define("DS/3DPlayVideoAnnotation/VideoAnnotationDrawPreview",["UWA/Class","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/3DPlayAnnotationUtils/CursorManager","DS/CoreEvents/Events","DS/WebUtils/Vector2","DS/VisuEvents/EventsManager","DS/WebSystem/Environment","DS/WebUtils/GeometryUtils","DS/3DPlayAnnotationUtils/ShapeUtils","DS/3DPlayAnnotationUtils/AnnotationShapeManipulator","DS/WebRunloop/Runloop","DS/3DPlayAnnotationUtils/CanvasShapes"],function(t,e,a,n,i,o,s,r,h,d,l,p){"use strict";var c;return t.extend({init:function(t){this._parent(t),c=this,this.viewer=t.viewer,this.holdingContainer=t.holdingContainer,this.hideUICB=t.hideUICB,this.strokeCompleteCB=t.strokeCompleteCB,this.editCB=t.editCB,this.endCB=t.endCB,this.annotationManager=t.annotationManager,this.draw=!1,this.drawSettings=new e,this.viewerPoints=[],this.endPoint=null,this.startPoint=null,this.frameWindow=t.frameWindow,c.annotationEdit=[],c.annotationData=void 0,c.editStarted=!1,c.editStartbbox=[],c.annot2DPoints=[],this.mode=t.mode,this.data=t.data},begin:function(t){this.container=this.viewer.getVideoContainer(),this.mode&&"edition"==this.mode&&this.data||this._activateCustomCursor(),c._createCanvas(),this.resizeToken=n.subscribe({event:"/3DPlay/VIDEO/RESIZE"},function(){c._destroyCanvas(),c._createCanvas()}),this.runloop=new l({data:this,func:this._runloopFunc}),this.runloop.start(),this.tokenSettingsChanged=n.subscribe({event:"3DPlay.Annotation.SettingsChanged"},function(t){c.mode&&"edition"==c.mode&&c.data||c._setMouseCursor("custom"),1==c.editStarted&&c.annotationEdit.length&&c.annotationData&&(c.annotationData.graphicalProp.color=c.drawSettings.getColor(),c.annotationManager.destroyShapes({idList:c.annotationEdit}),c.annotationManager.createShapeWithShapeData({id:c.annotationEdit[0],shape:JSON.parse(JSON.stringify(c.annotationData)),editMode:!1,render:!0,currTime:c.viewer.getCurrentTime()}))}),o.addEvent(this.frameWindow.getViewerFrame(),"onKeyDown",this._keyboardcallback),this._activateManipulators(),this.mode&&"edition"==this.mode&&this.data&&c._onClick({clientX:this.data.point.x,clientY:this.data.point.y},!0)},end:function(t){c.annotationEdit.length&&c.annotationData&&c.viewer&&(c.annotationManager.createShapeWithShapeData({id:c.annotationEdit[0],shape:JSON.parse(JSON.stringify(c.annotationData)),editMode:!1,render:!0,currTime:c.viewer.getCurrentTime()}),c.annotationEdit=[],c.annotationData=void 0,c.editStartbbox=[],c.annot2DPoints=[],c.editStarted=!1,c.manipulators.cleanManipulators()),c.editStartbbox=[],c.annot2DPoints=[],n.unsubscribe(this.tokenSettingsChanged),o.removeEvent(this.frameWindow.getViewerFrame(),"onKeyDown",this._keyboardcallback),this._disableManipulators(),this._deactivateCustomCursor(),this._destroyCanvas(),this.resizeToken&&(n.unsubscribe(this.resizeToken),this.resizeToken=void 0),c.editcanvas&&(c.editcanvas.width=0,c.editcanvas.height=0,c.editcanvas.remove()),this.drawSettings=void 0,this.viewer=void 0,c.runloop&&(c.runloop.stop(),c.runloop.dispose(),c.runloop=null)},destroy:function(){this.canvas&&this._destroyCanvas(),this.viewerPoints=[],this.endPoint=null,this.startPoint=null,this.hideUICB=void 0,this.strokeCompleteCB=void 0,this.editCB=void 0,this.container=void 0,this.viewer=void 0,c=void 0},_setMouseCursor:function(t){this.cursorManager&&this.cursorManager.setMouseCursor({container:this.container,caller:"2D",type:t,drawSettings:this.drawSettings})},_createCanvas:function(){this.canvas=new UWA.Element("canvas",{id:"annotPreviewCanvas",styles:{position:"absolute",top:0,left:0,"pointer-events":"none"}}).inject(this.container),this.canvas.style.left=this.viewer.getCanvas().style.left,this.canvas.style.top=this.viewer.getCanvas().style.top,this.canvas.width=this.viewer.getCanvas().width,this.canvas.height=this.viewer.getCanvas().height,this.canvasContext=this.canvas.getContext("2d")},_destroyCanvas:function(){this.canvasContext=void 0,this.canvas.destroy(),this.canvas=void 0},_activateCustomCursor:function(){this.cursorManager=new a,this._setMouseCursor("custom")},_deactivateCustomCursor:function(){this.cursorManager&&(this._setMouseCursor("auto"),this.cursorManager.dispose(),this.cursorManager=null)},_setStrokeStyle:function(t){var e=t.getContext("2d");e.strokeStyle=""+this.drawSettings.getColor(),e.fillStyle=""+this.drawSettings.getColor(),e.globalAlpha=1,e.lineCap="round",e.lineJoin="round",e.lineWidth=this.drawSettings.getThickness()},_translateToCanvasPosition:function(t){var e=this.canvas.getBoundingClientRect();return new i(t.x-e.left,t.y-e.top)},_beginMove:function(t){1==c.editStarted&&c.annotationEdit.length?(c.annotationManager.createShapeWithShapeData({id:c.annotationEdit[0],shape:JSON.parse(JSON.stringify(c.annotationData)),editMode:!1,render:!0,currTime:c.viewer.getCurrentTime()}),c.annotationEdit=[],c.annotationData=void 0,c.editStartbbox=[],c.annot2DPoints=[],c.editStarted=!1,c.manipulators.cleanManipulators(),c.mode&&"edition"==c.mode&&c.endCB&&c.endCB()):c._onClick(t,!1,!0)},_onClick:function(t,e,a){c.hideUICB();var n=new i(t.clientX,t.clientY),o=this.viewer.translateToViewerPosition(n);if(o)if(1==a)c._cleanDrawData(),c.draw=!0,c.startScreenPt=new i(t.clientX,t.clientY),c.currentScreenPt=new i(t.clientX,t.clientY),c.viewerPoints.push(o),c.startPoint={x:o.x,y:o.y},c.hideUICB(),c._setStrokeStyle(c.canvas),c._setStrokeStyle(c.viewer.getCanvas());else{var s,r=[],h=void 0,d=c._checkRepFromPick(t);d&&d.annotIDDelList&&d.annotIDDelList.length&&(r=d.annotIDDelList,h=d.annotationData,s=d.bBox),1==e&&0==c.annotationEdit.length&&r.length&&(c.annotationEdit=r,h&&"text"==h.type||(c.annotationData=h,c.editStartbbox=s,c.annotationManager.destroyShapes({idList:r}),c.annotationManager.createShapeWithShapeData({id:r[0],shape:JSON.parse(JSON.stringify(c.annotationData)),editMode:!1,render:!0,currTime:c.viewer.getCurrentTime()})));var l=!1;if(c.annotationEdit.length==r.length)for(var p=0;p<c.annotationEdit.length&&!(0>r.indexOf(c.annotationEdit[p]));p++)p==c.annotationEdit.length-1&&(l=!0);if(1==r.length&&1==l&&0==c.editStarted){c.editStarted=!0;var v=!1;s[0].y<30&&(v=!0),c.manipulators.createManipulators({bbox:s,color:c.annotationData.graphicalProp.color,container:c.holdingContainer,flipRotatePosition:v}),c._cleanDrawData()}}},_move:function(t){var e=new i(t.clientX,t.clientY),a=c.viewer.translateToViewerPosition(e);if(1==c.draw&&a){c._translateToCanvasPosition(e);c.viewerPoints.push(a),c.endPoint={x:a.x,y:a.y},c.viewer.drawPreview({startPoint:c.startPoint,endPoint:c.endPoint,canvas:c.canvas}),c.startPoint=c.endPoint,c.currentScreenPt=new i(t.clientX,t.clientY)}},_endMove:function(t){if(1==c.draw){var e=new i(t.clientX,t.clientY),a=c.viewer.translateToViewerPosition(e);a?(1==c.viewerPoints.length&&c.viewerPoints[0].x==a.x&&c.viewerPoints[0].y==a.y||c.viewerPoints.push(a),c.endPoint={x:a.x,y:a.y}):c.endPoint=c.viewerPoints[c.viewerPoints.length-1],c.viewer.drawPreview({startPoint:c.startPoint,endPoint:c.endPoint,canvas:c.canvas});var n=!1;if(c.recognizedshapeData)n=!0;else try{var o=h.filterAndSmoothPoints(c.viewerPoints,!0);c.viewerPoints=o}catch(t){console.log("error in shapeUtil")}var s=c.viewerPoints;1==s.length&&((s=[])[0]={x:c.viewerPoints[0].x-.1,y:c.viewerPoints[0].y-.1},s[1]={x:c.viewerPoints[0].x+.1,y:c.viewerPoints[0].y-.1},s[2]={x:c.viewerPoints[0].x+.1,y:c.viewerPoints[0].y+.1},s[3]={x:c.viewerPoints[0].x-.1,y:c.viewerPoints[0].y+.1}),c.strokeCompleteCB({points:c.viewerPoints,recognizeShape:n,recognizedshapeData:c.recognizedshapeData}),c.viewerPoints=[],c.endPoint=null,c.startPoint=null,c.startScreenPt=void 0,c.currentScreenPt=void 0,c.canvasContext.clearRect(0,0,c.canvas.width,c.canvas.height),c.draw=!1}},_runloopFunc:function(t){if(c.draw&&this.canvas)if(null==c.stationaryPos)c.stationaryPos=c.currentScreenPt,c.starttime=t.deltaTime,c.recognizedshapeData=void 0;else if(c.currentScreenPt.distanceTo(c.stationaryPos)<5){if(c.starttime=c.starttime+t.deltaTime,300<c.starttime){var e=h.shapeEval(c.viewerPoints).shape;if("unknownOpen"!=e.type&&"unknownClosed"!=e.type){var a={color:c.drawSettings.getColor(),thickness:parseInt(c.drawSettings.getThickness()),transparency:1},n=c.viewer.scale;a.thickness/=n,c.recognizedshapeData=p.createShape({shapeData:e,settings:a}),(i=c.canvas.getContext("2d")).clearRect(0,0,c.canvas.width,c.canvas.height),i.globalAlpha=1,p.drawShape({shape:JSON.parse(JSON.stringify(c.recognizedshapeData)),canvas:c.canvas,scale:n}),i.globalAlpha=.3,c.viewer.drawPreview({viewerPoints:c.viewerPoints,canvas:c.canvas})}}}else{var i;if(c.recognizedshapeData)c.stationaryPos=c.currentScreenPt,c.starttime=t.deltaTime,c.recognizedshapeData=void 0,(i=c.canvas.getContext("2d")).clearRect(0,0,c.canvas.width,c.canvas.height),i.globalAlpha=1,c.viewer.drawPreview({viewerPoints:c.viewerPoints,canvas:c.canvas});c.stationaryPos=c.currentScreenPt,c.starttime=t.deltaTime}},_cleanDrawData:function(){c.draw=!1,c.endPoint=null,c.startPoint=null,c.currentScreenPt=null,c.startScreenPt=null,c.viewerPoints=[]},_startShapeEdit:function(t){var e=c.viewer.scale;if(c.annotationData.data&&c.annotationData.data.path)for(var a=0;a<c.annotationData.data.path.length;a++)c.annotationData.data.path[a]=new i(c.annotationData.data.path[a].x,c.annotationData.data.path[a].y);var n=c.annotationManager.getAnnotationInformation({annotID:c.annotationEdit[0]});c.editStartbbox=n.bbox,c.annotationManager.destroyShapes({idList:c.annotationEdit});var o,s,r,h=[];if(c.annot2DPoints=[],c.currDeltaType=t.deltaType,"Rotate"==t.deltaType){var d={x:n.bbox[0].x+(n.bbox[1].x-n.bbox[0].x)/2,y:n.bbox[0].y+(n.bbox[2].y-n.bbox[1].y)/2},l=n.bbox[2].y-n.bbox[1].y,v=n.bbox[1].x-n.bbox[0].x,u=Math.sqrt(l/2*(l/2)+v/2*(v/2));h.push({x:d.x-u,y:d.y-u}),h.push({x:d.x+u,y:d.y-u}),h.push({x:d.x+u,y:d.y+u}),h.push({x:d.x-u,y:d.y+u}),c.annot2DPoints=JSON.parse(JSON.stringify(c.annotationData));for(a=0;a<c.annot2DPoints.data.path.length;a++)c.annot2DPoints.data.path[a]=new i(c.annot2DPoints.data.path[a].x,c.annot2DPoints.data.path[a].y)}"Rotate"==t.deltaType?(c.editcanvas=new UWA.Element("canvas",{id:"editCanvas",styles:{height:h[2].y-h[1].y+"px",width:h[1].x-h[0].x+"px",position:"absolute","z-index":5,top:h[0].y+"px",left:h[0].x+"px","pointer-events":"none"}}).inject(c.holdingContainer),o=h[2].y-h[1].y,s=h[1].x-h[0].x,r=h[0]):(c.editcanvas=new UWA.Element("canvas",{id:"editCanvas",styles:{height:n.bbox[2].y-n.bbox[1].y+"px",width:n.bbox[1].x-n.bbox[0].x+"px",position:"absolute","z-index":5,top:n.bbox[0].y+"px",left:n.bbox[0].x+"px"}}).inject(c.holdingContainer),o=n.bbox[2].y-n.bbox[1].y,s=n.bbox[1].x-n.bbox[0].x,r=n.bbox[0]),p.drawShape({shape:JSON.parse(JSON.stringify(c.annotationData)),editMode:!1,canvas:c.canvas,scale:e});var g=c.editcanvas.getContext("2d");c.editcanvas.width=s,c.editcanvas.height=o,g.strokeStyle="transparent",g.clearRect(0,0,s,o),g.drawImage(c.canvas,r.x,r.y,s,o,0,0,s,o),c.canvas.style.display="none",c.annotationManager.render({currTime:c.viewer.getCurrentTime()})},_editShape:function(t){var e=new i(t.event.clientX,t.event.clientY);if(c.viewer.translateToViewerPosition(e)){var a=c.viewer.scale;if("BothWithCenter"==t.deltaType){var n=parseFloat(c.editcanvas.style.top)+t.deltaY;(f=parseFloat(c.editcanvas.style.left)+t.deltaX)<=0?f=0:f>=c.holdingContainer.offsetWidth-parseFloat(c.editcanvas.style.width)&&(f=c.holdingContainer.offsetWidth-parseFloat(c.editcanvas.style.width)),n<=0?n=0:n>=c.holdingContainer.offsetHeight-parseFloat(c.editcanvas.style.height)&&(n=c.holdingContainer.offsetHeight-parseFloat(c.editcanvas.style.height)),c.editcanvas.style.top=n+"px",c.editcanvas.style.left=f+"px"}else{for(var o=!1,s=JSON.parse(JSON.stringify(c.annotationData)),r=0;r<s.data.path.length;r++)s.data.path[r]=new i(s.data.path[r].x,s.data.path[r].y);if("BottomWithCenter"==t.deltaType){var d=parseFloat(c.editcanvas.style.height)+t.deltaY;if(parseFloat(c.editcanvas.style.top)>=c.holdingContainer.offsetHeight-d&&(d=parseFloat(c.editcanvas.style.height)),0<d){var l=1*d/a-(x=1*(c.editStartbbox[2].y-c.editStartbbox[1].y)/a),v=1*c.editStartbbox[1].y/a;for(r=0;r<s.data.path.length;r++)s.data.path[r].y=s.data.path[r].y+(s.data.path[r].y-v)/x*l;c.editcanvas.style.height=d+"px"}else o=!0}else if("TopWithCenter"==t.deltaType){d=parseFloat(c.editcanvas.style.height)-t.deltaY;if((n=parseFloat(c.editcanvas.style.top)+t.deltaY)<=0&&(n=0,d=parseFloat(c.editcanvas.style.height)),0<d){l=1*d/a-(x=1*(c.editStartbbox[2].y-c.editStartbbox[1].y)/a);var u=1*c.editStartbbox[2].y/a;for(r=0;r<s.data.path.length;r++)s.data.path[r].y=s.data.path[r].y+(s.data.path[r].y-u)/x*l;c.editcanvas.style.height=d+"px",c.editcanvas.style.top=n+"px"}else o=!0}else if("LeftWithCenter"==t.deltaType){var g=parseFloat(c.editcanvas.style.width)-t.deltaX;if((f=parseFloat(c.editcanvas.style.left)+t.deltaX)<=0&&(f=0,g=parseFloat(c.editcanvas.style.width)),0<g){var y=1*g/a-(D=1*(c.editStartbbox[1].x-c.editStartbbox[0].x)/a),w=1*c.editStartbbox[1].x/a;for(r=0;r<s.data.path.length;r++)s.data.path[r].x=s.data.path[r].x+(s.data.path[r].x-w)/D*y;c.editcanvas.style.width=g+"px",c.editcanvas.style.left=f+"px"}else o=!0}else if("RightWithCenter"==t.deltaType){g=parseFloat(c.editcanvas.style.width)+t.deltaX;if(parseFloat(c.editcanvas.style.left)>=c.holdingContainer.offsetWidth-g&&(g=parseFloat(c.editcanvas.style.width)),0<g){y=1*g/a-(D=1*(c.editStartbbox[1].x-c.editStartbbox[0].x)/a);var m=1*c.editStartbbox[0].x/a;for(r=0;r<s.data.path.length;r++)s.data.path[r].x=s.data.path[r].x+(s.data.path[r].x-m)/D*y;c.editcanvas.style.width=g+"px"}else o=!0}else if("LeftWithTop"==t.deltaType){g=parseFloat(c.editcanvas.style.width)-t.deltaX;var f=parseFloat(c.editcanvas.style.left)+t.deltaX;d=parseFloat(c.editcanvas.style.height)-t.deltaY;if((n=parseFloat(c.editcanvas.style.top)+t.deltaY)<=0&&(n=0,d=parseFloat(c.editcanvas.style.height)),f<=0&&(f=0,g=parseFloat(c.editcanvas.style.width)),0<g&&0<d){for(y=1*g/a-(D=1*(c.editStartbbox[1].x-c.editStartbbox[0].x)/a),w=1*c.editStartbbox[1].x/a,l=1*d/a-(x=1*(c.editStartbbox[2].y-c.editStartbbox[1].y)/a),u=1*c.editStartbbox[2].y/a,r=0;r<s.data.path.length;r++)s.data.path[r].x=s.data.path[r].x+(s.data.path[r].x-w)/D*y,s.data.path[r].y=s.data.path[r].y+(s.data.path[r].y-u)/x*l;c.editcanvas.style.width=g+"px",c.editcanvas.style.left=f+"px",c.editcanvas.style.height=d+"px",c.editcanvas.style.top=n+"px"}else o=!0}else if("RightWithBottom"==t.deltaType){g=parseFloat(c.editcanvas.style.width)+t.deltaX,d=parseFloat(c.editcanvas.style.height)+t.deltaY;if(parseFloat(c.editcanvas.style.top)>=c.holdingContainer.offsetHeight-d&&(d=parseFloat(c.editcanvas.style.height)),parseFloat(c.editcanvas.style.left)>=c.holdingContainer.offsetWidth-g&&(g=parseFloat(c.editcanvas.style.width)),0<g&&0<d){for(y=1*g/a-(D=1*(c.editStartbbox[1].x-c.editStartbbox[0].x)/a),m=1*c.editStartbbox[0].x/a,l=1*d/a-(x=1*(c.editStartbbox[2].y-c.editStartbbox[1].y)/a),v=1*c.editStartbbox[1].y/a,r=0;r<s.data.path.length;r++)s.data.path[r].x=s.data.path[r].x+(s.data.path[r].x-m)/D*y,s.data.path[r].y=s.data.path[r].y+(s.data.path[r].y-v)/x*l;c.editcanvas.style.width=g+"px",c.editcanvas.style.height=d+"px"}else o=!0}else if("LeftWithBottom"==t.deltaType){g=parseFloat(c.editcanvas.style.width)-t.deltaX,f=parseFloat(c.editcanvas.style.left)+t.deltaX,d=parseFloat(c.editcanvas.style.height)+t.deltaY;if(f<=0&&(f=0,g=parseFloat(c.editcanvas.style.width)),parseFloat(c.editcanvas.style.top)>=c.holdingContainer.offsetHeight-d&&(d=parseFloat(c.editcanvas.style.height)),0<g&&0<d){for(y=1*g/a-(D=1*(c.editStartbbox[1].x-c.editStartbbox[0].x)/a),w=1*c.editStartbbox[1].x/a,l=1*d/a-(x=1*(c.editStartbbox[2].y-c.editStartbbox[1].y)/a),v=1*c.editStartbbox[1].y/a,r=0;r<s.data.path.length;r++)s.data.path[r].x=s.data.path[r].x+(s.data.path[r].x-w)/D*y,s.data.path[r].y=s.data.path[r].y+(s.data.path[r].y-v)/x*l;c.editcanvas.style.width=g+"px",c.editcanvas.style.left=f+"px",c.editcanvas.style.height=d+"px"}else o=!0}else if("RightWithTop"==t.deltaType){g=parseFloat(c.editcanvas.style.width)+t.deltaX,d=parseFloat(c.editcanvas.style.height)-t.deltaY,n=parseFloat(c.editcanvas.style.top)+t.deltaY;if(parseFloat(c.editcanvas.style.left)>=c.holdingContainer.offsetWidth-g&&(g=parseFloat(c.editcanvas.style.width)),n<=0&&(n=0,d=parseFloat(c.editcanvas.style.height)),0<g&&0<d){var D,x;for(y=1*g/a-(D=1*(c.editStartbbox[1].x-c.editStartbbox[0].x)/a),m=1*c.editStartbbox[0].x/a,l=1*d/a-(x=1*(c.editStartbbox[2].y-c.editStartbbox[1].y)/a),u=1*c.editStartbbox[2].y/a,r=0;r<s.data.path.length;r++)s.data.path[r].x=s.data.path[r].x+(s.data.path[r].x-m)/D*y,s.data.path[r].y=s.data.path[r].y+(s.data.path[r].y-u)/x*l;c.editcanvas.style.width=g+"px",c.editcanvas.style.height=d+"px",c.editcanvas.style.top=n+"px"}else o=!0}else if("Rotate"==t.deltaType){var C={x:(c.editStartbbox[3].x+c.editStartbbox[1].x)/2,y:(c.editStartbbox[3].y+c.editStartbbox[1].y)/2};C.x=1*C.x/a,C.y=1*C.y/a;for(r=0;r<c.annot2DPoints.data.path.length;r++){var b=new i(c.annot2DPoints.data.path[r].x,c.annot2DPoints.data.path[r].y);b.rotateAround(C,t.deltaAngle),c.annot2DPoints.data.path[r]=b}}if(0==o){if("circle"!=s.type&&"ellipse"!=s.type||"Rotate"==t.deltaType){if("ellipse"==c.annot2DPoints.type&&"Rotate"==t.deltaType){S=h.shapeEval(c.annot2DPoints.data.path).shape,T=p.createShape({shapeData:S,settings:c.annot2DPoints.graphicalProp});c.annot2DPoints.data=T.data,c.annot2DPoints.type=T.type}}else{var S=h.shapeEval(s.data.path).shape,T=p.createShape({shapeData:S,settings:s.graphicalProp});s.data=T.data,s.type=T.type}c.canvas.getContext("2d").clearRect(0,0,c.canvas.width,c.canvas.height),"Rotate"==t.deltaType?p.drawShape({shape:JSON.parse(JSON.stringify(c.annot2DPoints)),editMode:!1,canvas:c.canvas,scale:a}):p.drawShape({shape:JSON.parse(JSON.stringify(s)),editMode:!1,canvas:c.canvas,scale:a});var P=c.editcanvas.getContext("2d");c.editcanvas.width=1*parseFloat(c.editcanvas.style.width),c.editcanvas.height=1*parseFloat(c.editcanvas.style.height),P.strokeStyle="transparent",P.clearRect(0,0,1*parseFloat(c.editcanvas.style.width),1*parseFloat(c.editcanvas.style.height)),P.drawImage(c.canvas,parseFloat(c.editcanvas.style.left)/1*1,parseFloat(c.editcanvas.style.top)/1*1,parseFloat(c.editcanvas.style.width)/1*1,parseFloat(c.editcanvas.style.height)/1*1,0,0,parseFloat(c.editcanvas.style.width),parseFloat(c.editcanvas.style.height))}}var A=[{x:parseFloat(c.editcanvas.style.left),y:parseFloat(c.editcanvas.style.top)},{x:parseFloat(c.editcanvas.style.left)+parseFloat(c.editcanvas.style.width),y:parseFloat(c.editcanvas.style.top)},{x:parseFloat(c.editcanvas.style.left)+parseFloat(c.editcanvas.style.width),y:parseFloat(c.editcanvas.style.top)+parseFloat(c.editcanvas.style.height)},{x:parseFloat(c.editcanvas.style.left),y:parseFloat(c.editcanvas.style.top)+parseFloat(c.editcanvas.style.height)}],_=!1;parseFloat(c.editcanvas.style.top)<30&&(_=!0),"Rotate"==t.deltaType?c.manipulators.moveRotateManipulators({x:t.finalX,y:t.finalY}):c.manipulators.moveManipulators({bbox:A,flipRotatePosition:_})}},_endShapeEdit:function(t){var e=c.viewer.scale;if("BothWithCenter"==t.deltaType){var a={x:c.editStartbbox[0].x+(c.editStartbbox[1].x-c.editStartbbox[0].x)/2,y:c.editStartbbox[0].y+(c.editStartbbox[2].y-c.editStartbbox[1].y)/2},n={x:parseFloat(c.editcanvas.style.left)+parseFloat(c.editcanvas.style.width)/2,y:parseFloat(c.editcanvas.style.top)+parseFloat(c.editcanvas.style.height)/2},o={x:1*(n.x-a.x)/e,y:1*(n.y-a.y)/e};if("circle"==c.annotationData.type||"ellipse"==c.annotationData.type){c.annotationData.data.centre.x=c.annotationData.data.centre.x+o.x,c.annotationData.data.centre.y=c.annotationData.data.centre.y+o.y;for(var s=0;s<c.annotationData.data.path.length;s++)c.annotationData.data.path[s].x=c.annotationData.data.path[s].x+o.x,c.annotationData.data.path[s].y=c.annotationData.data.path[s].y+o.y}else if("text"==c.annotationData.type)c.annotationData.data.path.bottomLeft.x=c.annotationData.data.path.bottomLeft.x+o.x,c.annotationData.data.path.bottomLeft.y=c.annotationData.data.path.bottomLeft.y+o.y,c.annotationData.data.path.bottomRight.x=c.annotationData.data.path.bottomRight.x+o.x,c.annotationData.data.path.bottomRight.y=c.annotationData.data.path.bottomRight.y+o.y,c.annotationData.data.path.topLeft.x=c.annotationData.data.path.topLeft.x+o.x,c.annotationData.data.path.topLeft.y=c.annotationData.data.path.topLeft.y+o.y,c.annotationData.data.path.topRight.x=c.annotationData.data.path.topRight.x+o.x,c.annotationData.data.path.topRight.y=c.annotationData.data.path.topRight.y+o.y,c.annotationData.data.point.x=c.annotationData.data.point.x+o.x,c.annotationData.data.point.y=c.annotationData.data.point.y+o.y;else for(s=0;s<c.annotationData.data.path.length;s++)c.annotationData.data.path[s].x=c.annotationData.data.path[s].x+o.x,c.annotationData.data.path[s].y=c.annotationData.data.path[s].y+o.y}else if("BottomWithCenter"==t.deltaType){var r=1*(c.editStartbbox[2].y-c.editStartbbox[1].y)/e,d=1*parseFloat(c.editcanvas.style.height)/e-r,l=1*c.editStartbbox[1].y/e;for(s=0;s<c.annotationData.data.path.length;s++)c.annotationData.data.path[s].y=c.annotationData.data.path[s].y+(c.annotationData.data.path[s].y-l)/r*d;if("circle"==c.annotationData.type||"ellipse"==c.annotationData.type){var v=h.shapeEval(c.annotationData.data.path).shape,u=p.createShape({shapeData:v,settings:c.annotationData.graphicalProp});c.annotationData.data=u.data,c.annotationData.type=u.type}}else if("TopWithCenter"==t.deltaType){r=1*(c.editStartbbox[2].y-c.editStartbbox[1].y)/e,d=1*parseFloat(c.editcanvas.style.height)/e-r;var g=1*c.editStartbbox[2].y/e;for(s=0;s<c.annotationData.data.path.length;s++)c.annotationData.data.path[s].y=c.annotationData.data.path[s].y+(c.annotationData.data.path[s].y-g)/r*d;if("circle"==c.annotationData.type||"ellipse"==c.annotationData.type){v=h.shapeEval(c.annotationData.data.path).shape,u=p.createShape({shapeData:v,settings:c.annotationData.graphicalProp});c.annotationData.data=u.data,c.annotationData.type=u.type}}else if("RightWithCenter"==t.deltaType){var y=1*(c.editStartbbox[1].x-c.editStartbbox[0].x)/e,w=1*parseFloat(c.editcanvas.style.width)/e-y,m=1*c.editStartbbox[0].x/e;for(s=0;s<c.annotationData.data.path.length;s++)c.annotationData.data.path[s].x=c.annotationData.data.path[s].x+(c.annotationData.data.path[s].x-m)/y*w;if("circle"==c.annotationData.type||"ellipse"==c.annotationData.type){v=h.shapeEval(c.annotationData.data.path).shape,u=p.createShape({shapeData:v,settings:c.annotationData.graphicalProp});c.annotationData.data=u.data,c.annotationData.type=u.type}}else if("LeftWithCenter"==t.deltaType){y=1*(c.editStartbbox[1].x-c.editStartbbox[0].x)/e,w=1*parseFloat(c.editcanvas.style.width)/e-y;var f=1*c.editStartbbox[1].x/e;for(s=0;s<c.annotationData.data.path.length;s++)c.annotationData.data.path[s].x=c.annotationData.data.path[s].x+(c.annotationData.data.path[s].x-f)/y*w;if("circle"==c.annotationData.type||"ellipse"==c.annotationData.type){v=h.shapeEval(c.annotationData.data.path).shape,u=p.createShape({shapeData:v,settings:c.annotationData.graphicalProp});c.annotationData.data=u.data,c.annotationData.type=u.type}}else if("RightWithBottom"==t.deltaType){for(y=1*(c.editStartbbox[1].x-c.editStartbbox[0].x)/e,w=1*parseFloat(c.editcanvas.style.width)/e-y,m=1*c.editStartbbox[0].x/e,r=1*(c.editStartbbox[2].y-c.editStartbbox[1].y)/e,d=1*parseFloat(c.editcanvas.style.height)/e-r,l=1*c.editStartbbox[1].y/e,s=0;s<c.annotationData.data.path.length;s++)c.annotationData.data.path[s].x=c.annotationData.data.path[s].x+(c.annotationData.data.path[s].x-m)/y*w,c.annotationData.data.path[s].y=c.annotationData.data.path[s].y+(c.annotationData.data.path[s].y-l)/r*d;if("circle"==c.annotationData.type||"ellipse"==c.annotationData.type){v=h.shapeEval(c.annotationData.data.path).shape,u=p.createShape({shapeData:v,settings:c.annotationData.graphicalProp});c.annotationData.data=u.data,c.annotationData.type=u.type}}else if("LeftWithTop"==t.deltaType){for(y=1*(c.editStartbbox[1].x-c.editStartbbox[0].x)/e,w=1*parseFloat(c.editcanvas.style.width)/e-y,f=1*c.editStartbbox[1].x/e,r=1*(c.editStartbbox[2].y-c.editStartbbox[1].y)/e,d=1*parseFloat(c.editcanvas.style.height)/e-r,g=1*c.editStartbbox[2].y/e,s=0;s<c.annotationData.data.path.length;s++)c.annotationData.data.path[s].x=c.annotationData.data.path[s].x+(c.annotationData.data.path[s].x-f)/y*w,c.annotationData.data.path[s].y=c.annotationData.data.path[s].y+(c.annotationData.data.path[s].y-g)/r*d;if("circle"==c.annotationData.type||"ellipse"==c.annotationData.type){v=h.shapeEval(c.annotationData.data.path).shape,u=p.createShape({shapeData:v,settings:c.annotationData.graphicalProp});c.annotationData.data=u.data,c.annotationData.type=u.type}}else if("RightWithTop"==t.deltaType){for(y=1*(c.editStartbbox[1].x-c.editStartbbox[0].x)/e,w=1*parseFloat(c.editcanvas.style.width)/e-y,m=1*c.editStartbbox[0].x/e,r=1*(c.editStartbbox[2].y-c.editStartbbox[1].y)/e,d=1*parseFloat(c.editcanvas.style.height)/e-r,g=1*c.editStartbbox[2].y/e,s=0;s<c.annotationData.data.path.length;s++)c.annotationData.data.path[s].x=c.annotationData.data.path[s].x+(c.annotationData.data.path[s].x-m)/y*w,c.annotationData.data.path[s].y=c.annotationData.data.path[s].y+(c.annotationData.data.path[s].y-g)/r*d;if("circle"==c.annotationData.type||"ellipse"==c.annotationData.type){v=h.shapeEval(c.annotationData.data.path).shape,u=p.createShape({shapeData:v,settings:c.annotationData.graphicalProp});c.annotationData.data=u.data,c.annotationData.type=u.type}}else if("LeftWithBottom"==t.deltaType){for(y=1*(c.editStartbbox[1].x-c.editStartbbox[0].x)/e,w=1*parseFloat(c.editcanvas.style.width)/e-y,f=1*c.editStartbbox[1].x/e,r=1*(c.editStartbbox[2].y-c.editStartbbox[1].y)/e,d=1*parseFloat(c.editcanvas.style.height)/e-r,l=1*c.editStartbbox[1].y/e,s=0;s<c.annotationData.data.path.length;s++)c.annotationData.data.path[s].x=c.annotationData.data.path[s].x+(c.annotationData.data.path[s].x-f)/y*w,c.annotationData.data.path[s].y=c.annotationData.data.path[s].y+(c.annotationData.data.path[s].y-l)/r*d;if("circle"==c.annotationData.type||"ellipse"==c.annotationData.type){v=h.shapeEval(c.annotationData.data.path).shape,u=p.createShape({shapeData:v,settings:c.annotationData.graphicalProp});c.annotationData.data=u.data,c.annotationData.type=u.type}}else if("Rotate"==t.deltaType){var D=c.canvas.width/1*1,x=c.canvas.height/1*1,C=0,b=0;parseFloat(c.editcanvas.style.top)<0?b=1*Math.abs(parseFloat(c.editcanvas.style.top))/e:parseFloat(c.editcanvas.style.top)>0&&parseFloat(c.editcanvas.style.top)+parseFloat(c.editcanvas.style.height)>x&&(b=1*(x-parseFloat(c.editcanvas.style.top)-parseFloat(c.editcanvas.style.height))/e),parseFloat(c.editcanvas.style.left)<0?C=1*Math.abs(parseFloat(c.editcanvas.style.left))/e:parseFloat(c.editcanvas.style.left)>0&&parseFloat(c.editcanvas.style.left)+parseFloat(c.editcanvas.style.width)>D&&(C=1*(D-parseFloat(c.editcanvas.style.left)-parseFloat(c.editcanvas.style.width))/e),c.annotationData=JSON.parse(JSON.stringify(c.annot2DPoints));for(s=0;s<c.annotationData.data.path.length;s++){var S=new i(c.annotationData.data.path[s].x+C,c.annotationData.data.path[s].y+b);c.annotationData.data.path[s]=S}if("circle"==c.annotationData.type||"ellipse"==c.annotationData.type){v=h.shapeEval(c.annotationData.data.path).shape,u=p.createShape({shapeData:v,settings:c.annotationData.graphicalProp});c.annotationData.data=u.data,c.annotationData.type=u.type}}parseFloat(c.editcanvas.style.left),parseFloat(c.editcanvas.style.top),parseFloat(c.editcanvas.style.left),parseFloat(c.editcanvas.style.width),parseFloat(c.editcanvas.style.top),parseFloat(c.editcanvas.style.left),parseFloat(c.editcanvas.style.width),parseFloat(c.editcanvas.style.top),parseFloat(c.editcanvas.style.height),parseFloat(c.editcanvas.style.left),parseFloat(c.editcanvas.style.top),parseFloat(c.editcanvas.style.height);c.annotationManager.createShapeWithShapeData({id:c.annotationEdit[0],shape:JSON.parse(JSON.stringify(c.annotationData)),editMode:!1,render:!0,currTime:c.viewer.getCurrentTime()});var T=c.annotationManager.getAnnotationInformation({annotID:c.annotationEdit[0]});if(T){var P=!1;T.bbox[0].y<30&&(P=!0),c.manipulators.createManipulators({bbox:T.bbox,color:c.annotationData.graphicalProp.color,container:c.holdingContainer,flipRotatePosition:P})}c.editcanvas&&(c.editcanvas.width=0,c.editcanvas.height=0,c.editcanvas.remove()),c.canvasContext.clearRect(0,0,c.canvas.width,c.canvas.height),c.canvas.style.display="inherit",c.editStartbbox=[],c.currDeltaType=""},_activateManipulators:function(){this.pointerOut=function(t){0==t.button&&(c.draw?(c.draw=!1,c.canvasContext.clearRect(0,0,c.canvas.width,c.canvas.height),c.viewerPoints=[],c.endPoint=null,c.startPoint=null,c.startScreenPt=void 0,c.currentScreenPt=void 0,c.cursorManager&&c._setMouseCursor("auto")):1==c.editStarted&&c.annotationEdit.length&&c.annotationData&&c.viewer&&c.currDeltaType&&(c.manipulators.manipulation=!1,c.manipulators.manipulatorType="",c._endShapeEdit({deltaType:c.currDeltaType})))},this.manipulators=new d({eventTarget:this.frameWindow.getViewerFrame(),floatingBarContainer:c.holdingContainer,frameWindow:this.frameWindow,viewer:c.viewer,beginMove:this._beginMove,move:this._move,onTap:this._onTap,endMove:this._endMove,startShapeEdit:this._startShapeEdit,editShape:this._editShape,endShapeEdit:this._endShapeEdit,mouseLeave:this.pointerOut,coordinateScaling:this.coordinateScaling,floatingbarCallback:this.floatingbarCallback})},coordinateScaling:function(t){var e=c.holdingContainer.getBoundingClientRect().top,a=c.holdingContainer.getBoundingClientRect().left;return{x:t.clientX-a,y:t.clientY-e}},floatingbarCallback:function(t){"Delete3DPlay"==t.id?c.cleanCurrentAnnotation():"Color3DPlay"==t.id&&c.drawSettings.setColor(t.color)},_getPosition:function(t){var e=c.frameWindow.getViewerFrame().getBoundingClientRect().top,a=c.frameWindow.getViewerFrame().getBoundingClientRect().left,n={x:t.clientX-a,y:t.clientY-e};return new i(n.x,n.y)},_keyboardcallback:function(t){"Delete"==t.gesture.events[0].event.code&&c.cleanCurrentAnnotation()},cleanCurrentAnnotation:function(t){c.annotationEdit.length&&c.editStarted&&c.annotationManager&&c.viewer&&(c.annotationManager.destroyShapes({idList:c.annotationEdit}),c.annotationEdit=[],c.annotationData=void 0,c.editStartbbox=[],c.annot2DPoints=[],c.editStarted=!1,c.manipulators.cleanManipulators(),c.draw=!1,c.annotationManager.render({currTime:c.viewer.getCurrentTime()}),c.mode&&"edition"==c.mode&&c.endCB&&c.endCB())},_checkRepFromPick:function(t){var e,a,n=[],o=[],s=[],r=[],h=c.viewer.canvas.getBoundingClientRect(),d=new i(t.clientX-h.left,t.clientY-h.top),l=new i(t.clientX,t.clientY),v=c.viewer.translateToViewerPosition(l);new i(d.x,d.y);if(v){var u=c.annotationManager.getAllAnnotationwithCurrTime({currTime:c.viewer.getCurrentTime()});for(var g in u)if("alphaVal"!=g){var y=p.isOverlapShape({shape:u[g],point:{x:v.x,y:v.y},scale:c.viewer.scale,shapeList:u,thickness:u[g].graphicalProp.thickness});if(y){var w=c.annotationManager.getAnnotationInformation({annotID:y});w&&(n.push(y),o.push(w.shape),s.push(w.bbox),r.push(w.dataPoints))}}}if(0<n.length){for(var m,f=0,D=0;D<n.length;D++){var x=0;if(r[D].length){for(var C=0;C<r[D].length;C++){var b=new i(r[D][C].x,r[D][C].y);x+=v.distanceTo(b)}x/=r[D].length}0===D?(m=x,f=0):x<m&&(m=x,f=D)}n=[n[f]],e=o[f],a=s[f]}return{annotationData:e,annotIDDelList:n,bBox:a}},_disableManipulators:function(){this.manipulators&&(this.manipulators.destroy(),this.manipulators=void 0)}})}),define("DS/3DPlayVideoAnnotation/AnnotationTour",["DS/ApplicationFrame/Command","DS/WebInfraUI/NavigationArrows","DS/WebUtils/ContextedSingleton","DS/CoreEvents/Events"],function(t,e,a,n){"use strict";var i;return t.extend({init:function(t){this._parent(t,{isAsynchronous:!0,mode:"exclusive"}),i=this,this._exp=this.getFrameWindow().experience,this.disable(),this.enableCommand=function(){this.enable(),this.getFrameWindow().getViewer().enabledisableCommandButton("AnnotateTour","enable")},this.disableCommand=function(){this.disable(),this.getFrameWindow().getViewer().enabledisableCommandButton("AnnotateTour","disable")},this.AnnotationTourEnableSubscribe=n.subscribe({event:"3DPLAYVIDEO/ANNONATIONTOUR/ENABLE"},this.enableCommand.bind(this)),this.AnnotationTourDisableSubscribe=n.subscribe({event:"3DPLAYVIDEO/ANNONATIONTOUR/DISABLE"},this.disableCommand.bind(this))},beginExecute:function(){this.frameWindow=this.getFrameWindow(),this.viewer=this.getFrameWindow().getViewer(),0==this.viewer.isPaused()&&this.viewer.pauseVideo(),this.holdingContainer=new UWA.Element("div",{id:"holdingContainer",styles:{position:"absolute",top:0,left:0,"z-index":2}}).inject(this.viewer.getVideoContainer()),this.holdingContainer.style.left=this.viewer.getCanvas().style.left,this.holdingContainer.style.top=this.viewer.getCanvas().style.top,this.holdingContainer.style.width=this.viewer.getCanvas().width+"px",this.holdingContainer.style.height=this.viewer.getCanvas().height+"px";var t=this.frameWindow.getActionBar();t.close();var o=t.onActionBarOpen(function(){t.removeCallback(o),i.end()}),s=a.get(this._ctx,"ANNOTATION_MANAGER");this.navigationArrows=new e({arrowCB:{left:function(){s&&s.updateTimeline({direction:"left"})},right:function(){s&&s.updateTimeline({direction:"right"})}}},{container:this.holdingContainer,frmWindow:this.getFrameWindow(),toNotListenResize:!0}),this.MBAShow=n.subscribe({event:"3DPlay.MAB.Show"},function(){i._exitAnnot()}),this.MBAHide=n.subscribe({event:"3DPlay.MAB.Hide"},function(){i._exitAnnot()}),this.resizeToken=n.subscribe({event:"/3DPlay/VIDEO/RESIZE"},function(){i.holdingContainer.style.left=i.viewer.getCanvas().style.left,i.holdingContainer.style.top=i.viewer.getCanvas().style.top,i.holdingContainer.style.width=i.viewer.getCanvas().width+"px",i.holdingContainer.style.height=i.viewer.getCanvas().height+"px",i.navigationArrows&&i.navigationArrows._onViewerResize()}),n.publish({event:"/3DPlay/ANNOTATIONVIDEO/STARTED",data:{}})},endExecute:function(){n.unsubscribe(this.MBAShow),n.unsubscribe(this.MBAHide),n.publish({event:"/3DPlay/ANNOTATIONVIDEO/ENDED",data:{}}),this.viewer.deactivateCommandButton("AnnotateTour"),this.resizeToken&&(n.unsubscribe(this.resizeToken),this.resizeToken=void 0),this.holdingContainer&&(this.holdingContainer.destroy(),this.holdingContainer=void 0),this.navigationArrows.dispose(),this.navigationArrows=null,this.viewer=void 0},_destroy:function(){this._exp=void 0,this.AnnotationTourEnableSubscribe&&n.unsubscribe(this.AnnotationTourEnableSubscribe),this.AnnotationTourDisableSubscribe&&n.unsubscribe(this.AnnotationTourDisableSubscribe),this._parent()},_onWidgetResize:function(){i.holdingContainer.style.left=i.viewer.getCanvas().style.left,i.holdingContainer.style.top=i.viewer.getCanvas().style.top,i.holdingContainer.style.width=i.viewer.getCanvas().width+"px",i.holdingContainer.style.height=i.viewer.getCanvas().height+"px"},_exitAnnot:function(){this&&this.frameWindow&&this.frameWindow.getActionBar().open()}})}),define("DS/3DPlayVideoAnnotation/VideoTour",["DS/ApplicationFrame/Command","DS/WebInfraUI/NavigationArrows","DS/WebUtils/ContextedSingleton","DS/CoreEvents/Events"],function(t,e,a,n){"use strict";var i;return t.extend({init:function(t){this._parent(t,{isAsynchronous:!0,mode:"exclusive"}),i=this,this._exp=this.getFrameWindow().experience,this.disable(),this.enableCommand=function(){this.enable()},this.disableCommand=function(){this.disable()}},beginExecute:function(){this.frameWindow=this.getFrameWindow(),this.viewer=this.getFrameWindow().getViewer(),0==this.viewer.isPaused()&&this.viewer.pauseVideo(),this.holdingContainer=new UWA.Element("div",{id:"holdingContainer",styles:{position:"absolute",top:0,left:0,"z-index":2}}).inject(this.viewer.getVideoContainer()),this.holdingContainer.style.left=this.viewer.getCanvas().style.left,this.holdingContainer.style.top=this.viewer.getCanvas().style.top,this.holdingContainer.style.width=this.viewer.getCanvas().width+"px",this.holdingContainer.style.height=this.viewer.getCanvas().height+"px",this.navigationArrows=new e({arrowCB:{left:function(){i.viewer.setCurrentTime(i.viewer.getCurrentTime()-1/i.viewer.fps)},right:function(){i.viewer.setCurrentTime(i.viewer.getCurrentTime()+1/i.viewer.fps)}}},{container:this.holdingContainer,frmWindow:this.getFrameWindow(),toNotListenResize:!0}),this.resizeToken=n.subscribe({event:"/3DPlay/VIDEO/RESIZE"},function(){i.holdingContainer.style.left=i.viewer.getCanvas().style.left,i.holdingContainer.style.top=i.viewer.getCanvas().style.top,i.holdingContainer.style.width=i.viewer.getCanvas().width+"px",i.holdingContainer.style.height=i.viewer.getCanvas().height+"px",i.navigationArrows&&i.navigationArrows._onViewerResize()})},endExecute:function(){this.viewer.deactivateCommandButton("VideoTour"),this.resizeToken&&(n.unsubscribe(this.resizeToken),this.resizeToken=void 0),this.holdingContainer&&(this.holdingContainer.destroy(),this.holdingContainer=void 0),this.navigationArrows.dispose(),this.navigationArrows=null,this.viewer=void 0},_destroy:function(){this._exp=void 0,this._parent()},_onWidgetResize:function(){},_exitAnnot:function(){this.end()}})}),define("DS/3DPlayVideoAnnotation/AnnotationManager",["UWA/Class","DS/3DPlayAnnotationUtils/AnnotationAbbreviations","DS/3DPlayAnnotationUtils/CanvasShapes","DS/CoreEvents/Events","DS/WebUtils/GeometryUtils","DS/WebUtils/Vector2"],function(t,e,a,n,i,o){"use strict";var s;return t.extend({init:function(t){s=this,this.options=t,this.viewer=this.options.frameWindow.getViewer(),this._annotTimePointsList=[],this.AnnotationAbbreviations=new e,this.videoTimeChangeToken=n.subscribe({event:"/3DPlay/VIDEO/TIME_CHANGE"},function(t){var e=s._getCurrentTime(t.cTime),a=s._getAllAnnotationwithCurrTime({time:e});s.viewer.drawShapes({shapeList:a})})},saveAnnotationsToJSON:function(t){for(var e={ver:"0.0",explodeStates:[{id:0,timepoints:[]}]},a=e.explodeStates[0].timepoints,n=0;n<this._annotTimePointsList.length;n++)a.push({id:this._annotTimePointsList[n].timePoint,shapeList:this._annotTimePointsList[n].shapeList});var i=this.AnnotationAbbreviations.processJSON(e,"minify");return JSON.stringify(i)},drawAnnotationsFromJSON:function(t,e){for(var a=JSON.parse(t),i=this.AnnotationAbbreviations.processJSON(a,"expand").explodeStates[0].timepoints,o=0;o<i.length;o++){var s=i[o].id,r=this._getCurrentAnnotTimepoint({currTime:s,bIfToCraete:!0});if(r){var h=i[o].shapeList;for(var d in h)r.shapeList[""+d]=h[""+d]}}var l=this.viewer.getCurrentTime();l=this._getCurrentTime(l);var p=this._getAllAnnotationwithCurrTime({time:l});this.viewer.drawShapes({shapeList:p}),n.publish({event:"3DPLAYVIDEO/ANNONATIONTOUR/ENABLE",data:{}})},createShape:function(t){var e=this.viewer.scale;t.settings.thickness/=e;var i=!0;!1===t.render&&(i=!1);var o=this._getCurrentTime(t.currTime),s=this._getCurrentAnnotTimepoint({currTime:o,bIfToCraete:!0}),r=a.createShape({shapeData:t.shapeData,settings:t.settings});if(s.shapeList[""+r.id]=r,s.shapeList[""+r.id].time=s.timePoint,i){var h=this._getAllAnnotationwithCurrTime({time:o});this.viewer.drawShapes({shapeList:h})}n.publish({event:"3DPLAYVIDEO/ANNONATIONTOUR/ENABLE",data:{}})},createShapeWithShapeData:function(t){var e=t.shape.time;null==e&&(e=this._getCurrentTime(t.currTime));var a=this._getCurrentAnnotTimepoint({currTime:e,bIfToCraete:!0});if(a.shapeList[""+t.id]=t.shape,a.shapeList[""+t.id].time=a.timePoint,t.editMode&&(a.shapeList[""+t.id].editMode=!0),t.render){var i=this._getAllAnnotationwithCurrTime({time:t.shape.time});this.viewer.drawShapes({shapeList:i})}n.publish({event:"3DPLAYVIDEO/ANNONATIONTOUR/ENABLE",data:{}})},createAnnotationWithTextData:function(t){var e=t.shape.time;null==e&&(e=this._getCurrentTime(t.currTime));var a=this._getCurrentAnnotTimepoint({currTime:e,bIfToCraete:!0});if(a.shapeList[""+t.id]=t.shape,a.shapeList[""+t.id].time=a.timePoint,t.render){var i=this._getAllAnnotationwithCurrTime({time:t.shape.time});this.viewer.drawShapes({shapeList:i})}n.publish({event:"3DPLAYVIDEO/ANNONATIONTOUR/ENABLE",data:{}})},render:function(t){var e=this._getCurrentTime(t.currTime),a=this._getAllAnnotationwithCurrTime({time:e});this.viewer.drawShapes({shapeList:a})},getAnnotationInformation:function(t){var e=this.viewer.scale,n=this.getShapeByID(t.annotID);if(this.viewer.canvas&&n){var s=n.graphicalProp.thickness/2,r=a.getDrawPath({shape:n}),h=[];if("text"===n.type){var d=n.data.point.x-n.data.width/2,l=n.data.point.y,p=[d,l],c=[d+n.data.width,l+n.data.height],v=[d,l+n.data.height],u=[d+n.data.width,l];h.push(new o(u[0],u[1])),h.push(new o(c[0],c[1])),h.push(new o(p[0],p[1])),h.push(new o(v[0],v[1]))}else for(var g=0;g<r.length;++g)h.push(new o(r[g].x,r[g].y));if(h){for(var y=i.convexHullCompute(h),w=[],m=[],f=0;f<y.length;++f)w.push(y[f].x),m.push(y[f].y);w.sort(function(t,e){return t-e}),m.sort(function(t,e){return t-e});var D=w.length-1,x=[{x:w[0]-s,y:m[0]-s},{x:w[D]+s,y:m[0]-s},{x:w[D]+s,y:m[D]+s},{x:w[0]-s,y:m[D]+s}];return{bbox:[{x:(w[0]-s)*e,y:(m[0]-s)*e},{x:(w[D]+s)*e,y:(m[0]-s)*e},{x:(w[D]+s)*e,y:(m[D]+s)*e},{x:(w[0]-s)*e,y:(m[D]+s)*e}],bBoxUnScaled:x,dataPoints:h,shape:n}}return!1}return!1},getAllAnnotationwithCurrTime:function(t){var e=this._getCurrentTime(t.currTime);return s._getAllAnnotationwithCurrTime({time:e})},_getCurrentAnnotTimepoint:function(t){for(var e=t.currTime,a=null,n=0;n<this._annotTimePointsList.length;n++)if(e==this._annotTimePointsList[n].timePoint){a=this._annotTimePointsList[n];break}return!a&&t.bIfToCraete&&(a=this._createAnnotTimepoint({currTime:e}),this._annotTimePointsList.push(a)),a},_createAnnotTimepoint:function(t){return{timePoint:t.currTime,shapeList:{}}},_getCurrentTime:function(t){var e=t;e*=10;var a=Math.floor(e);return a/=10},_getAllAnnotationwithCurrTime:function(t){for(var e={},a={},n=0<t.time-1?t.time-1:0;n<=t.time+1.01;n+=.1){var i=1-Math.abs(t.time-n);0==i&&(i=.1);var o=10*n;o=Math.round(o),o/=10;var r=s._getCurrentAnnotTimepoint({currTime:o,bIfToCraete:!1});if(r)for(var h in r.shapeList)e[""+h]=r.shapeList[h],a[""+h]=i}return e.alphaVal=a,e},updateTimeline:function(t){var e,a,n,i=this.viewer.getCurrentTime();i=this._getCurrentTime(i);var o=this._annotTimePointsList[0].timePoint,s=this._annotTimePointsList[this._annotTimePointsList.length-1].timePoint;if(i>=s)a=i==s&&1<this._annotTimePointsList.length?this._annotTimePointsList[this._annotTimePointsList.length-2]:this._annotTimePointsList[this._annotTimePointsList.length-1],n=this._annotTimePointsList[0];else if(i<=o)n=i==o&&1<this._annotTimePointsList.length?this._annotTimePointsList[1]:this._annotTimePointsList[0],a=this._annotTimePointsList[this._annotTimePointsList.length-1];else for(var r=0;r<this._annotTimePointsList.length;r++){var h=this._annotTimePointsList[r].timePoint;if(i>=h){if(i==h){a=this._annotTimePointsList[r-1],n=this._annotTimePointsList[r+1];break}if(!(i>h))break;a=this._annotTimePointsList[r],n=this._annotTimePointsList[r+1]}}"right"==t.direction?e=n:"left"==t.direction&&(e=a),e&&this.viewer.setCurrentTime(e.timePoint)},getIntersectingShapes:function(t){var e=[],n=this.viewer.getCurrentTime();n=this._getCurrentTime(n);var i=this._getAllAnnotationwithCurrTime({time:n});for(var o in i)if("alphaVal"!=o){for(var s=t.thickness/this.viewer.scale,r=t.endPoint.x,h=t.endPoint.y,d=2*Math.PI/10,l=[],p=0;p<2*Math.PI;p+=d)l.push({x:r+s*Math.cos(p),y:h+s*Math.sin(p)});var c=a.isIntersectShape({shape:i[""+o],startPoint:t.startPoint,endPoint:t.endPoint,shapeList:i,referenceShapePath:l});c&&(e=e.concat(c))}return e},drawShapes:function(t){var e=s._getCurrentTime(t.cTime),a=s._getAllAnnotationwithCurrTime({time:e});s.viewer.drawShapes({shapeList:a})},drawShapeForErase:function(t){var e=t.idList,a=[],n=this.viewer.getCurrentTime();n=this._getCurrentTime(n);for(var i=this._getAllAnnotationwithCurrTime({time:n}),o=0;o<e.length;++o){var s=i[""+e[o]];a.push(s)}this.viewer.drawShapeForErase({shapeList:a,lowLightMode:t.lowLightMode})},destroyShapes:function(t){for(var e=t.idList,a=0;a<this._annotTimePointsList.length;a++)if(this._annotTimePointsList[a]){for(var i=0;i<e.length;++i)delete this._annotTimePointsList[a].shapeList[""+e[i]];var o=!0;for(var s in this._annotTimePointsList[a].shapeList)if(this._annotTimePointsList[a].shapeList.hasOwnProperty(s)){o=!1;break}1==o&&(this._annotTimePointsList.splice(a,1),--a)}0==this._annotTimePointsList.length&&n.publish({event:"3DPLAYVIDEO/ANNONATIONTOUR/DISABLE",data:{}})},getShapeByID:function(t){for(var e,a=0;a<this._annotTimePointsList.length;a++)if(this._annotTimePointsList[a]){for(var n in this._annotTimePointsList[a].shapeList)if(n==t){e=this._annotTimePointsList[a].shapeList[""+t];break}if(e)break}return e},dispose:function(){this.videoTimeChangeToken&&(n.unsubscribe(this.videoTimeChangeToken),this.videoTimeChangeToken=null)},deleteAllAnnotations:function(){}})}),define("DS/3DPlayVideoAnnotation/VideoAnnotationCommand",["UWA/Class","DS/3DPlayAnnotationUtils/AnnotationSettings"],function(t,e){"use strict";return t.extend({init:function(t){this._parent(t),this.frameWindow=t.frameWindow,this.hideTools=t.hideTools,this.annotationManager=t.annotationManager,this._isRunning=!1,this.viewer=this.frameWindow.getViewer(),this.drawSettings=new e},begin:function(t){this._isRunning=!0},end:function(t){this._isRunning=!1},isRunning:function(){return this._isRunning},destroy:function(){this.frameWindow=void 0,this.hideTools=void 0,this._isRunning=void 0},hideUI:function(){this.hideTools&&this.hideTools()}})}),define("DS/3DPlayVideoAnnotation/AnnotationVideoErase",["DS/3DPlayVideoAnnotation/VideoAnnotationCommand","DS/Core/PointerEvents","DS/WebUtils/Vector2","DS/WebappsUtils/WebappsUtils","DS/CoreEvents/Events","DS/3DPlayAnnotationUtils/CursorManager"],function(t,e,a,n,i,o){"use strict";var s;return t.extend({init:function(t){this._parent(t),s=this},begin:function(t){this._parent(t),this.container=this.viewer.getVideoContainer(),this.drag=!1,this._activateManipulators(),this._activateCustomCursor()},end:function(t){this._deactivateCustomCursor(),this._deleteListedAnnotations(),this._disableManipulators(),this._parent(t)},destroy:function(){s=null,this._parent()},_setCursor:function(t){if(t){var e="url("+n.getWebappsBaseUrl()+"3DPlayAnnotationUtils/assets/icons/32/I_AnnotationRubber.png), auto";this.viewer.canvas.style.setProperty("cursor",e)}else this.viewer.canvas.style.setProperty("cursor","auto")},_beginManipulate:function(t,e){this.viewerPoints=[];var n=new a(t.clientX,t.clientY),i=t.width?n:this.viewer.translateToViewerPosition(n);(0===t.button||t.touchType)&&i&&(this.viewerPoints.push(i),this.startPoint=i,this.endPoint=null,this.drag=!0,this.hideUI())},_manipulate:function(t,e){var n=new a(t.clientX,t.clientY),i=t.width?n:this.viewer.translateToViewerPosition(n);i&&(0==t.button||t.touchType)&&!0===this.drag&&(this.viewerPoints.push(i),null!=this.endPoint&&(this.startPoint=this.endPoint),this.endPoint=i,this._eraseRep())},_endManipulate:function(t,e){var n=new a(t.clientX,t.clientY),i=t.width?n:this.viewer.translateToViewerPosition(n);i&&(this.viewerPoints.push(i),null!=this.endPoint&&(this.startPoint=this.endPoint),this.endPoint=i),this._eraseRep(),this.annotationManager.drawShapes({cTime:this.viewer.getCurrentTime()}),this.startPoint=void 0,this.endPoint=void 0,this.drag=!1},_eraseRep:function(){if(this.startPoint&&this.endPoint){var t=this.annotationManager.getIntersectingShapes({startPoint:this.startPoint,endPoint:this.endPoint,thickness:s.drawSettings.getEraserThickness()});t.length>0&&(this.annotationManager.drawShapeForErase({idList:t,lowLightMode:!0}),this.annotationManager.destroyShapes({idList:t}))}},_activateManipulators:function(){this.onPointerDown=function(t){var e=t,a=!1;t&&t.touches&&t.touches.length>0&&(e=t.touches[0],a=!0),this._beginManipulate(e,a)}.bind(this),this.onPointerMove=function(t,e){var a=t;t&&t.touches&&t.touches.length>0&&(a=t.touches[0]),this._manipulate(a)}.bind(this),this.onPointerUp=function(t,e){var a=t;t&&t.changedTouches&&t.changedTouches.length>0&&(a=t.changedTouches[0]),this._endManipulate(a)}.bind(this),this.container.addEventListener("mousedown",this.onPointerDown,!0),this.container.addEventListener("mousemove",this.onPointerMove,!0),this.container.addEventListener("mouseup",this.onPointerUp,!0),this.container.addEventListener("touchstart",this.onPointerDown,!0),this.container.addEventListener("touchmove",this.onPointerMove,!0),this.container.addEventListener("touchend",this.onPointerUp,!0)},_disableManipulators:function(){this.container.removeEventListener("mousedown",this.onPointerDown,!0),this.container.removeEventListener("mousemove",this.onPointerMove,!0),this.container.removeEventListener("mouseup",this.onPointerUp,!0),this.container.removeEventListener("touchstart",this.onPointerDown,!0),this.container.removeEventListener("touchmove",this.onPointerMove,!0),this.container.removeEventListener("touchend",this.onPointerUp,!0)},_activateCustomCursor:function(){this.cursorManager=new o,s._setMouseCursor("custom_eraser")},_setMouseCursor:function(t){this.cursorManager&&this.cursorManager.setMouseCursor({container:this.container,caller:"2D",type:t,drawSettings:this.drawSettings})},_deactivateCustomCursor:function(){this.cursorManager&&(this._setMouseCursor("auto"),this.cursorManager.dispose(),this.cursorManager=null)},_deleteListedAnnotations:function(){}})}),define("DS/3DPlayVideoAnnotation/VideoAnnotationDraw",["DS/3DPlayVideoAnnotation/VideoAnnotationCommand","DS/3DPlayVideoAnnotation/VideoAnnotationDrawPreview","DS/3DPlayAnnotationUtils/ShapeUtils","DS/CoreEvents/Events"],function(t,e,a,n){"use strict";var i;return t.extend({init:function(t){this._parent(t),t.startCommandCB&&(this.startCommandCB=t.startCommandCB),t.endCommandCB&&(this.endCommandCB=t.endCommandCB),t.data&&(this.data=t.data),t.mode&&(this.mode=t.mode),this.holdingContainer=t.holdingContainer,i=this},begin:function(t){this._parent(t),this._createPreview()},end:function(t){this._destroyPreview(),this._parent(t)},destroy:function(){this.drawSettings=void 0,this._parent(),i=void 0},cleanCurrentAnnotation:function(){this.drawPreview&&this.drawPreview.cleanCurrentAnnotation()},_edit:function(t){this.startCommandCB&&this.startCommandCB({command:{id:"2DText"},data:{annotationData:t.annotationData}})},_endCommand:function(t){this.endCommandCB&&this.endCommandCB()},_strokeComplete:function(t){var e=this.frameWindow.getViewer();if(t.recognizeShape&&t.recognizedshapeData)i.annotationManager.createShapeWithShapeData({shape:t.recognizedshapeData,render:!0,id:t.recognizedshapeData.id,currTime:e.getCurrentTime()});else{var n=a.shapeUnEval(t.points).shape;this.annotationManager.createShape({shapeData:n,settings:{color:i.drawSettings.getColor(),thickness:parseInt(i.drawSettings.getThickness()),transparency:1},currTime:e.getCurrentTime(),render:!0})}},_createPreview:function(){var t=this.frameWindow.getViewer();this.drawPreview=new e({viewer:t,frameWindow:this.frameWindow,data:this.data,mode:this.mode,holdingContainer:i.holdingContainer,hideUICB:function(){i.hideUI()},annotationManager:this.annotationManager,strokeCompleteCB:function(t){i._strokeComplete(t)},editCB:function(t){i._edit(t)},endCB:function(t){i._endCommand(t)}}),this.drawPreview.begin()},_destroyPreview:function(){this.drawPreview&&(this.drawPreview.end(),this.drawPreview.destroy(),this.drawPreview=void 0)}})}),define("DS/3DPlayVideoAnnotation/AnnotationVideoText",["UWA/Core","DS/3DPlayVideoAnnotation/VideoAnnotationCommand","DS/3DPlayAnnotationUtils/AnnotationText","DS/CoreEvents/Events","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/WebUtils/GeometryUtils","DS/Core/PointerEvents","DS/WebUtils/Vector2"],function(t,e,a,n,i,o,s,r){"use strict";var h;return e.extend({init:function(t){(h=this)._parent(t),h._exp=this.frameWindow.experience,h.container=h.viewer.getViewerContainer(),h.holdingContainer=t.holdingContainer,t.previousCommand&&(this.previousCommand=t.previousCommand),t.startCommandCB&&(this.startCommandCB=t.startCommandCB),t.endCommandCB&&(this.endCommandCB=t.endCommandCB),t.isMobile?this.mab=!0:this.mab=!1},begin:function(t){this._parent(t),this.separate=function(t,e){void 0!==t.clientX?t.clientX:t.touches[0].clientX,void 0!==t.clientY?t.clientY:t.touches[0].clientY;this.textControl[e](t)},this.pointerDown=function(t){var e=t;t&&t.touches&&t.touches.length>0&&(e=t.touches[0]),h.textControl.pointerDown(e)},this.pointerMove=function(t){var e=t;t&&t.touches&&t.touches.length>0&&(e=t.touches[0]),h.separate(e,"pointerMove")},this.pointerUp=function(t){var e=t;t&&t.changedTouches&&t.changedTouches.length>0&&(e=t.changedTouches[0]),h.separate(e,"pointerup")},this.mouseleave=function(t){h.textControl.mouseleave(t)},this.container.addEventListener("mousedown",this.pointerDown,!0),this.container.addEventListener("mousemove",this.pointerMove,!0),this.container.addEventListener("mouseup",this.pointerUp,!0),this.container.addEventListener("touchstart",this.pointerDown,!0),this.container.addEventListener("touchmove",this.pointerMove,!0),this.container.addEventListener("touchend",this.pointerUp,!0),this.container.addEventListener("mouseleave",this.mouseleave,!0),t&&t.data&&(this.data=t.data),this._createTextControl(t),this.textControl.enable(),this.textControl.showControls()},end:function(t){t.isCommandcancelled&&this.data&&this.data.annotationData&&this.annotationManager.createAnnotationWithTextData({shape:this.data.annotationData,render:!0,id:this.data.annotationData.id,currTime:this.viewer.getCurrentTime()}),this.container.removeEventListener("mousedown",this.pointerDown,!0),this.container.removeEventListener("mousemove",this.pointerMove,!0),this.container.removeEventListener("mouseup",this.pointerUp,!0),this.container.removeEventListener("touchstart",this.pointerDown,!0),this.container.removeEventListener("touchmove",this.pointerMove,!0),this.container.removeEventListener("touchend",this.pointerUp,!0),this.container.removeEventListener("mouseleave",this.mouseleave,!0),this._destroyTextControl(),this._parent(t)},destroy:function(){this._parent(),this.drawSettings=void 0,h=void 0},_onValidate:function(t){this._createAnnotation(t),this.textControl.clearTextField(),this.endCommandCB(this.previousCommand)},_createAnnotation:function(t){var e=""+100*(parseInt(this.drawSettings.getThickness())-3),a=t.fontSize+'px "3ds"',n=o.wrapText({text:t.text,width:t.w/t.scale,height:t.h/t.scale,font:a}),i=new r(t.x/this.viewer.scale,t.y/this.viewer.scale),s={type:"text",text:n.wrappedLines,point:{x:i.x,y:i.y},height:t.h/this.viewer.scale,width:t.w/this.viewer.scale,offsetHeight:t.offsetHeight/this.viewer.scale,fontSize:t.fontSize/this.viewer.scale,fontWeight:e,controlScale:t.scale};this.annotationManager.createShape({shapeData:s,settings:{color:t.color,thickness:parseInt(this.drawSettings.getThickness()),transparency:1},currTime:this.viewer.getCurrentTime()})},_createTextControl:function(t){var e;t&&t.data&&(e=t.data),this.textControl=new a({mab:h.mab,mode:"video",viewer:h.viewer,container:this.holdingContainer,listnerContainer:this.container,floatingBarContainer:h.holdingContainer,onOk:function(t){h._onValidate(t)},onCancel:function(){h.textControl.clearTextField(),h.endCommandCB({command:h.previousCommand})},onTypeStartCB:function(t){h.hideUI()},disabled:!1,data:e,floatingbarCallback:this.floatingbarCallback}),t&&t.data?this.textControl.setTextControlPosForEdit(t.data):this.textControl.setTextControlPos({top:0,left:0,width:this.viewer.getCanvas().width,height:this.viewer.getCanvas().height})},_destroyTextControl:function(){this.textControl&&(this.textControl.destroy(),this.textControl=void 0)},floatingbarCallback:function(t){"Delete3DPlay"==t.id?h.endCommandCB({command:h.previousCommand}):"Color3DPlay"==t.id&&h.drawSettings.setColor(t.color)}})}),define("DS/3DPlayVideoAnnotation/AnnotationCommandsVideoEditShape",["DS/ApplicationFrame/Command","DS/WebInfraUI/ContextualBarManager","DS/3DPlayAnnotationUtils/AnnotationToolsMenu","DS/3DPlayVideoAnnotation/VideoAnnotationDraw","DS/3DPlayVideoAnnotation/AnnotationVideoText","DS/3DPlayVideoAnnotation/AnnotationVideoErase","DS/CoreEvents/Events","DS/WebUtils/ContextedSingleton","DS/WebSystem/BrowserInfos"],function(t,e,a,n,i,o,s,r,h){"use strict";var d;h.isMobile();return t.extend({init:function(t){this._parent(t,{isAsynchronous:!0,mode:"exclusive"}),this._exp=this.getFrameWindow().experience},beginExecute:function(){d=this,this.frameWindow=this.getFrameWindow(),this.viewer=this.frameWindow.getViewer(),0==this.viewer.isPaused()&&this.viewer.pauseVideo(),this.viewer.hideVideoControl(),this.holdingContainer=new UWA.Element("div",{id:"holdingContainer",styles:{position:"absolute",top:0,left:0,"z-index":2}}).inject(this.viewer.getVideoContainer()),this.holdingContainer.style.left=this.viewer.getCanvas().style.left,this.holdingContainer.style.top=this.viewer.getCanvas().style.top,this.holdingContainer.style.width=this.viewer.getCanvas().width+"px",this.holdingContainer.style.height=this.viewer.getCanvas().height+"px",this._enableEvents(),this.data=this.viewer.shapeEditionData},execute:function(){this.Draw2D=new n({frameWindow:this.frameWindow,holdingContainer:this.holdingContainer,annotationManager:r.get(this._ctx,"ANNOTATION_MANAGER"),hideTools:function(){d._removeTools()},data:this.data,mode:"edition",endCommandCB:this.endCommandCB}),this.Draw2D.begin()},endExecute:function(){this.viewer.showVideoControl(),this._disableEvents(),this._endCommands(),this.Draw2D&&(this.Draw2D.destroy(),this.Draw2D=void 0),this.Text2D&&(this.Text2D.destroy(),this.Text2D=void 0),this.Erase2D&&(this.Erase2D.destroy(),this.Erase2D=void 0),this.holdingContainer&&(this.holdingContainer.destroy(),this.holdingContainer=void 0),this.viewer=void 0,this.frameWindow=void 0,d=null},_enableEvents:function(){this.frameWindow.getViewerFrame().addEvent("resize",d._onWidgetResize),this.MABShow=s.subscribe({event:"3DPlay.MAB.Show"},function(){d._exitAnnot()}),this.MABHide=s.subscribe({event:"3DPlay.MAB.Hide"},function(){d._exitAnnot()}),s.publish({event:"/3DPlay/ANNOTATIONVIDEO/STARTED",data:{}})},_disableEvents:function(){this.frameWindow.getViewerFrame().removeEvent("resize",d._onWidgetResize),s.publish({event:"/3DPlay/ANNOTATIONVIDEO/ENDED",data:{}}),s.unsubscribe(this.MABShow),s.unsubscribe(this.MABHide)},_endCommands:function(){this.annotationToolsMenu&&this.annotationToolsMenu.colorPaletteVisible&&this._hideColorPalette(),this.Draw2D&&this.Draw2D.isRunning()&&this.Draw2D.end()},endCommandCB:function(t){d._exitAnnot()},_removeTools:function(){this._hideColorPalette()},_hideColorPalette:function(t){this.annotationToolsMenu&&this.annotationToolsMenu.hideColorPalette&&this.annotationToolsMenu.hideColorPalette()},_onWidgetResize:function(){d._exitAnnot()},_exitAnnot:function(){d.end()}})}),define("DS/3DPlayVideoAnnotation/AnnotationCommands",["DS/ApplicationFrame/Command","DS/WebInfraUI/ContextualBarManager","DS/3DPlayAnnotationUtils/AnnotationToolsMenu","DS/3DPlayVideoAnnotation/VideoAnnotationDraw","DS/3DPlayVideoAnnotation/AnnotationVideoText","DS/3DPlayVideoAnnotation/AnnotationVideoErase","DS/CoreEvents/Events","DS/WebUtils/ContextedSingleton","DS/WebSystem/BrowserInfos"],function(t,e,a,n,i,o,s,r,h){"use strict";var d,l=h.isMobile();return t.extend({init:function(t){this._parent(t,{isAsynchronous:!0,mode:"exclusive"}),this._exp=this.getFrameWindow().experience},beginExecute:function(){d=this,this.frameWindow=this.getFrameWindow(),this.viewer=this.frameWindow.getViewer(),0==this.viewer.isPaused()&&this.viewer.pauseVideo(),this.viewer.hideVideoControl(),this.holdingContainer=new UWA.Element("div",{id:"holdingContainer",styles:{position:"absolute",top:0,left:0,"z-index":2}}).inject(this.viewer.getVideoContainer()),this.holdingContainer.style.left=this.viewer.getCanvas().style.left,this.holdingContainer.style.top=this.viewer.getCanvas().style.top,this.holdingContainer.style.width=this.viewer.getCanvas().width+"px",this.holdingContainer.style.height=this.viewer.getCanvas().height+"px",this.resizeToken=s.subscribe({event:"/3DPlay/VIDEO/RESIZE"},function(){d.holdingContainer.style.left=d.viewer.getCanvas().style.left,d.holdingContainer.style.top=d.viewer.getCanvas().style.top,d.holdingContainer.style.width=d.viewer.getCanvas().width+"px",d.holdingContainer.style.height=d.viewer.getCanvas().height+"px"}),this._enableEvents(),this.frameWindow.getViewerFrame().offsetHeight>240&&this.frameWindow.getViewerFrame().offsetWidth>240&&(l||this.frameWindow.getViewerFrame().offsetWidth<=480||this.frameWindow.getViewerFrame().offsetHeight<=290)&&(this.frameWindow.getActionBar().MAB.commandInBlackout=!0,this.frameWindow.getActionBar().MAB.show())},execute:function(){this.Draw2D=new n({frameWindow:this.frameWindow,holdingContainer:this.holdingContainer,annotationManager:r.get(this._ctx,"ANNOTATION_MANAGER"),hideTools:function(){d._removeTools()}}),this.Erase2D=new o({frameWindow:this.frameWindow,annotationManager:r.get(this._ctx,"ANNOTATION_MANAGER"),hideTools:function(){d._removeTools()}}),this._buildUI(),this.Draw2D.begin()},endExecute:function(){this.frameWindow.getViewerFrame().offsetHeight>240&&this.frameWindow.getViewerFrame().offsetWidth>240&&(l||!0===this.frameWindow.getActionBar().MAB.state.visible)&&(this.frameWindow.getActionBar().MAB.commandInBlackout=!1,this.frameWindow.getActionBar().MAB.showNone()),this._disableEvents(),this._endCommands(),this.viewer.showVideoControl(),this.resizeToken&&(s.unsubscribe(this.resizeToken),this.resizeToken=void 0),this.annotationToolsMenu&&(this.annotationToolsMenu.dispose(),this.annotationToolsMenu=void 0),this.contextualMenu&&this.contextualMenuToken&&(this.contextualMenu.removeButtons(this.contextualMenuToken),this.contextualMenu.dispose(),this.contextualMenuToken=void 0,this.contextualMenu=void 0),this.Draw2D&&(this.Draw2D.destroy(),this.Draw2D=void 0),this.Erase2D&&(this.Erase2D.destroy(),this.Erase2D=void 0),this.holdingContainer&&(this.holdingContainer.destroy(),this.holdingContainer=void 0),this.viewer=void 0,this.frameWindow=void 0,d=null},_enableEvents:function(){this.frameWindow.getViewerFrame().addEvent("resize",d._onWidgetResize),this.MABShow=s.subscribe({event:"3DPlay.MAB.Show"},function(){d._exitAnnot()}),this.MABHide=s.subscribe({event:"3DPlay.MAB.Hide"},function(){d._exitAnnot()}),s.publish({event:"/3DPlay/ANNOTATIONVIDEO/STARTED",data:{}})},_disableEvents:function(){this.frameWindow.getViewerFrame().removeEvent("resize",d._onWidgetResize),s.publish({event:"/3DPlay/ANNOTATIONVIDEO/ENDED",data:{}}),s.unsubscribe(this.MABShow),s.unsubscribe(this.MABHide)},_endCommands:function(){this.annotationToolsMenu&&this.annotationToolsMenu.colorPaletteVisible&&this._hideColorPalette(),this.Draw2D&&this.Draw2D.isRunning()&&this.Draw2D.end(),this.Erase2D&&this.Erase2D.isRunning()&&this.Erase2D.end()},_startCommand:function(t,e){this._hideColorPalette(),"2DDrawing"===t.id?this.Draw2D.begin():"2DErase"===t.id&&this.Erase2D.begin()},_buildUI:function(){var t=this.holdingContainer;this.contextualMenu=new e({frameWindow:this.frameWindow,container:t});var n,i=this.frameWindow.getActionBar();n=(i.MAB&&i.MAB.state.visible,[{id:"2DDrawing",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",selected:!0},{id:"2DErase",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation"}]);var o=[{type:this.contextualMenu.Button.Radio,content:n,onclickCB:function(t){d._endCommands(),d._startCommand(t)}},{type:this.contextualMenu.Button.Master,id:"ExitAnnotation",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",onclickCB:function(){d._exitAnnot()}}];this.contextualMenuToken=this.contextualMenu.addButtons(o,{barType:this.contextualMenu.Toolbar.New,showContextBarBackground:!0}),this.annotationToolsMenu=new a({contextualMenu:this.contextualMenu,frameWindow:this.frameWindow,container:t,newToolsUI:!0}),this.annotationToolsMenu.addToolsButton(),this.contextualMenu.panel.container.style.cursor="pointer",this._hideColorPalette()},_removeTools:function(){this._hideColorPalette()},_hideColorPalette:function(t){this.annotationToolsMenu&&this.annotationToolsMenu.hideColorPalette&&this.annotationToolsMenu.hideColorPalette()},_onWidgetResize:function(){},_exitAnnot:function(){d.end()}})}),define("DS/3DPlayVideoAnnotation/AnnotationCommandsVideoText",["DS/ApplicationFrame/Command","DS/WebInfraUI/ContextualBarManager","DS/3DPlayAnnotationUtils/AnnotationToolsMenu","DS/3DPlayVideoAnnotation/VideoAnnotationDraw","DS/3DPlayVideoAnnotation/AnnotationVideoText","DS/3DPlayVideoAnnotation/AnnotationVideoErase","DS/CoreEvents/Events","DS/WebUtils/ContextedSingleton","DS/WebSystem/BrowserInfos"],function(t,e,a,n,i,o,s,r,h){"use strict";var d,l=h.isMobile();return t.extend({init:function(t){this._parent(t,{isAsynchronous:!0,mode:"exclusive"}),this._exp=this.getFrameWindow().experience},beginExecute:function(){d=this,this.frameWindow=this.getFrameWindow(),this.viewer=this.frameWindow.getViewer(),0==this.viewer.isPaused()&&this.viewer.pauseVideo(),this.viewer.hideVideoControl(),this.holdingContainer=new UWA.Element("div",{id:"holdingContainer",styles:{position:"absolute",top:0,left:0,"z-index":2}}).inject(this.viewer.getVideoContainer()),this.holdingContainer.style.left=this.viewer.getCanvas().style.left,this.holdingContainer.style.top=this.viewer.getCanvas().style.top,this.holdingContainer.style.width=this.viewer.getCanvas().width+"px",this.holdingContainer.style.height=this.viewer.getCanvas().height+"px",this.resizeToken=s.subscribe({event:"/3DPlay/VIDEO/RESIZE"},function(){d.holdingContainer.style.left=d.viewer.getCanvas().style.left,d.holdingContainer.style.top=d.viewer.getCanvas().style.top,d.holdingContainer.style.width=d.viewer.getCanvas().width+"px",d.holdingContainer.style.height=d.viewer.getCanvas().height+"px"}),this._enableEvents(),this.data=this.viewer.shapeEditionData},execute:function(){var t;if(this.Text2D=new i({isMobile:l,frameWindow:this.frameWindow,holdingContainer:this.holdingContainer,annotationManager:r.get(this._ctx,"ANNOTATION_MANAGER"),hideTools:function(){d._removeTools()},data:this.data,mode:"edition",endCommandCB:this.endCommandCB}),this.data){var e=this.viewer.translateToViewerPosition(this.data.point);if(e){var a=this.viewer.getUnderneathAnnotations(e);if(a&&a.annotIDDelList&&a.annotIDDelList.length){var n=a.annotationData;r.get(this._ctx,"ANNOTATION_MANAGER").destroyShapes({idList:a.annotIDDelList});var o=this.viewer.getCurrentTime();r.get(this._ctx,"ANNOTATION_MANAGER").render({currTime:o}),t={annotationData:n}}}}this.Text2D.begin({data:t})},endExecute:function(){this.viewer.showVideoControl(),this._disableEvents(),this._endCommands(),this.resizeToken&&(s.unsubscribe(this.resizeToken),this.resizeToken=void 0),this.Text2D&&(this.Text2D.destroy(),this.Text2D=void 0),this.holdingContainer&&(this.holdingContainer.destroy(),this.holdingContainer=void 0),this.viewer=void 0,this.frameWindow=void 0,d=null},_enableEvents:function(){this.frameWindow.getViewerFrame().addEvent("resize",d._onWidgetResize),this.MABShow=s.subscribe({event:"3DPlay.MAB.Show"},function(){d._exitAnnot()}),this.MABHide=s.subscribe({event:"3DPlay.MAB.Hide"},function(){d._exitAnnot()}),s.publish({event:"/3DPlay/ANNOTATIONVIDEO/STARTED",data:{}})},_disableEvents:function(){this.frameWindow.getViewerFrame().removeEvent("resize",d._onWidgetResize),s.publish({event:"/3DPlay/ANNOTATIONVIDEO/ENDED",data:{}}),s.unsubscribe(this.MABShow),s.unsubscribe(this.MABHide)},_endCommands:function(){var t=!1;this.isCanceled()&&(t=!0),this.Text2D&&this.Text2D.isRunning()&&this.Text2D.end({isCommandcancelled:t})},endCommandCB:function(t){d._exitAnnot()},_removeTools:function(){},_onWidgetResize:function(){},_exitAnnot:function(){d.end()}})});