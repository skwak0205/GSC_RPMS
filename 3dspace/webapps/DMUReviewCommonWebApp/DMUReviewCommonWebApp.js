define("DS/DMUReviewCommonWebApp/DMUCommonWebAppController",["UWA/Class","DS/DMUControls/EXPNotify","DS/DMUReadPersistence/DMULoadMarkupServices","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUPlaySlide/controllers/DMUSlideShowController","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents","DS/DMUBaseUIControllers/DMU2DSheetManager","DS/DMUBaseUIControllers/DMUCommentsController","DS/PADUtils/PADUtilsServices","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUReviewPersistence/DMUAuthReviewPersistenceServices","DS/DMUControls/DMUInfoModalDiv","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUReadPersistence/DMULoadingContextController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/DMUReadPersistence/DMUWebServicesUtils","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADProgressBar","DS/PADServices/utils/GlobalModelEvents","DS/DMUBaseUIControllers/DMUSceneDisplayController","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUPlayMarker/DMUMarkerFactory","DS/DMUPlayMarker/DMUMarkerServices","DS/DMUControls/DMUWarningPanel","DS/Selection/PSOManager","DS/ApplicationFrame/CommandsManager","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUReviewController","DS/CATWebUXComponents/CATWebUXUtils","i18n!DS/DMUBaseUI/assets/nls/DMUBaseUI","DS/CATWebUXSlideDrop/CATWebUXSlideDropServices","i18n!DS/DMUReviewCommonWebApp/assets/nls/DMUReviewCommonWebApp"],function(e,t,n,i,a,o,r,l,s,d,c,u,g,p,m,f,D,h,v,w,C,S,b,M,y,R,P,V,U,A,x,I,k,E,F,O,T,_,L,W){"use strict";return e.extend({init:function(N,j){this._parent(N);var B,q,H,X,G,J,z,Q,K,Y,$,Z,ee,te,ne,ie,ae,oe,re,le,se,de,ce,ue,ge,pe=this,me=!1,fe=j,De=(N||{}).ctxViewer,he=i.getEventsController({viewer:De.getViewer()}),ve=!1,we=new c,Ce={},Se={},be=null,Me={},ye={},Re=!1,Pe=!1;let Ve,Ue,Ae=!1,xe=!1,Ie=!0;const ke=["SIMItfSimulation","PLMPIMMetricReference","Document","DIFLayout","DIFSheet","DIFAnnotationSet","Requirement","Requirement Specification","DesignSight"];function Ee(e,n){Ue&&(Ue.destroy(),Ue=null),Ue=new t({body:De.getFrameWindow().getUIFrame(),type:e,message:n})}this.setSlideShowController=function(e){B=e},this.setValidatedObjCreationFlag=function(e){ve=e};var Fe,Oe,Te,_e=function(){return q||(q=F.giveDMUSlidesController({context:De.getFrameWindow()})),q};function Le(){"R3V"===fe?(ce&&clearTimeout(ce),ce=setTimeout(function(){if(ce=null,!De)return;var e,t,n=i.getReviewContext({context:De});e=["DMU2DCompareCmdHdr"],t=me&&0!==De.getViewer().getVisibleSpace()&&l.getRoots(De).length&&(!n||n&&!n.isReadOnly())&&K&&("Drawing"===ge||"DIFSheet"===ge||"DIFLayout"===ge);let o=!0;n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getActiveFlag()&&n.getCurrentSessionMarkup().isVisible()&&n.getCurrentSessionMarkup().getMarkupOwner()&&!n.getCurrentSessionMarkup().getMarkupOwner().isWebMarkup()&&(o=!1),pe._applyFlag(e,t&&o),e=["measureCmdHdr","sectionCmdHdr","3DcompareCmdHdr","thicknessCmdHdr","LockUnlockSectionHdr"],t=me&&0!==De.getViewer().getVisibleSpace()&&l.getRoots(De).length&&(!n||n&&!n.isReadOnly()),o=!0,n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getActiveFlag()&&n.getCurrentSessionMarkup().isVisible()&&n.getCurrentSessionMarkup().getMarkupOwner()&&!n.getCurrentSessionMarkup().getMarkupOwner().isWebMarkup()&&(o=!1),pe._applyFlag(e,t&&o),t=(t||!t&&!l.getRoots(De).length)&&n&&!n.isReadOnly()&&n.getCurrentSessionMarkup()&&!n.getCurrentSessionMarkup().isReadOnly();let r=n&&n.getValidation()?n.getValidation().getCurrentMarkup():null;for(;r&&"Markup"!==r.getValType();)r=r.getParentRepRef().getParent();o=!0,r&&!1===r.isWebMarkup()&&(o=!1),e=["DMUEditFormatsHdr","slideCmdHdr","DMUExportReviewAsPdfHdr"],pe._applyFlag(e,t&&o),t=me&&0!==De.getViewer().getVisibleSpace()&&n&&n.getValidation()&&!n.isReadOnly(),e=["DMUReviewMarkupHdr","DMUAddCheckHdr","CATWebUXGenerateIssueHdr","CATWebUXGenerateCAHdr"],pe._applyFlag(e,t),t=t&&n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getActiveFlag()&&n.getCurrentSessionMarkup().isVisible()&&n.getCurrentSessionMarkup().getCurrentSlide()&&n.getCurrentSessionMarkup().getCurrentSlide().isVisible(),e=["DMUAddHighlightHdr"],pe._applyFlag(e,t),t=t&&n&&!n.isReadOnly()&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getActiveFlag()&&n.getCurrentSessionMarkup().isVisible()&&n.getCurrentSessionMarkup().getCurrentSlide()&&n.getCurrentSessionMarkup().getCurrentSlide().isVisible()&&!n.getCurrentSessionMarkup().isReadOnly(),e=["markerTextCmdHdr","markerPictureCmdHdr","marker2DTextCmdHdr","marker2DPictureCmdHdr","markerCircleCmdHdr","DMU3DRectangleCmdHdr","DMUFreehandCmdHdr","DMUCommentCmdHdr","DMUCreateValidatedMkrHdr","DMUCreateRejectedMkrHdr","markerArrowCmdHdr"],pe._applyFlag(e,t),t=me&&0!==De.getViewer().getVisibleSpace()&&l.getRoots(De).length&&n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getSlides().length>0||"Document"===z||"Requirement"===Q||"Requirement Specification"===Q,e=["CATWebUXSlideShowHdr"],pe._applyFlag(e,t),t=me&&(!n||!n.isReadOnly())&&("Document"===z||"Requirement"===Q||"Requirement Specification"===Q)&&J&&J.documentHasBookmarks(),e=["WebDocumentBookmarksPanelCmdHdr"],pe._applyFlag(e,t),t=me&&("Document"===z||"Requirement"===Q||"Requirement Specification"===Q)&&J&&J.documentHasMultipleElements(),e=["WebDocumentPreviousPageCmdHdr","WebDocumentNextPageCmdHdr"],pe._applyFlag(e,t),t=me&&("Document"===z||"Requirement"===Q||"Requirement Specification"===Q)&&J&&"Document"===J.getDocumentType(),e=["WebDocumentRotatePagesLeftCmdHdr","WebDocumentRotatePagesRightCmdHdr"],pe._applyFlag(e,t);var s=a.getManager({name:"DMUUserExperienceManager",context:De.getFrameWindow()});s&&s.refreshCCPCommandsAvailability()})):(ce&&clearTimeout(ce),ce=setTimeout(function(){if(ce=null,!De)return;var e,t,n=i.getReviewContext({context:De});e=["DMU2DCompareCmdHdr"],t=me&&0!==De.getViewer().getVisibleSpace()&&l.getRoots(De).length&&(!n||n&&!n.isReadOnly())&&("Drawing"===ge||"DIFSheet"===ge||"DIFLayout"===ge);let o=!0;n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getActiveFlag()&&n.getCurrentSessionMarkup().isVisible()&&n.getCurrentSessionMarkup().getMarkupOwner()&&!n.getCurrentSessionMarkup().getMarkupOwner().isWebMarkup()&&(o=!1),pe._applyFlag(e,t&&o),e=["measureCmdHdr","sectionCmdHdr","3DcompareCmdHdr","thicknessCmdHdr","LockUnlockSectionHdr"],t=me&&0!==De.getViewer().getVisibleSpace()&&l.getRoots(De).length&&(!n||n&&!n.isReadOnly()),o=!0,n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getActiveFlag()&&n.getCurrentSessionMarkup().isVisible()&&n.getCurrentSessionMarkup().getMarkupOwner()&&!n.getCurrentSessionMarkup().getMarkupOwner().isWebMarkup()&&(o=!1),pe._applyFlag(e,t&&o),t=(t||!t&&!l.getRoots(De).length)&&n&&!n.isReadOnly()&&n.getCurrentSessionMarkup()&&!n.getCurrentSessionMarkup().isReadOnly();let r=n&&n.getValidation()?n.getValidation().getCurrentMarkup():null;for(;r&&"Markup"!==r.getValType();)r=r.getParentRepRef().getParent();o=!0,r&&!1===r.isWebMarkup()&&(o=!1),e=["DMUEditFormatsHdr","slideCmdHdr","DMUExportReviewAsPdfHdr"],pe._applyFlag(e,t&&o),t=t&&n&&!n.isReadOnly()&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getActiveFlag()&&n.getCurrentSessionMarkup().isVisible()&&n.getCurrentSessionMarkup().getCurrentSlide()&&n.getCurrentSessionMarkup().getCurrentSlide().isVisible()&&!n.getCurrentSessionMarkup().isReadOnly(),e=["markerTextCmdHdr","markerPictureCmdHdr","marker2DTextCmdHdr","marker2DPictureCmdHdr","markerCircleCmdHdr","DMU3DRectangleCmdHdr","DMUFreehandCmdHdr","DMUCommentCmdHdr","DMUCreateValidatedMkrHdr","DMUCreateRejectedMkrHdr","markerArrowCmdHdr"],pe._applyFlag(e,t),t=l.getRoots(De).length,e=["DMUReviewHdr"],pe._applyFlag(e,t),t=me&&0!==De.getViewer().getVisibleSpace()&&n&&n.getValidation()&&!n.isReadOnly(),e=["DMUReviewMarkupHdr","CATWebUXGenerateIssueHdr","CATWebUXGenerateCAHdr"],pe._applyFlag(e,t),t=me&&0!==De.getViewer().getVisibleSpace()&&l.getRoots(De).length&&n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getSlides().length>0||"Document"===z||"Requirement"===Q||"Requirement Specification"===Q,e=["CATWebUXSlideShowHdr"],pe._applyFlag(e,t),t=me&&(!n||!n.isReadOnly())&&("Document"===z||"Requirement"===Q||"Requirement Specification"===Q)&&J&&J.documentHasBookmarks(),e=["WebDocumentBookmarksPanelCmdHdr"],pe._applyFlag(e,t),t=me&&("Document"===z||"Requirement"===Q||"Requirement Specification"===Q)&&J&&J.documentHasMultipleElements(),e=["WebDocumentPreviousPageCmdHdr","WebDocumentNextPageCmdHdr"],pe._applyFlag(e,t),t=me&&("Document"===z||"Requirement"===Q||"Requirement Specification"===Q)&&J&&"Document"===J.getDocumentType(),e=["WebDocumentRotatePagesLeftCmdHdr","WebDocumentRotatePagesRightCmdHdr"],pe._applyFlag(e,t);var s=a.getManager({name:"DMUUserExperienceManager",context:De.getFrameWindow()});s&&s.refreshCCPCommandsAvailability()}))}function We(e){z!==e&&(z&&Y&&Y.removeApplicativeContainer(z),z=e,i.setCurrentReviewContext(z),pe.publish("onReviewContextModified",{type:z,onABReady:Le}),Y.initApplicativeContainer(z,{authoring:!0})),Le()}function Ne(e,t){let n=[];l.getRoots(De).forEach(i=>{const a=De.getController().getRootStats(l.getNodeID(i))&&"r2vsurvey"===De.getController().getRootStats(l.getNodeID(i)).serviceId?"R2V_FeatureState":l.getNodeType(i);e&&a===e||l.getNodeID(i)!==t&&("VPMReference"===e&&"R2V_FeatureState"===a||"R2V_FeatureState"===e&&"VPMReference"===a||n.push(l.getNodeID(i)))}),n.length&&De.removeRoots({pids:n})}async function je(e){try{let t=await b.getParentTypes(e);return[e].concat(t)}catch{return[e]}}async function Be(e){if(!me||!e)return;var t,n;if(ge=void 0,e.path?(t=l.getNodeID(e.path.getLastElement(!0)),n=De.getController().getRootStats(t)&&"r2vsurvey"===De.getController().getRootStats(t).serviceId?"R2V_FeatureState":l.getNodeType(e.path.getLastElement(!0))):e.docData&&(t=e.docData.objectId,n=e.docData.objectType),!t||!n)return;ge=n,K&&K.getLoadedID()===t||(J&&J.getDocumentLoadedID()!==t&&!Pe&&J.clean2DDocument(),de&&!Re&&de.cleanCommentsPanel(),K&&K.clean()),$=null;var i=function(){We("ITF")};var a=async function(){Ne("R2V_FeatureState",t),await async function(){const e=l.getRoots(De);let t=!1;for(let n=0;n<e.length;n++){let i=l.getNodeType(e[n]),a=0;const o=await je(i);if(o.includes("VPMReference")||a===e.length-1)return o.includes("VPMReference")&&(t=!0),t;a++}}()||We("R2V"),K.load({data:{serviceId:"r2vsurvey",objectParentType:"R2V_FeatureState",objectType:"R2V_FeatureState",objectId:t}})},o=function(){if("DIFLayout"===n||"DIFSheet"===n)We("2DFL");else if("Drawing"===n){We("2D"),Pe||Ne(null,t);var e=setInterval(function(){var i,a,o,r;(1===De.getRootBagPath().getChildrenPathes().length||Pe&&2===De.getRootBagPath().getChildrenPathes().length)&&(clearInterval(e),i=t,a=n,o=De.getRootBagPath().getChildrenPathes()[De.getRootBagPath().getChildrenPathes().length-1].getLastElement(!0),J.load2DDocument({phyID:i,dataType:a,serverUrl:p.get3DSpaceUrl(),securityContext:M.getSetting("pad_security_ctx"),parentNode:o,is2DCompareActive:Pe,onLoadingStarted:function(){y.on(),r=1},onComplete:function(){r&&(y.off(),r=0)},onFailure:function(){De.removeRoots({pids:[i]}),De.displayNotification({msg:W.fileWithNoSVG,eventID:"error"}),r&&(y.off(),r=0),he&&"R3V"===fe&&he.fireEvent("on2DDocumentLoadFailure")}}))},100)}},r=function(){!K||"DXF"!==K.getLoadMarkupCtxType()&&"DWG"!==K.getLoadMarkupCtxType()?(We(n),Ne(null,t)):(We("2D"),Ne(null,t)),$=t};if("Drawing"===n||"DIFLayout"===n||"DIFSheet"===n&&e.path.getParentPath().isEqual(De.getRootBagPath()))o(),Q=n;else if("Document"===n||"Requirement"===n||"Requirement Specification"===n)r(),Q=n;else if(De.getApplicativeData().getLoadedItfData&&De.getApplicativeData().getLoadedItfData().data.length>0)i(),Q="SIMItfSimulation";else if("DesignSight"===n)We("MSR"),Q="MSR";else if("R2V_FeatureState"===n)a(),Q="R2V";else{const l=await je(n);l&&l.length&&-1!==l.indexOf("Drawing")&&e.path.getParentPath().isEqual(De.getRootBagPath())?(n=Q="Drawing",o()):l&&l.length&&-1!==l.indexOf("SIMItfSimulation")&&e.path.getParentPath().isEqual(De.getRootBagPath())?(n=Q="SIMItfSimulation",i()):l&&l.length&&(-1!==l.indexOf("Requirement")||-1!==l.indexOf("Requirement Specification"))?(n=-1!==l.indexOf("Requirement Specification")?"Requirement Specification":"Requirement",Q="Requirement",r()):l&&l.length&&-1!==l.indexOf("Document")?(n=Q="Document",r()):l&&l.length&&-1!==l.indexOf("R2V_FeatureState")?(a(),Q="R2V"):ue?De.removeRoots({pids:[t]}):(Ne("VPMReference",t),We("3D"))}Le()}function qe(){var e=i.getReviewContext({context:De}),t=e?e.getValidation():null;if(t){let e=t.getAllRepRefs().filter(e=>{let t=e.getMarkupContent();if(t)return t.isDirty()&&!t.isReadOnly()&&!e.isBeingRemoved()});me&&!oe&&e&&e.length&&(Fe&&clearTimeout(Fe),Oe&&clearTimeout(Oe),ae&&ae.destroy(),Fe=setTimeout(function(){if(me&&!oe&&i.getReviewContext({context:De}))if(D.isProcessing())Oe=setTimeout(qe,1e3);else{if(De){ae||(ae=new h),ae.display({frmWindow:De.getFrameWindow(),type:"save"});let t=[],n=0;e.forEach(e=>t.push(function(e){return new Promise((t,n)=>{let i,a,o,r,l,s=null;Q&&"Document"===Q&&(l=K.getDocumentVersionInfos(),r="Document",s=K.getLoadMarkupCtxType()),De.getApplicativeData&&(De.getApplicativeData(),De.getApplicativeData().getLoadedItfData&&(i=De.getApplicativeData().getLoadedItfData()).data.length&&(i.data[0].metricID&&(a=i.data[0].metricID),void 0!==i.loadMode&&(o=i.loadMode),r="SIMItfSimulation")),D.saveReviewMarkup({markupRepRefId:e,frmWindow:De.getFrameWindow(),superType:r,documentType:s,listData:a,loadingInfos:o,documentVersionInfos:l,onSaveCompleted:t,onSaveFailed:n})})}(e.getPlmID()))),Promise.allSettled(t).then(e=>{if(e.forEach(e=>{"fulfilled"!==e.status&&"NoSaveNeeded"!==e.reason||n++}),n===t.length){ae&&ae.destroy(),i.giveEventsController({viewer:De.getViewer()}).fireEvent("onReviewSaved")}else{ae&&(ae.destroy(),ae.display({frmWindow:De.getFrameWindow(),type:"error"})),i.giveEventsController({viewer:De.getViewer()}).fireEvent("onReviewSaveFailed"),Oe=setTimeout(qe,5e3)}})}Fe=null}},750))}}function He(){qe(),Le()}function Xe(){const e=i.getReviewContext({context:De});(e?e.getValidation():null)&&setTimeout(()=>{De.toggleSOITimelinesUsability(!1)},1e3)}function Ge(e){if(!me)return;oe=!1,Ae=!1;var t=P.giveDMUSceneDisplayController({context:De});const n=t=>{var n=i.getReviewContext({viewer:De.getViewer()});if(n&&n.getValidation()&&"R3V"===fe){var a=n.getValidation().getContext(),o=De.getApplicativeData().getLoadedItfData&&De.getApplicativeData().getLoadedItfData().data.length>0?[De.getApplicativeData().getLoadedItfData().data[0].isrID]:[e.id];const i=i=>{D.updateReviewContext({ctxViewer:De,validation:n.getValidation(),contextId:o[0],rootData:{label:i.label,icon:i.icon,type:i.type},onUpdateReviewContextCompleted:function(){"DesignSight"!==t&&"DIFLayout"!==t&&"Requirement Specification"!==t&&D.updateValidatedObjectsList({fullPathRefs:[[e.id]],validatedObjects:[[e.id]],validatedId:n.getValidation().getValidated().getPlmID()?n.getValidation().getValidated().getPlmID():null,validatedToAdd:[[e.id]],referenceIds:[e.id],instanceIds:[e.id],instanceNames:[],updateMode:"add",onReviewCtxUpdateOrDropValidated:!0,ctxViewer:De.getFrameWindow().getViewer(),onSaveValidatedObjectsFailed:function(){}})},onUpdateReviewContextFailed:function(){}})};if(!a||a&&!a.getJsonContexts().length)if("R2V_FeatureState"===t){let e=setInterval(()=>{if(K&&K.getLoadedR2VInformations().length){clearInterval(e);let t=K.getLoadedR2VInformations()[0].info;i({label:t[0]["ds6w:label"],icon:t[0].icon,type:"R2V_FeatureState"})}},100)}else De.getController().getAttributes({ids:o,attributes:["ds6w:label","type_icon_url","ds6w:type"],callbacks:{onComplete:function(e){i({label:e[o[0]]["ds6w:label"],icon:e[o[0]].type_icon_url,type:e[o[0]]["ds6w:type"]})},onFailure:function(){}}})}};if((!t||!t.getCurrentComparedObjectIDPaths()&&B&&B.getActiveState())&&B.setActiveState(!1),e.id===sessionStorage.getItem("DMU2DCompareTempRoot"))De.removeRoots({pids:[sessionStorage.getItem("DMU2DCompareTempRoot")]}),sessionStorage.removeItem("DMU2DCompareTempRoot");else if(e.path){Be({path:e.path}),n(l.getNodeType(e.path.getLastElement(!0))),$=null}else{var a=De.getRootBagPath().externalPath[0].path.getChildrenPathes().length;if(a){var o=De.getRootBagPath().externalPath[0].path.getChildrenPathes()[a-1];Be({path:o}),n(l.getNodeType(o.getLastElement(!0)))}}}function Je(e){if(me){if(!De.getRootBagPath().getChildrenPathes().length&&B&&B.getActiveState()&&B.setActiveState(!1),J&&(e&&e.id?J.clean2DDocument(e):J.clean2DDocument()),de&&(de.cleanCommentsPanel(),g.unreferenceDMUCommentsController({context:De.getFrameWindow()}),de=null),ge&&"R2V_FeatureState"===ge&&De.toggleSOITimelinesUsability(!0),De.getRootBagPath().getChildrenPathes().length){var t=De.getRootBagPath().externalPath[0].path.getChildrenPathes().length;let e;t&&(e=De.getRootBagPath().externalPath[0].path.getChildrenPathes()[t-1]),ge=l.getNodeType(e.getLastElement(!0))}else oe=!0,i.setReviewContext({context:De});K&&(K.clean(),K.setLoadedR2VInformations([])),Le()}}function ze(){De.unsubscribe(Ce.onRootRemoved),Ce.onRootRemoved=-1}function Qe(){Ce.onRootRemoved=De.subscribe({event:"onRootRemoved"},Je)}function Ke(e){Te=V.getNearPositionFrom2DCoordinates({x:e.clientX,y:e.clientY},De.getViewer())}function Ye(e){me&&pe&&e&&p.multiTenantMgt([e],l.getRoots(De),function(t){if(!t.isMultiTenant){var n=i.getReviewContext({context:De}),a=n?n.getCurrentSessionMarkup():null;if(!a||a.isReadOnly()||!a.getCurrentSlide())return;A.getDataFromRelatedId({type:"DMUMarker3DPicture",objectId:e.objectId,onComplete:function(t){var n=U.create3DMarker({viewer:De.getViewer(),frameWindow:De.getFrameWindow(),parent:a,date:Date.now(),objectId:e.objectId,shape:{type:"picture",pointingPoint:Te,data:t}});n&&(a.getCurrentSlide().addDMUObject(n),n.fireEvent("onDMUObjectInitialized",{dmuObject:n}))}})}})}function $e(e){me&&pe&&e&&Ie&&p.multiTenantMgt([e],l.getRoots(De),function(t){t.isMultiTenant||pe.loadMarkupContext(e)})}this.loadReviewAfterRefresh=function(e){"_DMUValidationValidation"!==e.type&&"DMUValidationValidation"!==e.displayType||pe.loadContext(e,me,"_DMUValidationValidation","refreshMode",!0,pe),"_DMUValidationExposedPresentation"===e.type&&pe.loadContext(e,me,"_DMUValidationExposedPresentation","refreshMode",!0,pe)},this.loadContext=function(e,t,n,a){var o;t&&pe&&e&&(o=H&&H.objectId===e.reviewId?H:e,p.multiTenantMgt([o],l.getRoots(De),function(e){if(!e.isMultiTenant&&("_DMUValidationValidation"===n||"_DMUValidationExposedPresentation"===n)){var t={};t.loadMode=a||null,t.reviewId=o.objectId,t.context=De,t.displayName=o.displayName,t.displayType=o.displayType?o.displayType:"DMUValidationValidation"===o.objectType?"Review":void 0,t.type="_DMUValidationValidation"===n?"DMUValidationValidation":"DMUValidationExposedPresentation",t.readOnly=!1,t.cbRootAdded=function(){H=o},t.cbOK=function(e){let t=!1;e&&!0===e.sameReview&&(t=!0);var n=v.createReviewContext({context:De}),a=_e(),r=n.getValidation(),l=r.getLoadedRepRefs();l.length>0&&a&&(a=F.giveDMUSlidesController({context:De.getFrameWindow()}),pe.autoReframe=!1,"DMUValidationValidation"!==o.objectType&&"_DMUValidationValidation"!==o.objectType||t||a.setActiveSlide(l[0].getMarkupContent().getSlides()[0]));var s,d,c=[];let u=r.getHighlights();if(u&&u.length)for(s=0;s<u.length;s++)c.push(u[s]);if(d=[],r){var p=r.getLoadedRepRefs();for(s=0;s<p.length;s++){d=d.concat(p[s].getMarkupContent().getSlides());for(let e=0;e<p[s].getMarkupContent().getSlides().length;e++){var m=p[s].getMarkupContent().getSlides()[e].getDMUObjects();for(let e=0;e<m.length;e++)m[e].getDMUComments&&(d=d.concat(m[e].getDMUComments()))}}let e,t,n=i.getReviewContext({viewer:De.getFrameWindow().getViewer()}),a=r.getContext()?r.getContext().getJsonContexts():null;a.length>0&&(e=a[0].id,t=a[0].type),n.setReviewCtxInformation({contextId:e,contextType:t,reviewId:r.getPlmID(),reviewName:r.getName(),reviewType:r.getValType(),owner:r.getOwner()})}var f=function(e,t){g.giveDMUCommentsController({context:De.getFrameWindow()}).applyComment({commentId:e,markupId:t})};let D,h=(e,t)=>{D||(D=he.addEvent("on2DDocumentLoadSuccess",function(){f(e,t),he&&D&&he.removeEvent(D),D=null}))};for(let e=0;e<d.length;e++)for(let n=0;n<c.length;n++)if(c[n].getAttribute("sPresentationSlideID")===d[e].getAttribute("sUuid")){if(c[n].getPlmID()===o.objectId)if("DMUSlide"===d[e].getType())a&&a.setActiveSlide(d[e]);else if("DMUComment"===d[e].getType()){let i=d[e].getAttribute("sUuid"),a=c[n].getAttribute("sRepRefMarkupID");t?f(i,a):h(i,a)}t||pe.highlightInitialization({highlight:c[n],slide:d[e]})}he.addEvent("onReplyExpandRequest",function(e){let t=i.getReviewContext({viewer:De.getFrameWindow().getViewer()}),n=t.getValidation();he.fireEvent("onGetMarkupJsonEvt",{markup:n.getRepRef(e.data.id),onLoadingCompleted:function(e,i){n.setCurrentMarkup(i),he.fireEvent("onImportModelEvt",{asset:e,onImportCompleted:function(){var e=t.getCurrentSessionMarkup();i.setMarkupContent(e),e.setMarkupOwner(i),a&&a.setActiveSlide(e.getSlides()[0]),e.setReadOnly(t.isReadOnly());let o=n.getHighlightsData();if(o&&o.length)for(d=e.getSlides(),s=0;s<o.length;s++)for(var r=0;r<d.length;r++)o[s].slideId===d[r]._sUuid&&pe.highlightInitialization({highlight:o[s],slide:d[r]})}})}})})},t.cbFailed=function(){},pe.loadValidation(t),E.setSlidePreferences({context:De.getFrameWindow(),preferences:{displayNominal:!1,displayInWork:!1}})}}))},this.createSharedPreferences=function(e){e&&e.addPreferences([{nls:W.markerPrefTitle,id:"MarkerPreferences",type:"section",preferences:[{nls:W.validatedStampMarkerLabel,id:"DMUMarkerValidatedStampLabel",type:"editor",getValue:function(){return localStorage.getItem("DMUMarkerValidatedStampLabel")||_.defaultValidatedStampLabel},getDefaultValue:function(){return _.defaultValidatedStampLabel},setValue:function(e){e!==localStorage.getItem("DMUMarkerValidatedStampLabel")&&localStorage.setItem("DMUMarkerValidatedStampLabel",e)}},{nls:W.rejectedStampMarkerLabel,id:"DMUMarkerRejectedStampLabel",type:"editor",getValue:function(){return localStorage.getItem("DMUMarkerRejectedStampLabel")||_.defaultRejectedStampLabel},getDefaultValue:function(){return _.defaultRejectedStampLabel},setValue:function(e){e!==localStorage.getItem("DMUMarkerRejectedStampLabel")&&localStorage.setItem("DMUMarkerRejectedStampLabel",e)}}]},{nls:W.compareSectionTitle,id:"ComparePreferences",type:"section",preferences:[{nls:W.firstProductColor,id:"DMUCompareFirstColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompareFirstColor")?localStorage.getItem("DMUCompareFirstColor"):"#FF0000"},getDefaultValue:function(){return"#FF0000"},setValue:function(e){localStorage.setItem("DMUCompareFirstColor",e),he&&he.fireEvent("onDMUPreferencesChanged",{DMUCompareFirstColor:e})}},{nls:W.secondProductColor,id:"DMUCompareSecondColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompareSecondColor")?localStorage.getItem("DMUCompareSecondColor"):"#00FF00"},getDefaultValue:function(){return"#00FF00"},setValue:function(e){localStorage.setItem("DMUCompareSecondColor",e),he&&he.fireEvent("onDMUPreferencesChanged",{DMUCompareSecondColor:e})}},{nls:W.compare3DCommonColor,id:"DMUCompare3DCommonColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompare3DCommonColor")?localStorage.getItem("DMUCompare3DCommonColor"):"#D3D3D3"},getDefaultValue:function(){return"#D3D3D3"},setValue:function(e){localStorage.setItem("DMUCompare3DCommonColor",e),he&&he.fireEvent("onDMUPreferencesChanged",{DMUCompare3DCommonColor:e})}},{nls:W.compare2DCommonColor,id:"DMUCompare2DCommonColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompare2DCommonColor")?localStorage.getItem("DMUCompare2DCommonColor"):"#000000"},getDefaultValue:function(){return"#000000"},setValue:function(e){localStorage.setItem("DMUCompare2DCommonColor",e),he&&he.fireEvent("onDMUPreferencesChanged",{DMUCompare2DCommonColor:e})}}]},{nls:W.slideSectionTitle,id:"SlidePreferences",type:"section",preferences:[{nls:W.slideNameFromFeature,id:"DMUSlideNameFromFeature",type:"checkbox",getValue:function(){return"false"!==localStorage.getItem("DMUSlideNameFromFeature")},getDefaultValue:function(){return!0},setValue:function(e){e!==("false"!==localStorage.getItem("DMUSlideNameFromFeature"))&&(localStorage.setItem("DMUSlideNameFromFeature",e?"true":"false"),he&&he.fireEvent("onDMUPreferencesChanged",{DMUSlideNameFromFeature:e}))}},{nls:W.slideTitleDisplayLbl,id:"DMUDisplaySlideTitle",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("DMUDisplaySlideTitle")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("DMUDisplaySlideTitle"))&&(localStorage.setItem("DMUDisplaySlideTitle",e?"true":"false"),he&&he.fireEvent("onDMUPreferencesChanged",{DMUDisplaySlideTitle:e}))}},{nls:W.preferences.slideCaptureSpecLayers,id:"DMUCaptureSpecLayers",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("DMUCaptureSpecLayers")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("DMUCaptureSpecLayers"))&&(localStorage.setItem("DMUCaptureSpecLayers",e?"true":"false"),he&&he.fireEvent("onDMUPreferencesChanged",{DMUCaptureSpecLayers:e}))}},{nls:W.preferences.slideEnableDrag,id:"DMUEnableSlideDragContent",type:"radio",getValue:function(){return localStorage.getItem("DMUEnableSlideDragContent")||"0"},getDefaultValue:function(){return"0"},setValue:function(e){e!==localStorage.getItem("DMUEnableSlideDragContent")&&(localStorage.setItem("DMUEnableSlideDragContent",e),he&&he.fireEvent("onDMUPreferencesChanged",{DMUEnableSlideDragContent:e}))},options:[{id:"0",nls:W.preferences.enableReorder},{id:"1",nls:W.preferences.enableDragContent}]}]}])},this.removeSharedPreferences=function(e){e&&e.removePreferences(["MarkerPreferences","ComparePreferences","SlidePreferences"])},this._onContextualBarReadyCB=function(){var e=[],t=s.get(),n=t[t.length-1],a=function(e,t){return e.x>=t.x-3&&e.x<=t.x+3&&e.y>=t.y-3&&e.y<=t.y+3};if(t.length){for(var o,r=!1,d=null,c=!1,u=0;u<t.length;u++){for(o=t[u].pathElement.clone();o&&o.internalPath.length;)o=o.getParentPath();if(o.getLastElement(!0).getAnnotationClassType||o.getLastElement(!0).getDMUType)return{cmdList:[]};d=l.getLastReference(o);let e=!De.getController().isRootSupported||De.getController().isRootSupported(l.getNodeID(d.getLastElement(!0)));d&&l.isReference(d.getLastElement(!0))&&e?r=!0:d=null}n&&n.event&&n.event.lastPosition&&n.event.startPosition&&a(n.event.startPosition,n.event.lastPosition)&&n.pathElement.externalPath.length>2&&n.pathElement.externalPath[0]===De.getRootBagPath().getLastElement(!0)&&(c=!0);var g=i.getReviewContext({context:De}),p=g?g.getCurrentSessionMarkup():null;let s="3D"===i.getCurrentReviewContext()||"ITF"===i.getCurrentReviewContext();if(p&&p.getActiveFlag()&&!p.isReadOnly()&&p.isVisible()&&p.getCurrentSlide()&&!ve){if(r&&s&&e.push({name:"DMUHideShowOverloadStr",line:1,hdr_list:["DMUHideShowOverloadHdr"]}),d&&d.externalPath&&d.externalPath.length&&s){var m=P.getDMUSceneDisplayController({context:De});m&&!m.getCurrentComparedObjectIDPaths()&&e.push({name:"DMUColorOpacityOverloadStr",line:1,hdr_list:["DMUColorOpacityOverloadHdr"]}),e.push({name:"DMUPositionOverloadStr",line:1,hdr_list:["DMUPositionOverloadHdr"]})}}else r&&s&&e.push({name:"HideShowStr",line:1,hdr_list:["HideShowHdr"]});c&&s?e.push({name:"DMULevelSelectorStr",line:1,hdr_list:["DMULevelSelectorHdr"]}):1===t.length&&n&&n.pathElement&&n.pathElement.getParentPath().isEqual(De.getRootBagPath())&&s&&e.push({name:"RemoveRootStr",line:1,hdr_list:["RemoveRootHdr"]})}return"DIFLayout"!==ge&&"DIFSheet"!==ge||n&&n.event&&n.event.lastPosition&&n.event.startPosition&&a(n.event.startPosition,n.event.lastPosition)&&n.pathElement.externalPath.length>2&&n.pathElement.externalPath[0]===De.getRootBagPath().getLastElement(!0)&&e.push({name:"DMULevelSelectorStr",line:1,hdr_list:["DMULevelSelectorHdr"]}),{cmdList:e}},this._applyFlag=function(e,t){for(var n,i=0;i<e.length;i++)(n=k.getCommand(e[i],De.getCommandContext()))||(n=k.getCommandCheckHeader(e[i],De.getCommandContext())),n&&(t?n.enable():n.disable())},this._onContextualMenuReadyCB=function(e,t){var n=[];if(B&&B.getActiveState())return{cmdList:n};var o=i.getReviewContext({context:De}),r=s.get(),d=!De.getViewer().get2DMode(),c=a.getManager({name:"DMUUserExperienceManager",context:De.getFrameWindow()}),u={x:t.XmousePositionWithDevPxRatio,y:t.YmousePositionWithDevPxRatio};if(0===(c?c.pick(u,"mesh"):De.getViewer().pick({xPix:u.x,yPix:u.y},"mesh",!0).path).length){var g=I.get(),p=g&&g[0]&&g[0].pathElement?g[0].pathElement.getLastElement(!0):null,m=p&&p.getDMUType?p.getDMUType():"";if("DMUSlide"===m||"DMUFormat"===m||"DMUComment"===m||"DMUMarkup"===m||"DMUValidationExposedPresentation"===m||"DMUValidationCheck"===m||"Checks"===m||"Highlights"===m)return{cmdList:n};n=[{line:1,name:"DMU3DReviewDisplaySubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:!T.isMobile()&&d?["VisuQMCommand","PAD3DToggleStatusBarHdr"]:["PAD3DToggleStatusBarHdr"]},{line:1,name:"DMU3DReviewAmbiencesSubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]}]}else if(r.length){var f=o?o.getCurrentSessionMarkup():null,D=!1,h=!1,v=!1,w=f&&!f.isReadOnly()&&f.isVisible();for(let e=0;e<r.length;e++){if(f&&!f.isReadOnly()&&f.isVisible()){var C=f.getOrCreateOccurrenceOverloader(r[e]);if(!D)if(C&&C.isOverloadedInCurrentSlide())D=!0;else{let t=r[e].pathElement.clone();t.getParentPath()&&l.isInstance(t.getParentPath().getLastElement(!0))&&(C=f.getOrCreateOccurrenceOverloader({pathElement:t.getParentPath()}))&&C.isOverloadedInCurrentSlide()&&(D=!0)}}for(var S=!0,b=0;b<r[e].pathElement.externalPath.length;b++)r[e].pathElement.externalPath[b].getDMUType&&(h=!0,S=!1);S&&(v=!0)}var M=!1;if(c&&(M=c.areOccurenceOverloadsCopied()),D&&(n=n.concat([{line:1,name:"DMURemoveOverloadStr",hdr_list:["DMURemoveOverloadHdr"]},{line:1,name:"DMUCopyStr",hdr_list:["DMUCopyHdr"]},{line:1,name:"DMUCutStr",hdr_list:["DMUCutHdr"]}])),v&&M&&(n=n.concat([{line:1,name:"DMUPasteStr",hdr_list:["DMUPasteHdr"]},{line:1,name:"DMUPasteSpecialStr",hdr_list:["DMUPasteSpecialHdr"]}])),!h){d?n.push({line:1,name:"FocusOn",hdr_list:["FocusOnHdr"]}):-1===Q.indexOf("Document")&&n.push({line:1,name:"FocusOn",hdr_list:["DMUFocusOnRepresentationHdr"]}),"Requirement"===ge||"Requirement Specification"===ge?n.push({line:1,name:"ReframeOn",hdr_list:["WebDocumentReframeOnHdr"]}):"Drawing"===Q||"DIFLayout"===Q||"DIFSheet"===Q?n.push({line:1,name:"ReframeOn",hdr_list:["DMUReframeOnRepresentationHdr"]}):n.push({line:1,name:"ReframeOn",hdr_list:["ReframeOnHdr"]});let e=!De.getController().isRootSupported||r.length>=1&&r[0].pathElement.externalPath.length>=2&&De.getController().isRootSupported(l.getNodeID(r[0].pathElement.externalPath[1]));if(w&&d&&e){var y=!1;let e,t;for(let n=0;n<r.length;n++){for(e=r[n].pathElement.clone();e&&e.internalPath.length;)e=e.getParentPath();if((t=l.getLastReference(e))&&l.isReference(t.getLastElement(!0))){y=!0;break}}t&&t.externalPath.length<=2&&(y=!1),y&&n.push({line:1,name:"DMUHideShowOverloadStr",hdr_list:["DMUHideShowOverloadHdr"]})}1===r.length&&"Drawing"!==ge&&De.getRootBagPath().isAParentOf(r[0].pathElement)&&n.push({name:"DMUNavOnImplementationLinksStr",line:1,hdr_list:["DMUNavOnImplementationLinksHdr"]}),n.push({line:1,name:"EditPropertiesCmd",hdr_list:["ActionBar_Attributes"]}),d&&e&&n.push({line:1,name:"PAD3DViewerToggleGeometrySection",resourceFile:"ENOPAD3DViewer/ENOPAD3DViewer",hdr_list:["PAD3DToggleSimplifiedHdr","PAD3DToggleAccurateHdr"]})}}return{cmdList:n}},this.highlightInitialization=function(e){e&&e.slide&&e.slide.setAssociatedHighlightData&&e.highlight&&e.slide.setAssociatedHighlightData(JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:p.getPlatformId(),serviceId:"3DSpace",contextId:M.getSetting("pad_security_ctx")?M.getSetting("pad_security_ctx"):void 0,objectId:e.highlight.getPlmID(),objectType:e.highlight.getType(),displayName:e.highlight.getName()}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}))},this._setActiveState=async function(e){const t=()=>p.get3DSpaceUrl(),c=()=>p.getPlatformId(),v=()=>M.getSetting("pad_security_ctx");let b,y,P;if(e!==me){if(me=e){K||(K=w.getLoadingContextController({context:De}));let e=function(e){return new Promise((n,i)=>{let a=t()+"/resources/dictionary/getTypeInfo?tenant="+c(),o=v();require("DS/WAFData/WAFData").authenticatedRequest(a+"&SecurityContext="+o,{method:"POST",type:"json",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:o},data:JSON.stringify(e),onComplete:function(e){n(e)},onFailure:function(e){i(e)},onTimeout:function(e){i(e)}})})},s={_DMUValidationValidation:function(e){pe.loadContext(e,me,"_DMUValidationValidation",!1,pe)},_DMUValidationExposedPresentation:function(e){pe.loadContext(e,me,"_DMUValidationExposedPresentation",!1,pe)},...L.getDelegation(De,function(){he.fireEvent("onApplyingSlideView")})};try{let t=await e(ke);Object.keys(t).forEach(e=>{s["_"+e]=$e}),De.setLoadingDelegations(s)}catch{ke.forEach(e=>{s["_"+e]=$e}),De.setLoadingDelegations(s)}if((se=S.getSelectionManager({context:De})).setActiveState(!0),re={activated:De.getViewer().picking.activated,trapSelection:De.getViewer().picking.trapSelection,trapGPU:De.getViewer().picking.trapGPU},le={activated:De.getViewer().pPicking.activated},De.getViewer().setPicking({activated:!0,trapSelection:!0,trapGPU:!0}),De.getViewer().setPrePicking({activated:!0}),R.subscribe({event:"ENXViews/WelcomePanel/openContent"},async e=>{let t=e.unserializedData?e.unserializedData.data.items:null;if(t&&t.length>1)for(const e of t){const t=await je(e.objectType);if(!t.includes("VPMReference")&&!t.includes("R2V_FeatureState")){Ie=!1,Ee("warning",W.dropMultiNoAutorized);break}}}),he=i.getEventsController({viewer:De.getViewer()}),Me.onValidationObjectDeleted=he.addEvent("onValidationObjectDeleted",function(e){if(e&&e.dmuObject&&e.dmuObject.length&&e.dmuObject[0].getType&&"Markup"===e.dmuObject[0].getType()){let t=i.getReviewContext({context:De});t.getCurrentSessionMarkup()===e.dmuObject[0].getRepRef().getMarkupContent()&&t.setCurrentSessionMarkup(null),e.dmuObject[0].getRepRef().removeMarkupContent(),D.deleteObject({ctxViewer:De,objectIds:[e.dmuObject[0].getPlmID()],type:e.dmuObject[0].getValType(),onDeleteCompleted:Le})}else if(e&&e.dmuObject&&e.dmuObject.length&&("DMUValidationExposedPresentation"===e.dmuObject[0].getType()||"DMUValidationCheck"===e.dmuObject[0].getType())){var t=[];for(let n=0;n<e.dmuObject.length;n++)t.push(e.dmuObject[n].getPlmID());D.deleteObject({ctxViewer:De,objectIds:t,type:"validationObject",onDeleteCompleted:function(){}})}}),Me.onValidationObjectAttributesModificationRequest=he.addEvent("onValidationObjectAttributesModificationRequest",function(e){if(e&&e.attr&&e.dmuObject&&e.dmuObject.getValType&&e.attr.key){var t=[];if("name"===e.attr.key&&"ReviewMarkup"===e.dmuObject.getValType()){var n=[];n.push({sAlias:e.attr.value}),t.push({object:e.dmuObject,attributesList:n}),e.dmuObject.getParent&&e.dmuObject.getParent()&&t.push({object:e.dmuObject.getParent(),attributesList:n})}ae||(ae=new h),ae.display({frmWindow:De.getFrameWindow(),type:"save"}),D.updateAttributes({ctxViewer:De,objectsToModify:t,onAttributesSaveCompleted:function(){ae.destroy()},onSaveFailed:function(){ae.destroy()}})}}),Me.onDMUObjectDeleted=he.addEvent("onDMUObjectDeleted",function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&"DMUTemporaryBag"!==e.dmuObject.getParent().getType()&&(e.dmuObject.getValType||He())}),Me.onDMUObjectInitialized=he.addEvent("onDMUObjectInitialized",function(e){if(e&&e.dmuObject&&e.dmuObject.getParent()&&"DMUTemporaryBag"!==e.dmuObject.getParent().getType())if(!e.dmuObject.getValType||Ae)He(),Le();else if("DMUValidationValidation"===e.dmuObject.getValType())if(Le(),De.elements.container.removeEventListener("drop",Ke),"2DFL"===z){De.elements.container.addEventListener("drop",Ke);var t={_EleLogicalRelay:Ye,_EleLogicalContact:Ye,_EleLogicalOperatingDevice:Ye,_EleLogicalSingleConnector:Ye,_EleLogicalInlineConnector:Ye,_EleLogicalShellConnector:Ye,_EleLogicalSplice:Ye,_EleLogicalTerminalBoard:Ye,_EleLogicalBusbar:Ye,_EleLogicalHarness:Ye,_EleLogicalNet:Ye,_EleLogicalNetGroup:Ye,_EleLogicalWire:Ye,_EleLogicalWireShield:Ye,_EleLogicalCable:Ye,_EleLogicalCableShielded:Ye,_EleLogicalCableTwisted:Ye,_EleLogicalCableTwistedShielded:Ye,_EleLogicalOverShield:Ye,_EleLogicalPowerCable:Ye,_EleLogicalCoaxCable:Ye,_EleLogicalCableGroup:Ye,_EnsLogicalEquipment:Ye,_EnsInCLoop:Ye,_EnsInCLogicalRoute:Ye,_EnsInCLogicalBranch:Ye,_EnsInCLogicalComponent:Ye,_Piping_Logical_Miscellaneous:Ye,_Piping_Logical_Branch:Ye,_Piping_Logical_Instrument:Ye,_Piping_Logical_Reducer:Ye,_Piping_Logical_Valve:Ye,_Piping_Logical_Pipe:Ye,_Piping_Line:Ye,_ICLoop_Line:Ye,_HVAC_Logical_Miscellaneous:Ye,_HVAC_Logical_Branch:Ye,_HVAC_Logical_Instrument:Ye,_HVAC_Logical_Reducer:Ye,_HVAC_Logical_Damper:Ye,_HVAC_Logical_Duct:Ye,_HVAC_Line:Ye};De.setLoadingDelegations(Object.assign({},t,s))}else De.setLoadingDelegations(s);else"DMUValidationExposedPresentation"===e.dmuObject.getValType()&&pe.highlightInitialization({highlight:e.dmuObject,slide:e.slideObject})}),Me.onSlideApplicativeContextModified=he.addEvent("onSlideApplicativeContextModified",function(e){e&&e.dmuObject&&("DMUSlide"===e.dmuObject.getType()||"DMUFormat"===e.dmuObject.getType())&&He()}),Me.onDMUOverloadPropertiesChanged=he.addEvent("onDMUOverloadPropertiesChanged",He),Me.onDMUOccOverloadRemoved=he.addEvent("onDMUOccOverloadRemoved",He),Me.onDMUSlideSessionInfoChanged=he.addEvent("onDMUSlideSessionInfoChanged",function(e){e&&e.dmuObject&&("DMUSlide"===e.dmuObject.getType()||"DMUFormat"===e.dmuObject.getType())&&qe()}),Me.onDMUSlideNameChanged=he.addEvent("onDMUSlideNameChanged",qe),Me.onSaveRequested=he.addEvent("onSaveRequested",qe),Me.onDMUCurrentSlideChanged=he.addEvent("onDMUCurrentSlideChanged",Le),Me.onFormatsEditionModeStarted=he.addEvent("onFormatsEditionModeStarted",function(){pe.publish("onReviewContextModified",{type:z+"Formats",onABReady:Le})}),Me.onFormatsEditionModeEnded=he.addEvent("onFormatsEditionModeEnded",function(){pe.publish("onReviewContextModified",{type:"RefreshAB",onABReady:Le})}),Me.onComparisonStarted=he.addEvent("onComparisonStarted",function(e){e&&e.is2DCompare&&(Pe=!0),Le()}),Me.onComparisonEnded=he.addEvent("onComparisonEnded",function(){Pe=!1,Le()}),Me.onReviewCtxInformationChanged=he.addEvent("onReviewCtxInformationChanged",function(e){e&&e.reviewId&&De&&De.getWidget()&&De.getWidget().dispatchEvent("onDMUReviewLoaded",{envId:p.getPlatformId(),reviewId:"DMUValidationExposedPresentation"===e.reviewType&&e.highlightId?e.highlightId:e.reviewId,objectId:e.reviewId,objectType:"Review"===e.reviewType?"_DMUValidationValidation":"_"+e.reviewType,displayName:e.reviewName,displayType:e.reviewType,type:"Review"===e.reviewType?"_DMUValidationValidation":"_"+e.reviewType})}),Me.onDMUObjectReadOnlyFlagChanged=he.addEvent("onDMUObjectReadOnlyFlagChanged",function(e){if("Markup"===e.dmuObject.getAttribute("sType"))Le();else if("DMUValidationValidation"===e.dmuObject.getType()){var t="R3V"===fe&&!e.flag;he.fireEvent("setEditionMode",{editionMode:t,readOnly:e.flag}),Le()}}),Me.onDMUObjectActiveFlagChanged=he.addEvent("onDMUObjectActiveFlagChanged",Le),Me.onDMUObjectVisibleFlagChanged=he.addEvent("onDMUObjectVisibleFlagChanged",Le),Me.onApplicativeContextCommandsRequired=he.addEvent("onApplicativeContextCommandsRequired",function(e){pe.publish("onReviewContextModified",{type:"Data",data:e,onABReady:e.cb})}),Me.on2DDocumentLoadSuccess=he.addEvent("on2DDocumentLoadSuccess",function(){Le(),ue=!1}),Me.onDXFLoadSuccess=he.addEvent("onDXFLoadSuccess",function(){We("2D"),de&&(de.cleanCommentsPanel(),g.unreferenceDMUCommentsController({context:De.getFrameWindow()}),de=null)}),Me.reviewNoContextModeOn=he.addEvent("reviewNoContextModeOn",function(){We("ReviewNoContext"),oe=!1,Ae=!0}),require(["DS/PIMwebViewController/PIMwebItfCtrl"],function(e){Ve=e.getLoaderForMarkup({context:De}),Se.onDMUCtxtLoadingSuccess=Ve.subscribe("onDMUCtxtLoadingSuccess",function(){We("ITF")}),Se.onDMUCtxtRemoved=Ve.subscribe("onDMUCtxtRemoved",function(){i.getReviewContext({context:De})&&i.removeReviewContext({context:De}),We("3D")})}),Me.onValidatedCreationFlagChanged=he.addEvent("onUpdateValidatedRequested",function(e){pe.setValidatedObjCreationFlag(e)}),Me.onValidatedObjectDropped=he.addEvent("onValidatedObjectDropped",function(e){y=i.getReviewContext({context:De}),D.updateValidatedObjectsList({fullPathRefs:e.path,validatedObjects:e.path,validatedId:y.getValidation().getValidated().getPlmID()?y.getValidation().getValidated().getPlmID():null,validatedToAdd:e.pathToAdd,referenceIds:e.pathToAdd,instanceIds:e.pathToAdd,instanceNames:[],updateMode:"add",ctxViewer:De.getViewer(),onReviewCtxUpdateOrDropValidated:!0,onSaveValidatedObjectsFailed:function(){}})}),Me.onRequirementDropped=he.addEvent("onRequirementDropped",function(e){y=i.getReviewContext({context:De});let t=[];function n(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value}const a=e=>{let i=e["attribute[Content Text]"]?n(e["attribute[Content Text]"]):e["Content Text"]?e["Content Text"]:"",a=e["attribute[Title]"]?n(e["attribute[Title]"]):e.Title?e.Title:"",o=e.type.value?e.type.value:e["type.kindof"]?e["type.kindof"]:"";i&&i.length>100&&(i=i.substring(0,99)+"..."),"Requirement"===o&&t.push({sValidationId:y.getValidation().getPlmID(),sRequirementDocId:e.physicalid,sName:a,sDescription:i,iCheckState:1})};new Promise(t=>{let n=0;e.forEach(async i=>{if(["Requirement Specification","Chapter"].includes(i.objectType)){(await function(e){return new Promise((t,n)=>{require("DS/WAFData/WAFData").authenticatedRequest(p.get3DSpaceUrl()+"/resources/trm/streaming/structure/"+e.phyId,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:M.getSetting("pad_security_ctx")},timeout:6e4,onComplete:function(e){let n=JSON.parse(e);t(n)},onFailure:n,onTimeout:n})})}({phyId:i.objectId})).forEach(e=>{a(e)})}else{(await function(e){return new Promise((t,n)=>{let i=encodeURI(`${p.get3DSpaceUrl()}/resources/trm/dictionary/info?pid=${e}&select=type,attribute[Content Data],attribute[Title],attribute[Content Text]`);require("DS/WAFData/WAFData").authenticatedRequest(i,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:M.getSetting("pad_security_ctx")},timeout:6e4,onComplete:function(e){let i=JSON.parse(e);i&&"success"===i.status&&i.results[0]?t(i):n(new Error("Requirement has no content"))},onFailure:function(){n(new Error("Requirement content Request Failed"))},onTimeout:function(){n(new Error("Requirement content Request Timeout"))}})})}(i.objectId)).results.forEach(e=>{e.physicalid||(e.physicalid=i.objectId),a(e)})}++n===e.length&&t()})}).then(()=>{let e=[],n=[],i=e=>{if(e>10){new x({title:W.warningPanelTitle,message:W.createCheckInfo,frmWindow:De._frmWindow,callbacks:{onValidateCB:()=>{D.addChecks({checkList:t,iCtxViewer:De})},onCancelCB:()=>{},onCloseCB:()=>{}}})}else D.addChecks({checkList:t,iCtxViewer:De})};if(y.getValidation().getChecks().forEach(i=>{t.forEach(t=>{i.getJsonRequirements().length&&t.sRequirementDocId===i.getJsonRequirements()[0]._sPlmID&&(e.includes(t.sRequirementDocId)||(e.push(t.sRequirementDocId),n.push(t.sName)))})}),n.length){new x({title:W.warningPanelTitle,message:W.requirementAlreadyAssociated01+" <br /> "+W.requirementAlreadyAssociated02+" <br /> "+n.toString(),frmWindow:De._frmWindow,callbacks:{onValidateCB:()=>{i(t.length)},onCancelCB:()=>{},onCloseCB:()=>{}}})}else i(t.length)})}),Me.onLoadingReviewContext=he.addEvent("onLoadingReviewContext",function(e){"Document"!==e.rootType&&"Requirement Specification"!==e.rootType&&"Requirement"!==e.rootType||de||(de=g.getDMUCommentsController({context:De.getFrameWindow(),commandContext:De.getCommandContext()}))}),X=n.getLoadMarkupServices({context:De}),G=De.getFrameWindow().getActionBar().onActionBarReady(Le),(J=a.getManager({name:"DMU2DSheetManager",context:De.getFrameWindow()}))||(J=new u({ctxViewer:De}),a.addManager({name:"DMU2DSheetManager",context:De.getFrameWindow(),manager:J})),de||!J.isADocumentDisplayed()&&!J.isRunning()||"Document"!==J.getDocumentType()&&"Requirement"!==J.getDocumentType()||(de=g.getDMUCommentsController({context:De.getFrameWindow(),commandContext:De?De.getCommandContext():null})),B||(B=new o({context:De})),Ce.onApplyFilterBegin=De.subscribe({event:"onBeginFilterApplied"},ze),Ce.onFilterApplied=De.subscribe({event:"onFilterApplied"},Qe),Ce.onLoadingFailure=De.subscribe({event:"onLoadingFailure"},Qe),Ce.onRootAdded=De.subscribe({event:"onRootAdded"},Ge),Ce.onRootAdded=De.subscribe({event:"onRootAdded"},Ge),Ce.onRootAdded=De.subscribe({event:"onR2VLoaded"},Xe),Ce.onRootRemoved=De.subscribe({event:"onRootRemoved"},Je),Ce.onRootAttached=De.subscribe({event:"onRootAttached"},Ge),Ce.onRootDetached=De.subscribe({event:"onRootDetached"},Je),Ce.onRefresh=De.subscribe({event:"onRefresh"},()=>{xe=!0}),Ce.onRefreshBegin=De.subscribe({event:"onRefreshBegin"},()=>{oe=!0,xe||(De.unsubscribe(Ce.onRootRemoved),Ce.onRootRemoved=-1)}),Ce.onRefreshCompleted=De.subscribe({event:"onRefreshCompleted"},function(){oe=!1,xe?xe=!1:Ce.onRootRemoved=De.subscribe({event:"onRootRemoved"},Je)}),be=De.getViewer().onSwapVisibleSpace(Le),Y=r.getDMUApplicativeContextManager({context:De}),Me.onR3VAppTransitionRequested=he.addEvent("onLeavingR3VApp",function(e){if("X3DPLAW_AP"===e.targetApp)(y=i.getReviewContext({context:De}))&&y.getValidation()&&(y.getValidation().setReadOnly(!0),Le());else if("ENOR3R_AP"!==e.targetApp&&(y=i.getReviewContext({context:De}))&&y.getValidation()){O.giveDMUReviewController({context:De.getFrameWindow()}).setVisibleFlag(!1),q&&q.setVisibleFlag(!1)}}),Me.onR3RAppTransitionRequested=he.addEvent("onLeavingR3RApp",function(e){if("X3DPLAW_AP"===e.targetApp)(y=i.getReviewContext({context:De}))&&y.getValidation()&&(y.getValidation().setReadOnly(!0),Le());else if("ENOR3V_AP"!==e.targetApp&&"ENOR3R_AP"!==e.targetApp&&(y=i.getReviewContext({context:De}))&&y.getValidation()){O.giveDMUReviewController({context:De.getFrameWindow()}).setVisibleFlag(!1);const e=q||_e();e&&e.setVisibleFlag(!1)}}),(y=i.getReviewContext({context:De}))&&y.getCurrentSessionMarkup()){var V=!1,U=y.getReviewCtxInformation();if(U&&U.contextId||"R3R"===fe){var A=De.getRootBagPath().getChildrenPathes();for(b=0;b<A.length;b++){if((De.getApplicativeData().getLoadedItfData&&De.getApplicativeData().getLoadedItfData().data.length?De.getApplicativeData().getLoadedItfData().data[0].isrID:l.getNodeID(A[b].getLastElement(!0)))===U.contextId){y.getCurrentSessionMarkup().setActiveFlag(!0),!1!==U.modifiable&&y.setReadOnly(!1),V=!0;break}}V||y.setCurrentSessionMarkup(null)}}if(y&&y.getValidation()){O.giveDMUReviewController({context:De.getFrameWindow()}).setVisibleFlag(!0);const e=q||_e();e&&e.setVisibleFlag(!0),y.setReadOnly(!1),y.getValidation().setReadOnly(!1),he.fireEvent("setEditionMode",{editionMode:"R3V"===fe,readOnly:!1}),Le()}else y&&y.setCurrentSessionMarkup(null);ie=De.getViewer().sectionCappingEnabled,De.getViewer().setSectionCapping(!0),(ne=De.isRobotVisible())&&De.setRobotVisibility(!1),De.getFrameWindow().getContextualUIManager().registerUnshift({subscriberId:"R3V"===fe?"3DValidationWebAppCtxElements":"3DReviewWebAppCtxElements",workbenchName:"R3V"===fe?"DMUValWebAppController":"DMUReviewWebAppController",context:De.getCommandContext(),module:"R3V"===fe?"DMUValWebAppController":"DMUReviewWebAppController",cmdPrefix:"",directory:"assets/afr/",merge:!0,onContextualBarReady:this._onContextualBarReadyCB,onContextualMenuReady:this._onContextualMenuReadyCB}),(Z=De.isDefaultContextualBarVisible())&&De.setDefaultContextualBarVisibility(!1),(ee=De.isDefaultContextualMenuVisible())&&De.setDefaultContextualMenuVisibility(!1),(te=De.isOpenWithMenuAvailable())||De.setOpenWithMenuAvailability(!0),De.getRootBagPath()&&De.getRootBagPath().getChildrenPathes().length&&Be({path:De.getRootBagPath().getChildrenPathes()[0]}),function(){var e=m.getPreferenceManager({context:De.getFrameWindow()});if(e){if(e.setUnitsPreferencesDisplayFlag(!0),e.setDisplayPreferencesDisplayFlag(!0),e.set3DSelectionPreferencesDisplayFlag(!0),e.set2DSelectionPreferencesDisplayFlag(!0),e.setExportPreferencesDisplayFlag(!0),e.addPreferences([{nls:W.preferences.reviewSectionTitle,id:"ReviewPreferences",type:"section",preferences:[{nls:W.preferences.reviewQuickCreationLbl,id:"DMUDisplayReviewCreationDialog",type:"checkbox",getValue:function(){return"false"!==localStorage.getItem("DMUDisplayReviewCreationDialog")},getDefaultValue:function(){return!0},setValue:function(e){e!==("false"!==localStorage.getItem("DMUDisplayReviewCreationDialog"))&&(localStorage.setItem("DMUDisplayReviewCreationDialog",e?"true":"false"),he&&he.fireEvent("onDMUPreferencesChanged",{DMUDisplayReviewCreationDialog:e}))}},{nls:W.preferences.markupAutomaticCreationLbl,id:"DMUAutomaticMarkupCreationDialog",type:"checkbox",getValue:function(){return"R3V"===fe?"true"===localStorage.getItem("DMUAutomaticMarkupCreationDialog"):"false"!==localStorage.getItem("DMUAutomaticMarkupCreationDialog")},getDefaultValue:function(){return"R3V"===fe},setValue:function(e){(e!==("true"===localStorage.getItem("DMUAutomaticMarkupCreationDialog"))&&"R3V"===fe||e!==("false"!==localStorage.getItem("DMUAutomaticMarkupCreationDialog"))&&"R3R"===fe)&&(localStorage.setItem("DMUAutomaticMarkupCreationDialog",e?"true":"false"),he&&he.fireEvent("onDMUPreferencesChanged",{DMUAutomaticMarkupCreationDialog:e}))}}]},{nls:W.preferences.markupSectionTitle,id:"MarkupPreferences",type:"section",preferences:[{nls:W.preferences.QuickCreationLbl,id:"DMUDisplayMarkupCreationDialog",type:"checkbox",getValue:function(){return"false"!==localStorage.getItem("DMUDisplayMarkupCreationDialog")},getDefaultValue:function(){return!0},setValue:function(e){e!==("false"!==localStorage.getItem("DMUDisplayMarkupCreationDialog"))&&(localStorage.setItem("DMUDisplayMarkupCreationDialog",e?"true":"false"),he&&he.fireEvent("onDMUPreferencesChanged",{DMUDisplayMarkupCreationDialog:e}))}},{nls:W.preferences.automaticallyCreateFirstSlide,id:"DMUCreateFirstSlide",type:"checkbox",getValue:function(){return"false"!==localStorage.getItem("DMUCreateFirstSlide")},getDefaultValue:function(){return!0},setValue:function(e){e!==("false"!==localStorage.getItem("DMUCreateFirstSlide"))&&(localStorage.setItem("DMUCreateFirstSlide",e?"true":"false"),he&&he.fireEvent("onDMUPreferencesChanged",{DMUCreateFirstSlide:e}))}}]},{nls:W.preferences.handlesSectionTitle,id:"HandlesPreferences",type:"section",preferences:[{prefixnls:W.preferences.gridSpacingPrefix,suffixnls:W.preferences.gridSpacingSuffix,id:"DMUSnapHandlesToGrid",type:"checkbox+spinbox",disableSpinboxAtUncheck:!0,getValue:function(){return"false"!==localStorage.getItem("DMUSnapHandlesToGrid")},getSpinBoxValues:function(){var e=parseFloat(localStorage.getItem("DMUSnapHandlesGridValue")),t="mm",n=localStorage.getItem("CATWebUXPreferences_Units");return n&&n.length&&(t="foot"===(t=(n=JSON.parse(n)).Length.unit)?"inch":"cm"===t||"m"===t||"km"===t?"mm":t),e="inch"===t?f.convert(e,"Length","mm",t):e,{value:isNaN(e)?1:e,units:t,minValue:"mm"===t?1:.01,stepValue:"mm"===t?1:.01}},getDefaultValue:function(){return!0},getSpinBoxDefaultValues:function(){return{value:1,units:"mm",minValue:1,stepValue:1}},setValue:function(e){e!==("false"!==localStorage.getItem("DMUSnapHandlesToGrid"))&&(localStorage.setItem("DMUSnapHandlesToGrid",e?"true":"false"),he&&he.fireEvent("onDMUPreferencesChanged",{DMUSnapHandlesToGrid:e}))},setSpinBoxValue:function(e){var t=parseFloat(localStorage.getItem("DMUSnapHandlesGridValue"));e!==(t=isNaN(t)?1:t)&&(localStorage.setItem("DMUSnapHandlesGridValue",e),he&&he.fireEvent("onDMUPreferencesChanged",{DMUSnapHandlesGridValue:e}))}},{prefixnls:W.preferences.rotSnappingPrefix,suffixnls:"("+W.preferences.rotSnappingSuffix+")",id:"DMUSnapRotationToggle",type:"checkbox+spinbox",disableSpinboxAtUncheck:!1,getValue:function(){return"false"!==localStorage.getItem("DMUSnapRotationToggle")},getSpinBoxValues:function(){var e=parseFloat(localStorage.getItem("DMUSnapRotationAngle")),t="deg",n=localStorage.getItem("CATWebUXPreferences_Units");return n&&n.length&&(t=(n=JSON.parse(n)).Angle.unit),e="rad"===t?f.convert(e,"Angle","deg",t):e,{value:isNaN(e)?90:e,units:t,minValue:"deg"===t?1:.01,stepValue:"deg"===t?1:.01}},getDefaultValue:function(){return!0},getSpinBoxDefaultValues:function(){return{value:90,units:"deg",minValue:1,maxValue:360,stepValue:1}},setValue:function(e){e!==("false"!==localStorage.getItem("DMUSnapRotationToggle"))&&(localStorage.setItem("DMUSnapRotationToggle",e?"true":"false"),he&&he.fireEvent("onDMUPreferencesChanged",{DMUSnapRotationToggle:e}))},setSpinBoxValue:function(e){var t=parseFloat(localStorage.getItem("DMUSnapRotationAngle"));e!==(t=isNaN(t)?90:t)&&(localStorage.setItem("DMUSnapRotationAngle",e),he&&he.fireEvent("onDMUPreferencesChanged",{DMUSnapRotationAngle:e}))}}]}]),pe.createSharedPreferences(e),e.addPreferences(C.getCommonPreferencesDefinition()),e.setPreferredPreferenceContainersOrder(["ReviewPreferences","MarkupPreferences","SlidePreferences","HandlesPreferences","MarkerPreferences","MeasurePreferences","SectionPreferences"]),!De.getViewer().get2DMode()){var t=f.getPreference("CATWebUXPreferences_GravitationalEffects","boolean");"boolean"==typeof t&&(De.getViewer().currentViewpoint.getControl().setRotationRolling(!t),De.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!t));var n=f.getPreference("CATWebUXPreferences_ProjectionType","int");0!==n&&1!==n||De.getViewer().currentViewpoint.setProjectionType(n);var i=f.getPreference("CATWebUXPreferences_Select3DGeometry","boolean");se&&se.setPicking(i?0:1);let e=f.getPreference("CATWebUXPreferences_SelectParentReferenceOr3DShape","string");se&&se.selectParentReference("select3DShape"!==e)}ye&&!ye.CATWebUXPreferences_GravitationalEffects&&(ye.CATWebUXPreferences_GravitationalEffects=e.subscribe("CATWebUXPreferences_GravitationalEffects",function(e){De&&De.getViewer()&&De.getViewer().currentViewpoint&&De.getViewer().currentViewpoint.control&&!De.getViewer().get2DMode()&&(De.getViewer().currentViewpoint.getControl().setRotationRolling(!e),De.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!e))}),ye.CATWebUXPreferences_ProjectionType=e.subscribe("CATWebUXPreferences_ProjectionType",function(e){De&&De.getViewer()&&De.getViewer().currentViewpoint&&!De.getViewer().get2DMode()&&De.getViewer().currentViewpoint.setProjectionType(e)}),ye.CATWebUXPreferences_Select3DGeometry=e.subscribe("CATWebUXPreferences_Select3DGeometry",function(e){se&&!De.getViewer().get2DMode()&&se.setPicking(e?0:1)}),ye.CATWebUXPreferences_SelectParentReferenceOr3DShape=e.subscribe("CATWebUXPreferences_SelectParentReferenceOr3DShape",function(e){se&&se.selectParentReference("select3DShape"!==e)}))}}()}else{var I;if(S.unreferenceSelectionManager({context:De}),se=null,ae&&ae.destroy(),re&&De.getViewer().setPicking(re),le&&De.getViewer().setPrePicking(le),le=null,le=null,De.elements.container.removeEventListener("drop",Ke),P=m.givePreferenceManager({context:De.getFrameWindow()})){for(I=Object.keys(ye),b=0;b<I.length;b++)P.unsubscribe(ye[I[b]]);ye={},P.removePreferences("R3V"===fe?["MarkupPreferences","HandlesPreferences"]:["ReviewPreferences","HandlesPreferences"]),pe.removeSharedPreferences(P)}if(m.unreferencePreferenceManager({context:De.getFrameWindow()}),Fe&&(clearTimeout(Fe),Fe=null),De.setLoadingDelegations({}),De.getFrameWindow().getActionBar().removeCallback(G),De.getFrameWindow().getContextualUIManager().unregister("3DReviewWebAppCtxElements"),void 0!==Z&&De.setDefaultContextualBarVisibility(Z),Z=void 0,void 0!==ee&&De.setDefaultContextualMenuVisibility(ee),ee=void 0,void 0!==te&&De.setOpenWithMenuAvailability(te),te=void 0,void 0!==ne&&De.setRobotVisibility(ne),ne=void 0,void 0!==ie&&De.getViewer().setSectionCapping(ie),ie=void 0,r.unreferenceDMUApplicativeContextManager({context:De}),Y=null,J.isADocumentDisplayed())if(Re)(y=i.getReviewContext({context:De}))&&y.getCurrentSessionMarkup()&&y.setReadOnly(!0);else{J.clean2DDocument(),de&&de.cleanCommentsPanel();for(var k=[],E=l.getRoots(De),F=0;F<E.length;F++)k.push(l.getNodeID(E[F]));De.removeRoots({pids:k})}else(y=i.getReviewContext({context:De}))&&y.getCurrentSessionMarkup()&&(Re?y.setReadOnly(!0):y.getCurrentSessionMarkup().setActiveFlag(!1));for(s.empty(),d.empty(),I=Object.keys(Ce),b=0;b<I.length;b++)De.unsubscribe(Ce[I[b]]);if(Ce={},he){for(I=Object.keys(Me),b=0;b<I.length;b++)he.removeEvent(Me[I[b]]);i.unreferenceEventsController({viewer:De.getViewer()}),he=null}if(Me={},Ve){for(I=Object.keys(Se),b=0;b<I.length;b++)Ve.unsubscribe(Se[I[b]]);Se={},Ve=null}B&&(B.clean(),B=null),be&&(De.getViewer().unsubscribe(be),be=null),Re||(a.removeManager({name:"DMU2DSheetManager",context:De.getFrameWindow()}),J=null,de&&(g.unreferenceDMUCommentsController({context:De.getFrameWindow()}),de=null)),n.unreferenceLoadMarkupServices({context:De}),X=null}Le()}},this.disableDMUContextualBar=function(){De.getFrameWindow().getContextualUIManager().getContextualBar().hide()},this.enableDMUContextualBar=function(){},this.subscribe=function(e,t){if(e&&t&&we)return we.subscribe({event:e},t)},this.unsubscribe=function(e){we&&e&&we.unsubscribe(e)},this.getActiveState=function(){return me},this.clearController=function(){ce&&clearTimeout(ce),pe._setActiveState(!1),ae=De=pe=we=Ce=ue=ce=null},this.loadMarkupContext=async function(e){var t=!1,n=i.getReviewContext({context:De});if(n){var a=n.getReviewCtxInformation();t=a&&a.contextId===e.objectId}const o=await je(e.objectType);if(e.objectId&&!t){if($===e.objectId)return void De.displayNotification({msg:W.documentAlreadyLoaded,eventID:"info"});var r;o&&o.length&&["SIMItfSimulation","PLMPIMMetricReference","Document","DIFLayout","DIFSheet","DIFAnnotationSet","Requirement","Requirement Specification","DesignSight"].some(function(e){if(-1!==o.indexOf(e))return r=e,!0})?(e.objectParentType=r||e.objectType,K.load({data:e}),-1!==o.indexOf("Document")&&(ue=!0)):Be({docData:e})}},this.loadValidation=function(e){v.createReviewContext({context:De}),e.editionMode="R3V"===fe,e&&X&&X.loadValidation(e)},this.appInitFromTransition=function(t){return new e.Promise(function(e){e()}).then(function(e){e||t.onNoActionDone()}).catch(t.onNoActionDone).finally(function(){void 0})},this.refreshContext=function(){var e=i.getReviewContext({context:De});e&&(e.refreshNode(),De.getViewer().render())},this.publish=function(e,t){me&&setTimeout(function(){we&&we.publish({event:e,data:t,context:pe})})},this.setappTransition=function(e){Re=e}},setControllerActiveState:async function(e){this._setActiveState&&await this._setActiveState(e)}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/DMUReviewCommonWebApp/DMUCommonWebAppOptions",["UWA/Core","UWA/Class","UWA/Class/Options","UWA/Utils"],function(e,t,n,i){"use strict";return t.singleton(n,{init:function(){var t={};""!==window.location.search&&(e.extend(t,i.parseQuery(window.location.search)),t.widgetDomain&&e.extend(t,i.parseQuery(t.widgetDomain))),("debug_me"in t||window.debug)&&(t.debug=!0),("testWkb"in t||window.testWkb)&&(t.testWkb=!0),this.setOptions(t)}})}),define("DS/DMUReviewCommonWebApp/DMUCommonWebAppMain",["UWA/Core","DS/DMUControls/EXPNotify","DS/DMUReviewCommonWebApp/DMUCommonWebAppOptions","DS/DMUMeasurable/DMUToolsSceneGraph","DS/PADUtils/PADSettingsMgt","DS/ApplicationFrame/CommandsManager","DS/PADServices/views/LandingPage","DS/PADServices/utils/GlobalModelEvents","DS/EditPropWidget/constants/ConstantsMapping","DS/DMUReadPersistence/DMUWebServicesUtils","i18n!DS/DMUReviewCommonWebApp/assets/nls/DMUCommonWebAppMain"],function(e,t,n,i,a,o,r,l,s,d,c){"use strict";let u,g,p={widget:null,widgetLink:null,viewer:null,viewerAttachment:null};const m=[{key:"rvw",type:"DMUValidationValidation"},{key:"highlight",type:"DMUValidationExposedPresentation"},{key:"isr",type:"SIMItfSimulation"},{key:"itf",type:"PLMPIMMetricReference"},{key:"difLayout",type:"DIFLayout"},{key:"difSheet",type:"DIFSheet"},{key:"difAnnotSet",type:"DIFAnnotationSet"},{key:"doc",type:"Document"},{key:"req",type:"Requirement"},{key:"reqSpec",type:"Requirement Specification"},{key:"msr",type:"DesignSight"},{key:"pointClouds",type:"R2V_FeatureState"}],f=["ds6w:label","ds6w:type","ds6wg:revision","ds6w:status","owner","ds6w:responsible","ds6w:modified","ds6w:project","ds6w:identifier"];function D(){var e=this.params.widget.getValue("xsceneStoredObjects");return e&&"string"==typeof e||(e='{"products":{},"filters":{}}'),JSON.parse(e)}function h(e){e&&e.length&&(e[0].id.reviewId&&(e[0]=e[0].id,e[0].type&&"_DMUValidationValidation"===e[0].type&&(e[0].type="DMUValidationValidation"),e[0].type&&"_DMUValidationExposedPresentation"===e[0].type&&(e[0].type="DMUValidationExposedPresentation")),this.showWelcomePanel(!1),this.pad3DViewer.addRootNodesFromContent({json3DXContent:{protocol:"3DXContent",version:"1.1",source:"X3DSEAR_AP",data:{items:e.map(function(e){return{envId:require("DS/PADUtils/PADUtilsServices").getPlatformId(),objectId:e.reviewId?e.reviewId:e.id,objectType:"PointCloud"!==e.type?e.type:"R2V_FeatureState",displayName:e.displayName,serviceId:"PointCloud"!==e.type?void 0:"r2vsurvey"}})}}}))}async function v(e){try{let t=await d.getParentTypes(e);return[e].concat(t)}catch{return[e]}}async function w(e){let n=!0;if(e.length>1)for(const t of e){let e=await v(t["ds6w:type"]);if(!e.includes("VPMReference")&&!e.includes("R2V_FeatureState")){n=!1;break}}var i,a,o;n?h.call(this,e.map(function(e){return{id:e.resourceid,type:e["ds6w:type_value"],displayName:e["ds6w:label"]}})):(i="warning",a=c.dropMultiNoAutorized,o=this.pad3DViewer,g&&(g.destroy(),g=null),g=new t({body:o.getFrameWindow().getUIFrame(),type:i,message:a}))}function C(e){if(e&&e.length){l.publish({event:"ENXViews/LandingPage/addOrRefresh",data:{objects:e.map(function(e){return{resourceid:e,openWithFilter:!1,loading:!0,fromCustom:!0}})}});var t=setInterval(function(){this.isAppReady&&this.welcomePanel&&(clearInterval(t),function(e,t){require("DS/WAFData/WAFData").authenticatedRequest(require("DS/PADUtils/PADUtilsServices").get3DSpaceUrl()+"/cvservlet/fetch/v2?tenant="+require("DS/PADUtils/PADUtilsServices").getPlatformId(),{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx")},data:JSON.stringify({physicalid:e,label:"M3DFetchForWelcomePanel"+Date.now(),select_predicate:f,select_file:["icon","thumbnail_2d"]}),onComplete:t,onFailure:function(){},onTimeout:function(){}})}(e,function(e){if(this.welcomePanel){var t=((e?JSON.parse(e):{}).results||[]).map(function(e){var t={},n=require("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"),i=n.getRoots(this.pad3DViewer).map(function(e){return n.getNodeID(e)}),a=require("DS/DMUBaseExperience/DMUContextManager").getReviewContext({context:this.pad3DViewer}),o=a?a.getReviewCtxInformation():{};o&&o.reviewId&&i.push(o.reviewId),o&&o.highlightId&&i.push(o.highlightId),this.pad3DViewer.getApplicativeData().getLoadedItfData&&this.pad3DViewer.getApplicativeData().getLoadedItfData().data.forEach(function(e){i=i.concat(e.metricID.length?e.metricID:[e.isrID])}),e.attributes.forEach(function(e){t[e.name]=e.value});var r={resourceid:t.resourceid,label:t["ds6w:label"],icons:[t.type_icon_url],thumbnail:t.preview_url,grid:t,subLabel:t["ds6w:responsible"]+" | "+new Date(t["ds6w:modified"]).toLocaleString(),description:t["ds6w:identifier"],openWithFilter:!1,fromCustom:!0,loading:void 0,opened:i.indexOf(t.resourceid)>-1,item2Load:{}};r.item2Load[r.resourceid]={};let l=t["ds6w:type"];return"SIMItfSimulation"!==l&&"PLMPIMMetricReference"!==l&&"DIFAnnotationSet"!==l||(r.addRemoveFromViewCtx=!0),r}.bind(this));l.publish({event:"ENXViews/LandingPage/addOrRefresh",data:{objects:t}})}}.bind(this)))}.bind(this),100)}}function S(e){this.isAppReady=!1,this.params=e,this.welcomePanel=this.pad3DViewer=this.reviewCtrl=null,this.tokensWelcomePanel=[],this.tokensPAD=[],this.tokensMkp=[],this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/LandingPage/refreshCustom"},C.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/LandingPage/openCustom"},function(e){var t=D.call(this),n=[];e.customitem2open.forEach(function(e){m.some(function(i){if(t[i.key]&&t[i.key][e])return n.push({id:e,type:i.type}),!0})}),h.call(this,n)}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/LandingPage/removeFromView"},function(e){if(e&&e.customitem2remove&&e.customitem2remove.length){var t=require("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"),n=t.getRoots(this.pad3DViewer).map(function(e){return t.getNodeID(e)}),i=require("DS/DMUBaseExperience/DMUContextManager").getReviewContext({context:this.pad3DViewer}),a=i?i.getReviewCtxInformation():{},o=a?a.reviewId:null,r=[];this.pad3DViewer.getApplicativeData().getLoadedItfData&&(r=this.pad3DViewer.getApplicativeData().getLoadedItfData().data),this.pad3DViewer.getApplicativeData().removeDIFAnnotSetKeepPrd&&e.customitem2remove.forEach(e=>{this.pad3DViewer.getApplicativeData().removeDIFAnnotSetKeepPrd(e)}),e.customitem2remove.indexOf(o)>-1&&require(["DS/DMUBaseExperience/DMUContextManager"],function(e){e.removeReviewContext({context:p.viewer});let t=e.giveEventsController({viewer:p.viewer.getViewer()});t&&t.fireEvent("onDMURemoveSessionReview")}),r.forEach(function(t){(t.metricID.length?t.metricID:[t.isrID]).some(function(n){if(e.customitem2remove.indexOf(n)>-1)return this.pad3DViewer.getApplicativeData().removeIsrKeepContext(t.isrID),!0},this)},this),n.forEach(function(t){e.customitem2remove.indexOf(t)>-1&&this.pad3DViewer.removeRoots({pids:[t]})},this)}}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/LandingPage/removeFromStore"},function(e){if(e&&e.customitem2remove&&e.customitem2remove.length){var t=D.call(this),n=[];e.customitem2remove.forEach(function(e){m.some(function(i){if(t[i.key]&&t[i.key][e]&&-1===n.indexOf(e))return n.push(e),delete t[i.key][e],!0})}),this.params.widget.setValue("xsceneStoredObjects",JSON.stringify(t)),l.publish({event:"ENXViews/LandingPage/removeFromView",data:{customitem2remove:n}})}}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomePanelHighlights"},function(){r.launchSearch({title:c.highlights,precondition:'flattenedtaxonomies:"types/DMUValidationExposedPresentation"',showApplyButton:!1,ok:w.bind(this)})}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomePanelRvw"},function(){r.launchSearch({title:c.rvw,precondition:'flattenedtaxonomies:"types/DMUValidationValidation"',showApplyButton:!1,ok:w.bind(this)})}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomePanelIsr"},function(){r.launchSearch({title:c.isr,precondition:'flattenedtaxonomies:"types/SIMItfSimulation"',showApplyButton:!1,ok:w.bind(this)})}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomePanelItf"},function(){r.launchSearch({title:c.itf,precondition:'flattenedtaxonomies:"types/PLMPIMMetricReference"',showApplyButton:!1,ok:w.bind(this)})}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomePanelDrw"},function(){r.launchSearch({title:c.drw,precondition:'flattenedtaxonomies:"types/Drawing"',showApplyButton:!1,ok:w.bind(this)})}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomePanelDIFLayout"},function(){r.launchSearch({title:c.difLayout,precondition:'flattenedtaxonomies:"types/DIFLayout"',showApplyButton:!1,ok:w.bind(this)})}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomePanelDIFSheet"},function(){r.launchSearch({title:c.difSheet,precondition:'flattenedtaxonomies:"types/DIFSheet"',showApplyButton:!1,ok:w.bind(this)})}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomePanelDIFAnnotationSet"},function(){r.launchSearch({title:c.difAnnotSet,precondition:'flattenedtaxonomies:"types/DIFAnnotationSet"',showApplyButton:!1,ok:w.bind(this)})}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomePanelDocument"},function(){r.launchSearch({title:c.doc,precondition:'flattenedtaxonomies:"types/Document"',showApplyButton:!1,ok:w.bind(this)})}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomePanelRequirement"},function(){r.launchSearch({title:c.req,precondition:'flattenedtaxonomies:"types/Requirement"',showApplyButton:!1,ok:w.bind(this)})}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomePanelRequirementSpec"},function(){r.launchSearch({title:c.reqSpec,precondition:'flattenedtaxonomies:"types/Requirement Specification"',showApplyButton:!1,ok:w.bind(this)})}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomePanelMsr"},function(){r.launchSearch({title:c.msr,precondition:'flattenedtaxonomies:"types/DesignSight"',showApplyButton:!1,ok:w.bind(this)})}.bind(this))),this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomPanelPrefCmd"},function(){require(["DS/CATWebUXPreferences/CATWebUXPreferencesManager"],function(e){var t=e.givePreferenceManager({context:this.pad3DViewer.getFrameWindow()});if(t){var n=t.subscribe("onPreferencesPanelDestroyed",function(){t.unsubscribe(n),this.showWelcomePanel(!0)}.bind(this));this.showWelcomePanel(!1),t.displayPreferencePanel(this.pad3DViewer.getFrameWindow())}}.bind(this))}.bind(this))),"R3V"===u&&this.tokensWelcomePanel.push(l.subscribe({event:"ENXViews/WelcomePanel/action/welcomPanelNewActivity"},function(){var e=o.getCommand("DMUReviewHdr",this.pad3DViewer.getCommandContext());this.showWelcomePanel(!1),e.begin()}.bind(this)));var t=r.getDefaultActivities();t.activities[0].section.actions.splice(2,0,{id:"welcomePanelRvw",title:c.rvw,icon:"review"}),t.activities[0].section.actions.splice(3,0,{id:"welcomePanelHighlights",title:c.highlights,icon:"highlight-review"}),t.activities[0].section.actions.splice(6,0,{id:"welcomePanelDIFAnnotationSet",title:c.difAnnotSet,icon:"annotation"}),t.activities[0].section.actions.splice(7,0,{id:"welcomePanelIsr",title:c.isr,icon:"interference-simulation"}),t.activities[0].section.actions.splice(8,0,{id:"welcomePanelItf",title:c.itf,icon:"interference-metric"}),t.activities[0].section.actions.splice(9,0,{id:"welcomePanelMsr",title:c.msr,icon:"physics-simulation"}),t.activities[0].section.actions.splice(10,0,{id:"welcomePanelDrw",title:c.drw,icon:"drawing"}),t.activities[0].section.actions.splice(11,0,{id:"welcomePanelRequirementSpec",title:c.reqSpec,icon:"requirement-specification"}),t.activities[0].section.actions.splice(12,0,{id:"welcomePanelRequirement",title:c.req,icon:"requirement"}),t.activities[0].section.actions.splice(13,0,{id:"welcomePanelDIFLayout",title:c.difLayout,icon:"fl-diagrams"}),t.activities[0].section.actions.splice(14,0,{id:"welcomePanelDIFSheet",title:c.difSheet,icon:"fl-diagram"}),t.activities[0].section.actions.splice(15,0,{id:"welcomePanelDocument",title:c.doc,icon:"doc"}),"R3V"===u&&t.activities.push({section:{id:"NewActivitySection",title:c.startNewActivity,actions:[{id:"welcomPanelNewActivity",title:c.newReview,icon:"review"}]}}),t.activities.push({section:{id:"customizeAppSection",title:c.customApp,actions:[{id:"welcomPanelPrefCmd",title:c.prefs,icon:"cog"}]}}),this.welcomePanel=new r({widget:e.widget,readOnlyApp:!0,renderDiv:e.renderDiv,externalViewerMgt:!0,externalViewerMgtCB:function(e,t){!0!==t&&this.showWelcomePanel("viewer"!==e)}.bind(this),globalSearchPrecond:'flattenedtaxonomies:"types/DMUValidation" OR flattenedtaxonomies:"types/DMUValidationExposedPresentation" OR flattenedtaxonomies:"types/SIMItfSimulation" OR flattenedtaxonomies:"types/PLMPIMMetricReference" OR flattenedtaxonomies:"types/DIFLayout" OR flattenedtaxonomies:"types/DIFSheet" OR flattenedtaxonomies:"types/DIFAnnotationSet" OR flattenedtaxonomies:"types/VPMReference" OR flattenedtaxonomies:"types/VPMRepReference" OR flattenedtaxonomies:"types/ENOStrRefinementSpecification" OR (flattenedtaxonomies:"types/Document" AND [ds6w:docextension]:(pdf OR dxf OR dwg)) OR flattenedtaxonomies:"types/Requirement" OR flattenedtaxonomies:"types/Requirement Specification"',defaultActionId:t.defaultActionId,activities:t.activities,onLandingPageReady:e.onLandingPageReady})}var b;S.prototype={constructor:S,initialize:function(){var e=this.welcomePanel.initialize();return e.then(function(){var e=D.call(this),t=Array.prototype.concat.apply([],m.map(function(t){return Object.keys(e[t.key]||[])}));C.call(this,t)}.bind(this)),e},setViewer:function(e){this.pad3DViewer=e,!this.params.initApp&&this.showWelcomePanel(!1);var t=e.render().getContent(),n=t.parentNode;t.style.position="relative",!this.params.renderDiv.parentNode&&n&&n!==this.params.renderDiv&&n.insertBefore(this.params.renderDiv,n.firstChild),this.params.renderDiv.insertBefore(t,this.params.renderDiv.firstChild),this.welcomePanel&&(this.params.renderDiv.insertBefore(this.welcomePanel.elements.mainBody,this.params.renderDiv.firstChild),this.welcomePanel.setViewer(e,!this.params.initApp)),this.tokensPAD.push(e.subscribe({event:"onRootAdded"},function(t){var n=require("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"),i=t.id,a=e.getController().getNode({id:i}),o=n.getNodeType(a);if("R2V_FeatureState"===o||"DesignSight"===o||"DIFLayout"===o||"DIFSheet"===o||"Document"===o||"Requirement"===o||"Requirement Specification"===o){"DesignSight"===o?this.params.widget.setValue("mkpSession",JSON.stringify({type:"msr",plmType:o,id:i})):this.params.widget.setValue("mkpSession",JSON.stringify({type:"Document"===o||"Requirement"===o||"Requirement Specification"===o?o:"2D",plmType:o,id:i}));var r=D.call(this);r[o="DIFLayout"===o?"difLayout":"DIFSheet"===o?"difSheet":"Requirement"===o?"req":"Requirement Specification"===o?"reqSpec":"DesignSight"===o?"msr":"R2V_FeatureState"===o?"pointClouds":"doc"]||(r[o]={}),r[o][i]={},this.params.widget.setValue("xsceneStoredObjects",JSON.stringify(r)),this.showWelcomePanel(!1),C.call(this,[i])}}.bind(this))),this.tokensPAD.push(e.subscribe({event:"onRootRemoved"},function(e){var t=D.call(this);["difLayout","difSheet","doc","req","reqSpec","msr"].some(function(n){return t[n]&&t[n][e.id]})&&(C.call(this,[e.id]),this.params.widget.deleteValue("mkpSession"))}.bind(this))),require(["DS/DMUBaseExperience/DMUContextManager"],function(t){var n=t.getEventsController({viewer:e.getViewer()});this.tokensMkp.push(n.addEvent("onReviewCtxInformationChanged",function(e){var t=D.call(this);t.rvw||(t.rvw={}),t.highlight||(t.highlight={}),"DMUValidationValidation"===e.reviewType?t.rvw[e.reviewId]={}:"DMUValidationExposedPresentation"===e.reviewType&&(t.highlight[e.highlightId]={}),this.params.widget.setValue("xsceneStoredObjects",JSON.stringify(t)),C.call(this,[e.reviewId])}.bind(this))),this.tokensMkp.push(n.addEvent("onReviewRemoved",function(e){var t=D.call(this);e&&t.rvw&&t.rvw[e.reviewId]&&C.call(this,[e.reviewId]),e&&e.highlightId&&t.highlight&&t.highlight[e.highlightId]&&C.call(this,[e.highlightId]),this.params.widget.deleteValue("reviewIdInSession")}.bind(this)))}.bind(this))},appReady:function(e){if(this.reviewCtrl=e,this.isAppReady=!0,this.params.initApp){let l=this.params.widget.getValue("X3DContentId"),s=this.params.widget.id.indexOf("preview")>-1;if(this.params.widget.deleteValue("X3DContentId"),l)e.appInitFromTransition({x3dContent:JSON.parse(l),onNoActionDone:function(){setTimeout(function(e){var t=JSON.parse(l);(t.data&&t.data.items||[]).forEach(function(e){("Drawing"===e.objectType||e.objectTaxonomies&&e.objectTaxonomies.indexOf("Drawing")>-1)&&delete e.path}),e.addRootNodesFromContent({json3DXContent:t,dispatch:!1})},0,this.pad3DViewer)}.bind(this)});else if(!0===this.params.widget.getValue("autoreload")||!0===this.params.widget.getValue("autoreloadPreviewApp")&&!s){var t=this.params.widget.getValue("reviewIdInSession");if(t){var n=JSON.parse(t);"_DMUValidationExposedPresentation"===n.objectType?h.call(this,[{id:JSON.parse(t),type:"DMUValidationExposedPresentation"}]):"_DMUValidationValidation"===n.objectType?h.call(this,[{id:JSON.parse(t),type:"DMUValidationValidation"}]):h.call(this,[{id:JSON.parse(t),type:"Markup"}])}else{var i=this.params.widget.getValue("mkpSession");if((i=i?JSON.parse(i):null)&&"ITF"===i.type){var a=this.params.widget.getValue("ItfSimuInSession");if((a=a?JSON.parse(a):null)&&!Array.isArray(a)&&"object"==typeof a){var o=Object.keys(a);if(1===o.length){var r=o[0];Array.isArray(a[r])&&a[r].length?h.call(this,a[r].map(function(e){return{id:e,type:"PLMPIMMetricReference"}})):h.call(this,[{id:r,type:"SIMItfSimulation"}])}}}else i&&i.id&&("2D"===i.type||"Document"===i.type||"msr"===i.type)&&h.call(this,[{id:i.id,type:i.plmType}])}}s?this.params.widget.setValue("autoreloadPreviewApp",!0):this.params.widget.deleteValue("autoreloadPreviewApp")}var l=this.welcomePanel.appReady();return this.welcomePanel.redraw(),l},dispose:function(){if(this.showWelcomePanel(!1),this.welcomePanel){var e=require("DS/DMUBaseExperience/DMUContextManager").getEventsController({viewer:this.pad3DViewer.getViewer()});this.tokensMkp.forEach(e.removeEvent,e),this.tokensMkp=[],this.tokensPAD.forEach(this.pad3DViewer.unsubscribe,this.pad3DViewer),this.tokensPAD=[],this.pad3DViewer=this.params=null,this.tokensWelcomePanel.forEach(l.unsubscribe,l),this.tokensWelcomePanel.length=0;var t=this.welcomePanel.dispose();return this.welcomePanel=null,t}},showWelcomePanel:function(e){this.welcomePanel&&(this.welcomePanel.elements.mainBody.style.position="relative",this.welcomePanel.elements.mainBody.style.display=e?"":"none",e&&this.welcomePanel.redraw())}};var M,y,R,P,V=!1,U="CATCmdWorkbench",A=n.getOption("testWkb");function x(){return p.widget.getValue(U)}function I(e){p.widget.setValue(U,e)}function k(){p.viewer.getContentName({callbacks:{onComplete:function(e){p.widget.setTitle(e.contentName)},onFailure:function(){}}})}var E=[],F=function(e){E.push(e),1===E.length&&function e(t){var n={lastCommand:[],currentCommand:null,defaultCommand:null},i=p.viewer.getCommandContext?p.viewer.getCommandContext():null;i?o._commandsState[i]=n:o._commandsState=n,o.resetDefaultCommand(i),o._isCommandEnding=!1,o._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach(function(e){var t=i?o[e][i]:o[e];Object.keys(t).forEach(function(e){var n=t[e];n&&n._destroy&&n._destroy(),delete t[e]})});var a=0,r=t.viewer.getFrameWindow().getActionBar(),l=r.onActionBarReady(function(){++a<t.afr.wkb.length&&t.merge?t.viewer.loadActionBar({merge:!0,file:t.afr.wkb[a].file,module:t.afr.wkb[a].module}):(r.removeCallback(l),t.viewer.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClicAfterCSOChange(),o.setDefaultCommand({ID:"R3R"===u?"DMUReviewWebAppDefaultHdr":"DMUValidationWebAppDefaultHdr",className:"R3R"===u?"DS/DMUReviewWebApp/DMUReviewWebAppDefaultCmd":"DS/DMUValidationWebApp/DMUValidationWebAppDefaultCmd",context:i}),t.actionBarReadyCb&&t.actionBarReadyCb(),t.options&&t.options.done({appMainDiv:y,pad3DViewer:t.viewer})),t.merge&&a!==t.afr.wkb.length||(E.shift(),E.length&&e(E[0]))});t.viewer.loadActionBar({merge:!1,file:t.afr.wkb[0].file,module:t.afr.wkb[0].module})}(E[0])};async function O(e){e&&(e.subscribe("onReviewContextModified",function(e){var t=e.onABReady?e.onABReady:function(){},n=x();if("Data"===e.type){if("3D"===e.data.wkb){for(var i=!1,a=0;a<P.wkb3D.wkb.length;a++)P.wkb3D.wkb[a].file===e.data.file&&P.wkb3D.wkb[a].module===e.data.module&&(i=!0);i||(P.wkb3D.wkb.push({file:e.data.file,module:e.data.module}),"3D"===n&&F({merge:!0,afr:A?P.wkb3DTst:P.wkb3D,viewer:p.viewer,actionBarReadyCb:t}))}}else"RefreshAB"===e.type?F({merge:!0,afr:P["wkb"+n],viewer:p.viewer,actionBarReadyCb:t}):("ITF"===e.type||"MSR"===e.type||"R2V"===e.type||"Document"===e.type||"Requirement"===e.type||"Requirement Specification"===e.type||e.type!==n&&P["wkb"+e.type])&&(F({merge:!0,afr:P["wkb"+e.type+(A&&P["wkb"+e.type+"Tst"]?"Tst":"")],viewer:p.viewer,actionBarReadyCb:t}),e.type.contains("Formats")||I(e.type));"ITF"===e.type?p.widget.setValue("mkpSession",JSON.stringify({type:e.type})):"Data"===e.type&&p.widget.deleteValue("mkpSession")}),await e.setActiveState(!0))}var T,_,L,W=function(){require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext","DS/PADUtils/PADCommandProxy"],function(e,t){(T=e).renderDiv||T.initialize2(p.viewer.getFrameWindow().getViewerFrame(),t.appId(),p.widget.getValue("changeControlActivation")?"show":"hide","top-right",function(){T.addEvent("onAuthoringCtxVisible",function(e){e.showAuthoringContext&&p.widget.setValue("changeControlActivation",!0)})})})},N=function(e){require(["DS/PADUtils/PADCommandProxy","DS/PADUtils/PADSharedSettings","DS/DMUBaseExperience/DMUContextManager","i18n!DS/PADUtils/assets/nls/PADUtils"],function(t,i,o,r){var l,s=[],d=[];L=function(){p.widget.setPreferences([]),l.destroy(),s.forEach(function(e){e.cb&&a.removeEvent(e.cb,e.padFct)}),L=function(){}},_=function(){if(s.forEach(function(e){var t=e.preference.name,n=p.widget.getValue(t),i=a.getSetting(t);(n="boolean"===e.preference.type&&"boolean"!=typeof n?"true"===n:n)!==i&&a.setSetting(t,n),e.fct&&e.fct(n)}),a.updateWidgetPreferences(),!l&&s.length){let e=o.giveEventsController({viewer:p.viewer.getViewer()});l=t.create({events:{onPreferenceModification:function(e){s.some(function(t){if(e.name===t.preference.name){if("boolean"!=typeof e.value&&"string"!=typeof e.value)throw new Error("Value must be a string or a boolean");if(a.getSetting(e.name)!==e.value){if("boolean"===t.preference.type&&"boolean"!=typeof e.value)throw new Error("Preference is a boolean type so value must be a boolean");t.debounce=!0,p.widget.setValue(e.name,e.value),a.setSetting(e.name,e.value)}return t.fct&&t.fct(e.value),!0}})},onSelect:function(t){e&&e.fireEvent("onCrossWidgetSelection",t)}}}),p.widgetLink&&p.widgetLink.subscribe("DS/ExternalWdgtCom/Find",t=>{e&&e.fireEvent("onCrossWidgetFind",t)}),e&&(e.addEvent("onFireCrossWidgetSelection",e=>{l&&l.select(e)}),e.addEvent("onFireCrossWidgetFind",e=>{e&&e.paths&&e.paths.length&&p.widgetLink&&p.widgetLink.publish("DS/ExternalWdgtCom/Find",{paths:e.paths})})),s.forEach(function(e){e.cb&&a.addEvent(e.cb,e.padFct=function(t){e.debounce?e.debounce=!1:l.preferenceModification({name:e.preference.name,value:t})})})}},p.widget.setPreferences([]),a.setSetting("syncAutoReload",!0),i.destroy(),i.addSharedSettings(p.widget),s.push({preference:{name:"changeControlActivation",type:"boolean",label:r.changeControlActivation_label,defaultValue:!1},fct:function(e){T&&T[e?"show":"hide"]()},cb:"onChangeControlActivation",debounce:!1}),s.push({preference:{name:"changeControlPosition",type:"list",label:r.changeControlPosition_label,defaultValue:"top-right",options:[{label:r["top-right_label"],value:"top-right"},{label:r["top-left_label"],value:"top-left"},{label:r["bottom-left_label"],value:"bottom-left"},{label:r["bottom-right_label"],value:"bottom-right"}]},fct:function(e){T&&T.setPosition(e)}}),a.setSetting("authorizeChangeControl",!0),e&&W(),n.getOption("debug")?(s.push({preference:{name:"populateTags",type:"boolean",label:r.activateFilter_label,defaultValue:!1},fct:function(e){var t=p.viewer.getBIController();t&&t.toggleBetweenStandaloneAndSlaveMode(e?"STANDALONE":"SLAVE")}}),s.push({preference:{name:"webapi_timeout",type:"text",label:"Query timeout",defaultValue:"60000"}})):d=["populateTags","webapi_timeout"],d.forEach(function(e){p.widget.deleteValue(e)}),d.length=0,s.forEach(function(e){p.widget.mergePreferences([e.preference])}),_(),p.widget.addEvent("endEdit",_)})},j=function(e){e.unsubscribe(M),M=null,k(),W(),require("DS/PADUtils/PADUtilsServices").isCloud()&&!window.__preventPrefPanel&&e.getViewer().displayIntroductoryControlPreferencePanel(),p.widget.getValue(U)||p.widget.addPreference({name:U,type:"hidden"});var t=!1,n=async function(){if(t){var n=b.getController({context:e});await O(n),R.appReady(n)}else t=!0};require([p.controller],function(e){b=e,n()}),setTimeout(function(){"1"===p.widget.getValue("widgetForODTReplay")&&(p.widgetViewer3DReview._viewer3DReview=e),p.widget.dispatchEvent("onWidgetAndAppReady","1"===p.widget.getValue("widgetForODTReplay")?[{pad3DViewer:p.viewer}]:void 0),n()}),p.viewerAttachment&&p.viewerAttachment(y),p.viewerAttachment=null,e.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClicAfterCSOChange()};function B(t){return y||(y=e.createElement("div",{class:"appMain",styles:{width:"auto",height:"100%"}})),(R=new S({widget:p.widget,readOnlyApp:!1,renderDiv:y,initApp:t&&t.initApp,onLandingPageReady:t&&t.onLandingPageReady})).initialize()}function q(e){e&&"string"==typeof e.reviewId&&p.widget.setValue("reviewIdInSession",JSON.stringify(e))}function H(){if(!p.viewer){var e=new Promise(function(e){B({initApp:!0,onLandingPageReady:function(){p.viewerAttachment(y),p.viewerAttachment=null}}).then(e)}),t=new Promise(function(e){require(["DS/ENOPAD3DViewer/PAD3DViewer","text!DS/DMUReviewCommonWebApp/assets/DMUCommonWebApp.json"],function(t,n){e([t,n])})}),n=new Promise(e=>{require(["DS/ENOXInterWdgCom/LinkManager"],t=>{p.widgetLink=t,t.initializeWidgetLink(p.widget,{appIds:[],uses:["ENXContent","ENXEnrich"],implements:["ENXContent","ENXEnrich"],open:!0}).then(e)})});Promise.all([e,t,n]).then(function(e){var t=JSON.parse(e[1][1]);t.context="Default",t.mouseProfile=require("DS/PADUtils/PADUtilsServices").isCloud()?window.__mouseProfile:"CATIA";var n=x();t.workbenchModule="2D"===n||"ITF"===n||"MSR"===n||"R2V"===n||"Document"===n||"2DFL"===n||"ReviewNoContext"===n?P["wkb"+n].wkb[0].module:P.wkb3D.wkb[0].module,t.workbench="2D"===n||"ITF"===n||"MSR"===n||"R2V"===n||"Document"===n||"2DFL"===n||"ReviewNoContext"===n?P["wkb"+n].wkb[0].file:P.wkb3D.wkb[0].file;var i={widget:p.widget,windowOptions:t,enableFiltering:!0,binaryPrimitives:!0,enableSidePanel:!0,readyCB:N,authorizedRootTypes:["MCAD Assembly","MCAD Component","VPMReference","VPMRepReference"],visuProgressiveTileModel:!0},o=p.viewer=new e[1][0](i);t.mouseProfile&&o.getViewpoint().setDefaultController(!0,t.mouseProfile),R.setViewer(o);var r=a.getSetting("propertiesFacet"),l=s.getMapping();l&&(l.physicssimulation.alwaysVisible=!1,r.push(l.physicssimulation)),o.setOption("propertiesFacet",r),o.setAuthorizedRootTypes(a.getSetting("ups_authorized_root_types")),M=o.subscribe({event:"onReady"},j),o.subscribe({event:"onRootAdded"},k),o.subscribe({event:"onRootRemoved"},k),o.subscribe({event:"onRootAttached"},k),o.subscribe({event:"onRootDetached"},k),o.subscribe({event:"onContentNameModified"},k),o.setupWidgetLink(),a.setSetting("settypes",!0),a.setSetting("syncAutoReload",!0),"1"===p.widget.getValue("widgetForODTReplay")&&p.widget.dispatchEvent("onPAD3DViewerCreated",[{pad3DViewer:o}]),p.widgetInitDone&&p.widgetInitDone({appMainDiv:y,pad3DViewer:o})})}}function X(){if(!1===V&&p.viewer){var e=p.widget.getValue("reviewIdInSession");e=e?JSON.parse(e):void 0,p.viewer.refresh();var t,n,a=i.getRoots(p.viewer),o=!1;for(let e=0;e<a.length;e++)if(""!==i.getNodeID(a[e])&&(t=i.getNodeID(a[e]),"Document"===(n=i.getNodeType(a[e]))||"Requirement"===n||"Requirement Specification"===n||"DIFSheet"===n||"DIFLayout"===n)){o=!0;break}if(o)var r=p.viewer.subscribe({event:"onRefreshCompleted"},function(){p.viewer.unsubscribe(r);var e=p.viewer.options.visuProgressiveTileModel?[{rootID:t,structure:{rootStats:{infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:t,"ds6w:type":n,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part",boundingbox:{max:[-1,-1,-1],min:[1,1,1]}},{synthesis:{name:"ProgressiveExpand_FlatSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_OccSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_LeafSynthesis",value:1}}]},infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:t,"ds6w:type":n,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part",nbchildren:"0"}]}}]:[{rootID:t,structure:{rootId:n,results:[{attributes:[{name:"did",value:t},{name:"physicalid",value:t},{name:"ds6w:type",value:n}]},{path:[t]}]}}];p.viewer.loadJSON({data:e})});else"DesignSight"===n&&p.viewer.publish({event:"widgetReresh",data:{objectId:t,objectType:n}});var l=p.viewer.subscribe({event:"onLoadingComplete"},function(){p.viewer.unsubscribe(l),q(e);var t=p.widget.getValue("reviewIdInSession");t&&b&&b.giveController({context:p.viewer}).loadReviewAfterRefresh(JSON.parse(t))})}}function G(){V=!0}function J(){if(b){var e=b.giveController({context:p.viewer});e&&e.refreshContext()}V=!1}function z(){R&&R.dispose(),R=null,p.viewer&&(b&&b.unreferenceController({context:p.viewer}),p.viewer.destroy()),p={widget:null,viewer:null,viewerAttachment:null},b=null}function Q(e){p.viewer&&p.viewer.search({searchQuery:e})}var K=function(e){if(p.widget=e.widget,y=e.appMainDiv,p.widgetInitDone=e.done,p.data=e.data.wkb?e.data.wkb:e.data,p.controller=e.data.controller?e.data.controller:e.controller,P=e.data.wkb?e.data.wkb:e.data,u=e.data.appId?e.data.appId:e.appId,e.pad3DViewer){p.viewer=e.pad3DViewer;var t=require("DS/DMUBaseExperience/DMUContextManager").getReviewContext({context:e.pad3DViewer}),n=t?t.getReviewCtxInformation():null;n&&n.reviewId&&q(n.reviewId)}else e.viewerAttachment?(p.viewerAttachment=e.viewerAttachment,H()):(p.viewerAttachment=function(e){p.widget.setBody(e)},p.widget.addEvent("onLoad",H)),p.widget.addEvent("onEdit",G),p.widget.addEvent("endEdit",J),p.widget.addEvent("onRefresh",X),p.widget.addEvent("onDestroy",z),p.widget.addEvent("onSearch",Q),"1"===p.widget.getValue("widgetForODTReplay")&&(p.widgetViewer3DReview=this),p.widget.addEvent("onDMUReviewLoaded",q),p.widget.setMetas({helpPath:"DMUReviewWebApp/assets/help"})};return K.prototype.setUp=function(e){function t(){require([p.controller],function(t){var n=(b=t).getController({context:p.viewer});(async()=>{await O(n),B().then(function(){R.setViewer(p.viewer),R.appReady(n)}),e.sourceApp&&e.sourceApp.issues&&1===e.sourceApp.issues.length&&n.appInitFromTransition({issues:e.sourceApp.issues,onNoActionDone:function(){}})})()})}e.sourceApp&&e.sourceApp.pad3DViewer!==p.viewer&&(p.viewer=e.sourceApp.pad3DViewer),p.widget.addEvent("onRefresh",X),p.widget.addEvent("onSearch",Q),p.widget.addEvent("onDMUReviewLoaded",q),p.widget.setMetas({helpPath:"DMUReviewWebApp/assets/help"}),e.sourceApp&&e.sourceApp.pad3DViewer!==p.viewer&&(p.viewer=e.sourceApp.pad3DViewer);var n=a.getSetting("propertiesFacet"),o=s.getMapping();o&&o.physicssimulation&&o.physicssimulation.facet&&(n.find(function(e){return!(!e||!e.facet||e.facet.name!==o.physicssimulation.facet.name)})||(o.physicssimulation.alwaysVisible=!1,n.push(o.physicssimulation))),p.viewer.setOption("propertiesFacet",n),p.viewer.getBIController().toggleBetweenStandaloneAndSlaveMode("DUAL"),N(p.viewer),p.viewer.getViewer().updateViewPanelUIConfiguration&&p.viewer.getViewer().updateViewPanelUIConfiguration({useShadingIllustration:!1,useOutline:!1}),k(),"3D"===x()||i.getRoots(p.viewer).length>0?(F({options:e,merge:!1,afr:P.wkb3D,actionBarReadyCb:t,viewer:p.viewer}),p.viewer.getViewer().set2DMode(!1),I("3D")):"2DFL"===x()?(F({options:e,merge:!1,afr:P.wkb2DFL,actionBarReadyCb:t,viewer:p.viewer}),I("2DFL")):"ReviewNoContext"===x()?(F({options:e,merge:!1,afr:P.wkbReviewNoContext,actionBarReadyCb:t,viewer:p.viewer}),I("ReviewNoContext")):(F({options:e,merge:!1,afr:P.wkb2D,actionBarReadyCb:t,viewer:p.viewer}),I("2D")),a.setSetting("dynamic_authorized_types",!0);var r=a.getSetting("unsupported_root_types");r.push("Drawing"),a.setSetting("unsupported_root_types",r)},K.prototype.dispose=function(e){if(a.setSetting("dynamic_authorized_types",!1),p.widget.removeEvent("onRefresh",X),p.widget.removeEvent("onSearch",Q),p.widget.removeEvent("endEdit",_),p.widget.removeEvent("onDMUReviewLoaded",q),L&&L(),R&&R.dispose(),R=null,p.viewer){var t=a.getSetting("propertiesFacet"),n=s.getMapping();if(n){var i=t.findIndex(function(e){return!(!e||!e.facet||e.facet.name!==n.physicssimulation.facet.name)});i>=0&&t.splice(i,1)}p.viewer.setOption("propertiesFacet",t),b&&b.unreferenceController({context:p.viewer,options:e})}P.wkb2D.wkb.length>1&&P.wkb2D.wkb.splice(1,P.wkb2D.wkb.length),P.wkb2DFL.wkb.length>1&&P.wkb2DFL.wkb.splice(1,P.wkb2DFL.wkb.length),P.wkb3D.wkb.length>1&&P.wkb3D.wkb.splice(1,P.wkb3D.wkb.length),P.wkb2DFormats.wkb.length>1&&P.wkb2DFormats.wkb.splice(1,P.wkb2DFormats.wkb.length),P.wkb2DFLFormats.wkb.length>1&&P.wkb2DFLFormats.wkb.splice(1,P.wkb2DFLFormats.wkb.length),P.wkb3DFormats.wkb.length>1&&P.wkb3DFormats.wkb.splice(1,P.wkb3DFormats.wkb.length),b=null},K.prototype.onWillLeave=function(e){if(p.viewer){var t=require("DS/DMUBaseExperience/DMUContextManager");if(t){var n=t.giveEventsController({viewer:p.viewer.getViewer()});n&&n.fireEvent("onLeavingR3RApp",{targetApp:e&&e.options?e.options.id:""})}}},K});