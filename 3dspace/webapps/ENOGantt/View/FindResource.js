define("DS/ENOGantt/View/FindResource",["UWA/Class","DS/Foundation2/FoundationV2Data","DS/ENOGantt/Data/ResourceStore","DS/ENOGantt/Data/ResponseUtil","DS/ENOGantt/URLStore"],function(e,t,a,r,n){var s;try{s=e.extend({init:function(){that=this;new a;that.resourceStore=Ext.create("DS.ENOGantt.Data.ResourceStore",{storeId:"resourceStore"}),Ext.define("DS.ENOGantt.View.FindResource",{extend:"Ext.form.field.ComboBox",xtype:"dpmfindresourceview",store:that.resourceStore,displayField:"title",emptyText:App.Nls["emxProgramCentral.Gantt.ResourceUtilization.FindResource.PlaceholderText"],typeAhead:!1,minChars:3,hideLabel:!0,hideTrigger:!0,width:"100%",anchor:"100%",displayField:"Name",valueField:"UserName",queryCaching:!1,listeners:{beforequery:function(e){var t=e.query;if(t){return!/([\\\"\#\$\@\%\*\,\/\?\<\>\[\]\|\:\']+(\s[\\\"\#\$\@\%\*\,\?\\\\\<\>\[\]\|\:\']+)?)/.test(t)}return!1},select:function(e,t,a){that.assignResource(t),e.clearValue()}}})},assignResource:function(e){var a=this,s=Ext.ComponentQuery.query("#dpmprojectgantt")[0],o=Ext.ComponentQuery.query("#dpmresourceutilizationpanel")[0],d=e.get("Id");if(s.resourceStore.getModelById(d))return Ext.Msg.alert(App.Nls["emxProgramCentral.Gantt.ResourceUtilization.AddAssignment.Alert.Header"],App.Nls["emxProgramCentral.Gantt.ResourceUtilization.AddAssignment.Alert.Body"].replace("{PERSON_NAME}",e.get("Name")),Ext.emptyFn),void combo.clearValue();var i=o.context,l=i.get("Id"),c=i.get("TaskProjectId"),u=s.taskStore.getModelById(c),m=u.get("StartDate").getTime(),g=u.get("EndDate").getTime();this.data={taskId:l,taskProjectId:c,projectStart:m,projectEnd:g};var p={id:c,updateAction:"NONE",relateddata:{tasks:[]}};p.relateddata.tasks.push({id:l,updateAction:"MODIFY",relateddata:{assignees:[{updateAction:"CREATE",relelements:{allocation:"100"},dataelements:{},id:d}]}});var S={};S.data=[p],S.csrf={name:App.csrf.name,value:App.csrf.value};var f=n.getAssignResourceToTaskUrl(c),D="PUT",E=function(e){for(var t=a.data.taskProjectId,n=a.data.projectStart,o=a.data.projectEnd,d=e.data[0].relateddata.assignees,i=(d=e.data[0].relateddata.tasks[0].relateddata.assignees).length,l=[],c=[],u=[],m=0;m<i;m++){var g=d[m],p=g.dataelements;if(p.FirstName=p.firstname,p.LastName=p.lastname,p.Name=p.name,delete p.firstname,delete p.lastname,delete p.name,g.relateddata.calendar&&g.relateddata.calendar.length>0){p.hasCalendar=!0;var S=g.relateddata.calendar[0].id}var f=p.WorkTime;p.WorkTime=f?parseFloat(f)/60:parseFloat("8.0");var D=p.Id;if(""==S||null==S)S="Custom:"+D;p.CalendarId=S,l.push(p);var E=g.relateddata.Assignments;if(E.length>0)for(var h=E[0].dataelements,T=(h.contextUser,1);T<E.length;T++){var y=E[T],k=y.dataelements,x=y.relelements;r.convertToGanttKeyValues(k),r.convertToGanttKeyValues(x);var v=new Date(k.StartDate),I=new Date(k.EndDate),N=r.stdTimezoneOffset(v),A=v.getTimezoneOffset();if(v=v.getTime(),I=I.getTime(),N!==A&&(v+=60*(A-N)*1e3,I+=60*(A-N)*1e3),!(v<n||I>o)){var R={};R.TaskId=k.TaskId;var O=s.taskStore.getModelById(R.TaskId);R.isReadOnly=!1,O&&"TRUE"!=O.data.hasEditAccess&&(R.isReadOnly=!0);var C=y.type;if(h[C]&&(R.icon=h[C]),R.Id=x.Id,R.Units=x.allocation,R.ResourceId=D,k.TaskProjectId==t)R.Type="Internal";else{var F={};R.Type="External",F.Id=k.TaskId,F.Name=k.Name,F.PercentDone=k.PercentDone,F.Duration=k.Duration,k.StartDate&&(k.StartDate=Ext.Date.format(new Date(k.StartDate),"c")),k.EndDate&&(k.EndDate=Ext.Date.format(new Date(k.EndDate),"c")),F.StartDate=k.StartDate,F.EndDate=k.EndDate,F.expanded=!0,u.push(F)}c.push(R)}}}var G=s.taskStore.data.items[0],j=u.length;if(j>0)for(m=0;m<j;m++){var w=u[m],P=w.Id;if(null==s.taskStore.getModelById(P)&&"root"!=w.Name){w.visible=!1,w.Id=P,w.Rollup=!1,w.ReadOnly=!0,w.ExternalTask=!0,w.expanded=!0;var U=Ext.create("DS.ENOGantt.Data.TaskModel",w);App.Infra.ExtTaskArray.push(U),G.addTaskBelow(U),G.nextSibling="",s.taskStore.commitChanges()}}c.length;l.length>0&&s.taskStore.resourceStore.add(l),c.length>0&&s.taskStore.assignmentStore.add(c),s.taskStore.resourceStore.commitChanges(),s.taskStore.assignmentStore.commitChanges(),s.taskStore.commitChanges(),s.taskStore.filterBy(function(e){return!e.get("ExternalTask")})};window.isODTRunning?(D="GET",S="",Ext.Ajax.request({url:f,async:!1,success:function(e){e=JSON.parse(e.responseText.trim()),E(e)}})):t.ajaxRequest({url:f,data:JSON.stringify(S),type:D,dataType:"json",callback:E})}})}catch(e){console.log("::::::::error")}return s});