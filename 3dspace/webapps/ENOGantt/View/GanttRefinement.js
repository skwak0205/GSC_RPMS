define("DS/ENOGantt/View/GanttRefinement",["UWA/Core","UWA/Class/View","DS/ENOGantt/Ven/Ext","DS/ENOGantt/GanttUtil","DS/ENOGantt/Controller/MainController"],function(e,t,a,l,r){var n=!1,i=["PercentDone","Duration","BaselineDuration","TotalFloat","FreeFloat","Deviation"];return t.extend({setup:function(e){var t=this;this.taskModel=e.taskModel,this.taskStore=e.taskStore,this.taskStore.on("filterchange",function(){App.Gantt.filter.filterField||t.refresh()},this),this.taskStore.on("nodeExpand",function(){t.refresh("nodeExpand")},this),this.taskStore.on("nodeCollapse",function(){t.refresh()},this),this.taskStore.on("commit",function(e){t.refresh()})},resize:function(){},refresh:function(e){if(this.panel.isVisible()){var t=new a.util.HashMap;enoviaServer.resetRefinement?delete enoviaServer.resetRefinement:t=this.getRefinementSectionExpandCollapseStateMap(),this.panel.removeAll(),this.panel.add(this.getFields(null,t))}App.Gantt.filter.filterBy.Name&&"nodeExpand"==e&&this.taskStore.filterTreeBy(),this.retainSelection()},getRefinementSectionExpandCollapseStateMap:function(){var e=new a.util.HashMap,t=a.ComponentQuery.query("panel#GanttRefinementPanel")[0];if(t)for(var l=t.items.items,r=0,n=l.length;r<n;r++){var i=l[r],o=i.id,s=i.collapsed;e.add(o,s)}return e},getPatternFields:function(e){var t=App.Nls["emxProgramCentral.Gantt.TaskPattern"]||"Task Pattern";if(a.ComponentQuery.query("#dpmprojectgantt")[0].getTaskStore()){var l={dataIndex:"Pattern",name:"pattern",collapsible:!0},r=this.getValueArray(l,!0),i=[];i.push({boxLabel:"<div>"+App.Nls["emxProgramCentral.Common.All"]+"</div>",name:"Pattern",inputValue:"Select All"});for(var o=0,s=r.length;o<s;o++){var p="";if(""==(d=r[o])){i.push({boxLabel:"<div>"+App.Nls["emxProgramCentral.Gantt.NoPattern"]+"</div>",name:"Pattern",inputValue:d});break}}for(o=0,s=r.length;o<s;o++){var d;p="";null!=(d=r[o])&&""!=d&&(p='<div class="'+d+" "+d+'-Refinement">&nbsp;</div>',i.push({boxLabel:p,name:"Pattern",inputValue:d}))}return{xtype:"fieldset",title:"<div>"+t+"</div>",id:"cidPattern",name:"pattern",collapsible:!0,defaultType:"checkbox",collapsed:e,defaults:{anchor:"100%"},layout:"anchor",items:i,defaults:{anchor:"100%",listeners:{change:function(e,t,l,r){var i=e.name,o=a.getCmp("cid"+i).items.items;if("Select All"==e.inputValue){if(1==t)for(var s=0,p=o.length;s<p;s++){o[s].setValue(!0)}else if(!n)for(s=0,p=o.length;s<p;s++){o[s].setValue(!1)}n=!1}else{if(0==t)n=!0,o[0].setValue(!1)}}}}}}},getColorFields:function(e){var t=App.Nls["emxProgramCentral.Gantt.TaskColor"]||"Task Color";if(a.ComponentQuery.query("#dpmprojectgantt")[0].getTaskStore()){var l={dataIndex:"Color",name:"color",collapsible:!0},r=this.getValueArray(l,!0),i=[];i.push({boxLabel:"<div>"+App.Nls["emxProgramCentral.Common.All"]+"</div>",name:"Color",inputValue:"Select All"});for(var o=0,s=r.length;o<s;o++){var p="";if(""==(d=r[o])){i.push({boxLabel:"<div>"+App.Nls["emxProgramCentral.Gantt.NoColor"]+"</div>",name:"Color",inputValue:d});break}}for(o=0,s=r.length;o<s;o++){var d;p="";""!=(d=r[o])&&(p='<div class="status" style="background-color: #'+d+'">&nbsp;</div>',i.push({boxLabel:p,name:"Color",inputValue:d}))}return{xtype:"fieldset",title:"<div>"+t+"</div>",id:"cidColor",name:"color",collapsible:!0,defaultType:"checkbox",collapsed:e,defaults:{anchor:"100%"},layout:"anchor",items:i,defaults:{anchor:"100%",listeners:{change:function(e,t,l,r){var i=e.name,o=a.getCmp("cid"+i).items.items;if("Select All"==e.inputValue){if(1==t)for(var s=0,p=o.length;s<p;s++){o[s].setValue(!0)}else if(!n)for(s=0,p=o.length;s<p;s++){o[s].setValue(!1)}n=!1}else{if(0==t)n=!0,o[0].setValue(!1)}}}}}}},retainSelection:function(e){if(App.Gantt.filter.filterBy)for(var t in App.Gantt.filter.filterBy)if("Name"!==t){var l=App.Gantt.filter.filterBy[t].split("@");if("datefield"==App.Gantt.filter.fields[t].fieldDataType)a.getCmp(t+"_from_date").setValue(l[0].split("#")[0]),a.getCmp(t+"_to_date").setValue(l[1].split("#")[0]);else if(i.includes(t))parseInt(l[0])<=parseInt(l[1])?(a.getCmp(t+"_from").setValue(l[0]),a.getCmp(t+"_to").setValue(l[1])):(a.getCmp(t+"_from").setValue(Math.floor(this.taskStore.collect(t))),a.getCmp(t+"_from").setMaxValue(Math.ceil(this.taskStore.collect(t))),a.getCmp(t+"_from").setMinValue(Math.floor(this.taskStore.collect(t))),a.getCmp(t+"_to").setValue(Math.ceil(this.taskStore.collect(t))),a.getCmp(t+"_to").setMaxValue(Math.ceil(this.taskStore.collect(t))),a.getCmp(t+"_to").setMinValue(Math.floor(this.taskStore.collect(t))));else{var r=a.getCmp(t);"Color"==t?r=a.getCmp("cid"+t):"Pattern"==t&&(r=a.getCmp("cid"+t));for(var n=r.items.items,o=0,s=n.length;o<s;o++)checkBox=n[o],checkBoxValue=checkBox.inputValue,l.indexOf(checkBoxValue.toString())>=0&&checkBox.setValue(!0)}}},render:function(){var e=this;if(!this.panel){var t=App.Nls["emxProgramCentral.gantt.Refinements"];this.panel=a.create("Ext.form.Panel",{title:"<div>"+t+"</div>",xtype:"dpmganttrefinement",id:"GanttRefinementPanel",controller:"GanttViewController",region:"west",store:e.taskStore,width:290,hidden:!0,frame:!0,scrollable:!0,buttons:[{id:"btnApplyRefinement",text:App.Nls["emxProgramCentral.Common.Apply"],tooltip:App.Nls["emxProgramCentral.Common.Apply"],overflowText:App.Nls["emxProgramCentral.Common.Apply"],scope:e,width:85,style:"border-color:#368EC4;background-color:#368EC4;color:#FFFFFF !important;font-size:14px;",cls:"apply-button-text",reference:"filter"},{id:"btnResetRefinement",width:95,text:App.Nls["emxProgramCentral.Common.Reset"],scope:e,tooltip:App.Nls["emxProgramCentral.Common.Reset"],overflowText:App.Nls["emxProgramCentral.Common.Reset"],reference:"resetFilter"},{id:"btnCloseRefinement",width:75,text:App.Nls["emxProgramCentral.Common.Close"],tooltip:App.Nls["emxProgramCentral.Common.Close"],overflowText:App.Nls["emxProgramCentral.Common.Close"],scope:e,reference:"hide"}],beforeShow:function(){e.refresh()}})}},getFieldItems:function(e,t){e.header;var l,r=e.dataIndex,n=e.columnDataType,i=new Array;if("Duration"!=r&&"Deviation"!=r&&"TotalFloat"!=r&&"FreeFloat"!=r&&"BaselineDuration"!=r||(l=App.Nls["emxProgramCentral.DurationUnits.Days"]),this.taskStore&&t&&t.length>0)if(i.push({boxLabel:"<div>"+App.Nls["emxProgramCentral.Common.All"]+"</div>",name:r,inputValue:"Select All"}),"Status"==r)for(var o=0,s=t.length;o<s;o++){var p=t[o],d="",f=App.Nls["emxProgramCentral.Gantt.TaskStatus."+p];f&&(d='<div class="status '+p+'" style="display:inline-block;position:absolute;top:7px;">&nbsp;</div><div style="display:inline-block;position:absolute;left:35px;top:5px;">'+f+"</div>"),i.push({boxLabel:d,name:"Status",inputValue:p})}else this.sorteFieldValueArray(n,t,l,r),a.Array.forEach(t,function(e,t){i.push({boxLabel:"<div>"+e+"</div>",name:r,inputValue:e})});return i},sorteFieldValueArray:function(e,t,a,l){if("datefield"==e)t.sort(function(e,t){return(e=new Date(e))-(t=new Date(t))});else if(t.sort(function(e,t){return e-t}),"Duration"==l){a=" "+a.toLowerCase();for(var r=0,n=t.length;r<n;r++)t[r]=t[r]+a}},getDateFields:function(e,t){var a=l.getDateFormat(),r=e.dataIndex,n=e.groupedHeader?e.groupedHeader:e.header;return"BaselineStartDate"!=r&&"BaselineEndDate"!=r||(n=App.Nls["emxProgramCentral.Gantt.Forecast"]+" "+n),{xtype:"fieldset",defaultType:"datefield",title:"<div>"+n+"</div>",id:"cid"+r,name:r,collapsible:!0,collapsed:t,defaults:{anchor:"100%"},layout:"anchor",items:[{id:r+"_from_date",name:r,anchor:"100%",fieldLabel:App.Nls["emxProgramCentral.Gantt.Refinement.FromDate"],format:a,labelPad:-60,editable:!1},{id:r+"_to_date",name:r,anchor:"100%",fieldLabel:App.Nls["emxProgramCentral.Gantt.Refinement.ToDate"],format:a,labelPad:-60,editable:!1}]}},getValueArray:function(e,t){var a=e.dataIndex,l=[];if(Object.keys(App.Gantt.filter.filterBy).length<=0)l=this.taskStore.collect(a,{allowNull:t,filtered:!0});else{App.Gantt.filter.FilterFieldTaskArray=[],App.Gantt.filter.filterField=a,this.taskStore.filterTreeBy();var r=App.Gantt.filter.FilterFieldTaskArray;delete App.Gantt.filter.filterField,delete App.Gantt.filter.FilterFieldTaskArray;for(var n=0,i=r.length;n<i;n++){var o=r[n].data[a];(o||0==o)&&l.indexOf(o)<0&&l.push(o)}}return l},getNumberFields:function(e,t,a){var l=e.dataIndex,r="Duration"==l?App.Nls["emxProgramCentral.DurationUnits.Days"]+"/"+App.Nls["emxProgramCentral.DurationUnits.Hours"]:App.Nls["emxProgramCentral.DurationUnits.Days"],n=[],i=!1;if(0===a.length)i=!0;else{for(var o=0,s=a.length;o<s;o++){var p=a[o];if("Deviation"==l){var d=p.indexOf(r);p=p.substring(0,d)}p=parseFloat(p),n.push(p)}var f=Math.floor(Math.min.apply(Math,n)),m=Math.ceil(Math.max.apply(Math,n))}var u=e.groupedHeader?e.groupedHeader:e.header;if("TotalFloat"==l||"FreeFloat"==l?u=u+" "+App.Nls["emxProgramCentral.Gantt.Float"]:"BaselineDuration"==l&&(u=App.Nls["emxProgramCentral.Gantt.Forecast"]+" "+u),App.Gantt.filter.filterBy[l]){var c=App.Gantt.filter.filterBy[l].split("@"),h=parseFloat(c[0]),g=parseFloat(c[1]);g>m&&(g=m),h<f&&(h=f),App.Gantt.filter.filterBy[l]=h.toString().concat("@").concat(g.toString()),g===m&&h===f&&delete App.Gantt.filter.filterBy[l]}return{xtype:"fieldset",title:"<div>"+u+(r="PercentDone"==l?"":" ("+r+")")+"</div>",id:"cid"+l,name:l,defaults:{anchor:"100%"},collapsible:!0,collapsed:t,hidden:i,items:[{id:l+"_from",xtype:"numberfield",fieldLabel:App.Nls["emxProgramCentral.Gantt.Refinement.FromDate"],allowBlank:!1,minValue:f,maxValue:m,value:f,labelPad:-60,anchor:"100%",name:l},{id:l+"_to",xtype:"numberfield",fieldLabel:App.Nls["emxProgramCentral.Gantt.Refinement.ToDate"],allowBlank:!1,minValue:f,maxValue:m,value:m,labelPad:-60,anchor:"100%",name:l}]}},getFields:function(e,t){var l=this;e||(e=App.Infra.Columns);var r=new Array,o=!1,s=enoviaServer.viewId;if(a.Array.forEach(e,function(e,o){if(!e.excludeInRefinement){var p=e.name;if(s&&"WBSView"==s&&p&&("BaselineStartDate"==p||"BaselineEndDate"==p||"BaselineDuration"==p))return;if(s&&"PlannedVsActualView"!=s&&e.hidden)return;if(e.columns){for(var d=0,f=e.columns.length;d<f;d++){var m=e.columns[d];m.groupedHeader||(m.groupedHeader=e.text+" "+m.header)}r=r.concat(l.getFields(e.columns,t))}else if(e&&!e.excludeInRefinement){var u=App.Gantt.filter.filterBy&&e.dataIndex in App.Gantt.filter.filterBy?"selected-fieldset":"",c=p;("datefield"==e.columnDataType||i.includes(p))&&(c="cid"+p);var h=t.get(c);if(null==h&&(h="Type"!==p&&"State"!==p&&"Status"!==p),"datefield"==e.columnDataType){var g=l.getDateFields(e,h);g.cls=u,r.push(g)}else if(i.includes(p)){var v=l.getValueArray(e),x=l.getNumberFields(e,h,v);r.push(x)}else{v=l.getValueArray(e);var C=l.getFieldItems(e,v);if(C&&C.length>0){var A=e.groupedHeader?e.groupedHeader:e.header;r.push({xtype:"fieldset",cls:u,title:"<div>"+A+"</div>",id:e.dataIndex,name:e.dataIndex,collapsible:!0,collapsed:h,defaultType:"checkbox",layout:"anchor",items:C,defaults:{anchor:"100%",listeners:{change:function(e,t,l,r){var i=a.getCmp(e.getName()).items.items;if("Select All"==e.inputValue){if(1==t)for(var o=0,s=i.length;o<s;o++){i[o].setValue(!0)}else if(!n)for(o=0,s=i.length;o<s;o++){i[o].setValue(!1)}n=!1}else{if(0==t)n=!0,i[0].setValue(!1)}}}}})}}App.Gantt.filter.fields[e.dataIndex]={fieldLabel:e.columnLabel,fieldDataType:e.columnDataType}}}}),r.length>3||r.length>2&&"ProjectTemplateView"==s){null==(o=t.get("cidColor"))&&(o=!0);var p=l.getColorFields(o);p.items.length>2||null!=App.Gantt.filter.filterBy.Color?(App.Gantt.filter.fields.Color={fieldLabel:"Color",fieldDataType:"string"},r.push(p)):null==App.Gantt.filter.filterBy.Color&&delete App.Gantt.filter.filterBy.Color,null==(o=t.get("cidPattern"))&&(o=!0);var d=l.getPatternFields(o);d.items.length>2?(App.Gantt.filter.fields.Pattern={fieldLabel:"Pattern",fieldDataType:"string"},r.push(d)):null==App.Gantt.filter.filterBy.Pattern&&delete App.Gantt.filter.filterBy.Pattern}return r}})});