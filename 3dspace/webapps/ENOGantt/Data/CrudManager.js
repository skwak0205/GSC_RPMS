define("DS/ENOGantt/Data/CrudManager",["UWA/Class","DS/PlatformAPI/PlatformAPI","DS/Foundation2/FoundationV2Data","DS/ENOGantt/Ven/Bryntum","DS/ENOGantt/Data/TaskStore","DS/ENOGantt/Data/ResponseUtil","DS/ENOGantt/URLStore","DS/ENOProjectMgmtModels/Utils/StorageDataUtil"],function(e,t,a,r,n,s,o,d){return e.extend({init:function(){var e=new n;e=e.getStore(),Ext.define("DS.ENOGantt.Data.CrudManager",{extend:"Gnt.data.CrudManager",autoLoad:!1,taskStore:e,prepareRemoved:function(e){for(var t,a=[],r=0,n=e.length;r<n;r++)(t={})[e[r].idProperty]=e[r].getId(),"Gnt.model.Dependency"==e[r].$className&&(t.To=e[r].get("To"),t.From=e[r].get("From")),"Gnt.model.Assignment"==e[r].$className&&(t.TaskId=e[r].get("TaskId")),a.push(t);return a},sendRequest:function(){var e=this,t="live",n=e.transport.sync.params;n&&n.AddRemoveTask&&(t="");var l={rollup:t},i=arguments[0].success,p=JSON.parse(arguments[0].data).type,c="GET";url=o.getTaskRepositoryURL(p,l,this.transport.load.url),this.transport.load.url=url;var u,m={};if("sync"==p){if(u={},c="PUT",(m=this.getChangeSetPackage()).tasks)if(void 0===m.tasks.updated)m.tasks.updated={},m.tasks.updated[1]={Id:e.getTaskStore().data.items[0].data.Id};else{for(var f=e.getTaskStore().getRoot().childNodes[0].data.Id,A=m.tasks.updated,g=!1,v=0,S=A.length;v<S;v++){if(A[v].Id===f){g=!0;break}}0==g&&(m.tasks.updated[A.length]={Id:f})}u.data=s.format6WData(this,m),u.csrf={name:App.csrf.name,value:App.csrf.value}}u=this.encode(u);App.Infra.ViewId!=App.Infra.Views.VIEW_STATUS_REPORT||App.Infra.LoadStatusActualData||enoviaServer.initGantt||(c="POST",u="$ids="+objectId);var D=function(t){if(window.isODTRunning&&(this.type=window.ODT.type?window.ODT.type:"GET",delete window.ODT.type),t.error){null!=App.Infra.Load.Level&&0!=App.Infra.Load.Level&&(App.Infra.Load.Level=App.Infra.Load.Level+1),e.activeRequests={};var a=App.Nls["emxProgramCentral.Gantt.ServerSideFailure"];a=a.replace(/\\n/g,"\n"),alert(a),e.load()}else{var n=t.data,o=t.csrf;if(o&&(App.csrf=o),"PUT"==this.type||"PUT"==this.method){var l=e.transport.sync.params,p=s.syncFormat(n,!1,l,e);e.transport.sync.params={};var c=e.encode(p);i.call(e,c);var u=e.taskStore.store.data.items[0];0!=u.data.PercentDone&&u.data.State===App.Nls.Create&&(u.data.State=App.Nls.Active,e.commit()),100===u.data.PercentDone&&(u.data.State=App.Nls.Review,e.commit()),window.isIFWE&&(u.previousValues.EndDate||u.previousValues.StartDate)&&(App.ContextModel.model.set({estimatedFinishDate:u.data.EndDate,estimatedStartDate:u.data.StartDate}),delete u.previousValues.StartDate,delete u.previousValues.EndDate,App.ContextModel.model.resetChangedAttrs(),d.set(App.ContextModel.model.id,App.ContextModel.model),App.ContextModel.updateDetailsDisplay()),(l&&l.AddRemoveTask||l&&l.AddRemoveDep||l&&l.LeftIndent||l&&l.RightIndent||l&&l.DragDrop)&&(App.Infra.loadProjectSelectable||(App.Infra.loadProjectSelectable=!0),null!=App.Infra.Load.Level&&0!=App.Infra.Load.Level&&(App.Infra.Load.Level=App.Infra.Load.Level+1),e.load())}else{if(App.Infra.ViewId==App.Infra.Views.VIEW_STATUS_REPORT){if(!App.Infra.LoadStatusActualData&&!enoviaServer.initGantt){var m={relateddata:{}};m.relateddata.tasks=n,n=[m]}}else if(n.length>1){var f=n[1];s.getsourceIdData(f),n.splice(1,1)}var A=s.loadFormat(n);if(delete App.Infra.calendarData,App.Infra.LoadStatusActualData){var g=s.filterTaskForStatusReport(A,e);A.tasks.rows=g,delete App.Infra.LoadStatusActualData}console.timeEnd("loadFormat");c=e.encode(p);if(i.call(e,A,c),e.taskStore.store.autoNormalizeNodes=!0,e.taskStore.store.dependenciesCalendar=App.Infra.depLagCalendar,null==App.Infra.ProjectCalendar||""==App.Infra.ProjectCalendar){var v=e.taskStore.store.data.items[0].get("CalendarId");if(null==v||""==v){var S=new r.data.calendar.BusinessTime({name:"General",calendarId:"General"});e.taskStore.store.setCalendar(S,!0)}else{S=e.getStore("calendars").getCalendar(v);e.taskStore.store.setCalendar(S,!0)}App.Infra.ProjectCalendar=S}if((App.Infra.ViewId==App.Infra.Views.VIEW_STATUS_REPORT||1==App.Infra.ReadOnly)&&null==e.taskStore.store.data.items[0].getBaselineEndDate()){var D=Ext.getCmp("View");D.isDisabled()||D.disable()}var I=App.Infra.ViewId;if(I==App.Infra.Views.VIEW_EXPERIMENT_VERSUS_PROJECT||I==App.Infra.Views.VIEW_BASELINE_VERSUS_CURRENT_BASELINE||I==App.Infra.Views.VIEW_BASELINE_VERSUS_CURRENT_BASELINE2){var E=e.getTaskStore().collect("BaselineStartDate");E.sort(function(e,t){return(e=new Date(e))-(t=new Date(t))});var T=e.getTaskStore().collect("BaselineEndDate");T.sort(function(e,t){return(e=new Date(e))-(t=new Date(t))}),u.setBaselineStartDate(E[0]),u.setBaselineEndDate(T[T.length-1]),e.commit()}if(e.transport.load.resolve)console.log("Reolve in CRUD"),(0,e.transport.load.resolve)(),delete e.transport.load.resolve;console.timeEnd("call"),App.Infra.loadProjectSelectable&&(App.Infra.loadProjectSelectable=!1)}}(e.transport.load.resolve||window.ODT&&window.ODT.resolve)&&((e.transport.load.resolve||window.ODT.resolve)(),delete e.transport.load.resolve,delete window.ODT.resolve)};window.isODTRunning?(this.type,c="GET",Ext.Ajax.request({url:url,method:c,async:!1,success:function(e){e=JSON.parse(e.responseText.trim()),D(e)}})):a.ajaxRequest({data:u,url:url,type:c,dataType:"json",callback:D})},transport:{load:{method:"GET",url:"/resources/v1/modeler/projects/"+enoviaServer.physicalId+"/dpmgantt",requestConfig:{timeout:6e4}},sync:{url:"/resources/v1/modeler/projects/"+enoviaServer.physicalId+"/dpmgantt",requestConfig:{timeout:6e4},params:{}}}});var t=Ext.create("DS.ENOGantt.Data.CrudManager");t.on("sync",function(e,t){if(window.isODTRunning&&this.commit(),null!=t&&t.error)alert(t.error),this.reject();else{if(t.assignments)if(t.assignments.rows.length>0||t.assignments.removed.length>0||t.resources.rows.length>0||t.resources.removed.length>0)Ext.ComponentQuery.query("#dpmresourceutilizationpanel")[0].getStore().commitChanges(),this.commit();this.hasChanges()?(console.log("============SYNC CALLED========"),this.sync(),this.commit()):this.commit();var a=Ext.getCmp("tBarActionSaveAll"),r=Ext.getCmp("tBarActionResetAll"),n=Ext.getCmp("tBarActionUndo"),s=Ext.getCmp("tBarActionRedo");a.isDisabled()&&r.isDisabled()&&n.isDisabled()&&s.isDisabled()||(a.disable(),r.disable(),n.disable(),s.disable())}Ext.ComponentQuery.query("#dpmprojectgantt")[0].undoManager.start()}),t.on("haschanges",function(e,t){var a=Ext.getCmp("tBarActionSaveAll"),r=Ext.getCmp("tBarActionResetAll"),n=Ext.getCmp("tBarActionUndo");(a.isDisabled()||r.isDisabled()||n.isDisabled())&&(a.enable(),r.enable(),n.enable())}),t.on("nochanges",function(e,t){var a=Ext.getCmp("tBarActionSaveAll"),r=Ext.getCmp("tBarActionResetAll"),n=Ext.getCmp("tBarActionUndo"),s=Ext.getCmp("tBarActionRedo");if(a&&r&&!(a.isDisabled()&&r.isDisabled()&&n.isDisabled()&&s.isDisabled())&&(a.disable(),r.disable(),n.disable(),!0===App.Infra.OnReset)){if(null!=s)if(!s.isDisabled())s.disable(),Ext.ComponentQuery.query("#dpmprojectgantt")[0].undoManager.redoQueue=[];delete App.Infra.OnReset}}),t.on("beforeload",function(e,t,a){var r=Ext.ComponentQuery.query("#dpmprojectgantt")[0];r.rendered&&r.setLoading({msg:App.Infra.LoadText||r.L("loadingText")})}),t.on("beforesync",function(e,t){var a=Ext.ComponentQuery.query("#dpmprojectgantt")[0];a.undoManager.stop(),a.rendered&&a.setLoading({msg:"load"===t.type?a.L("loadingText"):a.L("savingText")})}),this.crudManager=t}})});