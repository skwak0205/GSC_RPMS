define("DS/Issue3DReview/commands/Print",["UWA/Class","DS/ApplicationFrame/CommandCheckHeader"],function(e,t){"use strict";var n=100;return e.extend(t,{init:function(e){var t=this;t._parent(e,{}),require(["UWA/Class/Promise","UWA/Core","DS/UIKIT/Mask","DS/VENWebCanvg/CanvgTools","DS/2DAnnotation/components/ImageEditor","DS/IssueServices/Contexts"],function(e,s,i,o,r,a){var l=a.get("widget")||window.widget,c=t.onStateChange(function(c){if(!1!==c){i.mask(l.body);var u=l.body.getElement("#divCss2DElement");u.setStyle("z-index","9999"),window.Promise=e;var d=a.get("pad3DViewer");d.getFrameWindow().getActionBar().close();var h=new o,p=d.getFrameWindow().elements.viewerFrame,g=[],m=[],f=p.getElementsByTagName("svg");try{for(var v=f.length-1;v>=0;v--){var w=f[v],b=w.parentNode,D=w.outerHTML,S=s.createElement("canvas");h.svgToCanvas(D,S),g.push({parent:b,child:w}),b.removeChild(w),m.push({parent:b,child:S}),b.appendChild(S)}}catch(e){}r.utils.capture(p,{imageTimeout:n,allowTaint:!0,onRendered:function(e){var t=e.getContext("2d");t.webkitImageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=!1,t.imageSmoothingEnabled=!1}}).then(function(e){g.forEach(function(e){e.parent.appendChild(e.child)}),m.forEach(function(e){e.parent.removeChild(e.child)}),d.getFrameWindow().getActionBar().open();var o=s.createElement("img",{src:e.dataURL}),r=window.open("","printForm","width="+e.canvas.width+", height="+e.canvas.height);r.document.body.innerHTML=o.outerHTML,setTimeout(function(){r.print(),setTimeout(function(){r.close(),u.setStyle("z-index","auto"),t.setState(!1,!1),i.unmask(l.body)},n)},n)})}});t._destroy=function(){t._modelEvents.unsubscribe(c)}})}})}),define("DS/Issue3DReview/commands/CommandsManager",["DS/ApplicationFrame/CommandsManager","DS/Logger/Logger"],function(e,t){"use strict";var n=t.getLogger("DS/Issue3DReview/commands/CommandsManager"),s={disabled:!1,commands:{toEnable:[],toDisable:[]},commandCheckHeaders:{toEnable:[],toDisable:[]}},i="Default";return{setContext:function(e){i=e},select:function(e){var t=[],n=[];e&&e.length>0?(e.length>=1&&t.push("Open","Inspect","Share"),1===e.length?t.push("AttachmentManager","Mockup"):n.push("AttachmentManager","Mockup")):n.push("Open","AttachmentManager","Mockup","Inspect","Share"),this._switchCommands(t,!0),this._switchCommands(n,!1)},getCommand:function(t){var n=i;return e.getCommand(t,n)},getCommandCheckHeader:function(t){var n=i;return e.getCommandCheckHeader(t,n)},disableAll:function(){if(!0!==s.disabled){var t=i,n=e.getCommands(t),o=Object.keys(n),r=e.getCommandCheckHeaders(t),a=Object.keys(r);s={disabled:!0,commands:{toEnable:[],toDisable:[]},commandCheckHeaders:{toEnable:[],toDisable:[]}};for(var l=0;l<o.length;l++)n[o[l]].isEnabled()?s.commands.toEnable.push(o[l]):s.commands.toDisable.push(o[l]);for(var c=0;c<a.length;c++)r[a[c]].isEnabled()?s.commandCheckHeaders.toEnable.push(a[c]):s.commandCheckHeaders.toDisable.push(a[c]);e.disableAll(t)}},enableAll:function(){if(!1!==s.disabled){var t=i;e.enableAll(t);var n=e.getCommands(t);if(s&&s.commands){for(var o=0;o<s.commands.toEnable.length;o++)n[s.commands.toEnable[o]].enable();for(var r=0;r<s.commands.toDisable.length;r++)n[s.commands.toDisable[r]].disable()}var a=e.getCommandCheckHeaders(t);if(s&&s.commandCheckHeaders){for(var l=0;l<s.commandCheckHeaders.toEnable.length;l++)a[s.commandCheckHeaders.toEnable[l]].enable();for(var c=0;c<s.commandCheckHeaders.toDisable.length;c++)a[s.commandCheckHeaders.toDisable[c]].disable()}s={disabled:!1,commands:{toEnable:[],toDisable:[]},commandCheckHeaders:{toEnable:[],toDisable:[]}}}},_switchCommands:function(e,t){for(var s=0;s<e.length;s++){var i=this.getCommand(e[s]);void 0===i&&(i=this.getCommandCheckHeader(e[s]));try{!0===t?i.enable():i.disable()}catch(i){n.error("Error "+(t?"enabling":"disabling"),e[s],i)}}},inspectingIssue:function(){var e=[];e.push("Reset","CreateFromBlank","CreateFromTemplate","Display","Focus","Refresh","Templates","CreateFrom3D"),this._switchCommands(e,!1)},releasingIssue:function(){var e=[],t=[];e.push("Reset","CreateFromBlank","CreateFromTemplate","Display","Focus","Refresh","Templates","CreateFrom3D"),t.push("Inspect"),this._switchCommands(e,!0),this._switchCommands(t,!1)},clean:function(t){t||(t="Default"),e._commandsState[t]={lastCommand:[],currentCommand:null,defaultCommand:null},e.resetDefaultCommand(t),e._isCommandEnding=!1,e._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach(function(n){var s=t&&e[n][t]?e[n][t]:e[n];Object.keys(s).forEach(function(e){var t=s[e];t&&t._destroy&&t._destroy(),delete s[e]})})}}}),define("DS/Issue3DReview/models/Marker",["UWA/Core","UWA/Class/Model","DS/Logger/Logger","DS/Visualization/ThreeJS_DS","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance"],function(e,t,n,s,i,o,r){"use strict";var a="(╯°□°）╯︵ ┻━┻",l="x",c="y",u="z",d=0;return t.extend({name:"DS/Issue3DReview/models/Marker",defaults:{id:"",physicalId:"",issue:"",type:"",name:"",revision:"",title:"",node:null,position:null,original:null,inverse:null,path:[],color:"",default:null,temporary:!1,path_str:""},_logger:null,setup:function(){this._logger=n.getLogger("DS/Issue3DReview/Model"),this._logger.debug("Marker for issue %s (%s) has been initialized",this.get("title"),this.get("name")),r.start(this.name+" setup");var e=this.get("id").split(a);this.set("issueId",e[0]),this.set("physicalId",e[1]),this.set("instanceIdx",e[2]);var t=this.get("path_str");if(t){var o=t.split(","),d=o[o.length-1];this.set("physicalId",d),this.set("node",d)}this.set("default",this.utils.getCenterBoundingSphere(this.get("path"),this.get("node"))),this.set("axis",this.utils.getAxisSystem(this.get("path"),this.get("node")));var h=i.get("component").get3DContext().controller,p=new s.Matrix4;p.extractRotation(h._model.getWorldMatrix(this.get("path"))),this.set("inverse",(new s.Matrix4).getInverse(p));var g=this.get("position");if(!0===this.utils.isValidPosition(g)){var m=new s.Vector3(g[l],g[c],g[u]);this.set("original",m),m.applyMatrix4(p);var f=this.utils.getRelativePosition(this.get("axis"),m);this.set("position",f)}else this.set("position",null);r.end(this.name+" setup")},save:function(t,n){var i=this;i._logger.debug("Saving marker %s from issue %s (%s)",i.get("id"),i.get("title"),i.get("name")),r.start(i.name+" save");var a=i.get("issue").get("id"),d=i.utils.convert(i,e.clone(t));d.physicalId=i.get("physicalId");var h=i.get("path_str");d.path=h.split(",");var p=new s.Vector3(d.position[l],d.position[c],d.position[u]);o.issues.update({data:{objects:[{physicalId:a,reportedAgainst:[d]}]},onComplete:function(e){i.set("position",t.position),i.set("original",p),n&&"function"==typeof n.onComplete&&n.onComplete(e.results),r.end(i.name+" save")},onFailure:function(e){n&&"function"==typeof n.onFailure&&n.onFailure(e),r.end(i.name+" save")}})},destroy:function(){this._logger.debug("Destroying marker %s from issue %s (%s)",this.get("id"),this.get("title"),this.get("name")),this.clear({silent:!0}).set(this.defaults)},utils:{isValidPosition:function(e){return e&&e.hasOwnProperty(l)&&e.hasOwnProperty(c)&&e.hasOwnProperty(u)},getPosition:function(e,t){var n=i.get("component").get3DContext().controller,o=new s.Matrix4;o.extractRotation(n.buildPathFromArray(e.get("path")).getWorldMatrix());var r=t;return r.applyMatrix4(o),this.getRelativePosition(e.get("axis"),r)},getCenterBoundingSphere:function(e,t){var n=i.get("component").get3DContext(),o=(n=i.get("component").get3DContext()).controller.getReferenceBoundingBox(t),r=new s.Vector3((o.min.x+o.max.x)/2,(o.min.y+o.max.y)/2,(o.min.z+o.max.z)/2),a=n.controller._model.getWorldMatrix(e),l=r.clone();return l.applyProjection(a),l},getAxisSystem:function(e,t){return i.get("component").get3DContext().controller._model.getWorldMatrix(e).decompose()[d]},getRelativePosition:function(e,t){var n=e.x,i=e.y,o=e.z,r=parseFloat(t.x),a=parseFloat(t.y),l=parseFloat(t.z);return new s.Vector3(n+r,i+a,o+l)},convert:function(e,t){var n={};if("position"in t){var i=new s.Vector3;i.subVectors(t.position,e.get("axis")),i.applyMatrix4(e.get("inverse")),n.position={x:i.x,y:i.y,z:i.z}}return n}}})}),define("DS/Issue3DReview/Issue3DReviewAppInit",["DS/WAfrContainer/App","UWA/Class/Promise","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(e,t,n){"use strict";var s=null;return e.extend({issues:null,getBrand:function(){return"ENOVIA"},setUp:function(e){var n=this;if(e.sourceApp){if(!e.sourceApp.pad3DViewer)return window.console.error("pad3DViewer property must be valuated"),void(e.failure&&e.failure());if(n.pad3DViewer=e.sourceApp.pad3DViewer,e.sourceApp&&!e.sourceApp.isDisposeCalled())try{e.sourceApp.dispose(e)}catch(e){console.log(e)}new t(function(t,n){require(["DS/Issue3DReview/Issue3DReview"],function(i){(s=new i({pad3DViewer:e.sourceApp.pad3DViewer})).isLoaded.then(t).catch(n)})}).then(function(){s.setUp(e)}).catch(function(){window.console.error("error when instantiating application"),e.failure()})}else require(["DS/Issue3DReview/Issue3DReview"],function(t){(s=new t).isLoaded.then(function(){n.pad3DViewer=s.pad3DViewer,e.done&&e.done()})})},onWillEnter:function(e){var n=this;return s?new t(function(t,i){s.onWillEnter(e).then(function(){n.issues={},t()}).catch(i)}):this._parent(e)},onWillLeave:function(e){var n=this;return s?new t(function(t,i){s.onWillLeave(e).then(function(e){n.issues=e.issues&&e.issues.map?Object.values(e.issues.map):[],n.issues.forEach(function(e){e.physicalid=e.physicalId}),t()}).catch(i)}):this._parent(e)},dispose:function(e){s&&(s.dispose(e),s=null),this._parent(e)}})}),define("DS/Issue3DReview/commands/Release",["UWA/Class","DS/ApplicationFrame/Command"],function(e,t){"use strict";return e.extend(t,{execute:function(){require(["DS/IssueServices/Contexts"],function(e){e.get("component").release()})}})}),define("DS/Issue3DReview/commands/Refresh",["UWA/Class","DS/ApplicationFrame/Command"],function(e,t){"use strict";return e.extend(t,{execute:function(){require(["DS/PADUtils/views/PADAlert","DS/IssueServices/Contexts","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(e,t,n){t.get("component").isProcessing()?e.displayNotification({msg:n.notifications.commandAlreadyProcessing,eventID:"info"}):t.get("application").refresh()})}})}),define("DS/Issue3DReview/commands/Create",["UWA/Class","UWA/Class/Listener","DS/ApplicationFrame/Command","DS/IssueCommon/utils/Utils","DS/IssueCommon/commands/CommandsManager","DS/IssueServices/Contexts","DS/IssueServices/utils/Parser"],function(e,t,n,s,i,o,r){"use strict";var a="ENX3DIR_AP";return e.extend(n,t,{component:null,init:function(e){this._parent(e,{isAsynchronous:!0})},execute:function(){var e=this;if(!0!==e.utils.isAlreadyRunning()){var t=o.get("widget"),n=o.get("component");new Promise(function(s){t.name===a&&!0!==n.isDisplayed()?require(["DS/UIKIT/Mask"],function(o){o.mask(t.body),e.listenTo(n,"onDisplay",function(){e.stopListening(n,"onDisplay"),o.unmask(t.body),s()}),i.getCommandCheckHeader("Display").toggleState()}):s()}).then(function(){e.IF3D()})}},beginExecute:function(){if(!0!==this.utils.isAlreadyRunning()){var e=o.get("widget")||window.widget;s.Mask.mask(e.body)}},endExecute:function(){var e=o.get("widget")||window.widget;s.Mask.unmask(e.body)},IF3D:function(){var e=this;require(["UWA/Class/Promise","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Selection/CSOManager","DS/IssueComponents/create/Create","DS/IssueServices/services/IssueServices"],function(t,n,s,i,a){for(var l=o.get("widget")||window.widget,c=s.get(),u=[],d=[],h=0;h<c.length;h++)u.push(c[h].pathElement);u.forEach(function(e){for(;!n.isReference(e.getLastElement());)e=e.getParentPath();var t=e.getLastElement();d.push(n.getNodeID(t))}),new t(function(e){var t=[];a.fetch({data:{objects:d.map(function(e){return{physicalId:e}})},onComplete:function(n){var s=n.body;"results"in s&&s.results.forEach(function(e){var n={},s=r.parseFetchResponse(e);n.fullName=s.display.responsible,n.user=s.display.owner,n.organization=s.display.organization,t.push(n)}),e(t)},onFailure:function(){e(t)}})}).then(function(t){var n=new i(l.body,{issueCreationType:e.options.ID});n.render();var s=t.map(function(e){return{user:e.user}}),o={};"true"===localStorage.getItem("assignPreferenceTemplate")&&(o=t.reduce(function(e,t){return e[t.user]={user:t.user,fullName:t.fullName,organization:t.organization},e},{})),n.isLoaded.then(function(){var e="";for(var t in o)o.hasOwnProperty(t)&&(e=o[t].organization);var i=new Date,r=n.finalize.getTasks(),a={id:"template-"+Date.now(),info:{name:"",description:"",lastUsed:null},data:{title:"",description:"",resolutionRecommendation:"",priority:"Low",resolutionDate:i.getMonth()+1+"/"+i.getDate()+"/"+i.getFullYear(),estimatedStartDate:i.getMonth()+1+"/"+i.getDate()+"/"+i.getFullYear(),estimatedEndDate:i.getMonth()+1+"/"+i.getDate()+"/"+i.getFullYear(),reportedAgainst:d.map(function(e){return{physicalId:e}}),positions:[],contexts:[],assignees:s,reportingOrganization:e,attachments:[],primaryAttachment:null,automationTasks:r,attributes:{}},ui:{assignees:o}};return n.applyTemplate(a)}).catch(function(e){n._logger.error(e)}).finally(function(){e.end()})})})},utils:{isAlreadyRunning:function(){var e=o.get("widget")||window.widget;return null!==e.body.getElement(".create-template-chooser-dialog")||null!==e.body.getElement(".create-view-dialog")}}})}),define("DS/Issue3DReview/utils/ModelParser",["UWA/Core","DS/Logger/Logger","DS/IssueCommon/utils/Utils","DS/IssueServices/utils/Performance"],function(e,t,n,s){"use strict";var i={NODE:{id:"",type:"",name:"",title:"",baseType:"",actionTaken:"",actualEndDate:"",actualStartDate:"",assignees:[],contexts:[],created:"",description:"",estimatedEndDate:"",estimatedStartDate:"",modified:"",owner:{},priority:"",reportedAgainst:[],reportingOrganization:"",resolutionDate:"",resolutionRecommendation:"",resolutionStatement:"",resolvedBy:[],resolvedItems:[],responsibleOrganization:"",revision:"",state:"",iconurl:"",custom:{}}},o=function(t){var s=e.clone(i.NODE);for(var o in s.icons=[],i.NODE)i.NODE.hasOwnProperty(o)&&(s[o]=t[o]?t[o]:i.NODE[o]);s.id=t.physicalId?t.physicalId:s.id,s.physicalId=s.id,s.resourceid=s.id;var r=n.getIconByState(s.state,s.type,s.iconurl);return s.icons.push(r),s},r=function(t){var n=e.clone(i.NODE);n.icons=[];for(var s=t.attributes,o=0;o<s.length;o++){var r=s[o];switch(r.name){case"resourceid":n.id=r.value;break;case"ds6w:identifier":n.name=r.value;break;case"ds6w:label":n.title=r.value;break;case"ds6w:status":n.state=r.value;break;case"ds6w:type":n.type=r.value;break;case"ds6w:responsible":n.owner=r.value;break;case"type_icon_url":n.icons.push(r.value);break;case"ds6w:modified":n.modified=r.value;break;case"ds6w:created":n.created=r.value;break;case"ds6wg:revision":n.revision=r.value}}return n};return{name:"DS/Issue3DReview/utils/ModelParser",parse:function(e,t){var n=[];if(s.start(this.name+" parse"),t=t||{},Array.isArray(e))if(!0===t.useIndex)for(var i=0;i<e.length;i++)n.push(r(e[i]));else for(var a=0;a<e.length;a++)n.push(o(e[a]));else n=!0===t.useIndex?r(e):o(e);return s.end(this.name+" parse"),n}}}),define("DS/Issue3DReview/commands/Mockup",["UWA/Class","DS/ApplicationFrame/Command","DS/IssueCommon/utils/Utils","DS/IssueServices/Contexts","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(e,t,n,s,i){"use strict";var o=50,r=/[/\\?%*:|"<>]/g;return e.extend(t,{_processing:!1,annotation:null,init:function(e){this._parent(e,{isAsynchronous:!0})},execute:function(){var e=this;require(["UWA/Core","DS/Selection/HSOManager","DS/2DAnnotation/2DAnnotation","DS/PADUtils/views/PADAlert","DS/UIKIT/Mask","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/PlatformAPI/PlatformAPI"],function(t,n,s,a,l,c,u,d,h){if(!0!==e._processing){var p=u.get("widget"),g=u.get("component"),m=g.get3DContext().root,f=g.getSelectedIssues();if(1===f.length){e.annotation=null;var v=g.getIssues().map[f[f.length-1].id],w=v.model.get("id");v.utils.unhighlight(v),e._processing=!0,n.empty();var b=function(){v.utils.highlight(v),e._processing=!1,e.annotation=null,this.destroy()};setTimeout(function(){var n=t.Element.getElement.call(m.getFrameWindow().elements.viewerFrame,"canvas");e.annotation=new s({className:"create-attachments-annotation",saveCallback:function(t){l.mask(p.body),l.mask(e.annotation.immersiveFrame.elements.container);var n=(new Date).toLocaleString();n=n.replace(r,"-");var s=i.replace(i.annotate.defaultName,{date:n}),o=new File([t.blob],s,{type:"image/png",lastModified:Date.now()});c.uploadFile(o,w).then(function(t){if(a.displayNotification({msg:i.replace(i.notifications.Annotation.uploadSuccess,{fileName:s}),eventID:"info"}),t&&t.data&&t.data.length>0&&t.data[0].id){var n=t.data[0];return c.setAsPrimary(n.id,w).then(function(e){var t=[[w]],s={};s[w]={id:w};var o=Math.floor(Date.now());h.publish("DS/Object/update",{metadata:{appId:p.id,appName:p.name,timestamp:o,options:{force:!0}},data:{paths:t,attributes:s},version:"1.0"});var r=JSON.parse(e);n.id===r.documentId&&a.displayNotification({msg:i.notifications.SetAsPrimary.success,eventID:"info"})},function(t){a.displayNotification({msg:i.notifications.SetAsPrimary.failure,eventID:"error"}),e.annotation._logger.error(t)})}return Promise.reject(new Error("Unexpected empty response for upload."))},function(t){a.displayNotification({msg:i.notifications.Annotation.uploadFailure,eventID:"error"}),e.annotation._logger.error(t)}).finally(function(){l.unmask(p.body),l.unmask(e.annotation.immersiveFrame.elements.container),b.apply(e.annotation)})},exitCallback:function(){b.apply(e.annotation)},captureTarget:n}),e.annotation.render(),e.annotation.isLoaded.then(function(){e.annotation.container.inject(p.body)}).catch(function(){b.apply(e.annotation)}).finally(function(){e.end()})},o)}}})},beginExecute:function(){var e=s.get("widget")||window.widget;n.Mask.mask(e.body)},endExecute:function(){var e=s.get("widget")||window.widget;n.Mask.unmask(e.body)}})}),define("DS/Issue3DReview/PAD3DViewer",["DS/ENOPAD3DViewer/PAD3DViewer"],function(e){"use strict";return e.extend({})}),define("DS/Issue3DReview/views/Balloon",["UWA/Class","UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Input/Button","DS/UIKIT/Popover","DS/Core/Events","DS/Core/PointerEvents","DS/ENO6WPlugins/jQuery","DS/ExternalComponents/jQueryUI","DS/IssueServices/utils/Performance","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/SceneGraphNodes/CSS2DNode","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/VisuEvents/EventsManager","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","css!DS/Issue3DReview/Issue3DReview.css"],function(e,t,n,s,i,o,r,a,l,c,u,d,h,p,g,m,f,v){"use strict";var w=200,b=100,D={height:45,width:25},S="1",I="#3D3D3D",y="#3D3D3D",_=0,C=0,E=function(e,t,n,s){return'<svg class="balloon-svg" width="25" height="45" viewBox="0 0 25 45" preserveAspectRatio="xMaxYMax" xmlns="http://www.w3.org/2000/svg"><g><g class="balloon-container" opacity="'+t+'"><path class="balloon-path" stroke-width="1" stroke="'+n+'" fill="'+e+'" d="m12.50023,0.61752c-6.51488,0 -11.79788,5.59224 -11.79788,12.48846c0,2.80815 0.87686,5.40025 2.35194,7.48519c0.005,0.00289 0.00727,0.00818 0.00727,0.01059c0.28047,0.43643 9.31685,14.46321 9.43822,23.78072c0.12182,-9.31751 9.15775,-23.34429 9.43867,-23.78072c0.005,-0.0077 0.00727,-0.01059 0.00727,-0.01059c1.47599,-2.08494 2.35194,-4.67704 2.35194,-7.48519c0,-6.89575 -5.28209,-12.48846 -11.79743,-12.48846zm0,6.57288c2.94833,0 5.34028,2.53195 5.34028,5.65287c0,3.12091 -2.39194,5.65287 -5.34028,5.65287s-5.33982,-2.53195 -5.33982,-5.65287c0,-3.12091 2.39149,-5.65287 5.33982,-5.65287z" /></g><ellipse class="balloon-inner" opacity="'+t+'" stroke="'+s+'" ry="4.16736" rx="3.95816" id="svg_6" cy="12.83264" cx="12.5" stroke-width="2" fill="'+s+'" /></g></svg><div class="pulse"></div>'},R=function(){return s.createElement("div",{class:"issue-reposition-confirmation",html:'<div class="issue-reposition-confirmation-label">'+v.inspect.relocate+"</div>"})},x=function(){return'<span class="dnd-status dnd-status-ok"><span class="fonticon fonticon-check"></span></span>'},A=function(){return'<span class="dnd-status dnd-status-ko"><span class="fonticon fonticon-cancel"></span></span>'};return n.extend({name:"DS/Issue3DReview/views/Balloon",tagName:"div",className:"issue-balloon",_logger:null,defaultOptions:{parent:null,viewer:null,window:null,controller:null},isSelected:!1,isVisible:!1,isEnabled:!0,node:null,balloon:null,_visualizationEvents:[],_preventEvents:!1,setup:function(e){this._logger=d.getLogger("DS/Issue3DReview/View"),this._logger.debug("Setup for balloon %s %s %s for issue %s (%s)",this.model.get("type"),this.model.get("name"),this.model.get("revision"),this.model.get("issue").get("title"),this.model.get("issue").get("name")),u.start(this.name+" setup"),this.options=s.merge(e||{},this.defaultOptions);var t=new g;t.name="issue-balloon-3D",t.setVisibilityInTree(!1),t.exludeFromBounding(!0),t._excludeFromCSO=!0,this.options.viewer.addNode(t,!1),this.isSelected=!1,this.isVisible=!1,this.node=t,this.balloon=null,this._visualizationEvents=[],this._preventEvents=!1,u.end(this.name+" setup")},destroy:function(){this.stopListening(this.model,"onChange"),this._visualizationEvents.forEach(function(e){f.removeEvent(e.container,e.event,e.cb)}),this.enable(!0),null!==this.balloon&&(this.balloon.html.destroy(),this.balloon.node.remove()),null!==this.node&&this.node.remove(),this.isSelected=!1,this.isVisible=!1,this.node=null,this.balloon=null,this._preventEvents=!1,this.options={},this.container.empty(),this.container.destroy(),this.dispatchEvent("onDestroy")},render:function(e){this._logger.debug("Rendering balloon %s %s %s for issue %s (%s)",this.model.get("type"),this.model.get("name"),this.model.get("revision"),this.model.get("issue").get("title"),this.model.get("issue").get("name")),u.start(this.name+" render");var t=this.model.get("color"),n=this.model.get("default");return null!==this.model.get("position")&&(n=this.model.get("position")),this.balloon=this.create(this.node,t,n),this.model.get("temporary")?this.container.addClassName("issue-balloon-temporary"):(this.container.setData("markerId",this.model.get("id")),this.draggable()),this.promiseWhileRendering=this.show().then(function(){e&&"function"==typeof e.callback&&e.callback()}),this._subscribers(),u.end(this.name+" render"),this},create:function(e,t,n){u.start(this.name+" create");var s=E(t,S,I,y);this.container.setContent(s+'<div class="issue-balloon-information"></div>'),this.container.setAttribute("data-name",this.model.get("issue").get("name"));var i=new p({html:this.container,name:"issue-balloon-2D"});i.setVisibilityInTree(!1),i.exludeFromBounding(!0),i.setOffset(new m.Vector2(-D.width/2,-D.height)),i._excludeFromCSO=!0,this.container.setOpacity(1);var o=this.container.getElement(".issue-balloon-information");return e.setMatrix((new m.Matrix4).setPosition(n)),i.setNoZ(!0),e.addChild(i),u.end(this.name+" create"),{node:i,html:this.container,information:o}},show:function(){var e=this;return!0===e.isVisible?t.resolve():new t(function(t){var n=function(){e.isVisible=!0,null!==e.balloon?(e.balloon.html.removeEventListener("animationend",n),t()):t()};e.balloon.html.addEventListener("animationend",n),e.balloon.html.removeClassName("issue-balloon-animation-hide").addClassName("issue-balloon-animation-show"),e.balloon.node.setVisibility(!0),e.balloon.html.hidden=!1,e.enable(),e.options.viewer.render()})},hide:function(){var e=this;return!1===e.isVisible?t.resolve():new t(function(t){var n=function(){e.isVisible=!1,null!==e.balloon?(e.balloon.html.removeEventListener("animationend",n),e.balloon.node.setVisibility(!1),e.balloon.html.hidden=!0,e.disable(),e.options.viewer.render(),t()):t()};!0===e.isBalloonInViewport()?e.balloon.html.addEventListener("animationend",n):setTimeout(function(){n()},0),e.balloon.html.removeClassName("issue-balloon-animation-show").addClassName("issue-balloon-animation-hide")})},enable:function(e){this.isEnabled=!0,e||this.container.getParent().removeClassName("issue-balloon-fade-out-element").addClassName("fade-in-element"),this.container.getParent().setStyle("opacity",1),this.container.getParent().setStyle("pointer-events","auto")},disable:function(e){this.isEnabled=!1,e||this.container.getParent().removeClassName("issue-balloon-fade-in-element").addClassName("fade-out-element"),this.container.getParent().setStyle("opacity",0),this.container.getParent().setStyle("pointer-events","none")},over:function(){!0===this.isEnabled&&!0!==this.isSelected&&this.balloon.node.getElement().addClassName("hover")},out:function(){!0!==this.isSelected&&this.balloon.node.getElement().removeClassName("hover")},select:function(){this.isSelected=!0,this.balloon.node.getElement().addClassName("selection"),this.dispatchEvent("onSelect")},unselect:function(){this.isSelected=!1,this.balloon.node.getElement().removeClassName("selection").removeClassName("hover"),this.dispatchEvent("onUnselect")},draggable:function(){var e=this;u.start(e.name+" draggable"),e.balloon.node.css2DNode.element.ondragstart=null;var t=null,n=x(),s=A(),a=function(t){var n=e.options.viewer.getMousePosition(new m.Vector2(t.clientX,t.clientY)),s=e.options.viewer.pick(n,"primHybrid",!0);if(s.position&&s.path.length){var i=e.options.controller.buildArrayFromPath(s.path[_]).join(","),o=e.model.get("path").join(",");return-1!==i.indexOf(o)?s:null}return null},c=null;l(e.balloon.html).draggable({delay:b,revert:function(){return null===a({clientX:c.clientX,clientY:c.clientY})},revertDuration:2*b,cursorAt:{left:D.width/2,top:D.height},opacity:.6,drag:function(t){if(c=t,!(null==e.balloon.html.getParent(".triptych-container")&&""==e.balloon.html.getParent(".triptych-container")||null==e.balloon.html.getParent(".triptych-container").getChildren(".triptych-left withtransition")&&""==e.balloon.html.getParent(".triptych-container").getChildren(".triptych-left withtransition"))){var i=e.balloon.html.getParent(".triptych-container").getChildren(".triptych-left withtransition")[0];if(i.className.includes("open")){let e=i.getBoundingClientRect();t.clientX=t.clientX-e.width}}null!==a({clientX:t.clientX,clientY:t.clientY})?e.balloon.information.setContent(n):e.balloon.information.setContent(s)},start:function(s,i){t=i.helper.position(),e.options.parent.dispatchEvent("onMouseLeave",{id:e.model.get("physicalId"),object:e,balloon:e.balloon.html,event:s}),e._preventEvents=!0,e.balloon.information.setContent(n)},stop:function(n){if(c=n,!(null==e.balloon.html.getParent(".triptych-container")&&""==e.balloon.html.getParent(".triptych-container")||null==e.balloon.html.getParent(".triptych-container").getChildren(".triptych-left withtransition")&&""==e.balloon.html.getParent(".triptych-container").getChildren(".triptych-left withtransition"))){var s=e.balloon.html.getParent(".triptych-container").getChildren(".triptych-left withtransition")[0];if(s.className.includes("open")){let e=s.getBoundingClientRect();n.clientX=n.clientX-e.width}}var u=a({clientX:n.clientX,clientY:n.clientY});if(null===u)return e.balloon.information.setContent(""),void(e._preventEvents=!1);l(e.balloon.html).draggable("disable"),e.balloon.node.getElement().addClassName("waiting");var d=R(),p=new o({target:e.container,trigger:"manual",position:"right",autoHideOnClickOutside:!1,autoHide:!1,delay:{show:b,hide:b},body:d});p.shouldListenForScroll=!1;var g=r.subscribe({event:"/VISU/"},function(e){"@onViewpointChange"===e.eventType&&p.updatePosition()});new i({value:v.inspect.yes,className:"primary",events:{onClick:function(){e.balloon.node.getElement().removeClassName("waiting"),p.destroy(),r.unsubscribe(g),e.balloon.information.setContent(""),l(e.balloon.html).draggable("enable"),e.model.save({position:u.position},{onComplete:function(){e.options.parent.dispatchEvent("onChange:position",{id:e.model.get("id"),physicalId:e.model.get("physicalId"),model:e.model})},onFailure:function(){h.displayNotification({msg:v.notifications.cannotRelocateBalloon,eventID:"error"}),l(e.balloon.html).animate({top:t.top,left:t.left},w)}}),e._preventEvents=!1}}}).inject(d),new i({value:v.inspect.no,className:"default",events:{onClick:function(){e.balloon.node.getElement().removeClassName("waiting"),p.destroy(),r.unsubscribe(g),l(e.balloon.html).animate({top:t.top,left:t.left},w),e.balloon.information.setContent(""),l(e.balloon.html).draggable("enable"),e._preventEvents=!1}}}).inject(d),p.show(),p.updatePosition()}}),u.end(e.name+" draggable")},isBalloonInViewport:function(){if(!this.balloon||!this.balloon.html)return!1;var e=this.balloon.html.getBoundingClientRect();return(0!==e.top||0!==e.left||0!==e.bottom||0!==e.right)&&(e.top>=0&&e.left>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&e.right<=(window.innerWidth||document.documentElement.clientWidth))},_onChangePosition:function(){var e=this;e._logger.debug("Changing the position for balloon %s %s %s for issue %s (%s)",e.model.get("type"),e.model.get("name"),e.model.get("revision"),e.model.get("issue").get("title"),e.model.get("issue").get("name")),u.start(e.name+" _onChangePosition");var n=e.isVisible;e.hide().then(function(){var s=null!==e.model.get("position")?e.model.get("position"):e.model.get("default");return e.node.setMatrix((new m.Matrix4).setPosition(s)),e.balloon.html.setStyle("left","initial"),e.balloon.html.setStyle("top","initial"),e.options.viewer.render(),u.end(e.name+" _onChangePosition"),!0===n?e.show():t.resolve()})},_onChangeColor:function(){var e=this;e._logger.debug("Changing the color for balloon %s %s %s for issue %s (%s)",e.model.get("type"),e.model.get("name"),e.model.get("revision"),e.model.get("issue").get("title"),e.model.get("issue").get("name")),u.start(e.name+" _onChangeColor");var n=e.isVisible;e.hide().then(function(){var s=e.balloon.html,i=e.model.get("color");return s.getElement(".balloon-path").setAttribute("fill",i),u.end(e.name+" _onChangeColor"),!0===n?e.show():t.resolve()})},_subscribers:function(){var e=this;e.listenTo(e.model,"onChange:position",e._onChangePosition),e.listenTo(e.model,"onChange:color",e._onChangeColor),e._visualizationEvents=[{container:e.balloon.html.getParent(),event:"onPrimaryPointerClick",cb:function(t){!0!==e._preventEvents&&e.options.parent.dispatchEvent("onClick",{id:e.model.get("physicalId"),object:e,balloon:e.balloon.html,isMultipleSelection:e.utils.isMultipleSelection(t),event:t})}},{container:e.balloon.html,event:"onPrimaryPointerDoubleClick",cb:function(t){!0!==e._preventEvents&&e.options.parent.dispatchEvent("onDoubleClick",{id:e.model.get("physicalId"),object:e,balloon:e.balloon.html,isMultipleSelection:e.utils.isMultipleSelection(t),event:t})}}],e._visualizationEvents.forEach(function(e){f.addEvent(e.container,e.event,e.cb)}),e.balloon.html.getParent().addEventListener("mouseover",function(t){!0!==e._preventEvents&&e.options.parent.dispatchEvent("onMouseOver",{id:e.model.get("physicalId"),object:e,balloon:e.balloon.html,event:t})}),e.balloon.html.getParent().addEventListener("mouseleave",function(t){if(!0!==e._preventEvents){for(var n=t.toElement||t.relatedTarget;n&&n.parentNode&&n.parentNode!==window;){if(n.parentNode===this||n===this)return void(n.preventDefault&&n.preventDefault());n=n.parentNode}e.options.parent.dispatchEvent("onMouseLeave",{id:e.model.get("physicalId"),object:e,balloon:e.balloon.html,event:t})}}),e.balloon.html.addEventListener("contextmenu",function(t){return!0!==e._preventEvents&&(t.preventDefault(),t.stopPropagation(),e.options.parent.dispatchEvent("onContextMenu",{id:e.model.get("physicalId"),object:e,balloon:e.balloon.html,isMultipleSelection:e.utils.isMultipleSelection(t),event:t}),!1)}),e.balloon.html.addEventListener(a.LONGHOLD,function(t){return!0!==e._preventEvents&&(a.isTouchEvent(t)&&(t.preventDefault(),t.stopPropagation(),e.options.parent.dispatchEvent("onContextMenu",{id:e.model.get("physicalId"),object:e,balloon:e.balloon.html,isMultipleSelection:e.utils.isMultipleSelection(t),event:t})),!1)});var t=0,n=0,s=0;e.balloon.html.addEventListener("touchstart",function(e){if(e.touches&&1===e.touches.length){var i=(new Date).getTime(),o=i-t,r=Math.abs(n-e.touches[C].clientX),a=Math.abs(s-e.touches[C].clientY);r<10&&a<10&&o<500&&e.preventDefault(),n=e.touches[C].clientX,s=e.touches[C].clientY,t=i}})},utils:{isMultipleSelection:function(e){var t=!1;try{t=e.gesture.events[C].event.ctrlKey}catch(e){}return void 0!==e.ctrlKey&&(t=e.ctrlKey),t}}})}),define("DS/Issue3DReview/commands/Reset",["UWA/Class","DS/ApplicationFrame/Command"],function(e,t){"use strict";return e.extend(t,{execute:function(){require(["DS/PADUtils/views/PADAlert","DS/Issue3DReview/commands/CommandsManager","DS/IssueServices/Contexts","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(e,t,n,s){n.get("component").isProcessing()?e.displayNotification({msg:s.notifications.commandAlreadyProcessing,eventID:"info"}):n.get("application").clear().then(function(){t.getCommand("RemoveAllHdr").begin()})})}})}),define("DS/Issue3DReview/components/header/Filter",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/DropdownMenu","DS/UIKIT/Iconbar","DS/UIKIT/Input/Toggle","DS/PADUtils/views/PADAlert","DS/IssueServices/Contexts","DS/IssueServices/utils/Performance","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(e,t,n,s,i,o,r,a,l,c){"use strict";var u=1e3;return t.extend({name:"DS/Issue3DReview/components/header/Filter",tagName:"div",className:"filter-container",_logger:null,elements:{bar:null,menu:null},filter:{},setup:function(e){l.start(this.name+" setup"),this._parent(e),this.elements={bar:null,menu:null},l.end(this.name+" setup")},render:function(){var t=this;l.start(t.name+" render");var o=a.get("widget")||window.widget;t.elements.bar=new i({renderTo:t.container,items:[{name:"Filter",fonticon:"list-filter",text:c.filter.title,handler:function(){}}]});var d=JSON.parse(o.getValue("filter")),h=[{text:c.filter.synchronize.header,className:"header"},{name:"synchronize",text:c.filter.synchronize.title,selectable:!0,selected:!0===d.synchronize,disabled:!1}];!0!==d.synchronize&&(h=h.concat([{className:"divider"},{name:"owned",text:c.filter.owned,selectable:!0,selected:!0===d.owned,disabled:!0===d.synchronize},{name:"assigned",text:c.filter.assigned,selectable:!0,selected:!0===d.assigned,disabled:!0===d.synchronize},{className:"divider"},{name:"contributed",text:c.filter.others.contributed,selectable:!0,selected:!0===d.contributed,disabled:!0===d.synchronize},{className:"divider"},{name:"closed",text:c.filter.others.closed,selectable:!0,selected:!0===d.closed,disabled:!0===d.synchronize}])),!0!==d.synchronize&&o.getPreference("organizationFilter").value&&h.splice(6,0,{name:"reported",text:c.filter.others.reported,selectable:!0,selected:!0===d.reported,disabled:!0===d.synchronize},{name:"responsible",text:c.filter.others.responsible,selectable:!0,selected:!0===d.responsible}),t.elements.menu=new s({target:t.elements.bar.getItem("Filter").elements.icon,multiSelect:!0,closeOnClick:!1,items:h,events:{onClick:function(s,i){new e(function(e,s){if("synchronize"===i.name){var l=a.get("component");if(!0===i.selected){t.elements.menu.items.forEach(function(e){"synchronize"!==e.name&&"others"!==e.name&&t.elements.menu.disableItem(e.name)});var d=!1;l.taskManager.addGetFilteredIssuesTask(function(t){var s=n.is(t,"object")&&n.is(t.filter,"object")&&Array.isArray(t.filter.issues)?n.clone(t.filter.issues):null;l.setFilteredIssues(s),d=!0;var i=JSON.parse(o.getValue("filter"));i.synchronize=!0,e(JSON.stringify(i))}),setTimeout(function(){!1===d&&(r.displayNotification({msg:c.filter.synchronize.timeout,eventID:"info"}),s(new Error("getFilteredIssuesTask timeout")))},u)}else{t.elements.menu.items.forEach(function(e){"synchronize"!==e.name&&"others"!==e.name&&t.elements.menu.enableItem(e.name)}),l.setFilteredIssues(null);var h=JSON.parse(o.getValue("filter"));h.synchronize=!1,e(JSON.stringify(h))}}else{var p={};t.elements.menu.getSelectedItems().forEach(function(e){p[e.name]=!0}),e(JSON.stringify(p))}}).then(function(e){n.is(e,"string")&&""!==e&&o.setValue("filter",e),setTimeout(function(){a.get("application").refresh()},0)}).finally(function(){t.refresh()})}}});var p=o.getValue("roots");return Array.isArray(p)&&p.length>0&&(t.elements.menu.addItem({className:"divider"}),t.elements.menu.addItem({name:"session",text:c.replace(c.filter.session,{number:p.length}),selectable:!0,selected:!0===d.session})),l.end(t.name+" render"),t},refresh:function(){this.destroy(),this.render()},destroy:function(){this.elements.menu.hide(),this.elements={bar:null,menu:null},this.container.empty()}})}),define("DS/Issue3DReview/commands/Clear",["UWA/Class","DS/ApplicationFrame/Command"],function(e,t){"use strict";return e.extend(t,{execute:function(){require(["DS/IssueServices/Contexts"],function(e){e.get("application").clear()})}})}),define("DS/Issue3DReview/commands/3DMarkup",["DS/ApplicationFrame/Command"],function(e){"use strict";return e.extend({execute:function(){require(["DS/i3DXCompassServices/i3DXCompassPubSub"],function(e){var t={appId:"ENOR3D_AP",widgetId:widget.id,fileName:"-file",fileContent:""};e.publish("launchApp",t)})}})}),define("DS/Issue3DReview/commands/Display",["UWA/Class","DS/ApplicationFrame/CommandCheckHeader"],function(e,t){"use strict";return e.extend(t,{init:function(e){var t=this;t._parent(e,{}),require(["UWA/Core","DS/Controls/Loader","DS/PADUtils/views/PADAlert","DS/IssueServices/Contexts","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(e,n,s,i,o){var r=!1,a=t.onStateChange(function(){if(!0!==r){var e=!1;if(i.get("component").isProcessing())return s.displayNotification({msg:o.notifications.commandAlreadyProcessing,eventID:"info"}),r=!0,e="true"===localStorage.getItem("Issue3DReviewDisplay"),void t.setState(e,!0);(e="true"===localStorage.getItem("Issue3DReviewDisplay"))!==t.getState()&&(localStorage.setItem("Issue3DReviewDisplay",t.getState()?"true":"false"),function(e){var t=i.get("application");!0===e?t.display():t.clear()}(e="true"===localStorage.getItem("Issue3DReviewDisplay")))}else r=!1});t._destroy=function(){t._modelEvents.unsubscribe(a)};var l="true"===localStorage.getItem("Issue3DReviewDisplay");r=!0,t.setState(l,!0)})}})}),define("DS/Issue3DReview/commands/Inspect",["UWA/Class","DS/ApplicationFrame/Command"],function(e,t){"use strict";return e.extend(t,{execute:function(){require(["DS/IssueServices/Contexts"],function(e){for(var t=e.get("component"),n=t.getSelectedIssues(),s=[],i=0;i<n.length;i++)s.push(n[i].id);t.inspect(s)})}})}),define("DS/Issue3DReview/Issue3DReview",["UWA/Class","UWA/Class/Promise","UWA/Core","DS/UIKIT/Tooltip","DS/IssueCommon/utils/Selector","DS/IssueComponents/helper/Helper","DS/IssueComponents/utils/Utils","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Migration","DS/IssueServices/utils/Performance","DS/IssueServices/utils/Support","DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","text!DS/Issue3DReview/assets/Issue3DReview.PADSettings.json","css!DS/Issue3DReview/Issue3DReview.css"],function(e,t,n,s,i,o,r,a,l,c,u,d,h,p,g,m,f){"use strict";var v="Issue",w=1e3,b=1e3,D="X3DContentId",S=function(){return n.createElement("div",{class:"issue-3d-placeholder fade-in-element",html:['<div class="pin"><span class="fonticon fonticon-5x fonticon-location"></span></div>','<div class="pulse"></div>']})},I=function(e){return n.createElement("div",{class:"loading-error-container",html:n.createElement("div",{class:"loading-error",html:[n.createElement("div",{class:"loading-error-label",html:e.label}),n.createElement("div",{class:"loading-error-sub-label",html:e.sub})]})})};return e.extend({name:"DS/Issue3DReview/Issue3DReview",pad3DViewer:null,component:null,filter:null,statusHelper:null,elements:{header:null},isLoaded:null,_deferred:{resolve:null,reject:null},_pad3DViewerTokens:[],_widgetEventTokens:[],_placeholder:null,displayLevelSelector:!0,init:function(e){var s=this;a.add("widget",window.widget),a.get("widget").name="ENX3DIR_AP",a.add("application",s),e&&n.is(e.pad3DViewer,"object")&&(s.pad3DViewer=e.pad3DViewer),s.component=null,s.filter=null,s.isLoaded=new t(function(e,t){s._deferred.resolve=e,s._deferred.reject=t}),s._placeholder=S(),s._subscribers(),s.settings=JSON.parse(f),s.displayLevelSelector=!0},onLoad:function(){var e=this;d.start(e.name+" onLoad"),a.get("widget").setMetas({helpPath:"Issue3DReview/assets/help"}),e._placeholder.inject(a.get("widget").body);try{h.checkBrowserSupport()}catch(e){}u.isUpToDate()?(a.get("widget").body.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation()}),c.initPlatformServices().then(function(){try{h.checkSwymSupport()}catch(e){}var t=c.getSecurityContexts(),n=c.getTenants();return e._setPreferences({securityContexts:t,tenants:n})}).then(function(){var t=c.getCurrentCredentials();return a.get("widget").setValue("xPref_CREDENTIAL",t.role+"."+t.organization+"."+t.collaborativeSpace),n.is(e.pad3DViewer,"object")?e._reusePAD3DViewer(e.pad3DViewer):e._initializePAD3DViewer()}).then(function(){return new t(function(e){var t=[v];l.type.getSubType().then(n=>{e(null!=n?Object.keys(n):t)}).catch(()=>{e(t)})})}).then(function(t){e._setLoadingDelegations(t)}).then(function(){e._computeFilter()}).then(function(){return e._initializeComponent({})}).then(function(){d.end(e.name+" onLoad"),e._deferred.resolve()},function(t){d.end(e.name+" onLoad"),e._deferred.reject(t);var n=e.utils.getNLSMsg(t);a.get("widget").body.appendChild(I(n)),"Oops! Something went wrong."===n.label&&e.utils.error(t)})):u.upgrade()},onRefresh:function(){var e=this;if(void 0!==widget.getValue("xPref_CREDENTIAL")){var t=c.getCurrentCredentials();widget.setValue("xPref_CREDENTIAL",t.role+"."+t.organization+"."+t.collaborativeSpace)}e.component.clear().then(function(){var t=a.get("widget").getValue("enopad3dviewer_CGRorTHB"),s=n.is(t,"boolean")?t:"true"===t;e.pad3DViewer.setDefaultStreamToLoad(s),e.pad3DViewer.refresh(),e.filter.refresh()})},onResize:function(){this.resize()},onDestroy:function(){this.destroy()},destroy:function(e){var t=this;null!==t.filter&&t.filter.destroy(),t.filter=null,a.remove("filter"),t.helper.destroy(),null!==t.statusHelper&&t.statusHelper.destroy(),t.statusHelper=null,t.hud.destroy(),null!==t.elements.header&&t.elements.header.destroy(),t.elements.header=null,null!==t.component&&t.component.destroy(),t.component=null,a.remove("component"),n.is(e,"object")&&!0===e.keepPAD3DViewer?(t._pad3DViewerTokens.forEach(function(e){t.pad3DViewer.unsubscribe(e)}),t.pad3DViewer.addRootNodesFromContent=t.defaultAddRootNodesFromContent):(null!==t.pad3DViewer&&t.pad3DViewer.destroy(),t.pad3DViewer=null),a.remove("pad3DViewer"),a.remove("application"),a.remove("widget")},setUp:function(e){e&&e.done&&e.done()},onWillEnter:function(e){return t.resolve()},onWillLeave:function(e){var n=this;return new t(function(e,t){var s={issues:i.getSelection({type:"issue"})};n.component.clear().then(function(){e(s)}).catch(t)})},dispose:function(e){var t=a.get("widget")||window.widget;t.setTitle(""),this._widgetEventTokens.forEach(function(e){t.removeEvent(e.eventName,e.listener)}),this._widgetEventTokens=[],this.destroy({keepPAD3DViewer:!0})},onTitleChange:function(){var e=a.get("widget"),t=this.getTitle();if(!1===this.component.isDisplayed())t+=" - "+m.titles.issuesNotDisplayed;else{var n=Object.keys(this.component.getIssues().map);0===n.length?t+=" - "+m.titles.noIssuesToShow:t+=" ("+n.length+")"}e.getTitle()!==t&&e.setTitle(t)},display:function(){var e=this;return e.component.isDisplayed()?(e.hud.on(m.notifications.lookingIssues),e.component.clear().then(function(){return e.hud.update(m.notifications.lookingIssues,"50"),e.component.display(e.pad3DViewer.getController().getRoots())}).then(function(){e.hud.update(e.hud.getHUDLabel(),"100"),e.onTitleChange(),e.component.isFocused()&&e.component.focus(),e.hud.off()}).catch(function(e){})):(e.hud.on(e.hud.getHUDLabel(),"100"),e.onTitleChange(),e.hud.off(),t.resolve())},resize:function(){null!==this.component&&this.component.resize()},clear:function(){var e=this;return(a.get("widget")||window.widget).setTitle(e.getTitle()+" - "+m.notifications.clearIssues),e.hud.on(m.notifications.clearIssues,"50"),e.component.clear().then(function(){e.hud.update(m.notifications.clearIssues,"100"),e.onTitleChange(),e.hud.off()}).catch(function(e){})},refresh:function(e){var t=this;(a.get("widget")||window.widget).setTitle(t.getTitle()+" - "+m.notifications.refreshIssues),t.hud.on(m.notifications.refreshIssues,"50");var n=t.pad3DViewer.getController().getRoots();return t.component.refresh(n,e).then(function(){t.hud.update(t.hud.getHUDLabel(),"100"),t.onTitleChange(),t.hud.off()})},setFilteredIssues:function(e){this.component.setFilteredIssues(e)},getTitle:function(){var e=a.get("widget")||window.widget,t=e.getValue("myTitle"),n=e.getPreference("myTitle");return e&&n?t=(t=t&&t.trim())||n.defaultValue:m.preferences.name.default},_initializePAD3DViewer:function(){var e=this,s=a.get("widget")||window.widget,i=null,o=null,r=null,l=null,c=null,u=null,d=null;return new t(function(e){require(["DS/Issue3DReview/PAD3DViewer","DS/PADServices/utils/PlatformURL","DS/PADUtils/PADSettingsMgt","DS/Issue3DReview/commands/CommandsManager","DS/IssueCommon/commands/CommandsManager","text!DS/Issue3DReview/assets/Issue3DReview.3D.json","text!DS/Issue3DReview/assets/Issue3DReview.PADSettings.json"],function(t,n,s,a,h,p,g){i=t,d=n,o=p,r=a,l=h,c=s,u=g,e()})}).then(function(){return new t(function(t){var h=s.getValue("enopad3dviewer_CGRorTHB"),p=n.is(h,"boolean")?h:"true"===h,g=JSON.parse(o);g.context="Default";var m={widget:s,windowOptions:g,actionbar_corrected:!0,interwidgetComAvailability:!0,enableFiltering:!0,allowAuthoring:!1,loadCGRAsDefaultStream:p,visuProgressiveTileModel:!0,enableSidePanel:!0};d.retrievePlatformUrl({addDefaults:!0,initWSAcess:!0}).then(function(){e.pad3DViewer=new i(m),g.mouseProfile=require("DS/PADUtils/PADUtilsServices").isCloud()?window.__mouseProfile:"CATIA",g.mouseProfile&&e.pad3DViewer.getViewpoint().setDefaultController(!0,g.mouseProfile);var n=JSON.parse(u);Object.keys(n).forEach(function(e){c.setSetting(e,n[e].value)});var o=s.getValue("enopad3dviewer_displayCandidateQueue"),d=s.getValue("enopad3dviewer_displayCandidateQueue_color");o&&c.setSetting("enopad3dviewer_displayCandidateQueue",o),d&&c.setSetting("enopad3dviewer_displayCandidateQueue_color",d),a.add("pad3DViewer",e.pad3DViewer);var h=!1;e._pad3DViewerTokens.push(e.pad3DViewer.subscribe({event:"onReady"},function(n){!0!==h&&(h=!0,r.setContext(e.pad3DViewer._context),l.setContext(e.pad3DViewer._context),s.setBody(n.render()),e._placeholder.destroy(),n.getLevelSelectorCommand&&n.getLevelSelectorCommand(function(e){e&&e.displayLabels(!0)}),t(n))}))})})}).then(function(e){var n=s.getValue("Issue3DReviewViewerPathsInSession");n=n?JSON.parse(n):[];var i=s.getValue("Issue3DReviewViewerRootsDetached");i=i?JSON.parse(i):[];var o=[],a=s.getValue("Issue3DReviewViewerFilterPathsInSession");return o.push({objectId:a}),new t(function(t){if(n&&n.length>0){setTimeout(function(){""!=a&&null!=a?e.getController().addFilter(o):e.getController().addRoots({paths:n,pids_hidden:i},!1,!1)},0);var s=e.subscribe({event:"onEndProgressiveLoad"},function(){e.unsubscribe(s),t(e)}),l=[];l.push("Reset"),r._switchCommands(l,!0)}else{t(e);var c=[];c.push("Reset"),r._switchCommands(c,!1)}})}).then(function(t){var n=function(t){s.setValue("Issue3DReviewViewerPathsInSession",JSON.stringify(t.rootLog)),e._updateSharedSettings()},i=function(t){s.setValue("Issue3DReviewViewerFilterPathsInSession",t.filter.objects[0].filterId),e._updateSharedSettings()};e._pad3DViewerTokens.push(t.subscribe({event:"onLoadingComplete"},function(){if(null!==e.component&&e.component.isDisplayed()&&!e.component.isInspected())var n=t.subscribe({event:"onEndProgressiveLoad"},function(){t.unsubscribe(n),e.display()})})),e._pad3DViewerTokens.push(t.subscribe({event:"onRootAdded"},function(t){if(null!==e.component){if(e.component.isInspected()||n(t),e.pad3DViewer.getController().getRoots().length>0){var s=[];s.push("Reset"),r._switchCommands(s,!0)}}else n(t)})),e._pad3DViewerTokens.push(t.subscribe({event:"onFilterApplied"},function(t){if(null!==e.component){if(e.component.isInspected()||i(t),e.pad3DViewer.getController().getRoots().length>0){var n=[];n.push("Reset"),r._switchCommands(n,!0)}}else i(t)})),e._pad3DViewerTokens.push(t.subscribe({event:"onRootRemoved"},function(t){if(null!==e.component){if(!e.component.isInspected())if(n(t),!e.component.isProcessing())0===e.pad3DViewer.getController().getRoots().length?e.clear():e.display();if(s.setValue("Issue3DReviewViewerFilterPathsInSession",""),e._updateSharedSettings(),0==e.pad3DViewer.getController().getRoots().length){var i=[];i.push("Reset"),r._switchCommands(i,!1)}}else n(t)})),e._pad3DViewerTokens.push(t.subscribe({event:"onRootAttached"},function(e){var t=s.getValue("Issue3DReviewViewerRootsDetached");(t=t?JSON.parse(t):[]).some(function(n,i){return n===e.id&&(t.splice(i,1),s.setValue("Issue3DReviewViewerRootsDetached",JSON.stringify(t)),!0)})})),e._pad3DViewerTokens.push(t.subscribe({event:"onRootDetached"},function(e){var t=s.getValue("Issue3DReviewViewerRootsDetached");null===(t=t?JSON.parse(t):null)&&(t=[]),t.some(function(t){return t===e.id})||(t.push(e.id),s.setValue("Issue3DReviewViewerRootsDetached",JSON.stringify(t)))})),e._pad3DViewerTokens.push(t.subscribe({event:"onBIColorize"},function(e){"true"===localStorage.getItem("Issue3DReviewFocus")&&require(["DS/PADUtils/views/PADAlert"],function(e){e.displayNotification({msg:m.notifications.noFocusedViewWhenColorized,eventID:"info"})})})),e._pad3DViewerTokens.push(t.getFrameWindow().getContextualUIManager().registerUnshift({subscriberId:"Issue3DReviewWebAppCtxElements",workbenchName:"Issue3DReview",context:t.getCommandContext(),module:"Issue3DReview",cmdPrefix:"",directory:"assets/afr/",merge:!0,onContextualBarReady:e._onContextualBarReadyCB}))})},_onContextualBarReadyCB:function(e,t){var n=a.get("application");if(n&&null!==n){var s=a.get("application").pad3DViewer.getViewer();if(void 0!==t&&void 0!==t.XmousePositionWithDevPxRatio&&void 0!==t.YmousePositionWithDevPxRatio&&s)if(0===s.pick({xPix:t.XmousePositionWithDevPxRatio,yPix:t.YmousePositionWithDevPxRatio},"mesh",!0).path.length);else if(n.displayLevelSelector){var i=[],o=p.get();return o.length>0&&a.get("application")._areValidPaths(o)&&1===o.length&&(2===o[0].pathElement.externalPath.length?i.push({name:"RemoveRoot",line:1,hdr_list:["RemoveRootHdr"]}):i.push({name:"LevelSelector",line:1,hdr_list:["LevelSelectorHdr"]})),i.length?{cmdList:i}:void 0}}},_areValidPaths:function(e){var t=!0;if(e)for(var n=0;n<e.length;n++)if(!g.isAModelPath(e[n].pathElement)){t=!1;break}return t},_reusePAD3DViewer:function(e){var s=this,i=a.get("widget"),o=e.getRoots(),r=[],l=[];return o&&n.is(o,"array")?require(["DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e){o.forEach(function(t){r.push(e.getNodeID(t))}),r.length>0&&l.push(r),i.setValue("Issue3DReviewViewerPathsInSession",JSON.stringify(l))}):i.setValue("Issue3DReviewViewerPathsInSession",JSON.stringify(l)),new t(function(t){require(["DS/Issue3DReview/commands/CommandsManager","DS/IssueCommon/commands/CommandsManager"],function(n,o){n.clean(s.pad3DViewer._context),n.setContext(s.pad3DViewer._context),o.clean(s.pad3DViewer._context),o.setContext(s.pad3DViewer._context),s.pad3DViewer=e,a.add("pad3DViewer",e);var r=s.pad3DViewer.subscribe({event:"onActionBarReady"},function(){s.pad3DViewer.unsubscribe(r),s._placeholder.destroy();var o=function(e){i.setValue("Issue3DReviewViewerPathsInSession",JSON.stringify(e.rootLog)),s._updateSharedSettings()},a=function(e){i.setValue("Issue3DReviewViewerFilterPathsInSession",JSON.stringify(e.filter.objects[0].path)),s._updateSharedSettings()};s._pad3DViewerTokens.push(e.subscribe({event:"onLoadingComplete"},function(){if(null!==s.component&&s.component.isDisplayed()&&!s.component.isInspected())var t=e.subscribe({event:"onEndProgressiveLoad"},function(){e.unsubscribe(t),s.display()})})),s._pad3DViewerTokens.push(e.subscribe({event:"onRootAdded"},function(e){if(null!==s.component){if(s.component.isInspected()||o(e),s.pad3DViewer.getController().getRoots().length>0){var t=[];t.push("Reset"),n._switchCommands(t,!0)}}else o(e)})),s._pad3DViewerTokens.push(e.subscribe({event:"onFilterApplied"},function(e){if(null!==s.component){if(s.component.isInspected()||a(e),s.pad3DViewer.getController().getRoots().length>0){var t=[];t.push("Reset"),n._switchCommands(t,!0)}}else a(e)})),s._pad3DViewerTokens.push(e.subscribe({event:"onRootRemoved"},function(e){if(null!==s.component){if(!s.component.isInspected())if(o(e),!s.component.isProcessing())0===s.pad3DViewer.getController().getRoots().length?s.clear():s.display();if(i.setValue("Issue3DReviewViewerFilterPathsInSession",""),s._updateSharedSettings(),0==s.pad3DViewer.getController().getRoots().length){var t=[];t.push("Reset"),n._switchCommands(t,!1)}}else o(e)})),s._pad3DViewerTokens.push(e.subscribe({event:"onRootAttached"},function(e){var t=i.getValue("Issue3DReviewViewerRootsDetached");(t=t?JSON.parse(t):[]).some(function(n,s){return n===e.id&&(t.splice(s,1),i.setValue("Issue3DReviewViewerRootsDetached",JSON.stringify(t)),!0)})})),s._pad3DViewerTokens.push(e.subscribe({event:"onRootDetached"},function(e){var t=i.getValue("Issue3DReviewViewerRootsDetached");null===(t=t?JSON.parse(t):null)&&(t=[]),t.some(function(t){return t===e.id})||(t.push(e.id),i.setValue("Issue3DReviewViewerRootsDetached",JSON.stringify(t)))})),t()});s.pad3DViewer.loadActionBar({merge:!1,file:"Issue3DReview.xml",module:"Issue3DReview"})})})},_initializeComponent:function(){var e=this,s=null,i=null,o=null,r=null,l=null;return new t(function(e){require(["DS/PADUtils/views/PADAlert","DS/PADUtils/views/PADStatusInfos","DS/Issue3DReview/commands/CommandsManager","DS/Issue3DReview/Component","DS/Issue3DReview/components/header/Filter","DS/IssueCommon/commands/CommandsManager"],function(t,n,a,c,u,d){s=t,i=n,o=a,d,r=c,l=u,e()})}).then(function(){return e.elements.header=n.createElement("div",{class:"im-3d-header"}),e.elements.header.inject(a.get("pad3DViewer").getContent()),e.filter=(new l).render(),a.add("filter",e.filter),e.hud.init().then(function(t){e.filter.inject(e.elements.header),t.container.inject(e.elements.header)})}).then(function(){if(e.component=new r({events:{onIssuesAdded:function(){e.onTitleChange()},onIssuesRemoved:function(){e.onTitleChange()}}}),a.add("component",e.component),o.select(null),e.pad3DViewer.getController().getRoots().length>0){var l=[];l.push("Reset"),o._switchCommands(l,!0)}e.helper.init(),e.helper.container.inject(e.pad3DViewer.getContent()),e.statusHelper=new i({renderTo:e.pad3DViewer.getContent(),events:{onShow:function(){d.start(e.name+" render status");var t=e.component.getIssues().map,s=e.component.getSelectedIssues(),i=n.createElement("div",{class:"im-status-msg"});n.createElement("div",{class:"im-status-msg-issues",text:m.replace(m.titles.issues,{number:Object.keys(t).length})}).inject(i),n.createElement("div",{class:"im-status-msg-selection",text:m.replace(m.tooltips.selectedIssues,{number:Object.keys(s).length})}).inject(i),e.statusHelper.setStatus(i),d.end(e.name+" render status")}}});let c=a.get("widget").body.getElementsByClassName("pad_status_footer"),u=c.length>0?c[0]:null;if(null!==u){let t=u.getSize().height-2+"px";e.helper.container.setStyle("bottom",t),e.statusHelper.elements.container.setAttribute("style","bottom:"+t+"!important")}else e.helper.container.setStyle("bottom","25px"),e.statusHelper.elements.container.setStyle("bottom","25px");e.defaultAddRootNodesFromContent=e.pad3DViewer.addRootNodesFromContent;var h=function(t){e.component.isInspected()?s.displayNotification({msg:m.notifications.dropPreventedForInspection,eventID:"info"}):(e.pad3DViewer.addRootNodesFromContent=e.defaultAddRootNodesFromContent,e.pad3DViewer.addRootNodesFromContent(t),e.pad3DViewer.addRootNodesFromContent=h)};e.pad3DViewer.addRootNodesFromContent=h;var p=a.get("widget")||window.widget;return new t(function(t){try{var i=JSON.parse(p.getValue("filter"));if(!0===i.synchronize){var o=!1;e.component.taskManager.addGetFilteredIssuesTask(function(s){var i=n.is(s,"object")&&n.is(s.filter,"object")&&Array.isArray(s.filter.issues)?n.clone(s.filter.issues):null;e.component.setFilteredIssues(i),o=!0,t()}),setTimeout(function(){!1===o&&(s.displayNotification({msg:m.filter.synchronize.timeout,eventID:"info"}),i.synchronize=!1,p.setValue("filter",JSON.stringify(i)),e.filter.refresh(),t())},b)}else t()}catch(e){t()}})}).then(function(){e.display()})},_setPreferences:function(e){var t=a.get("widget")||window.widget;if(!0===c.isCloudEnvironment()&&n.is(e.tenants,"object")&&t.addPreference({name:"x3dPlatformId",type:"list",label:m.preferences.tenant,options:e.tenants.platforms,defaultValue:e.tenants.tenant}),n.is(e.securityContexts,"object")){t.addPreference({name:"securityContext",type:"list",label:m.preferences.securityContext,options:e.securityContexts.cspaces});var s=t.getValue("securityContext"),i=e.securityContexts.cspaces.findIndex(e=>e.value==s)>=0?s:"";""!==i?t.setValue("securityContext",i):t.setValue("securityContext",e.securityContexts.securityContext),this._setENOPADSecurityContext()}return t.addPreference({name:"myTitle",type:"text",label:m.preferences.name.title,onchange:"onTitleChange",defaultValue:m.preferences.name.default}),this.settings.hideNoFilterSelectionPreference||t.addPreference({name:"defaultFilterForAll",type:"list",label:m.preferences.defaultFilterForAll.title,options:[{label:m.preferences.defaultFilterForAll.organizationAndProject,value:"organization-project",isDefault:!0},{label:m.preferences.defaultFilterForAll.organization,value:"organization"},{label:m.preferences.defaultFilterForAll.project,value:"project"},{label:m.preferences.defaultFilterForAll.policy,value:"policy"}],defaultValue:"organization-project"}),t.addPreference({name:"organizationFilter",type:"boolean",label:m.preferences.organizationFilter,defaultValue:"false"}),t.addPreference({name:"activateBIFilter",type:"boolean",label:m.preferences.tagger,defaultValue:"true"}),!0!==c.isCloudEnvironment()&&t.addPreference({name:"enopad3dviewer_CGRorTHB",type:"boolean",label:m.preferences.stream,defaultValue:"false"}),t.addPreference({name:"filter",type:"hidden",defaultValue:JSON.stringify({owned:!0,assigned:!0,reported:!1,responsible:!1,contributed:!1,closed:!1,synchronize:!1})}),t.addPreference({name:"Issue3DReviewViewerPathsInSession",type:"hidden"}),t.addPreference({name:"Issue3DReviewViewerRootsDetached",type:"hidden"}),t.addPreference({name:"Issue3DReviewViewerFilterPathsInSession",type:"hidden"}),require(["DS/PADUtils/PADSharedSettings"],function(e){try{e.destroy()}catch(e){}e.addSharedSettings(t,["enopad3dviewer_displayCandidateQueue","enopad3dviewer_displayCandidateQueue_color"])}),t.getPreferences()},_computeFilter:function(){try{var e=a.get("widget")||window.widget,t=e.getValue(D)?JSON.parse(e.getValue(D)):null;e.deleteValue(D),null!==t&&this.pad3DViewer.addRootNodesFromContent({json3DXContent:t,dispatch:!1}),c.getCompassPubSub().publish("resetX3DContent")}catch(e){}},_setLoadingDelegations:function(e){var t=this,s=function(e){require(["DS/PADUtils/views/PADAlert","DS/PADUtils/PADTypesMgt"],function(s,i){function o(o){if(!n.is(o,"array"))return null;var r=[],a={},l=[],c=[],u=o.forEach(function(e){var t,s=n.is(e.objectType)?e.objectType:e.type,i=n.is(e.objectId)?e.objectId:e.physicalId;n.is(e.path)&&(t=n.is(e.path,"string")?e.path.split(","):e.path,Array.isArray(t)&&(i=t));r.includes(s)||(r.push(s),l.push({type:s})),a[s]||(a[s]=[]),a[s].push(i)});if(r.length>0){u=[];i.isTypesAuthorized(l,function(n){if(n.length>0)n.forEach(function(e){a[e]&&a[e].forEach(function(e){Array.isArray(e)?u.push({path:[e[0]]}):u.push({path:[e]})})});else{var i=m.replace(m.notifications.noSupportedReportedAgainstData,{name:e.displayName});s.displayNotification({msg:i,eventID:"warning"})}t.pad3DViewer.addRoots({objects:u}),c.length>0&&t.pad3DViewer.getController().addFilter(c)})}}if(n.is(e.relatedObjects,"object")&&Array.isArray(e.relatedObjects.reportedAgainst)&&e.relatedObjects.reportedAgainst.length>0){var r=e.relatedObjects.reportedAgainst;r[0].hasOwnProperty("objectType")?o(r):t._retrieveAffectedItems(e).then(e=>{o(e)})}else n.is(e.objectId,"string")&&""!==e.objectId?t._retrieveAffectedItems(e).then(e=>{o(e)}):s.displayNotification({msg:m.notifications.serverError,eventID:"error"})})},i={};e.forEach(e=>{i["_"+e]=s}),t.pad3DViewer.setLoadingDelegations(i)},_retrieveAffectedItems:function(e){return new t((t,n)=>{l.issues.retrieve({data:{objects:[{physicalId:e.objectId}]},onComplete:function(e){e.results&&e.results.length&&e.results[e.results.length-1].body?t(e.results[e.results.length-1].body.reportedAgainst):t([])},onFailure:function(){PADAlert.displayNotification({msg:m.notifications.serverError,eventID:"error"})}})})},_subscribers:function(){var e=this,t=a.get("widget")||window.widget;e._widgetEventTokens=[{eventName:"onLoad",listener:e.onLoad.bind(e)},{eventName:"onRefresh",listener:e.onRefresh.bind(e)},{eventName:"onResize",listener:e.onResize.bind(e)},{eventName:"onDestroy",listener:e.onDestroy.bind(e)},{eventName:"onTitleChange",listener:e.onTitleChange.bind(e)},{eventName:"endEdit",listener:function(){e._setENOPADSecurityContext()}}],e._widgetEventTokens.forEach(function(e){t.addEvent(e.eventName,e.listener)}),t.body.addEventListener("contextmenu",function(e){e.preventDefault()},e)},_setENOPADSecurityContext:function(){var e=a.get("widget")||window.widget;try{if(e.getPreference("securityContext")){var t=e.getPreference("securityContext").value;require(["DS/PADUtils/PADSettingsMgt"],function(e){e.setSetting("pad_security_ctx",t)}),sessionStorage.setItem("PADSecurityCtx",t),e.setValue("pad_security_ctx",t)}}catch(e){}},_updateSharedSettings:function(){var e=a.get("widget")||window.widget;require(["DS/PADUtils/PADSettingsMgt"],function(t){try{var n=e.getValue("enopad3dviewer_displayCandidateQueue"),s=t.getSetting("enopad3dviewer_displayCandidateQueue");n!=s&&t.setSetting("enopad3dviewer_displayCandidateQueue",n),(n=e.getValue("enopad3dviewer_displayCandidateQueue_color"))!=(s=t.getSetting("enopad3dviewer_displayCandidateQueue_color"))&&t.setSetting("enopad3dviewer_displayCandidateQueue_color",n)}catch(e){}})},hud:{_loader:null,_container:null,init:function(){var e=this;if(n.is(e._loader,"object"))return t.resolve({loader:e._loader,container:e._container});var s=null;return new t(function(e){require(["DS/Controls/Loader"],function(t){s=t,e()})}).then(function(){return e._container=n.createElement("div",{class:"issue-3d-review-display-loader fade-in-element"}),e._loader=new s({text:"",fadeDuration:w,showButtonFlag:!1}),e._loader.inject(e._container),{loader:e._loader,container:e._container}})},on:function(e,t){var s,i;s=n.is(e,"string")?e:"",i=n.is(t,"string")?t:"0",this._loader.on(),this._loader.elements.label.innerHTML=s,this._loader.update(i)},off:function(){var e=this;setTimeout(function(){new n.Fx(e._loader.elements.container,{duration:w,transition:"linear",events:{onStart:function(){},onComplete:function(){n.is(e._loader,"object")&&e._loader.off()}}}).start({opacity:[1,0]})},0)},update:function(e,t){this._loader.elements.label.innerHTML=e,this._loader.update(t)},destroy:function(){n.is(this._loader,"object")&&(this._loader.destroy(),this._container.destroy()),this._loader=null,this._container=null},getHUDLabel:function(){var e=a.get("component");if(!1===e.isDisplayed())return m.titles.issuesNotDisplayed;var t=Object.keys(e.getIssues().map).length;return 0===t?m.titles.noIssuesToShow:m.replace(m.titles.issues,{number:t})}},helper:{container:null,_tooltip:null,init:function(){var e=a.get("widget")||window.widget,t=this.container=n.createElement("span",{class:"issue-status-left fonticon fonticon-help-circled"}),i=this._tooltip=new s({className:"helper-tooltip",position:"top",target:t,body:m.tooltips.helper,trigger:"touch"});return t.addEventListener("click",function(){i.hide(),o.show(e.body)}),this},on:function(){this.container.show()},off:function(){this.container.hide()},destroy:function(){null!==this._tooltip&&this._tooltip.destroy(),null!==this.container&&this.container.destroy(),this._tooltip=null,this.container=null}},utils:{error:function(e){n.is(e,"object")&&n.is(e.error,"object")&&n.is(e.error.message,"string")&&require(["DS/PADUtils/views/PADAlert"],function(t){t.displayNotification({msg:e.error.message,eventID:"error"})})},getNLSMsg:function(e){var t={label:m.error.generic.label,sub:m.error.generic.sub},s="";return n.is(e,"object")&&n.is(e.error,"object")&&n.is(e.error.message,"string")&&(s=e.error.message),s.contains("The server cannot obtain the license for user")&&(t.label=m.error.licensing.label,t.sub=m.replace(m.error.licensing.sub,{user:c.getUserName()})),t}}})}),define("DS/Issue3DReview/commands/Focus",["UWA/Class","DS/ApplicationFrame/CommandCheckHeader"],function(e,t){"use strict";return e.extend(t,{init:function(e){var t=this;t._parent(e,{}),require(["DS/PADUtils/views/PADAlert","DS/Issue3DReview/utils/ViewerManipulator","DS/IssueServices/Contexts","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(e,n,s,i){var o=!1,r=t.onStateChange(function(){if(!0!==o){var r=!1,a=s.get("component"),l=null!==a?a.getManager():null;if(null===a||null===l)return e.displayNotification({msg:i.notifications.noIssuesInSession,eventID:"info"}),o=!0,r="true"===localStorage.getItem("Issue3DReviewDisplay"),void t.setState(r,!0);if(a.isProcessing())return e.displayNotification({msg:i.notifications.commandAlreadyProcessing,eventID:"info"}),o=!0,r="true"===localStorage.getItem("Issue3DReviewDisplay"),void t.setState(r,!0);(r="true"===localStorage.getItem("Issue3DReviewFocus"))!==t.getState()&&(localStorage.setItem("Issue3DReviewFocus",t.getState()?"true":"false"),function(e){var t=s.get("component");n.focus2({application:t.context.root,toggle:e,neutrals:t.getManager().getNeutralNodes(),reported:t.getManager().getReportedNodes()})}(r="true"===localStorage.getItem("Issue3DReviewFocus")))}else o=!1});t._destroy=function(){t._modelEvents.unsubscribe(r)};var a="true"===localStorage.getItem("Issue3DReviewFocus");o=!0,t.setState(a,!0)})}})}),define("DS/Issue3DReview/utils/ViewerManipulator",["UWA/Class/Promise","UWA/Core","DS/UIKIT/Input/Button","DS/ENOFloatingPanel/ENOFloatingPanel","DS/LevelSelector/LevelSelector","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/Selection/HSOManager","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/IdPath","DS/Issue3DReview/commands/CommandsManager","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Parser","DS/IssueServices/utils/Performance","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Windows/Panel","DS/Controls/Button","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(e,t,n,s,i,o,r,a,l,c,u,d,h,p,g,m,f,v,w,b,D){"use strict";var S="DS/Issue3DReview/utils/ViewerManipulator",I=0,y=27,_=!1,C=[],E=[],R=null,x=null,A=function(){return t.createElement("ul",{class:"task-manager-cancel is-ground-level"})},k=function(){return t.createElement("li",{id:"task-manager-cancel-exit",class:"task-manager-cancel home-section",html:'<span class="home-section wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-move-to-start"></span>'})},P=function(){return t.createElement("li",{id:"task-manager-cancel-info",class:"task-manager-cancel first-crumb crumbs-with-home",html:"<p>"+D.tasks.cancel+"</p><span></span>"})},T=o.getLogger(S);return{focus2:function(e){var t=e.application,n=e.toggle,s=e.neutrals,i=e.reported;if(!1===n)return C.length>0&&(C.forEach(function(e){e.resetOpacity(),R.deleteOverride(C)}),C.length=0),E.length>0&&(E.forEach(function(e){e.resetOpacity(),R.deleteOverride(C)}),E.length=0),x.removeSceneGraphOverrideSet(R),R=null,t.getViewer().render(),_=!1,f.end(S+" focus"),!0;var o=p.get("component").get3DContext().controller;if(!0===_)return!1;f.start(S+" focus"),o.isColorizeActivated()&&r.displayNotification({msg:D.notifications.noFocusedViewWhenColorized,eventID:"info"}),_=!0,x=t.getViewer().getSceneGraphOverrideSetManager(),R=new l(o.getRootBag(),o.getRootBagId(),!0),x.insertSceneGraphOverrideSetAt(R,0);for(var a=Object.keys(s),c=0;c<a.length;c++){s[a[c]];var u=new d([o.getRootBagId()].concat(a[c].split(",")));(m=R.createIdPathOverride(u)).setOpacity(.15,!1),C.push(m)}for(var h=Object.keys(i),g=0;g<h.length;g++){var m;u=new d([o.getRootBagId()].concat(h[g].split(",")));(m=R.createIdPathOverride(u)).setOpacity(1,!0),E.push(m)}return t.getViewer().render(),_=!1,f.end(S+" focus"),!0},reportedAgainstDummyBalloons:[],OccurrenceSelectionInfo:{isOccurrenceSelection:!1,intermidiateLeafSelection:!1,leafId:null,leafPosition:null},occurrenceSelectionDialog:null,selectIn3D:function(e,o){var l=this,c=p.get("widget"),d=p.get("component"),f=p.get("application");f.displayLevelSelector=!1;var w=d.get3DContext(),b=c.body.querySelector(".enopad3Dviewer_container");d.stopListeningToCSO(),w.root.setDefaultContextualMenuVisibility(!1);var S,_,C,E,R,x,O=null,V=null,N=null,M=null,L=t.createElement("div",{class:"task-manager-cancel-container"}),F=A(),j=k(),U=P();F.appendChild(j),F.appendChild(U),F.addEventListener("click",function(){O()}),F.addEventListener("touchstart",function(e){e.preventDefault(),O()}),L.appendChild(F);var B=t.createElement("div",{id:"vertical-line-select-reported"}),z=t.createElement("div",{id:"horizontal-line-select-reported"});b.appendChild(B),b.appendChild(z);var W=null,H=null;return S=function(){null===N&&!0!==M&&(B.setStyle("display","initial"),z.setStyle("display","initial"))},_=function(e){if(null===N&&!0!==M){var t=e.offsetX||e.layerX,n=e.offsetY||e.layerY;void 0!==t&&void 0!==n||e.targetTouches[0]&&(t=e.targetTouches[0].clientX-e.currentTarget.getOffsets().x,n=e.targetTouches[0].clientY-e.currentTarget.getOffsets().y),B.setStyle("left",t),z.setStyle("top",n);var s=w.viewer.getMousePosition(new u.Vector2(t,n)),i=w.viewer.pick(s,"primHybrid",!0);return i.position&&i.path.length?(B.setStyle("background-color","#57B847"),z.setStyle("background-color","#57B847"),W=i):(B.setStyle("background-color","#E87B00"),z.setStyle("background-color","#E87B00"),W=null),{x:t,y:n}}},C=function(){null===N&&!0!==M&&(B.setStyle("display","none"),z.setStyle("display","none"),W=null)},O=function(e){e&&(e.stopPropagation(),e.preventDefault()),W=null,V(!0)},R=function(e){e.keyCode===y&&document.activeElement===e.target&&(W=null,V(!0))},E=function(t){if(null===N&&!0!==M){var o=_(t);if(W&&W.position&&W.path.length){var u=function(){1==l.OccurrenceSelectionInfo.intermidiateLeafSelection&&(l._intersectionForOccurrenceSelection=W),1==l.OccurrenceSelectionInfo.isOccurrenceSelection&&(W=l._intersectionForOccurrenceSelection);var n={x:W.position.x,y:W.position.y,z:W.position.z},s=W.path[I];if(H=(H=(H="CGR"==s.getLastElement().name?s.getParentPath():s).getParentPath()).getParentPath(),H=w.controller.buildArrayFromPath(H),1==l.OccurrenceSelectionInfo.isOccurrenceSelection&&(s=p.get("component").get3DContext().root.unstreamPath(H)),1==l.OccurrenceSelectionInfo.isOccurrenceSelection){H.splice(H.indexOf(l.OccurrenceSelectionInfo.leafId)+1,H.length-1);var c=H[H.length-1],d=p.get("component").getManager().getNodesById(c),h={};l.convertAbsoluteToRelativePosition(H,n,c).then(function(e){c=H.join(),h[c]={x:e.position.x,y:e.position.y,z:e.position.z,balloons:[]},l.addReportedAgainstDummyBalloons(c,h,d)})}var f=[],S=!1,y=function(e){if(e&&e.externalPath.length>0&&e.getLastElement()){var n=e.getLastElement();1==l.OccurrenceSelectionInfo.isOccurrenceSelection&&n.modelIdentification==l.OccurrenceSelectionInfo.leafId&&(S=!0),v.isReference(n)&&v.getNodeID(n)&&(1==l.OccurrenceSelectionInfo.isOccurrenceSelection&&1==S?f.push({pathElement:e,event:t}):0==l.OccurrenceSelectionInfo.isOccurrenceSelection&&f.push({pathElement:e,event:t})),y(e.getParentPath())}};1==l.OccurrenceSelectionInfo.isOccurrenceSelection&&(s=p.get("component").get3DContext().root.unstreamPath(H),H.splice(H.indexOf(l.OccurrenceSelectionInfo.leafId)+1,H.length-1)),y(s);var _=function(t){try{var s=t.pathElement,o=w.controller.buildArrayFromPath(s),a=v.getNodeID(t.pathElement.getLastElement()),c=null,d=f[f.length-1].pathElement.getLastElement(),h=v.getNodeID(d);h!==a&&(c=h);var g=p.get("component").getManager().getNodesById(a),m={};l.convertAbsoluteToRelativePosition(o,n,a).then(function(t){if(m[a]={x:t.position.x,y:t.position.y,z:t.position.z,balloons:[]},1==l.OccurrenceSelectionInfo.intermidiateLeafSelection)return l.OccurrenceSelectionInfo.leafId=a,l.OccurrenceSelectionInfo.leafPosition=m,l.OccurrenceSelectionInfo.isOccurrenceSelection=!0,l.OccurrenceSelectionInfo.intermidiateLeafSelection=!1,!0===M&&(i.destroyView(),M=!1),l.setLeafReferenceForOccurrence(),void u();V(!1),e(a,m,g,c)})}catch(e){T.error(e),r.displayNotification({msg:D.notifications.notValidReportedAgainst,eventID:"info"})}};if(0===f.length)T.error(new Error("no proper path found.")),r.displayNotification({msg:D.notifications.notValidReportedAgainst,eventID:"info"});else if(1===f.length){var C={pathElement:f[0].pathElement};_(C),setTimeout(function(){l.removeReportedAgaistDummyBalloons()},500)}else{var E=b,R={positionX:o?o.x+5:E.offsetWidth/2,positionY:o?o.y-5:E.offsetHeight/2,uiFrame:E,getLevels:function(e){var t=f.map(function(e){var t=e.pathElement.getLastElement();return v.getNodeID(t)});return g.fetch({data:{objects:t.map(function(e){return{physicalId:e}})},onComplete:function(t){var n=t.body,s={};if("results"in n)for(var i=0;i<n.results.length;i++){var o=m.parseFetchResponse(n.results[i]);s[o.value.physicalId]=o.value}for(var r=0;r<f.length;r++){var a=f[r].pathElement.getLastElement(),l=v.getNodeID(a);f[r].name=s[l].title,f[r].icon=s[l].typeIcon}e(f)},onFailure:function(t){T.warn("Fetching attributes for LevelSelector failed.",t),e(f)}}),f},onHover:function(e){1==l.OccurrenceSelectionInfo.isOccurrenceSelection?function(e){try{var t=e.pathElement,s=(w.controller.buildArrayFromPath(t),v.getNodeID(e.pathElement.getLastElement())),i=H[H.length-1],o=p.get("component").getManager().getNodesById(i),a=l.calculateReferenceInstanceOccurrencePath(H,s),c={};l.convertAbsoluteToRelativePosition(H,n,i).then(function(e){i=a.join(),c[i]={x:e.position.x,y:e.position.y,z:e.position.z,balloons:[]},l.removeReportedAgaistDummyBalloons(),l.addReportedAgainstDummyBalloons(i,c,o)})}catch(e){T.error(e),r.displayNotification({msg:D.notifications.notValidReportedAgainst,eventID:"info"})}}(e):(a.empty(),a.add(e))},onLeave:function(){l.removeReportedAgaistDummyBalloons()},onSelect:function(t){l.removeReportedAgaistDummyBalloons(),1==l.OccurrenceSelectionInfo.isOccurrenceSelection?function(t){try{l.removeReportedAgaistDummyBalloons();var s=t.pathElement,i=(w.controller.buildArrayFromPath(s),v.getNodeID(t.pathElement.getLastElement())),o=H[H.length-1],a=null,c=f[f.length-1].pathElement.getLastElement(),u=v.getNodeID(c);u!==o&&(a=u);var d=p.get("component").getManager().getNodesById(o),h=l.calculateReferenceInstanceOccurrencePath(H,i),g={};l.convertAbsoluteToRelativePosition(H,n,o).then(function(t){o=h.join(),g[o]={x:t.position.x,y:t.position.y,z:t.position.z,balloons:[]},V(!1),e(o,g,d,a)})}catch(e){T.error(e),r.displayNotification({msg:D.notifications.notValidReportedAgainst,eventID:"info"})}}(t):_(t)}};0===i.createView(R)?M=!0:T.error(new Error("Unexpected error during LevelSelector instantiation."))}};"touchstart"===t.type?(t.preventDefault(),N=new s({animate:!0,autocenter:!0,closable:!0,limitParent:!0,overlay:!0,resizable:!0,visible:!0,className:"confirm-select-in-3d-dialog",title:D.selectIn3D.confirmTitle,header:null,body:D.selectIn3D.confirmBody,footer:[new n({value:D.selectIn3D.confirmOK,className:"primary",events:{onClick:function(){u(),setTimeout(function(){N.destroy(),N=null},100)}}}),new n({value:D.selectIn3D.confirmCancel,className:"default",events:{onClick:function(){setTimeout(function(){N.destroy(),N=null},100)}}})],events:{onClose:function(){setTimeout(function(){N.destroy(),N=null},100)}}}).inject(c.body)):u()}}},b.ontouchstart=E,x=function(e){e.preventDefault(),e.stopPropagation()},b.addEventListener("mouseenter",S),b.addEventListener("mousemove",_),b.addEventListener("mouseleave",C),b.addEventListener("click",E),b.addEventListener("touchstart",E),b.addEventListener("touchend",x),b.addEventListener("touchmove",x),b.addEventListener("contextmenu",O),document.addEventListener("keydown",R),V=function(e,t){l.removeReportedAgaistDummyBalloons(),l.occurrenceSelectionDialog&&(l.occurrenceSelectionDialog.hide(),l.occurrenceSelectionDialog=null),f.displayLevelSelector=!0,B.destroy(),z.destroy(),b.removeEventListener("mouseenter",S),b.removeEventListener("mousemove",_),b.removeEventListener("mouseleave",C),b.removeEventListener("click",E),b.removeEventListener("touchstart",E),b.removeEventListener("touchend",x),b.removeEventListener("touchmove",x),b.removeEventListener("contextmenu",O),document.removeEventListener("keydown",R),b.ontouchstart=null,null!==N&&(N.destroy(),N=null),!0===M&&(i.destroyView(),M=!1),d.listenToCSO(),w.root.setDefaultContextualMenuVisibility(!0),h.enableAll(),L.destroy(),a.empty(),e&&o&&o()},1==l.OccurrenceSelectionInfo.intermidiateLeafSelection&&l.createOccurrenceSelectionDialog(V),h.disableAll(),V},_addBalloon:function(e,t,n,s){p.get("component").utils.createBalloon({id:t,position:e,path:n,color:"red",parent:this,temporary:!0}).then(function(e){s.call(e)})},addReportedAgainstDummyBalloons:function(t,n,s){for(var i=this,o=[],r=t.split(","),l=0;l<s.nodes.length;l++){if(s.paths[l].toString().includes(r.toString())){var c=s.paths[l].filter(e=>!r.includes(e));c.push(r[0]),c={pathElement:p.get("component").get3DContext().root.unstreamPath(c)},a.add(c),o.push(new e(function(e){i._addBalloon(n[t],t,s.paths[l],function(){i.reportedAgainstDummyBalloons.push(this),e()})}))}}},removeReportedAgaistDummyBalloons:function(){a.empty();for(var e=0;e<this.reportedAgainstDummyBalloons.length;e++)this.reportedAgainstDummyBalloons[e].destroy();this.reportedAgainstDummyBalloons=[]},calculateReferenceInstanceOccurrencePath:function(e,t){return[...e].splice(e.indexOf(t))},setOccurenceMode:function(e){this.OccurrenceSelectionInfo.intermidiateLeafSelection=e,this.OccurrenceSelectionInfo.isOccurrenceSelection=!1},createOccurrenceSelectionDialog:function(e){var n=this,s=new t.Element("div",{html:'<div>                            <li class="ISUListType">                                <div class="ISUNode ISUNodeSelect"></div>                                <div class="ISUConnector"></div>                                <div  class="ISUHeaderOccurenceSelection ISUSelect fonticon fonticon-location"></div>                                <div class="ISUHeaderOccurenceSelection ISUSelect">'+D.selectIn3D.selectAffectedItem+'</div>                            </li>                            <li class="ISUListType ISUSubListMargin ISUselectedReferencePlace">'+D.selectIn3D.pickUpFrom3DApplication+'</li>                            <li class="ISUListType ISUselectedOccurrencePlace">                                <div class="ISUNode ISUOccurrenceNode"></div>                                <div  class="ISUHeaderOccurenceSelection fonticon fonticon-location"></div>                                <div class="ISUHeaderOccurenceSelection">'+D.selectIn3D.selectApplicableContext+'</div>                                </li>                            <li class="ISUListType ISUSubListMargin">'+D.selectIn3D.pickUpOccurrenceFrom3DApplication+"</li>                        </div>"});new b({label:D.selectIn3D.cancel,allowUnsafeHTMLLabel:!1,onClick:function(t){t.dsModel.dialog.close(),n.occurrenceSelectionDialog=null,e(!0)}.bind(this)});this.occurrenceSelectionDialog=new w({title:D.selectIn3D.pickIn3D,immersiveFrame:p.get("component").get3DContext().controller._context.getFrameWindow().getImmersiveFrame(),content:s,resizableFlag:!1,width:270,height:150,movableFlag:!0,position:{at:"top right",my:"top right"}}),this.occurrenceSelectionDialog.addEventListener("close",()=>{n.occurrenceSelectionDialog=null,e(!0)});var i=this.occurrenceSelectionDialog.elements.container;i&&i.getElement(".wux-windows-window-content").addClassName("ISUDialogBackground")},setLeafReferenceForOccurrence:function(){var e=this,t=[e.OccurrenceSelectionInfo.leafId];g.fetch({data:{objects:t.map(function(e){return{physicalId:e}})},onComplete:function(t){var n=t.body,s={};if("results"in n)for(var i=0;i<n.results.length;i++){var o=m.parseFetchResponse(n.results[i]);s[o.value.physicalId]=o}if(e.occurrenceSelectionDialog){var r='<img src="'+s[e.OccurrenceSelectionInfo.leafId].display.typeIcon+'">',a=e.occurrenceSelectionDialog.elements.container;a&&(a.getElement(".ISUselectedReferencePlace").setContent(r+" "+s[e.OccurrenceSelectionInfo.leafId].display.title),a.getElement(".ISUselectedOccurrencePlace").addClassName("ISUSelect"),a.getElement(".ISUOccurrenceNode").addClassName("ISUNodeSelect"),a.getElement(".wux-windows-window-content").addClassName("ISUDialogBackground"))}},onFailure:function(e){T.warn("Fetching attributes for occurrence dialog failed.",e),callback(levels)}})},convertAbsoluteToRelativePosition:function(t,n,s){return new e(function(e){require(["DS/Issue3DReview/models/Marker"],function(i){var o=new i({id:Date.now().toString(),name:"",title:"",state:"",description:"",path:t,node:s,path_str:t.join()}),r=o.utils.convert(o,{position:n});e(r)})})}}}),define("DS/Issue3DReview/components/ContextualMenu",["UWA/Class/Promise","UWA/Core","DS/Menu/ContextualMenu","DS/WebappsUtils/WebappsUtils","DS/Issue3DReview/commands/CommandsManager","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Performance","DS/IssueServices/utils/Views","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","text!DS/IssueCommon/assets/Settings.json"],function(e,t,n,s,i,o,r,a,l,c,u){"use strict";var d="Issue",h={REPORTED_AGAINST:"reportedAgainst",RESOLVED_BY:"resolvedBy",RESOLVED_ITEMS:"resolvedItems",CONTEXTS:"contexts",OPEN_WITH:"Open with",OPEN:"Open"},p={REPORTED_AGAINST:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-location",RESOLVED_BY:"wux-ui-3ds wux-ui-3ds-1x fonticon-docs",RESOLVED_ITEMS:"wux-ui-3ds wux-ui-3ds-1x fonticon-markup-review",CONTEXTS:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-3d-object",OPEN_WITH:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-open-menu-dot",OPEN:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-open"},g="DS/Issue3DReview/components/ContextualMenu";return{getWUXContextualMenu:function(){return n},getContextualMenu:function(){var t=o.get("component").getIssues(),n=o.get("component").getSelectedIssues();if(0===n.length)return e.resolve([]);var s=n.reduce(function(e,n){var s=[],i=[],o=[],r=[];return t.map[n.id].model.get(h.REPORTED_AGAINST).forEach(function(e){s.push({physicalId:e.physicalId,type:e.type,name:e.name,title:e.title?e.title:e.name})}),t.map[n.id].model.get(h.RESOLVED_BY).forEach(function(e){i.push({physicalId:e.physicalId,type:e.type,name:e.name,title:e.title?e.title:e.name})}),t.map[n.id].model.get(h.RESOLVED_ITEMS).forEach(function(e){o.push({physicalId:e.physicalId,type:e.type,name:e.name,title:e.title?e.title:e.name})}),t.map[n.id].model.get(h.CONTEXTS).forEach(function(e){r.push({physicalId:e.physicalId,type:e.type,name:e.name,title:e.title?e.title:e.name})}),e.push({physicalId:n.id,type:n.type,name:n.name,title:n.title,reportedAgainst:s,resolvedBy:i,resolvedItems:o,contexts:r,baseType:n.baseType}),e},[]);return this._getMenu({objects:s})},_getMenu:function(t){var n=this,s=[];return 0===(Array.isArray(t.objects)?t.objects:[]).length?e.resolve([]):(a.start(n.name+" getFullMenu"),n._getOpenWithMenu(t).then(function(e){s=s.concat(e)}).then(function(){return n._getBasicMenu(t)}).then(function(e){return s=s.concat(e),a.end(n.name+" getFullMenu"),s}))},_getBasicMenu:function(e){a.start(this.name+" getMenu");var t=[],n=Array.isArray(e.objects)?e.objects:[],s=o.get("component").getSelectedIssues(),r=JSON.parse(u).duplicateIssues;return 0===n.length?t:(s.length<=r&&t.push({name:"Duplicate",title:c.commands.duplicate,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-duplicate"},data:null,action:{callback:function(){i.getCommand("Duplicate").begin()}}}),t.push({name:"Close",title:c.commands.close,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-status-change"},data:null,action:{callback:function(){i.getCommand("Close").begin()}}}),t.push({type:"SeparatorItem"}),t.push({name:"Share",title:c.commands.share,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-link"},data:null,action:{callback:function(){i.getCommand("Share").begin()}}}),t.push({type:"SeparatorItem"}),t.push({name:"RelationalExplorer",title:c.commands.relationalExplorer,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-object-related"},data:null,action:{callback:function(){i.getCommand("RelationalExplorer").begin()}}}),1===n.length&&t.push({name:"Attachments",title:c.commands.attachments,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-attach"},data:null,action:{callback:function(){i.getCommand("AttachmentManager").begin()}}}),t.push({type:"SeparatorItem"}),t.push({title:c.commands.inspect,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-location"},action:{callback:function(){i.getCommand("Inspect").begin()}}}),t.push({name:"Delete",title:c.commands.delete,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-trash"},data:null,action:{callback:function(){i.getCommand("Delete").begin()}}}),a.end(this.name+" getMenu"),t)},_getOpenWithMenu:function(t){var n=[],s=Array.isArray(t.objects)?t.objects:[];if(0===s.length)return e.resolve([]);if(t.allObjectsAreIssues=s.every(function(e){return e.baseType===d}),t.allObjectsAreNotIssues=s.every(function(e){return e.baseType!==d}),!0===t.allObjectsAreIssues){var i=[],o=[],r=[],a=[];t.objects.forEach(function(e){i=i.concat(e.contexts),o=o.concat(e.reportedAgainst),r=r.concat(e.resolvedBy),a=a.concat(e.resolvedItems)});var l=[];return e.all([this._getOpenWithSubMenu({name:h.CONTEXTS,label:c.commands.open.contexts,objects:i,icon:p.CONTEXTS}),this._getOpenWithSubMenu({name:h.REPORTED_AGAINST,label:c.commands.open.reportedAgainst,objects:o,icon:p.REPORTED_AGAINST}),this._getOpenWithSubMenu({name:h.RESOLVED_BY,label:c.commands.open.resolvedBy,objects:r,icon:p.RESOLVED_BY}),this._getOpenWithSubMenu({name:h.RESOLVED_ITEMS,label:c.commands.open.resolvedItems,objects:a,icon:p.RESOLVED_ITEMS})]).then(function(e){return(l=e.reduce(function(e,t){return e.concat(t)},[])).length>0&&n.push({name:h.OPEN,title:c.commands.open.multiple,type:"PushItem",data:null,fonticon:{content:p.OPEN},submenu:l}),n})}return!0===t.allObjectsAreNotIssues?this._getOpenWithSubMenu({name:h.OPEN_WITH,label:c.commands.open.single,objects:t.objects,icon:p.OPEN_WITH}):e.resolve([])},_getOpenWithSubMenu:function(t){if(!t||!Array.isArray(t.objects)||0===t.objects.length)return e.resolve([]);var n=[],s=[],i=t.objects;return a.start(g+" _getOpenWithSubMenu"),new e(function(e){a.start(g+" _getOpenWithSubMenu getOpenWithMenu");for(var c=0;c<i.length;c++){var u=i[c];s.push({envId:r.getTenant(),serviceId:"3DSpace",objectId:u.physicalId,objectType:u.type,displayName:u.title+"("+u.name+")"})}if(0===s.length)return a.end(g+" getOpenWithMenu"),void e(n);var d=o.get("widget")||window.widget;l.getOpenWith().set3DXContent({protocol:"3DXContent",version:"1.1",source:d.name,widgetId:d.id,data:{items:s}},!0).retrieveCompatibleApps(function(s){if(s&&s.length>0){var r=[],a=[];if(s.forEach(function(e){a={name:e.text.replace(/ /g,""),type:"PushItem",title:e.text,action:{callback:function(t){o.get("component").utils.setTypesCallbackForOFW(i),e.handler.call(t)}}},null!=e.fonticon?a.fonticon={content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+e.fonticon}:a.icon=e.icon,r.push(a)}),r.length>0){var l={name:t.name,type:"PushItem",fonticon:{content:t.icon},title:t.label,submenu:r};n.push(l)}}e(n)}),a.end(g+" _getOpenWithSubMenu")})}}}),define("DS/Issue3DReview/views/Preview",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Popover","DS/UIKIT/Scroller","DS/UIKIT/Tooltip","DS/Core/Events","DS/ENO6WPlugins/jQuery","DS/ENO6WPlugins/jQueryUI","DS/Logger/Logger","DS/SocialToolbar/SocialToolbar","DS/Issue3DReview/commands/CommandsManager","DS/Issue3DReview/utils/ModelParser","DS/IssueCommon/utils/Utils","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Performance","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","css!DS/Issue3DReview/Issue3DReview.css"],function(e,t,n,s,i,o,r,a,l,c,u,d,h,p,g,m,f,v){"use strict";var w=100,b=function(e){return n.createElement("div",{class:"card",html:n.createElement("div",{class:"card-block",html:[e.header,e.image,e.content]})})},D=function(e){return n.createElement("div",{class:"card-header",html:[n.createElement("h4",{class:"card-title",html:[n.createElement("img",{class:"card-icon",src:e.icon}),n.createElement("span",{class:"card-label",html:p.getTextFromHTML(e.title)})],title:p.getTextFromHTML(e.title)}),n.createElement("div",{class:"card-owner",html:[n.createElement("div",{class:"fonticon fonticon-user"}),e.owner]}),n.createElement("h5",{class:"card-subtitle",html:p.getTextFromHTML(e.subtitle)})]})},S=function(e){var t="";return t=n.is(e.image,"object")&&n.is(e.image.url,"string")&&""!==e.image.url?n.createElement("img",{class:"issue-latest-image",src:e.image.url}):n.createElement("div",{class:"issue-latest-image-placeholder",html:'<span class="fonticon fonticon-5x fonticon-camera"></span>'}),n.createElement("div",{class:"card-img",html:t})},I=function(e){return""!=m.get3DSwymUrl()?n.createElement("div",{class:"second-card-block",html:[n.createElement("p",{class:"card-content",html:[e.reported,n.createElement("div",{class:"card-description",html:p.getTextFromHTML(e.description)})]}),n.createElement("div",{class:"card-extra-content",html:e.extra})]}):n.createElement("div",{class:"second-card-block"})};return t.extend({name:"DS/Issue3DReview/views/Preview",tagName:"div",className:"issue-preview-container",_logger:null,domEvents:{"click .card-img":"_onClickImage","click .issue-preview-assignee":"_onClickUserIcon","click .issue-preview-owner-image":"_onClickUserIcon"},issue:null,balloon:null,comments:null,_popover:null,_firstRendering:!0,_isHovered:!1,_isFixed:!1,_closable:{element:null,tooltip:null},_visualizationEventToken:null,setup:function(e){var t=this;f.start(t.name+" setup"),t._logger=c.getLogger("DS/Issue3DReview/View"),t._parent(e),t.issue=e.issue,t._popover=new s({className:"issue-preview",target:t.issue.container,trigger:"manual",position:"right",autoHideOnClickOutside:!1,autoHide:!1,body:"",events:{onHide:function(){t._onHide()}}}),t._firstRendering=!0,t._closable={element:null,tooltip:null},t._popover.shouldListenForScroll=!1,t.comments=new u({subjectURI:"pid:"+t.issue.model.get("id"),enableShare:!1,enableComment:!0,enableLike:!1,tenantId:m.getTenant(),commentProxyToken:{header:"X-DS-CSRFTOKEN"},serviceURL:m.get3DSpaceUrl()+"/resources","3DSwymUrl":m.get3DSwymUrl(),commentsNumberAtInit:1,enableUpload:!1}),t._subscribers(),f.end(t.name+" setup")},render:function(){var e=this;e.container.empty();var t=e.issue.model.get("primaryImage"),s=null,o=null,r=null,a=m.getUserImageElement(e.issue.model.get("owner"),!1,{cssClass:"issue-preview-owner-image"});a.setData("user",e.issue.model.get("owner").user);var l=D({icon:p.getIconByState(e.issue.model.get("state"),e.issue.model.get("type"),e.issue.model.get("iconurl")),title:e.issue.model.get("title")+" ("+e.issue.model.get("name")+")",owner:a,subtitle:v.replace(v.preview.modified,{date:p.timeSince(new Date(e.issue.model.get("modified")))})}),c=S({image:null!==t?t:""}),u=I({reported:n.createElement("div",{class:"issue-preview-reported-container",html:[n.createElement("span",{class:"fonticon fonticon-location"}),s=n.createElement("span",{class:"issue-preview-reported",html:n.createElement("div",{class:"issue-preview-reported-placeholder"})})]}),description:e.issue.model.get("description"),extra:[n.createElement("div",{class:"issue-preview-assignees",html:[n.createElement("div",{class:"fonticon fonticon-users"}),0===e.issue.model.get("assignees").length?v.preview.noAssignees:e.issue.model.get("assignees").reduce(function(e,t){var s=n.createElement("img",{src:m.getUserImage(t.user),title:p.getTextFromHTML(t.fullName)+" ("+p.getTextFromHTML(t.user)+")"});return s.setData("user",t.user),e.push(n.createElement("div",{class:"issue-preview-assignee",html:s})),e},[])]}),n.createElement("div",{class:"fonticon fonticon-comment primary"}),o=n.createElement("span",{class:"issue-preview-nb-comments"}),r=n.createElement("div",{class:"issue-preview-comments enhanced-only",html:""})]}),d=n.createElement("div",{html:"",styles:{height:"100%",width:"100%"}});r.setContent(d);var f=new i({element:d}).inject(r);return e.comments.inject(f.getInnerElement()),e.container.setContent(b({header:l,image:c,content:u})),g.fetch({data:{objects:[{physicalId:e.balloon.model.get("physicalId")}]},onComplete:function(e){e.body.results.forEach(function(e){var t=h.parse(e,{useIndex:!0});s.setContent([n.createElement("img",{src:t.icons.length>0?t.icons[t.icons.length-1]:"",title:t.title+" ("+t.name+") "+t.revision}),n.createElement("span",{html:p.getTextFromHTML(t.title)+" ("+p.getTextFromHTML(t.name)+") "+p.getTextFromHTML(t.revision),title:p.getTextFromHTML(t.title)+" ("+p.getTextFromHTML(t.name)+") "+p.getTextFromHTML(t.revision)})])})},onFailure:function(t){e._logger.error("Could not fetch data for %s because %s",e.balloon.model.get("physicalId"),t),s.setContent(n.createElement("div",{class:"issue-preview-reported-error",html:v.preview.errorFetch}))}}),o.setContent("..."),e._popover.removeEvent("onShow"),e._popover.addEvent("onShow",function(){g.comments.retrieve({data:{physicalId:e.issue.model.get("id")}}).then(function(t){var n=0;try{n=t.body.result.nbComments}catch(e){n=0}e.utils.isInteger(n)||(n=0),o.setContent(v.replace(v.preview.comments,{number:n}))})}),!0===e._firstRendering&&(e._firstRendering=!1,e._getPrimaryImage().then(function(t){n.is(t)&&n.is(t.url,"string")&&""!==t.url&&e.container.getElement("div.card-img").setContent(n.createElement("img",{class:"issue-latest-image",src:t.url}))}).catch(function(t){e._logger.error(t)})),e},destroy:function(){null!==this._visualizationEventToken&&r.unsubscribe(this._visualizationEventToken),this.issue=null,this.balloon=null,this.comments.destroy(),this.comments=null,this._popover.destroy(),this._popover=null,this._firstRendering=!0,null!==this._closable.tooltip&&(this._closable.tooltip.destroy(),this._closable.tooltip=null),null!==this._closable.element&&(this._closable.element.destroy(),this._closable.element=null),this._isHovered=!1,this._isFixed=!1,this._visualizationEventToken=null,this.container.empty()},refresh:function(){this.render()},show:function(e){return!0===this.isFixed()?(this._logger.debug("Preview for issue %s (%s) is fixed, no need to show again",this.issue.model.get("title"),this.issue.model.get("name")),this):!0===this._popover.isVisible?this:(this._logger.debug("Showing preview for issue %s (%s)",this.issue.model.get("title"),this.issue.model.get("name")),this.balloon=e,this._logger.debug("Balloon is reported on %s (%s)",this.balloon.model.get("title"),this.balloon.model.get("name")),this._popover.setOption("target",this.balloon.container),this._popover.getContent().getElement(".popover-arrow").setStyle("display","initial"),this._popover.show(),this._popover.updatePosition(),this._popover.setBody(this.render()),this.container.removeClassName("enhanced"),!0===this.issue.isSelected&&this.enhance(),this)},hide:function(){var e=this;if(!0===e.isFixed())return e;if(!0===e.isEnhanced())var t=setInterval(function(){!0===e.shouldHide()&&(clearInterval(t),!0===e.shouldKaboom()&&e.kaboom())},w);else e.kaboom();return e},brake:function(){!1===this.isFixed()?this.kaboom():this.hide()},kaboom:function(){this._popover.hide()},enhance:function(){var e=this;!0!==e.isEnhanced()&&(null===e._visualizationEventToken&&(e._visualizationEventToken=r.subscribe({event:"/VISU/"},function(t){"@onViewpointChange"===t.eventType&&e._popover.updatePosition()})),e.container.addClassName("enhanced"),e._popover.updatePosition(),e._popover.getContent().addEventListener("mouseover",function(){e._isHovered=!0}),e._popover.getContent().addEventListener("mouseout",function(t){for(var n=t.toElement||t.relatedTarget;n&&n.parentNode&&n.parentNode!==window;){if(n.parentNode===this||n===this)return void(n.preventDefault&&n.preventDefault());n=n.parentNode}e._isHovered=!1}),e.draggable())},draggable:function(){var e=this,t=e._popover.getContent();a(t).draggable({handle:t.getElement(".card-title"),start:function(){!0!==e._isFixed&&(e._isFixed=!0,null!==e._visualizationEventToken&&r.unsubscribe(e._visualizationEventToken),t.getElement(".popover-arrow").setStyle("display","none"),e._closable.element=n.createElement("span",{class:"issue-preview-closable",html:'<span class="fonticon fonticon-cancel"></span>',events:{click:function(){e._isFixed=!1,e.kaboom()}}}).inject(t),e._closable.tooltip=new o({target:e._closable.element,body:v.preview.close}))}})},isEnhanced:function(){return this.container.hasClassName("enhanced")},isFixed:function(){return this._isFixed},isFocused:function(){var e=document.activeElement;return function(e,t){for(var n=t.parentNode;null!==n;){if(n===e)return!0;n=n.parentNode}return!1}(this._popover.getContent(),e)},shouldHide:function(){return!this._isHovered},shouldKaboom:function(){return null!==this._popover&&(!this.isFixed()&&!this.isFocused())},_onHide:function(){this._isFixed=!1,this._isHovered=!1;try{null!==this._closable.tooltip&&(this._closable.tooltip.destroy(),this._closable.tooltip=null),null!==this._closable.element&&(this._closable.element.destroy(),this._closable.element=null),a(this._popover.getContent()).draggable("destroy")}catch(e){}this.container.removeClassName("enhanced")},_onClickImage:function(){this._isFixed=!1,this.kaboom(),d.getCommand("AttachmentManager").begin()},_onClickUserIcon:function(e){var t=e.target.getData("user");n.is(t,"string")&&m.getUserProfile(t)},_getPrimaryImage:function(){var t=this;return new e(function(e){t.issue.model.fetchPrimaryImage({onComplete:e,onFailure:function(){}})})},_subscribers:function(){var e=this;e.listenTo(e.issue.model,"onChange",function(){e.kaboom()})},utils:{isInteger:function(e){return Number.isInteger?Number.isInteger(e):"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}}})}),define("DS/Issue3DReview/views/Inspector",["UWA/Class","UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Input/Toggle","DS/UIKIT/Mask","DS/UIKIT/Tooltip","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/Visualization/ThreeJS_DS","DS/Visualization/IdPath","DS/Issue3DReview/commands/CommandsManager","DS/IssueServices/Contexts","DS/IssueServices/utils/Performance","DS/IssueServices/services/IssueServices","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADTypesMgt","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","css!DS/Issue3DReview/Issue3DReview.css"],function(e,t,n,s,i,o,r,a,l,c,u,d,h,p,g,m,f,v,w){"use strict";var b=300,D=function(){return s.createElement("ul",{class:"navigation-inspect-mode is-ground-level"})},S=function(){return s.createElement("li",{id:"navigation-inspect-exit",class:"navigation-inspect-mode home-section",html:'<span class="home-section wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-move-to-start"></span>'})},I=function(){return s.createElement("li",{id:"navigation-inspect-back",class:"navigation-inspect-mode home-section",html:'<span class="home-section wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-back "></span>'})},y=function(e){return s.createElement("li",{id:"navigation-inspect-info",class:"navigation-inspect-mode first-crumb crumbs-with-home",html:"<p>"+w.replace(w.inspect.title,{number:e.number})+"</p><span></span>"})};return n.extend({name:"DS/Issue3DReview/views/Inspector",tag:"div",className:"inspect-options-container",_logger:null,manager:null,elements:{bar:null,info:null,context:null,related:null,tooltips:[]},isProcessing:!1,isInspectioneering:!1,isInContext:!1,isRelatedSwitch:!1,_toBeRemovedAtRelease:{contexts:[],resolvedItems:[]},_inspectedIssues:{},_currentLevel:-1,_restoreFocus:!1,_levels:{},_session:{paths:{inspected:[],added:[],showed:[]},issues:[]},defaultOptions:{manager:null},_viewPoint:null,_overrideAll:[],_overrideSet:null,_overrideManager:null,setup:function(e){return this._logger=a.getLogger("DS/Issue3DReview/View"),this._parent(e),this.manager=this.getOption("manager"),this.elements={bar:null,info:null,context:null,related:null,tooltips:[]},this._viewPoint=null,this.reset(),this},render:function(){var e=this,t=D(),n=S(),s=I(),o=y({number:Object.keys(e._inspectedIssues).length});e.elements.bar=t,e.elements.info=o,t.appendChild(n),t.appendChild(s),t.appendChild(o),n.addEventListener("click",function(){d.getCommand("Release").begin()}),n.addEventListener("touchstart",function(e){e.preventDefault(),d.getCommand("Release").begin()}),s.addEventListener("click",function(){e._goToLevel(e._currentLevel-1)}),s.addEventListener("touchstart",function(t){t.preventDefault(),e._goToLevel(e._currentLevel-1)}),o.addEventListener("click",function(){}),e.container.appendChild(t),e.elements.context=new i({type:"switch",value:"with-context",label:w.inspect.withContext,disabled:!0,events:{onChange:function(){!0===this.isChecked()&&!1===e.isInContext?e.showContext().catch(function(){setTimeout(function(){e.elements.context.uncheck()},b)}):e.hideContext()}}}).inject(e.container),e.elements.tooltips.push(new r({position:"top",target:e.elements.context.elements.container,body:w.inspect.withContextTooltip})),e.elements.related=new i({type:"switch",disabled:!0,label:w.inspect.switchRelated,events:{onChange:function(){e.switchRelatedObjects().catch(function(){setTimeout(function(){e.elements.related.uncheck()},b)})}}}).inject(e.container),e.elements.tooltips.push(new r({position:"top",target:e.elements.related.elements.container,body:w.inspect.switchRelatedTooltip}));var a=e.manager.options.context.root.getFrameWindow().elements.container;return a.insertBefore(e.container,a.firstChild),g.issues.retrieve({data:{objects:[{physicalId:Object.keys(e._levels[e._currentLevel].inspectedIssues)}]},onComplete:function(t){t.results&&t.results.length&&t.results[t.results.length-1].body?e.issueData=t.results[t.results.length-1].body:resolve([])},onFailure:function(t){l.displayNotification({msg:w.notifications.serverError,eventID:"error"}),p.end(e.name+" fetch")}}),e},destroy:function(){this.reset(),this.manager=null,this.elements.tooltips.forEach(function(e){e.destroy()}),this.elements={bar:null,info:null,context:null,related:null,tooltips:[]},this._viewPoint=null},reset:function(){this.isProcessing=!1,this.isInspectioneering=!1,this.isInContext=!1,this.isRelatedSwitch=!1,this._toBeRemovedAtRelease={contexts:[],resolvedItems:[]},this._inspectedIssues={},this._currentLevel=-1,this._restoreFocus=!1,this._levels={0:{inspectedIssues:{},session:{paths:{inspected:[],contexts:{added:[],showed:[]},resolvedItems:{added:[],showed:[]}}}}}},inspect:function(e){var t=this;p.start(t.name+" inspect");var n=e.ids;return t.isInspectable(n).then(function(){return-1===t._currentLevel?t._startInspect2(n):t._goDeeper(n)}).then(function(){p.end(t.name+" inspect")})},_startInspect2:function(e){var n=this,s=n.manager.options.context.window.getViewpoint(),i={target:s.control.target,orientation:s.control.orientation,distanceToTarget:s.control.distanceToTarget};n._viewPoint=JSON.stringify(i);var o=!1;return new t(function(e){n.loading(),n.reset(),h.get("filter").hide();var t=d.getCommandCheckHeader("Focus");t.getState()&&(n._restoreFocus=!0,t.toggleState()),n.manager.options.context.window.getViewer().visibleSpace?e():(o=!0,d.getCommand("VisuVisibleSpace").onEnd(e),d.getCommand("VisuVisibleSpace").begin())}).then(function(){return n._currentLevel++,d.inspectingIssue(),n.isInspectioneering=!0,n.isProcessing=!0,n.manager.optimizeBalloonVisualization(),n.manager.hide()}).then(function(){for(var s=n.manager.getIssues().map,i=[],o=[],r=0;r<e.length;r++){var a=s[e[r]];void 0!==a&&(n._inspectedIssues[e[r]]=a,a.model.get("markers").forEach(function(e){i.push(e.get("path"))}),o.push(a.show()))}return n._levels[n._currentLevel].inspectedIssues=n._inspectedIssues,n._levels[n._currentLevel].session.paths.inspected=i,n._renderViewer({pathsToShow:i,isInspect:!0}),t.all(o)}).then(function(){return!0===o?new t(function(e){d.getCommand("VisuVisibleSpace").onEnd(e),d.getCommand("VisuVisibleSpace").begin()}):t.resolve()}).then(function(){n.render(),n._refreshNavigationBar(),n.isProcessing=!1,n.unloading()})},_renderViewer:function(e){var t=this,n=t.manager.options.context.root.getController(),s=h.get("component").context.root,i=e.pathsToShow,o=!!e.isInspect,r=i.map(function(e){return e.toString()});null!==t._overrideManager&&null!==t._overrideSet&&(t._overrideAll.forEach(function(e){e.setVisibility(!0),e.setVisibilityFree(!1),t._overrideSet.deleteOverride(e)}),t._overrideManager.removeSceneGraphOverrideSet(t._overrideSet),t._overrideAll.length=0),t._overrideManager=s.getViewer().getSceneGraphOverrideSetManager(),t._overrideSet=new m(n.getRootBag(),n.getRootBagId(),!0),t._overrideManager.insertSceneGraphOverrideSetAt(t._overrideSet,0);var a=[],l={};for(var c in l=o?t.manager.paths:t.manager.utils.parseChildren2(n).paths)if(l.hasOwnProperty(c))for(var d=0;d<l[c].length;d++){var p=l[c][d],g=p.toString(),f=[n.getRootBagId()];f=f.concat(p);var v=new u(f),w=t._overrideSet.createIdPathOverride({idPathes:v});if(null!==w)r.some(function(e){var t=g.includes(e),n=g===e,s=e.includes(g);return t||n||s})?(w.setVisibility(!0),w.setVisibilityFree(!1),t._overrideAll.push(w),o&&a.push(c)):(w.setVisibility(!1),w.setVisibilityFree(!0),t._overrideAll.push(w))}n._viewer.render({updateInfinitePlane:!0}),t.manager.options.context.window.getViewpoint().reframe(null),o&&a.forEach(function(e){n._model._OOCManager.isReferenceLoaded(e)||n._model._OOCManager.forceReferenceLoad(e,null)})},_goDeeper:function(e){var n=this,s=!1;return new t(function(e){n.loading(),n.isProcessing=!0,n._currentLevel++,n.manager.options.context.window.getViewer().visibleSpace?e():(s=!0,d.getCommand("VisuVisibleSpace").onEnd(e),d.getCommand("VisuVisibleSpace").begin())}).then(function(){n._levels[n._currentLevel]={inspectedIssues:{},session:{paths:{inspected:[],contexts:{added:[],showed:[]},resolvedItems:{added:[],showed:[]}}}};for(var s=n.manager.getIssues().map,i=[],o=0;o<e.length;o++){var r=s[e[o]];void 0!==r&&(n._levels[n._currentLevel].inspectedIssues[e[o]]=r,r.model.get("markers").forEach(function(e){i.push(e.get("path"))}))}n._levels[n._currentLevel].session.paths.inspected=i;for(var a=[],l=Object.keys(n._levels[n._currentLevel-1].inspectedIssues),c=0;c<l.length;c++)-1===e.indexOf(l[c])&&a.push(n._levels[n._currentLevel-1].inspectedIssues[l[c]].hide());return t.all(a)}).then(function(){return n._refreshVisualization(!0)}).then(function(){return s?new t(function(e){d.getCommand("VisuVisibleSpace").onEnd(e),d.getCommand("VisuVisibleSpace").begin()}):t.resolve()}).then(function(){n._refreshNavigationBar(),n.manager.component.dispatchEvent("onInspect"),n.isProcessing=!1,n.unloading()})},_goToLevel:function(e){var n=this;if(null===n._levels[e]||void 0===n._levels[e])return t.reject(new Error("The level does not exist"));var s=t.resolve(),i=!1;return n.manager.options.context.window.getViewer().visibleSpace||(i=!0,s.then(function(){return new t(function(e){d.getCommand("VisuVisibleSpace").onEnd(e),d.getCommand("VisuVisibleSpace").begin()})})),!0===n.isInContext&&(s=s.then(function(){return n.hideContext().then(function(){n.elements.context.uncheck()})})),!0===n.isRelatedSwitch&&(s=s.then(function(){return n.switchRelatedObjects().then(function(){n.elements.related.uncheck()})})),s.then(function(){return n.loading(),n.isProcessing=!0,n._currentLevel=e,n._refreshVisualization(!0)}).then(function(){for(var e=[],s=Object.keys(n._levels[n._currentLevel].inspectedIssues),i=0;i<s.length;i++)e.push(n._levels[n._currentLevel].inspectedIssues[s[i]].show());return t.all(e)}).then(function(){return i?new t(function(e){d.getCommand("VisuVisibleSpace").onEnd(e),d.getCommand("VisuVisibleSpace").begin()}):t.resolve()}).then(function(){n._refreshNavigationBar(),n.manager.component.dispatchEvent("onInspect"),n.isProcessing=!1,n.unloading()})},_refreshNavigationBar:function(){var e=Object.keys(this._levels[this._currentLevel].inspectedIssues).length;0===this._currentLevel?this.elements.bar.addClassName("is-ground-level"):this.elements.bar.removeClassName("is-ground-level"),this.elements.info.innerHTML="<p>"+w.replace(w.inspect.title,{number:e})+"</p><span></span>",1===e?(this.elements.context.enable(),this.elements.related.enable()):(this.elements.context.disable(),this.elements.related.disable())},release:function(){var e=this;if(!0===e.isProcessing)return t.reject(new Error("We are already processing an inspection"));if(!1===e.isInspectioneering)return t.resolve();p.start(e.name+" release"),e.isProcessing=!0,e.loading();var n=[],i=!1;return e.manager.options.context.window.getViewer().visibleSpace||(i=!0,n.push(new t(function(e){d.getCommand("VisuVisibleSpace").onEnd(e),d.getCommand("VisuVisibleSpace").begin()}))),t.all(n).then(function(){d.releasingIssue(),e.container.destroy();var n=t.resolve();return!0===e.isInContext&&(n=n.then(function(){return e.hideContext()})),!0===e.isRelatedSwitch&&(n=n.then(function(){return e.switchRelatedObjects()})),n}).then(function(){e.manager.unselectAll({publish:!0});var t=e.manager.options.context.root.getController();if(e._toBeRemovedAtRelease.contexts.length>0&&t.removeRoots({pids:s.clone(e._toBeRemovedAtRelease.contexts)},!0),e._toBeRemovedAtRelease.resolvedItems.length>0){t.removeRoots({pids:s.clone(e._toBeRemovedAtRelease.resolvedItems)},!0);var n=widget.getValue("Issue3DReviewViewerPathsInSession");n=n?JSON.parse(n):[];var i=widget.getValue("Issue3DReviewViewerRootsDetached");i=i?JSON.parse(i):[],n&&n.length>0&&h.get("pad3DViewer").getController().addRoots({paths:n,pids_hidden:i},!1,!1)}if(e._overrideAll.forEach(function(t){t.setVisibility(!0),t.setVisibilityFree(!1),e._overrideSet.deleteOverride(t)}),e._overrideManager.removeSceneGraphOverrideSet(e._overrideSet),e._overrideAll.length=0,t._viewer.render({updateInfinitePlane:!0}),s.is(e._viewPoint,"string")){var o=JSON.parse(e._viewPoint),r={};r.target=new c.Vector3(o.target.x,o.target.y,o.target.z),r.orientation=new c.Quaternion(o.orientation.x,o.orientation.y,o.orientation.z,o.orientation.w),r.distanceToTarget=o.distanceToTarget,e.manager.options.context.window.getViewpoint().control.moveTo(r)}else e.manager.options.context.window.getViewpoint().reframe(null)}).then(function(){return e.manager.show()}).then(function(){return i?new t(function(e){d.getCommand("VisuVisibleSpace").onEnd(e),d.getCommand("VisuVisibleSpace").begin()}):t.resolve()}).then(function(){var t=d.getCommandCheckHeader("Focus");!0===e._restoreFocus&&t.toggleState(),h.get("filter").show(),e.isProcessing=!1,e.reset(),e.unloading(),p.end(e.name+" release")})},refresh:function(){var e=this,n=t.resolve();return!0===e.isInContext&&(n=n.then(function(){return e.hideContext()}).then(function(){return e.showContext()})),e.isRelatedSwitch&&(n=n.then(function(){return e.switchRelatedObjects()}).then(function(){return e.switchRelatedObjects()})),n},showContext:function(){var e=this,n=e.manager.options.context.root.getController();return!1===e.isInspectioneering||!0===e.isInContext?t.reject(new Error("You need to be in inspect mode to display the context")):Object.keys(e._levels[e._currentLevel].inspectedIssues).length>1?(l.displayNotification({msg:w.inspect.inspectNotAvailable,eventID:"info"}),t.reject(new Error("You need to inspect only ONE issue to display the context"))):(p.start(e.name+" showContext"),new t(function(t,n){e.loading(),e.isInContext=!0;var s=[];let i={},o=[];Object.keys(e._levels[e._currentLevel].inspectedIssues).forEach(function(t){var n=e._levels[e._currentLevel].inspectedIssues[t].model.get("contexts").map(t=>{const n=e.issueData.contexts.findIndex(e=>e.physicalId==t.physicalId),{type:s}=-1!==n?e.issueData.contexts[n]:{};return{...t,type:s}});Array.isArray(n)&&n.forEach(e=>{"Change Action"!==e.type&&(i.hasOwnProperty(e.type)?i[e.type].push(e.physicalId):(i[e.type]=[e.physicalId],o.push({type:e.type})))})});let r=[];v.isTypesAuthorized(o,function(o){o.forEach(function(e){s=[...s,...i[e]],r[e]=i[e]}),s.length>0?t({types:r}):(e.isInContext=!1,l.displayNotification({msg:w.inspect.noContext,eventID:"info"}),n(new Error("No context for this issue")))})}).then(function(e){var n=[];for(var s in e.types)n.push(new t(function(t,n){let i=s;"ENOStrRefinementSpecification"===s?h.get("pad3DViewer").getController().getPrdIdFromFilterId(e.types[s]).then(function(n){t({type:i,ids:e.types[i],resolvedPrdIds:[n]})}):t({type:i,ids:e.types[i],resolvedPrdIds:[]})}));return t.all(n)}).then(function(n){let s=new Set,i=new Set;n.forEach(e=>{"ENOStrRefinementSpecification"!=e.type&&e.ids.forEach(e=>s.add(e))});let o=[...s];return n.forEach(e=>{"ENOStrRefinementSpecification"!==e.type||o.includes(e.resolvedPrdIds[0])||e.ids.forEach(e=>i.add(e))}),new t(function(t,s){t({pathsInfo:e.getPathsInSession([...o,...i]),ctx:n})})}).then(function(s){return Object.keys(s.pathsInfo.inSession).length>0&&(e._levels[e._currentLevel].session.paths.contexts.showed=[].concat(s.pathsInfo.inSession)),new t(function(t,i){if(s.pathsInfo.notInSession.length>0){var o=0,r=e.manager.options.context.root.subscribe({event:"onRootAdded"},function(i){o+=1;var a=n.buildArrayFromPath(i.path);e._levels[e._currentLevel].session.paths.contexts.added.push(a),e._toBeRemovedAtRelease.contexts=e._toBeRemovedAtRelease.contexts.concat(a),o===s.pathsInfo.notInSession.length&&(e.manager.options.context.root.unsubscribe(r),t())}),a=e.manager.options.context.root.subscribe({event:"onLoadingFailure"},function(){e.manager.options.context.root.unsubscribe(a),l.displayNotification({msg:w.inspect.objectLoadError,eventID:"error"}),e.isInContext=!1,i(new Error("Object(s) failed to load"))});let d=s.ctx.filter(e=>"ENOStrRefinementSpecification"==e.type);var c=[],u=[];s.pathsInfo.notInSession.forEach(function(e){d.length>0&&d[0].ids&&d[0].ids.includes(e)?u.push({objectId:e}):c.push([e])}),n.addRoots({paths:c},!1,!0,!1),u.length>0&&n.addFilter(u)}else t()})}).then(function(){return e._refreshVisualization(!0)}).finally(function(){e.unloading(),e.isInContext&&d.inspectingIssue(),p.end(e.name+" showContext")}))},hideContext:function(){var e=this;return p.start(e.name+" hideContext"),e.loading(),e.isInContext=!1,e._levels[e._currentLevel].session.paths.contexts.showed=[],e._levels[e._currentLevel].session.paths.contexts.added=[],e._refreshVisualization(!0).then(function(){e.unloading(),p.end(e.name+" hideContext")})},switchRelatedObjects:function(){var e=this,n=e.manager.options.context.root.getController();if(!1===e.isInspectioneering)return t.reject(new Error("You need to be in inspect mode to switch the related objects"));if(Object.keys(e._levels[e._currentLevel].inspectedIssues).length>1)return l.displayNotification({msg:w.inspect.inspectNotAvailable,eventID:"info"}),t.reject(new Error("You need to inspect only ONE issue to switch the related objects"));p.start(e.name+" switchRelatedObjects"),e.isRelatedSwitch=!e.isRelatedSwitch,e.loading();return(!0===e.isRelatedSwitch?new t(function(t,n){var s=[];let i={},o=[];Object.keys(e._levels[e._currentLevel].inspectedIssues).forEach(function(t){var n=e._levels[e._currentLevel].inspectedIssues[t].model.get("resolvedItems").map(t=>{const n=e.issueData.resolvedItems.findIndex(e=>e.physicalId==t.physicalId),{type:s}=-1!==n?e.issueData.resolvedItems[n]:{};return{...t,type:s}});n&&Array.isArray(n)&&n.forEach(e=>{"Change Action"!==e.type&&(i.hasOwnProperty(e.type)?i[e.type].push(e.physicalId):(i[e.type]=[e.physicalId],o.push({type:e.type})))})});let r=[];v.isTypesAuthorized(o,function(o){o.forEach(function(e){s=[...s,...i[e]],r[e]=i[e]}),s.length>0?t({types:r}):(e.isRelatedSwitch=!1,l.displayNotification({msg:w.inspect.noResolvedItemsForSwitch,eventID:"info"}),n(new Error("No resolved by objects found")))})}).then(function(e){var n=[];for(var s in e.types)n.push(new t(function(t,n){let i=s;"ENOStrRefinementSpecification"===s?h.get("pad3DViewer").getController().getPrdIdFromFilterId(e.types[s]).then(function(n){t({type:i,ids:e.types[i],resolvedPrdIds:[n]})}):t({type:i,ids:e.types[i],resolvedPrdIds:[]})}));return t.all(n)}).then(function(n){let s=new Set,i=new Set;n.forEach(e=>{"ENOStrRefinementSpecification"!=e.type&&e.ids.forEach(e=>s.add(e))});let o=[...s];return n.forEach(e=>{"ENOStrRefinementSpecification"!==e.type||o.includes(e.resolvedPrdIds[0])||e.ids.forEach(e=>i.add(e))}),new t(function(t,s){t({pathsInfo:e.getPathsInSession([...o,...i]),ctx:n})})}).then(function(s){return Object.keys(s.pathsInfo.inSession).length>0&&(e._levels[e._currentLevel].session.paths.resolvedItems.showed=[].concat(s.pathsInfo.inSession)),new t(function(t,i){if(s.pathsInfo.notInSession.length>0){var o=0,r=e.manager.options.context.root.subscribe({event:"onRootAdded"},function(i){o+=1;var a=n.buildArrayFromPath(i.path);e._levels[e._currentLevel].session.paths.resolvedItems.added.push(a),e._toBeRemovedAtRelease.resolvedItems=e._toBeRemovedAtRelease.resolvedItems.concat(a),o===s.pathsInfo.notInSession.length&&(e.manager.options.context.root.unsubscribe(r),t())}),a=e.manager.options.context.root.subscribe({event:"onLoadingFailure"},function(){e.manager.options.context.root.unsubscribe(a),l.displayNotification({msg:w.inspect.objectLoadError,eventID:"error"}),e.isRelatedSwitch=!1,i(new Error("Object(s) failed to load"))});let d=s.ctx.filter(e=>"ENOStrRefinementSpecification"==e.type);var c=[],u=[];s.pathsInfo.notInSession.forEach(function(e){d.length>0&&d[0].ids&&d[0].ids.includes(e)?u.push({objectId:e}):c.push([e])}),n.addRoots({paths:c},!1,!0,!1),u.length>0&&(s.ctx.forEach(e=>{null!=e.resolvedPrdIds&&e.resolvedPrdIds.length>0&&n.removeRoots({pids:e.resolvedPrdIds},!0)}),n.addFilter(u))}else t()})}):new t(function(t){e._levels[e._currentLevel].session.paths.resolvedItems.showed=[],e._levels[e._currentLevel].session.paths.resolvedItems.added=[],t()})).then(function(){return e._refreshVisualization(!1)}).finally(function(){e.unloading(),e.isRelatedSwitch&&d.inspectingIssue(),p.end(e.name+" switchRelatedObjects")})},_refreshVisualization:function(e){var n=this;n.manager.options.context.root.getController();return new t(function(t){var s=n._levels[n._currentLevel].session,i=[];n.isInContext&&(i=i.concat(s.paths.contexts.showed).concat(s.paths.contexts.added)),i=n.isRelatedSwitch?i.concat(s.paths.resolvedItems.showed).concat(s.paths.resolvedItems.added):i.concat(s.paths.inspected),n._renderViewer({pathsToShow:i}),!0===e&&n.manager.options.context.window.getViewpoint().reframe(null),t()})},isInspected:function(){return this.isInspectioneering},isInspectable:function(e){if(!0===this.isProcessing)return t.reject(new Error("We are already processing an inspection"));if(this._currentLevel>=0){var n=Object.keys(this._levels[this._currentLevel].inspectedIssues);if(n.length===e.length)if(e.filter(function(e){return n.includes(e)}).length===e.length)return t.reject(new Error("You are trying to inspect the same issue(s)"))}return t.resolve()},getInspectedIssues:function(){var e=[],t=this._levels[this._currentLevel].inspectedIssues;for(var n in t)if(t.hasOwnProperty(n)){var s=t[n].model,i={id:s.get("id"),type:s.get("type"),name:s.get("name"),title:s.get("title")};e.push(i)}return e},getPathsInSession:function(e){for(var t={inSession:[],notInSession:[]},n=h.get("pad3DViewer").getController(),s=this.manager.utils.parseChildren2(n),i=0;i<e.length;i++){var o=[],r=s.paths[e[i]];if(r&&r.length>0)for(var a=0;a<r.length;a++)o.push(r[a]);o.length>0?t.inSession=t.inSession.concat(o):t.notInSession.push(e[i])}return t},loading:function(){o.mask(this.manager.options.context.window.getViewerFrame())},unloading:function(){o.unmask(this.manager.options.context.window.getViewerFrame())}})}),define("DS/Issue3DReview/views/Sack",["UWA/Class","UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/Core/Events","DS/Logger/Logger","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Issue3DReview/components/ContextualMenu","DS/Issue3DReview/views/Balloon","DS/Issue3DReview/views/Preview","DS/IssueCommon/utils/Utils","DS/IssueServices/utils/Performance","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","css!DS/Issue3DReview/Issue3DReview.css"],function(e,t,n,s,i,o,r,a,l,c,u,d,h){"use strict";var p="Create",g="Assign",m="Active",f="Review",v="Closed",w="#9B2C98",b="#E03400",D="#007DA3",S="#018308",I="#757575";return n.extend({name:"DS/Issue3DReview/views/Sack",_logger:null,defaultOptions:{manager:null,viewer:null,window:null,controller:null},balloons:[],clones:[],linked:[],preview:null,color:"",isSelected:!1,isHovered:!1,isInspected:!1,_preventPreview:!1,setup:function(e){h.start(this.name+" setup"),this._logger=o.getLogger("DS/Issue3DReview/View"),this.options=s.merge(e||{},this.defaultOptions);var t={};t[p]=w,t[g]=b,t[m]=D,t[f]=S,t[v]=I,this.options.colors=t,this.balloons=[],this.clones=[],this.linked=[],this.preview=null,this.isSelected=!1,this.isHovered=!1,this.preview=new u({issue:this}),this._subscribers(),h.end(this.name+" setup")},render:function(e){h.start(this.name+" render"),this._logger.debug("Rendering issue %s (%s)",this.model.get("title"),this.model.get("name")),e=e||{},this.color=this.options.colors[this.model.get("state")];for(var t=this.model.get("markers"),n=0;n<t.length;n++)this.add(t.at(n),e);return h.end(this.name+" render"),this},destroy:function(){var e=this;e.stopListening(e,"onMouseOver"),e.stopListening(e,"onMouseLeave"),e.stopListening(e,"onClick"),e.stopListening(e,"onDoubleClick"),e.stopListening(e,"onContextMenu"),e.stopListening(e.model,"onChange"),e.unselect();for(var n=[],s=0;s<e.balloons.length;s++)n.push(e.balloons[s].destroy());return t.all(n).then(function(){e.preview.destroy(),e.preview=null,e.balloons=[],e.clones=[],e.isSelected=!1,e.options.manager.getCollection().remove(e.model,{internal:!0}),e.model=null,e.options={}})},add:function(e){h.start(this.name+" add"),this._logger.debug("Adding balloon %s %s %s from issue %s (%s)",e.get("type"),e.get("name"),e.get("revision"),this.model.get("title"),this.model.get("name"));var t=this.options.manager;e.set("color",this.color,{silent:!0});var n=new c({model:e,parent:this,viewer:this.options.viewer,window:this.options.window,controller:this.options.controller}).render();return l.getWUXContextualMenu().addEventListener(n.container,{callback:function(){return l.getContextualMenu()}}),this.balloons.push(n),t.registerBalloon(e.get("id"),n),h.end(this.name+" add"),!0},remove:function(e){var t=this.options.manager;this.utils.unhighlightMarker.call(this,e);for(var n=0;n<this.balloons.length;n++)this.balloons[n].model.get("path_str")===e.get("path_str")&&(this._logger.debug("Removing balloon %s from issue %s (%s)",this.balloons[n].model.get("id"),this.model.get("title"),this.model.get("name")),this.balloons[n].destroy(),this.balloons.splice(n,1),t.deregisterBalloon(e.get("id")));return 0===this.balloons.length?(this.destroy(),null):this},select:function(){this._logger.debug("Selecting issue %s",this.model.get("title")),this.isSelected=!0;for(var e=0;e<this.balloons.length;e++)this.balloons[e].select();return this.utils.highlight(this),this.preview.enhance(),this},unselect:function(){this._logger.debug("Unselecting issue %s",this.model.get("title")),this.isSelected=!1;for(var e=0;e<this.balloons.length;e++)this.balloons[e].unselect();return this.utils.unhighlight(this),this.preview.brake(),this},show:function(){for(var e=[],n=0;n<this.balloons.length;n++)e.push(this.balloons[n].show());return t.all(e)},hide:function(){for(var e=[],n=0;n<this.balloons.length;n++)e.push(this.balloons[n].hide());return t.all(e)},_subscribers:function(){this.listenTo(this,"onMouseOver",this._onMouseOver),this.listenTo(this,"onMouseLeave",this._onMouseLeave),this.listenTo(this,"onClick",this._onClick),this.listenTo(this,"onDoubleClick",this._onDoubleClick),this.listenTo(this,"onContextMenu",this._onContextMenu),this.listenTo(this.model,"onChange",this._onChange),this.listenTo(this.model.get("markers"),"onRemove",this._onRemoveMarker),this.listenTo(this.model.get("markers"),"onAdd",this._onAddMarker),this.listenTo(this,"onChange:position",this._onChangePosition)},_onMouseOver:function(e){this._logger.debug("Issue %s mouseover with %s balloons",this.model.get("title"),this.balloons.length),this.isHovered=!0;for(var t=0;t<this.balloons.length;t++)this.balloons[t].over();var n=e.object;e.object.container=e.balloon,!0!==this._preventPreview&&this.preview.show(n)},_onMouseLeave:function(){this._logger.debug("Issue %s mouseout with %s balloons",this.model.get("title"),this.balloons.length),this.isHovered=!1;for(var e=0;e<this.balloons.length;e++)this.balloons[e].out();this.preview.hide()},_onChangePosition:function(e){var t=this.model.get("markers");null!==t&&t.forEach(function(t){t.get("physicalId")===e.physicalId&&t.get("id")!==e.id&&(t.set("position",t.utils.getPosition(t,e.model.get("original"))),t.set("original",e.model.get("original")))})},_onClick:function(e){return this._logger.debug("Issue %s clicked with multiple selection to %s",this.model.get("title"),e.isMultipleSelection),this._onMouseOver(e),this.preview.enhance(),!0===this.isSelected&&!0===e.isMultipleSelection?(this.unselect(),this.options.manager.dispatchEvent("onUnselect",{id:e.id,issue:this,publish:!0}),!1):(this.options.manager.dispatchEvent("onSelect",{id:e.id,issue:this,isMultipleSelection:e.isMultipleSelection}),this.select(),!0)},_onDoubleClick:function(e){return this._preventPreview=!0,this.preview.brake(),!0!==this.isSelected&&(this.options.manager.dispatchEvent("onSelect",{id:e.id,issue:this,isMultipleSelection:e.isMultipleSelection}),this.select()),this.options.manager.dispatchEvent("onInspect",{id:e.id}),this._preventPreview=!1,!0},_onContextMenu:function(e){this.preview.brake(),this._logger.debug("Issue %s context menu with multiple selection to %s",this.model.get("title"),e.isMultipleSelection),!1===this.isSelected&&(this.select(),this.options.manager.dispatchEvent("onSelect",{id:e.id,issue:this,isMultipleSelection:e.isMultipleSelection}))},_onChange:function(){var e=this;e._logger.debug("The model of the issue %s (%s) changed",e.model.get("title"),e.model.get("name")),e.color=e.options.colors[e.model.get("state")];var t=e.model.get("markers");null!==t&&t.forEach(function(t){t.set({color:e.color})}),e.model.fetchPrimaryImage({onComplete:function(){}})},_onRemoveMarker:function(e,t){this._logger.debug("The balloon %s %s %s from issue %s (%s) has been removed",e.get("type"),e.get("name"),e.get("revision"),this.model.get("title"),this.model.get("name")),this.remove(e,t)},_onAddMarker:function(e){this._logger.debug("The balloon %s %s %s for issue %s (%s) has been added",e.get("type"),e.get("name"),e.get("revision"),this.model.get("title"),this.model.get("name")),this.add(e)},utils:{highlight:function(e){if(e.hasOwnProperty("model")&&null!==e.model){var t=[];e.model.get("markers").forEach(function(e){var n=e.get("path");t.push(n)});var n=[];t.forEach(function(t){if(t.length){var s=e.options.controller.buildPathFromArray(t);s&&n.push({pathElement:s})}}),r.add(n),a.add(n)}},unhighlight:function(e){if(e.hasOwnProperty("model")&&null!==e.model){var t=[];e.model.get("markers").forEach(function(e){var n=e.get("path");t.push(n)});var n=[];t.forEach(function(t){if(t.length){var s=e.options.controller.buildPathFromArray(t);s&&n.push({pathElement:s})}}),r.remove(n),a.remove(n)}},unhighlightMarker:function(e){var t=this,n=[],s=e.get("path");n.push(s);var i=[];n.forEach(function(e){if(e.length){var n=t.options.controller.buildPathFromArray(e);n&&i.push({pathElement:n})}}),r.remove(i),a.remove(i)}}})}),define("DS/Issue3DReview/collections/Markers",["UWA/Class/Collection","DS/Logger/Logger","DS/Issue3DReview/models/Marker"],function(e,t,n){"use strict";return e.extend({name:"DS/Issue3DReview/collections/Markers",model:n,comparator:"state",_logger:null,setup:function(){return this._logger=t.getLogger("DS/Issue3DReview/Model"),this._logger.debug("Initializing the marker collection"),this.addEvents({onRemove:this._onRemove,onAdd:this._onAdd,onReset:this._onReset},this),this},fetch:function(e){e.onComplete()},_onRemove:function(){},_onAdd:function(){},_onReset:function(){}})}),define("DS/Issue3DReview/models/Issue",["UWA/Class/Model","UWA/Core","DS/Logger/Logger","DS/Issue3DReview/collections/Markers","DS/Issue3DReview/utils/ModelParser","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance"],function(e,t,n,s,i,o,r){"use strict";var a="(╯°□°）╯︵ ┻━┻",l=0;return e.extend({name:"DS/Issue3DReview/models/Issue",defaults:{id:"",type:"",name:"",title:"",state:"",description:"",owner:"",reportingOrganization:"",created:"",modified:"",resolutionDate:"",estimatedStartDate:"",estimatedEndDate:"",actualStartDate:"",actualEndDate:"",contexts:{},reportedAgainst:[],resolvedBy:[],resolvedItems:[],assignees:[],markers:null,primaryImage:null},_logger:null,setup:function(){this._logger=n.getLogger("DS/Issue3DReview/Model"),this._logger.debug("%s (%s) has been initialized with %s reported against",this.get("title"),this.get("name"),this.get("reportedAgainst").length)},fetch:function(e){var t=this;r.start(t.name+" fetch"),o.issues.retrieve({timestamp:e.timestamp?e.timestamp:null,data:{objects:[{physicalId:t.get("id")}]},onComplete:function(n){var s=i.parse(n.results[l].body,e);s=t.parse(s,e),t.merge(s,e),t.set(s),e&&"function"==typeof e.onComplete&&e.onComplete(s),r.end(t.name+" fetch")},onFailure:function(n){e&&"function"==typeof e.onFailure&&e.onFailure(n),r.end(t.name+" fetch")}})},merge:function(e,n){var s=this;r.start(s.name+" merge");var i=e.reportedAgainst.reduce(function(e,t){return e[t.path.join()]=t,e},{}),o=s.get("markers")||e.markers,a=[];o.forEach(function(e){a.push(e.get("path_str"))}),a.forEach(function(e){if(!t.is(i[e],"object"))for(var r=o.where({path_str:e}),a=0;a<r.length;a++)o.remove(r[a]),n.collection.setNodeAsNeutral(e),s.unset(e,{silent:n.silent})});var l=!1;t.is(e.markers,"object")||(e.markers=s.get("markers"),l=!0),s._addMarkers(e,n),!0===l&&delete e.markers,r.end(s.name+" merge")},fetchPrimaryImage:function(e){var n=this;n._logger.debug("Fetching primary image for issue %s (%s)",n.get("title"),n.get("name")),r.start(n.name+" primaryImage"),o.images.retrieve({data:{objects:[{physicalId:n.get("id")}]},onComplete:function(s){var i=s.results[l].body;n._logger.debug("Primary image for the issue %s have been fetched",n.get("title")+"("+n.get("name")+")");var o=null;t.is(i,"object")&&t.is(i.fileName,"string")&&""!==i.fileName&&t.is(i.url,"string")&&""!==i.url&&(o=i,n.set("primaryImage",i,{silent:!0})),e.onComplete(o),r.end(n.name+" primaryImage")},onFailure:function(t){n._logger.debug("Fetch primary image failed for issue %s (%s)",n.get("title"),n.get("name")),e.onFailure(t),r.end(n.name+" primaryImage")}})},parse:function(e,t){return r.start(this.name+" parse"),!0===t.add&&(e.markers=new s([],{}),this._addMarkers(e,t)),r.end(this.name+" parse"),e},save:function(e,n){var s=this;s._logger.debug("Saving issue %s (%)",s.get("title"),s.get("name")),r.start(s.name+" save");var i=t.clone(e);i.physicalId=s.get("id"),o.issues.update({id:s.get("id"),data:{objects:[i]},onComplete:function(e){n&&"function"==typeof n.onComplete&&n.onComplete(e.results),r.end(s.name+" save")},onFailure:function(e){n&&"function"==typeof n.onFailure&&n.onFailure(e),r.end(s.name+" save")}})},destroy:function(){this._logger.debug("Destroying issue %s (%s)",this.get("title"),this.get("name")),this.clear({silent:!0}).set(this.defaults)},_addMarkers:function(e,t){var n=this,s=e.markers.groupBy("path_str");e.reportedAgainst.forEach(function(i){var o=i.physicalId,r=i.path,l=t.collection.getNodesById(o),c=l.nodes,u=l.paths;if(c.length>0&&!s[r.join()])for(var d=0;d<c.length;d++){if(u[d].toString().includes(r.toString())){e.markers.add({id:e.id+a+r.join()+a+d,issue:n,type:i.type,name:i.name,revision:i.revision,title:i.title,position:i.position,node:c[d],path:u[d],path_str:r.join()},{silent:t.silent});var h=r.join();n.set(h,h,{silent:t.silent}),t.collection.setNodeAsReported(h)}}})}})}),define("DS/Issue3DReview/views/ConflictBalloon",["UWA/Class","UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/Core/PointerEvents","DS/Logger/Logger","DS/UIKIT/Popover","DS/VisuEvents/EventsManager","DS/Issue3DReview/components/ContextualMenu","DS/IssueServices/utils/Performance","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","i18n!DS/IssueCommon/assets/nls/IssueCommon","css!DS/Issue3DReview/Issue3DReview.css"],function(e,t,n,s,i,o,r,a,l,c,u,d){"use strict";var h="Create",p="Assign",g="Active",m="Review",f="Closed",v="1",w="#F9F9F9",b="#3D3D3D",D="#3D3D3D",S=0,I=function(e,t,n,s){return'<svg class="balloon-svg" width="25" height="45" viewBox="0 0 25 45" preserveAspectRatio="xMaxYMax" xmlns="http://www.w3.org/2000/svg"><g><g class="balloon-container" opacity="'+t+'"><path class="balloon-path" stroke-width="1" stroke="'+n+'" fill="'+e+'" d="m12.50023,0.61752c-6.51488,0 -11.79788,5.59224 -11.79788,12.48846c0,2.80815 0.87686,5.40025 2.35194,7.48519c0.005,0.00289 0.00727,0.00818 0.00727,0.01059c0.28047,0.43643 9.31685,14.46321 9.43822,23.78072c0.12182,-9.31751 9.15775,-23.34429 9.43867,-23.78072c0.005,-0.0077 0.00727,-0.01059 0.00727,-0.01059c1.47599,-2.08494 2.35194,-4.67704 2.35194,-7.48519c0,-6.89575 -5.28209,-12.48846 -11.79743,-12.48846zm0,6.57288c2.94833,0 5.34028,2.53195 5.34028,5.65287c0,3.12091 -2.39194,5.65287 -5.34028,5.65287s-5.33982,-2.53195 -5.33982,-5.65287c0,-3.12091 2.39149,-5.65287 5.33982,-5.65287z" /></g><ellipse class="balloon-inner" opacity="'+t+'" stroke="'+s+'" ry="4.16736" rx="3.95816" id="svg_6" cy="12.83264" cx="12.5" stroke-width="2" fill="'+s+'" /></g></svg><div class="pulse"></div>'},y=function(e){return'<div class="issue-preview-conflict"><div class="issue-preview-conflict-body">'+e+'</div><div class="issue-preview-conflict-enhanced"></div></div>'};return n.extend({name:"DS/Issue3DReview/views/ConflictBalloon",tagName:"div",className:"issue-balloon-conflict issue-balloon-fade-in-element",setup:function(e){this._logger=o.getLogger("DS/Issue3DReview/View"),this._visualizationEvents=[],this.isSelected=!1,this.options=s.merge(e||{},this.defaultOptions)},destroy:function(){this.isSelected=!1;for(var e=0;e<this.options.balloons.length;e++)this.stopListening(this.options.balloons[e],"onSelect"),this.stopListening(this.options.balloons[e],"onUnselect"),this.stopListening(this.options.balloons[e],"onDestroy");this._visualizationEvents.forEach(function(e){a.removeEvent(e.container,e.event,e.cb)}),this._visualizationEvents=[],null!==this._preview&&(this._preview.destroy(),this._preview=null),this.container.empty(),this.container.destroy()},render:function(){this.container.setStyle("display","block"),this.container.setStyle("position","absolute"),this.container.setStyle("pointer-events","auto"),this.container.setStyle("left",this.options.posX),this.container.setStyle("top",this.options.posY),this.container.setStyle("z-index",1e3);var e=I(w,v,b,D),t=s.createElement("div",{class:"issue-balloon-information",html:[{tag:"span",class:"issue-counter",html:this.options.count.toString()}]});return this._createPopover(),this._subscribers(),this.balloonContainer=s.createElement("div",{class:"issue-balloon",html:[e,t]}),this.container.setContent(this.balloonContainer),this},_createPopover:function(){var e=this.options.issues,t={};t[h]=0,t[p]=0,t[g]=0,t[m]=0,t[f]=0;for(var n=0;n<e.length;n++){t[e[n].get("state")]+=1}for(var s=Object.keys(t),i="",o=0;o<s.length;o++)0!==t[s[o]]&&(i+='<span class="issue-label-'+s[o].toLowerCase()+'"></span>'+t[s[o]].toString()+" "+d.maturity[s[o].toLowerCase()]+"</br>");this._preview=new r({target:this.container,trigger:"manual",position:"right",autoHideOnClickOutside:!1,autoHide:!1,delay:{show:200,hide:200},body:y(i)})},_subscribers:function(){for(var e=this,t=0;t<e.options.balloons.length;t++)e.listenTo(e.options.balloons[t],"onSelect",function(){e.select()}),e.listenTo(e.options.balloons[t],"onUnselect",function(){e.options.balloons.every(function(e){return!1===e.isSelected})&&e.unselect()}),e.listenTo(e.options.balloons[t],"onDestroy",function(){e.options.parent._throttledRender()});e.container.addEventListener("mouseover",function(){e.balloonContainer.toggleClassName("hover",!0),e._preview.show()}),e.container.addEventListener("mouseleave",function(){e.balloonContainer.toggleClassName("hover",!1),e._preview.hide()}),e._visualizationEvents=[{container:e.container,event:"onPrimaryPointerClick",cb:function(t){var n=e.options.issues.map(function(e){return e.get("id")}),s=t.from[S].event.ctrlKey;e.isSelected&&s?e.options.manager.unselect({ids:n,publish:!0}):e.options.manager.select({ids:n,publish:!0,unselectAll:!s})}},{container:e.container,event:"onPrimaryPointerDoubleClick",cb:function(t){var n=e.options.issues.map(function(e){return e.get("id")});e.options.manager.select({ids:n,publish:!0,unselectAll:!t.from[S].event.ctrlKey}),e.options.manager.dispatchEvent("onInspect")}}],e._visualizationEvents.forEach(function(e){a.addEvent(e.container,e.event,e.cb)}),e.container.addEventListener("contextmenu",function(t){t.preventDefault(),t.stopPropagation();var n=e.options.issues.map(function(e){return e.get("id")});e.options.manager.select({ids:n,publish:!0,unselectAll:!0})}),l.getWUXContextualMenu().addEventListener(e.container,{callback:function(){return l.getContextualMenu()}})},select:function(){this.isSelected=!0,this.balloonContainer.toggleClassName("selection",!0)},unselect:function(){this.isSelected=!1,this.balloonContainer.toggleClassName("selection",!1)}})}),define("DS/Issue3DReview/collections/Issues",["UWA/Class/Collection","DS/Logger/Logger","DS/Issue3DReview/models/Issue","DS/Issue3DReview/utils/ModelParser","DS/IssueComponents/utils/Utils","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance"],function(e,t,n,s,i,o,r,a){"use strict";return e.extend({name:"DS/Issue3DReview/collections/Issues",model:n,comparator:"name",_logger:null,_nodes:{},_paths:{},_neutralNodes:{},_reportedNodes:{},setup:function(e,n){for(var s in this._logger=t.getLogger(this.name),this._logger.debug("Initializing the issue collection"),a.start(this.name+" setup"),this.addEvents({onRemove:this._onRemove,onAdd:this._onAdd,onReset:this._onReset},this),this._nodes=n.nodes,this._paths=n.paths,this._neutralNodes={},n.nodes)n.nodes.hasOwnProperty(s)&&(this._neutralNodes[s]=n.nodes[s]);return this._reportedNodes={},a.end(this.name+" setup"),this},fetch:function(e){var t=this;t._logger.info("Fetching all issues..."),a.start(t.name+" fetch");var n=o.get("widget")||window.widget,s=n.getValue("filter");!0===i.isJson(s)?(s=JSON.parse(s),n.getPreference("organizationFilter").value||(s.reported=!1,s.responsible=!1,n.setValue("filter",JSON.stringify(s)))):s={},r.issues.filter({version:"2.0",data:{filter:s}}).then(function(n){var s=n.body,i=[];t._logger.debug("Issues fetched");for(var o=0;o<s.length;o++)for(var r=0;r<s[o].reportedAgainst.length;r++){t.getNodesById(s[o].reportedAgainst[r].physicalId).nodes.length>0&&i.push(s[o])}t.reset(i,{parse:!0}),e&&"function"==typeof e.onComplete&&e.onComplete(i),a.end(t.name+" fetch")}).catch(function(n){t._logger.error("Fetch issues failed"),e&&"function"==typeof e.onFailure&&e.onFailure(n),a.end(t.name+" fetch")})},parse:function(e,t){return this._logger.debug("Parsing issues..."),a.start(this.name+" parse"),e=s.parse(e,t),a.end(this.name+" parse"),e},getNodes:function(){return this._nodes},getNodesById:function(e){var t=[],n=this._paths[e];if(n&&n.length>0)for(var s=0;s<n.length;s++)t.push(this._nodes[n[s].join(",")]);return{nodes:t,paths:n}},getNeutralNodes:function(){return this._neutralNodes},getReportedNodes:function(){return this._reportedNodes},setNodeAsReported:function(e){var t=e.split(","),n=t[t.length-1],s=this._paths[n];if(s&&s.length>0)for(var i=0;i<s.length;i++){var o=s[i].join(",");o.includes(e)&&(delete this._neutralNodes[o],this._reportedNodes[o]=this._nodes[o])}},setNodeAsNeutral:function(e){var t=e.split(","),n=t[t.length-1],s=this._paths[n];if(s&&s.length>0)for(var i=0;i<s.length;i++){var o=s[i].join(",");o.includes(e)&&(delete this._reportedNodes[o],this._neutralNodes[o]=this._neutralNodes[o])}},_onRemove:function(){},_onAdd:function(){},_onReset:function(){}})}),define("DS/Issue3DReview/views/BalloonMerger",["UWA/Class","UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/Core/Events","DS/Logger/Logger","DS/Issue3DReview/views/ConflictBalloon","DS/IssueCommon/utils/Utils","DS/IssueServices/Contexts","DS/IssueServices/utils/Performance","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","css!DS/Issue3DReview/Issue3DReview.css"],function(e,t,n,s,i,o,r,a,l){"use strict";var c={X:25,Y:45},u=100;return n.extend({name:"DS/Issue3DReview/views/BalloonMerger",_logger:null,manager:null,conflictBalloons:[],visualizationEventToken:null,defaultOptions:{manager:null},setup:function(e){var t=this;return t._logger=o.getLogger("DS/Issue3DReview/View"),t._parent(e),t.manager=t.getOption("manager"),t.conflictBalloons=[],t._throttledRender=a.throttle(t.render.bind(t),u),t.visualizationEventToken=i.subscribe({event:"/VISU/"},function(e){if("@onViewpointChange"===e.eventType){if(!t.isRendering)for(var n=0;n<t.conflictBalloons.length;n++)t.conflictBalloons[n].hide();t.isRendering=!0,t._throttledRender({})}}),t},render:function(){var e=l.get("widget")||window.widget;if(this.isRendering=!0,this.clean(),s.is(this.manager)&&s.is(this.manager.inspector)&&!0!==this.manager.inspector.isInspected()){var t={dom:e.body.getElement("#divCss2DElement"),width:0,height:0};if(s.is(t.dom)){t.width=t.dom.getDimensions().width,t.height=t.dom.getDimensions().height;var n=t.dom.getElements(".issue-balloon:not(.issue-balloon-temporary)");if(n.length>0){for(var i=[],o=0;o<n.length;o++){var a=n[o],u=a.getParent().getPosition().x,d=a.getParent().getPosition().y;if(!(u<0||u>t.width)||!(d<0||d>t.height)){var h={markerId:a.getData("markerId"),absX:u,absY:d,gridX:Math.round(u/c.X),gridY:Math.round(d/c.Y)};i.push(h)}}for(var p=i.reduce(function(e,t){var n=t.gridX+";"+t.gridY;return e.hasOwnProperty(n)||(e[n]=[]),e[n].push(t),e},{}),g=Object.keys(p),m=0;m<g.length;m++){var f=p[g[m]];if(f=this.removeDuplicateIssues(f),(f=this.removeDuplicateIssues(f)).length>1){for(var v={x:0,y:0},w=0,b=[],D=[],S=0;S<f.length;S++){var I=this.manager.getBalloon(f[S].markerId);null!==I&&(v.x+=f[S].absX,v.y+=f[S].absY,w++,D.push(I),b.push(I.model.get("issue")),I.disable())}if(v.x=v.x/w,v.y=v.y/w,w>0){var y=new r({parent:this,posX:v.x,posY:v.y,count:f.length,issues:b,balloons:D,manager:this.manager});y.render(),y.inject(t.dom),this.conflictBalloons.push(y)}}else if(1===f.length){var _=this.manager.getBalloon(f[0].markerId);_&&_.enable()}}}}}this.isRendering=!1},clean:function(){for(var e=0;e<this.conflictBalloons.length;e++)this.conflictBalloons[e].destroy();this.conflictBalloons=[]},destroy:function(){this.visualizationEventToken&&(i.unsubscribe(this.visualizationEventToken),this.visualizationEventToken=null),this.clean(),this.manager=null},removeDuplicateIssues:function(e){let t={},n=[];return e.forEach(e=>{t[e.markerId.substring(0,e.markerId.length-1)]||(t[e.markerId.substring(0,e.markerId.length-1)]=!0,n.push(e))}),n}})}),define("DS/Issue3DReview/views/Manager",["UWA/Class","UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Mask","DS/UIKIT/Popover","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/PlatformAPI/PlatformAPI","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Visualization/SceneGraphUtils","DS/Issue3DReview/collections/Issues","DS/Issue3DReview/commands/CommandsManager","DS/Issue3DReview/models/Issue","DS/Issue3DReview/views/BalloonMerger","DS/Issue3DReview/views/Inspector","DS/Issue3DReview/views/Sack","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance","DS/IssueServices/Contexts","text!DS/Issue3DReview/assets/Issue3DReview.PADSettings.json","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(e,t,n,s,i,o,r,a,l,c,u,d,h,p,g,m,f,v,w,b,D,S,I){"use strict";var y,_,C,E;return n.extend({name:"DS/Issue3DReview/views/Manager",_logger:null,defaultOptions:{component:null,context:null,roots:[],callback:null},component:null,nodes:{},paths:{},collection:null,inspector:null,balloonMerger:null,_issues:[],_mapper:{},_balloons:{},_linker:{},_selectedIssues:{},_subscriberTokens:[],setup:function(e){var t=this;D.start(t.name+" setup"),t._parent(e),t.settings=JSON.parse(I),t.isAnyFilterSelected=!1,t._logger=a.getLogger("DS/Issue3DReview/View"),t._logger.debug("Initializing the manager..."),t.component=e.component;var n=t.utils.parseChildren2(e.context.controller);t.nodes=n.nodes,t.paths=n.paths,t.collection=new p([],{nodes:t.nodes,paths:t.paths}),t.inspector=new v({manager:t.getManager()}),t.balloonMerger=new f({manager:t.getManager()}),t._issues=[],t._mapper={},t._balloons={},t._linker={},t._selectedIssues={};var s=Object.keys(t.nodes),i=Object.keys(t.paths);t.isAnyFilterSelected=t.isFilteringRequestEligible();var o=!1;t.settings.hideNoFilterSelectionPreference&&t.isAnyFilterSelected?o=!0:t.settings.hideNoFilterSelectionPreference||(o=!0),s.length>0&&i.length>0&&o?t.collection.fetch({onComplete:function(e){t.render(),null!==t.getOption("callback")&&t.getOption("callback")(e)}}):null!==t.getOption("callback")&&t.getOption("callback")([]),t._subscriberTokens=[],t._subscribers(),D.end(t.name+" setup")},isFilteringRequestEligible:function(){let e=S.get("filter");var t=!1;if(e){let n=e.elements.menu.items.filter(e=>{if(e.selected)return t=!0,e.name}).map(e=>e.name);1==n.length&&"closed"==n[0]&&this.settings.hideNoFilterSelectionPreference&&(t=!1)}return t},render:function(){var e=this;return e._logger.debug("%s issue(s) to be displayed",e.collection.length),e.collection.forEach(function(t){var n=new w({manager:e,model:t,viewer:e.getOption("context").viewer,controller:e.getOption("context").controller,window:e.getOption("context").window}).render();e._issues.push(n),e._mapper[t.get("id")]=n}),e},destroy:function(){var e=this;e._logger.info("Destroying the manager..."),e.stopListening(e,"onSelect"),e.stopListening(e,"onUnselect"),e.stopListening(e,"onInspect"),e.stopListening(e.collection,"onReset"),e.stopListening(e.collection,"onRemove"),e.stopListening(e.collection,"onAdd"),e._subscriberTokens.forEach(function(e){u.unsubscribe(e)}),e._subscriberTokens=[],e.unselectAll({publish:!1}),e.inspector.destroy(),e.inspector=null,e.balloonMerger.destroy(),e.balloonMerger=null;for(var n=[],s=0;s<e._issues.length;s++)n.push(e._issues[s].destroy());return e.component=null,e.nodes={},e.paths={},t.all(n).then(function(){e.collection=null,e._issues=[],e._mapper={},e._balloons={},e._linker={},e._selectedIssues={},e._subscriberTokens=[]})},refreshIssuesById:function(e){var n=this;D.start(n.name+" refreshIssuesById");var i=e.ids,o=[];return i.forEach(function(i){o.push(new t(function(t){var o=n.collection.get(i);if(o&&s.is(o,"object"))o.fetch({timestamp:e.timestamp,onComplete:function(e){t(e)},collection:n.collection}),o.fetchPrimaryImage({onComplete:function(){},onFailure:function(e){n._logger.error(e)}});else{var r=new m({id:i});r.fetch({timestamp:e.timestamp,add:!0,onComplete:function(e){r.get("markers")&&r.get("markers").length>0?(n.collection.add(r,{}),t(e)):r=null},collection:n.collection,parse:!0})}}))}),t.all(o)},removeIssuesById:function(e){var n=this;return e.ids.forEach(function(e){n.collection.remove(e)}),t.resolve()},show:function(){for(var e=[],n=0;n<this._issues.length;n++)e.push(this._issues[n].show());return t.all(e)},hide:function(){for(var e=[],n=0;n<this._issues.length;n++)e.push(this._issues[n].hide());return t.all(e)},optimizeBalloonVisualization:function(){s.is(this.balloonMerger)&&this.balloonMerger._throttledRender()},select:function(e){var t=e.ids,n=!0===e.unselectAll,s=!0===e.publish;!0===n&&this.unselectAll({publish:!1});for(var i=0;i<t.length;i++){var o=this._mapper[t[i]];void 0!==o&&(this._selectedIssues[t[i]]=o,o.select(),o.utils.highlight(o))}g.select(Object.keys(this._selectedIssues)),this.component.dispatchEvent("onSelect"),!0===s&&this.pushBroadcastSelect()},unselect:function(e){for(var t=e.ids,n=!0===e.publish,s=0;s<t.length;s++)!0!==e.internal&&this._selectedIssues[t[s]].unselect(),delete this._selectedIssues[t[s]];g.select(Object.keys(this._selectedIssues)),this.component.dispatchEvent("onUnselect"),!0===n&&this.pushBroadcastSelect()},unselectAll:function(e){var t=!0===e.publish;this.unselect({ids:Object.keys(this._selectedIssues),publish:t}),this._selectedIssues={}},buildBroadcastSelect:function(){D.start(this.name+" buildBroadcastSelect");var e=[],t={};return this.getSelectedIssues().forEach(function(n){e.push([n.id]),t[n.id]={id:n.id,type:n.type,name:n.name,title:n.title}}),D.end(this.name+" buildBroadcastSelect"),{paths:e,attributes:t}},pushBroadcastSelect:(y=function(){if(D.start(this.name+" pushBroadcastSelect"),null!==this.component){var e=this.buildBroadcastSelect();this.component.publishSelect(e),this.component.publishCompass()}D.end(this.name+" pushBroadcastSelect")},_=100,function(){var e=this,t=arguments,n=C&&!E;clearTimeout(E),E=setTimeout(function(){E=null,C||y.apply(e,t)},_),n&&y.apply(e,t)}),inspect:function(e){return this.inspector.inspect({ids:e})},release:function(){var e=this;return e.inspector.release().then(function(){e.optimizeBalloonVisualization()})},groupBy:function(e){return this.collection.groupBy(e)[e]},getManager:function(){return this},getCollection:function(){return this.collection},getIssues:function(){return{map:this._mapper,array:this._issues}},getNodes:function(){return this.nodes},getNodesById:function(e){return this.collection.getNodesById(e)},getNeutralNodes:function(){return this.collection.getNeutralNodes()},getReportedNodes:function(){return this.collection.getReportedNodes()},getSelectedIssues:function(){var e=[];for(var t in this._selectedIssues)if(this._selectedIssues.hasOwnProperty(t)){var n=this._selectedIssues[t].model,s={id:n.get("id"),type:n.get("type"),title:n.get("title"),name:n.get("name"),baseType:n.get("baseType")};e.push(s)}return e},getInspectedIssues:function(){return this.inspector.getInspectedIssues()},getReportedAgainstFromSelectedIssues:function(){for(var e=this.getSelectedIssues(),t=this.getIssues().map,n=[],i=0;i<e.length;i++)s.is(t[e[i].id],"object")&&(n=n.concat(t[e[i].id].model.get("reportedAgainst")));return n.reduce(function(e,t){return e.push(t.physicalId),e},[])},registerBalloon:function(e,t){var n=this;n._balloons[e]=t,t.promiseWhileRendering.then(function(){n.optimizeBalloonVisualization()})},deregisterBalloon:function(e){delete this._balloons[e]},getBalloon:function(e){return this._balloons.hasOwnProperty(e)?this._balloons[e]:null},_onSelect:function(e){var t=e.issue.model.get("id");if(!1===e.isMultipleSelection){var n=Object.keys(this._selectedIssues);1===n.length&&-1!==n.indexOf(t)||(this.unselectAll({publish:!1}),d.empty())}this.select({ids:[t],publish:!0,unselectAll:!1})},_onUnselect:function(e){this.unselect({ids:[e.issue.model.get("id")]});for(var t=Object.keys(this._selectedIssues),n=0;n<t.length;n++)this._selectedIssues[t[n]].utils.highlight(this._selectedIssues[t[n]]);!0===e.publish&&this.pushBroadcastSelect()},_onInspect:function(){g.getCommand("Inspect").begin()},_subscribers:function(){this.listenTo(this,"onSelect",this._onSelect),this.listenTo(this,"onUnselect",this._onUnselect),this.listenTo(this,"onInspect",this._onInspect),this._listenToCSO(),this.listenTo(this.collection,"onReset",this._onReset),this.listenTo(this.collection,"onRemove",this._onRemove),this.listenTo(this.collection,"onAdd",this._onAdd)},_listenToCSO:function(){var e=this;e._stopListeningToCSO(),e._subscriberTokens.push(u.onEmpty(function(){e.unselectAll({publish:!0})}))},_stopListeningToCSO:function(){this._subscriberTokens.forEach(function(e){u.unsubscribe(e)}),this._subscriberTokens=[]},_onReset:function(){},_onRemove:function(e,t,n){this.unselect({ids:[e.get("id")],internal:n.internal,publish:!1}),s.is(n,"object")&&!0===n.internal||s.is(this._mapper[e.get("id")])&&this._mapper[e.get("id")].destroy();for(var i=[],o=e.get("id"),r=0;r<this._issues.length;r++)this._issues[r].model.get("id")!==o&&i.push(this._issues[r]);this._issues=i,delete this._mapper[e.get("id")]},_onAdd:function(e){this._logger.debug("The issue %s (%s) has been added to the collection, now creating the view",e.get("title"),e.get("name"));var t=new w({manager:this,model:e,viewer:this.getOption("context").viewer,controller:this.getOption("context").controller,window:this.getOption("context").window}).render();this._issues.push(t),this._mapper[e.get("id")]=t},utils:{parseChildren2:function(e){for(var t={},n={},s=e._model._OOCManager.getAllReferences(),i=0;i<s.length;i++){var o=s[i],r=e.getIdPathesLeadingToReference(o);n[o]=[];for(var a=0;a<r.length;a++){var l=r[a].ids;t[l]=o,n[o].push(l)}}return{nodes:t,paths:n}}}})}),define("DS/Issue3DReview/Component",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/PlatformAPI/PlatformAPI","DS/IssueCommon/utils/TaskManager","DS/IssueComponents/open/Open","DS/Issue3DReview/commands/CommandsManager","DS/Issue3DReview/views/Manager","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance","DS/IssueServices/utils/Views","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","css!DS/Issue3DReview/Issue3DReview.css","css!DS/UIKIT/UIKIT.css"],function(e,t,n,s,i,o,r,a,l,c,u,d,h,p){"use strict";var g="ENXISSU_AP",m="ENX3DIR_AP",f=0,v={ISU_TASK_MANAGER:"ISU_TASK_MANAGER"},w={SELECT_IN_3D:"SELECT_IN_3D",TAKE_SCREENSHOT:"TAKE_SCREENSHOT"},b=/[/\\?%*:|"<>]/g;return t.extend({name:"DS/Issue3DReview/Component",_logger:null,manager:null,context:{},taskManager:null,_issues:{},_nodes:{},_temporary:[],_isProcessing:!1,_subscriberTokens:[],_tasks:{subscriberTokens:[],current:null},_timestampUpdate:0,setup:function(e){d.start(this.name+" setup"),this._parent(e),this._logger=s.getLogger(this.name),this._logger.log("Initializing the main component..."),this.manager=null;var t=c.get("pad3DViewer");return this.context={root:t,viewer:t.getViewer(),window:t.getFrameWindow(),controller:t.getController()},this.taskManager=o,t.getViewpoint().getControl().lockZ=!1,t.getViewpoint().getControl().rotateSpeed=1,this._issues={},this._nodes={},this._filteredIssues=null,this._temporary=[],this._isProcessing=!1,this._subscriberTokens=[],this._tasks={subscriberTokens:[],current:null},this._timestampUpdate=0,this.utils._setTypesCallbackSubscribe=!1,this._subscribers(),this._subscribersTaskManager(),this},render:function(){return this},resize:function(){null!==this.manager&&this.manager.optimizeBalloonVisualization()},display:function(t){var s=this;return!0===s.isProcessing()?e.reject(new Error("A command is already processing, please wait")):(s._isProcessing=!0,s._logger.info("Displaying all the issues, parsing roots and instantiating manager"),new e(function(e){null!==s.manager?s.manager.destroy().then(function(){s.manager=null,e()}):e()}).then(function(){return new e(function(e){s.manager=new l({component:s,roots:t,context:s.context,callback:function(){s._isProcessing=!1,s.dispatchEvent("onDisplay"),e()}});var i=s.getOption("events");s.listenTo(s.manager.getCollection(),"onAdd",function(){i&&n.is(i.onIssuesAdded,"function")&&i.onIssuesAdded()}),s.listenTo(s.manager.getCollection(),"onRemove",function(){i&&n.is(i.onIssuesRemoved,"function")&&i.onIssuesRemoved()})})}))},destroy:function(){this._subscriberTokens.forEach(function(e){i.unsubscribe(e)}),this._tasks.subscriberTokens.forEach(function(e){i.unsubscribe(e)}),null!==this.manager&&(this.manager.getCollection().stopListening("onAdd"),this.manager.getCollection().stopListening("onRemove"),this.manager.destroy(),this.manager=null),this._timestampUpdate=0,this._subscriberTokens=[],this.utils._setTypesCallbackSubscribe=!1,this._tasks={subscriberTokens:[],current:null},this.taskManager.destroy(),this.taskManager=null},clear:function(){var t=this;if(!0===t.isProcessing())return e.reject(new Error("A command is already processing, please wait"));if(null===t.manager)return e.resolve();!0===t.isFocused()&&a.getCommandCheckHeader("Focus").toggleState();return t._isProcessing=!0,t.isInspected()?t.release().then(function(){return t.manager.destroy()}).then(function(){t.manager=null,t._isProcessing=!1,t.dispatchEvent("onClear")}):t.manager.destroy().then(function(){t.manager=null,t._isProcessing=!1,t.dispatchEvent("onClear")})},refresh:function(t,n){var s=this;return!0===s.isProcessing()?e.reject(new Error("A command is already processing, please wait")):(c.get("filter").refresh(),Array.isArray(n)&&s.setFilteredIssues(n),null===s.manager?e.resolve():s.clear().then(function(){return s.display(t)}))},focus:function(){a.getCommandCheckHeader("Focus").toggleState()},inspect:function(t){var n=this;return null===n.manager?e.resolve():n.manager.inspect(t).then(function(){n.dispatchEvent("onInspect")})},release:function(){var t=this;return null===t.manager?e.resolve():t.manager.release().then(function(){t.dispatchEvent("onRelease")})},publishSelect:function(e){var t=c.get("widget")||window.widget;i.publish("DS/Object/select",{metadata:{appId:t.id,appName:t.name,timestamp:Math.floor(Date.now())},data:{paths:e.paths,attributes:e.attributes},version:"1.0"})},publishCompass:function(){if(null!==this.manager){var e=this.manager.getSelectedIssues();this.utils.setTypesCallbackForOFW(e)}},isDisplayed:function(){return a.getCommandCheckHeader("Display").getState()},isFocused:function(){return a.getCommandCheckHeader("Focus").getState()},isInspected:function(){var e=this.getManager();return null!==e&&null!==e.inspector&&e.inspector.isInspected()},isProcessing:function(){return this._isProcessing},getManager:function(){return this.manager},getIssues:function(){return null===this.manager?[]:this.manager.getIssues()},getSelectedIssues:function(){return null===this.manager?[]:this.manager.getSelectedIssues()},getInspectedIssues:function(){return null===this.manager?[]:this.manager.getInspectedIssues()},get3DContext:function(){return this.context},listenToCSO:function(){this.manager&&this.manager._listenToCSO()},stopListeningToCSO:function(){this.manager&&this.manager._stopListeningToCSO()},setFilteredIssues:function(e){this._filteredIssues=e},getSessionOrFilteredRoots:function(){var e=[],t=c.get("widget");try{var s=JSON.parse(t.getValue("filter"));!0===s.synchronize&&Array.isArray(this._filteredIssues)?e=n.clone(this._filteredIssues):!0===s.session&&(e=t.getValue("roots"))}catch(e){this._logger.error(e)}return e},_subscribers:function(){var t=this,s=c.get("widget")||window.widget;t._subscriberTokens.push(i.subscribe("DS/Object/create",function(e){if(d.start(t.name+" DS/Object/create"),null!==t.manager){var n=e.data.attributes;t.manager.refreshIssuesById({timestamp:e.metadata.timestamp,ids:Object.keys(n)}).then(function(){d.end(t.name+" DS/Object/create")})}})),t._subscriberTokens.push(i.subscribe("DS/Object/update",function(n){if(null!==t.manager&&t._timestampUpdate!==n.metadata.timestamp){d.start(t.name+" DS/Object/update"),t._timestampUpdate=n.metadata.timestamp;var s=n.data.attributes;t.manager.refreshIssuesById({timestamp:n.metadata.timestamp,ids:Object.keys(s)}).then(function(){return t.isInspected()?t.getManager().inspector.refresh():e.resolve()}).then(function(){t.dispatchEvent("onUpdate"),d.end(t.name+" DS/Object/update")})}})),t._subscriberTokens.push(i.subscribe("DS/Object/delete",function(e){if(d.start(t.name+" DS/Object/delete"),null!==t.manager){var n=[];e.data.paths.forEach(function(e){n.push(e.pop())}),t.manager.removeIssuesById({timestamp:e.metadata.timestamp,ids:n}).then(function(){t.dispatchEvent("onDelete"),d.end(t.name+" DS/Object/delete")})}})),t._subscriberTokens.push(i.subscribe("DS/Object/select",function(e){if(null!==t.manager&&e.metadata.appId!==s.id){null!==t._tasks.current&&t._tasks.current.taskType===w.SELECT_IN_3D&&t.taskManager.cancel(t._tasks.current.taskId);var n=Object.keys(e.data.attributes);t.manager.select({ids:n,publish:!1,unselectAll:!0}),t.dispatchEvent("onSelect")}})),t._subscriberTokens.push(i.subscribe("DS/ENXISSU_AP/Filter/Issues",function(e){if(e.metadata.appId!==s.id&&e.metadata.appName===g)try{var i=JSON.parse(s.getValue("filter")),o=n.is(e.data,"object")&&n.is(e.data.filter,"object")&&Array.isArray(e.data.filter.issues)?n.clone(e.data.filter.issues):null;!0===i.synchronize&&Array.isArray(o)&&setTimeout(function(){c.get("application").refresh(o)},0)}catch(e){t._logger.error(e)}}))},_subscribersTaskManager:function(){var t=this,s=c.get("widget")||window.widget;t._tasks.subscriberTokens.push(i.subscribe("DS/IssueManagementTask/add",function(e){if(d.start(t.name+" DS/IssueManagementTask/add"),n.is(e.metadata,"object")&&n.is(e.metadata.options,"object")&&n.equals(e.metadata.options[v.ISU_TASK_MANAGER],v.ISU_TASK_MANAGER)&&Array.isArray(e.data.paths)&&e.data.paths.length>0){var o,r=e.data.paths[f][f],a=e.data.attributes[r];if(null!=a&&""!==a&&(o=a.taskType),!n.is(t._tasks.current)&&function(e){var n=s.body.getDimensions().height,i=window.getComputedStyle(s.body);return 0!==n&&"none"!==i.display&&(!0!==t.isInspected()||e===w.TAKE_SCREENSHOT)}(o)&&-1!==Object.keys(w).indexOf(a.taskType)){var l=[],c={};l.push([r]),c[r]={taskType:a.taskType,widgetIdIM:a.widgetIdIM,widgetId3D:s.id},i.publish("DS/IssueManagementTask/ready",{metadata:{appId:s.id,appName:s.name,timestamp:Math.floor(Date.now()),options:{}},data:{paths:l,attributes:c},version:"1.0"})}}d.end(t.name+" DS/IssueManagementTask/add")})),t._tasks.subscriberTokens.push(i.subscribe("DS/IssueManagementTask/exec",function(i){if(d.start(t.name+" DS/IssueManagementTask/exec"),n.is(i.metadata,"object")&&n.is(i.metadata.options,"object")&&n.equals(i.metadata.options[v.ISU_TASK_MANAGER],v.ISU_TASK_MANAGER)&&Array.isArray(i.data.paths)&&i.data.paths.length>0){var o=i.data.paths[f][f],r=i.data.attributes[o];s.name===m&&r.widgetId3D===s.id&&new e(function(e){!0!==t.isDisplayed()?require(["DS/UIKIT/Mask","DS/Issue3DReview/commands/CommandsManager"],function(n,i){n.mask(s.body),t.listenTo(t,"onDisplay",function(){t.stopListening(t,"onDisplay"),n.unmask(s.body),e()}),i.getCommandCheckHeader("Display").toggleState()}):e()}).then(function(){t._tasks.current={taskId:o,taskType:r.taskType,widgetIdIM:r.widgetIdIM,widgetId3D:s.id}}).then(function(){return n.is(t._taskHandlers[r.taskType],"function")?t._taskHandlers[r.taskType].call(t,r.args):e.resolve()}).then(function(e){n.is(e,"object")&&(t._tasks.current.cancel=e)}).catch(function(e){t._tasks.current=null,t._logger.error(e)})}d.end(t.name+" DS/IssueManagementTask/exec")})),t._tasks.subscriberTokens.push(i.subscribe("DS/IssueManagementTask/cancel",function(e){if(d.start(t.name+" DS/IssueManagementTask/cancel"),n.is(e.metadata,"object")&&n.is(e.metadata.options,"object")&&n.equals(e.metadata.options[v.ISU_TASK_MANAGER],v.ISU_TASK_MANAGER)&&Array.isArray(e.data.paths)&&e.data.paths.length>0){var i=e.data.paths[f][f],o=e.data.attributes[i];if(o.taskId===t._tasks.current.taskId&&o.widgetId3D===s.id&&o.widgetIdIM===t._tasks.current.widgetIdIM){if(n.is(t._tasks.current.cancel,"object")&&n.is(t._tasks.current.cancel.method,"function")){var r=t._tasks.current.cancel.method,a=t._tasks.current.cancel.context||null,l=t._tasks.current.cancel.args||[];r.apply(a,l)}t._tasks.current=null}}d.end(t.name+" DS/IssueManagementTask/cancel")}))},_taskHandlers:{SELECT_IN_3D:function(e){var t=this,n=c.get("widget")||window.widget;return t.utils.selectIn3D(function(e,s,o,r){var a=[],l={},c={nodes:[]};o.nodes.forEach(function(){c.nodes.push("node")}),c.paths=o.paths,a.push([t._tasks.current.taskId]),l[t._tasks.current.taskId]={taskType:t._tasks.current.taskType,widgetIdIM:t._tasks.current.widgetIdIM,widgetId3D:t._tasks.current.widgetId3D,response:{target:e,positions:s,nodes:c,context:r}},i.publish("DS/IssueManagementTask/done",{metadata:{appId:n.id,appName:n.name,timestamp:Math.floor(Date.now()),options:{}},data:{paths:a,attributes:l},version:"1.0"}),t._tasks.current=null},function(){var e=[],s={};e.push([t._tasks.current.taskId]),s[t._tasks.current.taskId]={taskType:t._tasks.current.taskType,widgetIdIM:t._tasks.current.widgetIdIM,widgetId3D:t._tasks.current.widgetId3D},i.publish("DS/IssueManagementTask/done",{metadata:{appId:n.id,appName:n.name,timestamp:Math.floor(Date.now()),options:{canceled:!0}},data:{paths:e,attributes:s},version:"1.0"}),t._tasks.current=null},e)},TAKE_SCREENSHOT:function(){var e=this,t=c.get("widget")||window.widget;return e.utils.takeAnnotation(function(n){var s=(new Date).toLocaleString();s=s.replace(b,"-");var o={data:n.dataURL,fileName:"screenshot_"+s+".png",fileType:"image/png",lastModified:new Date},r=[],a={};r.push([e._tasks.current.taskId]),a[e._tasks.current.taskId]={taskType:e._tasks.current.taskType,widgetIdIM:e._tasks.current.widgetIdIM,widgetId3D:e._tasks.current.widgetId3D,response:o},i.publish("DS/IssueManagementTask/done",{metadata:{appId:t.id,appName:t.name,timestamp:Math.floor(Date.now()),options:{}},data:{paths:r,attributes:a},version:"1.0"}),e._tasks.current=null},function(){var n=[],s={};n.push([e._tasks.current.taskId]),s[e._tasks.current.taskId]={taskType:e._tasks.current.taskType,widgetIdIM:e._tasks.current.widgetIdIM,widgetId3D:e._tasks.current.widgetId3D},i.publish("DS/IssueManagementTask/done",{metadata:{appId:t.id,appName:t.name,timestamp:Math.floor(Date.now()),options:{canceled:!0}},data:{paths:n,attributes:s},version:"1.0"}),e._tasks.current=null},function(t){e._logger.error(t)})}},utils:{pathUtils:{convertInstancePath:function(e){for(var t=e.split(","),n=[],s=0;s<t.length;s++)0!=s&&s%2!=1&&s!=t.length-1||n.push(t[s]);return n.toString()},convertReferencePath:function(e){for(var t=e.split(","),n=t[t.length-1],s=c.get("component").getManager().getNodesById(n).paths,i=0;i<s.length;i++){if(this.convertInstancePath(s[i].toString())==e)return s[i].toString()}return""},compareInstancePaths:function(e,t){var n=e.split(","),s=t.split(",");return n.shift(),s.shift(),!!n.toString().includes(s.toString())}},_setTypesCallbackSubscribe:!1,setTypesCallbackForOFW:function(e){r.setTypesCallbackForOFW(e,{setTypesCallbackSubscribe:this._setTypesCallbackSubscribe}),this._setTypesCallbackSubscribe=!0},createBalloon:function(t){return new e(function(e){require(["DS/Issue3DReview/views/Balloon","DS/Issue3DReview/models/Issue","DS/Issue3DReview/models/Marker"],function(n,s,i){var o=c.get("component").get3DContext(),r="";Array.isArray(t.path)&&(r=t.path.join());var a=new i({id:t.id,issue:new s({}),name:"",title:"",state:"",description:"",position:t.position,path:t.path,node:t.id,path_str:r,temporary:t.temporary||!1});a.set("color",t.color);var l=new n({parent:t.parent,model:a,isInspected:!1,viewer:o.viewer,window:o.window,controller:o.controller});l.render({callback:function(){e(l)}})})})},selectIn3D:function(t,n,s){return new e(function(e){require(["DS/Issue3DReview/utils/ViewerManipulator"],function(i){s&&1==s.length&&null!=s[0]?i.setOccurenceMode(s[0].isOccurenceSelection):i.setOccurenceMode(!1);var o={method:i.selectIn3D(t,n),context:null,args:[!0]};e(o)})})},takeAnnotation:function(t,s,i){return new e(function(e,o){require(["DS/2DAnnotation/2DAnnotation","DS/UIKIT/Mask"],function(r,a){var l=c.get("widget")||window.widget;a.mask(l.body);var u=c.get("component").get3DContext(),d=new r({className:"create-attachments-annotation",saveCallback:function(e){t(e),d.destroy()},exitCallback:function(){s(),d.destroy()},captureTarget:n.Element.getElement.call(u.root.getFrameWindow().elements.viewerFrame,"canvas")});d.render(),d.isLoaded.then(function(){a.unmask(l.body),d.container.inject(l.body),e({method:d.callbacks.exitCallback,context:null,args:[!0]})}).catch(function(e){a.unmask(l.body),i(e),o(e)})})})}}})});