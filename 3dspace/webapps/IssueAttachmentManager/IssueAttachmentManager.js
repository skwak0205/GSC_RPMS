define("DS/IssueAttachmentManager/services/AttachmentServices",["UWA/Core","UWA/Promise","UWA/Controls/Input","DS/DocumentManagement/DocumentManagement","DS/FedDictionaryAccess/FedDictionaryAccessAPI","DS/i3DXCompassPlatformServices/OpenWith","DS/WAFData/WAFData","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","DS/IssueServices/services/IssueServices","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(e,t,n,i,o,r,s,a,c,l,u){"use strict";var m={ISSUE_TYPE:"Issue",EXTENSIONS:{JPG:"image",JPEG:"image",PNG:"image",BMP:"image",GIF:"image",MP3:"audio",MPEG:"audio",OGG:"audio",FLAC:"audio",MP4:"video",AVI:"video",MPG:"video",MKV:"video",WEBM:"video",MOV:"video",PDF:"office",PPT:"office",PPTX:"office",DOC:"office",OTHER:"other"},TEN_MINUTES:6e5,CACHE_LIMIT:5,FETCH_DOCUMENT_PREDICATES:["resourceid","ds6w:identifier","ds6w:label","ds6w:type","ds6w:modified","ds6w:created","preview_url","type_icon_url","ds6w:responsible","owner","ds6w:docextension","ds6w:organizationResponsible"],NLS_PREDICATES:["ds6w:type"],DOCUMENTS_SERVICE_ROOT_URL:"/resources/v1/modeler/documents/",DOCUMENTS_SERVICE_REL_OWNER_DATE_ARGS:"$include=parents,relOwnerInfo&$fields=parents.originated,isDocumentType",SET_AS_PRIMARY:{EXTENSION:".png"}};return{getCurrentSecurityContext:function(){return c.getSecurityContext()},getCurrentTenant:function(){return c.getTenant()},parseDocument:function(t,n){if(!e.is(t,"object")){var i=u.replace(u.error.common.incorrectArgument,{arg:0,type:"Object"});throw new Error(i)}if(e.is(n)&&!e.is(n,"string")){var o=u.replace(u.error.common.incorrectArgument,{arg:1,type:"String"});throw new Error(o)}var r;try{if(r={id:t.id,title:t.dataelements.title||t.dataelements.name,name:t.dataelements.name,type:t.type,dispType:e.is(u.views.Attachment.types[t.type],"string")?u.views.Attachment.types[t.type]:t.type,thumbnailUrl:t.dataelements.image,owner:{firstName:t.relateddata.ownerInfo[0].dataelements.firstname,fullName:t.relateddata.ownerInfo[0].dataelements.firstname+" "+t.relateddata.ownerInfo[0].dataelements.lastname,lastName:t.relateddata.ownerInfo[0].dataelements.lastname,user:t.relateddata.ownerInfo[0].dataelements.name},created:t.dataelements.originated,modified:t.dataelements.modified},n&&t.relateddata.hasOwnProperty("parents")){var s=t.relateddata.parents.find(function(e){return e.id===n});s&&(r.relOwner={firstName:s.relateddata.relOwnerInfo[0].dataelements.firstname,fullName:s.relateddata.relOwnerInfo[0].dataelements.firstname+" "+s.relateddata.relOwnerInfo[0].dataelements.lastname,lastName:s.relateddata.relOwnerInfo[0].dataelements.lastname,user:s.relateddata.relOwnerInfo[0].dataelements.name},r.relOriginated=s.relelements.originated)}if("Document"===t.type&&t.relateddata.files.length){r.title=t.relateddata.files[0].dataelements.title;var a=t.relateddata.files[0].dataelements.title.split("."),c=a[a.length-1];m.EXTENSIONS.hasOwnProperty(c.toUpperCase())?r.documentType=m.EXTENSIONS[c.toUpperCase()]:r.documentType=m.EXTENSIONS.OTHER}}catch(e){throw e}return r},parseFromSearch:function(t){if(!e.is(t,"object")){var n=u.replace(u.error.common.incorrectArgument,{arg:0,type:"Object"});throw new Error(n)}var i={id:t.id,title:t["ds6w:label"],type:t["ds6w:type_value"],modified:t["ds6w:modified"],created:t["ds6w:created"],thumbnailUrl:t.preview_url,iconUrl:t.type_icon_url,sourceid_value:t.sourceid_value,owner:{firstName:"",fullName:t["ds6w:responsible"],lastName:"",user:t.owner}};if("Document"===i.type&&t.hasOwnProperty("ds6w:docExtension")){var o=t["ds6w:docExtension"];i.title+="."+o,m.EXTENSIONS.hasOwnProperty(o.toUpperCase())?i.documentType=m.EXTENSIONS[o.toUpperCase()]:i.documentType=m.EXTENSIONS.OTHER}return i},parseFromFetch:function(t){if(!e.is(t,"object")||!e.is(t.attributes,"array")){var n=u.replace(u.error.common.incorrectArgument,{arg:0,type:"Object"});throw new Error(n)}t.attributes.sort(function(e,t){return"ds6w:docextension"===e.name?1:"ds6w:docextension"===t.name?-1:0});for(var i={owner:{}},o=0;o<t.attributes.length;o++){var r=t.attributes[o];if("resourceid"===r.name&&(i.id=r.value),"ds6w:label"===r.name&&(i.title=r.value),"ds6w:type"===r.name&&(i.type=r.value,i.dispType=r.dispValue),"ds6w:modified"===r.name&&(i.modified=r.value),"ds6w:created"===r.name&&(i.created=r.value),"preview_url"===r.name&&(i.thumbnailUrl=r.value),"type_icon_url"===r.name&&(i.iconUrl=r.value),"ds6w:responsible"===r.name&&(i.owner.fullName=r.value),"owner"===r.name&&(i.owner.user=r.value),"ds6w:docextension"===r.name&&"Document"===i.type){var s=r.value;i.title+="."+s,m.EXTENSIONS.hasOwnProperty(s.toUpperCase())?i.documentType=m.EXTENSIONS[s.toUpperCase()]:i.documentType=m.EXTENSIONS.OTHER}}return i},parseFromDragEvent:function(t){if(!(t instanceof DragEvent)){var n=u.replace(u.error.common.incorrectArgument,{arg:0,type:"DragEvent"});throw new Error(n)}for(var i=null,o=e.is(t.dataTransfer.types.indexOf,"function")?"indexOf":"contains",r="",s=["text/searchitems","text/plain","Text","Files"],a=0;a<s.length&&""===r;a++){var c=t.dataTransfer.types[o](s[a]);(e.is(c,"number")&&c>=0||e.is(c,"boolean")&&!0===c)&&(r=s[a])}var l={};if("Files"===r)i={files:t.dataTransfer.files};else if(""!==r){l=t.dataTransfer.getData(r);try{i=JSON.parse(l)}catch(e){}}return i},getDocumentsFrom:function(n){var o=this;if(!e.is(n,"string")){var r=u.replace(u.error.common.incorrectArgument,{arg:0,type:"String"});return t.reject(Error(r))}return new t(function(e,t){i.getDocumentsFromParent({getVersions:!1,additionalURLParams:m.DOCUMENTS_SERVICE_REL_OWNER_DATE_ARGS,relInfo:{parentId:n,parentRelName:"Reference Document"},tenantUrl:c.get3DSpaceUrl(),tenant:o.getCurrentTenant(),securityContext:"ctx::"+decodeURIComponent(o.getCurrentSecurityContext()),onComplete:function(t){for(var i={id:n,primaryAttachment:"",attachments:[]},r=0;r<t.data.length;r++){var s=t.data[r],a=o.parseDocument(s,n);i.attachments.push(a)}e(i)},onFailure:t})})},getSearchQuery:function(e){var n=this;if(e){var i="",o=[],r=[];return e.forEach(function(e){var i=new t(function(t){n.getDocumentsFrom(e).then(function(e){t(e)})});r.push(i)}),t.all(r).then(function(e){return e.forEach(function(e){e.attachments.forEach(function(e){o.push(e.name)})}),0===o.length?i="":(o=o.filter(function(e,t,n){return n.indexOf(e)===t}),i="flattenedtaxonomies:types/DOCUMENTS AND name:(",o.forEach(function(e,t){i+=" "+e+" ",t!==o.length-1&&(i+="OR")}),i+=")"),i})}return t.resolve("")},getDocuments:function(n){var o=this;if(!e.is(n,"array")){var r=u.replace(u.error.common.incorrectArgument,{arg:0,type:"Array<String>"});return t.reject(Error(r))}return new t(function(e,t){i.getDocuments(n,{getVersions:!1,additionalURLParams:m.DOCUMENTS_SERVICE_REL_OWNER_DATE_ARGS,tenantUrl:c.get3DSpaceUrl(),tenant:o.getCurrentTenant(),securityContext:"ctx::"+decodeURIComponent(o.getCurrentSecurityContext()),onComplete:function(t){for(var n={attachments:[],data:t.data},i=0;i<t.data.length;i++){var r=t.data[i],s=o.parseDocument(r);n.attachments.push(s)}e(n)},onFailure:t})})},fetch:function(n){var i=this;if(!e.is(n,"array")){var r=u.replace(u.error.common.incorrectArgument,{arg:0,type:"Array<String>"});return t.reject(Error(r))}return new t(function(r,l){var u=a.get("widget")||window.widget,d={label:u.name+"-"+c.getUserName()+"-"+Date.now(),nresults:n.length,physicalid:n,start:0,tenantUrl:c.get3DSpaceUrl(),tenant:i.getCurrentTenant(),select_predicate:m.FETCH_DOCUMENT_PREDICATES},h={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+decodeURIComponent(i.getCurrentSecurityContext())},timeout:m.TEN_MINUTES,onComplete:function(s){var a;try{a=JSON.parse(s)}catch(e){l(e)}new t(function(t){if(Array.isArray(a.results)&&a.results.length===n.length)t(a);else{var o=[];if(Array.isArray(a.results)){var r=a.results.map(function(e){return i.parseFromFetch(e)}).reduce(function(e,t){return e.push(t.id),e},[]);o=n.filter(function(e){return-1===r.indexOf(e)})}else o=n;i.recent().then(function(n){if(Array.isArray(n.results)){var r=e.clone(a);Array.isArray(r.results)||(r.results=[]);for(var s=0;s<n.results.length;s++){var c=i.parseFromFetch(n.results[s]);-1!==o.indexOf(c.id)&&(r.results.push(n.results[s]),r.infos.nhits++,r.infos.nresults++)}t(r)}else t(a)}).catch(function(){t(a)})}}).then(function(t){var n=e.clone(t),s={};if(Array.isArray(n.results)&&n.results.length)for(var a=e.clone(n.results),c=0;c<a.length;c++)if(Array.isArray(a[c].attributes)&&a[c].attributes.length)for(var l=a[c].attributes,d=0;d<l.length;d++){var h=a[c].attributes[d];-1!==m.NLS_PREDICATES.indexOf(h.name)&&(s.hasOwnProperty(h.name)||(s[h.name]=[]),-1===s[h.name].indexOf(h.value)&&s[h.name].push(h.value))}o.getNlsOfPropertiesValues(JSON.stringify(s),{tenantId:i.getCurrentTenant(),lang:u.lang,onComplete:function(e){if(Array.isArray(n.results)&&n.results.length)for(var t=n.results,i=0;i<t.length;i++)if(Array.isArray(t[i].attributes)&&t[i].attributes.length)for(var o=t[i].attributes,s=0;s<o.length;s++){var a=t[i].attributes[s];e.hasOwnProperty(a.name)&&e[a.name].hasOwnProperty(a.value)&&(a.dispValue=e[a.name][a.value])}r(n)},onFailure:function(){r(n)}})})},onFailure:l,data:JSON.stringify(d)};s.authenticatedRequest(c.get3DSpaceUrl()+"/cvservlet/fetch/v2",h)})},recent:function(){var e=this;return new t(function(t,n){var i={label:(a.get("widget")||window.widget).name+"-"+c.getUserName()+"-"+Date.now(),nresults:100,delta_time_interval:300,tenant:e.getCurrentTenant(),select_predicate:m.FETCH_DOCUMENT_PREDICATES,select_file:["icon","thumbnail_2d"],login:{"3dspace":{SecurityContext:c.getSecurityContext()}}},o={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},timeout:m.TEN_MINUTES,onComplete:function(e){try{var i=JSON.parse(e);t(i)}catch(e){n(e)}},onFailure:n,data:JSON.stringify(i)},r=c.get3DSearchUrl()+"/recent?tenant="+e.getCurrentTenant()+"&_="+Date.now();s.authenticatedRequest(r,o)})},downloadDocuments:function(n,o){var r=this;if(!e.is(n,"array")){var a=u.replace(u.error.common.incorrectArgument,{arg:0,type:"Array<String>"});return t.reject(Error(a))}if(e.is(o)&&!e.is(o,"boolean")){var l=u.replace(u.error.common.incorrectArgument,{arg:1,type:"Boolean"});return t.reject(Error(l))}return new t(function(e){i._prepareService(e,{tenantUrl:c.get3DSpaceUrl(),tenant:r.getCurrentTenant(),securityContext:decodeURIComponent(r.getCurrentSecurityContext())})||e()}).then(function(){return new t(function(e,t){var a=c.get3DSpaceUrl()+m.DOCUMENTS_SERVICE_ROOT_URL+"DownloadTicket";a+=o?"?zipFiles=true":"?fileStream=true",a+="&tenant="+r.getCurrentTenant();var l={csrf:i.getCsrf(c.get3DSpaceUrl()),data:n.map(function(e){return{id:e}})},u={method:"PUT",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+r.getCurrentSecurityContext()},timeout:m.TEN_MINUTES,onComplete:function(n){try{var i=JSON.parse(n),o=[];if(i&&i.success){if(i&&i.data&&i.data.length){for(var r=i.data.length,s=0;s<r;s++){var a=i.data[s],c={id:a.id,errorMessage:a.updateMessage};a.dataelements&&a.dataelements.ticketURL&&(c.downloadUrl=a.dataelements.ticketURL,a.dataelements.fileName&&(c.fileName=a.dataelements.fileName),a.dataelements.fileNames&&(c.fileNames=a.dataelements.fileNames)),o.push(c)}e(o)}}else t(i)}catch(e){t(e)}},onFailure:t,data:JSON.stringify(l)};s.authenticatedRequest(a,u)})})},uploadFile:function(n,o,r){var a=this;if(!(n instanceof File||n instanceof Blob)){var l=u.replace(u.error.common.incorrectArgument,{arg:0,type:"File"});return t.reject(Error(l))}if(e.is(o,"string")&&""===o){var d=u.replace(u.error.common.incorrectArgument,{arg:1,type:"String"});return t.reject(Error(d))}return new t(function(e){i._prepareService(e,{tenantUrl:c.get3DSpaceUrl(),tenant:a.getCurrentTenant(),securityContext:decodeURIComponent(a.getCurrentSecurityContext())})||e()}).then(function(){return new t(function(t,l){var u=c.get3DSpaceUrl()+m.DOCUMENTS_SERVICE_ROOT_URL+"files/CheckinTicket";u+="?tenant="+a.getCurrentTenant();var d={csrf:i.getCsrf(c.get3DSpaceUrl())},h={method:"PUT",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+a.getCurrentSecurityContext()},timeout:m.TEN_MINUTES,onComplete:function(u){var h=JSON.parse(u);if(e.is(r,"object")&&e.is(r.onTicketComplete,"function")&&r.onTicketComplete(h),h&&h.success){var g=h.data[0].dataelements;i.setCsrf(h.csrf,c.get3DSpaceUrl());var p=g.ticketURL,f={csrf:"notNeeded",documentInfo:{fileInfo:{file:n}}};e.is(o,"string")&&""!==o&&(f.documentInfo.relInfo={parentId:o,parentRelName:"Reference Document"});var v=e.extend(f,g),E=new FormData;E.append(g.ticketparamname,g.ticket),E.append("file_0",n,n.name);var y={method:"POST",onComplete:function(n){e.is(r,"object")&&e.is(r.onCheckinComplete,"function")&&r.onCheckinComplete(n);var o=c.get3DSpaceUrl()+m.DOCUMENTS_SERVICE_ROOT_URL,u=Object.create(null);i._buildDocumentDataElements(u,v),v.fcsReceipt=n,i._buildFilesRelatedData(u,v);var h={csrf:d.csrf,data:[u]},g={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+a.getCurrentSecurityContext()},timeout:m.TEN_MINUTES,onComplete:function(n){var i=JSON.parse(n);e.is(r,"object")&&e.is(r.onConnectComplete,"function")&&r.onConnectComplete(i),t(i)},onFailure:function(e,t){var n=JSON.parse(t);l(n)},onCancel:l,onTimeout:l,data:JSON.stringify(h)},p=s.authenticatedRequest(o,g);e.is(r,"object")&&e.is(r.onConnectStart,"function")&&r.onConnectStart(p)},onFailure:l,onCancel:l,data:E,timeout:0};e.is(r,"object")&&e.is(r.onCheckinProgress,"function")&&(y.onUploadProgress=r.onCheckinProgress);var S=s.authenticatedRequest(p,y);e.is(r,"object")&&e.is(r.onCheckinStart,"function")&&r.onCheckinStart(S)}else l(h)},onFailure:l,onCancel:l,onTimeout:l,data:JSON.stringify(d)},g=s.authenticatedRequest(u,h);e.is(r,"object")&&e.is(r.onTicketStart,"function")&&r.onTicketStart(g)})})},connectDocumentToParent:function(n,o){var r=this;if(!e.is(n,"string")){var s=u.replace(u.error.common.incorrectArgument,{arg:0,type:"String"});return t.reject(Error(s))}if(!e.is(o,"string")){var a=u.replace(u.error.common.incorrectArgument,{arg:1,type:"String"});return t.reject(Error(a))}return new t(function(e,t){i.connectDocumentToParent(n,{relInfo:{parentId:o,parentRelName:"Reference Document"},tenantUrl:c.get3DSpaceUrl(),tenant:r.getCurrentTenant(),securityContext:"ctx::"+decodeURIComponent(r.getCurrentSecurityContext()),onComplete:e,onFailure:t})})},connectDocumentsToParent:function(n,i){if(!e.is(n,"array")){var o=u.replace(u.error.common.incorrectArgument,{arg:0,type:"Array<String>"});return t.reject(Error(o))}if(!e.is(i,"string")){var r=u.replace(u.error.common.incorrectArgument,{arg:1,type:"String"});return t.reject(Error(r))}for(var s=[],a=0;a<n.length;a++){var c=n[a],l=function(e){return{documentId:this.documentId,parentId:this.parentId,response:e}};s.push(this.connectDocumentToParent(c,i).then(l.bind({documentId:c,parentId:i})).catch(l.bind({documentId:c,parentId:i})))}return t.all(s)},disconnectDocumentFromParent:function(n,o){var r=this;if(!e.is(n,"string")){var s=u.replace(u.error.common.incorrectArgument,{arg:0,type:"String"});return t.reject(Error(s))}if(!e.is(o,"string")){var a=u.replace(u.error.common.incorrectArgument,{arg:1,type:"String"});return t.reject(Error(a))}return new t(function(e,t){i.disconnectDocumentFromParent(n,{relInfo:{parentId:o,parentRelName:"Reference Document"},tenantUrl:c.get3DSpaceUrl(),tenant:r.getCurrentTenant(),securityContext:"ctx::"+decodeURIComponent(r.getCurrentSecurityContext()),onComplete:e,onFailure:t})})},disconnectDocumentsFromParent:function(n,i){if(!e.is(n,"array")){var o=u.replace(u.error.common.incorrectArgument,{arg:0,type:"Array<String>"});return t.reject(Error(o))}if(!e.is(i,"string")){var r=u.replace(u.error.common.incorrectArgument,{arg:1,type:"String"});return t.reject(Error(r))}for(var s=[],a=0;a<n.length;a++){var c=n[a],l=function(e){return{documentId:this.documentId,parentId:this.parentId,response:e}};s.push(this.disconnectDocumentFromParent(c,i).then(l.bind({documentId:c,parentId:i})).catch(l.bind({documentId:c,parentId:i})))}return t.all(s)},deleteDocument:function(n){var o=this;if(!e.is(n,"string")){var r=u.replace(u.error.common.incorrectArgument,{arg:0,type:"String"});return t.reject(Error(r))}return new t(function(e,t){i.deleteDocument(n,{tenantUrl:c.get3DSpaceUrl(),tenant:o.getCurrentTenant(),securityContext:"ctx::"+decodeURIComponent(o.getCurrentSecurityContext()),onComplete:e,onFailure:t})})},deleteDocuments:function(n){if(!e.is(n,"array")){var i=u.replace(u.error.common.incorrectArgument,{arg:0,type:"Array<String>"});return t.reject(Error(i))}for(var o=[],r=0;r<n.length;r++){var s=n[r],a=function(e){return{documentId:this.documentId,response:e}};o.push(this.deleteDocument(s).then(a.bind({documentId:s})).catch(a.bind({documentId:s})))}return t.all(o)},browseFileFromLocalDisk:function(e){return new t(function(t){var i=new n.File("Input.File",{visibility:"hidden",styles:{display:"none"}}).inject(e);i.elements.container.setStyle("display","none"),i.elements.input.accept="all",i.elements.input.multiple=!0,i.elements.input.addEventListener("change",function(e){i.destroy(),i=null;var n=e.target.files;t(n)},!1),i.elements.input.addEventListener("click",function(e){e.stopPropagation()}),i.elements.input.click()})},getPrimary:function(n){var i=this;if(!e.is(n,"string")){var o=u.replace(u.error.common.incorrectArgument,{arg:0,type:"String"});return t.reject(Error(o))}return new t(function(e,t){var o={method:"GET"};o.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+i.getCurrentSecurityContext()},o.onComplete=function(t){var n=JSON.parse(t).body,i=m.SET_AS_PRIMARY.EXTENSION;n.fileName&&n.fileName.indexOf(i)===n.fileName.length-i.length&&(n.documentId=n.fileName.slice(0,-i.length)),e(JSON.stringify(n))},o.onFailure=t,s.authenticatedRequest(c.assembleURLFor3DSpace("/resources/issues/"+n+"/images/primary"),o)})},setAsPrimary:function(n,i,o){var r=this;if(!e.is(n,"string")){var a=u.replace(u.error.common.incorrectArgument,{arg:0,type:"String"});return t.reject(Error(a))}if(!e.is(i,"string")){var l=u.replace(u.error.common.incorrectArgument,{arg:1,type:"String"});return t.reject(Error(l))}if(e.is(o)&&!e.is(o,"boolean")){var d=u.replace(u.error.common.incorrectArgument,{arg:2,type:"Boolean"});return t.reject(Error(d))}return new t(function(e,t){var a={document:n,lock:o||!1},l={method:"PUT"};l.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+r.getCurrentSecurityContext()},l.data=JSON.stringify(a),l.onComplete=function(t){var n=JSON.parse(t).body,i=m.SET_AS_PRIMARY.EXTENSION;n.fileName&&n.fileName.indexOf(i)===n.fileName.length-i.length&&(n.documentId=n.fileName.slice(0,-i.length)),e(JSON.stringify(n))},l.onFailure=function(e,n){n&&n.search("ErrorCode:1500028")>0&&(e.message=e.message+" Access Denied"),n&&n.length>0?t(n):t(e)},s.authenticatedRequest(c.assembleURLFor3DSpace("/resources/issues/"+i+"/images/primary"),l)})},unsetAsPrimary:function(n){var i=this;if(!e.is(n,"string")){var o=u.replace(u.error.common.incorrectArgument,{arg:0,type:"String"});return t.reject(Error(o))}return new t(function(e,t){var o={method:"DELETE"};o.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+i.getCurrentSecurityContext()},o.onComplete=e,o.onFailure=function(e,n){n&&n.length,t(n)},s.authenticatedRequest(c.assembleURLFor3DSpace("/resources/issues/"+n+"/images/primary"),o)})},getCompatibleApps:function(n){if(!e.is(n,"array")){var i=u.replace(u.error.common.incorrectArgument,{arg:0,type:"Array"});return t.reject(Error(i))}return new t(function(t,i){if(0===n.length)t([]);else{var o=[],s=[];m.ISSUE_TYPE;l.type.getSubType().then(function(u){var m=u;null!=m&&Object.keys(m).length>1&&Object.keys(m);for(var d=0;d<n.length;d++){var h=n[d];s.push(h._attributes.type),o.push({envId:c.getTenant(),serviceId:"3DSpace",objectId:h._attributes.id,objectType:h._attributes.type,objectTaxonomies:[h._attributes.type],displayName:h._attributes.title?h._attributes.title:h._attributes.name})}l.getTypesHierarchy({types:s,onComplete:function(n){if(e.is(n.types_hierarchies,"array")&&n.types_hierarchies.forEach(function(e,t){o.forEach(function(t,n){t.objectTaxonomies[0]===e.type&&(t.objectTaxonomies=t.objectTaxonomies.concat(e.hierarchy))})}),0===o.length)return Performance.end(name+" getOpenWithMenu"),void t(out);var s=a.get("widget")||window.widget;(new r).set3DXContent({protocol:"3DXContent",version:"1.1",source:s.name,widgetId:s.id,data:{items:o}},!0).retrieveCompatibleApps(t,i)},onFailure:function(e){t(out)}})}).catch(function(e){return e})}})}}}),define("DS/IssueAttachmentManager/components/Item",["UWA/Class/Model","UWA/Core","DS/Logger/Logger","DS/WebappsUtils/WebappsUtils","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(e,t,n,i,o){"use strict";var r={EXTENSIONS:{JPG:"image",JPEG:"image",PNG:"image",BMP:"image",GIF:"image",MP3:"audio",MPEG:"audio",OGG:"audio",FLAC:"audio",MP4:"video",AVI:"video",MPG:"video",MKV:"video",WEBM:"video",MOV:"video",PDF:"office",PPT:"office",PPTX:"office",DOC:"office",OTHER:"other"},MIMETYPE:{IMAGE:"image",AUDIO:"audio",VIDEO:"video",APPLICATION:"other"}};return e.extend({name:"DS/IssueAttachmentManager/components/Item",_logger:null,defaults:{id:null,type:null,title:"",owner:null,relOwner:null,created:"",modified:"",relOriginated:"",isProcessing:!1,isFailed:!1,isFile:!1,isPrimary:!1},init:function(e,n){if(!e.hasOwnProperty("id")||t.is(e.id,null)||t.equals(e.id,"")||!t.is(e.id,"string"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Item",property:"id",type:"String"}));if(!e.hasOwnProperty("type")||t.is(e.type,null)||t.equals(e.type,"")||!t.is(e.type,"string"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Item",property:"type",type:"String"}));if(e.hasOwnProperty("dispType")&&!t.is(e.dispType,"string"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Item",property:"dispType",type:"Object"}));if(!e.hasOwnProperty("title")||t.is(e.title,null)||!t.is(e.title,"string"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Item",property:"title",type:"String"}));if(e.hasOwnProperty("documentType")&&!t.is(e.documentType,"string"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Item",property:"documentType",type:"String"}));if(e.hasOwnProperty("owner")&&!t.is(e.owner,"object"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Item",property:"owner",type:"Object"}));if(e.hasOwnProperty("relOwner")&&!t.is(e.relOwner,"object"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Item",property:"relOwner",type:"Object"}));if(e.hasOwnProperty("created")&&!t.is(e.created,"string")&&!t.is(e.created,"date"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Item",property:"created",type:"String"}));if(e.hasOwnProperty("modified")&&!t.is(e.modified,"string")&&!t.is(e.modified,"date"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Item",property:"modified",type:"String"}));if(e.hasOwnProperty("relOriginated")&&!t.is(e.relOriginated,"string")&&!t.is(e.relOriginated,"date"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Item",property:"relOriginated",type:"String"}));if(e.hasOwnProperty("thumbnailUrl")&&!t.is(e.thumbnailUrl,"string"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Item",property:"thumbnailUrl",type:"String"}));if(e.hasOwnProperty("iconUrl")&&!t.is(e.iconUrl,"string"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Item",property:"iconUrl",type:"String"}));if(e.hasOwnProperty("contentUrl")&&!t.is(e.contentUrl,"string"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Item",property:"contentUrl",type:"String"}));this._parent(e,n)},setup:function(){if(this.set("modified",new Date(this.get("modified"))),this.set("created",new Date(this.get("created"))),this.set("relOriginated",new Date(this.get("relOriginated"))),void 0===this.get("iconUrl")){var e=i.getWebappsAssetUrl("IssueAttachmentManager","images/I_MultipleDocuments22x22.png");this.set("iconUrl",e)}if(void 0===this.get("thumbnailUrl")){var t=i.getWebappsAssetUrl("IssueAttachmentManager","images/I_CDM_Document108x144.png");this.set("thumbnailUrl",t)}this._logger=n.getLogger(this.name),this.selected=!1,this.hidden=!1},setDocumentType:function(e){if(!t.is(e,"string"))throw new Error(o.replace(o.error.common.incorrectArgument,{arg:0,type:"String"}));return r.EXTENSIONS.hasOwnProperty(e.toUpperCase())?this.set("documentType",r.EXTENSIONS[e.toUpperCase()]):this.set("documentType",r.EXTENSIONS.OTHER),this},setDocumentTypeByMIME:function(e){if(!t.is(e,"string"))throw new Error(o.replace(o.error.common.incorrectArgument,{arg:0,type:"String"}));var n=e.split("/");if(2===n.length){var i=n[0];r.MIMETYPE.hasOwnProperty(i.toUpperCase())?this.set("documentType",r.MIMETYPE[i.toUpperCase()]):this.set("documentType",r.EXTENSIONS.OTHER)}else this.set("documentType",r.EXTENSIONS.OTHER);return this},select:function(){return!1===this.selected&&(this.selected=!0,this.dispatchEvent("onSelect",{id:this.id,props:this.toJSON()})),this},unselect:function(){return!0===this.selected&&(this.selected=!1,this.dispatchEvent("onUnselect",{id:this.id,props:this.toJSON()})),this},hide:function(){return!1===this.hidden&&(this.hidden=!0,this.dispatchEvent("onHide",{id:this.id,props:this.toJSON()})),this},show:function(){return!0===this.hidden&&(this.hidden=!1,this.dispatchEvent("onShow",{id:this.id,props:this.toJSON()})),this}})}),define("DS/IssueAttachmentManager/components/Collection",["UWA/Core","UWA/Class/Collection","DS/Logger/Logger","DS/IssueAttachmentManager/components/Item","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(e,t,n,i,o){"use strict";var r={ONSELECT_TIMEOUT:0,ONUNSELECT_TIMEOUT:0,SORT:{MODE:{DATE:"relOriginated",TITLE:"title"},ORDER:{ASCENDING:1,DESCENDING:-1},TYPE:{DOCUMENT:1,OTHER:2},DOCUMENTTYPE:{IMAGE:1,VIDEO:2,AUDIO:3,OFFICE:4,OTHER:5}}};return t.extend({name:"DS/IssueAttachmentManager/components/Collection",model:i,_logger:null,init:function(t,n){if(!t.hasOwnProperty("id")||e.is(t.id,null)||e.equals(t.id,"")||!e.is(t.id,"string"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Collection",property:"id",type:"String"}));if(t.hasOwnProperty("primaryAttachment")&&!e.is(t.primaryAttachment,"string"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Collection",property:"primaryAttachment",type:"String"}));if(t.hasOwnProperty("attachments")&&!e.is(t.attachments,"array"))throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Collection",property:"attachments",type:"Array"}));this.id=t.id,this.primaryAttachment=t.primaryAttachment;var i=e.merge(n||{},{comparator:this._sortComparator.bind(this)});this._parent(t.attachments,i)},setup:function(){this._logger=n.getLogger(this.name),this.sortMode="date",this.sortOrder="descending",this.groupByType=!1,this._selectedItems=[],this._unselectedItems=[],this._eventCallbacks._debounced._onItemSelect=this.debounce(this._eventCallbacks._unbounced._onItemSelect,r.ONSELECT_TIMEOUT),this._eventCallbacks._debounced._onItemUnselect=this.debounce(this._eventCallbacks._unbounced._onItemUnselect,r.ONUNSELECT_TIMEOUT)},select:function(t){if(e.is(t,"string")){if(!this.get(t)){var n=o.replace(o.error.components.Collection.common.itemNotExist,{id:t});throw new Error(n)}this.get(t).select()}else{if(!e.is(t,"array")){var i=o.replace(o.error.common.incorrectArgument,{arg:0,type:"String or Array<String>"});throw new Error(i)}for(var r=[],s=0;s<t.length;s++)this.get(t[s])?this.get(t[s]).select():r.push(t[s]);if(r.length>0){var a=o.replace(o.error.components.Collection.common.itemNotExist,{id:r});this._logger.error(a)}}return this},unselect:function(t){if(e.is(t,"string")){if(!this.get(t)){var n=o.replace(o.error.components.Collection.common.itemNotExist,{id:t});throw new Error(n)}this.get(t).unselect()}else{if(!e.is(t,"array")){var i=o.replace(o.error.common.incorrectArgument,{arg:0,type:"String or Array<String>"});throw new Error(i)}for(var r=[],s=0;s<t.length;s++)if(this.get(t[s])?this.get(t[s]).unselect():r.push(t[s]),r.length>0){var a=o.replace(o.error.components.Collection.common.itemNotExist,{id:t[s]});this._logger.error(a)}}return this},selectAll:function(){var e=this.map(function(e){return e.id});return this.select(e)},unselectAll:function(){var e=this.map(function(e){return e.id});return this.unselect(e)},getItems:function(t){if(e.is(t,"array")){for(var n=[],i=[],r=0;r<t.length;r++)if(this.get(t[r])?n.push(this.get(t[r])):i.push(t[r]),i.length>0){var s=o.replace(o.error.components.Collection.common.itemNotExist,{id:t[r]});this._logger.error(s)}return n}var a=o.replace(o.error.common.incorrectArgument,{arg:0,type:"array"});throw new Error(a)},getSelectedItems:function(){for(var e=[],t=0;t<this.size();t++){var n=this.at(t);n.selected&&e.push(n)}return e},_sortComparator:function(e,t){var n=this.groupByType?this._groupByType(e,t):0;if(0===n){switch(r.SORT.MODE[this.sortMode.toUpperCase()]){case r.SORT.MODE.DATE:n=this._sortByRelOriginatedDate(e,t);break;case r.SORT.MODE.TITLE:n=this._sortByTitle(e,t);break;default:n=this._sortByRelOriginatedDate(e,t)}var i=r.SORT.ORDER.ASCENDING;r.SORT.ORDER.hasOwnProperty(this.sortOrder.toUpperCase())&&(i=r.SORT.ORDER[this.sortOrder.toUpperCase()]),n*=i}return n},_groupByType:function(e,t){var n=0,i=r.SORT.TYPE[e.get("type").toUpperCase()]||r.SORT.TYPE.OTHER;0===(n=i-(r.SORT.TYPE[t.get("type").toUpperCase()]||r.SORT.TYPE.OTHER))&&i===r.SORT.TYPE.DOCUMENT&&(e.get("documentType")&&t.get("documentType")&&(n=(r.SORT.DOCUMENTTYPE[e.get("documentType").toUpperCase()]||r.SORT.TYPE.OTHER)-(r.SORT.DOCUMENTTYPE[t.get("documentType").toUpperCase()]||r.SORT.TYPE.OTHER)));return n},_sortByRelOriginatedDate:function(e,t){var n=e.get("relOriginated");if(isNaN(n))return-1;var i=t.get("relOriginated");return isNaN(i)?1:n-i},_sortByTitle:function(e,t){var n=e.get("title"),i=t.get("title");return n.localeCompare(i)},_onItemSelect:function(e){this._selectedItems.push(e.id),this._eventCallbacks._debounced._onItemSelect.call(this)},_onItemUnselect:function(e){this._unselectedItems.push(e.id),this._eventCallbacks._debounced._onItemUnselect.call(this)},_eventCallbacks:{_unbounced:{_onItemSelect:function(){this.dispatchEvent("onSelect",{ids:this._selectedItems.slice(0)}),this._selectedItems=[]},_onItemUnselect:function(){this.dispatchEvent("onUnselect",{ids:this._unselectedItems.slice(0)}),this._unselectedItems=[]}},_debounced:{}},_onModelEvent:function(){return"onSelect"===arguments[0]?this._onItemSelect(arguments[1]):"onUnselect"===arguments[0]?this._onItemUnselect(arguments[1]):this._parent.apply(this,arguments)},_debounceTimeouts:[],debounce:function(e,t,n){var i,o=this;return function(){var r=this,s=arguments,a=n&&!i;clearTimeout(i);var c=o._debounceTimeouts.indexOf(i);-1!==c&&o._debounceTimeouts.splice(c,1),i=setTimeout(function(){i=null,n||e.apply(r,s)},t),o._debounceTimeouts.push(i),a&&e.apply(r,s)}}})}),define("DS/IssueAttachmentManager/components/ContextualMenu",["UWA/Controls/Abstract","UWA/Class/Listener","UWA/Class/Promise","UWA/Core","DS/Menu/ContextualMenu","DS/Menu/Menu","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueCommon/commands/CommandsManager","DS/IssueServices/services/PlatformServices","DS/IssueCommon/utils/DocumentUtils","DS/IssueCommon/utils/Utils","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(e,t,n,i,o,r,s,a,c,l,u,m,d){"use strict";return e.extend(t,{name:"DS/IssueAttachmentManager/components/ContextualMenu",defaultOptions:{authoring:!0},init:function(e){if(!e.hasOwnProperty("collection")||i.is(e.collection,null)||!(e.collection instanceof s))throw new Error(d.replace(d.error.common.incorrectInitArgument,{className:"ContextualMenu",property:"collection",type:"DS/IssueAttachmentManager/components/Collection"}));if(e.hasOwnProperty("authoring")&&!i.is(e.authoring,"boolean"))throw new Error(d.replace(d.error.common.incorrectInitArgument,{className:"ContextualMenu",property:"authoring",type:"Boolean"}));this._parent(e),this.authoring=this.options.authoring,this.collection=e.collection,this.bo=e.bo,this.customCommands=[];var t=widget.getValue("attachmentManagerPreferences");i.is(t)&&i.is(t.catalogLayout)&&(this.catalogLayout=t.catalogLayout)},register:function(e){var t=this;o.addEventListener(e,{callback:function(e){return t.getCommands()}})},hide:function(){r.hide()},getCommands:function(){var e=this,t=[],o=e.collection.getSelectedItems(),r=o.some(function(e){return e.get("isProcessing")||e.get("isFailed")}),s=!1;i.is(e.bo)&&i.is(e.bo.state)&&"Closed"==e.bo.state&&(s=!0);var c=new n(function(n){(0===o.length||r)&&(t.push({name:"groupByType",title:d.views.Header.Iconbar.actions.sort.groupByType,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-group"},data:null,state:e.collection.groupByType?"selected":"unselected",action:{callback:function(){e.dispatchEvent("request:groupByType")}}}),t.push({name:"sort",title:d.views.Header.Iconbar.actions.sort.dropdown,type:"PushItem",data:null,fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sorting"},submenu:[{name:"sortAscDate",title:d.views.Header.Iconbar.actions.sort.ascDate,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sort-num-asc"},data:null,state:"ascending"===e.collection.sortOrder&&"date"===e.collection.sortMode?"selected":"unselected",action:{callback:function(){e.dispatchEvent("request:sort",{sortOrder:"ascending",sortMode:"date"})}}},{name:"sortDescDate",title:d.views.Header.Iconbar.actions.sort.descDate,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sort-num-desc"},state:"descending"===e.collection.sortOrder&&"date"===e.collection.sortMode?"selected":"unselected",data:null,action:{callback:function(){e.dispatchEvent("request:sort",{sortOrder:"descending",sortMode:"date"})}}},{name:"sortAscTitle",title:d.views.Header.Iconbar.actions.sort.ascTitle,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sort-alpha-asc"},data:null,state:"ascending"===e.collection.sortOrder&&"title"===e.collection.sortMode?"selected":"unselected",action:{callback:function(){e.dispatchEvent("request:sort",{sortOrder:"ascending",sortMode:"title"})}}},{name:"sortDescTitle",title:d.views.Header.Iconbar.actions.sort.descTitle,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sort-alpha-desc"},state:"descending"===e.collection.sortOrder&&"title"===e.collection.sortMode?"selected":"unselected",data:null,action:{callback:function(){e.dispatchEvent("request:sort",{sortOrder:"descending",sortMode:"title"})}}}]}),t.push({name:"switchCatalogLayout",title:(e.catalogLayout+1)%2==1?d.views.Header.Iconbar.actions.switchCatalogLayout_TV:d.views.Header.Iconbar.actions.switchCatalogLayout_GV,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x "+((e.catalogLayout+1)%2==1?"fonticon-view-small-thb":"fonticon-view-list")},data:null,action:{callback:function(){e.dispatchEvent("request:catalogSwitchLayout")}}}),t.push({type:"SeparatorItem"})),n()}),l=null,h=!1;return c=(c=(c=c.then(function(){var e=o.map(function(e){return e.id});if(e.length>0)return a.getDocuments(e).then(function(e){l=e.data[0],h=e.data.every(function(e){return"TRUE"===e.dataelements.isDocumentType})});n.resolve()}).then(function(){return o.length>0?r?n.resolve():a.getCompatibleApps(o).then(function(n){var r=[];if(r=i.is(n,"array")&&n.length>0?n.map(function(t){var n={name:t.name,type:"PushItem",title:t.text,action:{callback:function(){e.dispatchEvent("request:openWith",{app:t,objects:o,arguments:arguments,context:this})}}};return null!=t.fonticon?n.fonticon={content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+t.fonticon}:n.icon=t.icon,n}):[{name:"openWithNoApps",type:"PushItem",title:d.views.Header.Iconbar.actions.openWithNoApps}],t.push({name:"openWith",type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-open-menu-dot"},title:d.views.Header.Iconbar.actions.openWith,submenu:r}),t.push({type:"SeparatorItem"}),h&&1===o.length&&null!==l){var a={data:l,from:"attachments",menu:e,selected:o};t.push({name:"Preview",title:d.views.preview,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-eye"},data:null,action:{callback:function(){u.preview(a)}}}),t.push({type:"SeparatorItem"})}if(h&&!s&&e.authoring&&1===o.length&&"image"===o[0].get("documentType")&&(t.push({name:"annotate",title:d.views.Header.Iconbar.actions.annotate,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-highlighter"},data:null,action:{callback:function(){e.dispatchEvent("request:annotate")}}}),t.push({type:"SeparatorItem"})),h&&!s&&1===o.length&&null!==l){var c={data:l,from:"attachments",menu:e,selected:o[0]};""===l.relateddata.files[0].dataelements.locker?t.push({name:"Edit",title:d.views.edit,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-pencil"},data:null,action:{callback:function(){u.edit(c)}}}):(t.push({name:"UndoEdit",title:d.views.undoEdit,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-undo"},data:null,action:{callback:function(){u.undoEdit(c)}}}),t.push({name:"Update",title:d.views.update,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-upload"},data:null,action:{callback:function(){u.update(c)}}}))}if(h&&!s&&e.authoring&&1===o.length&&"image"===o[0].get("documentType")&&t.push({name:"setAsPrimary",title:d.views.Header.Iconbar.actions.setAsPrimary,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-star"},data:null,action:{callback:function(){e.dispatchEvent("request:setAsPrimary",{item:o[0],lock:!0})}}}),h&&null!==l){c={data:l,from:"attachments",menu:e,selected:o};t.push({name:"download",title:d.views.Header.Iconbar.actions.download,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-download"},data:null,action:{callback:function(){u.download(c)}}})}1===o.length&&t.push({name:"information",title:d.views.information,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-properties"},data:null,action:{callback:function(){m.viewProperties(o[0].id)}}}),e.authoring&&!s&&(t.push({name:"detach",title:d.views.Header.Iconbar.actions.detachDelete.detach,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-remove"},data:null,action:{callback:function(){e.dispatchEvent("request:detach")}}}),t.push({type:"SeparatorItem"})),e.authoring&&!s&&(t.push({type:"SeparatorItem"}),t.push({name:"delete",title:d.views.Header.Iconbar.actions.detachDelete.delete,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-trash"},data:null,action:{callback:function(){e.dispatchEvent("request:delete")}}}))}):(e.authoring&&!s&&(t.push({name:"annotate",title:d.views.Header.Iconbar.actions.annotate,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-highlighter"},data:null,action:{callback:function(){e.dispatchEvent("request:annotate")}}}),t.push({type:"SeparatorItem"})),n.resolve())})).then(function(){(e.authoring&&0===o.length||r)&&!s&&t.push({name:"attachFrom3DX",title:d.views.Header.Iconbar.actions.attach.from3DX,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-plus"},data:null,action:{callback:function(){e.dispatchEvent("request:attachFrom3DX")}}},{name:"attachFromLocalDisk",title:d.views.Header.Iconbar.actions.attach.fromLocalDisk,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-upload"},data:null,action:{callback:function(){e.dispatchEvent("request:attachFromLocalDisk")}}})})).then(function(){return(0===o.length||r)&&e.customCommands.length>0&&(t.push({type:"SeparatorItem"}),e.customCommands.forEach(function(e){t.push(e)})),t})}})}),define("DS/IssueAttachmentManager/views/Attachment",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Performance","DS/Controls/ResponsiveThumbnailView","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/ContextualMenu","DS/Menu/ContextualMenu","DS/IssueAttachmentManager/components/Item","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(e,t,n,i,o,r,s,a,c,l,u,m,d,h){"use strict";var g={CSS:{ELEMENTS:{THUMBNAIL:"isu-am-attachment-thumbnail",ERROR:"isu-am-attachment-error",ERRORICON:"fonticon-alert isu-am-attachment-error-icon",ERRORTEXT:"isu-am-attachment-error-text",ICON:"isu-am-attachment-icon",TITLE:"isu-am-attachment-title",DATE:"isu-am-attachment-date",RELOWNER:"isu-am-attachment-rel-owner",PRIMARYICON:"fonticon-star isu-am-attachment-primary-icon",CANCELBUTTON:"isu-am-attachment-cancelbtn default btn-sm",DISCARDBUTTON:"isu-am-attachment-discardbtn default btn-sm"},STATUS:{FAILED:"is-failed",PRIMARY:"is-primary",PROCESSING:"is-processing",CANCELABLE:"is-cancelable"}}};return e.extend({name:"DS/IssueAttachmentManager/views/Attachment",tagName:"div",className:"isu-am-attachment",_logger:null,model:null,id:null,elements:{thumbnail:null,icon:null,title:null,date:null,relOwner:null},init:function(e){if(!e.hasOwnProperty("model")||t.is(e.model,null)||!(e.model instanceof m))throw new Error(h.replace(h.error.common.incorrectInitArgument,{className:"Attachment",property:"model",type:"DS/IssueAttachmentManager/components/Item"}));let n=e.model._attributes;new c({id:n.id,primaryAttachment:"",attachments:[n]}).select(n.id),this._parent(e)},setup:function(e){s.start(this.name+" setup"),this._parent(e),this._logger=n.getLogger(this.name),this.id=this.model.id,this.container.id=this.id,this.listeners={},this.listenTo(this.model,"onSelect",this._onSelect),this.listenTo(this.model,"onUnselect",this._onUnselect),this.listenTo(this.model,"onChange:thumbnailUrl",this._onChangeThumbnailUrl),this.listenTo(this.model,"onChange:contentUrl",this._onChangeContentUrl),this.listenTo(this.model,"onChange:iconUrl",this._onChangeIconUrl),this.listenTo(this.model,"onChange:title",this._onChangeTitle),this.listenTo(this.model,"onChange:dispType",this._onChangeDispType),this.listenTo(this.model,"onChange:isProcessing",this._onChangeIsProcessing),this.listenTo(this.model,"onChange:isCancelable",this._onChangeIsCancelable),this.listenTo(this.model,"onChange:isFailed",this._onChangeIsFailed),this.listenTo(this.model,"onChange:isPrimary",this._onChangeIsPrimary),this.listenTo(this.model,"onChange:requestProgress",this._onChangeRequestProgress),s.end(this.name+" setup")},render:function(){var e=this;s.start(this.name+" render"),this.container.setAttribute("id","attachment-"+this.id),this.container.setData("id",this.id),!0===this.model.get("isProcessing")&&(this.container.addClassName(g.CSS.STATUS.PROCESSING),o.mask(this.container)),!0===this.model.get("isCancelable")&&this.container.addClassName(g.CSS.STATUS.CANCELABLE),!0===this.model.get("isPrimary")&&this.container.addClassName(g.CSS.STATUS.PRIMARY);["thumbnail","error","icon","title","date","relOwner"].forEach(function(n){e.elements[n]=t.createElement("div",{class:g.CSS.ELEMENTS[n.toUpperCase()]}).inject(e.container)});var n=t.createElement("img",{src:this.model.get("thumbnailUrl")||"",alt:this.model.get("dispType"),title:this.model.get("dispType")});n.inject(e.elements.thumbnail),e.elements.thumbnailImg=n,t.createElement("span",{class:"fonticon "+g.CSS.ELEMENTS.PRIMARYICON,title:h.views.Attachment.isPrimary}).inject(e.container);var r=t.createElement("img",{src:this.model.get("iconUrl")||"",alt:"",title:"",styles:{height:"17px"}});r.inject(e.elements.icon),e.elements.iconImg=r,e.elements.date.innerHTML=this.model.get("relOwner").fullName,e.elements.titleTxt=t.createElement("div",{styles:{"margin-left":"2px",display:"inline"}}).inject(e.elements.title),e.elements.titleTxt.innerHTML=this.model.get("title"),e.elements.titleTxt.title=this.model.get("title");var a=t.createElement("span",{class:"fonticon fonticon-chevron-down wux-ui-3ds",styles:{padding:"2px","font-size":"1.3em","margin-top":"3px"}});return t.is(e.options.bContextmenu)&&1!=e.options.bContextmenu||(a.inject(e.elements.relOwner),t.is(e.model.get("listener"))||"added"==e.model.get("listener")||(e.listeners.chevron=a.addEventListener("click",this._onChevronClick.bind(this)),e.model.set("listener","added"))),e.elements.cancelBtn=new i({value:h.views.Attachment.cancelButton,className:g.CSS.ELEMENTS.CANCELBUTTON}),e.elements.cancelBtn.addEvent("onClick",function(){if(e.model.get("request")){var n=e.model.get("request");t.is(n.cancel,"function")&&(n.cancel(),e.model.set("isFailed",!0),e.model.set("isProcessing",!1))}}),e.elements.cancelBtn.inject(this.container),e.elements.discardBtn=new i({value:h.views.Attachment.discardButton,className:g.CSS.ELEMENTS.DISCARDBUTTON}),e.elements.discardBtn.addEvent("onClick",function(){e.model.collection&&(e.model.collection.unselectAll(),e.model.collection.remove(e.model))}),e.elements.discardBtn.inject(this.container),s.end(this.name+" render"),this},_onSelect:function(){this.container.addClassName("selected")},_onUnselect:function(){this.container.removeClassName("selected")},_onChangeThumbnailUrl:function(e){this.elements.thumbnailImg.src=e.get("thumbnailUrl")},_onChangeContentUrl:function(e){"image"===e.get("documentType")&&(this.elements.thumbnailImg.src=e.get("contentUrl"))},_onChangeIconUrl:function(e){this.elements.iconImg.src=e.get("iconUrl")},_onChangeTitle:function(e){this.elements.title.innerHTML=e.get("title"),this.elements.title.title=e.get("title")},_onChangeDispType:function(e){this.elements.thumbnailImg.title=e.get("dispType"),this.elements.thumbnailImg.alt=e.get("dispType")},_onChangeIsProcessing:function(e){!0===e.get("isProcessing")?(this.container.addClassName(g.CSS.STATUS.PROCESSING),o.mask(this.container)):("image"===e.get("documentType")&&void 0!==e.get("contentUrl")&&null!==e.get("contentUrl")?this.elements.thumbnailImg.src=e.get("contentUrl"):void 0!==e.get("thumbnailUrl")&&null!==e.get("thumbnailUrl")&&(this.elements.thumbnailImg.src=e.get("thumbnailUrl")),void 0!==e.get("iconUrl")&&null!==e.get("iconUrl")&&(this.elements.iconImg.src=e.get("iconUrl")),this.elements.date.innerHTML=this.model.get("relOwner").fullName,this.elements.titleTxt.innerHTML=this.model.get("title"),this.elements.titleTxt.title=this.model.get("title"),this.container.id=e.get("id"),this.container.setAttribute("id","attachment-"+e.get("id")),this.container.setData("id",e.get("id")),this.container.removeClassName(g.CSS.STATUS.PROCESSING),this.container.removeClassName(g.CSS.STATUS.CANCELABLE),o.unmask(this.container))},_onChangeIsCancelable:function(e){!0===e.get("isCancelable")?!0===e.get("isProcessing")&&this.container.addClassName(g.CSS.STATUS.CANCELABLE):this.container.removeClassName(g.CSS.STATUS.CANCELABLE)},_onChangeIsFailed:function(e){!0===e.get("isFailed")?(this.container.addClassName(g.CSS.STATUS.FAILED),t.createElement("span",{class:"fonticon "+g.CSS.ELEMENTS.ERRORICON}).inject(this.elements.error),t.createElement("span",{html:h.views.Attachment.Failures.Upload,class:g.CSS.ELEMENTS.ERRORTEXT}).inject(this.elements.error)):this.container.removeClassName(g.CSS.STATUS.FAILED)},_onChangeIsPrimary:function(e){!0===e.get("isPrimary")?this.container.addClassName(g.CSS.STATUS.PRIMARY):this.container.removeClassName(g.CSS.STATUS.PRIMARY)},_onChangeRequestProgress:function(e){if(e.get("isProcessing")&&o.isMasked(this.container)){var t=this.container.getElement(".mask").getElement("span.text");t&&(t.innerHTML=Math.floor(100*e.get("requestProgress"))+"%")}},_onRelOwnerIconClick:function(){r.getUserProfile(this.model.get("relOwner").user)},_onChevronClick:function(e){this.model.collection.unselectAll(),this.model.select();var t=new Event("contextmenu",{bubbles:!0,cancelable:!1});t.pageX=e.pageX,t.pageY=e.pageY,this.elements.relOwner.dispatchEvent(t),e.stopPropagation()}})}),define("DS/IssueAttachmentManager/views/Catalog",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/UIKIT/Input/Button","DS/UIKIT/Scroller","DS/IssueComponents/utils/Utils","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/ContextualMenu","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/views/Attachment","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(e,t,n,i,o,r,s,a,c,l,u,m,d){"use strict";var h={CSS:{LAYOUTS:{1:"isu-am-catalog-grid",2:"isu-am-catalog-list"},ELEMENTS:{PLACEHOLDER:"isu-am-catalog-placeholder",PLACEHOLDERTEXT:"isu-am-catalog-placeholdertext",PLACEHOLDERTEXTAREA:"isu-am-catalog-placeholdertextarea",PLACEHOLDERBUTTONS:"isu-am-catalog-placeholder-buttons",PLACEHOLDERBUTTON:"isu-am-catalog-placeholder-button",SCROLLCONTENT:"isu-am-catalog-scroll-content",SCROLLCONTAINER:"isu-am-catalog-scroll-container"},CATALOG:{PADDINGRIGHT:5,PADDINGLEFT:5},ATTACHMENT:{CLASSNAME:"isu-am-attachment",WIDTH:150,MARGINRIGHT:10,MARGINLEFT:0},STATUS:{EMPTY:"is-empty"}}};return e.extend({name:"DS/IssueAttachmentManager/views/Catalog",tagName:"div",className:"isu-am-catalog",_logger:null,defaults:{layout:1},defaultOptions:{authoring:!0},init:function(e){if(!e.hasOwnProperty("collection")||t.is(e.collection,null)||!(e.collection instanceof a))throw new Error(d.replace(d.error.common.incorrectInitArgument,{className:"Catalog",property:"collection",type:"DS/IssueAttachmentManager/components/Collection"}));if(e.hasOwnProperty("authoring")&&!t.is(e.authoring,"boolean"))throw new Error(d.replace(d.error.common.incorrectInitArgument,{className:"Catalog",property:"authoring",type:"Boolean"}));if(e.hasOwnProperty("contextualMenu")&&(t.is(e.contextualMenu,null)||!(e.contextualMenu instanceof c)))throw new Error(d.replace(d.error.common.incorrectInitArgument,{className:"Catalog",property:"contextualMenu",type:"DS/IssueAttachmentManager/components/ContextualMenu"}));if(e.hasOwnProperty("layout")){if(!t.is(e.layout,"number"))throw new Error(d.replace(d.error.common.incorrectInitArgument,{className:"Catalog",property:"layout",type:"Number"}));if(!h.CSS.LAYOUTS.hasOwnProperty(e.layout))throw new Error(d.replace(d.error.views.Catalog.unsupportedLayout,{layout:e.layout}))}this._parent(e)},setup:function(e){s.start(this.name+" setup"),this._parent(e),this._logger=n.getLogger(this.name),this.contextualMenu=e.contextualMenu,this.layout=t.is(e.layout)?e.layout:this.defaults.layout,this.authoring=this.options.authoring,this.searchAttachmentCommand=e.searchAttachmentCommand||{getSearchQuery:function(){return Promise.resolve("")}},this.listenTo(this.collection,"onSelect",this._onCollectionSelect.bind(this)),this.listenTo(this.collection,"onUnselect",this._onCollectionUnselect.bind(this)),this.listenTo(this.collection,"onSort",this._onCollectionSort.bind(this)),this.listenTo(this.collection,"onAdd",this._onCollectionAdd.bind(this)),this.listenTo(this.collection,"onRemove",this._onCollectionRemove.bind(this)),this.listenTo(this.collection,"onReset",this._onCollectionReset.bind(this)),s.end(this.name+" setup")},render:function(){var e=this;s.start(this.name+" render"),this.container.addClassName(h.CSS.LAYOUTS[this.layout]),0===e.collection.size()&&this.container.addClassName(h.CSS.STATUS.EMPTY),e.elements.placeholder=t.createElement("div",{class:h.CSS.ELEMENTS.PLACEHOLDER}),e.elements.placeholder.inject(e.container),t.createElement("div",{class:h.CSS.ELEMENTS.PLACEHOLDERTEXT,html:t.createElement("textarea",{html:e.authoring?d.views.Placeholder.text:d.views.Placeholder.textNoAuthoring,class:h.CSS.ELEMENTS.PLACEHOLDERTEXTAREA,rows:2,readonly:!0}),title:e.authoring?d.views.Placeholder.text:d.views.Placeholder.textNoAuthoring}).inject(e.elements.placeholder);var n=t.createElement("div",{class:h.CSS.ELEMENTS.PLACEHOLDERBUTTONS});(n.inject(e.elements.placeholder),e.authoring)&&(new i({className:h.CSS.ELEMENTS.PLACEHOLDERBUTTON+" primary",value:d.views.Placeholder.addExisting,events:{onClick:function(){e.searchAttachmentCommand.getSearchQuery().then(function(t){e.dispatchEvent("request:attachFrom3DX",t)})}}}).inject(n),new i({className:h.CSS.ELEMENTS.PLACEHOLDERBUTTON+" default",value:d.views.Placeholder.upload,events:{onClick:function(){e.dispatchEvent("request:attachFromLocalDisk")}}}).inject(n));this.elements.scrollContent=t.createElement("div",{class:h.CSS.ELEMENTS.SCROLLCONTENT}).inject(this.container),this.elements.scrollContainer=t.createElement("div",{class:h.CSS.ELEMENTS.SCROLLCONTAINER}).inject(e.container);var r=!1;this.contextualMenu instanceof c&&(r=!0),this.attachments={};for(var a=0;a<this.collection.size();a++){var l=this.collection.at(a),m=new u({bContextmenu:r,model:l,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[l.id]=m,m.container.style.order=a,m.container.setAttribute("draggable",!0),m.render().inject(this.elements.scrollContent)}e._scroller=new o({element:this.elements.scrollContent}).inject(this.elements.scrollContainer);var g=function(t){t.target.getParents().some(function(e){return e.hasOwnProperty("hasClassName")&&e.hasClassName(h.CSS.ATTACHMENT.CLASSNAME)})||e.collection.unselectAll()};return e.container.addEventListener("click",g),e.container.addEventListener("contextmenu",g),this.contextualMenu instanceof c&&this.contextualMenu.register(this.container),s.end(this.name+" render"),this},switchLayout:function(e){if(!t.is(e,"number"))throw new Error(d.replace(d.error.common.incorrectArgument,{arg:0,type:"Number"}));if(!h.CSS.LAYOUTS.hasOwnProperty(e))throw new Error(d.replace(d.error.views.Catalog.unsupportedLayout,{layout:e}));return this.container.removeClassName(h.CSS.LAYOUTS[this.layout]),this.container.addClassName(h.CSS.LAYOUTS[e]),this.layout=e,this.dispatchEvent("onSwitchLayout",{layout:this.layout}),this},goToNext:function(e){if(this.collection.size()){var t=-1;if(null!==this.currentPos&&void 0!==this.currentPos&&(t=this.collection.indexOf(this.currentPos)),t<this.collection.size()-1)for(var n=1,i=t>=0?this.collection.size()-t:2;n<i;){var o=this.attachments[this.collection.at(t+n).id];o.model.get("isProcessing")?n++:(e&&o.model.selected&&void 0!==this.currentPos&&this.currentPos.selected&&this.currentPos.unselect(),this._goTo(o,e),this.currentPos=o.model,n=this.collection.size())}}return this},goToPrevious:function(e){if(this.collection.size()){var t=1;if(null!==this.currentPos&&void 0!==this.currentPos&&(t=this.collection.indexOf(this.currentPos)),t>0)for(var n=1;n<t+1;){var i=this.attachments[this.collection.at(t-1).id];i.model.get("isProcessing")?n++:(e&&i.model.selected&&void 0!==this.currentPos&&this.currentPos.selected&&this.currentPos.unselect(),this._goTo(i,e),this.currentPos=i.model,n=t+1)}}return this},goToNextLine:function(e){if(2!==this.layout){if(this.collection.size()){var t=this.container.clientWidth,n=h.CSS.CATALOG.PADDINGRIGHT+h.CSS.CATALOG.PADDINGLEFT,i=h.CSS.ATTACHMENT.WIDTH,o=h.CSS.ATTACHMENT.MARGINRIGHT+h.CSS.ATTACHMENT.MARGINLEFT,r=Math.floor((t-n)/(i+o)),s=-r;if(null!==this.currentPos&&void 0!==this.currentPos?s=this.collection.indexOf(this.currentPos):this.currentPos=this.collection.at(0),s<this.collection.size()-r){var a=this.attachments[this.collection.at(s+r).id],c=this.attachments[this.currentPos.id];this._goTo(a,e,c,!0),e&&(c.shiftKeySelected=!0),this.currentPos=a.model}}}else this.goToNext(e)},goToPreviousLine:function(e){if(2!==this.layout){if(this.collection.size()){var t=this.container.clientWidth,n=h.CSS.CATALOG.PADDINGRIGHT+h.CSS.CATALOG.PADDINGLEFT,i=h.CSS.ATTACHMENT.WIDTH,o=h.CSS.ATTACHMENT.MARGINRIGHT+h.CSS.ATTACHMENT.MARGINLEFT,r=Math.floor((t-n)/(i+o)),s=+r;if(null!==this.currentPos&&void 0!==this.currentPos?s=this.collection.indexOf(this.currentPos):this.currentPos=this.collection.at(0),s>=r){var a=this.attachments[this.collection.at(s-r).id],c=this.attachments[this.currentPos.id];this._goTo(a,e,c,!0),e&&(c.shiftKeySelected=!0),this.currentPos=a.model}}}else this.goToPrevious(e)},_goTo:function(e,t,n,i){var o=this;if(t&&n){var r=this.collection.getSelectedItems().map(function(e){return o.attachments.hasOwnProperty(e.id)?o.attachments[e.id]:void 0});if(r.length>0)if(1===r.length&&r[0]===e)e.model.select();else{var s=[],a=Math.min(e.container.style.order,n.container.style.order),c=Math.max(e.container.style.order,n.container.style.order);for(var l in o.attachments)o.attachments.hasOwnProperty(l)&&a<=o.attachments[l].container.style.order&&o.attachments[l].container.style.order<=c&&!1===o.attachments[l].model.get("isProcessing")&&(i&&(o.attachments[l].shiftKeySelected=!0),s.push(l));var u=o.collection.getSelectedItems().filter(function(e){return o.attachments[e.id].shiftKeySelected&&-1===s.indexOf(e.id)}).map(function(e){return e.id});s=s.concat(u);var m=this.collection.toArray().map(function(e){return e.id});m=m.filter(function(e){return s.indexOf(e)<0}),this.collection.unselect(m),this.collection.select(s)}else e.model.select()}else{if(!t){var d=this.collection.toArray().map(function(e){return e.id}),h=d.indexOf(e.id);d.splice(h,1),this.collection.unselect(d)}e.model.selected||e.model.select()}},_onAttachmentClick:function(e){if(this.attachments.hasOwnProperty(e.currentTarget.getData("id"))){var t=this.attachments[e.currentTarget.getData("id")];if(e.ctrlKey)t.model.selected&&"contextmenu"!==e.type?t.model.unselect():(t.model.select(),t.shiftKeySelected=!1);else if(e.shiftKey){var n=this.attachments[this.currentPos.id];this._goTo(t,!0,n,!0)}else{var i="contextmenu"===e.type&&t.model.selected||"dragstart"===e.type&&t.model.selected;this._goTo(t,i),t.shiftKeySelected=!1}this.currentPos=t.model}},_onAttachmentDrag:function(e){if(this._onAttachmentClick(e),this.attachments.hasOwnProperty(e.currentTarget.getData("id"))){var t=this.attachments[e.currentTarget.getData("id")];e.dataTransfer.setDragImage(t.container,e.offsetX,e.offsetY);var n=this.collection.getSelectedItems().map(function(e){return{options:{id:e.id,type:e.get("type"),name:e.get("title")}}}),i=r.setDroppableData(n),o={type:i.type,data:JSON.stringify(i.data)};e.dataTransfer.setData(o.type,o.data)}},_onCollectionSelect:function(e){if(e.hasOwnProperty("ids")&&!t.is(e.ids,null)&&t.is(e.ids,"array")){var n=this.collection.getSelectedItems();if(n.length>0){1===n.length&&(this.current=this.attachments[n[0].id]);var i=null;if(this.currentPos&&this.attachments[this.currentPos.id]?i=this.attachments[this.currentPos.id]:this.current&&(i=this.current),i){var o={x:this._scroller._infos.x.scrollPosition,xSize:this._scroller._infos.x.offsetSize,y:this._scroller._infos.y.scrollPosition,ySize:this._scroller._infos.y.offsetSize},r={x:i.container.offsetLeft,y:i.container.offsetTop};r.y<=o.y?this._scroller.scrollToElement(i.container,"top"):r.y>=o.y+o.ySize&&this._scroller.scrollToElement(i.container,"bottom")}}else this.current=null}else{var s=d.replace(d.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(s)}},_onCollectionUnselect:function(e){if(e.hasOwnProperty("ids")&&!t.is(e.ids,null)&&t.is(e.ids,"array")){for(var n=0;n<e.ids.length;n++){var i=e.ids[n];this.attachments.hasOwnProperty(i)&&(this.attachments[i].model.shiftKeySelected=!1)}0===this.collection.getSelectedItems().length&&(this.current=null)}else{var o=d.replace(d.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(o)}},_onCollectionSort:function(){for(var e=0;e<this.collection.size();e++){var t=this.collection.at(e);this.attachments[t.id].container.style.order=e}},_onCollectionAdd:function(e){var t=!1;this.contextualMenu instanceof c&&(t=!0);var n=new u({bContextmenu:t,model:e,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[e.id]=n,n.container.style.order="-1",n.render().inject(this._scroller.getInnerElement()),this.container.toggleClassName(h.CSS.STATUS.EMPTY,0===this.collection.size())},_onCollectionRemove:function(e){this.attachments.hasOwnProperty(e.id)&&(this.attachments[e.id].destroy(),delete this.attachments[e.id],this.currentPos&&this.currentPos.id===e.id&&(this.currentPos=null)),this.container.toggleClassName(h.CSS.STATUS.EMPTY,0===this.collection.size())},_onCollectionReset:function(){for(var e=Object.keys(this.attachments),t=0;t<e.length;t++)this.attachments[e[t]].destroy(),delete this.attachments[e[t]];var n=!1;this.contextualMenu instanceof c&&(n=!0),this.attachments={};for(var i=0;i<this.collection.size();i++){var o=this.collection.at(i),r=new u({bContextmenu:n,model:o,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[o.id]=r,r.container.style.order=i,r.render().inject(this.elements.scrollContent)}this.container.toggleClassName(h.CSS.STATUS.EMPTY,0===this.collection.size())}})}),define("DS/IssueAttachmentManager/views/UploadDialog",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/ENOFloatingPanel/ENOFloatingPanel","DS/IssueServices/Contexts","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/views/Catalog","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(e,t,n,i,o,r,s,a,c,l){"use strict";var u={DIALOG:"isu-am-upload-dialog"};return e.extend({name:"DS/IssueAttachmentManager/views/UploadDialog",tagName:"div",className:u.DIALOG,_logger:null,defaultOptions:{},init:function(e){if(!e.hasOwnProperty("collection")||t.is(e.collection,null)||!(e.collection instanceof s))throw new Error(l.replace(l.error.common.incorrectInitArgument,{className:"UploadDialog",property:"collection",type:"DS/IssueAttachmentManager/components/Collection"}));this._parent(e)},setup:function(e){r.start(this.name+" setup"),this._parent(e),this._logger=n.getLogger(this.name),r.end(this.name+" setup")},render:function(){var e=this;r.start(this.name+" render"),e.catalog=new a({collection:e.collection,layout:2}).render();var n=e.collection.size(),s=0,c=0,m=l.replace(l.views.UploadDialog.title,{number:e.collection.size(),success:0,failure:0});e.modal=new i({animate:!0,autocenter:!0,closable:!0,limitParent:!1,overlay:!1,resizable:!0,visible:!0,className:u.DIALOG,title:m,header:null,body:e.catalog,events:{onClose:function(){n===s+c?(e.modal.destroy(),t.is(e.status)&&t.is(e.status.loading)&&e.status.loading.hide()):e.modal.hide()}}}),e.modal.inject(e.container),e.status=o.get("status"),t.is(e.status)&&t.is(e.status.loading)?(e.status.loading.start({isClickable:!0}),e.status.loading.update(m),e.status.loading.setClickListener(function(){e.modal.show(),n===s+c&&e.status.loading.hide()}),e.modal.hide()):e.status=null;for(var d=function(){var i;!1===this.get("isProcessing")&&(1===this.get("requestProgress")&&!0!==this.get("isFailure")?s++:this.get("isFailure")&&c++),n===s+c?(i=s===n?l.replace(l.views.UploadDialog.uploadSuccess,{total:n}):l.replace(l.views.UploadDialog.uploadFailure,{total:n,success:s,failure:c}),t.is(e.status)&&t.is(e.status.loading)&&e.status.loading.stop(i)):(i=l.replace(l.views.UploadDialog.title,{total:n,success:s,failure:c}),t.is(e.status)&&t.is(e.status.loading)&&e.status.loading.update(i)),e.modal.setTitle(i)},h=0;h<n;h++){var g=e.collection.at(h);e.listenTo(g,"onChange:isProcessing",d.bind(g))}return r.end(this.name+" render"),this}})}),define("DS/IssueAttachmentManager/views/Header",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/UIKIT/Iconbar","DS/UIKIT/Mask","DS/ENO6WPlugins/jQuery","DS/PlatformAPI/PlatformAPI","DS/PADUtils/views/PADAlert","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance","DS/IssueCommon/utils/DocumentUtils","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueAttachmentManager/views/Attachment","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(e,t,n,i,o,r,s,a,c,l,u,m,d,h,g,p,f,v,E){"use strict";var y={ELEMENTS:{INFO:"isu-am-header-info",INFO_REL_OWNER_CONTAINER:"isu-am-header-info-rel-owner-ctn",INFO_REL_OWNER_ICON:"isu-am-header-info-rel-owner-icon",INFO_REL_OWNER_TEXT:"isu-am-header-info-rel-owner-txt",INFO_DATE_CONTAINER:"isu-am-header-info-date-ctn",INFO_DATE_ICON:"fonticon-calendar isu-am-header-info-date-icon",INFO_DATE_TEXT:"isu-am-header-info-date-txt",INFO_MULTI_CONTAINER:"isu-am-header-info-multi-ctn",INFO_MULTI_ICON:"fonticon-docs isu-am-header-info-multi-icon",INFO_MULTI_TEXT:"isu-am-header-info-multi-txt",ICONBAR_CTN:"isu-am-header-iconbar-ctn",ICONBAR_CTN_FIX:"isu-am-header-iconbar-ctn-fix",ICONBAR_TOGGLE_ACTIVE:"active",ANNOTATION:"isu-am-annotation"},STATUS:{EMPTY:"is-empty",MULTI:"is-multi"}};return e.extend({name:"DS/IssueAttachmentManager/views/Header",tagName:"div",className:"isu-am-header",_logger:null,defaultOptions:{authoring:!0,annotationPreLaunchCallback:function(){},annotationSaveCallback:function(){},annotationExitCallback:function(){}},init:function(e){if(!e.hasOwnProperty("collection")||t.is(e.collection,null)||!(e.collection instanceof h))throw new Error(E.replace(E.error.common.incorrectInitArgument,{className:"Header",property:"collection",type:"DS/IssueAttachmentManager/components/Collection"}));if(e.hasOwnProperty("authoring")&&!t.is(e.authoring,"boolean"))throw new Error(E.replace(E.error.common.incorrectInitArgument,{className:"Header",property:"authoring",type:"Boolean"}));if(e.hasOwnProperty("annotationSaveCallback")&&!t.is(e.annotationSaveCallback,"function"))throw new Error(E.replace(E.error.common.incorrectInitArgument,{className:"Header",property:"annotationSaveCallback",type:"Function"}));if(e.hasOwnProperty("annotationPreLaunchCallback")&&!t.is(e.annotationPreLaunchCallback,"function"))throw new Error(E.replace(E.error.common.incorrectInitArgument,{className:"Header",property:"annotationPreLaunchCallback",type:"Function"}));if(e.hasOwnProperty("annotationExitCallback")&&!t.is(e.annotationExitCallback,"function"))throw new Error(E.replace(E.error.common.incorrectInitArgument,{className:"Header",property:"annotationExitCallback",type:"Function"}));this._parent(e)},setup:function(e){var i=this;m.start(i.name+" setup"),i._parent(e),i._logger=n.getLogger(i.name),i.authoring=i.options.authoring,i.current=null,i.annotation=null,i.listeners={},i.bo=i.options.bo,this.listenTo(this.collection,"onSelect",this._onCollectionSelect.bind(this)),this.listenTo(this.collection,"onUnselect",this._onCollectionUnselect.bind(this));var o=c.get("eventsHandler");if(i._subscriberId=Math.random().toString(36).substr(2,9),i._eventListeners=[{event:"DS/Object/update",listener:function(e){1==e.data.paths.length&&u.issues.retrieve({data:{objects:[{physicalId:e.data.paths[0]}]}}).then(function(e){var t=e.results[0].body;i.bo=t,i.refresh()})},conditions:{type:"issue",attributes:["state"]}}],t.is(o))for(var r=0;r<i._eventListeners.length;r++){var s=i._eventListeners[r];s.token=o.subscribe(i._subscriberId,s.event,s.listener.bind(i),s.conditions)}m.end(i.name+" setup")},render:function(){var e=this;m.start(this.name+" render"),this.container.addClassName(y.STATUS.EMPTY),e.elements.info=t.createElement("div",{class:y.ELEMENTS.INFO}),e.elements.iconBarCtn=t.createElement("div",{class:y.ELEMENTS.ICONBAR_CTN}),e.elements.iconBarCtnFixed=t.createElement("div",{class:y.ELEMENTS.ICONBAR_CTN_FIX});var n=[],o=[{name:"openWith",fonticon:"open-menu-dot",text:E.views.Header.Iconbar.actions.openWith,content:{type:"dropdownmenu",options:{items:[{id:"openWithNoApps",text:E.views.Header.Iconbar.actions.openWithNoApps,selectable:!1}],events:{onShow:function(){e._setOpenWithSubMenus(this,e.collection.getSelectedItems())}}}}},{id:"download",fonticon:"download",text:E.views.Header.Iconbar.actions.download,selectable:!0,handler:function(){var t={from:"attachments",selected:e.collection.getSelectedItems()};d.download(t)}}];(n=n.concat(o)).push({id:"setAsPrimary",fonticon:"star",text:E.views.Header.Iconbar.actions.setAsPrimary,selectable:!0,handler:function(){e.dispatchEvent("request:setAsPrimary",{item:e.current,lock:!0})}}),e.authoring&&n.push({id:"annotate",fonticon:"highlighter",text:E.views.Header.Iconbar.actions.annotate,selectable:!0,handler:function(){e.dispatchEvent("request:annotate")}}),n.push({id:"detachDelete",fonticon:"trash",text:E.views.Header.Iconbar.actions.detachDelete.title,content:{type:"dropdownmenu",options:{items:[{id:"detach",fonticon:"wux-ui-3ds wux-ui-3ds-1x fonticon-remove",text:E.views.Header.Iconbar.actions.detachDelete.detach,selectable:!1,handler:function(){e.dispatchEvent("request:detach")}},{id:"delete",fonticon:"wux-ui-3ds wux-ui-3ds-1x fonticon-trash",text:E.views.Header.Iconbar.actions.detachDelete.delete,selectable:!1,handler:function(){e.dispatchEvent("request:delete")}}]}}});var r=widget.getValue("attachmentManagerPreferences");t.is(r)&&t.is(r.catalogLayout)||(r={catalogLayout:1});var s=[{className:"divider"},{id:"groupByType",fonticon:"group",text:E.views.Header.Iconbar.actions.sort.groupByType,selectable:!0,content:{type:"dropdownmenu",options:{items:[{id:"groupNone",description:E.views.Header.Iconbar.actions.sort.ascDate,text:E.views.Header.Iconbar.actions.sort.groupBy_None,selected:!e.collection.groupByType,handler:function(){e.dispatchEvent("request:groupByType",{sortByOrder:"None"})}},{id:"groupType",text:E.views.Header.Iconbar.actions.sort.groupBy_Type,description:E.views.Header.Iconbar.actions.sort.ascDate,selected:e.collection.groupByType,handler:function(){e.dispatchEvent("request:groupByType",{sortByOrder:"Type"})}}]}}},{id:"sort",fonticon:"sorting",text:E.views.Header.Iconbar.actions.sort.dropdown,selectable:!0,content:{type:"icondropdown",options:{items:[{id:"sortAscDate",fonticon:"sort-num-asc",description:E.views.Header.Iconbar.actions.sort.ascDate,selected:"ascending"===e.collection.sortOrder&&"date"===e.collection.sortMode,handler:function(){e.dispatchEvent("request:sort",{sortOrder:"ascending",sortMode:"date"})}},{id:"sortDescDate",fonticon:"sort-num-desc",description:E.views.Header.Iconbar.actions.sort.descDate,selected:"descending"===e.collection.sortOrder&&"date"===e.collection.sortMode,handler:function(){e.dispatchEvent("request:sort",{sortOrder:"descending",sortMode:"date"})}},{id:"sortAscTitle",fonticon:"sort-alpha-asc",description:E.views.Header.Iconbar.actions.sort.ascTitle,selected:"ascending"===e.collection.sortOrder&&"title"===e.collection.sortMode,handler:function(){e.dispatchEvent("request:sort",{sortOrder:"ascending",sortMode:"title"})}},{id:"sortDescTitle",fonticon:"sort-alpha-desc",description:E.views.Header.Iconbar.actions.sort.descTitle,selected:"descending"===e.collection.sortOrder&&"title"===e.collection.sortMode,handler:function(){e.dispatchEvent("request:sort",{sortOrder:"descending",sortMode:"title"})}}]}}},{id:"switchCatalogLayout",fonticon:r.catalogLayout%2!=1?"view-list":"view-small-thb",text:E.views.Header.Iconbar.actions.switchCatalogLayout,selectable:!0,content:{type:"dropdownmenu",options:{items:[{id:"catalogLayoutGrid",description:E.views.Header.Iconbar.actions.sort.ascDate,text:E.views.Header.Iconbar.actions.switchCatalogLayout_GV,fonticon:"view-list",selected:r.catalogLayout%2!=1,handler:function(){e.dispatchEvent("request:catalogSwitchLayout",{layout:"GridView"})}},{id:"catalogLayoutThumbnail",text:E.views.Header.Iconbar.actions.switchCatalogLayout_TV,fonticon:"view-small-thb",description:E.views.Header.Iconbar.actions.sort.ascDate,selected:r.catalogLayout%2==1,handler:function(){e.dispatchEvent("request:catalogSwitchLayout",{layout:"ThumbnailView"})}}]}}}];return e.authoring&&(n.push({id:"attach_divider",className:"divider"}),n.push({id:"attachFrom3DX",text:E.views.Header.Iconbar.actions.attach.from3DX,fonticon:"plus",selectable:!1,handler:function(){e.dispatchEvent("request:attachFrom3DX")}},{id:"attachFromLocalDisk",fonticon:"upload",text:E.views.Header.Iconbar.actions.attach.fromLocalDisk,selectable:!1,handler:function(){e.dispatchEvent("request:attachFromLocalDisk")}}),n.push({id:"screenshot",fonticon:"camera",text:E.views.Header.Iconbar.actions.screenshotAvailable,selectable:!0,handler:function(){e.dispatchEvent("request:screenshot")}})),e.iconBar=new i({renderTo:e.elements.iconBarCtn,items:n}),e.elements.iconBarCtn.inject(e.container),e.iconBarFix=new i({renderTo:e.elements.iconBarCtnFixed,items:s}),e.elements.iconBarCtnFixed.inject(e.container),e.listenTo(e.iconBar.overflowMenu,"onShow",function(){e.iconBar.overflowMenu.menus.forEach(function(t){t.parentItem&&"openWith"===t.parentItem.name&&e._setOpenWithSubMenus(t,e.collection.getSelectedItems())})}),e.refresh(),this.iconBar.getItem("openWith").elements.container.hide(),this.iconBar.getItem("download").elements.container.hide(),this.iconBar.getItem("detachDelete").elements.container.hide(),this.iconBar.getItem("setAsPrimary").elements.container.hide(),m.end(this.name+" render"),this},refresh:function(){var e=!1;t.is(this.bo)&&t.is(this.bo.state)&&"Closed"==this.bo.state&&(e=!0),this.iconBar.enableItem("openWith"),this.iconBar.enableItem("download"),this.iconBar.enableItem("detachDelete"),this.iconBar.enableItem("annotate"),this.iconBar.enableItem("setAsPrimary"),this.iconBar.getItem("openWith").elements.container.show(),this.iconBar.getItem("download").elements.container.show(),this.iconBar.getItem("detachDelete").elements.container.show(),this.iconBar.getItem("annotate").elements.container.show(),this.iconBar.getItem("setAsPrimary").elements.container.show();var n=this.collection.getSelectedItems();if(1===n.length)this.current=n[0],this.container.removeClassName(y.STATUS.EMPTY),this.container.removeClassName(y.STATUS.MULTI),"Document"!==this.current.get("type")&&(this.iconBar.disableItem("download"),this.iconBar.getItem("download").elements.container.hide()),"Document"===this.current.get("type")&&"image"===this.current.get("documentType")||(this.iconBar.disableItem("annotate"),this.iconBar.disableItem("setAsPrimary"),this.iconBar.getItem("annotate").elements.container.hide(),this.iconBar.getItem("setAsPrimary").elements.container.hide()),!0!==this.current.get("isProcessing")&&!0!==this.current.get("isFailed")||(this.iconBar.disableItem("openWith"),this.iconBar.disableItem("download"),this.iconBar.disableItem("detachDelete"),this.iconBar.disableItem("annotate"),this.iconBar.disableItem("setAsPrimary"),this.iconBar.getItem("openWith").elements.container.hide(),this.iconBar.getItem("download").elements.container.hide(),this.iconBar.getItem("detachDelete").elements.container.hide(),this.iconBar.getItem("annotate").elements.container.hide(),this.iconBar.getItem("setAsPrimary").elements.container.hide());else if(n.length>1){this.current=null,this.container.removeClassName(y.STATUS.EMPTY),this.container.addClassName(y.STATUS.MULTI),n.every(function(e){return"Document"===e.get("type")})||(this.iconBar.disableItem("download"),this.iconBar.getItem("download").elements.container.hide()),n.some(function(e){return!0===e.get("isProcessing")||!0===e.get("isFailed")})&&(this.iconBar.disableItem("openWith"),this.iconBar.disableItem("download"),this.iconBar.disableItem("detachDelete"),this.iconBar.getItem("openWith").elements.container.hide(),this.iconBar.getItem("download").elements.container.hide(),this.iconBar.getItem("detachDelete").elements.container.hide()),this.iconBar.disableItem("annotate"),this.iconBar.disableItem("setAsPrimary"),this.iconBar.getItem("annotate").elements.container.hide(),this.iconBar.getItem("setAsPrimary").elements.container.hide()}else this.current=null,this.container.addClassName(y.STATUS.EMPTY),this.container.removeClassName(y.STATUS.MULTI),this.iconBar.disableItem("openWith"),this.iconBar.disableItem("download"),this.iconBar.disableItem("detachDelete"),this.iconBar.disableItem("setAsPrimary"),this.iconBar.getItem("openWith").elements.container.hide(),this.iconBar.getItem("download").elements.container.hide(),this.iconBar.getItem("detachDelete").elements.container.hide(),this.iconBar.getItem("setAsPrimary").elements.container.hide();e&&(this.iconBar.disableItem("annotate"),this.iconBar.disableItem("setAsPrimary"),this.iconBar.disableItem("detachDelete"),this.iconBar.disableItem("attachFrom3DX"),this.iconBar.disableItem("attachFromLocalDisk"),this.iconBar.disableItem("screenshot"),this.iconBar.getItem("annotate").elements.container.hide(),this.iconBar.getItem("setAsPrimary").elements.container.hide(),this.iconBar.getItem("detachDelete").elements.container.hide(),this.iconBar.getItem("attachFrom3DX").elements.container.hide(),this.iconBar.getItem("attachFromLocalDisk").elements.container.hide(),this.iconBar.getItem("screenshot").elements.container.hide(),this.iconBar.getItem("attach_divider").elements.container.hide()),this.iconBar.resize(),this.iconBarFix.resize()},_setOpenWithSubMenus:function(e,n){var i=this;e.items.reduce(function(e,t){return e.push(t.id),e},[]).forEach(function(t){e.removeItem(t)}),Array.isArray(e.menus)&&(e.menus.length=1),p.getCompatibleApps(n).then(function(o){t.is(o,"array")&&o.length>0?o.map(function(e){var t={id:e.name,text:e.text,selectable:!1,handler:function(){i.dispatchEvent("request:openWith",{app:e,objects:n,arguments:arguments,context:this})}};return null!=e.fonticon?t.fonticon=e.fonticon:t.icon=e.icon,t}).forEach(function(t){e.addItem(t)}):e.addItem({id:"openWithNoApps",text:E.views.Header.Iconbar.actions.openWithNoApps,selectable:!1})})},_onCollectionSelect:function(e){if(e.hasOwnProperty("ids")&&!t.is(e.ids,null)&&t.is(e.ids,"array"))e.ids.length>1||this.collection.getSelectedItems().length,this.refresh();else{var n=E.replace(E.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(n)}},_onCollectionUnselect:function(e){if(e.hasOwnProperty("ids")&&!t.is(e.ids,null)&&t.is(e.ids,"array"))this.refresh();else{var n=E.replace(E.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(n)}}})}),define("DS/IssueAttachmentManager/views/Viewer",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/Controls/Button","DS/Controls/Slider","DS/PADUtils/views/PADAlert","DS/UIKIT/Input/Button","DS/IssueCommon/utils/Utils","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/ContextualMenu","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueAttachmentManager/views/Attachment","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(e,t,n,i,o,r,s,a,c,l,u,m,d,h,g,p){"use strict";var f=100,v={ELEMENTS:{PLACEHOLDER:"isu-am-viewer-placeholder",PLACEHOLDERTEXT:"isu-am-viewer-placeholdertext",PLACEHOLDERBUTTONS:"isu-am-viewer-placeholder-buttons",PLACEHOLDERBUTTON:"isu-am-viewer-placeholder-button",CONTENT:"isu-am-viewer-content",FOOTERTITLECONTAINER:"isu-am-viewer-footer-titlectn",FOOTERTITLEICON:"isu-am-viewer-footer-titleicon",FOOTERTITLETEXT:"isu-am-viewer-footer-titletxt",FOOTERZOOMCONTAINER:"isu-am-viewer-footer-zoomctn",FOOTERZOOMTXT:"isu-am-viewer-footer-zoomtxt",FOOTERZOOMCMDCONTAINER:"isu-am-viewer-footer-zoomcmdctn",FOOTERZOOMSLIDER:"isu-am-viewer-footer-zoomslider",BODY:"isu-am-viewer-body",BODYIMAGE:"isu-am-viewer-body-image",BODYVIDEO:"isu-am-viewer-body-video",BODYAUDIO:"isu-am-viewer-body-audio",BODYNOPREVIEW:"isu-am-viewer-body-nopreview",FOOTER:"isu-am-viewer-footer"},STATUS:{EMPTY:"is-empty",MULTI:"is-multi",FAILED:"is-failed"}};return e.extend({name:"DS/IssueAttachmentManager/views/Viewer",tagName:"div",className:"isu-am-viewer",_logger:null,defaultOptions:{authoring:!0},init:function(e){if(!e.hasOwnProperty("collection")||t.is(e.collection,null)||!(e.collection instanceof l))throw new Error(p.replace(p.error.common.incorrectInitArgument,{className:"Viewer",property:"collection",type:"DS/IssueAttachmentManager/components/Collection"}));if(e.hasOwnProperty("authoring")&&!t.is(e.authoring,"boolean"))throw new Error(p.replace(p.error.common.incorrectInitArgument,{className:"Viewer",property:"authoring",type:"Boolean"}));if(e.hasOwnProperty("contextualMenu")&&(t.is(e.contextualMenu,null)||!(e.contextualMenu instanceof u)))throw new Error(p.replace(p.error.common.incorrectInitArgument,{className:"Viewer",property:"contextualMenu",type:"DS/IssueAttachmentManager/components/ContextualMenu"}));this._parent(e)},setup:function(e){c.start(this.name+" setup"),this._parent(e),this._logger=n.getLogger(this.name),this.contextualMenu=e.contextualMenu,this.current=null,this._listeners={},this.elements={},this.authoring=this.options.authoring,this.listenTo(this.collection,"onSelect",this._onCollectionSelect.bind(this)),this.listenTo(this.collection,"onUnselect",this._onCollectionUnselect.bind(this)),this.listenTo(this.collection,"onAdd",this._onCollectionAdd.bind(this)),this.listenTo(this.collection,"onRemove",this._onCollectionRemove.bind(this)),this.refresh=this.debounce(this._refresh.bind(this),f),c.end(this.name+" setup")},render:function(){var e=this;c.start(this.name+" render"),this.container.toggleClassName(v.STATUS.EMPTY,0===this.collection.size()),this.contextualMenu instanceof u&&this.contextualMenu.register(this.container),e.elements.placeholder=t.createElement("div",{class:v.ELEMENTS.PLACEHOLDER}),e.elements.placeholder.inject(e.container),t.createElement("div",{class:v.ELEMENTS.PLACEHOLDERTEXT,html:e.authoring?p.views.Placeholder.text:p.views.Placeholder.textNoAuthoring,title:e.authoring?p.views.Placeholder.text:p.views.Placeholder.textNoAuthoring}).inject(e.elements.placeholder);var n=t.createElement("div",{class:v.ELEMENTS.PLACEHOLDERBUTTONS});(n.inject(e.elements.placeholder),e.authoring)&&(new s({className:v.ELEMENTS.PLACEHOLDERBUTTON+" primary",value:p.views.Placeholder.addExisting,events:{onClick:function(){e.dispatchEvent("request:attachFrom3DX")}}}).inject(n),new s({className:v.ELEMENTS.PLACEHOLDERBUTTON+" default",value:p.views.Placeholder.upload,events:{onClick:function(){e.dispatchEvent("request:attachFromLocalDisk")}}}).inject(n));return e.elements.content=t.createElement("div",{class:v.ELEMENTS.CONTENT}),e.elements.content.inject(e.container),e.elements.body=t.createElement("div",{class:v.ELEMENTS.BODY}),e.elements.body.inject(e.elements.content),e.elements.footer=t.createElement("div",{class:v.ELEMENTS.FOOTER}),e.elements.footerTitleCtn=t.createElement("div",{class:v.ELEMENTS.FOOTERTITLECONTAINER}).inject(e.elements.footer),e.elements.footerTitleIcon=t.createElement("img",{class:v.ELEMENTS.FOOTERTITLEICON}),e.elements.footerTitleIcon.inject(e.elements.footerTitleCtn),e.elements.footerTitleTxt=t.createElement("div",{class:v.ELEMENTS.FOOTERTITLETEXT}).inject(e.elements.footerTitleCtn),e.elements.footer.inject(e.elements.content),e.elements.footerZoomCtn=t.createElement("div",{class:v.ELEMENTS.FOOTERZOOMCONTAINER}).inject(e.elements.footer),e.elements.footerZoomTxt=t.createElement("div",{class:v.ELEMENTS.FOOTERZOOMTXT,html:"100%"}).inject(e.elements.footerZoomCtn),e.elements.footerZoomCmdCtn=t.createElement("div",{class:v.ELEMENTS.FOOTERZOOMCMDCONTAINER}).inject(e.elements.footerZoomCtn),e.elements.footerZoomMinus=new i({emphasize:"secondary",type:"button",icon:{iconName:"minus"},onClick:function(){e.elements.footerZoomSlider.value-50>e.elements.footerZoomSlider.minValue?e.elements.footerZoomSlider.value-=50:e.elements.footerZoomSlider.value=e.elements.footerZoomSlider.minValue},allowUnsafeHTMLLabel:!0}).inject(e.elements.footerZoomCmdCtn),e.elements.footerZoomSlider=new o({className:v.ELEMENTS.FOOTERZOOMSLIDER,value:100,minValue:100,maxValue:500,stepValue:2}).inject(e.elements.footerZoomCmdCtn),e.elements.footerZoomSlider.addEventListener("change",function(t){e.elements.footerZoomTxt.innerHTML=t.dsModel.value+"%",e.elements.bodyImage&&e.elements.bodyImage.setStyle("transform","scale("+t.dsModel.value/100+")")}),e.elements.footerZoomPlus=new i({emphasize:"secondary",type:"button",icon:{iconName:"plus"},onClick:function(){e.elements.footerZoomSlider.value+50<e.elements.footerZoomSlider.maxValue?e.elements.footerZoomSlider.value+=50:e.elements.footerZoomSlider.value=e.elements.footerZoomSlider.maxValue},allowUnsafeHTMLLabel:!0}).inject(e.elements.footerZoomCmdCtn),e.elements.footerZoomReset=new i({emphasize:"secondary",type:"button",icon:{iconName:"refresh"},onClick:function(){e.elements.footerZoomSlider.value=100,e.elements.bodyImage.style.top="0px",e.elements.bodyImage.style.left="0px"},allowUnsafeHTMLLabel:!0}).inject(e.elements.footerZoomCmdCtn),c.end(this.name+" render"),this},destroy:function(){this._debounceTimeouts.forEach(function(e){clearTimeout(e)}),this._debounceTimeouts=[],this._parent()},_refresh:function(){var e=this.collection.getSelectedItems();if(this.container.toggleClassName(v.STATUS.EMPTY,0===this.collection.size()),this.container.removeClassName(v.STATUS.MULTI),this.elements.footer.hide(),this.elements.footerTitleCtn.setStyle("max-width","100%"),this.elements.footerZoomCtn.hide(),this._listeners.wheel&&this.elements.content.removeEventListener("wheel",this._listeners.wheel),this.elements.bodyImage&&(this.elements.bodyImage.destroy(),delete this.elements.bodyImage),this.elements.bodyVideo&&(this.elements.bodyVideo.destroy(),delete this.elements.bodyVideo),1===e.length){if(this.current=e[0],this.listenTo(this.current,"onChange:contentUrl",this._onCurrentItemChangeContentUrl),this.container.toggleClassName(v.STATUS.FAILED,this.current.get("isFailed")),this.elements.footer.show(),this.current.get("isFailed")||(this.elements.footerTitleIcon.src=this.current.get("iconUrl"),this.elements.footerTitleIcon.alt=this.current.get("type"),this.elements.footerTitleIcon.title=this.current.get("type")),this.elements.footerTitleTxt.innerHTML=this.current.get("title"),this.elements.footerTitleTxt.title=this.current.get("title"),this.elements.body.setContent(t.createElement("span",{html:p.views.Viewer.noPreview,class:v.ELEMENTS.BODYNOPREVIEW})),!this.current.get("isFailed")&&!this.current.get("isProcessing")&&"Document"===this.current.get("type"))switch(this.current.get("documentType")){case"image":this._renderBodyForImage();break;case"video":this._renderBodyForVideo();break;case"audio":this._renderBodyForAudio()}}else e.length>1?(this.current=null,this.elements.body.setContent(t.createElement("span",{html:p.views.Viewer.noPreview,class:v.ELEMENTS.BODYNOPREVIEW})),this.container.addClassName(v.STATUS.MULTI)):(this.current=null,this.elements.body.setContent(t.createElement("span",{html:p.views.Viewer.noSelection,class:v.ELEMENTS.BODYNOPREVIEW})))},_renderBodyForImage:function(){var e=this;this.elements.body.empty(),this.elements.bodyImage=t.createElement("div",{class:v.ELEMENTS.BODYIMAGE,title:this.current.get("title")}),this.current.get("contentUrl")&&this.elements.bodyImage.setStyle("background-image","url("+this.current.get("contentUrl")+")"),this.elements.bodyImage.inject(this.elements.body),this.elements.footerZoomSlider.value=100,this.elements.footerZoomCtn.show(),this.elements.footerTitleCtn.setStyle("max-width","calc(100% - "+this.elements.footerZoomCtn.clientWidth+"px)"),e._listeners.wheel=e._onImageMouseWheel.bind(e),this.elements.content.addEventListener("wheel",e._listeners.wheel);var n=0,i=0,o=0,r=0,s=this.elements.bodyImage;s.style.top="0px",s.style.left="0px";e.container.addEventListener("mousedown",function(t){t.target===s&&(t.preventDefault(),o=t.clientX,r=t.clientY,s.setStyle("z-index","91"),e.container.addEventListener("mouseup",a),s.addEventListener("mousemove",c))});var a=function(){s.setStyle("z-index","89"),e.container.removeEventListener("mouseup",a),s.removeEventListener("mousemove",c)},c=function(e){e.preventDefault(),n=o-e.clientX,i=r-e.clientY,o=e.clientX,r=e.clientY;var t=s.clientTop-i,a=s.clientLeft-n;s.style.top=parseInt(s.style.top.replace("px",""))+t+"px",s.style.left=parseInt(s.style.left.replace("px",""))+a+"px"}},_renderBodyForVideo:function(){var e=this;a.Mask.mask(e.elements.body),d.downloadDocuments([e.current.id]).then(function(n){if(n[0].id===e.current.id){if(1!==n.length)throw new Error("Unexpected downloadDocuments response when rendering Attachment Viewer.");e.elements.body.empty(),e.elements.bodyVideo=t.createElement("video",{class:v.ELEMENTS.BODYVIDEO,src:n[0].downloadUrl,controls:!0}),setTimeout(function(){t.is(e.elements.bodyVideo)&&e.elements.bodyVideo.inject(e.elements.body)},f),e.current.set("contentUrl",n[0].downloadUrl)}}).catch(function(t){e._logger.error(t),r.displayNotification({msg:p.notifications.Download.failure,eventID:"error"})}).finally(function(){a.Mask.unmask(e.elements.body)})},_renderBodyForAudio:function(){var e=this;a.Mask.mask(e.elements.body),d.downloadDocuments([e.current.id]).then(function(n){if(n[0].id===e.current.id){if(1!==n.length)throw new Error("Unexpected downloadDocuments response when rendering Attachment Viewer.");e.elements.body.empty(),e.elements.bodyVideo=t.createElement("audio",{class:v.ELEMENTS.BODYAUDIO,src:n[0].downloadUrl,controls:!0}),setTimeout(function(){t.is(e.elements.bodyVideo)&&e.elements.bodyVideo.inject(e.elements.body)},f),e.current.set("contentUrl",n[0].downloadUrl)}}).catch(function(t){e._logger.error(t),r.displayNotification({msg:p.notifications.Download.failure,eventID:"error"})}).finally(function(){a.Mask.unmask(e.elements.body)})},_onCollectionSelect:function(e){if(e.hasOwnProperty("ids")&&!t.is(e.ids,null)&&t.is(e.ids,"array"))e.ids.length>1||this.collection.getSelectedItems().length,this.refresh();else{var n=p.replace(p.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(n)}},_onCollectionUnselect:function(e){if(e.hasOwnProperty("ids")&&!t.is(e.ids,null)&&t.is(e.ids,"array")){for(var n=0;n<e.ids.length;n++){var i=e.ids[n];this.current&&this.current.id===i&&this.stopListening(this.current,"onChange:contentUrl")}this.refresh()}else{var o=p.replace(p.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(o)}},_onCollectionAdd:function(){this.refresh()},_onCollectionRemove:function(){this.refresh()},_onCurrentItemChangeContentUrl:function(e){switch(this.current.get("documentType")){case"image":this.elements.bodyImage.setStyle("background-image","url("+e.get("contentUrl")+")")}},_onImageMouseWheel:function(e){if(e.preventDefault(),e.deltaY<0){var t=2*-e.deltaY/10;this.elements.footerZoomSlider.value+t<this.elements.footerZoomSlider.maxValue?this.elements.footerZoomSlider.value+=t:this.elements.footerZoomSlider.value=this.elements.footerZoomSlider.maxValue}else{var n=2*e.deltaY/10;this.elements.footerZoomSlider.value-n>this.elements.footerZoomSlider.minValue?this.elements.footerZoomSlider.value-=n:this.elements.footerZoomSlider.value=this.elements.footerZoomSlider.minValue}},_debounceTimeouts:[],debounce:function(e,t,n){var i,o=this;return function(){var r=this,s=arguments,a=n&&!i;clearTimeout(i);var c=o._debounceTimeouts.indexOf(i);-1!==c&&o._debounceTimeouts.splice(c,1),i=setTimeout(function(){i=null,n||e.apply(r,s)},t),o._debounceTimeouts.push(i),a&&e.apply(r,s)}}})}),define("DS/IssueAttachmentManager/views/Slider",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/UIKIT/Scroller","DS/IssueComponents/utils/Utils","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/ContextualMenu","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/views/Attachment","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(e,t,n,i,o,r,s,a,c,l,u,m){"use strict";var d={ELEMENTS:{NAVIGATIONBUTTON:"isu-am-slider-navigation-button",PREVIOUSBUTTON:"isu-am-slider-navigation-button-previous",PREVIOUSICON:"fonticon-chevron-left",NEXTICON:"fonticon-chevron-right",NEXTBUTTON:"isu-am-slider-navigation-button-next",SCROLLCONTENT:"isu-am-slider-scroll-content",SCROLLCONTAINER:"isu-am-slider-scroll-container"}};return e.extend({name:"DS/IssueAttachmentManager/views/Slider",tagName:"div",className:"isu-am-slider",_logger:null,init:function(e){if(!e.hasOwnProperty("collection")||t.is(e.collection,null)||!(e.collection instanceof s))throw new Error(m.replace(m.error.common.incorrectInitArgument,{className:"Slider",property:"collection",type:"DS/IssueAttachmentManager/components/Collection"}));if(e.hasOwnProperty("contextualMenu")&&(t.is(e.contextualMenu,null)||!(e.contextualMenu instanceof a)))throw new Error(m.replace(m.error.common.incorrectInitArgument,{className:"Slider",property:"contextualMenu",type:"DS/IssueAttachmentManager/components/ContextualMenu"}));this._parent(e)},setup:function(e){r.start(this.name+" setup"),this._parent(e),this._logger=n.getLogger(this.name),this.contextualMenu=e.contextualMenu,this.listenTo(this.collection,"onSelect",this._onCollectionSelect.bind(this)),this.listenTo(this.collection,"onUnselect",this._onCollectionUnselect.bind(this)),this.listenTo(this.collection,"onSort",this._onCollectionSort.bind(this)),this.listenTo(this.collection,"onAdd",this._onCollectionAdd.bind(this)),this.listenTo(this.collection,"onRemove",this._onCollectionRemove.bind(this)),this.listenTo(this.collection,"onReset",this._onCollectionReset.bind(this)),r.end(this.name+" setup")},render:function(){r.start(this.name+" render"),this.elements.prevBtn=t.createElement("div",{class:d.ELEMENTS.NAVIGATIONBUTTON+" "+d.ELEMENTS.PREVIOUSBUTTON}).inject(this.container),this.elements.prevBtn.addEventListener("click",this.slideToPrevious.bind(this)),this.elements.prevBtn.hide(),t.createElement("span",{class:"fonticon fonticon-2x "+d.ELEMENTS.PREVIOUSICON}).inject(this.elements.prevBtn),this.elements.nextBtn=t.createElement("div",{class:d.ELEMENTS.NAVIGATIONBUTTON+" "+d.ELEMENTS.NEXTBUTTON}).inject(this.container),this.elements.nextBtn.hide(),this.elements.nextBtn.addEventListener("click",this.slideToNext.bind(this)),t.createElement("span",{class:"fonticon fonticon-2x "+d.ELEMENTS.NEXTICON}).inject(this.elements.nextBtn),this.elements.scrollContent=t.createElement("div",{class:d.ELEMENTS.SCROLLCONTENT}).inject(this.container),this.elements.scrollContainer=t.createElement("div",{class:d.ELEMENTS.SCROLLCONTAINER}).inject(this.container);var e=t.createElement("div",{class:"isu-am-slider-block"});e.style.order=-2,e.inject(this.elements.scrollContent),this.elements.firstEmptyBlock=e;var n=t.createElement("div",{class:"isu-am-slider-block"});n.style.order=this.collection.size()+1,n.inject(this.elements.scrollContent),this.elements.lastEmptyBlock=n,this.attachments={};for(var o=0;o<this.collection.size();o++){var s=this.collection.at(o),c=new l({model:s,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[s.id]=c,c.container.style.order=o,c.container.setAttribute("draggable",!0),c.render().inject(this.elements.scrollContent),this.contextualMenu instanceof a&&this.contextualMenu.register(c.container)}return this._scroller=new i({element:this.elements.scrollContent,options:{snap:!0,momentum:!0,scrollDrag:!0}}).inject(this.elements.scrollContainer),r.end(this.name+" render"),this},refresh:function(){var e=this,t=this.collection.getSelectedItems();if(1===t.length){this.current&&this.current.model.id!==t[0].id&&this.current.container.removeClassName("selected"),this.current=this.attachments[t[0].id],this.current.container.addClassName("selected"),setTimeout(function(){if(e.current){var t=e.collection.indexOf(e.current.model),n=e.container.scrollWidth/2-(0===t?100:140);e._scroller.scrollTo(e.current.container.offsetLeft-n,0,10)}},200);var n=this.collection.indexOf(this.current.model);0===n?this.elements.prevBtn.hide():this.elements.prevBtn.show(),n===this.collection.size()-1?this.elements.nextBtn.hide():this.elements.nextBtn.show()}else t.length>1?(this.current&&(this.current.container.removeClassName("selected"),this.current=null),this.elements.prevBtn.hide(),this.elements.nextBtn.hide()):(this.elements.prevBtn.hide(),this.elements.nextBtn.hide())},slideToNext:function(){if(this.collection.size()){var e=-1;if(null!==this.current&&void 0!==this.current&&(e=this.collection.indexOf(this.current.model)),e<this.collection.size()-1){var t=this.attachments[this.collection.at(e+1).id];this._slideTo(t)}}return this},slideToPrevious:function(){if(this.collection.size()){var e=1;if(null!==this.current&&void 0!==this.current&&(e=this.collection.indexOf(this.current.model)),e>0){var t=this.attachments[this.collection.at(e-1).id];this._slideTo(t)}}return this},_slideTo:function(e){var t=this.collection.toArray().map(function(e){return e.id}),n=t.indexOf(e.id);if(t.splice(n,1),this.collection.unselect(t),e.model.selected){var i=this.container.scrollWidth/2-100;this._scroller.scrollTo(e.container.offsetLeft-i,0,10)}else e.model.select()},_onAttachmentClick:function(e){if(this.attachments.hasOwnProperty(e.currentTarget.getData("id"))){var t=this.attachments[e.currentTarget.getData("id")];this._slideTo(t)}},_onAttachmentDrag:function(e){if(this._onAttachmentClick(e),this.attachments.hasOwnProperty(e.currentTarget.getData("id"))){var t=this.attachments[e.currentTarget.getData("id")];e.dataTransfer.setDragImage(t.container,e.offsetX,e.offsetY);var n=[{options:{id:t.model.id,type:t.model.get("type"),name:t.model.get("title")}}],i=o.setDroppableData(n),r={type:i.type,data:JSON.stringify(i.data)};e.dataTransfer.setData(r.type,r.data)}},_onCollectionSelect:function(e){if(e.hasOwnProperty("ids")&&!t.is(e.ids,null)&&t.is(e.ids,"array"))e.ids.length>1||this.collection.getSelectedItems().length,this.refresh();else{var n=m.replace(m.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(n)}},_onCollectionUnselect:function(e){if(!e.hasOwnProperty("ids")||t.is(e.ids,null)||!t.is(e.ids,"array")){var n=m.replace(m.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(n)}0===this.collection.getSelectedItems().length&&this.refresh()},_onCollectionSort:function(){for(var e=0;e<this.collection.size();e++){var t=this.collection.at(e);this.attachments[t.id].container.style.order=e}this.elements.lastEmptyBlock.style.order=this.collection.size()+1},_onCollectionAdd:function(e){var t=new l({model:e,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[e.id]=t,t.container.style.order="-1",t.render().inject(this._scroller.getInnerElement()),this.contextualMenu instanceof a&&this.contextualMenu.register(t.container)},_onCollectionRemove:function(e){this.attachments.hasOwnProperty(e.id)&&(this.attachments[e.id].destroy(),delete this.attachments[e.id])},_onCollectionReset:function(){for(var e=Object.keys(this.attachments),t=0;t<e.length;t++)this.attachments[e[t]].destroy(),delete this.attachments[e[t]];this.attachments={};for(var n=0;n<this.collection.size();n++){var i=this.collection.at(n),o=new l({model:i,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[i.id]=o,o.container.style.order=n,o.render().inject(this.elements.scrollContent),this.contextualMenu instanceof a&&this.contextualMenu.register(o.container)}}})}),define("DS/IssueAttachmentManager/IssueAttachmentManager",["UWA/Class/View","UWA/Core","UWA/Class/Promise","DS/Logger/Logger","DS/UIKIT/Mask","DS/UIKIT/Scroller","DS/UIKIT/SuperModal","DS/ENO6WPlugins/jQuery","DS/ENO6WPlugins/jQueryUI","DS/PADUtils/views/PADAlert","DS/PlatformAPI/PlatformAPI","DS/UIBehaviors/CommandsRegistry","DS/WebappsUtils/WebappsUtils","DS/WAFData/WAFData","DS/2DAnnotation/2DAnnotation","DS/IssueCommon/utils/Utils","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/ContextualMenu","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueAttachmentManager/views/Catalog","DS/IssueAttachmentManager/views/Header","DS/IssueAttachmentManager/views/Slider","DS/IssueAttachmentManager/views/Viewer","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(e,t,n,i,o,r,s,a,c,l,u,m,d,h,g,p,f,v,E,y,S,T,I,C,w,A,N,b,O,D){"use strict";var M={CSS:{ELEMENTS:{IS_EMPTY:"is-empty",TOPFRAME:"isu-am-topframe",CENTERFRAME:"isu-am-centerframe",RIGHTFRAME:"isu-am-rightframe",RIGHTFRAMECOLLAPSER:"isu-am-rightframe-collapser",RIGHTFRAMECOLLAPSERBUTTONCLOSE:"fonticon-chevron-right",RIGHTFRAMECOLLAPSERBUTTONOPEN:"fonticon-chevron-left",INNERRIGHT:"isu-am-innerright",LEFTFRAME:"isu-am-leftframe",BOTTOMFRAME:"isu-am-bottomframe",BOTTOMFRAMECOLLAPSER:"isu-am-bottomframe-collapser",BOTTOMFRAMECOLLAPSERBUTTONCLOSE:"fonticon-chevron-down",BOTTOMFRAMECOLLAPSERBUTTONOPEN:"fonticon-chevron-up",INNERBOTTOM:"isu-am-innerbottom",FRAMECLOSED:"closed",DELETE_DIALOG:"isu-am-delete-confirm-dialog",ANNOTATION:"isu-am-annotation"},LAYOUTS:{CATALOG:{1:"grid",2:"list"},MODE:{1:"full",2:"catalog-only"}},DIMENSIONS:{RIGHTFRAME:{MINWIDTH:185},BOTTOMFRAME:{HEIGHT:150},LEFTFRAME:{MINWIDTH:280}},STATUS:{}},ISSUE_3D_REVIEW:"ENX3DIR_AP",ILLEGAL_CHARACTERS:/[/\\?%*:|"<>]/g};return e.extend({name:"DS/IssueAttachmentManager/IssueAttachmentManager",tagName:"div",className:"isu-am",_logger:null,defaultOptions:{authoring:!0,mode:1,catalogLayout:1,catalogVisibility:!0,sliderVisibility:!0,annotationPreLaunchCallback:function(){},annotationSaveCallback:function(){},annotationExitCallback:function(){}},init:function(e){if(!e.hasOwnProperty("id")||t.is(e.id,null)||t.equals(e.id,"")||!t.is(e.id,"string"))throw new Error(D.replace(D.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"id",type:"String"}));if(e.hasOwnProperty("authoring")&&!t.is(e.authoring,"boolean"))throw new Error(D.replace(D.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"authoring",type:"Boolean"}));if(e.hasOwnProperty("mode")){if(!t.is(e.mode,"number"))throw new Error(D.replace(D.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"mode",type:"Number"}));if(!M.CSS.LAYOUTS.MODE.hasOwnProperty(e.mode))throw new Error(D.replace(D.error.manager.unsupportedMode,{mode:e.mode}))}if(e.hasOwnProperty("catalogLayout")){if(!t.is(e.catalogLayout,"number"))throw new Error(D.replace(D.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"catalogLayout",type:"Number"}));if(!M.CSS.LAYOUTS.CATALOG.hasOwnProperty(e.catalogLayout))throw new Error(D.replace(D.error.views.Catalog.unsupportedLayout,{layout:e.catalogLayout}))}if(e.hasOwnProperty("catalogVisibility")&&!t.is(e.catalogVisibility,"boolean"))throw new Error(D.replace(D.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"catalogVisibility",type:"Boolean"}));if(e.hasOwnProperty("sliderVisibility")&&!t.is(e.sliderVisibility,"boolean"))throw new Error(D.replace(D.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"sliderVisibility",type:"Boolean"}));if(e.hasOwnProperty("groupByType")&&!t.is(e.groupByType,"boolean"))throw new Error(D.replace(D.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"groupByType",type:"Boolean"}));if(e.hasOwnProperty("sortMode")&&!t.is(e.sortMode,"string"))throw new Error(D.replace(D.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"sortMode",type:"String"}));if(e.hasOwnProperty("sortOrder")&&!t.is(e.sortOrder,"string"))throw new Error(D.replace(D.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"sortOrder",type:"String"}));if(e.hasOwnProperty("annotationPreLaunchCallback")&&!t.is(e.annotationPreLaunchCallback,"function"))throw new Error(D.replace(D.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"annotationPreLaunchCallback",type:"Function"}));if(e.hasOwnProperty("annotationSaveCallback")&&!t.is(e.annotationSaveCallback,"function"))throw new Error(D.replace(D.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"annotationSaveCallback",type:"Function"}));if(e.hasOwnProperty("annotationExitCallback")&&!t.is(e.annotationExitCallback,"function"))throw new Error(D.replace(D.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"annotationExitCallback",type:"Function"}));this._parent(e)},setup:function(e){y.start(this.name+" setup"),this._parent(e),this.mode=this.options.mode,this.authoring=this.options.authoring,this.catalogLayout=this.options.catalogLayout,this.bottomFrameIsClosed=!this.options.sliderVisibility,this.rightFrameIsClosed=!this.options.catalogVisibility,this._rightFrameWidth=this.options.catalogWidth||M.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH,this._logger=i.getLogger(this.name),y.end(this.name+" setup")},render:function(){var e=this;return y.start(this.name+" render"),e.isLoaded=new n(function(t,n){e._deferred={},e._deferred.resolve=t,e._deferred.reject=n}),e.container.setAttribute("id","isu-am-"+this.id+"-"+Date.now()),e.container.setData("id",this.id),o.mask(e.container),C.getDocumentsFrom(this.id).then(function(n){return e.collection=new S(n),e.options.hasOwnProperty("groupByType")&&(e.collection.groupByType=e.options.groupByType),e.options.hasOwnProperty("sortMode")&&(e.collection.sortMode=e.options.sortMode),e.options.hasOwnProperty("sortOrder")&&(e.collection.sortOrder=e.options.sortOrder),C.getPrimary(e.id).then(function(n){var i=JSON.parse(n);t.is(i.documentId,"string")&&""!==i.documentId&&e.collection.get(i.documentId)&&e.collection.get(i.documentId).set("isPrimary",!0)})}).then(function(){return new n(function(t,n){return v.issues.retrieve({data:{objects:[{physicalId:e.id}]}}).then(function(e){var n=e.results[0].body;t(n)})})}).then(function(i){if(e.container.empty(),null===e.collection)return n.resolve();e.contextualMenu=new T({bo:i,authoring:e.authoring,collection:e.collection}),e.elements.topFrame=t.createElement("div",{class:M.CSS.ELEMENTS.TOPFRAME}).inject(e.container),e.elements.rightFrame=t.createElement("div",{class:M.CSS.ELEMENTS.RIGHTFRAME+" "+M.CSS.ELEMENTS.FRAMECLOSED}).inject(e.container),e.elements.innerRight=t.createElement("div",{class:M.CSS.ELEMENTS.INNERRIGHT}).inject(e.elements.rightFrame),e.elements.centerFrame=t.createElement("div",{class:M.CSS.ELEMENTS.CENTERFRAME}).inject(e.container),e.elements.bottomFrame=t.createElement("div",{class:M.CSS.ELEMENTS.BOTTOMFRAME}).inject(e.container),e.elements.innerBottom=t.createElement("div",{class:M.CSS.ELEMENTS.INNERBOTTOM}).inject(e.elements.bottomFrame),e.views={},e.views.catalog=new w({authoring:e.authoring,collection:e.collection,contextualMenu:e.contextualMenu,layout:e.catalogLayout}).render().inject(e.elements.innerRight),e.views.header=new A({bo:i,authoring:e.authoring,collection:e.collection,annotationPreLaunchCallback:e.options.annotationPreLaunchCallback,annotationSaveCallback:e.options.annotationSaveCallback,annotationExitCallback:e.options.annotationExitCallback}).render().inject(e.elements.topFrame),e.views.slider=new N({collection:e.collection,contextualMenu:e.contextualMenu}).render().inject(e.elements.innerBottom),e.views.viewer=new b({authoring:e.authoring,collection:e.collection,contextualMenu:e.contextualMenu}).render().inject(e.elements.centerFrame);var r=e.container.getDimensions().innerWidth>M.CSS.DIMENSIONS.LEFTFRAME.MINWIDTH+M.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH?e.container.getDimensions().innerWidth-M.CSS.DIMENSIONS.LEFTFRAME.MINWIDTH:M.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH;e.resizable=a(e.elements.rightFrame).resizable({handles:"w",maxWidth:r,minWidth:M.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH,stop:function(t,n){e._rightFrameWidth=n.size.width,e._updatePreferences()}}),e.elements.rightFrameCollapser=t.createElement("div",{class:M.CSS.ELEMENTS.RIGHTFRAMECOLLAPSER}).inject(e.elements.rightFrame),e.elements.rightFrameCollapserButton=t.createElement("span",{class:"fonticon fonticon-2x "+M.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONOPEN}).inject(e.elements.rightFrameCollapser),e.elements.rightFrameCollapserButton.addEventListener("click",e._onRightFrameCollapserClick.bind(e)),e.elements.bottomFrameCollapser=t.createElement("div",{class:M.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSER}).inject(e.elements.bottomFrame),e.elements.bottomFrameCollapserButton=t.createElement("span",{class:"fonticon fonticon-2x "+M.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONOPEN}).inject(e.elements.bottomFrameCollapser),e.elements.bottomFrameCollapserButton.addEventListener("click",e._onBottomFrameCollapserClick.bind(e)),e._currentMode=null,e._toggleMode(e.mode,!0),!0===e.rightFrameIsClosed&&2!==e.mode||e._showRightFrame(),0!==e.collection.size()&&!0!==e.bottomFrameIsClosed&&e._showBottomFrame(),o.unmask(e.container),e.listenTo(e.collection,"onAdd",e.resize.bind(e)),e.listenTo(e.collection,"onRemove",e.resize.bind(e)),e.listenTo(e.collection,"onReset",e.resize.bind(e)),e.listenTo(e.contextualMenu,"request:groupByType",e._onRequestGroupByType.bind(e)),e.listenTo(e.contextualMenu,"request:sort",e._onRequestSort.bind(e)),e.listenTo(e.contextualMenu,"request:catalogSwitchLayout",e._onRequestCatalogSwitchLayout.bind(e)),e.listenTo(e.contextualMenu,"request:downloadFile",e._onRequestDownloadFile.bind(e)),e.listenTo(e.contextualMenu,"request:openWith",e._onRequestOpenWith.bind(e)),e.listenTo(e.contextualMenu,"request:annotate",e._onRequestAnnotate.bind(e)),e.listenTo(e.contextualMenu,"request:setAsPrimary",e._onRequestSetAsPrimary.bind(e)),e.listenTo(e.contextualMenu,"request:detach",e._onRequestDetach.bind(e)),e.listenTo(e.contextualMenu,"request:delete",e._onRequestDelete.bind(e)),e.listenTo(e.contextualMenu,"request:attachFrom3DX",e._onRequestAttachFrom3DX.bind(e)),e.listenTo(e.contextualMenu,"request:attachFromLocalDisk",e._onRequestAttachFromLocalDisk.bind(e)),e.listenTo(e.contextualMenu,"request:updateFile",e._onRequestUpdateFile.bind(e)),e._listeners=[],e._listeners.push({target:e.container,event:"keydown",listener:e._onKeyDown.bind(e)}),e._listeners.push({target:e.container,event:"paste",listener:e._onPasteEvent.bind(e)});for(var s=0;s<e._listeners.length;s++){var c=e._listeners[s];c.target.addEventListener(c.event,c.listener)}e.listenTo(e.views.header,"request:uploadFile",e._onRequestUploadFile.bind(e)),e.listenTo(e.views.header,"request:attachFrom3DX",e._onRequestAttachFrom3DX.bind(e)),e.listenTo(e.views.header,"request:attachFromLocalDisk",e._onRequestAttachFromLocalDisk.bind(e)),e.listenTo(e.views.header,"request:screenshot",e._screenshot.bind(e)),e.listenTo(e.views.header,"request:detach",e._onRequestDetach.bind(e)),e.listenTo(e.views.header,"request:delete",e._onRequestDelete.bind(e)),e.listenTo(e.views.header,"request:downloadFile",e._onRequestDownloadFile.bind(e)),e.listenTo(e.views.header,"request:openWith",e._onRequestOpenWith.bind(e)),e.listenTo(e.views.header,"request:annotate",e._onRequestAnnotate.bind(e)),e.listenTo(e.views.header,"request:groupByType",e._onRequestGroupByType.bind(e)),e.listenTo(e.views.header,"request:sort",e._onRequestSort.bind(e)),e.listenTo(e.views.header,"request:catalogSwitchLayout",e._onRequestCatalogSwitchLayout.bind(e)),e.listenTo(e.views.header,"request:updatePreferences",e._updatePreferences.bind(e)),e.listenTo(e.views.header,"request:setAsPrimary",e._onRequestSetAsPrimary.bind(e)),e.listenTo(e.views.catalog,"onSwitchLayout",e._onCatalogSwitchLayout.bind(e)),e.listenTo(e.views.catalog,"request:attachFrom3DX",e._onRequestAttachFrom3DX.bind(e)),e.listenTo(e.views.catalog,"request:attachFromLocalDisk",e._onRequestAttachFromLocalDisk.bind(e)),e.listenTo(e.views.viewer,"request:attachFrom3DX",e._onRequestAttachFrom3DX.bind(e)),e.listenTo(e.views.viewer,"request:attachFromLocalDisk",e._onRequestAttachFromLocalDisk.bind(e)),e._addDropEvent(e.views.viewer.container),e._addDropEvent(e.views.catalog.container),e._addDropEvent(e.views.slider.container);var l=e.collection.map(function(e){return e.id});if(l.length>0){var u=C.fetch(l).then(function(t){if(t.hasOwnProperty("results"))for(var n=0;n<t.results.length;n++){var i=t.results[n].attributes.find(function(e){return"resourceid"===e.name}).value,o=e.collection.get(i);if(o){var r=t.results[n].attributes.find(function(e){return"ds6w:type"===e.name});r&&r.dispValue&&o.set("dispType",r.dispValue);var s=t.results[n].attributes.find(function(e){return"ds6w:label"===e.name});s&&s.value&&o.set("title",s.value);var a=t.results[n].attributes.find(function(e){return"type_icon_url"===e.name});a&&a.value&&o.set("iconUrl",a.value);var c=t.results[n].attributes.find(function(e){return"preview_url"===e.name});c&&c.value&&o.set("thumbnailUrl",c.value);var l=t.results[n].attributes.find(function(e){return"ds6w:docextension"===e.name});l&&l.value&&o.setDocumentType(l.value)}}});return C.downloadDocuments(l).then(function(t){if(null!==e.collection)for(var n=0;n<t.length;n++){var i=t[n].id,o=e.collection.get(i);o&&t[n].downloadUrl&&void 0===t[n].errorMessage&&o.set("contentUrl",t[n].downloadUrl)}}),u}return n.resolve()}).then(function(){null!==e.collection?e.collection.size()>0?(e.container.removeClassName(M.CSS.ELEMENTS.IS_EMPTY),e.collection.sort(),e.listenTo(e.collection,"onSelect",function(){e.stopListening(e.collection,"onSelect"),e._deferred.resolve()}),e.collection.select(e.collection.at(0).id)):(e.container.addClassName(M.CSS.ELEMENTS.IS_EMPTY),1===e._currentMode&&e._closeRightFrame(),e._deferred.resolve()):e._deferred.resolve()}).catch(function(t){if(t.internalError&&t.internalError.includes("ErrorCode:1500127")){var n=p.getErrorMessage("0");p.displayErrorMessage(n,"error")}else l&&l.displayNotification({msg:D.notifications.Init.failure,eventID:"error"});o.unmask(e.container),e._deferred.reject(t)}),y.end(this.name+" render"),this},destroy:function(){var e=this;if(t.is(e.contextualMenu,"object")&&e.contextualMenu.hide(),e.collection=null,e.contextualMenu=null,Array.isArray(e._listeners))for(var n=0;n<e._listeners.length;n++){var i=e._listeners[n];i.target.removeEventListener(i.event,i.listener)}e._listeners=[],Object.keys(e.views).forEach(function(t){e.views[t].destroy()}),e.container.empty()},refresh:function(e){var i=this;if(null!=e){if(!t.is(e,"string")||0===e.length){var r=D.replace(D.error.common.incorrectArgument,{arg:0,type:"String"});return n.reject(Error(r))}this.id=e}return new n(function(e,t){i.isLoaded.then(function(){o.mask(i.container),i.destroy(),i.render(),i.isLoaded.then(function(){i.resize(),i.dispatchEvent("onRefresh"),o.unmask(i.container),e()}).catch(t)})})},resize:function(){var e=this;if(e.container.clientWidth>=M.CSS.DIMENSIONS.LEFTFRAME.MINWIDTH+M.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH){e._toggleMode(1);var t=e.container.getDimensions().innerWidth>M.CSS.DIMENSIONS.LEFTFRAME.MINWIDTH+M.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH?e.container.getDimensions().innerWidth-M.CSS.DIMENSIONS.LEFTFRAME.MINWIDTH:M.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH;e.resizable=a(e.elements.rightFrame).resizable({handles:"w",maxWidth:t,minWidth:M.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH,stop:function(t,n){e._rightFrameWidth=n.size.width,e._updatePreferences()}}),null!==e.collection&&0===e.collection.size()?e._closeRightFrame():null!==e.collection&&0!==e.collection.size()&&e._showRightFrame(),!0!==e.rightFrameIsClosed&&(e.elements.rightFrame.setStyle("transition","width 200ms"),e._rightFrameWidth>t?e.elements.rightFrame.setStyle("width",M.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH):e.elements.rightFrame.setStyle("width",e._rightFrameWidth),setTimeout(function(){e.elements.rightFrame.setStyle("transition","none")},200))}else e._toggleMode(2);e.views.header.iconBar.resize()},_closeBottomFrame:function(){var e=this;e.elements.bottomFrame.setStyle("transition","height 200ms"),e.elements.bottomFrame.setStyle("height",0),e.elements.bottomFrameCollapserButton.removeClassName(M.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONCLOSE),e.elements.bottomFrameCollapserButton.addClassName(M.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONOPEN),e.bottomFrameIsClosed=!0,setTimeout(function(){e.elements.bottomFrame.setStyle("transition","none")},200)},_showBottomFrame:function(){var e=this;e.elements.bottomFrame.setStyle("transition","height 200ms"),e.elements.bottomFrame.setStyle("height",M.CSS.DIMENSIONS.BOTTOMFRAME.HEIGHT),e.elements.bottomFrameCollapserButton.removeClassName(M.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONOPEN),e.elements.bottomFrameCollapserButton.addClassName(M.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONCLOSE),e.bottomFrameIsClosed=!1,setTimeout(function(){e.elements.bottomFrame.setStyle("transition","none")},200)},_closeRightFrame:function(){var e=this;e.elements.rightFrame.setStyle("transition","width 200ms"),e.elements.rightFrame.addClassName(M.CSS.ELEMENTS.FRAMECLOSED),e.elements.innerRight.setStyle("visibility","hidden"),e.elements.rightFrame.setStyle("width",0),e.elements.rightFrameCollapserButton.removeClassName(M.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONCLOSE),e.elements.rightFrameCollapserButton.addClassName(M.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONOPEN),e.rightFrameIsClosed=!0,setTimeout(function(){e.elements.rightFrame.setStyle("transition","none")},200)},_showRightFrame:function(){var e=this;e.elements.rightFrame.setStyle("transition","width 200ms"),e.elements.rightFrame.removeClassName(M.CSS.ELEMENTS.FRAMECLOSED),e.elements.innerRight.setStyle("visibility","visible"),e.elements.rightFrame.setStyle("width",e._rightFrameWidth),e.elements.rightFrameCollapserButton.removeClassName(M.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONOPEN),e.elements.rightFrameCollapserButton.addClassName(M.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONCLOSE),e.rightFrameIsClosed=!1,setTimeout(function(){e.elements.rightFrame.setStyle("transition","none")},200)},_toggleMode:function(e){if(!t.is(e,"number"))throw new Error(D.replace(D.error.common.incorrectArgument,{arg:0,type:"Number"}));if(!M.CSS.LAYOUTS.MODE.hasOwnProperty(e))throw new Error(D.replace(D.error.manager.unsupportedMode,{mode:e}));e!==this._currentMode&&(1===e?this.container.removeClassName("isu-am-catalog-only"):2===e&&(this.container.addClassName("isu-am-catalog-only"),this.elements.rightFrame.setStyle("width","calc(100%)"),this.elements.innerRight.setStyle("visibility","visible")),this._currentMode=e)},_onBottomFrameCollapserClick:function(){0===this.elements.bottomFrame.clientHeight?this._showBottomFrame():this._closeBottomFrame(),this._updatePreferences()},_onRightFrameCollapserClick:function(){0===this.elements.rightFrame.clientWidth?this._showRightFrame():this._closeRightFrame(),this._updatePreferences()},_onKeyDown:function(e){var n=t.Event.whichKey(e);this._onKeyDownCallbacks.hasOwnProperty(n)&&this._onKeyDownCallbacks[n].call(this,e)},_onKeyDownCallbacks:{right:function(){this.contextualMenu.hide(),this.views.catalog.goToNext()},"shift+right":function(){this.contextualMenu.hide(),this.views.catalog.goToNext(!0)},left:function(){this.contextualMenu.hide(),this.views.catalog.goToPrevious()},"shift+left":function(){this.contextualMenu.hide(),this.views.catalog.goToPrevious(!0)},down:function(){this.contextualMenu.hide(),this.views.catalog.goToNextLine()},"shift+down":function(){this.contextualMenu.hide(),this.views.catalog.goToNextLine(!0)},up:function(){this.contextualMenu.hide(),this.views.catalog.goToPreviousLine()},"shift+up":function(){this.contextualMenu.hide(),this.views.catalog.goToPreviousLine(!0)},"ctrl+a":function(e){e.preventDefault(),this.contextualMenu.hide(),this.collection.selectAll()}},_onRequestUploadFile:function(e){var t=e.fileList;this._addFiles(t)},_addFiles:function(e){var t=this,i=t.collection.id;0===t.collection.size()&&t._showRightFrame();for(var o=function(e){this.set("isCancelable",!0),this.set("request",e)},r=function(e){if(e.lengthComputable){var t=e.loaded/e.total;this.set("requestProgress",t)}},s=function(){this.set("isCancelable",!1),this.set("request",null)},a=[],c=[],m=0;m<e.length;m++){var d=e[m],h="temporary_"+Math.floor(Date.now())+"_"+m,g=d.type,f={id:h,title:d.name,type:"Document",dispType:D.views.Attachment.types.Document,owner:{firstName:u.getUser().firstName,fullName:u.getUser().firstName.trim()+" "+u.getUser().lastName.trim(),lastName:u.getUser().lastName,user:u.getUser().login},relOwner:{firstName:u.getUser().firstName,fullName:u.getUser().firstName.trim()+" "+u.getUser().lastName.trim(),lastName:u.getUser().lastName,user:u.getUser().login},relOriginated:(new Date).toString()};d.hasOwnProperty("lastModifiedDate")?d.lastModifiedDate instanceof Date?(f.modified=d.lastModifiedDate.toString(),f.created=d.lastModifiedDate.toString()):(f.modified=new Date(d.lastModifiedDate).toString(),f.created=new Date(d.lastModifiedDate).toString()):(f.modified=(new Date).toString(),f.created=(new Date).toString());var v=new I(f);v.set("isProcessing",!0),v.setDocumentTypeByMIME(g),a.push(v);var E=function(e){if(!e.internalError||!e.internalError.includes("Error: #1500178")){return{file:{tempId:this.tempId,type:this.type},response:e}}var n=p.getErrorMessage("0");p.displayErrorMessage(n,"error"),t.collection.remove(a,{sort:!1})},y=C.uploadFile(d,i,{onCheckinStart:o.bind(v),onCheckinProgress:r.bind(v),onCheckinComplete:s.bind(v)});c.push(y.then(E.bind({tempId:h,type:g})).catch(E.bind({tempId:h,type:g})))}return t.collection.add(a,{sort:!1}),n.all(c).then(function(e){for(var n=[],o=0,r=[],s=0;s<e.length;s++){var a=e[s].file.tempId,c=e[s].file.type,m=e[s].response;if(m.success){o++;var d=m.data[0],h=C.parseDocument(d);h.relOwner={firstName:u.getUser().firstName,fullName:u.getUser().firstName.trim()+" "+u.getUser().lastName.trim(),lastName:u.getUser().lastName,user:u.getUser().login},h.relOriginated=(new Date).toString();var g=new I(h);g.set("iconUrl",g.get("thumbnailUrl")),g.setDocumentTypeByMIME(c),t.collection.remove(a),t.collection.add(g),r.push(g),n.push(g.id)}else t.collection.get(a).set("isFailed",!0),t.collection.get(a).set("isProcessing",!1),t.collection.get(a).set("isCancelable",!1),t.collection.get(a).set("request",null),m instanceof Error&&t._logger.error(m)}o>0&&(o===e.length&&1===r.length&&"image"===r[0].get("documentType")?t._onRequestSetAsPrimary({item:r[0],lock:!1,id:i}):t.dispatchEvent("onUpdate",{objects:[{physicalId:t.collection.id}]}),l.displayNotification({msg:D.replace(D.notifications.Upload.success,{count:o}),eventID:"success"}),t.container.removeClassName(M.CSS.ELEMENTS.IS_EMPTY)),o!==e.length&&(void 0!==m.internalError&&null!==m.internalError&&""!==m.internalError?void 0!==m.error&&null!==m.error&&""!==m.error&&(m.internalError.indexOf("1500028")?p.displayErrorMessage(p.getErrorMessage("1500028_1"),"error"):l.displayNotification({msg:m.error,eventID:"error"})):l.displayNotification({msg:D.replace(D.notifications.Upload.failure,{count:e.length-o}),eventID:"error"})),n.length&&C.downloadDocuments(n).then(function(e){for(var n=0;n<e.length;n++){var i=e[n].id,o=t.collection.get(i);o&&e[n].downloadUrl&&void 0===e[n].errorMessage&&o.set("contentUrl",e[n].downloadUrl)}})}).catch(function(e){t._logger.error(e)})},_onRequestAttachFrom3DX:function(){var e=this,n=f.get("application");if(t.is(n,"object")&&n.isStandalone){var i=f.get("component");if(t.is(i,"object")&&t.is(i.taskManager,"object")){var o=i.taskManager.addObjectsTask(function(n){if(Array.isArray(n.physicalIds)){var r=n.physicalIds;C.fetch(r).then(function(n){if(t.is(n.results,"array")&&n.results.length===r.length){var i=n.results.map(function(e){return C.parseFromFetch(e)});return e._add3DXObjects(i)}throw new Error("Unexpected number of fetch results for attachments.")}).finally(function(){i.unmaskForTask(o)})}else i.unmaskForTask(o)},function(){i.unmaskForTask(o)});i.maskForTask(o)}}else E.search({title:D.Attach.SearchTitle,default_search_criteria:"",multiSel:!0,callback:function(t){var n=t.map(function(e){return C.parseFromSearch(e)});try{for(var i=0;i<n.length;i++){var o=n[i];if(o.hasOwnProperty("sourceid_value")){var r=o.sourceid_value;if(null!=r&&-1===r.indexOf("3dspace"))throw new Error("Object not supported")}}}catch(e){return l.displayNotification({msg:D.notifications.Drop.unsupported,eventID:"warning"}),null}e._add3DXObjects(n)},cancel:function(){}})},_onRequestAttachFromLocalDisk:function(){var e=this;C.browseFileFromLocalDisk(e.container).catch(function(t){l.displayNotification({msg:D.replace(D.notifications.BrowseFile.failure),eventID:"error"}),e._logger.error(t)}).then(function(t){return e._addFiles(t)})},_screenshot:function(){var e=this,n=f.get("widget").name===M.ISSUE_3D_REVIEW;if(n&&t.is(e.container)&&t.is(e.container.getParent())&&t.is(e.container.getParent().getParent())&&e.container.getParent().getParent().getParent()&&e.container.getParent().getParent().getParent().getParent()&&e.container.getParent().getParent().getParent().getParent().hide(),n){f.get("component").utils.takeAnnotation(function(n){var i=n.blob;i.lastModifiedDate=new Date;var o=(new Date).toLocaleString();o=o.replace(M.ILLEGAL_CHARACTERS,"-"),i.name="screenshot_"+o+".png",e._addFiles([i]),t.is(e.container)&&t.is(e.container.getParent())&&t.is(e.container.getParent().getParent())&&e.container.getParent().getParent().getParent()&&e.container.getParent().getParent().getParent().getParent()&&e.container.getParent().getParent().getParent().getParent().show()},function(){t.is(e.container)&&t.is(e.container.getParent())&&t.is(e.container.getParent().getParent())&&e.container.getParent().getParent().getParent()&&e.container.getParent().getParent().getParent().getParent()&&e.container.getParent().getParent().getParent().getParent().show()},function(t){e._logger.error(t)})}else{var i=f.get("component"),o=i.taskManager.addTakeScreenshotTask(function(t){for(var n=t.data,r=t.fileName,s=t.fileType,a=t.lastModified,c=atob(n.split(",")[1]),l=new ArrayBuffer(c.length),u=new Uint8Array(l),m=0;m<c.length;m++)u[m]=c.charCodeAt(m);var d=new File([l],r,{type:s,lastModified:a});e._addFiles([d]),i.unmaskForTask(o)},function(){i.unmaskForTask(o)});i.maskForTask(o)}},_add3DXObjects:function(e){var t=this,i=e.filter(function(e){return void 0===t.collection.get(e.id)});if(i.length!==e.length&&l.displayNotification({msg:D.replace(D.notifications.Attach.alreadyAttached,{count:e.length-i.length}),eventID:"warning"}),i.length>0){0===t.collection.size()&&t._showRightFrame();for(var o=[],r=0;r<i.length;r++){var s=i[r];s.relOwner={firstName:u.getUser().firstName,fullName:u.getUser().firstName.trim()+" "+u.getUser().lastName.trim(),lastName:u.getUser().lastName,user:u.getUser().login},s.relOriginated=(new Date).toString();var a=new I(s);a.set("isProcessing",!0),o.push(a)}t.collection.add(o,{sort:!1});var c=i.map(function(e){return e.id});C.connectDocumentsToParent(c,t.collection.id).then(function(e){for(var i=0,o=[],r=[],s=[],a=0;a<e.length;a++){var c=e[a].documentId,u=e[a].response,m=t.collection.get(c);u.success?(i++,o.push(m),r.push(c),"Document"===m.get("type")&&s.push(c)):(m.set("isFailed",!0),m.set("isProcessing",!1))}if(t.collection.sort(),i>0&&(i===e.length&&1===o.length&&"image"===o[0].get("documentType")?t._onRequestSetAsPrimary({item:o[0],lock:!1}):t.dispatchEvent("onUpdate",{objects:[{physicalId:t.collection.id}]}),l.displayNotification({msg:D.replace(D.notifications.Attach.success,{count:i}),eventID:"success"}),t.container.removeClassName(M.CSS.ELEMENTS.IS_EMPTY)),i!==e.length)if(e[e.length-1].response.internalError.includes("Error: #1500028")){var d=p.getErrorMessage("1500028_1");p.displayErrorMessage(d,"error")}else l.displayNotification({msg:D.replace(D.notifications.Attach.failure,{count:e.length-i}),eventID:"error"});var h=[n.resolve()];r.length>0&&h.push(C.fetch(r).then(function(e){for(var n=0;n<e.results.length;n++){var i=e.results[n].attributes.find(function(e){return"resourceid"===e.name}).value,o=t.collection.get(i);if(o){var r=e.results[n].attributes.find(function(e){return"ds6w:type"===e.name});r&&r.dispValue&&o.set("dispType",r.dispValue);var s=e.results[n].attributes.find(function(e){return"ds6w:label"===e.name});s&&s.value&&o.set("title",s.value);var a=e.results[n].attributes.find(function(e){return"owner"===e.name}),c=e.results[n].attributes.find(function(e){return"ds6w:responsible"===e.name});a&&a.value&&c&&c.value&&o.set("owner",{user:a.value,fullName:c.value,firstName:"",lastName:""});var l=e.results[n].attributes.find(function(e){return"ds6w:docextension"===e.name});l&&l.value&&o.setDocumentType(l.value),o.set("isProcessing",!1)}}}).catch(function(e){l.displayNotification({msg:D.replace(D.notifications.Fetch.failure),eventID:"error"}),t._logger.error(e)})),s.length>0&&h.push(C.downloadDocuments(s).then(function(e){for(var n=0;n<e.length;n++){var i=e[n].id,o=t.collection.get(i);o&&e[n].downloadUrl&&void 0===e[n].errorMessage&&o.set("contentUrl",e[n].downloadUrl)}}).catch(function(e){l.displayNotification({msg:D.replace(D.notifications.Download.failure),eventID:"error"}),t._logger.error(e)}))}).catch(function(e){t._logger.error(e)})}},_onRequestOpenWith:function(e){var n=e.objects,i=e.app,o=e.context,r=e.arguments,s=f.get("component");if(t.is(s,"object")&&t.is(s.utils,"object")&&t.is(s.utils.setTypesCallbackForOFW,"function")){var a=n.reduce(function(e,t){return e.push(t.id),e},[]);s.utils.setTypesCallbackForOFW(a)}i.handler.apply(o,r)},_onRequestDownloadFile:function(){var e=this,n=e.collection.getSelectedItems().map(function(e){return e.id});n.length>0&&C.downloadDocuments(n,n.length>1).then(function(e){var n=e[0].downloadUrl,i=f.get("application");if(t.is(i,"object")&&i.isStandalone){var o=t.createElement("a");document.body.appendChild(o),o.style="display: none",o.href=n,o.download=e[0].fileName,o.click()}else{var r=t.createElement("a",{id:"download-image",target:"_blank"});r.href=n;var s=document.createEvent("MouseEvents");s.initEvent("click",!1,!0),r.dispatchEvent(s)}}).catch(function(t){l.displayNotification({msg:D.replace(D.notifications.Download.failure),eventID:"error"}),e._logger.error(t)})},_onRequestAnnotate:function(){var e=this,t=f.get("widget")||window.widget;p.Mask.mask(t.body),e.options.annotationPreLaunchCallback.call(e);var i=e.collection.getSelectedItems()[0];new n(function(t,n){var o={className:M.CSS.ELEMENTS.ANNOTATION,saveCallback:e._annotationSaveCallback.bind(e),exitCallback:e._annotationExitCallback.bind(e)};i&&i.get("contentUrl")?C.downloadDocuments([i.id]).then(function(e){if(1!==e.length||e[0].id!==i.id)throw new Error("Unexpected downloadDocuments response when launching Annotation from Attachment.");i.set("contentUrl",e[0].downloadUrl),o.imageURL=i.get("contentUrl"),t(o)}).catch(n):(null!==e.annotationCanvasTarget&&void 0!==e.annotationCanvasTarget?o.captureTarget=e.annotationCanvasTarget:null!==e.annotationCanvasDefaultDimensions&&void 0!==e.annotationCanvasDefaultDimensions&&(o.defaultDimensions=e.annotationCanvasDefaultDimensions),t(o))}).then(function(n){var i=new g(n);return i.render(),i.isLoaded.then(function(){i.container.inject(t.body),e.annotation=i})}).catch(function(t){e.annotation&&(e.annotation.destroy(),e.annotation=null),l.displayNotification({msg:D.replace(D.notifications.Annotation.initFailure),eventID:"error"}),e._logger.error(t)}).finally(function(){p.Mask.unmask(t.body)})},_annotationSaveCallback:function(e){var t=this,i=f.get("widget")||window.widget;o.mask(i.body),o.mask(t.annotation.immersiveFrame.elements.container);var r=t.collection.id,s=(new Date).toLocaleString();s=s.replace(M.ILLEGAL_CHARACTERS,"-");var a=D.replace(D.annotate.defaultName,{date:s}),c=new File([e.blob],a,{type:"image/png",lastModified:Date.now()});C.uploadFile(c,r).then(function(e){if(l.displayNotification({msg:D.replace(D.notifications.Annotation.uploadSuccess,{fileName:a}),eventID:"info"}),e&&e.data&&e.data.length>0&&e.data[0].id){var i=e.data[0];return C.setAsPrimary(i.id,r).then(function(e){t.dispatchEvent("onUpdate",{objects:[{physicalId:r}]});var n=JSON.parse(e);i.id===n.documentId&&l.displayNotification({msg:D.notifications.SetAsPrimary.success,eventID:"info"}),t.refresh()},function(e){e.message.search("Access Denied")?l.displayNotification({msg:D.notifications.SetAsPrimary.Restricted,eventID:"error"}):l.displayNotification({msg:D.notifications.SetAsPrimary.failure,eventID:"error"}),t.annotation._logger.error(e)})}return n.reject(new Error("Unexpected empty response for upload."))},function(e){if(e.internalError&&e.internalError.includes("Error: #1500178")){var n=p.getErrorMessage("0");p.displayErrorMessage(n,"error")}else if(e.internalError&&e.internalError.includes("Error: #1500028")){n=p.getErrorMessage("1500028_1");p.displayErrorMessage(n,"error")}else l.displayNotification({msg:D.notifications.Annotation.uploadFailure,eventID:"error"});t._logger.error(e)}).finally(function(){t.options.annotationSaveCallback(e),o.unmask(i.body),o.unmask(t.annotation.immersiveFrame.elements.container),t.annotation.destroy(),t.annotation=null})},_annotationExitCallback:function(e){this.options.annotationExitCallback(e),this.annotation.destroy(),this.annotation=null},_onRequestDetach:function(){for(var e=this,t=e.collection.getSelectedItems(),i=[],o=0;o<t.length;o++){var r=t[o];r.set("isProcessing",!0),i.push(r.id)}e.collection.unselectAll(),C.disconnectDocumentsFromParent(i,e.collection.id).then(function(t){for(var i=0,o=[],r=0;r<t.length;r++){var s=t[r].documentId,a=t[r].response,c=e.collection.get(s);a.success?(i++,!0===c.get("isPrimary")&&o.push(C.unsetAsPrimary(e.collection.id)),e.collection.remove(c)):c.set("isProcessing",!1)}if(i>0&&(e.dispatchEvent("onUpdate",{objects:[{physicalId:e.collection.id}]}),l.displayNotification({msg:D.replace(D.notifications.Detach.success,{count:i}),eventID:"success"})),i!==t.length){var u=p.getErrorMessage("10");p.displayErrorMessage(u,"error")}o.length>0&&n.all(o).then(function(){e.dispatchEvent("onUpdate",{objects:[{physicalId:e.collection.id}]})}),0===e.collection.size()&&(e.container.addClassName(M.CSS.ELEMENTS.IS_EMPTY),1===e._currentMode&&e._closeRightFrame())}).catch(function(t){l.displayNotification({msg:D.replace(D.notifications.Detach.failure),eventID:"error"}),e._logger.error(t)})},_onRequestDelete:function(){var e=this;new s({renderTo:e.container,className:M.CSS.ELEMENTS.DELETE_DIALOG}).confirm(D.Delete.confirm.text,D.Delete.confirm.title,function(t){if(t){for(var i=e.collection.getSelectedItems(),o=[],r=0;r<i.length;r++){var s=i[r];s.set("isProcessing",!0),o.push(s.id)}e.collection.unselectAll(),C.deleteDocuments(o).then(function(t){for(var i=0,o=[],r=0;r<t.length;r++){var s=t[r].documentId,a=t[r].response,c=e.collection.get(s);a.success?(i++,!0===c.get("isPrimary")&&o.push(C.unsetAsPrimary(e.collection.id)),e.collection.remove(c)):c.set("isProcessing",!1)}i>0&&(e.dispatchEvent("onUpdate",{objects:[{physicalId:e.collection.id}]}),l.displayNotification({msg:D.replace(D.notifications.Delete.success,{count:i}),eventID:"success"})),i!==t.length&&l.displayNotification({msg:D.replace(D.notifications.Delete.failure,{count:t.length-i}),eventID:"error"}),o.length>0&&n.all(o).then(function(){e.dispatchEvent("onUpdate",{objects:[{physicalId:e.collection.id}]})}),0===e.collection.size()&&(e.container.addClassName(M.CSS.ELEMENTS.IS_EMPTY),1===e._currentMode&&e._closeRightFrame())}).catch(function(t){l.displayNotification({msg:D.replace(D.notifications.Delete.failure),eventID:"error"}),e._logger.error(t)})}},D.Delete.confirm.okButton,D.Delete.confirm.cancelButton)},_onRequestGroupByType:function(e){this.collection.groupByType=!this.collection.groupByType,t.is(e)&&(this.catalogLayout="None"!=e.sortByOrder),this.collection.sort(),this._updatePreferences(),t.is(this.views.header.iconBarFix.getItem("groupByType").content.component)&&(this.views.header.iconBarFix.getItem("groupByType").content.component.getItem("groupNone").elements.container.toggleClassName("selectable"),this.views.header.iconBarFix.getItem("groupByType").content.component.getItem("groupNone").elements.container.toggleClassName("selected"),this.views.header.iconBarFix.getItem("groupByType").content.component.getItem("groupType").elements.container.toggleClassName("selectable"),this.views.header.iconBarFix.getItem("groupByType").content.component.getItem("groupType").elements.container.toggleClassName("selected"))},_onRequestSort:function(e){this.collection.sortOrder=e.sortOrder,this.collection.sortMode=e.sortMode,this.collection.sort(),this._updatePreferences();var t="sort"+("ascending"===e.sortOrder?"Asc":"Desc")+e.sortMode.charAt(0).toUpperCase()+e.sortMode.slice(1);this.views.header.iconBarFix.getItem("sort").content.component.setActiveItem(t)},_onRequestCatalogSwitchLayout:function(e){this.catalogLayout=this.views.catalog.layout%2+1,t.is(e)&&(this.catalogLayout="ThumbnailView"==e.layout?1:2),this.views.catalog.switchLayout(this.catalogLayout),this._updatePreferences()},_onCatalogSwitchLayout:function(){(this.views.catalog.layout+1)%2==1?(this.views.header.iconBarFix.getItem("switchCatalogLayout").elements.icon.toggleClassName("fonticon-view-small-thb",!1),this.views.header.iconBarFix.getItem("switchCatalogLayout").elements.icon.toggleClassName("fonticon-view-list",!0),t.is(this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component)&&(this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutGrid").elements.container.addClassName("selectable"),this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutGrid").elements.container.addClassName("selected"),this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutThumbnail").elements.container.removeClassName("selectable"),this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutThumbnail").elements.container.removeClassName("selected"))):(this.views.header.iconBarFix.getItem("switchCatalogLayout").elements.icon.toggleClassName("fonticon-view-small-thb",!0),this.views.header.iconBarFix.getItem("switchCatalogLayout").elements.icon.toggleClassName("fonticon-view-list",!1),t.is(this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component)&&(this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutGrid").elements.container.removeClassName("selectable"),this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutGrid").elements.container.removeClassName("selected"),this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutThumbnail").elements.container.addClassName("selectable"),this.views.header.iconBarFix.getItem("switchCatalogLayout").content.component.getItem("catalogLayoutThumbnail").elements.container.addClassName("selected"))),this.contextualMenu.catalogLayout=this.views.catalog.layout},_onRequestSetAsPrimary:function(e){var n=this,i=n.collection.id,o=e.item,r=e.lock;t.is(e.id,"string")&&(i=e.id),n.views.header.iconBar.disableItem("setAsPrimary");var s=n.collection.filter(function(e){return!0===e.get("isPrimary")}),a=s.some(function(e){return e.get("id")===o.get("id")});o.set("isProcessing",!0),a?C.unsetAsPrimary(n.collection.id).then(function(){o.set("isPrimary",!1),n.dispatchEvent("onUpdate",{objects:[{physicalId:i}]}),l.displayNotification({msg:D.notifications.UnsetAsPrimary.success,eventID:"info"})}).catch(function(e){if(e.includes("business object' does not exist")){var t=p.getErrorMessage("0");p.displayErrorMessage(t,"error")}else l.displayNotification({msg:D.notifications.UnsetAsPrimary.failure,eventID:"error"});n._logger.error(e)}).finally(function(){o.set("isProcessing",!1),n.views.header.iconBar.enableItem("setAsPrimary")}):C.setAsPrimary(o.get("id"),i,r).then(function(e){var t=JSON.parse(e);if(o.get("id")===t.documentId){for(var r=0;r<s.length;r++)s[r].set("isPrimary",!1);o.set("isPrimary",!0),n.dispatchEvent("onUpdate",{objects:[{physicalId:i}]}),l.displayNotification({msg:D.notifications.SetAsPrimary.success,eventID:"info"})}}).catch(function(e){if(e.message&&e.message.search("Access Denied"))l.displayNotification({msg:D.notifications.SetAsPrimary.Restricted,eventID:"error"});else if(e.includes("business object' does not exist")){var t=p.getErrorMessage("0");p.displayErrorMessage(t,"error")}else l.displayNotification({msg:D.notifications.SetAsPrimary.failure,eventID:"error"});n._logger.error(e)}).finally(function(){o.set("isProcessing",!1),n.views.header.iconBar.enableItem("setAsPrimary")})},_onRequestUpdateFile:function(e){var n=this,i=n.collection.id,o=e.item,r=e.lock;t.is(e.id,"string")&&(i=e.id),n.views.header.iconBar.disableItem("setAsPrimary");var s=n.collection.filter(function(e){return!0===e.get("isPrimary")});o.set("isProcessing",!0),C.setAsPrimary(o.get("id"),i,r).then(function(e){var t=JSON.parse(e);if(o.get("id")===t.documentId){for(var r=0;r<s.length;r++)s[r].set("isPrimary",!1);o.set("isPrimary",!0),n.dispatchEvent("onUpdate",{objects:[{physicalId:i}]}),n.refresh(),l.displayNotification({msg:D.notifications.SetAsPrimary.success,eventID:"info"})}}).catch(function(e){if(e.message&&e.message.search("Access Denied"))l.displayNotification({msg:D.notifications.SetAsPrimary.Restricted,eventID:"error"});else if(e.includes("business object' does not exist")){var t=p.getErrorMessage("0");p.displayErrorMessage(t,"error")}else l.displayNotification({msg:D.notifications.SetAsPrimary.failure,eventID:"error"});n._logger.error(e)}).finally(function(){o.set("isProcessing",!1),n.views.header.iconBar.enableItem("setAsPrimary")})},_onDrop:function(e){var n=this;e.preventDefault(),e.stopPropagation();var i=C.parseFromDragEvent(e);if(i)if(i.hasOwnProperty("files")&&i.files instanceof FileList)n._addFiles(i.files);else if(p.isValid3DXContent(i)){var o=i.data.items.map(function(e){return e.objectId});C.fetch(o).then(function(e){if(!t.is(e.results,"array"))throw new Error("Unexpected empty fetch results.");var i=e.results.map(function(e){return C.parseFromFetch(e)});n._add3DXObjects(i)}).catch(function(e){l.displayNotification({msg:D.replace(D.notifications.Attach.failure,{count:o.length}),eventID:"error"}),n._logger.error(e)})}else l.displayNotification({msg:D.notifications.Drop.unsupported,eventID:"warning"});else l.displayNotification({msg:D.notifications.Drop.unsupported,eventID:"warning"})},_onPasteEvent:function(e){e.preventDefault(),e.stopPropagation();var t=e.clipboardData.items;if(void 0!==t&&t.length>0){for(var n=[],i=0;i<t.length;i++){var o=t[i];if(-1===o.type.indexOf("image"))break;var r=o.getAsFile();n.push(r)}n.length>0&&this._addFiles(n)}},_addDropEvent:function(e){var t=this;if(t.authoring){var n=0;e.addEventListener("drop",function(){e.removeClassName("dragenter"),t._onDrop.apply(t,arguments)}),e.addEventListener("dragenter",function(){e.addClassName("dragenter"),n++}),e.addEventListener("dragleave",function(){--n<=0&&e.removeClassName("dragenter")}),e.addEventListener("mouseenter",function(){e.hasClassName("dragenter")&&n++}),e.addEventListener("mouseleave",function(){e.hasClassName("dragenter")&&--n<=0&&e.removeClassName("dragenter")}),e.addEventListener("dragover",function(e){e.preventDefault(),e.dataTransfer.dropEffect="copy",e.dataTransfer.effectAllowed="copy"})}},_updatePreferences:function(){(f.get("widget")||window.widget).setValue("attachmentManagerPreferences",{mode:this._currentMode,catalogLayout:this.views.catalog.layout,catalogVisibility:!this.rightFrameIsClosed,catalogWidth:this._rightFrameWidth,sliderVisibility:!this.bottomFrameIsClosed,groupByType:this.collection.groupByType,sortMode:this.collection.sortMode,sortOrder:this.collection.sortOrder}),this.views.header.refresh()},resetPADAlert:function(){l=null}})});