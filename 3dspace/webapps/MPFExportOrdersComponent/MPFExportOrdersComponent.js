define("DS/MPFExportOrdersComponent/ExportOrdersComponent",["UWA/Core","UWA/Class/View","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/MPFServices/ObjectService","DS/MPFExportOrderModel/ExportOrderFactory","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFUrl/UrlUtils","i18n!DS/MPFExportOrdersComponent/assets/nls/ExportOrdersComponent","css!DS/MPFExportOrdersComponent/MPFExportOrdersComponent"],function(e,t,o,r,n,i,s,a,c,p,d,h){"use strict";var y={LOADING:"loading",CLICKABLE:"clickable",NOT_DISPLAYED:"not_displayed"};return t.extend({className:"mpf-export-orders",setup:function(e){e=e||{},n.requiredOfPrototype(e.buyerType,s,"options.buyerType must be a BuyerType"),n.requiredOfPrototype(e.me,a,"options.me must be a PersonModel"),n.requiredOfPrototype(e.exportOrderFactory,i,"options.exportOrderFactory must be an ExportOrderFactory"),e.buyerType===s.COMPANY&&(n.requiredOfPrototype(e.company,c,"options.company must be a CompanyModel"),this.company=e.company),this._parent(e),this.layoutV2=!0===e.layoutV2,this.buyerType=e.buyerType,this.me=e.me,this.exportOrderFactory=e.exportOrderFactory,this.isUserPMPadmin=this._isUserPMPadmin(),this.stateMachine=this._createStateMachine(),this.downloadLink=this._createDownloadLink(),this.layoutV2&&this.container.addClassName("layout-v2")},render:function(){return this.stateMachine.getState()===y.LOADING?this.layoutV2||o.mask(this.downloadLink.elements.input):this.stateMachine.getState()===y.CLICKABLE&&(this.container.setContent(this.downloadLink),this.layoutV2||o.unmask(this.downloadLink.elements.input)),this},_createStateMachine:function(){return new p({state:this.isUserPMPadmin?y.CLICKABLE:y.NOT_DISPLAYED,states:[y.CLICKABLE,y.LOADING,y.NOT_DISPLAYED],transitions:[{from:y.CLICKABLE,to:y.LOADING},{from:y.LOADING,to:y.CLICKABLE}]})},_createDownloadLink:function(){return this.layoutV2?e.createElement("span",{class:"fonticon fonticon-download",events:{click:this._downloadOrders.bind(this)}}):new r({className:"link",icon:"export-multiple",value:h.get("exportOrders"),events:{onClick:this._downloadOrders.bind(this)}})},_downloadOrders:function(){var e,t=this;return this.stateMachine.changeState(y.LOADING),this.render(),(e=this.exportOrderFactory.createModel()).fetchPromise().then(function(){t.layoutV2||t.downloadLink.setIcon("export-multiple"),window.open(e.getURI(),"_blank")}).catch(function(){t.layoutV2||t.downloadLink.setIcon("wrong")}).finally(function(){t.stateMachine.changeState(y.CLICKABLE),t.render()})},_isUserPMPadmin:function(){var e,t=this,o=!1;return e=""!==new d(window.location.href).getValueParameter("esid",""),this.buyerType===s.COMPANY&&e&&(o=this.me.getRoles().some(function(e){return"Admin"===e.Role&&e.Project===t.company.getEmpProjectName()})),o}})}),define("DS/MPFExportOrdersComponent/ExportOrdersFactory",["UWA/Core","UWA/Promise","DS/MPFExportOrdersComponent/ExportOrdersComponent","DS/MPFDataProxy/Connector","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFCompanyModel/CompanyHelper"],function(e,t,o,r,n,i,s,a){"use strict";return e.Class.extend({init:function(e){i.requiredOfPrototype(e.connector,r,"options.connector must be a Connector"),this.connector=e.connector},buildView:function(){return this._initFactories().then(this._fetchMe.bind(this)).then(this._fetchCompanyIfExists.bind(this)).then(this._buildExportOrdersComponent.bind(this))},_initFactories:function(){var e=n.getInstance(this.connector);t.all([e.getFactory(n.Types.PERSON),e.getFactory(n.Types.COMPANY),e.getFactory(n.Types.EXPORT_ORDER)]).then(function(e){this.personFactory=e[0],this.companyFactory=e[1],this.exportOrderFactory=e[2]})},_fetchMe:function(){return this.me=this.personFactory.createModel("me"),this.me.fetchPromise()},_fetchCompanyIfExists:function(){return this.company=a.getCompanyFromPerson(this.me,this.companyFactory),e.is(this.company)?(this.buyerType=s.COMPANY,this.company.fetchPromise()):(this.buyerType=s.INDIVIDUAL,t.resolve())},_buildExportOrdersComponent:function(){return new o({buyerType:this.buyerType,me:this.me,company:this.company,exportOrderFactory:this.exportOrderFactory})}})});