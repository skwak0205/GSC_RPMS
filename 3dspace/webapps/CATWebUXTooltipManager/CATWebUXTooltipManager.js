/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATWebUXTooltipManager/CATWebUXTooltipManager",["UWA/Class","UWA/Core","DS/VisuEvents/EventsManager","DS/Selection/PSOManager","DS/Core/Events","css!DS/CATWebUXTooltipManager/CATWebUXTooltipManager.css"],function(e,t,n,o,i){"use strict";var r=4,s=70,a=e.extend({init:function(e){var a,c,u,v,l,f,m,d,p,T,g,h,E,y=0,x={},b=[],C=e.context.getViewer();function M(e){var t=e;return b.some(function(n){if(n.obj.filterPath){var o=n.obj.filterPath(e);return o&&(t=o),Boolean(o)}}),t}function W(e){var t=C.pick(C.getMousePosition(e),C.picking.primitive?"primHybrid":"mesh",!1);return!t||!t.path||t.path.length<1?null:M(t.path[0])}function U(e){p.removeClassName("top"),p.removeClassName("left"),p.removeClassName("right");var t="top",n=x.x-T.offsetWidth/2,o=x.y-T.offsetHeight-8-e;o<0?((o=x.y-T.offsetHeight/2)<0&&(o=0),t="right",(n=x.x+10+e)+T.offsetWidth>C.SCREEN_WIDTH&&(t="left",n=x.x-T.offsetWidth-8-e)):n<0?(t="right",n=x.x+10+e,o=x.y-T.offsetHeight/2):n+T.offsetWidth>C.SCREEN_WIDTH&&(t="left",n=x.x-T.offsetWidth-8-e,o=x.y-T.offsetHeight/2),p.addClassName(t),p.setStyles({left:n+"px",top:o+"px"})}function w(){p&&p.removeClassName("visible")}function A(){clearTimeout(E),E=0,clearTimeout(l),clearTimeout(f),l=f=d=void 0,x={},w()}function L(){var e=o.get()[0];if(e&&(!e||e.event)){var t=e.event.getCurrentPosition(C.canvas);if(t&&(x.x!==t.x||x.y!==t.y)){x=t,clearTimeout(f),f=void 0;var n=e.pathElement;if(n=M(n)){if(d&&d.isEqual(n)){if(p&&p.hasClassName("visible"))return E&&(clearTimeout(E),E=0),void(f=setTimeout(function(){U(e.event&&"Touch"===e.event.type?s:r)},500))}else{if(g&&p&&p.hasClassName("visible"))return void(E||(E=setTimeout(function(){N(),E=0},1e3)));w(),d=n.clone()}clearTimeout(l),l=void 0;var i=setTimeout(function(){i===l&&S([n],e.event&&"Touch"===e.event.type?s:r)},500);l=i}else A()}}}function N(){h||(A(),L())}function S(n,o,i){var r,s=[];p||(p=t.createElement("div",{id:"CATWebUXtooltip",class:"CATWebUXtooltip top"}).inject(e.context.getFrameWindow().getUIFrame()),t.createElement("div",{class:"CATWebUXtooltip-arrow"}).inject(p),T=t.createElement("div",{class:"CATWebUXtooltipbody"}).inject(p),p.addEventListener("mouseleave",function(){h=!1,E||(E=setTimeout(function(){N(),E=0},1e3))}),p.addEventListener("mouseenter",function(){h=!0,E&&(clearTimeout(E),E=0)})),g=!1,E&&(clearTimeout(E),E=0),w(),T.empty(),T.addClassName("prefill"),p.addClassName("visible"),U(o),r=b.length,b.forEach(function(e,t){e.obj.onTooltipReady({arrayPath:Array.isArray(n)?n:void 0,element:Array.isArray(n)?void 0:n,token:l,completed:function(e){var n,i;n=t,r--,(i=e)&&i.token&&i.div&&"number"==typeof i.token&&i.token===l?(i.interactiveContent&&(g=!0),s[n]=i.div,0===r&&(T.empty(),s.forEach(function(e){e.inject(T)}),T.removeClassName("prefill"),U(o),g?p.setStyle({"pointer-events":""}):p.setStyle({"pointer-events":"none !important"}))):p&&w()},fromTouchEvt:i})})}function R(e){if("mouseenter"===e.type){x={x:e.clientX,y:e.clientY},clearTimeout(l),l=0;var t=setTimeout(function(){t===l&&S(e.target,"Touch"===e.type?s:r)},500);l=t}else"mouseleave"===e.type&&(E&&(clearTimeout(E),E=0),l&&(clearTimeout(l),l=0),g?E=setTimeout(function(){N(),E=0},500):A())}function j(e){"@onViewpointBeginMove"===e.eventType&&A()}function k(e){var t,o,i=e.from[0].getCurrentPosition(C.canvas);if("@onLeftMouseDownEvent"===e.eventType&&1===e.from[0].event.buttons){if(!(t=W(i)))return void A();x.x===i.x&&x.y===i.y&&p&&p.hasClassName("visible")||(A(),d=t.clone(),o=setTimeout(function(){o===l&&S([t],r)},100),l=o),x=i}else if("@onLeftMouseUpEvent"===e.eventType||"@onRightMouseUpEvent"===e.eventType)A(),x=i;else if("@onLongHoldEvent"===e.eventType){if(x=i,!(t=W(i)))return void A();d&&d.isEqual(t)||(w(),d=t.clone()),clearTimeout(l),l=void 0,clearTimeout(f),f=void 0,o=setTimeout(function(){o===l&&(n.addEvent(C.canvas,"onRelease",k),S([t],s,!0))},100),l=o}else"@onReleaseEvent"===e.eventType&&("Touch"===e.from[0].type&&g?E=setTimeout(function(){N(),E=0},2e3):A(),x=i,n.removeEvent(C.canvas,"onRelease",k))}this.registerElements=function(e){e&&e.length&&e.forEach(function(e){e.addEventListener("mouseenter",R),e.addEventListener("mouseleave",R)})},this.unregisterElements=function(e){e&&e.length&&e.forEach(function(e){e.removeEventListener("mouseenter",R),e.removeEventListener("mouseleave",R)})},this.register=function(e){var t;if(e&&e.onTooltipReady)return b.some(function(n){if(n.obj===e)return t=n.token,!0})||(t=++y,b.push({token:t,obj:e}),a||(a=o.onPostAdd(L),v=o.onRemove(function(){E&&(clearTimeout(E),E=0),g&&(E=setTimeout(function(){N(),E=0},500))}),u=o.onEmpty(function(){E&&(clearTimeout(E),E=0),g?E=setTimeout(function(){N(),E=0},500):A()}),c=C.onViewerResize(A),m=i.subscribe({event:"/VISU/"},j),n.addEvent(C.canvas,"onLeftMouseDown",k),n.addEvent(C.canvas,"onLeftMouseUp",k),n.addEvent(C.canvas,"onRightMouseUp",k),n.addEvent(C.canvas,"onLongHold",k))),t},this.unregister=function(e){var t;return b.some(function(n,o){if(n.token===e)return t=e,b.splice(o,1),!0}),0===b.length&&(o.unsubscribe(a),a=void 0,o.unsubscribe(u),u=void 0,o.unsubscribe(v),v=void 0,C.unsubscribe(c),c=void 0,i.unsubscribe(m),m=void 0,n.removeEvent(C.canvas,"onLeftMouseDown",k),n.removeEvent(C.canvas,"onLeftMouseUp",k),n.removeEvent(C.canvas,"onRightMouseUp",k),n.removeEvent(C.canvas,"onLongHold",k),this.destroyTooltip()),t},this.clearTooltipManager=function(){this.destroyTooltip();var e=this;b&&b.forEach(function(t){e.unregister(t.token),t.obj=null}),l&&(clearTimeout(l),l=void 0),f&&(clearTimeout(f),f=void 0),E&&(clearTimeout(E),E=void 0),x=d=b=p=T=C=null},this.destroyTooltip=function(){A(),p&&p.destroy(),p=T=void 0}}}),c=[];return e.singleton({init:function(){},giveTooltipManager:function(e){var t;return e&&e.context&&e.context.getViewer&&e.context.getFrameWindow&&c.some(function(n){if(n.context===e.context)return t=n.tooltipMng,!0}),t},getTooltipManager:function(e){var t,n;return e&&e.context&&e.context.getViewer&&e.context.getFrameWindow&&c.some(function(n){if(n.context===e.context)return t=n,!0}),!t&&e&&e.context&&e.context.getViewer&&e.context.getFrameWindow?(n=new a({context:e.context}),c.push({context:e.context,tooltipMng:n,counter:1})):t&&(t.counter++,n=t.tooltipMng),n},unreferenceTooltipManager:function(e){e&&e.context&&e.context.getViewer&&e.context.getFrameWindow&&c.some(function(t,n){if(t.context===e.context)return c[n].counter--,c[n].counter<=0&&(c[n].tooltipMng.clearTooltipManager(),c.splice(n,1)),!0})}})});