/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationController/CAT3DAnnotBaseControllerInstance",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/Visualization/SceneGraphUtils","DS/CATWebUXComponents/CATWebUXInfoFlag","DS/SceneGraphNodes/PolyLineSectionUtils","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CATWebUXSlideShow/CATWebUXSlideShowController","DS/Visualization/Viewpoint","DS/Visualization/ClippingContext","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices","DS/WAFData/WAFData","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CoreEvents/Events","DS/ApplicationFrame/CommandsManager","DS/CATWebUXTooltipManager/CATWebUXTooltipManager","DS/CAT3DAnnotationUI/CAT3DAnnotationAttrDiv","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/Visualization/IdPath"],function(e,t,n,i,a,o,r,s,l,g,h,c,d,u,p,f,m,v,P,C,A,b,y){"use strict";return t.extend({init:function(t){var S=t||{};this._parent(S);var L,V,D,w,T,E,I,O,R,x,M,B,F=S.ctxViewer,U=this,_=!1,k=0,N=new s,q={},G=[],z={},W=null,j=[],J=[],X=new n.MeshBasicMaterial({color:"#436655"}),H=0,K=!0,Y=!0;let Q=[];var Z;function $(){var e=F.getController().getRootBagId(),t=b.getLoadedAssetType();Z===t&&W||(Z=t,W&&F.getViewer().getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(W),j.length=0,W=new m(F.getRootBagPath().getLastElement(!0),"3DXML"===t?void 0:e),F.getViewer().getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(W))}function ee(){W&&!F.getRootBagPath().getChildrenPathes().length&&(F.getViewer().getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(W),W=null)}this.setActiveState=function(e){if(_=e,L=l.giveAnnotationModelLoader({context:F}),!e||L){if(function(){if(!M&&!1!==S.slideShowCtrl){M=h.getSlideShowController({context:F.getFrameWindow(),id:"CAT3DAnnotationSlideShow"});var e,t={},n=[],i=[],a=function(e,t){var a=i[t-1].label;U.displayViewOrCapture({path:e,data:{label:a,icon:i[t-1].icon.replace("icons/22/","icons/32/")}}),M.displaySlideInformation({icon:i[t-1].icon.replace("icons/22/","icons/32/"),message:a+(void 0!==t?" ("+t+" / "+n.length+") ":""),secondary:i[t-1].associatedObjectLabel})},o=function(e,t){if(t&&t.length&&t[e[0]]&&t[e[0]].children&&t[e[0]].children[e[1]]&&t[e[0]].children[e[1]].path){var n=t[e[0]].children[e[1]].path.getChildrenPathes();if(n&&n.length&&n[e[2]]){var i=n[e[2]].getChildrenPathes();if(i&&i.length&&i[e[3]])return i[e[3]]}}},r=function(t,n){var a,o,r=0,s=[];for(r=0;r<t.children.length;r++)"RootViews"===t.children[r].type?a=r:"RootCaptures"===t.children[r].type&&(o=r);if(e&&t.children[o].children.length)for(r=0;r<t.children[o].children.length;r++)s.push([n[0],n[1],o,r]),i.push({label:t.children[o].children[r].name,icon:t.children[o].children[r].icon});else if(!e){for(r=0;r<t.children[a].children.length;r++){var l=t.children[a].children[r];if(!l.isSubView){var g,h=[n[0],n[1],a,r],c=l.name,d=l.icon,u=l.associatedCapture;u&&u.length&&(h=[n[0],n[1],o,u[0]-1],g=t.children[o].children[u[0]-1].name),s.push(h),i.push({label:c,icon:d,associatedObjectLabel:g});var p=0;if(u.length>1)for(p=1;p<u.length;p++)s.push([n[0],n[1],o,u[p]-1]),i.push({label:t.children[o].children[u[p]-1].name,icon:t.children[o].children[u[p]-1].icon,associatedObjectLabel:c});if(l.isMultiSectionView)for(p=0;p<l.multiSectionData.views.length;p++){var f=t.children[a].children[l.multiSectionData.views[p]-1];if(f.isSubView){var m=f.associatedCapture;if(m&&(!m||m.length))for(var v=0;v<m.length;v++)s.push([n[0],n[1],o,m[v]-1]),i.push({label:t.children[o].children[m[v]-1].name,icon:t.children[o].children[m[v]-1].icon,associatedObjectLabel:c})}}}}for(r=0;r<t.children[o].children.length;r++){var P=t.children[o].children[r];P.pointedView||(s.push([n[0],n[1],o,r]),i.push({label:P.name,icon:P.icon}))}}return s};t.onPreviousSlideCB=M.subscribe("onPreviousSlideCB",function(){for(var e=0;e<n.length;e++)if(n[e].isEqual(U.getFTAViewOrCaptureDisplayed()))return void(e>0?a(n[e-1],e):a(n[n.length-1],n.length));a(n[n.length-1],n.length)}),t.onNextSlideCB=M.subscribe("onNextSlideCB",function(){for(var e=0;e<n.length;e++)if(n[e].isEqual(U.getFTAViewOrCaptureDisplayed()))return void(e<n.length-1?a(n[e+1],e+2):a(n[0],1));a(n[0],1)}),t.onFirstSlideCB=M.subscribe("onFirstSlideCB",function(){a(n[0],1)}),t.onLastSlideCB=M.subscribe("onLastSlideCB",function(){a(n[n.length-1],n.length)}),t.onActiveStateModified=M.subscribe("onActiveStateModified",function(t){var i=0;t.state?U._getJSONModel(function(s){for(n=[],i=0;i<s.length;i++)if(s[i].children)for(var l=0;l<s[i].children.length;l++){var h=s[i].children[l];if(h.isVisible){var c=r(h,[i,l]);if(c.length)for(var d=0;d<c.length;d++)n.push(o(c[d],s))}}if(t.onBeginSlideShow(n.length>0),n.length){U._disableAnnotUI(),e=g.getPreference("3DAnnotDisplayCapturesPref");var u=U.getFTAViewOrCaptureDisplayed();if(u)for(i=0;i<n.length;i++)u.isEqual(n[i])&&a(u,i+1);else a(n[0],1)}}):U._enableAnnotUI(),U._publish("onSlideShowActiveStateModified",{state:t.state})})}}(),_&&!D){D={},x=C.getTooltipManager({context:F}),R=x.register({onTooltipReady:ae,filterPath:ie}),D.onAnnotationSetLoaded=L.subscribe("onAnnotationSetLoaded",function(e){U.onAnnotationSetLoaded(e),e&&e.path&&de(e.path)}),D.onAnnotationSetPartiallyLoaded=L.subscribe("onAnnotationSetPartiallyLoaded",function(e){U.onAnnotationSetLoaded(e),e&&e.path&&de(e.path)}),D.onAnnotationSetRemoved=L.subscribe("onAnnotationSetRemoved",U.onAnnotationSetRemoved),D.cmdsManager=P.onCommandStart(U._onCommandStartCB,F.getCommandContext&&F.getCommandContext()?F.getCommandContext():void 0),q.onAddRoot=F.subscribe({event:"onRootAdded"},$),q.onRemoveRoot=F.subscribe({event:"onRootRemoved"},ee),q.on3DPlayAssetChanged=F.subscribe({event:"on3DPlayAssetChanged"},ee),$(),L.getOrderedAnnotationSetPaths().map(function(e){return{path:e.annotSetPath}}).forEach(U.onAnnotationSetLoaded);var t=localStorage.getItem("CAT3DAnnotationSavedViewOrCapture");t&&(t=JSON.parse(t))&&t.uuid&&(U.displayViewOrCapture(t),localStorage.removeItem("CAT3DAnnotationSavedViewOrCapture"))}else if(!_&&D){Pe(),j.length=0,J.length=0;var n,i=Object.keys(q);for(n=0;n<i.length;n++)F.unsubscribe(q[i[n]]);if(h.unreferenceSlideShowController({context:F.getFrameWindow(),id:"CAT3DAnnotationSlideShow"}),M=null,x.unregister(R),C.unreferenceTooltipManager({context:F}),E&&(E.clean(),E=null),L)for(i=Object.keys(D),n=0;n<i.length;n++)L.unsubscribe(D[i[n]]);D.cmdsManager&&v.unsubscribe(D.cmdsManager),D=null,q={},G.splice(0,G.length),W&&(F.getViewer().getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(W),W=null)}U._publish("onAnnotControllerActiveStateChanged",{state:_})}else var a=setInterval(function(){(L=l.giveAnnotationModelLoader({context:F}))&&(clearInterval(a),U.setActiveState(_))},10)},this.clearController=function(){U.setActiveState(!1),F=U=L=N=V=X=E=I=null,G=z=null},this.onAnnotationSetLoaded=function(){M&&M.getActiveState()&&M.setActiveState(!1)},this.onAnnotationSetRemoved=function(e){if(M&&M.getActiveState()&&M.setActiveState(!1),Q&&e&&e.nodes&&e.nodes.length)for(let t=Q.length-1;t>=0;t--){let n=Q[t].path.getLastElement(!0);for(;n&&n.getAnnotationClassType&&"tpsAnnotationSet"!==n.getAnnotationClassType();)n=n.parents[0];for(let i=0;i<e.nodes.length;i++)if(e.nodes[i]===n){Q.splice(t,1);break}}Pe()},this.saveLastFTAViewOrCaptureDisplayed=function(e){var t=I&&I.getLastElement(!0).getAnnotationUuid?I.getLastElement(!0).getAnnotationUuid():null;if(t){var n={uuid:t};e&&(n.changeAnnotationVisibleStates=!1,n.changeViewpoint=!1),localStorage.setItem("CAT3DAnnotationSavedViewOrCapture",JSON.stringify(n))}},this.onAdditionalInfosRequired=function(e){return"AnnotBrowser"===e.controller?{getJSONModel:U._getJSONModel,addClipping:re,removeClipping:le,getCurrentClippingInfos:se,reframe:ge,getOverloadedPaths:oe}:"AnnotScenario"===e.controller?{getSelectedAnnotationsVisibilityFlag:U._getSelectedAnnotationsVisibilityFlag}:"AnnotStandardMgr"===e.controller?{getJSONModel:U._getJSONModel}:{}},this.getAnnotControllerPrototype=function(){return{getAnnotationControllerType:function(){if(U)return U.getAnnotationControllerType()},solveAttributeLink:function(e){U&&U.onAttributeClicked(e)},onAdditionalInfosRequired:function(e){return U?U.onAdditionalInfosRequired(e):{}},setActiveState:function(e){U&&U.setActiveState(e)},getActiveState:function(){if(U)return U.getActiveState()},getFTAViewOrCaptureDisplayInfos:function(e){if(U)return te(e)},displayFTAViewOrCapture:function(e){U&&U.displayViewOrCapture(e)},getDisplayAreaInfos:function(e){return U?U.getDisplayAreaInfos(e):null},getFTAViewOrCaptureDisplayed:function(){return U?U.getFTAViewOrCaptureDisplayed():null},saveLastFTAViewOrCaptureDisplayed:function(e){U&&U.saveLastFTAViewOrCaptureDisplayed(e)},setSectionVisibleFlag:function(e){U&&U.setSectionVisibleFlag(e)},getSectionVisibleFlag:function(){return U?U.getSectionVisibleFlag():null},isRunning:function(){return k>0},setAnnotationUIVisibleFlag:function(e){U&&U.setAnnotationUIVisibleFlag(e)},getAnnotationUIVisibleFlag:function(){return U?U.getAnnotationUIVisibleFlag():null},removeFilteringAndClipping:function(){Pe()},subscribe:function(e,t){if(U)return U.subscribe(e,t)},unsubscribe:function(e){U&&U.unsubscribe(e)}}},this.getActiveState=function(){return _},this.getAnnotationControllerType=function(){return"3DAnnotationBaseServices"},this.subscribe=function(e,t){return N&&e&&t?N.subscribe({event:e},t):void 0},this.unsubscribe=function(e){N&&e&&N.unsubscribe(e)};var te=function(e){if(!e||e&&!e.path&&!e.uuid||!_||e&&!e.cb)return void(e.cb&&e.cb());var t=e.path;if(!t&&e.uuid)for(var n=L.getOrderedAnnotationSetPaths(),i=0;i<n.length;i++){for(var a=n[i].annotSetPath.getChildrenPathes(),o=0;o<a.length;o++)if("RootViews"===a[o].getLastElement(!0).getAnnotationType()||"RootCaptures"===a[o].getLastElement(!0).getAnnotationType()){for(var r=a[o].getChildrenPathes(),s=0;s<r.length;s++)if(r[s].getLastElement(!0).getAnnotationUuid()===e.uuid){t=r[s];break}if(t)break}if(t)break}if(!t)return void(e.cb&&e.cb());let l=Q.find(e=>e.path.isEqual(t)?e:null);if(l)e.cb(l);else{l={path:t};var g=t.getLastElement(!0);if(!g.getAnnotationClassType||g&&"tpsView"!==g.getAnnotationClassType()&&"tpsCapture"!==g.getAnnotationClassType())e.cb&&e.cb(l);else{var h=t.getParentPath().getParentPath(),c=pe(t);if(c&&(l.clippingInfos=fe(c,"tpsView"===g.getAnnotationClassType()&&("SectionView"===g.getViewType()||"SectionCutView"===g.getViewType()||g.isMultiSectionView())||"tpsCapture"===g.getAnnotationClassType()&&g.isSectionPlaneActivated()),"tpsCapture"===g.getAnnotationClassType()&&(l.clippingInfos.uncutData=g.getListsOfUncutAssyPathComponents()),l.clippingInfos.clippingRepInformation=c.getLastElement(!0).get2DClippingInformation()),l.visibleAnnotations=[t,h],l.visibleAnnotations=l.visibleAnnotations.concat(g.getVisibleAnnotations(h,!0)),g.getVisibleBodiesInst||g.getHiddenBodiesInst){var d=function(e,t,n){var i=e||[],a=t||[];if(!i.length&&!a.length||!n)return;var o=U.getCGRPath(n),r={};if(o){var s=o.getLastElement(!0);s.getHideShowPathElement?r=s.getHideShowPathElement(i,a,o):(e&&e.length&&(r.hiddenPath=s.getPathElement(e,o)),t&&t.length&&(r.visiblePath=s.getPathElement(e,o)))}return r}(g.getHiddenBodiesInst(),g.getVisibleBodiesInst(),h.getParentPath());d&&d.visiblePath&&(l.visibleBodies=d.visiblePath),d&&d.hiddenPath&&(l.hiddenBodies=d.hiddenPath)}var u=t.getLastElement(!0).getListsOfAssyPathComponents&&void 0!==t.getLastElement(!0).getListsOfAssyPathComponents()?t.getLastElement(!0).getListsOfAssyPathComponents():null;u&&(u.hiddenPaths&&u.hiddenPaths.length&&(l.hiddenAssemblyPathElts=u.hiddenPaths),u.visiblePaths&&u.visiblePaths.length&&(l.visibleAssemblyPathElts=u.visiblePaths),u.visibleIdPaths&&u.visibleIdPaths.length&&(l.visibleAssemblyIdPaths=u.visibleIdPaths)),l.reframeInfos=U.getDisplayAreaInfos(t),Q.push(l),e.cb(l)}}};let ne=function(e){let t=e;for(;t&&t.getAnnotationClassType&&"tpsAnnotationSet"!==t.getAnnotationClassType();)t=t.parents[0];return!!t&&t.isVisible()};this.getAssociatedInformations=function(t,n,i){var a=[];if(!t||!t.length||!U.getActiveState())return a;var o=null;n&&n.getAttributeTypesFiltered&&(o=n.getAttributeTypesFiltered());var r,s,l=g.getPreference("3DAnnotAttributesOrderedList"),h=function(e){var t=!1,n={};if(o&&-1===o.indexOf("3DAnnotations")||null===o){var i=e.getAnnotationHyperlinkData?e.getAnnotationHyperlinkData():null;i&&(i.hyperlinksAndComments&&(n.hyperlinksAndComments=i.hyperlinksAndComments,t=!0),i.relatedDocs&&i.relatedDocs.length&&(n.relatedDocs=i.relatedDocs,t=!0),i.requirements&&i.requirements.length&&(n.requirements=i.requirements,t=!0),i.failureModes&&i.failureModes.length&&(n.failureModes=i.failureModes,t=!0))}return t?n:null};for(r=0;r<t.length;r++){let n=t[r].clone();for(;n&&!n.getLastElement(!0).getAnnotationClassType;)n=n.getParentPath();var c=n?n.getLastElement(!0):t[r].getLastElement(!0);if(c.getAnnotationClassType){if(!ne(c))continue;var d="tpsAnnotationSet"===c.getAnnotationClassType()?-1:c.getAnnotationID();if(d){var u={id:d,type:c.getAnnotationType(),name:c.getAnnotationName(),icon:c.getAnnotationIcon(),infos:{},path:t[r].clone()};for(s=0;s<l.length;s++)u.infos[l[s]]=null;var p=!1;if("tpsAttribute"===c.getAnnotationClassType()){if(o&&-1===o.indexOf(c.getAttributeCategory())||null===o){var f=c.getAttributeParam();if(!(i||("4"!==c.getAttributeCategory()||14!==c.getAttributeType()&&32!==c.getAttributeType())&&f))continue;f&&(u.infos[c.getAttributeCategory()]=f,p=!0)}}else if(o&&-1===o.indexOf("3DAnnotations")||null===o){var m,v=c.getTabulatedLimit?c.getTabulatedLimit():null,P=c.getAnnotationDimensionLimits?c.getAnnotationDimensionLimits():null;v&&P&&(m={tabulatedLimit:v,toleranceLimits:P});var C=c.getGeneralTolerance?c.getGeneralTolerance():null;C&&(m||(m={}),m.generalTol=C),m&&(u.infos.tolerances=m,p=!0)}var A=h(c);if(A&&(e.extend(u.infos,A),p=!0),p||i){var b=Object.keys(u.infos);for(s=b.length-1;s>=0;s--)u.infos[b[s]]||delete u.infos[b[s]];a.push(u)}}}else if("function"==typeof U.getPontingAnnotations){var y=U.getPontingAnnotations(t[r],!0);if(y&&y.length){var S,L,V=[];for(s=0;s<y.length;s++)if(L=(S=y[s]).getLastElement(!0),ne(L)&&"tpsAttribute"===L.getAnnotationClassType()&&(L.isFakeAttribute()&&(L=(S=S.getParentPath()).getLastElement(!0)),-1===V.indexOf(L)&&(V.push(L),o&&-1===o.indexOf(L.getAttributeCategory())||null===o))){var D=L.getAttributeParam();if(!D&&!i)continue;var w={};w[L.getAttributeCategory()]=D,a.push({name:L.getAnnotationName(),icon:L.getAnnotationIcon(),infos:w,path:S.clone()})}}}}return a};var ie=function(e){for(var t=e;t&&t.getLastElement(!0).getPickParent();)t=t.getParentPath();return t},ae=function(e){if(e&&e.completed)if(e.arrayPath&&1===e.arrayPath.length&&e.token){var t=U.getAssociatedInformations(e.arrayPath),n=[];if(t&&t.length&&(V||(V=new A),t.forEach(function(e){n.push(e.path.clone())}),V.setTouchDisplay(e.fromTouchEvt),V.build(t,!1,U.onAttributeClicked))){var i=P.getCommandCheckHeader("CAT3DAnnotSemanticAttrBrowserHdr",F.getCommandContext?F.getCommandContext():null);V.buildDivWithDots({onDivCreated:function(t){e.completed({token:e.token,div:t.div,interactiveContent:!0})},createReadMoreDiv:void 0!==i,uiFrame:F.getFrameWindow().getUIFrame(),callback:function(){i&&!i.getState()&&i.setState(!0),C.getTooltipManager({context:F}).destroyTooltip(),U._publish("onFeatureFocusRequired",{paths:n})}})}else e.completed({token:e.token,div:null})}else e.completed()},oe=function(){return z};this.getFTAViewOrCaptureDisplayed=function(){return I?I.clone():void 0},this.displayViewOrCapture=function(e){if(e&&_){var t=++H;U._publish("onBeginDisplayViewOrCapture",e),Pe(),e.path||e.uuid?te({path:e.path,uuid:e.uuid,cb:function(n){if(!n||n&&!n.path)e.cb&&e.cb(n);else{I=n.path.clone();var i,o,r=n.path.getLastElement(!0);if(!r||!r.getAnnotationClassType||r&&"tpsCapture"!==r.getAnnotationClassType()&&"tpsView"!==r.getAnnotationClassType())e.cb&&e.cb(n);else if(H===t){var s=n.path.getParentPath().getParentPath().getChildrenPathes();if(g.getPreference("3DAnnotKeepSelectedFeaturesPref")&&(s=s.filter(e=>"RootAttributes"!==e.getLastElement(!0).getAnnotationType())),!1!==e.changeAnnotationVisibleStates){for(i=0;i<s.length;i++){var l=s[i].getChildrenPathes();for(o=0;o<l.length;o++)l[o].getLastElement(!0).setVisibility(!1)}if(n.visibleAnnotations)for(i=0;i<n.visibleAnnotations.length;i++)n.visibleAnnotations[i].getLastElement(!0).setVisibility(!0)}if(n.hiddenBodies&&n.hiddenBodies.length||n.visibleBodies&&n.visibleBodies.length){if(n.hiddenBodies&&n.hiddenBodies.length){for(z.hiddenBodies=[],i=0;i<n.hiddenBodies.length;i++)a.getVisibilityFromPath(n.hiddenBodies[i])&&z.hiddenBodies.push(n.hiddenBodies[i]);a.applyVisibilityToPaths(z.hiddenBodies,0)}if(n.visibleBodies&&n.visibleBodies.length){for(z.visibleBodies=[],i=0;i<n.visibleBodies.length;i++)a.getVisibilityFromPath(n.visibleBodies[i])||z.visibleBodies.push(n.visibleBodies[i]);a.applyVisibilityToPaths(z.visibleBodies,1)}}(n.hiddenAssemblyPathElts||n.visibleAssemblyPathElts||n.visibleAssemblyIdPaths)&&be(n.hiddenAssemblyPathElts,n.visibleAssemblyPathElts,n.visibleAssemblyIdPaths),(w=n.clippingInfos)&&re(w),!1!==e.changeViewpoint&&ge(F.getViewer().currentViewpoint,U.getDisplayAreaInfos(n.path)),Ce(e.data&&e.data.label?e.data.label:r.getAnnotationName(),e.data&&e.data.icon?e.data.icon:r.getAnnotationIcon().replace("icons/22/","icons/32/")),r.setDisplayFlag(!0),U._publish("onViewOrCaptureDisplayed",n),e.cb&&e.cb(n)}}}}):(U._publish("onViewOrCaptureDisplayed",e),e.cb&&e.cb())}else e.cb&&e.cb({})};var re=function(e){if(le(),e&&e.path&&e.rootPath){var t=e.path.getParentPath().getParentPath().getParentPath();if(e.data&&K&&W){var i,a=F.getController().getRootBagId();i="3DXML"!==b.getLoadedAssetType()?W.createIdPathOverride({idPathes:[new y([a])]}):W.createOverride({pathes:[e.rootPath]});var o,r=[];if(e.uncutData&&(e.uncutData.uncutIdPaths&&e.uncutData.uncutIdPaths.length&&r.push(W.createIdPathOverride({idPathes:e.uncutData.uncutIdPaths})),e.uncutData.uncutPaths&&e.uncutData.uncutPaths.length||e.uncutData.uncutCGs&&e.uncutData.uncutCGs.length)){var s=e.uncutData.uncutPaths?e.uncutData.uncutPaths:[];e.uncutData.uncutCGs&&(s=s.concat(e.uncutData.uncutCGs)),r.push(W.createOverride({pathes:s}))}i&&(o=new d,e.multiClipping?o.setClippingProfile(e.data):o.setPlanes([e.data]),o.setSectionCappingMaterial(X),i.setClippingContext(o),J.push(i),r.length&&((o=new d).setExcludeFromClippingPlanes([e.data]),o.setEnableClippingProfile("off"),r.forEach(function(e){e.setClippingContext(o)}),J=r.concat(J)));var l,g=e.path.getLastElement(!0).getCappingRep?e.path.getLastElement(!0).getCappingRep():null;g&&t.getLastElement(!0).addChild(g),t.getChildrenPathes().some(function(e){if(e.getLastElement(!0)===g)return l=e.clone(),!0}),l&&((o=new d).setExcludeFromClippingPlanes([e.data]),o.setEnableClippingProfile("off"),(i=W.createOverride([e.path.getParentPath().getParentPath(),l])).setClippingContext(o),J.push(i)),F.getViewer().setSectionCapping(!0)}if(e.clippingRepInformation){var h=e.path.getLastElement(!0).get2DClippingRepresentation();if(!h){h=b.create2DClippingRepresentation(e.clippingRepInformation);var c=e.path.getLastElement(!0).getViewPlaneInformations(),u=(new n.Matrix4).makeBasis((new n.Vector3).crossVectors(c.direction,c.normal),c.direction,c.normal).setPosition(c.origin);h.setMatrix(u),e.path.getLastElement(!0).set2DClippingRepresentation(h)}h&&t.getLastElement(!0).addChild(h)}(e.data||e.clippingRepInformation)&&(F.getViewer().render(),T=e)}},se=function(){if(w&&w.rootPath&&w.path)return{clippingRepInformation:w.clippingRepInformation,multiClipping:w.multiClipping,uncutData:w.uncutData,rootPath:w.rootPath.clone(),path:w.path.clone(),data:w.data}},le=function(){if(T&&T.path&&F&&F.getViewer()){W&&J.length&&W.deleteOverrides(J),J.length=0;var e=T.path.getLastElement(!0).getCappingRep?T.path.getLastElement(!0).getCappingRep():null;e&&T.path.getParentPath().getParentPath().getParentPath().getLastElement(!0).removeChild(e);var t=T.path.getLastElement(!0).get2DClippingRepresentation()?T.path.getLastElement(!0).get2DClippingRepresentation():null;t&&T.path.getParentPath().getParentPath().getParentPath().getLastElement(!0).removeChild(t),F.getViewer().render(),T=null}};this.setAnnotationUIVisibleFlag=function(e){Y!==e&&((Y=e)?U._enableAnnotUI():U._disableAnnotUI())},this.getAnnotationUIVisibleFlag=function(){return Y},this._disableAnnotUI=function(){O=!0,(B=F.isDefaultContextualMenuVisible())&&F.setDefaultContextualMenuVisibility(!1),E&&E.setVisibleFlag(!1),U._publish("onAnnotUIDisabled")},this._enableAnnotUI=function(){O=!1,void 0!==B&&F.setDefaultContextualMenuVisibility(B),B=void 0,E&&E.setVisibleFlag(!0),U._publish("onAnnotUIEnabled")},this._getJSONModel=function(e){if(L){var t,n,i,a,o,r=L.getOrderedAnnotationSetPaths(),s=[];for(t=0;t<r.length;t++){if(a=ue(F.getRootBagPath(),r[t].referencePath),i=r[t].referencePath.getLastElement(!0),-1===s.indexOf(i)&&s.push(i),1!==(n=r[t].annotSetPath.getLastElement(!0).getContextType())&&3!==n){if(o=2===n?r[t].referencePath.getParentPath():r[t].referencePath,i=o.getLastElement(!0),!o.isEqual(a))for(;o;){if(b.isReference(o.getLastElement(!0))){i=o.getLastElement(!0);break}o=o.getParentPath()}-1===s.indexOf(i)&&s.push(i)}for(o=r[t].referencePath;o;){if(b.isInstance(o.getLastElement(!0))||o.isEqual(a.getParentPath())){o.isEqual(a.getParentPath())||-1===s.indexOf(o.getLastElement(!0))&&s.push(o.getLastElement(!0));break}o=o.getParentPath()}}var l=F.getRootBagPath().getChildrenPathes(),g=F.getHideShowController();for(t=0;t<l.length;t++)g.isVisible(l[t])&&-1===s.indexOf(l[t].getLastElement(!0))&&s.push(l[t].getLastElement(!0));!function(e,t){if(e instanceof Array&&t&&_){var n,i,a=[],o=[];if("3DXML"===b.getLoadedAssetType()){for(n=0;n<e.length;n++)i=b.getNodeInfos(e[n]),o.push({id:b.getNodeID(e[n]),label:i.name,icon:i.icon});t(o)}else{for(n=0;n<e.length;n++)b.getNodeID(e[n])&&a.push(b.getNodeID(e[n]));var r=a.slice(0);for(n=r.length-1;n>=0;n--)for(var s=0;s<G.length;s++)if(G[s].id===r[n]){o.push({id:G[s].id,label:G[s].label,icon:G[s].icon}),r.splice(n,1);break}r.length?F.getController().getAttributes({ids:a,attributes:["ds6w:label","type_icon_url"],callbacks:{onComplete:function(e){if(_){var r=function(e){for(var t=0;t<G.length;t++)if(G[t].id===e.id)return;G.push(e)};for(o=[],n=0;n<a.length;n++)i={id:a[n],label:e[a[n]]?e[a[n]]["ds6w:label"]:"",icon:e[a[n]]?e[a[n]].type_icon_url:void 0},o.push(i),r(i);t(o)}},onFailure:function(){if(_){for(o=[],n=0;n<a.length;n++)o.push({id:a[n],label:"",icon:""});t(o)}}}}):t(o)}}}(s,function(s){if(U.getActiveState()){r=L.getOrderedAnnotationSetPaths(),l=F.getRootBagPath().getChildrenPathes();var g,h,c=[],d=[];for(g=0;g<l.length;g++){var u=l[g].getLastElement(!0);for(t=0;t<s.length;t++)if(b.getNodeID(u)===s[t].id&&-1===d.indexOf(l[g])){c.push({id:b.getNodeID(u),path:l[g].clone(),name:s[t].label,icon:s[t].icon,type:b.getNodeType(u),children:[]}),d.push(l[g]);break}}for(g=0;g<r.length;g++){a=ue(F.getRootBagPath(),r[g].referencePath);var p=r[g].referencePath.getLastElement(!0);for(t=0;t<s.length;t++)if(b.getNodeID(p)===s[t].id){for(var f=s[t].label,m=r[g].referencePath;m;){if(b.isInstance(m.getLastElement(!0))||m.isEqual(a.getParentPath())){if(!m.isEqual(a.getParentPath()))for(h=0;h<s.length;h++)s[h].id===b.getNodeID(m.getLastElement(!0))&&s[h].label&&(f+=" ("+s[h].label+")");break}m=m.getParentPath()}var v=s[t].icon;if(1!==(n=r[g].annotSetPath.getLastElement(!0).getContextType())&&3!==n){if(o=2===n?r[g].referencePath.getParentPath():r[g].referencePath,i=o.getLastElement(!0),!o.isEqual(a))for(;o&&!b.isReference(o.getLastElement(!0));)o=o.getParentPath();if(o)for(h=0;h<s.length;h++)s[h].id===b.getNodeID(o.getLastElement(!0))&&s[h].icon&&(v=s[h].icon)}for(h=0;h<c.length;h++)if(c[h].path.isAParentOf(r[g].referencePath)){for(var P=!1,C=L.getDirectChildrenAnnotSets(c[h].path),A=0;A<C.length;A++)C[A].referencePath.isEqual(r[g].referencePath)&&(P=!0);var y=JSON.parse(JSON.stringify(r[g].annotSetPath.getLastElement(!0).toJSON()));y.id=r[g].annotSetPath.getLastElement(!0).id,y.path=r[g].annotSetPath.clone(),y.referenceLabel=f,y.referenceIcon=v,y.isDirectChild=P,y.isLeafChild=b.is3DLeaf(p),c[h].children.push(y);break}break}}e(c)}else e()})}},this._getSelectedAnnotationsVisibilityFlag=function(){var e,t,n="notAssigned",a="true"===localStorage.getItem("3DAnnotLoadARMPartsPref"),o=i.get();for(e=0;e<o.length;e++){var r=o[e].pathElement;if(r.internalPath.length){for(;r.internalPath.length;)r=r.getParentPath();for(;r&&!b.isPLMNode(r.getLastElement(!0))&&!r.getLastElement(!0).getAnnotationClassType;)r=r.getParentPath()}if(r){var s=L.getLoadedAnnotationSets(),l=!1,g=r.getLastElement(!0);if(g.getAnnotationClassType){if("tpsAttribute"===g.getAnnotationClassType())return"notAssigned";if("notAssigned"===n||null===n)n=g.isVisible();else if(n!==g.isVisible())return}else if(b.is3DLeaf(g)){var h=!1,c=me(r);if(c&&(h=!0,n=c.getLastElement(!0).isVisible()),!h){if(!r){"notAssigned"===n&&(n=null);continue}if(L.hasAlreadyBeenLoaded(b.getNodeID(r.getLastElement(!0)))){for(l=!1,t=0;t<s.length;t++)if(s[t].parents[0]===r.getLastElement(!0))if(l=!0,"notAssigned"===n||null===n)n=s[t].isVisible();else if(n!==s[t].isVisible())return;l||"notAssigned"!==n||(n=null)}else if("notAssigned"===n||null===n)n=!1;else if(n)return}}else{var d=null,u=L.getDirectChildrenAnnotSets(o[e].pathElement);if(b.isReference(g))for(a&&(d=L.hasAlreadyBeenLoaded(b.getNodeID(o[e].pathElement.getLastElement(!0)),!0)),t=0;t<u.length;t++){let n=u[t].referencePath.clone();for(;n&&!b.isReference(n.getLastElement(!0));)n=n.getParentPath();if(n&&(2===u[t].annotSetPath.getLastElement(!0).getContextType()||n.isEqual(o[e].pathElement))){var p=u[t].annotSetPath.getLastElement(!0).isVisible();if(null===d)d=p;else if(d!==p){d=void 0;break}}}else for(t=0;t<u.length;t++){var f=u[t].annotSetPath.getLastElement(!0).isVisible();if(null===d)d=f;else if(d!==f){d=void 0;break}}if(void 0===d||null!==d&&"notAssigned"!==n&&n!==d)return;if(null!==d&&"notAssigned"===n)n=d;else if(null===d)if(L.hasAlreadyBeenLoaded(b.getNodeID(o[e].pathElement.getLastElement(!0)))){for(l=!1,t=0;t<s.length;t++)if(s[t].parents[0]===r.getLastElement(!0)){l=!0,n=!1;break}l||(n=null)}else n=!1}}}return n},this._onCommandStartCB=function(e){"PAD3DToggleSimplifiedHdr"!==e._id&&"PAD3DToggleAccurateHdr"!==e._id||Pe()},this.getDisplayAreaInfos=function(e){var t,i,a=F.getViewer().currentViewpoint.camera.fov,o=e.getLastElement(!0),r=ve(e),s=(new n.Matrix4).extractRotation(r),l=o.getCaptureCamera?o.getCaptureCamera():null;if(l&&"EquivalentCamera"!==l.nature){t={};var g=(new n.Vector3).copy(l.position);g.applyMatrix4(r),t.target=(new n.Vector3).copy(l.target),t.target.applyMatrix4(r),t.sight=(new n.Vector3).copy(l.direction).normalize(),t.sight.applyMatrix4(s),t.up=(new n.Vector3).copy(l.zenith).normalize(),t.up.applyMatrix4(s).normalize();var h=l.zoom;(0===h||isNaN(h))&&(t.distanceToTarget=t.target.distanceTo(g),h=1/(t.distanceToTarget*Math.tan(Math.PI/180*13.5))),t.distanceToTarget=1/(h*Math.tan(.5*a*Math.PI/180)),t.projectionType="0"===l.type?c.PERSPECTIVE:c.ORTHOGRAPHIC,t.origin=(new n.Vector3).copy(t.target),t.origin.sub((new n.Vector3).copy(t.sight).multiplyScalar(t.distanceToTarget))}else{var d=pe(e);if(d){t={};let e=d.getLastElement(!0);var u=e.getReframeArea(),p=e.getViewPlaneInformations();if(u){var f=Math.sqrt(u.width*u.width+u.length*u.length)/2,m=new n.Vector2(u.cornerX+u.width/2,u.cornerY+u.length/2),v=(new n.Vector3).crossVectors(p.direction,p.normal).normalize();t.origin=(new n.Vector3).copy(p.origin),t.origin.add((new n.Vector3).copy(v).multiplyScalar(m.x)),t.origin.add((new n.Vector3).copy(p.direction).multiplyScalar(m.y)),t.origin.applyMatrix4(r),t.sight=(new n.Vector3).copy(p.normal).applyMatrix4(s).normalize().negate(),t.distanceToTarget=f/Math.tan(a*Math.PI/360),t.origin.sub((new n.Vector3).copy(t.sight).multiplyScalar(t.distanceToTarget)),t.up=(new n.Vector3).copy(p.direction).applyMatrix4(s).normalize()}else{t.sight=(new n.Vector3).copy(p.normal).applyMatrix4(s).normalize().negate(),t.up=(new n.Vector3).copy(p.direction).applyMatrix4(s).normalize(),t.reframeView=d.clone();var P=[t.reframeView],C=t.reframeView.getLastElement(!0);if(C.isMultiSectionView()){var A=C.getMultiSectionData();if(A&&(A=A.views).length)for(var y=t.reframeView.getParentPath().getChildrenPathes(),S=0;S<A.length;S++)P.push(y[A[S]-1])}var L,V,D=t.reframeView.getParentPath().getParentPath(),w=D.getParentPath();if(P.forEach(function(e){(L=function(e){var t;if(e){var i,a,o,r,s=e.getParentPath().getParentPath(),l=ve(e),g=e.getLastElement(!0),h=g.getVisibleAnnotations(s,!0);if(h.length)for(i=0;i<h.length;i++)if("tps"===h[i].getLastElement(!0).getAnnotationClassType()&&(r=[],Se(h[i].getLastElement(!0),r),r.length))for(a=0;a<r.length;a++)(o=r[a].getBoundingSphere("visibleSpace")).radius&&(t?t.mergeWithSphere(o,t):t=(new n.Sphere).copy(o));if(g.get2DClippingRepresentation&&g.get2DClippingRepresentation()&&(o=g.get2DClippingRepresentation().getBoundingSphere("visibleSpace"))&&o.center){var c=e.getLastElement(!0).getViewPlaneInformations(),d=(new n.Matrix4).makeBasis((new n.Vector3).crossVectors(c.direction,c.normal),c.direction,c.normal).setPosition(c.origin);o.center.applyMatrix4(d),t?t.mergeWithSphere(o,t):t=(new n.Sphere).copy(o)}if((g.isSubView()||g.isMultiSectionView())&&(!t||!t.radius)&&(r=[],Se(e.getLastElement(!0),r),r.length))for(a=0;a<r.length;a++)(o=r[a].getBoundingSphere("visibleSpace")).radius&&(t?t.mergeWithSphere(o,t):t=(new n.Sphere).copy(o));t&&t.center.applyMatrix4(l)}return t}(e))&&L.radius&&(i?i.mergeWithSphere(L,i):i=(new n.Sphere).copy(L))}),o.getCaptureCamera&&o.getAnnotationVersion()>=18){var T=o.getListsOfAssyPathComponents();T&&T.visibleIdPaths.forEach(function(e){var t=e.idPathes&&e.idPathes.length?e.idPathes[0].buildPathElement(F.getViewer().getIdPathMatcher()):null;t&&!t.isEqual(w)&&(L=t.getBoundingSphere(F.getViewer(),"visibleSpace"))&&L.radius&&(i?i.mergeWithSphere(L,i):i=(new n.Sphere).copy(L))})}if(!i||!i.radius)if(2===D.getLastElement(!0).getContextType()){w=w.getParentPath(),b.isInstance(w.getLastElement(!0))&&(w=w.getParentPath());var E=w.getChildrenPathes();for(V=0;V<E.length;V++)(L=E[V].getBoundingSphere(F.getViewer(),"visibleSpace"))&&L.radius&&(i?i.mergeWithSphere(L,i):i=(new n.Sphere).copy(L));i&&i.center.applyMatrix4(r)}else{var I;for(V=0;V<w.getChildrenPathes().length;V++)I=w.getChildrenPathes()[V],L=I.getBoundingSphere(F.getViewer(),"visibleSpace"),!I.isEqual(D)&&L.radius&&(i?i.mergeWithSphere(L,i):i=(new n.Sphere).copy(L))}if(!i)return;t.origin=(new n.Vector3).copy(i.center),i.radius||t.origin.copy(C.getViewPlaneInformations().origin),t.distanceToTarget=i.radius/Math.tan(F.getViewer().currentViewpoint.camera.fov*Math.PI/360),t.origin.sub((new n.Vector3).copy(t.sight).multiplyScalar(t.distanceToTarget))}}else if(o.getCaptureSupportPlane){const a=o.getCaptureSupportPlane();a&&a.plane&&((t={}).sight=(new n.Vector3).copy(a.plane.normal).applyMatrix4(s).normalize().negate(),t.sight.x||t.sight.y||t.sight.z||(t.sight=new n.Vector3(-1,0,0)),t.up=a.up.clone(),t.up.x||t.up.y||t.up.z||(t.up=new n.Vector3(0,0,1)),(i=e.getBoundingSphere(F.getViewer(),"visibleSpace")).radius||(i=F.getRootBagPath().getBoundingSphere(F.getViewer(),"visibleSpace")),i&&i.radius&&(t.origin=(new n.Vector3).copy(i.center),t.distanceToTarget=i.radius/Math.tan(F.getViewer().currentViewpoint.camera.fov*Math.PI/360),t.origin.sub((new n.Vector3).copy(t.sight).multiplyScalar(t.distanceToTarget))))}}return t};var ge=function(e,t,n){e&&t&&t.origin&&t.distanceToTarget&&t.sight&&t.up&&(void 0!==t.projectionType&&e.setProjectionType(t.projectionType),0!==n?e.moveTo({eyePosition:t.origin,upDirection:t.up,sightDirection:t.sight,distanceToTarget:t.distanceToTarget,duration:n>0?n:400}):(e.setEyePosition(t.origin),e.setSightDirection(t.sight),e.setUpDirection(t.up),e.setTargetDistance(t.distanceToTarget)))};function he(e,t,n,i,a){if(e&&(!e||e.length)&&t&&n&&(!n||n.length)){var o,r,s,l={};for(o=0;o<e.length;o++)for(r=0;r<n.length;r++){var g,h,c=n[r].getLastElement(!0);if(c.getLinkedDataRelatedInfos){var d=c.getLinkedDataRelatedInfos();for(s=0;s<d.length;s++)d[s].addressRelId===e[o].matches[0].sr_id&&c.addLinkedData({displayLabel:d[s].anchorText,label:e[o].elements[0]["ds6w:label"],type:d[s].type,phyID:e[o].elements[0].physicalid,phyType:e[o].elements[0]["ds6w:type"]})}if(c.getVisibleCompRelIds&&c.getVisibleCompRelIds()&&-1!==c.getVisibleCompRelIds().indexOf(e[o].matches[0].sr_id)){for(g=e[o].elements,h=[],s=0;s<g.length;s++)h.push(g[s].physicalid);l[r]||(l[r]={path:n[r].clone(),instancePaths:[],uncutPaths:[]}),l[r].instancePaths.push(h)}if(c.getUncutCompRelIds&&c.getUncutCompRelIds()&&-1!==c.getUncutCompRelIds().indexOf(e[o].matches[0].sr_id)){for(g=e[o].elements,h=[],s=0;s<g.length;s++)h.push(g[s].physicalid);l[r]||(l[r]={path:n[r].clone(),instancePaths:[],uncutPaths:[]}),l[r].uncutPaths.push(h)}}for(r=0;r<n.length;r++)n[r].getLastElement(!0).getLinkedDataRelatedInfos&&delete n[r].getLastElement(!0).getLinkedDataRelatedInfos;var u=[],p=Object.keys(l);for(o=0;o<p.length;o++)u.push(l[p[o]]);!function(e,t,n){if(e.length){var i,a,o,r,s,l,g,h=[],c=[],d=[],u=F.getRootBagPath().getChildrenPathes();for(i=0;i<u.length;i++)if(u[i].isAParentOf(e[0].path)){g=u[i].clone();break}for(i=0;i<e.length;i++){r=e[i].instancePaths,s=e[i].uncutPaths,l={path:e[i].path.clone(),capture:e[i].path.getLastElement(!0)},d.push(l);var p=[],f={},m=[];for(r&&r.length&&(l.instancePaths=r.slice(),m=m.concat(r)),s&&s.length&&(l.uncutPaths=s.slice()),a=0;a<m.length;a++)for(o=0;o<m[a].length;o++)-1===p.indexOf(m[a][o])&&p.push(m[a][o]),-1===h.indexOf(m[a][o])&&h.push(m[a][o]),o===m[a].length-1&&(f[m[a][o]]?f[m[a][o]]++:f[m[a][o]]=1);for(a=0;a<p.length;a++)1===f[p[a]]&&-1===c.indexOf(p[a])&&c.push(p[a])}Ae({physicalIDs:h,onComplete:function(e){var r,s,l=[],h=[],u=[],p=JSON.parse(e);p&&p.infos&&"OK"===p.infos.status&&p.result&&(p.result.forEach(function(e){r=e.input_object,(s=e.outputs&&e.outputs.ref&&e.outputs.ref.length?e.outputs.ref[0]:null)&&("3DShape"===s["ds6w:type"]?h[r.physicalid]=s.physicalid:(l[r.physicalid]=s.physicalid,"VPMReference"===s["ds6w:type"]&&-1!==c.indexOf(r.physicalid)&&-1===u.indexOf(s.physicalid)&&u.push(s.physicalid)))}),Ae({physicalIDs:u,shapesOnly:!0,onComplete:function(e){p=JSON.parse(e);var n={};if(p&&p.infos&&"OK"===p.infos.status&&p.result){p.result.forEach(function(e){r=e.input_object;for(var t=e.outputs&&e.outputs.ref&&e.outputs.ref.length?e.outputs.ref:null,i=0;i<t.length;i++){if(!t[i])return;"VPMRepInstance"===t[i]["ds6w:type"]&&(n[r.physicalid]||(n[r.physicalid]=[]),n[r.physicalid].push([t[i].physicalid,t[i].to.physicalid]))}});var s=b.getNodeID(g.getLastElement(!0));d.forEach(function(e){var t,r,g,c,d=F.getController().getRootBagId(),u=function(e){var t,r=[];if(e&&e.length)for(i=0;i<e.length;i++){for(t=[d,s],a=0;a<e[i].length;a++)if(t.push(e[i][a]),h[e[i][a]])t.push(h[e[i][a]]);else if(t.push(l[e[i][a]]),a===e[i].length-1&&n[l[e[i][a]]]&&n[l[e[i][a]]].length){for(o=1;o<n[l[e[i][a]]].length;o++)r.push(t.concat(n[l[e[i][a]]][o]));t=t.concat(n[l[e[i][a]]][0])}r.push(t.slice())}return r};if(e.instancePaths&&e.instancePaths.length){for(t=u(e.instancePaths),r=[],g=e.path.clone();g&&g.externalPath.length>1;)(c=b.getNodeID(g.getLastElement(!0)))&&r.unshift(c),g=g.getParentPath();t.push([d].concat(r)),e.capture.setListsOfAssyPathComponents({visibleIdPaths:t.map(function(e){return{idPathes:[new y(e.slice())],propagateToParents:!0}})})}e.uncutPaths&&e.uncutPaths.length&&e.capture.setListsOfUncutAssyPathComponents({uncutIdPaths:u(e.uncutPaths).map(function(e){return new y(e)})})}),t()}},onFailure:n,onTimeout:n}))},onFailure:n,onTimeout:n})}else t()}(u,i,a)}}function ce(e,t){for(var n,i=[],a=e.getChildrenPathes(),o=0;o<a.length;o++)if("RootGeometries"===a[o].getLastElement(!0).getAnnotationType())for(var r=a[o].getChildrenPathes(),s=0;s<r.length;s++)n=r[s].getLastElement(!0),-1!==t.indexOf(n.getAnnotationID())&&i.push(r[s]);return i}this.onAttributeClicked=function(e){var t=e;t.cmdContext=F.getCommandContext(),b.solveAttributeLink(t)};var de=function(t){k++;var n=function(e){k--,U&&U._publish("onAnnotationsLinkedDataSolved",{path:t,succeeded:"boolean"==typeof e&&e})},i=t?t.getLastElement(!0):null;if(!t||t&&!i.getAnnotationClassType||t&&i.getAnnotationClassType&&"tpsAnnotationSet"!==i.getAnnotationClassType())n();else{for(var a,o=t.getChildrenPathes(),r=0;r<o.length;r++)if("RootCaptures"===o[r].getLastElement(!0).getAnnotationType())for(var s=o[r].getChildrenPathes(),l=0;l<s.length;l++)(a=s[l].getLastElement(!0)).getUncutCGs()&&a.getUncutCGs().length&&a.setListsOfUncutAssyPathComponents({uncutCGs:ce(t,a.getUncutCGs())});if("3DXML"===b.getLoadedAssetType())return function(e){for(var t,n,i,a,o=F.getRootBagPath().getChildrenPathes(),r=0;r<o.length;r++)if(o[r].isAParentOf(e)){t=o[r];break}for(var s=function(e,a){var o=e.getLastElement(!0);if(!b.is3DLeaf(o)&&!e.isEqual(a)){if(!e.isAParentOf(a)&&(e.getParentPath().isEqual(t)&&b.isRepInstance(o)||b.isInstance(o))){for(var r=!0,l=0;l<n.length;l++)if(n[l].isEqual(e)){r=!1;break}if(r&&i.push(e.clone()),e.getParentPath().isEqual(t)&&b.isRepInstance(o))return}for(var g=e.getChildrenPathes(),h=0;h<g.length;h++)s(g[h],a)}},l=e.getChildrenPathes(),g=0;g<l.length;g++)for(var h=l[g].getChildrenPathes(),c=0;c<h.length;c++){var d,u,p,f=h[c].getLastElement(!0).getXMLVisibleCompRelIds?h[c].getLastElement(!0).getXMLVisibleCompRelIds():null;if(f&&f.length){for(n=[],i=[],d=0;d<f.length;d++){for(u=t.clone(),p=0;p<f[d].length;p++)u=ye(u,f[d][p]);n.push(u)}s(t,h[c]),h[c].getLastElement(!0).setListsOfAssyPathComponents({visiblePaths:n,hiddenPaths:i})}if((f=h[c].getLastElement(!0).getXMLUncutCompRelIds?h[c].getLastElement(!0).getXMLUncutCompRelIds():null)&&f.length){for(a=[],d=0;d<f.length;d++){for(u=t.clone(),p=0;p<f[d].length;p++)u=ye(u,f[d][p]);a.push(u)}h[c].getLastElement(!0).setListsOfUncutAssyPathComponents({uncutPaths:a})}}}(t),void setTimeout(function(){n(!0)},10);var g=function(e){for(var t,n=e.getChildrenPathes(),i={relIds:[],paths:[]},a=0;a<n.length;a++)for(var o=n[a].getChildrenPathes(),r=0;r<o.length;r++){var s,l=o[r].getLastElement(!0),g=l.getLinkedDataRelatedInfos?l.getLinkedDataRelatedInfos():null;if(g&&g.length)for(i.paths.push(o[r].clone()),t=0;t<g.length;t++)-1===i.relIds.indexOf(g[t].addressRelId)&&i.relIds.push(g[t].addressRelId);if(l.getVisibleCompRelIds&&l.getVisibleCompRelIds())for(i.paths.push(o[r].clone()),s=l.getVisibleCompRelIds(),t=0;t<s.length;t++)-1===i.relIds.indexOf(s[t])&&i.relIds.push(s[t])}return i}(t);g.relIds&&g.relIds.length&&g.paths&&g.paths.length?function(t){if(!e.is(t,"object"))return;if(!e.is(t.onComplete,"function"))return;if(!e.is(t.physicalID,"string"))return void t.onComplete();if(!e.is(t.onFailure,"function"))return void t.onComplete();if(!e.is(t.onTimeout,"function"))return void t.onComplete();var n={};t.semantics&&(n.semantics=t.semantics);t.role&&(n.role=t.role);t.relIds&&t.relIds.length&&(n.sr_id=t.relIds);var i={input_physical_ids:[t.physicalID],primitives:[{navigate_to_sr:{id:1,filter:n,mode:"path"}}],patterns:{RESULTS:[{id:1,iter:1}]},flags:["returnMatches","noReturnThumbnails"],version:3,label:"CAT3DAnnotControllerNav"},a={data:JSON.stringify(i),timeout:parseInt(u.getSetting("webapi_timeout"),10),method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:t.onComplete,onFailure:t.onFailure,onTimeout:t.onTimeout};f.authenticatedRequest(p.get3DSpaceUrl()+"/cvservlet/navigate?SecurityContext="+u.getSetting("pad_security_ctx"),a)}({physicalID:b.getNodeID(t.getParentPath().getLastElement(!0)),relIds:g.relIds,semantics:["4"],role:["173"],onComplete:function(i){if(U){var a=e.is(i,"string")?JSON.parse(i):i;!e.is(a.result,"array")||a.result.length<1||!e.is(a.result[0].outputs.RESULTS,"array")||a.result[0].outputs.RESULTS.lenght<1?n():he(a.result[0].outputs.RESULTS,t,g.paths,function(){k--,U._publish("onAnnotationsLinkedDataSolved",{path:t,succeeded:!0})},n)}},onFailure:n,onTimeout:n}):n()}},ue=function(e,t){if(e.isAParentOf(t)){var n=e.getLastElement(!0);if(b.is3DLeaf(n)||b.isReference(n))return e;for(var i=e.getChildrenPathes(),a=0;a<i.length;a++){var o=ue(i[a],t);if(o)return o}}},pe=function(e){var t=e.getLastElement(!0);if(!t||!t.getAnnotationClassType||"tpsView"===t.getAnnotationClassType())return e;if(t&&t.getAnnotationClassType&&"tpsCapture"===t.getAnnotationClassType()){var n=e.getParentPath().getParentPath();if(t.getPointedView()){var i=n.getLastElement(!0).getRootAnnotationNode("RootViews");if(i){var a=n.clone();return a.addElement(i),a.addElement(i.children[t.getPointedView()-1]),a}}}},fe=function(e,t){var i;if(e&&"tpsView"===e.getLastElement(!0).getAnnotationClassType()){var a,o=e.getLastElement(!0);i={path:e.clone()};var s=F.getRootBagPath(),l=ve(e),g=s.getChildrenPathes();for(a=0;a<g.length;a++)g[a].isAParentOf(e)&&(i.rootPath=g[a].clone());if(!t)return i;if(o.isMultiSectionView()){i.multiClipping=!0;var h=o.getMultiSectionData(),c=(new n.Vector3).copy(h.SketchNormal).normalize().negate(),d=(new n.Vector3).subVectors(h.pointsDef[1],h.pointsDef[0]),u=(new n.Vector3).crossVectors(c,d).normalize();e.getParentPath().getLastElement(!0).children[h.views[0]-1].getViewPlaneInformations().normal.dot(u)>0&&c.negate();var p=(new n.Vector3).copy(h.SketchOrigin),f=new n.Vector3(c.y,c.x,c.z).normalize();f.equals(c)&&(f=new n.Vector3(c.x,c.z,c.y).normalize());var m=(new n.Vector3).crossVectors(c,f).normalize();p.applyMatrix4(l);var v=(new n.Matrix4).extractRotation(l);f.applyMatrix4(v),m.applyMatrix4(v);var P,C=[];for(a=0;a<h.pointsDef.length;a++){var A=(new n.Vector3).copy(h.pointsDef[a]).applyMatrix4(l);P=(new n.Vector3).subVectors(A,p),C.push(new n.Vector2(P.dot(f),P.dot(m)))}var b={polyLinePoints:C,planeOrigin:p,planeU:f,planeV:m},y=s.getLastElement(!0).getBoundingSphere("visibleSpace");i.data=r.makeClosedPolyLine(b,y)}else{var S=o.getViewPlaneInformations();i.data=(new n.Plane).setFromNormalAndCoplanarPoint(S.normal.clone().negate(),S.origin.clone()).applyMatrix4(l)}}return i};this._publish=function(e,t){N.publish({event:e,data:t,context:U})};var me=function(e){for(var t=e.getChildrenPathes(),n=0;n<t.length;n++)if(t[n].getLastElement(!0).getAnnotationClassType&&"tpsAnnotationSet"===t[n].getLastElement(!0).getAnnotationClassType())return t[n]},ve=function(e){for(var t=e.clone();t&&!b.isInstance(t.getLastElement(!0));)t=t.getParentPath();var i=new n.Matrix4;return t&&i.copy(t.getWorldMatrix(F.getViewer())),i},Pe=function(e){(z.hiddenBodies&&z.hiddenBodies.length||z.visibleBodies&&z.visibleBodies.length)&&(z.hiddenBodies&&z.hiddenBodies.length&&a.applyVisibilityToPaths(z.hiddenBodies,1),z.visibleBodies&&z.visibleBodies.length&&a.applyVisibilityToPaths(z.visibleBodies,0)),z.hiddenBodies=null,z.visibleBodies=null,le(),w=null,E&&E.hide(),I=void 0,W&&j.length&&W.deleteOverrides(j),j.length=0,F.getViewer().render(),U._publish("onFilteringAndClippingRemoved",{interactiveAction:e})},Ce=function(e,t){_&&(E&&E.hide(),(T&&T.path||z.hiddenBodies&&z.hiddenBodies.length||z.visibleBodies&&z.visibleBodies.length||W&&j.length)&&(E||(E=new o({frameWindow:F.getFrameWindow(),viewer:F.getViewer()})),E.display({label:e,icon:t,onClickCB:function(){Pe(!0)},widgetType:"Cancel"}),O&&E.setVisibleFlag(!1)))};function Ae(t){if(e.is(t,"object")&&e.is(t.onFailure,"function"))if(e.is(t.physicalIDs,"array"))if(e.is(t.onComplete,"function")){if(e.is(t.onTimeout,"function")){var n=p.get3DSpaceUrl()+"/cvservlet/navigate?SecurityContext="+u.getSetting("pad_security_ctx"),i={input_physical_ids:t.physicalIDs,label:"CAT3DAnnotControllerRefNavigation",primitives:[{navigate_to_rel:t.shapesOnly?{id:1,mode:"return_rel"}:{id:1}}],patterns:{ref:[{id:1}]},attributes:["ds6w:label","ds6w:type"],fileAttributes:[],version:3};return f.authenticatedRequest(n,{data:JSON.stringify(i),method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:u.getSetting("pad_security_ctx")},timeout:parseInt(u.getSetting("webapi_timeout"),10),onComplete:t.onComplete,onFailure:t.onFailure,onTimeout:t.onTimeout})}t.onFailure()}else t.onFailure();else t.onFailure()}this.setSectionVisibleFlag=function(e){K!==e&&((K=e)?re(w):le())},this.getSectionVisibleFlag=function(){return K},this.getCGRPath=function(e){if(e){for(var t=e.getChildrenPathes(),n=0;n<t.length;n++){var i=t[n].getLastElement(!0);if(i.getPathElement&&i.setInternalSceneGraph)return t[n]}return U.getCGRPath(e.getParentPath())}};var be=function(e,t,n){if(W&&(e&&e.length||t&&t.length||n&&n.length)){var i,a,o=F.getController().getRootBagId(),r=b.getLoadedAssetType();j.length&&W.deleteOverrides(j),"3DXML"!==r&&n&&n.length?((i=W.createIdPathOverride({idPathes:[new y([o])],propagateUntilRepRefs:!0}))&&(i.setVisibility(!1),j.push(i)),(a=W.createIdPathOverride({idPathes:[new y([o])],propagateToParents:!0}))&&(a.setVisibility(!0),j.push(a)),n.forEach(function(e){(a=W.createIdPathOverride(e))&&(a.setVisibility(!0),j.push(a))})):(t&&t.length&&(a=W.createOverride({pathes:t})),e&&e.length&&(i=W.createOverride({pathes:e})),i&&(i.setVisibility(!1),j.push(i)),a&&(a.setVisibility(!0),j.push(a)))}},ye=function(e,t){var n=e.getLastElement(!0);if(b.getNodeID(n)===t)return e;for(var i=e.getChildrenPathes(),a=0;a<i.length;a++){var o=ye(i[a],t);if(o)return o}},Se=function(e,t){if(e.getNodeType&&"Mesh3D"===e.getNodeType())t.push(e);else for(var n=0;n<e.children.length;n++)Se(e.children[n],t)}}})}),define("DS/CAT3DAnnotationController/CAT3DAnnotationController",["UWA/Class","DS/CAT3DAnnotationController/CAT3DAnnotBaseControllerInstance"],function(e,t){"use strict";var n=[];return e.singleton({registerAnnotationController:function(e){e&&e.annotController&&e.context&&(this.unreferenceAnnotationController(e),n.push({context:e.context,annotController:e.annotController}))},giveAnnotationController:function(e){if(e&&e.context)for(var t=0;t<n.length;t++)if(n[t].context===e.context)return Object.freeze(n[t].annotController.getAnnotControllerPrototype())},getAnnotationController:function(e){var i=this.giveAnnotationController(e);if(!i&&e&&e.context){var a=new t({ctxViewer:e.context});n.push({context:e.context,annotController:a}),i=Object.freeze(n[n.length-1].annotController.getAnnotControllerPrototype())}return i},unreferenceAnnotationController:function(e){if(e&&e.context)for(var t=n.length-1;t>=0;t--)n[t].context===e.context&&(n[t].annotController&&n[t].annotController.clearController(),n.splice(t,1))}})});