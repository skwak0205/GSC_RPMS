var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};define("DS/SocialToolbar/Models/Token",["require","exports","DS/WAFData/WAFData","UWA/Class/Events"],function(t,e,n,o){"use strict";var i={method:"GET"};return function(){function t(t){var e=t.api,n=t.header,i=t.initialToken;this.token=null,this.tokenFetchInProgress=!1,this.eventManager=new o,this.tokenSetEvent="onTokenSet",this.api=e,this.tokenHeader=n,i&&this.setToken(i)}return t.prototype.fetchToken=function(){var t=this.api;return new Promise(function(e){n.authenticatedRequest(t,__assign(__assign({},i),{onComplete:function(t){var n=JSON.parse(t);e(n.csrfToken)}}))})},t.prototype.getToken=function(){var t=this;return this.token?Promise.resolve(this.token):this.tokenFetchInProgress?new Promise(function(e){t.eventManager.addEventOnce(t.tokenSetEvent,function(t){return e(t)})}):(this.tokenFetchInProgress=!0,this.fetchToken().then(function(e){return t.setToken(e),t.tokenFetchInProgress=!1,t.eventManager.dispatchEvent(t.tokenSetEvent,[e]),e}))},t.prototype.setToken=function(t){this.token=t},t.prototype.unsetToken=function(){this.token=null},t.prototype.getHeader=function(){return this.tokenHeader},t}()}),define("DS/SocialToolbar/Utils/SocialToolbarSharedOptions",["UWA/Core","UWA/Array","UWA/Promise","UWA/Class/Options","UWA/Class/Events"],function(t,e,n,o,i){"use strict";var s=i.extend(o,{_lastActiveEditor:null,loaded:!1,loadingFailure:!1,defaultOptions:{"3DSwymUrl":"","3DSwymServerToken":null,tenantId:null,userLogin:null,userName:"",userIsAdmin:!1,serviceUrl:""},init:function(t){this._parent.apply(this,arguments),t&&this.configure(t)},_removeEndingSlash:function(e){return t.is(e,"string")&&e.length>0&&"/"===e.charAt(e.length-1)?e.slice(0,e.length-1):e},_getUserInfo:function(){var t=this,e=n.deferred();return this.options.userLogin&&this.options.userName?(t.setOptions({userLogin:this.options.userLogin,userName:this.options.userName}),e.resolve()):require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(n){try{n.getUser({platformId:t.options.tenantId,onComplete:function(n){t.setOptions({userLogin:n.id,userName:n.firstname+" "+n.lastname,userIsAdmin:n.admin}),e.resolve()},onFailure:function(){e.reject("Error retrieving user information. Please make sure that the TopFrame is correctly configured and that 3DCompass is up and running.")}})}catch(t){e.reject("Error trying to call 3DCompass: "+t.message)}}),e.promise},_get3DSwymUrl:function(){var t=this,o=n.deferred();return this.options["3DSwymUrl"]?(t.setOption("3DSwymUrl",this.options["3DSwymUrl"]),o.resolve()):require(["DS/i3DXCompassServices/i3DXCompassServices"],function(n){try{n.getPlatformServices({onComplete:function(n){var i=t.getOption("tenantId");e.isArray(n)&&n.forEach(function(e){e.platformId===i&&t.setOption("3DSwymUrl",t._removeEndingSlash(e["3DSwym"]))}),o.resolve()},onFailure:function(){o.resolve()}})}catch(t){o.reject("Error trying to call 3DCompass: "+t.message)}}),o.promise},configure:function(t){if(!1===this.loaded){var e=this;if(delete this.options,this.loadingFailure=!1,t&&t.serviceUrl&&(t.serviceUrl=this._removeEndingSlash(t.serviceUrl)),this.setOptions(t),!this.options.tenantId)throw new Error("Tenant ID is required");if(!this.options.serviceUrl)throw new Error("Web service URL is required");n.all([this._getUserInfo(),this._get3DSwymUrl()]).then(function(){e.loaded=!0,e.loadingFailure=!1,e.dispatchEvent("onReady")},function(t){e.loadingFailure=!0,e.dispatchEvent("onError",[t])})}},getUserInfo:function(){return{login:this.options.userLogin,displayName:this.options.userName}},executeWhenReady:function(t,e){!0===this.loaded&&t.apply(this),!0===this.loadingFailure?e&&e.apply(this):(this.addEventOnce("onReady",function(){e&&this.removeEvent("onError",e),t.apply(this,arguments)}),this.addEventOnce("onError",function(){this.removeEvent("onReady",t),e&&e.apply(this,arguments)}))},setLastActiveEditor:function(t){this._lastActiveEditor=t},getLastActiveEditor:function(){return this._lastActiveEditor}});return s.MODE={NORMAL:"normal",LIGHT:"light"},s}),define("DS/SocialToolbar/Utils/Generic",["UWA/Core"],function(t){"use strict";return{debounce:function(t,e){if("function"==typeof t)return n=null,o=null,i=e||30,s=null,r=function(){t.apply(o,n)},function(){o=this,n=arguments,s&&clearTimeout(s),s=setTimeout(r,i)};throw new Error("First argument is supposed to be a function");var n,o,i,s,r}}}),define("DS/SocialToolbar/Utils/Media",["UWA/Core","UWA/String","DS/Logger/Logger"],function(t,e,n){"use strict";return{DEFAULT_MEDIA_SOURCE:"3dcomment",ANNOTATION_TYPE:"annotation",getMediaHtml:function(o){var i="",s=this;return o&&o.length>0&&(i=o.reduce(function(o,i){return i.file?s.isValidBlob(i.file)?i.type?"annotation"===i.type?s.isValidBlob(i.data.annotationFile)?(i.source="3dcomment",i.uri=null,i.file=URL.createObjectURL(i.file),i.data.annotationFile=URL.createObjectURL(i.data.annotationFile),o+='<img data-media-type="'+e.escapeHTML(i.type)+'" data-file="'+e.escapeHTML(i.file)+(i.relatedMediaUri?'" data-related-media-uri="'+e.escapeHTML(i.relatedMediaUri):"")+'" data-data="'+e.escapeHTML(JSON.stringify(i.data))+'" data-source="'+e.escapeHTML(i.source)+'"/>'):n.error("Please provide a Blob representation of the annotation data file"):n.error("Only an annotation type media can be currently uploaded in 3DComment"):n.error("A type needs to be specified for a media that will be uploaded in 3DComment"):n.error("Please provide a Blob representation of the file to be uploaded"):i.source?t.is(i.uri,"string")?o+='<img data-uri="'+e.escapeHTML(i.uri)+'" data-source="'+e.escapeHTML(i.source)+'"/>':n.error("Please provide a valid media URI"):n.error('Media "source" is missing'),o},"")),i="<div>"+i+"</div>"},isValidBlob:function(t){return t instanceof Blob||t.constructor&&t.constructor.name&&"blob"===t.constructor.name.toLowerCase()||t.size&&t.type},isValidBlobUrl:function(e){return t.is(e,"string")&&0===e.indexOf("blob")},getMediaData:function(e){var n,o=[];return e&&(n=t.createElement("div",{html:e}).getElements("img")).length>0&&(o=n.reduce(function(t,e){var n={uri:e.dataset.uri,source:e.dataset.source,mediaType:e.dataset.mediaType,relatedMediaUri:e.dataset.relatedMediaUri};return n.source&&(n.uri?t.push(n):"annotation"===n.mediaType&&(n.file=e.dataset.file,n.data=JSON.parse(e.dataset.data),t.push(n))),t},[])),o}}}),define("DS/SocialToolbar/Utils/MessageBus",["UWA/Core","UWA/Class/Events"],function(t,e){"use strict";return e.singleton({})}),define("DS/SocialToolbar/Mixins/CompositeUI",["UWA/Core","UWA/Utils","UWA/Array","DS/WebAppsFoundations/Views/Plugins/Set"],function(t,e,n,o){"use strict";var i=o.extend({_parentComponent:null,_stackItem:function(t,n){return t[n]||(t[n]=e.getUUID()),"function"==typeof t.setTopLevelComponent&&t.setTopLevelComponent(this._parentComponent.getTopLevelComponent()),this._parent.apply(this,arguments)},setup:function(t,e){if(!e||!e.parentComponent)throw new Error("Parent component is required!");this._parentComponent=e.parentComponent},addMap:function(e,n){var o;if(t.is(e,"object"))for(var i in e)e.hasOwnProperty(i)&&(o=this.get(i))&&e[i]!==o&&o.destroy();return this._parent.apply(this,arguments)},reset:function(e,n){var o=n?t.clone(n,!1):{};return!1!==o.hashMap&&(o.hashMap=!0),this._parent.call(this,e,o)},onRemove:function(e){try{t.is(e.isDestroyed,"function")&&e.isDestroyed()||e.destroy()}catch(t){}},onReset:function(e,n){var o,i;if(n&&n.previousItems&&n.previousItems.length>0)for(o=n.previousItems.length-1;o>=0;o--)i=n.previousItems[o],t.is(i.isDestroyed,"function")&&i.isDestroyed()||i.destroy()}});return{_rendered:!1,_destroyed:!1,_inPage:!1,_topLevelComponent:null,options:null,components:null,_createContent:function(){},className:function(){return this.getClassNames()},init:function(e){var n=e&&e.componentsOptions?t.clone(e.componentsOptions,!1):{};return n.parentComponent=this,e&&e.parentComponent&&this.setTopLevelComponent(e.parentComponent.getTopLevelComponent()),this.components=new i(null,n),this},_propagateInPageValueToInnerComponents:function(){this.components&&this.components.forEach(function(e){e.container&&t.is(e._inPage)&&e.dispatchEvent("onInPageChangeRequest",[this._inPage])},this)},render:function(){return this.dispatchEvent("onBeforeRender"),this.container.setContent(this._createContent()),this._rendered=!0,this._propagateInPageValueToInnerComponents(),this.dispatchEvent("onRender"),this},inject:function(){return this._rendered||this.render(),this},setTopLevelComponent:function(t){this._topLevelComponent=t,this.components&&this.components.forEach(function(t){"function"==typeof t.setTopLevelComponent&&t.setTopLevelComponent(this._topLevelComponent)},this)},getTopLevelComponent:function(){return this._topLevelComponent||this},isRendered:function(){return this._rendered},isDestroyed:function(){return this._destroyed},isInPage:function(){return this._inPage},onInPageChangeRequest:function(e){e!==this._inPage&&t.is(e,"boolean")&&(this._inPage=e,this._propagateInPageValueToInnerComponents())},onPostInject:function(){var t=!1;this.container&&document.body.contains(this.container)&&(t=!0),this.dispatchEvent("onInPageChangeRequest",[t])},onInjected:function(){this._inPage=!0},onRemoved:function(){this._inPage=!1},destroy:function(t){return(!0!==this._destroyed||t&&!0===t.force)&&(this._destroyed=!0,this.components.remove(this.components.toArray()),this.components.reset(null,{silent:!0}),this.components=null,this._topLevelComponent=null,this.container=null,this.tagName=null,this.className=null,this.attributes=null,this.domEvents=null,this.options=null),this}}}),define("DS/SocialToolbar/Controls/ResponsiveButtonTooltip",["UWA/Core","DS/UIKIT/Tooltip"],function(t,e){"use strict";return e.extend({defaultOptions:{btnMaxWidth:42},show:function(){if(this.getOption("target")&&this.getOption("target").getSize().width<=this.getOption("btnMaxWidth"))return this._parent.apply(this,arguments)}})}),define("DS/SocialToolbar/Utils/Sprite",["UWA/Core","UWA/Utils","UWA/Class","DS/WebappsUtils/WebappsUtils","DS/Logger/Logger"],function(t,e,n,o,i){"use strict";return n.singleton({_normalPictureSelector:'img[data-type="ENoPicture"]',_miniPictureSelector:'img[data-type="EMiPicture"]',_nonReloadedImagesSelector:'[data-status="NonReloaded"]',_reloadUserPicturesWithoutSprites:function(e){if(!e||!e.el)throw new Error("An HTMLElement is required if you want to reload user pictures");if(!e.swymUrl)return this;var n,o,i,s,r,a="",l=e.selector,c=e.el,d=e.format||"normal",u=t.extendElement(c).getElements(l),h=u.length;if(h>0)for(n=0;n<h;n++)i=(r=u[n]).getAttribute("data-login"),(s=e.clsOver||r.getAttribute("data-cls_over"))&&addClassOnOver(r,s),i&&(r.onload="",i&&(o=r.getAttribute("data-fingerprint")||"",i&&(a=["/api/user/getpicture/login/",i,"/format/",d,o?"/update/"+o:""].join("")),r.src=e.swymUrl+a,r.setAttribute("data-status","Reloaded")))},_reloadUserPicturesWithSprite:function(n){if(!n||!n.el)throw new Error("An HTMLElement is required if you want to reload user pictures");if(!n.swymUrl)return this;var o,i=n.selector,s=n.el,r=n.format||"normal",a=t.extendElement(s).getElements(i);if(1===a.length&&!0!==n.useSprite)return this._reloadUserPicturesWithoutSprites.call(this,n);if(a.length>0){var l,c,d,u,h,m,p,g,f,C,S,_,b,E,T,v,w=[];switch(r){default:case"normal":m=123,E=7;break;case"mini":m=34,E=6}if(u=h=m,n.spritesMaxLength)for(;o=a.length;)w.push(a.splice(0,n.spritesMaxLength));else w.push(a);for(T=0,b=w.length;T<b;T++){for(a=w[T],l=0,c=0,d="",v=n.swymUrl+"/api/media/streammediasprite/idList/",g=0,o=a.length;g<o;g++)C=(f=a[g]).getAttribute("data-login"),(_=n.clsOver||f.getAttribute("data-cls_over"))&&addClassOnOver(f,_),C&&(v+=(0===g?"":"=")+[C,E,6,h,u,"1"].join(":")),(S=f.getAttribute("data-fingerprint")||"")&&(d+=S);for(d&&(v+="/update/"+e.getCheckSum(d)),p="101% "+100*o+"%",g=0;g<o;g++)l+=c,(f=a[g]).getAttribute("data-login")&&f.set({onload:"","data-status":"Reloaded",styles:{display:"inline-block","background-image":'url("'+v+'")',"background-size":p,"background-position":"0px "+100*l/((o-1)*u)+"%"}}),c=u}}},_reloadUserPictures:function(t){switch(t||(t={}),"string"!=typeof t.format&&(t.format="normal"),t.format=t.format.toLowerCase(),t.format){default:case"normal":t.selector=this._normalPictureSelector;break;case"mini":t.selector=this._miniPictureSelector}return!1!==t.nonReloadedImagesOnly&&(t.selector=t.selector+this._nonReloadedImagesSelector),this._reloadUserPicturesWithSprite(t)},getUserPictureAttributes:function(t){if(t){var e,n,s;switch("string"!=typeof t.format&&(t.format="normal"),t.format=t.format.toLowerCase(),t.format){default:case"normal":e="ENoPicture",n="st-e-nopicture";break;case"mini":e="EMiPicture",n="st-e-mipicture"}return s=t.swymUrl?{"data-type":e,"data-model_name":"user",class:[n," ",t.cls||""].join(""),src:[o.getWebappsBaseUrl(),"SocialToolbar/assets/s.gif"].join(""),"data-status":"NonReloaded"}:{"data-type":e,"data-model_name":"user",class:[n," fonticon fonticon-user ",t.cls||""].join("")},t.title&&(s.title=t.title),t.login?s["data-login"]=t.login:i.warn("User login is required if you want to display his/her profile picture"),t.clsOver&&(s["data-cls_over"]=t.clsOver),t.imageFingerprint?s["data-fingerprint"]=t.imageFingerprint:s["data-fingerprint"]="",s}return{}},renderUserPicture:function(e){return t.createElement(e.swymUrl?"img":"span",this.getUserPictureAttributes(e))},reloadUserPictures:function(t){if(t||(t={}),!t.swymUrl)return this;t.format="normal",this._reloadUserPictures(t),t.format="mini",this._reloadUserPictures(t)}})}),define("DS/SocialToolbar/Utils/Date",["UWA/Core","DS/UWPClientCode/I18n","i18n!DS/SocialToolbar/assets/nls/utils/date"],function(t,e,n){"use strict";return{prettyDate:function(o){if(o){var i;if("string"==typeof o&&o.match(/(\/|&#x2F;)/g)&&(o=o.replace("-"," ").replace(/(\/|&#x2F;)/g,"-")),t.is(o,"number"))i=new Date(o+6e4*(new Date).getTimezoneOffset());else{var s=new Date(o);i=s.getTime()+6e4*s.getTimezoneOffset()}var r,a=new Date((new Date).valueOf()+6e4*(new Date).getTimezoneOffset()),l=i>a,c=(a.getTime()-i)/1e3;if(l&&(c=-c),r=Math.floor(c/86400),isNaN(r)||r<0)return n.justnow;if(r>=31){var d=new Date(i),u=d.getDate(),h=d.getMonth()+1;return[d.getFullYear(),"-",h=h<10?"0"+h:h,"-",u=u<10?"0"+u:u].join("")}return l?0===r&&c<60?n.justnow:"":0===r&&(c<60&&n.justnow||c<120&&n.oneminago||c<3600&&e.replace(n.minutesCountminsago,{minutesCount:Math.floor(c/60)})||c<7200&&n.onehrago||c<86400&&1===Math.floor(c/3600)&&n.onehrago||c<86400&&e.replace(n.hoursCounthrsago,{hoursCount:Math.floor(c/3600)}))||1==r&&n.yesterday||r<7&&e.replace(n.daysCountdaysago,{daysCount:r})||r<31&&1==Math.ceil(r/7)&&e.replace(n.weekCountweekago,{weeksCount:Math.ceil(r/7)})||r<31&&Math.ceil(r/7)>1&&e.replace(n.weeksCountweekago,{weeksCount:Math.ceil(r/7)})}return n.justnow}}}),define("DS/SocialToolbar/Mixins/Commentable",["UWA/Core"],function(t){"use strict";return{_comments:null,_commenters:null,COMMENTS_ATTRIBUTE:"comments",COMMENTS_COUNT_ATTRIBUTE:"nbComments",CommentCollection:null,defaults:{comments:null},_onCommentsChange:function(t,e){this._comments&&this.setComments(e)},_onNbCommentsChange:function(t,e){this._comments&&!this._comments.hasBeenFetched()&&this._comments.setTotalRecords(this.getCommentsTotalCount())},setComments:function(t){this.getComments().reset(t)},getComments:function(){return this._comments||(this._comments=new this.CommentCollection(this.get("comments"),{target:this,targetInteractionCountAttr:this.COMMENTS_COUNT_ATTRIBUTE,subject:t.is(this.getSubject,"function")?this.getSubject():this})),this._comments},getCommentsTotalCount:function(){return this.get(this.COMMENTS_COUNT_ATTRIBUTE)},getCommenters:function(){var t=this.getComments();return this._commenters?this._commenters.add(t.getAuthorArray()):this._commenters=t.getAuthors(),this._commenters},init:function(t){var e={};this._parent.apply(this,arguments),e["onChange:"+this.COMMENTS_ATTRIBUTE]=this._onCommentsChange,e["onChange:"+this.COMMENTS_COUNT_ATTRIBUTE]=this._onNbCommentsChange,this.addEvents(e)},clean:function(){return this._comments&&(this._comments.clean(),this._comments=null),this._commenters&&(this._commenters.clean(),this._commenters=null),this._parent.apply(this,arguments)}}}),define("DS/SocialToolbar/Views/BaseView",["UWA/Core","UWA/Class/View","DS/SocialToolbar/Mixins/CompositeUI"],function(t,e,n){"use strict";return e.extend(n,{init:function(){this._parent.apply(this,arguments),this._previous.apply(this,arguments)},render:function(){return this._previous.apply(this,arguments)},inject:function(){return this._parent.apply(this,arguments),this._previous.apply(this,arguments),this},onInjected:function(){this._parent.apply(this,arguments),this._previous.apply(this,arguments)},destroy:function(){return!0!==this._destroyed&&(this._destroyed=!0,this.dispatchEvent("onDestroy",[this]),this.model=null,this.collection=null,this._parent.apply(this,arguments),this._previous.call(this,{force:!0}),this.stopListening()),this}})}),define("DS/SocialToolbar/Views/BaseCollectionView",["UWA/Core","DS/WebAppsFoundations/Views/CollectionView","DS/SocialToolbar/Mixins/CompositeUI"],function(t,e,n){"use strict";return e.extend(n,{init:function(){this._parent.apply(this,arguments),this._previous.apply(this,arguments)},buildItemView:function(t,e){return new e({model:t,parentComponent:this})},render:function(){return this._parent.apply(this,arguments)},inject:function(){return this._parent.apply(this,arguments),this._previous.apply(this,arguments),this},onInjected:function(){this._parent.apply(this,arguments),this._previous.apply(this,arguments)},destroy:function(){return!0!==this._destroyed&&(this.dispatchEvent("onDestroy",[this]),this._parent.apply(this,arguments),this._previous.apply(this,arguments),this.stopListening()),this}})}),define("DS/SocialToolbar/Utils/TokenManager",["require","exports","DS/SocialToolbar/Models/Token"],function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getToken=e.addToken=void 0;var o="commentproxy/session/info",i=new Map;e.addToken=function(t){var e=t.serviceUrl,s=t.header,r=t.value;if(e&&s){var a=e.endsWith("/")?e:e+"/",l=a+o;i.has(a)||i.set(a,new n({api:l,header:s,initialToken:r}))}else{if(!e)throw new Error("comment proxy serviceUrl is missing!");if(!s)throw new Error("comment proxy token header is missing!")}},e.getToken=function(t){return i.get(t)}}),define("DS/SocialToolbar/Models/Data",["require","exports","DS/WAFData/WAFData","DS/SocialToolbar/Utils/TokenManager"],function(t,e,n,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.request=e.ERROR_CODE_CSRF_KO=e.REQUEST_TYPE_JSON=e.HTTP_POST=e.HTTP_GET=void 0,e.HTTP_GET="GET",e.HTTP_POST="POST",e.REQUEST_TYPE_JSON="json",e.ERROR_CODE_CSRF_KO="ERROR_ACCESS_FORBIDDEN_CSRF_KO",e.request=function t(i,s){var r=i.substr(0,i.indexOf("/commentproxy/")+1),a=o.getToken(r);if(!a)return n.authenticatedRequest(i,s);a.getToken().then(function(o){(s=s||{}).headers=s.headers||{},s.headers[a.getHeader()]=o;var r=s.onFailure;return s.onFailure=function(n,o,l){o&&o.errorcode&&o.errorcode===e.ERROR_CODE_CSRF_KO?(a.unsetToken(),t(i,s)):r&&r(n,o,l)},n.authenticatedRequest(i,s)})}}),define("DS/SocialToolbar/Models/BaseModel",["UWA/Core","UWA/Json","UWA/Utils","UWA/Class/Model","DS/Logger/Logger","DS/WAFData/WAFData","DS/SocialToolbar/Utils/TokenManager"],function(t,e,n,o,i,s,r){"use strict";function a(t){return t.contains("?")?t.endsWith("?")?"":"&":"?"}return o.extend({_getResponseHeader:function(e,n){var o=null,i=e.request;return t.is(i&&i.getResponseHeader,"function")?o=i.getResponseHeader(n):t.is(i&&i.xhr&&i.xhr.getResponseHeader,"function")?o=i.xhr.getResponseHeader(n):e.responseHeaders&&(o=e.responseHeaders[n]),o},sync:function(o,l,c){var d,u,h,m,p,g,f=this,C=c||{},S=this._parent.bind(this),_=C.onComplete,b=C.onFailure,E=t.is(this.getSubject,"function")?this.getSubject():this,T=t.is(E.getSharedOptions,"function")?E.getSharedOptions().getOption("appForcedLinkUri"):null;return C.ajax=s.authenticatedRequest,C.headers=C.headers||{},t.is(C.data,"object")&&("read"===o||C.method&&"get"===C.method.toLowerCase())?(C.url+=a(C.url)+n.toQueryString(C.data),C.data=null):(!C.headers["Content-Type"]&!C.dataType||"json"===C.dataType)&&(C.headers["Content-Type"]="application/json;charset=utf-8"),"json"===C.dataType&&o&&"get"!==o.toLowerCase()&&(C.data=e.encode(C.data)),!T||C.method&&"get"===C.method.toLowerCase()||(t.is(C.attrs,"object")||(C.attrs=this.toJSON()),C.attrs.appForcedLinkUri=T),C.headers["X-Requested-With"]||(C.headers["X-Requested-With"]="XMLHttpRequest"),C.url||(C.url=(p="url",g=void 0,(m=l)&&(g=m[p],t.is(g,"function")&&(g=g.call(m))),g)),C.url&&-1===C.url.indexOf("tenant=")&&(t.is(E.getSharedOptions,"function")?C.url+=a(C.url)+"tenant="+E.getSharedOptions().getOption("tenantId"):i.warn("Tenant Id is missing")),u=C.url.substr(0,C.url.indexOf("/commentproxy/")+1),h=r.getToken(u),_&&(C.onComplete=((n,o)=>{var i=t.is(n,"string")?e.decode(n):n;const s=t.is(i&&i.result)?i.result:i;return s instanceof Object&&!Object.isFrozen(s)&&(s.metas=s.metas||{},s.metas["X-3DComment-Has-Moderation-Rights"]=this._getResponseHeader(C,"x-3dcomment-has-moderation-rights")),_.call(this,s,C)})),h?h.getToken().then(n=>{C.onFailure=function(n,i,s){if(n&&n.errorcode&&"ERROR_ACCESS_FORBIDDEN_CSRF_KO"===n.errorcode)h.unsetToken(),f.sync(o,l,C);else if(b){var r=t.is(i,"string")?e.decode(i):i;return b.call(this,n,t.is(r&&r.result)?r.result:r,s)}},C.headers[h.getHeader()]=n,d=S(o,l,C)}):(b&&(C.onFailure=function(n,o,i){var s=t.is(o,"string")?e.decode(o):o;return b.call(this,n,t.is(s&&s.result)?s.result:s,i)}),d=S(o,l,C)),d}})}),define("DS/SocialToolbar/Collections/BaseCollection",["UWA/Core","UWA/Json","DS/WebAppsFoundations/Collections/PageableCollection","UWA/Class/Model","DS/SocialToolbar/Models/BaseModel","DS/SocialToolbar/Utils/Generic"],function(t,e,n,o,i,s){"use strict";return n.extend({_mainRangeName:null,_stateModel:null,_fetched:!1,_beingFetched:!1,ranges:null,defaultOptions:{stateParseMode:"headers",state:{baseOffset:0,firstPage:0,currentPage:0},queryParams:{currentPage:"page_number",pageSize:"page_size"}},_executePostInitInstructions:function(){var t=this,e=s.debounce(function(){var e=[];arguments.length>=2&&(e=[].concat(arguments).slice(arguments.length-2)),t.dispatchEvent("onCollectionChange",e)});this.addEventOnce("onSync",function(t){t===this&&(this._fetched=!0)}),this.addEvents({onAdd:e,onRemove:e,onSort:e,onReset:e,onRequest:function(t){this===t&&(this._beingFetched=!0)},onSync:function(t){this===t&&(this._beingFetched=!1)},onError:function(t){this===t&&(this._beingFetched=!1)}})},_computeTotalPages:function(t,e){return this.state&&this.state.baseOffset>0&&t>=this.state.baseOffset?Math.ceil((t-this.state.baseOffset)/e):this._parent.apply(this,arguments)},_getPageValueConsistentWithCurrentState:function(e){e||(e={});var n=this.state||{},o=t.is(e.totalRecords,"number")?e.totalRecords:n.totalRecords,i=t.is(e.collectionSize,"number")?e.collectionSize:this.length;return this._computeTotalPages(o,n.pageSize)?Math.max(n.firstPage,Math.ceil((i-this.state.baseOffset)/n.pageSize)-(0===n.firstPage?1:0)):n.firstPage},_updateCurrentPageState:function(){this.state=this._checkState(t.extend(this.state||{},{currentPage:this._getPageValueConsistentWithCurrentState()}))},_updateStateModel:function(){this._stateModel||(this._stateModel=new o,this.listenTo(this._stateModel,{onAnyEvent:function(t,e,n,o){this.dispatchEvent(t+"State",[e,n,o])}})),this._stateModel.set(this.state)},_checkState:function(){var t=this._parent.apply(this,arguments);return setTimeout(this._updateStateModel,0),t},_getResponseHeader:function(e,n){var o=null;return t.is(e.request&&e.request.getResponseHeader,"function")?o=e.request.getResponseHeader(n):e.responseHeaders&&(o=e.responseHeaders[n]),o},init:function(){this.ranges={},this._updateStateModel=this._updateStateModel.bind(this),this._parent.apply(this,arguments),this._executePostInitInstructions()},parseRanges:function(t,e){return{}},parseHeadersForStateUpdate:function(e,n,o,i){return t.extend(this.ranges,this.parseRanges(e,i)),{}},setTotalRecords:function(e,n){return this.state=this._checkState(t.merge({totalRecords:e,currentPage:this._getPageValueConsistentWithCurrentState({totalRecords:e,collectionSize:n&&n.collectionSize})},this.state)),this._updateStateModel(),this},getTotalRecords:function(){return this.state.totalRecords},sync:function(t,e,n){return i.prototype.sync.apply(this,arguments)},hasBeenFetched:function(){return this._fetched},isBeingFetched:function(){return this._beingFetched},onAdd:function(){this._updateCurrentPageState()},onRemove:function(){this._updateCurrentPageState()},onReset:function(){this._updateCurrentPageState()},onCollectionChange:function(t,e){this._beingFetched||this.state.totalRecords&&!(this.length>this.state.totalRecords)||this.setTotalRecords(this.length)},clean:function(){this.reset([])}})}),define("DS/SocialToolbar/Models/Media",["UWA/Core","UWA/Promise","DS/SocialToolbar/Models/BaseModel","DS/SocialToolbar/Utils/Media"],function(t,e,n,o){"use strict";return n.extend({name:"media",defaults:{uri:null,source:null,mediaType:null,thumbnailUrl:"",redirectionUrl:"",relatedMediaUri:null},idAttribute:"uri",init:function(){this._parent.apply(this,arguments)}})}),define("DS/SocialToolbar/Views/MediaView",["UWA/Core","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Utils/Media","DS/WebappsUtils/WebappsUtils","DS/Logger/Logger"],function(t,e,n,o,i){"use strict";return e.extend({name:"st-media",_editMode:!1,domEvents:{"click span.fonticon-cancel":"_onRemove"},defaultOptions:{editMode:!1},init:function(e){if(this._parent.apply(this,arguments),t.is(this.getOption("editMode"),"boolean")&&(this._editMode=this.getOption("editMode")),!this.model)throw new Error("Media model is missing");return this.listenTo(this.model,"onChange:thumbnailUrl",this._updateImageBg),this},_updateImageBg:function(){this.elements.imgTag&&this.model&&this.model.get("thumbnailUrl")&&this.elements.imgTag.setStyle("background-image","url("+this.model.get("thumbnailUrl")+")")},_createContent:function(){var e,i,s=this.model;return s.get("thumbnailUrl")?e=s.get("thumbnailUrl"):s.get("mediaType")===n.ANNOTATION_TYPE&&s.get("thumbnailFile")?(i=s.get("thumbnailFile"),n.isValidBlobUrl(i)&&(e=i)):e=o.getWebappsBaseUrl()+"SocialToolbar/assets/thumb.png",this.elements.imgTag=t.createElement("img",{src:e,"data-source":s.get("source"),"data-uri":s.get("uri")}),s.get("relatedMediaUri")&&(this.elements.imgTag.dataset.relatedMediaUri=s.get("relatedMediaUri")),[this.elements.imgTag,this._editMode?this.getRemoveIcon():""]},getRemoveIcon:function(){return{tag:"span",class:"fonticon fonticon-cancel"}},_onRemove:function(){var t=this.model;t&&t.collection&&(this.dispatchEvent("onMediaRemoval",[t]),t.collection.remove(t))},onRender:function(){this._parent.apply(this,arguments);var t=this,e=this.model,o=e.get("source");e.get("thumbnailUrl")||e.get("source")!==n.DEFAULT_MEDIA_SOURCE&&require(["DS/SocialToolbarCustomization/script/source/"+o],function(n){t.isDestroyed()||n.getThumbnailUrlFromContentUri({contentUri:e.get("uri"),callback:function(t){e.set("thumbnailUrl",t)}})},function(){i.error("No customization module for media from source:",o)})}})}),define("DS/SocialToolbar/Models/User",["UWA/Core","DS/SocialToolbar/Models/BaseModel"],function(t,e){"use strict";return e.extend({name:"user",defaults:{login:null,displayName:""},idAttribute:"login",getFullName:function(){return this.get("firstName")&&this.get("lastName")?this.get("firstName")+" "+this.get("lastName"):this.get("displayName")||""}})}),define("DS/SocialToolbar/Models/Interaction",["UWA/Core","DS/SocialToolbar/Models/BaseModel","DS/SocialToolbar/Models/User"],function(t,e,n){"use strict";return e.extend({defaults:{},_author:null,_subject:null,_target:null,init:function(t,e){return this._parent.apply(this,arguments),e&&(e.subject&&(this._subject=e.subject),e.target&&(this._target=e.target)),this},setAuthor:function(t){this.getAuthor().set(t)},getAuthor:function(){return this._author||(this._author=new n(this.get("author"))),this._author},getSubject:function(){return this.collection?this.collection.getSubject():this._subject},getTarget:function(){return this.collection?this.collection.getTarget():this._target},"onChange:author":function(t,e){this.setAuthor(e)}})}),define("DS/SocialToolbar/Models/Endorsement",["UWA/Core","DS/SocialToolbar/Models/Interaction"],function(t,e){"use strict";return e.extend({name:"endorsement",idAttribute:"endorseUri",urlRoot:function(){return this.getTarget().url()+"/endorses"},url:function(){return this.isNew()?this.urlRoot()+"/me":this._parent.apply(this,arguments)}})}),define("DS/SocialToolbar/Collections/UserCollection",["UWA/Core","DS/SocialToolbar/Collections/BaseCollection","DS/SocialToolbar/Models/User"],function(t,e,n){"use strict";return e.extend({model:n,name:"user-collection",onAdd:function(t,e){return this._beingFetched||this.state.totalRecords&&!(this.length>this.state.totalRecords)||this.setTotalRecords(this.length),this._parent.apply(this,arguments)}})}),define("DS/SocialToolbar/Collections/InteractorCollection",["UWA/Core","DS/SocialToolbar/Collections/UserCollection"],function(t,e){"use strict";return e.extend({_subject:null,_interactions:null,name:"interactor-collection",init:function(t,e){return e&&(e.subject&&(this._subject=e.subject),e.interactions&&(this._interactions=e.interactions)),this._parent.apply(this,arguments)},getSubject:function(){return this._subject||this._interactions&&this._interactions.getSubject()},getTarget:function(){return this._interactions&&this._interactions.getTarget()||this.getSubject()},getInteractions:function(){return this._interactions},changeTotalRecordsBy:function(t){this.setTotalRecords((this.state.totalRecords||0)+t)}})}),define("DS/SocialToolbar/Collections/InteractionCollection",["UWA/Core","DS/SocialToolbar/Collections/BaseCollection","DS/SocialToolbar/Collections/UserCollection"],function(t,e,n){"use strict";return e.extend({_authors:null,_subject:null,_target:null,_targetInteractionCountAttr:null,AuthorCollection:n,defaultOptions:{state:{pageSize:10,order:1}},_updateAuthorList:function(){return this._authors?this._authors.add(this.getAuthorArray()):this._authors=new this.AuthorCollection(this.getAuthorArray(),{interactions:this}),this._authors},init:function(t,e){if(this._parent.apply(this,arguments),!e||!e.subject)throw new Error("A subject is required when initializing this collection");if(this._subject=e.subject,!e.target)throw new Error("The target of the interaction is required when initializing this collection");if(this._target=e.target,!e.targetInteractionCountAttr)throw new Error("The target attribute which contains the interaction count is required when initializing this collection");return this._targetInteractionCountAttr=e.targetInteractionCountAttr,this.setTotalRecords(this._target.get(this._targetInteractionCountAttr)),this},getAuthorArray:function(){return this.pluck("author")},getAuthors:function(){return this._authors||(this._authors=this._updateAuthorList()),this._authors},getSubject:function(){return this._subject},getTarget:function(){return this._target},changeTotalRecordsBy:function(t){var e,n=this._target;this.hasBeenFetched()?this.setTotalRecords((this.state.totalRecords||0)+t,{collectionSize:this.length+t}):(e=parseInt(n.get(this._targetInteractionCountAttr),10))+t>=0&&this.setTotalRecords(e+t,{collectionSize:this.length+t})},onCollectionChange:function(){this._parent.apply(this,arguments),this._updateAuthorList()},"onChange:totalRecordsState":function(t,e){(e=parseInt(e,10))>=0&&this._target.set(this._targetInteractionCountAttr,e)},clean:function(){return this._authors=null,this._parent.apply(this,arguments)}})}),define("DS/SocialToolbar/Collections/EndorserCollection",["UWA/Core","DS/SocialToolbar/Collections/InteractorCollection"],function(t,e){"use strict";return e.extend({name:"endorser-collection",url:function(){return this.getTarget().url()+"/endorses/users"}})}),define("DS/SocialToolbar/Views/AnnotationView",["UWA/Core","UWA/Promise","DS/SocialToolbar/Views/MediaView","DS/UIKIT/Spinner"],function(t,e,n,o){"use strict";return n.extend({className:function(){return this._parent()+(this.isClickable()?" clickable":"")},isClickable:function(){return!this.getOption("editMode")},domEvents:{"click img":"onAnnotationThumbnailClick","click span.fonticon-trash":"_onRemove"},getRemoveIcon:function(){return{tag:"span",class:"fonticon fonticon-trash"}},_onRemove:function(){this.model.deleteAnnotation(),this._parent.apply(this,arguments)},onAnnotationThumbnailClick:function(t){this.isClickable()&&t&&!t.data&&(t.data={view:this})},getDataOnClick:function(){var t=this.model,n=t.get("relatedMediaUri"),i=new o({className:"downloading-spinner"});return i.inject(this.container).show(),e.all([t.getAnnotationFile(),t.getThumbnailFile()]).then(function(t){var e=t[0],o=t[1];return i.remove().destroy(),{type:"annotation",file:o,relatedMediaUri:n,data:{annotationFile:e}}})}})}),define("DS/SocialToolbar/Models/Annotation",["UWA/Core","UWA/Promise","UWA/String","DS/SocialToolbar/Models/Media","DS/SocialToolbar/Utils/Media","DS/WAFData/WAFData"],function(t,e,n,o,i,s){"use strict";var r=function(t){return window.fetch?window.fetch(t).then(function(t){return t.blob()}):new e(function(e,n){var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="blob",o.onload=function(t){200===this.status?e(this.response):n(this.response)},o.send()})},a=function(t){return new e(function(e,n){s.authenticatedRequest(t,{method:"GET",responseType:"blob",onComplete:function(t){e(t)},onFailure:function(){n("Error downloading annotation file")},onTimeout:function(){n("Time out while trying to download annotation file")}})})};return o.extend({name:"annotation",_subject:null,defaults:{thumbnailFile:null,annotationFile:null},upload:function(){var t={},n=this;return r(n.get("annotationFile")).then(function(e){t.annotationFile=e}).then(function(){return r(n.get("thumbnailFile")).then(function(e){t.thumbnailFile=e})}).then(function(){return new e(function(e,o){n.save({},{url:n.getUploadUrl(),data:function(){var e=new FormData;if("image/png"===t.thumbnailFile.type)e.append("altFile",t.thumbnailFile,"annotation_thumbnail.png");else{if("image/jpeg"!==t.thumbnailFile.type)throw new Error("The annotation thumbnail can only be a png or jpg");e.append("altFile",t.thumbnailFile,"annotation_thumbnail.jpg")}return e.append("userFile",t.annotationFile,"annotation.3dplayannotation"),e}(),dataType:"formData",onComplete:function(t,o){n.onUpload(t,o),e()},onFailure:function(){o()}})})})},init:function(t,e){if(!e||!e.subject)throw new Error("Subject URI is needed for an annotation");if(this._preprocessAttributes(t),this._parent.apply(this,arguments),this._subject=e.subject,this.isNew()){if(!this.get("thumbnailFile")||!this.get("annotationFile"))throw new Error("For a new annotation, the thumbnail and annotation file need to be provided")}else this.set("thumbnailUrl",this.getAnnotationThumbnailURL())},_preprocessAttributes:function(t){if(!t)throw new Error("Cannot create an empty annotation");i.isValidBlobUrl(t.file)&&(t.thumbnailFile=t.file,delete t.file),t.data&&i.isValidBlobUrl(t.data.annotationFile)&&(t.annotationFile=t.data.annotationFile,delete t.data.annotationFile)},getSubject:function(){return this._subject},urlRoot:function(){return this.getSubject().url()+"/media"},getUploadUrl:function(){return this.urlRoot()},getDeleteUrl:function(){return this.urlRoot()+"/"+this.get("uri")},getAnnotationThumbnailURL:function(){var t=this.get("uri");if(t)return this.urlRoot()+"/"+t+"/type/thumb/key/original";throw new Error("Annotation URI is needed for generating its thumbnail URL")},getAnnotationURL:function(){var t=this.get("uri");if(t)return this.urlRoot()+"/"+t+"/type/original";throw new Error("Annotation URI is needed for generating its URL")},onUpload:function(t,e){this.set("uri",e.mediaUri),this.set("thumbnailUrl",this.getAnnotationThumbnailURL())},deleteAnnotation:function(){var t=this;return this.isNew()?e.resolve():new e(function(e,n){t.destroy({url:t.getDeleteUrl(),onComplete:e,onFailure:n})})},getAnnotationFile:function(){var t;return t=this.isNew()?this.get("annotationFile"):this.getAnnotationURL(),a(t)},getThumbnailFile:function(){var t;return t=this.isNew()?this.get("thumbnailFile"):this.getAnnotationThumbnailURL(),a(t)},getHtml:function(){var t=this.get("relatedMediaUri");return this.isNew()?'<img data-media-type="'+n.escapeHTML(this.get("mediaType"))+'" data-file="'+n.escapeHTML(this.get("thumbnailFile"))+'" data-data="'+n.escapeHTML(JSON.stringify({annotationFile:this.get("annotationFile")}))+'"'+(t?'" data-related-media-uri="'+t:"")+' data-source="'+this.get("source")+'"/>':'<img data-uri="'+this.get("uri")+'" data-media-type="'+this.get("mediaType")+(t?'" data-related-media-uri="'+t:"")+'" data-source="'+this.get("source")+'" />'}})}),define("DS/SocialToolbar/Mixins/InlineEditor",["UWA/Core","DS/SocialToolbar/Utils/Generic"],function(t,e){"use strict";return{CKEDITOR_TOOLBAR_HEIGHT:42,CKEDITOR_TOOLBAR_EDITOR_PADDING:10,CKEDITOR_TOOLBAR_HEIGHT_WITH_PADDING:52,_onKeyUp:e.debounce(function(t){var e=t.ctrlKey||t.metaKey;if((16===t.keyCode||17===t.keyCode||t.shiftKey||e)&&window.getSelection().toString().length>0)return this._displayContextualToolbarForTextSelection(),this;this._hideRTEToolbar()},250),_onWindowMouseUp:function(e){document.body.removeEvent("mouseup",this._onWindowMouseUpBound);var n=window.getSelection();n.toString().length>0||n.rangeCount>0&&(!e||!t.extendElement(e.target).match("img"))?setTimeout(this._displayContextualToolbarForTextSelection.bind(this),0):this._hideRTEToolbar()},_onMouseDown:function(){this._onWindowMouseUpBound||(this._onWindowMouseUpBound=this._onWindowMouseUp.bind(this)),t.extendElement(document.body).addEvent("mouseup",this._onWindowMouseUpBound),this._hideRTEToolbar()},_getTextAreaId:function(){throw new Error("This method is meant to be overridden")},_getEditorToolbarIdSelector:function(){return"#cke_"+this._getTextAreaId()},_hideRTEToolbar:function(){t.extendElement(document.body);var e=document.body.getElement(this._getEditorToolbarIdSelector());e&&e.addClassName("hidden")},_showRTEToolbar:function(){t.extendElement(document.body);var e=document.body.getElement(this._getEditorToolbarIdSelector());e&&e.hasClassName("hidden")&&e.removeClassName("hidden")},_positionRTEToolbar:function(e,n){t.extendElement(document.body);var o=document.body.getElement(this._getEditorToolbarIdSelector());o&&(o.style.setProperty("top",e+"px","important"),o.style.setProperty("left",n+"px","important"),o.setStyle("position","absolute"))},_displayContextualToolbarForTextSelection:function(){var e,n,o,i,s,r;t.extendElement(document.body);var a=window.getSelection(),l=a.toString();if(l.length>0||a.rangeCount>0){if(e=a.getRangeAt(0),l.length<=0&&a.rangeCount>0){var c=e.cloneContents(),d=document.createElement("div");if(d.appendChild(c),d.innerHTML.length<=0)return}o=(n=e.getBoundingClientRect()).top,i=n.bottom,s=n.left,r=o>52?o-52:document.body.getSize().height-i>42?i+10:10,this._positionRTEToolbar(r,s),this._showRTEToolbar()}}}}),define("DS/SocialToolbar/Views/MediaListView",["UWA/Core","DS/SocialToolbar/Views/BaseCollectionView","DS/SocialToolbar/Views/MediaView","DS/SocialToolbar/Views/AnnotationView","DS/SocialToolbar/Utils/Media"],function(t,e,n,o,i){"use strict";return e.extend({_ItemView:n,name:"st-media-list",domEvents:{},defaultOptions:{mediaViewsOptions:null},getItemView:function(t){var e={};return this.options&&this.options.mediaViewsOptions&&(e.defaultOptions=this.options.mediaViewsOptions),t&&t.get("source")===i.DEFAULT_MEDIA_SOURCE&&t.get("mediaType")===i.ANNOTATION_TYPE?o.extend(e):n.extend(e)},init:function(t){if(t&&t.mediaViewsOptions&&(this._ItemView=n.extend({defaultOptions:t.mediaViewsOptions})),this._parent.apply(this,arguments),!this.collection)throw new Error("Collection is required");this.listenTo(this.children,{onMediaRemoval:function(t){this.dispatchEvent("onMediaRemoval",[t])}})}})}),define("DS/SocialToolbar/Models/Contributions",["UWA/Core","DS/SocialToolbar/Models/BaseModel"],function(t,e){"use strict";return e.extend({name:"contributions",idAttribute:"subjectUri",defaults:{subjectUri:null,currentUserEndorse:null,nbEndorses:null,nbReplies:null,comments:null,metas:null},parse:function(e,n){var o;return e||(e={}),e.metas||(e.metas={}),t.is(e.metas["X-3DComment-Has-Moderation-Rights"])||(o=this._getResponseHeader(n,"X-3DComment-Has-Moderation-Rights"),t.is(o)&&(e.metas["X-3DComment-Has-Moderation-Rights"]=o)),e}})}),define("DS/SocialToolbar/Views/InteractorView",["UWA/Core","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Utils/Sprite"],function(t,e,n){"use strict";return e.extend({name:"st-interactor",getClassNames:function(){return this._parent.apply(this,arguments)+" col-xs-12 col-sm-6"},domEvents:{},_renderUserPicture:function(){var t=this.model,e=this.model.collection;return n.renderUserPicture({cls:"st-user-picture",format:"normal",login:t.get("login"),swymUrl:e?e.getSubject().getSharedOptions().getOption("3DSwymUrl"):""})},_createContent:function(){var t=this.model;return[this._renderUserPicture(),{class:"st-user-info",html:[{html:[{tag:"span",class:"st-fake-link","data-login":t.get("login"),html:t.getFullName()}]}]}]}})}),define("DS/SocialToolbar/Views/InteractorListView",["UWA/Core","DS/SocialToolbar/Views/BaseCollectionView","DS/SocialToolbar/Views/InteractorView","DS/SocialToolbar/Utils/Sprite"],function(t,e,n,o){"use strict";return e.extend({_ItemView:n,name:"st-interactor-list",domEvents:{},init:function(){if(this._parent.apply(this,arguments),!this.collection)throw new Error("Collection is required");this.listenTo(this.collection,{onCollectionChange:function(){o.reloadUserPictures({el:this.container,swymUrl:this.collection.getSubject().getSharedOptions().getOption("3DSwymUrl")})}})},onRender:function(){o.reloadUserPictures({el:this.container,swymUrl:this.collection.getSubject().getSharedOptions().getOption("3DSwymUrl")})}})}),define("DS/SocialToolbar/Collections/CommenterCollection",["UWA/Core","DS/SocialToolbar/Collections/InteractorCollection"],function(t,e){"use strict";return e.extend({name:"commenter-collection",url:function(){return this.getTarget().url()+"/comments/users"},parseState:function(e,n,o,i){var s=this._parent.apply(this,arguments);return!t.is(s&&s.totalRecords)&&o&&o.pageSize>0&&e&&e.length===o.pageSize&&(s||(s={}),s.totalRecords=this.length+e.length+1),s}})}),define("DS/SocialToolbar/Collections/EndorsementCollection",["UWA/Core","DS/SocialToolbar/Collections/InteractionCollection","DS/SocialToolbar/Collections/EndorserCollection","DS/SocialToolbar/Models/Endorsement"],function(t,e,n,o){"use strict";return e.extend({_mainRangeName:"endorses",name:"endorsement-collection",model:o,url:o.prototype.urlRoot,AuthorCollection:n})}),define("DS/SocialToolbar/Mixins/Endorsable",["UWA/Core","DS/SocialToolbar/Collections/EndorsementCollection","DS/SocialToolbar/Collections/EndorserCollection","DS/SocialToolbar/Models/Endorsement"],function(t,e,n,o){"use strict";return{_endorsements:null,_endorsers:null,ENDORSEMENT_COUNT_ATTRIBUTE:"nbEndorses",defaults:{endorsements:null},_getUserInfo:function(){return(t.is(this.getSubject,"function")?this.getSubject():this).getSharedOptions().getUserInfo()},_updateTotalRecordsIfNotfetched:function(t,e){t&&!t.hasBeenFetched()&&t.setTotalRecords(e)},setEndorsements:function(t){this.getEndorsements().reset(t)},getEndorsements:function(){return this._endorsements||(this._endorsements=new e(this.get("endorsements"),{target:this,targetInteractionCountAttr:this.ENDORSEMENT_COUNT_ATTRIBUTE,subject:t.is(this.getSubject,"function")?this.getSubject():this})),this._endorsements},getEndorsers:function(){var t=this.getEndorsements();return this._endorsers?this._endorsers.add(t.getAuthorArray()):this._endorsers=t.getAuthors(),this._updateTotalRecordsIfNotfetched(this._endorsers,this.getEndorsementsTotalCount()),this._endorsers},getUserEndorseId:function(){return this.get("currentUserEndorse")&&this.get("currentUserEndorse").endorseUri||"me"},getEndorsementsTotalCount:function(){return this.get(this.ENDORSEMENT_COUNT_ATTRIBUTE)},endorse:function(t){var e,n=this,o=null,i=this.getEndorsements(),s=this.getEndorsers();this.isEndorsed()||(this.dispatchEvent("onBeforeEndorse",[this]),this.set("_endorsedByCurrentUser",!0),i.changeTotalRecordsBy(1),e=this._getUserInfo(),s.add(e),o=i.create({author:e},{at:0,onComplete:function(){n.set("currentUserEndorse",o.toJSON()),n.dispatchEvent("onAfterEndorse",[this]),n.dispatchEvent("onEndorseSuccess",n)},onFailure:function(){i.changeTotalRecordsBy(-1),i.remove(o),s.remove(e.login),n.set({_endorsedByCurrentUser:!1,currentUserEndorse:null}),n.dispatchEvent("onAfterEndorse",[this]),require(["DS/UWPClientControls/PlatformNotify"],function(e){e.error(t)})}}))},unendorse:function(e){var n,i=-1,s=this,r=null,a=this.getEndorsements(),l=this.getEndorsers(),c=this.isEndorsed(),d=t.is(this.getSubject,"function")?this.getSubject():this,u=d.getSharedOptions().getUserInfo(),h=this.getUserEndorseId();c&&((r=a.find(function(t){return t.get("author").login===u.login}))?i=a.indexOf(r):h&&(r=new o({endorseUri:h,author:u},{subject:d,target:this})),r&&(this.dispatchEvent("onBeforeUnendorse",[this]),this.set("_endorsedByCurrentUser",!1),a.changeTotalRecordsBy(-1),n=l.remove(u.login),r.destroy({onComplete:function(){s.dispatchEvent("onAfterUnendorse",[this]),s.dispatchEvent("onUnendorseSuccess",s)},onFailure:function(){a.changeTotalRecordsBy(1),i>=0&&a.add(r,{at:i}),n&&l.add(n,{at:i>=0?i:0}),s.set({_endorsedByCurrentUser:!0,currentUserEndorse:r.toJSON()}),s.dispatchEvent("onAfterUnendorse",[this]),require(["DS/UWPClientControls/PlatformNotify"],function(t){t.error(e)})}})))},isEndorsed:function(){return t.is(this.get("_endorsedByCurrentUser"),"boolean")?this.get("_endorsedByCurrentUser"):t.is(this.get("currentUserEndorse"))},"onChange:endorsements":function(t,e){this._endorsements&&this.setEndorsements(e)},"onChange:nbEndorses":function(t,e){var n=this.getEndorsementsTotalCount();this._endorsers&&this._endorsers.setTotalRecords(n),this._endorsements&&this._endorsements.setTotalRecords(n)},clean:function(){return this._endorsers&&(this._endorsers.clean(),this._endorsers=null),this._endorsements&&(this._endorsements.clean(),this._endorsements=null),this._parent.apply(this,arguments)}}}),define("DS/SocialToolbar/Collections/CommentCollection",["UWA/Core","DS/SocialToolbar/Mixins/Endorsable","DS/SocialToolbar/Mixins/Commentable","DS/SocialToolbar/Models/Interaction","DS/SocialToolbar/Collections/InteractionCollection","DS/SocialToolbar/Collections/CommenterCollection"],function(t,e,n,o,i,s){"use strict";var r={ACTIVE:"active",DELETED:"deleted"},a={NOT_MODERATED:"notModerated",MODERATED_BY_AUTHOR:"moderatedByAuthor",MODERATED_BY_ADMIN:"moderatedByAdmin"},l={NOT_MODERATED:"notModerated",EDITED_BY_AUTHOR:"editedByAuthor",EDITED_BY_ADMIN:"editedByAdmin",DELETED:"deleted"},c=o.extend(e,n,{COMMENTS_COUNT_ATTRIBUTE:"nbReplies",ACCESS_STATE:r,MODERATION_STATE:a,MODERATION_STATE_FOR_UI:l,_parentComment:null,name:"comment",defaults:{commentUri:null,parentCommentUri:null,richMessage:"",moderationState:null,accessState:null},idAttribute:"commentUri",urlRoot:function(){return this.getSubject().url()+"/comments"},init:function(t,e){this.CommentCollection=d,this._parent.apply(this,arguments),this._previous.apply(this,arguments),e&&e.parentComment&&this.setParentComment(e.parentComment)},getParentComment:function(){var t=this.get("parentCommentUri");return this._parentComment?this._parentComment:t?(window.console.warn("Parent comment could not been found. A new instance will be created."),new this.constructor({commentUri:t})):null},setParentComment:function(t){this._parentComment=t,this.set("parentCommentUri",t.get("commentUri"))},getModerationState:function(){var t=this.get("moderationState");switch(this.get("accessState")){case r.DELETED:return l.DELETED;case r.ACTIVE:switch(t){case a.MODERATED_BY_AUTHOR:return l.EDITED_BY_AUTHOR;case a.MODERATED_BY_ADMIN:return l.EDITED_BY_ADMIN}}return l.NOT_MODERATED},hasBeenDeleted:function(){return this.getModerationState()===l.DELETED},canBeModerated:function(e){var n,o,i=!1;return this.hasBeenDeleted()||(e&&!1===e.canBeModeratedIfAuthor||this.getSubject().getSharedOptions().getOption("userLogin")!==this.getAuthor().get("login")?(i=o=this.collection&&this.collection.canBeModerated(),t.is(o,"boolean")||(n=this.getParentComment())&&(i=n.canBeModerated({canBeModeratedIfAuthor:!1}))):i=!0),i}}),d=i.extend({_userHasSpecialModerationRights:null,name:"comment-collection",model:c,AuthorCollection:s,_prepareModel:function(t,e){var n=e||{};return this._target&&this._target instanceof this.model&&(n.parentComment=this._target),this._parent.call(this,t,n)},_getModerationRightsUrl:function(){return this.getSubject().url()+"/moderationrights"},_getNbCommentsToLoadToCompleteCurrentPage:function(e){return t.is(e,"number")||(e=this.getDefaultPageSize()),Math.min(this.getSubject().getCommentsTotalCount(),e*(this.state.currentPage+(0===this.state.firstPage?1:0)))-this.length},getDefaultPageSize:function(){return this.defaultOptions.state.pageSize},url:function(){return this._target&&this._target!==this._subject?this.getSubject().url()+"/comments/"+this._target.get("commentUri"):this.model.prototype.urlRoot.call(this)},fetch:function(t){var e=t||{};return e.data||(e.data={}),e.data.order_by="reverse_time",this._parent.call(this,e)},parseHeadersForStateUpdate:function(e,n,o,i){var s=this._parent.apply(this,arguments),r=this._getResponseHeader(i,"X-3DComment-Has-Moderation-Rights");return t.is(r)&&(this._userHasSpecialModerationRights=r),s},canBeModerated:function(){switch(this._userHasSpecialModerationRights){case"true":return!0;case"false":return!1;default:return null}},getCommentModerationRights:function(e){var n,o=this,i=this.getSubject(),s=t.clone(e,!1);t.is(s,"object")||(s={}),n=s.onComplete,s.onComplete=function(e){t.is(e,"boolean")&&(o._userHasSpecialModerationRights=String(e)),n&&n.apply(this,arguments)},s.url=this._getModerationRightsUrl(),i.sync("read-moderationrights",i,s)},loadPreviousComments:function(e,n){var o,i=!1,s=null,r=this.length;t.is(e,"number")||(e=this.getDefaultPageSize()),s=(s=this.length%e)>=0?s:0,o=t.extend({at:0,reset:!1,add:!0,remove:!1,data:{offset:r>0?r:void 0}},n,!0),s!==this.state.baseOffset&&(i=!0,this.state.baseOffset=s),this.state.pageSize!==e?this.setPageSize(e,o):!0===i?this.getFirstPage(o):this._getNbCommentsToLoadToCompleteCurrentPage(e)>0?this.getPage(this.state.currentPage,o):this.getNextPage(o)}});return d.COMMENTS_ORDER="reverse_time",d}),define("DS/SocialToolbar/Collections/ContributionsCollection",["UWA/Core","DS/Logger/Logger","DS/SocialToolbar/Collections/BaseCollection","DS/SocialToolbar/Models/Contributions","DS/SocialToolbar/Collections/CommentCollection"],function(t,e,n,o,i){"use strict";var s={},r={1:"time","-1":"reverse_time"};s[r[1]]="1",s[r[-1]]="-1";var a=n.extend({name:"contribution-collection",model:o,defaultOptions:{tenantId:null,serviceUrl:"",subjectUris:null,state:{pageSize:2,sortKey:"time",order:s[i.COMMENTS_ORDER]},queryParams:{order:"order_by",sortKey:"sort_by",directions:r}},_executePostInitInstructions:function(){var e=this.getOption("subjectUris");if(!this.getOption("tenantId"))throw new Error("Tenant (online instance) ID is required");if(!this.getOption("serviceUrl"))throw new Error("Service URL is required");if(!t.is(e,"array")||0===e.length)throw new Error("Subjects URIs are required");if(e.length>10)throw new Error("The number of Subject URIs exceeds the maximum authorized which is: 10")},url:function(){return this.getOption("serviceUrl")+"/commentproxy/subjects/"+this.getOption("subjectUris").join(",")+"/contributions"},parseRecords:function(e,n){var o=e;if(n.subjectUris&&(o=[],t.is(e,"object")))if(1===n.subjectUris.length)e.subjectUri=n.subjectUris[0],o.push(e);else if(n.subjectUris.length>1)for(var i in e)e.hasOwnProperty(i)&&(e[i].subjectUri=i,o.push(e[i]));return o},fetch:function(t){var n=t||{};return n.onFailure||(n.onFailure=function(){e.error("Failed to retrieve contributions")}),n.subjectUris=this.getOption("subjectUris"),n.data=n.data||{},n.data.tenant=this.getOption("tenantId"),this._parent.call(this,n)}});return a.MAX_NB_SUBJECTS=10,a}),define("DS/SocialToolbar/CallMutualizer",["UWA/Core","UWA/Utils","UWA/Class/Events","UWA/Class/Options","DS/SocialToolbar/Collections/ContributionsCollection","DS/Logger/Logger"],function(t,e,n,o,i,s){"use strict";var r=!1,a=null,l={},c={},d=[],u=i.MAX_NB_SUBJECTS,h=n.singleton(o,{init:function(){this.setOptions(),this._parent.apply(this,arguments),this._previous.apply(this,arguments);var n=function(){var t;!0===r&&(r=!1),d.length>0&&(t=d.shift(),this.openCallWindow(t))}.bind(this),o=function(){var d,u,h=this,m=this.options,p=e.getUUID();d=Object.keys(a),r&&this.getOption("nbInitCallsToMutualize")===d.length&&(n(),d.length>0&&(c[p]=[].concat(d),(u=new i([],{tenantId:m.tenantId,serviceUrl:m.serviceUrl,subjectUris:d})).setPageSize(t.is(m.commentsNumberAtInit,"number")?m.commentsNumberAtInit:5,{onComplete:function(){var t;u.toJSON().forEach(function(e){t=e.subjectUri,l[t]=e,h.dispatchEvent("onContributionsFetch:"+t,[e]),l[t]=null,delete a[t]}),delete c[p];const e=function(t,e){return t.filter(t=>!e.includes(t))}(d,u.map(t=>t.get("subjectUri"))),n={errorcode:"ContainerNotFoundException"};e.forEach(function(t){h.dispatchEvent("onContributionsFetchFailure:"+t,[n]),delete a[t]}),o()},onFailure:function(t,e){s.error("Failed to retrieve contributions"),d.forEach(function(t){h.dispatchEvent("onContributionsFetchFailure:"+t,[e]),delete a[t]}),delete c[p]}})))}.bind(this),u=function(e){var n;if(!t.is(e))throw new Error("subjectURI is required");if(!r)return null;var i,s=!1,l=this.getOption("nbInitCallsToMutualize");return!0!==a[e]&&((i=Object.keys(a).length)<l?(i===l-1&&(s=!0),a[e]=!0):s=!0),n=!0===a[e],s&&o(),n}.bind(this),h=function(t){for(var e in c)if(c.hasOwnProperty(e)&&c[e].indexOf(t)>=0)return!0;return!1}.bind(this);this.getContributions=function(t,e,n,o){var i,s=this,a=r,c=void 0,d=void 0;if("function"!=typeof e)throw new Error("Provided callback is not valid!");if(!0!==o&&!1===u(t))return!1;if(i=l[t])e.call(null,i);else{if(!a&&!h(t))return!1;c=function(){d&&s.removeEvent("onContributionsFetchFailure:"+t,d),s.getContributions.call(s,t,e,null,!0)},this.addEventOnce("onContributionsFetch:"+t,c),"function"==typeof n&&(d=function(e){s.removeEvent("onContributionsFetch:"+t,c),n.call(null,e)},this.addEventOnce("onContributionsFetchFailure:"+t,d))}return!0},this.modifyCallWindowSizeBy=function(e){var n,i,s;if(0===e||!t.is(e,"number")||e!==parseInt(e,10))throw new Error("`difference` option is either missing or invalid");if(!1===r)return console.warn("Call window is closed"),!1;e>0?this.openCallWindow(t.extend(t.clone(this.options,!1),{nbInitCallsToMutualize:e})):(i=d.length)>0?((s=d[i-1]).nbInitCallsToMutualize+=e,0===s.nbInitCallsToMutualize&&d.pop()):(n=this.getOption("nbInitCallsToMutualize")+e)>0?(this.setOption("nbInitCallsToMutualize",n),Object.keys(a).length>=n&&o()):0===n&&(this.setOption("nbInitCallsToMutualize",null),r=!1)}},defaultOptions:{tenantId:null,serviceUrl:"",commentsNumberAtInit:5,nbInitCallsToMutualize:null},openCallWindow:function(e){var n=0,o=t.clone(e,!1);if(!t.is(o.nbInitCallsToMutualize,"number"))throw new Error("Number of calls to mutualize, is required");if(o.nbInitCallsToMutualize>u&&(console.warn("Maximum number of calls to mutualize should not exceed "+u),n=o.nbInitCallsToMutualize-u,o.nbInitCallsToMutualize=u),!o.tenantId)throw new Error("Tenant ID is required");if(!o.serviceUrl)throw new Error("ServiceUrl ID is required");if(!(o.nbInitCallsToMutualize>0))throw new Error("`nbInitCallsToMutualize` option is supposed to be strictly positive");!0===r?d.push(o):(r=!0,a={},this.setOptions.call(this,o)),n>0&&this.openCallWindow(t.merge({nbInitCallsToMutualize:n},o))}});return h.init(),h}),define("DS/SocialToolbar/Models/Subject",["UWA/Core","DS/Logger/Logger","DS/SocialToolbar/Models/BaseModel","DS/SocialToolbar/Mixins/Endorsable","DS/SocialToolbar/Mixins/Commentable","DS/SocialToolbar/Collections/CommentCollection","DS/SocialToolbar/Collections/ContributionsCollection","DS/SocialToolbar/CallMutualizer"],function(t,e,n,o,i,s,r,a){"use strict";return n.extend(o,i,{_populated:!1,_failedToFetchContributions:!1,_sharedOptions:null,name:"subject",idAttribute:"subjectUri",CommentCollection:s,defaults:{subjectUri:null,currentUserEndorse:null,nbEndorses:null,nbComments:null},init:function(t,e){if(this._parent.apply(this,arguments),this._previous.apply(this,arguments),e){if(!e.sharedOptions)throw new Error("Shared options are missing");this._sharedOptions=e.sharedOptions}},urlRoot:function(){return this.getSharedOptions().getOption("serviceUrl")+"/commentproxy/subjects"},_storeContributionsData:function(e){var n=this.getComments(),o=t.clone(e,!1);delete o.metas,delete o.comments,this.set(e),this._populated=!0,this._failedToFetchContributions=!1,n.setTotalRecords(this.get("nbComments")),n.reset(e.comments,{parse:!0,responseHeaders:{"X-3DComment-Has-Moderation-Rights":e.metas&&e.metas["X-3DComment-Has-Moderation-Rights"]}}),n.dispatchEvent("onSync",[n,{result:e.comments},{}]),this.dispatchEvent("onPopulate",[this])},_onContributionsFetchFailure:function(t){this._failedToFetchContributions=!0,this.dispatchEvent("onContributionsFetchFailure",[t])},fetchContributions:function(t,n,o){var i,s,l=this,c=this.get("subjectUri"),d=this.getSharedOptions();this._failedToFetchContributions=!1,!0===n&&!1!==a.getContributions(c,this._storeContributionsData.bind(this),this._onContributionsFetchFailure.bind(this))||(i=l.getComments(),s=l.getCommentsTotalCount(),(!0===o||!i.hasBeenFetched()||t<s)&&new r([],{tenantId:d.getOption("tenantId"),serviceUrl:d.getOption("serviceUrl"),subjectUris:[this.get("subjectUri")]}).setPageSize(t,{onComplete:function(t){l._storeContributionsData(t.toJSON()[0])},onFailure:function(){this.dispatchEvent("onPopulate",[this]),e.error("Failed to retrieve contributions"),l._onContributionsFetchFailure()}.bind(this)}))},hasBeenPopulated:function(){return this._populated},hasFailedToFetchContributions:function(){return this._failedToFetchContributions},getSharedOptions:function(){return this._sharedOptions}})}),define("DS/SocialToolbar/Collections/MediaCollection",["UWA/Core","UWA/Promise","DS/SocialToolbar/Collections/BaseCollection","DS/SocialToolbar/Models/Media","DS/SocialToolbar/Models/Annotation","DS/SocialToolbar/Utils/Media"],function(t,e,n,o,i,s){"use strict";return n.extend({name:"media-collection",init:function(t,e){this._parent.apply(this,arguments)},model:function(t,e){return t&&t.mediaType===s.ANNOTATION_TYPE?new i(t,e):new o(t,e)},uploadAllNewAnnotations:function(){return new e.all(this.reduce(function(t,e){return e instanceof i&&e.isNew()&&t.push(e.upload()),t},[]))},deleteAllAnnotations:function(){var t=this.filter(function(t){return t instanceof i}).map(function(t){return t.deleteAnnotation()});return new e.all(t)}})}),define("DS/SocialToolbar/Views/BaseCommentMediaListWrapperView",["UWA/Core","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Views/MediaListView","DS/SocialToolbar/Utils/Media","DS/SocialToolbar/Collections/MediaCollection"],function(t,e,n,o,i){"use strict";return e.extend({_getMediaListToDisplay:function(e,s){var r=this.components.get("mediaList"),a=t.is(e,"string")?e:this.model&&this.model.get("richMessage")||"",l=o.getMediaData(a);return this.model&&((s=s||{}).subject=s.subject||this.model.getSubject()),r?r.collection.reset(l,s):0===l.length?r="":(r=new n({collection:new i(l,s),mediaViewsOptions:this.getOption("mediaViewsOptions")}),this.components.addMap({mediaList:r})),r},getMediaCollection:function(){var t=this.components.get("mediaList");return t&&t.collection}})}),define("DS/SocialToolbar/Views/CommentEditorView",["UWA/Core","UWA/Event","UWA/Promise","UWA/Utils/Client","DS/UWPClientCode/I18n","DS/SocialToolbar/Mixins/InlineEditor","DS/SocialToolbar/Views/BaseCommentMediaListWrapperView","DS/SocialToolbar/Utils/Date","DS/SocialToolbar/Utils/Media","DS/SocialToolbar/Utils/MessageBus","i18n!DS/SocialToolbar/assets/nls/social-toolbar","DS/UIKIT/Input/Text","DS/UIKIT/Input/Button","DS/UIKIT/Tooltip","DS/Logger/Logger"],function(t,e,n,o,i,s,r,a,l,c,d,u,h,m,p){"use strict";var g=null,f=null,C=null,S="br;p{*};i{*};u{*};s{*};strike{*};em{*};strong{*};b{*};a[class,data-login,data-users-group-uri,href,target,contenteditable](*);img[data-uri,data-source,data-related-media-uri,data-media-type];";return r.extend(s,{_rteReady:!1,_lastKnownCursorPosition:null,name:"st-comment-editor",rte:null,defaultOptions:{richMode:!1,creationMode:!0,parentComment:null,showRteOnDOMInjection:!1,mediaViewsOptions:{editMode:!0}},domEvents:{"keyup .st-text-editor":"_onKeyUp","keydown .st-text-editor":"_onKeyDown","mousedown .st-text-editor":"_onMouseDown","click .st-text-editor":"_onFocusIn","focusin .st-text-editor":"_onFocusIn","focusout .st-text-editor":"_onFocusOut","click .st-send-button":"onSendButtonClick","click .st-rte-media-attach-btn":"_onOpenMediaLibraryRequest","mousedown .st-comment-cancel-link .st-fake-link":"cancelEdition"},onSendButtonClick:function(){this.saveComment(),this.shouldSaveCommentOnReturn()&&this.dispatchEvent("onSavedWithSendButton")},_onFocusIn:function(t){var e=this;o.Features.touchEvents||this.container.addClassName("show-long-msg"),this._setLastActiveEditor(this),!0!==this.options.richMode||this.rte||setTimeout(function(){e._lastKnownCursorPosition=e._getCursorPosition(),e.addEventOnce("onRteReady",e._placeCursorAtlastKnownPosition),e._showRTE()},0)},_onFocusOut:function(t){this.container.removeClassName("show-long-msg")},_onKeyUp:function(t){var n,o="return"===e.whichKey(t);return n=this._parent.apply(this,arguments),o&&this.shouldSaveCommentOnReturn()&&(t.preventDefault(),t.stopPropagation(),n=!1),n},shouldSaveCommentOnReturn:function(){var t=this.getTopLevelComponent().getOption("showSendButton");return!(o.Features.touchEvents&&t)},_onKeyDown:function(t){var n=e.whichKey(t),o=this.getTopLevelComponent().getOption("showSendButton");return"ctrl+return"===n&&this.shouldSaveCommentOnReturn()?(this.saveComment(),o&&this.dispatchEvent("onSavedWithCtrlEnterKey"),t.preventDefault(),t.stopPropagation(),!1):("esc"===n&&t.currentTarget===e.getElement(t)&&this.cancelEdition(),!0)},_onKeyDownOnRte:function(t){var e=this._getDomEventFromEditorEvent(t);if(e&&!this._onKeyDown(e))return t.cancel(),!1},_onPaste:function(){},_onOpenMediaLibraryRequest:function(){},init:function(){this._onFocusIn=this._onFocusIn.bind(this),this._onFocusOut=this._onFocusOut.bind(this),this._parent.apply(this,arguments),!1!==this.options.creationMode&&this.container.addClassName("st-creation"),this.listenToOnce(c,"onBeforeCKEditorLoad",this._onBeforeCKEditorLoad),this.listenToOnce(c,"onAfterCKEditorLoad",this._onAfterCKEditorLoad),this.listenTo(this.components,{onMediaRemoval:this.placeCursorAt}),g||this.addEventOnce("onInjected",this._loadCKE)},onEnterEditMode:function(){this._handleUserPictureVisibility({hide:!0})},onEnterViewMode:function(){this._handleUserPictureVisibility({hide:!1})},_getDomEventFromEditorEvent:function(t){return t.data&&t.data.domEvent&&t.data.domEvent.$},_getTextAreaId:function(){return"st-comment-editor-"+this.cid},_getSubject:function(){var t=this.collection||this.model;if(!t)throw new Error("This was not supposed to happen...");return t.getSubject()},_getSharedOptions:function(){return this._getSubject().getSharedOptions()},_setLastActiveEditor:function(t){this._getSharedOptions().setLastActiveEditor(t)},_containsMedia:function(){var t=this.components.get("mediaList");return!!t&&t.collection.length>0},_getMediaHtmlToSave:function(){var t=this.components.get("mediaList");return t?t.collection.reduce(function(t,e){var n=e.get("uri"),o=e.get("source"),i=e.get("relatedMediaUri"),s=e.get("mediaType")===l.ANNOTATION_TYPE?e.get("mediaType"):void 0;if(!n)throw new Error("Media URI is missing");if(!o)throw new Error("Media source is missing");return t+'<img data-uri="'+n+(s?'" data-media-type="'+s:"")+(i?'" data-related-media-uri="'+i:"")+'" data-source="'+o+'" />'},""):""},_getMediaHtmlFromMediaList:function(){var t=this.components.get("mediaList");return t?t.collection.reduce(function(t,e){var n=e.get("mediaType"),o=e.get("uri"),i=e.get("relatedMediaUri"),s=e.get("source");if(s){if(o||n!==l.ANNOTATION_TYPE){if(o)return t+'<img data-uri="'+o+(n?'" data-media-type="'+n:"")+(i?'" data-related-media-uri="'+i:"")+'" data-source="'+s+'" />';throw new Error("Media uri or file is missing")}return t+e.getHtml()}throw new Error("Media source is missing")},""):""},_createContent:function(){var e=t.createElement("div",{id:this._getTextAreaId(),contenteditable:"true",class:"form-control st-text-editor"+(this.getOption("parentComment")?" input-sm":""),"data-placeholder":this.getOption("parentComment")?d.get("Write a reply..."):d.CommentPlaceHolder,html:this._getMessageToDisplay()}),n=t.createElement("div",{class:"st-rte-media-attach-btn",html:{tag:"span",class:"fonticon fonticon-attach"}}),o=t.createElement("div",{class:"st-text-editor-container",html:[e,n,{class:"st-media-list-editor",html:this._getMediaListToDisplay()}]}),i=t.createElement("span",{class:"fonticon fonticon-send"}),s=new m({target:i,body:d.Send+"</br>"+d.CtrlEnter}),r=t.createElement("div",{class:"st-send-button",html:[i,s]}),a=t.createElement("div",{class:"st-text-editor-container-wrapper",html:[o,r]}),l=t.createElement("div",{class:"st-btn st-comment-cancel-link",html:[{tag:"span",class:"st-long-msg",html:d.PleaseClickOnEscapeToCancelHtml.format('<span class="st-fake-link">',"</span>")},{tag:"span",class:"st-short-msg st-fake-link",html:d.Cancel}]});return this.elements.textEditor=e,this.elements.sendButton=r,this.elements.textEditorContainer=o,this.elements.cancelLinks=l,this.components.addMap({attachmentIconTooltip:new m({target:n,body:d.AddMedia})}),[a,{class:"st-editor-footer",html:[l]}]},_getEditorElement:function(){return this.elements.textEditor},_getSendButton:function(){return this.elements.sendButton},_getEditorContent:function(){var t=this._getEditorElement();return t?t.getHTML():""},_getUnwrappedMessage:function(e){var n,i;return t.is(e,"string")?n=e:(n=this.model&&this.model.get("richMessage"),t.is(n,"string")?(i=t.createElement("div",{html:n}).getElement("div[data-generated-by-rte]"))&&(n=i.getHTML()):n=o.Engine.firefox||o.Engine.ie?"<p><br></p>":""),n},_getMessageToDisplay:function(t){return this._getUnwrappedMessage(t)},_filterContent:function(t,e){if(!g)throw new Error("CKEditor has not been loaded yet");if(!t)return"";var n=new g.htmlParser.basicWriter,o=new g.htmlParser.fragment.fromHtml(t,void 0,!1);return new g.filter(e).applyTo(o),o.writeHtml(n),n.getHtml()},_setRteData:function(t){var e=this;this.rte&&this.rte.setData(this._filterContent(t,this.extraAllowedContent),function(){e.dispatchEvent("onSetRTEData")})},_updateEditorContent:function(e){if(this._rendered){var n,i=this._getMessageToDisplay(e),s=this.getElement(".st-media-list-editor");!0===this.options.richMode&&this._rteReady?this._setRteData(i):this._getEditorElement().setContent(i),"ios"===o.Platform.name&&o.Platform.ipad&&""===e&&this._getEditorElement().setContent(i),this._handlePlaceholderVisibility(),s&&((n=this._getMediaListToDisplay(e,{subject:this._getSubject()}))&&t.is(n.inject,"function")?(s.empty(),n.inject(s)):s.setContent(n&&n.container||n)),this._handleSendButtonVisibility()}},_onBeforeCKEditorLoad:function(){this.elements.textEditor&&this.elements.textEditor.setAttribute("contenteditable","false")},_onAfterCKEditorLoad:function(){this.elements.textEditor&&this.elements.textEditor.setAttribute("contenteditable","true")},_handlePlaceholderVisibility:function(){this._isEditorEmpty()?this.container.addClassName("st-show-placeholder"):this.container.removeClassName("st-show-placeholder")},_handleSendButtonVisibility:function(t){!0===this.getTopLevelComponent().getOption("showSendButton")&&(t?!0===t.show?(this.container.addClassName("st-show-send"),this._handleUserPictureVisibility({hide:!0})):!1===t.show&&(this.container.removeClassName("st-show-send"),this._handleUserPictureVisibility({hide:!1})):!0!==this._isEditorEmpty()||this._containsMedia()?(this.container.addClassName("st-show-send"),this._handleUserPictureVisibility()):(this.container.removeClassName("st-show-send"),this._handleUserPictureVisibility()))},_handleUserPictureVisibility:function(t){!0===this.getTopLevelComponent().getOption("showSendButton")&&(t?!0===t.hide?this.dispatchEvent("onHideUserPictureRequest"):!1===t.hide&&this.dispatchEvent("onShowUserPictureRequest"):this._isEditorEmpty()?this.dispatchEvent("onShowUserPictureRequest"):this.dispatchEvent("onHideUserPictureRequest"))},_loadCKE:function(e){c.dispatchEvent("onBeforeCKEditorLoad"),require(["DS/CKEditor/CKEditor"],function(n){(g=n).disableAutoInline=!0,g.on("dialogDefinition",function(t){var e,n,o=[],i=[],s=void 0,r=t.data.definition;0===t.editor.name.indexOf("st-comment-editor")&&"link"===t.data.name&&(r.removeContents("target"),(n=r.getContents("info").get("linkType").items)&&(n.forEach(function(t){switch(t[1]){case"url":case"email":o.push(t)}}),n.splice(0),o.forEach(function(t){n.push(t)})),r.onShow&&(s=r.onShow),r.onShow=function(){var t=this.commitContent;if(this.commitContent=function(e){var n=Array.prototype.slice.call(arguments);return e.target||(e.target={}),e.target.type="_blank",e.target.name="_blank",n[0]=e,t.apply(this,n)},s)return s.apply(this,arguments)},(e=r.getContents("info").get("protocol").items)&&(e.forEach(function(t){switch(t[1]){case"http://":case"https://":case"ftp://":i.push(t)}}),e.splice(0),i.forEach(function(t){e.push(t)})))}),c.dispatchEvent("onAfterCKEditorLoad"),t.is(e,"function")&&e.call()})},_showRTE:function(){var e,n,s=this,r=this._getEditorElement();return!0!==this.options.richMode?this:this._inPage?void(r&&!this.rte&&(e=this._getEditorContent(),n=function(){var n,a=s.rte,l=function(){this._handlePlaceholderVisibility(),this._handleSendButtonVisibility()}.bind(s);C=t.extend(t.clone(g.config),{title:!1,removePlugins:"elementspath,magicline",removeButtons:"Subscript,Superscript",disableNativeSpellChecker:!1,language:i.getCurrentLanguage(),extraAllowedContent:S,toolbar:[{name:"basicstyles",groups:["basicstyles","cleanup"],items:["Bold","Italic","Underline","Strike","-","RemoveFormat"]},{name:"links",items:["Link","Unlink"]}],on:{paste:function(t){s._onPaste(t);var e=t.data,n=t.editor.dataProcessor,o=new g.filter(S);e.dataValue=n.toHtml(e.dataValue,{filter:o,fixForBody:!1})},customConfigLoaded:function(t){t.editor.config.removeButtons="Subscript,Superscript"}}}),n=s.collection||s.model?t.extend(t.clone(C,!1),s.getTopLevelComponent().getOption("RTEConfig")||{}):t.clone(C,!1),s.extraAllowedContent=n.extraAllowedContent,n.on.contentDom=function(t){var e=t.editor,n=s._getEditorElement();s._hideRTEToolbar(),null===s._lastKnownCursorPosition&&(s._lastKnownCursorPosition=s._getCursorPosition()),s.dispatchEvent("onRteReady"),s._handlePlaceholderVisibility(),s._handleSendButtonVisibility(),n&&n.addEvent(o.Engine.ie?"keyup":"input",l),e.editable().on("contextmenu",function(t){var n=e.getSelection();n&&!n.isLocked&&t.cancel()},null,null,1)},n.on.key=s._onKeyDownOnRte.bind(s),n.on.change=l,!r||a&&a.element.$===r||!r.isInjected()||(a=s.rte=g.inline(r,n),s._setRteData(e))},g?n.call():this._loadCKE(n))):(this.addEventOnce("onInjected",this._showRTE),this)},_destroyRte:function(){var t=this.rte;if(t){this.rte=null;try{t.destroy()}catch(t){t&&p.error(t)}}},_isMessageEmpty:function(t,e){var n=t.replace(/\u200B/g,"");return!n||""===n.unescapeHTML()||"<p></p>"===n||"<p><br></p>"===n||"<p><br></p>"===n||"<p><br/></p>"===n||e&&!0===e.checkWhitespaces&&""===n.replace(/<(?:.|\n)*?>|\s|&nbsp;|\u200B|&#8203;/gm,"").trim()},_isEditorEmpty:function(e){return this._isMessageEmpty(t.is(e&&e.editorContent,"string")?e.editorContent:this._getEditorContent(),e)},_getMessageToSave:function(){return this._getEditorContent()},_getRangeSize:function(e){return e.toString().length+(o.Engine.chrome?0:t.createElement("div",{html:e.cloneContents()}).getElements("br").length)},_findCursorPositionFromRangeSize:function(t,e,n){var i,s=null,r=void 0,a=t.childNodes,l=a.length;if(n||(n=document.createRange()).selectNodeContents(t),0===l)return t.nodeType===t.TEXT_NODE?{childPosition:e,childNode:t}:(s=t,"BR"===t.tagName&&(e=0,o.Engine.chrome||(s=t.parentNode.insertBefore(document.createTextNode(o.Engine.ie?"":""),t))),{childPosition:e,childNode:s});for(var c=0,d=l;c<d;c++)if(i=a[c],n.selectNodeContents(i),n.setStart(t,0),this._getRangeSize(n)>=e){if("BR"===(s=i).tagName)return this._findCursorPositionFromRangeSize(s,0,n);s.previousSibling?(n.selectNodeContents(s.previousSibling),n.setStart(t,0),r=e-this._getRangeSize(n)):r=e;break}return s?this._findCursorPositionFromRangeSize(s,r,n):(s=a[l-1],n.selectNodeContents(s),{childPosition:n.endOffset,childNode:n.endContainer})},_getCursorPosition:function(e,n,o){var i,s,r,a,l=this._getEditorElement();if(!l||document.activeElement!==l&&!l.contains(document.activeElement))return{};if(e||n||o&&!0===o.lastPositionIfUnspecifiedPosition){if(n||(n=l),n===l||l.contains(n)||(n=l,e=void 0),"object"===(a=t.typeOf(e))&&t.is(e.sizeOfRangeFromEditorStart,"number"))return this._findCursorPositionFromRangeSize(l,e.sizeOfRangeFromEditorStart);if("number"!==a)if(n.lastElementChild&&n.lastElementChild.childNodes.length>0){if((n=n.lastElementChild.lastChild)&&(e=n.nodeValue&&n.nodeValue.length,!t.is(e,"number"))){if("BR"===n.tagName)return this._findCursorPositionFromRangeSize(n,0);e=n.childNodes.length}}else e=0}else{if(!(r=document.getSelection())||0===r.rangeCount)return null;n=l,(s=(i=r.getRangeAt(0)).cloneRange()).selectNodeContents(l),s.setEnd(i.endContainer,i.endOffset),e={sizeOfRangeFromEditorStart:this._getRangeSize(s)}}return{childPosition:e,childNode:n}},_placeCursorAtlastKnownPosition:function(){var t=this._lastKnownCursorPosition;return this._lastKnownCursorPosition=null,this.placeCursorAt(t&&t.childPosition,t&&t.childNode)},isInRichMode:function(){return!0===this.getOption("richMode")},isRteReady:function(){return!0===this._rteReady},enterRichMode:function(){var t=this.elements.textEditor;return!0!==this.options.richMode&&(this.options.richMode=!0,this.container.addClassName("st-rich"),t.addClassName("st-rich"),this.rte&&this._showRTE()),this},resetEditorContent:function(t){this._hideRTEToolbar(),this._updateEditorContent(t)},updateEditorContentWhenRteIsReady:function(e,n,o){var i,s,r,a;return this._rteReady?(o&&o.allowedContent&&(e=this._filterContent(e,o.allowedContent)),r=(a=t.is(e,"string"))?e:"",o&&!1===o.replace?(i=this._getEditorContent(),r=((s=this._isEditorEmpty({editorContent:i}))?"":i)+(o&&!1===o.insertNewLineIfEditorEmpty||s?"":"<br>")+r+(this._getMediaHtmlFromMediaList()+l.getMediaHtml(n))):r+=l.getMediaHtml(n),a||""!==r||(r=void 0),this.resetEditorContent(r)):(this.addEventOnce("onRteReady",this.updateEditorContentWhenRteIsReady.bind(this,e,n,o)),this._showRTE()),this},cancelEdition:function(){this.resetEditorContent(),this.dispatchEvent("onCancelEdition",[this])},focus:function(){var t=null,e=null;return this.elements.textEditor&&document.activeElement!==this.elements.textEditor&&(o.Engine.firefox&&this.rte&&null===this.rte.getSelection()&&(e=this.rte.editable(),(t=new CKEDITOR.dom.selection(e)).selectElement(e),this.rte.lockSelection(t)),o.Platform.ios&&this.elements.textEditor.scrollIntoView(),t?this.rte.once("focus",function(){this.unlockSelection(t)},void 0,void 0,100):this.elements.textEditor.focus()),this._inPage&&this.rte?this.rte.focus():this.addEventOnce("onRteReady",this.focus),this},blur:function(){return this.elements&&this.elements.textEditor&&this.elements.textEditor.blur&&this.elements.textEditor.blur(),this},placeCursorAt:function(e,n,i){o.Platform.ios||this.focus();try{var s,r=document.createRange(),a=document.getSelection();a&&(s=this._getCursorPosition(e,n,{lastPositionIfUnspecifiedPosition:!0}),t.is(s.childNode)&&t.is(s.childPosition,"number")&&(r.setStart(s.childNode,s.childPosition),r.collapse(!0),a.removeAllRanges(),a.addRange(r)))}catch(t){console.error(t)}},saveSnapShot:function(){return!this.isDestroyed()&&this.rte?(this.rte.fire("saveSnapshot"),this):null},onRender:function(){var t=this,e=this._getSharedOptions();this.elements.textEditor&&o.Engine.firefox&&this.elements.textEditor.addEvents({focus:this._onFocusIn,blur:this._onFocusOut}),this._handlePlaceholderVisibility(),this._handleSendButtonVisibility(),this.enterRichMode(),e.getOption("3DSwymUrl")&&require(["DS/SocialUserMention/SocialUserMention"],function(n){if(f=n,!t.isDestroyed()){var o=function(){t.elements&&t.elements.textEditor&&f.enableFeature({editableElement:t.elements.textEditor,tenantId:e.getOption("tenantId"),"3DSwymUrl":e.getOption("3DSwymUrl"),"3DSwymServerToken":e.getOption("3DSwymServerToken"),userLogin:e.getOption("userLogin"),userName:e.getOption("userName"),events:{onInsert:function(){t.saveSnapShot()}}})};t.elements.textEditor&&("true"===t.elements.textEditor.getAttribute("contenteditable")?o():t.listenToOnce(c,"onAfterCKEditorLoad",function(){try{o()}catch(t){p.error(t)}}))}})},onInjected:function(){return this._parent.apply(this,arguments),!0===this.options.showRteOnDOMInjection&&(this._lastKnownCursorPosition=this._getCursorPosition(),this.executeWhenRteIsReady(this._placeCursorAtlastKnownPosition),this._showRTE()),this},onRteReady:function(){this._rteReady=!0},executeWhenRteIsReady:function(t){this._rteReady?t.call(this):this.addEventOnce("onRteReady",t)},saveComment:function(){var t,e,o,i,s,r,a=this,l=this.model,c=this.collection,u=(new Date).toISOString(),h=this._getMessageToSave(),m=this.components.get("mediaList"),p=m&&m.collection,g=this._isMessageEmpty(h,{checkWhitespaces:!0});(p&&p.uploadAllNewAnnotations()||n.resolve()).then(function(){g&&(h=""),r=a._getMediaHtmlToSave(),g&&!r||(h+=r,l?(t=l.get("richMessage"))!==h&&(l.save({richMessage:h},{onFailure:function(){var e=l.get("richMessage");require(["DS/UWPClientControls/PlatformNotify"],function(t){t.error(d.SorryYourCommentCouldNotBeSaved)}),l.set("richMessage",t),a.dispatchEvent("onCommentSaveFailure",[a,e])},onComplete:function(){a.dispatchEvent("onCommentEditSuccess",l)}}),l.set({modificationDate:u})):(o=c.getSubject().getSharedOptions().getUserInfo(),i=c.getTarget().getCommenters(),(s=i.get(o.login))||i.add(o),c.changeTotalRecordsBy(1),e={richMessage:h,author:o},a.getOption("parentComment")&&(e.parentCommentUri=a.getOption("parentComment").get("commentUri")),(l=c.create(e,{onFailure:function(){var t=l.collection;t&&(t.changeTotalRecordsBy(-1),t.remove(l)),s||i.remove(o.login),require(["DS/UWPClientControls/PlatformNotify"],function(t){t.error(d.SorryYourCommentCouldNotBeCreated)}),a.dispatchEvent("onCommentSaveFailure",[a,l.get("richMessage")])},onComplete:function(t){a.dispatchEvent("onCommentCreateSuccess",t)}})).set({creationDate:u,modificationDate:u}),a.dispatchEvent("onCommentPrePublish",[a,l])),a.dispatchEvent("onCommentSaved",[a]))})},destroy:function(){return f&&this.elements.textEditor&&f.disableFeature({editableElement:this.elements.textEditor}),this._destroyRte(),this._parent.apply(this,arguments)}})}),define("DS/SocialToolbar/Views/InteractorSmallView",["UWA/Core","DS/SocialToolbar/Views/BaseView"],function(t,e){"use strict";return e.extend({name:"st-interactor-small",_createContent:function(){return this.model.getFullName()}})}),define("DS/SocialToolbar/Views/CommentCreatorView",["UWA/Core","UWA/Utils/Client","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Utils/Sprite","DS/SocialToolbar/Views/CommentEditorView"],function(t,e,n,o,i){"use strict";return n.extend({name:"st-comment-creator",defaultOptions:{parentComment:null},_createContent:function(){var t=this.collection.getSubject().getSharedOptions(),e=new i({parentComment:this.getOption("parentComment"),collection:this.collection});return this.components.addMap({commentEditor:e}),[o.renderUserPicture({cls:"st-user-picture",format:"normal",login:t.getOption("userLogin"),swymUrl:t.getOption("3DSwymUrl")}),e]},_onCommentSaved:function(t){t.resetEditorContent(""),e.Features.touchEvents&&t.blur(),this.dispatchEvent("onCommentSaved",[this])},_onCommentSaveFailure:function(t,e){t.resetEditorContent(e),t.placeCursorAt(),this.dispatchEvent("onCommentSaveFailure",[this])},_onCancelEdition:function(t){t.resetEditorContent(""),this.dispatchEvent("onCancelEdition",[this])},init:function(){this._parent.apply(this,arguments),this.listenTo(this.components,{onCommentSaved:this._onCommentSaved,onCommentSaveFailure:this._onCommentSaveFailure,onCancelEdition:this._onCancelEdition,onShowUserPictureRequest:this._onShowUserPictureRequest,onHideUserPictureRequest:this._onHideUserPictureRequest,onCommentCreateSuccess:this._onCommentCreateSuccess,onSavedWithSendButton:this._onSavedWithSendButton,onSavedWithCtrlEnterKey:this._onSavedWithCtrlEnterKey})},_onSavedWithCtrlEnterKey:function(){this.dispatchEvent("onSavedWithCtrlEnterKey",[this])},_onSavedWithSendButton:function(){this.dispatchEvent("onSavedWithSendButton",[this])},_onShowUserPictureRequest:function(){this.container.removeClassName("st-hide-user")},_onHideUserPictureRequest:function(){(this.container.getSize&&this.container.getSize().width)<=319&&this.container.addClassName("st-hide-user")},_onCommentCreateSuccess:function(t){this.dispatchEvent("onCommentCreateSuccess",t)},getCommentEditor:function(){return this.components.get("commentEditor")},focus:function(){var t=this.getCommentEditor();return t&&t.focus(),t},onRender:function(){o.reloadUserPictures({el:this.container,swymUrl:this.collection.getSubject().getSharedOptions().getOption("3DSwymUrl")})}})}),define("DS/SocialToolbar/Views/InteractorSmallListView",["UWA/Core","DS/SocialToolbar/Views/BaseCollectionView","DS/SocialToolbar/Views/InteractorSmallView"],function(t,e,n){"use strict";return e.extend({name:"st-interactor-small-list",domEvents:{},_ItemView:n})}),define("DS/SocialToolbar/Views/PreviousCommentsLoaderView",["UWA/Core","DS/UIKIT/Mask","DS/SocialToolbar/Views/BaseView","i18n!DS/SocialToolbar/assets/nls/social-toolbar"],function(t,e,n,o){"use strict";return n.extend({name:"st-previous-comments-loader",domEvents:{"click .st-fake-link":"_onClick"},_masked:!1,_createContent:function(){var t,e,n,i=this.collection,s=i.length,r=this.model instanceof i.model,a=this.model.getCommentsTotalCount(),l=!1;return s<a?((n=a-s)<=(e=i.getDefaultPageSize())?l=!0:n=e,t={tag:"span",class:"st-fake-link",html:1===n?r?o.get("ViewFirstReply"):o.get("ViewFirstComment"):(!0===l?r?o.get("ViewFirstNReplies"):o.get("ViewFirstNComments"):r?o.get("ViewPreviousNReplies"):o.get("ViewPreviousNComments")).format(n)}):t=null,t},_onClick:function(){var t=this,e=this.collection;!0!==this._masked&&(this.mask(),e.loadPreviousComments(e.getDefaultPageSize(),{onComplete:function(){t.unmask()},onFailure:function(){t.unmask()}}))},init:function(t){this._parent.apply(this,arguments),this.listenTo(this.collection,{onCollectionChange:this.render}),this.listenTo(this.model,{"onChange:nbEndorses":this.render})},mask:function(){this._masked=!0,this.container&&e.mask(this.container,"")},unmask:function(){this._masked=!1,this.container&&e.unmask(this.container)}})}),define("DS/SocialToolbar/Views/InteractorTooltipView",["UWA/Core","DS/UIKIT/Mask","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Views/InteractorSmallListView","i18n!DS/SocialToolbar/assets/nls/social-toolbar"],function(t,e,n,o,i){"use strict";return n.extend({_masked:!1,name:"st-interactor-tooltip-view",defaultOptions:{tooltipLimit:10},domEvents:{},_showLoadingSpinner:function(t){t&&this.collection!==t||this.mask()},_hideLoadingSpinner:function(t){t&&this.collection!==t||this.unmask()},_createContent:function(){var t=this,e=this.collection,n=[this.components.reset({interactorSmallList:new o({collection:e,filterer:function(e){return this.collection.indexOf(e)<t.options.tooltipLimit}})}).interactorSmallList];return this.options.tooltipLimit<this.collection.getTotalRecords()&&n.push({tag:"span",html:i.andMore}),n},init:function(t){this._parent.apply(this,arguments),this.listenTo(this.collection,{"onChange:totalRecordsState":this.render,onCollectionChange:this.render,onRequest:this._showLoadingSpinner,onSync:this._hideLoadingSpinner,onError:this._hideLoadingSpinner})},render:function(){return this.dispatchEvent("onBeforeRender",[this]),this._parent.apply(this,arguments)},mask:function(){this._masked=!0,this.container&&e.mask(this.container,"")},unmask:function(){this._masked=!1,this.container&&e.unmask(this.container)},onBeforeRender:function(){this.collection.hasBeenFetched()||this._showLoadingSpinner()}})}),define("DS/SocialToolbar/Views/CountView",["UWA/Core","UWA/Utils/Client","DS/Logger/Logger","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Views/InteractorTooltipView","i18n!DS/SocialToolbar/assets/nls/social-toolbar","DS/UIKIT/Tooltip","DS/UIKIT/SuperModal","DS/UIKIT/Input/Button"],function(t,e,n,o,i,s,r,a,l){"use strict";var c=null,d=a.extend({defaultOptions:{className:"st-interactor-modal"},destroy:function(){var e,n,o=this.modals;if(o){if(e=o.current,t.is(o.queue,"array")){for(var i=o.queue.length-1;i>=0;i--)(n=o.queue[i])&&n.elements&&n.elements.container&&n.elements.container.hasClassName("st-interactor-modal")&&n.destroy();o.queue=[]}if(e)try{o.current=null,e&&e.elements&&e.elements.container&&e.elements.container.hasClassName("st-interactor-modal")&&e.destroy()}catch(t){}}return this}});return o.extend({tagName:"span",name:"st-count",className:"st-counter",domEvents:{"click .st-counter-value":"onClick"},defaultOptions:{modalTitle:"",interactorCountAtInit:10},_getCount:function(){},_createContent:function(){var e=this._getCount(),n=t.is(e,"number")?String(e):"";return this.elements.counterValue?this.elements.counterValue.setContent(n):this.elements.counterValue=t.createElement("span",{class:"st-counter-value",html:n}),this.elements.counterValue},_showModal:function(){var t=this.components.get("modal"),e=this.collection.getSubject().getSharedOptions(),o=new c({collection:this.collection,events:{onInfiniteScroll:function(){var t,e=this,o=this.collection;function i(){e.scrollView&&(e.scrollView.endLoading(),e.scrollView.useInfiniteScroll(!1))}t={reset:!1,add:!0,remove:!1,onComplete:function(){if(e.scrollView){e.scrollView.endLoading();try{o.hasNextPage()?e.scrollView.useInfiniteScroll(!0):e.scrollView.useInfiniteScroll(!1)}catch(t){n.error("Something went wrong...")}}},onFailure:i},o.hasBeenFetched()||0!==o.length?o.hasNextPage()?o.getNextPage(t):i():o.getFirstPage(t)}}});o.render(),this.components.addMap({interactorListViewWithScroller:o}),t||((t=new d({renderTo:window.widget&&window.widget.body||document.body})).addEvent("onHide",function(){this.getOption("interactorListViewWithScroller").destroy()}),this.components.addMap({modal:t})),t.setOption("interactorListViewWithScroller",o),o.container.addEvent("click *[data-login]",function(n){e.dispatchEvent("onUserLinkClick",n),t.next()}),t.dialog({title:this.getOption("modalTitle"),body:o})},init:function(t){if(this._parent.apply(this,arguments),!this.getOption("modalTitle"))throw new Error("Modal title is required")},onBeforeRender:function(){this.components.get("modal")&&this.components.get("modal").next()},onRender:function(){var t,n;this._getCount()?this.container.addClassName("not-zero"):this.container.removeClassName("not-zero"),e.Features.touchEvents||this.components.get("tooltip")||(n=new i({model:this.model,collection:this.collection,tooltipLimit:this.getOption("interactorCountAtInit")}),this.components.addMap({interactorTooltipView:n}),t=new r({target:this.elements.counterValue,position:"bottom",className:"st-interactor-tooltip",body:n,offset:{x:0,y:5},interactorTooltipView:n,events:{onShow:this.onTooltipShow.bind(this)}}),this.components.addMap({tooltip:t}),t.getContent().addEvent("resize",t.updatePosition.bind(t,"bottom")))},onTooltipShow:function(){var t=this.collection;t&&(t.hasBeenFetched()||t.isBeingFetched())||t.setPageSize(this.getOption("interactorCountAtInit"),{first:!0})},onClick:function(){var t=this;c?this._showModal():require(["DS/W3DXComponents/Views/Layout/NestedScrollView","DS/SocialToolbar/Views/InteractorListView"],function(e,n){c=e.extend({name:"st-interactor-list-scroll",nested:n}),t._showModal()})}})}),define("DS/SocialToolbar/Views/CommentCountView",["UWA/Core","DS/SocialToolbar/Views/CountView","i18n!DS/SocialToolbar/assets/nls/social-toolbar"],function(t,e,n){"use strict";return e.extend({name:"st-comment-count",defaultOptions:{modalTitle:n.get("PeopleWhoCommentedThis")},_getCount:function(){return this.model.getCommentsTotalCount()},init:function(t){var e={};this._parent.apply(this,arguments),e["onChange:"+this.model.COMMENTS_COUNT_ATTRIBUTE]=this.render,this.listenTo(this.model,e)}})}),define("DS/SocialToolbar/Views/EndorserCountView",["UWA/Core","DS/SocialToolbar/Views/CountView","i18n!DS/SocialToolbar/assets/nls/social-toolbar"],function(t,e,n){"use strict";return e.extend({name:"st-endorser-count",defaultOptions:{modalTitle:n.get("PeopleWhoEndorseThis")},_getCount:function(){return this.collection.getTotalRecords()},init:function(t){this._parent.apply(this,arguments),this.listenTo(this.collection,{"onChange:totalRecordsState":this.render})}})}),define("DS/SocialToolbar/Views/ActionToolbarView",["UWA/Core","UWA/Utils/Client","DS/UIKIT/Input/Button","DS/SocialToolbar/Controls/ResponsiveButtonTooltip","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Views/CommentCountView","DS/SocialToolbar/Views/EndorserCountView","DS/SocialToolbar/Models/Endorsement","DS/SocialToolbar/Models/Subject","i18n!DS/SocialToolbar/assets/nls/social-toolbar"],function(t,e,n,o,i,s,r,a,l,c){"use strict";return i.extend({_ignoreEndorseBtnClick:!1,_lightMode:!1,name:"st-action-toolbar",getClassNames:function(){return this._parent.apply(this,arguments)+" st-small-size"},domEvents:{resize:"_onResize","click .st-endorse-btn":"_onEndorseButtonClick","click .st-reply-btn":"_onCommentButtonClick"},defaultOptions:{mode:"normal",enableShare:!0,enableComment:!0,enableLike:!0},_onResize:function(){var t;this.container&&((t=this.container.getSize()).width<300?(this.container.addClassName("st-ultra-small-size"),this.container.removeClassName("st-small-size")):t.width<500?(this.container.addClassName("st-small-size"),this.container.removeClassName("st-ultra-small-size")):(this.container.removeClassName("st-ultra-small-size"),this.container.removeClassName("st-small-size")))},_onEndorseButtonClick:function(){if(!0!==this._ignoreEndorseBtnClick){var t=this.model;t.isEndorsed()?t.unendorse(t instanceof l?c.SorryTheContentCouldNotBeUnendorsed:c.SorryTheCommentCouldNotBeUnendorsed):t.endorse(t instanceof l?c.SorryTheContentCouldNotBeEndorsed:c.SorryTheCommentCouldNotBeEndorsed),this.dispatchEvent("onEndorseButtonClick")}},_onCommentButtonClick:function(t){t&&(t.preventDefault(),t.stopPropagation()),this.dispatchEvent("onCommentButtonClick")},_getCustomNls:function(e,n){var o,i=this.model;return i&&(o=(i instanceof l?i:i.getSubject()).getSharedOptions().getOption(e),t.is(o,"string"))?o:n},_getEndorseNls:function(){return this._getCustomNls("endorseNls",c.Endorse)},_getUnendorseNls:function(){return this._getCustomNls("unendorseNls",c.Unendorse)},_createLightActionSection:function(){var t,e,n=[],o=this.model,i=parseInt(o.get("nbReplies"));return!0===this.getOption("enableLike")&&(t=parseInt(o.getEndorsementsTotalCount()),n.push({tag:"span",class:"st-endorse-btn st-fake-link",html:o.isEndorsed()?this._getUnendorseNls():this._getEndorseNls()}),t>0&&((e=new r({model:this.model,collection:this.model.getEndorsers(),modalTitle:c.get("PeopleWhoEndorseThisComment")})).container.addClassName("st-fake-link st-detail-with-separator"),this.components.addMap({endorserCountView:e}),n.push(e)),n.push({tag:"span",class:"st-detail",html:" - "})),n.push({tag:"span",class:"st-reply-btn st-fake-link",html:c.Reply}),i>0&&n.push({tag:"span",class:"st-detail st-detail-with-separator",html:i}),n},_getCounter:function(e){return t.is(e,"number")?String(e):"&nbsp;"},_createContent:function(){var t,i,a=this,l=this.model,d={},u={},h={},m=null,p=null;return!0===this._lightMode?this._createLightActionSection():(t=l.isEndorsed(),!1!==this.getOption("enableComment")&&(u["comment-button"]=new n({icon:"comment",className:"default st-reply-btn",value:c.Comment}),p=new s({model:this.model,collection:this.model.getCommenters()}),d.commentCountView=p,e.Features.touchEvents||(h.commentBtnTooltip=new o({target:u["comment-button"].getContent(),position:"bottom",body:c.Comment,offset:{x:0,y:5}}))),!1!==this.getOption("enableShare")&&(u["share-button"]=new n({icon:"forward",className:"default st-share-btn",value:c.Share,events:{onClick:function(){a.dispatchEvent("onShareButtonClick")}}}),e.Features.touchEvents||(h.shareBtnTooltip=new o({target:u["share-button"].getContent(),position:"bottom",body:c.Share,offset:{x:0,y:5}}))),!1!==this.getOption("enableLike")&&(i=t?this._getUnendorseNls():this._getEndorseNls(),u["endorse-button"]=new n({icon:"thumbs-up",className:"default st-endorse-btn"+(t?" st-highlighted":"")+(this._ignoreEndorseBtnClick?" st-ignore-clicks":""),value:i}),m=new r({model:this.model,collection:this.model.getEndorsers()}),d.endorserCountView=m,e.Features.touchEvents||(h.endorseBtnTooltip=new o({target:u["endorse-button"].getContent(),position:"bottom",body:i,offset:{x:0,y:5}}))),this.components.reset(u),this.components.addMap(d),e.Features.touchEvents||this.components.addMap(h),{class:"st-action-toolbar-buttons",html:[u["endorse-button"]?{class:"st-btn-wrapper st-endorse-btn-wrapper",html:[u["endorse-button"],m]}:null,p?{class:"st-btn-wrapper st-reply-btn-wrapper",html:[u["comment-button"],p]}:null,u["share-button"]?{class:"st-btn-wrapper st-share-btn-wrapper",html:u["share-button"]}:null]})},_startIgnoringEndorseBtnClick:function(){var t=this.getElement(".st-endorse-btn");t&&(t.addClassName("st-ignore-clicks"),t.match("button")&&(t.disabled=!0)),this._ignoreEndorseBtnClick=!0},_stopIgnoringEndorseBtnClick:function(){var t=this.getElement(".st-endorse-btn");t&&(t.removeClassName("st-ignore-clicks"),t.match("button")&&(t.disabled=!1)),this._ignoreEndorseBtnClick=!1},_updateEndorseButton:function(t){var e=this.model.isEndorsed(),n=!0===this._lightMode?this.getElement(".st-endorse-btn"):this.components.get("endorse-button"),o=!0===this._lightMode?null:this.components.get("endorseBtnTooltip");t&&!1===t.stopIgnoringEndorseBtnClick||this._stopIgnoringEndorseBtnClick(),n&&(!0===this._lightMode?n.setContent(e?this._getUnendorseNls():this._getEndorseNls()):e?(n.setValue(this._getUnendorseNls()),n.getContent().addClassName("st-highlighted"),o&&o.setBody(this._getUnendorseNls())):(n.setValue(this._getEndorseNls()),n.getContent().removeClassName("st-highlighted"),o&&o.setBody(this._getEndorseNls())))},_updateDisplayedInfo:function(){!0===this._lightMode&&this.render()},init:function(){this._parent.apply(this,arguments);var t,e=this.model;if(!e)throw new Error("Model is required.");t={"onChange:_endorsedByCurrentUser":this._updateEndorseButton.bind(this,{stopIgnoringEndorseBtnClick:!1}),onBeforeEndorse:this._startIgnoringEndorseBtnClick,onAfterEndorse:this._stopIgnoringEndorseBtnClick,onBeforeUnendorse:this._startIgnoringEndorseBtnClick,onAfterUnendorse:this._stopIgnoringEndorseBtnClick,onEndorseSuccess:this._onEndorseSuccess,onUnendorseSuccess:this._onUnendorseSuccess},e instanceof l?e.hasBeenPopulated()||(t.onPopulate=this._updateEndorseButton,this._startIgnoringEndorseBtnClick()):(this._lightMode=!0,this.container.addClassName("st-light"),t["onChange:nbEndorses"]=t["onChange:nbReplies"]=this._updateDisplayedInfo),this.listenTo(e,t)},_onEndorseSuccess:function(t){this.dispatchEvent("onEndorseSuccess",t)},_onUnendorseSuccess:function(t){this.dispatchEvent("onUnendorseSuccess",t)},getTotalNumberOfLikes:function(){return this.model.getEndorsementsTotalCount()},disableCommentButton:function(){var t=this.components.get("comment-button");t&&t.disable()},enableCommentButton:function(){var t=this.components.get("comment-button");t&&t.enable()}})}),define("DS/SocialToolbar/Views/CommentView",["UWA/Core","UWA/Array","UWA/Utils/Client","DS/SocialToolbar/Utils/Sprite","DS/SocialToolbar/Utils/Date","DS/SocialToolbar/Views/CommentEditorView","DS/SocialToolbar/Views/ActionToolbarView","DS/SocialToolbar/Views/BaseCommentMediaListWrapperView","i18n!DS/SocialToolbar/assets/nls/social-toolbar","DS/UIKIT/DropdownMenu","DS/UIKIT/SuperModal","DS/UIKIT/Tooltip"],function(t,e,n,o,i,s,r,a,l,c,d,u){"use strict";var h=null;require(["DS/SocialToolbar/Views/CommentZoneView"],function(t){h=t});var m={edit:{name:"edit",text:l.Edit,fonticon:"pencil"},delete:{name:"delete",text:l.Delete,fonticon:"trash"},_loading:{name:"_loading",text:l.get("Loading"),disabled:!0},_noAvailableAction:{name:"_noAvailableAction",text:l.get("NoAvailableAction"),disabled:!0},_errorLoadingActions:{name:"_errorLoadingActions",text:l.get("ErrorLoadingActions"),disabled:!0}},p=function(e){if(m[e])return t.clone(m[e],!1);throw new Error('Menu item "'+e+'" is not supported!')},g=c.extend({show:function(){return this.items&&0===this.items.length&&this.addItem(p("_loading")),this._parent.apply(this,arguments)}}),f=["edit","delete"];return a.extend({_editMode:!1,_expandedReplies:!1,_commentExpanded:!1,_showSummary:!0,name:"st-comment",domEvents:{"click .st-comment-main-section > .st-comment-main-section-footer > .st-show-replies .st-fake-link":"_onShowRepliesButtonClick","click > .st-comment-main-section > .st-comment-main-section-body .st-msg":"_exitSummaryMode",resize:"_checkMessageHeight"},init:function(){var t;this._parent.apply(this,arguments),this.model&&((t={"onChange:richMessage":this._onRichMessageChange,"onChange:modificationDate":this._onModificationDateChange,"onChange:accessState":this.updateMainSection,"onChange:moderationState":this.updateMainSection,onRequest:this._hideActionButtons,onSync:this._showActionButtons,onError:this._showActionButtons})["onChange:"+this.model.COMMENTS_COUNT_ATTRIBUTE]=this._updateShowRepliesSection,t["onChange:"+this.model.idAttribute]=this._handleActionToolbarVisibility,this.listenTo(this.model,t),this._handleActionToolbarVisibility(),this._updateShowSummaryProperty(!this.model.get("parentCommentUri")&&this.getTopLevelComponent().getOption("showCommentsSummaryFirst"))),this.listenTo(this.components,{onCommentSaved:this._onCommentSaved,onCommentSaveFailure:this._onCommentSaveFailure,onCancelEdition:this._onCancelEdition,onCommentButtonClick:this._onReplyButtonClick,onCommentEditSuccess:this._onCommentEditSuccess,onShowUserPictureRequest:this._onShowUserPictureRequest,onHideUserPictureRequest:this._onHideUserPictureRequest,onSavedWithSendButton:this._onSavedWithSendButton,onSavedWithCtrlEnterKey:this._onSavedWithCtrlEnterKey})},_onSavedWithCtrlEnterKey:function(){this.dispatchEvent("onSavedWithCtrlEnterKey",[this])},_onSavedWithSendButton:function(){this.dispatchEvent("onSavedWithSendButton",[this])},_onShowUserPictureRequest:function(){this.container.removeClassName("st-hide-user")},_onHideUserPictureRequest:function(){(this.container.getSize&&this.container.getSize().width)<=319&&this.container.addClassName("st-hide-user")},_onCommentEditSuccess:function(t){this.dispatchEvent("onCommentEditSuccess",t)},_handleSummaryMode:function(){this.container&&(!0===this._showSummary?this.container.addClassName("st-summary-mode"):this.container.removeClassName("st-summary-mode"))},_updateShowSummaryProperty:function(t){this._showSummary=!0===t,this._handleSummaryMode()},_exitSummaryMode:function(){this._showSummary&&(this._commentExpanded=!0,this._updateShowSummaryProperty(!1))},_checkMessageHeight:function(){this.container&&(this._showSummary&&this.elements&&this.elements.commentMessage&&this.elements.commentMessage.scrollHeight>Math.ceil(parseFloat(this.elements.commentMessage.clientHeight))?this.container.addClassName("st-overflowing-content"):this.container.removeClassName("st-overflowing-content"))},_handleActionToolbarVisibility:function(){this.model.isNew()?this.container.addClassName("st-hidden-action-toolbar"):this.container.removeClassName("st-hidden-action-toolbar")},_hideActionButtons:function(){this.container.addClassName("st-hidden-action-buttons")},_showActionButtons:function(){this.container.removeClassName("st-hidden-action-buttons")},_handleRepliesDisplay:function(){var t,e,n=this.model.getComments(),o=parseInt(this.model.get("nbReplies"),10),i=this.elements.showRepliesSection;i&&(t=i.getElement(".st-fake-link"),e=i.getElement(".fonticon"),t&&t.setContent(!0===this._expandedReplies?l.HideReplies:l.ShowReplies),e&&(!0===this._expandedReplies?(e.removeClassName("fonticon-right-open-big"),e.addClassName("fonticon-down-open-big")):(e.removeClassName("fonticon-down-open-big"),e.addClassName("fonticon-right-open-big")))),!0===this._expandedReplies&&o>0&&n.length<o&&!n.isBeingFetched()&&!n.hasBeenFetched()&&n.getFirstPage()},_onShowRepliesButtonClick:function(){this._expandedReplies=!this._expandedReplies,this._handleRepliesDisplay(),!0===this._expandedReplies?this._showRepliesAndReplyCreator(!1):this._hideRepliesAndReplyCreator()},_onReplyButtonClick:function(){this.model.get("parentCommentUri")||(this._expandedReplies=!0,this._handleRepliesDisplay(),this._showRepliesAndReplyCreator(!0)),this.dispatchEvent("onReplyButtonClick",[this])},_showRepliesAndReplyCreator:function(t,e){var o=this,i=function(i){if(!o.isDestroyed()){var s,r,a=o.components.get("commentZone");a?s=a.getCommentCreator():(a=new i({model:o.model,parentComment:o.model,collection:o.model.getComments(),commentToScrollTo:e&&e.commentToScrollTo}),o.components.addMap({commentZone:a}),a.inject(o.getElement(".st-comment-main-section-footer"),"bottom"),s=a.getCommentCreator()),r=s.getCommentEditor(),s.show(),a.show(),r.updateEditorContentWhenRteIsReady(),n.Platform.ios&&!0===t&&r.isInPage()&&s.focus(),r.executeWhenRteIsReady(function(){!0===t&&r.placeCursorAt(),o.dispatchEvent("onShowRepliesAndReplyCreator",[this])})}};this.removeEvent("onShowRepliesAndReplyCreator",this._hideRepliesAndReplyCreator),h?i(h):require(["DS/SocialToolbar/Views/CommentZoneView"],i)},_hideRepliesAndReplyCreator:function(t){var e=this.components.get("commentZone");e?e.hide():this.addEventOnce("onShowRepliesAndReplyCreator",this._hideRepliesAndReplyCreator)},_getDropDownMenuItemFromActionList:function(t){return t.map(function(t){return p(t)},this)},_createDropDownMenu:function(n,o){var i=this,s=this._getDropDownMenuItemFromActionList(o);return this.components.addMap({dropdownMenu:new g({className:"st-comment-actions-dropdown",target:n,items:s,events:{onClick:function(t,e){switch(e.name){case"edit":i.enterEditMode();break;case"delete":i.deleteComment()}},onShow:function(){var n=this,o=i.model&&i.model.collection,s=function(t){var e=n.items&&1===n.items.length;n.removeItem("_loading"),n.removeItem("_noAvailableAction"),n.removeItem("_errorLoadingActions"),e&&t&&t.replacementItem&&n.items&&0===n.items.length&&n.addItem(t.replacementItem)},r=function(t){var o=[];!0===t?(f.forEach(function(t){e.detect(n.items,function(e){return e.name===t})||o.push(t)}),o.length>0&&n.addItem(i._getDropDownMenuItemFromActionList(o)),s()):s({replacementItem:p("_noAvailableAction")}),n.updatePosition()};o&&!t.is(i._hasUserEditionRight(),"boolean")?o.getCommentModerationRights({onComplete:function(t){r(t)},onFailure:function(){s({replacementItem:p("_errorLoadingActions")})}}):r(i._hasUserEditionRight())}}})})},_createShowRepliesSection:function(){var t=this.model,e=parseInt(t.get("nbReplies"),10);return!t.get("parentCommentUri")&&e>0?[{tag:"span",class:"fonticon fonticon-"+(!0===this._expandedReplies?"down-open-big":"right-open-big")},{tag:"span",class:"st-fake-link",html:!0===this._expandedReplies?l.HideReplies:l.ShowReplies}]:null},_updateShowRepliesSection:function(){this.elements.showRepliesSection&&this.elements.showRepliesSection.setContent(this._createShowRepliesSection())},_getModerationMessage:function(){var t=this.model;switch(t.getModerationState()){case t.MODERATION_STATE_FOR_UI.EDITED_BY_AUTHOR:return l.edited;case t.MODERATION_STATE_FOR_UI.EDITED_BY_ADMIN:return l.moderated;default:return""}},_getModerationMessageForTooltip:function(){var t=this.model;switch(t.getModerationState()){case t.MODERATION_STATE_FOR_UI.EDITED_BY_AUTHOR:return l.EditedOnAGivenDate;case t.MODERATION_STATE_FOR_UI.EDITED_BY_ADMIN:return l.ModeratedOnAGivenDate;default:return""}},_getMessageToDisplay:function(){return this.model.get("richMessage")},_getMessageDeleted:function(){return l.ThisCommentHasBeenDeleted},_hasUserEditionRight:function(){return this.model.canBeModerated()},_shouldFooterBeShown:function(){return!this.model.hasBeenDeleted()},_shouldActionMenuBeCreated:function(){return!1!==this._hasUserEditionRight()},_shouldCommentHeaderBeShown:function(){return!0},_createMainSection:function(){var e=this.model,n=e.getAuthor(),o=this._hasUserEditionRight(),i=this._shouldActionMenuBeCreated(),s=e.hasBeenDeleted(),r=this._getCreationDate(),a=this._getModerationMessage(),c=a?t.createElement("span",{class:"st-detail st-moderation-status",html:"- "+a}):null,d=i?t.createElement("span",{class:"fonticon fonticon-down-open-big"}):"";return i&&(this._createDropDownMenu(d,!0===o?f:[]),this.components.addMap({commentMenu:new u({target:d,body:l.Menu,position:"bottom"})})),this._updateModerationTooltip(c),this.elements.commentMessage=t.createElement("div",{class:"st-msg",html:s?{tag:"p",class:"st-comment-deleted",html:this._getMessageDeleted()}:this._getMessageToDisplay()}),{class:"st-comment-main-section",html:[{class:"st-comment-main-section-body",html:[{class:"st-comment-info",html:[!0===this._shouldCommentHeaderBeShown()&&{class:"st-comment-header",html:[{tag:"span",class:"st-fake-link","data-login":n.get("login"),html:n.getFullName().escapeHTML()},r?{tag:"span",class:"st-detail st-date",html:r}:null,c]},this.elements.commentMessage]},{class:"st-comment-actions",html:d}]},{class:"st-media-zone",html:this._getMediaListToDisplay()},this.getTopLevelComponent().getOption("enableReply")&&this._createFooterSection()]}},_createFooterSection:function(){var e=this.model,n=this.components.get("commentZone"),o=new r({model:e,enableLike:this.getTopLevelComponent().getOption("enableCommentLike")});return this.components.addMap({actionToolbar:o}),this.elements.showRepliesSection=t.createElement("div",{class:"st-show-replies",html:this._createShowRepliesSection()}),this._shouldFooterBeShown()?{class:"st-comment-main-section-footer",html:[o,this.elements.showRepliesSection,n]}:null},_renderUserPicture:function(){return o.renderUserPicture({cls:"st-user-picture",format:this.model.get("parentCommentUri")?"mini":"normal",login:this.model.getAuthor().get("login"),swymUrl:this.model.getSubject().getSharedOptions().getOption("3DSwymUrl")})},_createContent:function(){return[this._renderUserPicture(),this._createMainSection()]},_onCommentSaved:function(t){n.Engine.ie&&setTimeout(function(){t.isDestroyed()||t.blur()},50),this.enterViewMode(),this.dispatchEvent("onCommentSaved",[this])},_onCommentSaveFailure:function(t,e){this.enterEditMode(),t.resetEditorContent(e),t.placeCursorAt(),this.dispatchEvent("onCommentSaveFailure",[this])},_onCancelEdition:function(){this.enterViewMode(),this.dispatchEvent("onCancelEdition",[this])},_onRichMessageChange:function(){var t,e=this.getElement(".st-comment-info .st-msg"),n=this.getElement(".st-comment-main-section .st-media-zone");e&&e.setContent(this._getMessageToDisplay()),n&&(t=this._getMediaListToDisplay(),n.setContent(t&&t.container||t))},_getModificationDate:function(){return i.prettyDate(this.model.get("modificationDate"))||""},_getCreationDate:function(){var t=i.prettyDate(this.model.get("creationDate"));return t?"- "+t:""},_updateModerationTooltip:function(t){var e=this._getModificationDate();t&&(e?this.components.addMap({moderationTooltip:new u({target:t,body:l.replace(l.get(this._getModerationMessageForTooltip()),{onAGivenDate:e}),position:"bottom"})}):this.components.remove("moderationTooltip"))},_onModificationDateChange:function(){this._updateModerationTooltip(this.getElement(".st-moderation-status"))},_deleteComment:function(){var t=this.model,e=this.getMediaCollection(),n=t.collection,o=n&&n.indexOf(t),i={accessState:t.get("accessState"),moderationState:t.get("moderationState")},s={accessState:t.ACCESS_STATE.DELETED,moderationState:t.getAuthor().get("login")===t.getSubject().getSharedOptions().getOption("userLogin")?t.MODERATION_STATE.MODERATED_BY_AUTHOR:t.MODERATION_STATE.MODERATED_BY_ADMIN};n&&n.changeTotalRecordsBy(-1),t.destroy({data:s,dataType:"json",onComplete:function(){var o=(n||t).getSubject().getCommenters();t.set(s),o.hasBeenFetched()&&o.getFirstPage(),e&&e.deleteAllAnnotations()},onFailure:function(){o>=0&&(n.changeTotalRecordsBy(1),n.add(t,{at:o})),t.set(i),require(["DS/UWPClientControls/PlatformNotify"],function(t){t.error(l.get("SorryTheCommentCouldNotBeDeleted"))})}})},enterEditMode:function(){var t,e;!0!==this._editMode&&(this.model&&((e=this.model.getSubject().getSharedOptions()).dispatchEvent("onCommentViewEnterEditMode",[this]),this.listenTo(e,"onCommentViewEnterEditMode",this.enterViewMode)),this._editMode=!0,this.container.addClassName("st-edit"),(t=this.components.get("commentEditor"))?t.placeCursorAt():(t=new s({model:this.model,parentComment:this.model.getParentComment(),collection:this.collection,creationMode:!1,showRteOnDOMInjection:!0}),this.components.addMap({commentEditor:t})),t.container.isInjected(this.container)||t.inject(this.getElement(".st-comment-main-section"),"after"),t.dispatchEvent("onEnterEditMode"))},enterViewMode:function(){var t=this.components.get("commentEditor");!0===this._editMode&&(this._editMode=!1,this.container.removeClassName("st-edit"),this.model&&(this.model.getSubject().getSharedOptions().dispatchEvent("onCommentViewEnterViewMode",[this]),this.stopListening(this.model.getSubject().getSharedOptions(),"onCommentViewEnterEditMode",this.enterViewMode)),t.dispatchEvent("onEnterViewMode"))},_getDeleteConfirmationMessage:function(){return l.get("AreYouSureYouWantToDeleteThisComment")},deleteComment:function(){var t=this.components.get("modal");t||(t=new d({className:"",renderTo:document.body}),this.components.addMap({modal:t})),t.confirm(this._getDeleteConfirmationMessage(),l.Confirmation,function(t){!0===t&&this._deleteComment()}.bind(this))},updateMainSection:function(){var e,n=this.getElement(".st-comment-main-section");n&&(e=t.createElement("div",this._createMainSection()),n.hide(),e.inject(n,"before"),n.destroy())},scrollToReply:function(t){this.model.get("parentCommentUri")||(this._expandedReplies=!0,this._handleRepliesDisplay(),this._showRepliesAndReplyCreator(!1,{commentToScrollTo:{commentUri:t}}))},onInjected:function(){var t=this;this._parent.apply(this,arguments),setTimeout(function(){!t.isDestroyed()&&t.model&&o.reloadUserPictures({el:t.container,swymUrl:t.model.getSubject().getSharedOptions().getOption("3DSwymUrl")})},50)}})}),define("DS/SocialToolbar/Views/CommentListView",["UWA/Core","DS/SocialToolbar/Views/BaseCollectionView","DS/SocialToolbar/Views/CommentView","DS/SocialToolbar/Utils/Sprite","i18n!DS/SocialToolbar/assets/nls/social-toolbar"],function(t,e,n,o,i){"use strict";return e.extend({name:"st-comment-list",domEvents:{},defaultOptions:{commentToScrollTo:null},_ItemView:n,_onReplyButtonClick:function(t){return this.dispatchEvent("onReplyButtonClick",[t])},init:function(){if(this._parent.apply(this,arguments),!this.collection)throw new Error("Collection is required");this.listenTo(this.collection,{onCollectionChange:function(){o.reloadUserPictures({el:this.container,swymUrl:this.collection.getSubject().getSharedOptions().getOption("3DSwymUrl")})},onDestroy:this._onCommentDeleteSuccess}),this.listenTo(this.children,{onReplyButtonClick:this._onReplyButtonClick,onCommentEditSuccess:this._onCommentEditSuccess,onSavedWithSendButton:this._onSavedWithSendButton,onSavedWithCtrlEnterKey:this._onSavedWithCtrlEnterKey})},_onSavedWithCtrlEnterKey:function(t){this.dispatchEvent("onSavedWithCtrlEnterKey",t)},_onSavedWithSendButton:function(t){this.dispatchEvent("onSavedWithSendButton",t)},_onCommentEditSuccess:function(t){this.dispatchEvent("onCommentEditSuccess",t)},_onCommentDeleteSuccess:function(t){t&&"comment"===t.name&&this.dispatchEvent("onCommentDeleteSuccess",t)},scrollToComment:function(e,n){var o=this,s=null,r=e.commentUri;r&&!this.isDestroyed()&&(t.is(this.model.getCommentsTotalCount(),"number")&&!this.collection.isBeingFetched()?(s=this.children.find(function(t){return t.model.get("commentUri")===r}))?setTimeout(function(){s.isDestroyed()||(s.container.scrollIntoView(!1),e.replyUri&&!s.model.get("parentCommentUri")?s.scrollToReply(e.replyUri):(s.container.addClassName("st-fade-in-out"),setTimeout(function(){s.container&&s.container.removeClassName("st-fade-in-out")},5e3)))},500):this.model.getCommentsTotalCount()-this.collection.length>0?this.collection.loadPreviousComments(100,{onComplete:function(){o.scrollToComment(e)}}):n&&!0===n.noFetch?require(["DS/UWPClientControls/PlatformNotify"],function(t){t.info(i.get(o.model&&o.collection&&o.collection.getSubject()!==o.model?"TheReplyYouAreLookingForCouldNotBeFoundItMayHaveBeenRemoved":"TheCommentYouAreLookingForCouldNotBeFoundItMayHaveBeenRemoved"))}):(this.collection.reset(),this.collection.loadPreviousComments(100,{onComplete:function(){o.scrollToComment(e,{noFetch:!0})}})):this.collection.addEventOnce("onSync",function(){o.scrollToComment(e,n)}))},onRender:function(){var t=this.options.commentToScrollTo;o.reloadUserPictures({el:this.container,swymUrl:this.collection.getSubject().getSharedOptions().getOption("3DSwymUrl")}),t&&(setTimeout(function(){this.scrollToComment(t)}.bind(this),500),this.options.commentToScrollTo=null)}})}),define("DS/SocialToolbar/Views/CommentZoneView",["UWA/Core","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Views/PreviousCommentsLoaderView","DS/SocialToolbar/Views/CommentListView","DS/SocialToolbar/Views/CommentCreatorView"],function(t,e,n,o,i){"use strict";return e.extend({_lockedDisplay:!1,name:"st-comment-zone",domEvents:{},defaultOptions:{parentComment:null,lockedDisplay:!1,commentToScrollTo:null},_createContent:function(){return this.components.reset({previousCommentsLoader:new n({model:this.model,collection:this.collection}),commentList:new o({model:this.model,collection:this.collection,commentToScrollTo:this.getOption("commentToScrollTo")}),commentCreator:new i({parentComment:this.getOption("parentComment"),collection:this.collection})}),this.components.toArray()},_showLoadingSpinner:function(t){if(!t||this.collection===t){var e=this.components.get("previousCommentsLoader");e&&e.mask()}},_hideLoadingSpinner:function(t){if(!t||this.collection===t){var e=this.components.get("previousCommentsLoader");e&&e.unmask()}},_onReplyButtonClick:function(t){var e,n,o,i=t.model.getAuthor();t.model.get("parentCommentUri")&&(n=this.getCommentCreator(),o=n.getCommentEditor(),n.show(),o.focus(),require(["DS/SocialUserMention/SocialUserMention"],function(t){e=t.getMention({object:{value:i.get("login"),label:i.getFullName()}}),o.resetEditorContent(e),o.placeCursorAt(),o.isInRichMode()&&!o.isRteReady()&&o.addEventOnce("onRteReady",function(){o.isDestroyed()||o.placeCursorAt()})}))},_onCancelEdition:function(t){this.getOption("parentComment")&&t instanceof i&&0===this.collection.length&&t.hide()},init:function(t){if(this._parent.apply(this,arguments),!this.collection)throw new Error("Collection is required");this.listenTo(this.collection,{onRequest:this._showLoadingSpinner,onSync:this._hideLoadingSpinner,onError:this._hideLoadingSpinner}),this.listenTo(this.components,{onReplyButtonClick:this._onReplyButtonClick,onCancelEdition:this._onCancelEdition,onCommentCreateSuccess:this._onCommentCreateSuccess,onCommentEditSuccess:this._onCommentEditSuccess,onCommentDeleteSuccess:this._onCommentDeleteSuccess,onSavedWithSendButton:this._onSavedWithSendButton,onSavedWithCtrlEnterKey:this._onSavedWithCtrlEnterKey}),t&&!0===t.lockedDisplay&&(this._lockedDisplay=!0)},_onSavedWithCtrlEnterKey:function(t){this.dispatchEvent("onSavedWithCtrlEnterKey",t)},_onSavedWithSendButton:function(t){this.dispatchEvent("onSavedWithSendButton",t)},_onCommentCreateSuccess:function(t){this.dispatchEvent("onCommentCreateSuccess",t)},_onCommentEditSuccess:function(t){this.dispatchEvent("onCommentEditSuccess",t)},_onCommentDeleteSuccess:function(t){this.dispatchEvent("onCommentDeleteSuccess",t)},getCommentCreator:function(){return this.components.get("commentCreator")},getTotalNumberOfComments:function(){return this.collection.getTotalRecords()},unlockDisplay:function(){this._lockedDisplay=!1},show:function(){return!0!==this._lockedDisplay&&this._parent.apply(this,arguments),this},onRender:function(){this.options.commentToScrollTo=null,this.collection.isBeingFetched()&&this._showLoadingSpinner()}})}),define("DS/SocialToolbar/SocialToolbar",["UWA/Core","UWA/Event","UWA/Utils/Client","DS/Logger/Logger","DS/SocialToolbar/Utils/SocialToolbarSharedOptions","DS/SocialToolbar/Views/BaseView","DS/SocialToolbar/Views/ActionToolbarView","DS/SocialToolbar/Views/CommentZoneView","DS/SocialToolbar/Models/Subject","DS/SocialToolbar/Utils/Media","DS/SocialToolbar/CallMutualizer","DS/SocialToolbar/Utils/TokenManager","i18n!DS/SocialToolbar/assets/nls/social-toolbar","css!DS/UIKIT/UIKIT","css!DS/SocialToolbar/SocialToolbar"],function(t,e,n,o,i,s,r,a,l,c,d,u,h){"use strict";var m=null,p={};return s.extend({name:"social-toolbar",_successFullInit:!1,_rendered:!1,domEvents:{"click *[data-login]":"_onUserLinkClick","click *[data-users-group-uri]":"_onUsersGroupLinkClick","click .st-media img[data-source]":"_onMediaClick","mouseover .st-media img[data-source]":"_onMediaHover"},defaultOptions:{subjectUri:null,enableShare:!0,enableComment:!0,enableLike:!0,enableReply:!0,enableCommentLike:!1,supportedMedia:{annotation:!1},mode:"normal",showUserProfile:null,commentsNumberAtInit:5,enableUpload:!1,RTEConfig:null,showCommentsSummaryFirst:!0,sendInitCallInPool:!1,sendInitCallEvenIfSubjectIsInCache:!0,commentToScrollToAtInit:null,commentButtonClickEventIsOverrided:!1,showSendButton:!0},_createCommentZone:function(){var t=this.getOption("commentToScrollToAtInit");return this.components.addMap({commentZone:new a({model:this.model,collection:this.model.getComments(),lockedDisplay:this.getOption("mode")===i.MODE.LIGHT&&!t,commentToScrollTo:t&&t.commentUri?{commentUri:t.parentCommentUri||t.commentUri,replyUri:t.parentCommentUri&&t.commentUri}:null})}).commentZone},_createContent:function(){var t=null,e=this;this.getOption("commentToScrollToAtInit");return this.components.reset(this.model?{actionToolbar:new r({model:this.model,mode:this.getOption("mode"),enableShare:this.getOption("enableShare"),enableComment:this.getOption("enableComment"),enableLike:this.getOption("enableLike")})}:null),this.getOption("enableComment")&&(this.components.addMap({errorAlert:new m({closable:!1,closeOnClick:!1,visible:!1,fullWidth:!0,className:"st-error-msg",messageClassName:"primary",messages:[h.get("CommentsAreNotAvailable")],events:{onInjected:function(){!e._successFullInit||e.model&&e.model.hasFailedToFetchContributions()?this.show():this.hide()},onShow:function(){e.container&&e.container.addClassName("st-loading-error")},onHide:function(){e.container&&e.container.removeClassName("st-loading-error")}}})}),this.components.addMap({commentsNotFoundAlert:new m({closable:!1,closeOnClick:!1,visible:!1,fullWidth:!0,className:"st-error-msg",messageClassName:"primary",messages:[h.get("NoCommentFound")],events:{onInjected:function(){!e._successFullInit||e.model&&e.model.hasFailedToFetchContributions()?this.show():this.hide()},onShow:function(){e.container&&e.container.addClassName("st-loading-error")},onHide:function(){e.container&&e.container.removeClassName("st-loading-error")}}})})),this.getOption("enableComment")&&this.model&&this.getOption("mode")!==i.MODE.LIGHT&&((t=this._createCommentZone()).listenTo(this.model,{onContributionsFetchSuccess:t.show,onContributionsFetchFailure:t.hide}),this._successFullInit&&!this.model.hasFailedToFetchContributions()||t.hide()),this.components.toArray()},_applyMode:function(){this.getOption("mode")===i.MODE.LIGHT?this.container.addClassName("st-light"):this.container.removeClassName("st-light"),!0===this.getOption("enableUpload")?this.container.addClassName("st-upload-enabled"):this.container.removeClassName("st-upload-enabled")},_onUserLinkClick:function(t){var n,o=e.getElement(t).getAttribute("data-login");o&&(this.options.showUserProfile?this.options.showUserProfile.call(this,o):(n=this.model.getSharedOptions().getOption("3DSwymUrl"))&&require(["DS/TransientWidget/TransientWidget"],function(t){t.showWidget("X3DPRFL_AP","",{login:o,url:n})}))},_onUsersGroupLinkClick:function(t){var n=this,o=e.getElement(t).getAttribute("data-users-group-uri");o&&require(["DS/i3DXRDFGroupViewer/js/GroupViewer","DS/UWPClientCode/I18n","DS/UIKIT/Modal"],function(t,e,i){var s=new t({language:e.getCurrentLanguage(),groupId:o,platformId:n.getOption("tenantId")});s.render(),n.components.addMap({usersGroupModal:new i({body:s,className:"st-usersgroup-modal"})}).usersGroupModal.show()},function(){console.error("Viewer module is not present on disk!")})},_onMediaClick:function(n){var i=this,s=e.getElement(n),r=s.dataset.source,a=s.dataset.relatedMediaUri,l=s.dataset.uri;t.is(r,"string")&&r&&r!==c.DEFAULT_MEDIA_SOURCE&&l?this.hasEvent("onMediaClick")?this.dispatchEvent("onMediaClick",[{contentUri:l,contentSource:r,relatedMediaUri:a}]):require(["DS/SocialToolbarCustomization/script/source/"+r],function(t){t.getRedirectionUrlFromContentUri({contentUri:l,callback:function(t){window.open(t,"_blank")}})},function(){o.warn("No callback for media from source: ",r)}):t.is(r,"string")&&r&&r===c.DEFAULT_MEDIA_SOURCE&&n&&n.data&&n.data.view&&n.data.view.getDataOnClick&&n.data.view.getDataOnClick().then(function(t){i.model&&i.model.get("subjectUri")&&(t.subjectUri=i.model.get("subjectUri")),i.dispatchEvent("onMediaClick",[t])})},_onMediaHover:function(n){var o=e.getElement(n),i=o.dataset.source,s=o.dataset.uri;t.is(i,"string")&&i&&i!==c.DEFAULT_MEDIA_SOURCE&&s&&!o.hasClassName("st-interactive")&&(this.hasEvent("onMediaClick")?o.addClassName("st-interactive"):require(["DS/SocialToolbarCustomization/script/source/"+i],function(t){"function"==typeof t.getRedirectionUrlFromContentUri&&o.addClassName("st-interactive")},function(){}))},_onContributionsFetchSuccess:function(){if(!this.isDestroyed()){this.dispatchEvent("onPopulate",[this]);var t=this.components.get("actionToolbar"),e=this.components.get("commentZone"),n=this.components.get("errorAlert"),o=this.components.get("commentsNotFoundAlert");t&&t.enableCommentButton(),e&&e.show(),n&&n.hide(),o&&o.hide(),this.dispatchEvent("onSocialToolbarLoaded")}},_onContributionsFetchFailure:function(t){if(!this.isDestroyed()){var e=this.components.get("actionToolbar"),n=this.components.get("commentZone"),o=this.components.get("errorAlert"),i=this.components.get("commentsNotFoundAlert");e&&e.disableCommentButton(),n&&n.hide(),t&&"ContainerNotFoundException"===t.errorcode?i&&i.show():o&&o.show()}},_onCommentButtonClick:function(){var t,e;this.model.hasFailedToFetchContributions()||((t=this.components.get("commentZone"))||this.getOption("mode")!==i.MODE.LIGHT||(t=this._createCommentZone()).inject(this.container,"bottom"),t?(e=this._getCommentCreator(),t.unlockDisplay(),t.show(),e?e.focus():o.warn("Could not put focus on comment creator")):o.warn("Could not show comment zone"))},_getCommentCreator:function(){var t=this.components.get("commentZone");if(t)return t.getCommentCreator();o.warn("Comment zone view could not be found")},getNumberOfComments:function(){var t=this.components.get("commentZone");if(t)return t.getTotalNumberOfComments();o.warn("The comments have not yet been loaded")},getNumberOfLikes:function(){var t=this.components.get("actionToolbar");if(t)return t.getTotalNumberOfLikes();o.warn("The likes have not yet been loaded")},init:function(e){var o;if(e&&(t.is(e.subjectURI)&&!t.is(e.subjectUri)&&(e.subjectUri=e.subjectURI),t.is(e.serviceURL)&&!t.is(e.serviceUrl)&&(e.serviceUrl=e.serviceURL),t.is(e["3DSwymURL"])&&!t.is(e["3DSwymUrl"])&&(e["3DSwymUrl"]=e["3DSwymURL"])),this._parent.call(this,e),!this.getOption("subjectUri"))throw new Error("Subject URI is required");this.getOption("commentProxyToken")&&this.setupToken(this.getOption("commentProxyToken")),this._onContributionsFetchSuccess=this._onContributionsFetchSuccess.bind(this),this._onContributionsFetchFailure=this._onContributionsFetchFailure.bind(this),this.listenTo(this.components,{onCommentButtonClick:function(){!0===this.getOption("commentButtonClickEventIsOverrided")?this.dispatchEvent("onCommentButtonClick",[this]):this._onCommentButtonClick()},onShareButtonClick:function(){this.dispatchEvent("onShareRequest",[this])},onEndorseButtonClick:function(){this.dispatchEvent("onEndorseButtonClick",[this])},onCommentCreateSuccess:function(t){this.dispatchEvent("onCommentCreated")},onCommentEditSuccess:function(t){this.dispatchEvent("onCommentEdited")},onCommentDeleteSuccess:function(t){this.dispatchEvent("onCommentDeleted")},onEndorseSuccess:function(t){t&&"subject"===t.name&&this.dispatchEvent("onSubjectLiked")},onUnendorseSuccess:function(t){t&&"subject"===t.name&&this.dispatchEvent("onSubjectUnliked")},onSavedWithCtrlEnterKey:function(){this.dispatchEvent("onCommentSavedWithCtrlEnterKey")},onSavedWithSendButton:function(){this.dispatchEvent("onCommentSavedWithSendButton")}}),n.Features.touchEvents&&this.container.addClassName("st-touch"),(o=this.getOption("commentToScrollToAtInit"))&&o.commentUri&&this.setOption("mode",i.MODE.NORMAL),this._applyMode()},setupToken:function(t){t.header?u.addToken({serviceUrl:this.getOption("serviceUrl"),header:t.header,value:t.value}):o.error("No CSRF token header provided!")},render:function(){var e,n,s=this,r=function(n){s._successFullInit=!1,e(),t.is(n)&&o.error(n)};return!1===this._rendered&&(this._rendered=!0,e=this._parent.bind(this,arguments),n=new i({"3DSwymUrl":this.options["3DSwymUrl"],"3DSwymServerToken":this.options["3DSwymServerToken"],tenantId:this.options.tenantId,userLogin:this.options.userLogin,userName:this.options.userName,serviceUrl:this.options.serviceUrl,appForcedLinkUri:this.options.appForcedLinkUri}),require(["DS/UIKIT/Alert"],function(t){m=t,n.executeWhenReady(function(){var t,o;s.isDestroyed()||(p[s.getOption("subjectUri")]?(t=p[s.getOption("subjectUri")].subject,s.listenTo(t,{onPopulate:s._onContributionsFetchSuccess,onContributionsFetchFailure:s._onContributionsFetchFailure}),++p[s.getOption("subjectUri")].nbUseCases,o=t.getComments(),!0===s.getOption("sendInitCallEvenIfSubjectIsInCache")||!1===o.hasBeenFetched()||o.length<s.getOption("commentsNumberAtInit")&&o.length<t.getCommentsTotalCount()?t.fetchContributions(s.getOption("commentsNumberAtInit"),s.getOption("sendInitCallInPool"),!0):!0===s.getOption("sendInitCallInPool")&&d.modifyCallWindowSizeBy(-1)):(t=new l({subjectUri:s.getOption("subjectUri")},{sharedOptions:n}),s.listenTo(t,{onPopulate:s._onContributionsFetchSuccess,onContributionsFetchFailure:s._onContributionsFetchFailure}),p[s.getOption("subjectUri")]={subject:t,nbUseCases:1},t.fetchContributions(s.getOption("commentsNumberAtInit"),s.getOption("sendInitCallInPool"))),s._successFullInit=!0,s.model=t,e(),this.options.commentToScrollToAtInit=null,s.listenTo(n,"onUserLinkClick",s._onUserLinkClick))},r)})),this},setActiveFieldContent:function(e){var n,o,i,s;if(!e)throw new Error("Options are missing");if(this.model){if(!0!==this._rendered)throw new Error("Please render the view before using this method");if(!0===this._destroyed)throw new Error("You can't use this instance of SocialToolbar anymore. It has been destroyed");if((!(n=(o=this.model.getSharedOptions()).getLastActiveEditor())||n.isDestroyed()||t.extendElement(n.container)&&("none"===n.container.getStyle("display")||t.equals(n.container.getSize(),{width:0,height:0})))&&(s=this._getCommentCreator())&&(n=s.getCommentEditor()),!n)throw new Error("Something went wrong...");return o.setLastActiveEditor(n),i=e.message,n.updateEditorContentWhenRteIsReady(i,e.media,{replace:!1!==e.replace,allowedContent:"p;br;strong;b;s;u;em;a[href,target]",insertNewLineIfEditorEmpty:!1===e.replace,subjectUri:this.options.subjectURI}),this}this.addEventOnce("onSocialToolbarLoaded",function(){this.setActiveFieldContent(e)})},destroy:function(){var t=this.getOption("subjectUri");return p[t]&&(--p[t].nbUseCases,0===p[t].nbUseCases&&(p[t].subject.clean(),p[t]=null)),this._parent.apply(this,arguments)}})});