/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotControllerForReview/CATDIFAnnotSetLoader",["UWA/Class","DS/DibUDLWebLoader/CATDibUDLWebLoaderForAnnotationSet","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt"],function(t,e,n,i,o){"use strict";return t.extend({init:function(t){this._parent(t);let a=t.context;this.load=function({id:t}){return new Promise(function(l){(new e).getProductIDAssociatedToAnnotationSet({physicalid:t,serverUrl:i.get3DSpaceUrl(),securityContext:o.getSetting("pad_security_ctx"),onComplete:function(e){if(e&&a)if(a.getController().getNode({id:e})){let t=n.giveAnnotationModelLoader({context:a});t&&t.loadFTAModel({idPath:[e]})}else a.addRoots({objects:[{path:[e]}]});let i=window.widget.getValue("xsceneStoredObjects");i&&"string"==typeof i||(i='{"products":{},"filters":{}}'),(i=JSON.parse(i)).difAnnotSet||(i.difAnnotSet={}),i.difAnnotSet[t]={},window.widget.setValue("xsceneStoredObjects",JSON.stringify(i)),require(["DS/PADServices/utils/GlobalModelEvents"],function(e){e.publish({event:"ENXViews/LandingPage/refreshCustom",data:[t]})}),a.getApplicativeData().removeDIFAnnotSetKeepPrd||(a.getApplicativeData().removeDIFAnnotSetKeepPrd=function(t){let e=n.giveAnnotationModelLoader({context:a});e&&e.removeDIFAnnotationSet({id:t})}),l()},onFailure:l})})}}})}),define("DS/CAT3DAnnotControllerForReview/CAT3DAnnotationSectionHideShowController",["require","exports","DS/CAT3DAnnotationController/CAT3DAnnotationController"],function(t,e,n){"use strict";class i{}return i.setSectionVisibilityFlag=function(t,e){let i=n.giveAnnotationController({context:t});i&&i.setSectionVisibleFlag(e)},i}),define("DS/CAT3DAnnotControllerForReview/CAT3DAnnotControllerForReview",["UWA/Class","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/Selection/CSOManager","DS/ApplicationFrame/CommandsManager","DS/PADUtils/views/PADAlert","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","i18n!DS/CAT3DAnnotControllerForReview/assets/nls/CAT3DAnnotControllerForReview"],function(t,e,n,i,o,a,l,r,s,c,A,u,p){"use strict";var g=t.extend({init:function(t){this._parent(t);var g,f,d,C,v,D,h,b,S,m,I,y=this,F="FTA",x=t.ctxViewer,T=!1,E=new e,w=!1,P=!0,O=!1,L=[],V=!1,U=!1,M=!1,R={},k={},B={},N=!0,_=!0,j=!1,q=null;function H(t){for(var e,n=[],i=t.externalPath,o=0;o<i.length;o++)(e=r.getNodeID(i[o]))&&n.push(e);return n}function W(t,e){E.publish({event:t,data:e})}function z(t){w||f||d||!D||!h||h.isRunning()||!g||(t&&t.node&&"tpsAnnotationSet"===t.node.getAnnotationClassType()?W("onApplicativeContextChanged",{id:F}):(S&&clearTimeout(S),S=setTimeout(function(){S=0,w||f||d||!D||!h||h.isRunning()||!g||(P=!1,W("onApplicativeContentChanged",{id:F}),P=!0)})))}function J(t){var e,n={visibleAnnotations:[],annots:[]};if(!t)return n;if("number"==typeof t.version){for(n.visibleAnnotations=t.context.data.slice(),e=0;e<n.visibleAnnotations.length;e++)if(n.visibleAnnotations[e].viewOrCaptureDisplayedID){n.viewOrCaptureDisplayedID=n.visibleAnnotations[e].viewOrCaptureDisplayedID;break}n.annots=t.content&&t.content.annots&&t.content.annots.slice?t.content.annots.slice():[]}else for(n.visibleAnnotations=t.visibleAnnotations.slice(),n.viewOrCaptureDisplayedID=t.viewOrCaptureDisplayedID,n.annots=[],e=0;e<n.visibleAnnotations.length;e++)if(n.visibleAnnotations[e].annotationIDs||n.visibleAnnotations[e].featureIDs){n.annots.push({annotationSetID:n.visibleAnnotations[e].annotationSetID,annotationIDs:n.visibleAnnotations[e].annotationIDs?n.visibleAnnotations[e].annotationIDs:[],featureIDs:n.visibleAnnotations[e].featureIDs?n.visibleAnnotations[e].featureIDs:[]});break}return n}function X(){if(g){if(!h||h&&h.isRunning()||!b)return I&&clearTimeout(I),void(I=setTimeout(function(){I=null,X()},10));var t,e;b&&b.getActiveState()&&j&&b.hideAttributeResultTable();var n=function(){f.cb(),f=null,d&&(f=d,d=null,X())};if(f){var i=f.state,o=function(){var o,a,l,r,s,c,A,u=h.getOrderedAnnotationSetPaths(),p=[],g=[],f=[],d=function(t,e,n,i){var o=t.getLastElement(!0);if(o.getAnnotationClassType){var a=e.indexOf(o.getAnnotationUuid());-1!==a?(e.splice(a,1),o.setVisibility(!0)):"tpsAnnotationSet"!==o.getAnnotationClassType()&&"tpsRoot"!==o.getAnnotationClassType()&&"tpsAttribute"!==o.getAnnotationClassType()&&o.setVisibility(!1),-1!==(a=n.indexOf(o.getAnnotationUuid()))&&(n.splice(a,1),l=t.clone(),p.push(l),g.push({pathElement:l})),-1!==(a=i.indexOf(o.getAnnotationUuid()))&&(i.splice(a,1),l=t.clone(),p.push(l),f.push({pathElement:l}));var r=t.getChildrenPathes();if(r.length)for(var s=0;s<r.length;s++)d(r[s],e,n,i)}};for(t=0;t<u.length;t++){for(o=u[t].annotSetPath.getLastElement(!0),a=!1,r=[],s=[],c=[],e=0;e<i.visibleAnnotations.length;e++)i.visibleAnnotations[e].annotationSetID===o.getAnnotationUuid()&&(a=!0,i.visibleAnnotations[e].displayedIDs&&(c=c.concat(i.visibleAnnotations[e].displayedIDs)),i.visibleAnnotations[e].displayOpts&&(A=i.visibleAnnotations[e].displayOpts));for(e=0;e<i.annots.length;e++)i.annots[e].annotationSetID===o.getAnnotationUuid()&&(a=!0,r=r.concat(i.annots[e].annotationIDs),s=s.concat(i.annots[e].featureIDs));a&&d(u[t].annotSetPath,r||[],s||[],c||[]),o.setVisibility(a)}O=!1,b&&b.getActiveState()&&(O=f&&f.length||b.getDisplayedElementPaths()&&b.getDisplayedElementPaths().length,j&&b.displayAttributeResultTable(p)),A=A?JSON.parse(A):void 0,b.setDisplayedElementPaths(f,A),b.setSelectedElementPaths(g,A),n()},a=function(){D.setSectionVisibleFlag(N),D.displayFTAViewOrCapture({uuid:i.viewOrCaptureDisplayedID,changeViewpoint:!1,changeAnnotationVisibleStates:!1,cb:o})};if(i.visibleAnnotations){var l=function(){var t,e=[];if(h.isRunning())return!1;for(t=0;t<i.visibleAnnotations.length;t++)e.push(i.visibleAnnotations[t].annotationSetID);var n,o=h.getLoadedAnnotationSets();for(t=0;t<o.length;t++)-1!==(n=e.indexOf(o[t].getAnnotationUuid()))&&e.splice(n,1);return 0===e.length};if(l())a();else{for(t=0;t<i.visibleAnnotations.length;t++)i.visibleAnnotations[t].path&&h.loadFTAModel({idPath:i.visibleAnnotations[t].path});var r=0,s=setInterval(function(){l()?(clearInterval(s),a()):++r>=50&&(clearInterval(s),A.displayNotification({eventID:"info",msg:p.errorWhileSettingAppCtx}),n())},100)}}}else n()}}function G(){if(U){b&&b.setControllerEnableFlag(g);var t=l.give3DAnnotBrowserController({context:x});t&&t.setControllerEnableFlag(g),require([].concat(["DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController"]),function(t){var e=t.give3DAnnotFilterController({context:x});e&&e.setControllerEnableFlag(g)})}}this.subscribe=function(t,e){return t&&e?E.subscribe({event:t},e):void 0},this.unsubscribe=function(t){E&&t&&E.unsubscribe(t)},this.setActiveState=function(t){if(g!==t&&x){if(g=t,T){if(U){var e=i.giveFavoriteContextManager({context:x});e&&e.setActivationDropState(g)}if(g)R.onBeginDisplayViewOrCapture||(R.onBeginDisplayViewOrCapture=D.subscribe("onBeginDisplayViewOrCapture",function(){w=!0}),R.onViewOrCaptureDisplayed=D.subscribe("onViewOrCaptureDisplayed",function(){w=!1,f||d||W("onApplicativeContextRequested",{id:F})}),R.onFilteringAndClippingRemoved=D.subscribe("onFilteringAndClippingRemoved",function(t){t&&t.interactiveAction&&(f||d||W("onApplicativeContextChanged",{id:F}))}),R.onDisplayedAnnotationsOrFeaturesChanged=D.subscribe("onDisplayedAnnotationsOrFeaturesChanged",function(){w||f||d||O||W("onApplicativeContextChanged",{id:F}),O=!1}),k.onAnnotationVisibilityModified=h.subscribe("onAnnotationVisibilityModified",z),k.onAnnotationSetLoadedToken=h.subscribe("onAnnotationSetLoaded",function(){!w&&!f&&!d&&D&&h&&g&&W("onApplicativeContextChanged",{id:F})}),B.onCommentSelected=b.subscribe("onCommentSelected",function(t){if(t&&t.path){var e=t.path.getLastElement(!0);e&&e.getAnnotationUuid&&W("onApplicativeContextRequested",{id:F,data:{selectedFeature:e.getAnnotationUuid(),forceDisplay:!0}})}})),V&&U||b.setActiveState(!0),b.allowTableExportInCSV(!1),D.setActiveState(g),h.setActiveState(g&&U?1:g&&!U?2:0),L&&b.updateCommentColumn(L),y.setMinimalUIFlag(!(U&&V)),d&&!f&&(f=d,d=null,X());else{var n,o;if(f=d=null,w=!1,b){for(b.allowTableExportInCSV(!0),n=Object.keys(B),o=0;o<n.length;o++)b.unsubscribe(B[n[o]]);B={},V&&U||b.setActiveState(!1)}if(D){for(n=Object.keys(R),o=0;o<n.length;o++)D.unsubscribe(R[n[o]]);R={},M&&D.saveLastFTAViewOrCaptureDisplayed(!0),D.setActiveState(!1)}if(h){for(n=Object.keys(k),o=0;o<n.length;o++)h.unsubscribe(k[n[o]]);k={},M||h.setActiveState(0)}}W("onApplicativeContextActiveStateModified",{id:F,state:g})}G()}},this.getActiveState=function(){return g},this.setMinimalUIFlag=function(t){t!==j&&(j=t,b&&b.setResultRepresentationModeFlag(j||!V))},this.setAnnotationUIVisibleFlag=function(t){D&&D.setAnnotationUIVisibleFlag(t)},this.getMinimalUIFlag=function(){return j},this.onLeavingApp=function(t){M=t&&"CATA3I_AP"===t.targetApp},this.initializeAppContainer=function(t){U=!!(t&&t.options&&t.options.authoring)&&t.options.authoring,a.getGrantedRoles(function(e){V=!1,e.forEach(function(t){("InternalDS"===t.id||("YED"===t.id||"RED"===t.id||"PAU"===t.id||"DMRMH"===t.id)&&(t.platforms||[]).indexOf(require("DS/PADUtils/PADUtilsServices").getPlatformId())>-1)&&(V=!0)});var a=V?["DS/CAT3DAnnotSemanticController/CAT3DAnnotSemanticContInstance"]:["DS/CAT3DAnnotationExpController/CAT3DAnnotExpControllerInstance"];a.push("DS/CAT3DAnnotationAttributeController/CAT3DAnnotationAttributeController"),require(a,function(e,a){if(C=e,v=a,t.onDataWorkbenchReadyCB({wkb:"3D",file:V?"CAT3DAnnotSemanticControllerForReview.xml":"CAT3DAnnotExpControllerForReview.xml",module:"CAT3DAnnotControllerForReview",cb:G}),t.onPreferencesReadyCB(u.getPreferenceDefinitions({thumbnailPrefs:U,attributePrefs:U&&V,loadingPrefs:U,annotDisplayPrefs:!0,keepSelectedFeaturesPrefs:U,favoriteCtxPrefs:U})),!(h=n.giveAnnotationModelLoader({context:x}))){var l=i.getFavoriteContextManager({context:x});h=n.getAnnotationModelLoader({context:x,favoriteCtxManager:l})}if(!D&&!(D=o.giveAnnotationController({context:x}))){var r=new C({ctxViewer:x,slideShowCtrl:!1});r.disableCtxCommandsAvailability(!U||["CAT3DAnnotationLevelSelectorHdr","RemoveRootHdr"]),o.registerAnnotationController({annotController:r,context:x}),D=o.giveAnnotationController({context:x})}!b&&v&&(b=v.get3DAnnotAttrBrowserController({context:x}));var s=0;q=setInterval(function(){(!V||V&&c.getCommandCheckHeader("CAT3DAnnotationBrowserHdr",x.getCommandContext())||s>=30)&&(clearInterval(q),T=!0,"boolean"==typeof g&&(g=!g,y.setActiveState(!g)),t.onApplicativeControllerInitialized()),s++},100)})})},this.clear=function(){y.setActiveState(!1),m&&(clearInterval(m),m=null),D&&o.unreferenceAnnotationController({context:x}),h&&!M&&(n.unreferenceAnnotationModelLoader({context:x}),i.unreferenceFavoriteContextManager({context:x})),b&&v&&v.unreference3DAnnotAttrBrowserController({context:x}),q&&(clearInterval(q),q=null),T=!1,L.length=0,D=h=b=null,V=!1,C=v=E=x=null},this.updateAppContainer=function({slidesEditableFlag:t,slidesAppData:e}){var n,i,o,a,l={};if(e&&e.length)for(i=0;i<e.length;i++)if(n=J(e[i].state)){if(n.visibleAnnotations&&n.visibleAnnotations.length)for(o=0;o<n.visibleAnnotations.length;o++)if(n.visibleAnnotations[o].displayedIDs)for(a=0;a<n.visibleAnnotations[o].displayedIDs.length;a++)l[n.visibleAnnotations[o].displayedIDs[a]]||(l[n.visibleAnnotations[o].displayedIDs[a]]=0),l[n.visibleAnnotations[o].displayedIDs[a]]++;if(n.annots&&n.annots.length)for(o=0;o<n.annots.length;o++)if(n.annots[o].featureIDs)for(a=0;a<n.annots[o].featureIDs.length;a++)l[n.annots[o].featureIDs[a]]||(l[n.annots[o].featureIDs[a]]=0),l[n.annots[o].featureIDs[a]]++}b&&b.getActiveState()&&(b.forceCommentColumnVisibilityFlag(t),b.updateCommentColumn(l)),L=l},this.displayAppContainerState=function(t){if(t&&"function"==typeof t.callback&&g){var e=J(t.state);if(e)if(T&&!f){f={state:e,cb:t.callback};for(var n=s.get(),i=n.length-1;i>=0;i--)n[i].pathElement.getLastElement(!0).getAnnotationClassType&&s.remove(n[i]);X()}else d={state:e,cb:t.callback};else t.callback()}},this.getCurrentAppContainerState=function(){if(g){var t,e,n={version:0,context:{},content:{}},i=h.getOrderedAnnotationSetPaths();if(i.length){var o,a,l,r,c,A=s.get(),u=[];P&&(u=A.filter(function(t){return"function"==typeof t.pathElement.getLastElement(!0).getAnnotationClassType})),n.context.data=[],n.content.annots=[];var p=D.getFTAViewOrCaptureDisplayed();for(t=0;t<i.length;t++)if((l=i[t].annotSetPath.getLastElement(!0))&&l.isVisible()){var f;(o={}).path=H(i[t].referencePath),o.annotationSetID=l.getAnnotationUuid(),p&&p.getParentPath().getParentPath().getLastElement(!0)===l&&(o.viewOrCaptureDisplayedID=p.getLastElement(!0).getAnnotationUuid()),b.getDisplayedElementsFilteringOpts&&b.getDisplayedElementsFilteringOpts()&&(o.displayOpts=JSON.stringify(b.getDisplayedElementsFilteringOpts()));var d=b.getDisplayedElementPaths();if(d&&d.length)for(o.displayedIDs=[],e=d.length-1;e>=0;e--){for(f=d[e].pathElement.clone();f&&f.getLastElement(!0).getAnnotationClassType&&"tpsAnnotationSet"!==f.getLastElement(!0).getAnnotationClassType();)f=f.getParentPath();f&&f.getLastElement(!0)&&f.getLastElement(!0).getAnnotationClassType&&i[t].annotSetPath.getLastElement(!0)===f.getLastElement(!0)&&d[e].pathElement.getLastElement(!0).getAnnotationUuid()&&o.displayedIDs.push(d[e].pathElement.getLastElement(!0).getAnnotationUuid())}for(n.context.data.push(o),(a={}).annotationSetID=l.getAnnotationUuid(),a.annotationIDs=[],e=0;e<l.children.length;e++)if("RootAttributes"!==(r=l.children[e]).getAnnotationType())for(var C=0;C<r.children.length;C++)(c=r.children[C]).isVisible()&&c.getAnnotationUuid()&&a.annotationIDs.push(c.getAnnotationUuid());for(a.featureIDs=[],e=u.length-1;e>=0;e--){for(f=u[e].pathElement;f&&f.getLastElement(!0).getAnnotationClassType&&"tpsAnnotationSet"!==f.getLastElement(!0).getAnnotationClassType();)f=f.getParentPath();f&&f.getLastElement(!0)&&f.getLastElement(!0).getAnnotationClassType&&i[t].annotSetPath.getLastElement(!0)===f.getLastElement(!0)&&u[e].pathElement.getLastElement(!0).getAnnotationUuid()&&a.featureIDs.push(u[e].pathElement.getLastElement(!0).getAnnotationUuid())}n.content.annots.push(a)}return n}}},this.getCurrentAppContainerStateTitle=function(){var t,e=D.getFTAViewOrCaptureDisplayed();if(e)t=e.getLastElement(!0).getAnnotationName();else{let e=s.get().filter(function(t){return"function"==typeof t.pathElement.getLastElement(!0).getAnnotationName});1===e.length&&(t=e[0].pathElement.getLastElement(!0).getAnnotationName())}return t},this.getFeatureInformation=function(t){let e;if(D&&D.getActiveState())if(t)e=D.getAssociatedInformations([t],!0);else if(b){let t=b.getDisplayedElementPaths();t&&1===t.length&&t[0].pathElement&&(e=D.getAssociatedInformations([t[0].pathElement],!0))}return e&&e.length?e[0]:{}},this.getApplicativeContainerID=function(){return F},this.getOrderedAppContainerStates=function(t,e){var n,i,o,a,l=[],r=D.getFTAViewOrCaptureDisplayed();if(r&&(n=r.getLastElement(!0).getAnnotationUuid()),e&&e.selectedFeature){for(i=0;i<t.length;i++)if(a=J(t[i])){var s=!1;if(a.visibleAnnotations&&a.visibleAnnotations.length)for(o=0;o<a.visibleAnnotations.length;o++)if(a.visibleAnnotations[o].displayedIDs&&-1!==a.visibleAnnotations[o].displayedIDs.indexOf(e.selectedFeature)){l.push(t[i]),s=!0;break}if(!s&&a.annots&&a.annots.length)for(o=0;o<a.annots.length;o++)if(a.annots[o].featureIDs&&-1!==a.annots[o].featureIDs.indexOf(e.selectedFeature)){l.push(t[i]);break}}}else for(i=0;i<t.length;i++)(a=J(t[i]))&&a.viewOrCaptureDisplayedID===n&&l.push(t[i]);return l},this.setAppSectionPlanesVisibleFlag=function(t){N=t},this.getAppSectionPlanesVisibleFlag=function(){return N},this.setAppViewpointManipFlag=function(t){_=t},this.getAppViewpointManipFlag=function(){return _}}}),f=[];return t.singleton({init:function(){},getApplicativeController:function(t){if(t&&t.context){for(var e=!1,n=0;n<f.length;n++)if(f[n].context===t.context){e=!0;break}return e||f.push({context:t.context,controller:new g({ctxViewer:t.context})}),this.giveApplicativeController(t)}},giveApplicativeController:function(t){if(t&&t.context){for(var e,n,i=0;i<f.length;i++)if(f[i].context===t.context){n=f[i],e=n.controller;break}if(e)return Object.freeze({setActiveState:function(t){e&&e.setActiveState(t)},getActiveState:function(){return e?e.getActiveState():null},subscribe:function(t,n){return e?e.subscribe(t,n):void 0},unsubscribe:function(t){e&&e.unsubscribe(t)},initializeAppContainer:function(t){e&&e.initializeAppContainer(t)},updateAppContainer:function(t){e&&e.updateAppContainer(t)},onLeavingApp:function(t){e&&e.onLeavingApp(t)},displayAppContainerState:function(t){e&&e.displayAppContainerState(t)},getCurrentAppContainerState:function(){return e?e.getCurrentAppContainerState():null},getApplicativeContainerID:function(){return e?e.getApplicativeContainerID():null},getOrderedAppContainerStates:function(t,n){return e?e.getOrderedAppContainerStates(t,n):null},getCurrentAppContainerStateTitle:function(){return e?e.getCurrentAppContainerStateTitle():null},setMinimalUIFlag:function(t){e&&e.setMinimalUIFlag(t)},getMinimalUIFlag:function(){return e?e.getMinimalUIFlag():null},setAnnotationUIVisibleFlag:function(t){e&&e.setAnnotationUIVisibleFlag(t)},setAppSectionPlanesVisibleFlag:function(t){e&&e.setAppSectionPlanesVisibleFlag(t)},getAppSectionPlanesVisibleFlag:function(){return e?e.getAppSectionPlanesVisibleFlag():null},setAppViewpointManipFlag:function(t){e&&e.setAppViewpointManipFlag(t)},getAppViewpointManipFlag:function(){return e?e.getAppViewpointManipFlag():null},getFeatureInformation:function(t){return e?e.getFeatureInformation(t):null}})}},unreferenceApplicativeController:function(t){if(t&&t.context)for(var e=0;e<f.length;e++)f[e].context===t.context&&(f[e].controller&&f[e].controller.clear(),f.splice(e,1))}})}),define("DS/CAT3DAnnotControllerForReview/CAT3DAnnotationSwitchOnOffCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/CAT3DAnnotControllerForReview/CAT3DAnnotControllerForReview"],function(t,e,n){"use strict";return t.extend({init:function(t){this._parent(t,{});let i,o=this,a=e.get();var l=this.onStateChange(function(){if(a){var t=n.giveApplicativeController({context:a});t?t.setActiveState(o.getState()):i||(i=setInterval(()=>{(t=n.giveApplicativeController({context:a}))&&(clearInterval(i),i=null,t.setActiveState(o.getState()))},100)),localStorage.setItem("CAT3DAnnotationSwitchOnOffCmd",o.getState()?"true":"false")}});this._destroy=function(){var t=n.giveApplicativeController({context:a});t&&t.setActiveState(!1),i&&clearInterval(i),o._modelEvents.unsubscribe(l),a=i=null},o.setState("true"===localStorage.getItem("CAT3DAnnotationSwitchOnOffCmd"))}})});