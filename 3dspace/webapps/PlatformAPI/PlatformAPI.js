define("DS/PlatformAPI/PlatformAPI",["UWA/Core","DS/MessageBus/MessageBus"],function(e,t){"use strict";function n(e){if(function(e){var t;e=e||parent;try{t=!(!e||!e.document)}catch(e){t=!1}return t}(e=e||parent))return e===e.parent?e:n(e.parent)}var r,i=(r={},function(e){if(!r[e]){var t=n();if(t)try{r[e]=t.require(e)}catch(e){}else try{r[e]=require(e)}catch(e){}}return r[e]});function a(){if("string"!=typeof window.dsDefaultWebappsBaseUrl)throw new Error("Cannot query available services");var e;t.setTrustedOrigins((void 0!==n()?Promise.resolve():(e={},new Promise(function(t,n){require([["DS","UWPClientCode","PublicAPI"].join("/"),["DS","UWPClientCode","I18n"].join("/")],function(r,i){e.myAppsBaseUrl=r.getApplicationConfiguration("app.urls.myapps"),e.myAppsBaseUrl||(r.getAllApplicationConfigurations(!0),e.myAppsBaseUrl=r.getApplicationConfiguration("app.urls.myapps"),e.myAppsBaseUrl||n()),e.lang=i.getCurrentLanguage(),r.getUserAsync({success:function(n){e.userId=n.login,t(e)},failure:n})},n)}))).then(function(e){if(e)window.COMPASS_CONFIG=e;else{var t=i("DS/PlatformAPI/PlatformAPI");if(t&&t._trustedServices)return t._trustedServices}return new Promise(function(e,t){require([["DS","i3DXCompassPlatformServices","i3DXCompassPlatformServices"].join("/")],function(n){n.getPlatformServices({onComplete:function(t){var n=[].concat.apply([],t.map(function(e){return Object.keys(e).map(function(t){return e[t]})})).filter(function(e){return 0===e.indexOf("http")});o._trustedServices=n,e(n)},onFailure:t})},t)})}))}var o={_trustedServices:null,getUser:function(){var t=i("DS/UWPClientCode/PublicAPI");if(t)return e.clone(t.getUser())},getUserProperty:function(t){var n=i("DS/UWPClientCode/PublicAPI");if(n)return e.clone(n.getUserProperty(t))},getTenant:function(){var t=i("DS/Tenant/Tenant");if(t)return e.clone(t.getValue())},setTenant:function(t){var n=i("DS/Tenant/Tenant");if(n)return e.clone(n.setValue(t))},getApplicationConfiguration:function(t){var n=i("DS/UWPClientCode/PublicAPI");if(n)return e.clone(n.getApplicationConfiguration(t))},getAllApplicationConfigurations:function(){var t=i("DS/UWPClientCode/PublicAPI");if(t)return e.clone(t.getAllApplicationConfigurations())},getContextRoles:function(t){var n=i("DS/UWPClientCode/PublicAPI");if(n)return e.clone(n.getContextRoles(t))},setContextRoles:function(t){var n=i("DS/UWPClientCode/PublicAPI");if(n)return e.clone(n.setContextRoles(t))},publish:function(e,n,r){r=r||["web"],"webinwin:web:notification"===e&&(r=["web-in-win"]),r.indexOf("web-in-win")>=0&&t.publish({channel:"Widgets",topic:"webinwin:web:notification",data:n,crossFrame:!0,originalTopic:e}),r.indexOf("web")>=0&&t.publish({channel:"Widgets",topic:e,data:n,crossFrame:!0})},subscribe:function(e,n){return t.subscribe({channel:"Widgets",topic:e,callback:n,crossFrame:!0})},unsubscribe:function(e){e instanceof t.Subscription&&t.unsubscribe(e),t.unsubscribe({channel:"Widgets",topic:e})},setTrustedMessageOrigins:function(e){"services"===e?a():t.setTrustedOrigins(e)},patchWidgetData:function(){var t={},n=1;function r(e){var n=t[e],r=n.widget;r.removeEvent("onPatchDataSuccess-"+e,n.success),r.removeEvent("onPatchDataFailure-"+e,n.failure),delete t[e]}function i(e){if(!Array.isArray(e))throw new Error(e+" should be an array");e.forEach(function(e){if("string"!=typeof e)throw new Error(e+" should be a string")})}function a(e,t){if(e){if(e.multiple||"checklist"===e.type)try{t=function(e){if(!e)return[];var t;if(Array.isArray(e))t=e;else try{t=JSON.parse(e)}catch(t){throw new Error("While parsing JSON value `"+e+"`: "+t)}return i(t),t}(t)}catch(t){throw new Error("While decoding value for preference "+e.name+": "+t)}"boolean"===e.type&&"boolean"!=typeof t&&void 0!==t&&(t="false"!==t&&Boolean(t))}return t}function o(t,n){var r=t.op,o=t.path.substring(1),s=t.value,c=n.environment,u=n._getRawPreference(o);s=a(u,s),"remove"===r?(n.data.hasOwnProperty(o)&&delete n.data[o],c.deleteData?c.deleteData(o):c.setData&&c.setData(o,void 0)):"add"!==r&&"replace"!==r||(s=e.clone(s),n.data[o]=s,c.setData&&c.setData(o,function(e,t){return e&&(e.multiple||"checklist"===e.type)&&(i(t),t=JSON.stringify(t)),t}(u,s),!!u&&e.equals(u.defaultValue,s)))}return function(e){return new Promise(function(i,a){var s=e.widget,c=e.patches;if(!c||!(c||[]).length)return i();if(!s)return a("Missing widget options.");var u=s.environment;if(!u)return a("Missing options.widget.environment.");c.forEach(function(e){o(e,s)});var l=n,f={widget:s,resolve:i,reject:a,success:function(e,n){var i=t[e];i&&(i.resolve(n),r(e))},failure:function(e,n){var i=t[e];i&&(i.reject(n),r(e))}};e._callId=l,t[l]=f,e.widgetId=s.id,s.addEventOnce("onPatchDataSuccess-"+l,f.success),s.addEventOnce("onPatchDataFailure-"+l,f.failure),u.sendRemote?u.sendRemote("onPatchData",e):s.dispatchEvent("onPatchData",e),n++})}}()};try{o.setTrustedMessageOrigins("services")}catch(e){}return o});