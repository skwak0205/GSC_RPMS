define("DS/CAT3DWPhoto/CAT3DWImageView",["DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWMedia/CAT3DWMediaView","DS/CAT3DWVisu/CAT3DWDataFactory","DS/Manipulators/LineTranslationManipulator","DS/Mesh/MeshUtils","DS/Visualization/MaterialApplication","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS"],function(t,e,i,a,n,r,s,o){"use strict";var l=e.extend({init:function(t,e){this._parent(t,e),this._defaultRectangleValue=100,this._width=this._defaultRectangleValue,this._height=this._defaultRectangleValue,this._createRectangle()},_createRectangle:function(){this._rectangle&&this.removeChild(this._rectangle),this._rectangle=s.createRectangleNode({width:-this._width,height:-this._height,fill:!0,cornerPoint:this._getCornerPoint(),noEdge:"whiteboard"===t.getPreferenceValue("appMode"),color:new n.Color(255,255,255,0)}),this._rectangle.setPickingPriorityId(i.getLabelOf(i.SupportTypes.IMAGE)),this.addChild(this._rectangle)},_getCornerPoint:function(){return new o.Vector2},setTexture:function(t){if(!(t.image.originalWidth<=0||t.image.originalHeight<=0||t.image.width<=0||t.image.height<=0)){var e=t.image.width,i=t.image.height;t.image.originalWidth&&t.image.originalHeight&&(e=t.image.originalWidth,i=t.image.originalHeight);var a=this.getDimensions(),n=a.width,s=a.height,o=i/e,l=0,h=0;o>1?(l=this._defaultRectangleValue,h=this._defaultRectangleValue/o):(l=this._defaultRectangleValue*o,h=this._defaultRectangleValue),this.resize(Math.abs(h/n),Math.abs(l/s));var u=this._rectangle.getMaterial("Line")?this._rectangle.getMaterial("Line"):this.getImageBorderMaterial(null);this._rectangle.removeMaterialApplication();var c=new r({faceMaterial:this.getImageMaterial(t,!0),lineMaterial:u});this._rectangle.setMaterialApplication(c),this._viewer.render()}},resize:function(t,e){if(t&&e){var i=this.getMatrix();i.scale(new o.Vector3(t,e,1)),this.setMatrix(i),this._viewer.render(),this._width=this._defaultRectangleValue*t,this._height=this._defaultRectangleValue*e}},setOpacity:function(t){var e=this._rectangle.getMaterial("Face");e&&(e.opacity=t)},getOpacity:function(){var t=this._rectangle.getMaterial("Face");return t?t.opacity:null},setTransparent:function(t){var e=this._rectangle.getMaterial("Face");e&&(e.transparent=t)},setBorderMaterial:function(t){var e=this._rectangle.getMaterial("Face");this._rectangle.removeMaterialApplication();var i=new r({faceMaterial:e,lineMaterial:this.getImageBorderMaterial(t)});this._rectangle.setMaterialApplication(i)},createTranslationManipulator:function(t){this._translationManipulator||(this._translationManipulator=new a({axis:t}))},setManipulator:function(t){t?this._manipulatorLinkToken||(this._manipulatorLinkToken=this._translationManipulator.linkToNode(this),this._manipulatorBPToken=this._translationManipulator.subscribe("BeginPreactivate",this._beginPreactivateCB.bind(this)),this._manipulatorBMToken=this._translationManipulator.subscribe("BeginManipulate",this._beginManipulateCB.bind(this)),this._manipulatorMToken=this._translationManipulator.subscribe("Manipulate",this._manipulateCB.bind(this)),this._manipulatorEMToken=this._translationManipulator.subscribe("EndManipulate",this._endManipulateCB.bind(this)),this._manipulatorEPToken=this._translationManipulator.subscribe("EndPreactivate",this._endPreactivateCB.bind(this))):this._manipulatorLinkToken&&(this._translationManipulator.unlink(this._manipulatorLinkToken),this._manipulatorLinkToken=void 0,this._translationManipulator.unsubscribe(this._manipulatorBPToken),this._translationManipulator.unsubscribe(this._manipulatorBMToken),this._translationManipulator.unsubscribe(this._manipulatorMToken),this._translationManipulator.unsubscribe(this._manipulatorEMToken),this._translationManipulator.unsubscribe(this._manipulatorEPToken))},setImagePickable:function(t){this.setPickable(t?n.PICKABLE:n.NOPICKABLE),this._rectangle.setPickable(t?n.PICKABLE:n.NOPICKABLE)},setDepth:function(t,e){var i=3*t;this._rectangle.setRenderDepth(i),this._rectangle.setPickingPriorityId("imagePriority"+t),this._rectangle.material.transparent=!0,this._rectangle.material.depthTest=!1;var a=this._rectangle.getMaterial("Line");if(a&&(a.transparent=!0,a.depthTest=!1),e)for(var n=0;n<e.length;n++)e[n].node.setRenderDepth(i+e[n].offset),e[n].node.material&&(e[n].node.material.transparent=!0,e[n].node.material.depthTest=!1)},_setPolygonOffset:function(t,e){t.transparent=!0,t.polygonOffset=!0,t.polygonOffsetFactor=-e,t.polygonOffsetUnit=-.1},getDepth:function(){var t=0;return this._rectangle.mesh3js&&this._rectangle.mesh3js.renderDepth&&(t=this._rectangle.mesh3js.renderDepth/3),t},getImageMaterial:function(t,e){var i=new o.MeshBasicMaterial({map:t,force:!0,side:o.DoubleSide});return i.transparent=e,i.color=new o.Color,i.polygonOffset=!0,i.polygonOffsetFactor=.7,i},getImageBorderMaterial:function(t){var e=null;switch(t){case"edition":case"wizard":(e=new o.LineBasicMaterial({color:"#F4F5F6",lineWidth:10,opacity:1,side:o.DoubleSide})).force=!0,e.depthTest=!0;break;case"modeling":(e=new o.LineBasicMaterial({color:"#77797c",lineWidth:1,opacity:1,side:o.DoubleSide})).force=!0,e.depthTest=!0;break;case"placeholder":var i=new Float32Array(2);i[0]=.6,i[1]=.3,(e=new o.LineBasicMaterial({color:"#77797c",lineWidth:1,opacity:1,side:o.DoubleSide,dashPattern:i})).force=!0,e.depthTest=!0;break;case null:default:e=new o.LineBasicMaterial({opacity:0})}return e},getBackgroundImageMaterial:function(){var t=new o.MeshBasicMaterial({color:new o.Color(15856113),force:!0,side:o.DoubleSide});return t.depthTest=!0,t},getNormal:function(){var t=this.getMatrixWorld();return this._getRectangleNormal(t)},getCorners:function(){var t=this.getMatrixWorld();return this._getRectangleCorners(t)},getDimensions:function(){return{width:this._width,height:this._height}},getDefaultRectangleValue:function(){return this._defaultRectangleValue},getScale:function(){return{scaleX:this._defaultRectangleValue/this._media.getWidth(),scaleY:this._defaultRectangleValue/this._media.getHeight()}},getPlan:function(){var t=this.getNormal(),e=new o.Plane(t,0),i=(new o.Vector3).getPositionFromMatrix(this.getMatrix());return e.translate(i),e},getExtremesCorners:function(){var t=this.getCorners(),e=[this._viewer.currentViewpoint.project(t.topLeft),this._viewer.currentViewpoint.project(t.topRight),this._viewer.currentViewpoint.project(t.bottomRight),this._viewer.currentViewpoint.project(t.bottomLeft)],i=this._getExtreme(e),a=this.getPlan();return{topLeft:this._createExtremePoint(i.topLeft,a),topRight:this._createExtremePoint(i.topRight,a),bottomRight:this._createExtremePoint(i.bottomRight,a),bottomLeft:this._createExtremePoint(i.bottomLeft,a)}},_getExtreme:function(t){return{topLeft:{x:Math.min(t[0].x,t[1].x,t[2].x,t[3].x),y:Math.min(t[0].y,t[1].y,t[2].y,t[3].y)},topRight:{x:Math.max(t[0].x,t[1].x,t[2].x,t[3].x),y:Math.min(t[0].y,t[1].y,t[2].y,t[3].y)},bottomRight:{x:Math.max(t[0].x,t[1].x,t[2].x,t[3].x),y:Math.max(t[0].y,t[1].y,t[2].y,t[3].y)},bottomLeft:{x:Math.min(t[0].x,t[1].x,t[2].x,t[3].x),y:Math.max(t[0].y,t[1].y,t[2].y,t[3].y)}}},_createExtremePoint:function(t,e){return this._viewpoint.create3DRayFrom2DPoint(t,this._viewpoint.camera).intersectPlane(e)},_getRectangleNormal:function(t){var e=new o.Vector3,i=new o.Vector3,a=new o.Vector3;return t.extractBasis(e,i,a),a.normalize()},_getRectangleCenter:function(t){var e=this._getRectangleCorners(t),i=(new o.Vector3).addVectors(e.topRight,e.bottomLeft);return i.divideScalar(2),i},_getRectangleCorners:function(t){if(this._rectangle){var e=this._rectangle.mesh3js.geometry[0].vertexPositionArray;return{bottomLeft:new o.Vector3(e[0],e[1],e[2]).applyMatrix4(t),bottomRight:new o.Vector3(e[3],e[4],e[5]).applyMatrix4(t),topLeft:new o.Vector3(e[9],e[10],e[11]).applyMatrix4(t),topRight:new o.Vector3(e[6],e[7],e[8]).applyMatrix4(t)}}var i=new o.Vector3(0,0,0),a=new o.Vector3(-this._defaultRectangleValue,0,0),n=new o.Vector3(0,-this._defaultRectangleValue,0),r=new o.Vector3(-this._defaultRectangleValue,-this._defaultRectangleValue,0);return i.applyMatrix4(t),a.applyMatrix4(t),n.applyMatrix4(t),r.applyMatrix4(t),{bottomLeft:i,bottomRight:a,topLeft:n,topRight:r}},showSelectionNode:function(){this._createSelectionNode(),this._selectionNode.setVisibility(!0)},hideSelectionNode:function(){this._selectionNode&&this._selectionNode.setVisibility(!1)},_createSelectionNode:function(){if(!this._selectionNode){var t=this._rectangle.mesh3js.geometry[0].vertexPositionArray,e=[new o.Vector3(t[0],t[1],t[2]),new o.Vector3(t[3],t[4],t[5]),new o.Vector3(t[6],t[7],t[8]),new o.Vector3(t[9],t[10],t[11])];e[4]=e[0],this._selectionNode=s.createLineNode({points:e}),this._selectionNode.setMatrix(this._rectangle.getMatrix()),this._selectionNode.setPickable(n.NODRAWHL),this._selectionNode.setExcludeFromBounding(!0),this._selectionNode.setMaterialApplication(new r({lineMaterial:this._buildDottedBorderMaterial()})),this.addChild(this._selectionNode)}},_beginPreactivateCB:function(t){return this._parent(t)},_beginManipulateCB:function(t){this._initialMatrix=(new o.Matrix4).copy(t.paths[0].getWorldMatrix())},_manipulateCB:function(t){var e=(new o.Vector3).getPositionFromMatrix(this._initialMatrix);e.add(t.translationVector);var i=(new o.Matrix4).copy(this._initialMatrix);i.setPosition(e),this.setMatrix(i),this._viewer.render({updateInfinitePlane:!0})},_endManipulateCB:function(t){return this._parent(t)},_endPreactivateCB:function(t){return this._parent(t)},getCreationData:function(){var t=this._parent();return t.ratioWidth=this._width/this._defaultRectangleValue,t.ratioHeight=this._height/this._defaultRectangleValue,t.matrix=this.getMatrix(),t},getMoveData:function(){return{matrix:this.getMatrix()}},setMoveData:function(t){this.setMatrix(t.matrix)},getEditData:function(){var t=this._parent();return t.depth=this.getDepth(),t},setEditData:function(t){this._parent(t),t.depth&&this.setDepth(t.depth)},_getSrcWidthHeight:function(){return{ratioWidth:this._width/this._defaultRectangleValue,ratioHeight:this._height/this._defaultRectangleValue}}});return UWA.namespace("DS/CAT3DWPhoto/CAT3DWImageView",l)}),define("DS/CAT3DWPhoto/CAT3DWImageDataService",["UWA/Class"],function(t){"use strict";var e=t.extend({init:function(){this._parent(),this._data={},this._saveData=[]},setValue:function(t,e){return this._data[t]=e,this._data[t]},setValues:function(t){for(var e in t)this.setValue(e,t[e])},getValue:function(t){return this._data[t]},getData:function(){return JSON.parse(JSON.stringify(this._data))},setData:function(t){return this._data=JSON.parse(JSON.stringify(t)),this._data},save:function(){this._saveData.push(JSON.parse(JSON.stringify(this._data)))},forgetChg:function(){this._saveData.length<=0?console.warn("Error during forgetChg : No data has been saved"):this._data=JSON.parse(JSON.stringify(this._saveData.pop()))},clearSave:function(){this._saveData=[]}});return UWA.namespace("DS/CAT3DWPhoto/CAT3DWImageDataService",e)}),define("DS/CAT3DWPhoto/CAT3DWImage",["DS/CAT3DWMedia/CAT3DWMedia","DS/CAT3DWPhoto/CAT3DWImageView","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/CAT3DWInfra/CAT3DWPreferenceManager"],function(t,e,i,a,n,r){"use strict";var s=t.extend({init:function(t){this._parent(t),this._mediaData.setValues({width:0,height:0}),this._texture=null,this._saveTexture=[],this._templates=t.templates,this._bIsTextureLoading=!1,this._queuedTexture={urlOrTexture:null,callback:null}},initialize:function(t){this.setTexture(t.url,t.callback,t.isPlaceHolder)},getType:function(){return"CAT3DWImage"},createMediaView:function(t){return new e(this,t)},getWidth:function(){return this._mediaData.getValue("width")},getHeight:function(){return this._mediaData.getValue("height")},setTextureObj:function(t,e){this.setTexture(t,e)},setTexture:function(t,e,i){var s="";t?s=t:(s=n.getWebappsAssetUrl("CAT3DWPhoto","graphics/G_NXGAddImage.png"),i=!0),this._bIsTextureLoading?(this._queuedTexture.urlOrTexture=s,this._queuedTexture.callback=e,this._queuedTexture.isPlaceHolder=i):(this._bIsTextureLoading=!0,"string"==typeof s?this._texture=a.ImageUtils.loadTexture(s,void 0,this._onTextureLoaded.bind(this,e),this.onLoadImageError,!i&&r.getPreferenceValue("UseCredentials")):"object"==typeof s&&(this._texture=s,this._onTextureLoaded(e)))},onLoadImageError:function(){},removeTexture:function(t){this.setTexture(null,t)},_onTextureLoaded:function(t){if(this._mediaData.setValue("width",this._texture.image.width),this._mediaData.setValue("height",this._texture.image.height),this._mediaView.setTexture(this._texture),i.publish({event:this.getTextureReadyEvent(),data:this}),t&&t(this),this._queuedTexture.urlOrTexture){let t=this._queuedTexture.callback,e=this._queuedTexture.urlOrTexture,i=this._queuedTexture.isPlaceHolder;this._queuedTexture.urlOrTexture=null,this._queuedTexture.callback=null,this._queuedTexture.isPlaceHolder=null,"string"==typeof e?this._texture=a.ImageUtils.loadTexture(e,void 0,this._onTextureLoaded.bind(this,t),this.onLoadImageError,!i&&r.getPreferenceValue("UseCredentials")):"object"==typeof e&&(this._texture=e,this._onTextureLoaded(t))}else this._bIsTextureLoading=!1},getTexture:function(){return this._texture},getTextureClone:function(){var t=this.getTexture().clone();return t.sourceFile=this.getTexture().sourceFile,t},save:function(){this._saveTexture.push(this.getTextureClone()),this._parent()},forgetChg:function(t){this._parent(),this.setTextureObj(this._saveTexture.pop(),function(){this._mediaView.forgetChg(),t&&t()}.bind(this))},clearSavedData:function(){this._saveTexture=[],this._parent()},getTextureReadyEvent:function(){return"CATLSImageTextureReady_"+this._id},getCreationData:function(){var t=this._parent();return t.image=this._texture.sourceFile,t}});return UWA.namespace("DS/CAT3DWPhoto/CAT3DWImage",s)}),define("DS/CAT3DWPhoto/CAT3DWImagesManager",["DS/CAT3DWMedia/CAT3DWMediaManager","DS/CAT3DWPhoto/CAT3DWImage","DS/Visualization/Node3D","DS/CAT3DWInfraUI/CAT3DWCanvasServices","DS/CAT3DWVisu/CAT3DWPickingControllerFactory","WebappsUtils/WebappsUtils","DS/CAT3DWInfra/CAT3DWPreferenceManager","UWA/Data"],function(t,e,i,a,n,r,s,o){"use strict";return t.extend({init:function(){this._parent(),this._templates={}},initialize:function(t){this._parent(t);var e=this._viewer.getRootNode(),l=null;l=t&&t.rootNodeName?t.rootNodeName:n.getRootImageNodeName(),this._rootNode=new i(l),e.addChild(this._rootNode);var h=new a;if(s.getPreferenceValue("M3DEMobile")){var u=o.proxifyUrl(r.getWebappsAssetUrl("CAT3DWPhoto","graphics/G_NXGAddImage_template.png"),{proxy:"passport"});h.loadImage(u,!0,function(t){this._templates.addImage=t}.bind(this))}else h.loadImage(r.getWebappsAssetUrl("CAT3DWPhoto","graphics/G_NXGAddImage_template.png"),!0,function(t){this._templates.addImage=t}.bind(this))},createImageInGroup:function(t,e){return t.templates=this._templates,this._parent(t,e)},createMediaObject:function(t){return new e(t)},reset:function(t){this._parent(t),this._templates.addImage=null,this._templates={}},getResetEvent:function(){return"CAT3DWImagesManagerReset"}})});