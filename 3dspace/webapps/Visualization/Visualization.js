/*!  COPYRIGHT DASSAULT SYSTEMES 2014   */
/*! based on Three.js Copyright Â© 2010-2014 three.js authors */
/*! Uses SMAA. Copyright (C) 2011 by Jorge Jimenez, Jose I. Echevarria,
Belen Masia, Fernando Navarro and Diego Gutierrez. */
var Stats=function(){var e,t,i,r,n,a,s,o,l=0,h=0,c=Date.now(),d=c,u=c,p=0,f=1e3,g=0,m=[[16,16,48],[0,255,255]],v=0,y=1e3,S=0,_=[[16,48,16],[0,255,0]];for((e=document.createElement("div")).style.cursor="pointer",e.style.width="80px",e.style.opacity="0.9",e.style.zIndex="10001",e.addEventListener("mousedown",function(e){e.preventDefault(),0==(l=(l+1)%2)?(i.style.display="block",a.style.display="none"):(i.style.display="none",a.style.display="block")},!1),(i=document.createElement("div")).style.textAlign="left",i.style.lineHeight="1.2em",i.style.backgroundColor="rgb("+Math.floor(m[0][0]/2)+","+Math.floor(m[0][1]/2)+","+Math.floor(m[0][2]/2)+")",i.style.padding="0 0 3px 3px",e.appendChild(i),(r=document.createElement("div")).style.fontFamily="Helvetica, Arial, sans-serif",r.style.fontSize="9px",r.style.color="rgb("+m[1][0]+","+m[1][1]+","+m[1][2]+")",r.style.fontWeight="bold",r.innerHTML="FPS",i.appendChild(r),(n=document.createElement("div")).style.position="relative",n.style.width="74px",n.style.height="30px",n.style.backgroundColor="rgb("+m[1][0]+","+m[1][1]+","+m[1][2]+")",i.appendChild(n);n.children.length<74;)(t=document.createElement("span")).style.width="1px",t.style.height="30px",t.style.cssFloat="left",t.style.backgroundColor="rgb("+m[0][0]+","+m[0][1]+","+m[0][2]+")",n.appendChild(t);for((a=document.createElement("div")).style.textAlign="left",a.style.lineHeight="1.2em",a.style.backgroundColor="rgb("+Math.floor(_[0][0]/2)+","+Math.floor(_[0][1]/2)+","+Math.floor(_[0][2]/2)+")",a.style.padding="0 0 3px 3px",a.style.display="none",e.appendChild(a),(s=document.createElement("div")).style.fontFamily="Helvetica, Arial, sans-serif",s.style.fontSize="9px",s.style.color="rgb("+_[1][0]+","+_[1][1]+","+_[1][2]+")",s.style.fontWeight="bold",s.innerHTML="MS",a.appendChild(s),(o=document.createElement("div")).style.position="relative",o.style.width="74px",o.style.height="30px",o.style.backgroundColor="rgb("+_[1][0]+","+_[1][1]+","+_[1][2]+")",a.appendChild(o);o.children.length<74;)(t=document.createElement("span")).style.width="1px",t.style.height=30*Math.random()+"px",t.style.cssFloat="left",t.style.backgroundColor="rgb("+_[0][0]+","+_[0][1]+","+_[0][2]+")",o.appendChild(t);return{domElement:e,update:function(){c=Date.now(),v=c-d,y=Math.min(y,v),S=Math.max(S,v),s.textContent=v+" MS ("+y+"-"+S+")";var e=Math.min(30,30-v/200*30);o.appendChild(o.firstChild).style.height=e+"px",d=c,h++,c>u+1e3&&(p=Math.round(1e3*h/(c-u)),f=Math.min(f,p),g=Math.max(g,p),r.textContent=p+" FPS ("+f+"-"+g+")",e=Math.min(30,30-p/100*30),n.appendChild(n.firstChild).style.height=e+"px",u=c,h=0)}}};define("DS/Visualization/Info",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";const t=function(){this.programs=0,this.geometries=0,this.textures=0,this.renderTargets=0,this.sharedbuffers=0};t.prototype.reset=function(){this.programs=0,this.geometries=0,this.textures=0,this.renderTargets=0,this.sharedbuffers=0};const i=function(e){this.name=e||"",this._duration=0,this._parent=null,this.children=[]};i.prototype.push=function(e){e._parent=this,this.children.push(e)},i.prototype.start=function(){this._duration=performance.now()},i.prototype.end=function(){this._duration=performance.now()-this._duration};const r=function(){this.activated=!1,this.curNode=null,this.frameTypeMap=new Map};r.prototype.enable=function(e){this.activated=e,this.curNode=null,e&&this.frameTypeMap.clear()},r.prototype.pushRoot=function(e){this.activated&&(this.curNode=new i,this.frameTypeMap.set(e,this.curNode),this.curNode.start())},r.prototype.popRoot=function(){this.activated&&(this.curNode&&this.curNode.end(),this.curNode=null)},r.prototype.push=function(e){if(this.curNode){var t=new i(e);this.curNode.push(t),this.curNode=t,this.curNode.start()}},r.prototype.pop=function(){this.curNode&&(this.curNode.end(),this.curNode=this.curNode._parent)};const n=function(){this.calls=0,this.vertices=0,this.faces=0,this.lines=0,this.points=0,this.objectUniformCalls=0,this.swapMaterials=0,this.swapPrograms=0,this.swapBuffers=0,this.unsharedBuffers=0,this.swapScenes=0,this.cullingCalls=0,this.culledMeshes=0,this.culledGeometries=0,this.culledDGTriangles=0,this.culledDGLines=0,this.nbDGs=0,this.nbReps=0,this.nbDGsSSBProcessed=0};return n.prototype.reset=function(){this.calls=0,this.vertices=0,this.faces=0,this.lines=0,this.points=0,this.objectUniformCalls=0,this.swapMaterials=0,this.swapPrograms=0,this.swapBuffers=0,this.unsharedBuffers=0,this.swapScenes=0,this.cullingCalls=0,this.culledMeshes=0,this.culledGeometries=0,this.culledDGTriangles=0,this.culledDGLines=0,this.nbDGs=0,this.nbReps=0,this.nbDGsSSBProcessed=0},n.prototype.getRendering=function(){return{swapMaterials:this.swapMaterials,swapPrograms:this.swapPrograms,swapScenes:this.swapScenes,objectUniformCalls:this.objectUniformCalls,swapBuffers:this.swapBuffers,unsharedBuffers:this.unsharedBuffers}},n.prototype.getGeometries=function(){return{calls:this.calls,vertices:this.vertices,faces:this.faces,lines:this.lines,points:this.points,nbDGs:this.nbDGs,nbReps:this.nbReps,nbDGsSSBProcessed:this.nbDGsSSBProcessed}},n.prototype.getCulling=function(){return{cullingCalls:this.cullingCalls,culledMeshes:this.culledMeshes,culledGeometries:this.culledGeometries,culledDGTriangles:this.culledDGTriangles,culledDGLines:this.culledDGLines}},{MemoryInfo:t,RenderTimeInfo:r,RenderInfo:n}}),define("DS/Visualization/JSONReader",["DS/VisuLoaders/JSONReader"],function(e){"use strict";return e}),define("Visualization/JSONReader",["DS/Visualization/JSONReader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/JSONReader"),e}),window.disposedViewers=[];var __WebGLViewer_prereqs=["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/Viewpoint","DS/Visualization/InternalSceneGraph","DS/Mesh/MeshUtils","DS/Animation/AnimationEngine","DS/Visualization/WebGLV6Renderer","DS/Visualization/OccurrencePath","UWA/Controls/Abstract","DS/Magnifier/Magnifier","DS/Visualization/TrapSelection","DS/Visualization/MaterialManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/SubElement","DS/VisuEvents/EventsManager","DS/Manipulators/ManipulatorManager","DS/Visualization/SceneGraph","DS/Visualization/SceneGraphUtils","DS/Visualization/SceneGraphFactory","DS/Visualization/HighlightSelection","DS/CoreEvents/ModelEvents","DS/Plugins/UserPassManager","DS/Effects/BlurShadowEffect","DS/Visualization/PlaneGrid","DS/Manipulators/TrapSelectionManipulator","DS/Visualization/ClippingContext","DS/Visualization/GetSVGMode","DS/Visualization/RenderPriorityManager","DS/WebRecordEnabler/Adapter","DS/Effects/ConvertCubemapToLatlong","DS/Visualization/Ambience","DS/Visualization/RenderMode","DS/Visualization/RenderStyle","DS/Visualization/BudgetedRenderManager","DS/Visualization/WorldOrientation","DS/EKEventsWeb/EKEvents","DS/VisuEvents/MouseEvent","DS/Visualization/DecalManager","DS/Intersection/VolumeIntersection","DS/Visualization/WebGLViewerEffectSettings","DS/Visualization/ViewpointManager","DS/Visualization/PickingMode"];"file:"!==window.location.protocol&&(__WebGLViewer_prereqs.push("text!Visualization/assets/ambiences.json"),__WebGLViewer_prereqs.push("text!Visualization/assets/compare.json")),define("DS/Visualization/WebGLViewer",__WebGLViewer_prereqs,function(e,t,i,r,n,a,s,o,l,h,c,d,u,p,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A,T,D,I,R,O,L,V,F,B,N,G,k,U,z,H,W,j,X,q,Z,Y,Q){"use strict";var K=t.NoOccurrences,J="true"===localStorage.getItem("WebVisuForceHaloHL"),$=0,ee=t.__visibleInCurrentSpace,te={Shaded:["Shading","ShadingEdges","ShadingEdgesHiddenEdges","ShadingEdgesHalfSmoothEdges","ShadingEdgesHalfSmoothEdgesHiddenEdges","ShadingEdgesNoSmoothEdges","ShadingEdgesNoSmoothEdgesHiddenEdges","ShadingMaterial","ShadingMaterialEdges","ShadingMaterialEdgesHalfSmoothEdges","ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges","ShadingMaterialEdgesHiddenEdges","ShadingMaterialEdgesNoSmoothEdges","ShadingMaterialEdgesNoSmoothEdgesHiddenEdges"],Illustration:["ShadingIllustration"],Wireframe:["Wireframe"]},ie={WithEdges:["ShadingEdges","ShadingIllustration","Wireframe","ShadingMaterialEdges"],NoEdges:["Shading","ShadingMaterial"],WithEdgesHiddenEdges:["ShadingEdgesHiddenEdges","ShadingMaterialEdgesHiddenEdges"],WithEdgesHalfSmoothEdges:["ShadingEdgesHalfSmoothEdges","ShadingMaterialEdgesHalfSmoothEdges"],WithEdgesHalfSmoothEdgesHiddenEdges:["ShadingEdgesHalfSmoothEdgesHiddenEdges","ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges"],WithEdgesNoSmoothEdges:["ShadingEdgesNoSmoothEdges","ShadingMaterialEdgesNoSmoothEdges"],WithEdgesNoSmoothEdgesHiddenEdges:["ShadingEdgesNoSmoothEdgesHiddenEdges","ShadingMaterialEdgesNoSmoothEdgesHiddenEdges"]},re={true:["ShadingMaterial","ShadingMaterialEdges","ShadingMaterialEdgesHalfSmoothEdges","ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges","ShadingMaterialEdgesHiddenEdges","ShadingMaterialEdgesNoSmoothEdges","ShadingMaterialEdgesNoSmoothEdgesHiddenEdges"],false:["Shading","ShadingEdges","ShadingEdgesHalfSmoothEdges","ShadingEdgesHalfSmoothEdgesHiddenEdges","ShadingEdgesHiddenEdges","ShadingEdgesNoSmoothEdges","ShadingEdgesNoSmoothEdgesHiddenEdges","ShadingIllustration","Wireframe"]};let ne=(new t.Color).setRGB(150/255,185/255,165/255);var ae=p.extend({init:function(i){this.id=$++,window.debugWebGLV6Viewer=this;var r,n=this;i.uniqueName&&(this.uniqueName=i.uniqueName),i.pageObjectName&&(this.pageObjectName=i.pageObjectName),this.clearThis=function(){n=null},this.version="9.0",this._familyName=i.familyName?i.familyName:"",this.debugWebgl2=!!i.debugWebgl2,this._parent(),this._worldOrientation=U.ZUpYRight,this.idPathMatcher=null,this._refPlaneCounter=0,this._refPlaneMap=new Map,this._manipulators={},this.trapSelectionManipulator=null,this.disposed=!1,this._fillXSOMode=!0,this.lastViewerWidth=0,this.lastViewerHeight=0,i=i||{},this._svgMode=!!i.svgMode,this._2DMode=!1,this.div=null,this.divCssElement=null,this.materialManager=null,this.context2D=null,this._nearFarBigScale=!!window.nearFarBigScale,this._sceneGraph=null,this._sceneGraphOverrideSetManager=null,this._sceneGraphStateVersion=null,this._oocManager=null,this._userPassManager=new A(this),this._renderPriorityManager=null,this._modelEvent=new E,this.trapSelection=null,this._renderStyle=null,this._pickingMode=new Z,this._forceSceneMinValue=null,this._backgroundViewMode=t.BackgroundViewMode.NORMAL,this._invertBackgroundNodes=!1,this._pickBackgroundNodes=!0,this._planeViewMode={mode:t.PlaneViewMode.NORMAL,plane:new t.Plane},i.capturer&&(this.capturer=i.capturer,this.capturer.setViewer(this),i.preserveDrawingBuffer=!0),void 0!==i.div&&(this.div=i.div),void 0!==i.divCssElement&&(this.divCssElement=i.divCssElement),this._useDefaultAmbiancesIBL=void 0===i.useDefaultAmbiancesIBL||i.useDefaultAmbiancesIBL,this.buildSkeleton(),this.buildSkeletonCss(),window.DSWebRecord&&(console.log("registering viewer#"+this.id),x._record_registerObject(this,"WebGLV6Viewer",[this.canvas,this.divTrap])),this.previousMaxSectionPolyLineSize=0,this.ODTMode=i.ODTMode||!1,this.ODTMode&&(t._BinaryPrimitives=!t.IsIE11),this.fetchMePreferenceSettings=void 0===i.usePlatformSettings||i.usePlatformSettings,this._configAmbiences=null,this._compareSettings=null,Y&&(this._configAmbiences=JSON.parse(Y)),Q&&(this._compareSettings=JSON.parse(Q)),this.ODTMode&&i.ODTAmbiences&&(this._configAmbiences=JSON.parse(i.ODTAmbiences));var a=t.isAppleDevice();if(this._configAmbiences&&this._configAmbiences.effects&&void 0!==this._configAmbiences.effects.FallbackForApple&&(a=!!this._configAmbiences.effects.FallbackForApple),this._configAmbiences&&this._configAmbiences.effects&&void 0!==this._configAmbiences.effects.UnrolledHighlightForApple){var u=!!this._configAmbiences.effects.UnrolledHighlightForApple;t.__unrolledHighlight=function(){return u}}var p=t.isMobile();this.mobile=p||!!i.shouldBeMobile,void 0===i.mobile||a||(this.mobile=i.mobile,console.warn("Warning: Detected mobile mode override. DO NOT USE IN PRODUCTION.")),t.mobileVersion=this.mobile,t._mobileDevice=this.mobile||p,t._visuFaceMaterialsAsPBR=void 0!==i.visuFaceMaterialsAsPBR&&i.visuFaceMaterialsAsPBR,t._GASFaceMaterialsAsPBR=void 0!==i.GASFaceMaterialsAsPBR&&i.GASFaceMaterialsAsPBR,t._visuFaceMaterialsAsPBR&&(t._GASFaceMaterialsAsPBR=!0),t._GASFaceMaterialsAsPBR&&(t._visuFaceMaterialsAsPBR=!0),this.useHDR=!a&&(void 0===i.hdr||i.hdr),this.multiViewer=void 0!==i.multiViewer&&i.multiViewer,this.multiViewerFix=!0,this.defaultAnimationLoop=void 0===i.defaultAnimationLoop||i.defaultAnimationLoop,V.isReplaying()&&(this.defaultAnimationLoop=!1),this.autoUpdateFrustum=void 0===i.autoUpdateFrustum||i.autoUpdateFrustum,this.autoUpdateLights=!0,this.triLights=void 0!==i.triLights&&i.triLights,this.ambience=new B({viewer:this,v2:!0}),this.ambience.setBackgroundColor(void 0!==i.backgroundColor?i.backgroundColor:0),this.ambience.setBackgroundAlpha(void 0!==i.backgroundAlpha?i.backgroundAlpha:1),this.__tempBackgroundColorODT=void 0!==i.backgroundColor?i.backgroundColor:0,this.planeColor=new t.Color(15658734),this.gridColor=new t.Color(15658734),this.showBgAlpha=this.ambience.getBackgroundAlpha(),this.showBgColor=this.ambience.getBackgroundColor().getHex(),this.showPlaneColor=new t.Color(this.planeColor.getHex()),this.showGridColor=new t.Color(this.gridColor.getHex()),this.showGradientBackground=[],this.visibleSpace=void 0!==i.visibleSpace?i.visibleSpace:1,this._updateStaticOverrides=!1,this.visuShadingMode={preset:null,face:null,edge:null,point:null,before2DModeLinesFilter:null,before2DModePointsFilter:null,before2DModeVerticesFilter:null,outline:!1},this.axisFilterStatus=null,this.planesFilterStatus=null,this.pointsFilterStatus=null,this.linesFilterStatus=null,this.verticesFilterStatus=null,this.lockedRenderMode=new Map,this.sceneGraphState=null,this.cameraSystem=null,this.cameraSystemUpdated=!1,this.lastNbTexturesBeingLoaded=0,this._pageObjectData=null,this._immFrame=null,this.highlightColor=null,this.highlightSets=[],this.picking={activated:!0,trapSelection:!1,showDivTrap:!0,displayHL:!0,forceVisibility:!1,gpu:!0,trapGPU:!1,_trapPrimitiveUsed:!1,trapPrimitive:!1,computeNormalDepth:!0,primitive:!1,tolerance:2},Object.defineProperty(this.picking,"trapSelectionMesh",{set:function(e){console.warn("Invalid useage, please use setPicking API")},get:function(){return console.warn("DEPRECATED: please use .trapSelection and .trapPrimitive instead"),this.trapSelection&&!this.trapPrimitive}}),void 0!==i.highlight&&this.setPicking(i.highlight),this.pPicking={activated:!1,trapSelection:!1,displayHL:!0,forceVisibility:!1,gpu:!0,computeNormalDepth:!1,primitive:!1,disableWhileMoving:!0,tolerance:2},this._showHighlight=!0,void 0!==i.pHighlight&&this.setPrePicking(i.pHighlight),this.lastAddedToPSO=null,void 0===i.usePicking&&void 0===i.usePickingGPU||console.log("usePicking and usePickingGPU parameters are deprecated.\n Use highlight and pHighlight objects instead."),void 0!==i.usePicking&&(this.picking.activated=i.usePicking),void 0!==i.usePickingGPU&&(this.picking.gpu=i.usePickingGPU),void 0!==i.useTrapGPU&&(this.picking.trapGPU=i.useTrapGPU),this.infinitePlane=void 0===i.infinitePlane||i.infinitePlane,this._infinitePlane=this.infinitePlane,this.displayGrid=void 0!==i.displayGrid&&i.displayGrid,this._displayGrid=this.displayGrid,this.displayGridFromBelow=!1,this.autoUpdatePlane=void 0===i.autoUpdatePlane||i.autoUpdatePlane,this.useMirror=void 0!==i.mirror&&(!this.mobile&&i.mirror),this.blurryMirror=!1,this.planeAttenuation=!1,this.useShadowPlane=this._infinitePlane,this.useDefaultLights=void 0===i.defaultLights||i.defaultLights,this.useGroundShadow=void 0!==i.useGroundShadow&&i.useGroundShadow,this.useShadowMap=void 0===i.useShadowMap||i.useShadowMap,this.mobile&&(this.useShadowMap=!1),this.shadowFilter="PCF",this.shadowQuality="Low",this.shadowMapWidth=void 0!==i.shadowMapWidth?i.shadowMapWidth:4096,this.shadowMapHeight=void 0!==i.shadowMapHeight?i.shadowMapHeight:4096,this.deferred=void 0!==i.deferred&&i.deferred,this.antiAliasing=void 0!==i.antiAliasing?i.antiAliasing:"NoAA",!0===this.antiAliasing?this.antiAliasing="SMAA":!1===this.antiAliasing&&(this.antiAliasing="NoAA");var f=void 0!==i.useOIT&&i.useOIT;i.svgMode&&(f=!1),this.forceRender=!1,this._renderingToTarget=!1,this.visuEnv="None",void 0!==i.displayHighlight&&(this.displayHighlight=i.displayHighlight,this.setPicking({activated:this.displayHighlight,displayHL:this.displayHighlight})),this.useVignetting=void 0!==i.useVignetting&&i.useVignetting,this.useSSAO=void 0!==i.ssao&&i.ssao,this.useSSAOIterative=void 0!==i.ssaoIterative&&i.ssaoIterative,this.useSSLR=void 0!==i.sslr&&i.sslr,this.useSSLRDirect=!1,this.useSSLRefraction=!1,this.useBloom=void 0!==i.bloom&&i.bloom,this.useFlare=void 0!==i.flare&&i.flare,this.useDOF=void 0!==i.dof&&i.dof,a?this._viewerEffectSettings=new X.None(this,{enableOIT:f}):this.mobile?this._viewerEffectSettings=new X.Mobile(this,{enableOIT:f}):this.useHDR?this._viewerEffectSettings=new X.Desktop(this,{enableOIT:f}):this._viewerEffectSettings=new X.NoHDR(this,{enableOIT:f}),this.ssaoParams={dynamicRadius:!0,adaptativeRadius:!0,radius:.04,radiusMin:.01,radiusMax:.12,minPixelRadius:14,attenuation:1,contrast:2,power:1,thresholdAngle:1.35},this.magnifier=null,this.debugShadowLight=void 0!==i.debugShadowLight&&i.debugShadowLight,this.debugBSphere=void 0!==i.debugBSphere&&i.debugBSphere,this.debugPrimitiveBSphere=void 0!==i.debugPrimitiveBSphere&&i.debugPrimitiveBSphere,this.debugRepBBox=void 0!==i.debugRepBBox&&i.debugRepBBox,this.debugPicking=void 0!==i.debugPicking&&i.debugPicking,this.debugNormals=void 0!==i.debugNormals&&i.debugNormals,this.debugBackfaceCulling=void 0!==i.debugBackfaceCulling&&i.debugBackfaceCulling,this.debugPickHybrid=!1;this.debugPostProcessing=!1,this.debugShadowMaps=!1,this.debugEvents=0,this.debugFPS=!1,this.debugFPSInfos={fpsCounter:null,fpsArray:[],fpsIndex:0,fpsValue:30,fpsCumul:1200,fpsWindow:40,fpsLastTime:0},this._viewpointManager=new q(this),this.viewpoints=[],this.currentViewpoint=null,this.trackingViewpoint=null,this.internalSceneGraph=null,this._safeInternalSceneGraph=null,this.manipulatorManager=null,this.temporaryEmptyScene=new t.Scene,this.centerMouseDownCB=null,this.mouseMoveCB=null,this.centerMouseUpCB=null,this.leftMouseDownCB=null,this.leftMouseUpCB=null,this.rightMouseUpCB=null,this._defaultPicking=null,this.setDefaultPicking(!0),this.pickingPriorityMapping=null,this.forceMultiSel=!1,this.sceneBackground=new t.Scene,this.sceneBackground.isBackground=!0,this.cameraBackgroundNear=1e-4,this.cameraBackgroundFar=1,this.cameraBackground=new t.PerspectiveCamera,this.cameraBackground._renderingRole=t._CameraRoles.BACKGROUND,this.sceneBackground.add(this.cameraBackground),this.cameraReflected=new t.PerspectiveCamera,this.cameraReflected._renderingRole=t._CameraRoles.REFLECTED,this.planeGridOrientation=new t.Matrix4,this.infPlane=null,this.infPlaneSmall=null,this.planeSize=200,this.grid=null,this.bigGrid=null,this.gridSize=200,this.gridUnit=1,this.gridStep=.005,this.gridNbSteps=5,this.offsetPlaneSmall=new t.Vector3,this.offsetPlaneBackground=new t.Vector3,this.planeV2=void 0!==i.planeV2&&i.planeV2,this._planeV2Appli=this.planeV2,this.planeGrid=this.planeV2?new D(this):null,this.ground=null,this.envMap=null,this.envMap2=null,this.envMapExposure=1,this.envMapOffset=0,this.envMapBlur=0,this.sphereEnv=null,this.isRenderIteration=!0,this._lockRenderIteration=!1,this.renderIteration=0,this.timeIter0=0,this.delayBeforeIteration=500,this.devicePixelRatio=t.getDevicePixelRatio()||1,this.SCREEN_WIDTH=800,this.SCREEN_HEIGHT=600,this.lazyResize=void 0!==i.lazyResize&&i.lazyResize,this.lazyResizeTime=300,this.oldCanvasSize={width:this.SCREEN_WIDTH,height:this.SCREEN_HEIGHT,dpr:this.devicePixelRatio,time:(new Date).getTime()},this.initMousePos=null,this.currMousePos=null,this.bSphere=null,this.bBox=null,this.primitiveBSphere=null,this.debugPickingNode=null,this.debugNormalNode=new t.Object3D,this.renderer=null,this._requestRender=!1,this._onlyPostProcess=!0,this._renderParams=[],this.renderFrameCB=null,this.beginRenderFrameCB=null,this.ambientLight=new t.AmbientLight(new t.Color(0)),this.directionalLight=null,this.directionalLight2=null,this.directionalLight3=null,this.dirLightGroundShadow=null,this.groundShadowLatitude=0,this.groundShadowLongitude=0,this.dirLightLatitude=.25,this.dirLightLongitude=0,this.dirLightVector=new t.Vector3(2,1.5,2.5),this.dirLight2Vector=new t.Vector3(0,0,1),this.dirLight3Vector=new t.Vector3(0,0,1),this.dirLightType=[!1,!1,!1],this.lights=[],this.clipPlanes=[],t.intensityCorrection=!0,this.budgetedRenderManager=new k(this),r=new Date,this._oldTime=r.getTime(),this.overrideCursors=!0,this._changeCursorDelay=null,this._temporaryCursorData=null,this._forcePRZ=!1,this.startPan=function(e){var t=this.currentViewpoint.getControl();null!==t&&t.startPan(e),this._forcePRZ=!0},this.startRotate=function(e){var t=this.currentViewpoint.getControl();null!==t&&t.startRotate(e),this._forcePRZ=!0},this.startZoom=function(e){var t=this.currentViewpoint.getControl();null!==t&&t.startZoom(e),this._forcePRZ=!0},this.endPan=function(e){var t=this.currentViewpoint.getControl();null!==t&&(t.endPan(e),this.setCursor("Auto",0)),this._forcePRZ=!1},this.endRotate=function(e){var t=this.currentViewpoint.getControl();null!==t&&(t.endRotate(e),this.setCursor("Auto",0)),this._forcePRZ=!1},this.endZoom=function(e){var t=this.currentViewpoint.getControl();null!==t&&(t.endZoom(e),this.setCursor("Auto",0)),this._forcePRZ=!1},this._getPaths=function(e,t,i,r){var n,a;if(t.count!=t.stop){t.count++,i.push(e);var s=e.children;for(a=s.length,n=0;n<a;n++)this._getPaths(s[n],t,i,r);i.pop(),t.count--}else r.push(i.slice(0))},this.addPathToHso=function(e){var t=[],i=y;this._getPaths(this.getRootNode().children[0],{count:0,stop:e},[],t);for(var r=0;r<t.length;r++)i.add({pathElement:new s(t[r])});return t},this.render=function(e){null!=n&&(void 0===e&&(e={}),e.budgeted?n.budgetedRenderManager._askForRender(e):(void 0===e.budgeted&&n.budgetedRenderManager._resetShift(),n._renderParams.push(e),n._requestRender=!0,e&&e.onlyPostProcess||(n._onlyPostProcess=!1)))},this._QMTimer=null,this._QMMode=!1,this._getQMMode=function(e,t,i){if(this._QMMode=!!this._QMTimer&&!i||e.isMoving()||e._isAnimated()||!!t,this._QMTimer&&!i&&clearTimeout(this._QMTimer),this._QMMode){var r=this;this._QMTimer=setTimeout(function(){clearTimeout(r._QMTimer),r._QMTimer=null,r.render()},r.delayBeforeIteration||500)}return this._QMMode},this.glRenderMultiVP=function(e){this.budgetedRenderManager._isActive&&this.budgetedRenderManager._setAsRenderFrame(),this.beginRenderFrameCB&&this.beginRenderFrameCB(),this.renderer.renderer._dBufferNextFrame&&(this.renderer.renderer.requestDBuffer=!0,this.renderer.renderer._dBufferNextFrame=!1),this.renderer.renderer._politeDBufferNextFrame&&(this.renderer.renderer._requestPoliteDepthBuffer=!0,this.renderer.renderer._politeDBufferNextFrame=!1);let i=!1,r=this.renderer.renderer.getViewport();if(void 0!==e.viewpoint)i=this.glRender(e);else{let t=this._viewpointManager.getVpList();for(let n=0;n<t.length;n++){let a=this._viewpointManager.getViewpointScenegraph(t[n]),s=this.internalSceneGraph;a&&(this.internalSceneGraph=a),this.autoUpdateFrustum&&this._updateNearFar(t[n]),t[n].camera.updateProjectionMatrix(),t[n].camera.projectionMatrixInverse.getInverse(t[n].camera.projectionMatrix);let o=this.renderer.renderer.gammaOutput,l=this,h=function(){l.internalSceneGraph=s,l.renderer.renderer.gammaOutput=o,l.renderer.useAuxiliaryAsForward=!1,l.renderer.renderer.setViewport(r.x,r.y,r.width,r.height)};if(!t[n]._isMain){if(!this.renderer.mainComposer.composerContext||this.renderer.mainComposer.composerContext.id!=this.renderer.compForwardComposerContext.id){h();continue}this.renderer.auxiliaryViewpointComposerContext||this.renderer.initComposer("auxiliaryViewpoint"),this.renderer.useAuxiliaryAsForward=!0,this.renderer.renderer.gammaOutput=!1}let c=this._viewpointManager.getViewpointViewport(t[n]);c&&this.renderer.renderer.setViewport(c.x,c.y,c.width,c.height);let d=[...e,{viewpoint:t[n]}];i=this.glRender(d)||i,h()}}return this.renderer.renderer.requestDBuffer=!1,this.renderer.renderer._requestPoliteDepthBuffer&&(this.renderer.politeDepthBuffer=null),this.renderer.renderer._requestPoliteDepthBuffer=!1,this.ODTMode&&t.ImageUtils.nbTexturesBeingLoaded>0?this.render():this.renderFrameCB&&this.renderFrameCB(),i},this.glRender=function(e){var i,r,a,s,o,l,c,d,u,p,f,g,m,v;this.renderer.renderer.maxPolyLineSize!==this.previousMaxSectionPolyLineSize&&(this.previousMaxSectionPolyLineSize=this.renderer.renderer.maxPolyLineSize,this.renderer&&this.renderer.recompileAllShaders(null)),t.webGLStats&&t.webGLStats.reset();var y=!1,S=null,_=!1,x=!1,b=n.currentViewpoint,w=!0,P=!!e.length,E=!!e.length,A=!1,T=512,D=0,I=0,R=!1,O=!1,L=!1,V=!1,F=!1;for(ee=0;ee<e.length;ee++)void 0!==e[ee].needReframe&&(y=e[ee].needReframe),void 0!==e[ee].reframeSpace&&(S=e[ee].reframeSpace),void 0!==e[ee].updateInfinitePlane&&(_=_||e[ee].updateInfinitePlane),void 0!==e[ee].updateInfinitePlaneFast&&(x=x||e[ee].updateInfinitePlaneFast),void 0!==e[ee].renderIteration&&(I=e[ee].renderIteration),void 0!==e[ee].isStillFrame&&(R=e[ee].isStillFrame),void 0!==e[ee].forceRender&&(O=e[ee].forceRender),void 0!==e[ee].viewpoint&&(b=e[ee].viewpoint),void 0!==e[ee].toScreen&&(w=e[ee].toScreen),e[ee].onlyPostProcess||(P=!1),e[ee].onlyForward||(E=!1),void 0!==e[ee].cubemap&&(A=e[ee].cubemap),void 0!==e[ee].cubemapResolution&&(T=e[ee].cubemapResolution),void 0!==e[ee].cubeFace&&(D=e[ee].cubeFace),L||!0!==e[ee].ekTrace||(L=!0),!0===e[ee].forceStaticMode&&(forceStaticMode=!0),!0===e[ee].forceDynamicMode&&(F=!0),!0===e[ee].overrideEffects&&(V=!0);L&&(L=z.Trace.traceStart("techno_webvisu","webgl_frame_display"));let B=null!==b&&b.isMain();var N=V?"override":this._getQMMode(b,F,O)?"dynamic":"static",G=V?"override":0===I?"dynamic":"static";if(this._viewerEffectSettings.updateViewerSettings(N,G),n._modelEvent.publish({event:"PreRender",data:{viewer:n,viewpoint:b,trackingViewpoint:n.trackingViewpoint,onlyPostProcess:P}}),f=b.camera,se=null===n.internalSceneGraph?n.temporaryEmptyScene:n.internalSceneGraph.scene,(p=null===n.internalSceneGraph?new t.Sphere(new t.Vector3(0,0,0),100):n.getSceneBoundingSphere(this.visibleSpace?"visibleSpace":"invisibleSpace")).pixelRadius>0){var k=f.getWorldSizeFromPixelSize(1,p.center,this._getDivClientHeight());if(void 0!==f.fullWidth&&f.fullWidth>0)k*=Me=Math.max(1*f.width/f.fullWidth,1*f.height/f.fullHeight);p.radius+=k*p.pixelRadius}if(null!==b&&(f.updateMatrix(),f.matrixWorld.copy(f.matrix),f.matrixWorldInverse.getInverse(f.matrixWorld),this._viewerEffectSettings.updateAmbienceBackScale(N),this.blurShadowEffect&&this.dirLightGroundShadow&&this.ambience.getGround().needsUpdateShadowIntensity&&(this.ambience.getGround().needsUpdateShadowIntensity=!1,this.blurShadowEffect.setIntensity(this.ambience.getGround().getShadowIntensity()),this.dirLightGroundShadow.updateShadowMap=!0),this.sphereEnv&&this.ambience.updateCamera(b,this.renderer,f)),n.directionalLight&&(n.directionalLight.shadowCameraVisible=n.debugShadowLight),B){if(n.debugBSphere){if(n.bSphere)n.bSphere.visibilityFree=!0,n.bSphere.visible=!0,n.bSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(p.radius,p.radius,p.radius),i.setPosition(p.center),n.bSphere.setMatrix(i);else if(null!==se){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.2,transparent:!0,force:!0,forceSide:!0}),(X=C.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.bSphere=X._occurrences[0].renderable,n.bSphere.frustumCulled=!1,n.bSphere.noPickThrough=!1,se.add(n.bSphere)}}else n.bSphere&&(n.bSphere.visibilityFree=!0,n.bSphere.visible=!1);if(n.debugNodeBSphere){var U=null,H=null;if((J=WUX.Selection.HSOManager.get())[0])U=(Z=(q=J[0].pathElement).getLastElement(!0)).getBoundingSphere(),H=q.getWorldMatrix(this);if(U){if(n.nodeBSphere)n.nodeBSphere.visible=!0,n.nodeBSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(U.radius,U.radius,U.radius),i.setPosition(U.center),H.multiplyMatrices(H,i),n.nodeBSphere.setMatrix(H);else if(null!==se){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(X=C.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.nodeBSphere=X._occurrences[0].renderable,n.nodeBSphere.frustumCulled=!1,se.add(n.nodeBSphere)}}else n.nodeBSphere&&(n.nodeBSphere.visible=!1)}if(n.debugPrimitiveBSphere){var W=null;H=null;if((J=WUX.Selection.HSOManager.get())[0])(Z=(q=J[0].pathElement).getLastElement()).sgNode&&Z.sgNode.boundingSphere&&(W=Z.sgNode.boundingSphere,H=q.getWorldMatrix(this));if(W){if(n.primitiveBSphere)n.primitiveBSphere.visible=!0,n.primitiveBSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(W.radius,W.radius,W.radius),i.setPosition({x:W.center[0],y:W.center[1],z:W.center[2]}),H.multiplyMatrices(H,i),n.primitiveBSphere.setMatrix(H);else if(null!==se){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(X=C.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.primitiveBSphere=X._occurrences[0].renderable,n.primitiveBSphere.frustumCulled=!1,se.add(n.primitiveBSphere)}}else n.primitiveBSphere&&(n.primitiveBSphere.visible=!1)}if(n.debugRepBSphere){var j=null;H=null;if((J=WUX.Selection.HSOManager.get())[0])(Z=(q=J[0].pathElement).getLastElement()).sgNode&&Z.sgNode.rep&&Z.sgNode.rep.boundingSphere&&(j=Z.sgNode.rep.boundingSphere,H=q.getWorldMatrix(this));if(j){if(n.repBSphere)n.repBSphere.visible=!0,n.repBSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(j.radius,j.radius,j.radius),i.setPosition({x:j.center[0],y:j.center[1],z:j.center[2]}),H.multiplyMatrices(H,i),n.repBSphere.setMatrix(H);else if(null!==se){var X;r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(X=C.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.repBSphere=X._occurrences[0].renderable,n.repBSphere.frustumCulled=!1,se.add(n.repBSphere)}}else n.repBSphere&&(n.repBSphere.visible=!1)}if(n.debugRepBBox){var q,Z,Y=null;H=null;if((J=WUX.Selection.HSOManager.get())[0])(Z=(q=J[0].pathElement).getLastElement()).getBoundingBox()&&(Y=Z.getBoundingBox(),H=q.getWorldMatrix(this));else Y=this.getSceneBoundingBox(),H=this.internalSceneGraph.root.getMatrix();if(Y)if(n.bBox)n.bBox.visible=!0,n.bBox.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(Y.max.x-Y.min.x,Y.max.y-Y.min.y,Y.max.z-Y.min.z),i.setPosition({x:Y.min.x+(Y.max.x-Y.min.x)/2,y:Y.min.y+(Y.max.y-Y.min.y)/2,z:Y.min.z+(Y.max.z-Y.min.z)/2}),H.multiplyMatrices(H,i),n.bBox.setMatrix(H);else if(null!==se){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0});var Q=C.createCuboidNode({cornerPoint:new t.Vector3(-.5,-.5,-.5),firstAxis:new t.Vector3(1,0,0),secondAxis:new t.Vector3(0,1,0),thirdAxis:new t.Vector3(0,0,1),material:r});n.bBox=Q._occurrences[0].renderable,n.bBox.frustumCulled=!1,n.bBox.pickable=!1,se.add(n.bBox)}}else n.bBox&&(n.bBox.visible=!1);if(n.debugLocalBBox){var K=(new t.Matrix4).identity();n.debugHandleMatrix&&K.copy(n.currentViewpoint.camera.matrix);for(var J=WUX.Selection.HSOManager.get(),$=[],ee=0;ee<J.length;ee++)$.push(J[ee].pathElement);var te=M.getOrientedBoundingBoxFromPathElements($,K,n).localBBox;if(te){if(n.localBBox)n.localBBox.visible=!0,n.localBBox.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(te.max.x-te.min.x,te.max.y-te.min.y,te.max.z-te.min.z),i.setPosition({x:te.min.x+.5*(te.max.x-te.min.x),y:te.min.y+.5*(te.max.y-te.min.y),z:te.min.z+.5*(te.max.z-te.min.z)}),K.multiplyMatrices(K,i),n.localBBox.setMatrix(K);else if(se){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(Q=C.createCuboidNode({cornerPoint:new t.Vector3(-.5,-.5,-.5),firstAxis:new t.Vector3(1,0,0),secondAxis:new t.Vector3(0,1,0),thirdAxis:new t.Vector3(0,0,1),material:r})).setPickable(2),n.localBBox=Q._occurrences[0].renderable,n.localBBox.frustumCulled=!1,se.add(n.localBBox)}}else n.localBBox&&(n.localBBox.visible=!1)}if(n.debugBBox){K=(new t.Matrix4).identity();n.debugHandleMatrix&&K.copy(n.currentViewpoint.camera.matrix);var ie=this.computeSceneAccurateBoundingBox(n.visibleSpace?"visibleSpace":"invisibleSpace",n.debugHandleMatrix?K:null);if(ie){if(n.BBox)n.BBox.visible=!0,n.BBox.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(ie.max.x-ie.min.x,ie.max.y-ie.min.y,ie.max.z-ie.min.z),i.setPosition({x:ie.min.x+.5*(ie.max.x-ie.min.x),y:ie.min.y+.5*(ie.max.y-ie.min.y),z:ie.min.z+.5*(ie.max.z-ie.min.z)}),K.multiplyMatrices(K,i),n.BBox.setMatrix(K);else if(se){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(Q=C.createCuboidNode({cornerPoint:new t.Vector3(-.5,-.5,-.5),firstAxis:new t.Vector3(1,0,0),secondAxis:new t.Vector3(0,1,0),thirdAxis:new t.Vector3(0,0,1),material:r})).setPickable(2),n.BBox=Q._occurrences[0].renderable,n.BBox.frustumCulled=!1,se.add(n.BBox)}}else n.BBox&&(n.BBox.visible=!1)}else n.BBox&&(n.BBox.visible=!1);var re=this.getRootNode();re&&!n.debugPicking&&null!==n.debugPickingNode&&(n.debugPickingNode.removeChildren(),re.removeChild(n.debugPickingNode),n.debugPickingNode=null),n.debugNormals?(n.debugNormalNode.children.length||function(){if(null===n.internalSceneGraph)return;var e,i,r,a,s,o,l,c,d,u,p,f,g,m,v,y,S,_,x=n.internalSceneGraph.scene.getMeshInstances();for(y=0;y<x.length;y++){for(e=x[y],i=.05*e.boundingSphere.radius,r=null,a=0,e.geometry.length>=0?(r=e.geometry[0],a=e.geometry.length):2===e.geometry._type&&(r=e.geometry,a=1),s=[],_=0;_<a;_++){if(o=r.vertexPositionArray,null!==(l=r.vertexNormalArray))for(S=0;S<o.length;S+=3)s.push({x:o[S],y:o[S+1],z:o[S+2]}),s.push({x:o[S]+i*l[S],y:o[S+1]+i*l[S+1],z:o[S+2]+i*l[S+2]});r=e.geometry[_+1]}if(s.length){for((c=new h.PrimitiveGroup).fillAttr=new h.FillAttributes,c.lineAttr=new h.LineAttributes,c.pointAttr=new h.PointAttributes,(d=new h.Buffer).size=3*s.length,d.component=h.VertexComponentEnum.POSITION,d.format=h.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(d.size),c.addBuffer(0,d),v=d.data,_=0,S=0;S<s.length;S++)v[_++]=s[S].x,v[_++]=s[S].y,v[_++]=s[S].z;for(u=Math.ceil(s.length/65534),p=0,S=0;S<u;S++)(f=new h.Primitive).nbIndices=Math.min(s.length-p,65534),f.connectivity=h.ConnectivityTypeEnum.LINES,f.attr={fill:new h.FillAttributes,line:new h.LineAttributes(new h.Color(0,0,1,1)),point:new h.PointAttributes},(g=new h.VertexComponent).component=h.VertexComponentEnum.POSITION,g.nbVertices=3*Math.min(s.length-p,65534),g.nbValuesPerVertex=3,g.format=h.DataTypeEnum.FLOAT,g.cardinality=0,g.bufferId=0,g.offset=p,g.indices=null,f.addVertexComponent(g),c.addPrimitive(f),p+=65534;(m=C.createMeshNode(c)).mesh3js.setMatrix((new t.Matrix4).copy(e.matrixWorld)),m.setPickable(!1),m.mesh3js.castShadow=!1,m.mesh3js.receiveShadow=!1,n.debugNormalNode.add(m.mesh3js)}}}(),se.add(n.debugNormalNode)):(se.remove(n.debugNormalNode),n.debugNormalNode.children=[])}for(ee=0;ee<se.__lights.length;ee++){var ne,ae=!1;(ne=se.__lights[ee])._occurrence&&(ae=ne._occurrence.node._attachedToVpt),ae&&(ne._vptUp=b.getUpDirection(),ne._vptSight=b.getSightDirection(),ne._vptPosition=b.getEyePosition()),ne._sceneShadow&&ne.updateShadowParameters(p,n.renderer.renderer.baseLightDirection)}if(B&&this.ambience){var se=this.internalSceneGraph&&this.internalSceneGraph.scene;this.ambience.updateLights(b,se,p,n.useShadowMap,this.sceneBackground)}if(B&&n.useDefaultLights){if(ne=n.directionalLight,a=n.directionalLight2,s=n.directionalLight3,null!==p){if(n.triLights){var oe=b.getUpDirection(),le=b.getSightDirection(),he=(new t.Vector3).crossVectors(le,oe);n.autoUpdateLights?(o=new t.Vector3(2*p.radius,2*p.radius,2*p.radius),ne.position=(new t.Vector3).copy(p.center).add(o),ne.lookAt(p.center),l=(new t.Vector3).copy(oe).sub(le).sub(he).multiplyScalar(2*p.radius),a.position=(new t.Vector3).copy(p.center).add(l),a.lookAt(p.center),c=(new t.Vector3).copy(he).sub(le).multiplyScalar(2*p.radius),s.position=(new t.Vector3).copy(p.center).add(c),s.lookAt(p.center)):(n.dirLightType[0]?(o=new t.Vector3(he.x*n.dirLightVector.x+oe.x*n.dirLightVector.y-le.x*n.dirLightVector.z,he.y*n.dirLightVector.x+oe.y*n.dirLightVector.y-le.y*n.dirLightVector.z,he.z*n.dirLightVector.x+oe.z*n.dirLightVector.y-le.z*n.dirLightVector.z).multiplyScalar(p.radius),ne.updateShadowMap=!0):o=(new t.Vector3).copy(n.dirLightVector).multiplyScalar(p.radius),ne.position=(new t.Vector3).copy(p.center).add(o),ne.lookAt(p.center),l=n.dirLightType[1]?new t.Vector3(he.x*n.dirLight2Vector.x+oe.x*n.dirLight2Vector.y-le.x*n.dirLight2Vector.z,he.y*n.dirLight2Vector.x+oe.y*n.dirLight2Vector.y-le.y*n.dirLight2Vector.z,he.z*n.dirLight2Vector.x+oe.z*n.dirLight2Vector.y-le.z*n.dirLight2Vector.z).multiplyScalar(p.radius):(new t.Vector3).copy(n.dirLight2Vector).multiplyScalar(p.radius),a.position=(new t.Vector3).copy(p.center).add(l),a.lookAt(p.center),c=n.dirLightType[2]?new t.Vector3(he.x*n.dirLight3Vector.x+oe.x*n.dirLight3Vector.y-le.x*n.dirLight3Vector.z,he.y*n.dirLight3Vector.x+oe.y*n.dirLight3Vector.y-le.y*n.dirLight3Vector.z,he.z*n.dirLight3Vector.x+oe.z*n.dirLight3Vector.y-le.z*n.dirLight3Vector.z).multiplyScalar(p.radius):(new t.Vector3).copy(n.dirLight3Vector).multiplyScalar(p.radius),s.position=(new t.Vector3).copy(p.center).add(c),s.lookAt(p.center))}else if(n.autoUpdateLights){if(n.dirLightType[0])m=f.getLookAt(),o=new t.Vector3(-2*m.x*p.radius,-2*m.y*p.radius,-2*m.z*p.radius),ne.position=(new t.Vector3).copy(p.center).add(o);else{var ce=2;he=1.5,oe=2.5;n.dirLightVector=(new t.Vector3).copy(n._worldOrientation.frontVector).multiplyScalar(ce).add((new t.Vector3).copy(n._worldOrientation.rightVector).multiplyScalar(he)).add((new t.Vector3).copy(n._worldOrientation.upVector).multiplyScalar(oe)),ne.position=(new t.Vector3).copy(n.dirLightVector).multiplyScalar(p.radius).add(p.center)}ce=-2,he=1.5,oe=2.5;(l=(new t.Vector3).copy(n._worldOrientation.frontVector).multiplyScalar(ce).add((new t.Vector3).copy(n._worldOrientation.rightVector).multiplyScalar(he)).add((new t.Vector3).copy(n._worldOrientation.upVector).multiplyScalar(oe))).multiplyScalar(p.radius),a.position=(new t.Vector3).copy(p.center).add(l)}else{ne.position=(new t.Vector3).copy(n.dirLightVector).multiplyScalar(2*p.radius).add(p.center);ce=-2,he=1.5,oe=2.5;(l=(new t.Vector3).copy(n._worldOrientation.frontVector).multiplyScalar(ce).add((new t.Vector3).copy(n._worldOrientation.rightVector).multiplyScalar(he)).add((new t.Vector3).copy(n._worldOrientation.upVector).multiplyScalar(oe))).multiplyScalar(p.radius),a.position=(new t.Vector3).copy(p.center).add(l)}ne.lookAt(p.center),ne.target.position.copy(p.center),ne.target.updateMatrixWorld(),a.target.position.copy(p.center),a.target.updateMatrixWorld(),s&&(s.target.position.copy(p.center),s.target.updateMatrixWorld())}if(n.useShadowMap&&ne.intensity){if(ne.castShadow=!0,null!==p){d=ne.position.distanceTo(p.center);var de=Math.PI*Math.max(.1,.5-n.dirLightLatitude),ue=Math.sin(de)+(Math.cos(de)+1)/Math.tan(de);ne.shadowCamera&&!ne.LiSPSM?(ne.updateShadowMap=ne.updateShadowMap||ne.shadowCamera.top!==p.radius,ne.shadowCamera.far=d+ue*p.radius,ne.shadowCamera.near=Math.max(.001*ne.shadowCamera.far,d-p.radius),ne.shadowCamera.left=-p.radius,ne.shadowCamera.right=p.radius,ne.shadowCamera.bottom=-p.radius,ne.shadowCamera.top=p.radius,ne.shadowCamera.updateProjectionMatrix()):(ne.shadowCameraFar=d+ue*p.radius,ne.shadowCameraNear=Math.max(.001*ne.shadowCameraFar,d-p.radius),ne.updateShadowMap=!0)}}else ne.castShadow=!1}if(B&&(n._infinitePlane||n._displayGrid)&&n.updateBackgroundLights(),this._2DMode?(this.ground&&(this.ground.visible=!1),this.sphereEnv&&(this.sphereEnv.visible=!1)):this.ambience.getGround().isActivated()&&"physical"==this.ambience.getGround().getType()?(this.ground||this._setPhysicalGround(this.ambience.getGroundGeometry()),this.ambience.updateGround(this.ground)):this.ground&&(this.ground.visible=!1),B&&!this.ambience.needUpdateIBL.has(this)){var pe=this.ambience.getIblMap(),fe=this.ambience.getRoughnessMap();pe?(this.internalSceneGraph.scene.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(!0),n.internalSceneGraph.scene.envMipMap[0]=pe,n.internalSceneGraph.scene.envMipMap[1]=fe,this.sceneBackground.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(!0),this.sceneBackground.envMipMap[0]=pe,this.sceneBackground.envMipMap[1]=fe):(n.internalSceneGraph.scene.envMipMap=[],this.sceneBackground.envMipMap=[]),n.renderer.renderer.ambianceGenerators._decreaseSceneUseCount(n.internalSceneGraph.scene),n.renderer&&n.renderer.recompileAllShaders(null),this.ambience.needUpdateIBL.add(this)}if(!n._displayGrid&&(null!==n.grid&&n.grid.visible||null!==n.bigGrid&&n.bigGrid.visible)&&n._removeGrid(),!n._displayGrid&&n.planeGrid&&n.planeGrid.updateVisibility(),g=100,B&&null!==p&&(n._displayGrid||n._infinitePlane||n.useShadowPlane||n.ambience.getGround().isActivated()||n.ambience.isFiniteMode())){"yup"===this._worldOrientation._woName?(n.offsetPlaneSmall.x=p.center.x,n.offsetPlaneSmall.z=p.center.z):(n.offsetPlaneSmall.x=p.center.x,n.offsetPlaneSmall.y=p.center.y);var ge=2*p.radius;n._updateOffsetPlane(p,f,_,x);var me=n._getPlaneSize(p,f,n.gridUnit,n.gridStep);me!==n.planeSize&&(n.planeSize=me,n.autoUpdateFrustum&&n._updateNearFar(b)),u=-f.getLookAt().dot(this._worldOrientation.upVector);var ve=f.position.dot(this._worldOrientation.upVector)-n.offsetPlaneBackground.dot(this._worldOrientation.upVector);if((g=f.isOrtho?u:ve)>0&&n.useShadowPlane&&!n._2DMode){var ye=(new t.Vector3).copy(n.offsetPlaneSmall);ye.x-=.001*g*this._worldOrientation.upVector.x,ye.y-=.001*g*this._worldOrientation.upVector.y,ye.z-=.001*g*this._worldOrientation.upVector.z;de=Math.PI*Math.max(.1,.5-n.dirLightLatitude);ge*=ue=Math.sin(de)+(Math.cos(de)+1)/Math.tan(de),n.createInfinitePlane(n.infPlaneSmall,0,ge,ye)}else n._removeInfinitePlane(n.infPlaneSmall);if(n.planeV2&&n.planeGrid||n.ambience.usePlaneV2?(n._removeGrid(),n.planeGrid.createPlaneGrid(n.planeSize,n.offsetPlaneBackground,b,n.ambience.isAutoGroundOffset(),n.planeGridOrientation,n.renderer.renderer.simpleGamma)):(n._infinitePlane&&n.createInfinitePlane(n.infPlane,1,n.planeSize,n.offsetPlaneBackground),n._displayGrid&&(g>0||this.displayGridFromBelow?n.createGrid(n.planeSize,n.offsetPlaneBackground,Math.abs(ve),Math.abs(u),_):n._removeGrid()),(v=(new t.Vector3).copy(n.offsetPlaneBackground)).applyMatrix4(f.matrixWorldInverse),null!==this.grid&&(this.grid.material.updatePDSFXUniform("gridCenter",v.clone()),null!==this.bigGrid&&this.bigGrid.material.updatePDSFXUniform("gridCenter",v.clone()))),n.useGroundShadow){var Se=n.dirLightGroundShadow;o=new t.Vector3(0,0,2*p.radius);ce=Math.sin(Math.PI*this.groundShadowLatitude)*Math.cos(2*Math.PI*this.groundShadowLongitude),he=Math.sin(Math.PI*this.groundShadowLatitude)*Math.sin(2*Math.PI*this.groundShadowLongitude),oe=Math.cos(Math.PI*this.groundShadowLatitude);var _e=(new t.Vector3).copy(this._worldOrientation.frontVector).multiplyScalar(ce).add((new t.Vector3).copy(this._worldOrientation.rightVector).multiplyScalar(he)).add((new t.Vector3).copy(this._worldOrientation.upVector).multiplyScalar(oe));Se.position=(new t.Vector3).copy(_e).multiplyScalar(2*p.radius).add(p.center),Se.lookAt(p.center),Se.target.position.copy(p.center),Se.target.updateMatrixWorld(),Se.castGroundShadow=!0,d=Se.position.distanceTo(p.center),Se.shadowCamera?(Se.updateShadowMap=!Se.blockUpdate&&(Se.updateShadowMap||Se.shadowCamera.top!==.5*ge),Se.shadowCamera.far=d+p.radius,Se.shadowCamera.near=Math.max(.001*Se.shadowCamera.far,d-p.radius),Se.shadowCamera.left=-.5*ge,Se.shadowCamera.right=.5*ge,Se.shadowCamera.bottom=-.5*ge,Se.shadowCamera.top=.5*ge,Se.shadowCamera.updateProjectionMatrix()):(Se.shadowCameraFar=d+p.radius,Se.shadowCameraNear=Math.max(.001*Se.shadowCameraFar,d-p.radius),Se.shadowCameraLeft=-.5*ge,Se.shadowCameraRight=.5*ge,Se.shadowCameraBottom=-.5*ge,Se.shadowCameraTop=.5*ge,Se.updateShadowMap=!0),Se._matrixWorldReceiver||(Se._matrixWorldReceiver=new t.Matrix4),n.infPlaneSmall&&Se._matrixWorldReceiver.copy(n.infPlaneSmall.matrix)}else n.dirLightGroundShadow.castGroundShadow=!1}if(!this._2DMode)if(this.ambience.getBackground().isActivated()){var xe=this.trackingViewpoint?this.trackingViewpoint:b,be=(new t.Vector3).copy(xe.camera.position);this.sphereEnv&&(this.sphereEnv.visible=!0),this.sphereEnv||this._setSphereEnv(this.ambience.getSphere()),this.internalSceneGraph.scene.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(!0);var we=.1*this.cameraBackgroundFar;if(f.isOrtho){var Me,Ce=1;if(f.fullWidth)(Me=f.height/f.fullHeight)>1&&(Ce*=Me),(Me=f.width/f.fullWidth)>1&&(Ce*=Me);var Pe=Math.sqrt(Math.pow(f.right,2)+Math.pow(f.top,2));Pe*=Ce,this.ambience.getBackground().setRatio(Ce),(we=Math.max(we,Pe))+this.cameraBackgroundNear>this.cameraBackgroundFar&&(this.cameraBackgroundFar=we+this.cameraBackgroundNear);var Ee=this.currentViewpoint.getSightDirection().normalize();be.addVectors(be,Ee.multiplyScalar(this.cameraBackgroundNear))}this.ambience.updateSphere(we,be,this.sphereEnv)}else this.removeEnvMap();if(n.useGroundShadow&&n.useShadowPlane&&!n._2DMode&&n._setGroundShadow(),B&&this._updateStaticOverrides&&(this._updateStaticOverrides=!1,this.internalSceneGraph.updateStaticOverrides()),this.cameraSystem){this.renderer.renderer._VRFrameBuffer=this.cameraSystem._extFrameBuffer;var Ae,Te,De=this.trackingViewpoint||b;if(2===(Ae=this.cameraSystem.computeCameraArray(b,De.camera.near,De.camera.far)).length&&(Ae[0]._renderingRole=t._CameraRoles.STEREO,Ae[1]._renderingRole=t._CameraRoles.STEREO),this.cameraSystem.useExternalProjectionMatrix){var Ie=1e-4*this.cameraBackgroundFar;this._nearFarBigScale&&(Ie=Math.min(.001,Ie)),Te=this.cameraSystem.computeCameraArray(b,Ie,this.cameraBackgroundFar)}var Re=[],Oe=this.renderer.renderer.getViewportSize();for(ee=0;ee<Ae.length;ee++){if(this.renderer.renderer.cameraSystem_cameraIndex=ee,Re.push("cameraSystem"+ee),this.mobile||!this.useHDR?this.renderer.renderer.setSplitScreenMode(ee*Oe.width,0):this.renderer.renderer.removeSplitScreenMode(),this.sphereEnv&&this.sphereEnv.material){var Le=Ae[ee],Ve=this.sphereEnv.material;Le.fullWidth?(Ve.invScreenSize.x=1/Le.width,Ve.invScreenSize.y=1/Le.height,Ve.startOffset.x=Le.x/Le.fullWidth,Ve.endOffset.y=1-Le.y/Le.fullHeight,Ve.endOffset.x=(Le.x+Le.width)/Le.fullWidth,Ve.startOffset.y=1-(Le.y+Le.height)/Le.fullHeight):(Ve.invScreenSize.x=1/Oe.width,Ve.invScreenSize.y=1/Oe.height,Ve.startOffset.x=0,Ve.startOffset.y=0,Ve.endOffset.x=1,Ve.endOffset.y=1)}this.renderCamera(Ae[ee],Te&&Te[ee],!1,P,E,A,T,D,I,R,Re[ee],g)}!this.mobile&&this.useHDR?this.renderer.combineResults(Re,w,this.cameraSystem)||this.render():this.renderer.renderer.enableScissorTest(!1)}else this.renderer.renderer._VRFrameBuffer=null,this.renderCamera(f,null,w,P,E,A,T,D,I,R,"main",g);return null!==b&&y&&null!==p&&(b.resetCameraOrientation(),b.reframe(void 0,void 0,void 0,S)),t.webGLStats&&t.webGLStats.dump(),L&&L.End(),n._viewerEffectSettings._setDownsamplingFactor(N),!P},this._requestShadowMapUpdate=e.subscribe({event:"/VISU/requestShadowMapUpdate"},function(e){n._updateShadowMaps()}),this._requestVisuUpdate=e.subscribe({event:"/VISU/requestVisuUpdate"},function(e){n.render()}),this.renderCamera=function(e,i,r,n,a,s,o,l,h,c,d,u){if((y=this.currentViewpoint)._renderedCamera=e,this.internalSceneGraph&&y&&(this.internalSceneGraph.selectionHL.updateHighlight(y),this.internalSceneGraph.selectionPreHL.updateHighlight(y),this.renderer.updateEffects(this.internalSceneGraph,this.currentViewpoint,h,n)),i)this.sceneBackground.remove(this.cameraBackground),this.cameraBackground=i,this.sceneBackground.add(this.cameraBackground);else{!this.cameraBackground.isOrtho&&!e.isOrtho||this.cameraBackground.isOrtho&&e.isOrtho?e.clone(this.cameraBackground):(this.sceneBackground.remove(this.cameraBackground),this.cameraBackground=e.clone(),this.sceneBackground.add(this.cameraBackground));var p=1e-4*this.cameraBackgroundFar;this._nearFarBigScale&&(p=Math.min(.001,p)),this.cameraBackground.near=p,this.cameraBackground.far=this.cameraBackgroundFar,this.cameraBackground.isOrtho&&(this.cameraBackground.near=this.cameraBackgroundNear),this.cameraBackground.updateProjectionMatrix(),this.cameraBackground.projectionMatrixInverse.getInverse(this.cameraBackground.projectionMatrix)}this.cameraBackground._setBackgroundRenderingRoleFromPrincipal(e),!this.cameraReflected.isOrtho&&!e.isOrtho||this.cameraReflected.isOrtho&&e.isOrtho?e.clone(this.cameraReflected):this.cameraReflected=e.clone(),this.cameraReflected.matrixAutoUpdate=!1;var f="zup"===this._worldOrientation._woName,g=new t.Matrix4(1,0,0,0,0,f?1:-1,0,0,0,0,f?-1:1,0,0,0,0,1),m=2*this._worldOrientation.upVector.dot(this.offsetPlaneBackground);g.setPosition((new t.Vector3).copy(this._worldOrientation.upVector).multiplyScalar(m));var v=(new t.Matrix4).copy(e.matrixWorld);if(g.multiply(v),this.cameraReflected.setMatrix(g),this.cameraReflected._setReflectedRenderingRoleFromPrincipal(e),this.SCREEN_WIDTH&&this.SCREEN_HEIGHT){var y,S=u>0&&this.useMirror,_=this._infinitePlane||this._displayGrid||this.ambience.getBackground().isActivated()||S,x=this.useShadowMap&&(this.useDefaultLights||this.isShadowMap());(y=this.currentViewpoint)._updateRobotCamera(this.internalSceneGraph),this.planeV2&&this.planeGrid&&this.planeGrid.updateLabels(y);var b={main:e,cameraBackground:this.cameraBackground,connectedRobotCamera:y.connectedRobotCamera,robotCameraOrtho:y.robotCameraOrtho,mirrorCamera:this.cameraReflected};if(this.renderer.render(_,S,x,this.sceneBackground,b,this.internalSceneGraph,this.infPlaneSmall,this.ambience.getGroundGlossiness(),r,n,this.hasSceneGraphOverrideSet(),a,s,o,l,h,c,d,!this._showHighlight,this.clipPlanes,this.directionalLight),window.__debugLoop__)for(var w=performance.now(),M=0;M<600;)M=performance.now()-w}},this.renderToTarget=function(e,i,r,a,s){this._viewerEffectSettings.copySettings("override","static"),s&&Object.entries(this._QMSettings).forEach(e=>{void 0!==n._QMSettings[e[0]].value.override&&(n._QMSettings[e[0]].value.override=e[1].value.static)}),this.renderer.recompileAllShaders([t.RendererMode.override]);var o=n.useSSAOIterative;a?(this._viewerEffectSettings._setFromJson("override",a),void 0!==a.IterativeSSAO&&n.setIterativeSSAO(!!a.IterativeSSAO)):(n.setIterativeSSAO(!1),"MSAA"===n._viewerEffectSettings.getSetting("AntiAliasing","override")&&n._viewerEffectSettings.setSetting("AntiAliasing","override","SMAA"));var l=n._viewerEffectSettings.getSSAO("override"),h="MSAA"===n._viewerEffectSettings.getAntiAliasing("override"),c="FSAA"===n._viewerEffectSettings.getAntiAliasing("override"),d=l&&n.useSSAOIterative||h,u=a&&a.NbIterations?Math.min(a.NbIterations,128):32,p=!1;if(n.SCREEN_WIDTH&&n.SCREEN_HEIGHT){n._renderingToTarget=!0;var f=this.devicePixelRatio||1;c&&(f*=2);var g=Math.floor(f*n.SCREEN_WIDTH),m=Math.floor(f*n.SCREEN_HEIGHT);e||(e={data:null,width:g,height:m,bufferWidth:0,bufferHeight:0,x:0,y:0}),(e.width>g||e.height>m)&&(p=!0),null===e.data||e.bufferWidth<e.width||e.bufferHeight<e.height?c?(e.data=new Uint8Array(4*e.width*e.height*4),e.bufferWidth=2*e.width,e.bufferHeight=2*e.height):(e.data=new Uint8Array(4*e.width*e.height),e.bufferWidth=e.width,e.bufferHeight=e.height):(e.bufferWidth=e.width,e.bufferHeight=e.height),e.x||(e.x=0),e.y||(e.y=0),n.autoUpdateFrustum&&n._updateNearFar();var v=i.camera;v.updateProjectionMatrix(),v.projectionMatrixInverse.getInverse(v.projectionMatrix);var y=n.getWebGLContext(),S=n.getRenderer();if(S.removeSplitScreenMode(),p){var _=0,x=-1;l&&(_=32,a&&a.MaxOverlap&&(_=a.MaxOverlap),n.renderer.SSAOEffect&&(x=n.renderer.SSAOEffect.maxPixelRadius,n.renderer.SSAOEffect.maxPixelRadius=_));var b=g-2*_,w=m-2*_,M=Math.ceil(e.width/b),C=Math.ceil(e.height/w),P=e.width,E=e.height,A=E-C*w,T=0,D=0,I=P,R=E,O=b,L=w,V=1,F=1;if(i.camera.fullWidth){var B={fullWidth:i.camera.fullWidth,fullHeight:i.camera.fullHeight,x:i.camera.x,y:i.camera.y,width:i.camera.width,height:i.camera.height};I=B.fullWidth,R=B.fullHeight,T=B.x,D=B.y,O*=V=B.width/P,L*=F=B.height/E}for(var N=i.camera,G=new Uint8Array(4*b*w),k=0;k<C;k++)for(var U=0;U<M;U++){var z=Math.min(b,e.width-U*b),H=Math.min(w,e.height-k*w),W=N.clone();if(W._renderingRole=N._renderingRole,W.setViewOffsetInternal(I,R,U*O+T-_*V,k*L+D-_*F,O+2*_*V,L+2*_*F),i.camera=W,d)for(var j=0;j<u;j++)n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0,renderIteration:j}]);else n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0}]);y.readPixels(_,_,b,w,y.RGBA,y.UNSIGNED_BYTE,G);var X=C-k-1,q=0;X>0&&(q=X*w+A);for(var Z=0;Z<H;Z++)for(var Y=0;Y<z;Y++){var Q=P*(q+Z)+U*b+Y,K=(w-H+Z)*b+Y;e.data[4*Q]=G[4*K],e.data[4*Q+1]=G[4*K+1],e.data[4*Q+2]=G[4*K+2],e.data[4*Q+3]=G[4*K+3]}}i.camera=N,x>0&&(n.renderer.SSAOEffect.maxPixelRadius=x)}else if(r){var J={xMin:Math.max(0,-e.x),xMax:Math.max(0,e.x+e.width-g),yMin:Math.max(0,-e.y),yMax:Math.max(0,e.y+e.height-m)},$=J.xMin>0||J.xMax>0||J.yMin>0||J.yMax>0,ee=e.x,te=e.y;if($)(ie=(N=i.camera).clone())._renderingRole=N._renderingRole,ie.setViewOffsetInternal(g,m,J.xMin>0?-J.xMin:J.xMax>0?J.xMax:0,J.yMin>0?J.yMin:J.yMax>0?-J.yMax:0,g,m),i.camera=ie,ee=J.xMin>0?0:J.xMax>0?g-e.width:e.x,te=J.yMin>0?0:J.yMax>0?m-e.height:e.y;if(S.setScissor(ee,te,e.width,e.height),S.enableScissorTest(!0),d)for(j=0;j<u;j++)n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0,renderIteration:j}]);else n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0}]);S.enableScissorTest(!1),$&&(i.camera=N),y.readPixels(ee,te,e.width,e.height,y.RGBA,y.UNSIGNED_BYTE,e.data)}else{var ie;(ie=(N=i.camera).clone())._renderingRole=N._renderingRole;ee=.5*(g-e.bufferWidth),te=.5*(m-e.bufferHeight);if(N.fullWidth){ee=0,te=m-e.bufferHeight;var re=e.width/e.bufferHeight*N.height;ie.x-=.5*(re-ie.width),ie.width=re;var ne=g/e.bufferWidth,ae=m/e.bufferHeight;ie.width*=ne,ie.height*=ae,this.ambience.setRenderTargetSize(e.width,e.bufferHeight,ee,te)}else this.ambience.setRenderTargetSize(e.width,e.bufferHeight,ee,te),ie.setViewOffsetInternal(e.bufferWidth,e.bufferHeight,-.5*(g-e.bufferWidth),-.5*(m-e.bufferHeight),g,m);if(ie.updateProjectionMatrix(),ie.projectionMatrixInverse.getInverse(ie.projectionMatrix),i.camera=ie,S.setScissor(Math.max(0,ee-8),Math.max(0,te-8),Math.min(g,e.bufferWidth+16),Math.min(m,e.bufferHeight+16)),S.enableScissorTest(!0),this.ambience.updateParameters(),d)for(j=0;j<u;j++)n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0,renderIteration:j}]);else n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0}]);this.ambience.setRenderTargetSize(0,0,0,0),this.ambience.updateParameters(),this.ambience.setRenderTargetSize(0,0,0,0),S.enableScissorTest(!1),i.camera=N,y.readPixels(ee,te,e.bufferWidth,e.bufferHeight,y.RGBA,y.UNSIGNED_BYTE,e.data)}this.ambience.updateParameters(),n.setIterativeSSAO(o),n.mobile?n.glRender([{viewpoint:i,onlyPostProcess:!1}]):n.render({onlyPostProcess:!1}),n._renderingToTarget=!1}},this._renderToCanvas=function(e,t){var i,r;if(this.svgRootNode){var n;(n=this.svgRootNode.cloneNode(!0)).setAttributeNS(null,"width",this.canvas.width),n.setAttributeNS(null,"height",this.canvas.height),n.style.left=0,n.style.top=0,n.style.width=this.canvas.width+"px",n.style.height=this.canvas.height+"px";var a=n.outerHTML?n.outerHTML:(new XMLSerializer).serializeToString(n),s=new Blob([a],{type:"image/svg+xml;charset=utf-8"}),o=window.URL.createObjectURL(s),l=new Image,h=this;l.onload=function(){i=h.canvas.width,r=h.canvas.height,l.width=i,l.height=r;var t={width:i,height:r,data:null};h.renderToTarget(t,h.currentViewpoint);var n=document.createElement("canvas");n.width=i,n.height=r;for(var a=n.getContext("2d"),s=a.createImageData(i,r),c=s.data,d=0;d<s.height;d++)for(var u=0;u<s.width;u++){var p=u+d*i,f=u+(r-d-1)*i;c[4*p]=t.data[4*f],c[4*p+1]=t.data[4*f+1],c[4*p+2]=t.data[4*f+2],c[4*p+3]=t.data[4*f+3]}a.putImageData(s,0,0),setTimeout(function(){var t=document.createElement("canvas");t.width=i,t.height=r;var a=t.getContext("2d");a.drawImage(l,0,0),a.drawImage(n,0,0),window.URL.revokeObjectURL(o),e(t)},100)},l.onerror=function(){window.URL.revokeObjectURL(o),t()},l.src=o}else{i=this.canvas.width,r=this.canvas.height;var c={width:i,height:r,data:null};this.renderToTarget(c,this.currentViewpoint);var d=document.createElement("canvas");d.width=i,d.height=r;for(var u=d.getContext("2d"),p=u.createImageData(i,r),f=p.data,g=0;g<p.height;g++)for(var m=0;m<p.width;m++){var v=m+g*i,y=m+(r-g-1)*i;f[4*v]=c.data[4*y],f[4*v+1]=c.data[4*y+1],f[4*v+2]=c.data[4*y+2],f[4*v+3]=c.data[4*y+3]}u.putImageData(p,0,0),e(d)}},this.renderCubemap=function(e,i,r,a,s){var l=new o(this,90,void 0,void 0,!1),h=l.camera;h.aspect=1,h.position=e,h.useQuaternion=!0;for(var c=new t.Vector3,d=0;d<6;d++){switch(d){case 0:h.up.set(0,-1,0),h.lookAt(c.addVectors(e,new t.Vector3(1,0,0)));break;case 1:h.up.set(0,-1,0),h.lookAt(c.addVectors(e,new t.Vector3(-1,0,0)));break;case 2:h.up.set(0,0,1),h.lookAt(c.addVectors(e,new t.Vector3(0,1,0)));break;case 3:h.up.set(0,0,-1),h.lookAt(c.addVectors(e,new t.Vector3(0,-1,0)));break;case 4:h.up.set(0,-1,0),h.lookAt(c.addVectors(e,new t.Vector3(0,0,1)));break;case 5:h.up.set(0,-1,0),h.lookAt(c.addVectors(e,new t.Vector3(0,0,-1)))}h.updateMatrix(),n.autoUpdateFrustum&&n._updateNearFar(),h.updateProjectionMatrix(),h.projectionMatrixInverse.getInverse(h.projectionMatrix),n.glRender([{viewpoint:l,toScreen:!1,onlyForward:!0,cubemap:!0,cubemapResolution:i,cubeFace:d}])}var u=this.renderer.compForwardComposerContext.renderResults.main;require(["DS/EffectsDebug/ConvertCubemapToLatlong","DS/Visualization/AmbianceGenerator"],function(e,i){if(n.renderer.compConvertCubeMapToLatLong||(n.renderer.compConvertCubeMapToLatLong=new e(n.renderer.renderer,n.renderer.renderTargetPool)),r){n.renderer.compConvertCubeMapToLatLong.setEnvMap(u);var o=n.getRenderer().ambianceGenerators;o.manager||(o.manager=new i(o.cb));var l=n.renderer.compConvertCubeMapToLatLong.composers[1],h=o.manager._getGenerator("shoot360",!1);h.setCallBack(function(){var e=n.renderer.compConvertCubeMapToLatLong.saveComposer.composerContext.getResult(void 0,!0);e.hdr=!0,e.mapping=new t.LatLongReflectionMapping;var i=h._getResult();if(a){var r={map0:e,map1:i,position:a.position,geomProxy:new t.Box3(a.minAABB,a.maxAABB)};n.internalSceneGraph.scene.reflectionProbes.push(r),n.renderer.recompileAllShaders(null)}else n.internalSceneGraph.scene.envMipMap[0]=e,n.internalSceneGraph.scene.envMipMap[1]=i;n.renderer.renderer.ambianceGenerators._decreaseSceneUseCount(n.internalSceneGraph.scene),s&&s()}),h.setValues(l),n.renderer.compConvertCubeMapToLatLong.execute(),n.renderer.compConvertCubeMapToLatLong.encodeRGBE(),h.execute(),o.manager._disposeGenerator("shoot360",!1)}else n.renderer.compConvertCubeMapToLatLong.setEnvMap(u),n.renderer.compConvertCubeMapToLatLong.execute(),n.renderer.compConvertCubeMapToLatLong.renderToScreen(),n.renderer.compConvertCubeMapToLatLong.saveAsHDR("reflection"),s&&s()})},this.grabDepthBuffer=function(e){if(n.SCREEN_WIDTH&&n.SCREEN_HEIGHT){var t=this.devicePixelRatio||1,i=Math.floor(t*n.SCREEN_WIDTH),r=Math.floor(t*n.SCREEN_HEIGHT);e||(e={data:null,_dataUint8:null,width:i,height:r,bufferWidth:0,bufferHeight:0}),(e.width>i||e.height>r)&&(e.width=i,e.height=r),(!e._dataUint8||e.bufferWidth<e.width||e.bufferHeight<e.height)&&(e._dataUint8=new Uint8Array(4*e.width*e.height),e.data=null,e.bufferWidth=e.width,e.bufferHeight=e.height);var a=n.getWebGLContext();return this.renderer.computeDepthBuffer(this.internalSceneGraph,this.currentViewpoint,!0),a.readPixels(0,0,e.width,e.height,a.RGBA,a.UNSIGNED_BYTE,e._dataUint8),e.data=new Float32Array(e._dataUint8.buffer),e}};var g=this._getForceRenderTargetSize();switch(g?(this.SCREEN_WIDTH=g.width/this.devicePixelRatio,this.SCREEN_HEIGHT=g.height/this.devicePixelRatio):this.useOffscreenCanvas?(this.SCREEN_WIDTH=this.canvas.width,this.SCREEN_HEIGHT=this.canvas.height):(this.SCREEN_WIDTH=this.canvas.offsetWidth,this.SCREEN_HEIGHT=this.canvas.offsetHeight),this.ambience.resize(this.SCREEN_WIDTH,this.SCREEN_HEIGHT,this.devicePixelRatio,this.renderer),this.initResources(this.canvas),this.onWebGLContextLost=function(e){console.log("WebGL context Lost !"),e.preventDefault()},this._contextMenu=function(e){e.preventDefault()},this.canvas.addEventListener("webglcontextlost",this.onWebGLContextLost,!1),this.onWebGLContextRestore=function(){window.__debugLoop__=!1,n.renderer.renderer.restoreGLContext(),n.render()},this.canvas.addEventListener("webglcontextrestored",this.onWebGLContextRestore,!1),this.renderer=new d({canvas:this.canvas,context:this.materialManager.getContext(),debugWebgl2:this.debugWebgl2,divCSS:this.divCss3DElement,useOffscreenCanvas:this.useOffscreenCanvas,deferred:this.deferred,useCompositing:!this.mobile&&this.useHDR,tonemapping:1,bgColor:this.ambience.getBackgroundColor().getHex(),bgAlpha:this.ambience.getBackgroundAlpha(),viewer:this,visibleSpace:this.visibleSpace,compareSettings:this._compareSettings,antiAliasing:!(this.useHDR&&!this.mobile||!this.antiAliasing||"NoAA"===this.antiAliasing)||"NoAA",forcePostProHighlight:!!i.forcePostProHighlight&&!t.isIOS(),preserveDrawingBuffer:i.preserveDrawingBuffer,debugContext:i.debugContext}),this._viewerEffectSettings._checkCompatibility(),this.renderer.renderer.precomputedTexture=this.materialManager.precomputedTexture,this.renderer.renderer.noiseTexture3D=this.materialManager.noiseTexture3D,this.renderer.renderer.precomputedAreaGGX1texture=this.materialManager.precomputedAreaGGX1texture,this.renderer.renderer.precomputedAreaGGX2texture=this.materialManager.precomputedAreaGGX2texture,this.renderer.renderer.precomputedAreaAshikmintexture=this.materialManager.precomputedAreaAshikmintexture,this.renderer.renderer.precomputedAreaEsteveztexture=this.materialManager.precomputedAreaEsteveztexture,this.renderer.renderer.precomputedAreaBeckmanntexture=this.materialManager.precomputedAreaBeckmanntexture,this.renderer.renderer.ambianceGenerators=t._AmbianceGenerators,this.renderer.renderer.ambianceGenerators.viewers.push(this),this.renderer.renderer.sssGenerator=t._SSSGenerator,this.renderer.renderer.sssGenerator.viewers.push(this),this.renderer.renderer.visibleSpace=this.visibleSpace,this.renderer.renderer.newMaterialInheritance=window.newMaterialInheritance,this.antiAliasing){case"NoAA":break;case"FXAA":this.renderer.setEffect("FXAA",!0);break;case"MLAA":this.renderer.setEffect("MLAA",!0);break;case"SMAA":this.renderer.setEffect("SMAA",!0);break;case"MSAA":this.renderer.setEffect("MSAA",!0);break;case"TAA":this.renderer.setEffect("TAA",!0);break;case"FSAA":case"SSAA":this.renderer.setEffect("FSAA",!0)}function m(i,r){if(n){n.fpsCounter&&n.fpsCounter.onAnimate(),x.RecordEventsManager&&x.RecordEventsManager.pushRecordAnimateEvent(n),n._idPathOverrideWatcher&&n._idPathOverrideWatcher.update(),!r&&n.defaultAnimationLoop&&requestAnimationFrame(m),n.isRenderIteration||(n.renderIteration=0),n.capturer&&n.capturer.capture(n.canvas,n.renderIteration);var a,s,o,l,h,d,u,p,f=new c,g=new Date,v=g.getTime()-n._oldTime;n._oldTime=g.getTime(),f.step(v),l=!1,p=n.renderer.renderer._renderScale*(t.getDevicePixelRatio()||1);var y=n._getForceRenderTargetSize();y?(d=y.width,u=y.height,n.div.offsetWidth===n.lastViewerWidth&&n.div.offsetHeight===n.lastViewerHeight||(n.currentViewpoint.camera.aspect=n.SCREEN_WIDTH/n.SCREEN_HEIGHT,n.lastViewerWidth=n.div.offsetWidth,n.lastViewerHeight=n.div.offsetHeight,n.canvas.style.width=n.lastViewerWidth+"px",n.canvas.style.height=n.lastViewerHeight+"px")):n.useOffscreenCanvas?(d=n.canvas.width||1,u=n.canvas.height||1):(d=n.div.offsetWidth||1,u=n.div.offsetHeight||1);var S=!1;if(n.lazyResize?n.oldCanvasSize.width!==d||n.oldCanvasSize.height!==u||n.oldCanvasSize.dpr!==p?(n.oldCanvasSize.width=d,n.oldCanvasSize.height=u,n.oldCanvasSize.dpr=p,n.oldCanvasSize.time=(new Date).getTime(),l=!0):n.oldCanvasSize.time>=0&&(new Date).getTime()-n.oldCanvasSize.time>300&&(n.oldCanvasSize.time=-1,S=!0):n.SCREEN_WIDTH===d&&n.SCREEN_HEIGHT===u&&n.devicePixelRatio===p||(S=!0,l=!0),n.devicePixelRatio=p,l&&n.currentViewpoint&&(n.currentViewpoint.camera._hasChanged=!0),n.cameraSystemUpdated&&(n.cameraSystemUpdated=!1,S=2),S&&function(e,t){var i,r;(l=n._getForceRenderTargetSize())?(n.SCREEN_WIDTH=l.width/n.devicePixelRatio,n.SCREEN_HEIGHT=l.height/n.devicePixelRatio):n.useOffscreenCanvas?(n.SCREEN_WIDTH=n.canvas.width||1,n.SCREEN_HEIGHT=n.canvas.height||1):(n.SCREEN_WIDTH=n.div.offsetWidth||1,n.SCREEN_HEIGHT=n.div.offsetHeight||1);n.svgRoot&&n._updateSVGVisu();if(n.multiViewer){var a=Math.max(1,Math.floor(n.devicePixelRatio*n.SCREEN_WIDTH)),s=Math.max(1,Math.floor(n.devicePixelRatio*n.SCREEN_HEIGHT));n.materialManager.setCanvasSize(this,a,s)}if(n.cameraSystem){var o=n.cameraSystem.getViewportSize(n.SCREEN_WIDTH,n.SCREEN_HEIGHT);i=o.width,r=o.height}else i=n.SCREEN_WIDTH,r=n.SCREEN_HEIGHT;var l,h=void 0,c=void 0;(l=n._getForceRenderTargetSize())&&(h=n.div.offsetWidth,c=n.div.offsetHeight);n.renderer.setRendererSize(n.SCREEN_WIDTH,n.SCREEN_HEIGHT,n.useOffscreenCanvas||t,i,r,n.devicePixelRatio,h,c),n._viewpointManager.resize(i,r),n.ambience.resize(i,r,n.devicePixelRatio,n.renderer),n.renderIteration=0,n.render()}(0,2===S),null!==n.currentViewpoint){if(null!==(s=n.currentViewpoint.getControl())&&s.update(),(a=n.currentViewpoint.camera)&&(a.updateMatrix(),a.matrixWorld.copy(a.matrix),a.matrixWorldInverse.getInverse(a.matrixWorld)),n.autoUpdateFrustum)n._updateNearFar()&&(n.renderIteration=0);a.updateProjectionMatrix(),a.projectionMatrixInverse.getInverse(a.projectionMatrix),(o=a.getLookAt()).add(a.position),l&&(e.publish({event:"/VISU/onWindowResized",data:{eventChannel:"/VISU/onWindowResized",eventType:"@onWindowResized",viewpoint:n.currentViewpoint,cameraEye:a.position,cameraTarget:o,cameraUp:a.up}}),n._modelEvent.publish({event:"Resize",data:{width:d,height:u}})),t.ImageUtils.nbTexturesBeingLoaded<n.lastNbTexturesBeingLoaded&&n.render(),n.lastNbTexturesBeingLoaded=t.ImageUtils.nbTexturesBeingLoaded;var _=n._requestRender;_&&!n._onlyPostProcess&&(n.renderIteration=0),n._onlyPostProcess=!0;var b=!1;n._viewerEffectSettings._setAntiAliasing(n.renderIteration>0?"static":"dynamic"),n.renderIteration<n.renderer.getMaxIterationEffects()&&(b=!0),b=b&&!n.forceRender;var w=!n._QMMode,M=w&&1===n.renderIteration,C=w&&n.renderIteration>0;if(_||C&&b||n.forceRender||M){if(n._requestRender=!1,h=n._renderParams,n._renderParams=[],h.length?(h[0].renderIteration=n.renderIteration,h[0].isStillFrame=C,h[0].forceRender=n.forceRender,h[0].onlyPostProcess=h[0].onlyPostProcess&&!b):h.push({renderIteration:n.renderIteration,isStillFrame:C,forceRender:n.forceRender}),n.forceRender=!1,n.debugFPS){var P=performance.now()-n.debugFPSInfos.fpsLastTime;n.debugFPSInfos.fpsLastTime=performance.now();var E=1e3/Math.max(P,.1);n.debugFPSInfos.fpsCumul+=E,n.debugFPSInfos.fpsCumul-=n.debugFPSInfos.fpsArray[n.debugFPSInfos.fpsIndex],n.debugFPSInfos.fpsValue=n.debugFPSInfos.fpsCumul/n.debugFPSInfos.fpsWindow,n.debugFPSInfos.fpsArray[n.debugFPSInfos.fpsIndex]=E,n.debugFPSInfos.fpsIndex=(n.debugFPSInfos.fpsIndex+1)%n.debugFPSInfos.fpsWindow,n.debugFPSInfos.fpsCounter.setHTML(Math.ceil(n.debugFPSInfos.fpsValue).toString())}var A=n.glRenderMultiVP(h);if(!n)return;if(0===n.renderIteration&&(n.timeIter0=g.getTime()),A&&(b||n.renderIteration<2)&&n.renderIteration++,n.renderer.renderer._texturesToResize.size&&n.renderer.resizeNPOTTexture(),n.multiViewer){var T=n.materialManager.getCanvas();n.context2D.globalCompositeOperation="copy",n.context2D.drawImage(T,0,T.height-n.canvas.height,n.canvas.width,n.canvas.height,0,0,n.canvas.width,n.canvas.height)}n._modelEvent.publish({event:"PostRender",data:{viewer:n,viewpoint:n.currentViewpoint}})}}}}return this.renderer.setEffect("Vignetting",this.useVignetting),this.renderer.setEffect("SSAO",this.useSSAO&&!this.useSSAOIterative),this.renderer.setEffect("SSAOIterative",this.useSSAO&&this.useSSAOIterative),this.renderer.setEffect("SSLR",this.useSSLR),this.renderer.setEffect("DOF",this.useDOF),this.renderer.setEffect("Bloom",this.useBloom),this.renderer.setEffect("Flare",this.useFlare),this.renderer.setEffect("OIT",f),this.renderer.setEffect("OITnoZ",f),this.setPicking({}),this.setPrePicking({}),this.useDefaultLights&&function(){n.setAmbientLight(2236962),n.directionalLight=new t.DirectionalLight(16777215,.81*Math.PI),n.directionalLight._phongReduction=!0;var e=n.directionalLight;e.position.set(40,40,40),e.castShadow=n.useShadowMap,e.shadowCameraNear=40,e.shadowCameraFar=150,e.shadowBias=-.001,e.shadowDarkness=.65,e.shadowMapWidth=n.shadowMapWidth,e.shadowMapHeight=n.shadowMapHeight,n.renderer.renderer.shadowMapAutoUpdate=!0,e.shadowCascade=!1,n.triLights?(e.intensity=.49*Math.PI,e.shadowDarkness=.3,n.directionalLight2=new t.DirectionalLight(16777215,.49*Math.PI),n.directionalLight2._phongReduction=!0,n.directionalLight3=new t.DirectionalLight(16777215,.49*Math.PI),n.directionalLight3._phongReduction=!0,n.directionalLight3.position.set(40,-40,40)):(n.directionalLight2=new t.DirectionalLight(3827071,1*Math.PI),n.directionalLight2._phongReduction=!0);n.directionalLight2.position.set(40,-40,40)}(),function(){n.dirLightGroundShadow=new t.DirectionalLight(16777215,0);var e=n.dirLightGroundShadow;e.position.set(0,0,40),e.castGroundShadow=n.useGroundShadow,e.onlyShadow=!0,e.shadowCascade=!1,e.shadowMapWidth=n.shadowMapWidth,e.shadowMapHeight=n.shadowMapHeight,e.shadowCameraNear=40,e.shadowCameraFar=150,e.shadowBias=-.001,e.shadowDarkness=.65}(),function(e){this.div.appendChild(this.renderer.renderer.domElement),e||document.addEventListener("contextmenu",this._contextMenu,!0);void 0===x._isInit&&x.init();this.manipulatorManager=new b(this)}.apply(this,[i.enableDocumentContextMenu]),this.defaultAnimationLoop&&m(0,!1),this.animate=m,this.addEvent("onPostInject",function(){m(0,!0)}),this.internalSceneGraph=new l(this,this.multiViewerFix,!i.showReferenceAxisSystem),this._safeInternalSceneGraph=this.internalSceneGraph,null!==this.currentViewpoint&&this.internalSceneGraph.scene.add(this.currentViewpoint.getCamera()),this.internalSceneGraph.scene.add(this.ambientLight),this.useDefaultLights&&(this.internalSceneGraph.scene.add(this.directionalLight),this.internalSceneGraph.scene.add(this.directionalLight2),this.triLights&&this.internalSceneGraph.scene.add(this.directionalLight3)),this.internalSceneGraph.scene.add(this.dirLightGroundShadow),this._glFPSCounter=null,this._glInfoCounter=null,this._glNodeCounter=null,this.fpsCounter=null,this.blurShadowEffect=null,this.displayHighlight=!1,this.name="",this.debugLocalBBox=!1,this.debugBBox=!1,this.debugHandleMatrix=!1,this.localBBox=null,this.BBox=null,(J=J||this.ODTMode)||this.setAdvancedPoliteHighlight(null,null),this},setWorldOrientation:function(e){var t;for(this._worldOrientation=e,t=0;t<this.viewpoints.length;t++)this.viewpoints[t]._setWorldOrientation(e);this._setPlaneGridOrientation(),this.internalSceneGraph.setWorldOrientation(e),this.renderer.renderer._setWorldOrientation(e),this._updateDirectionalLightWorldOrientation(e),this.ambience.setWorldOrientation(e),this.render({updateInfinitePlane:!0})},getWorldOrientation:function(){return this._worldOrientation},buildSkeleton:function(){null===this.div?(this.elements.container=UWA.createElement("div"),this.div=this.elements.container,this.div.setStyles({width:"100%",height:"100%"})):this.elements.container=UWA.extendElement(this.div),this.div.style["-ms-touch-action"]="none",this.canvas=UWA.createElement("canvas");this.canvas.webGLViewer=this,V.isActive()&&(this.canvas.setAttribute("data-rec-id","FakeRecManager"),V.registerElement(this.canvas,"DS/WebVisuRecord/FakeRec",!0));var e={width:"100%",height:"100%"};if(this._svgMode&&!O.getWebGLMode()){e.zIndex=10,e.position="absolute",e.left="0px";var t=document.createElementNS(this.getSvgNS(),"svg");t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.top="0px",t.style.left="0px",t.style.backgroundColor="white",t.style.zIndex=0,this.svgRootNode=t,this.svgRoot=document.createElementNS(this.getSvgNS(),"g"),this.svgRootNode.appendChild(this.svgRoot),this.div.appendChild(this.svgRootNode)}this.canvas.setStyles(e),this.useOffscreenCanvas&&(this.canvas.width=this.div.width,this.canvas.height=this.div.height),this.div.appendChild(this.canvas),V.isActive()&&(this.canvas.webGLViewer=this,this.canvas.isWebGLCanvas=function(){return!0})},getSvgNS:function(){return"http://www.w3.org/2000/svg"},addBackgroundSVGNode:function(e){e&&e._cssSVGNode&&(this.renderer.resetGSSOCache(),this.internalSceneGraph.svgRoot.addChild(e),this._updateSVGVisu())},removeBackgroundSVGNode:function(e){e&&e._cssSVGNode&&(this.renderer.resetGSSOCache(),this.internalSceneGraph.svgRoot.removeChild(e),this._updateSVGVisu())},getAllBackgroundSVGNodes:function(){return this.internalSceneGraph.svgRoot.children.concat([])},clearBackgroundSVGNodes:function(){this.renderer.resetGSSOCache();var e,t=this.getAllBackgroundSVGNodes();for(e=0;e<t.length;e++)this.removeBackgroundSVGNode(t[e])},buildSkeletonCss:function(){null===this.divCssElement?(this.divCssElement=UWA.createElement("div"),this.divCssElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),this.div.appendChild(this.divCssElement)):this.divCssElement=UWA.extendElement(this.divCssElement),this.divCssElement.style.WebkitTransformStyle="preserve-3d",this.divCssElement.style.MozTransformStyle="preserve-3d",this.divCssElement.style.oTransformStyle="preserve-3d",this.divCssElement.style.transformStyle="preserve-3d",this.divCssElement.id="divCssElement",this.divCss3DElement=UWA.createElement("div"),this.divCss3DElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),this.divCss3DElement.style.WebkitTransformStyle="preserve-3d",this.divCss3DElement.style.MozTransformStyle="preserve-3d",this.divCss3DElement.style.oTransformStyle="preserve-3d",this.divCss3DElement.style.transformStyle="preserve-3d",this.divCss3DElement.id="divCss3DElement",this.divCssElement.appendChild(this.divCss3DElement),this.divCss2DElement=UWA.createElement("div"),this.divCss2DElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),this.divCss2DElement.id="divCss2DElement",this.divCssElement.appendChild(this.divCss2DElement),this.divTrap=UWA.createElement("div",{id:"trapSelection"}),this.div.appendChild(this.divTrap)},initResources:function(e){var t=(!this.useHDR||this.mobile)&&this.antiAliasing&&"NoAA"!==this.antiAliasing;this.materialManager=new m(d.testMode.testMode,this.multiViewer,t,this),this.multiViewer=this.materialManager.multiViewer,this.multiViewer&&(this.materialManager.setCanvasSize(this,e.offsetWidth,e.offsetHeight),this.context2D=e.getContext("2d"))},getCanvasSize:function(){return{width:Math.floor(this.devicePixelRatio*this.SCREEN_WIDTH),height:Math.floor(this.devicePixelRatio*this.SCREEN_HEIGHT)}},onBackgroundModify:function(e){return this._modelEvent.subscribe({event:"VisuBackgroundColor",data:this.ambience.getBackgroundColor().getHex()},e)},onSwapVisibleSpace:function(e){return this._modelEvent.subscribe({event:"SwapVisibleSpace"},e)},onViewerResize:function(e){return this._modelEvent.subscribe({event:"Resize"},e)},onPreRender:function(e){return this._modelEvent.subscribe({event:"PreRender"},e)},onPostRender:function(e){return this._modelEvent.subscribe({event:"PostRender"},e)},onActivate:function(e){return this._modelEvent.subscribe({event:"Activate"},e)},onPreactivate:function(e){return this._modelEvent.subscribe({event:"Preactivate"},e)},onContext:function(e){return this._modelEvent.subscribe({event:"Context"},e)},unsubscribe:function(e){this._modelEvent.unsubscribe(e)},unsubscribeFromArray:function(e){if(e&&e.length)for(var t=0;t<e.length;t++)this.unsubscribe(e[t])},setMaterialMode:function(e){var t=this.renderer.renderer.materialMode!==e;this._renderStyle&&(this._renderStyle.setMaterialMode(e),this.internalSceneGraph.root.forceUpdate()),t&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.renderer.resetGSSOCache(),this.renderer.renderer.materialMode=!!e,this.render(),this._modelEvent.publish({event:"MaterialMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getMaterialMode:function(){return this.renderer.renderer.getMaterialMode(null,!1)},onMaterialModeChange:function(e){return this._modelEvent.subscribe({event:"MaterialMode"},e)},setPlaneViewMode({mode:e,plane:t}){let i=!1;null!=e&&e!==this._planeViewMode.mode&&(this._planeViewMode.mode=e,i=!0),t&&(this._planeViewMode.plane.copy(t).normalize(),i=!0),i&&(this.renderer.renderer._planeViewMode=this._planeViewMode,this.renderer.resetGSSOCache(),this.renderer.recompileAllShaders())},getPlaneViewMode(){return{mode:this._planeViewMode.mode,plane:this._planeViewMode.plane.clone()}},setBackgroundViewMode(e){this._backgroundViewMode!==e&&(this._backgroundViewMode=e,this.renderer.renderer._backgroundViewMode=e,this.renderer.resetGSSOCache(),this.renderer.recompileAllShaders())},getBackgroundViewMode(){return this._backgroundViewMode},invertNodeBackgroundView(e){this._invertBackgroundNodes!==e&&(this._invertBackgroundNodes=e,this.renderer.renderer._invertBackgroundNodes=e,this.renderer.resetGSSOCache(),this.renderer.recompileAllShaders())},isNodeBackgroundViewInverted(){return this._invertBackgroundNodes},pickNodeBackgroundView(e){this._pickBackgroundNodes!==e&&(this._pickBackgroundNodes=e,this.renderer.renderer._pickBackgroundNodes=e,this.renderer.resetGSSOCache())},isNodeBackgroundViewPickable(){return this._pickBackgroundNodes},setGasLookMode:function(e){this.setVisuAppearanceMode(e?t.DefaultAppearanceMode._GASLOOK_OLD:t.DefaultAppearanceMode.BASIC)},setVisuAppearanceMode:function(e){var i=this.renderer.renderer._defaultAppearanceType;if(this.renderer.renderer._defaultAppearanceType=e,i!==this.renderer.renderer._defaultAppearanceType){if(this.renderer.resetGSSOCache(),e!==t.DefaultAppearanceMode.__QA_AUTOMATION__&&i!==t.DefaultAppearanceMode.__QA_AUTOMATION__)switch(i){case t.DefaultAppearanceMode.GASLOOK:case t.DefaultAppearanceMode._GASLOOK_OLD:case t.DefaultAppearanceMode.GENERIC_PLASTIC:case t.DefaultAppearanceMode.GENERIC_METAL:case t.DefaultAppearanceMode._TRANSPARENT:t.cleanPredefinedMaterialCache();break;case t.DefaultAppearanceMode.CAST_ALUMINUM:case t.DefaultAppearanceMode.MACHINED_ALUMINUM:case t.DefaultAppearanceMode.CAST_STEEL:case t.DefaultAppearanceMode.BRUSHED_STEEL:case t.DefaultAppearanceMode.MACHINED_STAINLESS_STEEL:case t.DefaultAppearanceMode.COPPER:case t.DefaultAppearanceMode.BRASS:t.cleanPredefinedMaterialTextureCache()}this.render(),e!==t.DefaultAppearanceMode.__QA_AUTOMATION__&&this._modelEvent.publish({event:"VisuAppearanceMode",data:{viewer:this,value:this.getVisuAppearanceMode()}})}},getVisuAppearanceMode:function(){for(var e=Object.keys(t.DefaultAppearanceMode),i=0;i<e.length;i++)if(t.DefaultAppearanceMode[e[i]]===this.renderer.renderer._defaultAppearanceType)return e[i];return""},onVisuAppearanceModeChange:function(e){return this._modelEvent.subscribe({event:"VisuAppearanceMode"},e)},_setDebugMaterial:function(e){this.renderer.renderer._debugMaterialMode!==e&&(this.renderer.renderer._debugMaterialMode=e,this.renderer.recompileAllShaders(null),this.renderer.resetGSSOCache(),this.render())},setCustomMaterialModeParameters:function(e){if(e&&this.renderer){var i=this.renderer.renderer._customMaterialModeParams,r=!1;if(void 0!==e.useColorFromGAS&&(e.useColorFromGAS!==i.colorFromGAS&&(t.cleanPredefinedMaterialCache(),r=!0),i.colorFromGAS=e.useColorFromGAS),void 0!==e.color){var n=new t.Color(e.color);r=r||i.color.getHex()!==n.getHex(),i.color.copy(n)}void 0!==e.shininess&&(r=r||i.shininess!==e.shininess,i.shininess=e.shininess),void 0!==e.opacity&&(r=r||i.opacity!==e.opacity,i.opacity=e.opacity),r&&(this.renderer.resetGSSOCache(),this.render(),this._modelEvent.publish({event:"CustomMaterialModeParameters",data:{viewer:this,value:i}}))}},getCustomMaterialModeParameters:function(){return this.renderer?this.renderer.renderer._customMaterialModeParams:null},onCustomMaterialModeParametersChange:function(e){return this._modelEvent.subscribe({event:"CustomMaterialModeParameters"},e)},setDefaultPicking:function(i){this._defaultPicking=!!i;if(i){var r=WUX.Selection.PSOManager;this.centerMouseDownCB=function(e,t){},this.mouseMoveCB=function(t,i){var n=t.view;if(!x.RecordEventsManager||n){var o=t.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(n!==o&&!n.renderable){for(;n!==o&&n.parentElement&&!n.renderable;)n=n.parentElement;if(!n.renderable)return void(this.lastAddedToPSO&&!this.lastAddedToPSO.ownedByUser?(r.remove(this.lastAddedToPSO),this.lastAddedToPSO=null):this._modelEvent.publish({event:"Preactivate",data:{viewer:this,event:t,pickingResult:null,ctrl:i.isCtrlKeyPressed(),shift:i.isShiftKeyPressed()}}))}if(i&&!i.isMiddleButtonPressed()){var l,h,c,d;if(l=this.getMousePosition(t.getCurrentPosition(this.canvas)),this.pPicking.activated&&(!this.manipulatorManager||!this.manipulatorManager.isInManipulation(!0,!0))&&(!this.pPicking.disableWhileMoving||this.pPicking.disableWhileMoving&&this.currentViewpoint&&!this.currentViewpoint.isMoving())){if(d="mesh",d=this.pPicking.gpu?2===this.pPicking.primitive?"repHybrid":this.pPicking.primitive?"primHybrid":"mesh":2===this.pPicking.primitive?"repCPU":this.pPicking.primitive?"primCPU":"mesh",h=this.pick(l,d,this.pPicking.computeNormalDepth),c=!1,r.isEmpty()&&!h.path.length||(c=!0),this._fillXSOMode)if(h.path.length){if(this.pPicking.displayHL){var u=null;if(h.path[0]&&(u=h.path[0].getLastElement(!0)),u instanceof a&&!u._getExcludeFromPreHL()&&!u._getExcludeFromPSO()){for(var p,f=h.path[0];f&&f.getLastElement(!0).getPickParent();)f=f.getParentPath();if(!this.multiViewerFix&&!window.userRootOutOfPathElements)if((p=f)&&p.externalPath.length>1){var g=p.externalPath.concat([]);g.shift(),f=new s,void 0!==p.instanceId&&(f.instanceId=p.instanceId),f.setFromArray(g,p.internalPath)}var m={pathElement:f,event:t};if(!r.isIn(m)||r.get().length>1){var v=r.get().slice();r.remove(v),r.add(m)}this.lastAddedToPSO=m}}}else r.isEmpty()||(this.lastAddedToPSO=null,r.empty());this._modelEvent.publish({event:"Preactivate",data:{viewer:this,event:t,pickingResult:h,ctrl:i.isCtrlKeyPressed(),shift:i.isShiftKeyPressed()}})}c&&this.render({onlyPostProcess:!0});var y,S="@pickNothing";if(h&&h.path.length){var _=h.path[0].getLastElement();_ instanceof THREEDS.SubElement?"primitive"===_.getType()?S="@pickPrimitive":"rep"===_.getType()&&(S="@pickRep"):null!==_&&(S="@pickMesh")}y="@pickNothing"===S?{eventChannel:"/VISU/",eventType:"@onMoveEvent",eventID:S,event:t}:{eventChannel:"/VISU/",eventType:"@onMoveEvent",eventID:S,event:t,from:h.path[0],point:h.position,normal:h.normal,tangent:h.tangent,uv:h.uv,ray:h.ray},e.publish({event:"/VISU/",data:y}),this.debugEvents>=6&&console.log(y)}}},this.centerMouseUpCB=function(i,r){if(r&&r.isMiddleClick()){var n,a;n=this.getMousePosition(i.getCurrentPosition(this.canvas)),r.lockPan||r.lockReframeOnDblTap||null===this.currentViewpoint||(null!==(a=this.pick(n,"mesh",!0)).position?this.currentViewpoint.centerCamera(a.position):r._2DMode&&this.currentViewpoint.centerCameraSVG(new t.Vector2(.5*this.div.clientWidth,.5*this.div.clientHeight),new t.Vector2(n.xPix,n.yPix)));var s={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@middleClick",event:i};e.publish({event:"/VISU/",data:s}),this.debugEvents>=6&&console.log(s)}},this.leftMouseDownCB=function(t,i){var r=t.view;if(!x.RecordEventsManager||r){var n=t.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap,a=t.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(r===n&&(r=a),r!==a&&!r.renderable){for(;r!==a&&r.parentElement&&!r.renderable;)r=r.parentElement;if(!r.renderable)return}if(i&&!i.isMiddleButtonPressed()&&i.isLeftClick()){if(this.picking.trapSelection&&this.trapSelection){var s=this.getMousePosition(t.getCurrentPosition(this.canvas)),o=this.pick(s,"mesh",!1);if(o&&o.path&&o.path.length)for(var l=o.path[0].externalPath,h=0;h<l.length;h++)if(l[h].getIsManipulator()){this.trapSelection.interrupt();break}}var c={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@leftClickDown",event:t};e.publish({event:"/VISU/",data:c}),this.debugEvents>=6&&console.log(c)}}},this.leftMouseUpCB=function(e,t){this._doPickingFromMouseEvent(e,t,null)},this._doPickingFromMouseEvent=function(t,i,r){if(this._defaultPicking){var n,a=r||this.trapSelection,o=t.view;if(!x.RecordEventsManager||o){var l=t.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap,h=t.path&&this.canvas.impl?this.canvas.impl:this.canvas;o===l&&(o=h);var c=!1;if(this.picking.trapSelection&&a&&(c=void 0!==(n=a.getExtremities()).pt&&(n.xPix!=n.pt.xPix||n.yPix!=n.pt.yPix)),!c&&o!==h&&!o.renderable){for(;o!==h&&o.parentElement&&!o.renderable;)o=o.parentElement;if(!o.renderable)return void null}if(i&&!i.isMiddleButtonPressed()){if(this.picking.activated){var d,u;null,null,null,null,c||(n=this.getMousePosition(t.getCurrentPosition(this.canvas)));var p=a&&a.isActive,f=this.magnifier&&this.magnifier.active&&"Touch"===t.getType(),g=t.contextButton?i.isRightClick():i.isLeftClick();if(!p&&(!f||window.magnifierCheckDistance&&!this.magnifier.displayed)&&!g)return;if(window.magnifierCheckDistance&&f&&this.magnifier.displayed){if(this.magnifier.displayed=!1,!this.magnifier.enableSelection)return;this.magnifier.enableSelection=!1}if(!r&&this.manipulatorManager&&this.manipulatorManager.isInManipulation())return;o!==h&&(n.event=t),u="mesh",u=c&&this.picking.trapSelection?this.picking.trapGPU?2===this.picking.trapPrimitive?"repHybrid":this.picking.trapPrimitive?"primHybrid":"mesh":2===this.picking.trapPrimitive?"repCPU":this.picking.trapPrimitive?"primCPU":"meshCPU":this.picking.gpu?2===this.picking.primitive?"repHybrid":this.picking.primitive?"primHybrid":"mesh":2===this.picking.primitive?"repCPU":this.picking.primitive?"primCPU":a&&n.pt?"meshCPU":"mesh",d=this.pick(n,u,this.picking.computeNormalDepth,void 0,r);var m,v,y=i.isShiftKeyPressed(),S=i.isCtrlKeyPressed()||this.forceMultiSel,_=(c=void 0!==n.pt&&(n.xPix!=n.pt.xPix||n.yPix!=n.pt.yPix),0);if(!this.multiViewerFix&&!window.userRootOutOfPathElements)for(_=0;_<d.path.length;_++)if((m=d.path[_])&&m.externalPath.length>1){var b=m.externalPath.concat([]);b.shift(),d.path[_]=new s,d.path[_].setFromArray(b,m.internalPath),void 0!==m.instanceId&&(d.path[_].instanceId=m.instanceId)}if(this._fillXSOMode&&(v=this.addToCSOHSO(d,{event:t,multiSel:S,additiveMode:y,trapSel:c})),null!==this.internalSceneGraph){if(this._fillXSOMode){var w="@pickNothing";if(d.path.length){var M=d.path[0].getLastElement();M instanceof THREEDS.SubElement?"primitive"===M.getType()?w="@pickPrimitive":"rep"===M.getType()&&(w="@pickRep"):null!==M&&(w="@pickMesh")}var C={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:w,event:t,from:d.path[0],addedToCSO:v.addedToCSO,removedFromCSO:v.removedFromCSO,point:d.position,normal:d.normal,tangent:d.tangent,uv:d.uv,ray:d.ray};e.publish({event:"/VISU/",data:C}),this.debugEvents>=6&&console.log(C)}this._modelEvent.publish({event:"Activate",data:{viewer:this,event:t,pickingResult:d,ctrl:i.isCtrlKeyPressed(),shift:i.isShiftKeyPressed(),trapSelection:c,contextButton:!!t.contextButton}})}this.render({onlyPostProcess:!0})}else{var P;(P=WUX.Selection.HSOManager).isEmpty()||(P.empty(),this.render({onlyPostProcess:!0}))}null}else null}}},this.rightMouseUpCB=function(t,i){if(t.view===this.canvas&&i&&!i.isMiddleButtonPressed()&&!i.isLeftButtonPressed()&&i.isRightClick()){this.picking.contextPick&&(t.contextButton=!0,this.leftMouseUpCB(t,i));var r={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@rightClick",event:t};e.publish({event:"/VISU/",data:r}),this._modelEvent.publish({event:"Context",data:{viewer:this,event:t,ctrl:i.isCtrlKeyPressed()}}),this.debugEvents>=6&&console.log(r)}}}else this.centerMouseDownCB=null,this.mouseMoveCB=null,this.leftMouseDownCB=null,this.leftMouseUpCB=function(e,t){var i=e.view;if(!x.RecordEventsManager||i){var r=e.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap,n=e.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(i===r&&(i=n),i!==n&&!i.renderable){for(;i!==n&&i.parentElement&&!i.renderable;)i=i.parentElement;if(!i.renderable)return}t&&!t.isMiddleButtonPressed()&&(this.trapSelection&&(!this.trapSelection||this.trapSelection.isActive)||t.isLeftClick())&&(this.manipulatorManager&&this.manipulatorManager.isInManipulation()||this._modelEvent.publish({event:"Activate",data:{viewer:this,event:e,ctrl:t.isCtrlKeyPressed(),shift:t.isShiftKeyPressed()}}))}},this.rightMouseUpCB=null},getDefaultPicking:function(){return this._defaultPicking},setCurrentHighlightSet:function(e){this.renderer.resetGSSOCache(),this.highlightColor=e?e.sceneHL.highlightData:null},setRenderSettings:function(e){!e||void 0!==e.type&&"rasterizer"!==e.type||(e.ambientOcclusion&&e.ambientOcclusion.activation&&(this.setSSAOParameters({dynamicRadius:!1,adaptativeRadius:!0,radius:e.ambientOcclusion.radius?e.ambientOcclusion.radius:100,radiusMin:.005,radiusMax:.12,minPixelRadius:14,attenuation:.984,contrast:e.ambientOcclusion.intensity?e.ambientOcclusion.intensity:1,power:1,thresholdAngle:1.32645023152}),viewer.setSSAO(!0)),e.reflection&&e.reflection.activation&&viewer.setSSLR(!0))},setAmbience:function(e,t){this.renderer.resetGSSOCache();var i=this.internalSceneGraph&&this.internalSceneGraph.scene;this.ambience.removeLights(i,this.sceneBackground);"Custom"!==this.visuEnv&&(this.visuEnv="Custom",this._modelEvent.publish({event:"VisuEnv",data:{viewer:this,value:"Custom"}})),this.ambience.isOCA&&this.ambience.dispose(),this.ambience=e,this.ambience.resize(this.SCREEN_WIDTH,this.SCREEN_HEIGHT,this.devicePixelRatio,this.renderer),t&&(this.setGroundOptions({groundSize:100,groundShadow:!1,displayPlane:!1,displayGrid:!1,displayGridFromBelow:!1,gridNbSteps:5,gridLabels:null,gridLabelCallback:null,gridDisplayLabelCallback:null,planeMirror:!1,blurryMirror:!1,planeColor:"#EEEEEE",planeOpacity:1,planeTexture:null,planeTextureScale:1,gridColor:"#EEEEEE",gridFalloff:0,planeFalloff:0,planeBorder:!1,planeBorderColor:"#FFFFFF"}),this.setGroundOptions(e.getGroundOptions())),this.ambience.updateAmbience()},removeAmbience:function(){var e=this.internalSceneGraph&&this.internalSceneGraph.scene;this.ambience.removeLights(e,this.sceneBackground),this.removeEnvMap(),this.ambience.needUpdateIBL.delete(this),this.renderer.SkyScatteringEffect&&this.renderer.SkyScatteringEffect.setEnabled(!1),this.ambience.isOCA&&this.ambience.dispose();var t=new B({viewer:this,v2:!0});this.setAmbience(t,!0)},createHighlightSet:function(e,t,i,r){i=null==i?!J:!!i;var n=null;if(!(!t&&r)&&(n=this._getHighlightSet(e,t,i)))return n;if((n=new P(this.internalSceneGraph)).setHighlightData(i,e),n.setMultiColorMode(!0),this.renderer._postProHighlight){var a=this.getEffect("Highlight");a.addScene(n),(a=this.getEffect("Canvas2DHighlight")).addScene(n)}else this.renderer._HighlightMobileNonEffect.addScene(n);return t||n.detachToHSO(),this.highlightSets.push(n),n},removeHighlightSet:function(e){this.renderer.resetGSSOCache();this._removeHighlightSet(e.getHighlightData(),e.linkToHSO);if(this.renderer._postProHighlight){var t=this.getEffect("Highlight");t.removeScene(e),(t=this.getEffect("Canvas2DHighlight")).removeScene(e)}else this.renderer._HighlightMobileNonEffect.removeScene(e);e.detachToHSO(),e.clearAll()},_getHighlightSet:function(e,t,i){for(var r=this.highlightSets,n=0;n<r.length;n++){var a=r[n];if(a.linkToHSO==t&&a.getHighlightData().isEqual(e)&&a.getHighlightData()._needsDepth===i)return a}return null},_removeHighlightSet:function(e,t){for(var i=this.highlightSets,r=0;r<i.length;r++){var n=i[r];if(n.linkToHSO==t&&n.getHighlightData().isEqual(e))return i.splice(r,1),!0}return!1},addToCSOHSO:function(e,t){function i(i,n,a,s){var o,l,h={removed:[],added:[]};a&&(h.removed=function(e){for(var t=e.get(),i=[],r=0;r<t.length;r++){var n=t[r],a=n.pathElement;!a&&n.options&&(a=n.options.pathElement),a&&i.push(a)}return i}(n),n.empty());var c,d,u,p,f=[],g=[],m={highlightColor:r.highlightColor};for(c=n.get(),o=0;o<i.length;o++){for(d=i[o],u=!1,l=0;l<c.length&&!u;l++)!(p=c[l]).pathElement&&p.options&&p.options.pathElement,d.isEqual(c[l].pathElement)&&(c[l].position&&(c[l].position=e.position),f.push(c[l]),u=!0);u||g.push({pathElement:d,event:t.event,position:e.position,parameters:m})}if(s)for(f.length>0&&n.remove(f),o=0;o<f.length;o++)h.removed.push(f[o].pathElement);for(g.length>0&&n.add(g),o=0;o<g.length;o++)h.added.push(g[o].pathElement);return h}var r=this,n=WUX.Selection.HSOManager,a=WUX.Selection.CSOManager,s=function(t){var i,r,n=[],a=!1;for(i=0;i<e.path.length&&!a;i++)(r=e.path[i]).getLastElement(!0)._getExcludeFromCSO()||(n.push(r),t||(a=!0));if(!n.length&&e.path.length)return null;var s,o,l,h,c={CSO:[],HSO:[]},d=[];for(i=0;i<n.length;i++){for(r=n[i],s=!1;r.getLastElement(!0).getPickParent();)r=r.getParentPath(),s=!0;if(l=!1,s){for(o=0;o<d.length;o++)d[o].isEqual(r)&&(l=!0);l||d.push(r)}l||(c.CSO.push(r),(h=r.getLastElement(!0))._getExcludeFromHL()||h._getExcludeFromHSO()||c.HSO.push(r))}return c}(t.trapSel);if(!s)return{addedToCSO:[],removedFromCSO:[]};var o=!t.multiSel,l=!t.additiveMode,h=i(s.CSO,a,o,l);return this.picking.displayHL&&i(s.HSO,n,o,l),{addedToCSO:h.added,removedFromCSO:h.removed}},getVersion:function(){return this.version},getWebGLContext:function(){return this.renderer.renderer.getContext()},getRenderer:function(){return this.renderer.renderer},getInfos:function(){return this.renderer.getInfos()},addViewpoint:function(e,t){null!==e&&(e._setWorldOrientation(this._worldOrientation),e._setNode(this.internalSceneGraph.root),this._2DMode&&e._set2DMode(!0,t),this.viewpoints.push(e)),1===this.viewpoints.length&&this.selectViewpoint(0),this.internalSceneGraph.onAddViewpoint(),this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}})},addMultiViewpoint:function(e,t,i){e._setWorldOrientation(this._worldOrientation),i&&e._setNode(this.internalSceneGraph.root),t?this._viewpointManager.addMainViewpoint(e,!!i):this._viewpointManager.addViewpoint(e,!!i)},addNodeToViewpoint:function(e,t){this._viewpointManager.addNodeToViewpoint(e,t)},removeViewpoint:function(e){e<0||e>=this.viewpoints.length||(this.viewpoints[e]==this.currentViewpoint&&(null!==this.internalSceneGraph&&this.internalSceneGraph.scene.remove(this.currentViewpoint.getCamera()),this.currentViewpoint=null),this.viewpoints.splice(e,1),this.viewpoints.length>0&&this.selectViewpoint(0))},selectViewpoint:function(e,t){!t&&(e<0||e>=this.viewpoints.length)||(null!==this.currentViewpoint&&null!==this.internalSceneGraph&&this.internalSceneGraph.scene.remove(this.currentViewpoint.getCamera()),this.currentViewpoint&&this._viewpointManager.removeViewpoint(this.currentViewpoint),this.currentViewpoint=t||this.viewpoints[e],this._viewpointManager.addMainViewpoint(this.currentViewpoint,!0),this.fetchMePreferenceSettings&&this.currentViewpoint._setApplicationDefaultController(),this.internalSceneGraph.onSelectViewpoint(),null!==this.internalSceneGraph&&this.internalSceneGraph.scene.add(this.currentViewpoint.getCamera()),this.render({updateInfinitePlane:!0}))},getViewpoints:function(){return this.viewpoints},setTrackingViewpoint:function(e){this.trackingViewpoint=e},getTrackingViewpoint:function(){return this.trackingViewpoint},updatePlatformPreferences:function(){if(this.fetchMePreferenceSettings){this.currentViewpoint._setApplicationDefaultController(!0)}},attachScene:function(e){if(null!==e){"I solemnly swear that I am up to no good."!==e.passcode&&n.DEPRECATED_SceneGraph(new Error),e.parentSceneGraph=this.internalSceneGraph;var t=this._sceneGraph;this._sceneGraph=null,t&&this.removeNode(t),this.addNode(e._private_root),this._sceneGraph=e}},addNode:function(e,t){if(e instanceof w)throw new Error("addNode with SceneGraph");this.internalSceneGraph&&this.internalSceneGraph.addUserNode(e,null!==this._sceneGraph),this.render({updateInfinitePlane:!!t})},removeNode:function(e,t){this.internalSceneGraph&&(this.internalSceneGraph.removeUserNode(e,null!==this._sceneGraph),this.render({updateInfinitePlane:!!t}))},getNodes:function(){return this.internalSceneGraph?this.internalSceneGraph.getUserNodes(null!==this._sceneGraph):null},getRootNode:function(){return this.internalSceneGraph?this.internalSceneGraph.getUserRoot(null!==this._sceneGraph):null},setClippingPlanes:function(e){this.renderer.resetGSSOCache();var t=this.getRenderer();if(null===t)return!1;if(e&&!this.clipPlanes.length)return!1;var i=t.clipPlanesEnabled;return t.clipPlanesEnabled=e,i!==e&&null!==this.internalSceneGraph&&this.render(),!0},getClippingPlanes:function(){var e=this.getRenderer();return null===e?null:e.clipPlanes},addClippingPlane:function(e,t){return this.renderer.resetGSSOCache(),this._requestClippingUpdate(),this.clipPlanes.indexOf(e)<0&&this.clipPlanes.push(e),this._addClippingPlane(e),this.setSectionCappingMaterial(e,t),!0},setSectionCappingMaterial:function(e,t){this._requestClippingUpdate(),this.renderer.setSectionCappingMaterial(e,t)},removeClippingPlane:function(e){this._requestClippingUpdate(),this.renderer.resetGSSOCache();var t=this.clipPlanes.indexOf(e);t>=0&&this.clipPlanes.splice(t,1),this._removeClippingPlane(e)},setClippingPlaneUpVector:function(e,t){this._requestClippingUpdate(),e.upVector=t.clone(),e.upVector.normalize()},setSectionCapping:function(e){return this._requestClippingUpdate(),this.renderer.resetGSSOCache(),e&&this.getRenderPriority()?(console.warn("Section capping is not compatible with render priority mode"),!1):(this.renderer.renderer.sectionCappingEnabled=!!e,this.render(),!0)},getSectionCapping:function(){return this.renderer.renderer.sectionCappingEnabled},_updateShadowMaps:function(){let e=this._getScenegraphs();this.renderer.resetGSSOCache();for(let r=0;r<e.length;r++){var t=e[r].root3js;if(null!==t&&void 0!==typeof t)for(var i=0;i<t.parent.__lights.length;i++)t.parent.__lights[i].updateShadowMap=!0}},getVisibleSpace:function(){return this.visibleSpace},swapVisibleSpace:function(){this.renderer.resetGSSOCache(),this.visibleSpace=(this.visibleSpace+1)%2,this.renderer.visibleSpace=this.visibleSpace,this.renderer.renderer.visibleSpace=this.visibleSpace;var e,i,r=new t.Color(this.showBgColor);if(this.ambience.setBackgroundAlpha(this.showBgAlpha),this.visibleSpace||r.desaturate(1).alphaBlend(ne,.5),this.ambience.setBackgroundColor(r.getHex()),this._setBackgroundColor(),this._svgMode&&this.svgRootNode)for(i="#"+ne.getHexString(),this.svgRootNode.style.backgroundColor=this.visibleSpace?"#ffffff":i,e=0;e<this.internalSceneGraph.svgRoot.children.length;e++)this.internalSceneGraph.svgRoot.children[e]._updateSVGVisibility();if(this.ambience.getBackground().hasGradient()){var n=this.ambience.getBackground().getColors(),a=[];for(e=0;e<n.length;e++)this.visibleSpace?a.push(new t.Color(this.showGradientBackground[e].getHex())):a.push(n[e].desaturate(1).alphaBlend(ne,.5));this.ambience.getBackground().setColors(a)}this._displayGrid&&(this.visibleSpace?this.gridColor.copy(this.showGridColor):this.gridColor.desaturate(1).alphaBlend(ne,.5)),this._infinitePlane&&(this.visibleSpace?this.planeColor.copy(this.showPlaneColor):this.planeColor.desaturate(1).alphaBlend(ne,.5)),this.getRobot()&&this.getRobot().isTargetGone(this.visibleSpace)&&this.getRobot().setConnectionState(!1),this._updateShadowMaps(),this.render({updateInfinitePlane:!0}),this._modelEvent.publish({event:"SwapVisibleSpace",data:{viewer:this,visibleSpace:this.visibleSpace}})},getMousePosition:function(e){if(!(e instanceof t.Vector2)&&(console.warn("DEPRECATED: WebGLViewer.getMousePosition() now only accepts THREEDS.Core.Vector2 2D position on the screen as argument."),e.changedTouches)){var i=e.changedTouches.length?e.changedTouches[0]:e,r=this.canvas.getBoundingClientRect(),n=i.pageX-r.left,a=i.pageY-r.top;e=new t.Vector2(n,a)}var s=this.devicePixelRatio;return{x:e.x/this.canvas.offsetWidth*2-1,y:-e.y/this.canvas.offsetHeight*2+1,xPix:e.x*s,yPix:e.y*s}},computeDistanceFromCamera:function(e){return this.renderer.computePositionGPU(this.internalSceneGraph,this.currentViewpoint,e).distanceTo(this.currentViewpoint.camera.position)},invalidatePickingBuffer:function(){this.renderer.pickingGPUComposerContext&&(this.renderer.pickingGPUComposerContext.needsUpdate=!0,this.renderer.meshesGPU={},this.renderer.resetGSSOCache())},setPickingPriority:function(e){this.pickingPriorityMapping=e,this.renderer.resetGSSOCache()},pick:function(e,i,r,n,a,o){null!==this._pageObjectData&&(void 0!==e.x&&void 0!==e.y||(e=this.getMousePosition(new t.Vector2(e.xPix,e.yPix))));var l,h,c,d={ray:null},u=n||this.pickingPriorityMapping,p=!1;this.infPlaneSmall&&u&&(p=this.infPlaneSmall.visible,this.infPlaneSmall.visible=!1),h={path:[],position:null,normal:null,tangent:null,uv:null,positions:[],normals:[],tangents:[],uvs:[],ray:null},this.renderer.overrideUpdate(this.internalSceneGraph,this.getCurrentSceneGraphState());var f=!1;switch(i){case"mesh":for(l=this.computeIntersection(e,!0,!1,r,d,u,a,o),c=0;c<l.length;++c)l[c].object?(l[c].path=new s,l[c].path.setFromOccurrence(l[c].object._occurrence)):l[c].path=null;break;case"meshCPU":for(l=this.computeIntersection(e,!1,!1,r,d,u,a,o),f=!0,c=0;c<l.length;++c)l[c].object?(l[c].path=new s,l[c].path.setFromOccurrence(l[c].object._occurrence)):l[c].path=null;break;case"primHybrid":for(l=this.computeIntersection(e,!0,!0,r,d,u,a,o),c=0;c<l.length;++c){var g=l[c].object?l[c].object._occurrence:null;if(l[c].primitive&&g){var m=!0===l[c].primitive?null:THREEDS.SubElement.getFromSGNode(l[c].primitive);l[c].path=new s,l[c].path.setFromOccurrence(g,m,void 0,!0)}else l[c].object&&l[c].object._instancingInfos&&l[c].object._instancingInfos.isInstanceNode3D?(l[c].path=new s,l[c].path.setFromOccurrence(g)):g&&g.node&&!1===g.node.primitivePicking?(l[c].path=new s,l[c].path.setFromOccurrence(g)):l[c].path=null}break;case"prim":case"primCPU":for(l=this.computeIntersection(e,!1,!0,r,d,u,a,o),f=!0,c=0;c<l.length;++c)if(l[c].primitive&&l[c].object._occurrence){m=!0===l[c].primitive?null:THREEDS.SubElement.getFromSGNode(l[c].primitive);l[c].path=new s,l[c].path.setFromOccurrence(l[c].object._occurrence,m,void 0,!0)}else l[c].path=null;break;case"rep":case"repCPU":for(l=this.computeIntersection(e,!1,!0,r,d,u,a,o),f=!0,c=0;c<l.length;++c)if(l[c].primitive&&l[c].object._occurrence){m=!0===l[c].primitive?null:THREEDS.SubElement.getFromSGNode(l[c].primitive.getRep());l[c].path=new s,l[c].path.setFromOccurrence(l[c].object._occurrence,m,void 0,!0)}else l[c].path=null;break;case"repHybrid":for(l=this.computeIntersection(e,!0,!0,!1,d,u,a,o),c=0;c<l.length;++c)if(l[c].primitive&&l[c].object._occurrence){m=!0===l[c].primitive?null:THREEDS.SubElement.getFromSGNode(l[c].primitive.getRep());l[c].path=new s,l[c].path.setFromOccurrence(l[c].object._occurrence,m,void 0,!0)}else l[c].object&&l[c].object._instancingInfos&&l[c].object._instancingInfos.isInstanceNode3D?(l[c].path=new s,l[c].path.setFromOccurrence(l[c].object._occurrence)):l[c].path=null}h.ray=d.ray;var v=!1;for(c=0;c<l.length;++c)if(null!==l[c].path)void 0!==l[c].instanceId&&(l[c].path.instanceId=l[c].instanceId),h.path.push(l[c].path),v||(v=!0,h.position=l[c].point,h.normal=l[c].normal,h.tangent=l[c].tangent,h.uv=l[c].uv),h.positions.push(l[c].point?l[c].point:null),h.normals.push(l[c].normal?l[c].normal:null),h.tangents.push(l[c].tangent?l[c].tangent:null),h.uvs.push(l[c].uv?l[c].uv:null);else if(!f)break;if(!v)if((this._displayGrid||this._infinitePlane)&&h.ray&&h.ray.direction.z<0){h.normal=new t.Vector3(0,0,1);var y=new t.Plane(h.normal,this.offsetPlaneSmall.z);h.position=h.ray.intersectPlane(y)}else l.length&&(h.position=l[0].point,h.normal=l[0].normal);return this.infPlaneSmall&&u&&(this.infPlaneSmall.visible=p),h},pickInVolume:function(e,i,r){if(!e||!i)return{inside:[],partial:[],outside:[]};var n=this.internalSceneGraph.scene,a=[];if(r)a=a.concat(r._getRenderableOccurrences(this,!1));else if(n instanceof t.Mesh)a=[n];else{for(var o=this._getUserPassManager()._getActiveRenderLists(),l=[],h=0;h<o.length;h++)l=l.concat(n.getWebGLObjects(o[h],0));for(h=0;h<l.length;h++)null!==l[h]&&a.push(l[h].object)}var[c,d,u]=this.getRenderMode().getMasks(),p=new t.Sphere;if(e instanceof t.Box3){var f=e.getPoints(i),g=[[0,2,1],[4,0,5],[6,4,7],[2,6,3],[5,1,7],[4,6,0]],m=[],v=new t.Vector3,y=new t.Vector3;for(h=0;h<g.length;h++){var S=g[h];v.copy(f[S[1]]).sub(f[S[0]]),y.copy(f[S[2]]).sub(f[S[0]]),v.cross(y).normalize(),m.push((new t.Plane).setFromNormalAndCoplanarPoint(v,f[S[0]]))}p=new t.Frustum(m[0],m[1],m[2],m[3],m[4],m[5])}else{if(!(e instanceof t.Sphere))return{inside:[],partial:[],outside:[]};(p=e.clone()).applyMatrix4(i)}var _=[{path:[]},{path:[]},{path:[]}],x=[],b=[],w=[],M=[x,b,w];for(h=0;h<a.length;h++){var C=a[h];ee(C.visible,C.visibilityFree,this.visibleSpace,C.layer,C._occurrence)&&!1!==C.noPickThrough&&((void 0===C.pickable||C.pickable)&&j._meshIntersectVolume(C,p,c,u,d,x,b,w,this.visibleSpace))}for(var P=0;P<M.length;P++){var E=M[P];for(h=0;h<E.length;++h)E[h].object?(E[h].path=new s,E[h].path.setFromOccurrence(E[h].object._occurrence)):E[h].path=null}for(P=0;P<M.length;P++)for(E=M[P],h=0;h<E.length;++h)null!==E[h].path&&(void 0!==E[h].instanceId&&(E[h].path.instanceId=E[h].instanceId),_[P].path.push(E[h].path));return{inside:_[0],outside:_[1],partial:_[2]}},computeIntersection:function(e,i,r,a,s,l,h,c){var d,u,p,f,g,m,v,y,S,_,x,b=this.trapSelection||h,w=[];if(u=new t.Projector,v=void 0!==i&&i,m=void 0!==r&&r,y=void 0!==a&&a,this.debugPickHybrid&&(y=!0),x=!(!this.picking.trapSelection||!b||void 0===e.pt||e.pt.xPix===e.xPix&&e.pt.yPix===e.yPix),null===this.currentViewpoint||null===this.internalSceneGraph)return w;var M=this.devicePixelRatio;if(d=new t.Vector2(e.xPix/M,e.yPix/M),p=this.currentViewpoint.create3DRayFrom2DPoint(d),void 0!==s&&void 0!==s.ray&&(s.ray=p),!x&&e.event){var P=e.event.getView(),E=P.renderable;if(!E)for(;P!==this.canvas&&(P.parentElement||P.parentNode)&&!E;)E=(P=P.parentElement||P.parentNode).renderable;if(E&&E.noPickThrough){var A,T;if(E instanceof t.CSS3DNode){var D=(new t.Matrix4).multiplyMatrices(E.matrixWorld,E.scaleCSS),I=e.event.getCurrentPosition(P);(A=new t.Vector3(I.x,I.y,0)).applyMatrix4(D);var R=D.elements;T=new t.Vector3(R[8],R[9],R[10])}else{var O=E.position.clone(),L=(this.currentViewpoint.camera.getLookAt(),(new t.Plane).setFromNormalAndCoplanarPoint(this.currentViewpoint.camera.getLookAt(),O)),V=(E.element.getBoundingClientRect(),this.getMousePosition(new t.Vector2(e.xPix,e.yPix)));V=new t.Vector3(V.x,V.y,1),u.unprojectVector(V,this.currentViewpoint.camera),A=new t.Ray(this.currentViewpoint.camera.position,V.clone().sub(this.currentViewpoint.camera.position).normalize()).intersectPlane(L),T=L.normal}return w[0]={object:E,primitive:!(!E||!E.primitive),point:A,normal:T},w}}if(x){if(y=!1,e.x===e.pt.x||e.y===e.pt.y)return w;if(m||!v){var F,B,N,G,k,U;_=new t.Vector3(e.pt.x,e.pt.y,1);var z=this.currentViewpoint.camera,H=z.position,W=z.getLookAt();if(k=(new t.Plane).setFromNormalAndCoplanarPoint(W,H.clone().add(W.clone().multiplyScalar(z.near))),U=(new t.Plane).setFromNormalAndCoplanarPoint(W.clone().multiplyScalar(-1),H.clone().add(W.clone().multiplyScalar(z.far))),this.currentViewpoint.getProjectionType()===o.PERSPECTIVE){var j=new t.Vector3(e.x,e.y,1);u.unprojectVector(j,z),j.sub(H).normalize();var X=new t.Vector3(e.pt.x,e.y,1);u.unprojectVector(X,z),X.sub(H).normalize();var q=new t.Vector3(e.pt.x,e.pt.y,1);u.unprojectVector(q,z),q.sub(H).normalize();var Z=new t.Vector3(e.x,e.pt.y,1);u.unprojectVector(Z,z),Z.sub(H).normalize();var Y=new t.Vector3;Y.copy(j),N=(new t.Plane).setFromNormalAndCoplanarPoint(j.cross(X).normalize(),H),B=(new t.Plane).setFromNormalAndCoplanarPoint(X.cross(q).normalize(),H),G=(new t.Plane).setFromNormalAndCoplanarPoint(q.cross(Z).normalize(),H),F=(new t.Plane).setFromNormalAndCoplanarPoint(Z.cross(Y).normalize(),H)}else{var Q=z.up.clone(),K=new t.Vector3(1,0,0).applyQuaternion(z.quaternion),J=new t.Vector3(e.x,e.y,1);u.unprojectVector(J,z);var $=new t.Vector3(e.pt.x,e.pt.y,1);u.unprojectVector($,z),N=(new t.Plane).setFromNormalAndCoplanarPoint(Q.clone().negate(),J),B=(new t.Plane).setFromNormalAndCoplanarPoint(K.clone().negate(),$),G=(new t.Plane).setFromNormalAndCoplanarPoint(Q,$),F=(new t.Plane).setFromNormalAndCoplanarPoint(K,J)}S=new t.Frustum(F,B,N,G,k,U)}}var ee,[te,ie,re]=this.getRenderMode().getMasks(),ne=t.getDevicePixelRatio();if(v){if(this.currentViewpoint._updateRobotCamera(this.internalSceneGraph),this.renderer.smallTargetPicking?(w=this.renderer.computeIntersectionGPUSmallTarget(this.internalSceneGraph,this.currentViewpoint,e,y,x,l,v&&m&&!x),this.currentViewpoint.camera.fullWidth&&(this.lockRenderIteration(),this.internalSceneGraph.onViewpointChange(),this.unlockRenderIteration())):w=this.renderer.computeIntersectionGPU(this.internalSceneGraph,this.currentViewpoint,e,y,x,null,null,null,l,v&&m&&!x,!!this._pageObjectData),w.length&&m){for(var ae=[],se=0;se<w.length;++se){var oe=w[se];oe.object&&oe.object._instancingInfos&&oe.object._instancingInfos.isInstanceNode3D?ae.push(oe):!(oe.object instanceof t.Mesh)||oe.object._occurrence&&oe.object._occurrence.node&&!1===oe.object._occurrence.node.primitivePicking||(ee=this._getUserPassManager()._getActiveRenderLists(),ae=x?ae.concat(p.intersectMeshInstancesZones3D(oe.object,this.currentViewpoint.camera,new t.Vector3(e.x,e.y,1),_,S,r,te,ie,re,this.renderer.deviceWidth,this.renderer.deviceHeight,!b.forwardSelect,{renderLists:ee,inVisibleSpace:this.visibleSpace,useViewerPickingRules:!0})):ae.concat(p.intersectMeshInstances(oe,this.currentViewpoint.camera,new t.Vector3(e.x,e.y,1),te,ie,re,this.renderer.deviceWidth,this.renderer.deviceHeight,this.picking.tolerance,{debugPickHybrid:this.debugPickHybrid,renderLists:ee,inVisibleSpace:this.visibleSpace,devicePixelRatio:ne,candidatesOnly:!1,useViewerPickingRules:!0})))}ae.length&&(w=ae),p._cleanIntersectionsList(w,!x)}}else{if(ee=this._getUserPassManager()._getActiveRenderLists(),w=x?w.concat(p.intersectMeshInstancesZones3D(this.internalSceneGraph.scene,this.currentViewpoint.camera,new t.Vector3(e.x,e.y,1),_,S,r,te,ie,re,this.renderer.deviceWidth,this.renderer.deviceHeight,!b.forwardSelect,{renderLists:ee,inVisibleSpace:this.visibleSpace,useViewerPickingRules:!0})):p.intersectMeshInstances({object:this.internalSceneGraph.scene},this.currentViewpoint.camera,new t.Vector3(e.x,e.y,1),te,ie,re,this.renderer.deviceWidth,this.renderer.deviceHeight,this.picking.tolerance,{debugPickHybrid:!1,renderLists:ee,inVisibleSpace:this.visibleSpace,devicePixelRatio:ne,candidatesOnly:!1,useViewerPickingRules:!0}),l){for(var le=[],he=0;he<l.length;he++)le[l[he].id]=l[he].priority;w.sort(function(e,t){var i=0,r=0;if(e.object.pickingPriorityID){var n=e.object.pickingPriorityID.points;!e.primitive||!e.primitive.getGroup||e.primitive.getGroup().glType>=4?n=e.object.pickingPriorityID.faces:e.primitive.getGroup().glType>=1&&(n=e.object.pickingPriorityID.edges),n&&le[n]&&(i=le[n])}if(t.object.pickingPriorityID){var a=t.object.pickingPriorityID.points;!t.primitive||!t.primitive.getGroup||t.primitive.getGroup().glType>=4?a=t.object.pickingPriorityID.faces:t.primitive.getGroup().glType>=1&&(a=t.object.pickingPriorityID.edges),a&&le[a]&&(r=le[a])}return i>r?-1:i<r?1:e.distance-t.distance})}p._cleanIntersectionsList(w,!x)}var ce=this.getRootNode();if(ce&&this.debugPicking&&(null===this.debugPickingNode?(this.debugPickingNode=new n,this.debugPickingNode.exludeFromBounding(!0),ce.addChild(this.debugPickingNode)):0===this.debugPickingNode.parents.length&&ce.addChild(this.debugPickingNode)),this.debugPicking){if(this.debugPickingNode.removeChildren(),w.length>0&&w[0].object&&w[0].point){f=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.8,transparent:!0,force:!0,forceSide:!0});var de=C.createSphereNode({radius:1,sag:32,material:f});de.setPickable(2),de._setRatio(4),de.setFrustumCulled(!1),de.setMatrix((new t.Matrix4).setPosition(w[0].point)),de.setSSAO(!1),de.setMirror(!1),de.setShadow(!1),this.debugPickingNode.addChild(de),g=t.MaterialUtils.createMatteFaceMaterial({color:4474111,opacity:1,transparent:!1,force:!0,forceSide:!0});var ue=C.createSphereNode({radius:1,sag:32,material:g});if(ue.setPickable(2),ue._setRatio(8),ue.setFrustumCulled(!1),ue.setSSAO(!1),ue.setMirror(!1),ue.setShadow(!1),ue.setMatrix((new t.Matrix4).setPosition(this.currentViewpoint.camera.position)),this.debugPickingNode.addChild(ue),w[0].normal){var pe=new t.LineBasicMaterial({color:4474111,opacity:1,force:!0,lineWidth:2}),fe=new t.Vector3(w[0].normal.x,w[0].normal.y,w[0].normal.z);fe.multiplyScalar(.2*w[0].object.boundingSphere.radius);var ge=(new t.Vector3).addVectors(w[0].point,fe);(be=C.createLineNode({points:[w[0].point,ge],material:pe}))._occurrences[0].renderable,be.setPickable(2),be.setSSAO(!1),be.setMirror(!1),be.setShadow(!1),this.debugPickingNode.addChild(be)}var me=w[0].primitive,ve=me&&me.getBoundingSphere();if(ve){var ye=t.MaterialUtils.createMatteFaceMaterial({color:4521796,opacity:.2,transparent:!1,force:!0,forceSide:!0}),Se=C.createSphereNode({radius:1,sag:32,material:ye});Se.setPickable(2),Se.setFrustumCulled(!1),Se.setSSAO(!1),Se.setMirror(!1),Se.setShadow(!1);var _e=new t.Sphere(new t.Vector3(ve.center.x,ve.center.y,ve.center.z),ve.radius);_e.applyMatrix4(w[0].object.matrix);var xe=(new t.Matrix4).setPosition(_e.center);xe.scale(new t.Vector3(_e.radius,_e.radius,_e.radius)),Se.setMatrix(xe),this.debugPickingNode.addChild(Se)}var be;pe=new t.LineBasicMaterial({color:16729156,opacity:1,force:!0,lineWidth:1});(be=C.createLineNode({points:[p.origin,w[0].point],material:pe}))._occurrences[0].renderable,be.setPickable(2),be.setSSAO(!1),be.setMirror(!1),be.setShadow(!1),this.debugPickingNode.addChild(be)}this.render()}for(se=0;se<w.length;se++){var we=w[se];if(we.object&&we.primitive){var Me=we.object.getSelectionGroup(we.primitive);Me&&(we.primitive=Me)}}return 0===w.length&&w.push({object:null}),v&&!r||(w=this._filterClippedIntersections(w)),w},_updateSVGVisu:function(){if(this._svgMode&&this.svgRoot&&this._2DMode){var e=this.currentViewpoint.camera,t=this.SCREEN_HEIGHT/e.visualizedHeight,i="matrix("+t+" 0 0 "+t+" "+0*(1-t)+" "+0*(1-t)+") ",r="translate ("+(.5*this.SCREEN_WIDTH-e.position.x*t+0*t-0)+" "+(.5*this.SCREEN_HEIGHT+e.position.y*t-0*t-0)+") ";this.svgRoot.setAttribute("transform",r+i)}},_updateOffsetPlane:function(e,i,r,n){var a,s="zup"===this._worldOrientation._woName;if(r&&((this.ambience.getGround().isActivated()&&"physical"==this.ambience.getGround().getType()||this.ambience.isFiniteMode())&&this.ambience.getBackgroundGeometry().isAutoUpdateSize()&&this.ambience.getBackgroundGeometry().setSize(4*e.radius),this.ambience.isAutoGroundOffset()&&null!==(a=null!==this._forceSceneMinValue?this._forceSceneMinValue:null===this.internalSceneGraph?0:this.internalSceneGraph.getSceneMin(n,this._worldOrientation))&&this.ambience.updateScene(new t.Vector3(e.center.x,s?e.center.y:a,s?a:e.center.z))),this.offsetPlaneBackground.copy(this.ambience.getGroundPosition()),this.ambience.isAutoGroundOffset()&&!this.ambience.isFiniteMode()&&"physical"!=this.ambience.getGround().getType()){var o=i.getLookAt();if(this.planeV2)this.offsetPlaneBackground.x=e.center.x,s?this.offsetPlaneBackground.y=e.center.y:this.offsetPlaneBackground.z=e.center.z;else if(s){var l=Math.abs(o.z)>1e-4?1/o.z:0;this.offsetPlaneBackground.x=.5*(e.center.x+i.position.x-(i.position.z-this.offsetPlaneBackground.z)*o.x*l),this.offsetPlaneBackground.y=.5*(e.center.y+i.position.y-(i.position.z-this.offsetPlaneBackground.z)*o.y*l)}else{l=Math.abs(o.y)>1e-4?1/o.y:0;this.offsetPlaneBackground.x=.5*(e.center.x+i.position.x-(i.position.y-this.offsetPlaneBackground.y)*o.x*l),this.offsetPlaneBackground.z=.5*(e.center.z+i.position.z-(i.position.y-this.offsetPlaneBackground.y)*o.z*l)}}s?(this.offsetPlaneBackground.z+=this.ambience.getOffset(),this.offsetPlaneSmall.z=this.offsetPlaneBackground.z):(this.offsetPlaneBackground.y+=this.ambience.getOffset(),this.offsetPlaneSmall.y=this.offsetPlaneBackground.y)},_getPlaneSize:function(e,t,i,r){return this.ambience.isAutoGroundOffset()?this.planeV2?20*e.radius:Math.max(20*(this.offsetPlaneBackground.distanceTo(e.center)+e.radius),5*this.offsetPlaneBackground.distanceTo(t.position)):this.planeV2&&this.planeGrid?this.planeGrid.size:this.gridUnit/this.gridStep},_castRayFunc:function(e,t,i,r){return console.warning("Internal method: use castRay or castRayOnOccurrence instead"),e._cast(t,i,r,s)},castRay:function(e,t,i,r){var n,a=0,o=0,l=(r=r||{}).iDoNotUseDefaultRenderPasses?[]:["main","noz","noEffectNoZ","afterHighlightNoZ","dialog"];if(r.iAdditionalRenderPasses)for(o=0;o<r.iAdditionalRenderPasses.length;o++)n=r.iAdditionalRenderPasses[o],l.push(n&&n._getIdString?n._getIdString():n);var h=[];if(t)for(a=0;a<t._occurrences.length;a++)h=h.concat(t._occurrences[a]._getRenderableOccurrences());else{var c=this.internalSceneGraph.scene;for(o=0;o<l.length;o++)h=h.concat(c.getWebGLObjects(l[o],0))}return e._cast(h,i,r,s)},castRayOnOccurrence:function(e,t,i,r){var n=0,a=["main","noz","noEffectNoZ","afterHighlightNoZ"],o=[];if(t){o=t._getRenderableOccurrences(this,!1);var l=t._getUniqueOccurrence(this);null===l?console.log("castRayIntoOccurrences ERROR: the path element is either invalid or doesn't define a unique occurrence."):l.node._tryOverridesUpdate(this)}else{var h=this.internalSceneGraph.scene;for(n=0;n<a.length;n++)o=o.concat(h.getWebGLObjects(a[n],0))}return e._cast(o,i,r,s)},displayFaces:function(e){this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),this.setRenderMode("Face",e),this.setRenderMode("AxisSystem",e),this.setRenderMode("InfiniteFace",e)},setBoundaryEdgeColor:function(e){this.renderer.renderer.boundaryEdgeMaterialInfo.color.copy(e),this.render()},displayBoundaryEdgeColor:function(e){this.renderer.resetGSSOCache(),this.renderer.renderer.boundaryEdgeMaterialInfo.enabled=e,this.render()},displayBlankingPolygon:function(e){this.renderer.resetGSSOCache(),this.materialManager&&this.materialManager.displayBlankingPolygon(e,this)},displayLines:function(e){this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),this.setRenderMode("@Edge",e)},displayHiddenEdges:function(e){this.renderer.resetGSSOCache(),this.renderer.renderer.renderHiddenEdges=e,this.render()},displayHalVisibleSmoothEdges:function(e){this.renderer.resetGSSOCache(),this.renderer.renderer.halfVisibleSmoothEdges=e,this.render()},setRenderLineMode:function(e){switch(this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),e){case t.HideAllRenderLineMode:this.setRenderMode("@Edge",!1);break;case t.HideSmoothEdgesRenderLineMode:this.setRenderMode("@Edge",!0),this.setRenderMode("InternalSmoothEdge",!1);break;case t.HideWireEdgesRenderLineMode:this.setRenderMode("@Edge",!0),this.setRenderMode("WireEdge",!1);break;case t.HideInternalEdgesRenderLineMode:this.setRenderMode("@Edge",!0),this.setRenderMode("InternalSmoothEdge",!1),this.setRenderMode("InternalSharpEdge",!1);break;case t.ShowAllRenderLineMode:this.setRenderMode("@Edge",!0);break;case t.SmoothEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("InternalSmoothEdge",!0);break;case t.SharpEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("InternalSharpEdge",!0);break;case t.WireEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("WireEdge",!0);break;case t.BoundaryEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("BoundaryEdge",!0)}},addRenderModeLock:function(e,t){this.lockedRenderMode.set(e,t),this.applyRenderModeLock()},removeRenderModeLock:function(e){this.lockedRenderMode.has(e)&&this.lockedRenderMode.delete(e)},clearRenderModeLock:function(){this.lockedRenderMode.clear()},applyRenderModeLock:function(){var e=this;this.lockedRenderMode.forEach(function(t,i,r){e._setRenderMode(i,t)})},getPlanesFilter:function(){return!!this.planesFilterStatus},onPlanesFilterChange:function(e){return this._modelEvent.subscribe({event:"RefPlaneFilterMode"},e)},getVerticesFilter:function(){return!!this.verticesFilterStatus},_setVerticesFilter:function(e){e=!!e,this.addRenderModeLock("BoundaryPoint",e),this.addRenderModeLock("SharpPoint",e),this.addRenderModeLock("SmoothPoint",e)},setVerticesFilter:function(e){this.verticesFilterStatus!==e&&(this.verticesFilterStatus=e,!1!==this.linesFilterStatus&&this._setVerticesFilter(e),this.render(),this._modelEvent.publish({event:"VerticesFilterMode",data:{viewer:this,state:this.verticesFilterStatus}}))},onVerticesFilterChange:function(e){return this._modelEvent.subscribe({event:"VerticesFilterMode"},e)},getAxisFilter:function(){return!!this.axisFilterStatus},setAxisFilter:function(e){var t=this.axisFilterStatus!==e,i=this.getBagNode?this.getBagNode():this.getRootNode?this.getRootNode():null;if(i){var r=i.getChildrenByName("AxisSystems");r&&r.length>0&&r.forEach(function(t){t.setVisibility(e),t.setVisibilityFree(!e)});var n=i.getChildrenByName("RefPlanes");n&&n.length>0&&n.forEach(function(t){t.setVisibility(e),t.setVisibilityFree(!e)})}t&&(this.axisFilterStatus=e,this.planesFilterStatus=e,this.addRenderModeLock("InfiniteFace",e),this.addRenderModeLock("AxisSystem",e),this._modelEvent.publish({event:"AxisFilterMode",data:{viewer:this,state:this.axisFilterStatus}}),this._modelEvent.publish({event:"RefPlaneFilterMode",data:{viewer:this,state:this.planesFilterStatus}})),this.render()},onAxisFilterChange:function(e){return this._modelEvent.subscribe({event:"AxisFilterMode"},e)},getLinesFilter:function(){return!!this.linesFilterStatus},setLinesFilter:function(e){this.linesFilterStatus!==e&&(this.linesFilterStatus=e,this.addRenderModeLock("WireEdge",e),this._setVerticesFilter(!!e&&(null===this.verticesFilterStatus||this.verticesFilterStatus)),this.render(),this._modelEvent.publish({event:"LinesFilterMode",data:{viewer:this,state:this.linesFilterStatus}}))},onLinesFilterChange:function(e){return this._modelEvent.subscribe({event:"LinesFilterMode"},e)},getPointsFilter:function(){return!!this.pointsFilterStatus},setPointsFilter:function(e){this.pointsFilterStatus!==e&&(this.pointsFilterStatus=e,this.addRenderModeLock("FreePoint",e),this.render(),this._modelEvent.publish({event:"PointsFilterMode",data:{viewer:this,state:this.pointsFilterStatus}}))},onPointsFilterChange:function(e){return this._modelEvent.subscribe({event:"PointsFilterMode"},e)},_setRenderMode:function(e,t){this.renderer.resetGSSOCache();var i=new N;i._setFromMasks(this.renderer.renderer.renderPointMode,this._getInternalRenderLineMode(),this._getInternalRenderFaceMode()),i.setRenderMode(e,t),this.renderer.renderer.renderPointMode=i.getMask()&N.pointsMask,this._setInternalRenderFaceMode(i.getMask()&N.facesMask),this._setInternalRenderLineMode(i.getMask()&N.linesMask)},setRenderMode:function(e,t){if(this._renderStyle)return this._renderStyle.setRenderMode(e,t),void this.setRenderStyle(this._renderStyle);this._setRenderMode(e,t),this.applyRenderModeLock()},setRenderStyle:function(e){this.renderer.resetGSSOCache(),this._renderStyle=e.clone(),this.setMaterialMode(e._materialMode);var t=this._renderStyle._renderMode;this.renderer.renderer.renderPointMode=t.getMask()&N.pointsMask,this.renderer.renderer.outlineWidth=t._outlineWidth,this._setInternalRenderFaceMode(t.getMask()&N.facesMask),this._setInternalRenderLineMode(t.getMask()&N.linesMask),this.applyRenderModeLock(),this.internalSceneGraph.root.forceUpdate()},requestViewPanelClose:function(){this._modelEvent.publish({event:"RequestViewPanelClose",data:{viewer:this}})},onRequestViewPanelClose:function(e){return this._modelEvent.subscribe({event:"RequestViewPanelClose"},e)},setRenderFaceMode:function(e){this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),this._setInternalRenderFaceMode(e)},displayPoints:function(e){this.renderer.resetGSSOCache(),e?(this.setRenderMode("@Point",!0),this.setRenderMode("SurfacicPoint",!1),N.defaultMask=N.defaultMask|t.GeomTypeEnum.UNKNOWN_0D):(this.setRenderMode("@Point",!1),N.defaultMask=N.defaultMask&~t.GeomTypeEnum.UNKNOWN_0D)},displaySurfacicPoints:function(e){this.renderer.resetGSSOCache(),this.setRenderMode("SurfacicPoint",e)},_setGradientBackgroundShader:function(){var e;if(null!==this.sphereEnv){var i=this.ambience.getBackground().getColors();switch(i){case 2:e=t.GradientBackgroundMaterial2;break;case 3:e=t.GradientBackgroundMaterial3;break;case 4:e=t.GradientBackgroundMaterial4;break;default:return void this.removeEnvMap()}var r=new e({force:!0,side:t.DoubleSide,forceSide:!0,depthTest:!1});r.colors=[];for(var n=r.colors,a=0;a<i.length;a++){var s=i[a];n.push(s.r),n.push(s.g),n.push(s.b)}this.sphereEnv.material=r}},setGradientBackground:function(e){if(this.renderer.resetGSSOCache(),this.showGradientBackground=[],!e||e.length<2||e.length>4)this.removeEnvMap();else{for(var i=[],r=0;r<e.length;r++){var n=new t.Color(e[r]);this.visibleSpace||n.desaturate(1).alphaBlend(ne,.5),this.showGradientBackground.push(new t.Color(e[r])),i.push(n)}this.ambience.getBackground().setColors(i)}},_setBackgroundColor:function(){this._svgMode&&this._2DMode&&!O.getWebGLMode()?this.renderer.setBackgroundColor(0,0):this.renderer.setBackgroundColor(this.ambience.getBackgroundColor().getHex(),this.ambience.getBackgroundAlpha()),this._modelEvent.publish({event:"VisuBackgroundColor",data:this.ambience.getBackgroundColor().getHex()})},setBackgroundColor:function(e,i){if(this.__tempBackgroundColorODT=e,this.renderer.resetGSSOCache(),this.ambience.setBackgroundAlpha(void 0!==i?i:1),this.showBgColor=new t.Color(e).getHex(),this.showBgAlpha=this.ambience.getBackgroundAlpha(),this.visibleSpace)this.ambience.setBackgroundColor(e);else{var r=new t.Color(e);r.desaturate(1).alphaBlend(ne,.5),this.ambience.setBackgroundColor(r.getHex())}this._setBackgroundColor(),this.render()},setPlaneColor:function(e){this.renderer.resetGSSOCache(),this.planeColor.set(e),this.showPlaneColor.set(e),this.visibleSpace||this.planeColor.desaturate(1).alphaBlend(ne,.5),this.render()},setGridColor:function(e){this.renderer.resetGSSOCache(),this.gridColor.set(e),this.showGridColor.set(e),this.visibleSpace||this.gridColor.desaturate(1).alphaBlend(ne,.5),this.render()},setSecondaryLightColor:function(e){var i;this.renderer.resetGSSOCache(),"number"==typeof e||"string"==typeof e?i=new t.Color(e):e&&(i=e),null!==this.directionalLight2&&this.directionalLight2.color.copyToLinear(i,this.renderer.renderer.simpleGamma),this.render()},setShadow:function(e,t,i){this._viewerEffectSettings.setShadow(e,t,i)},getShadow:function(e){return this._viewerEffectSettings.getShadow(e)},setAllowShadow(e,t){this._viewerEffectSettings.setAllowShadow(e,t)},getAllowShadow:function(e){return this._viewerEffectSettings.getAllowShadow(e)},setTransparentShadow:function(e,t){this._viewerEffectSettings.setTransparentShadow(e,t)},getTransparentShadow:function(e){return this._viewerEffectSettings.getTransparentShadow(e)},setAllowTransparentShadow(e,t){this._viewerEffectSettings.setAllowTransparentShadow(e,t)},getAllowTransparentShadow:function(e){return this._viewerEffectSettings.getAllowTransparentShadow(e)},setOIT:function(e,t){this._viewerEffectSettings.setOIT(e,t)},getOIT:function(e){return this._viewerEffectSettings.getOIT(e)},setFlakesQuality:function(e,t){this._viewerEffectSettings.setFlakesQuality(e,t)},getFlakesQuality:function(e){return this._viewerEffectSettings.getFlakesQuality(e)},setDownsamplingFactor:function(e){this._viewerEffectSettings.setDownsamplingFactor(e)},getDownsamplingFactor:function(){this._viewerEffectSettings.getDownsamplingFactor()},setDefaultMaterialQuality:function(e){this._viewerEffectSettings.setDefaultMaterialQuality(e)},getDefaultMaterialQuality:function(){this._viewerEffectSettings.getDefaultMaterialQuality(iQuality)},enableZPrePass:function(e,t){this._viewerEffectSettings.enableZPrePass(e,t)},zPrePassEnabled:function(e){return this._viewerEffectSettings.zPrePassEnabled(iOnOff,e)},setShadowFilter:function(e,t){this._viewerEffectSettings.setShadowFilter(e,t)},getShadowFilter:function(e){return this._viewerEffectSettings.getShadowFilter(e)},setShadowQuality:function(e,t){this._viewerEffectSettings.setShadowQuality(e,t)},getShadowQuality:function(e){return this._viewerEffectSettings.getShadowQuality(e)},setShadowCascade:function(e,t,i){this.renderer.resetGSSOCache();var r=this.directionalLight,n=t||1024,a=!1;if(null!==r){this.getRenderer()&&(this.getRenderer().shadowMapCascade=e),this.shadowMapWidth===n&&this.shadowMapHeight===n||(a=!0,this.shadowMapWidth=n,this.shadowMapHeight=n,e||(r.shadowMap=null,r.shadowMapWidth=n,r.shadowMapHeight=n)),r.shadowCascade=e,r.shadowCascadeCount=i||3,r.shadowCascadeWidth=[],r.shadowCascadeHeight=[],r.shadowCascadeBias=[],r.shadowCascadeNearZ=[],r.shadowCascadeFarZ=[];for(var s=0;s<r.shadowCascadeCount;s++)r.shadowCascadeWidth[s]=n,r.shadowCascadeHeight[s]=n,r.shadowCascadeBias[s]=-.005;if(r.shadowCascadeOffset.set(0,0,-10),a&&r.shadowCascadeArray)for(s=0;s<r.shadowCascadeArray.length;s++){var o=r.shadowCascadeArray[s];o.shadowMap=null,o.shadowMapWidth=n,o.shadowMapHeight=n,o.shadowBias=-.005}this.renderer&&this.renderer.recompileAllShaders(null)}},removePlaneV2:function(){this.ambience.usePlaneV2&&!this._planeV2Appli&&(this.setGroundOptions({displayPlane:!1,displayGrid:!1,planeFalloff:0}),this.planeGrid&&this.planeGrid.mesh&&(this.planeGrid.mesh.visible=!1),this.planeV2=!1)},setGroundShadow:function(e,t){this._viewerEffectSettings.setGroundShadow(e,t)},getGroundShadow:function(e){return this._viewerEffectSettings.getGroundShadow(e)},setAllowGroundShadow:function(e,t){this._viewerEffectSettings.setAllowGroundShadow(e,t)},getAllowGroundShadow:function(e){return this._viewerEffectSettings.getAllowGroundShadow(e)},setGroundShadowAutomaticUpdate:function(e){this.dirLightGroundShadow.blockUpdate=!e,e&&(this.dirLightGroundShadow.updateShadowMap=!0)},setGroundShadowDirection:function(e,t){this.groundShadowLatitude=e,this.groundShadowLongitude=t,this.dirLightGroundShadow.updateShadowMap=!0},_setGroundShadow:function(){this.blurShadowEffect||(this.blurShadowEffect=new T(this.renderer.renderer,this.renderer.renderTargetPool),this.dirLightGroundShadow.blurShadowEffect=this.blurShadowEffect);var e=this.dirLightGroundShadow.groundMaterial;e&&(e.getPDSFXUniform("groundShadow").value||(e.defines.GROUND_SHADOW=1,e.needsUpdate=!0))},setGrid:function(e,t){this.renderer.resetGSSOCache(),this.displayGrid!==e&&(this.displayGrid=e,this._modelEvent.publish({event:"DisplayGrid",data:{viewer:this,value:e}})),this._updateGridDisplay(),void 0!==t&&(this.displayGridFromBelow=t,this.planeV2&&(this.planeGrid.displayGridFromBelow=t?1:0)),this.render()},getGrid:function(){return this.displayGrid},onGridChange:function(e){return this._modelEvent.subscribe({event:"DisplayGrid"},e)},_updateGridDisplay:function(){var t=!this._2DMode&&this.displayGrid;this._displayGrid!==t&&(this._displayGrid=t,this.planeV2&&(this.planeGrid.displayGrid=t?1:0),e.publish({event:"/WUX/AFR/CMD/VisuGrid/"+(t?"BEGIN":"END")}))},getGridUnit:function(){return this.planeV2&&this.planeGrid?this.planeGrid.gridUnit:this.gridUnit},onProjectionTypeChange:function(e){var t=0,i=this;return this.onPreRender(function(){i.currentViewpoint.getProjectionType()!==t&&(t=i.currentViewpoint.getProjectionType(),e({viewer:i,state:t}))})},displayInfinitePlane:function(e,t){this.renderer.resetGSSOCache(),this.infinitePlane=e,this.planeAttenuation=void 0!==t&&t,this._updateInfinitePlaneDisplay()},_updateInfinitePlaneDisplay:function(){this._infinitePlane=!this._2DMode&&this.infinitePlane,this.planeV2&&(this.planeGrid.displayPlane=this._infinitePlane?1:0),this._infinitePlane?(this.render({updateInfinitePlane:!0}),this.useShadowPlane=!0):!this.planeV2&&this._removeInfinitePlane(this.infPlane)},setShadowPlane:function(e){this.renderer.resetGSSOCache(),this.useShadowPlane=e,this._updateShadowPlaneDisplay()},_updateShadowPlaneDisplay:function(e){!this._2DMode&&this.useShadowPlane?this.render({updateInfinitePlane:!0}):!this._infinitePlane&&this._removeInfinitePlane(this.infPlaneSmall)},setAutomaticPlaneUpdate:function(e){this.ambience.setAutoGroundOffset(e)},setPlanePositionAndScale:function(e,t){this.offsetPlaneBackground.copy(e),this.offsetPlaneSmall.z=e.z,this.ambience.updateScene(e),this.gridUnit=t},setGridNbSteps:function(e){if(this.renderer.resetGSSOCache(),this.gridNbSteps=Math.min(Math.max(e,1),10),this.planeV2)this.planeGrid.setGridNbSteps(this.gridNbSteps);else{if(!this.bigGrid)return;this._createBigGridGeometry()}},setGroundOptions:function(e){this.renderer.resetGSSOCache(),void 0!==e.groundCenter&&(this.offsetPlaneBackground.copy(e.groundCenter),this.offsetPlaneSmall.z=e.groundCenter.z,this.ambience.updateScene(e.groundCenter)),void 0!==e.groundSize&&this.planeV2&&(this.planeGrid.size=e.groundSize),void 0!==e.groundShadow&&this.setGroundShadow(!!e.groundShadow),void 0!==e.displayPlane&&this.displayInfinitePlane(!!e.displayPlane,e.planeAttenuation),void 0!==e.displayGrid?this.setGrid(!!e.displayGrid,e.displayGridFromBelow):void 0!==e.displayGridFromBelow&&this.setGrid(this.displayGrid,e.displayGridFromBelow),void 0!==e.gridNbSteps&&this.setGridNbSteps(e.gridNbSteps),void 0!==e.gridLabels&&this.planeV2&&this.planeGrid&&this.planeGrid.setLabels(e.gridLabels),void 0!==e.gridLabelColor&&this.planeV2&&this.planeGrid&&this.planeGrid.setLabelColor(e.gridLabelColor),void 0!==e.gridLabelCallback&&this.planeV2&&this.planeGrid&&this.planeGrid.setLabelCallback(e.gridLabelCallback),void 0!==e.gridDisplayLabelCallback&&this.planeV2&&this.planeGrid&&this.planeGrid.setDisplayLabelCallback(e.gridDisplayLabelCallback),void 0!==e._onlyDiffuse&&this.planeV2&&this.planeGrid&&(this.planeGrid._onlyDiffuse=e._onlyDiffuse),void 0!==e.planeMirror&&this.setMirror(!!e.planeMirror,e.blurryMirror),void 0!==e.planeColor&&this.setPlaneColor(e.planeColor),this.planeV2&&this.planeGrid&&(void 0!==e.planeOpacity&&(this.planeGrid.planeOpacity=e.planeOpacity),void 0!==e.planeTexture&&(this.planeGrid.planeTexture=e.planeTexture),void 0!==e.planeTextureScale&&(this.planeGrid.planeTextureScale=e.planeTextureScale),void 0!==e.planeFalloff&&(this.planeGrid.planeFalloff=e.planeFalloff),void 0!==e.gridFalloff&&(this.planeGrid.gridFalloff=e.gridFalloff),void 0!==e.planeBorder&&(this.planeGrid.planeBorder=e.planeBorder),void 0!==e.planeBorderColor&&this.planeGrid.edgeColor.set(e.planeBorderColor)),void 0!==e.gridColor&&this.setGridColor(e.gridColor)},getGroundOptions:function(){return{groundCenter:this.offsetPlaneBackground,groundSize:this.planeGrid?this.planeGrid.size:void 0,groundShadow:this.useGroundShadow,displayPlane:this.infinitePlane,displayGrid:this.displayGrid,displayGridFromBelow:this.displayGridFromBelow,gridNbSteps:this.gridNbSteps,gridLabels:!!this.planeGrid&&this.planeGrid.displayLabels,planeMirror:this.useMirror,blurryMirror:this.blurryMirror,planeColor:this.planeColor.getHexString(),gridColor:this.gridColor.getHexString(),gridFalloff:this.planeGrid?this.planeGrid.gridFalloff:void 0,planeFalloff:this.planeGrid?this.planeGrid.planeFalloff:void 0,planeBorder:!!this.planeGrid&&this.planeGrid.planeBorder,planeBorderColor:this.planeGrid?this.planeGrid.edgeColor.getHexString():void 0}},_getGroundOptions:function(){return{groundCenter:this.offsetPlaneBackground,groundSize:this.planeGrid?this.planeGrid.size:void 0,groundShadow:this.useGroundShadow,displayPlane:this.infinitePlane,onlyDiffuse:this.planeGrid?this.planeGrid._onlyDiffuse:0,displayGrid:this.displayGrid,displayGridFromBelow:this.displayGridFromBelow,gridNbSteps:this.gridNbSteps,gridLabels:this.planeGrid?this.planeGrid.displayLabels:null,gridLabelCallback:this.planeGrid?this.planeGrid.labelCB:null,gridDisplayLabelCallback:this.planeGrid?this.planeGrid.displayLabelCB:null,planeMirror:this.useMirror,blurryMirror:this.blurryMirror,planeColor:"#"+this.planeColor.getHexString(),planeOpacity:this.planeGrid?this.planeGrid.planeOpacity:1,planeTexture:this.planeGrid?this.planeGrid.planeTexture:null,planeTextureScale:this.planeGrid?this.planeGrid.planeTextureScale:1,gridColor:"#"+this.gridColor.getHexString(),gridFalloff:this.planeGrid?this.planeGrid.gridFalloff:void 0,planeFalloff:this.planeGrid?this.planeGrid.planeFalloff:void 0,planeBorder:!!this.planeGrid&&this.planeGrid.planeBorder,planeBorderColor:this.planeGrid?"#"+this.planeGrid.edgeColor.getHexString():void 0}},setMirror:function(e,t,i,r,n){this._viewerEffectSettings.setMirror(e,t,i,r,n)},getMirror:function(e){return this._viewerEffectSettings.getMirror(e)},setAllowMirror:function(e,t){this._viewerEffectSettings.setAllowMirror(e,t)},getAllowMirror:function(e){return this._viewerEffectSettings.getAllowMirror(e)},setVignetting:function(e){this.useVignetting!==e&&(this.renderer.setEffect("Vignetting",e),this.useVignetting=e,this.render())},setHighlight:function(e){this.displayHighlight!==e&&(this.displayHighlight=e,this.setPicking({activated:e,displayHL:e}),this.renderer.setEffect("Highlight",e),this.renderer.setEffect("Canvas2DHighlight",e),this.render())},showHighlight:function(e){this._showHighlight!==e&&(this._showHighlight=e,this.render())},setRenderIteration:function(e){this.isRenderIteration=e},lockRenderIteration:function(){this._lockRenderIteration=!0},unlockRenderIteration:function(){this._lockRenderIteration=!1},setAntiAliasing:function(e,t){this._viewerEffectSettings.setAntiAliasing(e,t)},getAntiAliasing:function(e){return this._viewerEffectSettings.getAntiAliasing(e)},setPixelCulling:function(e,t){this._viewerEffectSettings.setPixelCulling(e,t)},getPixelCulling:function(e){return this._viewerEffectSettings.getPixelCulling(e)},setSSAO:function(e,t){this._viewerEffectSettings.setSSAO(e,t)},getSSAO:function(e){this._viewerEffectSettings.getSSAO(e)},setAllowSSAO:function(e,t){this._viewerEffectSettings.setAllowSSAO(e,t)},getAllowSSAO:function(e){this._viewerEffectSettings.getAllowSSAO(e)},setSSAOParameters:function(e,t){var i=this.ssaoParams;void 0!==e.dynamicRadius&&(i.dynamicRadius=e.dynamicRadius),void 0!==e.adaptativeRadius&&(i.adaptativeRadius=e.adaptativeRadius),void 0!==e.radius&&(i.radius=e.radius),void 0!==e.radiusMin&&(i.radiusMin=e.radiusMin),void 0!==e.radiusMax&&(i.radiusMax=e.radiusMax),void 0!==e.minPixelRadius&&(i.minPixelRadius=e.minPixelRadius),void 0!==e.attenuation&&(i.attenuation=e.attenuation),void 0!==e.contrast&&(i.contrast=e.contrast),void 0!==e.power&&(i.power=e.power),void 0!==e.thresholdAngle&&(i.thresholdAngle=e.thresholdAngle),8!==e.nbOfSamples&&16!==e.nbOfSamples&&32!==e.nbOfSamples||this._viewerEffectSettings.setSSAONbSamples(e.nbOfSamples,t)},setIterativeSSAO:function(e){this.useSSAOIterative=e},setDOF:function(e,t){return this._viewerEffectSettings.setDOF(e,t)},getDOF:function(e){return this._viewerEffectSettings.getDOF(e)},setAllowDOF:function(e,t){return this._viewerEffectSettings.setAllowDOF(e,t)},getAllowDOF:function(e){return this._viewerEffectSettings.getAllowDOF(e)},setIterativeDOF:function(e){this.useDOFIterative=e},setSSLR:function(e,t){this._viewerEffectSettings.setSSLR(e,t)},getSSLR:function(e){return this._viewerEffectSettings.getSSLR(e)},setAllowSSLR:function(e,t){this._viewerEffectSettings.setAllowSSLR(e,t)},getAllowSSLR:function(e){return this._viewerEffectSettings.getAllowSSLR(e)},setSSLRefraction:function(e,t){this._viewerEffectSettings.setSSLRefraction(e,t)},getSSLRefraction:function(e){return this._viewerEffectSettings.getSSLRefraction(e)},setAllowSSLRefraction:function(e,t){this._viewerEffectSettings.setAllowSSLRefraction(e,t)},getAllowSSLRefraction:function(e){return this._viewerEffectSettings.getAllowSSLRefraction(e)},setBloom:function(e,t){this._viewerEffectSettings.setBloom(e,t)},getBloom:function(e){return this._viewerEffectSettings.getBloom(e)},setAllowBloom:function(e,t){this._viewerEffectSettings.setAllowBloom(e,t)},getAllowBloom:function(e){return this._viewerEffectSettings.getBloom(e)},setAdvancedPoliteHighlight:function(e,t){var i=this.internalSceneGraph.selectionHL,r=this.internalSceneGraph.selectionPreHL;i&&i.setHighlightData(!0,e),r&&r.setHighlightData(!0,t),this.render()},setHaloHighlight:function(e,t){var i=this.internalSceneGraph.selectionHL,r=this.internalSceneGraph.selectionPreHL;i&&i.setHighlightData(!1,e),r&&r.setHighlightData(!1,t),this.render()},getHighlightData:function(){var e=this.internalSceneGraph.selectionHL,t=this.internalSceneGraph.selectionPreHL,i={highlightData:null,preHighlightData:null};return e&&(i.highlightData=e.getHighlightData()),t&&(i.preHighlightData=t.getHighlightData()),i},setPreHighlightColor:function(e,i){console.warn("Warning: Deprecated API, please use setAdvancedPoliteHighlight or setHaloHighlight instead"),this.internalSceneGraph.selectionPreHL&&(e instanceof t.Color?this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{outlineColor:e,outlineThickness:1}):i instanceof t.Color&&this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{outlineColor:i,outlineThickness:1}),i instanceof t.Color?this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{haloColor:i,haloIntensity:500,haloThickness:1}):e instanceof t.Color&&this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{haloColor:e,haloIntensity:500,haloThickness:1}))},getEffect:function(e){var t=null;switch(e){case"xRevealStructure":t=this.renderer.XRevealStructureEffect;break;case"ToneMapping":case"Vignetting":t=this.renderer.ToneMappingEffect;break;case"Bloom":t=this.renderer.BloomEffect;break;case"DOF":t=this.renderer.BokehDOFEffect;break;case"SSLR":t=this.renderer.SSLREffect;break;case"SSLRDirect":t=this.renderer.SSLRDirectEffect;break;case"VolumeRendering":t=this.renderer.VolumeRenderingEffect;break;case"SSAO":t=this.renderer.SSAOEffect;break;case"SSAOIterative":t=this.renderer.SSAOIterativeEffect;break;case"PreHighlight":t=this.renderer.PreHighlightEffect;break;case"Canvas2DPreHighlight":t=this.renderer.Canvas2DPreHighlightEffect;break;case"Highlight":t=this.renderer.HighlightEffect;break;case"Canvas2DHighlight":t=this.renderer.Canvas2DHighlightEffect}return t},setFlare:function(e){this.useFlare!==e&&(this.renderer.setEffect("Flare",e),this.useFlare=e,this.render())},setMagnifier:function(e){e.viewer||(e.viewer=this),null===this.magnifier?this.magnifier=new f(e):this.magnifier.setOption(e),this.pPicking.activated||this.setPrePicking({activated:!0,displayHL:!1,gpu:!1,computeNormalDepth:!0})},setFillXSOMode:function(e){this._fillXSOMode=e},setPicking:function(e,t){"boolean"==typeof e&&console.log("boolean is DEPRECATED in setPicking() method.\n Use object instead."),void 0!==e.activated&&(this.picking.activated=e.activated);var i=e.divTrap,r=function(){var e=this.picking.trapSelection;!1!==window.enableNewTrapSelection?e?(this.trapSelectionManipulator||(this.trapSelectionManipulator=new I(this),this.trapSelectionManipulator._linkToViewer()),this.trapSelectionManipulator.enable(),this.trapSelectionManipulator.setAdvanced("advanced"===e),void 0!==i?this.trapSelectionManipulator.setShowDivTrap(!!i):this.trapSelectionManipulator.setShowDivTrap(this.picking.showDivTrap)):this.trapSelectionManipulator&&this.trapSelectionManipulator.disable():(this.trapSelection||(this.trapSelection=new g(this)),this.trapSelection.set(e))};void 0!==e.contextPick&&(this.picking.contextPick=e.contextPick),void 0!==e.displayHL&&(this.picking.displayHL=e.displayHL),void 0!==e.gpu&&(this.picking.gpu=e.gpu),void 0!==e.trapGPU&&(this.picking.trapGPU=e.trapGPU),void 0!==e.computeNormalDepth&&(this.picking.computeNormalDepth=e.computeNormalDepth),void 0!==e.primitive&&(this.picking.primitive=e.primitive,this.picking._trapPrimitiveUsed||(this.picking.trapPrimitive=!!e.primitive)),void 0!==e.pickingTolerance&&(this.renderer.gpuPickingTolerance=e.pickingTolerance,this.picking.tolerance=e.pickingTolerance),void 0!==e.forceVisibility&&this.picking.forceVisibility!==e.forceVisibility&&(this.picking.forceVisibility=e.forceVisibility,this.internalSceneGraph.forceHighlightVisibility(e.forceVisibility)),void 0!==e.trapSelection&&(this.picking.trapSelection=e.trapSelection,r.call(this)),void 0!==e.trapSelectionMesh&&(console.warn("DEPRECATED: please use trapPrimitive to control trap selection granularity instead"),this.picking.trapSelection=e.trapSelectionMesh,this.picking._trapPrimitiveUsed=!e.trapSelectionMesh,this.picking.trapPrimitive=!this.picking.trapSelection&&this.picking.trapPrimitive,r.call(this)),void 0!==e.trapPrimitive&&(this.picking.trapPrimitive=e.trapPrimitive,this.picking._trapPrimitiveUsed=!0),void 0!==e.showDivTrap&&(this.picking.showDivTrap=e.showDivTrap,this.trapSelectionManipulator&&this.trapSelectionManipulator.setShowDivTrap(this.picking.showDivTrap)),this.renderer&&(this.renderer.setEffect("Highlight",this.picking.activated&&this.picking.displayHL),this.renderer.setEffect("Canvas2DHighlight",this.picking.activated&&this.picking.displayHL));var n=!0;void 0!==t&&(n=t),this.setDefaultPicking(n)},setPrePicking:function(e,t){void 0!==e.activated&&(this.pPicking.activated=e.activated),void 0!==e.trapSelection&&(this.pPicking.trapSelection=e.trapSelection),void 0!==e.displayHL&&(this.pPicking.displayHL=e.displayHL),void 0!==e.gpu&&(this.pPicking.gpu=e.gpu),void 0!==e.computeNormalDepth&&(this.pPicking.computeNormalDepth=e.computeNormalDepth),void 0!==e.primitive&&(this.pPicking.primitive=e.primitive),void 0!==e.disableWhileMoving&&(this.pPicking.disableWhileMoving=e.disableWhileMoving),void 0!==e.forceVisibility&&this.pPicking.forceVisibility!==e.forceVisibility&&(this.pPicking.forceVisibility=e.forceVisibility,this.internalSceneGraph.forcePreHighlightVisibility(e.forceVisibility)),this.renderer&&(this.renderer.setEffect("PreHighlight",this.pPicking.activated&&this.pPicking.displayHL),this.renderer.setEffect("Canvas2DPreHighlight",this.pPicking.activated&&this.pPicking.displayHL));var i=!0;void 0!==t&&(i=t),this.setDefaultPicking(i)},setPickingGPU:function(e){this.picking.gpu!==e&&(this.picking.gpu=e)},setSmallRenderTargetPicking:function(e){this.renderer.smallTargetPicking!==e&&(this.renderer.smallTargetPicking=e)},setIntensityCorrection:function(e){},activateNoMeshInRAM:function(e){console.warn("DEPRECATED: noMeshInRAM should be activated on the modelLoader")},setManipulators:function(e){if(!this.manipulatorManager)return!1;void 0!==e.activated&&this.manipulatorManager.setActivate(e.activated),void 0!==e.preActivate&&this.manipulatorManager.setPreActivate(e.preActivate)},getManipulators:function(){return!!this.manipulatorManager&&this.manipulatorManager.getActivate()},setOverrideCursors:function(e){this.overrideCursors=e},getCursor:function(){return this.canvas.style.cursor},setCursor:function(e,t,r){if(this.overrideCursors){var n=this,a="auto";if(-1!==["auto","-webkit-grabbing","pointer"].indexOf(e))a=e;else if("Auto"!==e)if(r)a=e;else{var s=i.getWebappsAssetUrl("Visualization","")+"icons/";a="url('"+s+"WebViewer"+e+".png'), url('"+s+"WebViewer"+e+".cur'), auto"}this._changeCursorDelay&&(clearTimeout(this._changeCursorDelay),this._changeCursorDelay=null);var o=function(e){n.canvas.style.cursor=e};t>0?this._changeCursorDelay=setTimeout(function(){o(a)},t):o(a)}},setTemporaryCursor:function(e){var t=this._temporaryCursorData;t||(t={oldCursor:this.getCursor()||null},this._temporaryCursorData=t,this.setCursor(e))},unsetTemporaryCursor:function(){var e=this._temporaryCursorData;if(e){var t=e.oldCursor||"auto";this.setCursor(t,0,!0),this._temporaryCursorData=null}},setForceMultiSelection:function(e){this.forceMultiSel=e},setForcePickingFaces:function(e){this._pickingMode._setPickingMode(N.facesMask,e?1:2),this._setPickingMode()},setForcePickingLines:function(e){this._pickingMode._setPickingMode(N.linesPickingMask,e?1:2),this._setPickingMode()},setForcePickingPoints:function(e){this._pickingMode._setPickingMode(N.pointsMask,e?1:2),this._setPickingMode()},setFacePickingMode:function(e){this._pickingMode._setPickingMode(N.facesMask,e),this._setPickingMode()},setLinePickingMode:function(e){this._pickingMode._setPickingMode(N.linesPickingMask,e),this._setPickingMode()},setPointPickingMode:function(e){this._pickingMode._setPickingMode(N.pointsMask,e),this._setPickingMode()},setPickingMode:function(e,t){this._pickingMode.setPickingMode(e,t),this._setPickingMode()},_setPickingMode:function(){this.renderer.renderer.pickingModeLSB=this._pickingMode.pickingModeLSB,this.renderer.renderer.pickingModeMSB=this._pickingMode.pickingModeMSB,this.invalidatePickingBuffer(),this.renderer.resetGSSOCache()},getPickingMode:function(){return this._pickingMode.clone()},setFromPickingNode:function(e){this._pickingMode=e.clone(),this._setPickingMode()},getRenderMode:function(){return this.renderer.renderer.getRenderMode().clone()},setDebugPostProcessing:function(e){this.debugPostProcessing!==e&&(this.renderer.setEffect("DebugPass",e),this.debugPostProcessing=e,this.render())},showPerfo:function(e,t,i,r,n){if(e&&!this._glFPSCounter){var a=this;require(["DS/VisuTools/FPSCounter"],function(e){n&&e.setAutoRefresh(!1),a._glFPSCounter=e,a._glFPSCounter.setActivated(a,!0,i),window.webVisuPerfo.setEnabled(!!t),r&&r()})}else this._glFPSCounter&&(this._glFPSCounter.setActivated(this,e,i),window.webVisuPerfo.setEnabled(!!t))},showInfos:function(e,t){if(e&&!this._glInfoCounter){var i=this;require(["DS/VisuTools/InfoCounter"],function(e){i._glInfoCounter=new e(i,t)})}else this._glInfoCounter&&this._glInfoCounter.activate(e)},showNodeCounter:function(e,t){if(e&&!this._glNodeCounter){var i=this;require(["DS/VisuTools/NodeCounter"],function(e){i._glNodeCounter=new e(i,t)})}else this._glNodeCounter&&this._glNodeCounter.activate(e)},setDebugFPS:function(e,t){this.debugFPS=e,this.debugFPSInfos.fpsLastTime=performance.now(),this.debugFPSInfos.fpsWindow=t||40,this.debugFPSInfos.fpsIndex=0,this.debugFPSInfos.fpsCumul=30*this.debugFPSInfos.fpsWindow,this.debugFPSInfos.fpsValue=30,this.debugFPSInfos.fpsArray=[];for(var i=0;i<this.debugFPSInfos.fpsWindow;i++)this.debugFPSInfos.fpsArray[i]=30;e?this.debugFPSInfos.fpsCounter?this.debugFPSInfos.fpsCounter.show():(this.debugFPSInfos.fpsCounter=new UWA.Element("div",{html:"FPS",styles:{fontFamily:"arial, sans-serif",fontSize:"20px",position:"absolute",top:"20px",right:"10px",textAlign:"left",verticalAlign:"middle",backgroundColor:"#333",color:"white"}}),this.div.appendChild(this.debugFPSInfos.fpsCounter)):this.debugFPSInfos.fpsCounter&&this.debugFPSInfos.fpsCounter.hide()},setDebugShadowMaps:function(e){this.debugShadowMaps!==e&&(this.renderer.setEffect("DebugShadowMaps",e),this.debugShadowMaps=e,this.render())},setDebugEvents:function(e){this.debugEvents=e,x.setDebugEvents(e)},getDisplayFaces:function(){return!!(this.renderer.renderer.renderFaceMode&t.GeomTypeEnum.FACE)},getDisplayLines:function(){return this.renderer.renderer.renderLineMode!==t.HideAllRenderLineMode},getDisplayPoints:function(){return this.renderer.renderer.renderPointMode>0},getInfinitePlane:function(){return this.infinitePlane},getMirror:function(){return this.useMirror},_setPlaneGridOrientation:function(e){e?this.planeGridOrientation.copy(e):this.planeGridOrientation.makeBasis(this._worldOrientation.frontVector,this._worldOrientation.rightVector,this._worldOrientation.upVector)},createInfinitePlane:function(e,i,r,n){if(!K){var a,s=null===this.internalSceneGraph?this.temporaryEmptyScene:this.internalSceneGraph.scene,o=new t.Vector3,l=new t.Vector3,h=(new t.Matrix4).copy(this.planeGridOrientation);if(o.copy(this._worldOrientation.frontVector),o.multiplyScalar(n.dot(this._worldOrientation.frontVector)-.5*r),l.copy(this._worldOrientation.rightVector),l.multiplyScalar(n.dot(this._worldOrientation.rightVector)-.5*r),o.add(l),l.copy(this._worldOrientation.upVector),l.multiplyScalar(n.dot(this._worldOrientation.upVector)),o.add(l),h.setPosition(o),h.scale(new t.Vector3(r,r,r)),null===e){if(1===i)(a=new t.PlaneMaterial)._firstDirOnly=this.triLights,a.ambient.copy(new t.Color(328965)),a.color.copy(this.planeColor),(d=new t.Color).copyToLinear(this.ambience.getBackgroundColor(),this.renderer.renderer.simpleGamma),a.updatePDSFXUniform("border",d),a.updatePDSFXUniform("borderAlpha",this.ambience.getBackgroundAlpha()),a.updatePDSFXUniform("attenuation",this.planeAttenuation?1:0),(c=C.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:a}))._setIsAlwaysInForeground(!0),this.infPlane=c._occurrences[0].renderable,(e=this.infPlane).receiveShadow=!1,e.renderDepth=1,this.sceneBackground.add(e);else if(0===i){var c;a=new t.SmallPlaneMaterial(void 0),this.dirLightGroundShadow.groundMaterial=a,(c=C.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:a}))._setIsAlwaysInForeground(!0),this.infPlaneSmall=c._occurrences[0].renderable,(e=this.infPlaneSmall).__invisiblePlane=!0,e.receiveShadow=!0,e.castShadow=!1,e.renderDepth=-Number.MAX_VALUE,s.add(e)}e.pickable=!1,e.frustumCulled=!1,e.visibilityFree=!0,e.setMatrix(h)}else{var d;e.visible=!0,e.visibilityFree=!0,1===i&&e.material&&(e.material.color.copy(this.planeColor),(d=new t.Color).copyToLinear(this.ambience.getBackgroundColor(),this.renderer.renderer.simpleGamma),e.material.updatePDSFXUniform("border",d),e.material.updatePDSFXUniform("borderAlpha",this.ambience.getBackgroundAlpha()),e.material.updatePDSFXUniform("attenuation",this.planeAttenuation?1:0)),e.setMatrix(h)}}},_removeInfinitePlane:function(e){null!==e&&e.visible&&(e.visible=!1,this.render())},createGrid:function(e,r,n,a,s){if(!K){a=Math.pow(Math.max(0,a),.4);var o,l,c,d,u=this.mobile;o=function(t){var i=Math.tan(.125*Math.PI);return i*=t/e,Math.ceil(100*i)}(n),l=this.ambience.isAutoGroundOffset()?function(e){for(var t=.25*e,i=2e-4,r=0;i<t;){switch(r%3){case 0:i*=2;break;case 1:i*=2.5;break;case 2:i*=2}r++}return i}(e*o):e,null!==this.grid&&(this.grid.visibilityFree=!0,this.grid.material.color=this.gridColor),null!==this.bigGrid&&(this.bigGrid.visibilityFree=!0,this.bigGrid.material.color=this.gridColor);var p=new t.Vector3,f=new t.Vector3,g=(new t.Matrix4).copy(this.planeGridOrientation);g.scale(new t.Vector3(l,l,l)),this.gridSize=l,this.gridUnit=l*this.gridStep;var m,v=new t.Vector3(0,0,r.dot(this._worldOrientation.upVector));if(v.x=this.gridNbSteps*this.gridUnit*Math.floor(r.dot(this._worldOrientation.frontVector)/(this.gridNbSteps*this.gridUnit)),v.y=this.gridNbSteps*this.gridUnit*Math.floor(r.dot(this._worldOrientation.rightVector)/(this.gridNbSteps*this.gridUnit)),u?(p.copy(this._worldOrientation.frontVector),p.multiplyScalar(v.x-.5*l),f.copy(this._worldOrientation.rightVector),f.multiplyScalar(v.y-.5*l),p.add(f),f.copy(this._worldOrientation.upVector),f.multiplyScalar(v.z),p.add(f)):(p.copy(this._worldOrientation.frontVector),p.multiplyScalar(v.x),f.copy(this._worldOrientation.rightVector),f.multiplyScalar(v.y),p.add(f),f.copy(this._worldOrientation.upVector),f.multiplyScalar(v.z),p.add(f)),g.setPosition(p),null!==this.grid)return this.grid.visibilityFree=!0,this.grid.setMatrix(g),this.grid.material.updatePDSFXUniform("gridSize",e),this.grid.material.updatePDSFXUniform("attenuation",this.grid.map?.9*a:.6*a),this.grid.visible=!0,null!==this.bigGrid&&(this.bigGrid.visibilityFree=!0,this.bigGrid.setMatrix(g),this.bigGrid.material.updatePDSFXUniform("gridSize",e),this.bigGrid.material.updatePDSFXUniform("attenuation",a),this.bigGrid.visible=!0),!0;if(c=new t.GridMaterial,u){var y=i.getWebappsAssetUrl("Visualization","");(m=new t.ImageUtils.loadTexture(y+"grid512.png",void 0,null,null,t.ImageUtils.crossOriginPolicy)).wrapS=t.RepeatWrapping,m.wrapT=t.RepeatWrapping,m.anisotropy=8,m.repeat=new t.Vector2(.2/this.gridStep,.2/this.gridStep),c.setGridTexture(m)}if(c.updatePDSFXUniform("gridSize",e),c.updatePDSFXUniform("attenuation",u?.9*a:.6*a),u){var S=C.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:c});this.grid=S._occurrences[0].renderable,this.grid.frustumCulled=!1}else{var _=new h.PrimitiveGroup,x=2/this.gridStep,b=6*x,w=8*x,M=new h.Buffer({component:h.VertexComponentEnum.POSITION,data:new Float32Array(3*b)}),P=new Uint16Array(w),E=new h.Buffer({indexBuffer:!0,data:P});_.addBuffer(0,M),_.addBuffer(1,E);var A=0,T=0,D=M.data,I=E.data;for(d=0;d<x;d++)D[A++]=d*this.gridStep-1,D[A++]=-1,D[A++]=0,D[A++]=d*this.gridStep-1,D[A++]=0,D[A++]=0,D[A++]=d*this.gridStep-1,D[A++]=1,D[A++]=0,D[A++]=-1,D[A++]=d*this.gridStep-1,D[A++]=0,D[A++]=0,D[A++]=d*this.gridStep-1,D[A++]=0,D[A++]=1,D[A++]=d*this.gridStep-1,D[A++]=0;for(d=0;d<4*x;d++)I[T++]=3*d,I[T++]=3*d+1,I[T++]=3*d+1,I[T++]=3*d+2;var R=new h.Primitive({nbIndices:w,connectivity:h.ConnectivityTypeEnum.LINES,fillGAS:new h.FillAttributes(new h.Color(.2,.2,.2,1))}),O=new h.VertexComponent({nbVertices:b,bufferId:0,indices:new h.IndexArray({bufferId:1,offset:0})});R.addVertexComponent(O),_.addPrimitive(R);var L=C.createMeshNode(_,c);L._setIsAlwaysInForeground(!0),this.grid=L._occurrences[0].renderable,this.grid.frustumCulled=!1}return this.grid.pickable=!1,this.grid.receiveShadow=!0,this.grid.renderDepth=0,this.grid.visibilityFree=!0,this.sceneBackground.add(this.grid),u||(this._createBigGridGeometry(),this.bigGrid.setMatrix(g),this.bigGrid.material.updatePDSFXUniform("gridSize",e),this.bigGrid.material.updatePDSFXUniform("attenuation",a),this.bigGrid.material.color=this.gridColor),this.grid.setMatrix(g),this.grid.material.color=this.gridColor,!0}},_createBigGridGeometry:function(){this.bigGrid&&this.sceneBackground.remove(this.bigGrid);var e=new t.GridMaterial,i=this.gridNbSteps*this.gridStep,r=.02*this.gridStep,n=new h.PrimitiveGroup,a=2/this.gridStep,s=12*a,o=24*a,l=new h.Buffer({component:h.VertexComponentEnum.POSITION,data:new Float32Array(3*s)}),c=new h.Buffer({component:h.VertexComponentEnum.NORMAL,data:new Float32Array(3)}),d=new h.Buffer({indexBuffer:!0,data:new Uint16Array(o)}),u=new h.Buffer({indexBuffer:!0,data:new Uint16Array(o)});n.addBuffer(0,l),n.addBuffer(1,c),n.addBuffer(2,d),n.addBuffer(3,u);var p=0,f=0,g=0,m=l.data,v=d.data,y=c.data,S=u.data;y[0]=0,y[1]=0,y[2]=1;for(var _=0;_<a;_++)m[p++]=_*i-1-r,m[p++]=-1,m[p++]=0,m[p++]=_*i-1-r,m[p++]=0,m[p++]=0,m[p++]=_*i-1-r,m[p++]=1,m[p++]=0,m[p++]=_*i-1+r,m[p++]=1,m[p++]=0,m[p++]=_*i-1+r,m[p++]=0,m[p++]=0,m[p++]=_*i-1+r,m[p++]=-1,m[p++]=0,m[p++]=-1,m[p++]=_*i-1-r,m[p++]=0,m[p++]=0,m[p++]=_*i-1-r,m[p++]=0,m[p++]=1,m[p++]=_*i-1-r,m[p++]=0,m[p++]=1,m[p++]=_*i-1+r,m[p++]=0,m[p++]=0,m[p++]=_*i-1+r,m[p++]=0,m[p++]=-1,m[p++]=_*i-1+r,m[p++]=0;for(_=0;_<24*a;_++)S[g++]=0;var x=0;for(_=0;_<a;_++)v[f++]=x,v[f++]=x+4,v[f++]=x+1,v[f++]=x,v[f++]=x+5,v[f++]=x+4,v[f++]=x+1,v[f++]=x+3,v[f++]=x+2,v[f++]=x+1,v[f++]=x+4,v[f++]=x+3,x+=6,v[f++]=x,v[f++]=x+1,v[f++]=x+4,v[f++]=x,v[f++]=x+4,v[f++]=x+5,v[f++]=x+1,v[f++]=x+2,v[f++]=x+3,v[f++]=x+1,v[f++]=x+3,v[f++]=x+4,x+=6;var b=new h.Primitive({nbIndices:o,connectivity:h.ConnectivityTypeEnum.TRIANGLES,fillGAS:new h.FillAttributes(new h.Color(.2,.2,.2,1))}),w=new h.VertexComponent({nbVertices:s,bufferId:0,indices:new h.IndexArray({bufferId:2,offset:0})}),M=new h.VertexComponent({nbVertices:1,bufferId:1,indices:new h.IndexArray({bufferId:3,offset:0})});b.addVertexComponent(w),b.addVertexComponent(M),n.addPrimitive(b);var P=C.createMeshNode(n,e);P._setIsAlwaysInForeground(!0),this.bigGrid=P._occurrences[0].renderable,this.bigGrid.frustumCulled=!1,this.bigGrid.visibilityFree=!0,this.bigGrid.pickable=!1,this.bigGrid.receiveShadow=!0,this.bigGrid.renderDepth=0,this.sceneBackground.add(this.bigGrid)},_removeGrid:function(){var e=!1;return null!==this.grid&&(this.grid.visible=!1,e=!0),null!==this.bigGrid&&(this.bigGrid.visible=!1,e=!0),e},setAmbientLight:function(e){"number"==typeof e||"string"==typeof e?this.ambientLight.color=new t.Color(e):e&&(this.ambientLight.color=e)},_updateDirectionalLightWorldOrientation:function(e){var i=this.directionalLight,r=null===this.internalSceneGraph?100:this.internalSceneGraph.getBoundingSphere().radius,n=null===this.internalSceneGraph?new t.Vector3(0,0,0):this.internalSceneGraph.getBoundingSphere().center,a=Math.sin(Math.PI*this.dirLightLatitude)*Math.cos(2*Math.PI*this.dirLightLongitude),s=Math.sin(Math.PI*this.dirLightLatitude)*Math.sin(2*Math.PI*this.dirLightLongitude),o=Math.cos(Math.PI*this.dirLightLatitude);this.dirLightVector=(new t.Vector3).copy(e.frontVector).multiplyScalar(a).add((new t.Vector3).copy(e.rightVector).multiplyScalar(s)).add((new t.Vector3).copy(e.upVector).multiplyScalar(o)),this.useDefaultLights&&(i.position=(new t.Vector3).copy(this.dirLightVector).multiplyScalar(2*r).add(n),i.lookAt(n),i.target.position=n,i.target.updateMatrixWorld(),i.updateShadowMap=!0)},setDirectionalLight:function(e,i,r,n){this.renderer.resetGSSOCache(),this.autoUpdateLights=!1,this.dirLightLatitude=e,this.dirLightLongitude=i;var a=this.directionalLight;this._updateDirectionalLightWorldOrientation(this._worldOrientation),this.useDefaultLights&&("number"==typeof r||"string"==typeof r?a.color=new t.Color(r):r&&(a.color=r),a.intensity=n,a.updateShadowMap=!0),this.renderer.resetClippingScene(),this.render()},setLightParameters:function(e){var i=[this.directionalLight,this.directionalLight2,this.directionalLight3],r=[this.dirLightVector,this.dirLight2Vector,this.dirLight3Vector],n=e.lightIndex?e.lightIndex:0,a=i[n],s=r[n];return!!a&&(this.autoUpdateLights=!1,0==e.isPhysical?a._phongReduction=!1:a._phongReduction=!0,e.color&&(a.color=new t.Color(e.color)),void 0!==e.intensity&&(a.intensity=e.intensity),e.direction&&(s.copy(e.direction),0===n&&(a.updateShadowMap=!0)),e.directionType&&(this.dirLightType[n]="camera"===e.directionType,0===n&&(a.updateShadowMap=!0)),this.renderer.resetClippingScene(),this.render(),!0)},setAutoUpdateLights:function(e){this.renderer.resetGSSOCache(),this.autoUpdateLights=e},setLightOnViewpoint:function(e){this.renderer.resetGSSOCache(),this.dirLightType[0]=e},setToneMapping:function(e){var t=this.renderer.ToneMappingEffect;if(t){var i=!0;void 0!==e.gamma&&(t.setGamma(e.gamma),i=!1),void 0!==e.enable&&(e.enable?t.setToneMapping(i?1:2):t.setToneMapping(0))}},setAutoExposure:function(e,t){var i=this.getEffect("ToneMapping");i&&(t||(t={}),i.setAutoExposure(e,t.weightTexture,t.clampMin,t.clampMax))},setV6Ambience:function(){var e=window.__karma__&&!this.ODTMode?"V6":"None";this.setVisuEnv(e)},_removeBackgroundLight:function(){this.renderer.resetGSSOCache()},_cleanAmbience:function(){this.renderer.resetGSSOCache(),this.ambience._removePhysicalGround(),this.removePlaneV2(),this.setGradientBackground(),this.removeAmbience(),this.renderer.setEffect("ToneMapping",!0);var e=this.renderer.ToneMappingEffect;e&&(this.setBloom(!1),e.setBrightness(0),e.setToneMapping(2)),this.renderer.renderer.resetInlinedPostProcess(),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setGroundShadow(!1),this.setShadowPlane(!0),this.setSSLR(!1),this.setSSLRefraction(!1),this.setAmbientLight(3158064),this.useDefaultLights&&(this.setTriLights(!1),this.directionalLight.intensity=0,this.directionalLight2.intensity=0,this.directionalLight.castShadow=!1,this.directionalLight2.castShadow=!1)},setVisuEnvOCA:function(e,r,n){var a=null,s=new B({viewer:this,v2:!0});s.keepIBLTexture=!1,s.keepBackgroundTexture=!1,s.isOCA=!0;var o=i.getWebappsAssetUrl("Visualization",""),l=i.getWebappsAssetUrl("Ambiances",""),h=this,c=0,d=function(){if(--c<=0){h._cleanAmbience();var i=h.renderer.ToneMappingEffect,n=h.renderer.renderer.inlinedPostProcess;if(h.setAmbience(s),a){if(void 0!==a.backgroundColor&&h.setBackgroundColor(a.backgroundColor),a.grid&&(h.setGrid(!0),h.setGridColor(a.gridColor)),a.shadowPlane&&h.setShadowPlane(!0),a.ssao){h.setSSAO(!0);var o=h.ssaoParams;o.minPixelRadius=a.ssao.minPixelRadius,o.dynamicRadius=a.ssao.dynamicRadius,o.adaptativeRadius=a.ssao.adaptativeRadius,o.attenuation=a.ssao.attenuation,o.contrast=a.ssao.contrast,o.power=a.ssao.power,o.radius=a.ssao.radius,o.radiusMin=a.ssao.radiusMin,o.radiusMax=a.ssao.radiusMax,o.thresholdAngle=a.ssao.thresholdAngle}a.ambientLight&&h.setAmbientLight(a.ambientLight),i?(a.toneMapping&&i.setToneMapping(a.toneMapping.type,a.toneMapping.params),a.brightness&&i.setBrightness(a.brightness),a.bloom&&(h.setBloom(!0),h.getEffect("Bloom")._setBloom(a.bloom))):a.inlinedPostProcess&&(n.activated=a.inlinedPostProcess.activated,n.brightness=a.inlinedPostProcess.brightness,n.tonemapping=a.inlinedPostProcess.tonemapping,n.crushblacks=a.inlinedPostProcess.crushblacks,n.burnhighlights=a.inlinedPostProcess.burnhighlights),a.planeV2&&(h.planeV2=!0,h.planeGrid||(h.planeGrid=new D(h)),h.setGroundOptions({displayPlane:!0,planeColor:a.planeV2.planeColor,planeFalloff:a.planeV2.planeFalloff,_onlyDiffuse:a.planeV2._onlyDiffuse})),a.shadow&&(h.setShadow(!0),h.setTransparentShadow(!0)),a.sslr&&h._useQM&&(h.setSSLR(!0),h.setSSLRefraction(!0))}if(h.ambience.updateAmbience(),h.render({updateInfinitePlane:!0}),h.ambience.getBackground().hasGradient()){h.showGradientBackground=[];for(var l=h.ambience.getBackground().getColors(),d=[],u=0;u<l.length;u++)h.showGradientBackground.push(new t.Color(l[u])),h.visibleSpace||d.push(l[u].desaturate(1).alphaBlend(ne,.5));d.length&&h.ambience.getBackground().setColors(d)}var p=e+"OCA";p!==h.visuEnv&&(h.visuEnv=p,h._modelEvent.publish({event:"VisuEnv",data:{viewer:h,value:p}})),r&&r({ambiance:h.ambience})}},u=function(e,i,r,n){var a=2*(e/r-.5)*Math.PI,s=-((n-i)/n-1)*Math.PI;return new t.Vector3(Math.cos(a)*Math.sin(s),Math.sin(a)*Math.sin(s),Math.cos(s))};switch(e){case"Basic":this._cleanAmbience(),this.setVisuEnv("No"),this.useDefaultLights&&(this.directionalLight.castShadow=!1,this.directionalLight2.castShadow=!1);var p=e+"OCA";return void(p!==this.visuEnv&&(this.visuEnv=p,this._modelEvent.publish({event:"VisuEnv",data:{viewer:this,value:p}})));case"WhiteDesign":a={backgroundColor:15132390,grid:!0,gridColor:8355711,shadowPlane:!1},s.getBackground().setFromJson({colors:[[.980392217636108,.980392217636108,.980392217636108,1],[.921568691730499,.921568691730499,.921568691730499,1],[.901960849761963,.901960849761963,.901960849761963,1],[.901960849761963,.901960849761963,.901960849761963,1]],horizonHeight:0,intensity:1,type:"gradientWithHorizon"}),s.generateIBLFromColor([81,81,81,128]);var f=new t.DirectionalLight(16777215,.628318548202515);s.setLights(f,!1,new t.Vector3(0,0,1));var g=new t.DirectionalLight(16777215,1.884955644607544);s.setLights(g,!0,new t.Vector3(-.5,.5,.707107));var m=new t.DirectionalLight(16777215,.942477822303772);s.setLights(m,!0,new t.Vector3(.683012,.183015,.707107));var v=new t.DirectionalLight(16777215,.942477822303772);s.setLights(v,!0,new t.Vector3(-.5,.5,-.707107));break;case"BlueDesign":a={backgroundColor:3958400,grid:!0,gridColor:16777215,shadowPlane:!1},s.getBackground().setFromJson({colors:[[.39607846736908,.549019634723663,.643137276172638,1],[.243137270212173,.415686309337616,.521568655967712,1],[.235294133424759,.400000035762787,.501960813999176,1],[.235294133424759,.400000035762787,.501960813999176,1]],horizonHeight:0,intensity:1,type:"gradientWithHorizon"});f=new t.DirectionalLight(16777215,.628318548202515);s.setLights(f,!1,new t.Vector3(0,0,1));g=new t.DirectionalLight(16777215,1.884955644607544);s.setLights(g,!0,new t.Vector3(-.5,.5,.707107));m=new t.DirectionalLight(16777215,.942477822303772);s.setLights(m,!0,new t.Vector3(.683012,.183015,.707107));v=new t.DirectionalLight(16777215,.942477822303772);s.setLights(v,!0,new t.Vector3(-.5,.5,-.707107)),s.generateIBLFromColor([81,81,81,128]);break;case"DarkDesign":a={backgroundColor:2960685,grid:!0,gridColor:8355711,shadowPlane:!1},s.getBackground().setFromJson({colors:[[.274509817361832,.274509817361832,.274509817361832,1],[.196078449487686,.196078449487686,.196078449487686,1],[.176470592617989,.176470592617989,.176470592617989,1],[.176470592617989,.176470592617989,.176470592617989,1]],horizonHeight:0,intensity:1,type:"gradientWithHorizon"});f=new t.DirectionalLight(16777215,.628318548202515);s.setLights(f,!1,new t.Vector3(0,0,1));g=new t.DirectionalLight(16777215,1.884955644607544);s.setLights(g,!0,new t.Vector3(-.5,.5,.707107));m=new t.DirectionalLight(16777215,.942477822303772);s.setLights(m,!0,new t.Vector3(.683012,.183015,.707107));v=new t.DirectionalLight(16777215,.942477822303772);s.setLights(v,!0,new t.Vector3(-.5,.5,-.707107)),s.generateIBLFromColor([81,81,81,128]);break;case"Studio":a={backgroundColor:15527149,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:1.22,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.22},sslr:!0};var y=new t.DirectionalLight(16777215,1.572345066070557);s.setLights(y,!1,new t.Vector3(0,0,1));g=new t.DirectionalLight(15774860,1.884955644607544);s.setLights(g,!0,new t.Vector3(-.883779,-.413691,.218621));m=new t.DirectionalLight(4214874,2.04);s.setLights(m,!0,new t.Vector3(.865806,-.442989,-.232682));v=new t.DirectionalLight(7895160,.9424);s.setLights(v,!0,new t.Vector3(0,0,1)),c=2,s.getBackground().setFromJson({colors:[[.921568691730499,.921568691730499,.9294117,1],[1,1,1,1]],intensity:1,type:"gradient"}),(E=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});var S={url:l+"OCA/ambianceStudio.png",pngHdr:!0,doneCallback:d};s.setIblMap(S);var _={url:l+"OCA/ambianceStudio_rmips.png",pngHdr:!0,doneCallback:d,hasDiffuse:!0};s.setRoughnessMap(_),(A=s.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.792156934738159,type:"transparent"});break;case"PureWhite":a={backgroundColor:15527149,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:2.125,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.22},sslr:!0};g=new t.DirectionalLight(7895160,.6911);s.setLights(g,!0,new t.Vector3(0,0,1));var x=s._getEnvironmentLightMatrix();f=new t.DirectionalPhongLight(16777215,1);s.setLights(f,!1,u(171,416,2048,1024).applyMatrix4(x));y=new t.DirectionalPhongLight(16777215,1);s.setLights(y,!1,u(852,416,2048,1024).applyMatrix4(x));var b=new t.DirectionalPhongLight(16777215,1);s.setLights(b,!1,u(1536,416,2048,1024).applyMatrix4(x));var w=new t.DirectionalPhongLight(16777215,1);s.setLights(w,!1,u(1024,0,2048,1024).applyMatrix4(x)),s.getBackground().setFromJson({colors:[[.9254,.9254,.9294,1],[1,1,1,1]],intensity:1,type:"gradient"}),(E=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1}),c=2;S={url:l+"OCA/pureWhite.png",pngHdr:!0,doneCallback:d};s.setIblMap(S);_={url:l+"OCA/pureWhite_rmips.png",pngHdr:!0,doneCallback:d,hasDiffuse:!0};s.setRoughnessMap(_),(A=s.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.69803923368454,type:"transparent"});break;case"NeoPureWhite":case"WhiteExperience":a={backgroundColor:14607334,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:2.125,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.22},ambientLight:10066329,sslr:!0,planeV2:{planeColor:"#FFFFFF",planeFalloff:.25,_onlyDiffuse:1}};x=s._getEnvironmentLightMatrix(),f=new t.DirectionalPhongLight(8956671,1);s.setLights(f,!1,u(1957,651,2048,1024).applyMatrix4(x));y=new t.DirectionalPhongLight(16755336,1);s.setLights(y,!1,u(1151,511,2048,1024).applyMatrix4(x));b=new t.DirectionalPhongLight(16777215,1);s.setLights(b,!1,u(0,215,2048,1024).applyMatrix4(x));w=new t.DirectionalPhongLight(16777215,1);s.setLights(w,!1,u(1024,215,2048,1024).applyMatrix4(x)),s.getBackground().setIntensity(1),(E=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1]}),E.setSpecularIntensity(1),E.setDiffuseIntensity(1),c=3;var M={url:l+"OCA/neoPureWhiteBackground.png",mapping:new t.LatLongEnvMapping,doneCallback:d};s.setBackGroundMap(M);S={url:l+"OCA/neoPureWhite.png",pngHdr:!0,doneCallback:d};s.setIblMap(S);_={url:l+"OCA/neoPureWhite_rmips.png",pngHdr:!0,doneCallback:d,hasDiffuse:!0};s.setRoughnessMap(_),n&&n.from3dx?s.getBackgroundGeometry().setAutoUpdateSize(!1):s.getBackgroundGeometry().setAutoUpdateSize(!0),(A=s.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.569,type:"transparent"}),s.usePlaneV2=!0;break;case"WhiteMirror":a={backgroundColor:16777215,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.932,contrast:3.088,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.31},sslr:!0},s.getBackground().setFromJson({colors:[[1,1,1,1],[1,1,1,1]],intensity:1,type:"gradient"}),(E=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});x=s._getEnvironmentLightMatrix(),f=new t.DirectionalPhongLight(16777215,1);s.setLights(f,!1,u(171,416,2048,1024).applyMatrix4(x));y=new t.DirectionalPhongLight(16777215,1.5);s.setLights(y,!1,u(852,416,2048,1024).applyMatrix4(x));b=new t.DirectionalPhongLight(16777215,1);s.setLights(b,!1,u(1536,416,2048,1024).applyMatrix4(x));w=new t.DirectionalPhongLight(16777215,1.5);s.setLights(w,!1,u(1024,0,2048,1024).applyMatrix4(x)),c=2;S={url:l+"OCA/whiteMirror.png",pngHdr:!0,doneCallback:d};s.setIblMap(S);_={url:l+"OCA/whiteMirror_rmips.png",pngHdr:!0,doneCallback:d,hasDiffuse:!0};s.setRoughnessMap(_),(A=s.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.69803923368454,type:"transparent"});break;case"WhiteReview":a={backgroundColor:14474460,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:1.032,contrast:2.5,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.31},sslr:!0},s.getBackground().setFromJson({colors:[[.8627,.8627,.8627,1],[1,1,1,1]],intensity:1,type:"gradient"}),(E=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});x=s._getEnvironmentLightMatrix(),f=new t.DirectionalPhongLight(16777215,1.1);s.setLights(f,!1,u(171,416,2048,1024).applyMatrix4(x));y=new t.DirectionalPhongLight(16777215,1.25);s.setLights(y,!1,u(852,416,2048,1024).applyMatrix4(x));b=new t.DirectionalPhongLight(16777215,1.1);s.setLights(b,!1,u(1536,416,2048,1024).applyMatrix4(x));w=new t.DirectionalPhongLight(16777215,1.25);s.setLights(w,!1,u(1024,0,2048,1024).applyMatrix4(x)),c=2;S={url:o+"OCA/whiteReview.png",pngHdr:!0,doneCallback:d};s.setIblMap(S);_={url:o+"OCA/whiteReview_rmips.png",pngHdr:!0,doneCallback:d,hasDiffuse:!0};s.setRoughnessMap(_),(A=s.getGround()).setFromJson({glossiness:0,height:0,reflectivity:0,shadowIntensity:.423529446125031,type:"transparent"});break;case"DarkMirror":a={backgroundColor:1118481,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},toneMapping:{type:6,params:{crushblacks:.75,burnhighlights:.12,saturation:1}},brightness:1,bloom:{nbIterations:6,bloomFactor:.22,threshold:0},inlinedPostProcess:{activated:!0,brightness:1,tonemapping:6,crushblacks:.75,burnhighlights:.12},shadow:!0,sslr:!0},(f=new t.DirectionalLight(16777215,1.633628129959106)).castShadow=!0,f.shadowMapWidth=this.shadowMapWidth,f.shadowMapHeight=this.shadowMapHeight,f._sceneShadow=!0,s.setLights(f,!1,new t.Vector3(-.588439,0,.808542)),(y=new t.DirectionalLight(16777215,1.633628129959106)).castShadow=!0,y.shadowMapWidth=this.shadowMapWidth,y.shadowMapHeight=this.shadowMapHeight,y._sceneShadow=!0,s.setLights(y,!1,new t.Vector3(.588439,0,.808542)),s.getBackground().setIntensity(1),c=3;M={url:o+"OCA/darkMirror.png",pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:d};s.setBackGroundMap(M),(E=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:.600000023841858});S={url:o+"OCA/darkMirror.png",pngHdr:!0,doneCallback:d};s.setIblMap(S);_={url:o+"OCA/darkMirror_rmips.png",pngHdr:!0,doneCallback:d,hasDiffuse:!0};s.setRoughnessMap(_),(A=s.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.5,shadowIntensity:0,type:"transparent"});break;case"DarkReview":c=2,a={backgroundColor:3289650,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:1.032,contrast:2.5,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.31},sslr:!0},s.getBackground().setFromJson({colors:[[.196,.196,.196,1],[.3529,.3529,.3529,1]],intensity:1,type:"gradient"}),(E=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});x=s._getEnvironmentLightMatrix(),f=new t.DirectionalPhongLight(16777215,1);s.setLights(f,!1,u(171,416,2048,1024).applyMatrix4(x));y=new t.DirectionalPhongLight(16777215,1);s.setLights(y,!1,u(852,416,2048,1024).applyMatrix4(x));b=new t.DirectionalPhongLight(16777215,1);s.setLights(b,!1,u(1536,416,2048,1024).applyMatrix4(x));w=new t.DirectionalPhongLight(16777215,1);s.setLights(w,!1,u(1024,0,2048,1024).applyMatrix4(x));S={url:o+"OCA/darkReview.png",pngHdr:!0,doneCallback:d};s.setIblMap(S);_={url:o+"OCA/darkReview_rmips.png",pngHdr:!0,doneCallback:d,hasDiffuse:!0};s.setRoughnessMap(_),(A=s.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:.447058856487274,type:"transparent"});break;case"Outdoor":a={backgroundColor:15463679,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:1,contrast:1.8,power:1,radius:.06,radiusMin:.001,radiusMax:.1,thresholdAngle:1.31},toneMapping:{type:6,params:{crushblacks:1,burnhighlights:.01,saturation:1}},bloom:{nbIterations:5,bloomFactor:.22,threshold:0},inlinedPostProcess:{activated:!0,brightness:1,tonemapping:6,crushblacks:1,burnhighlights:.01},shadow:!0,sslr:!0};f=new t.DirectionalLight(16704193,18.8);var C=new t.DirectionalLight(16704193,18.8);s.setLights(f,!1,new t.Vector3(-.182353,.741268,.645963),C),f.castShadow=!0,f.shadowMapWidth=this.shadowMapWidth,f.shadowMapHeight=this.shadowMapHeight,f._sceneShadow=!0,C.castShadow=!1,s.getBackground().setIntensity(1),c=3;M={url:l+"OCA/outdoor.png",pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:d};s.setBackGroundMap(M),(E=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1]}),E.setSpecularIntensity(.6),E.setDiffuseIntensity(.5);S={url:l+"OCA/outdoor.png",pngHdr:!0,doneCallback:d};s.setIblMap(S);_={url:l+"OCA/outdoor_rmips.png",pngHdr:!0,doneCallback:d,hasDiffuse:!0};s.setRoughnessMap(_),(A=s.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:0,type:"physical",planeColor:new t.Color(16768178)});var P=s.getBackgroundGeometry();n&&n.from3dx?P.setAutoUpdateSize(!1):P.setAutoUpdateSize(!0),A.setGroundOutDoor();break;case"Indoor":a={backgroundColor:13421772,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},brightness:1,toneMapping:{type:6,params:{crushblacks:.5,burnhighlights:.01,saturation:1}},bloom:{nbIterations:4,bloomFactor:.1,threshold:0},inlinedPostProcess:{activated:!0,brightness:1,tonemapping:6,crushblacks:.5,burnhighlights:.01},shadow:!0,sslr:!0};f=new t.DirectionalLight(16777215,2.513274192810059);s.setLights(f,!1,new t.Vector3(0,.961181,.27592));y=new t.DirectionalLight(16777215,1.256637096405029);s.setLights(y,!1,new t.Vector3(0,.516689,.856173)),y.castShadow=!0,y.shadowMapWidth=this.shadowMapWidth,y.shadowMapHeight=this.shadowMapHeight,y._sceneShadow=!0;b=new t.DirectionalLight(16777215,1.256637096405029);s.setLights(b,!1,new t.Vector3(0,-.506721,.86211)),s.getBackground().setIntensity(1),c=3;M={url:l+"OCA/indoor.png",pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:d};s.setBackGroundMap(M),(E=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:.600000023841858});P=s.getBackgroundGeometry();n&&!n.from3dx&&P.setAutoUpdateSize(!0),n&&n.from3dx?P.setAutoUpdateSize(!1):P.setAutoUpdateSize(!0),P.setFromJson({shootPosition:[0,0,0]});S={url:l+"OCA/indoor.png",pngHdr:!0,doneCallback:d};s.setIblMap(S);_={url:l+"OCA/indoor_rmips.png",pngHdr:!0,doneCallback:d,hasDiffuse:!0};s.setRoughnessMap(_),(A=s.getGround()).setFromJson({glossiness:0,height:0,reflectivity:.400000005960464,shadowIntensity:0,type:"transparent"}),s.setAutoGroundOffset(!0),s.setGroundHeight(new t.Vector3(0,0,.2)),s.setSceneHeight(new t.Vector3(0,0,.2)),this.render({updateInfinitePlane:!0});break;case"City":a={backgroundColor:13421772,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},brightness:1.7,toneMapping:{type:6,params:{crushblacks:.24,burnhighlights:.08,saturation:1}},bloom:{nbIterations:6,bloomFactor:.1,threshold:0},inlinedPostProcess:{activated:!0,brightness:1.7,tonemapping:6,crushblacks:.24,burnhighlights:.08},shadow:!0,sslr:!0};f=new t.DirectionalLight(16777215,1.25);s.setLights(f,!1,new t.Vector3(.727313,-.001712,.686304)),f.castShadow=!0,f.shadowMapWidth=this.shadowMapWidth,f.shadowMapHeight=this.shadowMapHeight,f._sceneShadow=!0,s.getBackground().setIntensity(1),c=3;M={url:l+"OCA/city.png",pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:d};s.setBackGroundMap(M),(E=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1]}),E.setSpecularIntensity(1),E.setDiffuseIntensity(.6);P=s.getBackgroundGeometry();n&&n.from3dx?P.setAutoUpdateSize(!1):P.setAutoUpdateSize(!0),P.setFromJson({shootPosition:[0,0,.5]});S={url:l+"OCA/city.png",pngHdr:!0,doneCallback:d};s.setIblMap(S);_={url:l+"OCA/city_rmips.png",pngHdr:!0,doneCallback:d,hasDiffuse:!0};s.setRoughnessMap(_),(A=s.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:0,type:"transparent"}),s.setAutoGroundOffset(!0),s.setGroundHeight(new t.Vector3(0,0,.2)),s.setSceneHeight(new t.Vector3(0,0,.2));break;case"Road":a={backgroundColor:13421772,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},brightness:.8,toneMapping:{type:6,params:{crushblacks:.2,burnhighlights:.17,saturation:1}},bloom:{nbIterations:4,bloomFactor:.058,threshold:0},inlinedPostProcess:{activated:!0,brightness:.8,tonemapping:6,crushblacks:.2,burnhighlights:.17},shadow:!0,sslr:!0};f=new t.DirectionalLight(16777215,2.51);s.setLights(f,!1,new t.Vector3(.46785,-.847623,.250302)),f.castShadow=!0,f.shadowMapWidth=this.shadowMapWidth,f.shadowMapHeight=this.shadowMapHeight,f._sceneShadow=!0,s.getBackground().setIntensity(1),c=3;var E;M={url:l+"OCA/road.png",pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:d};s.setBackGroundMap(M),(E=s.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:.8});P=s.getBackgroundGeometry();n&&n.from3dx?P.setAutoUpdateSize(!1):P.setAutoUpdateSize(!0),P.setFromJson({shootPosition:[0,0,0]});S={url:l+"OCA/road.png",pngHdr:!0,doneCallback:d};s.setIblMap(S);var A;_={url:l+"OCA/road_rmips.png",pngHdr:!0,doneCallback:d,hasDiffuse:!0};s.setRoughnessMap(_),(A=s.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:1,type:"transparent"}),s.setAutoGroundOffset(!0),s.setGroundHeight(new t.Vector3(0,0,.17)),s.setSceneHeight(new t.Vector3(0,0,.43)),this.render({updateInfinitePlane:!0});break;default:return a={backgroundColor:0},s.updateAmbience(),void d()}return 0==c&&(d(),!0)},setVisuEnv:function(e){this.renderer.resetGSSOCache(),this.ambience._removePhysicalGround(),this.setGradientBackground();var r=this.internalSceneGraph&&this.internalSceneGraph.scene;r&&this.ambience.removeLights(r,this.sceneBackground),this._useDefaultAmbiancesIBL&&this.ambience.dispose(),this.removePlaneV2(),this.renderer.setEffect("ToneMapping",!0);var n=this.renderer.ToneMappingEffect;n&&(this.setBloom(!1),n.setBrightness(0),n.setToneMapping(this.renderer.tonemapping)),this.renderer.renderer.resetInlinedPostProcess();var a="SMAA",s=!0,o=null;this._configAmbiences&&this._configAmbiences.effects&&(o=this._configAmbiences.effects);var l=i.getWebappsAssetUrl("Visualization","");switch(this.setGroundShadow(!1),e){case"None":case"No":if(this.ODTMode&&o&&!o.force){this.setGrid(!1),this.displayInfinitePlane(!1),this.setShadowPlane(!1),this.setBackgroundColor(14414586),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),s=!1;break}var h=!1,c=!1,d=!1,u=!1,p=!1,f=new t.Color,g=new t.Color,m=new t.Color;if(o){var v=o.BackgroundColor;"false"===o.AntiAliasing&&(a="NoAA"),h="false"!==o.Plane,c="false"!==o.Grid,d="false"!==o.Mirror,u="false"!==o.Shadow,p="false"!==o.SSAO,v&&(f.r=void 0!==v.red?v.red:1,f.g=void 0!==v.green?v.green:1,f.b=void 0!==v.blue?v.blue:1)}this.setGrid(c),this.displayInfinitePlane(h),this.setShadowPlane(h);var y=Math.min(Math.max(0,.2126*f.r+.7152*f.g+.0722*f.b),1)>=.5?0:1;g.r=.4*y+.6*f.r,g.g=.4*y+.6*f.g,g.b=.4*y+.6*f.b,m.r=.05*y+.95*f.r,m.g=.05*y+.95*f.g,m.b=.05*y+.95*f.b,this.setBackgroundColor(f.getHex()),this.setPlaneColor(m.getHex()),this.setGridColor(g.getHex()),this.setSSAO(p);var S=this.ssaoParams;p&&(S.dynamicRadius=!0,S.adaptativeRadius=!0,S.radius=.04,S.radiusMin=.01,S.radiusMax=.12,S.minPixelRadius=14,S.attenuation=1,S.contrast=2,S.power=1,S.thresholdAngle=1.35),this.setShadow(u),this.setTransparentShadow(u),this.setMirror(d,!0),this._useDefaultAmbiancesIBL&&this.ambience.generateIBLFromColor([81,81,81,128]),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15});break;case"V6":if(this.setGrid(!0),this.displayInfinitePlane(!0,!1),this.setBackgroundColor(15527148),this.setPlaneColor(16514043),this.setGridColor(13421772),this.setSSAO(!0),(S=this.ssaoParams).dynamicRadius=!0,S.adaptativeRadius=!0,S.radius=.04,S.radiusMin=.01,S.radiusMax=.12,S.minPixelRadius=14,S.attenuation=1,S.contrast=2.5,S.power=1,S.thresholdAngle=1.35,this.setShadow(!0),this.setTransparentShadow(!0),this.setMirror(!0,!0),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){var _={url:l+"OCA/whiteReview.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,127]};this.ambience.setIblMap(_);var x={url:l+"OCA/whiteReview_rmips.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,127],hasDiffuse:!0};this.ambience.setRoughnessMap(x)}break;case"CleanSpace":if(this.setGrid(!1),this.displayInfinitePlane(!0,!1),this.setBackgroundColor(15527148),this.setPlaneColor(16514043),this.setSSAO(!0),(S=this.ssaoParams).dynamicRadius=!0,S.adaptativeRadius=!0,S.radius=.04,S.radiusMin=.01,S.radiusMax=.12,S.minPixelRadius=14,S.attenuation=1,S.contrast=2.5,S.power=1,S.thresholdAngle=1.35,this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){_={url:l+"OCA/whiteReview.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,127]};this.ambience.setIblMap(_);x={url:l+"OCA/whiteReview_rmips.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,127],hasDiffuse:!0};this.ambience.setRoughnessMap(x)}break;case"DarkBlue":this.setGrid(!0),this.displayInfinitePlane(!1),this.setBackgroundColor(3958400),this.setGradientBackground([6728399,3958400,1848912]),this.setGridColor(8362924),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),this._useDefaultAmbiancesIBL&&this.ambience.generateIBLFromColor([81,81,81,128]),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15});break;case"DarkGrey":if(this.setGrid(!0),this.displayInfinitePlane(!0,!1),this.setBackgroundColor(3881787),this.setPlaneColor(2960685),this.setGridColor(7303023),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){_={url:l+"OCA/darkReview.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,125]};this.ambience.setIblMap(_);x={url:l+"OCA/darkReview_rmips.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,125],hasDiffuse:!0};this.ambience.setRoughnessMap(x)}break;case"Shiny":if(this.setGrid(!1),this.displayInfinitePlane(!0,!0),this.setBackgroundColor(1118481),this.setGradientBackground([6710886,2105376,0]),this.setPlaneColor(6710886),this.setSSAO(!0),(S=this.ssaoParams).dynamicRadius=!0,S.adaptativeRadius=!0,S.radius=.04,S.radiusMin=.01,S.radiusMax=.12,S.minPixelRadius=14,S.attenuation=1,S.contrast=2.8,S.power=1,S.thresholdAngle=1.35,this.setShadow(!0),this.setTransparentShadow(!0),this.setMirror(!0,!0),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){_={url:l+"OCA/darkMirror.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,125]};this.ambience.setIblMap(_);x={url:l+"OCA/darkMirror_rmips.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,125],hasDiffuse:!0};this.ambience.setRoughnessMap(x)}break;case"Studio":if(this.setGrid(!1),this.displayInfinitePlane(!1),this.setBackgroundColor(15527148),this.setGradientBackground([7497556,15131615,9668981]),this.setPlaneColor(16119027),this.setSSAO(!0),(S=this.ssaoParams).dynamicRadius=!0,S.adaptativeRadius=!0,S.radius=.04,S.radiusMin=.01,S.radiusMax=.12,S.minPixelRadius=14,S.attenuation=1,S.contrast=2.5,S.power=1,S.thresholdAngle=1.35,this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!0,!0),this._useDefaultAmbiancesIBL){_={url:l+"OCA/darkMirror.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,126]};this.ambience.setIblMap(_);x={url:l+"OCA/darkMirror_rmips.png",pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,126],hasDiffuse:!0};this.ambience.setRoughnessMap(x)}this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15});break;default:return}var b=e;b!==this.visuEnv&&(this.visuEnv=b,this._modelEvent.publish({event:"VisuEnv",data:{viewer:this,value:b}})),this.ODTMode&&this.setAntiAliasing(a),this.setTriLights(s),this.triLights?this.dirLightLatitude=.34:(this.setSecondaryLightColor(15527148),this.setDirectionalLight(.34,.16,16777215,.95*Math.PI))},getVisuEnv:function(){return this.visuEnv},onVisuEnvChange:function(e){return this._modelEvent.subscribe({event:"VisuEnv"},e)},setTriLights:function(e){if(e!==this.triLights){this.triLights=e;var i=this.directionalLight,r=this.directionalLight2,n=this.directionalLight3;e?(i&&(i.intensity=.49*Math.PI,i.shadowDarkness=.3),r&&(r.intensity=.49*Math.PI,r.color=new t.Color(16777215)),n||(this.directionalLight3=new t.DirectionalLight(16777215,.49*Math.PI),this.directionalLight3._phongReduction=!0,n=this.directionalLight3),n.position.set(40,-40,40),n.target=new t.Object3D,this.internalSceneGraph&&this.internalSceneGraph.scene.add(n)):(i&&(i.intensity=.81*Math.PI,i.shadowDarkness=.65),r&&(r.intensity=1*Math.PI,r.color=new t.Color(3827071)),n&&this.internalSceneGraph&&this.internalSceneGraph.scene.remove(n)),this.infPlane&&this.infPlane.material&&(this.infPlane.material._firstDirOnly=e,this.infPlane.material.needsUpdate=!0)}},setLightProbe:function(e){console.warn("Light probes are deprecated and won't work on PBR materials, please use an ambiance instead, phongs are deprecated"),console.warn("setLightProbe API disabled")},showEnvMap:function(e){this.renderer.resetGSSOCache();var t=this.ambience.getBackground();t.isActivated()!==e&&(e?(t.withImage()||t.hasGradient())&&t.setActivated(e):t.setActivated(e))},setEnvMap:function(e,i,r){if(this.renderer.resetGSSOCache(),2===i){console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation.");var n=this,a=0,s=2===e.length?e[0]:null,o=2===e.length?e[1]:null;s||(s=t.ImageUtils.loadHDRTexture(e+".hdr",new t.LatLongReflectionMapping)),s.minFilter=t.NearestFilter,s.magFilter=t.NearestFilter,s.wrapS=t.RepeatWrapping,s.wrapT=t.RepeatWrapping,o||(o=t.ImageUtils.loadHDRTexture(e+"_rmips.hdr",new t.LatLongReflectionMapping)),o.minFilter=t.NearestFilter,o.magFilter=t.NearestFilter,o.wrapS=t.RepeatWrapping,o.wrapT=t.RepeatWrapping;var l=function(){2===++a&&(n.internalSceneGraph.scene.envMipMap[0]=s,n.internalSceneGraph.scene.envMipMap[1]=o,n.renderer.renderer.ambianceGenerators._decreaseSceneUseCount(n.internalSceneGraph.scene),n.render(),r&&r())};return s&&s.onLoadCallbacks.push(l),o&&o.onLoadCallbacks.push(l),s}null!==e?e.length||e instanceof t.Texture?(console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation."),2===e.length?(this.ambience.setBackGroundMap({texture:e[0]}),this.ambience.setRoughnessMap({texture:e[1]})):this.ambience.setBackGroundMap({texture:e})):this._setEnvMap(e):console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation.")},_setSphereEnv:function(e){e&&(this.sphereEnv=e,this.sceneBackground.add(e))},_setPhysicalGround:function(e){e&&(this.ground=e,this.sceneBackground.add(e))},_setEnvMap:function(e){var i=void 0,n=0,a=0,s=function(){++a===n&&e.doneCallback&&e.doneCallback()};e.roughnessMap instanceof t.Texture?(n++,this.ambience.setRoughnessMap({texture:e.roughnessMap,doneCallback:s}),i=!0):null===e.roughnessMap&&(i=null);if(e.IBLMap){if(e.IBLMap instanceof t.Texture)n++,this.ambience.setIblMap({texture:e.IBLMap,doneCallback:s});else if(""!==e.IBLMap){var o="dds"===r.getExtension(e.IBLMap);n++,o?this.ambience.setReflectionMap({url:e.IBLMap,doneCallback:s}):this.ambience.setIblMap({url:e.IBLMap+".hdr",mapping:new t.LatLongReflectionMapping,hdr:!0,doneCallback:s}),i||o||(n++,this.ambience.setRoughnessMap({url:e.IBLMap+"_rmips.hdr",doneCallback:s}))}}else null===e.IBLMap&&(null,i=null);if(e.envMap)if(e.envMap instanceof t.Texture)n++,this.ambience.setBackGroundMap({texture:e.envMap,doneCallback:s});else if(""!==e.envMap){(o="dds"===r.getExtension(e.envMap))?(n++,this.ambience.setBackGroundMap({url:e.envMap,hdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:s})):(n++,this.ambience.setBackGroundMap({url:e.envMap+".hdr",hdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:s}))}},setEnvMapBlur:function(e){this.envMapBlur=e,this.ambience.setEnvMapBlur(e)},setEnvMapOffset:function(e){},setEnvMapExposure:function(e){this.envMapExposure=e,this.ambience.setExposure(e),this.sphereEnv&&this.sphereEnv.material&&(this.sphereEnv.material.envMapExposure=e),this.internalSceneGraph.scene.envMipMap[0]&&(this.internalSceneGraph.scene.envMipMap[0].envMapExposureSpecular=e,this.internalSceneGraph.scene.envMipMap[0].envMapExposureDiffuse=e)},addReflectionProbe:function(e,i,r,n,a){var s=this,o=t.ImageUtils.loadHDRTexture(e+".hdr",new t.LatLongReflectionMapping,a);o.onLoadCallbacks.push(function(){s.render()}),o.minFilter=t.NearestFilter,o.magFilter=t.NearestFilter,o.wrapS=t.RepeatWrapping,o.wrapT=t.RepeatWrapping;var l=t.ImageUtils.loadHDRTexture(e+"_rmips.hdr",new t.LatLongReflectionMapping);l.onLoadCallbacks.push(function(){s.render()}),l.minFilter=t.NearestFilter,l.magFilter=t.NearestFilter,l.wrapS=t.RepeatWrapping,l.wrapT=t.RepeatWrapping;var h={map0:o,map1:l,position:i,geomProxy:new t.Box3(r,n)};this.internalSceneGraph.scene.reflectionProbes.push(h)},removeReflectionProbes:function(){this.internalSceneGraph.scene.reflectionProbes=[]},setEnvMapAmbient:function(e){this.sphereEnv&&this.sphereEnv.material&&this.sphereEnv.material.ambient.copyToLinear(e,this.renderer.renderer.simpleGamma)},removeEnvMap:function(){var e=!1;return this.ambience.getBackground().isActivated()&&(e=!0,this.ambience.getBackground().setActivated(!1)),null!==this.sphereEnv&&(this.sphereEnv.visible=!1),e},updateBackgroundLights:function(){for(var e=(null===this.internalSceneGraph?this.temporaryEmptyScene:this.internalSceneGraph.scene).__lights,t=[],i=-1,r=[],n=0;n<this.lights.length;n++){i=-1;for(var a=0;a<e.length;a++)if(this.lights[n].fgLight===e[a]){i=n;break}-1===i&&(this.sceneBackground.remove(this.lights[n].bgLight),r.push(n))}for(n=r.length;n>0;n--)this.lights.splice(r[n],1);for(n=0;n<e.length;n++){var s=e[n];if(i=-1,!s.isVirtual){for(a=0;a<this.lights.length;a++)if(this.lights[a].fgLight===s){i=a;break}if(-1===i){var o=s.clone();o.castShadow=!1,this.sceneBackground.add(o),t.push({fgLight:s,bgLight:o})}else{var l=this.lights[i].bgLight;s.clone(l),l.castShadow=!1}}}for(n=0;n<t.length;n++){var h=t[n];this.lights.push(h)}},getSceneBoundingSphere:function(e,i,r){"show"===e&&(console.warn("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace");let n=r||this.internalSceneGraph;return n?(n.root._tryOverridesUpdate(this),n.getBoundingSphere(e,i)):i?null:new t.Sphere},getSceneBoundingBox:function(e,i){"show"===e&&(console.warn("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace");let r=i||this.internalSceneGraph;if(!r)return new t.Box3;var n=r.root;return n._tryOverridesUpdate(this),n._occurrences[0].getBoundingBox(e)},computeSceneAccurateBoundingBox:function(e,i,r,n,a){let s=a||this.internalSceneGraph;if(!s)return new t.Box3;var o=s.root;o._tryOverridesUpdate(this),r=r||t.FixedSizeFiltering.Include,n=n||[];for(var l=0,h=0;h<n.length;h++){l|=n[h]}return o._occurrences[0].computeAccurateBoundingBox(e,i,r,l)},_updateNearFar:function(e){var i=this.trackingViewpoint?this.trackingViewpoint:e||this.currentViewpoint,r=i.camera;if(!r)return!1;var n=r.near,a=r.far,s=null===this.internalSceneGraph?new t.Sphere(new t.Vector3(0,0,0),100):this.getSceneBoundingSphere(this.visibleSpace?"visibleSpace":"invisibleSpace");if(!s)return!1;var o=0;if(s.pixelRadius>0){var l=r.getWorldSizeFromPixelSize(1,s.center,this._getDivClientHeight());if(void 0!==r.fullWidth&&r.fullWidth>0)l*=Math.max(1*r.width/r.fullWidth,1*r.height/r.fullHeight);o=l*s.pixelRadius}this._updateOffsetPlane(s,r,!1);var h=this._getPlaneSize(s,r,this.gridUnit,this.gridStep);h!==this.planeSize&&(this.planeSize=h);var c,d=(new t.Vector3).subVectors(s.center,r.position),u=(new t.Vector3).subVectors(this.offsetPlaneBackground,r.position),p=r.getLookAt(),f=d.dot(p),g=u.dot(p),m=f,v=Math.PI*Math.max(.1,.5-this.dirLightLatitude),y=Math.sin(v)+(Math.cos(v)+1)/Math.tan(v),S=this._infinitePlane||this._displayGrid;if(S)if(this.cameraBackgroundFar=Math.max(g+this.planeSize,f+s.radius),this._nearFarBigScale){var _=(new t.Sphere).copy(s);_.center.z-=s.radius;var x=new t.Sphere;s.mergeWithSphere(_,x),d.subVectors(x.center,r.position),m=d.dot(p)}else d.z-=s.radius,m=d.dot(p);if(this.cameraBackgroundNear=g-this.planeSize,this._nearFarBigScale&&(this.cameraBackgroundNear=Math.max(this.cameraBackgroundNear,.001)),this.ambience.getBackground().isActivated()&&!this._2DMode)if(this.ambience.isFiniteMode()){if(!r.isOrtho){var b=y*this.ambience.getRadiusEnvMap();this.cameraBackgroundFar=m+b;var w=Math.max(m-b,.001*this.cameraBackgroundFar);w>this.cameraBackgroundNear&&(this.cameraBackgroundNear=w)}0==this.internalSceneGraph.scene.useFiniteEnvMap&&(this.internalSceneGraph.scene.useFiniteEnvMap=!0,this.renderer&&this.renderer.recompileAllShaders(null)),this.internalSceneGraph.scene.parallaxCorrectionParameters.sphereCenter=this.ambience.getCenter(),this.internalSceneGraph.scene.parallaxCorrectionParameters.sphereRadius=this.ambience.getRadius(),this.internalSceneGraph.scene.parallaxCorrectionParameters.projectionCenter=this.ambience.getProjectionCenter()}else 1==this.internalSceneGraph.scene.useFiniteEnvMap&&(this.internalSceneGraph.scene.useFiniteEnvMap=!1,this.renderer&&this.renderer.recompileAllShaders(null)),this.cameraBackgroundFar=Math.max(g+this.planeSize,f+s.radius);if(c=this._nearFarBigScale?y*(S?x.radius+o:s.radius+o):y*(s.radius+o),r.far=m+c,r.near=Math.max(m-c,.001*r.far),this._nearFarBigScale){var M=i.control.distanceToTarget,C=Math.max(0,m-c);r.near=M>50?Math.min(Math.max(M/50,C),r.near):Math.min(Math.max(.1,C),r.near)}return r.isOrtho?r.near=m-c:r.far<0&&(r.near=5,r.far=50),n!==r.near||a!==r.far},isShadowMap:function(){for(var e=(null===this.internalSceneGraph?this.temporaryEmptyScene:this.internalSceneGraph.scene).__lights,t=0;t<e.length;t++)if(!e[t].isVirtual&&(e[t].castShadow||e[t].castGroundShadow))return!0;return!1},dispose:function(){e.publish({event:"/VISU/VIEWER/VIEWER_DISPOSED",data:{eventChannel:"/VISU/VIEWER/VIEWER_DISPOSED",eventType:"@VIEWER_DISPOSED",parameters:{viewer:this}}}),disposedViewers.push(this.id),this.canvas.removeEventListener("webglcontextlost",this.onWebGLContextLost),this.canvas.removeEventListener("webglcontextrestored",this.onWebGLContextRestore),this.canvas.webGLViewer=null;for(var i=0;i<this.highlightSets.length;i++)this.highlightSets[i]&&this.highlightSets[i]._detachEvents(!1,!1);this.highlightSets=[],this._oocManager&&this._oocManager._dispose(),this._oocManager=null,this._sceneGraphOverrideSetManager&&(this._sceneGraphOverrideSetManager.dispose(),this._sceneGraphOverrideSetManager=null),this.disposed=!0,this.setDefaultPicking(!1),this.infPlane&&this.infPlane.dispose(),this.infPlaneSmall&&this.infPlaneSmall.dispose(),this.grid&&this.grid.dispose(),this.ambience&&this.ambience.needUpdateIBL.delete(this),this.renderer.renderer.ambianceGenerators._decreaseSceneUseCount(this.internalSceneGraph.scene),this.bigGrid&&this.bigGrid.dispose(),this.internalSceneGraph&&(this.internalSceneGraph.dispose(),this.internalSceneGraph=null,this._safeInternalSceneGraph=null),e.unsubscribe(this._requestShadowMapUpdate),e.unsubscribe(this._requestVisuUpdate),this.requestViewPanelClose(),t.cleanPredefinedMaterialCache(),t.cleanPredefinedMaterialTextureCache(),this.sceneBackground.dispose(),this.sceneBackground=null,this.manipulatorManager&&(this.manipulatorManager._detachEvents(),this.manipulatorManager=null),this.renderer.renderer.ambianceGenerators.dispose(this),this.renderer.renderer.sssGenerator.dispose(this),this._viewpointManager.dispose(),this._viewpointManager=null;for(i=0;i<this.viewpoints.length;i++)this.viewpoints[i].setDefaultController(!1),this.viewpoints[i]._setNode(null);this.materialManager.viewerList.delete(this.id),this.materialManager.cleanAll(),this.materialManager=null,this._userPassManager._dispose(),this.renderer&&this.renderer.dispose(),this.renderer=null,x.disconnectFrom(this.canvas),x._dispose(this.canvas),document.removeEventListener("contextmenu",this._contextMenu,!0),window.debugWebGLV6Viewer=null,this.div&&(this.canvas&&this.div===this.canvas.parentNode&&this.div.removeChild(this.canvas),this.divCssElement&&this.div===this.divCssElement.parentNode&&this.div.removeChild(this.divCssElement),this.divTrap&&this.div===this.divTrap.parentNode&&this.div.removeChild(this.divTrap),this.svgRootNode&&this.div===this.svgRootNode.parentNode&&this.div.removeChild(this.svgRootNode)),this.canvas.webGLV6Viewer&&delete this.canvas.webGLV6Viewer,this.canvas=null,this.infPlane=null,this.infPlaneSmall=null,this.grid=null,this.bigGrid=null,this.sceneBackground=null,this.cameraBackground=null,this.ambientLight=null,this.directionalLight=null,this.directionalLight2=null,this.directionalLight3=null,this.dirLightGroundShadow=null,this.lights=[],this.currentViewpoint=null,this.viewpoints=[],this.trackingViewpoint=null,this.materialManager=null,this.cameraReflected=null,this.renderer=null,this.debugPickingNode=null,this.debugNormalNode=null,this.temporaryEmptyScene=null,this._modelEvent.destroy(),this.trapSelectionManipulator=null,W.detachViewer(this),this.clearThis(),this._refPlaneMap.clear(),this._refPlaneCounter=0},setRenderFrameCB:function(e,t){this.renderFrameCB=e,this.beginRenderFrameCB=t},getCurrentSceneGraphState:function(){return this.sceneGraphState},getSceneGraphOverrideSetManager:function(){return this._sceneGraphOverrideSetManager},hasSceneGraphOverrideSet:function(){return!!(this.sceneGraphState||this._sceneGraphOverrideSetManager&&this._sceneGraphOverrideSetManager.hasSceneGraphOverrideSet())},getUserPassManager:function(){return this._getUserPassManager()},clearScene:function(e,t){this.empty(e,t)},empty:function(e,t){this.internalSceneGraph&&this.internalSceneGraph.clearScene(e,t,this._sceneGraph?"deprecated":void 0),e&&this.render({updateInfinitePlane:t,needReframe:t}),this.divCss2DElement.empty()},isEmpty:function(){return this._sceneGraph?0===this._sceneGraph._private_root.children.length:this.internalSceneGraph?0===this.internalSceneGraph.userRoot.children.length:void 0},setDisableBackFaceCulling:function(e){this.renderer.setDisableBackFaceCulling(e)},setCameraSystem:function(e){e!==this.cameraSystem&&(this.cameraSystem=e,this.renderer.clearCameraSystemData(),this.cameraSystemUpdated=!0),e||this.renderer.renderer.removeSplitScreenMode(),this.renderer.resetGSSOCache()},set2DMode:function(e,t,i){this._2DMode=e,this._setBackgroundColor(),this._updateGridDisplay(),this._updateInfinitePlaneDisplay(),this._updateShadowPlaneDisplay(),this.currentViewpoint&&this.currentViewpoint._set2DMode(e,t),this._updateSVGVisu(),this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}})},get2DMode:function(){return this._2DMode},getCameraSystem:function(){return this.cameraSystem},_updateShaders:function(){this.internalSceneGraph&&this.internalSceneGraph.updateShaders()},_addRobot:function(e,t){t.addRobotNode(e)},addDebugPoint:function(e,i){var r=C.createSphereNode({radius:3,material:new t.MeshBasicMaterial({color:i,force:!0,enableClipPlanes:!1,forceSide:!0})});r.setNoZ(!0);var n=C.createFixedSizeNode();n.addChild(r),this.internalSceneGraph.addDebugNode(n),n.setPickable(h.PICKTHROUGH);var a=this;function s(e){var i=new t.Matrix4;e instanceof Array&&(e={x:e[0],y:e[1],z:e[2]}),i.setPosition(e),n.setMatrix(i)}return s(e),{setPosition:function(e){s(e)},remove:function(){a.internalSceneGraph.removeDebugNode(n)},add:function(){a.internalSceneGraph.addDebugNode(n)}}},_initRenderStyle:function(){if(!this._renderStyle){var e=new G;e.setFaceMode("COLOR"),e.setMaterialMode(!!this.renderer.renderer.materialMode),e._renderMode._setMask(this.renderer.renderer.renderPointMode|this.renderer.renderer.renderFaceMode|this.renderer.renderer.renderLineMode),e._renderMode._outlineWidth=this.renderer.renderer.outlineWidth,this.setRenderStyle(e)}},setVisuShadingMode:function(t){if(t&&(this._initRenderStyle(),this.visuShadingMode.preset!==t)){switch(this.visuShadingMode.preset=null,t){case"NoShadingEdges":case"Wireframe":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Wireframe"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("NoPoints");break;case"Shading":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("NoEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingEdgesHiddenEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHiddenEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingEdgesHalfSmoothEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdgesHalfSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdgesNoSmoothEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdgesNoSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingIllustration":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Illustration"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingMaterial":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("NoEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingMaterialEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesHalfSmoothEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesHiddenEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHiddenEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesNoSmoothEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingMaterialEdgesNoSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("NoPoints");break;case"Unknown":break;default:throw"Unknown mode in setVisuShadingMode"}this.visuShadingMode.preset=t,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:t}}),e.publish({event:"/VISU/onViewModeChanged",data:{eventChannel:"/VISU/onViewModeChanged",eventType:"@onViewModeChanged",viewer:this}}),this.setRenderStyle(this._renderStyle),this.render()}},_solveVisuShadingPreset:function(){if(null===this.visuShadingMode.preset&&null!==this.visuShadingMode.face&&null!==this.visuShadingMode.edge){for(var e=this.getMaterialMode().toString(),t=re[e],i=this.visuShadingMode.face,r=te[i],n=this.visuShadingMode.edge,a=ie[n],s=0;s<t.length;s++)for(var o=t[s],l=0;l<r.length;l++){var h=r[l];if(h===o)for(var c=0;c<a.length;c++){var d=a[c];if(d===h)return this.visuShadingMode.preset=d,void this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:d}})}}this.visuShadingMode.preset="Unknown",this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:"Unknown"}})}},getVisuShadingMode:function(){return this.visuShadingMode.preset},onVisuShadingModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingMode"},e)},_setVisuShadingFaceMode:function(e){if(e){switch(this._initRenderStyle(),e){case"Shaded":this._renderStyle.setRenderMode("Face",!0),this._renderStyle.setRenderMode("Outline",this.visuShadingMode.outline),this._renderStyle.setFaceMode("COLOR"),this._setVisuShadingEdgeMode(this.visuShadingMode.edge),this._setVisuShadingPointMode(this.visuShadingMode.point);break;case"Illustration":this._renderStyle.setRenderMode("Face",!0),this._renderStyle.setRenderMode("Outline",!0),this._renderStyle.setFaceMode("BACKGROUND"),this._setVisuShadingEdgeMode("WithEdges"),this._setVisuShadingPointMode("NoPoints");break;case"Wireframe":this._renderStyle.setRenderMode("Face",!1),this._renderStyle.setRenderMode("Outline",this.visuShadingMode.outline),this._renderStyle.setFaceMode("COLOR"),this._setVisuShadingEdgeMode("WithEdges"),this._setVisuShadingPointMode("WithPoints");break;default:throw"Unknown mode in setVisuShadingFaceMode"}this.setRenderStyle(this._renderStyle),this.render()}},setVisuShadingFaceMode:function(e){e&&e!==this.visuShadingMode.face&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.visuShadingMode.face=e,this._setVisuShadingFaceMode(e),this._modelEvent.publish({event:"VisuShadingFaceMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getVisuShadingFaceMode:function(){return this.visuShadingMode.face},onVisuShadingFaceModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingFaceMode"},e)},_setVisuOutlineMode:function(e){"Illustration"!==this.visuShadingMode.face&&(this._initRenderStyle(),this.visuShadingMode.outline!==e&&(this._renderStyle.setRenderMode("Outline",e),this.visuShadingMode.outline=e,this._modelEvent.publish({event:"VisuOutlineMode",data:{viewer:this,value:e}}),this.setRenderStyle(this._renderStyle),this.render()))},_getVisuOutlineMode:function(){return this.visuShadingMode.outline},_onVisuOutlineModeChange:function(e){return this._modelEvent.subscribe({event:"VisuOutlineMode"},e)},_setVisuShadingPointMode:function(e){if(e){switch(this._initRenderStyle(),e){case"WithPoints":this._renderStyle.setRenderMode("BoundaryPoint",!0),this._renderStyle.setRenderMode("SharpPoint",!0),this._renderStyle.setRenderMode("SmoothPoint",!0),this._renderStyle.setRenderMode("SurfacicPoint",!0);break;case"NoPoints":this._renderStyle.setRenderMode("BoundaryPoint",!1),this._renderStyle.setRenderMode("SharpPoint",!1),this._renderStyle.setRenderMode("SmoothPoint",!1),this._renderStyle.setRenderMode("SurfacicPoint",!1);break;default:throw"Unknown mode in setVisuShadingPointMode"}this.setRenderStyle(this._renderStyle),this.render()}},setVisuShadingPointMode:function(e){e&&e!==this.visuShadingMode.point&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.visuShadingMode.point=e,"Wireframe"!==this.visuShadingMode.face&&"Illustration"!==this.visuShadingMode.face&&this._setVisuShadingPointMode(e),this._modelEvent.publish({event:"VisuShadingPointMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getVisuShadingPointMode:function(){return this.visuShadingMode.point},onVisuShadingPointModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingPointMode"},e)},_setVisuShadingEdgeMode:function(e){if(e){switch(this._initRenderStyle(),e){case"WithEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesHalfSmoothEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!0);break;case"NoEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!1),this._renderStyle.setRenderMode("Edge",!1),this._renderStyle.setRenderMode("InternalSmoothEdge",!1),this._renderStyle.setRenderMode("BoundaryEdge",!1),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesHiddenEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(1),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesHalfSmoothEdgesHiddenEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(1),this.displayHalVisibleSmoothEdges(!0);break;case"WithEdgesNoSmoothEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!1),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesNoSmoothEdgesHiddenEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!1),this.displayHiddenEdges(1),this.displayHalVisibleSmoothEdges(!1);break;default:throw"Unknown mode in setVisuShadingEdgeMode"}this.setRenderStyle(this._renderStyle),this.render()}},setVisuShadingEdgeMode:function(e){e&&e!==this.visuShadingMode.edge&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.visuShadingMode.edge=e,"Wireframe"!==this.visuShadingMode.face&&"Illustration"!==this.visuShadingMode.face&&this._setVisuShadingEdgeMode(e),this._modelEvent.publish({event:"VisuShadingEdgeMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getVisuShadingEdgeMode:function(){return this.visuShadingMode.edge},onVisuShadingEdgeModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingEdgeMode"},e)},restoreVisualizationMode:function(e){var i=[],r=0,n=t.ShowAllFaces,a=t.ShowAllRenderLineMode,s=0;e&&(void 0!==e.materialMode&&null!==e.materialMode&&(r=e.materialMode),void 0!==e.renderFaceMode&&null!==e.renderFaceMode&&(n=e.renderFaceMode),void 0!==e.renderLineMode&&null!==e.renderLineMode&&(a=e.renderLineMode),void 0!==e.displayHiddenEdges&&null!==e.displayHiddenEdges&&(s=e.displayHiddenEdges));var o=localStorage.getItem("visuShadingMode");if(o)localStorage.removeItem("renderFaceMode"),localStorage.removeItem("renderLineMode"),localStorage.removeItem("displayHiddenEdges"),localStorage.removeItem("materialMode"),this.setVisuShadingMode(o),i.push("Visu"+o+"Cmd"),i.push("Visu"+o);else{if(!localStorage.getItem("materialMode")||"BACKGROUND"!==localStorage.getItem("materialMode")&&"ZONLY"!==localStorage.getItem("materialMode")){var l=localStorage.getItem("materialMode")?parseInt(localStorage.getItem("materialMode"),10):r;this.setMaterialMode(l)}else{var h=new G;h.setFaceMode(localStorage.getItem("materialMode")),this.setRenderStyle(h)}var c=localStorage.getItem("renderFaceMode")?parseInt(localStorage.getItem("renderFaceMode"),10):n,d=localStorage.getItem("renderLineMode")?parseInt(localStorage.getItem("renderLineMode"),10):a;this._setInternalRenderFaceMode(c),this._setInternalRenderLineMode(d);var u=localStorage.getItem("displayHiddenEdges")?parseInt(localStorage.getItem("displayHiddenEdges"),10):s;this.displayHiddenEdges(u)}var p=localStorage.getItem("axisState");p&&(this.setAxisFilter("true"===p),this.getAxisFilter()&&(i.push("VisuFilterAxis"),i.push("VisuFilterAxisEnableCmd")));var f=localStorage.getItem("linesState");f&&(this.setLinesFilter("true"===f),this.getLinesFilter()&&(i.push("VisuFilterLines"),i.push("VisuFilterLinesEnableCmd")));var g=localStorage.getItem("pointsState");return g&&(this.setPointsFilter("true"===g),this.getPointsFilter()&&(i.push("VisuFilterPoints"),i.push("VisuFilterPointsEnableCmd"))),this.applyRenderModeLock(),i},restoreProjectionMode:function(){var e=[];return this.currentViewpoint&&localStorage.getItem("projectionMode")&&!this._2DMode&&(this.currentViewpoint.setProjectionType(parseInt(localStorage.getItem("projectionMode"),10)),1===this.currentViewpoint.getProjectionType()?(e.push("VisuOrthographicViewCmd"),e.push("VisuOrthographicView")):(e.push("VisuPerspectiveViewCmd"),e.push("VisuPerspectiveView"))),e},restoreAmbiance:function(){var e=[],t=localStorage.getItem("visuEnv");return t?t.includes("OCA")?(e.push("Visu"+t+"Cmd"),t=t.replace("OCA",""),this.setVisuEnvOCA(t)):(e.push("Visu"+t+"Env"),e.push("Visu"+t+"EnvCmd"),this.setVisuEnv(t)):this.setV6Ambience(),e},getWidgetID:function(){var e=window.widget;return void 0!==e?e.getValue("x3DAppId"):"no-app"},setRobotAndRefAxisSystemEnabled:function(e){this.internalSceneGraph.setRobotAndRefAxisSystemEnabled(e)},getRobotAndRefAxisSystemEnabled:function(){var e=this.getRobot();return e&&e._isEnabled()},setRenderPriority:function(e){return this.renderer.resetGSSOCache(),e&&this.getSectionCapping()?(console.warn("Render priority mode is not compatible with section capping"),!1):(e&&this.setOIT(!1),this._renderPriorityManager||(this._renderPriorityManager=new L(this)),this._renderPriorityManager.setEnabled(e),!0)},getRenderPriority:function(){return!(!this._renderPriorityManager||!this._renderPriorityManager.enabled)},setRenderPriorityDefaultOpacity:function(e){this.getRenderer().renderPriorityDefaultOpacity=e},forceSceneMin:function(e){this._forceSceneMin(e),this.render({updateInfinitePlane:!0})},_getDivClientWidth:function(){return(this._pageObjectData?this.canvas.width:this.div.clientWidth)||1},_getDivClientHeight:function(){return(this._pageObjectData?this.canvas.height:this.div.clientHeight)||1},_getCanvasOffsetWidth:function(){return this._pageObjectData?this.canvas.width:this.canvas.offsetWidth},_getCanvasOffsetHeight:function(){return this._pageObjectData?this.canvas.height:this.canvas.offsetHeight},_getForceRenderTargetSize:function(){return this._pageObjectData&&this._pageObjectData.forceRenderTargetSize},_forceSceneMin:function(e){this._forceSceneMinValue=e},_addClippingPlane:function(e){},_removeClippingPlane:function(e){},_addManipulator:function(e,t){this._manipulators[t]=e},_removeManipulator:function(e){delete this._manipulators[e]},_filterClippedIntersections:function(e){var t,i,r=[],n=this.getRenderer();n.clipPlanesEnabled&&(t=new R(n.clipPlanes));var a,s=0;for(s=0;s<e.length;s++)(i=(a=e[s]).object&&(t||a.object._occurrence.clippingContext))&&a.point&&!i.isPointVisible(a.point)||r.push(a);return r},setIdPathMatcher:function(e){this.idPathMatcher=e},setImmersiveFrame:function(e){this._immFrame=e},getFreeZone:function(){var e=this._pageObjectData?this._pageObjectData.getFreeZone():null;return e||this._immFrame&&this._immFrame.getFreeZone()},getIdPathMatcher:function(){return this.idPathMatcher},_deprecated_useBackfaceCullingWithNoCapping:function(e){this.renderer.renderer.useBackfaceCullingWithNoCapping=e},useCustomCappingForClipPolyline:function(e){this.renderer.renderer.useCustomCappingForClipPolyline=!!e},_setPageObjectData:function(e){this._pageObjectData=e},_dbgQuickHighlight:function(e){if(e){var t=new s([e]);y.add({pathElement:t})}else y.empty()},_getScenegraphs:function(){let e=this._viewpointManager.getAuxiliaryScenegraphs();return this._safeInternalSceneGraph&&e.push(this._safeInternalSceneGraph),e},_requestClippingUpdate:function(){let e=this._getScenegraphs();for(let t=0;t<e.length;t++)e[t]._needClippingUpdate=!0},_getUserPassManager:function(){return this._userPassManager},_setOOCManager:function(e){this._oocManager=e},_getOOCManager:function(){return this._oocManager},_setInternalRenderFaceMode:function(e){this.renderer.renderer.renderFaceMode=e},_getInternalRenderFaceMode:function(){return this.renderer.renderer.renderFaceMode},_setInternalRenderLineMode:function(e){this.renderer.renderer.renderLineMode=e},_getInternalRenderLineMode:function(){return this.renderer.renderer.renderLineMode},_DEPRECATED_setRenderFooMode:function(e){console.warn("[WebGLViewer] Deprecated setRenderLineMode/setRenderFaceMode method.\nUse setRenderMode() instead\n"+e.stack)},_remoteRenderInfos:{eventToken:null,div:null,cvs:null,img:null,tex:null,useDiv:!1},enableRemoteRender:function(e){this.renderer.setEffect("xRevealStructure",e)},setupRemoteRender:function(e){var t=this;if(this._remoteRenderInfos.eventToken&&(t.unsubscribe(t._remoteRenderInfos.eventToken),!e&&t._remoteRenderInfos.div&&t._remoteRenderInfos.div.destroy()),e||t.renderer.setEffect("xRevealStructure",!1),e){if(t._remoteRenderInfos.useDiv&&!t._remoteRenderInfos.div){t._remoteRenderInfos.div=UWA.createElement("div"),t._remoteRenderInfos.div.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"});let e=UWA.createElement("img"),i=UWA.createElement("canvas");i.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),t.div.insertBefore(t._remoteRenderInfos.div,t.div.firstChild),t._remoteRenderInfos.div.append(e),t._remoteRenderInfos.div.append(i),t._remoteRenderInfos.img=e,t._remoteRenderInfos.cvs=i}if(t._remoteRenderInfos.useDiv||this.getEffect("xRevealStructure")||this.renderer.initEffect("xRevealStructure"),t.renderer.setEffect("xRevealStructure",!0),"function"==typeof e){t._remoteRenderInfos.eventToken=t.onPreRender(function(){var i=e(t.currentViewpoint,[t.SCREEN_WIDTH,t.SCREEN_HEIGHT]);i&&i.then(t._onRemoteImageReceived).catch(()=>{})})}}},setRemoteVideo:function(e){let i=new t.ImageUtils.loadVideoTexture(e);viewer.getEffect("xRevealStructure").updateTexture(i)},_onRemoteImageReceived:function(e){let i=this;if(e.data)if(i._remoteRenderInfos.useDiv){if("blob"==e.format||"arrayBuffer"==e.format||"url"==e.format)URL.revokeObjectURL(i._remoteRenderInfos.img.src),"blob"==e.format?i._remoteRenderInfos.img.src=URL.createObjectURL(e.data):"arrayBuffer"==e.format?i._remoteRenderInfos.img.src=URL.createObjectURL(new Blob([e.data])):"url"==e.format&&(i._remoteRenderInfos.img.src=e.data),i._remoteRenderInfos.img.width=i.SCREEN_WIDTH,i._remoteRenderInfos.img.height=i.SCREEN_HEIGHT,i._remoteRenderInfos.cvs.width=0,i._remoteRenderInfos.cvs.height=0;else if("uint8Array"==e.format){i._remoteRenderInfos.img.width=0,i._remoteRenderInfos.img.height=0,i._remoteRenderInfos.cvs.width=e.width,i._remoteRenderInfos.cvs.height=e.height;var r=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height);i._remoteRenderInfos.cvs.getContext("2d").putImageData(r,0,0)}}else{var n=null,a=!0;"uint8Array"==e.format?((n=new t.DataTexture(e.data,e.width,e.height,t.RGBAFormat,t.UnsignedByteType)).flipY=!1,n.needsUpdate=!0,a=!1):"blob"==e.format?n=new t.ImageUtils.loadTexture(URL.createObjectURL(e.data)):"arrayBuffer"==e.format?n=new t.ImageUtils.loadTexture(URL.createObjectURL(new Blob([e.data]))):"url"==e.format&&(n=new t.ImageUtils.loadTexture(e.data)),a?n.onLoadCallbacks.push(function(e){i._remoteRenderInfos.tex&&i._remoteRenderInfos.tex.dispose(),i._remoteRenderInfos.tex=e,i.getEffect("xRevealStructure").updateTexture(e)}):(i._remoteRenderInfos.tex&&i._remoteRenderInfos.tex.dispose(),i._remoteRenderInfos.tex=n,i.getEffect("xRevealStructure").updateTexture(n))}}});return Object.defineProperty(ae.prototype,"backgroundColor",{get:function(){return this.__tempBackgroundColorODT}}),Object.defineProperty(ae.prototype,"sceneGraph",{get:function(){return n.DEPRECATED_SceneGraph(new Error,!0),this.getRootNode()}}),UWA.namespace("THREEDS/WebGLViewer",ae)}),define("DS/Visualization/CGRReader",["DS/VisuLoaders/CGRReader"],function(e){"use strict";return e}),define("Visualization/CGRReader",["DS/Visualization/CGRReader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/CGRReader"),e}),define("DS/Visualization/WidelinesHelper",["DS/Mesh/ThreeJS_Base","DS/Mesh/Mesh"],function(e,t){"use strict";return{_computeLineDistances:function(t,i){t.cpuPatternMode=!1;for(var r,n,a=0,s=[],o=t.vertexIndexArray,l=i&&i.length===o.length,h=new e.Vector3,c=new e.Vector3,d=0;d<t.drawingGroups.length;d++)for(var u=t.drawingGroups[d],p=u.start,f=u.count,g=0;g<f;g++){a=0;var m=g+p,v=0;if(l&&(v=i[m]),g>0){if((r=o[m])===(n=o[m-1]))continue;t.getVertexPosition(r,h),t.getVertexPosition(n,c),a=h.distanceTo(c),Math.abs(a)>1e-6&&!(g%2)?(s[2*r]=v,s[2*r+1]=v):(s[2*r]=v+a+s[2*n],s[2*r+1]=v+a+s[2*n])}else{var y=o[m];s[2*y]=v,s[2*y+1]=v}}t.needsUpdate=!0,t.vertexLineDistancesArray=new Float32Array(s)},_computeWideLineDistances:function(e){this._computeLineDistances(e.wideLinesLinker.parentGeometry,[]),e.cpuPatternMode=!1;for(var t=[],i=e.wideLinesLinker.parentGeometry.vertexLineDistancesArray,r=e.wideLinesLinker.lineStructureMap,n=0;n<e.drawingGroups.length;n++)for(var a=e.drawingGroups[n],s=r.get(a),o=s.sides,l=s.primitives,h=0,c=0;c<l.length;c++)for(var d=l[c],u=0;u<d.length;u++)for(var p=d[u],f=!p.endLine&&!p.begLine||p.isLoopedWith||p.fusedWith?4:2,g=0;g<f;g++){var m=i[2*p.cur];if(o[h]%2==0)if(t.push(m),p.isLoopedWith)t.push(m);else if(p.fusedWith){var v=l[p.fusedWith.primIndex][0];v=i[2*v.cur],Math.abs(v-m)<1e-6?t.push(i[2*p.next]):t.push(m)}else t.push(i[2*p.next]);else t.push(i[2*p.prev]),t.push(m);h++}e.needsUpdate=!0,e.vertexLineDistancesArray=new Float32Array(t)},_computePixelLineDistances:function(t,i,r,n,a){if(!(t.cpuPatternFrame>=a)){t.cpuPatternMode=!0,t.cpuPatternFrame=a;var s=0,o=[],l=new e.Matrix4;l.multiplyMatrices(r,i);for(var h,c,d=t.vertexIndexArray,u=new e.Vector4,p=new e.Vector4,f=new e.Vector2,g=new e.Vector2,m=0;m<t.drawingGroups.length;m++)for(var v=t.drawingGroups[m],y=v.start,S=0,_=v.count;S<_;S++){s=0;var x=S+y;if(S>0){if((h=d[x])===(c=d[x-1]))continue;t.getVertexPosition(h,u),t.getVertexPosition(c,p),u.w=1,u.applyMatrix4(l),p.w=1,p.applyMatrix4(l),f.x=.5*(u.x/u.w+1)*n.width,f.y=.5*(u.y/u.w+1)*n.height,g.x=.5*(p.x/p.w+1)*n.width,g.y=.5*(p.y/p.w+1)*n.height,s=f.distanceTo(g),Math.abs(s)>1e-6&&!(S%2)?(o[2*h]=0,o[2*h+1]=0):(o[2*h]=s+o[2*c],o[2*h+1]=s+o[2*c])}else{var b=d[x];o[2*b]=0,o[2*b+1]=0}}t.needsUpdate=!0,t.vertexLineDistancesArray=new Float32Array(o)}},_computePixelWideLineDistances:function(e,t,i,r,n){if(!(e.cpuPatternFrame>=n)){e.cpuPatternMode=!0,e.cpuPatternFrame=n,this._computePixelLineDistances(e.wideLinesLinker.parentGeometry,t,i,r,n);for(var a=[],s=e.wideLinesLinker.parentGeometry.vertexLineDistancesArray,o=e.wideLinesLinker.lineStructureMap,l=0;l<e.drawingGroups.length;l++)for(var h=e.drawingGroups[l],c=o.get(h),d=c.sides,u=c.primitives,p=0,f=0;f<u.length;f++)for(var g=u[f],m=0;m<g.length;m++)for(var v=g[m],y=!v.endLine&&!v.begLine||v.isLoopedWith||v.fusedWith?4:2,S=0;S<y;S++){var _=s[2*v.cur];if(d[p]%2==0)if(a.push(_),v.isLoopedWith)a.push(_);else if(v.fusedWith){var x=u[v.fusedWith.primIndex][0];x=s[2*x.cur],Math.abs(x-_)<1e-6?a.push(s[2*v.next]):a.push(_)}else a.push(s[2*v.next]);else a.push(s[2*v.prev]),a.push(_);p++}e.needsUpdate=!0,e.vertexLineDistancesArray=new Float32Array(a)}},_computeWideLineDG:function(i,r,n,a,s){var o=i.wideLinesLinker,l=o.originalDGToWideDG.get(n);if(l)return l;if(!i.vertexIndexArray)return null;l=new t.DrawingGroup,n instanceof t.DrawingGroup?l=n.clone():(l.gas=n.gas,l.gasIndex=n.gasIndex,l._geomType=n._geomType,l.layers=n.layers,l.material=n.material,l.copyPrimitives(n.primitives),l.count=n.count),l.geometry=r,l.glType=4,o.originalDGToWideDG.set(n,l);var h=new e.Vector3,c=new e.Vector3,d=function(e,t){return i.getVertexPosition(e,h),i.getVertexPosition(t,c),Math.abs(h.x-c.x)<1e-6&&Math.abs(h.y-c.y)<1e-6&&Math.abs(h.z-c.z)<1e-6},u=function(){for(var e=[],r=0,a=new t.SGPrimitiveHelper,s=0;s<n.getPrimitivesCount();s++){a.set(n,s),e.push([]);for(var o=a.getStart();o<a.getStart()+a.getCount();o++){var l=(o-a.getStart())%2,h={cur:r=i.vertexIndexArray[o],prev:l?i.vertexIndexArray[o-1]:r,next:l?r:i.vertexIndexArray[o+1],begLine:!1,endLine:!1,fusedBack:!1,fusedWith:null};e[s].push(h)}}return e}(),p=function(e,t){for(var i=0;i<e.length;i++){var r=e[i];if(!(r.length<1))for(var n=0;n<r.length;n++){t(r[n],r,n)}}};p(u=function(e){for(var t=[],i=0;i<e.length;i++)if(t.push([]),!((w=e[i]).length<1))for(var r=0;r<w.length;r++){var n=w[r];if(n.cur!==n.next)t[i].push(n);else if(r<w.length-1){var a=r+1,s=w[a];if(n.cur===s.cur){for(var o=r+2;o<w.length&&n.cur===w[o].cur;o++)a=o;s=w[a];var l={cur:n.cur,next:s.next,prev:n.prev,begLine:!1,endLine:!1,fusedBack:!1,fusedWith:null};r=a,t[i].push(l)}else t[i].push(n)}else t[i].push(n)}return t}(u),function(e){e.next===e.cur?e.endLine=!0:e.prev===e.cur&&(e.begLine=!0)});p(u,function(e,t,i){if(e.endLine&&i<t.length-1){var r=t[i+1];r.begLine&&d(e.cur,r.cur)&&(e.endLine=!1,r.begLine=!1)}});p(u,function(e,t,i){if(d(e.cur,e.next)&&!e.endLine&&!e.begLine)for(var r=i+1;r<t.length;r++){var n=t[r];if(!d(e.cur,n.cur))break;if(n.prev=e.prev,n.endLine)break;d(n.next,n.cur)?n.colorIndex||(n.colorIndex=e.cur):(e.next=n.next,e.endSkip=!0,n.baseSkip=!0)}});!function(e){if(!(e.length<2)){for(var t=[],r=0;r<e.length;r++)if(!((u=e[r]).length<1)){var n=u[u.length-1],a=u[0];d(n.cur,n.next)&&(i.getVertexPosition(n.cur,h),t.push([h.x,h.y,h.z,r,1])),d(a.prev,a.cur)&&(i.getVertexPosition(a.cur,h),t.push([h.x,h.y,h.z,r,0]))}t.sort(function(e,t){var i=e[0]-t[0];if(Math.abs(i)<1e-6){var r=e[1]-t[1];if(Math.abs(r)<1e-6){var n=e[2]-t[2];if(Math.abs(n)<1e-6){var a=e[3]-t[3];return 0===a?0:a>0?1:-1}return n>0?1:-1}return r>0?1:-1}return i>0?1:-1});for(var s=0;s<t.length;s++){var o=t[s];if(0!==o[4])for(var l=s+1;l<t.length;l++){var c=t[l];if(1!==c[4]&&c[3]!==o[3]){if(Math.abs(o[0]-c[0])<1e-6&&Math.abs(o[1]-c[1])<1e-6&&Math.abs(o[2]-c[2])<1e-6){n=(u=e[o[3]])[u.length-1];var u,p=e[c[3]][0];if(!p.fusedBack){n.next=p.next,p.prev=n.prev,n.fusedWith={primIndex:c[3]},p.fusedBack=!0;break}}break}}}}}(u);p(u,function(e,t,i){var r=t.length;if(e.begLine)for(var n=i+1;n<r;n++){var a=t[n];if(a.endLine){n-i>1&&d(a.cur,e.cur)&&(a.isLoopedWith=!0,e.prev=a.prev,a.next=e.next);break}}});for(var f=[],g=[],m=[],v=[],y=0,S=new e.Vector3,_=new e.Vector3,x=new e.Vector3,b=0;b<u.length;b++)for(var w=u[b],M=0;M<w.length;M++){var C=!(L=w[M]).endLine&&!L.begLine||L.isLoopedWith||L.fusedWith?4:2;L.indRef=y,L.inds=[];for(var P=0;P<C;P++)L.inds.push(y),v[y]=P%2==0?1:-1,4===C?v[y]*=P<2?1:2:L.begLine&&(v[y]*=2),i.getVertexPosition(L.cur,S),i.getVertexPosition(L.prev,_),i.getVertexPosition(L.next,x),f[3*y]=S.x,f[3*y+1]=S.y,f[3*y+2]=S.z,g[3*y]=_.x,g[3*y+1]=_.y,g[3*y+2]=_.z,m[3*y]=x.x,m[3*y+1]=x.y,m[3*y+2]=x.z,y++}o.lineStructureMap.set(l,{sides:v.slice(0),primitives:u.slice(0)});var E=null;if(i.vertexColorArray){var A=new e.Vector4;E=[];for(y=0,b=0;b<u.length;b++)for(w=u[b],M=0;M<w.length;M++)for(C=!(L=w[M]).endLine&&!L.begLine||L.isLoopedWith||L.fusedWith?4:2,P=0;P<C;P++){var T=L.colorIndex>=0?L.colorIndex:L.cur;i.getVertexColor(T,A),E[4*y]=A.x,E[4*y+1]=A.y,E[4*y+2]=A.z,E[4*y+3]=A.w,y++}}var D=null;const I=i.vertexPatternStartEndArray;if(I){D=[];for(y=0,b=0;b<u.length;b++)for(w=u[b],M=0;M<w.length;M++)for(C=!(L=w[M]).endLine&&!L.begLine||L.isLoopedWith||L.fusedWith?4:2,P=0;P<C;P++){T=L.cur;for(var R=0;R<2;R++)D[2*y+R]=I[2*T+R];y++}}var O=null;if(!i.vertexLineDistancesArray&&a.isDashedLine&&this._computeLineDistances(i,[]),!i.vertexLineDistancesArray&&a.politeMaterial&&this._computeLineDistances(i,[]),i.vertexLineDistancesArray&&s&&this._computeLineDistances(i,[]),i.vertexLineDistancesArray){const e=i.vertexLineDistancesArray;O=[];for(y=0,b=0;b<u.length;b++)for(w=u[b],M=0;M<w.length;M++){var L;for(C=!(L=w[M]).endLine&&!L.begLine||L.isLoopedWith||L.fusedWith?4:2,P=0;P<C;P++){var V=e[2*L.cur];if(v[y]%2==0)if(O.push(V),L.isLoopedWith)O.push(V);else if(L.fusedWith){var F=u[L.fusedWith.primIndex][0];F=e[2*F.cur],Math.abs(F-V)<1e-6?O.push(e[2*L.next]):O.push(V)}else O.push(e[2*L.next]);else O.push(e[2*L.prev]),O.push(V);y++}}}var B=[],N=0;for(b=0;b<u.length;b++){if(!((w=u[b]).length<1)){l._setPrimitiveCount(0,b);M=0;for(M=0;M<w.length;M++){var G=w[M],k=G.inds;if(G.endLine||G.begLine){if(G.endLine){G.isLoopedWith&&(B.push(k[0]),B.push(k[1]),B.push(k[2]),B.push(k[3]),B.push(k[2]),B.push(k[1]),l._setPrimitiveCount(l.getPrimitiveCount(b)+6,b));continue}var U=w[M+1].inds;B.push(k[0]),B.push(k[1]),B.push(U[0]),B.push(U[1]),B.push(U[0]),B.push(k[1]),l._setPrimitiveCount(l.getPrimitiveCount(b)+6,b)}else if(G.baseSkip||(B.push(k[0]),B.push(k[1]),B.push(k[2]),B.push(k[3]),B.push(k[2]),B.push(k[1]),l._setPrimitiveCount(l.getPrimitiveCount(b)+6,b)),!G.endSkip){U=w[M+1].inds;B.push(k[2]),B.push(k[3]),B.push(U[0]),B.push(U[1]),B.push(U[0]),B.push(k[3]),l._setPrimitiveCount(l.getPrimitiveCount(b)+6,b)}}if(w[w.length-1].fusedWith){var z=w[M-1].inds;B.push(z[0]),B.push(z[1]),B.push(z[2]),B.push(z[3]),B.push(z[2]),B.push(z[1]),l._setPrimitiveCount(l.getPrimitiveCount(b)+6,b)}l._setPrimitiveStart(N,b),N+=l.getPrimitiveCount(b)}}var H={count:B.length,start:0},W=0;return r.vertexPositionArray&&(W=r.vertexPositionArray.length/3,f=Array.prototype.slice.call(r.vertexPositionArray).concat(f)),r.vertexPreviousPositionArray&&(g=Array.prototype.slice.call(r.vertexPreviousPositionArray).concat(g)),r.vertexNextPositionArray&&(m=Array.prototype.slice.call(r.vertexNextPositionArray).concat(m)),r.vertexSideExtrusionArray&&(v=Array.prototype.slice.call(r.vertexSideExtrusionArray).concat(v)),r.vertexColorArray&&(E=Array.prototype.slice.call(r.vertexColorArray).concat(E)),r.vertexPatternStartEndArray&&(D=Array.prototype.slice.call(r.vertexPatternStartEndArray).concat(D)),r.vertexLineDistancesArray?(W-r.vertexLineDistancesArray.length/2>0&&this._computeWideLineDistances(r),O=Array.prototype.slice.call(r.vertexLineDistancesArray).concat(O)):null!==O&&O.length>0&&W>0&&(this._computeWideLineDistances(r),O=Array.prototype.slice.call(r.vertexLineDistancesArray).concat(O)),r.vertexIndexArray&&(H.start=r.vertexIndexArray.length,B.forEach(function(e,t,i){i[t]+=W}),B=Array.prototype.slice.call(r.vertexIndexArray).concat(B)),r.needsUpdate=!0,r.vertexPositionArray=f,r.vertexPreviousPositionArray=g,r.vertexNextPositionArray=m,r.vertexSideExtrusionArray=v,E&&(r.vertexColorArray=E),O&&(r.vertexLineDistancesArray=O),D&&(r.vertexPatternStartEndArray=D),r.vertexIndexArray=B,l.start=H.start,l.count=H.count,r.drawingGroups.push(l),l}}});for(var _materialsBase="DS/Materials/",_toLoad=["DeferrableMaterial","DeferredCaches","LineBasicMaterial","LineDSMaterial","Material","MeshBasicMaterial","MeshLambertMaterial","MeshPhongMaterial","ParticleBasicMaterial","PhysicalMaterial","CATGraphicalMaterial","ShaderMaterial","ShaderMaterialDS","DSPBR19x","DSPBR21x","DSPBR22x","DSPBR23x","GASPBR","OutlineMaterial","SectionBuilderMaterial","OldInfraMaterial","CubeMapMaterial","FiniteEnvMapMaterial","FiniteTransitionEnvMapMaterial","GradientBackgroundMaterials","LatLongMapMaterial","SimpleMapMaterial","GridMaterial","SmallPlaneMaterial","PlaneMaterial","ShaderDynamicPrefixBuilder"],i=0;i<_toLoad.length;i++)_toLoad[i]=_materialsBase+_toLoad[i];_toLoad.push("DS/Mesh/ThreeJS_Base"),define("DS/Visualization/Materials",_toLoad,function(e,t,i,r,n,a,s,o,l,h,c,d,u,p,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A,T,D,I){"use strict";return{cleanPredefinedMaterialTextureCache:function(){for(var e=t._loadPredefinedMaterialTextures(!0,function(){},!0),i=0;i<e.length;i++)e[i].loadEndStatus===I.AssetLoadingStatus.READY&&e[i].dispose()},cleanPredefinedMaterialCache:function(){for(var e=[t.PredefinedMaterials],i=0;i<e.length;i++)e[i].forEach(function(e,t,i){var r,n;if(e.material.dispose)e.material.dispose();else for(r in e.material)(n=e.material[r])&&n.dispose&&n.dispose();i.delete(t)})},cleanDeferredCache:function(e){for(var i=[t.DefaultNormalDepthMaterials,t.DefaultShadowDepthMaterials,t.DefaultPickingMaterials,t.DefaultHighlightMaterials,t.DefaultMaterials,t.GeomTypeMaterials,t.PredefinedMaterials],r=0;r<i.length;r++)i[r].forEach(function(t,i,r){if(t.usedBy.delete(e),t.usedBy.size<1){var n,a;if(t.material.dispose)t.material.dispose();else for(n in t.material)(a=t.material[n])&&a.dispose&&a.dispose();r.delete(i)}})},DeferrableMaterial:e,LineBasicMaterial:i,LineDSMaterial:r,Material:n,MeshBasicMaterial:a,MeshLambertMaterial:s,MeshPhongMaterial:o,ParticleBasicMaterial:l,PhysicalMaterial:h,_CATGraphicalMaterial:c,ShaderMaterial:d,ShaderMaterialDS:u,DSPBR19xMaterial:p,DSPBR21xMaterial:f,DSPBR22xMaterial:g,DSPBR23xMaterial:m,_GASPBRMaterial:v,_OutlineMaterial:y._OutlineMaterial,_WideOutlineMaterial:y._WideOutlineMaterial,_SectionMaterial:S._SectionMaterial,_WideSectionMaterial:S._WideSectionMaterial,_OldInfraMaterial:_,CubeMapMaterial:x,FiniteEnvMapMaterial:b,FiniteTransitionEnvMapMaterial:w,GradientBackgroundMaterial2:M.GradientBackgroundMaterial2,GradientBackgroundMaterial3:M.GradientBackgroundMaterial3,GradientBackgroundMaterial4:M.GradientBackgroundMaterial4,LatLongMapMaterial:C,SimpleMapMaterial:P,GridMaterial:E,SmallPlaneMaterial:A,PlaneMaterial:T,ShaderDynamicPrefixBuilder:D}}),define("DS/Visualization/OBJReader",["DS/VisuLoaders/OBJReader"],function(e){"use strict";return e}),define("Visualization/OBJReader",["DS/Visualization/OBJReader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/OBJReader"),e});var _shaderChunkBase="DS/Shaders/";for(_toLoad=["LineDSShaders","ScenegraphShaders","PDSFXShaders","PhongShaders","LambertShaders","ShadowingShaders","FogShaders","LowLightShaders","ClipShaders","MappingShaders","EnvMapShaders","AlphaShaders","ColorShaders","VerticeShaders"],i=0;i<_toLoad.length;i++)_toLoad[i]=_shaderChunkBase+_toLoad[i];define("DS/Visualization/ShaderChunk",_toLoad,function(e,t,i,r,n,a,s,o,l,h,c,d,u,p){"use strict";var f={Default_uniforms_declaration:["#ifdef GLSL300ES","uniform FrameUBO {","mat4 viewMatrix;","mat4 projectionMatrix;","vec3 cameraPosition;","};","#else","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform vec3 cameraPosition;","#endif","uniform mat4 _modelMatrixForDoubleGPU;","mat4 modelMatrix;","vec3 lowPartModelTranslation;","#if defined(MODELVIEW_CPU)","uniform mat4 modelViewMatrix;","#elif defined(USE_TANGENT_BINORMAL) && defined(MAPPING_OPERATOR)","varying mat4 modelViewMatrix;","#else","mat4 modelViewMatrix;","#endif",""].join("\n"),normalMatrix_uniforms_declaration:["#ifdef USE_NORMAL_MATRIX","bool use_normal_matrix = true;","uniform mat3 normalMatrix;","#else","bool use_normal_matrix = false;","mat3 normalMatrix;","#endif"].join("\n"),double_emulation_utilities:["// http://andrewthall.org/papers/df64_qf128.pdf","vec2 quickTwoSum(float a, float b) {","    float s = a + b;","    float e = b - (s-a);","    return vec2(s,e);","}","","vec4 twoSumComp(vec2 a, vec2 b) {","    vec2 s = a + b;","    vec2 v = s - a;","    vec2 e = (a - (s-v)) + (b-v);","    return vec4(s.x,e.x,s.y,e.y);","}","","vec2 df64_add(vec2 a, vec2 b) {","    vec4 st = twoSumComp(a,b);","    st.y += st.z;","    st.xy = quickTwoSum(st.x,st.y);","    st.y += st.w;","    return  quickTwoSum(st.x,st.y);","}","","vec3 _computeModelPosition(in vec3 position, in vec3 cameraPos, in vec3 lowPartCameraPos, in mat4 matrix, in vec3 lowPartTranslation) {","   vec2 Tmx = vec2(matrix[3][0],lowPartTranslation.x);","   vec2 Tmy = vec2(matrix[3][1],lowPartTranslation.y);","   vec2 Tmz = vec2(matrix[3][2],lowPartTranslation.z);","   vec2 Tcx = -vec2(cameraPos.x,lowPartCameraPos.x);","   vec2 Tcy = -vec2(cameraPos.y,lowPartCameraPos.y);","   vec2 Tcz = -vec2(cameraPos.z,lowPartCameraPos.z);","   vec2 Tx = df64_add(Tmx, Tcx);","   vec2 Ty = df64_add(Tmy, Tcy);","   vec2 Tz = df64_add(Tmz, Tcz);","   vec4 worldPos = matrix * vec4(position.xyz,0.0);","   return worldPos.xyz + vec3(Tx.x, Ty.x, Tz.x);","}","vec3 _computeModelViewPosition(in vec3 position, in vec3 cameraPos, in vec3 lowPartCameraPos, in mat4 matrix, in vec3 lowPartTranslation, in mat4 viewMatrix) {","   return (viewMatrix * vec4(_computeModelPosition(position, cameraPos, lowPartCameraPos, matrix, lowPartTranslation), 0.0)).xyz;","}"].join("\n"),double_emulation_vertex:["uniform vec3 lowPartCameraPosition;","vec4 computeModelViewPosition(in vec4 position) {","#if defined(MODELVIEW_CPU)","return modelViewMatrix * position;","#else","return vec4(_computeModelViewPosition(position.xyz,cameraPosition,lowPartCameraPosition, modelMatrix, lowPartModelTranslation, viewMatrix),1.0);","#endif","}","vec4 computeModelViewPosition(in vec3 position) {","return computeModelViewPosition(vec4(position, 1.0));","}","vec4 computeModelViewDirection(in vec3 direction) {","return modelViewMatrix * vec4(direction, 0.0);","}","vec4 computeModelViewPositionCustom(in vec4 position, in mat4 matrix, in vec3 lowPartTranslation) {","   return vec4(_computeModelViewPosition(position.xyz,cameraPosition,lowPartCameraPosition, matrix, lowPartTranslation, viewMatrix),1.0);","}","vec4 computeModelViewPositionCustom(in vec3 position, in mat4 matrix, in vec3 lowPartTranslation) {","   return vec4(_computeModelViewPosition(position.xyz,cameraPosition,lowPartCameraPosition, matrix, lowPartTranslation, viewMatrix),1.0);","}","vec4 computeModelViewDirectionCustom(in vec3 direction, in mat4 matrix) {","return viewMatrix * (matrix * vec4(direction, 0.0));","}","#if defined(USE_SHADOWMAP) && !defined(DECAL)","vec4 computeShadowCoord(in vec3 position,in mat4 shadowMat,in vec3 shadowCameraPos, in vec3 lowPartShadowCameraPos) {","   vec4 worldPos = vec4(_computeModelPosition(position,shadowCameraPos,lowPartShadowCameraPos, modelMatrix, lowPartModelTranslation),1.0);","   return shadowMat * worldPos;","}","#endif"].join("\n"),double_emulation_fragment:["#if defined(USE_SHADOWMAP) && defined(DECAL)","vec4 computeShadowCoord(in vec3 position,in mat4 shadowMat,in vec3 shadowCameraPos, in vec3 lowPartShadowCameraPos) {","   vec4 worldPos = vec4(_computeModelPosition(position,shadowCameraPos,lowPartShadowCameraPos, modelMatrix, lowPartModelTranslation),1.0);","   return shadowMat * worldPos;","}","#endif"].join("\n"),bumpmap_pars_fragment:["#if defined(USE_BUMPMAP) && !defined(DSPBR)","uniform sampler2D bumpMap;","uniform float bumpScale;","#ifndef SPECGLOSS","vec2 dHdxy_fwd() {","vec2 dSTdx = dFdx( vUv );","vec2 dSTdy = dFdy( vUv );","float Hll = bumpScale * texture2D( bumpMap, vUv ).x;","float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;","float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;","return vec2( dBx, dBy );","}","#endif","vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {","vec3 vSigmaX = dFdx( surf_pos );","vec3 vSigmaY = dFdy( surf_pos );","vec3 vN = surf_norm;","vec3 R1 = cross( vSigmaY, vN );","vec3 R2 = cross( vN, vSigmaX );","float fDet = dot( vSigmaX, R1 );","vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );","return normalize( abs( fDet ) * surf_norm - vGrad );","}","#endif"].join("\n"),normalmap_pars_fragment:["#ifdef USE_NORMALMAP","uniform sampler2D normalMap;","#ifndef DSPBR","uniform vec2 normalScale;","#ifndef SPECGLOSS","vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {","vec3 q0 = dFdx( eye_pos.xyz );","vec3 q1 = dFdy( eye_pos.xyz );","vec2 st0 = dFdx( uvToUse.st );","vec2 st1 = dFdy( uvToUse.st );","float alphaT = step(0.00001, abs(st0.y) + abs(st1.y));","float alphaB = step(0.00001, abs(st0.x) + abs(st1.x));","float alphaBT = 1.0 - max(alphaB, alphaT);","st0.y = alphaT * st0.y - (1.0 - alphaT)*(alphaB * st1.x);","st1.y = alphaT * st1.y + (1.0 - alphaT)*(alphaB * st0.x) + alphaBT;","st0.x = alphaB * st0.x - (1.0 - alphaB)*(alphaT * st1.y) + alphaBT;","st1.x = alphaB * st1.x + (1.0 - alphaB)*(alphaT * st0.y);","vec3 S = normalize(  q0 * st1.t - q1 * st0.t );","vec3 T = normalize( -q0 * st1.s + q1 * st0.s );","vec3 N = normalize( surf_norm );","vec3 mapN = texture2D( normalMap, uvToUse ).xyz * 2.0 - 1.0;","mapN.xy = normalScale * mapN.xy;","#ifdef NORMALFLIPY","mapN.y = - mapN.y;","#endif","mat3 tsn = mat3( S, T, N );","return normalize( tsn * mapN );","}","#endif","#endif","#endif"].join("\n"),specularmap_pars_fragment:["#ifdef USE_SPECULARMAP","uniform sampler2D specularMap;","#endif"].join("\n"),specularmap_fragment:["float specularStrength;","#ifdef USE_SPECULARMAP","vec2 specularUV=uvToUse;","vec4 texelSpecular = texture2D( specularMap, specularUV );","specularStrength = texelSpecular.r;","#ifdef PHONG","if (shininessInSpecMap) {","shininessValue = texelSpecular.a;","}","#endif","#else","specularStrength = 1.0;","#endif"].join("\n"),large_scale_VS:["","modelMatrix = mat4(_modelMatrixForDoubleGPU);","lowPartModelTranslation = vec3(modelMatrix[0][3],modelMatrix[1][3],modelMatrix[2][3]);","modelMatrix[0][3] = 0.0;","modelMatrix[1][3] = 0.0;","modelMatrix[2][3] = 0.0;","#if !defined(MODELVIEW_CPU)","modelViewMatrix = viewMatrix*modelMatrix;","#endif",""].join("\n"),large_scale_FS:["","modelMatrix = mat4(_modelMatrixForDoubleGPU);","lowPartModelTranslation = vec3(modelMatrix[0][3],modelMatrix[1][3],modelMatrix[2][3]);","modelMatrix[0][3] = 0.0;","modelMatrix[1][3] = 0.0;","modelMatrix[2][3] = 0.0;",""].join("\n"),rgba_packing_pars:["float unpackRGBA( const in vec4 rgba ) {","const vec4 bit_shift = vec4( 1.0 / ( 255.0 * 255.0 * 255.0 ), 1.0 / ( 255.0 * 255.0 ), 1.0 / 255.0, 1.0 );","#ifdef MOBILE_DEVICE_MODE","float unpack = dot( floor(255.0 * rgba + 0.5) / 255.0, bit_shift );","#else","float unpack = dot( rgba, bit_shift );","#endif","return unpack;","}","float unpackRGB( const in vec3 rgb ) {","const vec3 bit_shift = vec3(1.0 / ( 255.0 * 255.0 ), 1.0 / 255.0, 1.0 );","#ifdef MOBILE_DEVICE_MODE","float unpack = dot( floor(255.0 * rgb + 0.5) / 255.0, bit_shift );","#else","float unpack = dot( rgb, bit_shift );","#endif","return unpack;","}","vec4 packRGBA( const in float value ) {","const vec4 bit_shift = vec4( 255.0 * 255.0 * 255.0, 255.0 * 255.0, 255.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0 );","vec4 res = value * bit_shift;","res -= floor(res);","res -= res.xxyz * bit_mask;","return res;","}","vec3 packRGB( const in float value ) {","const vec3 bit_shift = vec3(255.0 * 255.0, 255.0, 1.0 );","const vec3 bit_mask  = vec3( 0.0, 1.0 / 255.0, 1.0 / 255.0 );","vec3 res = value * bit_shift;","res -= floor(res);","res -= res.xxy * bit_mask;","return res;","}"].join("\n")};return Object.assign(f,e.LineShaders),Object.assign(f,t),Object.assign(f,i),Object.assign(f,r),Object.assign(f,n),Object.assign(f,a),Object.assign(f,s),Object.assign(f,o),Object.assign(f,l),Object.assign(f,h),Object.assign(f,c),Object.assign(f,d),Object.assign(f,u),Object.assign(f,p),f}),define("DS/Visualization/IdPathWatcher",["DS/CoreEvents/Events"],function(e){"use strict";var t=function(t){this.viewer=t.viewer,this.onIdPathActiveCB=t.onIdPathActiveCB,this.onIdPathInactiveCB=t.onIdPathInactiveCB,this.idPathes=new Map,this.macroNodes=new Map,this.token=e.subscribe({event:"/VISU/onSceneGraphUpdate"},this.onSceneGraphUpdate.bind(this))};t.prototype.addIdPath=function(e,t){var r=this.idPathes.get(t);r||(r=new i(t),this.idPathes.set(t,r),this.addIdPath_internal(e,r))},t.prototype.removeIdObject=function(e){var t=this.idPathes.get(e);if(t){var i,r,n=t.firstNode;if(n.single)(i=n.macroNode).removeSingleNode(n),i.isEmpty()&&this.macroNodes.delete(i.id),n.macroNode=null;else for(;null!==n;)(i=n.macroNode).removeNode(n),i.isEmpty()&&this.macroNodes.delete(i.id),n.macroNode=null,r=n.nextNode,n.nextNode=null,n=r;t.firstNode=null,this.idPathes.delete(e)}},t.prototype.addIdPath_internal=function(e,t){var i,r=e.ids,n=1===r.length;if(t.count+=r.length,0!==r.length){var s=this.viewer.getIdPathMatcher(),o=null,l=this.createNode(r[0],t,n),h=null,c=s.idToNode(r[0]);for(t.firstNode=l,i=0;i<r.length-1;i++)o=l,l=this.createNode(r[i+1],t),o.nextNode=l,a(h=c,c=s.idToNode(l.macroNode.id))&&(o.active=!0,t.count--);o=l,h=c,n?o.single=!0:t.count--,o.single&&h&&h._hasOccurrenceInViewer(this.viewer)&&(o.active=!0,t.count--),0===t.count&&this.onIdPathActiveCB(t.idObject)}},t.prototype.getMacroNode=function(e){var t=this.macroNodes.get(e);return t||(t=new r(e),this.macroNodes.set(e,t)),t},t.prototype.createNode=function(e,t,i){var r=this.getMacroNode(e);return i?r.createSingleNode(t):r.createNode(t)},t.prototype.onSceneGraphUpdate=function(e){"ADD"===e.eventType?this.onAddChild(e.fromNode,e.toNode):"REMOVE"===e.eventType&&this.onRemoveChild(e.fromNode,e.toNode)},t.prototype.onAddChild=function(e,t){var i=this.viewer.getIdPathMatcher(),r=i.nodeToId(e),n=i.nodeToId(t),a=this.macroNodes.get(r),s=this.macroNodes.get(n);s&&a&&a.onAddChild(s,this,e),a&&a.onAddSingle(this,e),s&&s.onAddSingle(this,t)},t.prototype.onRemoveChild=function(e,t){var i=this.viewer.getIdPathMatcher(),r=i.nodeToId(e),n=i.nodeToId(t),a=this.macroNodes.get(r),s=this.macroNodes.get(n);s&&a&&(a.onRemoveChild(s,this),s.onRemoveSingle(this))},t.prototype.getIdPathMatcher=function(){return this.viewer.getIdPathMatcher()},t.prototype.dispose=function(){this.token&&(e.unsubscribe(this.token),this.token=null)};var i=function(e){this.idObject=e,this.count=0,this.firstNode=null},r=function(e){this.id=e,this.firstChainedNode=null,this.firstChainedSingleNode=null};r.prototype.getNode3D=function(e){return e.getIdPathMatcher().idToNode(this.id)},r.prototype.createNode=function(e){var t=new n(this);return t.idPath=e,t.nextChainedNode=this.firstChainedNode,this.firstChainedNode=t,t},r.prototype.createSingleNode=function(e){var t=new n(this);return t.idPath=e,t.nextChainedNode=this.firstChainedSingleNode,this.firstChainedSingleNode=t,t},r.prototype.onAddChild=function(e,t,i){for(var r=this.firstChainedNode;r;)r.nextNode&&r.nextNode.macroNode===e&&r.activate(t),r=r.nextChainedNode},r.prototype.onAddSingle=function(e,t){for(var i=this.firstChainedSingleNode;i;)i.activate(e),i=i.nextChainedNode},r.prototype.onRemoveChild=function(e,t){for(var i=this.firstChainedNode;i;)i.nextNode&&i.nextNode.macroNode===e&&i.deactivate(t),i=i.nextChainedNode},r.prototype.onRemoveSingle=function(e){for(var t=this.firstChainedSingleNode,i=null;t;)t.single&&t.active&&(null===i&&(i=this.getNode3D(e)),null!=i&&0!==i.parents.length||t.deactivate(e)),t=t.nextChainedNode},r.prototype.removeNode=function(e){var t=this.firstChainedNode;if(t===e)this.firstChainedNode=e.nextChainedNode;else{for(;null!==t.nextChainedNode&&t.nextChainedNode!==e;)t=t.nextChainedNode;t.nextChainedNode===e&&(t.nextChainedNode=e.nextChainedNode)}},r.prototype.removeSingleNode=function(e){var t=this.firstChainedSingleNode;if(t===e)this.firstChainedSingleNode=e.nextChainedNode;else{for(;null!==t.nextChainedNode&&t.nextChainedNode!==e;)t=t.nextChainedNode;t.nextChainedNode===e&&(t.nextChainedNode=e.nextChainedNode)}},r.prototype.isEmpty=function(){return null===this.firstChainedNode&&null===this.firstChainedSingleNode};var n=function(e){this.macroNode=e,this.idPath=null,this.nextNode=null,this.active=!1,this.single=!1,this.nextChainedNode=null};function a(e,t){var i;if(e&&t)if(e.children.length<t.parents.length){for(i=0;i<e.children.length;i++)if(e.children[i]===t)return!0}else for(i=0;i<t.parents.length;i++)if(t.parents[i]===e)return!0;return!1}return n.prototype.activate=function(e){this.active||(this.active=!0,this.idPath.count--,0===this.idPath.count&&e.onIdPathActiveCB(this.idPath.idObject))},n.prototype.deactivate=function(e){var t=this.idPath.count;this.active&&(this.active=!1,this.idPath.count++,0===t&&e.onIdPathInactiveCB(this.idPath.idObject))},t}),define("DS/Visualization/ExplicitGeometries",["DS/Mesh/ThreeJS_Base","DS/Object3D/Object3D","DS/Object3D/Mesh"],function(e,t,i){"use strict";var r={LegacyGeometry:function(){e.EventDispatcher.call(this),this.id=e.GeometryIdCount++,this.name="",this._type=0,this.vertices=[],this.colors=[],this.normals=[],this.faces=[],this.faceUvs=[[]],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphColors=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.hasTangents=!1,this.dynamic=!0,this.verticesNeedUpdate=!1,this.elementsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.tangentsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.buffersNeedUpdate=!1}};return r.LegacyGeometry.prototype={constructor:r.LegacyGeometry,applyMatrix:function(t){for(var i=(new e.Matrix3).getInverse(t).transpose(),r=0,n=this.vertices.length;r<n;r++){this.vertices[r].applyMatrix4(t)}for(r=0,n=this.faces.length;r<n;r++){var a=this.faces[r];a.normal.applyMatrix3(i).normalize();for(var s=0,o=a.vertexNormals.length;s<o;s++)a.vertexNormals[s].applyMatrix3(i).normalize();a.centroid.applyMatrix4(t)}},computeCentroids:function(){var t,i,r;for(t=0,i=this.faces.length;t<i;t++)(r=this.faces[t]).centroid.set(0,0,0),r instanceof e.Face3?(r.centroid.add(this.vertices[r.a]),r.centroid.add(this.vertices[r.b]),r.centroid.add(this.vertices[r.c]),r.centroid.divideScalar(3)):r instanceof e.Face4&&(r.centroid.add(this.vertices[r.a]),r.centroid.add(this.vertices[r.b]),r.centroid.add(this.vertices[r.c]),r.centroid.add(this.vertices[r.d]),r.centroid.divideScalar(4))},computeFaceNormals:function(){for(var t=new e.Vector3,i=new e.Vector3,r=0,n=this.faces.length;r<n;r++){var a=this.faces[r],s=this.vertices[a.a],o=this.vertices[a.b],l=this.vertices[a.c];t.subVectors(l,o),i.subVectors(s,o),t.cross(i),t.normalize(),a.normal.copy(t)}},computeVertexNormals:function(t){var i,r,n,a,s,o;if(void 0===this.__tmpVertices){for(this.__tmpVertices=new Array(this.vertices.length),o=this.__tmpVertices,i=0,r=this.vertices.length;i<r;i++)o[i]=new e.Vector3;for(n=0,a=this.faces.length;n<a;n++)(s=this.faces[n])instanceof e.Face3?s.vertexNormals=[new e.Vector3,new e.Vector3,new e.Vector3]:s instanceof e.Face4&&(s.vertexNormals=[new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3])}else for(o=this.__tmpVertices,i=0,r=this.vertices.length;i<r;i++)o[i].set(0,0,0);if(t){var l,h,c,d,u=new e.Vector3,p=new e.Vector3,f=new e.Vector3,g=new e.Vector3,m=new e.Vector3;for(n=0,a=this.faces.length;n<a;n++)(s=this.faces[n])instanceof e.Face3?(l=this.vertices[s.a],h=this.vertices[s.b],c=this.vertices[s.c],u.subVectors(c,h),p.subVectors(l,h),u.cross(p),o[s.a].add(u),o[s.b].add(u),o[s.c].add(u)):s instanceof e.Face4&&(l=this.vertices[s.a],h=this.vertices[s.b],c=this.vertices[s.c],d=this.vertices[s.d],f.subVectors(d,h),p.subVectors(l,h),f.cross(p),o[s.a].add(f),o[s.b].add(f),o[s.d].add(f),g.subVectors(d,c),m.subVectors(h,c),g.cross(m),o[s.b].add(g),o[s.c].add(g),o[s.d].add(g))}else for(n=0,a=this.faces.length;n<a;n++)(s=this.faces[n])instanceof e.Face3?(o[s.a].add(s.normal),o[s.b].add(s.normal),o[s.c].add(s.normal)):s instanceof e.Face4&&(o[s.a].add(s.normal),o[s.b].add(s.normal),o[s.c].add(s.normal),o[s.d].add(s.normal));for(i=0,r=this.vertices.length;i<r;i++)o[i].normalize();for(n=0,a=this.faces.length;n<a;n++)(s=this.faces[n])instanceof e.Face3?(s.vertexNormals[0].copy(o[s.a]),s.vertexNormals[1].copy(o[s.b]),s.vertexNormals[2].copy(o[s.c])):s instanceof e.Face4&&(s.vertexNormals[0].copy(o[s.a]),s.vertexNormals[1].copy(o[s.b]),s.vertexNormals[2].copy(o[s.c]),s.vertexNormals[3].copy(o[s.d]))},computeTangents:function(){var t,i,r,n,a,s,o,l,h,c,d,u,p,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A=[],T=[],D=new e.Vector3,I=new e.Vector3,R=new e.Vector3,O=new e.Vector3,L=new e.Vector3;for(r=0,n=this.vertices.length;r<n;r++)A[r]=new e.Vector3,T[r]=new e.Vector3;function V(e,t,i,r,n,a,s){h=e.vertices[t],c=e.vertices[i],d=e.vertices[r],u=l[n],p=l[a],f=l[s],g=c.x-h.x,m=d.x-h.x,v=c.y-h.y,y=d.y-h.y,S=c.z-h.z,_=d.z-h.z,x=p.x-u.x,b=f.x-u.x,w=p.y-u.y,M=f.y-u.y,C=1/(x*M-b*w),D.set((M*g-w*m)*C,(M*v-w*y)*C,(M*S-w*_)*C),I.set((x*m-b*g)*C,(x*y-b*v)*C,(x*_-b*S)*C),A[t].add(D),A[i].add(D),A[r].add(D),T[t].add(I),T[i].add(I),T[r].add(I)}for(t=0,i=this.faces.length;t<i;t++)o=this.faces[t],l=this.faceVertexUvs[0][t],o instanceof e.Face3?V(this,o.a,o.b,o.c,0,1,2):o instanceof e.Face4&&(V(this,o.a,o.b,o.d,0,1,3),V(this,o.b,o.c,o.d,1,2,3));var F=["a","b","c","d"];for(t=0,i=this.faces.length;t<i;t++)for(o=this.faces[t],a=0;a<o.vertexNormals.length;a++)L.copy(o.vertexNormals[a]),s=o[F[a]],P=A[s],R.copy(P),R.sub(L.multiplyScalar(L.dot(P))).normalize(),O.crossVectors(o.vertexNormals[a],P),E=O.dot(T[s])<0?-1:1,o.vertexTangents[a]=new e.Vector4(R.x,R.y,R.z,E);this.hasTangents=!0},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new e.Box3),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new e.Sphere),this.boundingSphere.setFromCenterAndPoints(this.boundingSphere.center,this.vertices)},mergeVertices:function(){var t,i,r,n,a,s,o,l,h,c={},d=[],u=[],p=Math.pow(10,4);for(this.__tmpVertices=void 0,r=0,n=this.vertices.length;r<n;r++)t=this.vertices[r],void 0===c[i=[Math.round(t.x*p),Math.round(t.y*p),Math.round(t.z*p)].join("_")]?(c[i]=r,d.push(this.vertices[r]),u[r]=d.length-1):u[r]=u[c[i]];var f=[];for(r=0,n=this.faces.length;r<n;r++)if((a=this.faces[r])instanceof e.Face3){a.a=u[a.a],a.b=u[a.b],a.c=u[a.c],s=[a.a,a.b,a.c];for(var g=-1,m=0;m<3;m++)if(s[m]==s[(m+1)%3]){g=m,f.push(r);break}}else if(a instanceof e.Face4){a.a=u[a.a],a.b=u[a.b],a.c=u[a.c],a.d=u[a.d],s=[a.a,a.b,a.c,a.d];for(g=-1,m=0;m<4;m++)s[m]==s[(m+1)%4]&&(g>=0&&f.push(r),g=m);if(g>=0){s.splice(g,1);var v=new e.Face3(s[0],s[1],s[2],a.normal,a.color,a.materialIndex);for(o=0,l=this.faceVertexUvs.length;o<l;o++)(h=this.faceVertexUvs[o][r])&&h.splice(g,1);a.vertexNormals&&a.vertexNormals.length>0&&(v.vertexNormals=a.vertexNormals,v.vertexNormals.splice(g,1)),a.vertexColors&&a.vertexColors.length>0&&(v.vertexColors=a.vertexColors,v.vertexColors.splice(g,1)),this.faces[r]=v}}for(r=f.length-1;r>=0;r--)for(this.faces.splice(r,1),o=0,l=this.faceVertexUvs.length;o<l;o++)this.faceVertexUvs[o].splice(r,1);var y=this.vertices.length-d.length;return this.vertices=d,y},clone:function(){for(var t=new r.LegacyGeometry,i=this.vertices,n=0,a=i.length;n<a;n++)t.vertices.push(i[n].clone());var s=this.faces;for(n=0,a=s.length;n<a;n++)t.faces.push(s[n].clone());var o=this.faceVertexUvs[0];for(n=0,a=o.length;n<a;n++){for(var l=o[n],h=[],c=0,d=l.length;c<d;c++)h.push(new e.Vector2(l[c].x,l[c].y));t.faceVertexUvs[0].push(h)}return t},dispose:function(){this.dispatchEvent({type:"dispose"})}},r.ParticleSystem=function(i,r){t.call(this),this.geometry=i,this.material=void 0!==r?r:new e.ParticleBasicMaterial({color:16777215*Math.random()}),this.sortParticles=!1,this.geometry&&null===this.geometry.boundingSphere&&this.geometry.computeBoundingSphere(),this.frustumCulled=!1,console.log("ExplicitGeometries.ParticleSystem is deprecated. Please use SceneGraphFactory.createMeshNode instead.")},r.ParticleSystem.prototype=Object.create(t.prototype),r.ParticleSystem.prototype.clone=function(e){return void 0===e&&(e=new r.ParticleSystem(this.geometry,this.material)),e.sortParticles=this.sortParticles,t.prototype.clone.call(this,e),e},r.Line=function(i,r,n){t.call(this),this.geometry=i,this.material=void 0!==r?r:new e.LineBasicMaterial({color:16777215*Math.random()}),this.type=void 0!==n?n:e.LineStrip,this.geometry&&(this.geometry.boundingSphere||this.geometry.computeBoundingSphere())},r.Line.prototype=Object.create(t.prototype),r.Line.prototype.clone=function(e){return void 0===e&&(e=new r.Line(this.geometry,this.material,this.type)),t.prototype.clone.call(this,e),e},r.SkinnedMesh=function(t,r,n){i.call(this,t,r,!0),this.useVertexTexture=void 0===n||n,this.identityMatrix=new e.Matrix4,this.bones=[],this.boneMatrices=[],window.sealWebVisuObjects&&Object.seal(this)},r.SkinnedMesh.prototype=Object.create(i.prototype),r.CircleGeometry=function(t,i,n,a){r.LegacyGeometry.call(this),t=t||50,n=void 0!==n?n:0,a=void 0!==a?a:2*Math.PI,i=void 0!==i?Math.max(3,i):8;var s,o=[],l=new e.Vector3,h=new e.Vector2(.5,.5);for(this.vertices.push(l),o.push(h),s=0;s<=i;s++){var c=new e.Vector3,d=n+s/i*a;c.x=t*Math.cos(d),c.y=t*Math.sin(d),this.vertices.push(c),o.push(new e.Vector2((c.x/t+1)/2,-(c.y/t+1)/2+1))}var u=new e.Vector3(0,0,-1);for(s=1;s<=i;s++){var p=s,f=s+1;this.faces.push(new e.Face3(p,f,0,[u,u,u])),this.faceVertexUvs[0].push([o[s],o[s+1],h])}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new e.Sphere(new e.Vector3,t)},r.CircleGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.CubeGeometry=function(t,i,n,a,s,o){r.LegacyGeometry.call(this);var l=this;this.width=t,this.height=i,this.depth=n,this.widthSegments=a||1,this.heightSegments=s||1,this.depthSegments=o||1;var h=this.width/2,c=this.height/2,d=this.depth/2;function u(t,i,r,n,a,s,o,h){var c,d,u,p=l.widthSegments,f=l.heightSegments,g=a/2,m=s/2,v=l.vertices.length;"x"===t&&"y"===i||"y"===t&&"x"===i?c="z":"x"===t&&"z"===i||"z"===t&&"x"===i?(c="y",f=l.depthSegments):("z"===t&&"y"===i||"y"===t&&"z"===i)&&(c="x",p=l.depthSegments);var y=p+1,S=f+1,_=a/p,x=s/f,b=new e.Vector3;for(b[c]=o>0?1:-1,u=0;u<S;u++)for(d=0;d<y;d++){var w=new e.Vector3;w[t]=(d*_-g)*r,w[i]=(u*x-m)*n,w[c]=o,l.vertices.push(w)}for(u=0;u<f;u++)for(d=0;d<p;d++){var M=d+y*u,C=d+y*(u+1),P=d+1+y*(u+1),E=d+1+y*u,A=new e.Face4(M+v,C+v,P+v,E+v);A.normal.copy(b),A.vertexNormals.push(b.clone(),b.clone(),b.clone(),b.clone()),A.materialIndex=h,l.faces.push(A),l.faceVertexUvs[0].push([new e.Vector2(d/p,1-u/f),new e.Vector2(d/p,1-(u+1)/f),new e.Vector2((d+1)/p,1-(u+1)/f),new e.Vector2((d+1)/p,1-u/f)])}}u("z","y",-1,-1,this.depth,this.height,h,0),u("z","y",1,-1,this.depth,this.height,-h,1),u("x","z",1,1,this.width,this.depth,c,2),u("x","z",1,-1,this.width,this.depth,-c,3),u("x","y",1,-1,this.width,this.height,d,4),u("x","y",-1,-1,this.width,this.height,-d,5),this.computeCentroids(),this.mergeVertices()},r.CubeGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.CylinderGeometry=function(t,i,n,a,s,o){r.LegacyGeometry.call(this),t=void 0!==t?t:20,i=void 0!==i?i:20;var l,h,c=(n=void 0!==n?n:100)/2,d=a||8,u=s||1,p=[],f=[];for(h=0;h<=u;h++){var g=[],m=[],v=h/u,y=v*(i-t)+t;for(l=0;l<=d;l++){var S=l/d,_=new e.Vector3;_.x=y*Math.sin(S*Math.PI*2),_.y=-v*n+c,_.z=y*Math.cos(S*Math.PI*2),this.vertices.push(_),g.push(this.vertices.length-1),m.push(new e.Vector2(S,1-v))}p.push(g),f.push(m)}var x,b,w=(i-t)/n;for(l=0;l<d;l++)for(0!==t?(x=this.vertices[p[0][l]].clone(),b=this.vertices[p[0][l+1]].clone()):(x=this.vertices[p[1][l]].clone(),b=this.vertices[p[1][l+1]].clone()),x.setY(Math.sqrt(x.x*x.x+x.z*x.z)*w).normalize(),b.setY(Math.sqrt(b.x*b.x+b.z*b.z)*w).normalize(),h=0;h<u;h++){var M=p[h][l],C=p[h+1][l],P=p[h+1][l+1],E=p[h][l+1],A=x.clone(),T=x.clone(),D=b.clone(),I=b.clone(),R=f[h][l].clone(),O=f[h+1][l].clone(),L=f[h+1][l+1].clone(),V=f[h][l+1].clone();this.faces.push(new e.Face4(M,C,P,E,[A,T,D,I])),this.faceVertexUvs[0].push([R,O,L,V])}if(!o&&t>0)for(this.vertices.push(new e.Vector3(0,c,0)),l=0;l<d;l++){M=p[0][l],C=p[0][l+1],P=this.vertices.length-1,A=new e.Vector3(0,1,0),T=new e.Vector3(0,1,0),D=new e.Vector3(0,1,0),R=f[0][l].clone(),O=f[0][l+1].clone(),L=new e.Vector2(O.u,0);this.faces.push(new e.Face3(M,C,P,[A,T,D])),this.faceVertexUvs[0].push([R,O,L])}if(!o&&i>0)for(this.vertices.push(new e.Vector3(0,-c,0)),l=0;l<d;l++){M=p[h][l+1],C=p[h][l],P=this.vertices.length-1,A=new e.Vector3(0,-1,0),T=new e.Vector3(0,-1,0),D=new e.Vector3(0,-1,0),R=f[h][l+1].clone(),O=f[h][l].clone(),L=new e.Vector2(O.u,1);this.faces.push(new e.Face3(M,C,P,[A,T,D])),this.faceVertexUvs[0].push([R,O,L])}this.computeCentroids(),this.computeFaceNormals()},r.CylinderGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.ExtrudeGeometry=function(e,t){void 0!==e?(r.LegacyGeometry.call(this),e=e instanceof Array?e:[e],this.shapebb=e[e.length-1].getBoundingBox(),this.addShapeList(e,t),this.computeCentroids(),this.computeFaceNormals()):e=[]},r.ExtrudeGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.ExtrudeGeometry.prototype.addShapeList=function(e,t){for(var i=e.length,r=0;r<i;r++){var n=e[r];this.addShape(n,t)}},r.ExtrudeGeometry.prototype.addShape=function(t,i){var n,a,s,o,l,h,c,d,u=void 0!==i.amount?i.amount:100,p=void 0!==i.bevelThickness?i.bevelThickness:6,f=void 0!==i.bevelSize?i.bevelSize:p-2,g=void 0!==i.bevelSegments?i.bevelSegments:3,m=void 0===i.bevelEnabled||i.bevelEnabled,v=void 0!==i.curveSegments?i.curveSegments:12,y=void 0!==i.steps?i.steps:1,S=i.extrudePath,_=!1,x=i.material,b=i.extrudeMaterial,w=void 0!==i.UVGenerator?i.UVGenerator:r.ExtrudeGeometry.WorldUVGenerator;this.shapebb;S&&(n=S.getSpacedPoints(y),_=!0,m=!1,a=void 0!==i.frames?i.frames:new e.TubeGeometry.FrenetFrames(S,y,!1),s=new e.Vector3,o=new e.Vector3,l=new e.Vector3),m||(g=0,p=0,f=0);var M=this,C=this.vertices.length,P=t.extractPoints(v),E=P.shape,A=P.holes,T=!e.Shape.Utils.isClockWise(E);if(T){for(E=E.reverse(),c=0,d=A.length;c<d;c++)h=A[c],e.Shape.Utils.isClockWise(h)&&(A[c]=h.reverse());T=!1}var D=e.Shape.Utils.triangulateShape(E,A),I=E;for(c=0,d=A.length;c<d;c++)h=A[c],E=E.concat(h);function R(e,t,i){return t||console.log("die"),t.clone().multiplyScalar(i).add(e)}var O,L,V,F,B,N,G=E.length,k=D.length;I.length,Math.PI;function U(t,i,n){return function(t,i,n){var a,s,o,l,h,c=r.ExtrudeGeometry.__v1,d=r.ExtrudeGeometry.__v2,u=r.ExtrudeGeometry.__v3,p=r.ExtrudeGeometry.__v4,f=r.ExtrudeGeometry.__v5,g=r.ExtrudeGeometry.__v6;if(c.set(t.x-i.x,t.y-i.y),d.set(t.x-n.x,t.y-n.y),a=c.normalize(),s=d.normalize(),u.set(-a.y,a.x),p.set(s.y,-s.x),f.copy(t).add(u),g.copy(t).add(p),f.equals(g))return p.clone();f.copy(i).add(u),g.copy(n).add(p),o=a.dot(p),l=g.sub(f).dot(p),0===o&&(console.log("Either infinite or no solutions!"),0===l?console.log("Its finite solutions."):console.log("Too bad, no solutions."));if((h=l/o)<0)return function(t,i,r){var n=Math.atan2(i.y-t.y,i.x-t.x),a=Math.atan2(r.y-t.y,r.x-t.x);n>a&&(a+=2*Math.PI);var s=(n+a)/2,o=-Math.cos(s),l=-Math.sin(s);return new e.Vector2(o,l)}(t,i,n);return a.multiplyScalar(h).add(f).sub(t).clone()}(t,i,n)}for(var z=[],H=0,W=I.length,j=W-1,X=H+1;H<W;H++,j++,X++){j===W&&(j=0),X===W&&(X=0);I[H],I[j],I[X];z[H]=U(I[H],I[j],I[X])}var q,Z,Y=[],Q=z.concat();for(c=0,d=A.length;c<d;c++){for(h=A[c],q=[],H=0,j=(W=h.length)-1,X=H+1;H<W;H++,j++,X++)j===W&&(j=0),X===W&&(X=0),q[H]=U(h[H],h[j],h[X]);Y.push(q),Q=Q.concat(q)}for(O=0;O<g;O++){for(F=p*(1-(V=O/g)),L=f*Math.sin(V*Math.PI/2),H=0,W=I.length;H<W;H++)J((B=R(I[H],z[H],L)).x,B.y,-F);for(c=0,d=A.length;c<d;c++)for(h=A[c],q=Y[c],H=0,W=h.length;H<W;H++)J((B=R(h[H],q[H],L)).x,B.y,-F)}for(L=f,H=0;H<G;H++)B=m?R(E[H],Q[H],L):E[H],_?(o.copy(a.normals[0]).multiplyScalar(B.x),s.copy(a.binormals[0]).multiplyScalar(B.y),l.copy(n[0]).add(o).add(s),J(l.x,l.y,l.z)):J(B.x,B.y,0);for(Z=1;Z<=y;Z++)for(H=0;H<G;H++)B=m?R(E[H],Q[H],L):E[H],_?(o.copy(a.normals[Z]).multiplyScalar(B.x),s.copy(a.binormals[Z]).multiplyScalar(B.y),l.copy(n[Z]).add(o).add(s),J(l.x,l.y,l.z)):J(B.x,B.y,u/y*Z);for(O=g-1;O>=0;O--){for(F=p*(1-(V=O/g)),L=f*Math.sin(V*Math.PI/2),H=0,W=I.length;H<W;H++)J((B=R(I[H],z[H],L)).x,B.y,u+F);for(c=0,d=A.length;c<d;c++)for(h=A[c],q=Y[c],H=0,W=h.length;H<W;H++)B=R(h[H],q[H],L),_?J(B.x,B.y+n[y-1].y,n[y-1].x+F):J(B.x,B.y,u+F)}function K(e,t){var i,r;for(H=e.length;--H>=0;){i=H,(r=H-1)<0&&(r=e.length-1);var n=0,a=y+2*g;for(n=0;n<a;n++){var s=G*n,o=G*(n+1);ee(t+i+s,t+r+s,t+r+o,t+i+o,e,n,a,i,r)}}}function J(t,i,r){M.vertices.push(new e.Vector3(t,i,r))}function $(r,n,a,s){r+=C,n+=C,a+=C,M.faces.push(new e.Face3(r,n,a,null,null,x));var o=s?w.generateBottomUV(M,t,i,r,n,a):w.generateTopUV(M,t,i,r,n,a);M.faceVertexUvs[0].push(o)}function ee(r,n,a,s,o,l,h,c,d){r+=C,n+=C,a+=C,s+=C,M.faces.push(new e.Face4(r,n,a,s,null,null,b));var u=w.generateSideWallUV(M,t,o,i,r,n,a,s,l,h,c,d);M.faceVertexUvs[0].push(u)}!function(){if(m){var e=0,t=G*e;for(H=0;H<k;H++)$((N=D[H])[2]+t,N[1]+t,N[0]+t,!0);for(t=G*(e=y+2*g),H=0;H<k;H++)$((N=D[H])[0]+t,N[1]+t,N[2]+t,!1)}else{for(H=0;H<k;H++)$((N=D[H])[2],N[1],N[0],!0);for(H=0;H<k;H++)$((N=D[H])[0]+G*y,N[1]+G*y,N[2]+G*y,!1)}}(),function(){var e=0;for(K(I,e),e+=I.length,c=0,d=A.length;c<d;c++)K(h=A[c],e),e+=h.length}()},r.ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(t,i,r,n,a,s){var o=t.vertices[n].x,l=t.vertices[n].y,h=t.vertices[a].x,c=t.vertices[a].y,d=t.vertices[s].x,u=t.vertices[s].y;return[new e.Vector2(o,l),new e.Vector2(h,c),new e.Vector2(d,u)]},generateBottomUV:function(e,t,i,r,n,a){return this.generateTopUV(e,t,i,r,n,a)},generateSideWallUV:function(t,i,r,n,a,s,o,l,h,c,d,u){var p=t.vertices[a].x,f=t.vertices[a].y,g=t.vertices[a].z,m=t.vertices[s].x,v=t.vertices[s].y,y=t.vertices[s].z,S=t.vertices[o].x,_=t.vertices[o].y,x=t.vertices[o].z,b=t.vertices[l].x,w=t.vertices[l].y,M=t.vertices[l].z;return Math.abs(f-v)<.01?[new e.Vector2(p,1-g),new e.Vector2(m,1-y),new e.Vector2(S,1-x),new e.Vector2(b,1-M)]:[new e.Vector2(f,1-g),new e.Vector2(v,1-y),new e.Vector2(_,1-x),new e.Vector2(w,1-M)]}},r.ExtrudeGeometry.__v1=new e.Vector2,r.ExtrudeGeometry.__v2=new e.Vector2,r.ExtrudeGeometry.__v3=new e.Vector2,r.ExtrudeGeometry.__v4=new e.Vector2,r.ExtrudeGeometry.__v5=new e.Vector2,r.ExtrudeGeometry.__v6=new e.Vector2,r.ShapeGeometry=function(e,t){r.LegacyGeometry.call(this),e instanceof Array==!1&&(e=[e]),this.shapebb=e[e.length-1].getBoundingBox(),this.addShapeList(e,t),this.computeCentroids(),this.computeFaceNormals()},r.ShapeGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.ShapeGeometry.prototype.addShapeList=function(e,t){for(var i=0,r=e.length;i<r;i++)this.addShape(e[i],t);return this},r.ShapeGeometry.prototype.addShape=function(t,i){void 0===i&&(i={});var n,a,s,o=void 0!==i.curveSegments?i.curveSegments:12,l=i.material,h=void 0===i.UVGenerator?r.ExtrudeGeometry.WorldUVGenerator:i.UVGenerator,c=(this.shapebb,this.vertices.length),d=t.extractPoints(o),u=d.shape,p=d.holes,f=!e.Shape.Utils.isClockWise(u);if(f){for(u=u.reverse(),n=0,a=p.length;n<a;n++)s=p[n],e.Shape.Utils.isClockWise(s)&&(p[n]=s.reverse());f=!1}var g=e.Shape.Utils.triangulateShape(u,p),m=u;for(n=0,a=p.length;n<a;n++)s=p[n],u=u.concat(s);var v,y,S=u.length,_=g.length;m.length;for(n=0;n<S;n++)v=u[n],this.vertices.push(new e.Vector3(v.x,v.y,0));for(n=0;n<_;n++){var x=(y=g[n])[0]+c,b=y[1]+c,w=y[2]+c;this.faces.push(new e.Face3(x,b,w,null,null,l)),this.faceVertexUvs[0].push(h.generateBottomUV(this,t,i,x,b,w))}},r.PlaneGeometry=function(t,i,n,a){var s,o;r.LegacyGeometry.call(this),this.width=t,this.height=i,this.widthSegments=n||1,this.heightSegments=a||1;var l=t/2,h=i/2,c=this.widthSegments,d=this.heightSegments,u=c+1,p=d+1,f=this.width/c,g=this.height/d,m=new e.Vector3(0,0,1);for(o=0;o<p;o++)for(s=0;s<u;s++){var v=s*f-l,y=o*g-h;this.vertices.push(new e.Vector3(v,-y,0))}for(o=0;o<d;o++)for(s=0;s<c;s++){var S=s+u*o,_=s+u*(o+1),x=s+1+u*(o+1),b=s+1+u*o,w=new e.Face4(S,_,x,b);w.normal.copy(m),w.vertexNormals.push(m.clone(),m.clone(),m.clone(),m.clone()),this.faces.push(w),this.faceVertexUvs[0].push([new e.Vector2(s/c,1-o/d),new e.Vector2(s/c,1-(o+1)/d),new e.Vector2((s+1)/c,1-(o+1)/d),new e.Vector2((s+1)/c,1-o/d)])}this.computeCentroids()},r.PlaneGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.SphereGeometry=function(t,i,n,a,s,o,l){r.LegacyGeometry.call(this),this.radius=t||50,this.widthSegments=Math.max(3,Math.floor(i)||8),this.heightSegments=Math.max(2,Math.floor(n)||6),a=void 0!==a?a:0,s=void 0!==s?s:2*Math.PI,o=void 0!==o?o:0,l=void 0!==l?l:Math.PI;var h,c,d=[],u=[];for(c=0;c<=this.heightSegments;c++){var p=[],f=[];for(h=0;h<=this.widthSegments;h++){var g=h/this.widthSegments,m=c/this.heightSegments,v=new e.Vector3;v.x=-this.radius*Math.cos(a+g*s)*Math.sin(o+m*l),v.y=this.radius*Math.cos(o+m*l),v.z=this.radius*Math.sin(a+g*s)*Math.sin(o+m*l),this.vertices.push(v),p.push(this.vertices.length-1),f.push(new e.Vector2(g,1-m))}d.push(p),u.push(f)}for(c=0;c<this.heightSegments;c++)for(h=0;h<this.widthSegments;h++){var y=d[c][h+1],S=d[c][h],_=d[c+1][h],x=d[c+1][h+1],b=this.vertices[y].clone().normalize(),w=this.vertices[S].clone().normalize(),M=this.vertices[_].clone().normalize(),C=this.vertices[x].clone().normalize(),P=u[c][h+1].clone(),E=u[c][h].clone(),A=u[c+1][h].clone(),T=u[c+1][h+1].clone();Math.abs(this.vertices[y].y)===this.radius?(this.faces.push(new e.Face3(y,_,x,[b,M,C])),this.faceVertexUvs[0].push([P,A,T])):Math.abs(this.vertices[_].y)===this.radius?(this.faces.push(new e.Face3(y,S,_,[b,w,M])),this.faceVertexUvs[0].push([P,E,A])):(this.faces.push(new e.Face4(y,S,_,x,[b,w,M,C])),this.faceVertexUvs[0].push([P,E,A,T]))}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new e.Sphere(new e.Vector3,t)},r.SphereGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.TextGeometry=function(t,i){var n=e.FontUtils.generateShapes(t,i);i.amount=void 0!==i.height?i.height:50,void 0===i.bevelThickness&&(i.bevelThickness=10),void 0===i.bevelSize&&(i.bevelSize=8),void 0===i.bevelEnabled&&(i.bevelEnabled=!1),r.ExtrudeGeometry.call(this,n,i)},r.TextGeometry.prototype=Object.create(r.ExtrudeGeometry.prototype),r}),function(){var e="file:"!==window.location.protocol?"text!Visualization/assets/svgmode.json":null;define("DS/Visualization/GetSVGMode",[e],function(e){var t=e&&JSON.parse(e);return{getWebGLMode:function(){return!(t&&"svg"===t.svgMode||window.v6ViewerSVGBrowserMode)}}})}(),define("DS/Visualization/SceneGraphConverter",["DS/VisuLoaders/SceneGraphConverter"],function(e){"use strict";return e}),define("Visualization/SceneGraphConverter",["DS/Visualization/SceneGraphConverter","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SceneGraphConverter"),e}),define("DS/Visualization/ParticlesLoader",["DS/VisuLoaders/ParticlesLoader"],function(e){"use strict";return e}),define("Visualization/ParticlesLoader",["DS/Visualization/ParticlesLoader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ParticlesLoader"),e}),define("DS/Visualization/SectionBuilder",["DS/Mesh/Mesh"],function(e){"use strict";var t;function i({geom:e,index_ranges:t,plane:i,deduplication:r=null}){const n=e.vertexPositionArray;function a(e){const t=3*e;return i.x*n[t]+i.y*n[t+1]+i.z*n[t+2]+i.w}const s=[];function o(e){const t=3*e;s.push(n[t],n[t+1],n[t+2])}function l(e,t,i){const r=3*e,a=3*t,o=(1-i)*n[r]+i*n[a],l=(1-i)*n[r+1]+i*n[a+1],h=(1-i)*n[r+2]+i*n[a+2];s.push(o,l,h)}const h=e.vertexIndexArray,c=r?e=>r[h[e]]:e=>h[e];for(let e=0;e<t.length;e++){const i=t[e][0],r=t[e][1];for(let e=i;e<r;e+=3){const t=c(e),i=c(e+1),r=c(e+2),n=a(t),s=a(i),h=a(r),d=n*s<=0?-n/(s-n):null,u=s*h<=0?-s/(h-s):null,p=h*n<=0?-h/(n-h):null;if(null===d&&null===u&&null===p)continue;let f=!1;Number.isNaN(d)&&(o(t),o(i),f=!0),Number.isNaN(u)&&(o(i),o(r),f=!0),Number.isNaN(p)&&(o(r),o(t),f=!0),f||(null!==d&&d<1&&l(t,i,d),null!==u&&u<1&&l(i,r,u),null!==p&&p<1&&l(r,t,p))}}return new Float32Array(s)}function r(e,t){const i=e.length;for(let r=0;r<i;r+=3)e[r]+=t.x,e[r+1]+=t.y,e[r+2]+=t.z}function n({renderable:n,clipPlanes:a,sectionLines:s,lineWidth:o=1,color:l="#000000",visibleSpace:h}){if(0===a.length)return null;const c=(new t.Matrix4).copy(n.matrixWorld).transpose(),d=a.map(e=>new t.Vector4(e.normal.x,e.normal.y,e.normal.z,e.constant).applyMatrix4(c)),u=function(e,i){let r=new Map;function n(e,t,i){const n=r.get(e);n?n.push([t,t+i]):r.set(e,[[t,t+i]])}if(e.layer)for(let r=0;r<e.layer.layers.length;r++){const a=e.layer.layers[r].drawableGroup;if(a._geomType!==t.GeomTypeEnum.FACE)continue;const s=e.layer.layers[r].drawableInterval;s.skip(e,i)||n(a.geometry,s.start,s.count)}else{const i=e.geometry.length;for(let r=0;r<i;r++){const i=e.geometry[r];for(let e=0;e<i.drawingGroups.length;e++){const r=i.drawingGroups[e];r._geomType===t.GeomTypeEnum.FACE&&n(i,r.start,r.count)}}}return r}(n,h),p=[];u.forEach((e,n)=>{const a=function({geom:e,index_ranges:n,planes:a,clipPlanes:s,sectionLines:o,deduplication:l=null}){const h=[];for(let s=0;s<a.length;s++)if(o[s]){const o=a[s],c=i({geom:e,index_ranges:n,plane:o,deduplication:l});r(c,new t.Vector3(o.x,o.y,o.z).normalize().multiplyScalar(5e-4)),h.push(c)}else h.push([]);const c=[];for(let e=0;e<h.length;e++){const t=h[e];let i=t.length;for(let r=0;r<a.length;r++){if(r===e)continue;const n=a[r];let s=0;for(let e=0;e<i;e+=6){const i=t[e],r=t[e+1],a=t[e+2],o=t[e+3],l=t[e+4],h=t[e+5],c=n.x*i+n.y*r+n.z*a+n.w,d=n.x*o+n.y*l+n.z*h+n.w;let u=null;c*d<=0?0==(u=-c/(d-c))&&d<0?u=null:1===u&&c<0&&(u=null):c>0&&(u=NaN),Number.isNaN(u)?s!==e?(t[s++]=i,t[s++]=r,t[s++]=a,t[s++]=o,t[s++]=l,t[s++]=h):s+=6:null!==u&&(t[s++]=(1-u)*i+u*o,t[s++]=(1-u)*r+u*l,t[s++]=(1-u)*a+u*h,c>0?(t[s++]=i,t[s++]=r,t[s++]=a):(t[s++]=o,t[s++]=l,t[s++]=h))}i=s}0!==i&&c.push(t.subarray(0,i))}return c}({geom:n,index_ranges:e=function(e){if(e.length<2)return e;e.sort((e,t)=>e[0]-t[0]);let t=0;for(let i=1;i<e.length;i++){const r=e[t],n=e[i];n[0]>r[1]?e[++t]=n:n[1]>r[1]&&(r[1]=n[1])}return e.length=t+1,e}(e),planes:d,sectionLines:s});p.push(...a)});let f=0;for(let e=0;e<p.length;e++)f+=p[e].length;const g=new Float32Array(f);let m=0;for(let e=0;e<p.length;e++)g.set(p[e],m),m+=p[e].length;let v=[];for(let e=0;e<f/3;e++)v.push(e);v=new Uint32Array(v);const y=new t.BufferGeometryDS;y.vertexPositionArray=g,y.vertexIndexArray=v,y.boundingSphere=n.boundingSphere,y.boundingBox=n.boundingBox;const S=new t.LineBasicMaterial({color:l,lineWidth:o,force:!0});S.enableClipPlanes=!1,S.side=t.DoubleSide,S.polygonOffset=!0,S.polygonOffsetFactor=-1.5,S.polygonOffsetUnits=-10;const _={start:0,count:y.vertexIndexArray.length},x=new e.DrawingGroup(S,S,1,0,y.vertexIndexArray.length,[_],void 0,0);return y.drawingGroups=[x],x.geometry=y,y}var a=function(e){for(var t=1;t<e;)t*=2;return t};return class{constructor({renderable:e,renderer:i,lineWidth:r,color:n,clipPlanes:a,sectionLines:s}){t=THREEDS.Core,this._color=new t.Color(n||0),this.lineWidth=r||1,this.wide=this.lineWidth>1,this._renderable=e,this.clipPlanes=a,this.sectionLines=this.computeInternalSectionLineArray(a,s),this.resetBuffers(),this.renderer=i,this.sectionLineGeometry=null}resetBuffers(){this.indexArray=null,this.currentsArray=null,this.edgeLastIndexArray=null,this._Id=0,this._edgeId=0,this.halfEdges=[],this.halfEdgesStructure=null,this._positionArray=null}allocateArrays(e){if(this.wide){this.indexArray=new Uint32Array(3*e*2);var t=6*e;this.currentsArray=new Float32Array(2*t),this.edgeLastIndexArray=new Float32Array(6*e*2)}else this.indexArray=new Uint32Array(2*e),t=6*e,this.currentsArray=new Float32Array(t),this.edgeLastIndexArray=new Float32Array(6*e)}addEdgeIndices(e,t,i){var r=this.indexArray,n=this.currentsArray,a=this.edgeLastIndexArray,s=this._edgeId;if(this.wide){var o=4*s,l=4*s+1,h=4*s+2,c=4*s+3;r[6*s]=o,r[6*s+1]=h,r[6*s+2]=c,r[6*s+3]=o,r[6*s+4]=c,r[6*s+5]=l,n[12*s]=e,n[12*s+1]=t,n[12*s+2]=i,n[12*s+3]=e,n[12*s+3+1]=t,n[12*s+3+2]=i,n[12*s+6]=t,n[12*s+6+1]=i,n[12*s+6+2]=e,n[12*s+9]=t,n[12*s+9+1]=i,n[12*s+9+2]=e,a[12*s]=1,a[12*s+1]=1,a[12*s+2]=0,a[12*s+3]=1,a[12*s+3+1]=-1,a[12*s+3+2]=0,a[12*s+6]=-1,a[12*s+6+1]=1,a[12*s+6+2]=0,a[12*s+9]=-1,a[12*s+9+1]=-1,a[12*s+9+2]=0}else r[2*s]=2*s,r[2*s+1]=2*s+1,n[6*s]=e,n[6*s+1]=t,n[6*s+2]=i,n[6*s+3]=t,n[6*s+4]=i,n[6*s+5]=e,a[6*s]=1,a[6*s+1]=0,a[6*s+2]=0,a[6*s+3]=-1,a[6*s+4]=0,a[6*s+5]=0;this._edgeId++}processTriangleIndices(e,t,i){this.addEdgeIndices(e,t,i),this.addEdgeIndices(t,i,e),this.addEdgeIndices(i,e,t)}computeSectionLineGeometry(){!!localStorage.getItem("useCPUSection")||(this.clipPlanes=null),this.clipPlanes?this.sectionLineGeometry=n({renderable:this._renderable,clipPlanes:this.clipPlanes,sectionLines:this.sectionLines,lineWidth:this.lineWidth,color:this._color,visibleSpace:this.renderer.visibleSpace}):this.computeSectionLineGeometry_old()}setColor(e){if(null===e)return;const t=this.sectionLineGeometry&&this.sectionLineGeometry.drawingGroups[0].material;t&&t.color.set(e)}computeInternalSectionLineArray(e,t){let i=null;if(t||!e)i=t;else{let t;for(i=[],t=0;t<e.length;t++)i.push(!0)}return i}update({width:e,color:t,clipPlanes:i,sectionLines:r}){this.setColor(t);const n=this.sectionLineGeometry&&this.sectionLineGeometry.drawingGroups[0].material;if(this.clipPlanes){if(n){if(!i||this.clipPlanes.length!==i.length)return!1;const t=this.computeInternalSectionLineArray(i,r);for(let e=0;e<this.clipPlanes.length;e++)if(!this.clipPlanes[e].equals(i[e])||this.sectionLines[e]!==t[e])return!1;return n.setLineWidth(e),!0}return!1}return this.lineWidth===e}dispose(){this.sectionLineGeometry&&this.sectionLineGeometry.dispose(),this.sectionLineGeometry=null}computeSectionLineGeometry_old(){var e,t,i,r,n,a,s=THREEDS.Core,o=this._renderable,l=[],h=this.renderer.visibleSpace,c=0;if(o.layer){var d={};for(u=0;u<o.layer.layers.length;u++)P=o.layer.layers[u].drawableGroup,(w=o.layer.layers[u].drawableInterval).skip(o,h)||(d[P.geometry.id]=P.geometry,c+=P._geomType===s.GeomTypeEnum.FACE?w.count:0);for(var u in d)l.push(d[u])}else{l=o.geometry;for(var p=o.geometry.length,u=0;u<p;u++){(C=o.geometry[u]).drawingGroups.length;for(var f=0;f<C.drawingGroups.length;f++)c+=(P=C.drawingGroups[f])._geomType===s.GeomTypeEnum.FACE?P.count:0}}if(0===c)return null;this.allocateArrays(c);var g=0,m=0,v=[],y=[];for(u=0;u<l.length;u++)v[u]=g,y[u]=m,g+=l[u].vertexIndexArray.length,m+=l[u].vertexPositionArray.length;if(1===l.length)e=l[0].vertexIndexArray,t=l[0].vertexPositionArray;else{e=new Uint32Array(g),t=new Float32Array(m);var S=0,_=0;for(u=0;u<l.length;u++){for(var x=l[u],b=0;b<x.vertexIndexArray.length;b++)e[S]=y[u]/3+x.vertexIndexArray[b],S++;for(b=0;b<x.vertexPositionArray.length;b++)t[_]=x.vertexPositionArray[b],_++}}if(this.halfEdgesStructure={},a=e.length,this.maxIndices=a,this._positionArray=t,o.layer)for(u=0;u<o.layer.layers.length;u++){var w;if(P=o.layer.layers[u].drawableGroup,!(w=o.layer.layers[u].drawableInterval).skip(o,h)&&P._geomType===s.GeomTypeEnum.FACE){var M=l.indexOf(P.geometry);for(E=v[M]+w.start;E<v[M]+w.start+w.count;E+=3)i=e[E],r=e[E+1],n=e[E+2],i!==r&&r!==n&&i!==n&&this.processTriangleIndices(i,r,n,a)}}else for(p=l.length,u=0;u<p;u++){var C=l[u];for(f=0;f<C.drawingGroups.length;f++){var P;if((P=C.drawingGroups[f])._geomType===s.GeomTypeEnum.FACE)for(var E=v[u]+P.start;E<v[u]+P.start+P.count;E+=3)i=e[E],r=e[E+1],n=e[E+2],i!==r&&r!==n&&i!==n&&this.processTriangleIndices(i,r,n,a)}}this.sectionLineGeometry=this.createNewGeometry(),this.resetBuffers()}createNewGeometry(t){var i,r=THREEDS.Core,n=this.indexArray.length,s=[],o=debugWebGLV6Viewer.renderer.renderer.context,l=o.getParameter(o.MAX_TEXTURE_SIZE),h=l*l,c=this._positionArray.length/3,d=Math.ceil(c/h),u=c-Math.floor(c/h)*h,p=Math.sqrt(u),f=a(p),g=a(u/f),m=3*((d-1)*h+f*g),v=new Float32Array(m);v.set(this._positionArray);for(var y=0;y<d-1;y++){var S;(S=new r.DataTexture(v.subarray(y*h*3,(y+1)*h*3),l,l,r.RGBFormat,r.FloatType)).minFilter=r.NearestFilter,S.magFilter=r.NearestFilter,S.generateMipmaps=!1,S.flipY=!1,S.needsUpdate=!0,s.push(S)}(S=new r.DataTexture(v.subarray((d-1)*h*3,m),f,g,r.RGBFormat,r.FloatType)).minFilter=r.NearestFilter,S.magFilter=r.NearestFilter,S.generateMipmaps=!1,S.flipY=!1,S.needsUpdate=!0,s.push(S);var _={NB_OUTLINE_MAPS:d,MAX_OUTLINE_MAP_SIZE:l.toFixed(1),LAST_OUTLINE_MAP_SIZE_X:f.toFixed(1),LAST_OUTLINE_MAP_SIZE_Y:g.toFixed(1)};(i=this.wide?new r._WideSectionMaterial(_,s,.5*this.lineWidth):new r._SectionMaterial(_,s)).color.set(this._color);var x=new e.DrawingGroup(i,i,this.wide?4:1,0,n),b=new r.BufferGeometryDS;return b.drawingGroups=[],x.geometry=b,b.drawingGroups.push(x),b.vertexPositionArray=this.currentsArray,b.vertexUvArray=this.edgeLastIndexArray,b.vertexIndexArray=this.indexArray,b.boundingSphere=this._renderable.boundingSphere,b.boundingBox=this._renderable.boundingBox,b}}}),define("DS/Visualization/BufferGPUManager",["UWA/Class","DS/Mesh/ThreeJS_Base"],function(e,t){"use strict";var i=e.singleton({init:function(){return this.reset(),this},reset:function(){this._gl=null,this._infos=new Map,this.initAtLoading=!1,this.sharedGeometriesToInit=new Map,this.intermediaryArray=null,this.sharingIntermediaryArray=null,this.sharingIntermediaryIndex16Array=null,this.sharingIntermediaryIndex32Array=null,this.fillMapGeomBufferSize=!1,this.mapGeomBufferSize=new Map},addToMapGeomBufferSize:function(e){this.fillMapGeomBufferSize&&this.mapGeomBufferSize.set(e.id,e.getBuffersMemorySize())},addGeometryFromObject:function(e){if(e.geometry&&!(2!==e.geometry._type&&e.geometry.length<0)){var t=e.geometry;if(2===t._type&&(t=[t]),t[0])if(t[0].sharedBuffers)this.sharedGeometriesToInit.has(t[0].id)||(this.sharedGeometriesToInit.set(t[0].id,t),this.initAtLoading&&this.allocateShared(!1));else if(this.initAtLoading)for(var i=0;i<t.length;i++)this.allocateDirect(t[i],e),this.allocateInstancingBuffers(e,null)}},geometryInfoDecrement:function(){this._infos.forEach(function(e,t,i){e.memory.geometries--})},geometryInfoIncrement:function(){this._infos.forEach(function(e,t,i){e.memory.geometries++})},sharedBufferInfoIncrement:function(){this._infos.forEach(function(e,t,i){e.memory.sharedbuffers++})},allocateDirect:function(e){e.wideLinesLinker&&!e.wideLinesLinker._isParent(e)&&e.__setTypedArraysForWidelines();let i=!1;if(!e.vertexBufferGPU){const r=e.getVertexCount(),n=r>0?e.layout.clone():null;if(r>0&&n&&n.size()>0){this.addToMapGeomBufferSize(e);let a=void 0,s=void 0,o=n.getFullInterleaving();if(o)a=e.buffers[o.bufferId],s=o.stride;else{n.interleave();const t=(s=n.getFullInterleaving().stride)*r;!e.editable&&this.intermediaryArray&&this.intermediaryArray.byteLength>=t?a=this.intermediaryArray.subarray(0,t):(a=new Uint8Array(t),e.editable||(this.intermediaryArray=a)),e.exportRaw({target_array:a,target_layout:n})}const l=new t.GLVertexBuffer({gl:this._gl});l.nbGeometries=1,l.numVertices=r,l.layout=n,e.vertexBufferGPU=l,e.vertexOffsetGPU=0,e.vertexCountGPU=r,this._gl.bindBuffer(this._gl.ARRAY_BUFFER,l.buffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,a,e.editable?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),e.editable&&(l.interleavedData=a),this.geometryInfoIncrement(),e._markAllAttributesClean(),i=!0}}if(!e.indexBufferGPU){let r=e.vertexIndexArray;if(0!==e.vertexOffsetGPU){const t=e.vertexOffsetGPU;r=e.vertexIndexArray.map(e=>e+t)}const n=new t.GLIndexBuffer({gl:this._gl,data:r});n.nbGeometries=1,e.indexBufferGPU=n,e.indexOffsetGPU=0,e._markIndexClean(),i=!0}i&&e.noMeshInRAM&&!e.sharedBuffers&&!e.editable&&e.clearMeshInRAM(!1)},allocateInstancingBuffers:function(e,t){let i=t&&t._instancingInfos?t._instancingInfos:e&&e._instancingInfos?e._instancingInfos:null;if(i&&i.instanceAttribArrays){var r=i.instanceAttribArrays;for(var n in r)"id"!==n&&null!==r[n].array&&null===r[n].buffer&&(r[n].buffer=this._gl.createBuffer(),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,r[n].buffer),r[n].isDynamic?this._gl.bufferData(this._gl.ARRAY_BUFFER,r[n].array,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.ARRAY_BUFFER,r[n].array,this._gl.STATIC_DRAW),r[n].buffer.itemSize=r[n].itemSize,r[n].buffer.numItems=i.nbInstances)}},allocateShared:function(e){if(0==this.sharedGeometriesToInit.size)return;let i=Number.MAX_SAFE_INTEGER;if(navigator.userAgent.toLowerCase().indexOf("firefox")>-1){parseFloat(navigator.userAgent.substr(navigator.userAgent.length-4))>=60&&(i=250)}const r=[],n={};if(this.sharedGeometriesToInit.forEach(e=>{for(let t=0;t<e.length;t++){const a=e[t];if(!a)continue;if(a.vertexBufferGPU&&a.vertexBufferGPU.isShared)continue;if(!a.vertexIndexArray){console.warn("no geometry available, are you trying to reattach a mesh while noMeshInRAM has been activated?");continue}const s=a.layout.getSignature();let o=n[s];o||(o={geoms:[],dgCount:0,vertexCount:0,indexCount:0},n[s]=o),o.geoms.push(a),o.vertexCount+=a.getVertexCount(),o.indexCount+=a.vertexIndexArray.length,o.dgCount+=a.drawingGroups.length,(o.vertexCount>2097152||o.dgCount>i)&&(r.push(o),n[s]=null)}}),e)for(let e in n){const t=n[e];t&&t.dgCount>0&&r.push(t)}for(let e=0;e<r.length;e++){const i=r[e],n=new t.GLVertexBuffer({gl:this._gl});n.numVertices=i.vertexCount,n.nbGeometries=i.geoms.length,n.isShared=!0,n.layout=i.geoms[0].layout.clone();const s=new t.GLIndexBuffer({gl:this._gl,numIndices:i.indexCount,use32bitIndexBuffer:t.supportedExtensions.elementIndexUint&&n.numVertices>65535});s.nbGeometries=i.geoms.length,s.isShared=!0,this.sharedBufferInfoIncrement();for(let e=0;e<i.geoms.length;e++){const t=i.geoms[e];this.sharedGeometriesToInit.delete(t.id),(t.vertexBufferGPU||t.indexBufferGPU)&&(t.deallocate(this._gl,null),this.geometryInfoDecrement()),t.vertexBufferGPU=n,t.indexBufferGPU=s;for(var a=0;a<t.meshList.length;a++)t.meshList[a]._flagAsGSSOInvalidated()}this._gl.bindBuffer(this._gl.ARRAY_BUFFER,n.buffer),n.layout.interleave();const o=n.layout.getFullInterleaving().stride,l=o*i.vertexCount;this._gl.bufferData(this._gl.ARRAY_BUFFER,l,this._gl.STATIC_DRAW);let h=0;for(let e=0;e<i.geoms.length;e++){const t=i.geoms[e],r=t.getVertexCount(),a=r*o;t.vertexOffsetGPU=h/o,t.vertexCountGPU=r;let s=null;this.sharingIntermediaryArray&&this.sharingIntermediaryArray.length>=a?s=this.sharingIntermediaryArray.subarray(0,a):(s=new Uint8Array(a),this.sharingIntermediaryArray=s),t.exportRaw({target_array:s,target_layout:n.layout}),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,h,s),h+=a,t.noMeshInRAM&&t.clearMeshInRAM(!0),this.geometryInfoIncrement()}0,this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,s.buffer);let c=s.numIndices*s.bytesPerIndex;this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,c,this._gl.STATIC_DRAW);let d=0;for(let e=0;e<i.geoms.length;e++){let t=i.geoms[e];const r=t.vertexIndexArray.length;t.indexOffsetGPU=d;let n=null;{let e=s.use32bitIndexBuffer?this.sharingIntermediaryIndex32Array:this.sharingIntermediaryIndex16Array;e&&e.length>=r?n=e.subarray(0,r):s.use32bitIndexBuffer?(n=new Uint32Array(r),this.sharingIntermediaryIndex32Array=n):(n=new Uint16Array(r),this.sharingIntermediaryIndex16Array=n)}for(let e=0;e<r;e++)n[e]=t.vertexOffsetGPU+t.vertexIndexArray[e];this._gl.bufferSubData(this._gl.ELEMENT_ARRAY_BUFFER,d*s.bytesPerIndex,n),d+=r,t.noMeshInRAM&&(t.vertexIndexArray=null)}0}e&&(this.sharingIntermediaryArray=null,this.sharingIntermediaryIndex16Array=null,this.sharingIntermediaryIndex32Array=null)},deallocate:function(e){if(null!=e)for(let t=0;t<e.length;t++)_gl.deleteBuffer(e[t])},setGLContext:function(e,t,i){this._gl=t,this._infos.set(e,i)},dispose:function(e){this._infos.delete(e),0==this._infos.size&&this.reset()}});return UWA.namespace("THREEDS/BufferGPUManager",i)}),define("DS/Visualization/ImageUtils",["DS/Mesh/ThreeJS_Base","DS/GPUFormats/GPUFormats"],function(e,t){"use strict";let i={};var r=null;i.BasisUsage={NOT_BASIS:-1,NO_TRANSCODE:0,RGB:t.RGB_S3TC_DXT1_Format,RGBA:t.RGBA_S3TC_DXT5_Format,RGBHQ:t.RGBA_BPTC_UNORM_Format,NORMAL_MAP:t.REDGREEN_RGTC2_Format,GRAYSCALE:t.RED_RGTC1_Format,BC1:t.RGB_S3TC_DXT1_Format,BC3:t.RGBA_S3TC_DXT5_Format,BC7:t.RGBA_BPTC_UNORM_Format,BC5:t.REDGREEN_RGTC2_Format,BC4:t.RED_RGTC1_Format};var n={__initBasis__:function(e){null===r?require(["DS/BasisLoader/BasisLoader"],function(t){(r=t)(function(){e()})}):r(function(){e()})}};i.Utils=n;var a=function(t,i,r,n,a,s){var o=r.s3tcSupport,l=r.astcSupport,h=r.etcSupport,c=r.etc1Support,d=r.pvrtcSupport,u=r.rgtcSupport,p=r.bptcSupport,f=r.basisUsage,g=!1;switch(f){case 0:return t.textureFormat=e.RGBAFormat,t.transcodeFormat=i.cTFRGBA32,void(t.textureType=e.UnsignedByteType);case e.RGB_S3TC_DXT1_Format:if(o)return t.textureFormat=f,void(t.transcodeFormat=i.cTFBC1_RGB);break;case e.RGBA_S3TC_DXT5_Format:if(o)return t.textureFormat=f,void(t.transcodeFormat=i.cTFBC3_RGBA);break;case e.RED_RGTC1_Format:if(u)return t.textureFormat=f,void(t.transcodeFormat=i.cTFBC4_R);g=!0;break;case e.REDGREEN_RGTC2_Format:if(u)return t.textureFormat=f,void(t.transcodeFormat=i.cTFBC5_RG);g=!0;break;case e.RGBA_BPTC_UNORM_Format:if(p)return t.textureFormat=f,void(t.transcodeFormat=n?i.cTFBC7_M5_RGBA:i.cTFBC7_M6_RGB);if(o)return t.textureFormat=n?e.RGBA_S3TC_DXT5_Format:e.RGB_S3TC_DXT1_Format,void(t.transcodeFormat=n?i.cTFBC3_RGBA:i.cTFBC1_RGB);g=!0}if(l)return t.textureFormat=e.RGBA_ASTC_4x4_Format,void(t.transcodeFormat=i.cTFASTC_4x4_RGBA);if(d)if(t.textureFormat=e.RGB_PVRTC_4BPPV1_Format,t.transcodeFormat=i.cTFPVRTC1_4_RGB,n&&(t.textureFormat=e.RGBA_PVRTC_4BPPV1_Format,t.transcodeFormat=i.cTFPVRTC1_4_RGBA),0!=(a&a-1)||0!=(s&s-1))console.error("ERROR: PVRTC1 requires square power of 2 textures");else{if(a==s)return;console.error("ERROR: PVRTC1 requires square power of 2 textures")}else{if(c&&!n)return t.textureFormat=e.RGB_ETC1_Format,void(t.transcodeFormat=i.cTFETC1_RGB);if(h)return t.textureFormat=e.RGBA8_ETC2_EAC_Format,void(t.transcodeFormat=i.cTFETC2_RGBA)}g?(e.VisualizationTraces.info("No supported compression format for basis/ktx2, rgba 8888 fallback"),t.textureFormat=e.RGBAFormat,t.transcodeFormat=i.cTFRGBA32,t.textureType=e.UnsignedByteType):n?(e.VisualizationTraces.info("No supported compression format for basis/ktx2, rgba 4444 fallback"),t.textureFormat=e.RGBAFormat,t.transcodeFormat=i.cTFRGBA4444,t.textureType=e.UnsignedShort4444Type):(e.VisualizationTraces.info("No supported compression format for basis/ktx2, rgb ushort565 fallback"),t.textureFormat=e.RGBFormat,t.transcodeFormat=i.cTFRGB565,t.textureType=e.UnsignedShort565Type)},s=function(e,t,i,r,n){var a=document.createElement("canvas");a.width=t,a.height=i;var s=a.getContext("2d"),o=s.getImageData(0,0,t,i);o.data.set(new Uint8ClampedArray(e)),s.putImageData(o,0,0);var l=document.createElement("canvas"),h=l.getContext("2d");return l.width=r,l.height=n,h.drawImage(a,0,0,t,i,0,0,r,n),o=h.getImageData(0,0,r,n),new Uint8Array(o.data)};n.loadKTX2Texture=function(t,i,o,l,h,c,d){var u,p=!!e.supportedExtensions.compressedTexturesS3TC,f=!!e.supportedExtensions.compressedTexturesRGTC,g=!!e.supportedExtensions.compressedTexturesBPTC,m=!!e.supportedExtensions.compressedTexturesASTC,v=!!e.supportedExtensions.compressedTexturesETC,y=!!e.supportedExtensions.compressedTexturesETC1,S=!!e.supportedExtensions.compressedTexturesPVRTC,_=new e.CompressedTexture;return _.image={},_.loadEndStatus=d?e.AssetLoadingStatus.PAUSED:e.AssetLoadingStatus.LOADING,i&&(_.mapping=i),null===c||c===e.BasisUsage.NOT_BASIS?(console.error("Missing required format parameter"),_):(u=function(i,r){if(!i)return console.error("Missing KTX2File in BasisLoader"),void(l&&l());!function(t,i,r,o,l,h,c,d,u){var p=function(o){var l=function(t,i){console.warn(i),r.loadEndStatus=e.AssetLoadingStatus.ERROR,c&&c(),t.close(),t.delete()},d=new t(new Uint8Array(o));if(d.isValid()){var p=d.getLevels();if(p<1)l(d,"No levels in .ktx2 file");else{var f=d.getFaces();if(f>1)if(6!==f)f=1;else{r.extraFaces=new Array(5);for(var g=0;g<5;g++)r.extraFaces[g]=new e.Texture.Face(null,[])}if(d.getHeader().pixelDepth>0)l(d,"Non 2D textures are not supported in .ktx2 files");else if(d.getLayers()>1)l(d,"Array textures are not supported in .ktx2 files");else if(d.startTranscoding()){var m=d.getWidth(),v=d.getHeight(),y={textureFormat:0,transcodeFormat:0,textureType:0},S=d.getHasAlpha();a(y,i,u,S,m,v);var _=!1;n.is_pow2(m)&&n.is_pow2(v)||(console.error("Non power of two compressed ktx2 texture, full rgba 8888 decompression for resizing"),_=!0,y.textureFormat=e.RGBAFormat,y.transcodeFormat=i.cTFRGBA32,y.textureType=e.UnsignedByteType),r.format=y.textureFormat,0!==y.textureType&&(r.flipY=0===u.basisUsage,r.type=y.textureType),r.sRGB=2===d.getDFDTransferFunc(),r.premultipliedAlpha=(1&d.getDFDFlags())>0;for(var x=0;x<f;x++){const t=0===x?r.mipmaps:r.extraFaces[x-1].mipmaps;for(var b=0;b<p;b++){var w=d.getImageLevelInfo(b,0,x);m=w.origWidth,v=w.origHeight;var M={data:null,width:0,height:0};t.push(M);var C=d.getImageTranscodedSizeInBytes(b,0,0,y.transcodeFormat),P=new Uint8Array(C);if(!d.transcodeImage(P,b,0,0,y.transcodeFormat,S,-1,-1))return void l(d,"transcodeImage failed");var E=m>=4?m+3&-4:m,A=v>=4?v+3&-4:v;M.width=E,M.height=A,_?n.is_pow2(m)&&n.is_pow2(v)?M.data=P:(e.VisualizationTraces.info("Resizing ktx2 texture to power of two"),M.width=n.nearest_smaller_pow2(m),M.height=n.nearest_smaller_pow2(v),M.data=s(P,m,v,M.width,M.height)):y.textureType===e.UnsignedShort565Type||y.textureType===e.UnsignedShort4444Type?M.data=new Uint16Array(P.buffer):M.data=P}}for(d.close(),d.delete(),r.loadEndStatus=e.AssetLoadingStatus.READY,r.needsUpdate=!0,h&&h(r),g=0;g<r.onLoadCallbacks.length;g++)r.onLoadCallbacks[g](r)}else l(d,"startTranscoding failed")}}else l(d,"Invalid .ktx2 file")};if("string"==typeof o){var f=new XMLHttpRequest;f.withCredentials=!!l,f.responseType="arraybuffer",f.open("GET",o,!0),f.onload=function(){n.nbTexturesBeingLoaded--,p(f.response)},f.onerror=function(){r.loadEndStatus=e.AssetLoadingStatus.ERROR,c&&c(),n.nbTexturesBeingLoaded--},d?(r.loadEndStatus=e.AssetLoadingStatus.PAUSED,r.onRequest=function(){n.nbTexturesBeingLoaded++,r.loadEndStatus=e.AssetLoadingStatus.LOADING,f.send(null),r.onRequest=null}):(n.nbTexturesBeingLoaded++,r.loadEndStatus=e.AssetLoadingStatus.LOADING,f.send(null))}else{if(!(o instanceof Uint8Array))return void console.error("Invalid ktx2 data: returning empty texture");p(o.buffer)}}(i,r,_,t,h,o,l,d,{s3tcSupport:p,astcSupport:m,etc1Support:y,etcSupport:v,pvrtcSupport:S,rgtcSupport:f,bptcSupport:g,basisUsage:c})},null===r?require(["DS/BasisLoader/BasisLoader"],function(e){(r=e)(function(e){u(e.KTX2File,e.BasisFormat)})}):r(function(e){u(e.KTX2File,e.BasisFormat)}),_)};n.loadBasisTexture=function(t,i,o,l,h,c,d,u){var p,f=!!e.supportedExtensions.compressedTexturesS3TC,g=!!e.supportedExtensions.compressedTexturesRGTC,m=!!e.supportedExtensions.compressedTexturesBPTC,v=!!e.supportedExtensions.compressedTexturesASTC,y=!!e.supportedExtensions.compressedTexturesETC,S=!!e.supportedExtensions.compressedTexturesETC1,_=!!e.supportedExtensions.compressedTexturesPVRTC,x=u||new e.CompressedTexture;return x.loadEndStatus=d?e.AssetLoadingStatus.PAUSED:e.AssetLoadingStatus.LOADING,x.image={},i&&(x.mapping=i),null===c||c===e.BasisUsage.NOT_BASIS?(console.error("Missing required format parameter"),x):(p=function(i,r){if(!i)return console.error("Missing BasisFile in BasisLoader"),void(l&&l());!function(t,i,r,o,l,h,c,d,u){var p=function(o){var l=function(t,i){console.warn(i),r.loadEndStatus=e.AssetLoadingStatus.ERROR,c&&c(),t.close(),t.delete()},d=new t(new Uint8Array(o)),p=d.getNumImages(),f=d.getNumLevels(0);if(p&&f)if(d.startTranscoding()){var g=d.getImageWidth(0,0),m=d.getImageHeight(0,0),v={textureFormat:0,transcodeFormat:0,textureType:0},y=d.getHasAlpha();a(v,i,u,y,g,m);var S=!1;n.is_pow2(g)&&n.is_pow2(m)||(console.error("Non power of two compressed basis texture, full rgba 8888 decompression for resizing"),S=!0,v.textureFormat=e.RGBAFormat,v.transcodeFormat=i.cTFRGBA32,v.textureType=e.UnsignedByteType),r.format=v.textureFormat,0!==v.textureType&&(r.flipY=0===u.basisUsage,r.type=v.textureType);for(var _=0;_<f;_++){g=d.getImageWidth(0,_),m=d.getImageHeight(0,_);var x={data:null,width:0,height:0};r.mipmaps.push(x);var b=d.getImageTranscodedSizeInBytes(0,_,v.transcodeFormat),w=new Uint8Array(b);if(!d.transcodeImage(w,0,_,v.transcodeFormat,0,y))return void l(d,"transcodeImage failed");var M=g>=4?g+3&-4:g,C=m>=4?m+3&-4:m;x.width=M,x.height=C,S?n.is_pow2(g)&&n.is_pow2(m)?x.data=w:(e.VisualizationTraces.info("Resizing basis texture to power of two"),x.width=n.nearest_smaller_pow2(g),x.height=n.nearest_smaller_pow2(m),x.data=s(w,g,m,x.width,x.height)):v.textureType===e.UnsignedShort565Type||v.textureType===e.UnsignedShort4444Type?x.data=new Uint16Array(w.buffer):x.data=w}d.close(),d.delete(),r.loadEndStatus=e.AssetLoadingStatus.READY,r.needsUpdate=!0,h&&h(r);for(var P=0;P<r.onLoadCallbacks.length;P++)r.onLoadCallbacks[P](r)}else l(d,"startTranscoding failed");else l(d,"Invalid .basis file")};if("string"==typeof o){var f=new XMLHttpRequest;f.withCredentials=!!l,f.responseType="arraybuffer",f.open("GET",o,!0),f.onload=function(){n.nbTexturesBeingLoaded--,p(f.response)},f.onerror=function(){r.loadEndStatus=e.AssetLoadingStatus.ERROR,c&&c(),n.nbTexturesBeingLoaded--},d?(r.loadEndStatus=e.AssetLoadingStatus.PAUSED,r.onRequest=function(){n.nbTexturesBeingLoaded++,r.loadEndStatus=e.AssetLoadingStatus.LOADING,f.send(null),r.onRequest=null}):(n.nbTexturesBeingLoaded++,r.loadEndStatus=e.AssetLoadingStatus.LOADING,f.send(null))}else{if(!(o instanceof Uint8Array))return void console.error("Invalid basis data: returning empty texture");p(o.buffer)}}(i,r,x,t,h,o,l,d,{s3tcSupport:f,astcSupport:v,etc1Support:S,etcSupport:y,pvrtcSupport:_,rgtcSupport:g,bptcSupport:m,basisUsage:c})},null===r?require(["DS/BasisLoader/BasisLoader"],function(e){(r=e)(function(e){p(e.BasisFile,e.BasisFormat)})}):r(function(e){p(e.BasisFile,e.BasisFormat)}),x)},n.nbTexturesBeingLoaded=0,n.crossOrigin="anonymous",n.is_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.floor(t)===t},n.nearest_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(t))},n.nearest_greater_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.ceil(t))},n.nearest_smaller_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.floor(t))},n._loadTextureWithProxy=function(t,i,r,n,a,s,o,l){return window.ds&&window.ds.env&&"MOBILE"===window.ds.env&&(t=UWA.Data.proxifyUrl(t,{proxy:"passport"})),e.ImageUtils.loadTexture(t,i,r,n,a,s,o,l)},n.loadTexture=function(t,i,r,a,s,o,l,h){var c=this,d=document.createElement("canvas");d.width=16,d.height=16;var u=h;u?(u.image=d,u.mapping=i):u=new e.Texture(d,i),u.loadEndStatus=e.AssetLoadingStatus.LOADING;var p=null!=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),f=!t.startsWith("data:");if(p&&f&&(void 0===s||!1===s)){var g={headers:new Object,method:"GET",authentication:"ajax",timeout:36e5,async:!0,type:"blob",onComplete:function(t){var i=URL.createObjectURL(t),s=new Image,l=new e.ImageLoader;l.addEventListener("load",function(t){var i,a;n.nbTexturesBeingLoaded--,u.needsUpdate=!0,u.loadEndStatus=e.AssetLoadingStatus.READY,!o||c.is_pow2(s.width)&&c.is_pow2(s.height)?u.image=s:(i=c.nearest_pow2(s.width),a=c.nearest_pow2(s.height),u.image.width=i,u.image.height=a,u.image.getContext("2d").drawImage(s,0,0,i,a)),r&&r(u);for(var l=0;l<u.onLoadCallbacks.length;l++)u.onLoadCallbacks[l](u)}),l.addEventListener("error",function(t){n.nbTexturesBeingLoaded--,a&&a(t.message),u.loadEndStatus=e.AssetLoadingStatus.ERROR}),l.load(i,s)},onFailure:function(t){n.nbTexturesBeingLoaded--,a&&a(event.message),u.loadEndStatus=e.AssetLoadingStatus.ERROR},onTimeout:function(){n.nbTexturesBeingLoaded--,a&&a(event.message),u.loadEndStatus=e.AssetLoadingStatus.ERROR}};UWA.Data.request(t,g)}else{var m=new Image;null!==s&&(m.crossOrigin=s?"use-credentials":"anonymous");var v=new e.ImageLoader;v.addEventListener("load",function(t){var i,a;n.nbTexturesBeingLoaded--,u.needsUpdate=!0,u.loadEndStatus=e.AssetLoadingStatus.READY,!o||c.is_pow2(m.width)&&c.is_pow2(m.height)?u.image=m:(i=c.nearest_pow2(m.width),a=c.nearest_pow2(m.height),u.image.width=i,u.image.height=a,u.image.getContext("2d").drawImage(m,0,0,i,a)),r&&r(u);for(var s=0;s<u.onLoadCallbacks.length;s++)u.onLoadCallbacks[s](u)}),v.addEventListener("error",function(t){n.nbTexturesBeingLoaded--,a&&a(t.message),u.loadEndStatus=e.AssetLoadingStatus.ERROR}),m.crossOrigin&&(v.crossOrigin=m.crossOrigin),l?(u.loadEndStatus=e.AssetLoadingStatus.PAUSED,u.onRequest=function(){u.loadEndStatus=e.AssetLoadingStatus.LOADING,v.load(t,m),n.nbTexturesBeingLoaded++,u.onRequest=null}):(v.load(t,m),n.nbTexturesBeingLoaded++),u.sourceFile=t}return u},n.loadTexture2=function(e,t,i,r,a){return console.warn("loadTexture2 is deprecated, use loadTexture with forcePowerOfTwo parameter activated"),n.loadTexture(e,t,i,r,a,!0)},n.loadTGATexture=function(t,i,r,a,s,o){var l=new e.DataTexture(new Uint8Array(16),2,2,e.RGBAFormat,e.UnsignedByteType);l.mapping=i;var h=new XMLHttpRequest;return h.onload=function(){n.nbTexturesBeingLoaded--;var t=new Uint8Array(h.response),i=12,a=t[i]+256*t[i+1],s=t[i+=2]+256*t[i+1];i+=4,l.image.data=new Uint8Array(4*a*s);var o=l.image.data;l.image.width=a,l.image.height=s;for(var c=0;c<s;c++)for(var d=0;d<a;d++){var u=c*a+d;o[4*u]=t[i+4*u+2],o[4*u+1]=t[i+4*u+1],o[4*u+2]=t[i+4*u],o[4*u+3]=t[i+4*u+3]}l.loadEndStatus=e.AssetLoadingStatus.READY,l.generateMipmaps=!1,l.needsUpdate=!0,r&&r(l);for(var p=0;p<l.onLoadCallbacks.length;p++)l.onLoadCallbacks[p](l)},h.onerror=function(){a&&a(),n.nbTexturesBeingLoaded--,l.loadEndStatus=e.AssetLoadingStatus.ERROR},o?(l.loadEndStatus=e.AssetLoadingStatus.PAUSED,l.onRequest=function(){l.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,h.open("GET",t,!0),h.responseType="arraybuffer",h.withCredentials=!!s,h.send(null),l.onRequest=null}):(l.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,h.open("GET",t,!0),h.responseType="arraybuffer",h.withCredentials=!!s,h.send(null)),l},n.loadHDRTexture=function(t,i,r,a,s,o,l,h,c,d){var u=d||new e.DataTexture;u.loadEndStatus=e.AssetLoadingStatus.LOADING,u.hdr=!0,u.sRGB=!1,u.mapping=i,u.needsSH=!1,u.shFactorsR=null,u.shFactorsG=null,u.shFactorsB=null;var p=this,f=new XMLHttpRequest;return f.onload=function(){n.nbTexturesBeingLoaded--;var t=f.response,a=n.parseRadianceHDR(t,i,s,o,l);if(!p.is_pow2(a.width)||!p.is_pow2(a.height)){var h=p.nearest_pow2(a.width),c=p.nearest_pow2(a.height);!function(e,t,i,r){if(t){for(var n=new Float32Array(3*i*r),a=(e.width-1)/(i-1),s=(e.height-1)/(r-1),o=0;o<r;o++)for(var l=0;l<i;l++){var h=i*o+l,c=a*l,d=s*o,u=e.width*Math.floor(d)+Math.floor(c);n[3*h]=e.data[3*u],n[3*h+1]=e.data[3*u+1],n[3*h+2]=e.data[3*u+2]}e.data=n,e.width=i,e.height=r}}(a,s,h,c)}u.format=a.format,u.type=a.type,u.image.data=a.data,u.image.width=a.width,u.image.height=a.height,u.loadEndStatus=e.AssetLoadingStatus.READY,u.needsSH&&n.computeSphericalHarmonics(u),u.generateMipmaps=!0,u.needsUpdate=!0,r&&r(u);for(var d=0;d<u.onLoadCallbacks.length;d++)u.onLoadCallbacks[d](u)},f.onerror=function(){u.loadEndStatus=e.AssetLoadingStatus.ERROR,a&&a(),n.nbTexturesBeingLoaded--},c?(u.loadEndStatus=e.AssetLoadingStatus.PAUSED,u.onRequest=function(){u.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,f.open("GET",t,!0),f.responseType="arraybuffer",f.withCredentials=!!h,f.send(null),u.onRequest=null}):(u.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,f.open("GET",t,!0),f.responseType="arraybuffer",f.withCredentials=!!h,f.send(null)),u},n._loadTextureVisu=function(e,t,i,r,a,s,o){var l=require.toUrl("DS/"+e+"/assets/"+t);return n.loadTexture(l,i,r,a,s,o)};return n.streamHDRFormat=function(e,t,i){for(var r=function(e,t){var i=function(e,t,i){for(var r=0;r<t.length;r++)e[i++]=t.charCodeAt(r);return i},r="# Made with Dassault Systemes HDR mipmap roughness generator - TZW",n="-Y "+t+" +X "+e,a=new Uint8Array("#?RADIANCE".length+1+r.length+1+"FORMAT=32-bit_rle_rgbe".length+2+n.length+1+e*t*4),s=0;return s=i(a,"#?RADIANCE",s),a[s++]=10,s=i(a,r,s),a[s++]=10,s=i(a,"FORMAT=32-bit_rle_rgbe",s),a[s++]=10,a[s++]=10,s=i(a,n,s),a[s++]=10,{buffer:a,offset:s,width:e,height:t}}(t,i),n=r.buffer,a=r.offset,s=i-1,o=0;o<i;o++){for(var l=t-1,h=0;h<t;h++){for(var c=0;c<4;c++)n[a+4*(t*o+h)+c]=e[4*(t*s+l)+c];l--}s--}return function(e){for(var t=function(e){for(var t=new Uint8Array(2*e.length),i=0;i<e.length;i++)t[i]=e[i];return t},i=e.offset,r=i,n=new Uint8Array(e.buffer.length),a=0;a<i;a++)n[a]=e.buffer[a];for(var s=new Uint8Array(4+5*e.width),o=0;o<e.height;o++){var l=0;s[l++]=2,s[l++]=2,s[l++]=e.width>>8,s[l++]=255&e.width;for(var h=0;h<4;h++){var c=[];for(a=0;a<e.width;){for(var d=0,u=e.buffer[i+4*(o*e.width+a)+h],p=u;a<e.width&&p===u&&d<127;)d++,a++,u=p,p=e.buffer[i+4*(o*e.width+a)+h];if(d>3){if(c.length){s[l++]=c.length;for(var f=0;f<c.length;f++)s[l++]=c[f];c=[]}s[l++]=128+d,s[l++]=u}else{if(c.length+d>127){for(s[l++]=c.length,f=0;f<c.length;f++)s[l++]=c[f];c=[]}c.push(u),d>1&&c.push(u),d>2&&c.push(u)}}if(c.length)for(s[l++]=c.length,f=0;f<c.length;f++)s[l++]=c[f]}r+l>=n.length&&(n=t(n));for(var g=0;g<l;g++)n[r++]=s[g]}var m=new Uint8Array(r);for(a=0;a<r;a++)m[a]=n[a];e.buffer=m}(r),new Blob([r.buffer],{type:"application/octet-binary"})},n.generateBlankHDRTexture=function(t,i){var r=new e.DataTexture;r.hdr=!0,r.sRGB=!1,r.mapping=new e.LatLongReflectionMapping,r.needsSH=!1,r.shFactorsR=null,r.shFactorsG=null,r.shFactorsB=null,r.format=e.RGBAFormat,r.type=e.UnsignedByteType,r.image.width=t,r.image.height=i,r.loadEndStatus=e.AssetLoadingStatus.READY,r.generateMipmaps=!0,r.needsUpdate=!0;for(var n=new Uint8Array(4*t*i),a=0;a<t*i;a++)n[4*a]=255,n[4*a+1]=255,n[4*a+2]=255,n[4*a+3]=127;return r.image.data=n,r},n.computeSphericalHarmonics=function(t){t.mapping;var i,r,n=t.image.data,a=t.image.width,s=t.image.height;if(void 0!==n){if(null===t.shFactorsR){var o=[];for(i=0;i<3;i++)for(o[i]=[],r=0;r<9;r++)o[i][r]=0;var l=function(e){return Math.abs(e)<1e-4?1:Math.sin(e)/e},h=function(e,t,i,r,s,l){var h,c=4*(a*t+e),d=Math.pow(2,n[c+3]-128);for(h=0;h<3;h++){var u,p=1/256*n[c+h]*d;u=.282095,o[h][0]+=p*u*i,u=.488603,o[h][1]+=p*(u*s)*i,o[h][2]+=p*(u*l)*i,o[h][3]+=p*(u*r)*i,u=1.092548,o[h][4]+=p*(u*r*s)*i,o[h][5]+=p*(u*s*l)*i,o[h][7]+=p*(u*r*l)*i,u=.315392,o[h][6]+=p*(u*(3*l*l-1))*i,u=.546274,o[h][8]+=p*(u*(r*r-s*s))*i}return o};if(t.mapping instanceof e.LatLongReflectionMapping)for(r=0;r<s;r++)for(i=0;i<a;i++){c=i/a,d=r/s,f=Math.PI*(2*c-1),p=Math.PI*d,g=Math.sin(p)*Math.cos(f),m=Math.sin(p)*Math.sin(f),v=Math.cos(p),h(i,r,Math.PI/a*2*(Math.PI/s)*Math.sin(p),g,m,v)}else for(i=0;i<a;i++)for(r=0;r<a;r++){var c,d,u,p,f,g,m,v;d=(a/2-i)/(a/2),c=(r-a/2)/(a/2),(u=Math.sqrt(c*c+d*d))>1||(p=Math.PI*u,f=Math.atan2(d,c),g=Math.sin(p)*Math.cos(f),m=Math.sin(p)*Math.sin(f),v=Math.cos(p),h(i,r,2*Math.PI/a*(2*Math.PI/a)*l(p),g,m,v))}var y=function(){var t,i,r;i=.429043,r=.511664;var n=[];for(n[0]=new e.Matrix4,n[1]=new e.Matrix4,n[2]=new e.Matrix4,t=0;t<3;t++)n[t].elements[0]=i*o[t][8],n[t].elements[1]=i*o[t][4],n[t].elements[2]=i*o[t][7],n[t].elements[3]=r*o[t][3],n[t].elements[4]=i*o[t][4],n[t].elements[5]=-i*o[t][8],n[t].elements[6]=i*o[t][5],n[t].elements[7]=r*o[t][1],n[t].elements[8]=i*o[t][7],n[t].elements[9]=i*o[t][5],n[t].elements[10]=.743125*o[t][6],n[t].elements[11]=r*o[t][2],n[t].elements[12]=r*o[t][3],n[t].elements[13]=r*o[t][1],n[t].elements[14]=r*o[t][2],n[t].elements[15]=.886227*o[t][0]-.247708*o[t][6];return n}();null!==y&&(t.shFactorsR=y[0],t.shFactorsG=y[1],t.shFactorsB=y[2])}}else t.needsSH=!0},n.loadTextureCube=function(t,i,r,a){var s={images:[],loadCount:0},o=new e.Texture;o.loadEndStatus=e.AssetLoadingStatus.LOADING,void 0!==i&&(o.mapping=i),o.flipY=!1;for(var l=0;l<t.length;++l){var h=new Image;s.images[l]=h,h.onload=function(){if(s.loadCount+=1,n.nbTexturesBeingLoaded--,6===s.loadCount){o.loadEndStatus!==e.AssetLoadingStatus.ERROR&&(o.loadEndStatus=e.AssetLoadingStatus.READY),o.needsUpdate=!0,o.image=s.images[0],o.extraFaces=new Array(5);for(var t=1;t<s.images.length;t++)o.extraFaces[t-1]=new e.Texture.Face(s.images[t],null);r&&r(o);for(t=0;t<o.onLoadCallbacks.length;t++)o.onLoadCallbacks[t](o)}},h.onerror=function(){s.loadCount+=1,n.nbTexturesBeingLoaded--,o.loadEndStatus=e.AssetLoadingStatus.ERROR,a&&a()},h.crossOrigin=this.crossOrigin,n.nbTexturesBeingLoaded++,h.src=t[l]}return o},n.parseRadianceHDR=function(t,i,r,n,a){var s,o={data:null,width:0,height:0,format:r?e.RGBFormat:e.RGBAFormat,type:r?e.FloatType:e.UnsignedByteType},l={offset:0,data:new Uint8Array(t)},h="";for(s=0;s<10;s++)h+=String.fromCharCode(l.data[l.offset++]);if("#?RADIANCE"!==h)return o;for(var c,d=0;c=d,10!=(d=l.data[l.offset++])||10!=c;);for(var u="";10!=(d=l.data[l.offset++]);)u+=String.fromCharCode(d);if(null===new RegExp(/[-,+][X,Y]\s+([0-9]+)\s+[-,+][X,Y]\s+([0-9]+)/i).exec(u))return o;o.height=RegExp.$1,o.width=RegExp.$2,o.data=r?new Float32Array(o.width*o.height*3):new Uint8Array(o.width*o.height*4);for(var p=new Uint8Array(4*o.width),f=n?(o.height-1)*(r?3:4)*o.width:0,g=function(e,t){return.00390625*t*e},m=function(e,t,i,r){for(a&&(r+=3*(t-1));t-- >0;){var n=Math.pow(2,e[4*t+3]-128);i[r++]=g(n,e[4*t]),i[r++]=g(n,e[4*t+1]),i[r++]=g(n,e[4*t+2]),a&&(r-=6)}},v=function(e,t,i,r){for(;t-- >0;)i[r++]=e[4*t],i[r++]=e[4*t+1],i[r++]=e[4*t+2],i[r++]=e[4*t+3]},y=function(e,t,i){var r,n;if(t<8||t>32767)return S(e,0,t,i);if(2!==(r=i.data[i.offset]))return S(e,0,t,i);if(i.offset++,e[1]=i.data[i.offset++],e[2]=i.data[i.offset++],r=i.data[i.offset++],2!=e[1]||128&e[2])return e[0]=2,e[3]=r,S(e,1,t-1,i);for(r=0;r<4;r++)for(n=0;n<t;){var a=i.data[i.offset++];if(a>128){a&=127;for(var s=i.data[i.offset++];a--;)e[4*n+r]=s,n++}else for(;a--;)e[4*n+r]=i.data[i.offset++],n++}return!(i.data.length===i.offset)},S=function(e,t,i,r){for(var n,a=0;i>0;)if(e[4*t]=r.data[r.offset++],e[4*t+1]=r.data[r.offset++],e[4*t+2]=r.data[r.offset++],e[4*t+3]=r.data[r.offset++],1===e[4*t]&&1===e[4*t+1]&&1===e[4*t+2]){for(n=e[4*t+3]<<a;n>0;n--)e[4*t]=e[4*(t-1)],e[4*t+1]=e[4*(t-1)+1],e[4*t+2]=e[4*(t-1)+2],e[4*t+3]=e[4*(t-1)+3],t++,i--;a+=8}else t++,i--,a=0;return!0},_=o.height-1;_>=0;_--)y(p,o.width,l),r?(m(p,o.width,o.data,f),n?f-=3*o.width:f+=3*o.width):(v(p,o.width,o.data,f),f+=4*o.width);return o},n.streamDDS=function(t){function i(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}for(var r=i("DXT1"),n=i("DXT3"),a=i("DXT5"),s=0,o=0;o<t.mipmaps.length;o++)s+=t.mipmaps[o].data.length;var l=new ArrayBuffer(128+s),h=new Int32Array(l,0,32);switch(h[0]=542327876,h[1]=124,h[2]=659463,h[3]=t.image.height,h[4]=t.image.width,h[5]=65536,h[7]=t.mipmaps.length,h[19]=32,h[20]=4,t.format){case e.RGB_S3TC_DXT1_Format:h[21]=r;break;case e.RGB_S3TC_DXT3_Format:h[21]=n;break;case e.RGB_S3TC_DXT5_Format:h[21]=a;break;case e.RGBAFormat:h[20]|=1;case e.RGBFormat:h[20]|=64,h[23]=255,h[24]=65280,h[25]=16711680,h[26]=4278190080;break;default:return void console.error("ImageUtils.streamDDS(): Unsupported FourCC code: ")}h[27]=4198408;var c=new Uint8Array(l,128,s),d=0;for(o=0;o<t.mipmaps.length;o++){for(var u=t.mipmaps[o].data,p=0;p<u.length;p++)c[d+p]=u[p];d+=u.length}return l},n.crossOriginPolicy=!0,n.loadTextureFromFormat=function(e,t,i,r){var a;return"dds"===t?a=n.loadCompressedTexture(blobUrl,null,function(){i&&i(a)},function(){r&&r(a)},!0):"hdr"===t?a=n.loadHDRTexture(blobUrl,null,function(){i&&i(a)},function(){r&&r(a)},!0,!1,!0):(a=n.loadTexture(blobUrl,null,function(){i&&i(a)},function(){r&&r(a)},void 0,!0)).flipY=!0,a},n.loadCompressedTexture=function(t,i,r,a,s,o,l){var h=l||new e.CompressedTexture;h.mapping=i;var c=new XMLHttpRequest;return c.onload=function(){n.nbTexturesBeingLoaded--;var t=c.response,i=n.parseDDS(t,!0,s);if(h.sRGB=i.sRGB,h.format=i.format,i.type&&(h.type=i.type),h.width=i.width,h.height=i.height,i.isCubemap){h.image={data:null,width:i.width,height:i.height};var a=i.mipmaps.length/i.mipmapCount;h.extraFaces=new Array(a-1);for(var o=0;o<a;o++){var l=h;o>0&&(l=new e.Texture.Face(null,[]),h.extraFaces[o-1]=l);for(var d=0;d<i.mipmapCount;d++)l.mipmaps.push(i.mipmaps[o*i.mipmapCount+d])}var u=h.extraFaces[2];h.extraFaces[2]=h.extraFaces[1],h.extraFaces[1]=u}else h.mipmaps=i.mipmaps,h.image.width=i.width,h.image.height=i.height;h.generateMipmaps=!1,(!h.mipmaps||h.mipmaps&&h.mipmaps.length<2)&&(1003!=h.magFilter&&1006!=h.magFilter&&(h.magFilter=1006),1003!=h.minFilter&&1006!=h.minFilter&&(h.minFilter=1006)),h.needsUpdate=!0,h.loadEndStatus=e.AssetLoadingStatus.READY,r&&r(h);for(d=0;d<h.onLoadCallbacks.length;d++)h.onLoadCallbacks[d](h)},o?(h.loadEndStatus=e.AssetLoadingStatus.PAUSED,h.onRequest=function(){h.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,c.open("GET",t,!0),c.responseType="arraybuffer",c.send(null),h.onRequest=null}):(h.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,c.open("GET",t,!0),c.responseType="arraybuffer",c.send(null)),h},n.loadCompressedTextureFromBuffer=function(t,i){var r=new e.CompressedTexture;r.loadEndStatus=e.AssetLoadingStatus.READY,r.mapping=i;var a=n.parseDDS(t,!0);return r.format=a.format,r.mipmaps=a.mipmaps,r.image.width=a.width,r.image.height=a.height,r.generateMipmaps=!1,r.needsUpdate=!0,r},n.parseDDS=function(t,i,r){void 0===r&&(r=!0);var a={mipmaps:[],width:0,height:0,sRGB:!1,format:null,mipmapCount:1};function s(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function o(e){var t=e[4];e[4]=e[7],e[7]=t,t=e[5],e[5]=e[6],e[6]=t}function l(e){var t=e[4];e[4]=e[5],e[5]=t}function h(e){var t=e[0];e[0]=e[6],e[6]=t,t=e[1],e[1]=e[7],e[7]=t,t=e[2],e[2]=e[4],e[4]=t,t=e[3],e[3]=e[5],e[5]=t,o(e.subarray(8,16))}function c(e){var t=e[0];e[0]=e[2],e[2]=t,t=e[1],e[1]=e[3],e[3]=t,o(e.subarray(8,16))}function d(e){var t=e[2]+256*(e[3]+256*e[4]),i=e[5]+256*(e[6]+256*e[7]),r=(4095&t)<<12|(16773120&t)>>12,n=(4095&i)<<12|(16773120&i)>>12;e[2]=255&n,e[3]=(65280&n)>>8,e[4]=(16711680&n)>>8,e[5]=255&r,e[6]=(65280&r)>>8,e[7]=(16711680&r)>>8,o(e.subarray(8,16))}function d(e){var t=e[2]+256*(e[3]+256*e[4]),i=e[5]+256*(e[6]+256*e[7]),r=(4095&t)<<12|(16773120&t)>>12,n=(4095&i)<<12|(16773120&i)>>12;e[2]=255&n,e[3]=(65280&n)>>8,e[4]=(16711680&n)>>8,e[5]=255&r,e[6]=(65280&r)>>8,e[7]=(16711680&r)>>8,o(e.subarray(8,16))}function u(e){var t=(4095&e[2]+256*(e[3]+256*e[4]))<<12;e[2]=255&t,e[3]=(65280&t)>>8,e[4]=(16711680&t)>>8,o(e.subarray(8,16))}function p(e,t){var i;for(i=0;i<e.length;i++)e[i]=t[i]}var f=s("DXT1"),g=s("DXT3"),m=s("DXT5"),v=s("DX10"),y=new Int32Array(t,0,36);if(542327876!==y[0])return console.error("ImageUtils.parseDDS(): Invalid magic number in DDS header"),a;var S,_,x=y[23],b=y[24],w=y[25],M=y[26],C=y[21];if(C===v){var P=y[32];(4&y[34]||6===y[35])&&(a.isCubemap=!0),28===P?(a.format=e.RGBAFormat,S=4):6===P&&(a.format=e.RGBFormat,S=12,a.type=e.FloatType,r=!1)}else{switch(C){case f:S=8,a.format=e.RGB_S3TC_DXT1_Format;break;case g:S=16,a.format=e.RGBA_S3TC_DXT3_Format;break;case m:S=16,a.format=e.RGBA_S3TC_DXT5_Format;break;default:if(r=!1,116===C)a.format=e.RGBAFormat,a.type=e.FloatType,S=16;else if(113==C);else if(32===y[22]&&16711680&y[23]&&65280&y[24]&&255&y[25]&&4278190080&y[26])a.format=e.RGBAFormat,S=4;else{if(!(64&y[20]))return console.error("ImageUtils.parseDDS(): Unsupported FourCC code: ",(_=C,String.fromCharCode(255&_,_>>8&255,_>>16&255,_>>24&255))),a;1&y[20]?(a.format=e.RGBAFormat,S=4):(a.format=e.RGBFormat,S=3)}}var E=y[28];if(a.isCubemap=!!(512&E),a.isCubemap&&(!(1024&E)||!(2048&E)||!(4096&E)||!(8192&E)||!(16384&E)||!(32768&E)))return console.error("THREE.DDSLoader.parse: Incomplete cubemap faces"),a}a.mipmapCount=1,131072&y[2]&&!1!==i&&(a.mipmapCount=Math.max(1,y[7])),a.width=y[4],a.height=y[3];var A=y[1]+4;C===v&&(A+=20);for(var T=a.isCubemap?6:1,D=C===f||C===g||C===m,I=0;I<T;I++){var R=a.width,O=a.height,L=R*O;D&&(L=Math.ceil(R/4)*Math.ceil(O/4)),L*=S;for(var V=0;V<a.mipmapCount;V++){var F=null;D?(A+L>t.byteLength&&console.log("dxterror"),F=new Uint8Array(t,A,L)):F=16===S?new Float32Array(t,A,L/4):12===S?new Float32Array(t,A,L/4):0===C&&3!==S?n.getImageFromColorMasks(t,A,L,x,b,w,M):n.loadARGBMip(t,A,R,O,S);var B={data:F,width:R,height:O};a.mipmaps.push(B),A+=L,(R/=2)<1&&(R=1),(O/=2)<1&&(O=1),L=D?Math.ceil(R/4)*Math.ceil(O/4):R*O,L*=S}}return r&&function(t,i,r,n,a){var s,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A;switch(n){case e.RGB_S3TC_DXT1_Format:g=8,s=o,f=l;break;case e.RGBA_S3TC_DXT3_Format:g=16,s=h,f=c;break;case e.RGBA_S3TC_DXT5_Format:g=16,s=d,f=u;break;default:return console.error("flip dds error"),a}for(m=t,v=i,x=0;x<r&&(w=a[x].data,_=(y=Math.floor((m+3)/4))*(S=Math.floor((v+3)/4)),1!=v);++x){if(2==v)for(E=0;E<y;E++)f(w.subarray(b,E*g)),b=+g;else{for(b=0,E=1;E<=_;E++)s(w.subarray(b,E*g)),b+=g;A=g*y,P=new Uint8Array(A);for(var T=0;T<S/2;++T)M=w.subarray(T*A,(T+1)*A),C=w.subarray((S-T-1)*A,(S-T)*A),p(P,M),p(M,C),p(C,P)}(m/=2)<1&&(t=1),(v/=2)<1&&(i=1)}}(a.width,a.height,a.mipmapCount,a.format,a.mipmaps),a},n.loadARGBMip=function(e,t,i,r,n){for(var a=i*r*n,s=(4-n*i%4)%4,o=a+r*s,l=new Uint8Array(e,t,a),h=new Uint8Array(o),c=0,d=0,u=0;u<r;u++){for(var p=0;p<i;p++){var f,g=l[d],m=l[++d],v=l[++d];d++,4===n&&(f=l[d],d++),h[c]=g,h[++c]=m,h[++c]=v,c++,4===n&&(h[c]=f,c++)}c+=s}return h},n.getImageFromColorMasks=function(e,t,i,r,a,s,o){for(var l=new Int32Array(e,t,i/4),h=new Uint8Array(i),c=n.computeMaskShift(r),d=n.computeMaskShift(a),u=n.computeMaskShift(s),p=n.computeMaskShift(o),f=0;f<i/4;f++){var g=l[f];h[4*f]=(g&r)>>c,h[4*f+1]=(g&a)>>d,h[4*f+2]=(g&s)>>u,h[4*f+3]=(g&o)>>p}return h},n.computeMaskShift=function(e){for(var t=e,i=0;!(1&t);)t>>=1,i++;return i},n.loadVideoTexture=function(t,i){var r=new e.Texture(t,i);return r.forceUpdate=!0,r.generateMipmaps=!1,r.loadEndStatus=e.AssetLoadingStatus.READY,r},i}),define("DS/Visualization/Curves",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";let t={LineCurve:function(e,t){this.v1=e,this.v2=t}};return t.LineCurve.prototype=Object.create(e.Curve.prototype),t.LineCurve.prototype.getPoint=function(e){var t=this.v2.clone().sub(this.v1);return t.multiplyScalar(e).add(this.v1),t},t.LineCurve.prototype.getPointAt=function(e){return this.getPoint(e)},t.LineCurve.prototype.getTangent=function(e){return this.v2.clone().sub(this.v1).normalize()},t.QuadraticBezierCurve=function(e,t,i){this.v0=e,this.v1=t,this.v2=i},t.QuadraticBezierCurve.prototype=Object.create(e.Curve.prototype),t.QuadraticBezierCurve.prototype.getPoint=function(t){var i,r;return i=e.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x),r=e.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y),new e.Vector2(i,r)},t.QuadraticBezierCurve.prototype.getTangent=function(t){var i,r;i=e.Curve.Utils.tangentQuadraticBezier(t,this.v0.x,this.v1.x,this.v2.x),r=e.Curve.Utils.tangentQuadraticBezier(t,this.v0.y,this.v1.y,this.v2.y);var n=new e.Vector2(i,r);return n.normalize(),n},t.CubicBezierCurve=function(e,t,i,r){this.v0=e,this.v1=t,this.v2=i,this.v3=r},t.CubicBezierCurve.prototype=Object.create(e.Curve.prototype),t.CubicBezierCurve.prototype.getPoint=function(t){var i,r;return i=e.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),r=e.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y),new e.Vector2(i,r)},t.CubicBezierCurve.prototype.getTangent=function(t){var i,r;i=e.Curve.Utils.tangentCubicBezier(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),r=e.Curve.Utils.tangentCubicBezier(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y);var n=new e.Vector2(i,r);return n.normalize(),n},t.SplineCurve=function(e){this.points=null==e?[]:e},t.SplineCurve.prototype=Object.create(e.Curve.prototype),t.SplineCurve.prototype.getPoint=function(t){var i,r,n,a=new e.Vector2,s=[],o=this.points;return n=(i=(o.length-1)*t)-(r=Math.floor(i)),s[0]=0==r?r:r-1,s[1]=r,s[2]=r>o.length-2?o.length-1:r+1,s[3]=r>o.length-3?o.length-1:r+2,a.x=e.Curve.Utils.interpolate(o[s[0]].x,o[s[1]].x,o[s[2]].x,o[s[3]].x,n),a.y=e.Curve.Utils.interpolate(o[s[0]].y,o[s[1]].y,o[s[2]].y,o[s[3]].y,n),a},t.EllipseCurve=function(e,t,i,r,n,a,s){this.aX=e,this.aY=t,this.xRadius=i,this.yRadius=r,this.aStartAngle=n,this.aEndAngle=a,this.aClockwise=s},t.EllipseCurve.prototype=Object.create(e.Curve.prototype),t.EllipseCurve.prototype.getPoint=function(t){var i=this.aEndAngle-this.aStartAngle;this.aClockwise||(t=1-t);var r=this.aStartAngle+t*i,n=this.aX+this.xRadius*Math.cos(r),a=this.aY+this.yRadius*Math.sin(r);return new e.Vector2(n,a)},t.LineCurve3=e.Curve.create(function(e,t){this.v1=e,this.v2=t},function(t){var i=new e.Vector3;return i.subVectors(this.v2,this.v1),i.multiplyScalar(t),i.add(this.v1),i}),t.QuadraticBezierCurve3=e.Curve.create(function(e,t,i){this.v0=e,this.v1=t,this.v2=i},function(t){var i,r,n;return i=e.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x),r=e.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y),n=e.Shape.Utils.b2(t,this.v0.z,this.v1.z,this.v2.z),new e.Vector3(i,r,n)}),t.CubicBezierCurve3=e.Curve.create(function(e,t,i,r){this.v0=e,this.v1=t,this.v2=i,this.v3=r},function(t){var i,r,n;return i=e.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),r=e.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y),n=e.Shape.Utils.b3(t,this.v0.z,this.v1.z,this.v2.z,this.v3.z),new e.Vector3(i,r,n)}),t.SplineCurve3=e.Curve.create(function(e){this.points=null==e?[]:e},function(t){var i,r,n,a=new e.Vector3,s=[],o=this.points;n=(i=(o.length-1)*t)-(r=Math.floor(i)),s[0]=0==r?r:r-1,s[1]=r,s[2]=r>o.length-2?o.length-1:r+1,s[3]=r>o.length-3?o.length-1:r+2;var l=o[s[0]],h=o[s[1]],c=o[s[2]],d=o[s[3]];return a.x=e.Curve.Utils.interpolate(l.x,h.x,c.x,d.x,n),a.y=e.Curve.Utils.interpolate(l.y,h.y,c.y,d.y,n),a.z=e.Curve.Utils.interpolate(l.z,h.z,c.z,d.z,n),a}),e.ClosedSplineCurve3=e.Curve.create(function(e){this.points=null==e?[]:e},function(t){var i,r,n,a=new e.Vector3,s=[],o=this.points;return n=(i=(o.length-0)*t)-(r=Math.floor(i)),r+=r>0?0:(Math.floor(Math.abs(r)/o.length)+1)*o.length,s[0]=(r-1)%o.length,s[1]=r%o.length,s[2]=(r+1)%o.length,s[3]=(r+2)%o.length,a.x=e.Curve.Utils.interpolate(o[s[0]].x,o[s[1]].x,o[s[2]].x,o[s[3]].x,n),a.y=e.Curve.Utils.interpolate(o[s[0]].y,o[s[1]].y,o[s[2]].y,o[s[3]].y,n),a.z=e.Curve.Utils.interpolate(o[s[0]].z,o[s[1]].z,o[s[2]].z,o[s[3]].z,n),a}),t.CurvePath=function(){this.curves=[],this.bends=[],this.autoClose=!1},t.CurvePath.prototype=Object.create(e.Curve.prototype),t.CurvePath.prototype.add=function(e){this.curves.push(e)},t.CurvePath.prototype.checkConnection=function(){},t.CurvePath.prototype.closePath=function(){var t=this.curves[0].getPoint(0),i=this.curves[this.curves.length-1].getPoint(1);t.equals(i)||this.curves.push(new e.LineCurve(i,t))},t.CurvePath.prototype.getPoint=function(e){for(var t,i=e*this.getLength(),r=this.getCurveLengths(),n=0;n<r.length;){if(r[n]>=i){var a=1-(r[n]-i)/(t=this.curves[n]).getLength();return t.getPointAt(a)}n++}return null},t.CurvePath.prototype.getLength=function(){var e=this.getCurveLengths();return e[e.length-1]},t.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length)return this.cacheLengths;var e,t=[],i=0,r=this.curves.length;for(e=0;e<r;e++)i+=this.curves[e].getLength(),t.push(i);return this.cacheLengths=t,t},t.CurvePath.prototype.getBoundingBox=function(){var t,i,r,n,a,s,o,l,h,c,d=this.getPoints();t=i=Number.NEGATIVE_INFINITY,n=a=Number.POSITIVE_INFINITY;var u=d[0]instanceof e.Vector3;for(c=u?new e.Vector3:new e.Vector2,l=0,h=d.length;l<h;l++)(o=d[l]).x>t?t=o.x:o.x<n&&(n=o.x),o.y>i?i=o.y:o.y<a&&(a=o.y),u&&(o.z>r?r=o.z:o.z<s&&(s=o.z)),c.add(o);var p={minX:n,minY:a,maxX:t,maxY:i,centroid:c.divideScalar(h)};return u&&(p.maxZ=r,p.minZ=s),p},t.CurvePath.prototype.createPointsGeometry=function(e){var t=this.getPoints(e,!0);return this.createGeometry(t)},t.CurvePath.prototype.createSpacedPointsGeometry=function(e){var t=this.getSpacedPoints(e,!0);return this.createGeometry(t)},t.CurvePath.prototype.createGeometry=function(t){for(var i=new e.Geometry,r=0;r<t.length;r++)i.vertices.push(new e.Vector3(t[r].x,t[r].y,t[r].z||0));return i},t.CurvePath.prototype.addWrapPath=function(e){this.bends.push(e)},t.CurvePath.prototype.getTransformedPoints=function(e,t){var i,r,n=this.getPoints(e);for(t||(t=this.bends),i=0,r=t.length;i<r;i++)n=this.getWrapPoints(n,t[i]);return n},t.CurvePath.prototype.getTransformedSpacedPoints=function(e,t){var i,r,n=this.getSpacedPoints(e);for(t||(t=this.bends),i=0,r=t.length;i<r;i++)n=this.getWrapPoints(n,t[i]);return n},t.CurvePath.prototype.getWrapPoints=function(e,t){var i,r,n,a,s,o,l=this.getBoundingBox();for(i=0,r=e.length;i<r;i++){a=(n=e[i]).x,s=n.y,o=a/l.maxX,o=t.getUtoTmapping(o,a);var h=t.getPoint(o),c=t.getNormalVector(o).multiplyScalar(s);n.x=h.x+c.x,n.y=h.y+c.y}return e},t.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"},t.Path=function(e){t.CurvePath.call(this),this.actions=[],e&&this.fromPoints(e)},t.Path.prototype=Object.create(t.CurvePath.prototype),t.Path.prototype.fromPoints=function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,i=e.length;t<i;t++)this.lineTo(e[t].x,e[t].y)},t.Path.prototype.moveTo=function(t,i){var r=Array.prototype.slice.call(arguments);this.actions.push({action:e.PathActions.MOVE_TO,args:r})},t.Path.prototype.lineTo=function(t,i){var r=Array.prototype.slice.call(arguments),n=this.actions[this.actions.length-1].args,a=n[n.length-2],s=n[n.length-1],o=new e.LineCurve(new e.Vector2(a,s),new e.Vector2(t,i));this.curves.push(o),this.actions.push({action:e.PathActions.LINE_TO,args:r})},t.Path.prototype.quadraticCurveTo=function(t,i,r,n){var a=Array.prototype.slice.call(arguments),s=this.actions[this.actions.length-1].args,o=s[s.length-2],l=s[s.length-1],h=new e.QuadraticBezierCurve(new e.Vector2(o,l),new e.Vector2(t,i),new e.Vector2(r,n));this.curves.push(h),this.actions.push({action:e.PathActions.QUADRATIC_CURVE_TO,args:a})},t.Path.prototype.bezierCurveTo=function(t,i,r,n,a,s){var o=Array.prototype.slice.call(arguments),l=this.actions[this.actions.length-1].args,h=l[l.length-2],c=l[l.length-1],d=new e.CubicBezierCurve(new e.Vector2(h,c),new e.Vector2(t,i),new e.Vector2(r,n),new e.Vector2(a,s));this.curves.push(d),this.actions.push({action:e.PathActions.BEZIER_CURVE_TO,args:o})},t.Path.prototype.splineThru=function(t){var i=Array.prototype.slice.call(arguments),r=this.actions[this.actions.length-1].args,n=r[r.length-2],a=r[r.length-1],s=[new e.Vector2(n,a)];Array.prototype.push.apply(s,t);var o=new e.SplineCurve(s);this.curves.push(o),this.actions.push({action:e.PathActions.CSPLINE_THRU,args:i})},t.Path.prototype.arc=function(e,t,i,r,n,a){var s=this.actions[this.actions.length-1].args,o=s[s.length-2],l=s[s.length-1];this.absarc(e+o,t+l,i,r,n,a)},t.Path.prototype.absarc=function(e,t,i,r,n,a){this.absellipse(e,t,i,i,r,n,a)},t.Path.prototype.ellipse=function(e,t,i,r,n,a,s){var o=this.actions[this.actions.length-1].args,l=o[o.length-2],h=o[o.length-1];this.absellipse(e+l,t+h,i,r,n,a,s)},t.Path.prototype.absellipse=function(t,i,r,n,a,s,o){var l=Array.prototype.slice.call(arguments),h=new e.EllipseCurve(t,i,r,n,a,s,o);this.curves.push(h);var c=h.getPoint(o?1:0);l.push(c.x),l.push(c.y),this.actions.push({action:e.PathActions.ELLIPSE,args:l})},t.Path.prototype.getSpacedPoints=function(e,t){e||(e=40);for(var i=[],r=0;r<e;r++)i.push(this.getPoint(r/e));return i},t.Path.prototype.getPoints=function(t,i){if(this.useSpacedPoints)return console.log("tata"),this.getSpacedPoints(t,i);t=t||12;var r,n,a,s,o,l,h,c,d,u,p,f,g,m,v,y,S,_,x=[];for(r=0,n=this.actions.length;r<n;r++)switch(s=(a=this.actions[r]).action,o=a.args,s){case e.PathActions.MOVE_TO:case e.PathActions.LINE_TO:x.push(new e.Vector2(o[0],o[1]));break;case e.PathActions.QUADRATIC_CURVE_TO:for(l=o[2],h=o[3],u=o[0],p=o[1],x.length>0?(f=(m=x[x.length-1]).x,g=m.y):(f=(m=this.actions[r-1].args)[m.length-2],g=m[m.length-1]),v=1;v<=t;v++)y=v/t,S=e.Shape.Utils.b2(y,f,u,l),_=e.Shape.Utils.b2(y,g,p,h),x.push(new e.Vector2(S,_));break;case e.PathActions.BEZIER_CURVE_TO:for(l=o[4],h=o[5],u=o[0],p=o[1],c=o[2],d=o[3],x.length>0?(f=(m=x[x.length-1]).x,g=m.y):(f=(m=this.actions[r-1].args)[m.length-2],g=m[m.length-1]),v=1;v<=t;v++)y=v/t,S=e.Shape.Utils.b3(y,f,u,c,l),_=e.Shape.Utils.b3(y,g,p,d,h),x.push(new e.Vector2(S,_));break;case e.PathActions.CSPLINE_THRU:m=this.actions[r-1].args;var b=[new e.Vector2(m[m.length-2],m[m.length-1])],w=t*o[0].length;b=b.concat(o[0]);var M=new e.SplineCurve(b);for(v=1;v<=w;v++)x.push(M.getPointAt(v/w));break;case e.PathActions.ARC:var C=o[0],P=o[1],E=o[2],A=o[3],T=o[4],D=!!o[5],I=T-A,R=2*t;for(v=1;v<=R;v++)y=v/R,D||(y=1-y),O=A+y*I,S=C+E*Math.cos(O),_=P+E*Math.sin(O),x.push(new e.Vector2(S,_));break;case e.PathActions.ELLIPSE:C=o[0],P=o[1];var O,L=o[2],V=o[3];A=o[4],T=o[5],D=!!o[6],I=T-A,R=2*t;for(v=1;v<=R;v++)y=v/R,D||(y=1-y),O=A+y*I,S=C+L*Math.cos(O),_=P+V*Math.sin(O),x.push(new e.Vector2(S,_))}var F=x[x.length-1];return Math.abs(F.x-x[0].x)<1e-10&&Math.abs(F.y-x[0].y)<1e-10&&x.splice(x.length-1,1),i&&x.push(x[0]),x},t.Path.prototype.toShapes=function(){var i,r,n,a,s,o=[],l=new t.Path;for(i=0,r=this.actions.length;i<r;i++)s=(n=this.actions[i]).args,(a=n.action)==e.PathActions.MOVE_TO&&0!=l.actions.length&&(o.push(l),l=new t.Path),l[a].apply(l,s);if(0!=l.actions.length&&o.push(l),0==o.length)return[];var h,c,d=[],u=!e.Shape.Utils.isClockWise(o[0].getPoints());if(1==o.length)return h=o[0],(c=new e.Shape).actions=h.actions,c.curves=h.curves,d.push(c),d;if(u)for(c=new e.Shape,i=0,r=o.length;i<r;i++)h=o[i],e.Shape.Utils.isClockWise(h.getPoints())?(c.actions=h.actions,c.curves=h.curves,d.push(c),c=new e.Shape):c.holes.push(h);else{for(i=0,r=o.length;i<r;i++)h=o[i],e.Shape.Utils.isClockWise(h.getPoints())?(c&&d.push(c),(c=new e.Shape).actions=h.actions,c.curves=h.curves):c.holes.push(h);d.push(c)}return d},t}),define("DS/Visualization/OccurrencePath",["UWA/Class"],function(e){"use strict";var t=e.extend({init:function(e){this.path=[],this.setFromArray(e)},getSize:function(){return this.path.length},getNodeName:function(e){return e<0||e>=this.path.length?null:this.path[e]},add:function(e){this.path.push(e)},setFromArray:function(e){var t;if(void 0!==e&&e instanceof Array)for(t=0;t<e.length;t++)""!==e[t]&&this.path.push(e[t])},isEqual:function(e){var t;if(this.path.length!==e.path.length)return!1;for(t=0;t<e.path.length;t++)if(this.path[t]!==e.path[t])return!1;return!0},isIncludedIn:function(e){var t,i,r,n=!1;for(i=0;i<this.path.length;i++){for(t=this.path[i],n=!1,r=0;r<e.path.length;r++)if(t===e.path[r]){n=!0;break}if(!n)return!1}return!0}});return UWA.namespace("THREEDS/OccurrencePath",t)}),define("Visualization/OccurrencePath",["DS/Visualization/OccurrencePath","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/OccurrencePath"),e}),define("DS/Visualization/ThreeDXLoader",["DS/VisuLoaders/ThreeDXLoader"],function(e){"use strict";return e}),define("DS/Visualization/SectionCappingPassCreator",["UWA/Class"],function(e){"use strict";return e.extend({init:function(){},setupViewer:function(e){}})}),define("Visualization/SectionCappingPassCreator",["DS/Visualization/SectionCappingPassCreator","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SectionCappingPassCreator"),e}),define("DS/Visualization/SessionNodesWithSectionProfile",[],function(){"use strict";return null}),define("DS/Visualization/ImplicitGeometries",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t,i,r,n,a,s={};class o{constructor(t,i){this.origin=void 0!==t?t:new e.Vector3,this.axis=void 0!==i?i.normalize():new e.Vector3}at(t,i){return i||(i=new e.Vector3),i.copy(this.axis).multiplyScalar(t).add(this.origin)}parameter(t,i){return(i||new e.Vector3).subVectors(t,this.origin).dot(this.axis)}project(t,i){i||(i=new e.Vector3);const r=this.parameter(t,i);return this.at(r/this.axis.lengthSq(),i)}distanceToSquared(e,t){return this.project(e,t).distanceToSquared(e)}distanceTo(e,t){return Math.sqrt(this.distanceToSquared(e,t))}applyMatrix4(e){return this.origin.applyMatrix4(e),this.axis.transformDirection(e),this}clone(){return new o(this.origin,this.axis)}}return s.InfiniteLine3=o,s.Line3=function(t,i){this.start=void 0!==t?t:new e.Vector3,this.end=void 0!==i?i:new e.Vector3},s.Line3.prototype={constructor:s.Line3,set:function(e,t){return this.start.copy(e),this.end.copy(t),this},copy:function(e){return this.start.copy(e.start),this.end.copy(e.end),this},center:function(t){return(t||new e.Vector3).addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(t){return(t||new e.Vector3).subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(t,i){var r=i||new e.Vector3;return this.delta(r).multiplyScalar(t).add(this.start)},closestPointToPointParameter:(t=new e.Vector3,i=new e.Vector3,function(r,n){t.subVectors(r,this.start),i.subVectors(this.end,this.start);var a=i.dot(i),s=i.dot(t)/a;return n&&(s=e.Math.clamp(s,0,1)),s}),closestPointToPoint:function(t,i,r){var n=this.closestPointToPointParameter(t,i),a=r||new e.Vector3;return this.delta(a).multiplyScalar(n).add(this.start)},applyMatrix4:function(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this},equals:function(e){return e.start.equals(this.start)&&e.end.equals(this.end)},clone:function(){return(new s.Line3).copy(this)}},s.Box2=function(t,i){this.min=void 0!==t?t:new e.Vector2(1/0,1/0),this.max=void 0!==i?i:new e.Vector2(-1/0,-1/0)},s.Box2.prototype={constructor:s.Box2,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){if(e.length>0){var t=e[0];this.min.copy(t),this.max.copy(t);for(var i=1,r=e.length;i<r;i++)(t=e[i]).x<this.min.x?this.min.x=t.x:t.x>this.max.x&&(this.max.x=t.x),t.y<this.min.y?this.min.y=t.y:t.y>this.max.y&&(this.max.y=t.y)}else this.makeEmpty();return this},setFromCenterAndSize:(r=new e.Vector2,function(e,t){var i=r.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}),copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},singlePoint:function(){return this.max.x<=this.min.x&&this.max.y<=this.min.y},center:function(t){return(t||new e.Vector2).addVectors(this.min,this.max).multiplyScalar(.5)},size:function(t){return(t||new e.Vector2).subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y},getParameter:function(t){return new e.Vector2((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))},isIntersectionBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)},clampPoint:function(t,i){return(i||new e.Vector2).copy(t).clamp(this.min,this.max)},distanceToPoint:function(){var t=new e.Vector2;return function(e){return t.copy(e).clamp(this.min,this.max).sub(e).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)},clone:function(){return(new s.Box2).copy(this)}},s.Box3=function(t,i){this.min=void 0!==t?t:new e.Vector3(1/0,1/0,1/0),this.max=void 0!==i?i:new e.Vector3(-1/0,-1/0,-1/0)},s.Box3.prototype={constructor:s.Box3,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setValues:function(e,t,i,r,n,a){this.min.x=e,this.min.y=t,this.min.z=i,this.max.x=r,this.max.y=n,this.max.z=a},setFromPoints:function(e){if(e.length>0){var t=e[0];this.min.copy(t),this.max.copy(t);for(var i=1,r=e.length;i<r;i++)(t=e[i]).x<this.min.x?this.min.x=t.x:t.x>this.max.x&&(this.max.x=t.x),t.y<this.min.y?this.min.y=t.y:t.y>this.max.y&&(this.max.y=t.y),t.z<this.min.z?this.min.z=t.z:t.z>this.max.z&&(this.max.z=t.z)}else this.makeEmpty();return this},setFromCenterAndSize:function(){var t=new e.Vector3;return function(e,i){var r=t.copy(i).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this}}(),createJSON:function(){return[this.min.x,this.min.y,this.min.z,this.max.x,this.max.y,this.max.z]},setFromJSON:function(e){this.min.set(e[0],e[1],e[2]),this.max.set(e[3],e[4],e[5])},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},singlePoint:function(){return this.max.x<=this.min.x&&this.max.y<=this.min.y&&this.max.z<=this.min.z},center:function(t){return(t||new e.Vector3).addVectors(this.min,this.max).multiplyScalar(.5)},size:function(t){return(t||new e.Vector3).subVectors(this.max,this.min)},getArea:function(){var e=this.size();return 2*(e.x*e.y+e.x*e.z+e.y*e.z)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},getParameter:function(t){return new e.Vector3((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},clampPoint:function(t,i){return(i||new e.Vector3).copy(t).clamp(this.min,this.max)},distanceToPoint:function(){var t=new e.Vector3;return function(e){return t.copy(e).clamp(this.min,this.max).sub(e).length()}}(),getBoundingSphere:function(){var t=new e.Vector3;return function(e){var i=e||new s.Sphere;return i.center=this.center(),i.radius=.5*this.size(t).length(),i}}(),isIntersectingWith:function(t,i){function r(e,t){let i=1/0,r=-1/0;for(let n=0;n<t.length;n++){const a=e.dot(t[n]);a<i&&(i=a),a>r&&(r=a)}return[i,r]}const n=t.getPoints(i).map(e=>e.clone()),a=this.getPoints();function s(e){if(e.lengthSq()<=1e-6)return!1;const t=r(e,a),i=r(e,n);return t[1]<=i[0]||i[1]<=t[0]}const o=[new e.Vector3(1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,1),(new e.Vector3).copy(n[4]).sub(n[0]),(new e.Vector3).copy(n[2]).sub(n[0]),(new e.Vector3).copy(n[1]).sub(n[0])];for(let e=0;e<6;e++)if(s(o[e]))return!1;const l=new e.Vector3;for(let e=0;e<3;e++){l.copy(o[e]);for(let e=0;e<3;e++)if(l.cross(o[e+3]),s(l))return!1}return!0},intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:(n=[new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3],function(e){return n[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),n[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),n[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),n[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),n[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),n[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),n[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),n[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.makeEmpty(),this.setFromPoints(n),this}),getPoints:function(){var t=[new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3];return function(e){return t[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),t[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),t[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),t[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),t[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),t[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),t[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),t[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),t}}(),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)},clone:function(){return(new s.Box3).copy(this)},mergeWithBox:function(e){this.expandByPoint(e.min),this.expandByPoint(e.max)},isNaN:function(){return!(!this.min.isNaN()&&!this.max.isNaN())},fromDGBoundingBoxArray:function(e){var t=this,i=e.length;if(i>1){var r=function(t){for(var r=e[0],n=1;n<i;n++){var a=e[n];r.fastBBox.min[t]>a.fastBBox.min[t]&&(r=a)}return r},n=function(t){for(var r=e[0],n=1;n<i;n++){var a=e[n];r.fastBBox.max[t]<a.fastBBox.max[t]&&(r=a)}return r},a=function(e){for(var i=r(e);t.min[e]>=i.fastBBox.min[e];)i.flagMinAttr(e),t.min[e]=Math.min(i.getMinAttr(e),t.min[e]),i=r(e)};a("x"),a("y"),a("z");var s=function(e){for(var i=n(e);t.max[e]<=i.fastBBox.max[e];)i.flagMaxAttr(e),t.max[e]=Math.max(i.getMaxAttr(e),t.max[e]),i=n(e)};s("x"),s("y"),s("z")}else if(i>0){var o=e[0];this.union(o.getRealBBox())}return this},getPlanes:function(){var t=new e.Vector3,i=new e.Vector3,r=null,n=[];return t.set(this.min.x,this.max.y,this.min.z),i.set(this.min.x,this.min.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.min,i,t),n.push(r),t.set(this.max.x,this.min.y,this.min.z),(r=new e.Plane).setFromCoplanarPoints(this.min,t,i),n.push(r),i.set(this.min.x,this.max.y,this.min.z),(r=new e.Plane).setFromCoplanarPoints(this.min,i,t),n.push(r),t.set(this.max.x,this.max.y,this.min.z),i.set(this.max.x,this.min.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.max,i,t),n.push(r),i.set(this.min.x,this.max.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.max,t,i),n.push(r),t.set(this.max.x,this.min.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.max,i,t),n.push(r),n}},s.DGBoundingBoxArray=function(e){this.fastBBox=e.fastBBox.clone(),this._realBBox=e.fastBBox.singlePoint()?e.fastBBox.clone():null,this.matrix=e.matrix.clone(),this.renderable=e.renderable,this.obj=[]},s.DGBoundingBoxArray.prototype.computeFunction=function(){for(var t=new e.Box3,i=0;i<this.obj.length;i++){var r=this.obj[i]._computeOrientedBoundingBox(this.matrix,-1,0,!1,null,null,0);t.union(r)}this._realBBox=t},s.DGBoundingBoxArray.prototype.getRealBBox=function(){return null===this._realBBox&&this.computeFunction(),this._realBBox},s.DGBoundingBoxArray.prototype.getMinAttr=function(e){return null===this._realBBox&&this.computeFunction(),this._realBBox.min[e]},s.DGBoundingBoxArray.prototype.getMaxAttr=function(e){return null===this._realBBox&&this.computeFunction(),this._realBBox.max[e]},s.DGBoundingBoxArray.prototype.flagMaxAttr=function(e){this.fastBBox.max[e]=-1/0},s.DGBoundingBoxArray.prototype.flagMinAttr=function(e){this.fastBBox.min[e]=1/0},s.DGBoundingBoxArray.prototype.addDG=function(e){this.obj.push(e)},s.DGBoundingBoxArray.prototype.setDGs=function(e){this.obj=e},s.DGBoundingBoxArray.prototype.empty=function(){return 0===this.obj.length},s.Sphere=function(t,i){this.center=void 0!==t?t:new e.Vector3,this.radius=void 0!==i?i:0,this.pixelRadius=0},s.Sphere.prototype={constructor:s.Sphere,set:function(e,t){return this.center.copy(e),this.radius=t,this},setSimple:function(e,t,i,r){return this.center.set(e,t,i),this.radius=r,this.pixelRadius=0,this},reset:function(){return this.setSimple(0,0,0,0)},createJSON:function(){return[this.center.x,this.center.y,this.center.z,this.radius]},setFromJSON:function(e){this.center.set(e[0],e[1],e[2]),this.radius=e[3]},setFromCenterAndPoints:function(e,t){for(var i=0,r=0,n=t.length;r<n;r++){var a=e.distanceToSquared(t[r]);i=Math.max(i,a)}return this.center=e,this.radius=Math.sqrt(i),this},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this.pixelRadius=e.pixelRadius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius+1e-6},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},containsSphere:function(e){return this.center.distanceTo(e.center)<=this.radius-e.radius},intersectsSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},intersectsLine:function(e){var t=e[1].clone().sub(e[0]),i=this.center.clone().sub(e[0]),r=t.dot(i),n=t.dot(t),a=e[0].clone().add(t.clone().multiplyScalar(r/n));if(!this.containsPoint(a))return!1;var s=a.sub(e[0]).dot(t);return s>=0&&s<=n},intersectsTriangle:function(e){return this.intersectsLine([e[0],e[1]])||this.intersectsLine([e[1],e[2]])||this.intersectsLine([e[2],e[0]])},clampPoint:function(t,i){var r=this.center.distanceToSquared(t),n=i||new e.Vector3;return n.copy(t),r>this.radius*this.radius&&(n.sub(this.center).normalize(),n.multiplyScalar(this.radius).add(this.center)),n},getBoundingBox:function(t){var i=t||new e.Box3;return i.set(this.center,this.center),i.expandByScalar(this.radius),i},applyMatrix4:function(e){return e&&(this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis()),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius},clone:function(){return(new s.Sphere).copy(this)},mergeWithSphere:function(e,t){var i,r,n;this.radius<e.radius?(i=this,r=e):(i=e,r=this);var a,s=r.center.distanceTo(i.center),o=Math.max(e.pixelRadius,t.pixelRadius);s+i.radius<=r.radius?t.copy(r):(a=((n=.5*(i.radius+r.radius+s))-r.radius)/s,t.radius=n,t.center.x=a*i.center.x+(1-a)*r.center.x,t.center.y=a*i.center.y+(1-a)*r.center.y,t.center.z=a*i.center.z+(1-a)*r.center.z),t.pixelRadius=o},isNaN:function(){return!(isFinite(this.radius)&&!this.center.isNaN())},_updateRatio:function(t){0!==t&&(this.pixelRadius+=this.center.length()*t,this.set(new e.Vector3,this.radius+this.center.length()),this.radius*=t,this.pixelRadius=Math.max(this.pixelRadius,this.radius),this.radius=0)}},s.BoundingSphere=function(e,t,i){s.Sphere.call(this,e,t),this.state=0,i&&this.setState(i)},s.BoundingSphere.prototype=Object.create(s.Sphere.prototype),s.BoundingSphere.prototype.states=["EMPTY","NORMAL","INFINITE"],s.BoundingSphere.prototype.setState=function(e){this.state=this.states.indexOf(e)},s.BoundingSphere.prototype.getState=function(){return this.states[this.state]},s.Triangle=function(t,i,r){this.a=void 0!==t?t:new e.Vector3,this.b=void 0!==i?i:new e.Vector3,this.c=void 0!==r?r:new e.Vector3},s.Triangle.normal=(a=new e.Vector3,function(t,i,r,n){var s=n||new e.Vector3;s.subVectors(r,i),a.subVectors(t,i),s.cross(a);var o=s.lengthSq();return o>0?s.multiplyScalar(1/Math.sqrt(o)):s.set(0,0,0)}),s.Triangle.barycoordFromPoint=function(){var t=new e.Vector3,i=new e.Vector3,r=new e.Vector3;return function(n,a,s,o,l){t.subVectors(o,a),i.subVectors(s,a),r.subVectors(n,a);var h=t.dot(t),c=t.dot(i),d=t.dot(r),u=i.dot(i),p=i.dot(r),f=h*u-c*c,g=l||new e.Vector3;if(0==f)return g.set(-2,-1,-1);var m=1/f,v=(u*d-c*p)*m,y=(h*p-c*d)*m;return g.set(1-v-y,y,v)}}(),s.Triangle.containsPoint=function(){var t=new e.Vector3;return function(e,i,r,n){var a=s.Triangle.barycoordFromPoint(e,i,r,n,t);return a.x>=0&&a.y>=0&&a.x+a.y<=1}}(),s.Triangle.prototype={constructor:s.Triangle,set:function(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this},setFromPointsAndIndices:function(e,t,i,r){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[r]),this},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:function(){var t=new e.Vector3,i=new e.Vector3;return function(){return t.subVectors(this.c,this.b),i.subVectors(this.a,this.b),.5*t.cross(i).length()}}(),midpoint:function(t){return(t||new e.Vector3).addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(e){return s.Triangle.normal(this.a,this.b,this.c,e)},plane:function(e){return(e||new s.Plane).setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(e,t){return s.Triangle.barycoordFromPoint(e,this.a,this.b,this.c,t)},containsPoint:function(e){return s.Triangle.containsPoint(e,this.a,this.b,this.c)},equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)},clone:function(){return(new s.Triangle).copy(this)}},s.Spline=function(t){this.points=t;var i,r,n,a,s,o,l,h,c,d=[],u={x:0,y:0,z:0};function p(e,t,i,r,n,a,s){var o=.5*(i-e),l=.5*(r-t);return(2*(t-i)+o+l)*s+(-3*(t-i)-2*o-l)*a+o*n+t}this.initFromArray=function(e){this.points=[];for(var t=0;t<e.length;t++)this.points[t]={x:e[t][0],y:e[t][1],z:e[t][2]}},this.getPoint=function(e){return i=(this.points.length-1)*e,r=Math.floor(i),n=i-r,d[0]=0===r?r:r-1,d[1]=r,d[2]=r>this.points.length-2?this.points.length-1:r+1,d[3]=r>this.points.length-3?this.points.length-1:r+2,o=this.points[d[0]],l=this.points[d[1]],h=this.points[d[2]],c=this.points[d[3]],s=n*(a=n*n),u.x=p(o.x,l.x,h.x,c.x,n,a,s),u.y=p(o.y,l.y,h.y,c.y,n,a,s),u.z=p(o.z,l.z,h.z,c.z,n,a,s),u},this.getControlPointsArray=function(){var e,t,i=this.points.length,r=[];for(e=0;e<i;e++)t=this.points[e],r[e]=[t.x,t.y,t.z];return r},this.getLength=function(t){var i,r,n,a,s=0,o=0,l=0,h=new e.Vector3,c=new e.Vector3,d=[],u=0;for(d[0]=0,t||(t=100),n=this.points.length*t,h.copy(this.points[0]),i=1;i<n;i++)r=i/n,a=this.getPoint(r),c.copy(a),u+=c.distanceTo(h),h.copy(a),s=(this.points.length-1)*r,(o=Math.floor(s))!=l&&(d[o]=u,l=o);return d[d.length]=u,{chunks:d,total:u}},this.reparametrizeByArcLength=function(t){var i,r,n,a,s,o,l,h,c=[],d=new e.Vector3,u=this.getLength();for(c.push(d.copy(this.points[0]).clone()),i=1;i<this.points.length;i++){for(o=u.chunks[i]-u.chunks[i-1],l=Math.ceil(t*o/u.total),a=(i-1)/(this.points.length-1),s=i/(this.points.length-1),r=1;r<l-1;r++)n=a+r*(1/l)*(s-a),h=this.getPoint(n),c.push(d.copy(h).clone());c.push(d.copy(this.points[i]).clone())}this.points=c}},s.Plane=function(t,i){this.normal=void 0!==t?t:new e.Vector3(1,0,0),this.constant=void 0!==i?i:0},s.Plane.prototype={constructor:s.Plane,set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,i,r){return this.normal.set(e,t,i),this.constant=r,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(){var t=new e.Vector3,i=new e.Vector3;return function(e,r,n){var a=t.subVectors(n,r).cross(i.subVectors(e,r)).normalize();return this.setFromNormalAndCoplanarPoint(a,e),this}}(),copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToPointSquared:function(e){const t=this.distanceToPoint(e);return t*t},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return this.orthoPoint(e,t).sub(e).negate()},orthoPoint:function(t,i){var r=this.distanceToPoint(t);return(i||new e.Vector3).copy(this.normal).multiplyScalar(r)},isIntersectionLine:function(e){var t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0},intersectLine:function(){var t=new e.Vector3;return function(i,r){var n=r||new e.Vector3,a=i.delta(t),s=this.normal.dot(a);if(0==s)return 0==this.distanceToPoint(i.start)?n.copy(i.start):void 0;var o=-(i.start.dot(this.normal)+this.constant)/s;return o<0||o>1?void 0:n.copy(a).multiplyScalar(o).add(i.start)}}(),containsPoint(e,t=1e-9){return this.distanceToPointSquared(e)<t},containsInfiniteLine(e,t=1e-9){return this.normal.dot(e.axis)<t&&this.containsPoint(e.origin,t)},containsPlane(e,t=1e-9){return Math.abs(this.normal.dot(e.normal))>1-t&&e.containsPoint(this.coplanarPoint())},coplanarPoint:function(t){return(t||new e.Vector3).copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var t=new e.Vector3,i=new e.Vector3;return function(r,n){n=n||(new e.Matrix3).getInverse(r).transpose();var a=t.copy(this.normal).applyMatrix3(n),s=this.coplanarPoint(i);return s.applyMatrix4(r),this.setFromNormalAndCoplanarPoint(a,s),this}}(),translate:function(e){return this.constant=this.constant-e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant==this.constant},clone:function(){return(new s.Plane).copy(this)}},s.Frustum=function(e,t,i,r,n,a){this.planes=[void 0!==e?e:new s.Plane,void 0!==t?t:new s.Plane,void 0!==i?i:new s.Plane,void 0!==r?r:new s.Plane,void 0!==n?n:new s.Plane,void 0!==a?a:new s.Plane]},s.Frustum.prototype={constructor:s.Frustum,set:function(e,t,i,r,n,a){var s=this.planes;return s[0].copy(e),s[1].copy(t),s[2].copy(i),s[3].copy(r),s[4].copy(n),s[5].copy(a),this},copy:function(e){for(var t=this.planes,i=0;i<6;i++)t[i].copy(e.planes[i]);return this},setFromMatrix:function(e){var t=this.planes,i=e.elements,r=i[0],n=i[1],a=i[2],s=i[3],o=i[4],l=i[5],h=i[6],c=i[7],d=i[8],u=i[9],p=i[10],f=i[11],g=i[12],m=i[13],v=i[14],y=i[15];return t[0].setComponents(s-r,c-o,f-d,y-g).normalize(),t[1].setComponents(s+r,c+o,f+d,y+g).normalize(),t[2].setComponents(s+n,c+l,f+u,y+m).normalize(),t[3].setComponents(s-n,c-l,f-u,y-m).normalize(),t[4].setComponents(s-a,c-h,f-p,y-v).normalize(),t[5].setComponents(s+a,c+h,f+p,y+v).normalize(),this},intersectsSphere:function(e){for(var t=this.planes,i=e.center,r=-e.radius,n=0;n<6;n++){if(t[n].distanceToPoint(i)<r)return!1}return!0},containsSphere:function(e){for(var t=this.planes,i=0;i<6;i++)if(t[i].distanceToPoint(e.center)-e.radius<0)return!1;return!0},containsPoint:function(e){for(var t=this.planes,i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0},clone:function(){return(new s.Frustum).copy(this)},computeOutcode:function(e){var t=0;return e.dot(this.planes[0].normal)+this.planes[0].constant<0&&(t|=1),e.dot(this.planes[1].normal)+this.planes[1].constant<0&&(t|=2),e.dot(this.planes[2].normal)+this.planes[2].constant<0&&(t|=4),e.dot(this.planes[3].normal)+this.planes[3].constant<0&&(t|=8),e.dot(this.planes[4].normal)+this.planes[4].constant<0&&(t|=16),e.dot(this.planes[5].normal)+this.planes[5].constant<0&&(t|=32),t},intersectsLine:function(t){var i=[],r=[new e.Vector3,new e.Vector3];r[0].copy(t[0]),r[1].copy(t[1]),i[0]=this.computeOutcode(r[0]),i[1]=this.computeOutcode(r[1]);for(var n=0;n<4;n++){if(0===i[0]||0===i[1])return!0;if(0!=(i[0]&i[1]))break;var a=new e.Vector3(r[0].x-r[1].x,r[0].y-r[1].y,r[0].z-r[1].z),s=0,o=null;1&i[0]?o=this.planes[0]:2&i[0]?o=this.planes[1]:4&i[0]?o=this.planes[2]:8&i[0]?o=this.planes[3]:16&i[0]?o=this.planes[4]:32&i[0]&&(o=this.planes[5]),o&&(s=-(r[0].dot(o.normal)+o.constant)/a.dot(o.normal)),r[0].add(a.multiplyScalar(s)),i[0]=this.computeOutcode(r[0])}return!1},intersectsTriangle:function(e){return this.intersectsLine([e[0],e[1]])||this.intersectsLine([e[1],e[2]])||this.intersectsLine([e[2],e[0]])},__v2:!0,intersectsObject:function(t,i,r){var n=this.planes,a=t._getMMMatrix(),s=t.geometry.boundingSphere,o=-s.radius*a.getMaxScaleOnAxis(),l=e.Frustum.__v2;null!==s?l.copy(s.center):l.set(0,0,0),l.applyMatrix4(a);for(var h=0;h<6;h++)if(n[h].distanceToPoint(l)<=o)return!1;return!0},performFrustumCulling:function(e,t){for(var i=this.planes,r=-e,n=null,a=null,s=0;s<6;s++)if((a=(n=i[s]).normal).x*t.x+a.y*t.y+a.z*t.z+n.constant<=r)return!1;return!0},performFrustumCullingNoNearFar:function(e,t){for(var i=this.planes,r=-e,n=null,a=null,s=0;s<4;s++)if((a=(n=i[s]).normal).x*t.x+a.y*t.y+a.z*t.z+n.constant<=r)return!1;return!0},getCorners:function(){var t=[],i=new e.Matrix4,r=new e.Matrix4,n=this;function a(t,a,s){var o=n.planes[t],l=n.planes[a],h=n.planes[s];i.set(o.normal.x,o.normal.y,o.normal.z,0,l.normal.x,l.normal.y,l.normal.z,0,h.normal.x,h.normal.y,h.normal.z,0,0,0,0,1),r.getInverse(i);var c=(new e.Vector4).set(-o.constant,-l.constant,-h.constant,1);return c.applyMatrix4(r),c}return t[0]=a(1,2,5),t[1]=a(0,2,5),t[2]=a(0,3,5),t[3]=a(1,3,5),t[4]=a(1,2,4),t[5]=a(0,2,4),t[6]=a(0,3,4),t[7]=a(1,3,4),t}},s.Face4=function(t,i,r,n,a,s,o){this.a=t,this.b=i,this.c=r,this.d=n,this.normal=a instanceof e.Vector3?a:new e.Vector3,this.vertexNormals=a instanceof Array?a:[],this.color=s instanceof e.Color?s:new e.Color,this.vertexColors=s instanceof Array?s:[],this.vertexTangents=[],this.materialIndex=void 0!==o?o:0,this.centroid=new e.Vector3},s.Face4.prototype={constructor:s.Face4,clone:function(){var e,t,i=new s.Face4(this.a,this.b,this.c,this.d);for(i.normal.copy(this.normal),i.color.copy(this.color),i.centroid.copy(this.centroid),i.materialIndex=this.materialIndex,e=0,t=this.vertexNormals.length;e<t;e++)i.vertexNormals[e]=this.vertexNormals[e].clone();for(e=0,t=this.vertexColors.length;e<t;e++)i.vertexColors[e]=this.vertexColors[e].clone();for(e=0,t=this.vertexTangents.length;e<t;e++)i.vertexTangents[e]=this.vertexTangents[e].clone();return i}},s.Face3=function(t,i,r,n,a,s){this.a=t,this.b=i,this.c=r,this.normal=n instanceof e.Vector3?n:new e.Vector3,this.vertexNormals=n instanceof Array?n:[],this.color=a instanceof e.Color?a:new e.Color,this.vertexColors=a instanceof Array?a:[],this.vertexTangents=[],this.materialIndex=void 0!==s?s:0,this.centroid=new e.Vector3},s.Face3.prototype={constructor:s.Face3,clone:function(){var e,t,i=new s.Face3(this.a,this.b,this.c);for(i.normal.copy(this.normal),i.color.copy(this.color),i.centroid.copy(this.centroid),i.materialIndex=this.materialIndex,e=0,t=this.vertexNormals.length;e<t;e++)i.vertexNormals[e]=this.vertexNormals[e].clone();for(e=0,t=this.vertexColors.length;e<t;e++)i.vertexColors[e]=this.vertexColors[e].clone();for(e=0,t=this.vertexTangents.length;e<t;e++)i.vertexTangents[e]=this.vertexTangents[e].clone();return i}},s.mergeBoundingSphereInto=function(e,t,i,r){if(t&&!t.isNaN()){var n=t.clone();r&&n._updateRatio(r),i&&n.applyMatrix4(i),e?e.mergeWithSphere(n,e):e=n}return e},s.mergeBoundingBoxInto=function(t,i,r,n){if(i&&!i.isNaN()){var a=i.clone();n&&(a.max=new e.Vector3(0,0,0),a.min=new e.Vector3(0,0,0)),r&&a.applyMatrix4(r),t?t.mergeWithBox(a):t=a}return t},s}),define("DS/Visualization/ProxyAbstraction",["DS/WAFData/WAFData"],function(e){"use strict";return class{useNoProxy(e){this.proxyUsage=0,this.server=null,this.sport=null,this.withCredentials=e}useProxyDefinedBy(e,t){this.proxyUsage=1,this.server=e,this.sport=t}useUWAProxy(e){this.proxyUsage=2,this.server=null,this.sport=null,this.proxymode=e.proxymode,this.requestsOptions=e.requestsOptions}rewriteUrlUsingProxyDef(e,t,i){var r=e.indexOf("/"),n=e.indexOf("/",r+2);return e.slice(0,r)+"//"+t+":"+i+e.slice(n,e.length)}executeGetHttpRequest(t,i,r,n,a,s){var o,l,h=(o=a,l=t,function(e){o&&o({url:l,type:"LOAD",responseCode:e})});if(2===this.proxyUsage){var c=this.requestsOptions||{};c.headers=c.headers||new Object,s&&(c.headers.Accept=s),c.data&&(c.data.GET=c.data.GET||r),c.method=c.method||"GET",c.timeout=36e5,c.async=!0,c.onComplete=n,c.onFailure=function(e){for(var t=e.message.split('"'),i=null,r=0;r<t.length-1;r++)-1!=t[r].search("return ResponseCode with value")&&(i=parseInt(t[r+1]));i&&h(i)},c.onTimeout=function(e){h(408)},c.type=i,c.proxymode&&(c.authentication=c.proxymode),e.handleRequest(t,c)}else{1===this.proxyUsage&&(t=this.rewriteUrlUsingProxyDef(t,this.server,this.sport));var d=new XMLHttpRequest;d.open("GET",t,!0),d.onload=function(e){var t=d.status;200===t||0===t&&this.response&&this.response.byteLength>0?n(this.response):h(t)},d.onerror=function(e){h(d.status)},d.ontimeout=function(e){h(408)},d.timeout=36e5,this.withCredentials&&(d.withCredentials=!0),"arraybuffer"===i&&(d.responseType=i),"blob"===i&&(d.responseType=i),d.send(r)}}fetchUint8Array(e,t,i,r){return new Promise((n,a)=>{this.executeGetHttpRequest(e,t,i,e=>n(new Uint8Array(e)),a,r)})}}}),define("DS/Visualization/PLMMaterialServicesItf",[],function(){"use strict";var e=function(){this.implementation=null};return e.prototype.setImplementation=function(e){this.implementation=e},e.prototype.loadMaterials=function(e,t,i){this.implementation.loadMaterials(e,t,i)},e.prototype.loadMaterialConnections=function(e,t){this.implementation.loadMaterialConnections(e,t)},new e}),define("DS/Visualization/IdPathMatcher",[],function(){"use strict";var e=function(e){this._idToNodeCB=e.idToNodeCB,this._nodeToIdCB=e.nodeToIdCB,this._isNodeRepRefCB=e.isNodeRepRefCB};return e.prototype.idToNode=function(e){return this._idToNodeCB(e)},e.prototype.nodeToId=function(e){return this._nodeToIdCB(e)},e.prototype.isNodeRepRef=function(e){return this._isNodeRepRefCB(e)},e}),define("DS/Visualization/SkinningTransformation",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";const t=function(){this.useEulerAngles=!1,this.skinningMap=null,this.skinningMapWidth=0,this.skinningMapWidth=0};t.prototype.setSkinningMatrices=function(t,i){var r;this.skinningMapWidth&&this.skinningMapHeight||(r=i>256?64:i>64?32:i>16?16:8,this.skinningMapWidth=r,this.skinningMapHeight=r);if(this.useEulerAngles=!1,this.skinningMap)this.skinningMap.image.data.set(t,0);else{var n=new Float32Array(this.skinningMapWidth*this.skinningMapHeight*3);n.set(t,0),this.skinningMap=new e.DataTexture(n,this.skinningMapWidth,this.skinningMapHeight,e.RGBFormat,e.FloatType),this.skinningMap.minFilter=e.NearestFilter,this.skinningMap.magFilter=e.NearestFilter,this.skinningMap.generateMipmaps=!1,this.skinningMap.flipY=!1}this.skinningMap.needsUpdate=!0},t.prototype.setSkinningEulerAngles=function(t,i){var r;this.skinningMapWidth&&this.skinningMapHeight||(r=i>512?64:i>128?32:i>32?16:8,this.skinningMapWidth=r,this.skinningMapHeight=r);if(this.useEulerAngles=!0,this.skinningMap)this.skinningMap.image.data.set(t,0);else{var n=new Float32Array(this.skinningMapWidth*this.skinningMapHeight*3);n.set(t,0),this.skinningMap=new e.DataTexture(n,this.skinningMapWidth,this.skinningMapHeight,e.RGBFormat,e.FloatType),this.skinningMap.minFilter=e.NearestFilter,this.skinningMap.magFilter=e.NearestFilter,this.skinningMap.generateMipmaps=!1,this.skinningMap.flipY=!1}this.skinningMap.needsUpdate=!0},t.prototype.dispose=function(){this.skinningMap&&this.skinningMap.dispose()};const i=function(){this.useEulerAngles=!1,this.skinningInstancingMaps=null,this.skinningInstancingMapsInfo=null};return i.prototype.setInstancingSkinningMatrices=function(t,i,r){var n,a;if(this.useEulerAngles=!1,this.skinningInstancingMapsInfo&&this.nbBones===i)n=this.skinningInstancingMapsInfo;else{var s=function(e){for(var t=1;t<e;)t*=2;return t},o=debugWebGLV6Viewer.renderer.renderer.context,l=o.getParameter(o.MAX_TEXTURE_SIZE),h=l*l,c=i*r*4,d=Math.ceil(c/h),u=c-Math.floor(c/h)*h,p=s(Math.sqrt(u)),f=s(u/p),g=3*((d-1)*h+p*f);n={nbBones:i,maxTextureSize:l,nbTextures:d,lastTextureSizeX:p,lastTextureSizeY:f},this.skinningInstancingMapsInfo=n}this.skinningInstancingMaps||(this.skinningInstancingMaps=new Array(n.nbTextures),(a=new Float32Array(g)).set(t,0));for(var m=0;m<n.nbTextures-1;m++){var v;if(this.skinningInstancingMaps[m])this.skinningInstancingMaps[m].image.data.set(t.subarray(m*n.maxTextureTotalSize*3,(m+1)*n.maxTextureTotalSize*3),0);else(v=new e.DataTexture(a.subarray(m*n.maxTextureTotalSize*3,(m+1)*n.maxTextureTotalSize*3),n.maxTextureSize,n.maxTextureSize,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,v.magFilter=e.NearestFilter,v.generateMipmaps=!1,v.flipY=!1,this.skinningInstancingMaps[m]=v;this.skinningInstancingMaps[m].needsUpdate=!0}this.skinningInstancingMaps[n.nbTextures-1]?this.skinningInstancingMaps[n.nbTextures-1].image.data.set(t.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,t.length),0):((v=new e.DataTexture(a.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,a.length),n.lastTextureSizeX,n.lastTextureSizeY,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,v.magFilter=e.NearestFilter,v.generateMipmaps=!1,v.flipY=!1,this.skinningInstancingMaps[n.nbTextures-1]=v);this.skinningInstancingMaps[n.nbTextures-1].needsUpdate=!0},i.prototype.setInstancingSkinningEulerAngles=function(t,i,r){var n,a;if(this.useEulerAngles=!0,this.skinningInstancingMapsInfo&&this.nbBones===i)n=this.skinningInstancingMapsInfo;else{var s=function(e){for(var t=1;t<e;)t*=2;return t},o=debugWebGLV6Viewer.renderer.renderer.context,l=o.getParameter(o.MAX_TEXTURE_SIZE),h=l*l,c=i*r*2,d=Math.ceil(c/h),u=c-Math.floor(c/h)*h,p=s(Math.sqrt(u)),f=s(u/p),g=3*((d-1)*h+p*f);n={nbBones:i,maxTextureSize:l,nbTextures:d,lastTextureSizeX:p,lastTextureSizeY:f},this.skinningInstancingMapsInfo=n}this.skinningInstancingMaps||(this.skinningInstancingMaps=new Array(n.nbTextures),(a=new Float32Array(g)).set(t,0));for(var m=0;m<n.nbTextures-1;m++){var v;if(this.skinningInstancingMaps[m])this.skinningInstancingMaps[m].image.data.set(t.subarray(m*n.maxTextureTotalSize*3,(m+1)*n.maxTextureTotalSize*3),0);else(v=new e.DataTexture(a.subarray(m*n.maxTextureTotalSize*3,(m+1)*n.maxTextureTotalSize*3),n.maxTextureSize,n.maxTextureSize,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,v.magFilter=e.NearestFilter,v.generateMipmaps=!1,v.flipY=!1,this.skinningInstancingMaps[m]=v;this.skinningInstancingMaps[m].needsUpdate=!0}this.skinningInstancingMaps[n.nbTextures-1]?this.skinningInstancingMaps[n.nbTextures-1].image.data.set(t.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,t.length),0):((v=new e.DataTexture(a.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,a.length),n.lastTextureSizeX,n.lastTextureSizeY,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,v.magFilter=e.NearestFilter,v.generateMipmaps=!1,v.flipY=!1,this.skinningInstancingMaps[n.nbTextures-1]=v);this.skinningInstancingMaps[n.nbTextures-1].needsUpdate=!0},i.prototype.dispose=function(){if(this.skinningInstancingMaps)for(var e=0;e<this.skinningInstancingMaps.length;e++){var t=this.skinningInstancingMaps[e];t&&t.dispose()}},{SkinningTransformations:t,SkinningTransformationsInstancing:i}}),define("DS/Visualization/StreamVisuLoader",["DS/VisuLoaders/StreamVisuLoader"],function(e){"use strict";return e}),define("Visualization/StreamVisuLoader",["DS/Visualization/StreamVisuLoader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/StreamVisuLoader"),e}),define("DS/Visualization/OccurrenceInterfaceFactory",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e,t){this._occurrenceExplorer=e,this.viewer=t},getOccurrenceItf:function(e){var t=e._getUniqueOccurrence(this.viewer);return t?this._occurrenceExplorer.getOccurrenceInterface(t):null},getOccurrenceItfMulti:function(e){var t,i=e._getOccurrences(this.viewer),r=[];for(t=0;t<i.length;t++)r.push(this._occurrenceExplorer.getOccurrenceInterface(i[t]));return r},getUserRootOccurrenceItf:function(){var e=this.viewer.internalSceneGraph.userRoot._occurrences[0];return this._occurrenceExplorer.getOccurrenceInterface(e)}})}),define("DS/Visualization/RenderPriorityManager",["UWA/Class","DS/Plugins/RenderPass","DS/Plugins/ClearPass"],function(e,t,i){"use strict";return e.extend({init:function(e){this.viewer=e,this.enabled=!1,this.passes=this._createPasses(e)},setEnabled:function(e){e=!!e,this.enabled!==e&&(this.enabled=e,this._enablePasses(this.enabled),this.viewer.internalSceneGraph.root._forceUpdate())},_enablePasses:function(e){if(this.passes){var t,i=this.viewer;if(e)for(t=0;t<this.passes.length;t++)i.renderer.mainComposer.addPass(this.passes[t]);else i.renderer.mainComposer.removePasses(this.passes)}},_createPasses:function(e){var r=[],n=new i("renderPriorityClear");n.defaults.clear=!1,n.setClearStencil(!0),n.clearStencilValue=0,n.idString="renderPriority",r.push(n);var a,s,o;for(a=0;a<=4;a++)(s=new t(null,null,null,null,null,null,"renderPriorityStencilP"+a)).idString="p"+a,s.stencilRef=a,s.enableStencilTest=!0,s.setStencilFunc("GEQUAL"),s.setStencilOps("REPLACE","REPLACE"),s.setEnableStencilWrite(!0),r.push(s),4!==a&&((o=new t(null,null,null,null,null,null,"renderPriorityDrawP"+a)).idString="p"+a,o.stencilRef=a,o.enableStencilTest=!0,o.setStencilFunc("LESS"),o.setStencilOps("KEEP","KEEP"),o.useRenderPriorityOpacity=!0,o.setEnableStencilWrite(!1),r.push(o));return r}})}),define("DS/Visualization/UniformsUtils",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";return{merge:function(e){var t,i,r,n={};for(t=0;t<e.length;t++)for(i in r=this.clone(e[t]))n[i]=r[i];return n},mergeNoClone:function(e){var t,i,r,n={};for(t=0;t<e.length;t++)for(i in r=e[t])n[i]=r[i];return n},clone:function(t){var i,r,n,a={};for(i in t)for(r in a[i]={},t[i])(n=t[i][r])instanceof e.Color||n instanceof e.Vector2||n instanceof e.Vector3||n instanceof e.Vector4||n instanceof e.Matrix4?a[i][r]=n.clone():n instanceof Array?a[i][r]=n.slice():a[i][r]=n;return a}}}),define("DS/Visualization/WebGLObjectManager",[],function(){"use strict";var e=function(e,t){this.object=t,this.frustumCulled=t.frustumCulled};e.prototype._performCulling=function(e,t,i,r){var n=i.worldCenter,a=i.worldRadius;r.currentRenderPointsOnly=!1;var s=!1;if(e.pixelCulling>0){var o=e.pixelCullingCst;if(!e.isOrtho){var l=e.matrixWorldInverse.elements;o*=Math.abs(l[2]*n.x+l[6]*n.y+l[10]*n.z+l[14])}a<o&&(!1===i.hasPoint?s=!0:r.currentRenderPointsOnly=!0)}return r.previousRenderPointsOnly!==r.currentRenderPointsOnly&&(r.invalidated=!0,r.previousRenderPointsOnly=r.currentRenderPointsOnly),!s&&t.performFrustumCulling(a,n)};var t=function(t,i){e.call(this,t,i)};(t.prototype=Object.create(e.prototype))._performCulling=function(e,t,i,r){var n=i.worldCenter,a=i.worldRadius;if(e.pixelCulling>0){var s=e.pixelCullingCst;if(!e.isOrtho){var o=e.matrixWorldInverse.elements;s*=Math.abs(o[2]*n.x+o[6]*n.y+o[10]*n.z+o[14])}if(a<s)return!1}return t.performFrustumCulling(a,n)};var i=function(e,i){t.call(this,e,i)};(i.prototype=Object.create(t.prototype))._performCulling=function(e,i,r,n){var a=t.prototype._performCulling.call(this,e,i,r,n);return a&&r._computeLOD(e,n),a};var r=function(t,i){e.call(this,t,i)};(r.prototype=Object.create(e.prototype))._performCulling=function(e,t,i,r){var n=i.worldCenter,a=i.worldRadius;r.currentRenderPointsOnly=!1;var s=!1,o=e.pixelCulling,l=e.matrixWorldInverse.elements;if(o>0&&a<o&&(!1===i.hasPoint?s=!0:r.currentRenderPointsOnly=!0),r.previousRenderPointsOnly!==r.currentRenderPointsOnly&&(r.invalidated=!0,r.previousRenderPointsOnly=r.currentRenderPointsOnly),s)return!1;var h=a*e.fixedSizeCameraConstant;return e.isOrtho||(h*=Math.abs(l[2]*n.x+l[6]*n.y+l[10]*n.z+l[14])),t.performFrustumCulling(h,n)};var n=function(){this.objects=[],this.idMap=new Map,this.nullCount=0,this.lastCleanFrame=0};return n.prototype._clean=function(){if(this.nullCount>1e3){this.idMap.clear(),this.objects=this.objects.filter(function(e){return null!==e}),this.nullCount=0;for(var e=0;e<this.objects.length;e++)this.idMap.has(this.objects[e].object)?this.idMap.get(this.objects[e].object).push(e):this.idMap.set(this.objects[e].object,[e])}},n.prototype.getObjects=function(e){return this._tryClean(e),this.objects},n.prototype._tryClean=function(e){if(0===this.lastCleanFrame&&e)this.lastCleanFrame=e;else if(this.nullCount>0&&(!e||e-this.lastCleanFrame>60)){if(this.idMap.clear(),this.nullCount===this.objects.length)this.objects=[];else{this.objects=this.objects.filter(function(e){return null!==e});for(var t=0;t<this.objects.length;t++)this.idMap.has(this.objects[t].object)?this.idMap.get(this.objects[t].object).push(t):this.idMap.set(this.objects[t].object,[t])}this.lastCleanFrame=e,this.nullCount=0}},n.prototype.add=function(e){null!==e&&(this.idMap.has(e.object)?this.idMap.get(e.object).push(this.objects.length):this.idMap.set(e.object,[this.objects.length]),this.objects.push(e))},n.prototype._remove=function(e){if(null===e)return!1;if(this.idMap.has(e)){for(var t=this.idMap.get(e),i=0;i<t.length;i++)this.objects[t[i]]=null,this.nullCount++;return this.idMap.delete(e),!0}return!1},n.prototype.remove=function(e){this._remove(e)&&this._clean()},n.prototype.removeCollection=function(e){var t=0,i=this;e.forEach(function(e,r,n){i._remove(e)&&t++}),t>0&&this._clean()},n.prototype.clear=function(){this.objects=[],this.nullCount=0,this.lastCleanFrame=0,this.idMap.clear()},n.__WebGLObject=e,n.__WebGLObjectNoPoints=t,n.__WebGLObjectCurvedPipe=i,n.__WebGLObjectFixedSize=r,n}),define("DS/Visualization/DAEReader",["DS/VisuLoaders/DAEReader"],function(e){"use strict";return e}),define("Visualization/DAEReader",["DS/Visualization/DAEReader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/DAEReader"),e}),define("DS/Visualization/XMLV6Loader",["DS/VisuLoaders/XMLV6Loader"],function(e){"use strict";return e}),define("Visualization/XMLV6Loader",["DS/Visualization/XMLV6Loader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/XMLV6Loader"),e}),define("DS/Visualization/HighlightData",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t="true"===localStorage.getItem("__1x3HL__"),i=function(){this._needsDepth=!1,this.outlineEnabled=!0,this.outlineColor=(new e.Color).setRGB(1,1,1),this.outlineAlpha=1,this.outlineThickness=1,this.haloEnabled=!0,this.haloColor=(new e.Color).setRGB(1,1,1),this.haloIntensity=2,this.haloThickness=4,this.color=(new e.Color).setRGB(1,1,1),this.colorEnabled=!0,this._id=0,this.priority=1,this.clearDepth=!1};i.prototype._setOutlineData=function(e){this.outlineEnabled=void 0!==e.outlineEnabled?e.outlineEnabled:this.outlineEnabled,void 0!==e.outlineColor&&this.outlineColor.copy(e.outlineColor),this.outlineAlpha=void 0!==e.outlineAlpha?e.outlineAlpha:this.outlineAlpha,this.outlineThickness=void 0!==e.outlineThickness?e.outlineThickness:this.outlineThickness},i.prototype._setHaloData=function(e){this.haloEnabled=void 0!==e.haloEnabled?e.haloEnabled:this.haloEnabled,void 0!==e.haloColor&&this.haloColor.copy(e.haloColor),this.haloIntensity=void 0!==e.haloIntensity?e.haloIntensity:this.haloIntensity,this.haloThickness=void 0!==e.haloThickness?e.haloThickness:this.haloThickness,this.haloThickness=Math.min(this.haloThickness,4)},i.prototype._setGenericData=function(e){void 0!==e.priority&&0!==this.priority&&0!==e.priority&&(this.priority=e.priority),void 0!==e.clearDepth&&0!==this.priority&&(this.clearDepth=e.clearDepth)},i.prototype._setColorData=function(e){this.colorEnabled=void 0!==e.colorEnabled?e.colorEnabled:this.colorEnabled,void 0!==e.color&&this.color.copy(e.color)},i.prototype.isEqual=function(e){return(void 0===e.outlineEnabled||e.outlineEnabled===this.outlineEnabled)&&((void 0===e.outlineAlpha||e.outlineAlpha===this.outlineAlpha)&&((void 0===e.haloEnabled||e.haloEnabled===this.haloEnabled)&&((void 0===e.haloIntensity||e.haloIntensity===this.haloIntensity)&&(!(void 0!==e.outlineColor&&!this.outlineColor.equals(e.outlineColor))&&((void 0===e.outlineThickness||this.outlineThickness===e.outlineThickness)&&(!(void 0!==e.haloColor&&!this.haloColor.equals(e.haloColor))&&(!(void 0!==e.color&&!this.color.equals(e.color))&&((void 0===e.colorEnabled||e.colorEnabled===this.colorEnabled)&&((void 0===e.priority||e.priority===this.priority)&&(void 0===e.clearDepth||e.clearDepth===this.clearDepth))))))))))},i.prototype._updateMixPassUniforms=function(e,t){this._id=t;var i=t-1,r=3*i;e.iHaloColors.value[r]=this.haloEnabled?this.haloColor.r:0,e.iHaloColors.value[r+1]=this.haloEnabled?this.haloColor.g:0,e.iHaloColors.value[r+2]=this.haloEnabled?this.haloColor.b:0,e.iOutlineColors.value[r]=this.outlineEnabled?this.outlineColor.r:0,e.iOutlineColors.value[r+1]=this.outlineEnabled?this.outlineColor.g:0,e.iOutlineColors.value[r+2]=this.outlineEnabled?this.outlineColor.b:0,e.iOutlineAlphas.value[i]=this.outlineEnabled?this.outlineAlpha:-1,e.iOutlineThicknesses.value[i]=this.outlineEnabled?this.outlineThickness:0,e.iColors.value[r]=this.colorEnabled?this.color.r:0,e.iColors.value[r+1]=this.colorEnabled?this.color.g:0,e.iColors.value[r+2]=this.colorEnabled?this.color.b:0},i.prototype._updateMaterialUniforms=function(e,t){var i=e.uniforms;i&&(i.highlightID&&(i.highlightID.value=this._id),i.iHighlightColor&&(i.iHighlightColor.value.x=this.color.r,i.iHighlightColor.value.y=this.color.g,i.iHighlightColor.value.z=this.color.b),i.iHighlightLineicColor&&(i.iHighlightLineicColor.value.x=this.outlineColor.r,i.iHighlightLineicColor.value.y=this.outlineColor.g,i.iHighlightLineicColor.value.z=this.outlineColor.b))};var r=function(e){i.call(this),this.intensity=1,this._setData(e)};(r.prototype=Object.create(i.prototype))._updateMixPassUniforms=function(e,t){i.prototype._updateMixPassUniforms.call(this,e,t);var r=t-1,n=2*r;e.iHaloIntensities.value[r]=this.haloEnabled?this.haloIntensity*this.haloIntensity:0,e.iColorIntensities.value[n]=this.colorEnabled?this.intensity:0,e.iColorIntensities.value[n+1]=-1},r.prototype.isEqual=function(e){return!!i.prototype.isEqual.call(this,e)&&(void 0===e.intensity||e.intensity===this.intensity)},r.prototype._updateMaterialUniforms=function(e,t){i.prototype._updateMaterialUniforms.call(this,e,t);var r=e.uniforms;r&&r.iHighlightIntensity&&(r.iHighlightIntensity.value.x=this.colorEnabled?this.intensity:0,r.iHighlightIntensity.value.y=-1)},r.prototype._setColorData=function(e){i.prototype._setColorData.call(this,e),this.intensity=void 0!==e.intensity?e.intensity:this.intensity},r.prototype._setData=function(e){e=e||{},this._setColorData(e),this._setHaloData(e),this._setOutlineData(e),this._setGenericData(e)};var n=function(t){i.call(this),this._needsDepth=!0,this.visibleAlpha=1,this.occludedAlpha=1,this.lineicOutlineColor=(new e.Color).setRGB(1,1,1),this.lineicHaloColor=(new e.Color).setRGB(1,1,1),this._setData(t)};return(n.prototype=Object.create(i.prototype)).isEqual=function(e){return!!i.prototype.isEqual.call(this,e)&&((void 0===e.visibleAlpha||e.visibleAlpha===this.visibleAlpha)&&((void 0===e.occludedAlpha||e.occludedAlpha===this.occludedAlpha)&&(!(void 0!==e.lineicOutlineColor&&!this.lineicOutlineColor.equals(e.lineicOutlineColor))&&!(void 0!==e.lineicHaloColor&&!this.lineicHaloColor.equals(e.lineicHaloColor)))))},n.prototype._updateMixPassUniforms=function(e,t){i.prototype._updateMixPassUniforms.call(this,e,t);var r=t-1,n=2*r,a=3*r;e.iHaloIntensities.value[r]=this.haloEnabled?1.4*this.haloIntensity:0,e.iColorIntensities.value[n]=this.colorEnabled?this.visibleAlpha:0,e.iColorIntensities.value[n+1]=this.colorEnabled?this.occludedAlpha:0,e.iLineicOutlineColors.value[a]=this.outlineEnabled?this.lineicOutlineColor.r:0,e.iLineicOutlineColors.value[a+1]=this.outlineEnabled?this.lineicOutlineColor.g:0,e.iLineicOutlineColors.value[a+2]=this.outlineEnabled?this.lineicOutlineColor.b:0,e.iLineicHaloColors.value[a]=this.haloEnabled?this.lineicHaloColor.r:0,e.iLineicHaloColors.value[a+1]=this.haloEnabled?this.lineicHaloColor.g:0,e.iLineicHaloColors.value[a+2]=this.haloEnabled?this.lineicHaloColor.b:0},n.prototype._updateMaterialUniforms=function(e,t){i.prototype._updateMaterialUniforms.call(this,e,t);var r=e.uniforms;r&&(r.rgbaDepth&&(r.rgbaDepth.value=t.politeDepthBuffer),r.iHighlightIntensity&&(r.iHighlightIntensity.value.x=Math.max(this.visibleAlpha,.3),r.iHighlightIntensity.value.y=Math.max(this.occludedAlpha,.1)))},n.prototype._setPoliteData=function(e){i.prototype._setColorData.call(this,e),this.visibleAlpha=void 0!==e.visibleAlpha?e.visibleAlpha:this.visibleAlpha,this.occludedAlpha=void 0!==e.occludedAlpha?e.occludedAlpha:this.occludedAlpha},n.prototype._setData=function(e){e=e||{},this._setPoliteData(e),this._setHaloData(e),this._setOutlineData(e),this._setGenericData(e),void 0!==e.lineicOutlineColor&&this.lineicOutlineColor.copy(e.lineicOutlineColor),void 0!==e.lineicHaloColor&&this.lineicHaloColor.copy(e.lineicHaloColor)},{DefaultHighlightData:{halo:new r({colorEnabled:!0,color:(new e.Color).setRGB(0,.6,1),intensity:1,haloEnabled:!0,haloColor:(new e.Color).setRGB(0,.6,1),haloThickness:4,haloIntensity:2,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(0,1,1),outlineAlpha:1,outlineThickness:1}),advancedpolite:new n({colorEnabled:!0,color:(new e.Color).setRGB(0,.6,1),visibleAlpha:.6,occludedAlpha:.15,haloEnabled:!0,haloColor:(new e.Color).setRGB(0,.6,1),lineicHaloColor:t?(new e.Color).setRGB(0,.85,1):(new e.Color).setRGB(0,1,1),haloIntensity:2,haloThickness:4,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(0,1,1),lineicOutlineColor:t?(new e.Color).setRGB(0,1,1):(new e.Color).setRGB(0,.6,1),outlineAlpha:1,outlineThickness:1})},DefaultPreHighlightData:{halo:new r({colorEnabled:!1,color:(new e.Color).setRGB(0,.6,1),intensity:1,haloEnabled:!0,haloColor:(new e.Color).setRGB(0,.6,1),haloIntensity:2,haloThickness:1,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(0,1,1),outlineAlpha:1,outlineThickness:1}),advancedpolite:new n({colorEnabled:!0,color:(new e.Color).setRGB(.97,.97,.97),visibleAlpha:.3,occludedAlpha:0,haloEnabled:!0,haloColor:(new e.Color).setRGB(.67,.67,.69),lineicHaloColor:t?(new e.Color).setRGB(.7,.7,.72):(new e.Color).setRGB(1,1,1),haloIntensity:1.3,haloThickness:4,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(.97,.97,.97),lineicOutlineColor:t?(new e.Color).setRGB(1,1,1):(new e.Color).setRGB(.7,.7,.72),outlineAlpha:1,outlineThickness:1})},HaloHighlightData:r,AdvancedPoliteHighlightData:n}});for(_shaderChunkBase="DS/MaterialLibs/",_toLoad=["LineBasicLib","MeshBasicLib","MeshLambertLib","MeshPhongLib","ParticleBasicLib","CubeMapLib","FiniteEnvMapLib","FiniteTransitionEnvMapLib","GradientBackgroundLibs","LatLongMapLib","SimpleMapLib"],i=0;i<_toLoad.length;i++)_toLoad[i]=_shaderChunkBase+_toLoad[i];function HighlightMeshData(e,t){this.selectionId=e,this.renderable=t}define("DS/Visualization/ShaderLib",_toLoad,function(e,t,i,r,n,a,s,o,l,h,c){"use strict";return{basic:t,lambert:i,phong:r,particle_basic:n,line:e,finiteenvmap:s,gradient2:l.GradientBackgroundLib2,gradient3:l.GradientBackgroundLib3,gradient4:l.GradientBackgroundLib4,latlong:h,cubemap:a,finitetransition:o,simplemap:c}}),define("DS/Visualization/Detector",[],function(){"use strict";return{canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{return!(!window.WebGLRenderingContext||!document.createElement("canvas").getContext("experimental-webgl")&&!document.createElement("canvas").getContext("webgl"))}catch(e){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e;return this.webgl||(e=window.WebGLRenderingContext?'Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />':'Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>',e+='Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'),e}}}),define("Visualization/Detector",["DS/Visualization/Detector","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Detector"),e}),define("DS/Visualization/StaticOverrideSet",["DS/Mesh/MeshUtils"],function(e){"use strict";var t=1;function i(e,i){this.id=t++,this.path=e,this.materialApplication=i}i.prototype.deactivate=function(){this.apply(!1)},i.prototype.apply=function(e){this.path.internalPath.length>0?this.apply_internal(e):this.apply_external(e)},i.prototype.apply_external=function(e){var t,i,r,n,a,s,o;if(e)for(t=this.path.externalPath[0]._occurrences,i=0;i<t.length;i++)o=(r=t[i]).depth,(n=this.path._getOccurrenceFromRootOccurrence(r))&&(a=n.matAppOverride,(s=this.materialApplication)._depth=o,a&&!s.isPrioritary(a,o)||(n.matAppOverride=s.clone()),s._depth=-1);else for(t=this.path._getOccurrences(null),i=0;i<t.length;i++)(n=t[i]).matAppOverride=null},i.prototype.apply_internal=function(t){var i,r,n=this.path.externalPath[0]._occurrences,a=this.path.getLastElement(),s=a&&a instanceof e.SGPrimitiveHelper?[a]:a.getPrimitives();for(r=0;r<n.length;r++)i=n[r],this.applyToRootOccurrence_internal(t,i,s)},i.prototype.applyToRootOccurrence_internal=function(e,t,i){var r=this.path._getOccurrenceFromRootOccurrence(t);if(r){for(var n=r._getRenderableOccurrences(),a=n.length,s=0;s<a;s++){var o=n[s];o&&o._flagAsGSSOInvalidated()}if(i){var l=e?this.materialApplication.clone():null;l&&(l._depth=t.depth);for(s=0;s<n.length;s++)this.applyToRenderable(n[s],i,l)}}},i.prototype.applyToRenderable=function(e,t,i){null===e.layer&&e.initLayers(1),e.layer.addPrimitivesToLayers(t,1,void 0,void 0,i)};var r=function(e){this.root=e,this._overrides=[]};return r.prototype.addStaticOverride=function(e,t){if(e.externalPath[0]===this.root){var r=new i(e,t);return this._overrides.push(r),r.id}return-1},r.prototype.clear=function(){this._deactivateStaticOverrides(),this._overrides=[]},r.prototype.applyStaticOverrides=function(){var e;for(e=0;e<this._overrides.length;e++)this._overrides[e].apply(!0)},r.prototype._deactivateStaticOverrides=function(){var e;for(e=0;e<this._overrides.length;e++)this._overrides[e].apply(!1)},r}),define("DS/Visualization/XMLV43Loader",["DS/VisuLoaders/XMLV43Loader"],function(e){"use strict";return e}),define("Visualization/XMLV43Loader",["DS/Visualization/XMLV43Loader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/XMLV43Loader"),e}),define("DS/Visualization/Utils",["UWA/Class","UWA/Utils","DS/Visualization/ProxyAbstraction"],function(e,t,i){"use strict";var r=e.extend({init:function(){}});return r.parseUrl=function(e){return t.parseUrl(e)},r.getExtension=function(e){var t=e.replace(/\.\./g,"");if(1===(t=t.split(".")).length||""===t[0]&&2===t.length)return"";var i=t.pop(),r=i.indexOf("?")+1;return t=r?i.substring(0,r-1):i,null!==new RegExp(/^[a-zA-Z0-9_]+$/).exec(t)?t:""},r.getDomain=function(e){var i=e;return t.isAbsoluteUrl(e)||(i=window.location),r.parseUrl(i).hostname},r.getWorkerFromSpec=function(e,t){var n=window.URL||window.webkitURL,a=new i;r.setProxyFromSpec(e,a);var s=e.serverurl?e.serverurl:"";s+=e.filename?e.filename:"";a.executeGetHttpRequest(s,"blob",null,function(e){var i=n.createObjectURL(e),r=new Worker(i);t&&t(r)})},r.getJSFromSpec=function(e,t){var n=new i;r.setProxyFromSpec(e,n);var a=e.serverurl?e.serverurl:"";a+=e.filename?e.filename:"",e.module&&e.filename&&(a=require.toUrl("DS/"+e.module+"/"+e.filename));n.executeGetHttpRequest(a,"text",null,function(e){t&&t(e)},null,"text/plain, text/javascript, application/javascript, application/x-javascript")},r.getWorkerFromSpecs=function(e,t){var i=window.URL||window.webkitURL,n="",a=function(s){r.getJSFromSpec(e[s],function(r){if(n+=r,s<e.length-1)a(s+1);else if(t){var o=new Blob([n],{type:"application/javascript"}),l=i.createObjectURL(o),h=new Worker(l);t(h)}})};a(0)},r.getWorkerBlobFromSpecs=function(e,t){var i=window.URL||window.webkitURL,n="",a=function(s){r.getJSFromSpec(e[s],function(r){if(n+=r,s<e.length-1)a(s+1);else if(t){var o=new Blob([n],{type:"application/javascript"}),l=i.createObjectURL(o);t(l)}})};a(0)},r.getFileURLFromSpec=function(e,t){var n=window.URL||window.webkitURL,a=new i;r.setProxyFromSpec(e,a);var s=e.serverurl?e.serverurl:"";s+=e.filename?e.filename:"";a.executeGetHttpRequest(s,"blob",null,function(e){var i=n.createObjectURL(e);t&&t(i)})},r.getFilesURLFromSpec=function(e,t){var i=[],n=function(a){r.getFileURLFromSpec(e[a],function(r){i.push(r),a<e.length-1?n(a+1):t&&t(i)})};n(0)},r.setProxyFromSpec=function(e,t){if(e.proxyurl)if("none"===e.proxyurl)t.useNoProxy(e.withCredentials);else{var i=r.parseUrl(e.proxyurl);if(null===i)t.useUWAProxy();else if(null!=i.hostname)t.useProxyDefinedBy(i.hostname,i.port);else if(0==(n=e.proxyurl.indexOf("http://127.0.0.1"))){var n=e.proxyurl.lastIndexOf(":"),a=e.proxyurl.slice(n+1,e.proxyurl.length);a=a.replace("/",""),t.useProxyDefinedBy("127.0.0.1",8023)}}else t.useUWAProxy({proxymode:e.requiredAuth,requestsOptions:e.requestsOptions,login:e.login,contextid:e.contextid})},UWA.namespace("THREEDS/Utils",r)}),define("Visualization/Utils",["DS/Visualization/Utils","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Utils"),e}),define("DS/Visualization/FixedSizeArrayPool",["DS/Visualization/WidelinesHelper"],function(e){var t=function(){},i=0,r=0,n=new Map,a=null,s=null;localStorage.getItem("curvedPipesDebug")&&"true"===localStorage.getItem("curvedPipesDebug")&&(s={nbTokens:0,nbInstData:0,tokens:{},tokenPool:a,instData:{},maxNbInstances:{},instDataPool:n},window._debugTokenPool=s);var o=function(e,t,r){this.id=i++,this.idsArray=new Float32Array(2*e),this.idsBuffer=null,this.includesPicking=t,this.pickingColorArray=t?new Float32Array(3*e):null,this.pickingColorBuffer=null,this.lastId=-1,this.igId=r,this._maxNbInstances=e,this.key="",this.objectToIdInArray=new Map,this.idToObjectArray=new Map,this.updateData=!0,this._next=null,s&&(s.nbInstData++,s.instData[this.id]=this,s.maxNbInstances[e]?s.maxNbInstances[e]++:s.maxNbInstances[e]=1)};o.prototype.addInstance=function(e,t,i,r,n){if(this.lastId!==this._maxNbInstances-1){this.lastId++;var a=i.dgIndex+"_"+i.index,s=this.objectToIdInArray.get(a);void 0===s?(this.objectToIdInArray.set(a,this.lastId),this.idToObjectArray.set(this.lastId,a),s=this.lastId):console.log("what!!");var o=t.idInMaps,l=t.matrixId4,h=2*s;if(this.idsArray[h]=l,this.idsArray[h+1]=o*n,this.pickingColorArray){var c=3*s;this.pickingColorArray[c]=r.r,this.pickingColorArray[c+1]=r.g,this.pickingColorArray[c+2]=r.b}this.updateData=!0}else console.error("there has been an issue : not enough room to add instances")},o.prototype.removeInstances=function(e,t,i){for(var r=0;r<i.length&&-1!==this.lastId;r++){i[r].bin===this.igId&&this.removeInstance(e,t,r)}return-1===this.lastId},o.prototype.removeInstance=function(e,t,i){var r=e+"_"+t+"_"+i,n=this.objectToIdInArray.get(r),a=this.idToObjectArray.get(this.lastId);if(void 0!==n){if(this.objectToIdInArray.delete(r),this.idToObjectArray.delete(n),n!==this.lastId){var s=this.idsArray[2*this.lastId],o=this.idsArray[2*this.lastId+1];if(this.idsArray[2*n]=s,this.idsArray[2*n+1]=o,this.pickingColorArray){var l=this.pickingColorArray[3*this.lastId],h=this.pickingColorArray[3*this.lastId+1],c=this.pickingColorArray[3*this.lastId+2];this.pickingColorArray[3*n]=l,this.pickingColorArray[3*n+1]=h,this.pickingColorArray[3*n+2]=c}var d=this.objectToIdInArray.get(a);this.objectToIdInArray.set(a,n),this.idToObjectArray.delete(d),this.idToObjectArray.set(n,a),this.updateData=!0}this.lastId--}},o.prototype.copyDataTo=function(e){for(var t=this.idsArray.length,i=0;i<t;i++)e.idsArray[i]=this.idsArray[i];if(this.pickingColorArray){var r=this.pickingColorArray.length;for(i=0;i<r;i++)e.pickingColorArray[i]=this.pickingColorArray[i]}this.objectToIdInArray.forEach(function(t,i){e.objectToIdInArray.set(i,t)}),this.idToObjectArray.forEach(function(t,i){e.idToObjectArray.set(i,t)}),e.lastId=this.lastId,e.includesPicking=this.includesPicking,e.updateData=!0},o.prototype.resetForReuse=function(e){this.lastId=-1,this.igId=e,this.objectToIdInArray?this.objectToIdInArray.clear():this.objectToIdInArray=new Map,this.idToObjectArray?this.idToObjectArray.clear():this.idToObjectArray=new Map,null===this.idsArray&&(this.idsArray=new Float32Array(2*this._maxNbInstances)),this.includesPicking&&null===this.pickingColorArray&&(this.pickingColorArray=new Float32Array(3*this._maxNbInstances)),this.updateData=!0};var l=function(e,i,n,a,o,l,h){this.object=e,this.geometry=i,this.dg=n,this.start=a,this.count=o,this.attachment=null,this.next=null,this.doRenderLineModePolygonOffset={doIt:!1,enable:!1,unit:1,factor:1},this.doSetMaterialFaces={doubleSided:!1,forceSide:!1,flipSided:!1},this.draw=t,this.updateLineInfos=!1,this.matApp=l,this.gas=h,this._programID=0,e&&(this._programID|=e._programID),l&&(this._programID|=l._programID),s&&(this.__id=r++)};l.prototype.reset=function(){this.object=null,this.geometry=null,this.dg=null,this.start=0,this.count=0,this.matApp=null,this.gas=null,this._programID=0},l.prototype._updateWideLineAndPatternStuff=function(t,i,r,n){if(t.isWideLine||t.is2DLine){if(!i.renderVolumesOnly){t.pixelSize||(t.pixelSize=new n.Vector2);var a=i.domElement;if(t.pixelSize.x=2/a.width,t.pixelSize.y=2/a.height,r.fullWidth&&r.pickingRatioW&&(t.pixelSize.x/=r.pickingRatioW,t.pixelSize.y/=r.pickingRatioH),(l=this.geometry)&&t.isDashedLine&&t.isCPUPattern){var s=this.object;o=(new n.Matrix4).multiplyMatrices(r.matrixWorldInverse,s._getMMMatrix()),e._computePixelWideLineDistances(l,o,r.projectionMatrix,a,i.currentFrameIndex)}}}else if(t.isDashedLine&&!t.is2DLine){t.pixelSize||(t.pixelSize=new n.Vector2);a=i.domElement;if(t.pixelSize.x=2/a.width,t.pixelSize.y=2/a.height,t.isCPUPattern){var o;s=this.object;o=(new n.Matrix4).multiplyMatrices(r.matrixWorldInverse,s._getMMMatrix());var l=this.geometry;e._computePixelLineDistances(l,o,r.projectionMatrix,a,i.currentFrameIndex)}}if(this.dg&&this.dg._updateLineWithShapes){const e=new n.Matrix4(i.domElement.width/2,0,0,0,0,i.domElement.height/2,0,0,0,0,1,0,0,0,0,1).multiply(r.projectionMatrix).multiply(r.matrixWorldInverse).multiply(this.object._getMMMatrix());this.dg._updateLineWithShapes(e)}};var h=function(e,t,i,r,n,a,o,h){l.call(this,e,t,i,r,n,null,null),s&&(s.nbTokens++,s.tokens[this.__id]=this),this.autoInstancingData=c.prototype.allocate_autoInstData(a,o,h),this.instanced=!0};h.prototype.releaseAutoInstData=function(){var e=n.get(this.autoInstancingData.key)||null;this.autoInstancingData._next=e,n.set(this.autoInstancingData.key,this.autoInstancingData),s&&(s.nbInstData--,s.maxNbInstances[this.autoInstancingData._maxNbInstances]--,delete s.instData[this.autoInstancingData.id])};var c=function(){this.bySizePools={},this.pool5=this.bySizePools[5]={list:[],nextAvailable:0,lastCount:0},this.timerClean=void 0},d=null;return c.prototype.allocate=function(e,i,r,n,a,s,o){var h=null;if(d){h=d;d=d.next,h.object=e,h.geometry=i,h.dg=r,h.start=n,h.count=a,h.attachment=null,h.next=null,h.doRenderLineModePolygonOffset.doIt=!1,h.doRenderLineModePolygonOffset.enable=!1,h.doRenderLineModePolygonOffset.unit=1,h.doRenderLineModePolygonOffset.factor=1,h.doSetMaterialFaces.doubleSided=!1,h.doSetMaterialFaces.forceSide=!1,h.doSetMaterialFaces.flipSided=!1,h.draw=t,h.matApp=s,h.gas=o,h._programID=0,e&&(h._programID|=e._programID),s&&(h._programID|=s._programID)}else h=new l(e,i,r,n,a,s,o);return h},c.prototype.release=function(e){e.next=d,d=e,e.reset()},c.prototype.allocateInstancedCurvedPipeSection=function(e,i,r,n,o,l,d,u){var p=null;if(a){p=a;a=a.next,p.object=e,p.geometry=i,p.dg=r,p.start=n,p.count=o,p.attachment=null,p.next=null,p.higher=null,p.lower=null,p.doRenderLineModePolygonOffset.doIt=!1,p.doRenderLineModePolygonOffset.enable=!1,p.doRenderLineModePolygonOffset.unit=1,p.doRenderLineModePolygonOffset.factor=1,p.doSetMaterialFaces.doubleSided=!1,p.doSetMaterialFaces.forceSide=!1,p.doSetMaterialFaces.flipSided=!1,p.draw=t,p.autoInstancingData=c.prototype.allocate_autoInstData(l,d,u),s&&(s.nbTokens++,s.tokens[p.__id]=p)}else p=new h(e,i,r,n,o,l,d,u);return p},c.prototype.releaseInstanced=function(e){e.releaseAutoInstData(),e.autoInstancingData=null,e.next=a,a=e,s&&(s.nbTokens--,delete s.tokens[e.__id])},c.prototype.allocate_autoInstData=function(e,t,i){var r=e.toString()+(t?"p":""),a=n.get(r)||null,l=null;a?(l=a,n.set(r,a._next),l._next=null,l.resetForReuse(i),s&&(s.nbInstData++,s.maxNbInstances[e]?s.maxNbInstances[e]++:s.maxNbInstances[e]=1,s.instData[l.id]=l)):(l=new o(e,t,i)).key=r;var h=debugWebGLV6Viewer.renderer.renderer.context;return l.idsBuffer||(l.idsBuffer=h.createBuffer()),h.bindBuffer(h.ARRAY_BUFFER,l.idsBuffer),h.bufferData(h.ARRAY_BUFFER,l.idsArray,h.DYNAMIC_DRAW),t&&(l.pickingColorBuffer||(l.pickingColorBuffer=h.createBuffer()),h.bindBuffer(h.ARRAY_BUFFER,l.pickingColorBuffer),h.bufferData(h.ARRAY_BUFFER,l.pickingColorArray,h.DYNAMIC_DRAW)),l},c.prototype.dispose=function(){d=null,a=null,n.clear()},c}),define("Visualization/FixedSizeArrayPool",["DS/Visualization/FixedSizeArrayPool","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/FixedSizeArrayPool"),e}),define("DS/Visualization/GeometryProcessing",["DS/Mesh/ThreeJS_Base","DS/Visualization/ImplicitGeometries"],function(e,t){"use strict";const i=new Uint32Array(2),r=new Float64Array(i.buffer);function n(e,t){return e>t?(i[0]=e,i[1]=t):(i[0]=t,i[1]=e),Number.isFinite(r[0])?r[0]:`${e}:${t}`}const a=(1+Math.sqrt(5))/2,s=2*Math.PI*a,o=Math.PI*Math.sqrt(5),l=1/Math.sqrt(5),h=1/Math.log(a+1),c={PLANE:3,AXIS:2,POINT:1,NONE:0,space_none:()=>({type:c.NONE}),space_point:e=>({type:c.POINT,point:e}),space_axis:e=>({type:c.AXIS,axis:e}),space_plane:e=>({type:c.PLANE,plane:e}),compute(i,r=null){if(r||(r=[0,i.vertexIndexArray.length]),2!==r.length||r[1]<=r[0])return this.space_none();const n=i.vertexIndexArray;let a=r[0];const s=r[1];function o(e){return i.getVertexPosition(n[a],e),e}const l=new e.Vector3;o(l),a++;const h=new e.Vector3;for(;a<s&&o(h).distanceToSquared(l)<1e-6;)a++;if(a>=s)return this.space_point(l);const c=new t.InfiniteLine3(l,(new e.Vector3).subVectors(h,l));a++;const d=new e.Vector3;for(;a<s&&c.distanceToSquared(o(h),d)<1e-6;)a++;if(a>=s)return this.space_axis(c);const u=(new e.Vector3).crossVectors(c.axis,d.subVectors(h,l)).normalize(),p=new t.Plane(u,-u.dot(l));for(a++;a<s&&p.distanceToPointSquared(o(h))<1e-6;)a++;return a>=s?this.space_plane(p):this.space_none()},combine(e,t,i=1e-9){if(!e||!t)return e||t;switch(e.type){case c.POINT:switch(t.type){case c.POINT:return this._combine_point_point(e.point,t.point,i);case c.AXIS:return this._combine_point_axis(e.point,t.axis,i);case c.PLANE:return this._combine_point_plane(e.point,t.plane,i)}case c.AXIS:switch(t.type){case c.POINT:return this._combine_point_axis(t.point,e.axis,i);case c.AXIS:return this._combine_axis_axis(e.axis,t.axis,i);case c.PLANE:return this._combine_axis_plane(e.axis,t.plane,i)}case c.PLANE:switch(t.type){case c.POINT:return this._combine_point_plane(t.point,e.plane,i);case c.AXIS:return this._combine_axis_plane(t.axis,e.plane,i);case c.PLANE:return this._combine_plane_plane(e.plane,t.plane,i)}}return this.space_none()},fit({plane:e,space:t,transform:i}){switch(t.type){case c.NONE:return!1;case c.POINT:return e.containsPoint(t.point.clone().applyMatrix4(i));case c.AXIS:return e.containsInfiniteLine(t.axis.clone().applyMatrix4(i));case c.PLANE:return e.containsPlane(t.plane.clone().applyMatrix4(i));default:return!1}},_combine_point_point(t,i,r){return t.distanceToSquared(i)<r?this.space_point(t):this.space_axis(t,(new e.Vector3).subVectors(i,t))},_combine_point_axis(i,r,n){const a=new e.Vector3;return r.distanceToSquared(i,a)<n?this.space_axis(r):(a.subVectors(i,r.origin).cross(r.axis).normalize(),this.space_plane(new t.Plane(a,-a.dot(i))))},_combine_point_plane(e,t,i){return t.containsPoint(e,i)?this.space_plane(t):this.space_none()},_combine_axis_axis(i,r,n){const a=new e.Vector3;return i.distanceToSquared(r.origin,a)<n&&Math.abs(i.axis.dot(r.axis))>1-n?this.space_axis(i):(a.crossVectors(i.axis,r.axis).normalize(),this.space_plane(new t.Plane(a,-a.dot(i.origin))))},_combine_axis_plane(e,t,i){return t.containsInfiniteLine(e,i)?this.space_plane(t):this.space_none()},_combine_plane_plane(e,t,i){return e.containsPlane(t,i)?this.space_plane(e):this.space_none()}};return{deduplicateVerticesExactMatch:function(e,t=3){const i=e.length/t,r=new Float32Array(t),n=new Uint16Array(r.buffer);let a=null;switch(t){case 2:a=function(t){const i=2*t;return r[0]=e[i],r[1]=e[i+1],String.fromCharCode(n[0],n[1],n[2],n[3])};break;case 3:a=function(t){const i=3*t;return r[0]=e[i],r[1]=e[i+1],r[2]=e[i+2],String.fromCharCode(n[0],n[1],n[2],n[3],n[4],n[5])};break;default:a=function(i){const a=i*t;for(let i=0;i<t;i++)r[i]=e[a+i];return String.fromCharCode(...n)}}const s=new Map,o=i>65535?new Uint32Array(i):new Uint16Array(i);for(let e=0;e<i;e++){const t=a(e);let i=s.get(t);void 0===i&&s.set(t,i=e),o[e]=i}return o},mergeIndexBuffers:function(e){let t=!1,i=0;for(let r=0;r<e.length;r++)e[r]instanceof Uint32Array&&(t=!0),i+=e[r].length;const r=t?new Uint32Array(i):new Uint16Array(i);let n=0;for(let t=0;t<e.length;t++)r.set(e[t],n),n+=e[t].length;return r},computeFaceNormals:function({geom:t,index_ranges:i,alloc_output:r=null}){const n=t.vertexPositionArray,a=t.vertexIndexArray,s=r?r(a.length):new Float32Array(a.length);function o(e,t){e*=3,t.x=n[e],t.y=n[e+1],t.z=n[e+2]}const l=new e.Vector3,h=new e.Vector3,c=new e.Vector3;for(let e=0;e<i.length;e++){const t=i[e][0],r=i[e][1];for(let e=t;e<r;e+=3)o(a[e],l),o(a[e+1],h),o(a[e+2],c),c.sub(h),h.sub(l),h.cross(c),s[e]=h.x,s[e+1]=h.y,s[e+2]=h.z}return s},FitPlaneSpace:c,FibonacciSpiral:{get:function(t,i,r=null){const n=1-(2*t+1)/i,a=Math.sqrt(1-n*n),o=t*s,l=a*Math.cos(o),h=a*Math.sin(o);return r?r.set(l,h,n):r=new e.Vector3(l,h,n),r},inv:function(t,i){const r=1-1/i,n=Math.min(Math.atan2(t.y,t.x),Math.PI),s=t.z,c=e=>e-Math.floor(e),d=Math.max(2,Math.floor(Math.log(i*(1-s*s)*o)*h)),u=Math.pow(a,d)*l,p=Math.round(u),f=Math.round(u*a),g=2*p/i,m=2*f/i,v=2*Math.PI*(c((p+1)*a)-(a-1)),y=2*Math.PI*(c((f+1)*a)-(a-1)),S=1/(m*v-g*y),_=Math.floor(S*(m*n+y*(s-r))),x=Math.floor(S*(-g*n-v*(s-r)));let b=8,w=0,M=new e.Vector3;for(let e=0;e<4;e++){const r=Math.floor(e/2),n=e-2*r,a=Math.floor(p*(n+_)+f*(r+x));this.get(a,i,M);const s=t.distanceToSquared(M);s<b&&(b=s,w=a)}return w}},computeAdjacencyTriangleToTriangle:function({geom:e,index_ranges:t,deduplication:i=null,bijective:r=!0,result:a=null}){a||(a=new Uint32Array(e.vertexIndexArray.length));const s=new Map;function o(e,t,i,o){const l=n(e,t),h=s.get(l);void 0===h?s.set(l,4*i+o):(a[(h>>>2)+h%4]=1+4*i+o,r&&(a[i+o]=1+h),s.delete(l))}const l=e.vertexIndexArray,h=i?e=>i[l[e]]:e=>l[e];for(let e=0;e<t.length;e++){const i=t[e][0],r=t[e][1];for(let e=i;e<r;e+=3){const t=h(e+0),i=h(e+1),r=h(e+2);o(t,i,e,0),o(i,r,e,1),o(r,t,e,2)}}return{adjacency:a,boundary:s}},extractBoundaryEdges:function(e,t){let i=e.values(),r=i.next();const n=[];for(;!r.done;){const e=r.value>>>2,a=r.value%4;n.push(t[e+a]),n.push(t[e+(a+1)%3]),r=i.next()}return Uint32Array.from(n)},edgeKey:n}}),define("DS/Visualization/OutlineBuilder",["DS/Mesh/Mesh","DS/Visualization/GeometryProcessing"],function(e,t){"use strict";var i;class r{constructor(e){this.type=e,this.array=null}get(e=0){return(!this.array||this.array.length<e)&&(this.array=new this.type(this._alloc_size(e))),0===e?new this.type(this.array.buffer):new this.type(this.array.buffer,0,e)}realloc(e=0){if(!this.array)return this.get(e);if(0===e||this.array.length<e){const t=new this.type(this._alloc_size(e));t.set(this.array),this.array=t}return 0===e?new this.type(this.array.buffer):new this.type(this.array.buffer,0,e)}_alloc_size(e){return Math.max(this.array?2*this.array.length:10,e)}}new r(Uint32Array),new r(Uint32Array);function n({geom:e,adjTri2Tri:t,index_ranges:i=null}){const r=e.vertexIndexArray,n=e.vertexPositionArray;function a(e){const t=3*r[e+0],i=3*r[e+1],a=3*r[e+2],s=n[t],o=n[t+1],l=n[t+2],h=n[i],c=n[i+1],d=n[i+2],u=n[a]-s,p=n[a+1]-o,f=n[a+2]-l,g=h-s,m=c-o,v=d-l;return[p*v-f*m,f*g-u*v,u*m-p*g]}let s=[];function o(e,i,r){const n=t[i+r];n&&(function(e,t){const i=e[1]*t[2]-e[2]*t[1],r=e[2]*t[0]-e[0]*t[2],n=e[0]*t[1]-e[1]*t[0];return 0===i&&0===r&&0===n}(e,a(n-1>>>2))||s.push(4*i+r))}for(let e=0;e<i.length;e++){const t=i[e][0],r=i[e][1];for(let e=t;e<r;e+=3){const t=a(e);o(t,e,0),o(t,e,1),o(t,e,2)}}return new Uint32Array(s)}function a(e,t,i,r,n,a,s,o){for(let l=i;l<r;l+=3){const i=3*t[l],r=3*t[l+1],h=3*t[l+2],c=e[i],d=e[i+1],u=e[i+2],p=e[r],f=e[r+1],g=e[r+2],m=e[h]-c,v=e[h+1]-d,y=e[h+2]-u,S=p-c,_=f-d,x=g-u,b=n*(v*x-y*_)+a*(y*S-m*x)+s*(m*_-v*S);o[l+1]=b<0?-1:b>0?1:0}}const s=new r(Int8Array);new r(Uint32Array);const o=new r(Uint32Array);function l(e,i,r,l){const h=performance.now();let c=e.__deduplication;c||(c=e.__deduplication=t.deduplicateVerticesExactMatch(e.vertexPositionArray,e.compressedVertices?2:3));const d=performance.now();e.__segmentEdges||(e.__segmentEdges=new Map);let u=e.__segmentEdges.get(r);if(!u){const a=t.computeAdjacencyTriangleToTriangle({geom:e,index_ranges:i,deduplication:c,bijective:!1,result:e.__adjTri2Tri});u={boundary:t.extractBoundaryEdges(a.boundary,e.vertexIndexArray),inner:n({geom:e,adjTri2Tri:a.adjacency,index_ranges:i})},e.__adjTri2Tri=a.adjacency,e.__segmentEdges.set(r,u)}const p=e.__adjTri2Tri,f=performance.now(),g=function({geom:e,view_direction:t,index_ranges:i}){const r=e.vertexIndexArray,n=e.vertexPositionArray,o=s.get(e.vertexIndexArray.length);for(let e=0;e<i.length;e++)a(n,r,i[e][0],i[e][1],t.x,t.y,t.z,o);return o}({geom:e,view_direction:l,index_ranges:i}),m=performance.now(),v=function({indices:e,adjTri2Tri:t,grouped_edges:i,tri_visibility:r}){let n=o.get(),a=0;function s(t){a+1>=n.length&&(n=o.realloc());const i=t>>>2,r=t%4;n[a++]=e[i+r],n[a++]=e[i+(r+1)%3]}const l=i.boundary,h=l.length;if(h>0)for(let e=0;e<h;e++)a>=n.length&&(n=o.realloc()),n[a++]=l[e];const c=i.inner,d=c.length;for(let e=0;e<d;e++){const i=c[e],n=i>>>2,a=t[n+i%4],o=a-1>>>2;a&&r[n+1]*r[o+1]<=0&&s(i)}return n.slice(0,a)}({indices:e.vertexIndexArray,adjTri2Tri:p,grouped_edges:u,index_ranges:i,tri_visibility:g}),y=performance.now();return window.time_outlines.dedup+=d-h,window.time_outlines.adj+=f-d,window.time_outlines.visibility+=m-f,window.time_outlines.outlines+=y-m,v}function h(e,t,r=!1){let n=new Map;function a(e,t,i,r){const a=n.get(e),s=a.get(t);s?s.push([i,i+r]):a.set(t,[[i,i+r]])}function s(e){n.get(e)||n.set(e,new Map)}if(e.layer)for(let r=0;r<e.layer.layers.length;r++){const n=e.layer.layers[r].drawableGroup,o=e.layer.layers[r].drawableInterval;o.skip(e,t)||(s(n.geometry),n._geomType===i.GeomTypeEnum.FACE&&a(n.geometry,0,o.start,o.count))}else{const t=e.geometry.length;for(let r=0;r<t;r++){const t=e.geometry[r];s(t);for(let e=0;e<t.drawingGroups.length;e++){const r=t.drawingGroups[e];if(r._geomType!==i.GeomTypeEnum.FACE)continue;const n=r.getPrimitivesCount();for(let e=0;e<n;e++){const i=r.getPrimitiveRep(e);a(t,i?i.cgmId:0,r.getPrimitiveStart(e),r.getPrimitiveCount(e))}0===n&&a(t,0,r.start,r.count)}}}const o=[];return n.forEach((e,t)=>{const i=[];e.forEach((e,t)=>i.push({ranges:function(e){if(e.length<2)return e;e.sort((e,t)=>e[0]-t[0]);let t=0;for(let i=1;i<e.length;i++){const r=e[t],n=e[i];n[0]>r[1]?e[++t]=n:n[1]>r[1]&&(r[1]=n[1])}return e.length=t+1,e}(e),id:t})),(r||i.length>0)&&o.push({geom:t,components:i})}),o.sort((e,t)=>e.geom.id-t.geom.id),o}function c(e,t,i=!1){let r=e.__outline_segments;return r||(r=e.__outline_segments=h(e,t,i)),r}function d({geom:e,new_indices:t=null,gl:i}){if(t){e.indexBufferGPU&&e.indexBufferGPU.numIndices<t.length?(e.indexBufferGPU.deallocate(i),e.indexBufferGPU=null):(e.markIndexStale(0,t.length),e.vertexBufferGPU&&(e.vertexBufferGPU.needsUpdate=!0)),e.vertexIndexArray=t;const r=e.drawingGroups[0];r.count=r._primitives[0].count=e.vertexIndexArray.length,e.wideLinesLinker&&e.wideLinesLinker.linkedGeometry.dispose()}return e}function u({width:e,color:t="#000000",show_hidden:r=!1,polite_color:n="#aaaaaa"}){const a=new i.Color(t),s=new i.Color(n),o={ProcessClipSpacePosition:"void ProcessClipSpacePosition(inout vec4 pos)\n\t\t\t\t{\n\t\t\t\t\t#ifndef USE_WIDELINE\n\t\t\t\t\t\tcP = pos;\n\t\t\t\t\t#else\n\t\t\t\t\t\tcP = vGetProjectionMatrix() * vGetWorldViewMatrix() * vec4(vGetAttribPosition(), 1.0);\n\t\t\t\t\t#endif\n\t\t\t\t}"},l=r?{ComputeAlbedo:`vec3 ComputeAlbedo()\n\t\t\t{\n\t\t\t\tbool occluded = correctZFighting();\n\t\t\t\tgl_FragDepthEXT = occluded ? 0.001 : 0.0;\n\t\t\t\treturn occluded ? vec3(${s.r}, ${s.g}, ${s.b}) : vec3(${a.r}, ${a.g}, ${a.b});\n\t\t\t}`}:{ComputeDiscard:"bool ComputeDiscard() { return correctZFighting(); }"};let h=new i.LineBasicMaterial({color:a,lineWidth:e,depthTest:r,force:!0});return h.activatePDSFX(),h.setPDSFXGlobalShaderCode("","\n\t\t\t#ifdef RENDER_TO_FLOAT_TEXTURE\n\n\t\t\t\tvec4 getNormalDepth(in vec2 coord)\n\t\t\t\t{\n\t\t\t\t\tvec4 res = texture2D( depthBuffer, coord );\n\t\t\t\t\tvec3 normal = normalize(2.0 * res.xyz - 1.0);\n\t\t\t\t\tfloat depth = res.w;\n\t\t\t\t\tif (depth < 0.01) depth = 1.0;\n\t\t\t\t\treturn vec4(normal,depth);\n\t\t\t\t}\n\n\t\t\t\tfloat getPolygonOffset(in vec2 coord,in vec3 vN, in float depth)\n\t\t\t\t{\n\t\t\t\t\tmat4 P = projectionMatrix;\n\t\t\t\t\tbool isPersp = P[2][3] == -1.0;\n\n\t\t\t\t\tfloat slopeFactor = isPersp ? 1.0 : 0.1;\n\n\t\t\t\t\tvec2 sr = vec2(2.0)/depthMapSize;\n\t\t\t\t\tvec2 vC = (gl_FragCoord.xy - 0.5) / depthMapSize;\n\t\t\t\t\tvC = 2.0*vC - 1.0;\n\n\t\t\t\t\tfloat K = dot(vec3(P[1][1] * (vC.x + P[2][0]), P[0][0] * (vC.y + P[2][1]), -P[0][0] * P[1][1]), vN);\n\t\t\t\t\tvec2 offset = vec2(P[1][1] * vN.x*sr.x, P[0][0] * vN.y*sr.y);\n\n\t\t\t\t\tfloat factor = (-depth - 0.5 * (P[2][2] - 1.0)) / K;\n\t\t\t\t\tfloat dFdxOfZ = abs(offset.x * factor);\n\t\t\t\t\tfloat dFdyOfZ = abs(offset.y * factor);\n\n\t\t\t\t\tfloat slope = max(dFdxOfZ, dFdyOfZ);\n\t\t\t\t\tslope = min(max(slope, 1e-6), 1e-3);\n\n\t\t\t\t\treturn (slope * slopeFactor) + (DEPTH_PRECISION * 1.5);\n\t\t\t\t}\n\n\t\t\t\tfloat getOffsetedDepth(in vec2 coord)\n\t\t\t\t{\n\t\t\t\t\tvec4 nDepth = getNormalDepth(coord);\n\t\t\t\t\tfloat offset = getPolygonOffset(coord,nDepth.xyz,nDepth.w);\n\t\t\t\t\treturn nDepth.w + offset;\n\t\t\t\t}\n\n\t\t\t\tfloat getDepth(in vec2 coord) { return getOffsetedDepth(coord); }\n\n\t\t\t#else\n\n\t\t\t\tfloat getDepth(in vec2 coord)\n\t\t\t\t{\n\t\t\t\t\tvec4 rgba_depth = texture2D( depthBuffer, coord );\n\t\t\t\t\tfloat depth = unpackRGBA(rgba_depth);\n\t\t\t\t\treturn depth > 1e-6 ? depth + 1.0* DEPTH_PRECISION : 1.0;\n\t\t\t\t}\n\n\t\t\t#endif\n\n\t\t\tfloat depthSampleTest(in vec2 coord, in float depth)\n\t\t\t{\n\t\t\t\tfloat fDepth = getDepth(coord);\n\t\t\t\treturn fDepth < depth ? 1.0 : 0.0;\n\t\t\t}\n\n\t\t\tbool correctZFighting()\n\t\t\t{\n\t\t\t\tvec2 coord  = 0.5 + 0.5 * cP.xy / cP.w;\n\t\t\t\tfloat depth = 0.5 + 0.5 * cP.z / cP.w - 0.00002;\n\n\t\t\t\tfloat dx0 = -0.5 / depthMapSize.x;\n\t\t\t\tfloat dy0 = -0.5 / depthMapSize.y;\n\t\t\t\tfloat dx1 = -dx0;\n\t\t\t\tfloat dy1 = -dy0;\n\n\t\t\t\tif(depth <= getDepth(coord)) return false;\n\n\t\t\t\tfloat num_closer = 0.0;\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( dx0, dy0 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( 0.0, dy0 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( dx1, dy0 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( dx0, 0.0 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( dx1, 0.0 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( dx0, dy1 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( 0.0, dy1 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer += (depth > getDepth(coord + vec2( dx1, dy1 )) ? 1.0 : 0.0);\n\t\t\t\tnum_closer /= 8.0;\n\n\t\t\t\t// if at this point enough tests failed, discard\n\t\t\t\treturn num_closer > 0.8;\n\t\t\t}"),h.setPDSFXOverridableFunctions(o,l),h.setPDSFXUniforms({depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new i.Vector2(.01,.01)}}),h.setPDSFXVaryings({cP:{type:"v4"}}),h._refreshPDSFXUniforms_private=function(e,t){e.requestRealDepthBuffer(),e.dBuffer&&(h.updatePDSFXUniform("depthBuffer",e.dBuffer),h.updatePDSFXUniform("depthMapSize",new i.Vector2(e.dBuffer.width,e.dBuffer.height)))},h}window.time_outlines={dedup:0,adj:0,visibility:0,outlines:0,total:0,old_setup:0,old_add_edges:0,old_sort_edges:0,old_process_edges:0,old_total:0,print_cpu:function(e=10){const t=t=>t.toFixed(1).padStart(e),i=["dedup".padStart(e),"adj".padStart(e),"visibility".padStart(e),"outlines".padStart(e),"total".padStart(e)].join(" / "),r=[t(this.dedup),t(this.adj),t(this.visibility),t(this.outlines),t(this.total)].join("   ").replaceAll(".",",");console.log(`Outline statistics (CPU):\n${i}\n${r}\n\n`)},print_gpu:function(e=10){const t=t=>t.toFixed(1).padStart(e),i=["setup".padStart(e),"add".padStart(e),"sort".padStart(e),"process".padStart(e),"total".padStart(e)].join(" / "),r=[t(this.old_setup),t(this.old_add_edges),t(this.old_sort_edges),t(this.old_process_edges),t(this.old_total)].join("   ").replaceAll(".",",");console.log(`Outline statistics (GPU):\n${i}\n${r}\n\n`)},print:function(e=10){this.print_cpu(e),this.print_gpu(e)}};let p=null,f=null;function g({width:e,showHiddenOutlines:t}){t&&!f?f=u({width:e,show_hidden:!0}):t||p||(p=u({width:e,show_hidden:!1}));const i=t?f:p;return i.setLineWidth(e),i}var m=function(e){for(var t=1;t<e;)t*=2;return t};class v{constructor(e){this._renderable=e,this.indexArray=null,this.firstIndicesArray=null,this.lastIndexArray=null,this._Id=0,this._edgeId=0,this.width=1}createNewGeometry(e){const t=THREEDS.Core,i=this.createMaterial(),r=this.createDg(i),n=new t.BufferGeometryDS;return n.drawingGroups=[],r.geometry=n,n.drawingGroups.push(r),n.vertexPositionArray=this.firstIndicesArray,n.vertexNormalArray=this.lastIndexArray,n.vertexIndexArray=this.indexArray,n.boundingSphere=this._renderable.boundingSphere,n.boundingBox=this._renderable.boundingBox,_.TexturesManager.addGeometriesOfRenderable(this._renderable,e),n}}class y extends v{constructor(e){super(e),this.width=1}initArrays(){this.indexArray=[],this.firstIndicesArray=[],this.lastIndexArray=[]}createFinalArrays(){this.indexArray=new Uint32Array(this.indexArray),this.firstIndicesArray=new Float32Array(this.firstIndicesArray),this.lastIndexArray=new Float32Array(this.lastIndexArray)}addFullEdgeIndices(e,t,i,r){const n=this.firstIndicesArray,a=this.lastIndexArray,s=this._edgeId;n[6*s]=e,n[6*s+1]=t,n[6*s+2]=i,n[6*s+3]=t,n[6*s+4]=e,n[6*s+5]=r,a[6*s]=r,a[6*s+1]=0,a[6*s+2]=0,a[6*s+3]=i,a[6*s+4]=0,a[6*s+5]=0,this._edgeId++}createMaterial(){return _.TexturesManager.createSimpleMaterial()}createDg(t){const i=this.firstIndicesArray.length/3,r=THREEDS.Core,n=new e.DrawingGroup(t,t,1,0,i,void 0,void 0,r.GeomTypeEnum._OUTLINE);return n.nonIndexed=!0,n}}class S extends v{constructor(e,t){super(e),this.width=t,this.curr_Id=0}initArrays(){this.indexArray=[],this.firstIndicesArray=[],this.lastIndexArray=[]}createFinalArrays(){this.indexArray=new Uint32Array(this.indexArray),this.firstIndicesArray=new Float32Array(this.firstIndicesArray),this.lastIndexArray=new Float32Array(this.lastIndexArray)}addFullEdgeIndices(e,t,i,r){const n=this.indexArray,a=this.firstIndicesArray,s=this.lastIndexArray;n[this._Id++]=this.curr_Id,n[this._Id++]=this.curr_Id+1,n[this._Id++]=this.curr_Id+2,n[this._Id++]=this.curr_Id+2,n[this._Id++]=this.curr_Id+1,n[this._Id++]=this.curr_Id+3,this.curr_Id+=4;const o=this._edgeId;a[12*o]=e,a[12*o+1]=t,a[12*o+2]=i,a[12*o+3]=t,a[12*o+4]=e,a[12*o+5]=r,a[12*o+6]=e,a[12*o+7]=t,a[12*o+8]=i,a[12*o+9]=t,a[12*o+10]=e,a[12*o+11]=r,s[12*o]=r,s[12*o+1]=-1,s[12*o+2]=0,s[12*o+3]=i,s[12*o+4]=2,s[12*o+5]=0,s[12*o+6]=r,s[12*o+7]=1,s[12*o+8]=0,s[12*o+9]=i,s[12*o+10]=-2,s[12*o+11]=0,this._edgeId++}createMaterial(){return _.TexturesManager.createWideMaterial(.5*this.width)}createDg(t){const i=this.indexArray.length,r=THREEDS.Core;return new e.DrawingGroup(t,t,4,0,i,void 0,void 0,r.GeomTypeEnum._OUTLINE)}}class _{constructor(e,t,i,r){this._renderable=e,this._oGeometry=1===t?new y(e):new S(e,t),_.TexturesManager.sortCount!==i&&(_.TexturesManager.clean(r),_.TexturesManager.sortCount=i)}computeOutlineGeometry(e){const i=performance.now();this._oGeometry.initArrays();const r=h(this._renderable,e,!0);if(0===r.length)return null;let a=0;for(let e=0;e<r.length;e++){const i=r[e],l=i.geom;l.__adjTri2Tri=null;const h=(e,t,i,r)=>{e!==t&&e!==i&&e!==r&&t!==i&&t!==r&&this._oGeometry.addFullEdgeIndices(a+e,a+t,a+i,a+r)};let c=l.__deduplication;c||(c=l.__deduplication=t.deduplicateVerticesExactMatch(l.vertexPositionArray,l.compressedVertices?2:3));const d=l.vertexIndexArray,u=e=>c[d[e]];function s(e,t){const i=e>>>2,r=e%4,n=t[i+r]-1,a=n>>>2,s=n%4;h(u(i+r),u(i+(r+1)%3),u(i+(r+2)%3),u(a+(s+2)%3))}function o(e){const t=e>>>2,i=e%4,r=u(t+(i+2)%3);h(u(t+i),u(t+(i+1)%3),r,r)}for(let e=0;e<i.components.length;e++){const r=i.components[e].ranges,a=t.computeAdjacencyTriangleToTriangle({geom:l,index_ranges:r,deduplication:c,bijective:!1,result:l.__adjTri2Tri});l.__adjTri2Tri=a.adjacency;{let e=a.boundary.values(),t=e.next();for(;!t.done;)o(t.value),t=e.next()}n({geom:l,adjTri2Tri:a.adjacency,index_ranges:r}).forEach(e=>s(e,a.adjacency))}a+=l.vertexPositionArray.length/3}const l=performance.now();return window.time_outlines.old_total+=l-i,this._oGeometry.createFinalArrays(),this._oGeometry.createNewGeometry(e)}}_.halfEdgesArray=[],_.convertOutlineGeometry=function(t,i,r,n){_.ConversionMaterialsManager.sortCount!==n&&(_.ConversionMaterialsManager.clean(),_.ConversionMaterialsManager.sortCount=n);var a=THREEDS.Core,s=null,o=null,l=null,h=0,c=0,d=t.vertexPositionArray,u=t.vertexNormalArray,p=t.vertexPositionArray.length,f=0,g=t.drawingGroups[0].material,m=0,v=0,y=0,S=0,x=0,b=0,w=0,M=0,C=null,P=0;if(i<r){P=4,m=(f=p/3)/2,h=2*p,c=3*f,s=new Float32Array(h),o=new Float32Array(h),l=new Uint32Array(c);for(var E=0;E<m;E++)l[w++]=M,l[w++]=M+1,l[w++]=M+2,l[w++]=M+2,l[w++]=M+1,l[w++]=M+3,M+=4,v=d[6*E],y=d[6*E+1],S=d[6*E+2],x=u[6*E],b=u[6*E+2],s[12*E]=v,s[12*E+1]=y,s[12*E+2]=S,s[12*E+3]=y,s[12*E+4]=v,s[12*E+5]=x,s[12*E+6]=v,s[12*E+7]=y,s[12*E+8]=S,s[12*E+9]=y,s[12*E+10]=v,s[12*E+11]=x,o[12*E]=x,o[12*E+1]=-1,o[12*E+2]=b,o[12*E+3]=S,o[12*E+4]=2,o[12*E+5]=b,o[12*E+6]=x,o[12*E+7]=1,o[12*E+8]=b,o[12*E+9]=S,o[12*E+10]=-2,o[12*E+11]=b;C=_.ConversionMaterialsManager.createWideMaterialFromOther(g,.5*r)}else{P=1,m=(f=t.vertexIndexArray.length)/6,h=p/2,c=f/3,s=new Float32Array(h),o=new Float32Array(h);for(E=0;E<m;E++)v=d[12*E],y=d[12*E+1],S=d[12*E+2],x=u[12*E],b=u[12*E+2],s[6*E]=v,s[6*E+1]=y,s[6*E+2]=S,s[6*E+3]=y,s[6*E+4]=v,s[6*E+5]=x,o[6*E]=x,o[6*E+1]=0,o[6*E+2]=b,o[6*E+3]=S,o[6*E+4]=0,o[6*E+5]=b;C=_.ConversionMaterialsManager.createSimpleMaterialFromWide(g)}a=THREEDS.Core;var A=new e.DrawingGroup(C,C,P,0,c,void 0,void 0,a.GeomTypeEnum._OUTLINE);A.nonIndexed=1===P;var T=new a.BufferGeometryDS;return T.drawingGroups=[],A.geometry=T,T.drawingGroups.push(A),T.vertexPositionArray=s,T.vertexNormalArray=o,T.vertexIndexArray=l,T.boundingSphere=t.boundingSphere,T.boundingBox=t.boundingBox,t.dispose(),t=null,T},_.convertWideWidth=function(e,t,i){_.ConversionMaterialsManager.sortCount!==i&&(_.ConversionMaterialsManager.clean(),_.ConversionMaterialsManager.sortCount=i);var r=e.drawingGroups[0].material,n=_.ConversionMaterialsManager.createWideMaterialFromOther(r,.5*t);e.drawingGroups[0].material=n},_.TexturesManager={sortCount:-1,nbVertices:0,newSimpleMaterial:function(e,t){return new THREEDS.Core._OutlineMaterial(e,t)},newWideMaterial:function(e,t,i){return new THREEDS.Core._WideOutlineMaterial(e,t,i)},addGeometriesOfRenderable:function(e,t){this.isClean=!1;var i=e.geometry.length,r=null,n=0;if(e.layer){var a={},s=[];for(l=0;l<e.layer.layers.length;l++){var o=e.layer.layers[l].drawableGroup;e.layer.layers[l].drawableInterval.skip(e,t)||(a[o.geometry.id]=o.geometry)}for(var l in a)s.push(a[l]);for(l=0;l<s.length;l++)this.geometriesAssociated.push({renderable:e,geom:s[l],renderableOffset:this.nbVertices}),n+=s[l].vertexPositionArray.length/3}else for(var l=0;l<i;l++)r=e.geometry[l],this.geometriesAssociated.push({renderable:e,geom:r,renderableOffset:this.nbVertices}),n+=r.vertexPositionArray.length/3;this.nbVertices+=n,this._updateTextureDefines()},_updateTextureDefines:function(){var e=this.nbVertices;this.textureDefines.NB_OUTLINE_MAPS=Math.ceil(e/this.maxTextureTotalSize);var t=e-Math.floor(e/this.maxTextureTotalSize)*this.maxTextureTotalSize,i=Math.sqrt(t),r=m(i),n=m(t/r);this.textureDefines.LAST_OUTLINE_MAP_SIZE_X=r,this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y=n},geometriesAssociated:[],textureDefines:{NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:-1,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0},maxTextureTotalSize:-1,isClean:!0,simpleOutlineMaterial:null,wideOutlineMaterials:null,createSimpleMaterial:function(){if(null!==this.simpleOutlineMaterial)return this.simpleOutlineMaterial;var e=this.newSimpleMaterial(null,null);return this.simpleOutlineMaterial=e,e},createWideMaterial:function(e){if(null===this.wideOutlineMaterials&&(this.wideOutlineMaterials={}),this.wideOutlineMaterials[e])return this.wideOutlineMaterials[e];var t=this.newWideMaterial(null,null,e);return this.wideOutlineMaterials[e]=t,t},finalize:function(){var e=THREEDS.Core,t=this.textureDefines.NB_OUTLINE_MAPS;if(0!==t){for(var i=this.maxTextureTotalSize,r=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X,n=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y,a=3*((t-1)*i+r*n),s=new Float32Array(a),o=0,l=this.geometriesAssociated,h=l.length,c=null,d=(c=null,null),u=0,p=null,f=0;f<h;f++){c=l[f].geom,u=l[f].renderableOffset,d=l[f].renderable,s.set(c.vertexPositionArray,o);for(var g=(p=d.outlinesGeometry.geometry).vertexNormalArray.length/3,m=0;m<g;m++)p.vertexNormalArray[3*m+2]=u;o+=c.vertexPositionArray.length}for(var v=[],y=0;y<t-1;y++){(S=new e.DataTexture(s.subarray(y*i*3,(y+1)*i*3),maxTextureSize,maxTextureSize,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,S.magFilter=e.NearestFilter,S.generateMipmaps=!1,S.flipY=!1,S.needsUpdate=!0,v.push(S)}var S;if((S=new e.DataTexture(s.subarray((t-1)*i*3,a),r,n,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,S.magFilter=e.NearestFilter,S.generateMipmaps=!1,S.flipY=!1,S.needsUpdate=!0,v.push(S),null!==this.simpleOutlineMaterial){this.simpleOutlineMaterial.defines.NB_OUTLINE_MAPS=this.textureDefines.NB_OUTLINE_MAPS,this.simpleOutlineMaterial.defines.MAX_OUTLINE_MAP_SIZE=this.textureDefines.MAX_OUTLINE_MAP_SIZE.toFixed(1),this.simpleOutlineMaterial.defines.LAST_OUTLINE_MAP_SIZE_X=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X.toFixed(1),this.simpleOutlineMaterial.defines.LAST_OUTLINE_MAP_SIZE_Y=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y.toFixed(1);var _={occludedColor:{type:"v3",value:new e.Vector3(this.simpleOutlineMaterial.occludedColor.r,this.simpleOutlineMaterial.occludedColor.g,this.simpleOutlineMaterial.occludedColor.b)},outlinePositionMaps:{type:"t2v",value:v,length:this.simpleOutlineMaterial.defines.NB_OUTLINE_MAPS},depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new e.Vector2(.01,.01)}};this.simpleOutlineMaterial.setPDSFXUniforms(_)}if(null!==this.wideOutlineMaterials){var x=null;for(var b in this.wideOutlineMaterials){(x=this.wideOutlineMaterials[b]).defines.NB_OUTLINE_MAPS=this.textureDefines.NB_OUTLINE_MAPS,x.defines.MAX_OUTLINE_MAP_SIZE=this.textureDefines.MAX_OUTLINE_MAP_SIZE.toFixed(1),x.defines.LAST_OUTLINE_MAP_SIZE_X=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X.toFixed(1),x.defines.LAST_OUTLINE_MAP_SIZE_Y=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y.toFixed(1);_={occludedColor:{type:"v3",value:new e.Vector3(x.occludedColor.r,x.occludedColor.g,x.occludedColor.b)},outlinePositionMaps:{type:"t2v",value:v,length:x.defines.NB_OUTLINE_MAPS},depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new e.Vector2(.01,.01)},outlineHalfWidth:{type:"f",value:parseFloat(b)},pixelSize:{type:"v2",value:new e.Vector2}};x.setPDSFXUniforms(_)}}}},clean:function(e){if(this.isClean=!0,this.simpleOutlineMaterial=null,this.wideOutlineMaterials=null,this.nbVertices=0,this.textureDefines.MAX_OUTLINE_MAP_SIZE<0){var t=e.getParameter(e.MAX_TEXTURE_SIZE);this.textureDefines.MAX_OUTLINE_MAP_SIZE=t,this.maxTextureTotalSize=t*t}this.textureDefines.NB_OUTLINE_MAPS=0,this.textureDefines.LAST_OUTLINE_MAP_SIZE_X=0,this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y=0,this.geometriesAssociated.length=0}},_.ConversionMaterialsManager={sortCount:-1,simpleOutlineMaterials:null,wideOutlineMaterials:null,createSimpleMaterialFromWide:function(e){null===this.simpleOutlineMaterials&&(this.simpleOutlineMaterials={});var t=e.getPDSFXUniform("outlinePositionMaps").value;if(this.simpleOutlineMaterials[t[0].id])return this.simpleOutlineMaterials[t[0].id];var i=e.defines,r=_.TexturesManager.newSimpleMaterial(i,t);return this.simpleOutlineMaterials[t[0].id]=r,r},createWideMaterialFromOther:function(e,t){null===this.wideOutlineMaterials&&(this.wideOutlineMaterials={});var i=e.getPDSFXUniform("outlinePositionMaps").value;if(this.wideOutlineMaterials[t]||(this.wideOutlineMaterials[t]={}),this.wideOutlineMaterials[t][i[0].id])return this.wideOutlineMaterials[t][i[0].id];var r=e.defines,n=_.TexturesManager.newWideMaterial(r,i,t);return this.wideOutlineMaterials[t][i[0].id]=n,n},clean:function(){this.simpleOutlineMaterials=null,this.wideOutlineMaterials=null}};const x={fetchFromOccurrences({object:e,width:t,viewDirection:i}){let r=e.outlinesGeometry;if(r&&r.geometry||e.layer)return r;const n=e._occurrence.node._occurrences;for(let a=0;a<n.length;a++){const s=n[a].renderable,o=s.outlinesGeometry;if(s!==e&&o&&o.geometry&&!s.layer&&(t===o.outlineWidth&&!i==!o.viewDirection&&(!i||i.equals(o.viewDirection)))){r&&r.dispose(),e.outlinesGeometry=r=o,r.refs++;break}}return r},implementation(e){const t=e.outlinesGeometry;if(t)return t.viewDirection?"cpu":"gpu"},isOutdated({object:e,viewDirection:t}){let i=e.outlinesGeometry;return!!i&&(!i.upToDate||e.layer&&!e.layer.upToDate||i.viewDirection&&!t)},updateMaterialGPU({object:e,width:t,showHiddenOutlines:i,_sortCount:r}){const n=e.outlinesGeometry;let a=n&&n.geometry;if(!a)return;a.drawingGroups[0].material.setShowHiddenOutlines(i);const s=n.outlineWidth;s!==t&&(n.outlineWidth=t,1===s||1===t?(e.clearOutlines(),e.layer&&(e.layer.upToDate=!0)):_.convertWideWidth(n.geometry,t,r))},updateMaterialCPU({object:e,width:t,showHiddenOutlines:i}){const r=e.outlinesGeometry;let n=r&&r.geometry;if(!n)return;if(!(r.outlineWidth!==t||r.showHiddenOutlines!==i))return;r.outlineWidth=t,r.showHiddenOutlines=i;const a=g({width:t,showHiddenOutlines:i});for(let e=0;e<n.length;e++)n[e].drawingGroups[0].material=a},create({object:t,viewDirection:r,width:n,_sortCount:a,_gl:s,showHiddenOutlines:o,visibleSpace:l}){let h=null;if(r){const r=g({width:n,showHiddenOutlines:o});h=c(t).map(n=>(function({renderable:t,material:r,vertexSourceGeometry:n=null,indices:a=null}){const s=new i.BufferGeometryDS;s.vertexIndexArray=a,n&&(s.vertexPositionArray=n.vertexPositionArray,s.vertexBufferGPU=n.vertexBufferGPU,s.vertexOffsetGPU=n.vertexOffsetGPU),s.vertexBufferGPU&&s.vertexBufferGPU.nbGeometries++,s.boundingSphere=t.boundingSphere,s.boundingBox=t.boundingBox;const o=a?a.length:0,l={start:0,count:o},h=new e.DrawingGroup(r,r,1,0,o,[l],void 0,i.GeomTypeEnum._OUTLINE);return s.drawingGroups=[h],h.geometry=s,s})({renderable:t,material:r,vertexSourceGeometry:n.geom})),_.TexturesManager.sortCount!==a&&(_.TexturesManager.clean(s),_.TexturesManager.sortCount=a)}else{(h=new _(t,n,a,s).computeOutlineGeometry(l))&&(h.noMeshInRAM=!0,h.drawingGroups[0].material.setShowHiddenOutlines(o))}return h?(t.outlinesGeometry={geometry:h,outlineWidth:n,showHiddenOutlines:o,viewDirection:r,upToDate:!0,refs:1,dispose(){this.refs--,0===this.refs&&(Array.isArray(this.geometry)?this.geometry.forEach(e=>e.dispose()):this.geometry&&this.geometry.dispose()),this.geometry=null}},h):null},prepare({object:e,width:t,viewDirection:r,_sortCount:n,_gl:a,showHiddenOutlines:s,visibleSpace:o}){if(i=THREEDS.Core,e._isDecal())return{outlineBG:[],created:!1,invalidateGSSO:!1};switch(x.fetchFromOccurrences({object:e,width:t,viewDirection:r}),x.isOutdated({object:e,viewDirection:r})&&(e.clearOutlines(),e.layer&&(e.layer.upToDate=!0)),x.implementation(e)){case"cpu":x.updateMaterialCPU({object:e,width:t,showHiddenOutlines:s});break;case"gpu":x.updateMaterialGPU({object:e,width:t,showHiddenOutlines:s,_sortCount:n})}let l=e.outlinesGeometry&&e.outlinesGeometry.geometry,h=!1;null===l&&(h=!!(l=x.create({object:e,viewDirection:r,width:t,_sortCount:n,_gl:a,showHiddenOutlines:s,visibleSpace:o})));const c=l&&!e.outlinesGeometry.viewDirection;return l?Array.isArray(l)||(l=[l]):l=[],{outlineBG:l,created:h,invalidateGSSO:c}},refresh({object:e,viewDirection:r,width:n,gl:a,visibleSpace:s}){i=THREEDS.Core;let o=e.outlinesGeometry;if(!o)return;let h=o.geometry;if(h)if(!r==!o.viewDirection){if(r){if(0===h.length)return;x.updateMaterialCPU({object:e,width:n,showHiddenOutlines:o.showHiddenOutlines});let i=!1;for(let e=0;e<h.length;e++)h[e].vertexIndexArray||(i=!0);if(!i&&o.viewDirection.equals(r))return;!function({renderable:e,view_direction:i,geometry:r=null,gl:n,visibleSpace:a}){const s=performance.now();let o=c(e,a);r||(r=Array(o.length));for(let e=0;e<o.length;e++){const a=o[e],s=a.geom;let h=[];for(let e=0;e<a.components.length;e++){const t=a.components[e];h.push(l(s,t.ranges,t.id,i))}h=t.mergeIndexBuffers(h),d({geom:r[e],new_indices:h,gl:n})}const h=performance.now();window.time_outlines.total+=h-s}({renderable:e,view_direction:r,geometry:h,gl:a,visibleSpace:s}),o.viewDirection=r}else if(o.outlineWidth!==n)return void e._flagAsGSSOInvalidated()}else e._flagAsGSSOInvalidated()}};return _.prepareOutlines=function(e){return x.prepare(e)},_.refreshOutlines=function(e){return x.refresh(e)},_}),define("DS/Visualization/CullingSystem",["DS/Visualization/WebGLObjectManager","DS/Object3D/Camera"],function(e,t){"use strict";var i=0,r={_INVISIBLE:0,_VISIBLE:1,_FRESH:2},n={_GSSO:0,_REMOVE_AND_GSSO:1,_REMOVE:2,_NOTHING:3,_SKIP:4},a=function(e){this.webglObject=e,this.invalidated=!0,this.previousCullingStatus=r._FRESH,this.action=n._NOTHING,this.previousRenderPointsOnly=!1,this.currentRenderPointsOnly=!1,this.object=e.object},s=function(){this.map=new Map};s.prototype.get=function(e,t){var i=null,r=this.map.get(e.id);return r||(r=new Map,this.map.set(e.id,r)),(i=r.get(t))||(i=new l(e),r.set(t,i),e._cullingSystems.push(i)),i},s.prototype.resetCullingStatuses=function(e){this.map.forEach(function(t,i){t.forEach(function(t,i){t._resetCullingStatuses(e)})})},s.prototype.dispose=function(){this.map.clear()};var o=new s,l=function(e){this.id=i++,this.scene=e,this.objectManagers={},this.lastComposerContextsSeen=new Set,this.currComposerContextsSeen=new Set};return l.prototype.isSet=function(e){return!!this.objectManagers[e]},l.prototype.setFromIdString=function(t,i){this.objectManagers[t]={list:new e,frame:-1};for(var r=this.objectManagers[t].list,n=this.scene.getWebGLObjects(t,i),s=n.length,o=0;o<s;o++)r.add(null===n[o]?null:new a(n[o]))},l.prototype.getWebGLObjects=function(e,t){this.scene.getWebGLObjects(this.idString,t);return this.objectManagers&&this.objectManagers[e]&&this.objectManagers[e].list?this.objectManagers[e].list.getObjects(t):[]},l.prototype._resetCullingStatuses=function(e){for(var t in this.objectManagers)this.objectManagers[t].frame=-1;if(this.currComposerContextsSeen.size>0){var i=this;this.lastComposerContextsSeen.clear(),this.currComposerContextsSeen.forEach(function(e){i.lastComposerContextsSeen.add(e)}),this.currComposerContextsSeen.clear()}},{WebGLObjectCullingStatus:a,__CullingSystemFactory:o,CullingSystem:l,VISIBILITY_STATUS:r,INCREMENTAL_ACTIONS:n}}),define("DS/Visualization/Shapes",["DS/Mesh/ThreeJS_Base","DS/Visualization/Curves"],function(e,t){"use strict";let i={};var r,n,a;return i.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(e){var t=e.familyName.toLowerCase();this.faces[t]=this.faces[t]||{},this.faces[t][e.cssFontWeight]=this.faces[t][e.cssFontWeight]||{},this.faces[t][e.cssFontWeight][e.cssFontStyle]=e;this.faces[t][e.cssFontWeight][e.cssFontStyle]=e;return e},drawText:function(e){var i,r=this.getFace(),n=this.size/r.resolution,a=0,s=String(e).split(""),o=s.length,l=[];for(i=0;i<o;i++){var h=new t.Path,c=this.extractGlyphPoints(s[i],r,n,a,h);a+=c.offset,l.push(c.path)}return{paths:l,offset:a/2}},extractGlyphPoints:function(e,t,r,n,a){var s,o,l,h,c,d,u,p,f,g,m,v,y,S,_,x,b,w,M=[],C=t.glyphs[e]||t.glyphs["?"];if(C){if(C.o)for(c=(h=C._cachedOutline||(C._cachedOutline=C.o.split(" "))).length,d=r,u=r,s=0;s<c;)switch(h[s++]){case"m":p=h[s++]*d+n,f=h[s++]*u,a.moveTo(p,f);break;case"l":p=h[s++]*d+n,f=h[s++]*u,a.lineTo(p,f);break;case"q":if(g=h[s++]*d+n,m=h[s++]*u,S=h[s++]*d+n,_=h[s++]*u,a.quadraticCurveTo(S,_,g,m),w=M[M.length-1])for(v=w.x,y=w.y,o=1,l=this.divisions;o<=l;o++){var P=o/l;i.Shape.Utils.b2(P,v,S,g),i.Shape.Utils.b2(P,y,_,m)}break;case"b":if(g=h[s++]*d+n,m=h[s++]*u,S=h[s++]*d+n,_=h[s++]*-u,x=h[s++]*d+n,b=h[s++]*-u,a.bezierCurveTo(g,m,S,_,x,b),w=M[M.length-1])for(v=w.x,y=w.y,o=1,l=this.divisions;o<=l;o++)P=o/l,i.Shape.Utils.b3(P,v,S,x,g),i.Shape.Utils.b3(P,y,_,b,m)}return{offset:C.ha*r,path:a}}}},i.FontUtils.generateShapes=function(e,t){var r=void 0!==(t=t||{}).size?t.size:100,n=void 0!==t.curveSegments?t.curveSegments:4,a=void 0!==t.font?t.font:"helvetiker",s=void 0!==t.weight?t.weight:"normal",o=void 0!==t.style?t.style:"normal";i.FontUtils.size=r,i.FontUtils.divisions=n,i.FontUtils.face=a,i.FontUtils.weight=s,i.FontUtils.style=o;for(var l=i.FontUtils.drawText(e).paths,h=[],c=0,d=l.length;c<d;c++)Array.prototype.push.apply(h,l[c].toShapes());return h},r=i.FontUtils,n=function(e){for(var t=e.length,i=0,r=t-1,n=0;n<t;r=n++)i+=e[r].x*e[n].y-e[n].x*e[r].y;return.5*i},a=function(e,t,i,r,n,a){var s,o,l,h,c,d,u,p,f,g,m,v,y,S,_;if(o=e[a[t]].x,l=e[a[t]].y,h=e[a[i]].x,c=e[a[i]].y,d=e[a[r]].x,1e-10>(h-o)*((u=e[a[r]].y)-l)-(c-l)*(d-o))return!1;for(g=d-h,m=u-c,v=o-d,y=l-u,S=h-o,_=c-l,s=0;s<n;s++)if(s!==t&&s!==i&&s!==r&&(p=e[a[s]].x,g*((f=e[a[s]].y)-c)-m*(p-h)>=0&&v*(f-u)-y*(p-d)>=0&&S*(f-l)-_*(p-o)>=0))return!1;return!0},r.Triangulate=function(e,t){var i=e.length;if(i<3)return null;var r,s,o,l=[],h=[],c=[];if(n(e)>0)for(s=0;s<i;s++)h[s]=s;else for(s=0;s<i;s++)h[s]=i-1-s;var d=i,u=2*d;for(s=d-1;d>2;){if(u--<=0)return console.log("Warning, unable to triangulate polygon!"),t?c:l;if(d<=(r=s)&&(r=0),d<=(s=r+1)&&(s=0),d<=(o=s+1)&&(o=0),a(e,r,s,o,d,h)){var p,f,g,m,v;for(p=h[r],f=h[s],g=h[o],l.push([e[p],e[f],e[g]]),c.push([h[r],h[s],h[o]]),m=s,v=s+1;v<d;m++,v++)h[m]=h[v];u=2*--d}}return t?c:l},r.Triangulate.area=n,i.Shape=function(){t.Path.apply(this,arguments),this.holes=[]},i.Shape.prototype=Object.create(t.Path.prototype),i.Shape.prototype.extrude=function(t){return new e.ExtrudeGeometry(this,t)},i.Shape.prototype.makeGeometry=function(t){return new e.ShapeGeometry(this,t)},i.Shape.prototype.getPointsHoles=function(e){var t,i=this.holes.length,r=[];for(t=0;t<i;t++)r[t]=this.holes[t].getTransformedPoints(e,this.bends);return r},i.Shape.prototype.getSpacedPointsHoles=function(e){var t,i=this.holes.length,r=[];for(t=0;t<i;t++)r[t]=this.holes[t].getTransformedSpacedPoints(e,this.bends);return r},i.Shape.prototype.extractAllPoints=function(e){return{shape:this.getTransformedPoints(e),holes:this.getPointsHoles(e)}},i.Shape.prototype.extractPoints=function(e){return this.useSpacedPoints?this.extractAllSpacedPoints(e):this.extractAllPoints(e)},i.Shape.prototype.extractAllSpacedPoints=function(e){return{shape:this.getTransformedSpacedPoints(e),holes:this.getSpacedPointsHoles(e)}},i.Shape.Utils={removeHoles:function(t,i){var r,n,a,s,o,l,h,c,d,u,p,f,g,m,v,y,S=t.concat(),_=S.concat(),x=[];for(o=0;o<i.length;o++){for(h=i[o],Array.prototype.push.apply(_,h),c=Number.POSITIVE_INFINITY,l=0;l<h.length;l++){p=h[l];var b=[];for(u=0;u<S.length;u++)f=S[u],d=p.distanceToSquared(f),b.push(d),d<c&&(c=d,a=l,s=u)}r=s-1>=0?s-1:S.length-1,n=a-1>=0?a-1:h.length-1;var w=[h[a],S[s],S[r]],M=e.FontUtils.Triangulate.area(w),C=[h[a],h[n],S[s]],P=e.FontUtils.Triangulate.area(C),E=s,A=a;a+=-1,(s+=1)<0&&(s+=S.length),s%=S.length,a<0&&(a+=h.length),a%=h.length,r=s-1>=0?s-1:S.length-1,n=a-1>=0?a-1:h.length-1,w=[h[a],S[s],S[r]];var T=e.FontUtils.Triangulate.area(w);C=[h[a],h[n],S[s]],M+P>T+e.FontUtils.Triangulate.area(C)&&(a=A,(s=E)<0&&(s+=S.length),s%=S.length,a<0&&(a+=h.length),a%=h.length,r=s-1>=0?s-1:S.length-1,n=a-1>=0?a-1:h.length-1),g=S.slice(0,s),m=S.slice(s),v=h.slice(a),y=h.slice(0,a);var D=[h[a],S[s],S[r]],I=[h[a],h[n],S[s]];x.push(D),x.push(I),S=g.concat(v).concat(y).concat(m)}return{shape:S,isolatedPts:x,allpoints:_}},triangulateShape:function(t,r){var n,a,s,o,l,h,c=i.Shape.Utils.removeHoles(t,r),d=c.shape,u=c.allpoints,p=c.isolatedPts,f=e.FontUtils.Triangulate(d,!1),g={};for(n=0,a=u.length;n<a;n++)void 0!==g[l=u[n].x+":"+u[n].y]&&console.log("Duplicate point",l),g[l]=n;for(n=0,a=f.length;n<a;n++)for(o=f[n],s=0;s<3;s++)void 0!==(h=g[l=o[s].x+":"+o[s].y])&&(o[s]=h);for(n=0,a=p.length;n<a;n++)for(o=p[n],s=0;s<3;s++)void 0!==(h=g[l=o[s].x+":"+o[s].y])&&(o[s]=h);return f.concat(p)},isClockWise:function(t){return e.FontUtils.Triangulate.area(t)<0},b2p0:function(e,t){var i=1-e;return i*i*t},b2p1:function(e,t){return 2*(1-e)*e*t},b2p2:function(e,t){return e*e*t},b2:function(e,t,i,r){return this.b2p0(e,t)+this.b2p1(e,i)+this.b2p2(e,r)},b3p0:function(e,t){var i=1-e;return i*i*i*t},b3p1:function(e,t){var i=1-e;return 3*i*i*e*t},b3p2:function(e,t){return 3*(1-e)*e*e*t},b3p3:function(e,t){return e*e*e*t},b3:function(e,t,i,r,n){return this.b3p0(e,t)+this.b3p1(e,i)+this.b3p2(e,r)+this.b3p3(e,n)}},i}),define("DS/Visualization/ThreeJS_R57",["DS/Mesh/ThreeJS_Base","DS/Visualization/FixedSizeArrayPool","DS/Visualization/OutlineBuilder","DS/Visualization/SectionBuilder","DS/Visualization/BufferGPUManager","DS/Shaders/DefaultShaders","DS/Shaders/LineDSShaders","DS/Visualization/ShaderChunk","UWA/Data","WebappsUtils/WebappsUtils","DS/Visualization/HighlightData","DS/Object3D/Object3D","DS/Object3D/Light","DS/Object3D/Camera","DS/Visualization/Materials","DS/Visualization/UniformsUtils","DS/Visualization/ShaderLib","DS/MaterialLibs/UniformsLib","DS/Shaders/DeferrableShaders","DS/Object3D/Mesh","DS/Object3D/Scene","DS/Visualization/WebGLObjectManager","DS/Visualization/CullingSystem","DS/GPUFormats/GPUFormats","DS/Visualization/ImplicitGeometries","DS/Visualization/ExplicitGeometries","DS/Visualization/Curves","DS/Visualization/Shapes","DS/Visualization/ImageUtils","DS/RenderEngineUtils/RenderEngineUtils","DS/Visualization/SkinningTransformation","DS/Visualization/Info"],function(e,t,i,r,n,a,s,o,l,h,c,d,u,p,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A,T,D,I){"use strict";window.SIMULATE_EXPERIENCE_PLAYER;var R={FrontSide:0,BackSide:1,DoubleSide:2};R.BoundaryPointRenderPointMask=e.GeomTypeEnum.BOUNDARY_POINT,R.SharpPointRenderPointMask=e.GeomTypeEnum.SHARP_POINT,R.SmoothPointRenderPointMask=e.GeomTypeEnum.SMOOTH_POINT,R.SurfacicPointRenderPointMask=e.GeomTypeEnum.SURFACIC_POINT,R.FreePointRenderPointMask=e.GeomTypeEnum.FREE_POINT,R.AllPointsRenderPointMask=R.BoundaryPointRenderPointMask|R.SharpPointRenderPointMask|R.SmoothPointRenderPointMask|R.SurfacicPointRenderPointMask|R.FreePointRenderPointMask,R.AllPointsButSurfacicPointsRenderPointMask=R.BoundaryPointRenderPointMask|R.SharpPointRenderPointMask|R.SmoothPointRenderPointMask|R.FreePointRenderPointMask,e.Constants=R,e.FrontSide=R.FrontSide,e.BackSide=R.BackSide,e.DoubleSide=R.DoubleSide,e.NoOccurrences="true"===localStorage.getItem("WebVisuPrivate_NoOccurrences"),e.disableJHGDev=!0,e.WebGLVersion=2,e._setForceDevicePixelRatio=function(e){this._forceDevicePixelRatio=e},e._forceDevicePixelRatio=-1,e.getDevicePixelRatio=function(){return-1!==this._forceDevicePixelRatio?this._forceDevicePixelRatio:window.devicePixelRatio},self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}},self.Int32Array=self.Int32Array||Array,self.Float32Array=self.Float32Array||Array,String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")};var O=new e.Color,L=e.__visibleInCurrentSpace,V=e.__visibleInCurrentSpaceSimple;!function(){for(var e=0,t=["ms","moz","webkit","o"],i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"];void 0===window.requestAnimationFrame&&(window.requestAnimationFrame=function(t){var i=Date.now(),r=Math.max(0,16-(i-e)),n=window.setTimeout(function(){t(i+r,!1)},r);return e=i+r,n}),window.cancelAnimationFrame=window.cancelAnimationFrame||function(e){window.clearTimeout(e)}}(),e.getColorHex=function(e){return O.set(e),O.getHex()},e.__renderTargetID=0,e.CullFaceNone=0,e.CullFaceBack=1,e.CullFaceFront=2,e.CullFaceFrontBack=3,e.FrontFaceDirectionCW=0,e.FrontFaceDirectionCCW=1,e.BasicShadowMap=0,e.PCFShadowMap=1,e.PCFSoftShadowMap=2,e.PCFInterpolShadowMap=3,e.PCFPoissonShadowMap=4,e.PCFOptimizedShadowMap=5,e.ESMShadowMap=6,e.ESMImprovedShadowMap=7,e.LowQuality=0,e.MediumQuality=1,e.HighQuality=2,e.NoShading=0,e.FlatShading=1,e.SmoothShading=2,e.FrontToBack=0,e.BackToFront=1,e.VertexColorType={NoColors:0,Face:1,RGBA:2,RGB:3,A:4,R:8,G:16,B:32},e.NoColors=e.VertexColorType.NoColors,e.FaceColors=e.VertexColorType.Face,e.VertexColors=e.VertexColorType.RGBA,e.VertexColorsRGBA=e.VertexColorType.RGBA,e.VertexColorsRGB=e.VertexColorType.RGB,e.VertexColorsA=e.VertexColorType.A,e.NoBlending=0,e.NormalBlending=1,e.AdditiveBlending=2,e.SubtractiveBlending=3,e.MultiplyBlending=4,e.CustomBlending=5,e.NormalDepthBlending=6,e.AlphaBlending=7,e.GroundShadowBlending=8,e.TransparentShadowBlending=9,e.OITAccumBlending=10,e.OITRevealBlending=11,e.AddEquation=100,e.SubtractEquation=101,e.ReverseSubtractEquation=102,e.MinEquation=103,e.MaxEquation=104,e.ZeroFactor=200,e.OneFactor=201,e.SrcColorFactor=202,e.OneMinusSrcColorFactor=203,e.SrcAlphaFactor=204,e.OneMinusSrcAlphaFactor=205,e.DstAlphaFactor=206,e.OneMinusDstAlphaFactor=207,e.DstColorFactor=208,e.OneMinusDstColorFactor=209,e.SrcAlphaSaturateFactor=210,e.MultiplyOperation=0,e.MixOperation=1,e.AddOperation=2,e.SmoothEdgeRenderLineModeMask=e.GeomTypeEnum.SMOOTH_EDGE,e.SharpEdgeRenderLineModeMask=e.GeomTypeEnum.SHARP_EDGE,e.WireEdgeRenderLineModeMask=e.GeomTypeEnum.WIRE_EDGE,e.BoundaryEdgeRenderLineModeMask=e.GeomTypeEnum.BOUNDARY_EDGE,e.HideAllRenderLineMode=0,e.OutlineMask=e.GeomTypeEnum._OUTLINE,e.SectionLineMask=e.GeomTypeEnum._SECTION_LINE,e.HideWireEdgesRenderLineMode=e.GeomTypeEnum.EDGE|e.SmoothEdgeRenderLineModeMask|e.SharpEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.HideSmoothEdgesRenderLineMode=e.GeomTypeEnum.EDGE|e.SharpEdgeRenderLineModeMask|e.WireEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.HideInternalEdgesRenderLineMode=e.WireEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.ShowAllRenderLineMode=e.GeomTypeEnum.EDGE|e.SmoothEdgeRenderLineModeMask|e.SharpEdgeRenderLineModeMask|e.WireEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.ShowOutlinesAndEdgesRenderLineMode=e.OutlineMask|e.ShowAllRenderLineMode,e.ShowOutlinesHideEdgesRenderLineMode=e.OutlineMask|e.HideAllRenderLineMode,e.BodyLinesMask=e.GeomTypeEnum.EDGE|e.SmoothEdgeRenderLineModeMask|e.SharpEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.NoNoZPriorityMask=e.GeomTypeEnum.EDGE|e.GeomTypeEnum.SHARP_EDGE|e.GeomTypeEnum.BOUNDARY_EDGE|e.GeomTypeEnum.SMOOTH_EDGE|e.GeomTypeEnum.HIDDEN_SEAM_EDGE,e.HideAllModelFaces=0,e.ShowAllFaces=e.GeomTypeEnum.FACE|e.GeomTypeEnum.INFINITE_FACE|e.GeomTypeEnum.AXIS_SYSTEM,e.BoundaryPointRenderPointMask=e.GeomTypeEnum.BOUNDARY_POINT,e.SharpPointRenderPointMask=e.GeomTypeEnum.SHARP_POINT,e.SmoothPointRenderPointMask=e.GeomTypeEnum.SMOOTH_POINT,e.SurfacicPointRenderPointMask=e.GeomTypeEnum.SURFACIC_POINT,e.FreePointRenderPointMask=e.GeomTypeEnum.FREE_POINT,e.AllPointsRenderPointMask=e.BoundaryPointRenderPointMask|e.SharpPointRenderPointMask|e.SmoothPointRenderPointMask|e.SurfacicPointRenderPointMask|e.FreePointRenderPointMask,e.AllPointsButSurfacicPointsRenderPointMask=e.BoundaryPointRenderPointMask|e.SharpPointRenderPointMask|e.SmoothPointRenderPointMask|e.FreePointRenderPointMask,e.BodyPointsMask=e.BoundaryPointRenderPointMask|e.SharpPointRenderPointMask|e.SmoothPointRenderPointMask|e.SurfacicPointRenderPointMask,e.__QA_AUTOMATION_MASK__=e.GeomTypeEnum.FACE|e.GeomTypeEnum.UNKNOWN_0D|e.GeomTypeEnum.UNKNOWN_1D|e.GeomTypeEnum.UNKNOWN_2D|e.GeomTypeEnum.UNKNOWN,e.loadingModels=!1;var F=[];F.push(new e.Vector2(-.770613,-.239161)),F.push(new e.Vector2(.654029,-.712337)),F.push(new e.Vector2(-.307109,.184156)),F.push(new e.Vector2(.511665,.311578)),F.push(new e.Vector2(.950228,-.256954)),F.push(new e.Vector2(-.00583136,-.537149)),F.push(new e.Vector2(-.692077,.433278)),F.push(new e.Vector2(-.357517,.88078)),F.push(new e.Vector2(.278742,.859941)),F.push(new e.Vector2(-.631555,-.471973)),F.push(new e.Vector2(-.480475,-.732053)),F.push(new e.Vector2(-.486058,.576291)),F.push(new e.Vector2(.190138,-.625394)),F.push(new e.Vector2(-.176393,-.166675)),F.push(new e.Vector2(.0663065,-.333703)),F.push(new e.Vector2(.348117,-.812683)),F.push(new e.Vector2(.0817859,.0594559)),F.push(new e.Vector2(.375191,-.0632498)),F.push(new e.Vector2(.770788,-.0723965)),F.push(new e.Vector2(.800971,.431381)),F.push(new e.Vector2(-.100114,.320657)),F.push(new e.Vector2(.285262,.61499)),F.push(new e.Vector2(-.579148,.219349)),F.push(new e.Vector2(-.684372,-.0462647)),F.push(new e.Vector2(-.313914,-.939188)),F.push(new e.Vector2(-.414696,.367707)),F.push(new e.Vector2(.698927,.219188)),F.push(new e.Vector2(.971183,.130313)),F.push(new e.Vector2(.0822042,.526062)),F.push(new e.Vector2(-.214193,.522263)),F.push(new e.Vector2(-.0751906,.901432)),F.push(new e.Vector2(.488676,-.253098)),F.push(new e.Vector2(-.580828,.778049)),F.push(new e.Vector2(.816108,-.536974)),F.push(new e.Vector2(.51456,.543311)),F.push(new e.Vector2(-.213744,-.428735)),F.push(new e.Vector2(.293803,-.405018)),F.push(new e.Vector2(.169169,.259656)),F.push(new e.Vector2(.445091,-.594255)),F.push(new e.Vector2(-.453123,-.1009)),F.push(new e.Vector2(-.420509,-.388243)),F.push(new e.Vector2(.576791,.0184982)),F.push(new e.Vector2(.610535,.759891)),F.push(new e.Vector2(.692311,-.348235)),F.push(new e.Vector2(.0912182,.752741)),F.push(new e.Vector2(-.840539,.203544)),F.push(new e.Vector2(.0673295,-.961926)),F.push(new e.Vector2(-.951943,.0129663)),F.push(new e.Vector2(-.14793,-.811125)),e._ForbidRenderableStates={NO_TRANSPARENT:1,NO_INVISIBLE_PLANE:2};var B=e._ForbidRenderableStates;function N(t){for(var i=new Uint8Array(16),r=0;r<4;r++)i[4*r]=t[0],i[4*r+1]=t[1],i[4*r+2]=t[2],i[4*r+3]=t[3];var n=new e.DataTexture(i,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter);return n.generateMipmaps=!1,n.needsUpdate=!0,n}Object.assign(e,w),e._SaveGeneratedRoughnessMaps=!1,e._DownloadGeneratedRoughnessMaps=!0,e._AmbianceGenerators={viewers:[],loading:!1,manager:null,_dummyRoughnessTexture:N([200,200,200,127]),_needsUpdate:function(){return!!this.manager&&this.manager._needsUpdate()},cb:null,errorCount:0,init:function(e){if(!this.loading&&!this.manager)if(this._dummyRoughnessTexture.hasDiffuse=!0,this.available(e)){if(null===this.manager){this.loading=!0;var t=this;require(["DS/Visualization/AmbianceGenerator"],function(e){t.loading=!1,t.manager=new e(t.cb);for(var i=0;i<t.viewers.length;i++)t.viewers[i].forceRender=!0})}}else this.loading=!0},available:function(t){var i=!!e.supportedExtensions.textureHalfFloat&&!!e.supportedExtensions.renderToHalfFloatTexture&&!!e.supportedExtensions.textureHalfFloatLinear||!!e.supportedExtensions.textureFloat&&!!e.supportedExtensions.renderToFloatTexture&&!!e.supportedExtensions.textureFloatLinear;return i||(0===t&&this.errorCount<10?console.warn("Warning: device does not support automatic mip map generation for hdrs, please set one yourself"):1===t&&this.errorCount<11&&console.warn("Warning: device does not support fabrics under ibl"),this.errorCount++),i},getAmbiance:function(e,t,i,r){return this.manager?this.manager.getAmbiance(e,t,i,r):null},update:function(e,t){return!!this._needsUpdate()&&this.manager.update(e,t)},decreaseUseCount:function(e){this.manager&&this.manager.decreaseUseCount(e)},_decreaseSceneUseCount:function(e){this.manager&&(this.manager.decreaseUseCount(e.envMipMapID),e.envMipMapID=null,this.manager.decreaseUseCount(e.envMipMapSheenID),e.envMipMapSheenID=null)},keep:function(e){return this.manager?this.manager.keep(e):null},setCallBack:function(e){this.cb=e,this.manager&&this.manager._setCB(e)},dispose:function(e){var t=this.viewers.indexOf(e);t>-1&&this.viewers.splice(t,1),0===this.viewers.length&&(this.manager&&(this.manager.dispose(),this.manager=null),this._dummyRoughnessTexture&&this._dummyRoughnessTexture.dispose())}},e._SSSGenerator={viewers:[],loading:!1,manager:null,init:function(){if(!this.loading&&!this.manager&&null===this.manager){this.loading=!0;var e=this;require(["DS/Visualization/SubsurfaceGenerator"],function(t){e.loading=!1,e.manager=new t;for(var i=0;i<e.viewers.length;i++)e.viewers[i].forceRender=!0})}},getTextures:function(e){return this.manager?this.manager.compute(e):null},decreaseUseCount:function(e){this.manager&&this.manager.decreaseUseCount(e)},dispose:function(e){var t=this.viewers.indexOf(e);t>-1&&this.viewers.splice(t,1),0===this.viewers.length&&this.manager&&(this.manager.dispose(),this.manager=null)}};var G={modelMatrix:1,modelViewMatrix:2,modelViewInvTranspMatrix:4,modelInvTranspMatrix:8,normalMatrix:32,quantizedVector:64,fixedSizeRatio:128,fixedSizeCenterRatio:256,lightMap:512,billboardType:1024,decalStencilValue:2048,displacementRadius:4096,backgroundViewModeControl:8192,objectColorBufferType:16384,skinningMap:32768,skinningInstancingMaps:65536,backgroundViewModeNearFar:1<<17},k=function(){this.modelMatrix=null,this.modelViewMatrix=null,this.modelViewInvTranspMatrix=null,this.modelInvTranspMatrix=null,this.normalMatrix=null,this.quantizedVector=null,this.offsetVector=null,this.fixedSizeRatio=null,this.fixedSizeCenterRatio=null,this.lightMap=null,this.lightMapUvSlot=null,this.lightMapUvTransform=null,this.billboardType=null,this.billboardRotationEnabled=null,this.billboardAxis=null,this.billboardRotation=null,this.modelInvRotMatrix=null,this.modelViewInvMatrix=null,this.decalStencilValue=null,this.decalExplicitUv=null,this.displacementRadius=null,this.objectColorBufferType=null,this.skinningMap=null,this.skinningInstancingMaps=null,this.backgroundViewModeControl=null,this.backgroundViewModeNearFar=null,this.funcName="loadObjectUniforms"};k.prototype.computeFuncName=function(){var e=0;for(var t in G)null!==this[t]&&(e|=G[t]);switch(e){case G.modelMatrix:this.funcName="_load_MM";break;case G.modelMatrix|G.normalMatrix:this.funcName="_load_MM_NM";break;case G.modelViewMatrix:this.funcName="_load_MVM";break;case G.modelViewMatrix|G.normalMatrix:this.funcName="_load_MVM_NM";break;case G.modelMatrix|G.modelViewMatrix:this.funcName="_load_MM_MVM";break;case G.modelMatrix|G.modelViewMatrix|G.normalMatrix:this.funcName="_load_MM_MVM_NM";break;default:this.funcName="loadObjectUniforms"}};var U=function(){this.program=null,this.id=0,this.uniformLocations=null,this.objectUniformLocations=null,this.attributes={position:-1,normal:-1,uv:-1,uv2:-1,tangent:-1,binormal:-1,color:-1,skinIndex:-1,skinWeight:-1,lineDistance:-1,previousPos:-1,followingPos:-1,sideExtrusion:-1,patternStartEnd:-1},this.uvOrBinOrTan=!1,this.instanceAttributes={},this.flattenedUniformArrays={},this._clipPlanesVersion=-1,this._lightsKey=0,this._ambianceKey=0,this._materialToUse=0};e.glStates={currentFramebuffer:void 0,currentWidth:0,currentHeight:0},e.DefaultAppearanceMode={BASIC:0,_GASLOOK_OLD:.5,GASLOOK:1,_TRANSPARENT:2,CLAY:3,WHITE_MAT_PLASTER:4,GREY_SHINY_PLASTIC:5,CAST_ALUMINUM:6,MACHINED_ALUMINUM:7,CAST_STEEL:8,BRUSHED_STEEL:9,MACHINED_STAINLESS_STEEL:10,COPPER:11,BRASS:12,GENERIC_PLASTIC:13,GENERIC_METAL:14,__QA_AUTOMATION__:15};var z=e.DefaultAppearanceMode;e._DebugMaterialMode={NO_DEBUG:0,NORMAL:1,DEPTH:2,SHADOW:3,GEOM_UV:4,MAPPING_UV:5,GEOM_UV2:6,MAPPING_UV2:7};var H=e._DebugMaterialMode;e.MaterialToUse={originalMaterial:0,normalMaterial:1,depthMaterial:2,normalDepthIoRRoughnessMaterial:3,shadowMapDepthMaterial:4,highlightMaterial:5,pickingMaterial:6,pickingMaterialInstancing:7,oitAccumMaterial:8,oitRevealMaterial:9,ZOnlyMaterial:10,depthRGBAMaterial:11,normalDepthMaterial:12,decalNormalStencilDepthMaterial:13,transparentShadowMaterial:14,texCoordMaterial:15,totalMaterial:16};var W=e.MaterialToUse;e._isSelectionMaterial=function(e){switch(e){case W.normalMaterial:case W.depthMaterial:case W.highlightMaterial:case W.pickingMaterial:case W.pickingMaterialInstancing:return!0;default:return!1}};var j,X;e._isSelectionMaterial;e.MaterialHasPriority=[!1,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0,!0],e.HaloHighlightData=c.HaloHighlightData,e.AdvancedPoliteHighlightData=c.AdvancedPoliteHighlightData,e.DefaultHighlightData=c.DefaultHighlightData,e.DefaultPreHighlightData=c.DefaultPreHighlightData,e.Line3=M.Line3,e.Box2=M.Box2,e.Box3=M.Box3,e.mergeBoundingBoxInto=M.mergeBoundingBoxInto,e.DGBoundingBoxArray=M.DGBoundingBoxArray,e.Sphere=M.Sphere,e.mergeBoundingSphereInto=M.mergeBoundingSphereInto,e.BoundingSphere=M.BoundingSphere,e.Frustum=M.Frustum,e.Plane=M.Plane,e.Math={clamp:function(e,t,i){return e<t?t:e>i?i:e},clampBottom:function(e,t){return e<t?t:e},mapLinear:function(e,t,i,r,n){return r+(e-t)*(n-r)/(i-t)},smoothstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*(3-2*e)},smootherstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*e*(e*(6*e-15)+10)},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},sign:function(e){return e<0?-1:e>0?1:0},degToRad:(X=Math.PI/180,function(e){return e*X}),radToDeg:(j=180/Math.PI,function(e){return e*j})},e.Spline=M.Spline,e.Triangle=M.Triangle,e.Vertex=function(e){return console.warn("THREE.Vertex has been DEPRECATED. Use THREE.Vector3 instead."),e},e.UV=function(t,i){return console.warn("THREE.UV has been DEPRECATED. Use THREE.Vector2 instead."),new e.Vector2(t,i)},e.Clock=function(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1},e.extend(e.Clock.prototype,{start:function(){this.startTime=void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now(),this.oldTime=this.startTime,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var e=0;if(this.autoStart&&!this.running&&this.start(),this.running){var t=void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now();e=.001*(t-this.oldTime),this.oldTime=t,this.elapsedTime+=e}return e}}),e.Object3D=d,e.Projector=function(){var t=new e.Matrix4;this.projectVector=function(e,i){return i.matrixWorldInverse.getInverse(i.matrixWorld),t.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),e.applyProjection(t)},this.unprojectVector=function(e,i){return i.projectionMatrixInverse.getInverse(i.projectionMatrix),t.multiplyMatrices(i.matrixWorld,i.projectionMatrixInverse),e.applyProjection(t)},this.pickingRay=function(t,i){t.z=-1;var r=new e.Vector3(t.x,t.y,1);return this.unprojectVector(t,i),this.unprojectVector(r,i),r.sub(t).normalize(),new e.Raycaster(t,r)}},e.Face3=M.Face3,e.Face4=M.Face4,e.Geometry=C.LegacyGeometry,e.GeometryIdCount=0;var q=b.VISIBILITY_STATUS,Z=b.INCREMENTAL_ACTIONS,Y=b.__CullingSystemFactory;e.CullingSystem=b.CullingSystem,e._CameraRoles=p._CameraRoles,e._FrameTypes=p._FrameTypes,e.Camera=p.BaseCamera,e.OrthographicCamera=p.OrthographicCamera,e.PerspectiveCamera=p.PerspectiveCamera,e.Light=u.BaseLight,e.AmbientLight=u.AmbientLight,e.AreaLightUnits=u.AreaLightUnits,e.SphereLight=u.SphereLight,e.DiskLight=u.DiskLight,e.TubeLight=u.TubeLight,e.AreaLight=u.AreaLight,e.DirectionalLight=u.DirectionalLight,e.DirectionalIBLLight=u.DirectionalIBLLight;var Q=u.DirectionalIBLLight.prototype._sortKey;e.DirectionalPhongLight=u.DirectionalPhongLight,e.PointLight=u.PointLight,e.SpotLight=u.SpotLight,e.IESLight=u.IESLight,e.ImageLoader=function(){e.EventDispatcher.call(this),this.crossOrigin=null},e.ImageLoader.prototype={constructor:e.ImageLoader,load:function(e,t){var i=this;void 0===t&&(t=new Image),t.addEventListener("load",function(){i.dispatchEvent({type:"load",content:t})},!1),t.addEventListener("error",function(){i.dispatchEvent({type:"error",message:"Couldn't load URL ["+e+"]"})},!1),i.crossOrigin&&(t.crossOrigin=i.crossOrigin),t.src=e}},e.LineBasicShaderLibs=s.LineShaderLib,Object.assign(e,f);var K=f.ShaderDynamicPrefixBuilder._VertexPrefixBuilder,J=f.ShaderDynamicPrefixBuilder._FragmentPrefixBuilder;function $(e,t){return t[0]-e[0]}Object.assign(e,D),e.MeshFaceMaterial=function(e){this.materials=e instanceof Array?e:[]},e.MeshFaceMaterial.prototype.clone=function(){return new e.MeshFaceMaterial(this.materials.slice(0))},e.ParticleCanvasMaterial=function(t){e._OldInfraMaterial.call(this),this.color=new e.Color(16777215),this.program=function(e,t){},this.setValues(t)},e.ParticleCanvasMaterial.prototype=Object.create(e._OldInfraMaterial.prototype),e.ParticleCanvasMaterial.prototype.clone=function(){var t=new e.ParticleCanvasMaterial;return e._OldInfraMaterial.prototype.clone.call(this,t),t.color.copy(this.color),t.program=this.program,t},e.ParticleCanvasMaterial.prototype.getType=function(){return"ParticleCanvas"},e.Particle=function(t){e.Object3D.call(this),this.material=t},e.Particle.prototype=Object.create(e.Object3D.prototype),e.Particle.prototype.clone=function(t){return void 0===t&&(t=new e.Particle(this.material)),e.Object3D.prototype.clone.call(this,t),t},e.ParticleSystem=C.ParticleSystem,e.Line=C.Line,e.LineStrip=0,e.LinePieces=1,e.Mesh=S,e.CSS3DNode=function(t){e.Object3D.call(this),this.element=t||document.createElement("div"),this.element.renderable=this,this.element.style.position="absolute",this.geometry=new e.Geometry,this.geometry.boundingSphere=new e.Sphere},e.CSS3DNode.prototype=Object.create(e.Object3D.prototype),e.Bone=function(t){e.Object3D.call(this)},e.SkinnedMesh=C.SkinnedMesh,e.Sprite=function(t){e.Object3D.call(this)},e.Sprite.prototype=Object.create(e.Object3D.prototype),e.WebGLObjectManager=x,e.Scene=_,e.StateSortingResult=T.StateSortingResult,e.VertexStage=0,e.FragmentStage=1,e.ToGLSLTypes={f:{t:"float",isArray:!1,isTexture:!1,canBeVarying:!0,isInt:!1},v2:{t:"vec2",isArray:!1,isTexture:!1,canBeVarying:!0,isInt:!1},v3:{t:"vec3",isArray:!1,isTexture:!1,canBeVarying:!0,isInt:!1},c:{t:"vec3",isArray:!1,isTexture:!1,canBeVarying:!0,isInt:!1},v4:{t:"vec4",isArray:!1,isTexture:!1,canBeVarying:!0,isInt:!1},m3:{t:"mat3",isArray:!1,isTexture:!1,canBeVarying:!0,isInt:!1},m4:{t:"mat4",isArray:!1,isTexture:!1,canBeVarying:!0,isInt:!1},i:{t:"int",isArray:!1,isTexture:!1,canBeVarying:!1,isInt:!0},b:{t:"bool",isArray:!1,isTexture:!1,canBeVarying:!1,isInt:!1},fv1:{t:"float",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},iv1:{t:"int",isArray:!0,isTexture:!1,canBeVarying:!1,isInt:!0},v2v:{t:"vec2",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},fv2:{t:"vec2",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},v3v:{t:"vec3",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},fv3:{t:"vec3",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},v4v:{t:"vec4",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},fv4:{t:"vec4",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},m4v:{t:"mat4",isArray:!0,isTexture:!1,canBeVarying:!0,isInt:!1},t2:{t:"sampler2D",isArray:!1,isTexture:!0,canBeVarying:!1,isInt:!1},tc:{t:"samplerCube",isArray:!1,isTexture:!0,canBeVarying:!1,isInt:!1},t2v:{t:"sampler2D",isArray:!0,isTexture:!0,canBeVarying:!1,isInt:!1},tcv:{t:"samplerCube",isArray:!0,isTexture:!0,canBeVarying:!1,isInt:!1}},e.PDSFXPolygonOffsetParams={Backward2:[4,4],Backward1:[2,2.3],Backward0:[1,1],Neutral:[0,0],Frontward0:[-.9,-1],Frontward1:[-2,-2]},e._DefaultShaderChunk=a,e.ShaderChunk=o,e.DeferredShaderChunk=y,e.UniformsUtils=g,e.UniformsLib=v,e.ShaderLib=m;var ee=0,te=-1;e.RendererMode={static:0,dynamic:1,override:2,_count:3};for(var ie=e.RendererMode,re=new Array(ie._count),ne=0;ne<ie._count;ne++)re[ne]=ne;var ae=function(e,t,i,r,n){if(i)e.setRenderTarget(t.currentNormalStencilDepthBuffer);else if(r){if(null==t.currentTexCoordBuffer){var a=e.getViewportSize();t.currentTexCoordBuffer=e.renderTargetPool.buildRenderTarget(a.width,a.height,"decalTex",null,null,!1),e.clearTarget(t.currentTexCoordBuffer,!0,!0,!0)}e.setRenderTarget(t.currentTexCoordBuffer)}else n&&e.setRenderTarget(t.currentRGBADepthBuffer)},se=function(e,t,i){i&&e.setRenderTarget(t)};const oe={FRAME:0,OBJECT:1},le=T.StateSortingCacheItem;return e.WebGLRenderer=function(a){this.currentFrameIndex=0,this._currentFrameType=-1,this.renderIteration=0;var s=0;this._VRCompatible=!1,this._VRFrameBuffer=null,this.resetGSSOCacheFrame=0,this.useBackfaceCullingWithNoCapping=!1,this.useCustomCappingForClipPolyline=!1,this.shaderVersions=new Array(ie._count);for(var o=0;o<ie._count;o++)this.shaderVersions[o]=0;this.currentRendererMode=ie.static,this.forcePolygonOffset=e.PolygonOffsetForceStatus.DEFAULT,this.overrideWireframeFix=!1,a=a||{},this._texturesToResize=new Set;var l,h,c,d,u,p,f,g,m,v,y,S,_,x,b,M,C,P,E,A,D=void 0!==a.canvas?a.canvas:document.createElement("canvas"),G=a.useCompositing,j=void 0!==a.divCSS?a.divCSS:document.createElement("div"),X=void 0!==a.precision?a.precision:"highp",ne=void 0!==a.precision?a.precision:"highp",he=void 0===a.alpha||a.alpha,ce=void 0===a.premultipliedAlpha||a.premultipliedAlpha,de=!(!navigator.webdriver||localStorage.getItem("WebVisuEnableAAWithWebdriver")),ue=void 0!==a.antialias&&!de&&a.antialias,pe=void 0===a.stencil||a.stencil,fe=void 0!==a.preserveDrawingBuffer&&a.preserveDrawingBuffer,ge=void 0!==a.clearColor?new e.Color(a.clearColor):new e.Color(0),me=void 0!==a.clearAlpha?a.clearAlpha:0;this._sortRenderListByBuffer=void 0!==a.sortRenderListByBuffer&&a.sortRenderListByBuffer,this.domElement=D,this.currentPass=null,this.id=ee++,this.useRenderPriorityOpacity=!1,this.renderPriorityDefaultOpacity=1,this.context=null,this.devicePixelRatio=void 0!==a.devicePixelRatio?a.devicePixelRatio:e.getDevicePixelRatio()||1,this.splitScreenMode=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sectionCappingEnabled=!1;var ve,ye={currentNormalStencilDepthBuffer:null,currentTexCoordBuffer:null,currentRGBADepthBuffer:null};this.visibleSpace=void 0!==a.visibleSpace?a.visibleSpace:1,this.sortObjects=!0,this.autoUpdateObjects=!0,this.autoUpdateScene=!0,this.gammaInput=!1,this.gammaOutput=!1,this.renderTargetPool=null,this.simpleGamma=!0,this.lensFlareEnabled=!0,this.baseLightDirection=new e.Vector3(0,0,1),this.shadowMapEnabled=!1,this.transparentShadowEnabled=!1,this.shadowMapAutoUpdate=!0,this.shadowMapType=e.PCFShadowMap,this.shadowMapQuality="Low",this.shadowMapCullFace=e.CullFaceFront,this.shadowMapDebug=!1,this.shadowMapCascade=!1,this._renderScale=1,this._internalPixelScale=1,this.flakesMode=0,this.gasAsPhong=!1,this.clipPlanesEnabled=!1,this.clipPlanes=[],this.disableBackFaceClipPlanes=0,this.maxMorphTargets=8,this.maxMorphNormals=4,this.disableDepthWrite=!1,this.disableDepthTest=!1,this.disableColorWrite=!1,this.enableStencilWrite=!1,this.disableBackFaceCulling=!1,this._inheritanceSolver=new T.InheritanceSolver(this),this.renderVolumesOnly=!1,this.materialMode=!0,this._defaultAppearanceType=z.BASIC,this._debugMaterialMode=H.NO_DEBUG,this._backgroundViewMode=e.BackgroundViewMode.NORMAL,this._invertBackgroundNodes=!1,this._pickBackgroundNodes=!0,this._backgroundColor=null,this._planeViewMode=null,this._customMaterialModeParams={colorFromGAS:!1,color:new e.Color,shininess:1,opacity:1},this._GlobalZModeFilter=null;const Se=this._inheritanceSolver._useCPUOutlines;this.enableRenderPluginsPre=!0,this.enableRenderPluginsPost=!0,this.renderPluginsPre=[],this.renderPluginsPost=[],this.refractionColorBuffer=null,this.reflectionColorBuffer=null,this.ambianceGenerators=null,this.sssGenerator=null,this.dBuffer=null,this.requestDBuffer=!1,this._dBufferNextFrame=!1,this.requestRealDepthBuffer=function(){this._dBufferNextFrame=!0},this._requestPoliteDepthBuffer=!1,this._politeDBufferNextFrame=!1,this.requestPoliteDepthBuffer=function(){this._politeDBufferNextFrame=!0,this._requestPoliteDepthBuffer=!0},this.politeDepthBuffer=null,this._NoMeshInRamWarningCount=0,this.maxPolyLineSize=0,this.maxNbPolyLine=0,this.maxScissorSize=0,this.maxNbScissor=0,this.useClippingCylinder=!1,this.info={memory:new I.MemoryInfo,renderMap:new Map,render:null,renderTime:new I.RenderTimeInfo};var _e=this.info.memory,xe=null;this.inlinedPostProcess={activated:!1,brightness:0,tonemapping:2,crushblacks:0,burnhighlights:0,saturation:1,colorCorrection:{x:1,y:1,z:1}},this.resetInlinedPostProcess=function(){this.inlinedPostProcess.activated=!1,this.inlinedPostProcess.brightness=0,this.inlinedPostProcess.tonemapping=2,this.inlinedPostProcess.crushblacks=0,this.inlinedPostProcess.burnhighlights=0,this.inlinedPostProcess.saturation=1,this.inlinedPostProcess.colorCorrection={x:1,y:1,z:1}},this.frameUBOArray=null,this.frameUBOBuffer=null,this.float32Matrix4x3Temp=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.float32Matrix4x3Temp.setDoubles=function(e){var t=this;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[12]=e[12],t[13]=e[13],t[14]=e[14],this},this.float32Matrix4x4Temp=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.float32Matrix4x4Temp.setDoubles=function(e){var t=this;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this},this.float32Matrix3x3Temp=new Float32Array([1,0,0,0,1,0,0,0,1]),this.float32Matrix3x3Temp.setDoubles=function(e){var t=this;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this},this._dummyTexture=N([0,0,0,255]),this._clipPlanesState={uniforms:{nbClipPlanes:{type:"i",value:0,clipPlanesUniform:!0},clipPlaneEquations:{type:"fv4",value:[],clipPlanesUniform:!0},clipPlaneActive:{type:"iv1",value:[],clipPlanesUniform:!0},clipFrontOpacity:{type:"f",value:1,clipPlanesUniform:!0},clipBackOpacity:{type:"f",value:0,clipPlanesUniform:!0},scissorSize:{type:"iv1",value:[],clipPlanesUniform:!0},scissorPoints:{type:"t",value:null,clipPlanesUniform:!0},polygonSize:{type:"iv1",value:[0],clipPlanesUniform:!0},polygonPoints:{type:"t",value:null,clipPlanesUniform:!0},extrusionPlaneU:{type:"fv",value:[0,0,1],clipPlanesUniform:!0},extrusionPlaneV:{type:"fv",value:[1,0,0],clipPlanesUniform:!0},cylinderClipZone:{type:"i",value:0,clipPlanesUniform:!0},cylinderCenter:{type:"v3",value:null,clipPlanesUniform:!0},cylinderAxisU:{type:"v3",value:new e.Vector3(0,0,1),clipPlanesUniform:!0},cylinderAxisV:{type:"v3",value:new e.Vector3(1,0,0),clipPlanesUniform:!0}},version:-1,disabled:!1,useTolerance:!1,update:function(t,i,r,n,a,s){var o=!(!n||!n.useClippingTolerance);if(r||t!==i||this.disabled&&n.enableClipPlanes||o!==this.useTolerance){var l=t&&t.clipPlanes,h=Xe.clipPlanesEnabled?Xe.clipPlanes:[];l&&(h=l);var c,d,u,p=[];for(u=0;u<h.length&&p.length<6;u++)(d=(c=h[u])&&c.clippingContext&&c.clippingContext[Xe.id])&&d.clippingPlaneAdded&&p.push(c);var f=-1,g=t&&t.getClippingSettings();for(g&&0===g.frontOpacity&&(f=1),u=0;u<p.length;u++){var m,v=Xe.clipPlanesEnabled||l;m=a instanceof e.OrthographicCamera?-p[u].normal.dot(a.getLookAt()):p[u].distanceToPoint(a.position),p[u].enabled=v&&(0==Xe.disableBackFaceClipPlanes||f*m>0)}this.useTolerance=o,function(t,i,r,n,a){Ft.hasCapping=!0;var s,o,l,h=0,c=0,d=n&&n.clippingContext;for(s=0,o=i.length;s<o;s++){l=i[s],c=4*h;var u=(new e.Matrix4).copy(r.matrixWorld);u.transpose();var p=(new e.Plane).copy(l);p.applyMatrix4(r.matrixWorldInverse),Ft.eqs[c]=p.normal.x,Ft.eqs[c+1]=p.normal.y,Ft.eqs[c+2]=p.normal.z,Ft.eqs[c+3]=p.constant,a&&(Ft.eqs[c+3]+=.005),Ft.states[s]=l.enabled?1:0,Ft.sectionLines[s]=!d||d._hasPlaneSectionLine(l),d&&!d._hasPlaneCapping(l)&&(Ft.hasCapping=!1),h++}Ft.length=h}(0,p,a,t,o),Ui(this.uniforms,Ft,n&&n.clipPlaneIndex,t,s),function(e,t,i,r,n){if(e.polygonPoints){t&&t.updateCamera(i,r),e.polygonPoints.value=t?t.getTexture():null;var a,s,o=[],l=[],h=[];for(a=0;a<n;a++)t&&a<t.getCount()?(s=t.polyLines[a],o.push(s.closedPoints2d.length),l.push(s.viewPlaneU.x),l.push(s.viewPlaneU.y),l.push(s.viewPlaneU.z),h.push(s.viewPlaneV.x),h.push(s.viewPlaneV.y),h.push(s.viewPlaneV.z)):(o.push(0),l.push(0),l.push(0),l.push(0),h.push(0),h.push(0),h.push(0));e.polygonSize.value=o.length>0?o:[0],e.extrusionPlaneU.value=l,e.extrusionPlaneV.value=h}}(this.uniforms,t?t.clipPolyLine:null,a,Xe.currentFrameIndex,Xe.maxNbPolyLine),t&&t.scissor&&"polyline"===t.scissor.type?zi(this.uniforms,t.scissor,a,Xe.currentFrameIndex,Xe.maxNbScissor):zi(this.uniforms,null),function(e,t){if(!e.cylinderClipZone)return;e.cylinderClipZone.value=t?t.clipOutside?1:-1:0,t&&t.center&&(e.cylinderCenter.value=t.center);t&&t.axisU&&(e.cylinderAxisU.value=t.axisU.clone().multiplyScalar(1/t.axisU.lengthSq()));t&&t.axisV&&(e.cylinderAxisV.value=t.axisV.clone().multiplyScalar(1/t.axisV.lengthSq()))}(this.uniforms,t?t.clipCylinder:null),this.disabled=!1,this.version++}else this.disabled||n.enableClipPlanes||(this.disabled=!0,Ui(this.uniforms,{length:0,eqs:[],states:[]},0))}},this.__glResources__={renderTarget:{},geometry:[],geometryNullCount:0,texture:[],textureLODPool:new e.TextureLODPool,removeGeometryList:function(e){var t=new Set;e.forEach(function(e,i,r){t.add(e.id)});for(var i=0,r=0;r<this.geometry.length;r++){var n=this.geometry[r];if(n&&t.has(n.object.id)&&(i++,t.delete(n.object.id),this.geometry[r]=null,this.geometryNullCount++,i===e.size))break}this.tryClean()},tryClean:function(){this.geometryNullCount>=100&&(this.geometry=this.geometry.filter(function(e){return null!==e}),this.geometryNullCount=0)}},this.restoreGLContext=function(){console.log("restore context"),nr(null,null,2===e.WebGLVersion),qe=[],Ze=0,be._currentProgram=null;_e.programs;_e.programs=0,_e.sharedbuffers=0,_e.geometries=0;var t=this.__glResources__.geometry;console.log("restore "+t.length+" geometries");for(var i=[],r=0;r<t.length;r++)if(t[r]){var n=t[r].object.geometry;if(n){if(n.length)for(var a=0;a<n.length;a++)n[a].vertexBufferGPU=null;else if(t[r].object.__webglInit=!1,n.__webglVertexBuffer=null,n.geometryGroups)for(var s in n.geometryGroups){n.geometryGroups[s].__webglVertexBuffer=null}Xe.initObject(t[r].object)&&i.push(t[r])}}this.initSharedBuffersDS(i,!0),_e.textures=0,_e.renderTargets=0;var o=this.__glResources__.texture;console.log("restore "+o.length+" textures");for(r=0;r<o.length;r++){var l=o[r];l.needsUpdate=!0,l.__webglInit=!1,l.__webglTexture&&(l.__webglTexture=null)}var h=this.__glResources__.renderTarget,c=0;for(var r in h){var d=h[r];d&&(d.__webglFramebuffer=null,d.__webglRenderbuffer=null,d.__webglTexture=null,c++)}console.log("restore "+c+" render targets")},this._setWorldOrientation=function(e){this.baseLightDirection=e.upVector.clone()},this.initFrameUBO=function(){this.frameUBOArray=new Float32Array(36),this.frameUBOBuffer=be.createBuffer(),be.bindBuffer(be.UNIFORM_BUFFER,this.frameUBOBuffer),be.bufferData(be.UNIFORM_BUFFER,this.frameUBOArray,be.DYNAMIC_DRAW),be.bufferSubData(be.UNIFORM_BUFFER,0,this.frameUBOArray),be.bindBufferBase(be.UNIFORM_BUFFER,oe.FRAME,this.frameUBOBuffer),be.bindBuffer(be.UNIFORM_BUFFER,null)},this.updateFrameUBO=function(e){for(var t=e.matrixWorldInverse.elements,i=0;i<16;i++)this.frameUBOArray[i]=t[i];var r=e.projectionMatrix.elements;for(i=0;i<16;i++)this.frameUBOArray[i+16]=r[i];Dt.getPositionFromMatrix(e.matrixWorld),this.frameUBOArray[32]=Dt.x,this.frameUBOArray[33]=Dt.y,this.frameUBOArray[34]=Dt.z,be.bindBuffer(be.UNIFORM_BUFFER,this.frameUBOBuffer),be.bufferSubData(be.UNIFORM_BUFFER,0,this.frameUBOArray)};var be,we,Me,Ce,Pe,Ee,Ae,Te,De,Ie,Re,Oe,Le,Ve,Fe,Be,Ne,Ge,ke,Ue,ze,He,We,je,Xe=this,qe=[],Ze=0,Ye=-1,Qe=null,Ke=-1,Je=null,$e=null,et=null,tt=null,it=null,rt=0,nt=1,at=-1,st=-1,ot=-1,lt=1,ht=-1,ct=-1,dt=-1,ut=-1,pt=-1,ft=-1,gt=-1,mt=-1,vt=null,yt=null,St=null,_t=1,xt=0,bt=0,wt=0,Mt=0,Ct=!1,Pt={x:-1/0,y:-1/0,width:0,height:0},Et=new e.Frustum,At=new e.Matrix4,Tt=new e.Matrix4,Dt=new e.Vector3,It=(new e.Vector4,new e.Vector3,!0),Rt=0,Ot=0,Lt=null,Vt={ambient:[0,0,0],directional:{length:0,colors:[],colorsPhong:[],colorsNoIntensity:[],positions:[]},directionalIBL:{length:0,colors:[],positions:[]},directionalPhong:{length:0,colors:[],positions:[]},point:{length:0,colors:[],colorsPhong:[],colorsNoIntensity:[],positions:[],physicalAttenuations:[],distances:[]},spot:{length:0,colors:[],colorsPhong:[],colorsNoIntensity:[],positions:[],physicalAttenuations:[],distances:[],directions:[],anglesCos:[],innerAnglesCos:[]},sphere:{length:0,colors:[],positions:[],data:[]},area:{length:0,colors:[],positions:[],normals:[],ups:[],data:[]},disk:{length:0,colors:[],positions:[],normals:[],ups:[],data:[]},tube:{length:0,colors:[],positions:[],rights:[],data:[]},ies:{length:0,colors:[],positions:[],distances:[],iesLightTexture:[],matrixWorldInv:[]}},Ft={length:0,eqs:[],states:[],sectionLines:[],hasCapping:!1},Bt={gpu:"Unknown",vendor:"Unknown"},Nt=null;this.fixedSizeArrayPool=new t,nr(a.context,a.debugContext,a.debugWebgl2),n.setGLContext(this.id,be,this.info),this._inheritanceSolver.setContext(be,i,r),2===e.WebGLVersion&&this.initFrameUBO();var Gt=new e.DataTexture(new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),2,2,e.RGBAFormat,e.UnsignedByteType);Gt.needsUpdate=!0,be.lineWidth(1),be.clearColor(0,0,0,1),be.clearDepth(1),be.clearStencil(0),be.enable(be.DEPTH_TEST),be.depthFunc(be.LEQUAL),pt=be.LEQUAL,be.frontFace(be.CCW),be.cullFace(be.BACK),be.enable(be.CULL_FACE),be.enable(be.BLEND),be.blendEquation(be.FUNC_ADD),be.blendFunc(be.SRC_ALPHA,be.ONE_MINUS_SRC_ALPHA),be._oldBlending=e.AlphaBlending,be.clearColor(ge.r,ge.g,ge.b,me),this.dispose=function(){var e;for(e=0;e<this.renderPluginsPre.length;e++)this.renderPluginsPre[e].dispose&&this.renderPluginsPre[e].dispose();for(e=0;e<this.renderPluginsPost.length;e++)this.renderPluginsPost[e].dispose&&this.renderPluginsPost[e].dispose();this.ambianceGenerators&&(this.ambianceGenerators=null),this.sssGenerator&&(this.sssGenerator=null),Gt.dispose(),this.renderPluginsPre=[],this.renderPluginsPost=[],n.dispose(this.id),Y.dispose(),this.fixedSizeArrayPool=null,this.getContext=null,Xe=null,j=null,D=null,this.__glResources__=null,this.context=null,tt=null,$e=null,et=null},this.clearCurrentBuffer=function(){$e=null,et=null},this.setPickingPriorityMapping=function(t,i){if(t){t.sort(function(e,t){return e.priority<t.priority?-1:e.priority>t.priority?1:0});for(var r={},n=null,a=0,s=0;s<t.length;s++){if((o=t[s]).priority>0){if(!n||n.priority!==o.priority)a++,(l=i.getDisplayListByName("PICKING_H"+a))||(l=i.addDisplayList(new e.DisplayList({name:"PICKING_H"+a,priority:-a,zSort:e.FrontToBack,side:R.FrontSide,polygonOffset:!1,pickingPriority:!0})),this.resetGSSOCache());r[o.id]=l}else 0===o.priority&&(r[o.id]=null);n=o}n=null,a=0;for(s=t.length-1;s>=0;s--){var o;if((o=t[s]).priority<0){var l;if(!n||n.priority!==o.priority)a--,(l=i.getDisplayListByName("PICKING_L"+-a))||(l=i.addDisplayList(new e.DisplayList({name:"PICKING_L"+-a,priority:2048-a,zSort:e.FrontToBack,side:R.FrontSide,polygonOffset:!1,pickingPriority:!0})),this.resetGSSOCache());r[o.id]=l}n=o}i._pickingPriorityMapping=r}else i._pickingPriorityMapping=null},this.setCurrentPass=function(e){this.currentPass=e},this.context=be;var kt=be.getParameter(be.MAX_TEXTURE_IMAGE_UNITS),Ut=be.getParameter(be.MAX_VERTEX_TEXTURE_IMAGE_UNITS),zt=be.getParameter(be.MAX_TEXTURE_SIZE),Ht=be.getParameter(be.MAX_CUBE_MAP_TEXTURE_SIZE),Wt=Re?be.getParameter(Re.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,jt=Ut>0,Xt=(Oe&&be.getParameter(be.COMPRESSED_TEXTURE_FORMATS),be.getShaderPrecisionFormat(be.VERTEX_SHADER,be.HIGH_FLOAT)),qt=be.getShaderPrecisionFormat(be.VERTEX_SHADER,be.MEDIUM_FLOAT),Zt=(be.getShaderPrecisionFormat(be.VERTEX_SHADER,be.LOW_FLOAT),be.getShaderPrecisionFormat(be.FRAGMENT_SHADER,be.HIGH_FLOAT)),Yt=be.getShaderPrecisionFormat(be.FRAGMENT_SHADER,be.MEDIUM_FLOAT),Qt=(be.getShaderPrecisionFormat(be.FRAGMENT_SHADER,be.LOW_FLOAT),be.getShaderPrecisionFormat(be.VERTEX_SHADER,be.HIGH_INT)),Kt=be.getShaderPrecisionFormat(be.VERTEX_SHADER,be.MEDIUM_INT),Jt=(be.getShaderPrecisionFormat(be.VERTEX_SHADER,be.LOW_INT),be.getShaderPrecisionFormat(be.FRAGMENT_SHADER,be.HIGH_INT)),$t=be.getShaderPrecisionFormat(be.FRAGMENT_SHADER,be.MEDIUM_INT),ei=(be.getShaderPrecisionFormat(be.FRAGMENT_SHADER,be.LOW_INT),Xt.precision>0&&Zt.precision>0),ti=qt.precision>0&&Yt.precision>0;"highp"!==X||ei||(ti?(X="mediump",e.VisualizationTraces.info("WebGLRenderer: highp not supported, using mediump")):(X="lowp",e.VisualizationTraces.info("WebGLRenderer: highp and mediump not supported, using lowp"))),"mediump"!==X||ti||(X="lowp",e.VisualizationTraces.info("WebGLRenderer: mediump not supported, using lowp"));var ii=0===Qt.precision&&0===Jt.precision,ri=0===Kt.precision&&0===$t.precision;function ni(e){var t,i;if(e.__webglVertexBuffer=be.createBuffer(),e.__webglNormalBuffer=be.createBuffer(),e.__webglTangentBuffer=be.createBuffer(),e.__webglColorBuffer=be.createBuffer(),e.__webglUVBuffer=be.createBuffer(),e.__webglUV2Buffer=be.createBuffer(),e.__webglSkinIndicesBuffer=be.createBuffer(),e.__webglSkinWeightsBuffer=be.createBuffer(),e.__webglFaceBuffer=be.createBuffer(),e.__webglLineBuffer=be.createBuffer(),e.numMorphTargets)for(e.__webglMorphTargetsBuffers=[],t=0,i=e.numMorphTargets;t<i;t++)e.__webglMorphTargetsBuffers.push(be.createBuffer());if(e.numMorphNormals)for(e.__webglMorphNormalsBuffers=[],t=0,i=e.numMorphNormals;t<i;t++)e.__webglMorphNormalsBuffers.push(be.createBuffer());_e.geometries++}"highp"!==ne||ii||(ri?(ne="mediump",e.VisualizationTraces.info("WebGLRenderer: highp int not supported, using mediump")):(ne="lowp",e.VisualizationTraces.info("WebGLRenderer: highp and mediump int not supported, using lowp"))),"mediump"!==ne||ri||(ne="lowp",e.VisualizationTraces.info("WebGLRenderer: mediump int not supported, using lowp")),this.getContext=function(){return be},this.supportsVertexTextures=function(){return jt},this.supportsFloatTextures=function(){return we&&(Ce||ke)},this.supportsHalfFloatTextures=function(){return Me&&(Pe||Ue)},this.getRendererInfo=function(){return Bt},this.supportsFloatLinearTextures=function(){return Ee},this.supportsHalfFloatLinearTextures=function(){return Ae},this.supportsStandardDerivatives=function(){return Te},this.supportsCompressedTextureS3TC=function(){return Oe},this.supportsMinMaxBlending=function(){return je},this.supportsElementIndexUint=function(){return He||2===e.WebGLVersion},this.getMaxAnisotropy=function(){return Wt},this.getPrecision=function(){return X},this.setGLSize=function(t,i,r,n,a,s){this.devicePixelRatio=this._renderScale*(e.getDevicePixelRatio()||1),D.width=Math.floor(t*this.devicePixelRatio),D.height=Math.floor(i*this.devicePixelRatio),this._VRCompatible?(D.style.width="100%",D.style.height="100%"):(D.style.width=a+"px",D.style.height=s+"px"),this.setViewport(0,0,Math.floor(r*this.devicePixelRatio),Math.floor(n*this.devicePixelRatio)),h=t/2,c=(l=i)/2,j.style.width=t+"px",j.style.height=i+"px";for(var o=0;o<j.childNodes.length;o++){var d=j.childNodes[o];d.style.width=t+"px",d.style.height=i+"px"}},this.setViewport=function(t,i,r,n){var a=xt,s=bt,o=wt,l=Mt;xt=void 0!==t?t:0,bt=void 0!==i?i:0,wt=void 0!==r?r:D.width,Mt=void 0!==n?n:D.height,xt===a&&bt===s&&wt===o&&Mt===l&&e.glStates.currentWidth===wt&&e.glStates.currentHeight===Mt||be.viewport(xt,bt,wt,Mt),e.glStates.currentWidth=wt,e.glStates.currentHeight=Mt},this.removeSplitScreenMode=function(){this.splitScreenMode&&(this.activateSplitScreenMode(!1),this.splitScreenMode=null)},this.setSplitScreenMode=function(e,t){this.splitScreenMode={x:e,y:t,active:!1},this.activateSplitScreenMode(!0)},this.activateSplitScreenMode=function(e){this.splitScreenMode&&e!==this.splitScreenMode.active&&(e?(this.setScissor(this.splitScreenMode.x,this.splitScreenMode.y,wt,Mt),this.enableScissorTest(!0),this.setViewport(this.splitScreenMode.x,this.splitScreenMode.y,wt,Mt)):(this.enableScissorTest(!1),this.setViewport(0,0,wt,Mt)),this.splitScreenMode.active=!!e)},this.getViewportSize=function(){return{width:wt,height:Mt}},this.getViewport=function(){return{width:wt,height:Mt,x:xt,y:bt}},this.setScissor=function(e,t,i,r){Pt.x=e,Pt.y=t,Pt.width=i,Pt.height=r,be.scissor(e,t,i,r)},this.enableScissorTest=function(e){Ct=e,e?be.enable(be.SCISSOR_TEST):be.disable(be.SCISSOR_TEST)},this.getScissorTest=function(){return Ct},this.setClearColorHex=function(e,t){ge.setHex(e),me=t,be.clearColor(ge.r,ge.g,ge.b,me)},this.setClearColor=function(e,t){ge.copy(e),me=t,be.clearColor(ge.r,ge.g,ge.b,me)},this.getClearColor=function(){return ge},this.getClearAlpha=function(){return me},this.clear=function(e,t,i){var r=0;(void 0===e||e)&&(r|=be.COLOR_BUFFER_BIT),(void 0===t||t)&&(r|=be.DEPTH_BUFFER_BIT);var n=!1;(void 0===i||i)&&(n=!0,r|=be.STENCIL_BUFFER_BIT,this.setStencilWrite(!0)),r&&be.clear(r),n&&!this.enableStencilWrite&&this.setStencilWrite(!1)},this.clearTarget=function(e,t,i,r){this.setRenderTarget(e),this.clear(t,i,r)},this._getReflectionColorBufferResult=function(){return this.reflectionColorBuffer?this.reflectionColorBuffer.getResult():Gt},this._getRefractionColorBufferResult=function(){return this.refractionColorBuffer?this.refractionColorBuffer.getResult():Gt},this.addPostPlugin=function(e){e.init(this),this.renderPluginsPost.push(e)},this.addPrePlugin=function(e){e.init(this),this.renderPluginsPre.push(e)},this.updateShadowMap=function(e,t){be._currentProgram=null,be._oldBlending=-1,ut=-1,ft=-1,gt=-1,Je=-1,$e=-1,et=-1,Ye=-1,Ke=-1,it=null,It=!0,st=-1,ot=-1,this.shadowMapPlugin.update(e,t)};var ai,si,oi=function(e){return Math.abs(e)<1e-6?0:e},li=function(e){var t=e.elements;return"matrix3d("+oi(t[0])+","+oi(-t[1])+","+oi(t[2])+","+oi(t[3])+","+oi(t[4])+","+oi(-t[5])+","+oi(t[6])+","+oi(t[7])+","+oi(t[8])+","+oi(-t[9])+","+oi(t[10])+","+oi(t[11])+","+oi(t[12])+","+oi(-t[13])+","+oi(t[14])+","+oi(t[15])+")"},hi=function(e){var t=e.elements;return"translate3d(-50%,-50%,0) matrix3d("+oi(t[0])+","+oi(t[1])+","+oi(t[2])+","+oi(t[3])+","+oi(-t[4])+","+oi(-t[5])+","+oi(-t[6])+","+oi(-t[7])+","+oi(t[8])+","+oi(t[9])+","+oi(t[10])+","+oi(t[11])+","+oi(t[12])+","+oi(t[13])+","+oi(t[14])+","+oi(t[15])+")"},ci=function(e){var t=e.target;t.removeEventListener("dispose",ci),gi(t),Xe&&_e.geometries--},di=function(e){var t=e.target;t.removeEventListener("dispose",di);var i=Xe?Xe.info:null;t.deallocate(be,i)},ui=function(e){var t=e.target;t.removeEventListener("dispose",ui),mi(t),t.textures&&(t.usedTexture=-1),Xe&&_e.textures--},pi=function(e){var t=e.target;t.removeEventListener("dispose",pi),vi(t),Xe&&_e.renderTargets--;var i=Xe?Xe.__glResources__.renderTarget:null;i&&i[t.uniqueID]&&delete i[t.uniqueID]},fi=function(e){var t=e.target;t.removeEventListener("dispose",fi);var i=null!==t.program?t.program.program:null;yi(t,i,!0)},gi=function(e){if(e.__webglInit=void 0,void 0!==e.__webglVertexBuffer&&be.deleteBuffer(e.__webglVertexBuffer),void 0!==e.__webglNormalBuffer&&be.deleteBuffer(e.__webglNormalBuffer),void 0!==e.__webglTangentBuffer&&be.deleteBuffer(e.__webglTangentBuffer),void 0!==e.__webglColorBuffer&&be.deleteBuffer(e.__webglColorBuffer),void 0!==e.__webglUVBuffer&&be.deleteBuffer(e.__webglUVBuffer),void 0!==e.__webglUV2Buffer&&be.deleteBuffer(e.__webglUV2Buffer),void 0!==e.__webglTangentBuffer&&be.deleteBuffer(e.__webglTangentBuffer),void 0!==e.__webglBinormalBuffer&&be.deleteBuffer(e.__webglBinormalBuffer),void 0!==e.__webglSkinIndicesBuffer&&be.deleteBuffer(e.__webglSkinIndicesBuffer),void 0!==e.__webglSkinWeightsBuffer&&be.deleteBuffer(e.__webglSkinWeightsBuffer),void 0!==e.__webglFaceBuffer&&be.deleteBuffer(e.__webglFaceBuffer),void 0!==e.__webglLineBuffer&&be.deleteBuffer(e.__webglLineBuffer),void 0!==e.__webglLineDistanceBuffer&&be.deleteBuffer(e.__webglLineDistanceBuffer),void 0!==e.geometryGroups)for(var t in e.geometryGroups){Si(e.geometryGroups[t])}},mi=function(e){var t=Xe.__glResources__.texture.indexOf(e);t>=0&&Xe.__glResources__.texture.splice(t,1),e.__webglInit&&(e.__webglInit=!1,be.deleteTexture(e.__webglTexture),e.needsUpdate=!0)},vi=function(t){if(t&&t.__webglTexture)if(be.deleteTexture(t.__webglTexture),t instanceof e.WebGLRenderTargetCube)for(var i=0;i<6;i++)be.deleteFramebuffer(t.__webglFramebuffer[i]),be.deleteRenderbuffer(t.__webglRenderbuffer[i]);else be.deleteFramebuffer(t.__webglFramebuffer),be.deleteRenderbuffer(t.__webglRenderbuffer)},yi=function(e,t,i){if(null!==t){if(i)return e.programManager.disposeAllPrograms(yi),void e._deallocate(Xe);var r,n,a;e.program=null;var s=!1;for(r=0,n=qe.length;r<n;r++)if(null!==(a=qe[r]).program&&a.program.program===t){a.usedTimes--,0===a.usedTimes&&(s=!0);break}if(!0===s){var o=[];for(r=0,n=qe.length;r<n;r++)null!==(a=qe[r]).program&&a.program.program!==t&&o.push(a);qe=o,be.deleteProgram(t),Xe&&_e.programs--}}};function Si(e){var t,i;if(be.deleteBuffer(e.__webglVertexBuffer),be.deleteBuffer(e.__webglNormalBuffer),be.deleteBuffer(e.__webglTangentBuffer),be.deleteBuffer(e.__webglColorBuffer),be.deleteBuffer(e.__webglUVBuffer),be.deleteBuffer(e.__webglUV2Buffer),be.deleteBuffer(e.__webglSkinIndicesBuffer),be.deleteBuffer(e.__webglSkinWeightsBuffer),be.deleteBuffer(e.__webglFaceBuffer),be.deleteBuffer(e.__webglLineBuffer),e.numMorphTargets)for(t=0,i=e.numMorphTargets;t<i;t++)be.deleteBuffer(e.__webglMorphTargetsBuffers[t]);if(e.numMorphNormals)for(t=0,i=e.numMorphNormals;t<i;t++)be.deleteBuffer(e.__webglMorphNormalsBuffers[t]);_e.geometries--}function _i(e,t){var i,r,n=t.geometry,a=e.faces3,s=e.faces4,o=3*a.length+4*s.length,l=1*a.length+2*s.length,h=3*a.length+4*s.length,c=xi(t,e),d=Mi(c),u=bi(c),p=wi(c);if(e.__vertexArray=new Float32Array(3*o),u&&(e.__normalArray=new Float32Array(3*o)),n.hasTangents&&(e.__tangentArray=new Float32Array(4*o)),p&&(e.__colorArray=new Float32Array(3*o)),d&&((n.faceUvs.length>0||n.faceVertexUvs.length>0)&&(e.__uvArray=new Float32Array(2*o)),(n.faceUvs.length>1||n.faceVertexUvs.length>1)&&(e.__uv2Array=new Float32Array(2*o))),t.geometry.skinWeights.length&&t.geometry.skinIndices.length&&(e.__skinIndexArray=new Float32Array(4*o),e.__skinWeightArray=new Float32Array(4*o)),e.__faceArray=new Uint16Array(3*l),e.__lineArray=new Uint16Array(2*h),e.numMorphTargets)for(e.__morphTargetsArrays=[],i=0,r=e.numMorphTargets;i<r;i++)e.__morphTargetsArrays.push(new Float32Array(3*o));if(e.numMorphNormals)for(e.__morphNormalsArrays=[],i=0,r=e.numMorphNormals;i<r;i++)e.__morphNormalsArrays.push(new Float32Array(3*o));e.__webglFaceCount=3*l,e.__webglLineCount=2*h,e.__inittedArrays=!0}function xi(t,i){return t.material instanceof e.MeshFaceMaterial?t.material.materials[i.materialIndex]:t.material}function bi(t){return function(t){return t&&void 0!==t.shading&&t.shading===e.SmoothShading}(t)?e.SmoothShading:e.FlatShading}function wi(e){return!!e.vertexColors&&e.vertexColors}function Mi(t){return!!(t.map||t.bumpMap||t.normalMap||t.specularMap||t instanceof e.ShaderMaterial)}function Ci(e,t,i){var r,n,a,s,o,l=e.vertices,h=l.length,c=e.colors,d=c.length,u=e.__vertexArray,p=e.__colorArray,f=e.__sortArray,g=e.verticesNeedUpdate,m=(e.elementsNeedUpdate,e.colorsNeedUpdate);e.__webglCustomAttributesList;if(i.sortParticles){for(Tt.copy(At),Tt.multiply(i.matrixWorld),r=0;r<h;r++)a=l[r],Dt.copy(a),Dt.applyProjection(Tt),f[r]=[Dt.z,r];for(f.sort($),r=0;r<h;r++)a=l[f[r][1]],u[s=3*r]=a.x,u[s+1]=a.y,u[s+2]=a.z;for(n=0;n<d;n++)s=3*n,o=c[f[n][1]],p[s]=o.r,p[s+1]=o.g,p[s+2]=o.b}else{if(g)for(r=0;r<h;r++)a=l[r],u[s=3*r]=a.x,u[s+1]=a.y,u[s+2]=a.z;if(m)for(n=0;n<d;n++)o=c[n],p[s=3*n]=o.r,p[s+1]=o.g,p[s+2]=o.b}(g||i.sortParticles)&&(be.bindBuffer(be.ARRAY_BUFFER,e.__webglVertexBuffer),be.bufferData(be.ARRAY_BUFFER,u,t)),(m||i.sortParticles)&&(be.bindBuffer(be.ARRAY_BUFFER,e.__webglColorBuffer),be.bufferData(be.ARRAY_BUFFER,p,t))}function Pi(t,i,r,n,a){if(t.__inittedArrays){var s,o,l,h,c,d,u,p,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A,T,D=bi(a),I=wi(a),R=Mi(a),O=D===e.SmoothShading,L=0,V=0,F=0,B=0,N=0,G=0,k=0,U=0,z=t.__vertexArray,H=t.__uvArray,W=t.__normalArray,j=t.__tangentArray,X=t.__colorArray,q=t.__faceArray,Z=t.__lineArray,Y=i.geometry,Q=Y.verticesNeedUpdate,K=Y.elementsNeedUpdate,J=Y.uvsNeedUpdate,$=Y.normalsNeedUpdate,ee=Y.tangentsNeedUpdate,te=Y.colorsNeedUpdate,ie=Y.vertices,re=t.faces3,ne=t.faces4,ae=Y.faces,se=Y.faceVertexUvs[0];if(Q){for(s=0,o=re.length;s<o;s++)g=ie[(l=ae[re[s]]).a],m=ie[l.b],v=ie[l.c],z[V]=g.x,z[V+1]=g.y,z[V+2]=g.z,z[V+3]=m.x,z[V+4]=m.y,z[V+5]=m.z,z[V+6]=v.x,z[V+7]=v.y,z[V+8]=v.z,V+=9;for(s=0,o=ne.length;s<o;s++)g=ie[(l=ae[ne[s]]).a],m=ie[l.b],v=ie[l.c],y=ie[l.d],z[V]=g.x,z[V+1]=g.y,z[V+2]=g.z,z[V+3]=m.x,z[V+4]=m.y,z[V+5]=m.z,z[V+6]=v.x,z[V+7]=v.y,z[V+8]=v.z,z[V+9]=y.x,z[V+10]=y.y,z[V+11]=y.z,V+=12;be.bindBuffer(be.ARRAY_BUFFER,t.__webglVertexBuffer),be.bufferData(be.ARRAY_BUFFER,z,r)}if(te&&I){for(s=0,o=re.length;s<o;s++)d=(l=ae[re[s]]).vertexColors,u=l.color,3===d.length&&I===e.VertexColorType.RGBA?(w=d[0],M=d[1],C=d[2]):(w=u,M=u,C=u),X[U]=w.r,X[U+1]=w.g,X[U+2]=w.b,X[U+3]=M.r,X[U+4]=M.g,X[U+5]=M.b,X[U+6]=C.r,X[U+7]=C.g,X[U+8]=C.b,U+=9;for(s=0,o=ne.length;s<o;s++)d=(l=ae[ne[s]]).vertexColors,u=l.color,4===d.length&&I===e.VertexColorType.RGBA?(w=d[0],M=d[1],C=d[2],P=d[3]):(w=u,M=u,C=u,P=u),X[U]=w.r,X[U+1]=w.g,X[U+2]=w.b,X[U+3]=M.r,X[U+4]=M.g,X[U+5]=M.b,X[U+6]=C.r,X[U+7]=C.g,X[U+8]=C.b,X[U+9]=P.r,X[U+10]=P.g,X[U+11]=P.b,U+=12;U>0&&(be.bindBuffer(be.ARRAY_BUFFER,t.__webglColorBuffer),be.bufferData(be.ARRAY_BUFFER,X,r))}if(ee&&Y.hasTangents){for(s=0,o=re.length;s<o;s++)S=(p=(l=ae[re[s]]).vertexTangents)[0],_=p[1],x=p[2],j[G]=S.x,j[G+1]=S.y,j[G+2]=S.z,j[G+3]=S.w,j[G+4]=_.x,j[G+5]=_.y,j[G+6]=_.z,j[G+7]=_.w,j[G+8]=x.x,j[G+9]=x.y,j[G+10]=x.z,j[G+11]=x.w,G+=12;for(s=0,o=ne.length;s<o;s++)S=(p=(l=ae[ne[s]]).vertexTangents)[0],_=p[1],x=p[2],b=p[3],j[G]=S.x,j[G+1]=S.y,j[G+2]=S.z,j[G+3]=S.w,j[G+4]=_.x,j[G+5]=_.y,j[G+6]=_.z,j[G+7]=_.w,j[G+8]=x.x,j[G+9]=x.y,j[G+10]=x.z,j[G+11]=x.w,j[G+12]=b.x,j[G+13]=b.y,j[G+14]=b.z,j[G+15]=b.w,G+=16;be.bindBuffer(be.ARRAY_BUFFER,t.__webglTangentBuffer),be.bufferData(be.ARRAY_BUFFER,j,r)}if($&&D){for(s=0,o=re.length;s<o;s++)if(h=(l=ae[re[s]]).vertexNormals,c=l.normal,3===h.length&&O)for(E=0;E<3;E++)A=h[E],W[N]=A.x,W[N+1]=A.y,W[N+2]=A.z,N+=3;else for(E=0;E<3;E++)W[N]=c.x,W[N+1]=c.y,W[N+2]=c.z,N+=3;for(s=0,o=ne.length;s<o;s++)if(h=(l=ae[ne[s]]).vertexNormals,c=l.normal,4===h.length&&O)for(E=0;E<4;E++)A=h[E],W[N]=A.x,W[N+1]=A.y,W[N+2]=A.z,N+=3;else for(E=0;E<4;E++)W[N]=c.x,W[N+1]=c.y,W[N+2]=c.z,N+=3;be.bindBuffer(be.ARRAY_BUFFER,t.__webglNormalBuffer),be.bufferData(be.ARRAY_BUFFER,W,r)}if(J&&se&&R){for(s=0,o=re.length;s<o;s++)if(void 0!==(f=se[re[s]]))for(E=0;E<3;E++)T=f[E],H[F]=T.x,H[F+1]=T.y,F+=2;for(s=0,o=ne.length;s<o;s++)if(void 0!==(f=se[ne[s]]))for(E=0;E<4;E++)T=f[E],H[F]=T.x,H[F+1]=T.y,F+=2;F>0&&(be.bindBuffer(be.ARRAY_BUFFER,t.__webglUVBuffer),be.bufferData(be.ARRAY_BUFFER,H,r))}if(K){for(s=0,o=re.length;s<o;s++)q[B]=L,q[B+1]=L+1,q[B+2]=L+2,B+=3,Z[k]=L,Z[k+1]=L+1,Z[k+2]=L,Z[k+3]=L+2,Z[k+4]=L+1,Z[k+5]=L+2,k+=6,L+=3;for(s=0,o=ne.length;s<o;s++)q[B]=L,q[B+1]=L+1,q[B+2]=L+3,q[B+3]=L+1,q[B+4]=L+2,q[B+5]=L+3,B+=6,Z[k]=L,Z[k+1]=L+1,Z[k+2]=L,Z[k+3]=L+3,Z[k+4]=L+1,Z[k+5]=L+2,Z[k+6]=L+2,Z[k+7]=L+3,k+=8,L+=4;be.bindBuffer(be.ELEMENT_ARRAY_BUFFER,t.__webglFaceBuffer),be.bufferData(be.ELEMENT_ARRAY_BUFFER,q,r),be.bindBuffer(be.ELEMENT_ARRAY_BUFFER,t.__webglLineBuffer),be.bufferData(be.ELEMENT_ARRAY_BUFFER,Z,r)}n&&(delete t.__inittedArrays,delete t.__colorArray,delete t.__normalArray,delete t.__tangentArray,delete t.__uvArray,delete t.__uv2Array,delete t.__binormalArray,delete t.__faceArray,delete t.__vertexArray,delete t.__lineArray,delete t.__skinIndexArray,delete t.__skinWeightArray)}}this.newMaterialInheritance=!1,this.initSharedBuffersDS=function(e,t){},this.renderBufferDirect=function(t,i,r,n,a){if(!1!==r.visible){var s,o,l,h,c,d,u,p=!1;o=(s=ki(t,i,r,a,void 0,n,r.programManager.getProgramID(a,null,this.materialToUse),null,this.materialToUse)).attributes,l=n.attributes;var f=!1,g=r.wireframe?1:0,m=16777215*n.id+2*s.id+g;if(m!==Je&&(Je=m,f=!0),f&&Di(),a instanceof e.Mesh){var v=l.index;if(v){var y=n.offsets;y.length>1&&(f=!0);for(var S=0,_=y.length;S<_;S++){var x=y[S].index;if(f){for(c in l)"index"!==c&&(d=o[c],u=(h=l[c]).itemSize,d>=0&&(be.bindBuffer(be.ARRAY_BUFFER,h.buffer),Ti(d),be.vertexAttribPointer(d,u,be.FLOAT,!1,0,x*u*4)));be.bindBuffer(be.ELEMENT_ARRAY_BUFFER,v.buffer)}be.drawElements(be.TRIANGLES,y[S].count,be.UNSIGNED_SHORT,2*y[S].start),xe.calls++,xe.vertices+=y[S].count,xe.faces+=y[S].count/3,p=!0}}else{if(f)for(c in l)"index"!==c&&(d=o[c],u=(h=l[c]).itemSize,d>=0&&(be.bindBuffer(be.ARRAY_BUFFER,h.buffer),Ti(d),be.vertexAttribPointer(d,u,be.FLOAT,!1,0,0)));var b=n.attributes.position;be.drawArrays(be.TRIANGLES,0,b.numItems/3),p=!0,xe.calls++,xe.vertices+=b.numItems/3,xe.faces+=b.numItems/3/3}}else if(a instanceof e.ParticleSystem){if(f){for(c in l)d=o[c],u=(h=l[c]).itemSize,d>=0&&(be.bindBuffer(be.ARRAY_BUFFER,h.buffer),Ti(d),be.vertexAttribPointer(d,u,be.FLOAT,!1,0,0));b=l.position;be.drawArrays(be.POINTS,0,b.numItems/3),p=!0,xe.calls++,xe.points+=b.numItems/3}}else if(a instanceof e.Line&&f){for(c in l)d=o[c],u=(h=l[c]).itemSize,d>=0&&(be.bindBuffer(be.ARRAY_BUFFER,h.buffer),Ti(d),be.vertexAttribPointer(d,u,be.FLOAT,!1,0,0));qi(r.lineWidth);b=l.position;be.drawArrays(be.LINE_STRIP,0,b.numItems/3),p=!0,xe.calls++,xe.points+=b.numItems}return p}};var Ei=new e.DSPBR19xMaterial({color:14540253,roughness:.34,specular:16777215,ior:1.4,metalness:0,specularContrib:1,opacity:1,transparency:0}),Ai=e.GeomTypeEnum;function Ti(e){be._enabledAttributes[e]||(be.enableVertexAttribArray(e),be._enabledAttributes[e]=!0)}function Di(){for(var e in be._enabledAttributes)be._enabledAttributes[e]&&(be.disableVertexAttribArray(e),be._enabledAttributes[e]=!1)}this.getRenderMode=function(t){var i=e.RenderMode;ai||(ai=new i);var r=e.PickingMode;si||(si=new r);var n=this.renderLineMode||0,a=this.renderPointMode||0,s=this.renderFaceMode,o=this.outlineWidth,l=this.halfVisibleSmoothEdges?1:0,h=this.renderHiddenEdges?1:0,c=ai;if(t){var d=null,u=t._occurrence;if(u){var p=u.renderMode;p&&(p._useRenderLineMask&&(n=p.getMasks()[1]),p._useRenderPointMask&&(a=p.getMasks()[2]),p._useRenderFaceMask&&(s=p.getMasks()[0]),o=p._outlineWidth,p._halfVisibleSmoothEdges>-1&&(l=p._halfVisibleSmoothEdges),p._hiddenEdges>-1&&(h=p._hiddenEdges)),d=u.pickingMode}(P||M)&&(d||(d=si)._fromRenderer(this),c._setFromMasks(a,n,s),[s,n,a]=d.getPickingMasks(c),v&&(n&=~e.BodyLinesMask,a&=~e.BodyPointsMask),P&&(s|=Ai.FACE))}return c._setFromMasks(a,n,s),c.setOutlineWidth(o),c.setHalfVisibleSmoothEdges(l),c.setHiddenEdges(h),c},this.getMaterialMode=function(e,t){if(e){if(e._occurrence&&null!==e._occurrence.faceMode)return e._occurrence.faceMode.material;if(e.materialMode<2)return!!e.materialMode}return!t&&this.materialMode},this.getRenderLineMode=function(e){var t=e&&e._occurrence&&e._occurrence.renderMode;return t&&t._useRenderLineMask?t.getMasks()[1]:this.renderLineMode},this.recompileAllShaders=function(e){e=e||re;for(var t=0;t<e.length;t++)this.shaderVersions[e[t]]++},this.setupPickingMaterial=function(e,t,i){var r=i.pickingID>>16&255,n=(i.pickingID>>8&255)/255,a=(255&i.pickingID)/255;if(t==be.LINES||e&&e.lineWidth){r|=64}else if(t==be.TRIANGLES||null==t){r|=128}O.setRGB(r/255,n,a)},this.renderInterval=function(t,i,r,a,s,o,l,h,c,d,u,p,f,g,m,v,y){xe.nbDGs++,xe.nbReps+=l.cullingData?l.cullingData.length:1;var S=0;if(l.cullingData&&!t.isOrtho){var _=l.glType===be.TRIANGLES?c/3:c/2;if((_/=l.cullingData.length)>this.ratioSSB){var x=t.performPixelCullingOnDG(f,r,o,l,h,c);if(xe.nbDGsSSBProcessed++,l.glType===be.TRIANGLES?xe.culledDGTriangles+=(c-x)/3:l.glType===be.LINES&&(xe.culledDGLines+=(c-x)/2),S=1-x/(c+1),this.colorizeSSB||(c=x),0===c)return!1}}var M,P,E,T=l.glType,D=l._instancingInfos?l._instancingInfos:r._instancingInfos?r._instancingInfos:null,I=D?D.instanceAttribArrays:null,R=null!==I,L=o.vertexBufferGPU,V=o.indexBufferGPU,F=!1;D&&(n.deallocate(D.staleGLBuffers),D.staleGLBuffers=[],R||(l._instancingInfos?l._instancingInfos=null:r._instancingInfos&&(r._instancingInfos=null))),o.needsUpdate&&(o.needsUpdate=!1,o.deallocate(be,Xe.info),F=!0);var B=be._currentProgram,N=a.programManager.getTokenProgramID(g,y);p||N!==nt?(a.previousOccurrenceRenderingOverride=null,ki(t,i,a,r,u,o,N,m,v,y)):this[(G=a.program.objectUniformLocations).funcName](G,r,o,a,t,i,m);if(v){var G=a.program.uniformLocations;this.loadGASUniforms(be,a,G,u,v)}if(m&&m._mappingOperator&&m._loadMappingOperatorUniforms(a,this,be),b)this.setupPickingMaterial(a,T,r),(G=a.program.uniformLocations).pickingColor?be.uniform3f(G.pickingColor,O.r,O.g,O.b):be.uniform3f(G.diffuse,O.r,O.g,O.b);else if(this._planeViewMode&&r._applyPlaneViewMode&&(this._planeViewMode.mode===e.PlaneViewMode.LOWLIGHT||this._planeViewMode.mode===e.PlaneViewMode.LOWLIGHT_NO_PICK)){(G=a.program.uniformLocations).diffuse&&be.uniform3f(G.diffuse,.26,.4,.33)}else if(this.colorizeSSB&&S){(G=a.program.uniformLocations).diffuse&&be.uniform3f(G.diffuse,S,0,0)}a.map&&a.map.lods&&!C&&!A&&a.map.chooseTexture(t,r),M=a.program,P=M.attributes,E=M.instanceAttributes;var k=!1;!M.uvOrBinOrTan||o.compressedNormals||o.vertexBufferGPU&&o.vertexBufferGPU.layout.has("uv")||(o.vertexIndexArray?(o.computeUVs(),o.deallocate(be,Xe.info),F=!0):(m&&m._mappingOperator?m._mappingOperator.mappingType:a.mappingType)<1&&this._NoMeshInRamWarningCount<1&&(console.warn("uv computation unavailable in noMeshInRAM mode"),this._NoMeshInRamWarningCount++));var U=a.requireVertexTangentBinormal()&&(m&&m._mappingOperator?m._mappingOperator.mappingType:a.mappingType)<1;if(o.vertexBufferGPU?!(U&&o.vertexBufferGPU.layout.has("uv")&&o.vertexBufferGPU.layout.has("normal"))||o.vertexBufferGPU.layout.has("binormal")&&o.vertexBufferGPU.layout.has("tangent")||(o.vertexIndexArray?(o.computeTangents(),o.deallocate(be,Xe.info),F=!0):this._NoMeshInRamWarningCount<2&&(console.warn("tangent binormal computation unavailable in noMeshInRAM mode"),this._NoMeshInRamWarningCount++)):!(o.vertexUvArray&&o.vertexNormalArray&&U)||o.vertexBinormalArray&&o.vertexTangentArray||(o.computeTangents(),o.deallocate(be,Xe.info),F=!0),L&&V||(F=!0),R)for(var z in at!==I.id&&(at=I.id,k=!0),I)if("id"!==z){if(!I[z].buffer){n.allocateInstancingBuffers(r,l);break}I[z].isDynamic&&(be.bindBuffer(be.ARRAY_BUFFER,I[z].buffer),be.bufferData(be.ARRAY_BUFFER,I[z].array,be.DYNAMIC_DRAW),I[z].isDynamic=!1)}if(F&&(n.allocateDirect(o),L=o.vertexBufferGPU,V=o.indexBufferGPU),!L||!V)return!1;if(o._uploadStaleIndices(be),o._uploadStaleVertices(be),L!==$e&&($e=L,k=!0),k&&(xe.swapBuffers++,xe.unsharedBuffers+=o.sharedBuffers&&!L.isShared?1:0,be.bindBuffer(be.ARRAY_BUFFER,L.buffer),L.layout.forEach(function(e){const t=P[e.name];if(!Number.isInteger(t)||t<0)return;const i=w.VertexAttribute[e.type];be.vertexAttribPointer(t,i.components,i.native,i.normalized,e.stride,e.offset)}),R))for(var H in I)"id"!==H&&(be.bindBuffer(be.ARRAY_BUFFER,I[H].buffer),E[H]>=0&&I[H].array&&(I[H].isMat4?(be.vertexAttribPointer(E[H],I[H].itemSize,be.FLOAT,!1,64,0),be.vertexAttribPointer(E[H]+1,I[H].itemSize,be.FLOAT,!1,64,16),be.vertexAttribPointer(E[H]+2,I[H].itemSize,be.FLOAT,!1,64,32),be.vertexAttribPointer(E[H]+3,I[H].itemSize,be.FLOAT,!1,64,48)):be.vertexAttribPointer(E[H],I[H].itemSize,be.FLOAT,!1,0,0)));if(V!==et&&(et=V,be.bindBuffer(be.ELEMENT_ARRAY_BUFFER,V.buffer)),B!=be._currentProgram){var W={};if(R)for(var H in I)"id"!==H&&E[H]>=0&&(I[H].isMat4?(W[E[H]]=!0,W[E[H]+1]=!0,W[E[H]+2]=!0,W[E[H]+3]=!0):W[E[H]]=!0);r.isCurvedPipe&&(E.specialMeshIds>=0&&(W[E.specialMeshIds]=!0),E.specialMeshPicking>=0&&(W[E.specialMeshPicking]=!0)),L.layout.forEach(function(e){const t=P[e.name];!Number.isInteger(t)||t<0||(W[t]=!0)}),function(e){for(var t in e)be._enabledAttributes[t]||(be.enableVertexAttribArray(t),be._enabledAttributes[t]=!0);for(var t in be._enabledAttributes)be._enabledAttributes[t]&&!e[t]&&(be.disableVertexAttribArray(t),be._enabledAttributes[t]=!1)}(W)}var j=!1,X=!1;if(d&&d.scissor&&"box"===d.scissor.type){j=!0;var q,Z,Y,Q,K=d.scissor.data;K.updateClipRect(t,this.currentFrameIndex,wt,Mt),be.enable(be.SCISSOR_TEST),Ct?(q=Math.max(Pt.x,K.clipX0),Z=Math.max(Pt.y,K.clipY0),Y=Math.min(Pt.x+Pt.width,K.clipX1)-q,Q=Math.min(Pt.y+Pt.height,K.clipY1-Z)):(q=K.clipX0,Z=K.clipY0,Y=K.clipX1-K.clipX0,Q=K.clipY1-K.clipY0),be.scissor(q,Z,Y,Q),(q+Y<0||Z+Q<0||q>wt||Z>Mt)&&(X=!0)}if(!X)if(g)g.draw(be,g,c,Nt,I,E);else{const e=o.indexBufferGPU,t=T===be.TRIANGLES||T===be.TRIANGLE_STRIP;a.wireframe&&t?be.drawElements(be.LINE_STRIP,c,e.glFormat,h*e.bytesPerIndex):T===be.POINTS&&o.vertexPositionArray&&o.vertexPositionArray.nonindexedPoints?be.drawArrays(T,o.vertexIndexArray[h],c):l.nonIndexed?be.drawArrays(T,h,c):be.drawElements(T,c,e.glFormat,(o.indexOffsetGPU+h)*e.bytesPerIndex)}return j&&(Ct?be.enable(be.SCISSOR_TEST):be.disable(be.SCISSOR_TEST),Pt.x!==-1/0&&be.scissor(Pt.x,Pt.y,Pt.width,Pt.height)),xe.calls++,xe.vertices+=c,T===be.TRIANGLES?xe.faces+=c/3:T===be.LINES?xe.lines+=c/2:T===be.POINTS&&(xe.points+=c),!0},this.renderSectionLines=function(e,t,i,r,n,a,s,o,l,h,c,d,u,p,f,g,m){if(r.__isSectionLine){var v=0;for(v=0;v<Ft.length;v++)if(Ft.sectionLines[v]){var y=r.program;r.clipPlaneIndex=v+1,y&&y.program===be._currentProgram&&be.uniform1i(y.uniformLocations.currentClipPlane,v),this._clipPlanesState.update(h,null,!0,r,e,!0),this.renderInterval.apply(this,arguments)}r.clipPlaneIndex=0,this._clipPlanesState.update(h,null,!0,r,e,!1)}else this.renderInterval.apply(this,arguments)},this.renderBuffer=function(t,i,r,n,a,s){if(!1===r.visible)return!1;var o,l,h,c,d,u;l=(o=ki(t,i,r,a,s,null,r.programManager.getProgramID(a,null,this.materialToUse),null,null,this.materialToUse)).attributes,b&&(this.setupPickingMaterial(r,null,a),r.uniforms&&r.uniforms.pickingColor?be.uniform3f(r.program.uniformLocations.pickingColor,O.r,O.g,O.b):be.uniform3f(r.program.uniformLocations.diffuse,O.r,O.g,O.b));var p=!1,f=r.wireframe?1:0,g=16777215*n.id+2*o.id+f;if(g!==Je&&(Je=g,p=!0),p&&Di(),!r.morphTargets&&l.position>=0?p&&(be.bindBuffer(be.ARRAY_BUFFER,n.__webglVertexBuffer),Ti(l.position),be.vertexAttribPointer(l.position,3,be.FLOAT,!1,0,0)):a.morphTargetBase,p){if(n.__webglCustomAttributesList)for(d=0,u=n.__webglCustomAttributesList.length;d<u;d++)l[(c=n.__webglCustomAttributesList[d]).buffer.belongsToAttribute]>=0&&(be.bindBuffer(be.ARRAY_BUFFER,c.buffer),Ti(l[c.buffer.belongsToAttribute]),be.vertexAttribPointer(l[c.buffer.belongsToAttribute],c.size,be.FLOAT,!1,0,0));l.color>=0&&n.__colorArray&&(be.bindBuffer(be.ARRAY_BUFFER,n.__webglColorBuffer),Ti(l.color),be.vertexAttribPointer(l.color,3,be.FLOAT,!1,0,0)),l.normal>=0&&n.__normalArray&&(be.bindBuffer(be.ARRAY_BUFFER,n.__webglNormalBuffer),Ti(l.normal),be.vertexAttribPointer(l.normal,3,be.FLOAT,!1,0,0)),l.tangent>=0&&n.__tangentArray&&(be.bindBuffer(be.ARRAY_BUFFER,n.__webglTangentBuffer),Ti(l.tangent),be.vertexAttribPointer(l.tangent,4,be.FLOAT,!1,0,0)),l.uv>=0&&n.__uvArray&&(be.bindBuffer(be.ARRAY_BUFFER,n.__webglUVBuffer),Ti(l.uv),be.vertexAttribPointer(l.uv,2,be.FLOAT,!1,0,0)),l.uv2>=0&&n.__uv2Array&&(be.bindBuffer(be.ARRAY_BUFFER,n.__webglUV2Buffer),Ti(l.uv2),be.vertexAttribPointer(l.uv2,2,be.FLOAT,!1,0,0)),(a._skinning||a._skinningInstancing)&&l.skinIndex>=0&&l.skinWeight>=0&&(be.bindBuffer(be.ARRAY_BUFFER,n.__webglSkinIndicesBuffer),Ti(l.skinIndex),be.vertexAttribPointer(l.skinIndex,4,be.FLOAT,!1,0,0),be.bindBuffer(be.ARRAY_BUFFER,n.__webglSkinWeightsBuffer),Ti(l.skinWeight),be.vertexAttribPointer(l.skinWeight,4,be.FLOAT,!1,0,0)),l.lineDistance>=0&&(be.bindBuffer(be.ARRAY_BUFFER,n.__webglLineDistanceBuffer),Ti(l.lineDistance),be.vertexAttribPointer(l.lineDistance,2,be.FLOAT,!1,0,0))}return a instanceof e.Mesh?(r.wireframe?(qi(r.wireframeLinewidth),p&&be.bindBuffer(be.ELEMENT_ARRAY_BUFFER,n.__webglLineBuffer),be.drawElements(be.LINES,n.__webglLineCount,be.UNSIGNED_SHORT,0)):(p&&be.bindBuffer(be.ELEMENT_ARRAY_BUFFER,n.__webglFaceBuffer),be.drawElements(be.TRIANGLES,n.__webglFaceCount,be.UNSIGNED_SHORT,0)),xe.calls++,xe.vertices+=n.__webglFaceCount,xe.faces+=n.__webglFaceCount/3):a instanceof e.Line?(h=a.type===e.LineStrip?be.LINE_STRIP:be.LINES,qi(r.lineWidth),be.drawArrays(h,0,n.__webglLineCount),xe.calls++):a instanceof e.ParticleSystem&&(be.drawArrays(be.POINTS,0,n.__webglParticleCount),xe.calls++,xe.points+=n.__webglParticleCount),!0},this.isQAAutomationMode=function(){return this._defaultAppearanceType===e.DefaultAppearanceMode.__QA_AUTOMATION__},this.addDGToDL=function({object:t,geometry:i,dg:r=null,dgInterval:n=null,material:a,originalMaterial:s,renderMode:o=null,getDLFromObjectFunc:l,geomDisposeFunc:h,enableGSSOCache:c,camera:u,matApp:f=null,gasMaterial:g=null,gasStruct:v=null,materialMode:y=!1}){if(a.visible){var x=this._defaultAppearanceType;(S||_)&&(x=z.BASIC);var b=x===e.DefaultAppearanceMode.__QA_AUTOMATION__;if(!this.renderVolumesOnly&&s._isLineWithShapes&&!C&&!A){const n=new e.Matrix4(this.domElement.width/2,0,0,0,0,this.domElement.height/2,0,0,0,0,1,0,0,0,0,1).multiply(u.projectionMatrix).multiply(u.matrixWorldInverse).multiply(t._getMMMatrix());let a=s._computeDependentDGs(r,i,n);for(let e=0;e<a.length;e++){let i=a[e].material;i._deferredMaterialsInit||i.updateDeferredMaterials(),this.addDGToDL({object:t,geometry:a[e].geometry,dg:a[e],dgInterval:a[e],material:i._deferredMaterials[this.materialToUse],originalMaterial:i,renderMode:o,getDLFromObjectFunc:l,geomDisposeFunc:h,enableGSSOCache:c,camera:u,matApp:f,gasMaterial:g,gasStruct:v,materialMode:y})}}var w=a,M=s;if(!this.gasAsPhong||!w.isPhysicalMaterial||null===w._phongFallbackMaterial||((w=w._phongFallbackMaterial)._deferredMaterialsInit||w.updateDeferredMaterials(),w=w._deferredMaterials[this.materialToUse])){var T=!this.isQAAutomationMode()&&t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.getFullMaterial(y),D=null;(w.overridable||w._forceAllowFullMaterialOverride)&&T&&(T.isMatApp?(D=T._getMaterialFromGLType(r.glType,r._geomType)||null)&&(w=D,s=D,f=T):(D=T,(d||E||A||w.deferrable)&&(r.glType===be.POINTS?"POINTS"===D.targetPrimitiveType:r.glType===be.LINES||r.glType===be.POINTS?"LINES"===D.targetPrimitiveType:"FACES"===D.targetPrimitiveType)&&(d||(!D._deferredMaterialsInit&&D.updateDeferredMaterials(),D=D._deferredMaterials[this.materialToUse]),w=D,s=D)));var I=!p&&t._isReceivingDecal(),R=!1;if((C||A)&&!t.castShadow){if(!I)return;R=!0}if(m&&(!t.enableNormalDepth||this._debugMaterialMode>0)){if(!I)return;R=!0}if(m||C||A){if(t._noZPriority||r._noZPriority>=0)return;if(r.glType<=be.LINE_STRIP)return}if(!M.deferrable||!M._transparencyOnGPU(t)){if(((this._forbidRenderableState&B.NO_TRANSPARENT)>0||C&&!M._forceOpaqueShadowMapPass())&&M)if(t.occurrenceRenderingOverride){var O=null;if((V=t.occurrenceRenderingOverride.materialOverride)&&(O=V.getOpacity()),null!==O){if(O<1){if(!I)return;R=!0}}else if(D){if(D.getOpacity()<1||D.transparent){if(!I)return;R=!0}}else if(M.getOpacity()<1||M.transparent){if(!I)return;R=!0}}else if(M.getOpacity()<1||M.transparent){if(!I)return;R=!0}if(A&&M){var L=M.transparent;if(t.occurrenceRenderingOverride){var V;O=null;(V=t.occurrenceRenderingOverride.materialOverride)&&(O=V.getOpacity()),null!==O?O<1&&(L=!0):D?(D.getOpacity()<1||D.transparent)&&(L=!0):M.getOpacity()<1&&(L=!0)}else M.getOpacity()<1&&(L=!0);if(!L||M._forceOpaqueShadowMapPass()){if(!I)return;R=!0}}}for(var F=o?o._hiddenEdges>0:this.renderHiddenEdges,N=w.polite||F&&r&&r._geomType&&(r._geomType===e.GeomTypeEnum.SHARP_EDGE||r._geomType===e.GeomTypeEnum.SMOOTH_EDGE||r._geomType===e.GeomTypeEnum.BOUNDARY_EDGE||r._geomType===e.GeomTypeEnum.EDGE)?2:1,G=0;G<N;G++){G&&(w.politeMaterial||(w.politeMaterial=w.clone(),P||(w.politeMaterial.transparent=!0,w.politeMaterial.opacity=.3,w.politeMaterial.depthTest=!1,w.politeMaterial.depthWrite=!1)),w=w.politeMaterial);var k=l(t,r,w,n,v);if(k){var U=t._gsso_cache[k.ssrId];if(t.isCurvedPipe){var H=e.InstancedCurvedPipeManager,j=H._initMatricesMap(),X=t.id+"_"+i.drawingGroups.indexOf(r),q=H._perRenderableData.get(X);if(!q)continue;for(var Z=H._instancingGroups,Y=q.length,Q=0;Q<Y;Q++){if(ne=Z[q[Q].bin]){var K=ne._initCurvesMaps(H),J=!ne.materials[a.id];J&&(ne.materials[a.id]=a.clone(),H.setPDSFXParamsOnMaterial(ne.materials[a.id]));w=ne.materials[a.id];if(J&&(w.updatePDSFXUniform("curvesMaps",ne._curvesMaps),w.updatePDSFXUniform("curvesMapsProperties",ne._curvesMapsProperties),w.updatePDSFXUniform("curvesMatrices",H._matricesMaps),w.updatePDSFXUniform("curvesMatricesProperties",H._curvesMatricesProperties)),K)for(var $ in ne.materials){(ae=ne.materials[$]).updatePDSFXUniform("curvesMaps",ne._curvesMaps),ae.updatePDSFXUniform("curvesMapsProperties",ne._curvesMapsProperties)}var ee=t.currentLOD;-1===ee&&(ee=ne._LODGeometries.length-1);var te=ne._LODGeometries[ee],ie=te.drawingGroups[0],re={dgIndex:X,index:Q};k.addDrawable({material:w,object:t,geometry:te,dg:ie,dgInterval:ie,renderMode:o,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:this.materialToUse,matApp:f,gasMaterial:g,cpInfos:re,qaAutomationMode:b}),U.push(new le({dlIndex:k.index,material:w,object:t,geometry:te,dg:ie,dgInterval:ie,renderMode:o&&o.clone(),renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:this.materialToUse,matApp:f,gasMaterial:g,cpInfos:re,renderLineMode:t.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame}))}}if(j)for(Q=0;Q<Z.length;Q++){var ne;if(ne=Z[Q])for(var $ in ne.materials){var ae;(ae=ne.materials[$]).updatePDSFXUniform("curvesMatrices",H._matricesMaps),ae.updatePDSFXUniform("curvesMatricesProperties",H._curvesMatricesProperties)}}return}if(M._isLineWithShapes&&M._isBidimLine)continue;if(k.hasDecal&&I){if(k.addDrawable({material:M._deferredMaterials[W.decalNormalStencilDepthMaterial],object:t,geometry:i,dg:r,dgInterval:n,renderMode:o,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:W.decalNormalStencilDepthMaterial,matApp:f,gasMaterial:g,qaAutomationMode:b}),U.push(new le({dlIndex:k.index,material:M._deferredMaterials[W.decalNormalStencilDepthMaterial],object:t,geometry:i,dg:r,dgInterval:n,renderMode:o&&o.clone(),renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:W.decalNormalStencilDepthMaterial,matApp:f,gasMaterial:g,renderLineMode:t.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame})),t._decalData.needDrawUvs&&(k.addDrawable({material:M._deferredMaterials[W.texCoordMaterial],object:t,geometry:i,dg:r,dgInterval:n,renderMode:o,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:W.texCoordMaterial,matApp:f,gasMaterial:g,qaAutomationMode:b}),U.push(new le({dlIndex:k.index,material:M._deferredMaterials[W.texCoordMaterial],object:t,geometry:i,dg:r,dgInterval:n,renderMode:o&&o.clone(),renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:W.texCoordMaterial,matApp:f,gasMaterial:g,renderLineMode:t.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame}))),e._mobileDevice&&(k.addDrawable({material:M._deferredMaterials[W.depthRGBAMaterial],object:t,geometry:i,dg:r,dgInterval:n,renderMode:o,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:W.depthRGBAMaterial,matApp:f,gasMaterial:g,qaAutomationMode:b}),U.push(new le({dlIndex:k.index,material:M._deferredMaterials[W.depthRGBAMaterial],object:t,geometry:i,dg:r,dgInterval:n,renderMode:o&&o.clone(),renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:W.depthRGBAMaterial,matApp:f,gasMaterial:g,renderLineMode:t.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame}))),!R){var se=t._gsso_cache[k._fatherDL.ssrId];k._fatherDL.addDrawable({material:w,object:t,geometry:i,dg:r,dgInterval:n,renderMode:o,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:this.materialToUse,matApp:f,gasMaterial:g,qaAutomationMode:b}),se.push(new le({dlIndex:k._fatherDL.index,material:w,object:t,geometry:i,dg:r,dgInterval:n,renderMode:o&&o.clone(),renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:this.materialToUse,matApp:f,gasMaterial:g,renderLineMode:t.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame}))}}else k.addDrawable({material:w,object:t,geometry:i,dg:r,dgInterval:n,renderMode:o,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:this.materialToUse,matApp:f,gasMaterial:g,qaAutomationMode:b}),U.push(new le({dlIndex:k.index,material:w,object:t,geometry:i,dg:r,dgInterval:n,renderMode:o&&o.clone(),renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:this.materialToUse,matApp:f,gasMaterial:g,renderLineMode:t.renderLineMode,resetFrameIndex:this.resetGSSOCacheFrame}))}}}}},this.resetGSSOCache=function(){this.resetGSSOCacheFrame++},this._setToneMapping=function(e){this.gammaInput=e>0,this.simpleGamma=e<2},this.increaseFrameCount=function(e){Y.resetCullingStatuses(this.currentFrameIndex),this.currentFrameIndex++,this._currentFrameType=e,this.info.render=this.info.renderMap.get(e),this.info.render||(this.info.render=new I.RenderInfo,this.info.renderMap.set(e,this.info.render)),xe=this.info.render,this.info.render.reset()};var Ii={};!function(){var t,i,r=["EDGE","WIRE_EDGE","BOUNDARY_EDGE","SHARP_EDGE","SMOOTH_EDGE","HIDDEN_SEAM_EDGE","BOUNDARY_POINT","SHARP_POINT","SMOOTH_POINT","HIDDEN_SEAM_POINT","SURFACIC_POINT","FREE_POINT","INFINITE_FACE","FACE","UNKNOWN","AXIS_SYSTEM","_OUTLINE"],n={EDGE:1,WIRE_EDGE:1,BOUNDARY_EDGE:1,SHARP_EDGE:1,SMOOTH_EDGE:1,HIDDEN_SEAM_EDGE:1,BOUNDARY_POINT:0,SHARP_POINT:0,SMOOTH_POINT:0,HIDDEN_SEAM_POINT:0,SURFACIC_POINT:0,FREE_POINT:0,INFINITE_FACE:2,FACE:2,UNKNOWN:2,AXIS_SYSTEM:2,_OUTLINE:1};for(t=0;t<r.length;t++)i=r[t],Ii[e.GeomTypeEnum[i]]=n[i]}(),this.getStateSortedObjects=function(t,r,n,a,l){s++;var h=this,c=r.getDisplayListByName("DEPTHVALUE"),u=r.getDisplayListByName("DEPTHVALUE2"),f=r.getDisplayListByName("EDGE"),g=r.getDisplayListByName("POINT"),m=r.getDisplayListByName("SOLID"),v=r.getDisplayListByName("SURFACE"),w=r.getDisplayListByName("SURFACE_CURVED_PIPE"),C=r.getDisplayListByName("SURFACE_CURVED_PIPE_TRANSPAR"),E=r.getDisplayListByName("BACK"),T=r.getDisplayListByName("NOZ"),D=r.getDisplayListByName("DECALS"),I=r.getDisplayListByName("TRANSPAR"),R=r.getDisplayListByName("TRANSPAR1D"),O=r.getDisplayListByName("NOZTRANSPAR"),L=r.getDisplayListByName("EDGEPRIMITIVESELECTION"),V=r.getDisplayListByName("EDGEADJACENCESELECTION"),F=r.getDisplayListByName("POINTPRIMITIVESELECTION"),N=this._defaultAppearanceType;(S||_)&&(N=z.BASIC);var G=N===e.DefaultAppearanceMode.__QA_AUTOMATION__,k=[g,f,v,v,T,m],U=[R,R,I,I,O,I],H=d&&!this._debugMaterialMode||A||b||y,j="true"===localStorage.getItem("__WEBVISU_NEWHL_POC__")&&!e.__unrolledHighlight()||G;const X={outlinesCreated:!1,objectWithTransientGSSO:new Set,sortCount:s,outlinesCameraDirection:null};this._inheritanceSolver.setGlobals(function(t,i,n,a,s){if(n._sceneGraphOrderMode)return 2==n._sceneGraphOrderMode?c:u;if(n.defines&&void 0!==n.defines.NB_OUTLINE_MAPS)return f;if(n.isBackMaterial)return E;var o;if(b&&r._pickingPriorityMapping&&t.pickingPriorityID){var g=t.pickingPriorityID.points;if(i.glType>=4?g=t.pickingPriorityID.faces:i.glType>=1&&(g=t.pickingPriorityID.edges),g&&(o=r._pickingPriorityMapping[g]),o)return o}var y=t._priorityMode,S=a&&a!==i?a.noZ:-1,_=S>=0?S:i&&i._noZPriority>=0?i._noZPriority:t&&t._noZPriority?4:-1;-1==_&&s&&s._type==e.GASTypeEnum.NOZ&&(_=s._priority);var x=null;if(_>=0&&!(i._geomType&e.NoNoZPriorityMask))switch(y){case e.PriorityMode.ClassicPriority2D:x=s&&s._type==e.GASTypeEnum.NOZ&&s._transparent?r.getDisplayListByPriority(_):r.getDisplayListByPriority(e.displayListPriorityEnum.priority[_]);break;case e.PriorityMode.ClassicPriority:x=r.getDisplayListByPriority(e.displayListPriorityEnum.priority[_]);break;case e.PriorityMode.Advanced:x=r.getDisplayListByPriority(e.displayListPriorityEnum.priorityP[_]);break;case e.PriorityMode.SceneGraphOrder:break;case e.PriorityMode.DepthPriority:x=s&&s._type==e.GASTypeEnum.NOZ&&s._transparent?r.getDisplayListByPriority(_):r.getDisplayListByPriority(e.displayListPriorityEnum.OTHER2D)}var M=null;if(P&&(l.highlightData._needsDepth||G))if((t._programID&e.ProgramIDs.PRIMITIVE_HIGHLIGHT)>0)j&&(0==i.glType&&(M=F),1!=i.glType||n.is2DLine||(M=L));else if((t._programID&e.ProgramIDs.ADJACENCE_HIGHLIGHT)>0&&!G){if(j){if(!(1==i.glType&&(i._geomType&e.BodyLinesMask)>0))return null;M=V}}else{if(0==i.glType&&(i._geomType&e.BodyPointsMask)>0&&!G)return null;if(1==i.glType&&(i._geomType&e.BodyLinesMask)>0&&!G)return null}if(x)return x;if(M)return M;var A,T=function(t,i,r){var n=2;return t?(t._getDimension||(t._getDimension=function(e,t){var i=2,r=this;if(r._geomType)i=e[r._geomType];else switch(r.glType){case 0:i=0;break;case 1:i=1;break;default:i=2}return 2===i&&(i=t&&t._bodyDim>0?3===t._bodyDim?5:2:r.gas&&0===r.gas.side?5:2),this._dimension=i,i}),n=-1,2===(n=d||-1===t._dimension?t._getDimension(Ii,i):t._dimension)&&r&&0===r.side&&(n=5),n):(i instanceof e.Line&&(n=1),n)}(i,t,s),R=n,O=n.overridable&&t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.materialOverride,B=null;!O||n.isPhysicalMaterial&&0!==n.transparency||O.internalMaterialOverride&&n===O.internalMaterialOverride.material||null!==(A=O.getOpacity())&&(B=A<1),h.useRenderPriorityOpacity&&h.computeRenderPriorityOpacity(1,O)<1&&(B=!0);return o=H&&(B||null===B&&!n.iterative&&R.getOpacity()<1||R.transparent)?U[T]:k[T],t.isCurvedPipe&&(o!==v&&o!==m||(o=w),o===I&&(o=C)),p||!t._isInDecalPass()||!n._deferredMaterials[W.decalNormalStencilDepthMaterial]||o!==I&&o!==v&&o!==m&&o!==w&&o!==C||(D._fatherDL=o,o=D),o},ci,a,N,n,r.id,S,M,P),this._inheritanceSolver.enableOutlineHanding(x,X);this.materialToUse;for(var q=this.resetGSSOCacheFrame,Z=(a&&a.isOrtho,0);Z<t.length;++Z){var Y=t[Z];if(Y){var Q=Y.object,K=Q._gsso_cache?Q._gsso_cache[r.id]:null;if(!Q.filtered){var J=K?K.length:0;if(d&&(Q._forceBackFacesOnSolid=!1),J>0&&K[0].resetFrameIndex>=q){Q.renderLineMode=K[0].renderLineMode;for(var $=0;$<K.length;$++)K[$].addDrawable(r._displayLists,G)}else!d&&Q instanceof e.Line||M&&!Q.noPickThrough||M&&Q.applyBackgroundViewMode&&!this._pickBackgroundNodes||(this._forbidRenderableState&B.NO_INVISIBLE_PLANE)>0&&Q.__invisiblePlane||this._inheritanceSolver.solve(Q)}}}for(X.outlinesCreated&&i.TexturesManager.finalize(),o=0;o<r._displayLists.length;o++)r._displayLists[o].finalize();X.objectWithTransientGSSO.forEach(e=>e._flagAsGSSOInvalidated()),this._inheritanceSolver.reset()},this.renderCuttingElements=function(t,i,r,n){function a(t){return!(!t||!(t instanceof e.MeshBasicMaterial||t instanceof e.MeshPhongMaterial||t instanceof e.MeshLambertMaterial||t instanceof e.PhysicalMaterial)||t.map)}if(this.cuttingScene){var s,o=Xe.getContext();o.stencilFunc(o.NOTEQUAL,100,255),o.colorMask(!0,!0,!0,!0),o.stencilMask(0),o.enable(o.CULL_FACE),this.setDepthWrite(!0);var l=this.disableBackFaceClipPlanes;this.disableBackFaceClipPlanes=0;var h=n&&n.clipPlanes,c=this.cuttingScene.getWebGLObjects("main",this.currentFrameIndex),d=n&&n.getClippingSettings();if(d&&0===d.frontOpacity&&o.cullFace(o.FRONT),h){var u,p=[];for(u=0;u<h.length;u++)(v=h[u].clippingContext&&h[u].clippingContext[this.id])&&v.clippingMeshIndex>0&&p.push(c[v.clippingMeshIndex-1]);c=p}var f,g,m=0,v=n&&n.clippingContext,y=this.materialToUse===W.depthRGBAMaterial||this.materialToUse===W.normalDepthIoRRoughnessMaterial||this.materialToUse===W.normalDepthMaterial||this.materialToUse===W.ZOnlyMaterial;for(m=c.length-1;m>=0;m-=1)if(null!==c[m]&&(!v||v._hasPlaneCapping(c[m].object.clippingPlane))){if(g=null,s=null,n&&n.sectionCappingMaterials){for(g=n.sectionCappingMaterials.defaultMaterial,f=0;f<n.sectionCappingMaterials.length;f++)if(n.sectionCappingMaterials[f].clippingPlane===c[m].object.clippingPlane){g=n.sectionCappingMaterials[f].material;break}g&&(g.clipPlaneIndex=m+1,c[m].object.geometry.normalsNeedUpdate=!0)}var S;if(Li(c[m].object,i),t&&t.enableReceiveShadowOnCapping&&(c[m].object.receiveShadow=!0),y||!g&&c[m].object.material.clipPlaneUseModelMaterial)y||a(t)?(g=t,s=n&&!y&&n.materialOverride):(this.backupCuttingMaterial||(this.backupCuttingMaterial=e.MaterialUtils.createShinyFaceMaterial({color:"black"})),g=this.backupCuttingMaterial),g.clipPlaneIndex=m+1;else if((g=g||c[m].object.material)&&(g.clipPlaneIndex=m+1),e.HatchingMeshMaterial&&g instanceof e.HatchingMeshMaterial)g.autoSpaceColor&&(a(t)?(S=n&&n.getOverrideColor(t),g.spaceColor=S||t.color):(S=n&&n.getOverrideColor(),g.spaceColor=S||new e.Color(16777215))),g.autoStripesColor&&(a(t)?g.stripesColor=S||t.color:g.stripesColor=S||new e.Color(0));this._clipPlanesState.update(n,null,!0,g,i,!0),Bi(c[m].object,g),g._renderedClipPlane=c[m].object.clippingPlane,this.setPolygonOffset(!0,1,1),this.renderObjects([c[m]],!1,"",i,r,!0,g,s),g._renderedClipPlane=null,(y||c[m].object.material.clipPlaneUseModelMaterial)&&(g.clipPlaneIndex=0)}return d&&0===d.frontOpacity&&o.cullFace(o.BACK),this.setDepthWrite(!1),o.disable(o.CULL_FACE),o.stencilFunc(o.ALWAYS,100,255),o.colorMask(!1,!1,!1,!1),o.stencilMask(255),this.clear(!1,!1,!0),this.disableBackFaceClipPlanes=l,this._clipPlanesState.update(null,null,!0,t,i),!0}return!1},this.renderAssets=function(){var e=!1,t=ve;null!==this.ambianceGenerators&&(e=e||this.ambianceGenerators.update(this.currentFrameIndex,this)),e&&this.setRenderTarget(t)};const Ri=e._VisuFilterType;this.updateCSSNodes=function(t,i){var r=t.getWebGLObjects("css2d",this.currentFrameIndex),n=t.getWebGLObjects("css3d",this.currentFrameIndex);if(i.matrixWorldInverse.getInverse(i.matrixWorld),n.length&&i._viewpoint){var a=i.isOrtho?i.projectionMatrix.elements[5]*c:.5/Math.tan(e.Math.degToRad(.5*i.fov))*l,s=i._viewpoint.divCameraCSSElement;if(i.isOrtho?(j.style.WebkitPerspective="",j.style.MozPerspective="",j.style.oPerspective="",j.style.perspective=""):(j.style.WebkitPerspective=a+"px",j.style.MozPerspective=a+"px",j.style.oPerspective=a+"px",j.style.perspective=a+"px"),i.isOrtho)w="scale("+a+")translate("+oi(-(i.right+i.left)/2)+"px,"+oi((i.top+i.bottom)/2)+"px)"+li(i.matrixWorldInverse)+"translate("+h+"px,"+c+"px)";else w="translate3d(0,0,"+a+"px)"+li(i.matrixWorldInverse)+" translate3d("+h+"px,"+c+"px, 0)";s.style.WebkitTransform=w,s.style.MozTransform=w,s.style.oTransform=w,s.style.transform=w}var o,d=null;for(o=0;o<r.length;o++){if(null!==(S=r[o]))if((!(x=(_=S.object)._getFilter(Ri._MATERIAL_TO_USE))||x.materialToUse===this.materialToUse)&&L(_.visible,_.visibilityFree,this.visibleSpace,void 0,_._occurrence)){if(this.renderIteration>0)continue;var u=new e.Vector3;u.copy(_.position);var p=!1;if(this.clipPlanesEnabled)for(var f=0;f<this.clipPlanes.length;f++){var g=this.clipPlanes[f];if(g.normal.x*_.position.x+g.normal.y*_.position.y+g.normal.z*_.position.z+g.constant<0){p=!0;break}}if((i.isOrtho||i.getLookAt().dot(i.position.clone().sub(u))<0)&&!p){(new e.Projector).projectVector(u,i),_.element.style.display="block";var m=e.getDevicePixelRatio()||1,v=_.offset.x/m,y=_.offset.y/m;_.element.style.left=v+.5*(u.x+1)*this.domElement.clientWidth+"px",_.element.style.top=y-.5*(u.y-1)*this.domElement.clientHeight+"px",d||(d=[]),d.push({domElement:_.element,z:u.z,alwaysOnTopIndex:_._occurrence?_._occurrence.node._alwaysOnTopIndex:null})}else _.element.style.display="none"}}for(o=0;o<n.length;o++){var S,_,x;if(null!==(S=n[o]))if((!(x=(_=S.object)._getFilter(Ri._MATERIAL_TO_USE))||x.materialToUse===this.materialToUse)&&L(_.visible,_.visibilityFree,this.visibleSpace,void 0,_._occurrence)){if(this.renderIteration>0)continue;if(i._viewpoint){var b=(new e.Matrix4).multiplyMatrices(_.matrixWorld,_.scaleCSS),w=hi(b),M=_.element;M.style.WebkitTransform=w,M.style.MozTransform=w,M.style.oTransform=w,M.style.transform=w,M.style.pointerEvents="auto",M.style.display="block",M.parentNode!==s&&s.appendChild(M)}}}if(d)for(d.sort(function(e,t){var i=null!==e.alwaysOnTopIndex,r=null!==t.alwaysOnTopIndex;if(i||r){if(!i)return-1;if(!r)return 1;if(e.alwaysOnTopIndex!==t.alwaysOnTopIndex)return e.alwaysOnTopIndex-t.alwaysOnTopIndex}return t.z-e.z}),o=0;o<d.length;o++)d[o].domElement.style.zIndex=20+o};var Oi=function(t,i){t._modelViewMatrix&&t._modelViewMatrix._multiplyMatricesMV(i.matrixWorldInverse,t.matrixWorld),t.isUniformlyScaled||(t._normalMatrix.getInverse((new e.Matrix4).multiplyMatrices(i.matrixWorldInverse,t.matrixWorld)),t._normalMatrix.transpose()),t.modelViewInvMatrix&&t.modelViewInvMatrix.multiplyMatricesAndInverse(i.matrixWorldInverse,t.matrixWorld),t.modelViewInvTranspMatrix&&t.modelViewInvTranspMatrix.multiplyMatricesAndInverse(i.matrixWorldInverse,t.matrixWorld).transpose()},Li=function(e,t){Oi(e,t),e._matrixWorldForDoubleGPU._fromMatrix4WithLowPartTranslation(e.matrixWorld)};function Vi(t,i,r,n){if(t.length)for(var a=0,s=t.length;a<s;a++)be._currentProgram=null,tt=null,be._oldBlending=-1,ut=-1,ft=-1,gt=-1,st=-1,ot=-1,Je=-1,$e=-1,et=-1,Ye=-1,Ke=-1,it=null,It=!0,t[a].render(i,r,e.glStates.currentWidth,e.glStates.currentHeight,n),be._currentProgram=null,tt=null,be._oldBlending=-1,ut=-1,ft=-1,gt=-1,st=-1,ot=-1,Je=-1,$e=-1,et=-1,Ye=-1,Ke=-1,it=null,It=!0}function Fi(e,t,i,r){Xe.initObject(e.object);var n=r(e,t,i);n&&Xe.__glResources__.geometry.push(n)}function Bi(t,i){var r,n,a,s=t.geometry;if(s)if(1===s._type);else if(2===s._type||s.length>=0);else if(t instanceof e.Mesh){for(var o=0,l=s.geometryGroupsList.length;o<l;o++)r=s.geometryGroupsList[o],a=i||xi(t,r),s.buffersNeedUpdate&&_i(r,t),n=a.attributes&&Ni(a),(s.verticesNeedUpdate||s.morphTargetsNeedUpdate||s.elementsNeedUpdate||s.uvsNeedUpdate||s.normalsNeedUpdate||s.colorsNeedUpdate||s.tangentsNeedUpdate||n)&&Pi(r,t,be.DYNAMIC_DRAW,!s.dynamic,a);s.verticesNeedUpdate=!1,s.morphTargetsNeedUpdate=!1,s.elementsNeedUpdate=!1,s.uvsNeedUpdate=!1,s.normalsNeedUpdate=!1,s.colorsNeedUpdate=!1,s.tangentsNeedUpdate=!1,s.buffersNeedUpdate=!1,a.attributes&&Gi(a)}else t instanceof e.Line?(n=(a=xi(t,s)).attributes&&Ni(a),(s.verticesNeedUpdate||s.colorsNeedUpdate||s.lineDistancesNeedUpdate||n)&&function(e,t){var i,r,n,a,s,o,l=e.vertices,h=e.colors,c=e.lineDistances,d=l.length,u=h.length,p=c.length,f=e.__vertexArray,g=e.__colorArray,m=e.__lineDistanceArray,v=e.verticesNeedUpdate,y=e.colorsNeedUpdate,S=e.lineDistancesNeedUpdate;if(e.__webglCustomAttributesList,v){for(i=0;i<d;i++)a=l[i],f[s=3*i]=a.x,f[s+1]=a.y,f[s+2]=a.z;be.bindBuffer(be.ARRAY_BUFFER,e.__webglVertexBuffer),be.bufferData(be.ARRAY_BUFFER,f,t)}if(y){for(r=0;r<u;r++)o=h[r],g[s=3*r]=o.r,g[s+1]=o.g,g[s+2]=o.b;be.bindBuffer(be.ARRAY_BUFFER,e.__webglColorBuffer),be.bufferData(be.ARRAY_BUFFER,g,t)}if(S){for(n=0;n<p;n++)m[n]=c[n];be.bindBuffer(be.ARRAY_BUFFER,e.__webglLineDistanceBuffer),be.bufferData(be.ARRAY_BUFFER,m,t)}}(s,be.DYNAMIC_DRAW),s.verticesNeedUpdate=!1,s.colorsNeedUpdate=!1,s.lineDistancesNeedUpdate=!1,a.attributes&&Gi(a)):t instanceof e.ParticleSystem&&(n=(a=xi(t,s)).attributes&&Ni(a),(s.verticesNeedUpdate||s.colorsNeedUpdate||t.sortParticles||n)&&Ci(s,be.DYNAMIC_DRAW,t),s.verticesNeedUpdate=!1,s.colorsNeedUpdate=!1,a.attributes&&Gi(a))}function Ni(e){for(var t in e.attributes)if(e.attributes[t].needsUpdate)return!0;return!1}function Gi(e){for(var t in e.attributes)e.attributes[t].needsUpdate=!1}function ki(t,i,r,n,a,s,o,l,h,c){rt=0;var d=be.contextId,p=Xe.id,f=Xe.currentRendererMode,g=r.programManager;if(f===g.currentRendererMode&&p===g.currentRendererId&&d===g.currentContextId||g.setActive(d,p,f),!r.needsUpdate){var m=r.program;r.program=g.getProgram(o,Xe.shaderVersions[Xe.currentRendererMode],yi),null===r.program&&Xe.initMaterial(r,i,n,s,o,l,c),m!==r.program&&r._notifyDLtoBeSortedNextFrame()}u&&r.lights&&r.program&&(r.program._lightsKey!==Rt||r.program._ambianceKey!==Ot)&&r.program._materialToUse===c&&(g.disposeCurrentProgram(yi,o),Xe.initMaterial(r,i,n,s,o,l,c)),r.needsUpdate&&(g.disposeAllPrograms(yi),Xe.initMaterial(r,i,n,s,o,l,c),r.needsUpdate=!1);var v=r._PDSFXData&&r._PDSFXData.PDSFX,y=!1,S=!1,_=r.program,x=_.uniformLocations,b=r.uniforms,w=_.program,M=a?a.id:-1;r.id===Ye&&M===Ke||(xe.swapMaterials++,Ye=r.id,Ke=M,y=!0),w!==be._currentProgram&&(xe.swapPrograms++,be.useProgram(w),be._currentProgram=w,$e=null,et=null,S=!0,y=!0),Qe===Lt&&t===tt||(xe.swapScenes++,S=!0),it=null;var C=_.objectUniformLocations;if(Xe[C.funcName](C,n,s,r,t,i,l),S&&(1===e.WebGLVersion&&(be.uniformMatrix4fv(x.projectionMatrix,!1,Xe.float32Matrix4x4Temp.setDoubles(t.projectionMatrix.elements)),x.viewMatrix&&be.uniformMatrix4fv(x.viewMatrix,!1,Xe.float32Matrix4x4Temp.setDoubles(t.matrixWorldInverse.elements)),x.cameraPosition&&(Dt.getPositionFromMatrix(t.matrixWorld),be.uniform3f(x.cameraPosition,Dt.x,Dt.y,Dt.z),be.uniform3f(x.lowPartCameraPosition,e.SplitFloat32(Dt.x).low,e.SplitFloat32(Dt.y).low,e.SplitFloat32(Dt.z).low))),v&&(x.projectionInvMatrix&&be.uniformMatrix4fv(x.projectionInvMatrix,!1,Xe.float32Matrix4x4Temp.setDoubles(t.projectionMatrixInverse.elements)),x.viewInvMatrix&&be.uniformMatrix4fv(x.viewInvMatrix,!1,Xe.float32Matrix4x4Temp.setDoubles(t.matrixWorld.elements)),x.viewInvTranspMatrix&&(be.uniformMatrix4fv(x.viewInvTranspMatrix,!1,Xe.float32Matrix4x4Temp.setDoubles(t.matrixWorld.transpose().elements)),t.matrixWorld.transpose()),x.nearFarLogFactor&&be.uniform3f(x.nearFarLogFactor,t.near,t.far,1/Math.log(t.far/t.near)),x.viewportSize&&be.uniform2f(x.viewportSize,wt,Mt)),t!==tt&&(tt=t),Qe=Lt),y){if(r.refreshUniforms(Xe,n,a),r.physical&&(b.renderIteration.value=Xe.renderIteration,Xe.refreshUniformsPhysicalDSRoughnessMaps(b,r,.2)),r.loadUniforms?r.loadUniforms(Xe,be,_.uniformLocations,a,h,l):Wi(x,r.uniformsList),v&&r._PDSFXData._pdsfxUniformsList&&(r._refreshPDSFXUniforms_private(Xe,n,a),Wi(x,r._PDSFXData._pdsfxUniformsList)),P&&r.deferrable){var E=r.uniforms;x.iHighlightColor?(be.uniform4f(x.iHighlightColor,E.iHighlightColor.value.x,E.iHighlightColor.value.y,E.iHighlightColor.value.z,1),be.uniform2f(x.iHighlightIntensity,E.iHighlightIntensity.value.x,E.iHighlightIntensity.value.y)):x.iHighlightLineicColor?(be.uniform4f(x.iHighlightLineicColor,E.iHighlightLineicColor.value.x,E.iHighlightLineicColor.value.y,E.iHighlightLineicColor.value.z,1),be.uniform2f(x.iHighlightIntensity,E.iHighlightIntensity.value.x,E.iHighlightIntensity.value.y)):be.uniform1f(x.highlightID,E.highlightID.value),x.rgbaDepth&&Xe.loadTexture(be,x.rgbaDepth,Xe.politeDepthBuffer)}if(S){if(x.viewInfo&&(be.uniform2f(x.viewInfo,t.near,t.far),Xe.loadTexture(be,x.currentNormalStencilDepth,ye.currentNormalStencilDepthBuffer),Xe.loadTexture(be,x.currentTexCoord,ye.currentTexCoordBuffer),x.currentRGBADepth&&Xe.loadTexture(be,x.currentRGBADepth,ye.currentRGBADepthBuffer)),x.cameraConstant&&be.uniform1f(x.cameraConstant,t.fixedSizeCameraConstant),x.billCameraPos||x.billCameraLookAt){be.uniform3f(x.billCameraPos,t.position.x,t.position.y,t.position.z);var A=t.getLookAt();be.uniform3f(x.billCameraLookAt,A.x,A.y,A.z),be.uniform3f(x.billCameraUp,t.up.x,t.up.y,t.up.z),be.uniformMatrix4fv(x.invViewMatrix,!1,Xe.float32Matrix4x4Temp.setDoubles(t.matrixWorld.elements)),be.uniformMatrix4fv(x.invProjectionMatrix,!1,Xe.float32Matrix4x4Temp.setDoubles(t.projectionMatrixInverse.elements))}r.lights&&u&&(It&&(!function(e,t){var i,r,n={ambient:{r:0,g:0,b:0},directional:{dirCount:0,dirLength:0,dirColors:Vt.directional.colors,dirColorsPhong:Vt.directional.colorsPhong,dirPositions:Vt.directional.positions,dirColorsNoIntensity:Vt.directional.colorsNoIntensity},directionalIBL:{dirIBLCount:0,dirIBLLength:0,dirIBLColors:Vt.directionalIBL.colors,dirIBLPositions:Vt.directionalIBL.positions},directionalPhong:{dirPhongCount:0,dirPhongLength:0,dirPhongColors:Vt.directionalPhong.colors,dirPhongPositions:Vt.directionalPhong.positions},point:{pointCount:0,pointLength:0,pointColors:Vt.point.colors,pointColorsPhong:Vt.point.colorsPhong,pointPositions:Vt.point.positions,pointPhysicalAttenuations:Vt.point.physicalAttenuations,pointDistances:Vt.point.distances,pointColorsNoIntensity:Vt.point.colorsNoIntensity},spot:{spotCount:0,spotLength:0,spotColors:Vt.spot.colors,spotColorsPhong:Vt.spot.colorsPhong,spotPositions:Vt.spot.positions,spotPhysicalAttenuations:Vt.spot.physicalAttenuations,spotDistances:Vt.spot.distances,spotDirections:Vt.spot.directions,spotAnglesCos:Vt.spot.anglesCos,spotInnerAnglesCos:Vt.spot.innerAnglesCos,spotColorsNoIntensity:Vt.spot.colorsNoIntensity},ies:{iesCount:0,iesLength:0,iesColors:Vt.ies.colors,iesPositions:Vt.ies.positions,iesDistances:Vt.ies.distances,iesLightTexture:Vt.ies.iesLightTexture,matrixWorldInv:Vt.ies.matrixWorldInv},area:{areaCount:0,areaLength:0,areaColors:Vt.area.colors,areaPositions:Vt.area.positions,areaNormals:Vt.area.normals,areaUps:Vt.area.ups,areaData:Vt.area.data},sphere:{sphereCount:0,sphereLength:0,sphereColors:Vt.sphere.colors,spherePositions:Vt.sphere.positions,sphereData:Vt.sphere.data},disk:{diskCount:0,diskLength:0,diskColors:Vt.disk.colors,diskNormals:Vt.disk.normals,diskUps:Vt.disk.ups,diskPositions:Vt.disk.positions,diskData:Vt.disk.data},tube:{tubeCount:0,tubeLength:0,tubeColors:Vt.tube.colors,tubeRights:Vt.tube.rights,tubePositions:Vt.tube.positions,tubeData:Vt.tube.data},camera:t};for(i=0,r=e.length;i<r;i++){var a=e[i];a.onlyShadow||a.setup(n,ji,Xi,Xe)}var s=function(e,t){for(i=3*n[e][t+"Length"],r=Math.max(n[e][t+"Colors"].length,3*n[e][t+"Count"]);i<r;i++)n[e][t+"Colors"][i]=0;Vt[e].length=n[e][t+"Length"]};s("directional","dir"),s("directionalIBL","dirIBL"),s("directionalPhong","dirPhong"),s("point","point"),s("spot","spot"),s("ies","ies"),s("area","area"),s("disk","disk"),s("sphere","sphere"),s("tube","tube"),Vt.ambient[0]=n.ambient.r,Vt.ambient[1]=n.ambient.g,Vt.ambient[2]=n.ambient.b}(i,t),It=!1),Xe.loadUniformsLights(be,_.uniformLocations,Vt,_,r._usePhongLighting)),n.receiveShadow&&Xe.loadUniformsShadow(be,_,i,Vt,r),Xe.loadUniformsPostProcess(be,_)}}return(S||_._clipPlanesVersion!==Xe._clipPlanesState.version)&&(r.enableClipPlanes&&Xe.loadClippingUniforms(be,_.uniformLocations),_._clipPlanesVersion=Xe._clipPlanesState.version),nt=o,_}function Ui(e,t,i,r,n){if(e.nbClipPlanes){e.nbClipPlanes.value=t.length,e.clipPlaneEquations.value=t.eqs,e.clipPlaneActive.value=t.states.slice(0);var a=r&&r.getClippingSettings();!a||n?(e.clipFrontOpacity.value=1,e.clipBackOpacity.value=0):(e.clipFrontOpacity.value=a.frontOpacity<.5?0:1,e.clipBackOpacity.value=a.backOpacity<.5?0:1),i&&(e.clipPlaneActive.value[i-1]=0)}}function zi(e,t,i,r,n){if(e.scissorPoints){t&&t.updateTexture(i,r),e.scissorPoints.value=t?t.texture:null;var a,s=t?t.getNbVertices():[];for(a=s.length;a<n;a++)s.push(0);e.scissorSize.value=s.length>0?s:[0]}}function Hi(){var e=rt;return e>=kt&&console.warn("WebGLRenderer: trying to use "+e+" texture units while this GPU supports only "+kt),rt+=1,e}function Wi(t,i){var r,n,a,s,o;i.forEach(function(i,l,h){var c=i,d=t[l];if(d){var u=c.type;i=c.value;switch(u){case"b":case"i":be.uniform1i(d,i);break;case"f":be.uniform1f(d,i);break;case"v2":be.uniform2f(d,i.x,i.y);break;case"v3":be.uniform3f(d,i.x,i.y,i.z);break;case"v4":be.uniform4f(d,i.x,i.y,i.z,i.w);break;case"c":be.uniform3f(d,i.r,i.g,i.b);break;case"iv1":i.length>0&&be.uniform1iv(d,i);break;case"iv":i.length>0&&be.uniform3iv(d,i);break;case"fv1":i.length>0&&be.uniform1fv(d,i);break;case"fv2":i.length>0&&be.uniform2fv(d,i);break;case"fv3":case"fv":i.length>0&&be.uniform3fv(d,i);break;case"fv4":i.length>0&&be.uniform4fv(d,i);break;case"v2v":for(void 0===c._array&&(c._array=new Float32Array(2*i.length)),s=0,o=i.length;s<o;s++)a=2*s,c._array[a]=i[s].x,c._array[a+1]=i[s].y;be.uniform2fv(d,c._array);break;case"v3v":for(void 0===c._array&&(c._array=new Float32Array(3*i.length)),s=0,o=i.length;s<o;s++)a=3*s,c._array[a]=i[s].x,c._array[a+1]=i[s].y,c._array[a+2]=i[s].z;be.uniform3fv(d,c._array);break;case"v4v":for(void 0===c._array&&(c._array=new Float32Array(4*i.length)),s=0,o=i.length;s<o;s++)a=4*s,c._array[a]=i[s].x,c._array[a+1]=i[s].y,c._array[a+2]=i[s].z,c._array[a+3]=i[s].w;be.uniform4fv(d,c._array);break;case"m3":i&&Xe.loadMatrix3(be,d,i);break;case"m4":i&&Xe.loadMatrix4(be,d,i);break;case"m4v":for(void 0===c._array&&(c._array=new Float32Array(16*i.length)),s=0,o=i.length;s<o;s++)i[s]&&i[s].flattenToArrayOffset(c._array,16*s);be.uniformMatrix4fv(d,!1,c._array);break;case"t":case"t2":case"tc":r=i,n=Hi(),be.uniform1i(d,n),r||(r=Xe._dummyTexture),r instanceof e.WebGLRenderTargetCube?Ji(r,n):Xe.setTexture(r,n);break;case"tv":case"t2v":case"tcv":for(void 0===c._array&&(c._array=[]),s=0,o=c.value.length;s<o;s++)c._array[s]=Hi();for(be.uniform1iv(d,c._array),s=0,o=c.value.length;s<o;s++)r=c.value[s],n=c._array[s],r||(r=Xe._dummyTexture),Xe.setTexture(r,n)}}})}function ji(e,t,i,r,n,a){var s=O.copyToLinear(i,n);e[t]=s.r*r,e[t+1]=s.g*r,e[t+2]=s.b*r,a&&(a[t]=s.r,a[t+1]=s.g,a[t+2]=s.b)}function Xi(e,t,i,r,n){e[t]=i.r*r,e[t+1]=i.g*r,e[t+2]=i.b*r,n&&(n[t]=i.r,n[t+1]=i.g,n[t+2]=i.b)}function qi(e){null!=e&&e!==_t&&(be.lineWidth(e),_t=e)}function Zi(e,t){var i="";if(t){i+="float getExposureFromIndexCube(int index) {\n",i+="\tfloat result;\n";for(r=0;r<e.maxShadowsCube;r++)i+="\tif(index == "+r+"){\n",i+="\t\tresult = getExposure(shadowPointPosition["+r+"],shadowMapCube["+r+"],shadowBiasCube["+r+"],shadowMapSizeCube["+r+"],shadowNearCube["+r+"],shadowFarCube["+r+"]);\n",i+="\t}\n";i+="\treturn result;\n",i+="}\n"}else{i+="float getExposureFromIndex(int index) {\n",i+="\tfloat result;\n";for(var r=0;r<e.maxShadows;r++)i+="\tif(index == "+r+"){\n",i+="\t\tresult = getExposure(vShadowCoord["+r+"],shadowMap["+r+"],shadowBias["+r+"],shadowMapSize["+r+"]);\n",i+="\t}\n";i+="\treturn result;\n",i+="}\n"}if(i+="#ifdef USE_TRANSPARENTSHADOWMAP \n",t){i+="vec4 getTransparentExposureFromIndexCube(int index) {\n",i+="\tvec4 result;\n";for(r=0;r<e.maxShadowsCube;r++)i+="\tif(index == "+r+"){\n",i+="\t\tvec4 lPosition =  vec4( shadowPointPosition["+r+"], 1.0 );\n",i+="\t\tvec3 pointVector = normalize(vWorldPosition.xyz-lPosition.xyz);\n",i+="\t\tresult = textureCube(transparentShadowMapCube["+r+"], pointVector);\n",i+="\t}\n";i+="\treturn result;\n",i+="}\n"}else{i+="vec4 getTransparentExposureFromIndex(int index) {\n",i+="\tvec4 result;\n";for(var r=0;r<e.maxShadows;r++)i+="\tif(index == "+r+"){\n",i+="\t\tvec3 shadowCoord = vShadowCoord["+r+"].xyz / vShadowCoord["+r+"].w;\n",i+="\t\tfloat isNotbehindFrustum = step(0.0,vShadowCoord["+r+"].w);\n",i+="\t\tresult = isNotbehindFrustum * texture2D(transparentShadowMap["+r+"], shadowCoord.xy) + (1.0-isNotbehindFrustum) * vec4(1.0);\n",i+="\t}\n";i+="\treturn result;\n",i+="}\n"}return i+="#endif \n"}function Yi(e){for(var t=e.split("\n"),i=0,r=t.length;i<r;i++)t[i]=i+1+": "+t[i];return t.join("\n")}function Qi(e){return 0==(e&e-1)}function Ki(t,i,r){r?(be.texParameteri(t,be.TEXTURE_WRAP_S,ir(i.wrapS)),be.texParameteri(t,be.TEXTURE_WRAP_T,ir(i.wrapT)),be.texParameteri(t,be.TEXTURE_MAG_FILTER,ir(i.magFilter)),be.texParameteri(t,be.TEXTURE_MIN_FILTER,ir(i.minFilter))):(i.wrapS===e.ClampToEdgeWrapping&&i.wrapT===e.ClampToEdgeWrapping||i.wrapS===e._ClampToBorderWrapping&&i.wrapT===e._ClampToBorderWrapping||console.warn("Non power of two textures must be clamp to edge, falling back on it"),be.texParameteri(t,be.TEXTURE_WRAP_S,be.CLAMP_TO_EDGE),be.texParameteri(t,be.TEXTURE_WRAP_T,be.CLAMP_TO_EDGE),be.texParameteri(t,be.TEXTURE_MAG_FILTER,tr(i.magFilter)),be.texParameteri(t,be.TEXTURE_MIN_FILTER,tr(i.minFilter))),Re&&i.type!==e.FloatType&&(i.anisotropy>1||i.__oldAnisotropy)&&(be.texParameterf(t,Re.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i.anisotropy,Wt)),i.__oldAnisotropy=i.anisotropy)}function Ji(e,t){e.onRequest&&e.onRequest(),be.activeTexture(be.TEXTURE0+t),be.bindTexture(be.TEXTURE_CUBE_MAP,e.__webglTexture)}function $i(e,t,i){be.bindFramebuffer(be.FRAMEBUFFER,e),t&&be.framebufferTexture2D(be.FRAMEBUFFER,be.COLOR_ATTACHMENT0,i,t.__webglTexture,0)}function er(e,t){be.bindRenderbuffer(be.RENDERBUFFER,e),t.depthBuffer&&!t.stencilBuffer?(be.renderbufferStorage(be.RENDERBUFFER,be.DEPTH_COMPONENT16,t.width,t.height),be.framebufferRenderbuffer(be.FRAMEBUFFER,be.DEPTH_ATTACHMENT,be.RENDERBUFFER,e)):t.depthBuffer&&t.stencilBuffer?(be.renderbufferStorage(be.RENDERBUFFER,be.DEPTH_STENCIL,t.width,t.height),be.framebufferRenderbuffer(be.FRAMEBUFFER,be.DEPTH_STENCIL_ATTACHMENT,be.RENDERBUFFER,e)):be.renderbufferStorage(be.RENDERBUFFER,be.RGBA4,t.width,t.height)}function tr(t){return t===e.NearestFilter||t===e.NearestMipMapNearestFilter||t===e.NearestMipMapLinearFilter?be.NEAREST:be.LINEAR}function ir(t){if(t===e.RepeatWrapping)return be.REPEAT;if(t===e.ClampToEdgeWrapping)return be.CLAMP_TO_EDGE;if(t===e._ClampToBorderWrapping)return be.CLAMP_TO_EDGE;if(t===e.MirroredRepeatWrapping)return be.MIRRORED_REPEAT;if(t===e.NearestFilter)return be.NEAREST;if(t===e.NearestMipMapNearestFilter)return be.NEAREST_MIPMAP_NEAREST;if(t===e.NearestMipMapLinearFilter)return be.NEAREST_MIPMAP_LINEAR;if(t===e.LinearFilter)return be.LINEAR;if(t===e.LinearMipMapNearestFilter)return be.LINEAR_MIPMAP_NEAREST;if(t===e.LinearMipMapLinearFilter)return be.LINEAR_MIPMAP_LINEAR;if(t===e.UnsignedByteType)return be.UNSIGNED_BYTE;if(t===e.UnsignedShort4444Type)return be.UNSIGNED_SHORT_4_4_4_4;if(t===e.UnsignedShort5551Type)return be.UNSIGNED_SHORT_5_5_5_1;if(t===e.UnsignedShort565Type)return be.UNSIGNED_SHORT_5_6_5;if(t===e.ByteType)return be.BYTE;if(t===e.ShortType)return be.SHORT;if(t===e.UnsignedShortType)return be.UNSIGNED_SHORT;if(t===e.IntType)return be.INT;if(t===e.UnsignedIntType)return be.UNSIGNED_INT;if(t===e.FloatType)return be.FLOAT;if(t===e.HalfFloatType){if(be.HALF_FLOAT)return be.HALF_FLOAT;if(Me)return Me.HALF_FLOAT_OES}if(t===e.AlphaFormat)return be.ALPHA;if(t===e.RGBFormat)return be.RGB;if(t===e.RGBAFormat)return be.RGBA;if(t===e.LuminanceFormat)return 2===e.WebGLVersion?be.RED:be.LUMINANCE;if(t===e.LuminanceAlphaFormat)return be.LUMINANCE_ALPHA;if(t===e.AddEquation)return be.FUNC_ADD;if(t===e.SubtractEquation)return be.FUNC_SUBTRACT;if(t===e.ReverseSubtractEquation)return be.FUNC_REVERSE_SUBTRACT;if(t===e.ZeroFactor)return be.ZERO;if(t===e.OneFactor)return be.ONE;if(t===e.SrcColorFactor)return be.SRC_COLOR;if(t===e.OneMinusSrcColorFactor)return be.ONE_MINUS_SRC_COLOR;if(t===e.SrcAlphaFactor)return be.SRC_ALPHA;if(t===e.OneMinusSrcAlphaFactor)return be.ONE_MINUS_SRC_ALPHA;if(t===e.DstAlphaFactor)return be.DST_ALPHA;if(t===e.OneMinusDstAlphaFactor)return be.ONE_MINUS_DST_ALPHA;if(t===e.DstColorFactor)return be.DST_COLOR;if(t===e.OneMinusDstColorFactor)return be.ONE_MINUS_DST_COLOR;if(t===e.SrcAlphaSaturateFactor)return be.SRC_ALPHA_SATURATE;if(Oe){if(t===e.RGB_S3TC_DXT1_Format)return Oe.COMPRESSED_RGB_S3TC_DXT1_EXT;if(t===e.RGBA_S3TC_DXT1_Format)return Oe.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(t===e.RGBA_S3TC_DXT3_Format)return Oe.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(t===e.RGBA_S3TC_DXT5_Format)return Oe.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(void 0!==Le){if(t===e.RED_RGTC1_Format)return Le.COMPRESSED_RED_RGTC1_EXT;if(t===e.RED_RGTC1_S_Format)return Le.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(t===e.REDGREEN_RGTC2_Format)return Le.COMPRESSED_RED_GREEN_RGTC2_EXT;if(t===e.REDGREEN_RGTC2_S_Format)return Le.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}if(void 0!==Ve){if(t===e.RGBA_BPTC_UNORM_Format)return Ve.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(t===e.SRGB_ALPHA_BPTC_UNORM_Format)return Ve.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;if(t===e.RGB_BPTC_SIGNED_FLOAT_Format)return Ve.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(t===e.RGB_BPTC_UNSIGNED_FLOAT_Format)return Ve.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(void 0!==Fe&&t===e.RGBA_ASTC_4x4_Format)return Fe.COMPRESSED_RGBA_ASTC_4x4_KHR;if(void 0!==Be&&t===e.RGB_ETC1_Format)return Be.COMPRESSED_RGB_ETC1_WEBGL;if(void 0!==Ne&&t===e.RGBA8_ETC2_EAC_Format)return Ne.COMPRESSED_RGBA8_ETC2_EAC;if(void 0!==Ge){if(t===e.RGB_PVRTC_2BPPV1_Format)return Ge.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(t===e.RGB_PVRTC_4BPPV1_Format)return Ge.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(t===e.RGBA_PVRTC_2BPPV1_Format)return Ge.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;if(t===e.RGBA_PVRTC_4BPPV1_Format)return Ge.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG}if(void 0!==je){if(t===e.MinEquation)return je.MIN_EXT;if(t===e.MaxEquation)return je.MAX_EXT}return 0}function rr(t,i,r){if(2===e.WebGLVersion){switch(t){case be.RGBA:switch(i){case be.UNSIGNED_BYTE:return be.RGBA8;case be.BYTE:return be.RGBA8_SNORM;case be.HALF_FLOAT:return be.RGBA16F;case be.FLOAT:return be.RGBA32F}break;case be.RGB:switch(i){case be.UNSIGNED_BYTE:return be.RGB8;case be.BYTE:return be.RGB8_SNORM;case be.HALF_FLOAT:return be.RGB16F;case be.FLOAT:return r?be.R11F_G11F_B10F:be.RGB32F}break;case be.RED:switch(i){case be.UNSIGNED_BYTE:return be.R8;case be.BYTE:return be.R8_SNORM;case be.HALF_FLOAT:return be.R16F;case be.FLOAT:return be.R32F}break;case be.RG:switch(i){case be.UNSIGNED_BYTE:return be.RG8;case be.BYTE:return be.RG8_SNORM;case be.HALF_FLOAT:return be.RG16F;case be.FLOAT:return be.RG32F}}return t}return t}function nr(t,i,r){try{if(t)be=t;else{if(r&&(be=D.getContext("webgl2",{alpha:he,premultipliedAlpha:ce,antialias:ue,stencil:pe,preserveDrawingBuffer:fe,powerPreference:e._webglPerformanceProfile()})),!be){var n={alpha:he,premultipliedAlpha:ce,antialias:ue,stencil:pe,preserveDrawingBuffer:fe,powerPreference:e._webglPerformanceProfile()};be=D.getContext("webgl",n)||D.getContext("experimental-webgl",n),e.WebGLVersion=1}if(!be)throw"Error creating WebGL context."}}catch(e){console.error(e)}!t&&i&&(be=WebGLDebugUtils.makeDebugContext(be,function(e,t,i){throw window.WebVisuTestsWebGLError=!0,"##WEBGLERROR## "+WebGLDebugUtils.glEnumToString(e)+" was caused by call to: "+t})),be._enabledAttributes||(be._enabledAttributes={}),be.hasOwnProperty("contextId")||(te++,be.contextId=te),be._currentProgram||(be._currentProgram=null),be._oldBlending||(be.oldBlending=-1),e.enableWebGLStats&&(e.webGLStats={reset:function(){this.useProgram_nb=0,this.bindBuffer_nb=0,this.drawElements_nb=0},dump:function(){console.log({useProgram_nb:this.useProgram_nb,bindBuffer_nb:this.bindBuffer_nb,drawElements_nb:this.drawElements_nb})},useProgram_nb:0,bindBuffer_nb:0,drawElements_nb:0},be.useProgram_save=be.useProgram,be.useProgram=function(){e.webGLStats.useProgram_nb++,be.useProgram_save.apply(be,arguments)},be.bindBuffer_save=be.bindBuffer,be.bindBuffer=function(){e.webGLStats.bindBuffer_nb++,be.bindBuffer_save.apply(be,arguments)},be.drawElements_save=be.drawElements,be.drawElements=function(){e.webGLStats.drawElements_nb++,be.drawElements_save.apply(be,arguments)});var a=be.getSupportedExtensions();function s(e){return a.indexOf(e)>=0?be.getExtension(e):null}Ce=s("WEBGL_color_buffer_float")||s("EXT_color_buffer_float"),Pe=s("EXT_color_buffer_half_float")||s("EXT_color_buffer_float"),Me=2===e.WebGLVersion||s("OES_texture_half_float"),we=2===e.WebGLVersion||s("OES_texture_float"),Ee=s("OES_texture_float_linear"),s("EXT_float_blend"),Ae=s("OES_texture_half_float_linear"),Te=s("OES_standard_derivatives"),Ie=De?De.COMPLETION_STATUS_KHR:be.LINK_STATUS;var o=s("WEBGL_debug_renderer_info");if(null!==o&&(Bt.gpu=be.getParameter(o.UNMASKED_RENDERER_WEBGL),Bt.vendor=be.getParameter(o.UNMASKED_VENDOR_WEBGL)),Re=s("EXT_texture_filter_anisotropic")||s("MOZ_EXT_texture_filter_anisotropic")||s("WEBKIT_EXT_texture_filter_anisotropic"),Oe=s("WEBGL_compressed_texture_s3tc")||s("MOZ_WEBGL_compressed_texture_s3tc")||s("WEBKIT_WEBGL_compressed_texture_s3tc"),Le=s("EXT_texture_compression_rgtc")||s("WEBGL_compressed_texture_rgtc")||s("WEBKIT_WEBGL_compressed_texture_rgtc")||s("MOZ_WEBGL_compressed_texture_rgtc"),Ve=s("EXT_texture_compression_bptc")||s("WEBGL_compressed_texture_bptc")||s("WEBKIT_WEBGL_compressed_texture_bptc")||s("MOZ_WEBGL_compressed_texture_bptc"),Fe=s("WEBGL_compressed_texture_astc"),Be=s("WEBGL_compressed_texture_etc1"),Ne=s("WEBGL_compressed_texture_etc"),Ge=s("WEBGL_compressed_texture_pvrtc")||s("WEBKIT_WEBGL_compressed_texture_pvrtc"),ze=s("ANGLE_instanced_arrays"),He=s("OES_element_index_uint"),We=s("EXT_frag_depth"),je=s("EXT_blend_minmax"),ke=!!Ce,we&&!ke){var l=2===e.WebGLVersion?be.RGBA32F:be.RGBA,h=be.createTexture(),c=be.createFramebuffer(),d=be.createRenderbuffer();be.bindTexture(be.TEXTURE_2D,h),be.texParameteri(be.TEXTURE_2D,be.TEXTURE_WRAP_S,be.CLAMP_TO_EDGE),be.texParameteri(be.TEXTURE_2D,be.TEXTURE_WRAP_T,be.CLAMP_TO_EDGE),be.texParameteri(be.TEXTURE_2D,be.TEXTURE_MAG_FILTER,be.LINEAR),be.texParameteri(be.TEXTURE_2D,be.TEXTURE_MIN_FILTER,be.LINEAR),be.texImage2D(be.TEXTURE_2D,0,l,100,100,0,be.RGBA,be.FLOAT,null),be.bindFramebuffer(be.FRAMEBUFFER,c),be.framebufferTexture2D(be.FRAMEBUFFER,be.COLOR_ATTACHMENT0,be.TEXTURE_2D,h,0),be.bindRenderbuffer(be.RENDERBUFFER,d),be.renderbufferStorage(be.RENDERBUFFER,be.DEPTH_COMPONENT16,100,100),be.framebufferRenderbuffer(be.FRAMEBUFFER,be.DEPTH_ATTACHMENT,be.RENDERBUFFER,d);var u=be.checkFramebufferStatus(be.FRAMEBUFFER);ke=!0,u!=be.FRAMEBUFFER_COMPLETE&&(ke=!1),be.bindFramebuffer(be.FRAMEBUFFER,null),be.bindTexture(be.TEXTURE_2D,null),be.bindRenderbuffer(be.RENDERBUFFER,null),be.deleteTexture(h),be.deleteFramebuffer(c),be.deleteRenderbuffer(d)}if(Ue=!!Pe,Me&&!Ue){l=2===e.WebGLVersion?be.RGBA16F:be.RGBA,h=be.createTexture(),c=be.createFramebuffer(),d=be.createRenderbuffer();be.bindTexture(be.TEXTURE_2D,h),be.texParameteri(be.TEXTURE_2D,be.TEXTURE_WRAP_S,be.CLAMP_TO_EDGE),be.texParameteri(be.TEXTURE_2D,be.TEXTURE_WRAP_T,be.CLAMP_TO_EDGE),be.texParameteri(be.TEXTURE_2D,be.TEXTURE_MAG_FILTER,be.LINEAR),be.texParameteri(be.TEXTURE_2D,be.TEXTURE_MIN_FILTER,be.LINEAR),be.texImage2D(be.TEXTURE_2D,0,l,100,100,0,be.RGBA,2===e.WebGLVersion?be.HALF_FLOAT:Me.HALF_FLOAT_OES,null),be.bindFramebuffer(be.FRAMEBUFFER,c),be.framebufferTexture2D(be.FRAMEBUFFER,be.COLOR_ATTACHMENT0,be.TEXTURE_2D,h,0),be.bindRenderbuffer(be.RENDERBUFFER,d),be.renderbufferStorage(be.RENDERBUFFER,be.DEPTH_COMPONENT16,100,100),be.framebufferRenderbuffer(be.FRAMEBUFFER,be.DEPTH_ATTACHMENT,be.RENDERBUFFER,d);u=be.checkFramebufferStatus(be.FRAMEBUFFER);Ue=!0,u!=be.FRAMEBUFFER_COMPLETE&&(Ue=!1),be.bindFramebuffer(be.FRAMEBUFFER,null),be.bindTexture(be.TEXTURE_2D,null),be.bindRenderbuffer(be.RENDERBUFFER,null),be.deleteTexture(h),be.deleteFramebuffer(c),be.deleteRenderbuffer(d)}e.supportedExtensions={colorBufferFloat:Ce,colorBufferHalfFloat:Pe,textureHalfFloat:Me,textureFloat:we,textureFloatLinear:Ee,textureHalfFloatLinear:Ae,standardDerivatives:Te,textureFilterAnisotropic:Re,compressedTexturesS3TC:Oe,compressedTexturesRGTC:Le,compressedTexturesBPTC:Ve,compressedTexturesASTC:Fe,compressedTexturesETC1:Be,compressedTexturesETC:Ne,compressedTexturesPVRTC:Ge,instancedArrays:ze,elementIndexUint:He||2===e.WebGLVersion,renderToFloatTexture:ke,renderToHalfFloatTexture:Ue,fragDepth:We,minMaxBlending:je,fragmentTextureUnits:be.getParameter(be.MAX_TEXTURE_IMAGE_UNITS),vertexTextureUnits:be.getParameter(be.MAX_VERTEX_TEXTURE_IMAGE_UNITS),depthBits:Math.pow(2,-be.getParameter(be.DEPTH_BITS))},we||e.VisualizationTraces.info("THREE.WebGLRenderer: Float textures not supported."),Me||e.VisualizationTraces.info("THREE.WebGLRenderer: Half Float textures not supported."),Te||2!==e.WebGLVersion&&e.VisualizationTraces.info("THREE.WebGLRenderer: Standard derivatives not supported."),Re||e.VisualizationTraces.info("THREE.WebGLRenderer: Anisotropic texture filtering not supported."),Oe||e.VisualizationTraces.info("THREE.WebGLRenderer: S3TC compressed textures not supported."),Le||e.VisualizationTraces.info("THREE.WebGLRenderer: RGTC compressed textures not supported."),Ve||e.VisualizationTraces.info("THREE.WebGLRenderer: BPTC compressed textures not supported."),Be||e.VisualizationTraces.info("THREE.WebGLRenderer: ETC1 compressed textures not supported."),Ne||e.VisualizationTraces.info("THREE.WebGLRenderer: ETC compressed textures not supported."),Fe||e.VisualizationTraces.info("THREE.WebGLRenderer: ASTC compressed textures not supported."),Ge||e.VisualizationTraces.info("THREE.WebGLRenderer: PVRTC compressed textures not supported."),ze?Nt={vertexAttribDivisor:function(e,t){ze.vertexAttribDivisorANGLE(e,t)},drawElementsInstanced:function(e,t,i,r,n){ze.drawElementsInstancedANGLE(e,t,i,r,n)},_setVertexAttribDivisors:function(e,t,i){for(var r in t)"id"!==r&&i[r]>=0&&t[r].array&&(t[r].isMat4?(ze.vertexAttribDivisorANGLE(i[r],e),ze.vertexAttribDivisorANGLE(i[r]+1,e),ze.vertexAttribDivisorANGLE(i[r]+2,e),ze.vertexAttribDivisorANGLE(i[r]+3,e)):ze.vertexAttribDivisorANGLE(i[r],e))}}:2===e.WebGLVersion?Nt={vertexAttribDivisor:function(e,t){be.vertexAttribDivisor(e,t)},drawElementsInstanced:function(e,t,i,r,n){be.drawElementsInstanced(e,t,i,r,n)},_setVertexAttribDivisors:function(e,t,i){for(var r in t)"id"!==r&&i[r]>=0&&t[r].array&&(t[r].isMat4?(be.vertexAttribDivisor(i[r],e),be.vertexAttribDivisor(i[r]+1,e),be.vertexAttribDivisor(i[r]+2,e),be.vertexAttribDivisor(i[r]+3,e)):be.vertexAttribDivisor(i[r],e))}}:e.VisualizationTraces.info("THREE.WebGLRenderer: angle instanced arrays not supported."),He||2!==e.WebGLVersion&&e.VisualizationTraces.info("THREE.WebGLRenderer: UInt Element Index not supported."),We||2!==e.WebGLVersion&&e.VisualizationTraces.info("THREE.WebGLRenderer: Fragment Depth Writing not supported."),je||e.VisualizationTraces.info("THREE.WebGLRenderer: min/max blending not supported."),void 0===be.getShaderPrecisionFormat&&(be.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}});const p={float16:2===e.WebGLVersion?be.HALF_FLOAT:void 0,float32:be.FLOAT,sint8:be.BYTE,sint16:be.SHORT,sint32:2===e.WebGLVersion?be.INT:void 0,uint8:be.UNSIGNED_BYTE,uint16:be.UNSIGNED_SHORT,uint32:2===e.WebGLVersion?be.UNSIGNED_INT:void 0};for(let e in w.VertexAttribute)w.VertexAttribute[e].native=p[w.VertexAttribute[e].base]}this.tokens=[],this.render=function(t,r,n,a,s,o,l,h){if(xe||(xe=new I.RenderInfo),d=this.materialToUse===W.originalMaterial,u=this.materialToUse===W.originalMaterial||this.materialToUse===W.oitAccumMaterial||this.materialToUse===W.oitRevealMaterial,f=this.materialToUse===W.depthMaterial,this.materialToUse===W.depthRGBAMaterial,g=this.materialToUse===W.normalDepthIoRRoughnessMaterial,m=g||this.materialToUse===W.normalDepthMaterial,v=this.materialToUse===W.normalMaterial,y=this.materialToUse===W.ZOnlyMaterial,C=this.materialToUse===W.shadowMapDepthMaterial,x=d||y,b=this.materialToUse===W.pickingMaterial||this.materialToUse===W.pickingMaterialInstancing,P=this.materialToUse===W.highlightMaterial,M=b||v||f,E=this.materialToUse===W.oitAccumMaterial||this.materialToUse===W.oitRevealMaterial,p=M||P,A=this.materialToUse===W.transparentShadowMaterial,S=!!this.currentPass&&("ZOnly"===this.currentPass.idString||"background"===this.currentPass.idString),_=!!this.currentPass&&"dialogPass"===this.currentPass.name,this._clipPlanesState.update(null,null,!0,null,r),ve=n,Je=null,r instanceof e.Camera!=!1){var c=t.__lights;c.sort(t._lightSort),Ye=-1,Ke=-1,it=null,It=!0;var w=t.computeLightsKey();Rt=w.key,Lt=t;var T=e._mobileDevice,D=e._mobileHighlight;this.autoUpdateScene&&t.updateMatrixWorld(),this.cuttingScene&&this.cuttingScene.updateMatrixWorld(),void 0===r.parent&&r.updateMatrixWorld(),r.matrixWorldInverse.getInverse(r.matrixWorld),r.orientation||(r.orientation=r.matrixWorld.determinant()>0?1:-1),At.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),Et.setFromMatrix(At);var R=r.getCameraConstant(this.devicePixelRatio,e.glStates.currentHeight);r.fullWidth?(R*=r.height/r.fullHeight,r.useRealSize?r.useRealSize&&r.visualizedHeight&&(r.fixedSizeCameraConstant=r.getCameraConstant(this.devicePixelRatio,r.fullHeight)):r.fixedSizeCameraConstant=R):r.fixedSizeCameraConstant=R,r.pixelCullingCst=r.pixelCulling*R,r._cstLOD=R,this.autoUpdateObjects&&this.initWebGLObjects(t),this.cuttingScene&&this.initWebGLObjects(this.cuttingScene),this.enableRenderPluginsPre&&Vi(this.renderPluginsPre,t,r),this.setRenderTarget(n),(this.autoClear||a)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),this.setStencilWrite(this.enableStencilWrite);var O=this.currentPass?this.currentPass.idString:null;"main"===t.defaultRenderList||"main"!==O&&O||(O=t.defaultRenderList);var L=this.resetGSSOCacheFrame>o._resetGSSOCacheIndex,F=this.currentPass.composer?this.currentPass.composer.composerContext:null,N=F?F.id:"mtU_"+this.materialToUse,k=r._renderingRole===e._CameraRoles.NONE?r.id+"id":r._renderingRole,U=this._currentFrameType+"_rr"+k;this.currentPass.hideSurfacesAndUnclipedMeshes&&(U+="_h");var z=Y.get(t,U);z.lastComposerContextsSeen.has(N)||(z.objectManagers[O]=null,L=!0),z.currComposerContextsSeen.add(N),z.isSet(O)||z.setFromIdString(O,this.currentFrameIndex);var H,j=(H=z.getWebGLObjects(O,this.currentFrameIndex)).length,X=this.currentFrameIndex;if(j>0&&l){o._resetGSSOCacheIndex=this.resetGSSOCacheFrame,window.webVisuPerfo.startPerfo("cull");var Q=z.objectManagers[O],K=X>Q.frame;Q.frame=X;for(var J=q._INVISIBLE,$=q._VISIBLE,ee=(q._FRESH,Z._GSSO),te=Z._REMOVE_AND_GSSO,ie=Z._REMOVE,re=Z._NOTHING,ne=Z._SKIP,oe=t.__webglObjectsToDraw,le=0,he=0,ce=null,de=!1,ue=this.visibleSpace,pe=0,fe=0;fe<j;fe++)if(null!==(ce=H[fe])){var ge,me=(ge=ce.webglObject).object;if(K){var _e=ce.previousCullingStatus;ce.action=re,V(me.visible,me.visibilityFree,ue,me.layer)&&(!ge.frustumCulled||++pe&&ge._performCulling(r,Et,me,ce))?(ce.previousCullingStatus=$,ce.invalidated||L?(ce.invalidated=!1,ce.action=te,me._gsso_cache=null):_e!==$&&(ce.action=ee)):(ce.previousCullingStatus=J,he++,ce.invalidated||L?(ce.invalidated=!1,ce.action=ie,me._gsso_cache=null):ce.action=_e!==J?ie:ne)}switch(me.renderPointsOnly=ce.currentRenderPointsOnly,ce.action){case re:break;case ne:continue;case ee:oe[le++]=ge;break;case te:de=!0,me._removeFromStateSortingResult(o.id),oe[le++]=ge;break;case ie:de=!0,me._removeFromStateSortingResult(o.id);continue}ce.previousCullingStatus===$&&(me.beforeRenderCB&&!M&&me.beforeRenderCB(me,{viewpoint:r._viewpoint,camera:r}),Oi(me,r))}xe.culledMeshes+=he,xe.cullingCalls+=pe,window.webVisuPerfo.endPerfo("cull"),window.webVisuPerfo.startPerfo("sort"),window.webVisuPerfo.endPerfo("sort");var we=!t.isBackground;if(window.webVisuPerfo.startPerfo("gsso"),le>0&&(oe.length=le,this.getStateSortedObjects(oe,o,h,r,t)),de)for(var Me=0;Me<o._displayLists.length;Me++)o._displayLists[Me].cleanMaterialListAndDRLs();if(we)for(Me=0;Me<o._displayLists.length;Me++){if(!(ze=o._displayLists[Me]).neverSort)if(ze.hasDecal)ze._materialList.sort(function(e,t){return e.decalSortID-t.decalSortID});else if(ze.sortByGLType)ze._materialList.sort(function(e,t){var i=e.glType;return t.glType-i});else if(!ze.mustZSort||this.currentPass.isOITPass&&ze.canOIT)ze._sortByProgramNextFrame&&(ze._sortByProgramNextFrame=!1,ze._materialList.sort(function(e,t){var i=e.material,r=t.material;return i.program&&r.program?r.program!==i.program?i.program.id-r.program.id:e.occurrenceRenderingOverrideId!==t.occurrenceRenderingOverrideId?e.occurrenceRenderingOverrideId-t.occurrenceRenderingOverrideId:i.id-r.id:r.id-i.id}));else{for(var Ce=0;Ce<ze._materialList.length;Ce++){var Pe=ze._materialList[Ce];(nt=ze._displayRangeLists.get(Pe.id)).sortDrawablesBackToFront(r)}ze._materialList.sort(function(e,t){var i=ze._displayRangeLists.get(e.id).getFirstDrawable(),r=ze._displayRangeLists.get(t.id).getFirstDrawable(),n=i?i.object.z:0,a=r?r.object.z:0;return a!==n?n-a:i&&r&&i.object.id!==r.object.id?i.object.id-r.object.id:t.material.id-e.material.id})}}else for(Me=0;Me<o._displayLists.length;Me++){(ze=o._displayLists[Me])._materialList.sort(function(e,t){var i=ze._displayRangeLists.get(e.id).getFirstDrawable(),r=ze._displayRangeLists.get(t.id).getFirstDrawable(),n=i?i.object.renderDepth:0,a=r?r.object.renderDepth:0;return a?n?a!==n?a-n:i.object.id!==r.object.id?r.object.id-i.object.id:e.material.id-t.material.id:1:-1})}window.webVisuPerfo.endPerfo("gsso")}$e=null,et=null,this.setBlending(e.NoBlending);var Ee=!1;o._displayLists[5].active=!s,window.webVisuPerfo.startPerfo("draw");var Ae=null,Te=this.materialToUse===W.oitAccumMaterial,De=this.materialToUse===W.oitRevealMaterial,Ie=u,Re=this.useOIT&&this.currentPass.isOITPass&&u,Oe=!u&&!x,Le=P&&t.highlightData,Ve=Le&&D,Fe=!1;if(!G&&E){var Be=0,Ne=o._displayLists.filter(function(e){return e.hasTranspar});for(Me=0;Me<Ne.length;Me++){Be+=Ne[Me]._materialList.length}Fe=0===Be}2===e.WebGLVersion&&this.updateFrameUBO(r);var Ge=this.forcePolygonOffset!==e.PolygonOffsetForceStatus.DEFAULT,ke=this.forcePolygonOffset===e.PolygonOffsetForceStatus.ENABLED;if(!Fe)for(var Ue=0;Ue<o._displayLists.length;Ue++){var ze,He=(ze=o._displayLists[Ue])._materialList;if(ze.active&&0!==He.length){if(!ze.canOIT&&E&&be.colorMask(!1,!1,!1,!1),ze.hasDecal){var We=this.getViewportSize();ye.currentNormalStencilDepthBuffer=this.renderTargetPool.buildRenderTarget(We.width,We.height,"decal",null,null,!1),this.clearTarget(ye.currentNormalStencilDepthBuffer,!0,!0,!0),T&&(ye.currentRGBADepthBuffer=this.renderTargetPool.buildRenderTarget(We.width,We.height,"uintNearest",null,null,!1),this.clearTarget(ye.currentRGBADepthBuffer,!0,!0,!0)),this.setRenderTarget(n)}var je=null;ze.depthFunc&&(je=pt,this.setDepthFunc(be[ze.depthFunc])),b&&(Ue>0&&(ze.pickingPriority||Ee)&&be.clear(be.DEPTH_BUFFER_BIT),Ee=!!ze.pickingPriority),ze.useStencil&&("NOZ"!==ze.name||"NOZ"===ze.name&&d)&&(be.enable(be.STENCIL_TEST),be.stencilFunc(be.ALWAYS,1,255),be.stencilOp(be.KEEP,be.KEEP,be.REPLACE),be.stencilMask(255));var qe=ze.depthWrite;ze.hasTranspar&&Re&&(qe=!0);var Ze=De&&ze.canOIT,Qe=Te&&ze.canOIT,tt=Re&&ze.canOIT,rt=-1;for(Ce=0;Ce<He.length;Ce++){Pe=He[Ce];var nt,at=(nt=ze._displayRangeLists.get(Pe.id))&&nt.getFirstDrawable();if(at){var st=!1,ot=!1,lt=!1,ht=Ze,ct=Qe,dt=tt,ut=this.materialToUse,ft=Oe;if(ze.hasDecal){var gt=!1;switch(Pe.materialToUse){case W.decalNormalStencilDepthMaterial:st=!0,gt=!0;break;case W.texCoordMaterial:ot=!0,gt=!0;break;case W.depthRGBAMaterial:lt=!0,gt=!0;break;default:u=Ie}gt&&(ut=Pe.materialToUse,u=!1,dt=!1,ht=!1,ct=!1,ft=!0)}Je=null;var mt=nt.materialOverride;if(this.clipPlanesEnabled||!this.cuttingScene||Pe.occurrenceRenderingOverride&&Pe.occurrenceRenderingOverride.clipPlanes){var vt=Pe.material,yt=!G&&rt!==Ce&&(ht||ct)&&(Pe._objectsTransparentOnGPU||vt._transparencyOnGPU(null));yt&&(be.colorMask(!1,!1,!1,!1),rt=Ce,ut=W.originalMaterial,ht=!1,ct=!1),dt!==vt.isOIT&&(dt?vt._programID|=e.ProgramIDs.OIT:vt._programID&=~e.ProgramIDs.OIT,vt.isOIT=dt),vt.deferrable&&(this._forbidRenderableState&B.NO_TRANSPARENT?vt._programID|=e.ProgramIDs.SKIP_TRANSPAR:vt._programID&=~e.ProgramIDs.SKIP_TRANSPAR);var St=vt;if(!vt.areTexturesLoaded()&&u){if(vt.transparent||vt.getOpacity()<1)continue;St=Ei}if(Ot=vt._computeAmbianceKeyAndProcessMaterial(u,t,this.ambianceGenerators,this.sssGenerator,w,this.id),vt.physical&&(t.envMipMap.length>0&&(vt.envMipMap=t.envMipMap,vt.envMap=t.envMipMap[0],vt.ambienceMatrix=t.ambienceMatrix),t.reflectionProbes.length&&(vt.envMap=t.reflectionProbes[0].map0,vt.reflectionProbes=t.reflectionProbes),t.useFiniteEnvMap&&(vt.useFiniteEnvMap=t.useFiniteEnvMap,vt.parallaxCorrectionParameters=t.parallaxCorrectionParameters)),ht)Xe.setBlending(e.OITRevealBlending,0,0,0);else if(ct)Xe.setBlending(e.OITAccumBlending,0,0,0);else if(A)Xe.setBlending(e.TransparentShadowBlending,0,0,0);else if(ft)Ve?Xe.setBlending(e.NormalBlending,e.AddEquation,e.SrcAlphaFactor,e.OneMinusSrcAlphaFactor):Xe.setBlending(e.NoBlending);else if(vt.useBlending||!vt.iterative&&(vt.transparent||vt.getOpacity()<1))Xe.setBlending(vt.blending,vt.blendEquation,vt.blendSrc,vt.blendDst);else{var _t=!1;if(mt&&mt.hasTransparency())_t=!0;else if(this.useRenderPriorityOpacity)this.computeRenderPriorityOpacity(1,mt)<1&&(_t=!0);_t?Xe.setBlending(e.NormalBlending,e.AddEquation,e.SrcAlphaFactor,e.OneMinusSrcAlphaFactor):Xe.setBlending(e.NoBlending)}Le?(Xe.setDepthTest(!Xe.disableDepthTest&&ze.depthTest),t.highlightData._updateMaterialUniforms(vt,this)):at.dg&&!at.dg.glType&&at.dg._geomType===e.GeomTypeEnum.SURFACIC_POINT&&ze.depthTest?Xe.setDepthTest(!0):ft?Xe.setDepthTest(!Xe.disableDepthTest&&ze.depthTest):Xe.setDepthTest(vt.depthTest&&!Xe.disableDepthTest&&ze.depthTest);var xt=qe;!qe&&this.currentPass&&(!this.currentPass.isRobotPass&&ze.hasTranspar&&(St.opacityMap||St.map||(1===St.getOpacity()||b)&&null===mt||mt&&(1===mt.getOpacity()||b))&&(qe=!0),this.currentPass.isRobotPass&&b&&(qe=!0)),ft?(Xe.setDepthWrite(qe&&!Xe.disableDepthWrite),Xe.setColorWrite(!Xe.disableColorWrite)):ct||ht?(Xe.setDepthWrite(!1),Xe.setColorWrite(vt.colorWrite&&!Xe.disableColorWrite)):(Xe.setDepthWrite(vt.depthWrite&&qe&&!Xe.disableDepthWrite),Xe.setColorWrite(vt.colorWrite&&!Xe.disableColorWrite)),qe=xt,vt.polygonOffset&&!Ge&&this.setPolygonOffset(vt.polygonOffset,vt.polygonOffsetFactor,vt.polygonOffsetUnits),Xe._clipPlanesState.update(Pe.occurrenceRenderingOverride,Ae,!1,St,r,!!Xe.cuttingScene),Ae=Pe.occurrenceRenderingOverride;var bt=!1,wt=null;if(this.useRenderPriorityOpacity)if(0===this.computeRenderPriorityOpacity(1,mt))continue;var Mt=!0,Ct=this.tokens,Pt=this._hasClippingWithoutCapping(),Tt=0;nt.tree.forEach(function(e,t){Ct[Tt++]=e.next});var Dt=null;vt.depthFunc&&(Dt=pt,this.setDepthFunc(be[vt.depthFunc]));for(var Vt=0;Vt<Tt;++Vt)for(wt=Ct[Vt];null!==wt;wt=wt.next){var Ft=wt.dg,Bt=wt.object,Nt=wt.geometry,Gt=wt.matApp,kt=wt.gas;if(Bt&&Bt.outlinesGeometry&&Ft._geomType===e.GeomTypeEnum._OUTLINE){let t=null;if(Se(r)){let i=new e.Vector4(0,0,1,0).applyMatrix4(r.matrixWorld);i.applyMatrix4((new e.Matrix4).getInverse(Bt.matrixWorld)),t=new e.Vector3(i.x,i.y,i.z).normalize()}i.refreshOutlines({object:Bt,viewDirection:t,width:this.getRenderMode(me)._outlineWidth,gl:be,visibleSpace:this.visibleSpace}),wt.start=Ft.start,wt.count=Ft.count}if(wt.updateLineInfos&&wt._updateWideLineAndPatternStuff(St,this,r,e),wt.doRenderLineModePolygonOffset.doIt&&this.setPolygonOffset(Ge?ke:wt.doRenderLineModePolygonOffset.enable,wt.doRenderLineModePolygonOffset.factor,wt.doRenderLineModePolygonOffset.unit),ze.hasDecal&&ae(Xe,ye,st,ot,lt),this.setMaterialFacesSimple(wt,St,r,Pt),2===Nt._type){if(mt&&mt.colorOverride){var Ut=!1;if((mt.colorOverride.hasASMInherit()||Bt._occurrence.gas&&Bt._occurrence.gas.hasASMInherit())&&(Ut=!0),Ut&&(mt.disableColorOverride=!1,Ft&&(Ft._geomType===e.GeomTypeEnum.BOUNDARY_EDGE||Ft._geomType===e.GeomTypeEnum.SMOOTH_EDGE||Ft._geomType===e.GeomTypeEnum.SHARP_EDGE||Ft._geomType===e.GeomTypeEnum._OUTLINE))){var zt=this.getRenderMode(Bt);this.overrideWireframeFix&&zt&&!zt.areFacesVisible()||(mt.disableColorOverride=!0)}}Bt&&null!==Bt.sectionLinesBuilder&&Bt.sectionLinesBuilder.sectionLineGeometry&&Nt===Bt.sectionLinesBuilder.sectionLineGeometry?this.renderSectionLines(r,c,Bt,St,null,Nt,Ft,wt.start,wt.count,Pe.occurrenceRenderingOverride,mt,Mt,0,wt,Gt,kt,ut):bt=this.renderInterval(r,c,Bt,St,null,Nt,Ft,wt.start,wt.count,Pe.occurrenceRenderingOverride,mt,Mt,R,wt,Gt,kt,ut),mt&&(mt.disableColorOverride=!1),bt&&(Mt=!1)}else bt=1===Nt._type?this.renderBufferDirect(r,c,vt,Nt,Bt):this.renderBuffer(r,c,vt,Nt,Bt);ze.hasDecal&&se(Xe,n,st||ot||lt)}bt&&this.renderCuttingElements(vt,r,c,Pe.occurrenceRenderingOverride)&&(Ae=null),yt&&(be.colorMask(!0,!0,!0,!0),Ce--),Dt&&this.setDepthFunc(oldDepthFunc)}}}!ze.canOIT&&E&&be.colorMask(!0,!0,!0,!0),je&&this.setDepthFunc(je),ze.useStencil&&("NOZ"!==ze.name||"NOZ"===ze.name&&d)&&be.disable(be.STENCIL_TEST),ze.hasDecal&&(this.renderTargetPool.pushRenderTarget(ye.currentNormalStencilDepthBuffer,null),ye.currentNormalStencilDepthBuffer=null,this.renderTargetPool.pushRenderTarget(ye.currentTexCoordBuffer,null),ye.currentTexCoordBuffer=null,T&&(this.renderTargetPool.pushRenderTarget(ye.currentRGBADepthBuffer,null),ye.currentRGBADepthBuffer=null))}}window.webVisuPerfo.endPerfo("draw"),this.enableRenderPluginsPost&&Vi(this.renderPluginsPost,t,r),n&&n.generateMipmaps&&n.minFilter!==e.NearestFilter&&n.minFilter!==e.LinearFilter&&function(t){t instanceof e.WebGLRenderTargetCube?(be.bindTexture(be.TEXTURE_CUBE_MAP,t.__webglTexture),be.generateMipmap(be.TEXTURE_CUBE_MAP),be.bindTexture(be.TEXTURE_CUBE_MAP,null)):(be.bindTexture(be.TEXTURE_2D,t.__webglTexture),be.generateMipmap(be.TEXTURE_2D),be.bindTexture(be.TEXTURE_2D,null))}(n),this.setColorWrite(!0),this.setDepthTest(!0),this.setDepthWrite(!0)}else console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.")},this.doRenderPlugins=function(e,t,i,r,n){this.initWebGLObjects(t);var a=0;for(a=0;a<e.length;a++)e[a].noRenderTarget||this.setRenderTarget(r);Vi(e,t,i,n)},this.renderObjects=function(t,i,r,n,a,s,o,l){var h,c,d,u,p,f,g;i?(p=t.length-1,f=-1,g=-1):(p=0,f=t.length,g=1),2===e.WebGLVersion&&this.updateFrameUBO(n),$e=null,et=null;for(var m=p;m!==f;m+=g)if(null!==(h=t[m])){if(d=(c=h.object).geometry.geometryGroupsList[0],o)u=o;else{if(void 0===(u=h.object.material[this.materialToUse])&&(u=h.object.material),!u)continue;s||u.useBlending?Xe.setBlending(u.blending,u.blendEquation,u.blendSrc,u.blendDst):Xe.setBlending(e.NoBlending),Xe.setDepthTest(u.depthTest&&!Xe.disableDepthTest),Xe.setDepthWrite(u.depthWrite&&!Xe.disableDepthWrite),Xe.forcePolygonOffset===e.PolygonOffsetForceStatus.DEFAULT&&setPolygonOffset(u.polygonOffset,u.polygonOffsetFactor,u.polygonOffsetUnits)}if(Xe.setMaterialFaces(u),1===d._type)Xe.renderBufferDirect(n,a,u,d,c);else if(2===d._type||d.length>=0){var v=c.geometry.length||1,y=c.geometry.length?c.geometry[0]:c.geometry;for(m=0;m<v;m++){for(var S=y.drawingGroups,_=0;_<S.length;_++)Xe.renderInterval(n,a,c,u,null,y,S[_],S[_].start,S[_].count,null,l,!0,0,token,null);if(1===v)break;y=c.geometry[m+1]}}else Xe.renderBuffer(n,a,u,d,c,l)}},this.initWebGLObjects=function(t){t.initWebGLObjectFrameIndex!==this.currentFrameIndex&&(t.initWebGLObjectFrameIndex=this.currentFrameIndex,t.__webglObjects||(t.__webglObjects={main:new e.WebGLObjectManager},t.__webglObjectsAll=new e.WebGLObjectManager,t.__webglObjectsToDraw=[],t.__webglSprites=[],t.__webglFlares||(t.__webglFlares=[])),t.__objectsAdded.size&&t.__processAddedObjects(Fi),t.__objectsUpdated.size&&t.__processUpdatedObjects(Fi),t.__objectsRemoved.size&&t.__processRemovedObjects(Xe.__glResources__),n.allocateShared(0==e.loadingModels),n.intermediaryArray=null,t.traverseObject3DWithCondition(function(e){return!e.isRoot3ds&&(Bi(e),!0)}))},this.initObject=function(t){var i;if(t.geometry&&(2===t.geometry._type||t.geometry.length>=0)){if(t._normalMatrix=new e.Matrix3,2===(n=t.geometry)._type)n.addEventListener("dispose",di);else if(n.length)for(var r=0;r<n.length;r++)n[r].addEventListener("dispose",di)}else if(!t.__webglInit){t.__webglInit=!0,t._normalMatrix=new e.Matrix3,void 0!==t.geometry&&void 0===t.geometry.__webglInit&&(t.geometry.__webglInit=!0,t.geometry.addEventListener("dispose",ci));var n=t.geometry;if(void 0===n);else if(1===n._type)!function(e){var t,i,r;for(t in e.attributes)r="index"===t?be.ELEMENT_ARRAY_BUFFER:be.ARRAY_BUFFER,(i=e.attributes[t]).buffer=be.createBuffer(),be.bindBuffer(r,i.buffer),be.bufferData(r,i.array,be.STATIC_DRAW)}(n);else if(t instanceof e.Mesh)for(i in s=t.material,void 0===n.geometryGroups&&function(t,i){var r,n,a,s,o,l,h={},c=t.morphTargets.length,d=t.morphNormals.length,u=i instanceof e.MeshFaceMaterial;for(t.geometryGroups={},r=0,n=t.faces.length;r<n;r++)a=t.faces[r],void 0===h[s=u?a.materialIndex:0]&&(h[s]={hash:s,counter:0}),l=h[s].hash+"_"+h[s].counter,void 0===t.geometryGroups[l]&&(t.geometryGroups[l]={faces3:[],faces4:[],materialIndex:s,vertices:0,numMorphTargets:c,numMorphNormals:d}),o=a instanceof e.Face3?3:4,t.geometryGroups[l].vertices+o>65535&&(h[s].counter+=1,l=h[s].hash+"_"+h[s].counter,void 0===t.geometryGroups[l]&&(t.geometryGroups[l]={faces3:[],faces4:[],materialIndex:s,vertices:0,numMorphTargets:c,numMorphNormals:d})),a instanceof e.Face3?t.geometryGroups[l].faces3.push(r):t.geometryGroups[l].faces4.push(r),t.geometryGroups[l].vertices+=o;for(var p in t.geometryGroupsList=[],t.geometryGroups)t.geometryGroups[p].id=e.GeometryIdCount++,t.geometryGroupsList.push(t.geometryGroups[p])}(n,s),n.geometryGroups){var a=n.geometryGroups[i];a.__webglVertexBuffer||(ni(a),_i(a,t),n.verticesNeedUpdate=!0,n.morphTargetsNeedUpdate=!0,n.elementsNeedUpdate=!0,n.uvsNeedUpdate=!0,n.normalsNeedUpdate=!0,n.tangentsNeedUpdate=!0,n.colorsNeedUpdate=!0)}else if(t instanceof e.Line)n.__webglVertexBuffer||(!function(e){e.__webglVertexBuffer=be.createBuffer(),e.__webglColorBuffer=be.createBuffer(),e.__webglLineDistanceBuffer=be.createBuffer(),_e.geometries++}(n),function(e,t){var i=e.vertices.length;e.__vertexArray=new Float32Array(3*i),e.__colorArray=new Float32Array(3*i),e.__lineDistanceArray=new Float32Array(1*i),e.__webglLineCount=i}(n),n.verticesNeedUpdate=!0,n.colorsNeedUpdate=!0,n.lineDistancesNeedUpdate=!0);else if(t instanceof e.ParticleSystem){n.__webglVertexBuffer||(!function(e){e.__webglVertexBuffer=be.createBuffer(),e.__webglColorBuffer=be.createBuffer(),_e.geometries++}(n),function(e,t){var i=e.vertices.length;e.__vertexArray=new Float32Array(3*i),e.__colorArray=new Float32Array(3*i),e.__sortArray=[],e.__webglParticleCount=i}(n),n.verticesNeedUpdate=!0,n.colorsNeedUpdate=!0);var s=xi(t,n),o=s.attributes&&Ni(s);(n.verticesNeedUpdate||n.colorsNeedUpdate||t.sortParticles||o)&&Ci(n,be.DYNAMIC_DRAW,t),n.verticesNeedUpdate=!1,n.colorsNeedUpdate=!1,s.attributes&&Gi(s)}}t._updateWorldCenterAndRadius()},this._commonShaderOptionsBuilder=function(t,i,r,n,a,s,o,l){var h={materialToUse:o,mobile:e.mobileVersion,mobileDevice:e._mobileDevice,noCompositing:!G,mobileHL:e._mobileHighlight,deferrable:t.deferrable,depthDebugMaterial:l&&this._debugMaterialMode===H.DEPTH,normalDebugMaterial:l&&this._debugMaterialMode===H.NORMAL,shadowMapDebugMaterial:l&&this._debugMaterialMode===H.SHADOW,geomUVDebug:l&&this._debugMaterialMode===H.GEOM_UV,mappingUVDebug:l&&this._debugMaterialMode===H.MAPPING_UV,geomUV2Debug:l&&this._debugMaterialMode===H.GEOM_UV2,mappingUV2Debug:l&&this._debugMaterialMode===H.MAPPING_UV2,useOIT:t.isOIT,maxDirLights:0,maxDirIBLLights:0,maxDirPhongLights:0,maxPointLights:0,maxSpotLights:0,maxSphereLights:0,maxTubeLights:0,maxDiskLights:0,maxAreaLights:0,maxIESLights:0,lightMapMode:0,useLighting:!1,maxDirShadows:0,maxDirIBLShadows:0,maxSpotShadows:0,maxShadows:0,maxShadowsCube:0,uintESM:this.packESM,shadowMapType:this.shadowMapType,morphTargets:t.morphTargets,morphNormals:t.morphNormals,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,fixedSize:r&&r._ratioData&&r._ratioData.ratio>0,fixedSizeCenter:r&&r._ratioData&&r._ratioData.ratio>0&&r._ratioData.center,alphaTest:t.alphaTest,discardOrOpaque:t.alphaTest&&t.alphaTestMode===e.AlphaTestMode.DISCARD_OR_OPAQUE,doubleSided:t.side===R.DoubleSide,flipSided:t.side===R.BackSide,vertexColors:t.vertexColors>0,objectVertexColors:r._vertexColors>0,allowObjectVertexColors:t._allowObjectColor,sizeAttenuation:t.sizeAttenuation,largeScale:(a&e.ProgramIDs.LARGE_SCALE)>0,useNormalMatrix:(a&e.ProgramIDs.NON_UNIFORM_SCALE)>0,noZObject:(a&e.ProgramIDs.NOZ_OBJECT)>0,politeHighlight:(a&e.ProgramIDs.POLITE_HIGHLIGHT)>0,primitiveHighlight:(a&e.ProgramIDs.PRIMITIVE_HIGHLIGHT)>0,adjacenceHighlight:(a&e.ProgramIDs.ADJACENCE_HIGHLIGHT)>0,clipPlanesEnabled:this.clipPlanes.length>0&&t.enableClipPlanes,billboard:r&&r._billboardData&&r._billboardData.type>=1,isMultiInstanced:r&&r._instancingInfos&&r._instancingInfos.isInstanceNode3D||t.isInstancingMaterial,instancingMeshSelectionMode:r&&r._instancingInfos&&"mesh"===r._instancingInfos.instancingSelectionMode,compressedVertices:n&&n.compressedVertices,compressedNormals:n&&n.compressedNormals,compressedUVs:n&&n.compressedUVs,compressedColors:n&&n.compressedColors,gpuTangentBinormal:n&&!n.hasTangentBinormal(),map:t._isTextureAvailable("map"),mapHDR:!!t.map&&t.map.hdr,newSslr:this.useSSLR||this.useSSLRefraction,sslrefractionEnabled:this.useSSLRefraction,sslreflectionEnabled:this.useSSLR,shadowPass:C||A,skipTranspar:(a&e.ProgramIDs.SKIP_TRANSPAR)>0,inlinedPostProActivated:this.inlinedPostProcess.activated,inlinedPostProTonemapping:this.inlinedPostProcess.tonemapping,fogViewMode:this._backgroundViewMode===e.BackgroundViewMode.FOG||this._backgroundViewMode===e.BackgroundViewMode.LOWLIGHT,lowlightViewMode:this._backgroundViewMode===e.BackgroundViewMode.LOWLIGHT};return r._skinning?Object.assign(h,{skinning:!0,useEulerAngles:r._skinning.useEulerAngles,skinningMapWidth:r._skinning.skinningMapWidth,skinningMapHeight:r._skinning.skinningMapHeight}):r._skinningInstancing&&Object.assign(h,{skinning:!0,useEulerAngles:r._skinningInstancing.useEulerAngles,skinningInstancingMapsInfo:r._skinningInstancing.skinningInstancingMapsInfo}),h},this._lightedShaderOptionsBuilder=function(t,i,r,n,a,s,o){var l=function(e){var t,i,r,n={dirLights:0,dirIBLLights:0,dirPhongLights:0,pointLights:0,spotLights:0,sphereLights:0,areaLights:0,iesLights:0,tubeLights:0,diskLights:0};for(t=0,i=e.length;t<i;t++)(r=e[t]).onlyShadow||r.allocate(n);return{directional:n.dirLights,directionalIBL:n.dirIBLLights,directionalPhong:n.dirPhongLights,point:n.pointLights,spot:n.spotLights,sphere:n.sphereLights,area:n.areaLights,ies:n.iesLights,tube:n.tubeLights,disk:n.diskLights}}(i),h=function(e){var t,i,r,n={dirLight:0,dirIBLLight:0,spotLight:0,tex2d:0,texCube:0};for(t=0,i=e.length;t<i;t++)(r=e[t]).castShadow&&r.allocateShadows(Xe,n);return n}(i),c=h.dirLight,d=h.dirIBLLight,u=h.spotLight,p=h.tex2d,f=h.texCube,g=0;if(t.envMap){var m=t.envMap.mapping;m instanceof e.SphericalReflectionMapping?g=1:m instanceof e.LatLongReflectionMapping&&(g=2)}var v=!1,y=0,S=!1;return s&&s._lightMap&&s._lightMap.texture?(v=!0,y=s._lightMap.mode,S=s._lightMap.linear):(v=r&&!!r.lightMapData,y=r&&!!r.lightMapData&&r.lightMapData.lightMapMode,S=!0),{maxDirLights:l.directional,maxDirIBLLights:l.directionalIBL,maxDirPhongLights:l.directionalPhong,maxPointLights:l.point,maxSpotLights:l.spot,maxSphereLights:l.sphere,maxTubeLights:l.tube,maxDiskLights:l.disk,maxAreaLights:l.area,maxIESLights:l.ies,lightMap:v,lightMapMode:y,lightMapLinear:S,useLighting:!0,reflectivityEnvMap:t._isTextureAvailable("reflectivityEnvMap"),maxDirShadows:c,_maxDirIBLShadows:d,maxDirIBLShadows:0,maxSpotShadows:u,maxShadows:p,maxShadowsCube:f,_shadowMapEnabled:this.shadowMapEnabled&&r.receiveShadow,shadowMapEnabled:this.shadowMapEnabled&&p>0&&r.receiveShadow,shadowMapCubeEnabled:this.shadowMapEnabled&&f>0&&r.receiveShadow,transparentShadowEnabled:this.shadowMapEnabled&&this.transparentShadowEnabled&&!(t.transparent||t.getOpacity()<1),metal:t.metal,perPixel:t.perPixel,wrapAround:t.wrapAround,reflectionProbes:t.reflectionProbes,useFiniteEnvMap:t.useFiniteEnvMap,envMap:!!t.envMap,envMapSheen:!!t.envMap&&t._sheenData&&null!==t._sheenData.envMipMap,envMapDiffuse:t.envMipMap&&t.envMipMap[1]&&t.envMipMap[1].hasDiffuse,envMapHDR:t.envMap&&t.envMap.hdr,envMapRGBHDR:t.envMap&&t.envMap.rgbHdr,envMapRGBsRGB:t.envMap&&t.envMap.sRGB,envMapping:g,flakesMode:this.flakesMode,specularMap:t._isTextureAvailable("specularMap"),specularMapLinear:!!t.specularMap&&t.specularMap.hdr}},this._textureShaderOptionsBuilder=function(e,t,i,r,n,a,s){var o=e._getTextures(!0).filter(function(e){return!!e}).length>0;return{useUV:o=a&&a._lightMap?o||!!a._lightMap.texture:o||i&&!!i.lightMapData,mappingType:a&&a._mappingOperator?a._mappingOperator.mappingType:e.mappingType,mappingUseFragment:a&&a._mappingOperator?a._mappingOperator.mappingUseFragment:e.mappingUseFragment,textureBlending:e.textureBlending,textureFormat:e.map,needTangent:e.needTangent,needTangentBinormal:e.requireTangentBinormal()}},this.initMaterial=function(t,i,r,n,a,s,o){t.addEventListener("dispose",fi);var l,h=be.contextId,c=this.id,d=this.currentRendererMode,f=t.programManager;d===f.currentRendererMode&&c===f.currentRendererId&&h===f.currentContextId||f.setActive(h,c,d);var y=t._shaderID,S=u;u=u&&t._canUseLights(),null!==y&&function(e,t,i){e.uniforms=t.uniforms;var r=!!e.isPhysicalMaterial&&!i;e.vertexShader=r?t.vertexShaderNoLight:t.vertexShader,e.fragmentShader=r?t.fragmentShaderNoLight:t.fragmentShader}(t,e.ShaderLib[y],u);var _=this._commonShaderOptionsBuilder(t,i,r,n,a,s,o,S);if(u&&Object.assign(_,this._lightedShaderOptionsBuilder(t,i,r,n,a,s,o)),Object.assign(_,this._textureShaderOptionsBuilder(t,i,r,n,a,s,o)),M||(_.dashedLine=t.isDashedLine,_.cpuPattern=t.isCPUPattern,_.patternSize=t.isDashedLine&&t.dashPattern?t.dashPattern.length:0),b&&(_.specialPickingInstancing=r&&r.isCurvedPipe,_._definePickingInstancing=t._definePickingInstancing),(u||C||A)&&(_.shadowMapQuality=this.shadowMapEnabled&&r.receiveShadow&&this.shadowMapQuality,_.shadowMapDebug=this.shadowMapEnabled&&r.receiveShadow&&this.shadowMapDebug,_.shadowMapCascade=this.shadowMapEnabled&&r.receiveShadow&&this.shadowMapCascade),_._isDecal=(a&e.ProgramIDs.DECALS)>0,p||(_.isDecal=_._isDecal,_.isDecal&&0==_.mappingUseFragment&&(_.mappingUseFragment=!0)),t._setMaterialShaderOptions(_,u,m||v,C||A,g,M),t._PDSFXData&&t._PDSFXData.PDSFX){var x=t._PDSFXData;_.PDSFX=!0,_.PDSFX_OverridableFunctions_VS=t._getPDSFXOverridableFunctions_VS(),_.PDSFX_OverridableFunctions_FS=t._getPDSFXOverridableFunctions_FS(),_.PDSFX_hasAlbedo=x.PDSFX_hasAlbedo,_.PDSFX_hasOpacity=x.PDSFX_hasOpacity,_.PDSFX_hasHalfWidth=x.PDSFX_hasHalfWidth,_.PDSFX_hasEmissive=x.PDSFX_hasEmissive,_.PDSFX_hasSpecular=x.PDSFX_hasSpecular,_.pdsfxVaryingsCode=x.pdsfxVaryingsCode?x.pdsfxVaryingsCode:"",_.pdsfxUniformsCode=x.pdsfxUniformsCode?x.pdsfxUniformsCode:null,x.pdsfxUniforms&&(_.pdsfxUniforms=x.pdsfxUniforms),_.pdsfxGlobalVariablesCode_VS=x.pdsfxGlobalVariablesCode_VS?x.pdsfxGlobalVariablesCode_VS:"",_.pdsfxGlobalVariablesCode_FS=x.pdsfxGlobalVariablesCode_FS?x.pdsfxGlobalVariablesCode_FS:"",_.pdsfxAttributesCode=x.pdsfxAttributesCode?x.pdsfxAttributesCode:"",_.pdsfxUseMap=x.pdsfxUseMap?x.pdsfxUseMap:"",_.pdsfxCPULargeScale=x.CPULargeScale,_.pdsfxUseMap&&(_.useUV=!0)}t.enableReceiveShadowOnCapping=_.shadowMapEnabled;var w,P=t.program;if(t.program=function(t,i,r){var n,a,s,o,l=[],h=i.fragmentShader,c=i.vertexShader,d=i.uniforms,u=i.attributes,p=i.defines;null===t&&(l.push(h),l.push(c));o=l.join();var f="SHADOWMAP_TYPE_BASIC";r.shadowMapType===e.PCFShadowMap?f="SHADOWMAP_TYPE_PCF":r.shadowMapType===e.PCFSoftShadowMap?f="SHADOWMAP_TYPE_PCF_SOFT":r.shadowMapType===e.PCFInterpolShadowMap?f="SHADOWMAP_TYPE_PCF_INTERPOL":r.shadowMapType===e.PCFPoissonShadowMap?f="SHADOWMAP_TYPE_PCF_POISSON":r.shadowMapType===e.PCFOptimizedShadowMap?f="SHADOWMAP_TYPE_PCF_OPTI":r.shadowMapType===e.ESMShadowMap?f="SHADOWMAP_TYPE_ESM":r.shadowMapType===e.ESMImprovedShadowMap&&(f="SHADOWMAP_TYPE_ESM_IMPROVED");var g="SHADOWMAP_QUALITY_LOW";r.shadowMapQuality===e.MediumQuality?g="SHADOWMAP_QUALITY_MEDIUM":r.shadowMapQuality===e.HighQuality&&(g="SHADOWMAP_QUALITY_HIGH");r.shadowMapTypeDefine=f,r.shadowMapQualityDefine=g;var m=function(e){var t,i,r=[];for(var n in e)!1!==(t=e[n])&&(i="#define "+n+" "+t,r.push(i));return r.join("\n")}(p),v=["vec4 sampleTexture(sampler2D iTexture, vec2 iCoord) {","#ifdef GLSL300ES","return texture(iTexture, iCoord);","#else","return texture2D/*NO REPLACING*/(iTexture, iCoord);","#endif","}","vec4 sampleCubeTexture(samplerCube iTexture, vec3 iCoord) {","#ifdef GLSL300ES","return texture(iTexture, iCoord);","#else","return textureCube/*NO REPLACING*/(iTexture, iCoord);","#endif","}"].join("\n"),y=[2===e.WebGLVersion?"#version 300 es":"",2===e.WebGLVersion?"#define GLSL300ES":"","precision "+X+" float;","precision "+ne+" int;",m,jt?"#define VERTEX_TEXTURES":"",ke?"#define RENDER_TO_FLOAT_TEXTURE":"",Ue?"#define RENDER_TO_HALF_FLOAT_TEXTURE":"","#define MAX_TEXTURE_SIZE "+zt.toFixed(1),Xe.gammaInput?"#define GAMMA_INPUT":"",Xe.gammaOutput?"#define GAMMA_OUTPUT":"",Xe.simpleGamma?"#define SIMPLE_GAMMA":"",Xe.useClippingCylinder?"#define USE_CLIPPINGCYLINDER":"","#define MAX_POLYGON_SIZE "+Math.max(Xe.maxPolyLineSize,Xe.maxScissorSize),Xe.maxPolyLineSize>0?"#define USE_CLIPPINGPOLYGON":"",Xe.maxPolyLineSize>0?"#define NB_CLIPPINGPOLYGON "+Xe.maxNbPolyLine:"",Xe.maxScissorSize>0?"#define USE_SCISSORPOLYGON":"",K(r)].join("\n"),S=[v,"","#ifndef DEFERRABLE_MATERIAL","#if defined(PICKING_INSTANCING) || defined(SPECIAL_PICKING_INSTANCING)","varying vec3 vInstancePickingColor;","#endif","#endif","",e.ShaderChunk.Default_uniforms_declaration,e.ShaderChunk.normalMatrix_uniforms_declaration,e.ShaderChunk.double_emulation_utilities,e.ShaderChunk.double_emulation_vertex,e.ShaderChunk.sRGB_conversion,e.ShaderChunk.gpu_scenegraph_nodes,"#ifdef PDSFX",e.ShaderChunk.PDSFX_header_vertex,"#else","#ifdef COMPRESSED_VERTICES","vec3 position;","attribute vec2 _DSposition;","#else","attribute vec3 position;","#endif","#ifdef COMPRESSED_NORMALS","vec3 normal;","attribute float _DSnormal;","#else","attribute vec3 normal;","#endif","#ifdef COMPRESSED_UVS","vec2 uv;","vec2 uv2;","attribute vec2 _DSuv;","attribute vec2 _DSuv2;","#else","attribute vec2 uv;","attribute vec2 uv2;","#endif","attribute vec3 _DStangent;","attribute vec3 _DSbinormal;","vec3 tangent;","vec3 binormal;","#ifdef USE_DASHEDLINE","attribute vec2 lineDistance;","#ifdef WORLD_SIZE_PATTERN2","attribute vec2 patternStartEnd;","#endif","#endif","#ifdef USE_WIDELINE","attribute vec3 previousPos;","attribute vec3 followingPos;","#endif","#endif","#ifdef USE_WIDELINE","attribute float sideExtrusion;","#endif","#ifdef COMPRESSED_COLORS","attribute vec2 _DScolor;","vec4 color;","#else","attribute vec4 color;","#endif","#ifdef COMPRESSED_VERTICES","uniform vec3 offsetVector;","uniform vec3 quantizedVector;","#endif",e.ShaderChunk.rgba_packing_pars,e.ShaderChunk.decompress_vertices_pars,e.ShaderChunk.decompress_normals_pars,e.ShaderChunk.decompress_uvs_pars,e.ShaderChunk.decompress_colors_pars,"#ifdef IS_MULTI_INSTANCED","attribute float instanceId;","#endif","#ifdef USE_MORPHTARGETS","attribute vec3 morphTarget0;","attribute vec3 morphTarget1;","attribute vec3 morphTarget2;","attribute vec3 morphTarget3;","#ifdef USE_MORPHNORMALS","attribute vec3 morphNormal0;","attribute vec3 morphNormal1;","attribute vec3 morphNormal2;","attribute vec3 morphNormal3;","#else","attribute vec3 morphTarget4;","attribute vec3 morphTarget5;","attribute vec3 morphTarget6;","attribute vec3 morphTarget7;","#endif","#endif","#ifdef USE_SKINNING","attribute vec4 skinIndex;","attribute vec4 skinWeight;","#endif",""].join("\n"),_=[2===e.WebGLVersion?"#version 300 es":"",2===e.WebGLVersion?"#define GLSL300ES":"",We?"#extension GL_EXT_frag_depth : enable":"",1===e.WebGLVersion?"#extension  GL_OES_standard_derivatives : enable":"",We?"#extension GL_EXT_frag_depth : enable":"",We?"#define FRAG_DEPTH_EXT":"",ke?"#define RENDER_TO_FLOAT_TEXTURE":"",Ue?"#define RENDER_TO_HALF_FLOAT_TEXTURE":"","#define DEPTH_PRECISION "+e.supportedExtensions.depthBits,"precision "+X+" float;","precision "+ne+" int;",Xe.gammaInput?"#define GAMMA_INPUT":"",Xe.gammaOutput?"#define GAMMA_OUTPUT":"",Xe.simpleGamma?"#define SIMPLE_GAMMA":"",m,"#define MAX_TEXTURE_SIZE "+zt.toFixed(1),Xe.useClippingCylinder?"#define USE_CLIPPINGCYLINDER":"","#define MAX_POLYGON_SIZE "+Math.max(Xe.maxPolyLineSize,Xe.maxScissorSize),Xe.maxPolyLineSize>0?"#define USE_CLIPPINGPOLYGON":"",Xe.maxPolyLineSize>0?"#define NB_CLIPPINGPOLYGON "+Xe.maxNbPolyLine:"",Xe.maxScissorSize>0?"#define USE_SCISSORPOLYGON":"",Xe.maxScissorSize>0?"#define NB_SCISSOR "+Xe.maxNbScissor:"",J(r)].join("\n"),x=[v,"vec4 sampleCubeTexture(samplerCube iTexture, vec3 iCoord, float iBias) {","#ifdef GLSL300ES","return texture(iTexture, iCoord, iBias);","#else","return textureCube/*NO REPLACING*/(iTexture, iCoord, iBias);","#endif","}",e.ShaderChunk.sRGB_conversion,e.ShaderChunk.rgba_packing_pars,e.ShaderChunk.decompress_vertices_pars,e.ShaderChunk.decompress_normals_pars,e.ShaderChunk.decompress_uvs_pars,e.ShaderChunk.decompress_colors_pars,"","#ifndef DEFERRABLE_MATERIAL","#if defined(PICKING_INSTANCING) || defined(SPECIAL_PICKING_INSTANCING)","varying vec3 vInstancePickingColor;","#endif","#endif","","vec3 tangent;","vec3 binormal;","#if defined(USE_MAPPING_OPERATOR_FRAGMENT) && defined(USE_TANGENT_BINORMAL)","vec3 MVUnit;",e.ShaderChunk.normalMatrix_uniforms_declaration,"#endif",e.ShaderChunk.Default_uniforms_declaration,e.ShaderChunk.double_emulation_utilities,e.ShaderChunk.double_emulation_fragment,"#ifdef GLSL300ES","layout(location = 0) out vec4 outFragColor;","#endif",""].join("\n"),b="",w="";if(r.PDSFX){var M=r.pdsfxGlobalVariablesCode_VS;if(p&&p.NB_OUTLINE_MAPS){for(var C="",P=0;P<p.NB_OUTLINE_MAPS;P++)C+="if (idInTextureArray == "+P+") return texture2D(outlinePositionMaps["+P+"], texCoords);";M=M.replace("__OUTLINES_MAPS_SAMPLING__",C)}var E=["#ifdef PDSFX",r.pdsfxAttributesCode,r.pdsfxVaryingsCode,r.pdsfxUniformsCode.common,r.pdsfxUniformsCode.vertex,e.ShaderChunk.PDSFX_common_pars,e.ShaderChunk.PDSFX_varyings_pars,e.ShaderChunk.PDSFX_attribute_getters_vertex,M,"struct TangentSpace","{","\tvec3 Position;","\tvec3 Normal;","\tvec3 Tangent;","\tvec3 Binormal;","};",r.PDSFX_OverridableFunctions_VS,"#endif",""].join("\n"),A=["#ifdef PDSFX",r.pdsfxVaryingsCode,r.pdsfxUniformsCode.common,r.pdsfxUniformsCode.fragment,e.ShaderChunk.PDSFX_common_pars,e.ShaderChunk.PDSFX_varyings_pars,e.ShaderChunk.PDSFX_varying_getters_fragment,r.pdsfxGlobalVariablesCode_FS,r.PDSFX_OverridableFunctions_FS,"#endif",""].join("\n");if(r.pdsfxCPULargeScale)y=y.replace("MODELVIEW_GPU","MODELVIEW_CPU"),_=_.replace("MODELVIEW_GPU","MODELVIEW_CPU");else{var T=[...E.matchAll("vGetWorldViewMatrix")],D=[...A.matchAll("vGetWorldViewMatrix")];(T&&T.length>1||D&&D.length>1)&&(y=y.replace("MODELVIEW_GPU","MODELVIEW_CPU"),_=_.replace("MODELVIEW_GPU","MODELVIEW_CPU"))}b=E,w=A}for(n=0,a=qe.length;n<a;n++){var I=qe[n];if(I.program._materialToUse===r.materialToUse&&I.shaderID===t&&I.pdsfx===r.PDSFX&&I.code===o&&I.prefix_vertex===y&&I.prefix_fragment===_&&I.pdsfx_fragment===w&&I.pdsfx_vertex===b)return I.usedTimes++,I.program}(r.shadowMapEnabled||r.shadowMapCubeEnabled)&&(h=(h=(h=h.replace("getExposureFromIndexPlaceholder",Zi(r,!1))).replace("getExposureFromIndexCubePlaceholder",Zi(r,!0))).replace("cascadedunrolledloop",function(e){for(var t="vec3 shadowCoord;bvec4 inFrustumVec;bool inFrustum;bvec2 inFrustumAndZVec;bool inFrustumAndZ;bvec2 frustumTestVec;bool frustumTest;\n",i=0;i<e.maxDirShadows;i++)t+="shadowCoord = vShadowCoord["+i+"].xyz / vShadowCoord["+i+"].w;\n",t+="inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n",t+="inFrustum = all( inFrustumVec );\n",t+="inFrustumAndZVec = bvec2(inFrustum, shadowCoord.z <= 1.0);\n",t+="inFrustumAndZ = all(inFrustumAndZVec);\n",t+="inFrustumCount += int( inFrustumAndZ );\n",t+="frustumTestVec = bvec2( inFrustumAndZ, inFrustumCount == 1 );\n",t+="frustumTest = all( frustumTestVec );\n",t+="if ( frustumTest ) {\n",t+="\texposure = getExposure(vShadowCoord["+i+"],shadowMap["+i+"],shadowBias["+i+"],shadowMapSize["+i+"]);\n",t+="\t#ifdef USE_TRANSPARENTSHADOWMAP \n",t+="\t\tvec3 shadowCoord = vShadowCoord["+i+"].xyz / vShadowCoord["+i+"].w;\n",t+="\t\tfloat isNotbehindFrustum = step(0.0,vShadowCoord["+i+"].w);\n",t+="\t\ttransparentExposure = isNotbehindFrustum * texture2D(transparentShadowMap["+i+"], shadowCoord.xy) + (1.0-isNotbehindFrustum) * vec4(1.0);\n",t+="\t#endif\n",t+="\t#ifdef SHADOWMAP_DEBUG\n",t+="\t\tif ( frustumTest ) gl_FragColor.xyz *= frustumColors[ "+i+" ];\n",t+="\t#endif\n",t+="}\n";return t}(r)));var R=new U;s=be.createProgram(),R.program=s,R._lightsKey=Rt,R._ambianceKey=Ot,R._materialToUse=r.materialToUse;var O=/(void(\s+)main(\s*)\((\s*)\)(\s*){(\s*))/,L=c.replace(O,"$&"+e.ShaderChunk.large_scale_VS),V=h.replace(O,"$&"+e.ShaderChunk.large_scale_FS),F=_+"\n"+x+"\n"+w+"\n"+V,B=y+"\n"+S+"\n"+b+"\n"+L;if(2===e.WebGLVersion){F=F.replace(/varying /g,"in "),B=(B=B.replace(/varying /g,"out ")).replace(/attribute /g,"in "),F=F.replace(/gl_FragColor/g,"outFragColor");var N=/\s*texture2D\s*\(/g,G=/\s*textureCube\s*\(/g;B=B.replace(N," sampleTexture("),F=(F=F.replace(N," sampleTexture(")).replace(G," sampleCubeTexture("),B=B.replace(G," sampleCubeTexture(");F=F.replace(/#extension\s+GL_OES_standard_derivatives\s*:\s*enable/g,"")}var z=be.createShader(be.FRAGMENT_SHADER);be.shaderSource(z,F),be.compileShader(z);var H,W,j=be.createShader(be.VERTEX_SHADER);be.shaderSource(j,B),be.compileShader(j),be.attachShader(s,j),be.attachShader(s,z),be.linkProgram(s),be.getProgramParameter(s,Ie)||(console.error("Could not initialise shader\nVALIDATE_STATUS: "+be.getProgramParameter(s,be.VALIDATE_STATUS)+", gl error ["+be.getProgramInfoLog(s)+"]"),console.error(be.getShaderInfoLog(z)),console.error(Yi(F)),console.error(be.getShaderInfoLog(j)),console.error(Yi(B)));be.deleteShader(z),be.deleteShader(j),R.objectUniformLocations=new k;var q=R.objectUniformLocations;q.modelMatrix=be.getUniformLocation(s,"_modelMatrixForDoubleGPU"),q.modelInvTranspMatrix=be.getUniformLocation(s,"modelInvTranspMatrix"),q.modelViewMatrix=be.getUniformLocation(s,"modelViewMatrix"),q.modelViewInvTranspMatrix=be.getUniformLocation(s,"modelViewInvTranspMatrix"),q.normalMatrix=be.getUniformLocation(s,"normalMatrix"),q.displacementRadius=be.getUniformLocation(s,"displacementRadius"),q.quantizedVector=be.getUniformLocation(s,"quantizedVector"),q.offsetVector=be.getUniformLocation(s,"offsetVector"),q.fixedSizeRatio=be.getUniformLocation(s,"fixedSizeRatio"),q.fixedSizeCenterRatio=be.getUniformLocation(s,"fixedSizeCenterRatio"),q.lightMap=be.getUniformLocation(s,"lightMap"),q.lightMapUvSlot=be.getUniformLocation(s,"lightMapUvSlot"),q.lightMapUvTransform=be.getUniformLocation(s,"lightMapUvTransform"),q.billboardRotationEnabled=be.getUniformLocation(s,"billboardRotationEnabled"),q.billboardType=be.getUniformLocation(s,"billboardType"),q.billboardAxis=be.getUniformLocation(s,"billboardAxis"),q.billboardRotation=be.getUniformLocation(s,"billboardRotation"),q.modelInvRotMatrix=be.getUniformLocation(s,"modelInvRotMatrix"),q.decalStencilValue=be.getUniformLocation(s,"decalStencilValue"),q.modelViewInvMatrix=be.getUniformLocation(s,"modelViewInvMatrix"),q.decalExplicitUv=be.getUniformLocation(s,"decalExplicitUv"),q.objectColorBufferType=be.getUniformLocation(s,"objectColorBufferType"),q.skinningMap=be.getUniformLocation(s,"skinningMap"),q.skinningInstancingMaps=be.getUniformLocation(s,"skinningInstancingMaps"),q.backgroundViewModeControl=be.getUniformLocation(s,"background_view_mode_control"),q.backgroundViewModeNearFar=be.getUniformLocation(s,"background_view_mode_near_far"),q.computeFuncName(),R.uniformLocations={};var Z=R.uniformLocations;if(2===e.WebGLVersion){var Y=be.getUniformBlockIndex(s,"FrameUBO");be.uniformBlockBinding(s,Y,oe.FRAME)}else Z.viewMatrix=be.getUniformLocation(s,"viewMatrix"),Z.projectionMatrix=be.getUniformLocation(s,"projectionMatrix"),Z.cameraPosition=be.getUniformLocation(s,"cameraPosition");for(H in Z.lowPartCameraPosition=be.getUniformLocation(s,"lowPartCameraPosition"),Z.cameraConstant=be.getUniformLocation(s,"cameraConstant"),Z.billCameraPos=be.getUniformLocation(s,"billCameraPos"),Z.billCameraLookAt=be.getUniformLocation(s,"billCameraLookAt"),Z.billCameraUp=be.getUniformLocation(s,"billCameraUp"),Z.invViewMatrix=be.getUniformLocation(s,"invViewMatrix"),Z.invProjectionMatrix=be.getUniformLocation(s,"invProjectionMatrix"),Z.viewInfo=be.getUniformLocation(s,"viewInfo"),Z.currentNormalStencilDepth=be.getUniformLocation(s,"currentNormalStencilDepth"),Z.currentTexCoord=be.getUniformLocation(s,"currentTexCoord"),Z.currentRGBADepth=be.getUniformLocation(s,"currentRGBADepth"),d)d[H]._array&&(d[H]._array=void 0),Z[H]=be.getUniformLocation(s,H);if(r.PDSFX&&(Z.viewInvMatrix=be.getUniformLocation(s,"viewInvMatrix"),Z.projectionInvMatrix=be.getUniformLocation(s,"projectionInvMatrix"),Z.viewInvTranspMatrix=be.getUniformLocation(s,"viewInvTranspMatrix"),Z.nearFarLogFactor=be.getUniformLocation(s,"nearFarLogFactor"),Z.viewportSize=be.getUniformLocation(s,"viewportSize"),r.PDSFX_hasAlbedo&&(Z.diffuse=be.getUniformLocation(s,"_DSalbedo")),r.PDSFX_hasHalfWidth&&(Z.halfWidth=be.getUniformLocation(s,"_DShalfWidth")),r.PDSFX_hasEmissive&&(Z.emissive=be.getUniformLocation(s,"_DSemissive")),r.PDSFX_hasSpecular&&(Z.specular=be.getUniformLocation(s,"_DSspecular")),r.PDSFX_hasOpacity&&(Z.opacity=be.getUniformLocation(s,"_DSopacity")),r.pdsfxUniforms))for(var Q in r.pdsfxUniforms)Z[Q]=be.getUniformLocation(s,Q);var $=R.attributes;r.PDSFX?($.position=be.getAttribLocation(s,"_DSposition"),$.normal=be.getAttribLocation(s,"_DSnormal"),$.uv=be.getAttribLocation(s,"_DSuv"),$.uv2=be.getAttribLocation(s,"_DSuv2"),$.lineDistance=be.getAttribLocation(s,"_DSlineDistance"),$.previousPos=be.getAttribLocation(s,"_DSpreviousPos"),$.followingPos=be.getAttribLocation(s,"_DSfollowingPos")):(r.compressedVertices?$.position=be.getAttribLocation(s,"_DSposition"):$.position=be.getAttribLocation(s,"position"),r.compressedNormals?$.normal=be.getAttribLocation(s,"_DSnormal"):$.normal=be.getAttribLocation(s,"normal"),r.compressedUVs?$.uv=be.getAttribLocation(s,"_DSuv"):$.uv=be.getAttribLocation(s,"uv"),r.compressedUVs?$.uv2=be.getAttribLocation(s,"_DSuv2"):$.uv2=be.getAttribLocation(s,"uv2"),$.lineDistance=be.getAttribLocation(s,"lineDistance"),$.previousPos=be.getAttribLocation(s,"previousPos"),$.followingPos=be.getAttribLocation(s,"followingPos"));$.tangent=be.getAttribLocation(s,"_DStangent"),$.binormal=be.getAttribLocation(s,"_DSbinormal"),$.patternStartEnd=be.getAttribLocation(s,"patternStartEnd"),r.compressedColors?$.color=be.getAttribLocation(s,"_DScolor"):$.color=be.getAttribLocation(s,"color");$.skinIndex=be.getAttribLocation(s,"skinIndex"),$.skinWeight=be.getAttribLocation(s,"skinWeight"),$.sideExtrusion=be.getAttribLocation(s,"sideExtrusion"),R.uvOrBinOrTan=($.uv>=0||$.binormal>=0||$.tangent>=0)&&r.mappingType<1;var ee=R.instanceAttributes;for(W in u)ee[W]=be.getAttribLocation(s,W);function te(e){if(e.name.startsWith("_DS"))return!0;return["binormal","color","followingPos","lineDistance","normal","position","previousPos","patternStartEnd","sideExtrusion","skinIndex","skinWeight","tangent","uv","uv2","specialMeshIds","specialMeshPicking"].includes(e.name)}function ie(e){return Object.keys(R.instanceAttributes).includes(e.name)}ee.specialMeshIds=be.getAttribLocation(s,"specialMeshIds"),ee.specialMeshPicking=be.getAttribLocation(s,"specialMeshPicking");const re=be.getProgramParameter(s,be.ACTIVE_ATTRIBUTES);for(let e=0;e<re;e++){const t=be.getActiveAttrib(s,e);te(t)||(ie(t)||($[t.name]=be.getAttribLocation(s,t.name)))}return R.id=Ze++,qe.push({program:R,code:o,usedTimes:1,prefix_vertex:y,prefix_fragment:_,pdsfx_fragment:w,pdsfx_vertex:b,shaderID:t,pdsfx:r.PDSFX}),_e.programs=qe.length,R}(y,t,_),P!==t.program&&t._notifyDLtoBeSortedNextFrame(),f.addProgram(a,t.program,this.shaderVersions[this.currentRendererMode]),!t.loadUniforms)for(l in null===t.uniformsList&&(t.uniformsList=new Map),t.uniforms){t.program.uniformLocations[l]&&((w=t.uniforms[l]).sceneUniform||w.clipPlanesUniform||t.uniformsList.set(l,w))}u=S},this.loadObjectUniforms=function(t,i,r,n,a,s,o){if(!i.isCurvedPipe){if(t.quantizedVector&&be.uniform3f(t.quantizedVector,r.quantizedVector.x,r.quantizedVector.y,r.quantizedVector.z),t.offsetVector&&be.uniform3f(t.offsetVector,r.offsetVector.x,r.offsetVector.y,r.offsetVector.z),t.lightMap&&(o&&o._lightMap?(this.loadTexture(be,t.lightMap,o._lightMap.texture),be.uniformMatrix3fv(t.lightMapUvTransform,!1,this.float32Matrix3x3Temp.setDoubles(o._lightMap.uvTransform.elements)),be.uniform1i(t.lightMapUvSlot,o._lightMap.uvSlot?o._lightMap.uvSlot:1)):(this.loadTexture(be,t.lightMap,r.lightMap),be.uniformMatrix3fv(t.lightMapUvTransform,!1,this.float32Matrix3x3Temp.setDoubles((i.lightMapData.lightMapUvTransform?i.lightMapData.lightMapUvTransform:this._dummyMat3).elements)),be.uniform1i(t.lightMapUvSlot,i.lightMapData.lightMapUvSlot?i.lightMapData.lightMapUvSlot:1))),t.displacementRadius&&be.uniform1f(t.displacementRadius,i.worldRadius),t.billboardType){var l=i._billboardData;be.uniform1i(t.billboardType,l.type),l.type>1&&(l.axis?be.uniform3f(t.billboardAxis,l.axis.x,l.axis.y,l.axis.z):be.uniform3f(t.billboardAxis,0,0,1)),l.rotation?(be.uniform1i(t.billboardRotationEnabled,1),be.uniformMatrix4fv(t.billboardRotation,!1,this.float32Matrix4x3Temp.setDoubles(l.rotation.elements))):be.uniform1i(t.billboardRotationEnabled,0)}if(t.skinningMap?this.loadTexture(be,t.skinningMap,i._skinning.skinningMap):t.skinningInstancingMaps&&this.loadTextureArray(be,n.program,t.skinningInstancingMaps,"skinningInstancingMaps",i._skinningInstancing.skinningInstancingMaps),it!==i.matrixWorld){if(t.fixedSizeCenterRatio?be.uniform4f(t.fixedSizeCenterRatio,i._ratioData.center.x,i._ratioData.center.y,i._ratioData.center.z,i._ratioData.ratio):t.fixedSizeRatio&&be.uniform1f(t.fixedSizeRatio,i._ratioData.ratio),t.decalStencilValue&&i._decalData&&(be.uniform1f(t.decalStencilValue,i._decalData.stencilID),be.uniform1f(t.decalExplicitUv,i._decalData.explicitUv)),t.objectColorBufferType&&be.uniform1f(t.objectColorBufferType,i._vertexColors),t.modelViewMatrix&&(i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(a.matrixWorldInverse,i.matrixWorld)),be.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements)),t.modelMatrix&&be.uniformMatrix4fv(t.modelMatrix,!1,i._mElements),t.modelInvRotMatrix){if(!i._modelInvRotMatrix){var h=(new e.Matrix4).getInverse(i.matrixWorld);i._modelInvRotMatrix=(new e.Matrix4).extractRotation(h)}be.uniformMatrix4fv(t.modelInvRotMatrix,!1,this.float32Matrix4x3Temp.setDoubles(i._modelInvRotMatrix.elements))}n._PDSFXData&&n._PDSFXData.PDSFX&&(t.modelInvTranspMatrix&&(null===i.modelInvTranspMatrix&&(i.modelInvTranspMatrix=(new e.Matrix4).getInverse(i.matrixWorld).transpose()),be.uniformMatrix4fv(t.modelInvTranspMatrix,!1,this.float32Matrix4x3Temp.setDoubles(i.modelInvTranspMatrix.elements))),t.modelViewInvTranspMatrix&&(null===i.modelViewInvTranspMatrix&&(i.modelViewInvTranspMatrix=(new e._Float32Matrix4).multiplyMatricesAndInverse(a.matrixWorldInverse,i.matrixWorld).transpose()),be.uniformMatrix4fv(t.modelViewInvTranspMatrix,!1,i.modelViewInvTranspMatrix.elements))),t.modelViewInvMatrix&&(null===i.modelViewInvMatrix&&(i.modelViewInvMatrix=(new e._Float32Matrix4).multiplyMatricesAndInverse(a.matrixWorldInverse,i.matrixWorld)),be.uniformMatrix4fv(t.modelViewInvMatrix,!1,i.modelViewInvMatrix.elements)),t.normalMatrix&&be.uniformMatrix3fv(t.normalMatrix,!1,this.float32Matrix3x3Temp.setDoubles(i._normalMatrix.elements)),it=i.matrixWorld}if(t.backgroundViewModeControl){const e=this._backgroundColor?this._backgroundColor.r:0,r=this._backgroundColor?this._backgroundColor.g:0,n=this._backgroundColor?this._backgroundColor.b:0;be.uniform4f(t.backgroundViewModeControl,e,r,n,i.applyBackgroundViewMode?1:0)}t.backgroundViewModeNearFar&&be.uniform2f(t.backgroundViewModeNearFar,a.near,a.far),xe.objectUniformCalls++}},this._load_MM=function(e,t,i,r,n,a,s){it!==t.matrixWorld&&(be.uniformMatrix4fv(e.modelMatrix,!1,t._mElements),it=t.matrixWorld,xe.objectUniformCalls++)},this._load_MM_NM=function(e,t,i,r,n,a,s){it!==t.matrixWorld&&(be.uniformMatrix4fv(e.modelMatrix,!1,t._mElements),be.uniformMatrix3fv(e.normalMatrix,!1,this.float32Matrix3x3Temp.setDoubles(t._normalMatrix.elements)),it=t.matrixWorld,xe.objectUniformCalls++)},this._load_MVM=function(t,i,r,n,a,s,o){it!==i.matrixWorld&&(i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(a.matrixWorldInverse,i.matrixWorld)),be.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements),it=i.matrixWorld,xe.objectUniformCalls++)},this._load_MVM_NM=function(t,i,r,n,a,s,o){it!==i.matrixWorld&&(i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(a.matrixWorldInverse,i.matrixWorld)),be.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements),be.uniformMatrix3fv(t.normalMatrix,!1,this.float32Matrix3x3Temp.setDoubles(i._normalMatrix.elements)),it=i.matrixWorld,xe.objectUniformCalls++)},this._load_MM_MVM=function(t,i,r,n,a,s,o){it!==i.matrixWorld&&(i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(a.matrixWorldInverse,i.matrixWorld)),be.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements),be.uniformMatrix4fv(t.modelMatrix,!1,i._matrixWorldForDoubleGPU.elements),it=i.matrixWorld,xe.objectUniformCalls++)},this._load_MM_MVM_NM=function(t,i,r,n,a,s,o){it!==i.matrixWorld&&(i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(a.matrixWorldInverse,i.matrixWorld)),be.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements),be.uniformMatrix4fv(t.modelMatrix,!1,i._matrixWorldForDoubleGPU.elements),be.uniformMatrix3fv(t.normalMatrix,!1,this.float32Matrix3x3Temp.setDoubles(i._normalMatrix.elements)),it=i.matrixWorld,xe.objectUniformCalls++)},this._dummyMat3=new e.Matrix3,this._dummyMat4=new e.Matrix4,this.loadMatrix3=function(e,t,i){e.uniformMatrix3fv(t,!1,this.float32Matrix3x3Temp.setDoubles(i.elements))},this.loadMatrix4=function(e,t,i){e.uniformMatrix4fv(t,!1,this.float32Matrix4x4Temp.setDoubles(i.elements))},this.loadMatrix4x3=function(e,t,i){e.uniformMatrix4fv(t,!1,this.float32Matrix4x3Temp.setDoubles(i.elements))},this.loadMatrixFloat4=function(e,t,i){e.uniformMatrix4fv(t,!1,i.elements)},this.loadMatrix4Array=function(e,t,i,r,n){var a=t.flattenedUniformArrays;void 0!==a[r]&&a[r].length===16*n.length||(a[r]=new Float32Array(16*n.length));for(var s=0,o=n.length;s<o;s++)n[s]&&n[s].flattenToArrayOffset(a[r],16*s);var l=a[r];l.length>0&&e.uniformMatrix4fv(i,!1,l)},this.loadVector2Array=function(e,t,i,r,n){var a,s=t.flattenedUniformArrays;void 0===s[r]&&(s[r]=new Float32Array(2*n.length));for(var o=0,l=n.length;o<l;o++)a=2*o,s[r][a]=n[o].x,s[r][a+1]=n[o].y;e.uniform2fv(i,s[r])},this.loadTexture=function(t,i,r){var n=r,a=Hi();t.uniform1i(i,a),n&&(n instanceof e.WebGLRenderTargetCube?Ji(n,a):this.setTexture(n,a))},this.loadTextureArray=function(e,t,i,r,n){var a,s,o,l,h=t.flattenedUniformArrays;for(void 0===h[r]&&(h[r]=[]),a=0,s=n.length;a<s;a++)h[r][a]=Hi();for(be.uniform1iv(i,h[r]),a=0,s=n.length;a<s;a++)o=n[a],l=h[r][a],o&&this.setTexture(o,l)},this.loadTextureCubeArray=function(e,t,i,r,n){var a,s,o,l,h=t.flattenedUniformArrays;for(void 0===h[r]&&(h[r]=[]),a=0,s=n.length;a<s;a++)h[r][a]=Hi();for(be.uniform1iv(i,h[r]),a=0,s=n.length;a<s;a++)o=n[a],l=h[r][a],o&&Ji(o,l)},this.loadGASUniforms=function(e,t,i,r,n){if(i.diffuse){var a=n&&t.useGASColor?n.color:t.color,s=r&&r.getColor();s&&(a=O.set(r.getColor())),this.gammaInput&&(a=O.copyToLinear(a,this.simpleGamma)),e.uniform3f(i.diffuse,a.r,a.g,a.b),i._colorOverride&&e.uniform1i(i._colorOverride,s?1:0)}if(i.opacity){var o=n&&t.useGASOpacity?n.opacity:t.opacity;r&&null!==r.getOpacity()&&(o=r.getOpacity()),this.useRenderPriorityOpacity&&(o=this.computeRenderPriorityOpacity(o,r)),e.uniform1f(i.opacity,o)}},this.loadUniformsCommon=function(t,i,r,n,a,s){if(this.loadGASUniforms(t,i,r,n,a),r.colorBufferType&&be.uniform1f(r.colorBufferType,i.vertexColors),r.envMapExposureSpecular&&t.uniform1f(r.envMapExposureSpecular,i.envMapExposureSpecular||0==i.envMapExposureSpecular?i.envMapExposureSpecular:1),r.envMapExposureDiffuse&&t.uniform1f(r.envMapExposureDiffuse,i.envMapExposureDiffuse||0==i.envMapExposureDiffuse?i.envMapExposureDiffuse:1),r.ambienceMatrix){var o=i.ambienceMatrix?i.ambienceMatrix:this._dummyMat4;be.uniformMatrix4fv(r.ambienceMatrix,!1,this.float32Matrix4x4Temp.setDoubles(o.elements))}var l;if(r.flipEnvMap&&t.uniform1f(r.flipEnvMap,i.flipEnvMap||0==i.flipEnvMap?i.flipEnvMap:1),r.reflectivity&&t.uniform1f(r.reflectivity,i.reflectivity||0==i.reflectivity?i.reflectivity:1),r.refractionRatio&&t.uniform1f(r.refractionRatio,i.refractionRatio||0==i.refractionRatio?i.refractionRatio:.98),r.morphTargetInfluences&&t.uniform1f(r.morphTargetInfluences,i.morphTargetInfluences?i.morphTargetInfluences:0),r.combine&&t.uniform1i(r.combine,i.combine?i.combine:0),r.renderIteration&&t.uniform1i(r.renderIteration,this.renderIteration?this.renderIteration:0),i.map?l=i.map:i.specularMap?l=i.specularMap:i.normalMap?l=i.normalMap:i.bumpMap&&(l=i.bumpMap),void 0!==l){var h=l.offset||{x:0,y:0},c=l.repeat||{x:1,y:1};r.offsetBumpMap&&t.uniform2f(r.offsetBumpMap,h.x,h.y),r.repeatBumpMap&&t.uniform2f(r.repeatBumpMap,c.x,c.y)}else r.offsetBumpMap&&t.uniform2f(r.offsetBumpMap,0,0),r.repeatBumpMap&&t.uniform2f(r.repeatBumpMap,1,1);r.map&&this.loadTexture(t,r.map,i.map),r.specularMap&&this.loadTexture(t,r.specularMap,i.specularMap),r.reflectivityEnvMap&&this.loadTexture(t,r.reflectivityEnvMap,i.reflectivityEnvMap),r.envMap&&this.loadTexture(t,r.envMap,i.envMap),r.refractionRatioMap&&this.loadTexture(t,r.refractionRatioMap,i.refractionRatioMap),s&&s._mappingOperator||i._loadMappingInfo(i,this,t,r),i.map&&i.map.hdr&&i.map.image?r.mapHDRSize&&t.uniform2f(r.mapHDRSize,parseInt(i.map.image.width),parseInt(i.map.image.height)):r.mapHDRSize&&t.uniform2f(r.mapHDRSize,2048,1024),i.envMap&&i.envMap.hdr&&i.envMap.image?(r.envMapHDRSize&&t.uniform2f(r.envMapHDRSize,parseInt(i.envMap.image.width),parseInt(i.envMap.image.height)),r.useRefract&&t.uniform1i(r.useRefract,i.envMap&&i.envMap.mapping instanceof e.CubeRefractionMapping)):(r.envMapHDRSize&&t.uniform2f(r.envMapHDRSize,2048,1024),r.useRefract&&t.uniform1i(r.useRefract,0))},this.loadUniformsBump=function(e,t,i){t.bumpMap&&(i.bumpScale&&e.uniform1f(i.bumpScale,t.bumpScale?t.bumpScale:1),i.bumpMap&&this.loadTexture(e,i.bumpMap,t.bumpMap))},this.loadUniformsDepthLayer=function(e,t,i){},this.loadUniformsNormalMap=function(e,t,i){t.normalMap&&(i.normalScale&&(t.normalScale?e.uniform2f(i.normalScale,t.normalScale.x,t.normalScale.y):e.uniform2f(i.normalScale,1,1)),i.normalMap&&this.loadTexture(e,i.normalMap,t.normalMap))},this.loadUniformsLights=function(e,t,i,r,n){t.ambientLightColor&&i.ambient.length>0&&e.uniform3fv(t.ambientLightColor,i.ambient),n?t.directionalLightColor&&i.directional.colorsPhong.length>0&&e.uniform3fv(t.directionalLightColor,i.directional.colorsPhong):t.directionalLightColor&&i.directional.colors.length>0&&e.uniform3fv(t.directionalLightColor,i.directional.colors),t.directionalLightDirection&&i.directional.positions.length>0&&e.uniform3fv(t.directionalLightDirection,i.directional.positions),t.directionalIBLLightColor&&i.directionalIBL.colors.length>0&&e.uniform3fv(t.directionalIBLLightColor,i.directionalIBL.colors),t.directionalIBLLightDirection&&i.directionalIBL.positions.length>0&&e.uniform3fv(t.directionalIBLLightDirection,i.directionalIBL.positions),t.directionalPhongLightColor&&i.directionalPhong.colors.length>0&&e.uniform3fv(t.directionalPhongLightColor,i.directionalPhong.colors),t.directionalPhongLightDirection&&i.directionalPhong.positions.length>0&&e.uniform3fv(t.directionalPhongLightDirection,i.directionalPhong.positions),n?t.pointLightColor&&i.point.colorsPhong.length>0&&e.uniform3fv(t.pointLightColor,i.point.colorsPhong):t.pointLightColor&&i.point.colors.length>0&&e.uniform3fv(t.pointLightColor,i.point.colors),t.pointLightPosition&&i.point.positions.length>0&&e.uniform3fv(t.pointLightPosition,i.point.positions),t.pointLightPhysicalAttenuation&&i.point.physicalAttenuations.length>0&&e.uniform1iv(t.pointLightPhysicalAttenuation,i.point.physicalAttenuations),t.pointLightDistance&&i.point.distances.length>0&&e.uniform1fv(t.pointLightDistance,i.point.distances),n?t.spotLightColor&&i.spot.colorsPhong.length>0&&e.uniform3fv(t.spotLightColor,i.spot.colorsPhong):t.spotLightColor&&i.spot.colors.length>0&&e.uniform3fv(t.spotLightColor,i.spot.colors),t.spotLightPosition&&i.spot.positions.length>0&&e.uniform3fv(t.spotLightPosition,i.spot.positions),t.spotLightDirection&&i.spot.directions.length>0&&e.uniform3fv(t.spotLightDirection,i.spot.directions),t.spotLightPhysicalAttenuation&&i.spot.physicalAttenuations.length>0&&e.uniform1iv(t.spotLightPhysicalAttenuation,i.spot.physicalAttenuations),t.spotLightDistance&&i.spot.distances.length>0&&e.uniform1fv(t.spotLightDistance,i.spot.distances),t.spotLightAngleCos&&i.spot.anglesCos.length>0&&e.uniform1fv(t.spotLightAngleCos,i.spot.anglesCos),t.spotLightInnerAngleCos&&i.spot.innerAnglesCos.length>0&&e.uniform1fv(t.spotLightInnerAngleCos,i.spot.innerAnglesCos),t.iesLightColor&&i.ies.colors.length>0&&e.uniform3fv(t.iesLightColor,i.ies.colors),t.iesLightPosition&&i.ies.positions.length>0&&e.uniform3fv(t.iesLightPosition,i.ies.positions),t.iesLightDistance&&i.ies.distances.length>0&&e.uniform1fv(t.iesLightDistance,i.ies.distances),t.iesLightTexture&&i.ies.iesLightTexture.length>0&&this.loadTextureArray(e,r,t.iesLightTexture,"iesLightTexture",i.ies.iesLightTexture),t.matrixWorldInv&&this.loadMatrix4Array(e,r,t.matrixWorldInv,"matrixWorldInv",i.ies.matrixWorldInv),t.sphereLightColor&&i.sphere.colors.length>0&&e.uniform3fv(t.sphereLightColor,i.sphere.colors),t.sphereLightPosition&&i.sphere.positions.length>0&&e.uniform3fv(t.sphereLightPosition,i.sphere.positions),t.sphereLightData&&i.sphere.data.length>0&&e.uniform3fv(t.sphereLightData,i.sphere.data),t.diskLightColor&&i.disk.colors.length>0&&e.uniform3fv(t.diskLightColor,i.disk.colors),t.diskLightNormal&&i.disk.normals.length>0&&e.uniform3fv(t.diskLightNormal,i.disk.normals),t.diskLightUp&&i.disk.ups.length>0&&e.uniform3fv(t.diskLightUp,i.disk.ups),t.diskLightPosition&&i.disk.positions.length>0&&e.uniform3fv(t.diskLightPosition,i.disk.positions),t.diskLightData&&i.disk.data.length>0&&e.uniform3fv(t.diskLightData,i.disk.data),t.tubeLightColor&&i.tube.colors.length>0&&e.uniform3fv(t.tubeLightColor,i.tube.colors),t.tubeLightRight&&i.tube.rights.length>0&&e.uniform3fv(t.tubeLightRight,i.tube.rights),t.tubeLightPosition&&i.tube.positions.length>0&&e.uniform3fv(t.tubeLightPosition,i.tube.positions),t.tubeLightData&&i.tube.data.length>0&&e.uniform3fv(t.tubeLightData,i.tube.data),t.areaLightColor&&i.area.colors.length>0&&e.uniform3fv(t.areaLightColor,i.area.colors),t.areaLightPosition&&i.area.positions.length>0&&e.uniform3fv(t.areaLightPosition,i.area.positions),t.areaLightNormal&&i.area.normals.length>0&&e.uniform3fv(t.areaLightNormal,i.area.normals),t.areaLightUp&&i.area.ups.length>0&&e.uniform3fv(t.areaLightUp,i.area.ups),t.areaLightData&&i.area.data.length>0&&e.uniform3fv(t.areaLightData,i.area.data),(i.area.colors.length>0||i.tube.colors.length>0||i.disk.colors.length>0||i.sphere.colors.length>0)&&(t.precomputedAreaGGX1texture&&this.loadTexture(e,t.precomputedAreaGGX1texture,this.precomputedAreaGGX1texture),t.precomputedAreaGGX2texture&&this.loadTexture(e,t.precomputedAreaGGX2texture,this.precomputedAreaGGX2texture),t.precomputedAreaAshikmintexture&&this.loadTexture(e,t.precomputedAreaAshikmintexture,this.precomputedAreaAshikmintexture),t.precomputedAreaEsteveztexture&&this.loadTexture(e,t.precomputedAreaEsteveztexture,this.precomputedAreaEsteveztexture),t.precomputedAreaBeckmanntexture&&this.loadTexture(e,t.precomputedAreaBeckmanntexture,this.precomputedAreaBeckmanntexture))},this.loadUniformsShadow=function(t,i,r,n,a){if(!C&&!A){var s=i.uniformLocations;if(s.shadowMatrix){var o=0,l=[],h=[],c=[],d=[],u=[],p=[],f=[],g=[],m=[],v=[];this.shadowMapType===e.PCFPoissonShadowMap&&this.loadVector2Array(t,i,s.poissonDisk,"poissonDisk",F);for(var y=0,S=r.length;y<S;y++){if((V=r[y])instanceof e.SpotLight||V instanceof e.DirectionalLight&&!V.shadowCascade&&(!V.isVirtual||this.shadowMapCascade)){if(!V.castShadow)continue;if(V._sortKey===Q&&!a._needsIBLLightExtraction())continue;l[o]=V.shadowMap,h[o]=V.transparentShadowMap,c[o]=V.shadowMapSize,p[o]=V.shadowDarkness,u[o]=V.shadowCamera.far,d[o]=V.shadowCamera.near,f[o]=V.shadowBias,g[o]=V.shadowMatrix;var _=(new e.Vector3).getPositionFromMatrix(V.shadowCamera.matrixWorld);if(V.isVirtual){var x=e._SplitFloat32PositiveError(_.x),b=e._SplitFloat32PositiveError(_.y),w=e._SplitFloat32PositiveError(_.z);m[3*o]=x.high,m[3*o+1]=b.high,m[3*o+2]=w.high,v[3*o]=x.low,v[3*o+1]=b.low,v[3*o+2]=w.low}else m[3*o]=_.x,m[3*o+1]=_.y,m[3*o+2]=_.z,v[3*o]=e.SplitFloat32(_.x).low,v[3*o+1]=e.SplitFloat32(_.y).low,v[3*o+2]=e.SplitFloat32(_.z).low;o++}}s.shadowMap&&this.loadTextureArray(t,i,s.shadowMap,"shadowMap",l),s.transparentShadowMap&&(this.loadTextureArray(t,i,s.transparentShadowMap,"transparentShadowMap",h),s.directionalLightColorNoIntensity&&n.directional.colorsNoIntensity.length>0&&t.uniform3fv(s.directionalLightColorNoIntensity,n.directional.colorsNoIntensity),s.spotLightColorNoIntensity&&n.spot.colorsNoIntensity.length>0&&t.uniform3fv(s.spotLightColorNoIntensity,n.spot.colorsNoIntensity)),s.shadowMapSize&&this.loadVector2Array(t,i,s.shadowMapSize,"shadowMapSize",c),s.shadowDarkness&&t.uniform1fv(s.shadowDarkness,p),s.shadowBias&&t.uniform1fv(s.shadowBias,f),s.shadowMapNear&&t.uniform1fv(s.shadowMapNear,d),s.shadowMapFar&&t.uniform1fv(s.shadowMapFar,u),s.shadowCameraPosition&&t.uniform3fv(s.shadowCameraPosition,m),s.lowPartShadowCameraPosition&&t.uniform3fv(s.lowPartShadowCameraPosition,v),this.loadMatrix4Array(t,i,s.shadowMatrix,"shadowMatrix",g)}if(s.shadowMapCube){var M=0,P=[],E=[],T=[],D=[],I=[],R=[],O=[],L=[];for(y=0,S=r.length;y<S;y++){var V;if((V=r[y])instanceof e.PointLight){if(!V.castShadow)continue;P[M]=V.shadowMap,E[M]=V.transparentShadowMap,T[M]=V.shadowDarkness,D[M]=V.shadowBias,R[M]=V.shadowCameraNear,O[M]=V.shadowCameraFar,L[M]=V.shadowMapWidth,V.setupShadowPositions(I),M++}}this.loadTextureCubeArray(t,i,s.shadowMapCube,"shadowMapCube",P),s.transparentShadowMapCube&&(this.loadTextureCubeArray(t,i,s.transparentShadowMapCube,"",E),s.pointLightColorNoIntensity&&n.point.colorsNoIntensity.length>0&&t.uniform3fv(s.pointLightColorNoIntensity,n.point.colorsNoIntensity)),s.shadowDarknessCube&&t.uniform1fv(s.shadowDarknessCube,T),s.shadowFarCube&&t.uniform1fv(s.shadowFarCube,O),s.shadowNearCube&&t.uniform1fv(s.shadowNearCube,R),s.shadowBiasCube&&t.uniform1fv(s.shadowBiasCube,D),s.shadowPointPosition&&t.uniform3fv(s.shadowPointPosition,I),s.shadowMapSizeCube&&t.uniform1fv(s.shadowMapSizeCube,L)}}},this.loadUniformsPostProcess=function(e,t){var i=t.uniformLocations;this.inlinedPostProcess.activated&&(i.brightness&&e.uniform1f(i.brightness,this.inlinedPostProcess.brightness),i.crushblacks&&e.uniform1f(i.crushblacks,this.inlinedPostProcess.crushblacks),i.burnhighlights&&e.uniform1f(i.burnhighlights,this.inlinedPostProcess.burnhighlights),i.saturation&&e.uniform1f(i.saturation,this.inlinedPostProcess.saturation),i.colorCorrection&&e.uniform3f(i.colorCorrection,this.inlinedPostProcess.colorCorrection.x,this.inlinedPostProcess.colorCorrection.y,this.inlinedPostProcess.colorCorrection.z))},this.loadClippingUniforms=function(e,t){var i=this._clipPlanesState.uniforms;if(t.nbClipPlanes&&e.uniform1i(t.nbClipPlanes,i.nbClipPlanes.value),0!==i.nbClipPlanes.value&&(t.clipPlaneEquations&&i.clipPlaneEquations.value.length>0&&e.uniform4fv(t.clipPlaneEquations,i.clipPlaneEquations.value),t.clipPlaneActive&&i.clipPlaneActive.value.length>0&&e.uniform1iv(t.clipPlaneActive,i.clipPlaneActive.value),t.clipFrontOpacity&&e.uniform1f(t.clipFrontOpacity,i.clipFrontOpacity.value),t.clipBackOpacity&&e.uniform1f(t.clipBackOpacity,i.clipBackOpacity.value)),t.polygonSize&&e.uniform1iv(t.polygonSize,i.polygonSize.value),i.polygonSize.value&&0!==i.polygonSize.value[0]?(t.polygonPoints&&this.loadTexture(e,t.polygonPoints,i.polygonPoints.value),t.extrusionPlaneU&&e.uniform3fv(t.extrusionPlaneU,i.extrusionPlaneU.value),t.extrusionPlaneV&&e.uniform3fv(t.extrusionPlaneV,i.extrusionPlaneV.value)):t.polygonPoints&&this.loadTexture(e,t.polygonPoints,this._dummyTexture),t.scissorSize){var r=i.scissorSize.value;r&&0===r.length&&(r=[0]),e.uniform1iv(t.scissorSize,r)}t.scissorPoints&&(0!==i.scissorSize.value?this.loadTexture(e,t.scissorPoints,i.scissorPoints.value):this.loadTexture(e,t.scissorPoints,this._dummyTexture)),t.cylinderClipZone&&e.uniform1i(t.cylinderClipZone,i.cylinderClipZone.value),0!==i.cylinderClipZone.value&&(t.cylinderCenter&&e.uniform3f(t.cylinderCenter,i.cylinderCenter.value.x,i.cylinderCenter.value.y,i.cylinderCenter.value.z),t.cylinderAxisU&&e.uniform3f(t.cylinderAxisU,i.cylinderAxisU.value.x,i.cylinderAxisU.value.y,i.cylinderAxisU.value.z),t.cylinderAxisV&&e.uniform3f(t.cylinderAxisV,i.cylinderAxisV.value.x,i.cylinderAxisV.value.y,i.cylinderAxisV.value.z))},this.setDisableColorWrite=function(e){this.disableColorWrite=e},this.setDisableDepthWrite=function(e){this.disableDepthWrite=e},this.setDisableDepthTest=function(e){this.disableDepthTest=e},this.setEnableStencilWrite=function(e){this.enableStencilWrite=e},this.setDisableBackFaceCulling=function(e){this.disableBackFaceCulling=e},this.setFaceCulling=function(t,i){lt=0,ot=void 0,st=void 0,t===e.CullFaceNone?(be.disable(be.CULL_FACE),st=!0):(i===e.FrontFaceDirectionCW?be.frontFace(be.CW):be.frontFace(be.CCW),t===e.CullFaceBack?be.cullFace(be.BACK):t===e.CullFaceFront?be.cullFace(be.FRONT):be.cullFace(be.FRONT_AND_BACK),be.enable(be.CULL_FACE),st=!1)},this._hasClippingWithoutCapping=function(){return this.maxPolyLineSize>0?!this.useBackfaceCullingWithNoCapping&&!this.useCustomCappingForClipPolyline:this.useClippingCylinder&&this._clipPlanesState.value?!this.useBackfaceCullingWithNoCapping:!this.useBackfaceCullingWithNoCapping&&!(this.sectionCappingEnabled&&Ft.hasCapping)&&Ft.length>0},this.setMaterialFacesSimple=function(e,t,i,r){var n=e.doSetMaterialFaces,a=e.object,s=n.flipSided,o=n.doubleSided||this.disableBackFaceCulling||a._forceBackFacesOnSolid&&e.dg._dimension>=2&&!n.forceSide||r,l=a.orientation*i.orientation;st!==o&&(o?be.disable(be.CULL_FACE):be.enable(be.CULL_FACE),st=o),ot===s&&lt===l||(s?l>=0?be.frontFace(be.CW):be.frontFace(be.CCW):l>=0?be.frontFace(be.CCW):be.frontFace(be.CW),lt=l,ot=s)},this.setMaterialFacesSimpleDebug=function(t,i,r){var n=i.side===R.DoubleSide,a=i.side===R.BackSide,s=void 0!==t.object?t.object.orientation:1;void 0!==r&&(s*=r.orientation),t.object instanceof e.Mesh&&(s=-s),st!==n&&(n?be.disable(be.CULL_FACE):be.enable(be.CULL_FACE),st=n),ot===a&&lt===s||(a?s>=0?be.frontFace(be.CW):be.frontFace(be.CCW):s>=0?be.frontFace(be.CCW):be.frontFace(be.CW),lt=s,ot=a)},this.setMaterialFaces=function(e,t,i,r){var n=r&&3===t._bodyDim,a=e.side===R.BackSide,s=!n&&!a&&e.side!==R.FrontSide||this.disableBackFaceCulling,o=void 0!==t?t.orientation:1;void 0!==i&&(o*=i.orientation),st!==s&&(s?be.disable(be.CULL_FACE):be.enable(be.CULL_FACE),st=s),ot===a&&lt===o||(a?o>=0?be.frontFace(be.CW):be.frontFace(be.CCW):o>=0?be.frontFace(be.CCW):be.frontFace(be.CW),lt=o,ot=a)},this.setMaterialFacesDebug=function(t,i,r){var n=t.side===R.DoubleSide,a=t.side===R.BackSide,s=void 0!==i?i.orientation:1;void 0!==r&&(s*=r.orientation),i instanceof e.Mesh&&(s=-s),st!==n&&(n?be.disable(be.CULL_FACE):be.enable(be.CULL_FACE),st=n),ot===a&&lt===s||(a?s>=0?be.frontFace(be.CW):be.frontFace(be.CCW):s>=0?be.frontFace(be.CCW):be.frontFace(be.CW),lt=s,ot=a)},this.getDepthFunc=function(){return pt},this.setDepthFunc=function(e){pt!==e&&(be.depthFunc(e),pt=e)},this.setDepthTest=function(e){ut!==e&&(e?be.enable(be.DEPTH_TEST):be.disable(be.DEPTH_TEST),ut=e)},this.setColorWrite=function(e){ft!==e&&(e?be.colorMask(!0,!0,!0,!0):be.colorMask(!1,!1,!1,!1),ft=e)},this.setDepthWrite=function(e){gt!==e&&(be.depthMask(e),gt=e)},this.setStencilWrite=function(e){e!==mt&&(e?be.stencilMask(255):be.stencilMask(0),mt=e)},this.setPolygonOffset=function(e,t,i){vt!==e&&(e?be.enable(be.POLYGON_OFFSET_FILL):be.disable(be.POLYGON_OFFSET_FILL),vt=e),!e||yt===t&&St===i||(be.polygonOffset(t,i),yt=t,St=i)},this.setBlending=function(t,i,r,n){if(t!==be._oldBlending){switch(t){case e.NoBlending:be.disable(be.BLEND);break;case e.AdditiveBlending:be.enable(be.BLEND),be.blendEquation(be.FUNC_ADD),be.blendFunc(be.SRC_ALPHA,be.ONE);break;case e.SubtractiveBlending:be.enable(be.BLEND),be.blendEquation(be.FUNC_ADD),be.blendFunc(be.ZERO,be.ONE_MINUS_SRC_COLOR);break;case e.MultiplyBlending:be.enable(be.BLEND),be.blendEquation(be.FUNC_ADD),be.blendFunc(be.ZERO,be.SRC_COLOR);break;case e.CustomBlending:be.enable(be.BLEND);break;case e.NormalDepthBlending:be.enable(be.BLEND),be.blendEquationSeparate(be.FUNC_ADD,be.FUNC_ADD),be.blendFuncSeparate(be.ZERO,be.ONE,be.ONE,be.ZERO);break;case e.AlphaBlending:be.enable(be.BLEND),be.blendEquation(be.FUNC_ADD),be.blendFunc(be.SRC_ALPHA,be.ONE_MINUS_SRC_ALPHA);break;case e.GroundShadowBlending:be.enable(be.BLEND),be.blendEquationSeparate(be.FUNC_ADD,be.FUNC_ADD),be.blendFuncSeparate(be.ZERO,be.SRC_COLOR,be.ONE,be.ONE_MINUS_SRC_ALPHA);break;case e.TransparentShadowBlending:be.enable(be.BLEND),be.blendEquationSeparate(be.FUNC_ADD,be.FUNC_ADD),be.blendFuncSeparate(be.SRC_ALPHA,be.ONE_MINUS_SRC_ALPHA,be.ZERO,be.ONE_MINUS_SRC_ALPHA);break;case e.OITAccumBlending:be.enable(be.BLEND),be.blendEquation(be.FUNC_ADD),be.blendFunc(be.ONE,be.ONE);break;case e.OITRevealBlending:be.enable(be.BLEND),be.blendEquation(be.FUNC_ADD),be.blendFunc(be.ZERO,be.ONE_MINUS_SRC_COLOR);break;default:be.enable(be.BLEND),be.blendEquationSeparate(be.FUNC_ADD,be.FUNC_ADD),be.blendFuncSeparate(be.SRC_ALPHA,be.ONE_MINUS_SRC_ALPHA,be.ONE,be.ONE_MINUS_SRC_ALPHA)}be._oldBlending=t}t===e.CustomBlending?(i!==ht&&(be.blendEquation(ir(i)),ht=i),r===ct&&n===dt||(be.blendFunc(ir(r),ir(n)),ct=r,dt=n)):(ht=null,ct=null,dt=null)},this.initTexture=function(e,t){if(t)if(e.onUpdate){var i=e.onUpdate;e.onUpdate=function(){i(),t()}}else e.onUpdate=t;e._setupTexture(be,this,Qi,ir,rr,Ki,ui,null,Ht)},this.setTexture=function(t,i){t.onRequest&&t.onRequest();var r=t.isCubeMap&&t.isCubeMap();if(!r&&t.lods&&t.lods.length){var n=t.usedTexture;if(-1===n)t.lastUsedTexture=-1;else{var a=t.textures[n];a&&a.loadEndStatus===e.AssetLoadingStatus.READY?(a.__webglInit||this.__glResources__.textureLODPool.add({textureLOD:t,lod:n,size:a.image?4*a.image.width*a.image.height:0}),t.lastUsedTexture=n,t=a):-1!==t.lastUsedTexture&&(t=t.textures[t.lastUsedTexture])}this.__glResources__.textureLODPool.removeUnusedTextures()}if(t.needsUpdate)t._setupTexture(be,this,Qi,ir,rr,Ki,ui,i,Ht);else{if(!t.__webglTexture)return void this.setTexture(this._dummyTexture,i);be.activeTexture(be.TEXTURE0+i),be.bindTexture(r?be.TEXTURE_CUBE_MAP:be.TEXTURE_2D,t.__webglTexture)}},this.setRenderTarget=function(t){var i,r,n,a,s,o=t instanceof e.WebGLRenderTargetCube;if(t&&!t.__webglFramebuffer){void 0===t.depthBuffer&&(t.depthBuffer=!0),void 0===t.stencilBuffer&&(t.stencilBuffer=!0),t.addEventListener("dispose",pi),t.__webglTexture=be.createTexture(),_e.renderTargets++,this.__glResources__.renderTarget[t.uniqueID]=t;var l=Qi(t.width)&&Qi(t.height),h=ir(t.format),c=ir(t.type),d=rr(h,c,!0);if(o){t.__webglFramebuffer=[],t.__webglRenderbuffer=[],be.bindTexture(be.TEXTURE_CUBE_MAP,t.__webglTexture),Ki(be.TEXTURE_CUBE_MAP,t,l);for(var u=0;u<6;u++)t.__webglFramebuffer[u]=be.createFramebuffer(),t.shareDepthFrom?t.__webglRenderbuffer[u]=t.shareDepthFrom.__webglRenderbuffer[u]:t.__webglRenderbuffer[u]=be.createRenderbuffer(),be.texImage2D(be.TEXTURE_CUBE_MAP_POSITIVE_X+u,0,d,t.width,t.height,0,h,c,null),$i(t.__webglFramebuffer[u],t,be.TEXTURE_CUBE_MAP_POSITIVE_X+u),t.shareDepthFrom?t.depthBuffer&&!t.stencilBuffer?be.framebufferRenderbuffer(be.FRAMEBUFFER,be.DEPTH_ATTACHMENT,be.RENDERBUFFER,t.__webglRenderbuffer[u]):t.depthBuffer&&t.stencilBuffer&&be.framebufferRenderbuffer(be.FRAMEBUFFER,be.DEPTH_STENCIL_ATTACHMENT,be.RENDERBUFFER,t.__webglRenderbuffer[u]):er(t.__webglRenderbuffer[u],t);l&&be.generateMipmap(be.TEXTURE_CUBE_MAP)}else t.__webglFramebuffer=be.createFramebuffer(),t.shareDepthFrom?t.__webglRenderbuffer=t.shareDepthFrom.__webglRenderbuffer:t.__webglRenderbuffer=be.createRenderbuffer(),be.bindTexture(be.TEXTURE_2D,t.__webglTexture),Ki(be.TEXTURE_2D,t,l),be.texImage2D(be.TEXTURE_2D,0,d,t.width,t.height,0,h,c,null),$i(t.__webglFramebuffer,t,be.TEXTURE_2D),t.shareDepthFrom?t.depthBuffer&&!t.stencilBuffer?be.framebufferRenderbuffer(be.FRAMEBUFFER,be.DEPTH_ATTACHMENT,be.RENDERBUFFER,t.__webglRenderbuffer):t.depthBuffer&&t.stencilBuffer&&be.framebufferRenderbuffer(be.FRAMEBUFFER,be.DEPTH_STENCIL_ATTACHMENT,be.RENDERBUFFER,t.__webglRenderbuffer):er(t.__webglRenderbuffer,t),l&&be.generateMipmap(be.TEXTURE_2D);o?be.bindTexture(be.TEXTURE_CUBE_MAP,null):be.bindTexture(be.TEXTURE_2D,null),be.bindRenderbuffer(be.RENDERBUFFER,null),be.bindFramebuffer(be.FRAMEBUFFER,null)}else if(t&&(t.minFilter!==t.originalMinFilter||t.magFilter!==t.originalMagFilter)){l=Qi(t.width)&&Qi(t.height);o?(be.bindTexture(be.TEXTURE_CUBE_MAP,t.__webglTexture),Ki(be.TEXTURE_CUBE_MAP,t,l),be.bindTexture(be.TEXTURE_CUBE_MAP,null)):(be.bindTexture(be.TEXTURE_2D,t.__webglTexture),Ki(be.TEXTURE_2D,t,l),be.bindTexture(be.TEXTURE_2D,null)),t.originalMinFilter=t.minFilter,t.originalMagFilter=t.magFilter}t?(i=o?t.__webglFramebuffer[t.activeCubeFace]:t.__webglFramebuffer,Xe.RTTmatchViewport?(r=wt,n=Mt,a=xt,s=bt):(r=t.width,n=t.height,a=0,s=0)):(i=this._VRFrameBuffer?this._VRFrameBuffer:null,r=wt,n=Mt,a=xt,s=bt),i!==e.glStates.currentFramebuffer&&(be.bindFramebuffer(be.FRAMEBUFFER,i),e.glStates.currentFramebuffer=i),e.glStates.currentWidth===r&&e.glStates.currentHeight===n||(be.viewport(a,s,r,n),e.glStates.currentWidth=r,e.glStates.currentHeight=n)},this.getSupportedExtensions=function(){return e.supportedExtensions},this.packESM=!1,this._gpuPickingTolerance=0,this._smallTargetPicking=0,this.useOIT=!1,this.useSSLR=!1,this.useSSLRefraction=!1,this.precomputedTexture=null,this.boundaryEdgeMaterialInfo={color:new e.Color(255),enabled:!1},this.precomputedAreaGGX1texture=null,this.precomputedAreaGGX2texture=null,this.precomputedAreaAshikmintexture=null,this.precomputedAreaEsteveztexture=null,this.precomputedAreaBeckmanntexture=null,this.materialToUse=e.MaterialToUse.originalMaterial,this._forbidRenderableState=0,this.shadowMapSoft=!1,this.gpuAntiAliasing=!1,this.forceMaterialDoubleSide=!0,this.cuttingScene=null,this.backupCuttingMaterial=null,this.cameraSystem_cameraIndex=-1},e.GeometryUtils={center:function(t){t.computeBoundingBox();var i=t.boundingBox,r=new e.Vector3;return r.addVectors(i.min,i.max),r.multiplyScalar(-.5),t.applyMatrix((new e.Matrix4).makeTranslation(r.x,r.y,r.z)),t.computeBoundingBox(),r}},e.BasisUsage=A.BasisUsage,e.ImageUtils=A.Utils,e.FontUtils=E.FontUtils,self._typeface_js={faces:e.FontUtils.faces,loadFace:e.FontUtils.loadFace},e.LineCurve=P.LineCurve,e.QuadraticBezierCurve=P.QuadraticBezierCurve,e.CubicBezierCurve=P.CubicBezierCurve,e.SplineCurve=P.SplineCurve,e.EllipseCurve=P.EllipseCurve,e.LineCurve3=P.LineCurve3,e.QuadraticBezierCurve3=P.QuadraticBezierCurve3,e.CubicBezierCurve3=P.CubicBezierCurve3,e.SplineCurve3=P.SplineCurve3,e.ClosedSplineCurve3=P.ClosedSplineCurve3,e.CurvePath=P.CurvePath,e.Path=P.Path,e.PathActions=P.PathActions,e.Shape=E.Shape,e.CubeGeometry=C.CubeGeometry,e.CircleGeometry=C.CircleGeometry,e.CylinderGeometry=C.CylinderGeometry,e.ExtrudeGeometry=C.ExtrudeGeometry,e.ShapeGeometry=C.ShapeGeometry,e.PlaneGeometry=C.PlaneGeometry,e.SphereGeometry=C.SphereGeometry,e.TextGeometry=C.TextGeometry,e.CameraHelper=function(t){e.Line.call(this);var i=this;this._tokens={},this.geometry=new e.Geometry,this.material=new e.LineBasicMaterial({color:16777215,vertexColors:e.VertexColorType.Face}),this.type=e.LinePieces,this.matrixWorld=t.matrixWorld,this.matrixAutoUpdate=!1,this.frustumCulled=!1,this.pointMap={};function r(e,t,i){n(e,i),n(t,i)}function n(t,r){i.geometry.vertices.push(new e.Vector3),i.geometry.colors.push(new e.Color(r)),void 0===i.pointMap[t]&&(i.pointMap[t]=[]),i.pointMap[t].push(i.geometry.vertices.length-1)}r("n1","n2",16755200),r("n2","n4",16755200),r("n4","n3",16755200),r("n3","n1",16755200),r("f1","f2",16755200),r("f2","f4",16755200),r("f4","f3",16755200),r("f3","f1",16755200),r("n1","f1",16755200),r("n2","f2",16755200),r("n3","f3",16755200),r("n4","f4",16755200),r("p","n1",16711680),r("p","n2",16711680),r("p","n3",16711680),r("p","n4",16711680),r("u1","u2",43775),r("u2","u3",43775),r("u3","u1",43775),r("c","t",16777215),r("p","c",3355443),r("cn1","cn2",3355443),r("cn3","cn4",3355443),r("cf1","cf2",3355443),r("cf3","cf4",3355443),this.camera=t,this.update(t)},e.CameraHelper.prototype=Object.create(e.Line.prototype),e.CameraHelper.prototype.update=function(){var t=this;function i(i,r,n,a){e.CameraHelper.__v.set(r,n,a),e.CameraHelper.__projector.unprojectVector(e.CameraHelper.__v,e.CameraHelper.__c);var s=t.pointMap[i];if(void 0!==s)for(var o=0,l=s.length;o<l;o++)t.geometry.vertices[s[o]].copy(e.CameraHelper.__v)}e.CameraHelper.__c.projectionMatrix.copy(this.camera.projectionMatrix),i("c",0,0,-1),i("t",0,0,1),i("n1",-1,-1,-1),i("n2",1,-1,-1),i("n3",-1,1,-1),i("n4",1,1,-1),i("f1",-1,-1,1),i("f2",1,-1,1),i("f3",-1,1,1),i("f4",1,1,1),i("u1",.7,1.1,-1),i("u2",-.7,1.1,-1),i("u3",0,2,-1),i("cf1",-1,0,1),i("cf2",1,0,1),i("cf3",0,-1,1),i("cf4",0,1,1),i("cn1",-1,0,-1),i("cn2",1,0,-1),i("cn3",0,-1,-1),i("cn4",0,1,-1),this.geometry.verticesNeedUpdate=!0},e.CameraHelper.__projector=new e.Projector,e.CameraHelper.__v=new e.Vector3,e.CameraHelper.__c=new e.Camera,e.LensFlare=function(t,i,r,n,a){e.Object3D.call(this),this.lensFlares=[],this.positionScreen=new e.Vector3,this.customUpdateCallback=void 0,void 0!==t&&this.add(t,i,r,n,a)},e.LensFlare.prototype=Object.create(e.Object3D.prototype),e.LensFlare.prototype.add=function(t,i,r,n,a,s){void 0===i&&(i=-1),void 0===r&&(r=0),void 0===s&&(s=1),void 0===a&&(a=new e.Color(16777215)),void 0===n&&(n=e.NormalBlending),r=Math.min(r,Math.max(0,r)),this.lensFlares.push({texture:t,size:i,distance:r,x:0,y:0,z:0,scale:1,rotation:1,opacity:s,color:a,blending:n})},e.LensFlare.prototype.updateLensFlares=function(){var e,t,i=this.lensFlares.length,r=2*-this.positionScreen.x,n=2*-this.positionScreen.y;for(e=0;e<i;e++)(t=this.lensFlares[e]).x=this.positionScreen.x+r*t.distance,t.y=this.positionScreen.y+n*t.distance,t.wantedRotation=t.x*Math.PI*.25,t.rotation+=.25*(t.wantedRotation-t.rotation)},e}),define("Visualization/ThreeJS_R57",["DS/Visualization/ThreeJS_R57","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ThreeJS_R57"),e}),define("DS/Visualization/SubsurfaceGenerator",["DS/Visualization/ThreeJS_R57"],function(e){"use strict";var t=function(){this.computedTextures=new Map,this.size=64,this.radiusR=null,this.depthR=null,this.radiusG=null,this.depthG=null,this.radiusB=null,this.depthB=null;var e=this.utilities.linspace(-1,1,this.size);this.theta=this.utilities.applyToArray(e,function(e){return Math.acos(e)}),this.sinTheta=this.utilities.applyToArray(this.theta,function(e){return e>.5*Math.PI?0:Math.sin(e)}),this.aux=Math.PI*Math.PI*Math.sqrt(.31830988618)/this.size};return t.prototype={constructor:t,modelFunction:function(e){var t=e.scatteringCoeffs,i=Math.max(Math.min(e.subsurfaceAnisotropy,.99),-.99);t=this.utilities.applyToArray(t,function(e){return e*(1-i)});var r=this.utilities.sumArray(e.absorptionCoeffs,t),n=this.utilities.applyToArray(this.utilities.multiplyArray(e.absorptionCoeffs,r),function(e){return Math.sqrt(3*e)}),a=-1.44/(e.eta*e.eta)+.71/e.eta+.668+.0636*e.eta,s=(1+a)/(1-a),o=this.utilities.applyToArray(r,function(e){return 1/Math.max(e,1e-20)}),l=this.utilities.applyToArray(o,function(e){return 4*s/3*e}),h=this.utilities.applyToArray(o,function(e){return 5*e});this.depthR=this.utilities.linspace(0,15*o[0],this.size),this.radiusR=this.utilities.linspace(.5*o[0],7.5*o[0],this.size),this.depthG=this.utilities.linspace(0,15*o[1],this.size),this.radiusG=this.utilities.linspace(.5*o[1],7.5*o[1],this.size),this.depthB=this.utilities.linspace(0,15*o[2],this.size),this.radiusB=this.utilities.linspace(.5*o[2],7.5*o[2],this.size);var c=this.utilities.multiplyArray(t,o),d=function(e,t){return(t*e+1)*Math.exp(-t*e)/(e*e*e)},u=.25/Math.PI,p=function(e,t){for(var i=n[e],r=o[e],a=l[e],s=h[e],p=0,f=-2;f<=2;f++){var g=2*f*(s+a),m=g+r,v=g-r-a,y=Math.sqrt(t*t+m*m),S=Math.sqrt(t*t+v*v);p+=m*d(y,i)-v*d(S,i)}var _=c[e];return p*u*_};return{red:function(e){return p(0,e)},green:function(e){return p(1,e)},blue:function(e){return p(2,e)}}},sssLUTBuilder:function(e,t,i){return this.utilities.integrate(function(r){var n=t*Math.abs(2*Math.sin(.5*r));return Math.max(Math.cos(i+r),0)*e(n)},-Math.PI,Math.PI)/Math.max(this.utilities.integrate(function(i){var r=t*Math.abs(2*Math.sin(.5*i));return e(r)},-Math.PI,Math.PI),1e-20)},translucencyLUTBuilder:function(e,t,i){return this.utilities.integrateT(function(i){return 2*Math.PI*i*e(Math.sqrt(i*i+t*t))},i[this.size-1])},setTexture:function(t,i,r){var n=new e.DataTexture(t,i,r,e.RGBFormat,e.FloatType);return n.minFilter=e.LinearFilter,n.magFilter=e.LinearFilter,n.generateMipmaps=!1,n.flipY=!1,n.needsUpdate=!0,n},decreaseUseCount:function(e){if(this.computedTextures.has(e)){var t=this.computedTextures.get(e);t.useCount--,0===t.useCount&&(t.textures.sssLUT.dispose(),this.computedTextures.delete(e))}},dispose:function(){this.computedTextures.forEach(function(e,t,i){e.textures.sssLUT.dispose()}),this.computedTextures.clear()},_getComputedTextures:function(e){var t=-1;return this.computedTextures.forEach(function(i,r,n){var a,s,o,l,h,c,d;a=i.options,s=e,o=Math.abs(a.scatteringCoeffs[0]-s.scatteringCoeffs[0])<1e-6&&Math.abs(a.scatteringCoeffs[1]-s.scatteringCoeffs[1])<1e-6&&Math.abs(a.scatteringCoeffs[2]-s.scatteringCoeffs[2])<1e-6,l=Math.abs(a.absorptionCoeffs[0]-s.absorptionCoeffs[0])<1e-6&&Math.abs(a.absorptionCoeffs[1]-s.absorptionCoeffs[1])<1e-6&&Math.abs(a.absorptionCoeffs[2]-s.absorptionCoeffs[2])<1e-6,h=Math.abs(a.color[0]-s.color[0])<1e-6&&Math.abs(a.color[1]-s.color[1])<1e-6&&Math.abs(a.color[2]-s.color[2])<1e-6,c=Math.abs(a.eta-s.eta)<1e-6,d=Math.abs(a.subsurfaceAnisotropy-s.subsurfaceAnisotropy)<1e-6,o&&l&&c&&h&&d&&(i.useCount++,t=r)}),t>-1?this.computedTextures.get(t).textures:null},compute:function(t){var i=this._getComputedTextures(t);if(null!==i)return i;for(var r=Date.now(),n=this.modelFunction(t),a=this.size+2+3+2+3,s=new Float32Array(this.size*a*3),o=this.size+2,l=this.size+7,h=t.color,c=0;c<this.size;c++){for(var d=this.radiusR[c],u=this.radiusG[c],p=this.radiusB[c],f=0,g=0,m=0,v=0;v<this.size;v++){var y,S,_,x=this.theta[v];y=h[0]*this.sssLUTBuilder(n.red,d,x),_=h[1]*this.sssLUTBuilder(n.green,u,x),S=h[2]*this.sssLUTBuilder(n.blue,p,x),s[3*this.size*c+3*v+0]=y,s[3*this.size*c+3*v+1]=_,s[3*this.size*c+3*v+2]=S,c==this.size-1&&(s[3*this.size*this.size+3*v+0]=y,s[3*this.size*this.size+3*v+1]=_,s[3*this.size*this.size+3*v+2]=S),f+=y*this.sinTheta[v],g+=_*this.sinTheta[v],m+=S*this.sinTheta[v]}f*=this.aux,g*=this.aux,m*=this.aux;for(var b=this.depthR[c],w=this.depthG[c],M=this.depthB[c],C=this.translucencyLUTBuilder(n.red,b,this.depthR),P=this.translucencyLUTBuilder(n.green,w,this.depthG),E=this.translucencyLUTBuilder(n.blue,M,this.depthB),A=0;A<3;A++){var T=this.size*(o+A);s[3*T+3*c+0]=f,s[3*T+3*c+1]=g,s[3*T+3*c+2]=m;var D=this.size*(l+A);s[3*D+3*c+0]=C,s[3*D+3*c+1]=P,s[3*D+3*c+2]=E}}var I=this.setTexture(s,this.size,this.size+5+5),R=Date.now();e.VisualizationTraces.info((R-r)/1e3);var O={sssLUT:I,translucencyDepth:[this.depthR[this.size-1],this.depthG[this.size-1],this.depthB[this.size-1]]};return this.computedTextures.set(I.id,{textures:O,options:{eta:t.eta,absorptionCoeffs:t.absorptionCoeffs.slice(0),scatteringCoeffs:t.scatteringCoeffs.slice(0),subsurfaceAnisotropy:t.subsurfaceAnisotropy,color:t.color.slice(0)},useCount:1}),O},toImage:function(){var e=document.createElement("canvas");document.body.appendChild(e);var t=e.getContext("2d"),i=this;this.computedTextures.forEach(function(r,n,a){!function(r,n,a,s){e.height=a,e.width=n;for(var o=0;o<a;++o)for(var l=0;l<n;++l)t.fillStyle="rgb("+255*r[3*i.size*o+3*l]+", "+255*r[3*i.size*o+3*l+1]+",+"+255*r[3*i.size*o+3*l+2]+")",t.fillRect(l,o,1,1);var h=e.toDataURL("image/png"),c=document.createElement("a");c.download=s,c.innerHTML="Download File",c.href=h,c.click()}(r.textures.sssLUT.image.data,r.textures.sssLUT.image.width,r.textures.sssLUT.image.height,"sssLUT")})},utilities:{linspace:function(e,t,i){var r=Math.floor(i);if(r<=1)return[t];for(var n=(t-e)/(i-1),a=[],s=0;s<r;s++)a[s]=e+s*n;return a},sumElements:function(e){for(var t=0,i=0;i<e.length;i++)t+=e[i];return t},multiplyArray:function(e,t){for(var i=Math.min(t.length,e.length),r=[],n=0;n<i;n++)r[n]=e[n]*t[n];return r},sumArray:function(e,t){for(var i=Math.min(t.length,e.length),r=[],n=0;n<i;n++)r[n]=e[n]+t[n];return r},applyToArray:function(e,t){for(var i=[],r=0;r<e.length;r++)i[r]=t(e[r]);return i},integrate:function(e,t,i){var r=this.linspace(t,i,120),n=this.applyToArray(r,e);return.5*(i-t)/120*(2*this.sumElements(n)-n[119]-n[0])},integrateT:function(e,t){var i=this.linspace(0,t,1e3),r=this.applyToArray(i,e);return.5*t/1e3*(2*this.sumElements(r)-r[999]-r[0])}}},t}),define("DS/Visualization/AmbianceGenerator",["DS/CoreEvents/Events","UWA/Class","DS/Effects/ConvertLatLongToDualParaboloid","DS/Effects/GenerateMipMaps","DS/Effects/ComputeMipMapRoughness","DS/Visualization/ThreeJS_R57"],function(e,t,i,r,n,a){"use strict";var s=a._AmbianceGenerators,o=t.extend({init:function(t,n){this.nbSamples=n,this.onDoneCallBack=null,this.texture=null,this.mode=null,a.EventDispatcher.call(this),this.finished=!1;var o=this;this.addEventListener("done",function(t){t.isDone&&s.viewers.forEach(function(e){e.render()}),t.isDone&&(a.VisualizationTraces.info("INFO: Finished computing ambiance"),e.publish({event:"/VISU/IBLComputed",data:{eventChannel:"/VISU/IBLComputed",eventType:"@onIBLComputed"}})),o.onDoneCallBack&&t.isDone&&o.onDoneCallBack()}),this.renderer=t.renderer.renderer,this.convertEffect=new i(this.renderer,t.renderer.renderTargetPool),this.mipMapEffect=new r(this.renderer,t.renderer.renderTargetPool),this.computeEffect=null,this.frameIndex=0,this.init=!1},dispose:function(){this.convertEffect.dispose(),this.convertEffect=null,this.mipMapEffect.dispose(),this.mipMapEffect=null,this.computeEffect.dispose(),this.computeEffect=null,this.init=!1},_setNbSamples:function(){console.warn("A virtual function has been called")},setValues:function(e,t){if(e){this.texture=e;var i=e.composerContext&&e.composerContext.width,r=e.composerContext&&e.composerContext.height;if(e instanceof a.Texture){if(e.loadEndStatus!==a.AssetLoadingStatus.READY)return;i=e.image.width,r=e.image.height}else e instanceof a.WebGLRenderTarget&&(i=e.width,r=e.height);this.convertEffect.setSize(i,r),this.mipMapEffect.setSize(i,r),this.computeEffect.setSize(i,r),this.convertEffect.setEnvMap(e),this.mipMapEffect.setInput(this.convertEffect.composers[0]),this.mode=t,this.init=!0}},_execute:function(e){this.init&&(e&&(this.convertEffect.execute(),this.mipMapEffect.execute(),this.computeEffect.setInput(this.mipMapEffect.getResult().composerContext.getResult(void 0,!0)),this._setNbSamples(),this.computeEffect.setMode(this.mode)),this.computeEffect.execute())},_getResult:function(){if(!this.init)return{};var e=this.isDone();e&&a._SaveGeneratedRoughnessMaps&&this.computeEffect._saveResult();var t=this.computeEffect.composers[this.computeEffect.nbMipMaps].composerContext.getResult(void 0,e);return t&&(t.hdr=!0,t.hasDiffuse=0===this.computeEffect.modeValue,t.mapping=new a.LatLongReflectionMapping),t},setCallBack:function(e){this.onDoneCallBack=e},isDone:function(){return this.finished}}),l=o.extend({init:function(e,t){this._parent(e,t),this.computeEffect=new n.ComputeMipMapRoughnessFIS(this.renderer,e.renderer.renderTargetPool)},_isExecuteReady:function(){var e=!this.texture.loadEndStatus||this.texture.loadEndStatus===a.AssetLoadingStatus.READY;return s.viewers.forEach(function(t){e=e&&!t._renderingToTarget}),e},execute:function(){var e=Date.now(),t=this._isExecuteReady();return t&&(this._execute(!0),this.finished=!0,this.dispatchEvent({type:"done",time:e,isDone:this.isDone()})),t?this._getResult():null},_setNbSamples:function(){this.computeEffect.setNbSamples(this.nbSamples)}}),h=o.extend({init:function(e,t){this._parent(e,t),this.timeFactor=a._mobileDevice?1.5:1,this.computeEffect=new n.ComputeMipMapRoughnessIterative(this.renderer,e.renderer.renderTargetPool)},_isExecuteReady:function(e){var t=0===this.computeEffect.iter||!this.texture.loadEndStatus||this.texture.loadEndStatus===a.AssetLoadingStatus.READY,i=this;return s.viewers.forEach(function(r){t=t&&!r._QMMode&&r.renderIteration>0&&e-r.timeIter0>i.timeFactor*r.delayBeforeIteration&&!r._renderingToTarget}),t},execute:function(){var e=Date.now(),t=this._isExecuteReady(e);return t&&(this._execute(0===this.computeEffect.iter),this.finished=this.computeEffect.iter>=this.computeEffect.nbIterations,this.dispatchEvent({type:"done",time:e,iteration:this.computeEffect.iter,isDone:this.isDone()})),t?this._getResult():null},_setNbSamples:function(){this.computeEffect.setNbSamples(this.nbSamples)}});return t.extend({init:function(e){this.generators=new Map,this.generated=new Map,this.toCompute=[],this.cb=e},_getViewer:function(){return s.viewers[0]},_getGenerator:function(e,t){if(t&&(e+="-iterative"),!this.generators.has(e)){var i=this._getViewer(),r=t?new h(i,512):new l(i,512);this.cb&&r.setCallBack(this.cb),this.generators.set(e,r)}return this.generators.get(e)},_getAmbiance:function(e,t){return t&&(e+="-iterative"),this.generated.get(e)},_updateAmbiance:function(e,t,i,r,n){i&&(t+="-iterative"),this.generated.set(t,{ambiance:e,complete:r,usedBy:n})},_disposeGenerator:function(e,t){if(t&&(e+="-iterative"),this.generators.has(e)){var i=this.generators.get(e);this.generators.delete(e),i.dispose()}},_setCB:function(e){this.cb=e,this.generators.forEach(function(t,i,r){t.setCallBack(e)})},getAmbiance:function(e,t,i,r){var n=e;t&&(e+="-iterative"),this.generated.has(e)||(this.generated.set(e,{ambiance:s._dummyRoughnessTexture,complete:!1,usedBy:new Set}),this.toCompute.push({name:n,iterative:t,hdr:i.hdr,brdf:i.brdf}));var a=this.generated.get(e);return a.usedBy.add(r),a},keep:function(e){var t=null;return this.generated.forEach(function(i,r,n){i.usedBy.has(e)&&(1!==i.usedBy.size?console.error("Internal roughness map, access refused"):i.ambiance!==dummyTexture&&i.ambiance.complete?(i.usedBy.delete(e),t=i.ambiance,n.delete(r)):console.error("Roughness map not finished, access refused"))}),t},decreaseUseCount:function(e){if(e){var t=this;this.generated.forEach(function(i,r,n){if(i.usedBy.delete(e),i.usedBy.size<1&&(i.ambiance&&i.ambiance.dispose(),n.delete(r),t.generators.has(r))){var a=t.generators.get(r);t.generators.delete(r),a.dispose()}})}},dispose:function(){this.generated.forEach(function(e,t,i){e.ambiance.dispose()}),this.generated.clear(),this.generators.forEach(function(e,t,i){e.dispose()}),this.generators.clear(),this.toCompute=[]},_needsUpdate:function(){for(var e=this.toCompute,t=0;t<e.length;t++){var i=e[t],r=this._getAmbiance(i.name,i.iterative);if(r&&!r.complete)return!0}return!1},update:function(e,t){for(var i=this.toCompute,r=0,n=!1,a=0;a<i.length;a++){var o=i[a],l=this._getAmbiance(o.name,o.iterative);if(l&&!l.complete){var h=this._getGenerator(o.name,o.iterative);if(h.init||h.setValues(o.hdr,o.brdf),h.init&&h.renderer===t&&h.frameIndex<e&&!h.isDone()){var c=h.execute();c&&(n=!0,this._updateAmbiance(c,o.name,o.iterative,h.isDone(),l.usedBy)),h.frameIndex=e,h.isDone()&&(this._disposeGenerator(o.name,o.iterative),r++)}}else this._disposeGenerator(o.name,o.iterative),r++}return r===i.length&&(this.toCompute=[],this.generators.clear()),s.viewers.forEach(function(e){e.forceRender=!0}),n}})}),define("DS/Visualization/OccurrenceRenderingOverride",["UWA/Class","DS/Visualization/ThreeJS_R57"],function(e,t){"use strict";var i,r=function(e,t){this.id=i.getNewId(),this.materialOverride=t instanceof r?t.materialOverride:t,this.opacity=e.opacity,this.renderPriorityActivated=!1};r.prototype.getOpacity=function(){return this.materialOverride?this.materialOverride.getOpacity():null},r.prototype.getColor=function(){return this.materialOverride?this.materialOverride.getColor():null},r.prototype.getFullMaterial=function(){return this.materialOverride?this.materialOverride.getFullMaterial():null},r.prototype.clone=function(){return new r({opacity:this.opacity},this.materialOverride)},r.prototype.getRenderPriorityOpacity=function(){return null===this.opacity?null:this.opacity},r.prototype.hasTransparency=function(){var e=this.getOpacity();return null!==e&&e<1},r.prototype.isPGPOnly=function(){return!1};var n=0,a=new WeakMap;function s(e){var t;return a.has(e)?t=a.get(e):(t=n++,a.set(e,t)),t}var o=0,l=e.extend({init:function(){this.id=o++,this.clipPlanes=[],this.clippingContext=null,this.clipPolyLine=null,this.clipCylinder=null,this.scissor=null,this.materialOverride=null,this.sectionCappingMaterials=null,this.sectionLinesProperties=null},clone:function(){var e=new l;return e.clipPlanes=this.clipPlanes,e.clippingContext=this.clippingContext,e.clipPolyLine=this.clipPolyLine,e.clipCylinder=this.clipCylinder,e.scissor=this.scissor,e.sectionLinesProperties=this.sectionLinesProperties,this.materialOverride instanceof r?e.materialOverride=this.materialOverride.clone():e.materialOverride=this.materialOverride,e},getFullMaterial:function(e){return this.materialOverride&&this.materialOverride.getFullMaterial(e)},getClippingSettings:function(){return this.clippingContext&&this.clippingContext.clippingSettings},setRenderPriority:function(e){e&&null!==e.opacity&&(this.materialOverride=new r(e,this.materialOverride))},getOverrideColor:function(e){if(!this.materialOverride)return null;if(e&&!e.overridable)return e.overridable;var i=this.getFullMaterial();if(i&&!i.overridable)return i.color;var r=this.materialOverride.getColor();return 0!==r&&r?new t.Color(r):null},isPurePGP:function(){return!this.clipPolyLine&&!this.scissor&&this.materialOverride&&this.materialOverride.isPGPOnly()&&!this.sectionCappingMaterials},getGSSOId:function(e){if(e){var t,i="";if(this.clipPlanes)for(t=0;t<this.clipPlanes.length;t++)i+="p"+s(this.clipPlanes[t]);return this.clippingContext&&(i+="k"+this.clippingContext.id),i+=this.materialOverride.getPGPGSSOId()}return""+this.id}});return l.setOverrideLink2Class=function(e){i=e},l}),define("Visualization/OccurrenceRenderingOverride",["DS/Visualization/OccurrenceRenderingOverride","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/OccurrenceRenderingOverride"),e}),define("DS/Visualization/BufferGeometry",["DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh","DS/Visualization/WidelinesHelper"],function(e,t,i){"use strict";class r{constructor({gl:e}){this.buffer=e.createBuffer(),this.nbGeometries=0,this.isShared=!1}deallocate(e,t){this.nbGeometries--,0===this.nbGeometries&&(t&&this.isShared&&t.memory.sharedbuffers--,e.deleteBuffer(this.buffer),this.buffer=null)}}e.GLIndexBuffer=class extends r{constructor({gl:e,numIndices:t=0,use32bitIndexBuffer:i=!1,data:r=null}){super({gl:e}),this.use32bitIndexBuffer=i,this.numIndices=t,r&&(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,r,e.STATIC_DRAW),this.use32bitIndexBuffer=r instanceof Uint32Array,this.numIndices=r.length)}get byteLength(){return this.numIndices*this.bytesPerIndex}get bytesPerIndex(){return this.use32bitIndexBuffer?4:2}get glFormat(){return this.use32bitIndexBuffer?5125:5123}};let n=0;e.GLVertexBuffer=class extends r{constructor({gl:e}){super({gl:e}),this.numVertices=0,this.interleavedData=null,this.id=n++,this.layout=null,this.needsUpdate=!1}};class a{constructor(){this.clear()}clear(){this._attributes=new Map}clone(){const e=new a;return this._attributes.forEach((t,i)=>e._attributes.set(i,Object.assign({},t))),e}set(e){for(let t in e)this.setAttribute(Object.assign({name:t},e[t]))}setAttribute({name:t,type:i,offset:r,stride:n,bufferId:a=0}){if(!e.VertexAttribute[i])throw new Error(`Vertex attribute '${t}': unknown type (${i}), see GPUFormats.VertexAttribute for acceptable data types`);if(r<0||r>=n)throw new Error(`Invalid offset/stride, expected 0 <= offset (${r}) < stride (${n})`);this._attributes.set(t,{name:t,type:i,offset:r,bufferId:a,stride:n})}remove(e){this._attributes.delete(e)}get(e){return this._attributes.get(e)}has(e){return this._attributes.has(e)}getNames(){return[...this._attributes.keys()]}size(){return this._attributes.size}forEach(e){this._attributes.forEach(t=>e(t))}getSignature(){let e=[];return this._attributes.forEach(t=>e.push(`|${t.name}:${t.type}>`)),e.sort().join()}getBufferStrides(){const e=[];return this._attributes.forEach(t=>e[t.bufferId]=t.stride),e}getBufferAttributes(){const e=[];return this._attributes.forEach(t=>{e[t.bufferId]?e[t.bufferId].push(t.name):e[t.bufferId]=[t.name]}),e}pickAnyAttribute({bufferId:e=-1}={}){if(0===this.size())return null;const t=this._attributes.values();if(e<0)return t.next().value;for(let i=t.next();!i.done;i=t.next())if(i.value.bufferId===e)return i.value;return null}isFullInterleaved(){return!!this.getFullInterleaving()}getFullInterleaving(){if(0===this._attributes.size)return;const e=this._attributes.values();let t=e.next().value,i=t.bufferId,r=t.stride;for(let n=e.next();!n.done;n=e.next())if(i!==(t=n.value).bufferId||r!==t.stride)return;return{bufferId:i,stride:r}}interleave({order:t=null,targetBufferId:i=0,allAttributes:r=!0}={}){if(r)if(t){const e=new Set(t);for(let i of this._attributes.keys())e.has(i)||t.push(i)}else t=this.getNames();else if(!t)return;let n=0;for(let r=0;r<t.length;r++){const a=this._attributes.get(t[r]);a&&(a.offset=n,a.bufferId=i,n+=e.VertexAttribute[a.type].size)}for(let e=0;e<t.length;e++){const i=this._attributes.get(t[e]);i&&(i.stride=n)}}}e.VertexLayout=a;var s=function(e,t,i){this.parentGeometry=e,this.linkedGeometry=t,this.attrName=i;var r,n,a=this;this.parentGeometry[i]=this,this.linkedGeometry[i]=this,r=function(){a.parentGeometry.removeEventListener("dispose",r),a.linkedGeometry.dispose()},this.parentGeometry.addEventListener("dispose",r),n=function(){a.linkedGeometry.removeEventListener("dispose",n),a.parentGeometry[i]=null,a.linkedGeometry[i]=null},this.linkedGeometry.addEventListener("dispose",n)};s.prototype._isParent=function(e){return this.parentGeometry===e};var o=function(e,t){s.call(this,e,t,"wideLinesLinker"),this.lineStructureMap=new Map,this.originalDGToWideDG=new Map};function l(){throw new Error("No data for this attribute")}o.prototype=Object.create(s.prototype);class h{constructor(){e.EventDispatcher.call(this),this.id=e.GeometryIdCount++,this._type=2,this.needsUpdate=!1,this.decorations=null,this.vertexBufferGPU=null,this.indexBufferGPU=null,this.vertexOffsetGPU=0,this.vertexCountGPU=0,this.sharedBuffers=!1,this.noMeshInRAM=!1,this.vertexIndexArray=null,this.__migration_fixed_attribute_buffers=new Map,this.buffers=[],this.layout=new a,this.staleIndices=null,this.staleAttributes=null,this.getVertexPosition=l,this.getVertexNormal=l,this.getVertexColor=l,this.getUV=l,this.getUV2=l,this.dynamic=!1,this.boundingBox=null,this.boundingSphere=null,this.lightMap=null,this.drawingGroups=[],this.meshList=[],this.wideLinesLinker=null,this.cpuPatternFrame=0,this.cpuPatternMode=!1,this.editable=!1,this.indexOffsetGPU=0,this.__impl_compressedNormals=void 0,this.__impl_compressedVertices=void 0,this.__impl_compressedUVs=void 0,this.__impl_compressedColors=void 0,this.quantizedVector=null,this.offsetVector=null}static copyRawAttribute({source_bgds:t,source_attr:i,source_vertex_offset:r=0,target_array:n,target_attr:a,target_vertex_offset:s=0,num_vertices:o}){if(i.type||(i=t.layout.get(i)),i.type!==a.type)throw new Error(`Cannot copy attributes with different types (${i.type} -> ${a.type})`);if(o||(o=t.getVertexCount()),!o)return;const l=i.stride,h=a.stride,c=e.VertexAttribute[i.type].size,d=t.buffers[i.bufferId],u=new Uint8Array(d.buffer,d.byteOffset+r*l+i.offset),p=new Uint8Array(n.buffer,n.byteOffset+s*h+a.offset);for(let e=0;e<o;e++){const t=e*l,i=e*h;for(let e=0;e<c;e++)p[i+e]=u[t+e]}}exportRaw({target_array:e,target_layout:t}){t.forEach(t=>{h.copyRawAttribute({source_bgds:this,source_attr:t.name,target_array:e,target_attr:t})})}markIndexStale(e,t){this.staleIndices?(this.staleIndices[0]=Math.min(this.staleIndices[0],e),this.staleIndices[1]=Math.max(this.staleIndices[1],t)):this.staleIndices=[e,t]}isStale(){return this.staleIndices||this.staleAttributes}isAttributeStale(e){return!(!this.staleAttributes||!this.staleAttributes.get(e))}markAttributeStale(e,t,i){this.staleAttributes||(this.staleAttributes=new Map);let r=this.staleAttributes.get(e);r?(r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],i)):this.staleAttributes.set(e,[t,i])}markAllAttributesStale(){const e=this.getVertexCount();this.layout.forEach(t=>this.markAttributeStale(t.name,0,e))}_markIndexClean(){this.staleIndices=null}_markAttributeClean(e){this.staleAttributes.delete(e),0===this.staleAttributes.size&&(this.staleAttributes=null)}_markAllAttributesClean(){this.staleAttributes=null}getBuffersMemorySize(){let e=this.vertexIndexArray?this.vertexIndexArray.byteLength:0;for(let t=0;t<this.buffers.length;t++)this.buffers[t]&&(e+=this.buffers[t].byteLength);return e}_uploadStaleIndices(e){if(!this.staleIndices)return;const[t,i]=this.staleIndices;this._markIndexClean();const r=this.indexBufferGPU;if(!r)return;let n=this.vertexIndexArray.subarray(t,i);if(0!==this.vertexOffsetGPU){const e=this.vertexOffsetGPU;n=n.map(t=>t+e)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r.buffer),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,(this.indexOffsetGPU+t)*r.bytesPerIndex,n)}_uploadStaleVertices(t){if(!this.staleAttributes)return;const i=this.staleAttributes;this._markAllAttributesClean();const r=this.vertexBufferGPU;if(!r)return;let n=2**32,a=-(2**32);if(i.forEach((t,i)=>{t[0]<n&&(n=t[0]),t[1]>a&&(a=t[1]),e.BufferGeometryDS.copyRawAttribute({source_bgds:this,source_attr:i,source_vertex_offset:t[0],target_array:r.interleavedData,target_attr:r.layout.get(i),target_vertex_offset:t[0]+this.vertexOffsetGPU,num_vertices:t[1]-t[0]})}),r.needsUpdate=!1,n>=a)return;const s=r.layout.pickAnyAttribute().stride,o=this.vertexOffsetGPU+s*n,l=this.vertexOffsetGPU+s*a,h=new Uint8Array(r.interleavedData.buffer,r.interleavedData.byteOffset+o,l-o);t.bindBuffer(t.ARRAY_BUFFER,r.buffer),t.bufferSubData(t.ARRAY_BUFFER,o,h)}_compactArrays(e){if(!e.has(this)){e.add(this);var t=this.drawingGroups;this.drawingGroups=new Array(t.length);for(var i=0;i<t.length;i++)this.drawingGroups[i]=t[i],t[i]._compactArrays();var r=this.meshList;this.meshList=new Array(r.length);for(i=0;i<r.length;i++)this.meshList[i]=r[i]}}getVertexCount(){if(0===this.buffers.length)return 0;const e=this.layout.pickAnyAttribute();return e&&this.buffers[e.bufferId]?this.buffers[e.bufferId].byteLength/e.stride:0}_getVertexPositionAccessor(){const e=this.vertexPositionArray;if(!e)return l;const t=this.quantizedVector,i=this.offsetVector;return this.compressedVertices?function(r,n){const a=2*r,s=e[a],o=e[a+1];n.x=t.x*(Math.floor(s/256)+i.x),n.z=t.z*(Math.floor(o/256)+i.z),n.y=t.y*(s%256*256+o%256+i.y)}:function(t,i){const r=3*t;i.x=e[r],i.y=e[r+1],i.z=e[r+2]}}_updateVertexPositionAccessor(){this.getVertexPosition=this._getVertexPositionAccessor()}hasTangentBinormal(){return this.layout.has("tangent")&&this.layout.has("binormal")}clearMeshInRAM(e){e||(this.vertexIndexArray=null),this.buffers=[]}_getVertexNormalAccessor(){const e=this.vertexNormalArray;if(!e)return l;return this.compressedNormals?function(t,i){const r=e[t],n=(a=r,{x:Math.floor(a/4096)/4095,y:a%4096/4095});var a,s,o;if(i.x=2*n.x-1,i.y=2*n.y-1,i.z=1-Math.abs(i.x)-Math.abs(i.y),i.z<=0){const e=(s=i.x,o=i.y,{x:s>=0?1:-1,y:o>=0?1:-1}),t=i.x;i.x=-Math.abs(i.y)*e.x+e.x,i.y=-Math.abs(t)*e.y+e.y}}:function(t,i){const r=3*t;i.x=e[r],i.y=e[r+1],i.z=e[r+2]}}_updateVertexNormalAccessor(){this.getVertexNormal=this._getVertexNormalAccessor()}_getVertexColorAccessor(){const e=this.vertexColorArray;if(!e)return l;return this.compressedColors?function(t,i){const r=e[2*t],n=e[2*t+1],a=Math.floor(r/65536),s=Math.floor(r/256)%256,o=r%256,l=n;return i.x=a/255,i.y=s/255,i.z=o/255,i.w=l/255,i}:function(t,i){const r=4*t;return i.x=e[r],i.y=e[r+1],i.z=e[r+2],i.w=e[r+3],i}}_updateVertexColorAccessor(){this.getVertexColor=this._getVertexColorAccessor()}_getVertexUVAccessor(e){if(!e)return l;return this.compressedUVs?function(t,i){var r=e[2*t],n=e[2*t+1],a=Math.floor(r/256),s=Math.floor(n/256),o=r%256*256+n%256;return i.x=a/65535,i.y=o/65535,i.z=s/65535,i}:function(t,i){const r=3*t;return i.x=e[r],i.y=e[r+1],i.z=e[r+2],i}}_updateVertexUVAccessor(){this.getUV=this._getVertexUVAccessor(this.vertexUvArray)}_updateVertexUV2Accessor(){this.getUV2=this._getVertexUVAccessor(this.vertexUv2Array)}startIteration(){return!0}endIteration(){return!0}getDGRange(){const e=this.drawingGroups;let t=1/0,i=-1/0;for(let r=0;r<e.length;r++){const{start:n,count:a}=e[r];t=Math.min(t,n),i=Math.max(i,n+a)}return[t,i]}computeBoundingBox(){var t=[0,0,0],i=[0,0,0],r=this.getVertexCount();if(r>=1){t=[1/0,1/0,1/0],i=[-1/0,-1/0,-1/0];for(var n=new e.Vector3,a=0;a<r;a++)this.getVertexPosition(a,n),isNaN(n.x)||isNaN(n.y)||isNaN(n.z)||(n.x<t[0]&&(t[0]=n.x),n.y<t[1]&&(t[1]=n.y),n.z<t[2]&&(t[2]=n.z),n.x>i[0]&&(i[0]=n.x),n.y>i[1]&&(i[1]=n.y),n.z>i[2]&&(i[2]=n.z))}return t=new e.Vector3(t[0],t[1],t[2]),i=new e.Vector3(i[0],i[1],i[2]),this.boundingBox=new e.Box3(t,i),this.boundingBox}_computeOrientedBoundingBox(t,i){if(!t)return null;var r=new e.Vector3,n=new e.Vector3,a=new e.Vector3,s=this.vertexIndexArray,o=this.getVertexCount();if(o>=1){var l=new e.Vector3;if(i)for(var h=!0,c=0;c<i.length;c++){var d=i[c];if(d.layerNum&&d.count){if(h){h=!1;var u=s[d.start];this.getVertexPosition(u,l),n.set(l.x,l.y,l.z).applyMatrix4(t),a.set(l.x,l.y,l.z).applyMatrix4(t)}for(var p=d.start;p<d.start+d.count;p++){u=s[p];this.getVertexPosition(u,l),r.set(l.x,l.y,l.z).applyMatrix4(t),r.x<n.x&&(n.x=r.x),r.y<n.y&&(n.y=r.y),r.z<n.z&&(n.z=r.z),r.x>a.x&&(a.x=r.x),r.y>a.y&&(a.y=r.y),r.z>a.z&&(a.z=r.z)}}}else{this.getVertexPosition(0,l),n.set(l.x,l.y,l.z).applyMatrix4(t),a.set(l.x,l.y,l.z).applyMatrix4(t);for(var f=1;f<o;f++)this.getVertexPosition(f,l),r.set(l.x,l.y,l.z).applyMatrix4(t),r.x<n.x&&(n.x=r.x),r.y<n.y&&(n.y=r.y),r.z<n.z&&(n.z=r.z),r.x>a.x&&(a.x=r.x),r.y>a.y&&(a.y=r.y),r.z>a.z&&(a.z=r.z)}}return new e.Box3(n,a)}computeBoundingSphere(){this.boundingSphere||(this.boundingSphere=new e.Sphere);var t=this.boundingBox;t&&(this.boundingSphere.radius=t.max.clone().sub(t.min).multiplyScalar(.5).length(),this.boundingSphere.center=t.max.clone().add(t.min).multiplyScalar(.5))}computeUVs(t){if(!this.vertexUvArray){var i=new Float32Array(3*this.getVertexCount());this.vertexUvArray=i;var r=new e.Vector3;if(this.vertexNormalArray){t||(t=this.computeBoundingBox());for(var n=[t.min.x,t.min.y,t.min.z],a=[t.max.x-t.min.x,t.max.y-t.min.y,t.max.z-t.min.z],s=0;s<i.length/3;s++){var o=3*s,l=new e.Vector3;this.getVertexNormal(s,l);var h=Math.abs(l.x),c=Math.abs(l.y),d=0;c>h&&(h=c,d=1),(c=Math.abs(l.z))>h&&(h=c,d=2);var u=(d+1)%3,p=(d+2)%3;this.getVertexPosition(s,r);var f=[r.x,r.y,r.z];i[o]=(f[u]-n[u])/Math.min(a[u],a[p]),i[o+1]=(f[p]-n[p])/Math.min(a[u],a[p]),i[o+2]=0}}}}_computeUV(t,i,r){var n=new e.Vector3,a=new e.Vector3;this.getVertexNormal(t,n),this.getVertexPosition(t,a);var s=Math.abs(n.x),o=Math.abs(n.y),l=0;o>s&&(s=o,l=1),(o=Math.abs(n.z))>s&&(s=o,l=2);var h=(l+1)%3,c=(l+2)%3,d=[i.min.x,i.min.y,i.min.z],u=[i.max.x-i.min.x,i.max.y-i.min.y,i.max.z-i.min.z],p=[a.x,a.y,a.z];r.set((p[h]-d[h])/Math.min(u[h],u[c]),(p[c]-d[c])/Math.min(u[h],u[c]))}computeTangents(t){let i=this.vertexTangentArray,r=this.vertexBinormalArray;if(r&&i)return;if(i){var n=new e.Vector3,a=new e.Vector3,s=new e.Vector3;r=this.vertexBinormalArray=new Float32Array(i.length);for(var o=0;o<i.length;o+=3)this.getVertexNormal(o/3,n),n.normalize(),a.set(i[o],i[o+1],i[o+2]),a.normalize(),s.crossVectors(n,a),r[o]=s.x,r[o+1]=s.y,r[o+2]=s.z;return}o=0;var l=0,h=0,c=0,d=new e.Vector3,u=new e.Vector3,p=new e.Vector3,f=new e.Vector2,g=new e.Vector2,m=new e.Vector2,v=new e.Vector2,y=new e.Vector2,S=new e.Vector3,_=new e.Vector3,x=new e.Vector3,b=(n=new e.Vector3,a=new e.Vector3,s=new e.Vector3,new e.Vector3),w=0,M=0,C=0,P=0,E=0,A=0,T=0,D=3*this.getVertexCount();for(i||(i=this.vertexTangentArray=new Float32Array(D)),r||(r=this.vertexBinormalArray=new Float32Array(D)),o=0;o<i.length;o++)i[o]=0,r[o]=0;var I=this.computeBoundingBox(),R=this.vertexIndexArray;const O=this.vertexUvArray;for(var L=0;L<this.drawingGroups.length;L++){var V=this.drawingGroups[L];if(4===V.glType)for(o=V.start;o<V.start+V.count;o+=3){l=R[o],h=R[o+1],c=R[o+2],this.getVertexPosition(l,d),this.getVertexPosition(h,u),this.getVertexPosition(c,p),O?(this.getUV(l,f),this.getUV(h,g),this.getUV(c,m)):(this._computeUV(l,I,f),this._computeUV(h,I,g),this._computeUV(c,I,m)),S.subVectors(u,d),_.subVectors(p,d),v.subVectors(g,f),y.subVectors(m,f);var F=v.x*y.y-y.x*v.y;Math.abs(F)>1e-8?(w=(F=1/F)*(y.y*S.x-v.y*_.x),M=F*(y.y*S.y-v.y*_.y),C=F*(y.y*S.z-v.y*_.z),P=F*(v.x*_.x-y.x*S.x),E=F*(v.x*_.y-y.x*S.y),A=F*(v.x*_.z-y.x*S.z)):(w=1,M=0,C=0,P=0,E=1,A=0),i[3*l]+=w,i[3*h]+=w,i[3*c]+=w,i[3*l+1]+=M,i[3*h+1]+=M,i[3*c+1]+=M,i[3*l+2]+=C,i[3*h+2]+=C,i[3*c+2]+=C,r[3*l]+=P,r[3*h]+=P,r[3*c]+=P,r[3*l+1]+=E,r[3*h+1]+=E,r[3*c+1]+=E,r[3*l+2]+=A,r[3*h+2]+=A,r[3*c+2]+=A}}for(o=0;o<i.length;o+=3)this.getVertexNormal(o/3,n),a.set(i[o],i[o+1],i[o+2]),s.set(r[o],r[o+1],r[o+2]),a.normalize(),s.normalize(),T=n.dot(a),(b=(new e.Vector3).copy(a)).sub(x.copy(n).multiplyScalar(T)),b.normalize(),i[o]=b.x,i[o+1]=b.y,i[o+2]=b.z,r[o]=s.x,r[o+1]=s.y,r[o+2]=s.z}computeLineDistances(e){i._computeLineDistances(this,e)}computeWideLine(t,r){var n,a=!1;return!this.wideLinesLinker||this.wideLinesLinker.linkedGeometry.vertexBufferGPU&&this.wideLinesLinker.linkedGeometry.vertexBufferGPU.needsUpdate?(this.wideLinesLinker&&(a=!0,this.wideLinesLinker.linkedGeometry.dispose()),(n=new e.BufferGeometryDS).editable=this.editable,new o(this,n)):n=this.wideLinesLinker.linkedGeometry,i._computeWideLineDG(this,n,t,r,a)}__setTypedArraysForWidelines(){var t=this.vertexPositionArray;if(!(t instanceof Float32Array)){var i=this.vertexPreviousPositionArray,r=this.vertexNextPositionArray,n=this.vertexSideExtrusionArray,a=this.vertexColorArray,s=this.vertexLineDistancesArray,o=this.vertexPatternStartEndArray,l=this.vertexIndexArray;this.vertexPositionArray=new Float32Array(t),this.vertexPreviousPositionArray=new Float32Array(i),this.vertexNextPositionArray=new Float32Array(r),this.vertexSideExtrusionArray=new Float32Array(n),a&&(this.vertexColorArray=new Float32Array(a)),s&&(this.vertexLineDistancesArray=new Float32Array(s)),o&&(this.vertexPatternStartEndArray=new Float32Array(o)),t.length>196608&&e.supportedExtensions.elementIndexUint?this.vertexIndexArray=new Uint32Array(l):this.vertexIndexArray=new Uint16Array(l)}}deallocate(e,t){t&&(this.vertexBufferGPU||this.indexBufferGPU)&&t.memory.geometries--,this.vertexBufferGPU&&(this.vertexBufferGPU.deallocate(e,t),this.vertexBufferGPU=null),this.indexBufferGPU&&(this.indexBufferGPU.deallocate(e,t),this.indexBufferGPU=null)}addRefVBO(t,i){i||this.meshList.push(t);var r=function(t){if(t&&t._source===e.AssetSource.MATERIAL_MANAGER){t._useCount++;for(var i=t._getTextures(!1),n=0;n<i.length;n++){var a=i[n];a&&a._source===e.AssetSource.MATERIAL_MANAGER&&a._useCount++}r(t.line),r(t.politeMaterial),r(t.backMaterial),r(t.point)}};r(t.material),r(t.gas),t.matApp&&(r(t.matApp._material),r(t.matApp._materialGeomFace),r(t.matApp._materialLine),r(t.matApp._materialPoint),t.matApp._lightMap&&t.matApp._lightMap.texture&&t.matApp._lightMap.texture._source===e.AssetSource.MATERIAL_MANAGER&&t.matApp._lightMap.texture._useCount++);for(var n=0;n<this.drawingGroups.length;n++){var a=this.drawingGroups[n];r(a.material),r(a.gas)}this.lightMap&&this.lightMap._source===e.AssetSource.MATERIAL_MANAGER&&this.lightMap._useCount++}releaseVBO(t,i){var r=function(t){if(t&&t._source===e.AssetSource.MATERIAL_MANAGER){t._useCount--,t._useCount<=0&&t.dispose();for(var i=t._getTextures(!1),n=0;n<i.length;n++){var a=i[n];a&&a._source===e.AssetSource.MATERIAL_MANAGER&&(a._useCount--,a._useCount<=0&&a.dispose())}r(t.line),r(t.politeMaterial),r(t.backMaterial),r(t.point)}},n=this.meshList.indexOf(t);if(-1!==n){i||this.meshList.splice(n,1),r(t.material),r(t.gas),t.matApp&&(r(t.matApp._material),r(t.matApp._materialGeomFace),r(t.matApp._materialLine),r(t.matApp._materialPoint),t.matApp._lightMap&&t.matApp._lightMap.texture&&t.matApp._lightMap.texture._source===e.AssetSource.MATERIAL_MANAGER&&(t.matApp._lightMap.texture._useCount--,t.matApp._lightMap.texture._useCount<=0&&t.matApp._lightMap.texture.dispose()));for(var a=0;a<this.drawingGroups.length;a++){var s=this.drawingGroups[a];r(s.material),r(s.gas)}this.lightMap&&this.lightMap._source===e.AssetSource.MATERIAL_MANAGER&&(this.lightMap._useCount--,this.lightMap._useCount<=0&&this.lightMap.dispose())}else console.warn("BufferGeometryDS tried to break the link with a THREE.Mesh, but it failed !");0===this.meshList.length&&this.dispose()}dispose(){this.dispatchEvent({type:"dispose"})}clone(i){var r=new e.BufferGeometryDS;for(let e=0;e<this.buffers.length;e++)r.buffers.push(this.buffers[e].slice());r.layout=this.layout.clone(),r.__migration_fixed_attribute_buffers=new Map(this.__migration_fixed_attribute_buffers),r.compressedNormals=this.compressedNormals,r.compressedVertices=this.compressedVertices,r.compressedUVs=this.compressedUVs,r.compressedColors=this.compressedColors,this.vertexIndexArray&&(r.vertexIndexArray=this.vertexIndexArray.slice()),r.boundingBox=this.boundingBox?this.boundingBox.clone():null,r.boundingSphere=this.boundingSphere?this.boundingSphere.clone():null,r.offsetVector=this.offsetVector,r.quantizedVector=this.quantizedVector,r.drawingGroups=[];for(var n=0;n<this.drawingGroups.length;n++){var a=this.drawingGroups[n],s=[],o=new t.DrawingGroup(a.gas,a.material,a.glType,a.start,a.count,null,null,a._geomType,a.gasIndex);if(a instanceof t.DrawingGroup)for(l=0;l<a.getPrimitivesCount();l++){c=new t.SGPrimitive({type:a.getPrimitiveType(l),cgmId:a.getPrimitiveCgmId(l),rep:a.getPrimitiveRep(l),group:o,start:a.getPrimitiveStart(l),count:a.getPrimitiveCount(l)});s.push(c)}else for(var l=0;l<a._primitives.length;l++){var h=a._primitives[l],c=new t.SGPrimitive({type:h.type,cgmId:h.cgmId,rep:h.rep,group:o,start:h.start,count:h.count});s.push(c)}o.geometry=r,o._primitives=s,r.drawingGroups.push(o)}return r}merge(t,i,r){if(!t.layout||!this.layout)throw new Error("Need vertex layout to be able to merge buffers");if(t.layout.getSignature()!==this.layout.getSignature())throw new Error("Cannot merge buffers with different layouts");const n=this.getVertexCount(),a=t.getVertexCount(),s=this.layout.getBufferAttributes(),o=this.layout.getBufferStrides();for(let e=0;e<this.buffers.length;e++){const i=o[e],r=new Uint8Array(i*(n+a));r.set((l=this.buffers[e],new Uint8Array(l.buffer,l.byteOffset,l.byteLength)));const c=s[e];for(let e=0;e<c.length;e++)h.copyRawAttribute({source_bgds:t,source_attr:t.layout.get(c[e]),source_vertex_offset:0,target_array:r,target_attr:this.layout.get(c[e]),target_vertex_offset:n,num_vertices:a});this.buffers[e]=new Float32Array(r.buffer)}var l;this.markAllAttributesStale();const c=this.vertexIndexArray.length,d=t.vertexIndexArray.length,u=c+d>=65536?new Uint32Array(c+d):new Uint16Array(c+d);function p(e){e&&(e.isShared?(e.nbGeometries--,0===e.nbGeometries&&e.deallocate(i,r)):e.deallocate(i,r))}u.set(this.vertexIndexArray,0),u.set(t.vertexIndexArray.map(e=>e+n),c),this.vertexIndexArray=u,p(this.vertexBufferGPU),this.vertexBufferGPU=null,p(this.indexBufferGPU),this.indexBufferGPU=null;for(let e=0;e<t.drawingGroups.length;e++){let i=t.drawingGroups[e];i.geometry=this,i.start+=c;for(let e=0;e<i.getPrimitivesCount();e++)i._setPrimitiveStart(i.getPrimitiveStart(e)+c,e);this.drawingGroups.push(i)}for(let i=0;i<this.meshList.length;i++){let r=this.meshList[i];if(r.layer)for(let i=0;i<t.drawingGroups.length;i++){let n=t.drawingGroups[i],a=new e.DrawableInterval(1,n.start,n.count);a.primitiveStart=0,a.primitiveCount=n.getPrimitivesCount();let s=new e.LayerInterval(this,n,a);r.layer.layers.push(s)}}return this}}function c(t,i,r,n){t.buffers[i]?t.layout.setAttribute({name:r,type:n,offset:0,stride:e.VertexAttribute[n].size,bufferId:i}):t.layout.remove(r)}e.BufferGeometryDS=h;const d=new Map([["vertexPositionArray",(e,t)=>{c(e,t,"position",e.compressedVertices?"float32x2":"float32x3"),e._updateVertexPositionAccessor()}],["vertexNormalArray",(e,t)=>{c(e,t,"normal",e.compressedNormals?"float32":"float32x3"),e._updateVertexNormalAccessor()}],["vertexUvArray",(e,t)=>{c(e,t,"uv",e.compressedUVs?"float32x2":"float32x3"),e._updateVertexUVAccessor()}],["vertexUv2Array",(e,t)=>{c(e,t,"uv2",e.compressedUVs?"float32x2":"float32x3"),e._updateVertexUV2Accessor()}],["vertexColorArray",(e,t)=>{c(e,t,"color",e.compressedColors?"float32x2":"float32x4"),e._updateVertexColorAccessor()}],["vertexTangentArray",(e,t)=>c(e,t,"tangent","float32x3")],["vertexBinormalArray",(e,t)=>c(e,t,"binormal","float32x3")],["vertexLineDistancesArray",(e,t)=>c(e,t,"lineDistance","float32x2")],["vertexPatternStartEndArray",(e,t)=>c(e,t,"patternStartEnd","float32x2")],["vertexPreviousPositionArray",(e,t)=>c(e,t,"previousPos","float32x3")],["vertexNextPositionArray",(e,t)=>c(e,t,"followingPos","float32x3")],["vertexSideExtrusionArray",(e,t)=>c(e,t,"sideExtrusion","float32")],["vertexSkinIndexArray",(e,t)=>c(e,t,"skinIndex","float32x4")],["vertexSkinWeightArray",(e,t)=>c(e,t,"skinWeight","float32x4")]]);function u(t){Object.defineProperty(e.BufferGeometryDS.prototype,t,{get:function(){let e=this.__migration_fixed_attribute_buffers.get(t);return void 0===e?null:this.buffers[e]},set:function(e){let i=this.__migration_fixed_attribute_buffers.get(t);void 0===i&&this.__migration_fixed_attribute_buffers.set(t,i=this.buffers.length),this.buffers[i]=e,d.get(t)(this,i)}})}function p(t,i,r=!1){const n=`__impl_${t}`;Object.defineProperty(e.BufferGeometryDS.prototype,t,{get:function(){return void 0===this[n]&&(this[n]=r),this[n]},set:function(e){this[n]=e;for(let e=0;e<i.length;e++){const t=this.__migration_fixed_attribute_buffers.get(i[e]);void 0!==t&&d.get(i[e])(this,t)}}})}function f(e,t){Object.defineProperty(e.prototype,t,{get:()=>{throw new Error(`(GET) Invalid property: ${t}`)},set:()=>{throw new Error(`(SET) Invalid property: ${t}`)}})}return p("compressedNormals",["vertexNormalArray"]),p("compressedVertices",["vertexPositionArray"]),p("compressedUVs",["vertexUvArray","vertexUv2Array"]),p("compressedColors",["vertexColorArray"]),u("vertexPositionArray"),u("vertexNormalArray"),u("vertexUvArray"),u("vertexUv2Array"),u("vertexTangentArray"),u("vertexBinormalArray"),u("vertexColorArray"),u("vertexLineDistancesArray"),u("vertexPatternStartEndArray"),u("vertexPreviousPositionArray"),u("vertexNextPositionArray"),u("vertexSideExtrusionArray"),u("vertexSkinIndexArray"),u("vertexSkinWeightArray"),f(e.GLVertexBuffer,"indexBuffer"),f(e.GLVertexBuffer,"indexNumItems"),f(e.GLVertexBuffer,"indexData"),f(e.GLVertexBuffer,"numItems"),f(e.GLVertexBuffer,"geometries"),f(e.GLVertexBuffer,"start"),f(e.GLVertexBuffer,"count"),f(e.BufferGeometryDS,"glFormatTypeIndex"),f(e.BufferGeometryDS,"use32bitIndexBuffer"),f(e.BufferGeometryDS,"itemSize"),f(e.BufferGeometryDS,"numItems"),e}),define("DS/Visualization/ThreeJS_DS",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh","DS/Intersection/Ray","DS/Intersection/Raycaster","DS/Shaders/PBRShaders","DS/Visualization/BufferGeometry","DS/Shaders/DeferredShaders","DS/Shaders/AdvancedHighlightShader","DS/Shaders/AdvancedHighlightShaderSinglePass","DS/Materials/DeferredCaches","DS/RenderEngineUtils/RenderEngineUtils"],function(e,t,i,r,n,a,s,o,l,h,c,d,u){"use strict";var p,f;window.SIMULATE_EXPERIENCE_PLAYER,new i.Color;i.mobileVersion=!1,i._mobileHighlight=!0,i._mobileDevice=!1,i._visuFaceMaterialsAsPBR=!1,i._CATGraphicalAsPBR=!0,i._GASFaceMaterialsAsPBR=!1,i._DeferredShaders=l,i._AdvancedHighlightShader=h,i._AdvancedHighlightShaderSinglePass=c,i.DefaultNormalDepthMaterials=d.DefaultNormalDepthMaterials,i.DefaultShadowDepthMaterials=d.DefaultShadowDepthMaterials,i.DefaultPickingMaterials=d.DefaultPickingMaterials,i.DefaultHighlightMaterials=d.DefaultHighlightMaterials,i.DefaultMaterials=d.DefaultMaterials,i.PredefinedMaterials=d.PredefinedMaterials,i.GeomTypeMaterials=d.GeomTypeMaterials,i.DeferredMaterial=d.DeferredMaterial,i.__tmpIsA2X=!1,window.webVisuPerfo||(window.webVisuPerfo={startPerfo:function(){},endPerfo:function(){},setStats:function(){}}),i.getPixelsPerMM=function(){return 96/25.4},i.Frustum.__v2=new i.Vector3,i.Frustum.prototype.intersectsObject=function(e,t,r){var n=this.planes,a=e._getMMMatrix(),s=e.geometry.boundingSphere,o=-s.radius*a.getMaxScaleOnAxis(),l=i.Frustum.__v2;null!==s?l.copy(s.center):l.set(0,0,0),l.applyMatrix4(a);for(var h=0;h<6;h++)if(n[h].distanceToPoint(l)<=o)return!1;return!0},i.Frustum.prototype.performFrustumCulling=function(e,t){for(var i=this.planes,r=-e,n=null,a=null,s=0;s<6;s++)if((a=(n=i[s]).normal).x*t.x+a.y*t.y+a.z*t.z+n.constant<=r)return!1;return!0},i.Frustum.prototype.performFrustumCullingNoNearFar=function(e,t){for(var i=this.planes,r=-e,n=null,a=null,s=0;s<4;s++)if((a=(n=i[s]).normal).x*t.x+a.y*t.y+a.z*t.z+n.constant<=r)return!1;return!0},i.Frustum.prototype.getCorners=function(){var e=[],t=new i.Matrix4,r=new i.Matrix4,n=this;function a(e,a,s){var o=n.planes[e],l=n.planes[a],h=n.planes[s];t.set(o.normal.x,o.normal.y,o.normal.z,0,l.normal.x,l.normal.y,l.normal.z,0,h.normal.x,h.normal.y,h.normal.z,0,0,0,0,1),r.getInverse(t);var c=(new i.Vector4).set(-o.constant,-l.constant,-h.constant,1);return c.applyMatrix4(r),c}return e[0]=a(1,2,5),e[1]=a(0,2,5),e[2]=a(0,3,5),e[3]=a(1,3,5),e[4]=a(1,2,4),e[5]=a(0,2,4),e[6]=a(0,3,4),e[7]=a(1,3,4),e},i.CGPolygon=function(){this.corner=[]},i.CGPolygon.prototype={constructor:i.CGPolygon,clone:function(e){var t=e||new i.CGPolygon;t.empty();for(var r=0;r<this.corner.length;r++)t.addPoint(this.corner[r]);return t},empty:function(){this.corner=[]},applyMatrix4:function(e){for(var t=0;t<this.corner.length;t++)this.corner[t].applyMatrix4(e);return this},addPoint:function(e){return this.corner.push((new i.Vector3).copy(e)),this},addPoints:function(e){return this.corner=e,this},addPointAtIndex:function(e,t){return this.corner[e]=new i.Vector3,this.corner[e].copy(t),this},clipByPlane:function(e,t){var r=new i.CGPolygon,n=this.corner.length;if(n<3)return r;for(var a=[],s=0;s<n;s++)a[s]=e.distanceToPoint(this.corner[s])>0;for(s=0;s<n;s++){var o=(s+1)%n;if(!a[s]||!a[o])if(a[s]){var l=new i.Vector3,h=new i.Line3(this.corner[s],this.corner[o]);void 0!==e.intersectLine(h,l)&&(t.addPoint(l),r.addPoint(l)),t.addPoint(this.corner[o])}else if(a[o]){l=new i.Vector3,h=new i.Line3(this.corner[s],this.corner[o]);void 0!==e.intersectLine(h,l)&&(t.addPoint(l),r.addPoint(l))}else t.addPoint(this.corner[o])}return r.corner.length&&2!==r.corner.length&&(this.clone(t),r.empty()),r}},i.CGPoly=function(){return this.polygon=[],this},i.CGPoly.prototype={constructor:i.CGPoly,addPolygon:function(e){this.polygon.push(e)},removePolygon:function(e){e>=this.polygon.length||e<0?console.log("CGPoly: trying to remove a polygon which does not exist !"):this.polygon.splice(e,1)},empty:function(){this.polygon=[]},clone:function(e){var t=e||new i.CGPoly;t.empty();for(var r=0;r<this.polygon.length;r++)t.addPolygon(this.polygon[r].clone());return t},applyMatrix4:function(e){for(var t=0;t<this.polygon.length;t++)this.polygon[t].applyMatrix4(e);return this},setFromBox:function(e){var t;(t=new i.CGPolygon).addPoint((new i.Vector3).copy(e.min)),t.addPoint(new i.Vector3(e.min.x,e.min.y,e.max.z)),t.addPoint(new i.Vector3(e.min.x,e.max.y,e.max.z)),t.addPoint(new i.Vector3(e.min.x,e.max.y,e.min.z)),this.addPolygon(t),(t=new i.CGPolygon).addPoint((new i.Vector3).copy(e.min)),t.addPoint(new i.Vector3(e.min.x,e.max.y,e.min.z)),t.addPoint(new i.Vector3(e.max.x,e.max.y,e.min.z)),t.addPoint(new i.Vector3(e.max.x,e.min.y,e.min.z)),this.addPolygon(t),(t=new i.CGPolygon).addPoint((new i.Vector3).copy(e.min)),t.addPoint(new i.Vector3(e.max.x,e.min.y,e.min.z)),t.addPoint(new i.Vector3(e.max.x,e.min.y,e.max.z)),t.addPoint(new i.Vector3(e.min.x,e.min.y,e.max.z)),this.addPolygon(t),(t=new i.CGPolygon).addPoint((new i.Vector3).copy(e.max)),t.addPoint(new i.Vector3(e.max.x,e.min.y,e.max.z)),t.addPoint(new i.Vector3(e.max.x,e.min.y,e.min.z)),t.addPoint(new i.Vector3(e.max.x,e.max.y,e.min.z)),this.addPolygon(t),(t=new i.CGPolygon).addPoint((new i.Vector3).copy(e.max)),t.addPoint(new i.Vector3(e.max.x,e.max.y,e.min.z)),t.addPoint(new i.Vector3(e.min.x,e.max.y,e.min.z)),t.addPoint(new i.Vector3(e.min.x,e.max.y,e.max.z)),this.addPolygon(t),(t=new i.CGPolygon).addPoint((new i.Vector3).copy(e.max)),t.addPoint(new i.Vector3(e.min.x,e.max.y,e.max.z)),t.addPoint(new i.Vector3(e.min.x,e.min.y,e.max.z)),t.addPoint(new i.Vector3(e.max.x,e.min.y,e.max.z)),this.addPolygon(t)},setFromFrustumPoints:function(e){for(var t=new i.CGPolygon,r=0;r<4;r++)t.addPoint((new i.Vector3).copy(e[r]));this.addPolygon(t),t=new i.CGPolygon;for(r=4;r<8;r++)t.addPointAtIndex(r-4,(new i.Vector3).copy(e[11-r]));this.addPolygon(t),(t=new i.CGPolygon).addPoint(e[0]),t.addPoint(e[3]),t.addPoint(e[7]),t.addPoint(e[4]),this.addPolygon(t),(t=new i.CGPolygon).addPoint(e[1]),t.addPoint(e[5]),t.addPoint(e[6]),t.addPoint(e[2]),this.addPolygon(t),(t=new i.CGPolygon).addPoint(e[4]),t.addPoint(e[5]),t.addPoint(e[1]),t.addPoint(e[0]),this.addPolygon(t),(t=new i.CGPolygon).addPoint(e[6]),t.addPoint(e[7]),t.addPoint(e[3]),t.addPoint(e[2]),this.addPolygon(t)},clipByPlane:function(e){var t,r,n=new i.CGPoly,a=new i.CGPoly;for(t=0;t<this.polygon.length;t++){var s=new i.CGPolygon,o=this.polygon[t].clipByPlane(e,s);s.corner.length&&(n.addPolygon(s),o.corner.length&&2===o.corner.length?a.addPolygon(o):o.corner.length>0&&console.log("plane / polygon intersection is not a segment : "+o.corner.length+" points"))}if(a.polygon.length>=3){var l=new i.CGPolygon,h=a.polygon[a.polygon.length-1];for(l.addPoint(h.corner[0]),l.addPoint(h.corner[1]),a.removePolygon(a.polygon.length-1);a.polygon.length>0;){var c=l.corner[l.corner.length-1],d=1/0,u=-1,p=-1;for(t=0;t<a.polygon.length;t++){var f=a.polygon[t];if(2===f.corner.length){for(r=0;r<f.corner.length;r++){var g=f.corner[r].distanceToSquared(c);if(g<1e-4)break;g<d&&(d=g,u=t,p=r)}if(r<f.corner.length){l.addPoint(f.corner[(r+1)%2]);break}}else console.log("convex hull clipping : intersection segment has length > 2")}if(t<a.polygon.length)a.removePolygon(t);else{if(!(u>=0)){console.log("failed to build the intersection polygon btw polyhedra and plane");break}l.addPoint(a.polygon[u].corner[(p+1)%2]),a.removePolygon(u)}}l.corner.splice(l.corner.length-1,1),n.addPolygon(l)}return n},clipByPlanes:function(e){if(!e.length)return null;for(var t=this.clipByPlane(e[0]),i=1;i<e.length;i++)t=t.clipByPlane(e[i]);return t},clipByBox:function(e){for(var t=e.getPlanes(),i=this.clipByPlane(t[0]),r=1;r<6;r++)i=i.clipByPlane(t[r]);return i},getPoints:function(){var e,t,i,r=[];for(t=0;t<this.polygon.length;t++)for(e=this.polygon[t],i=0;i<e.corner.length;i++)r.push(e.corner[i]);return r}},i.CGPolyHelper=function(e){i.Line.call(this),this._tokens={};this.frustumCulled=!1,this.geometry=new i.Geometry,this.material=new i.LineBasicMaterial({color:16777215,vertexColors:i.VertexColorType.Face}),this.type=i.LinePieces,this.matrixWorld=new i.Matrix4,this.matrixAutoUpdate=!1;for(var t=0;t<1e3;t++)this.geometry.vertices.push(new i.Vector3),this.geometry.colors.push(new i.Color(16711680));this.update(e,new i.Color(16711680))},i.CGPolyHelper.prototype=Object.create(i.Line.prototype),i.CGPolyHelper.prototype.update=function(e,t){var r,n=0;for(r=0;r<e.polygon.length;r++)for(var a=e.polygon[r],s=a.corner.length,o=0;o<s;o++){var l=a.corner[o];this.geometry.vertices[n].copy(l),this.geometry.colors[n].copy(t),n++,l=a.corner[(o+1)%s],this.geometry.vertices[n].copy(l),this.geometry.colors[n].copy(t),n++}var h=n>0?this.geometry.vertices[n-1]:new i.Vector3;for(r=n;r<1e3;r++)this.geometry.vertices[r].copy(h),this.geometry.colors[r].copy(t);this.geometry.verticesNeedUpdate=!0,this.geometry.colorsNeedUpdate=!0},i.BackgroundViewMode={NORMAL:0,FOG:1,LOWLIGHT:2,GHOST:3,NO_DISPLAY:4},i.PlaneViewMode={NORMAL:0,NO_DISPLAY:1,LOWLIGHT:2,LOWLIGHT_NO_PICK:3},i.ShaderLib.physicalDS=s,i._loadPredefinedMaterialTextures=d._loadPredefinedMaterialTextures,i.MaterialUtils={_addParameters:function(e,t,i){for(var r=0;r<i.length;r++)void 0!==t[i[r]]&&(e[i[r]]=t[i[r]]);var n=["line","point","depthWrite","depthTest","colorWrite","side","forceSide","force","transparent","polite","enableClipPlanes","polygonOffset","polygonOffsetFactor","polygonOffsetUnits","overridable","iterative","name"];for(r=0;r<n.length;r++)void 0!==t[n[r]]&&(e[n[r]]=t[n[r]])},convertShininessToIoRRoughness:function(e){return null==e?{ior:1.5,roughness:.34}:(e>1&&(e=Math.min(e/128,1)),{ior:1.5,roughness:1-e})},createShinyFaceMaterial:function(e){if(!i._visuFaceMaterialsAsPBR)return e&&e.color&&!e.ambient&&(e.ambient=e.color),new i.MeshPhongMaterial(e);var t={shininess:30};e&&this._addParameters(t,e,["color","map","shininess","opacity","alphaTest","vertexColors","useLighting"]);var r=this.convertShininessToIoRRoughness(t.shininess);return Object.assign(t,r),new i.DSPBR19xMaterial(t)},createMatteFaceMaterial:function(e){if(!i._visuFaceMaterialsAsPBR)return e&&e.color&&!e.ambient&&(e.ambient=e.color),new i.MeshLambertMaterial(e);var t={specularContrib:0};return e&&this._addParameters(t,e,["color","map","opacity","alphaTest","vertexColors","useLighting"]),new i.DSPBR19xMaterial(t)}},i.TangentToWorld=(p=new i.Vector3,f=new i.Vector3,function(e,t){var i=Math.abs(t.z)<.999?p.set(0,0,1):p.set(1,0,0);f.crossVectors(i,t);var r=f.normalize(),n=p.crossVectors(t,r);return r.multiplyScalar(e.x),n.multiplyScalar(e.y),r.add(n),n.copy(t),n.multiplyScalar(e.z),r.add(n),r}),i.RandomLib={_tmpVec2:new i.Vector2,_tmpVec3:new i.Vector3,HaltonSequence:function(e,t){for(var i=0,r=1/t,n=r;e>0;){i+=e%t*n,e=Math.floor(e/t),n*=r}return i},LowDiscrepancy2D:function(e,t,i,r){var n=this._tmpVec2;return n.x=this.HaltonSequence(e,2),n.y=this.HaltonSequence(e,5),n},computeHaltonSequence4D:function(e){for(var t=e*e,r=new Float32Array(4*t),n=0;n<t;n++)r[4*n]=this.HaltonSequence(n,2),r[4*n+1]=this.HaltonSequence(n,5),r[4*n+2]=this.HaltonSequence(n,7),r[4*n+3]=this.HaltonSequence(n,9);return new i.DataTexture(r,e,e,i.RGBAFormat,i.FloatType)}},i.LODTextureData=function(e,t,i,r,n){this.imageData=e,this.bufferData=t,this.loadCB=i,this.type=r,this.basisUsage=n},i.CSS2DNode=function(e,t,r){i.Object3D.call(this),this.element=e||document.createElement("div"),this.element.renderable=this,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.position=t||(this.position?this.position:new i.Vector3),this.pickable=!0,this.geometry=new i.Geometry,this.geometry.boundingSphere=new i.Sphere,this.offset=r||(this.offset?this.offset:new i.Vector2)},i.CSS2DNode.prototype=Object.create(i.Object3D.prototype),i.DisplayList=u.DisplayList,i.Ray=n,i.Raycaster=a,i.KDTree=null,i.CurvedPipeMesh=function(e,t,r){i.Mesh.call(this,e,t,r),this.isCurvedPipe=!0,this._capWorldRadius=0,this._nbLODsMinusOne=0,this.currentLOD=-1},i.CurvedPipeMesh.prototype=Object.create(i.Mesh.prototype),i.CurvedPipeMesh.prototype.clone=function(){var e=new i.CurvedPipeMesh(this.geometry,this.material);return i.Mesh.prototype.clone.call(this,e),e},i.CurvedPipeMesh.prototype.getMin=function(e){void 0===e&&(e="z");var t="x"===e?0:"y"===e?1:2,i=this.getNode();if(!i)return null;for(var r=null,n=0;n<i._pipes.length;n++){var a=i._pipes[n];if(!(a.curvePoints.length<2))for(var s=t;s<a.curvePoints.length;s+=3){var o=a.curvePoints[s]-a.radius;(o<r||null===r)&&(r=o)}}return r},i.CurvedPipeMesh.prototype._computeLOD=function(e,t){if(-1===this.currentLOD||e._renderingRole===i._CameraRoles.PRINCIPAL){var r=this._nbLODsMinusOne;if(0===r)return t.currentLOD=0,void(this.currentLOD=0);var n=this._capWorldRadius/e._cstLOD;if(!e.isOrtho){var a=this.worldCenter,s=e.matrixWorldInverse.elements,o=Math.abs(s[2]*a.x+s[6]*a.y+s[10]*a.z+s[14])-this.worldRadius;if(o<=0)return r;n/=o}var l=Math.min(r,Math.floor((n+11)/27));(l=Math.max(l,0))!==t.currentLOD&&(t.invalidated=!0,t.currentLOD=l,this.currentLOD=l)}},i.LensFlare.prototype.clone=function(e){void 0===e&&(e=new i.LensFlare),i.Object3D.prototype.clone.call(this,e),e.positionScreen.copy(this.positionScreen),e.customUpdateCallback=this.customUpdateCallback;for(var t=0;t<this.lensFlares.length;t++){var r=this.lensFlares[t],n={texture:r.texture,size:r.size,distance:r.distance,x:0,y:0,z:0,scale:1,rotation:1,opacity:r.opacity,color:r.color.clone(),blending:r.blending};e.lensFlares.push(n)}return e};var g={vertexShader:["uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uv;","vec2 pos = position;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 screenPositionFlare;","uniform sampler2D tNormalDepth;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","void main() {","float visibility = 0.0;","float depth1 = texture2D( tNormalDepth, screenPositionFlare.xy ).w;","float depth2 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2( 0.005,  0.005) ).w;","float depth3 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2( 0.005, -0.005) ).w;","float depth4 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2(-0.005,  0.005) ).w;","float depth5 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2(-0.005, -0.005) ).w;","if ((depth1 == 0.0) || (screenPositionFlare.z < depth1)) visibility += 0.2;","if ((depth2 == 0.0) || (screenPositionFlare.z < depth2)) visibility += 0.2;","if ((depth3 == 0.0) || (screenPositionFlare.z < depth3)) visibility += 0.2;","if ((depth4 == 0.0) || (screenPositionFlare.z < depth4)) visibility += 0.2;","if ((depth5 == 0.0) || (screenPositionFlare.z < depth5)) visibility += 0.2;","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * visibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}"].join("\n")};function m(e,t){if(t<=e.getPrimitiveStart(0))return 0;for(var i,r=e.getPrimitivesCount()-1,n=0;r-n>1;)i=Math.floor((r+n)/2),e.getPrimitiveStart(i)<t?n=i:r=i;return r}i.LensFlarePlugin=function(){var e,t,r;this._lensFlare={},this.init=function(i){e=i.context,t=i;var n=this._lensFlare;r=i.getPrecision(),n.vertices=new Float32Array(16),n.faces=new Uint16Array(6);var a,s,o,l,h,c,d=0;n.vertices[d++]=-1,n.vertices[d++]=-1,n.vertices[d++]=0,n.vertices[d++]=0,n.vertices[d++]=1,n.vertices[d++]=-1,n.vertices[d++]=1,n.vertices[d++]=0,n.vertices[d++]=1,n.vertices[d++]=1,n.vertices[d++]=1,n.vertices[d++]=1,n.vertices[d++]=-1,n.vertices[d++]=1,n.vertices[d++]=0,n.vertices[d++]=1,d=0,n.faces[d++]=0,n.faces[d++]=1,n.faces[d++]=2,n.faces[d++]=0,n.faces[d++]=2,n.faces[d++]=3,n.vertexBuffer=e.createBuffer(),n.elementBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,n.vertices,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.elementBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,n.faces,e.STATIC_DRAW),n.program=(a=g,s=r,o=e.createProgram(),l=e.createShader(e.FRAGMENT_SHADER),h=e.createShader(e.VERTEX_SHADER),c="precision "+s+" float;\n",e.shaderSource(l,c+a.fragmentShader),e.shaderSource(h,c+a.vertexShader),e.compileShader(l),e.compileShader(h),e.attachShader(o,l),e.attachShader(o,h),e.linkProgram(o),e.deleteShader(l),e.deleteShader(h),o),n.attributes={},n.uniforms={},n.attributes.vertex=e.getAttribLocation(n.program,"position"),n.attributes.uv=e.getAttribLocation(n.program,"uv"),n.uniforms.map=e.getUniformLocation(n.program,"map"),n.uniforms.tNormalDepth={location:null,value:null},n.uniforms.tNormalDepth.location=e.getUniformLocation(n.program,"tNormalDepth"),n.uniforms.opacity=e.getUniformLocation(n.program,"opacity"),n.uniforms.color=e.getUniformLocation(n.program,"color"),n.uniforms.scale=e.getUniformLocation(n.program,"scale"),n.uniforms.rotation=e.getUniformLocation(n.program,"rotation"),n.uniforms.screenPosition=e.getUniformLocation(n.program,"screenPosition"),n.uniforms.screenPositionFlare=e.getUniformLocation(n.program,"screenPositionFlare")},this.dispose=function(){e.deleteBuffer(this._lensFlare.vertexBuffer),e.deleteBuffer(this._lensFlare.elementBuffer),e.deleteProgram(this._lensFlare.program)},this.render=function(r,n,a,s){var o=r.__webglFlares,l=o.length;if(l&&t.lensFlareEnabled){var h,c,d,u,p,f=this._lensFlare,g=new i.Vector3,m=s/a,v=.5*a,y=.5*s,S=16/s,_=new i.Vector2(S*m,S),x=new i.Vector3(1,1,0),b=new i.Vector2(1,1),w=f.uniforms,M=f.attributes;for(e.useProgram(f.program),e.enableVertexAttribArray(f.attributes.vertex),e.enableVertexAttribArray(f.attributes.uv),t.setTexture(w.tNormalDepth.value,0),e.uniform1i(w.tNormalDepth.location,0),e.uniform1i(w.map,1),e.bindBuffer(e.ARRAY_BUFFER,f.vertexBuffer),e.vertexAttribPointer(M.vertex,2,e.FLOAT,!1,16,0),e.vertexAttribPointer(M.uv,2,e.FLOAT,!1,16,8),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f.elementBuffer),e.disable(e.CULL_FACE),e.depthMask(!1),h=0;h<l;h++)if(S=16/s,_.set(S*m,S),u=o[h],g.set(u.matrixWorld.elements[12],u.matrixWorld.elements[13],u.matrixWorld.elements[14]),g.applyMatrix4(n.matrixWorldInverse),!(g.z>0)){g.applyProjection(n.projectionMatrix);var C=.5+.5*g.z;if(x.copy(g),b.x=x.x*v+v,b.y=x.y*y+y,b.x>0&&b.x<a&&b.y>0&&b.y<s)for(e.disable(e.DEPTH_TEST),e.uniform3f(w.screenPositionFlare,.5*(x.x+1),.5*(x.y+1),C),u.positionScreen.copy(x),u.customUpdateCallback?u.customUpdateCallback(u):u.updateLensFlares(),e.uniform1i(w.renderType,2),e.enable(e.BLEND),c=0,d=u.lensFlares.length;c<d;c++)(p=u.lensFlares[c]).opacity>.001&&p.scale>.001&&(x.x=p.x,x.y=p.y,x.z=p.z,S=p.size*p.scale/s,_.x=S*m,_.y=S,e.uniform3f(w.screenPosition,x.x,x.y,x.z),e.uniform2f(w.scale,_.x,_.y),e.uniform1f(w.rotation,p.rotation),e.uniform1f(w.opacity,p.opacity),e.uniform3f(w.color,p.color.r,p.color.g,p.color.b),t.setBlending(p.blending,p.blendEquation,p.blendSrc,p.blendDst),t.setTexture(p.texture,1),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0))}e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.depthMask(!0)}}},i.WebGLRenderer_backup=i.WebGLRenderer,i.WebGLRenderer=function(e){this.renderPointMode=0,this.renderLineMode=i.ShowAllRenderLineMode,this.renderFaceMode=i.ShowAllFaces,this.renderHiddenEdges=!1,this.halfVisibleSmoothEdges=!1,this.outlineWidth=1,this.ratioSSB=100,this.colorizeSSB=!1;var t=new i.PickingMode;this.pickingModeMSB=t.pickingModeMSB,this.pickingModeLSB=t.pickingModeLSB,i.WebGLRenderer_backup.call(this,e);this.getContext()},i.WebGLRenderer.prototype.computeRenderPriorityOpacity=function(e,t){var i=t?t.getRenderPriorityOpacity():null;return(null===i||i<0)&&(i=this.renderPriorityDefaultOpacity),i*e},i.WebGLRenderer.prototype.refreshUniformsPhysicalDSRoughnessMaps=function(e,t,r){var n=this.precomputedTexture;if(e.precomputedTexture&&n&&(e.precomputedTexture.value=n),t.envMipMap&&t.envMipMap[0]){e.envMap.value=t.envMipMap[0],e.envMap2.value=t.envMipMap[1];var a=1,s=1;if(e.envMap.value&&e.envMap.value.hdr&&(e.envMap.value.image?(a=parseInt(e.envMap.value.image.width),s=parseInt(e.envMap.value.image.height)):(a=parseInt(e.envMap.value.width),s=parseInt(e.envMap.value.height)),e.envMapHDRSize.value.x=a,e.envMapHDRSize.value.y=s),e.envMap2&&e.envMapHDRToMipsRatio){var o=1;o=e.envMap2.image?parseInt(e.envMap2.image.width)/a:parseInt(e.envMap2.width)/a,e.envMapHDRToMipsRatio.value=o}var l=t.envMipMap[0].envMapExposureSpecular,h=t.envMipMap[0].envMapExposureDiffuse;e.envMapExposureSpecular.value=l||0===l?l:1,e.envMapExposureDiffuse.value=h||0===h?h:1,e.ambienceMatrix.value=t.ambienceMatrix?t.ambienceMatrix:new i.Matrix4,t.useFiniteEnvMap&&(e.sphereCenter.value=t.parallaxCorrectionParameters.sphereCenter,e.sphereRadius.value=t.parallaxCorrectionParameters.sphereRadius,e.projectionCenter.value=t.parallaxCorrectionParameters.projectionCenter)}t.reflectionProbes&&t.reflectionProbes.length&&(e.reflectionProbe.value=t.reflectionProbes[0].map0,e.reflectionProbeMips.value=t.reflectionProbes[0].map1,e.reflectionProbePos.value=t.reflectionProbes[0].position,e.reflectionProbeProxyMin.value=t.reflectionProbes[0].geomProxy.min,e.reflectionProbeProxyMax.value=t.reflectionProbes[0].geomProxy.max,e.envMapHDRToMipsRatio&&(e.envMapHDRToMipsRatio.value=1))},i.createPlaneGeometryDS=function(e,t){var n=new i.BufferGeometryDS;n.vertexIndexArray=new Uint16Array(6),n.vertexPositionArray=new Float32Array(12),n.vertexNormalArray=new Float32Array(12),n.vertexUvArray=new Float32Array(12);var a=new r.SGRep({solid:!1}),s=[],o=new r.DrawingGroup(i.MaterialUtils.createShinyFaceMaterial({side:i.DoubleSide,color:new i.Color(16777215)}),null,4,0,6,s,void 0,i.GeomTypeEnum.UNKNOWN,0);o.geometry=n,n.drawingGroups.push(o);var l=new r.SGPrimitive({start:0,count:6,cgmId:0,rep:a,group:o});s.push(l),a._primitives.push(l);var h=n.vertexIndexArray;h[0]=0,h[1]=1,h[2]=3,h[3]=1,h[4]=2,h[5]=3;var c=n.vertexPositionArray;c[0]=-.5*e,c[1]=.5*t,c[2]=0,c[3]=-.5*e,c[4]=-.5*t,c[5]=0,c[6]=.5*e,c[7]=-.5*t,c[8]=0,c[9]=.5*e,c[10]=.5*t,c[11]=0;for(var d=n.vertexNormalArray,u=0;u<4;u++)d[3*u]=0,d[3*u+1]=0,d[3*u+2]=1;var p=n.vertexUvArray;return p[0]=0,p[1]=1,p[2]=0,p[3]=0,p[4]=0,p[5]=0,p[6]=1,p[7]=0,p[8]=0,p[9]=1,p[10]=1,p[11]=0,n.computeBoundingBox(),n.computeBoundingSphere(),n},i.convertParticleSystemToBufferGeometryDS=function(e){if(e&&0===e._type&&e.vertices){var t=e.vertices.length,n=new i.BufferGeometryDS;n.vertexPositionArray=new Float32Array(3*t),n.vertexPositionArray.nonindexedPoints=!0,n.vertexIndexArray=new Uint16Array(1),n.vertexIndexArray[0]=0;var a=new r.SGRep({solid:!1}),s=[],o=new r.DrawingGroup(i.MaterialUtils.createShinyFaceMaterial({side:i.DoubleSide,color:new i.Color(16777215)}),null,0,0,t,s,void 0,i.GeomTypeEnum.UNKNOWN,0);o.geometry=n,n.drawingGroups.push(o);var l=new r.SGPrimitive({start:0,count:t,cgmId:0,rep:a,group:o});s.push(l),a._primitives.push(l);for(var h=n.vertexPositionArray,c=0;c<t;c++)h[3*c]=e.vertices[c].x,h[3*c+1]=e.vertices[c].y,h[3*c+2]=e.vertices[c].z;return n.computeBoundingBox(),n.computeBoundingSphere(),n}},i.DrawableInterval=function(e,t,i,r,n,a,s){this.layerNum=e||0,this.material=r||null,this.gas=null,n&&(this.gas=n.__getGAS(this.gas)),this.start=t||0,this.count=i||0,this.primitiveStart=0,this.primitiveCount=0,this.primitiveOverrideMaterial=a||null,this.noZ=void 0!==s?s:-1},i.DrawableInterval.prototype={constructor:i.DrawableInterval,clone:function(){var e=new i.DrawableInterval(this.layerNum,this.start,this.count,this.material,this.gas,void 0,this.noZ);return e.primitiveStart=this.primitiveStart,e.primitiveCount=this.primitiveCount,e},skip:function(e,t){return this.layerNum<=0||!!(e&&this.gas&&this.gas.isGAS)&&!this.gas.visibleInCurrentSpace(e,t)},getMaterial:function(){return this.primitiveOverrideMaterial?this.primitiveOverrideMaterial:this.material}},i.LayerInterval=function(e,t,i){this.geometry=void 0!==e?e:null,this.drawableGroup=void 0!==t?t:null,this.drawableInterval=void 0!==i?i:null},i.LayerInterval.prototype={constructor:i.LayerInterval,clone:function(){var e=new i.LayerInterval;return e.geometry=this.geometry,e.drawableGroup=this.drawableGroup,e.drawableInterval=this.drawableInterval.clone(),e},_computeOrientedBoundingBox:function(e){var t=!0,r=this.drawableInterval,n=this.geometry,a=n.vertexIndexArray,s=new i.Vector3,o=new i.Vector3,l=new i.Vector3;if(r.layerNum&&r.count){var h=r.start,c=r.start+r.count;if(t){t=!1;var d=a[h];n.getVertexPosition(d,l),s.set(l.x,l.y,l.z).applyMatrix4(e),o.set(l.x,l.y,l.z).applyMatrix4(e)}for(var u=h;u<c;u++){d=a[u];n.getVertexPosition(d,l),l.applyMatrix4(e),l.x<s.x&&(s.x=l.x),l.y<s.y&&(s.y=l.y),l.z<s.z&&(s.z=l.z),l.x>o.x&&(o.x=l.x),l.y>o.y&&(o.y=l.y),l.z>o.z&&(o.z=l.z)}}return new i.Box3(s,o)}},i.BufferLayer=function(e){this.layers=[],this.upToDate=!1,this.mesh=e},i.BufferLayer.prototype={constructor:i.BufferLayer,clone:function(e){for(var t=new i.BufferLayer(this.mesh),r=0;r<this.layers.length;r++){var n=this.layers[r].clone();e&&(n.drawableInterval.layerNum=0),t.addLayerInterval(n)}return t},getIntervals:function(e,t,i){for(var r=[],n=0;n<this.layers.length;n++){var a=this.layers[n];a.geometry!==e||t&&a.drawableGroup!==t||r.push(i?a:a.drawableInterval)}return r},getInterval:function(e){for(var t=e.group,i=t.geometry,r=this.getIntervals(i,t),n=0;n<r.length;n++){var a=r[n];if(e.start>=a.start&&e.start+e.count<=a.start+a.count)return a}return null},addLayerInterval:function(e){this.layers.push(e),this.upToDate=!1},removeIntervals:function(e,t){for(var i=void 0!==t,r=0;r<this.layers.length;r++){var n=this.layers[r];n.geometry==e&&(!i||i&&n.drawableGroup==t)&&(this.layers.splice(r,1),r--)}this.upToDate=!1},addPrimitivesToLayersOpacity:function(e,t,i){var r=[];this.addPrimitivesToLayers_internal(e,t,function(e){var t=r[e.id];return t||((t=e.clone()).opacity=i,t.transparent=!0,r[e.id]=t),t}),this.upToDate=!1},addPrimitivesToLayers:function(e,t,i,r,n,a){this.addPrimitivesToLayers_internal(e,t,function(){return i},r,n,a),this.upToDate=!1},addPrimitivesToLayers_internal:function(e,t,i,r,n,a){var s;this.mesh._flagAsGSSOInvalidated();var o=new Map;for(s=0;s<e.length;s++){var l=e[s],h=l.getGroup(),c=o.get(h);c||(c=[],o.set(h,c)),c.push(l)}var d=[];for(o.forEach((e,t)=>{d.push(e)}),s=0;s<d.length;s++)d[s].sort(function(e,t){return e.getStart()<t.getStart()?-1:e.getStart()>t.getStart()?1:0});for(s=0;s<d.length;s++){var u=d[s][0].getGroup(),p=u.geometry,f=i(u.gas);this.addPrimitivesToLayer(p,u,d[s],t,f,r,n,a)}},addPrimitivesToLayer:function(e,t,r,n,a,s,o,l){var h,c,d=this.getIntervals(e,t,!0),u=[],p=function(e){return s?s.__getGAS(e):e};if(d.length){var f=0,g=d[f].drawableInterval,v=p(g.gas),y=void 0===a?g.material:a,S=void 0===o?g.primitiveOverrideMaterial:o,_=void 0===l?g.noZ:l;h=g.start,c=g.count;var x=0,b=!0;for(P=0;P<r.length;P++){var w=(E=r[P]).getStart(),M=E.getCount();if(M&&(b||x!==w)){for(b=!1,x=w;w+M>h+c;)c&&u.push(new i.DrawableInterval(g.layerNum,h,c,g.material,g.gas,g.primitiveOverrideMaterial,g.noZ)),v=p((g=d[++f].drawableInterval).gas),y=void 0===a?g.material:a,S=void 0===o?g.primitiveOverrideMaterial:o,_=void 0===l?g.noZ:l,h=g.start,c=g.count;if(n!==g.layerNum||y!==g.material||v!==g.gas||S!==g.primitiveOverrideMaterial||_!==g.noZ){w>h&&u.push(new i.DrawableInterval(g.layerNum,h,w-h,g.material,g.gas,g.primitiveOverrideMaterial,g.noZ)),u.push(new i.DrawableInterval(n,w,M,y,v,S,_));var C=w+M;c=g.count-C+g.start,h=C}}}c>0&&u.push(new i.DrawableInterval(g.layerNum,h,c,g.material,g.gas,g.primitiveOverrideMaterial,g.noZ));for(var P=f+1;P<d.length;P++)u.push(d[P].drawableInterval);this.removeIntervals(e,t)}else for(P=0;P<r.length;P++){var E=r[P];u.push(new i.DrawableInterval(n,E.start,E.count,a||null,s||null,o||null,l))}var A=u[0].layerNum,T=u[0].material,D=u[0].gas,I=u[0].primitiveOverrideMaterial,R=u[0].noZ;for(h=u[0].start,c=0,P=0;P<u.length;P++){var O=u[P];if(O.layerNum===A&&O.material===T&&O.gas===D&&O.primitiveOverrideMaterial===I&&O.noZ===R)c+=O.count;else{var L=new i.DrawableInterval(A,h,c,T,D,I,R);this.addLayerInterval(new i.LayerInterval(e,t,L)),A=O.layerNum,T=O.material,I=O.primitiveOverrideMaterial,D=O.gas,R=O.noZ,h=O.start,c=O.count}if(P==u.length-1){L=new i.DrawableInterval(A,h,c,T,D,I,R);this.addLayerInterval(new i.LayerInterval(e,t,L))}}for(P=0;P<this.layers.length;P++){var V=this.layers[P],F=V.drawableGroup;if(F===t&&V.geometry===e){var B=V.drawableInterval,N=0,G=F.getPrimitivesCount();if(G){if(G<20)for(;B.start>F.getPrimitiveStart(N);)N++;else N=m(F,B.start);for(B.primitiveStart=N;B.start+B.count>F.getPrimitiveStart(N)+F.getPrimitiveCount(N);)N++;B.primitiveCount=N-B.primitiveStart+1}else B.primitiveStart=0,B.primitiveCount=0}}},setDGToLayer:function(e,t,i,r,n,a,s){for(var o=this.getIntervals(e,t),l=0;l<o.length;l++){var h=o[l];void 0!==i&&(h.layerNum=i),void 0!==r&&(h.material=r),void 0!==n&&(h.gas=n.__getGAS(h.gas)),void 0!==s&&(h.noZ=s),void 0!==a&&(h.primitiveOverrideMaterial=a)}}},i.EventTarget=function(){var e={};this.addEventListener=function(t,i){null==e[t]&&(e[t]=[]),-1===e[t].indexOf(i)&&e[t].push(i)},this.dispatchEvent=function(t){for(var i in e[t.type])e[t.type].hasOwnProperty(i)&&e[t.type][i](t)},this.removeEventListener=function(t,i){var r=e[t].indexOf(i);-1!==r&&e[t].splice(r,1)}};var v={uniforms:i.UniformsUtils.merge([i.UniformsLib.common,i.UniformsLib.lights,i.UniformsLib.shadowmap,i.UniformsLib.postprocess,{ambient:{type:"c",value:new i.Color(328965)},emissive:{type:"c",value:new i.Color(0)},specular:{type:"c",value:new i.Color(1118481)},border:{type:"c",value:new i.Color(516)},borderAlpha:{type:"f",value:1},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new i.Vector3(1,1,1)},attenuation:{type:"i",value:0},displayGrid:{type:"f",value:1},displayPlane:{type:"f",value:1},gridFromBelow:{type:"f",value:1},gridTexture:{type:"t",value:null},gridTexture2:{type:"t",value:null},gridTexture3:{type:"t",value:null},gridTexture4:{type:"t",value:null},nbSteps:{type:"f",value:5},gridUnit:{type:"f",value:1},gridOffset:{type:"v2",value:new i.Vector2},gridCoeff:{type:"f",value:0},gridColor:{type:"c",value:new i.Color(16777215)},planeSize:{type:"f",value:100},planeBorder:{type:"f",value:1},planeFalloff:{type:"f",value:0},onlyDiffuse:{type:"f",value:0},gridFalloff:{type:"f",value:0},uvScale:{type:"f",value:1},planeOpacity:{type:"f",value:1}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","#ifndef USE_MAP","varying vec2 vUv;","#endif",i.ShaderChunk.map_pars_vertex,i.ShaderChunk.clip_pars_vertex,i.ShaderChunk.lights_phong_pars_vertex,i.ShaderChunk.color_pars_vertex,i.ShaderChunk.shadowmap_pars_vertex,"void main() {","vUv = uv;",i.ShaderChunk.color_vertex,i.ShaderChunk.default_vertex_with_normal,i.ShaderChunk.defaultnormal_vertex,i.ShaderChunk.clip_vertex,"vViewPosition = -mvPosition.xyz;","vNormal = normalize( transformedNormal );",i.ShaderChunk.worldpos_vertex,i.ShaderChunk.lights_phong_vertex,i.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["const vec3 vOrthoDir = vec3(0.0, 0.0, 1.0);","uniform vec3 diffuse;","uniform float planeOpacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform vec3 border;","uniform float borderAlpha;","uniform int attenuation;","#ifdef PLANE_V2","const float alphaSlope = 0.66666666667;","const float alphaSlope2 = 0.44444444444;","const float edgeSize = 0.01;","const float stepSize = 0.001;","const float small2GridWidth = 0.0005;","const float smallGridWidth = 0.0005;","const float bigGridWidth = 0.0005;","uniform float displayGrid;","uniform float displayPlane;","uniform float onlyDiffuse;","uniform float gridFromBelow;","uniform float planeFalloff;","uniform float gridFalloff;","uniform float planeSize;","uniform float planeBorder;","uniform sampler2D gridTexture;","uniform sampler2D gridTexture2;","uniform sampler2D gridTexture3;","uniform sampler2D gridTexture4;","uniform float nbSteps;","uniform float gridUnit;","uniform vec2 gridOffset;","uniform float gridCoeff;","uniform vec3 gridColor;","#ifdef USE_MAP","uniform sampler2D map;","#endif","#endif","uniform float uvScale;","varying vec2 vUv;","vec2 uvToUse;",i.ShaderChunk.color_pars_fragment,i.ShaderChunk.lights_phong_pars_fragment,i.ShaderChunk.shadowmap_pars_fragment,i.ShaderChunk.postprocess_pars_fragment,"void main() {","uvToUse = vUv * uvScale;","vec3 I = vOrthoDir;","gl_FragColor = vec4(1.0);","if (!(projectionMatrix[3][3] > 0.0)) {","  I = normalize(vViewPosition);","}","float fresnelFactor = dot(I, vNormal);","#ifndef PLANE_V2","if (fresnelFactor < 0.0) {","  discard;","}","if (attenuation == 0) {","  fresnelFactor = 1.0;","}","#endif",i.ShaderChunk.alphatest_fragment,"float shininessValue = shininess;",i.ShaderChunk.specularmap_fragment,i.ShaderChunk.lights_phong_fragment,i.ShaderChunk.color_fragment,"vec3 cCenter = gl_FragColor.xyz;","vec3 cBorder = border;","#ifdef PLANE_V2","cCenter = (cCenter.xyz * (1.0 - onlyDiffuse)) + (onlyDiffuse * diffuse);","float dUV = length(2.0 * vUv - 1.0);","float borderMask = planeBorder * smoothstep(1.0 - 2.0 * edgeSize, 1.0 - 2.0 * edgeSize + stepSize, dUV) * smoothstep(1.0 - edgeSize + stepSize, 1.0 - edgeSize, dUV);","float a2 = max(1.0 - alphaSlope2 * (1.0 + gridCoeff) * (1.0 + gridCoeff), 0.0);","float a1 = 1.0 - alphaSlope2 * gridCoeff * gridCoeff;","float a0 = 1.0 - alphaSlope2 * (1.0 - gridCoeff) * (1.0 - gridCoeff);","float a00 = max(1.0 - alphaSlope2 * (2.0 - gridCoeff) * (2.0 - gridCoeff), 0.0);","vec2 div = 0.5 * planeSize * (2.0 * vUv - 1.0) + gridOffset;","vec2 big2Div = (1.0 / (nbSteps * nbSteps)) * div / gridUnit;","vec2 bigDiv = (1.0 / nbSteps) * div / gridUnit;","vec2 smallDiv = div / gridUnit;","vec2 small2Div = nbSteps * div / gridUnit;","float gridAlpha = texture2D(gridTexture, small2Div).a;","gridAlpha *= a2;","gridAlpha += a1 * texture2D(gridTexture2, smallDiv).a;","gridAlpha += a0 * texture2D(gridTexture3, bigDiv).a;","gridAlpha += a00 * texture2D(gridTexture4, big2Div).a;","gridAlpha = min(1.0, gridAlpha);","#ifdef USE_MAP","vec4 texelColor = texture2D( map, uvToUse );","#ifdef GAMMA_INPUT","texelColor.xyz = convertToLinear(texelColor.xyz);","#endif","cCenter = mix(cCenter, texelColor.xyz, texelColor.a);","#endif","float planeAlpha = 1.0001 - smoothstep(planeFalloff, 1.0, dUV);","gridAlpha *= 1.0001 - smoothstep(gridFalloff, 1.0, dUV);","planeAlpha *= planeOpacity * step(0.0, fresnelFactor) * displayPlane;","gridAlpha *= step(-gridFromBelow, fresnelFactor) * displayGrid;","vec4 planeCol = vec4(mix(mix(cCenter, cBorder, planeBorder), cCenter, planeAlpha), mix(planeAlpha, 1.0, planeBorder));","vec4 gridCol = vec4(gridColor * gridColor, gridAlpha);","vec4 gridOverPlaneColor = vec4((gridCol.xyz * gridCol.a + planeCol.xyz * planeCol.a * (1.0 - gridCol.a)) / (0.0001 + gridCol.a + planeCol.a * (1.0 - gridCol.a)), gridCol.a + planeCol.a * (1.0 - gridCol.a));","gl_FragColor = mix(gridOverPlaneColor, vec4(cBorder, borderMask), step(1.0 - 2.0 * edgeSize, dUV));","#else","vec2 dUV = 2.0 * (vUv * 2.0 - 1.0);","float dist = dot(dUV, dUV);","float dist2 = clamp(dist * dist, 0.0, 1.0);","dist = clamp(dist, 0.0, 1.0);","gl_FragColor = vec4(mix(cCenter, mix(cCenter, cBorder, borderAlpha), dist), fresnelFactor*(1.0 - dist2));","#endif",i.ShaderChunk.postprocess_fragment,i.ShaderChunk.linear_to_gamma_fragment,"}"].join("\n")};return Object.defineProperty(i,"InfinitePlaneShader",{get:function(){return console.error("Using internal shader, use THREE.PlaneMaterial instead"),v},set:function(){throw"NO"}}),i.HatchingMeshMaterial=function(e){var t={side:i.FrontSide,vertexColors:i.VertexColorType.RGBA,force:!0};i.MeshBasicMaterial.call(this,t),this.activatePDSFX();var r={planeU:{type:"v3",value:new i.Vector3(1,0,0)},planeV:{type:"v3",value:new i.Vector3(0,1,0)},hatchingDirection:{type:"v2",value:new i.Vector2(1,-1)},hatchingNormal:{type:"v2",value:new i.Vector2(-1,-1)},hatchingSpaceWidth:{type:"f",value:10},hatchingSpaceColor:{type:"v4",value:new i.Vector4(10,10,10,1)},hatchingLineWidth:{type:"f",value:1},hatchingLineColor:{type:"v4",value:new i.Vector4(0,0,0,1)}};this.setPDSFXUniforms(r);this.setPDSFXVaryings({_uv:{type:"v2"},myPosition:{type:"v4"}});this.setPDSFXGlobalShaderCode("vec4 _mvPosition;","");var n={ProcessViewTangentSpace:"void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) { _mvPosition = vec4(ioWorldViewTS.Position, 0.0); }",ComputeVaryingValues:["void ComputeVaryingValues() {","mat4 VM = vGetViewMatrix();","vec3 mvPlaneU = (VM * vec4(planeU, 0.0)).xyz;","vec3 mvPlaneV = (VM * vec4(planeV, 0.0)).xyz;","_uv = vec2(dot(_mvPosition.xyz, mvPlaneU), dot(_mvPosition.xyz, mvPlaneV))-vec2(dot(VM[3].xyz, mvPlaneU), dot(VM[3].xyz, mvPlaneV));","}"].join("\n")},a={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","float eval = hatchingNormal.x*_uv.x + hatchingNormal.y*_uv.y;","float k = mod(eval, hatchingSpaceWidth);","vec2 fwx = dot(hatchingNormal, dFdx(_uv))*hatchingNormal;","vec2 fwy = dot(hatchingNormal, dFdy(_uv))*hatchingNormal;","vec2 fw = abs(fwx) + abs(fwy);","float fwlen = length(fw);","float tol = min(hatchingLineWidth*fwlen, hatchingSpaceWidth - fwlen);","if (k < tol/2.0 || k > hatchingSpaceWidth - tol/2.0) {","  ioFinalColor = hatchingLineColor;","} else {","  ioFinalColor = hatchingSpaceColor;","}","}"].join("\n")};this.setPDSFXOverridableFunctions(n,a),this.stripesDirection=new i.Vector2(1,1),this.spaceWidth=1,this.spaceColor=new i.Color(16777215),this.spaceOpacity=1,this.stripesWidth=1,this.stripesColor=new i.Color(0),this.stripesOpacity=1,this.autoSpaceColor=!1,this.autoStripesColor=!1,this.enableClipPlanes=!0,this._refreshPDSFXUniforms_private=function(e,t,r){var n=this._renderedClipPlane;if(n){var a=new i.Vector3;a.crossVectors(n.normal,n.upVector),a.normalize();var s=new i.Vector3;s.crossVectors(a,n.normal),this.updatePDSFXUniform("planeU",a),this.updatePDSFXUniform("planeV",s)}this.updatePDSFXUniform("hatchingDirection",this.stripesDirection.clone().normalize()),this.updatePDSFXUniform("hatchingNormal",new i.Vector2(this.stripesDirection.y,-this.stripesDirection.x).normalize()),this.updatePDSFXUniform("hatchingSpaceWidth",this.spaceWidth),this.updatePDSFXUniform("hatchingLineWidth",this.stripesWidth),e.gammaInput?(this.updatePDSFXUniform("hatchingSpaceColor",new i.Vector4(this.spaceColor.r*this.spaceColor.r,this.spaceColor.g*this.spaceColor.g,this.spaceColor.b*this.spaceColor.b,this.stripesOpacity)),this.updatePDSFXUniform("hatchingLineColor",new i.Vector4(this.stripesColor.r*this.stripesColor.r,this.stripesColor.g*this.stripesColor.g,this.stripesColor.b*this.stripesColor.b,this.stripesOpacity))):(this.updatePDSFXUniform("hatchingSpaceColor",new i.Vector4(this.spaceColor.r,this.spaceColor.g,this.spaceColor.b,this.stripesOpacity)),this.updatePDSFXUniform("hatchingLineColor",new i.Vector4(this.stripesColor.r,this.stripesColor.g,this.stripesColor.b,this.stripesOpacity)))},this.setValues(e)},i.HatchingMeshMaterial.prototype=Object.create(i.MeshBasicMaterial.prototype),i.HatchingMeshMaterial.prototype.clone=function(){var e=new i.HatchingMeshMaterial;return i.MeshBasicMaterial.prototype.clone.call(this,e),e.stripesDirection=this.stripesDirection.clone(),e.spaceWidth=this.spaceWidth,e.spaceColor=this.spaceColor.clone(),e.spaceOpacity=this.spaceOpacity,e.stripesWidth=this.stripesWidth,e.stripesColor=this.stripesColor.clone(),e.stripesOpacity=this.stripesOpacity,e.autoStripesColor=this.autoStripesColor,e.autoSpaceColor=this.autoSpaceColor,e.updatePDSFXUniform("planeU",this.getPDSFXUniform("planeU").value.clone()),e.updatePDSFXUniform("planeV",this.getPDSFXUniform("planeV").value.clone()),e},i.HatchingMeshMaterial.prototype.getType=function(){return"Hatching"},i.CSSSVGNode=function(e){i.Object3D.call(this),this.element=e,this.element.renderable=this,this.geometry=new i.Geometry,this.geometry.boundingSphere=new i.Sphere},i.CSSSVGNode.prototype=Object.create(i.Object3D.prototype),UWA.namespace("THREEDS/Core",i)}),define("Visualization/ThreeJS_DS",["DS/Visualization/ThreeJS_DS","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ThreeJS_DS"),e}),define("DS/Visualization/BudgetedRenderManager",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=e.extend({init:function(e){return this.viewer=e,this._frameTime=0,this._isActive=!1,this._isSimpleActive=!0,this._lastRefreshStamp=performance.now(),this._objectivePercentage=-1,this._shiftToObjective=0,this._shiftStart=0,this._renderTimeStart=0,this._lastRenderTime=16.7,this._lastRenderFrameTime=16.7,this._maxTime=0,this._simpleMaxTime=2e3,this._renderCallbackId=-1,this._startStamp=performance.now(),this._preRenderCallBackId=-1,this._postRenderCallBackId=-1,this},_setAsRenderFrame:function(){this._isRenderFrame=!0},_askForRender:function(e){if(this._isActive||this._isSimpleActive)if(this._isSimpleActive){(i=(t=performance.now())-this._lastRefreshStamp)>this._simpleMaxTime&&(e.budgeted=!1,this._lastRefreshStamp=t,this.viewer.render(e))}else{var t,i=(t=performance.now())-this._lastRefreshStamp,r=(this._startStamp,this._objectivePercentage),n=(performance.now()-this._shiftStart)/this._shiftToObjective;r=1-(n=(n=Math.min(Math.max(0,n),1))*n*(3-2*n))+r*n;var a=this._lastRenderTime*(1-r)/r-i;if(a<=0||this._maxTime>0&&i>this._maxTime)e.budgeted=!1,this._lastRefreshStamp=t,this._renderCallbackId>=0&&(clearTimeout(this._renderCallbackId),this._renderCallbackId=-1),this.viewer.render(e);else if(this._renderCallbackId<0){var s=this;this._renderCallbackId=setTimeout(function(){s.viewer.render(e)},a)}}else e.budgeted=!1,this.viewer.render(e)},_resetShift:function(){this._shiftStart=performance.now(),this._renderCallbackId>=0&&(clearTimeout(this._renderCallbackId),this._renderCallbackId=-1)},resetMeasures:function(){this._startStamp=performance.now(),this._lastRefreshStamp=performance.now(),this._lastrenderTime=16.7},setBudget:function(e){this._objectivePercentage=Math.max(0,Math.min(1,e)),this._isActive=!0,this._isSimpleActive=!1;var t=this;if(-1===this._preRenderCallBackId){this._preRenderCallBackId=this.viewer.onPreRender(function(){t._renderTimeStart=performance.now()});this._postRenderCallBackId=this.viewer.onPostRender(function(){t._lastRenderTime=performance.now()-t._renderTimeStart})}this.resetMeasures()},setSimpleBudget:function(e){this._isSimpleActive=e,e&&this._isActive&&(this._isActive=!1)},disableBudget:function(){this._isActive=!1,this._objectivePercentage=-1,this._preRenderCallBackId>=0&&(this.viewer.unsubscribe(this._preRenderCallBackId),this.viewer.unsubscribe(this._postRenderCallBackId),this._preRenderCallBackId=-1,this._postRenderCallBackId=-1)},setSimpleMaxTime:function(e){this._simpleMaxTime=e},setMaxTime:function(e){this._maxTime=e},setShiftingObjective:function(e){this._shiftToObjective=e}});return UWA.namespace("THREEDS/BudgetedRenderManager",i)}),define("DS/Visualization/ColladaLoader",["DS/VisuLoaders/ColladaLoader","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return t}),define("DS/Visualization/CameraSystem",["UWA/Class","DS/Shaders/StereoShaders","DS/Plugins/ShaderPass","DS/Plugins/RenderPass","DS/Visualization/ThreeJS_DS","DS/Plugins/ClearPass"],function(e,t,i,r,n,a){"use strict";var s=e.extend({init:function(){this._computeCameraArrayCB=null,this._predefinedCombineShader=null,this._shaderParameters=null,this._extFrameBuffer=null},setComputeCameraArrayCB:function(e,t){this._computeCameraArrayCB=e,this.useExternalProjectionMatrix=!!t},setUsePredefinedCombineShader:function(e,t){this._predefinedCombineShader=e,this._shaderParameters=t;var i=o[this._predefinedCombineShader];i.warmup&&i.warmup()},getViewportSize:function(e,t){return o[this._predefinedCombineShader].getViewportSize.apply(this,arguments)},computeCameraArray:function(e,t,i){var r,n=this._computeCameraArrayCB(e,t,i);for(r=0;n&&r<n.length;r++)n[r].updateProjectionMatrix(),n[r].projectionMatrixInverse.getInverse(n[r].projectionMatrix);return n},getUniformName:function(e){return o[this._predefinedCombineShader].uniformsName[e]},applyShaderParameters:function(e){var t;if(e&&this._shaderParameters)for(t in this._shaderParameters)e[t].value=this._shaderParameters[t]},isReady:function(){var e=o[this._predefinedCombineShader];return"ShaderPass"===e.type||e.ready},createPasses:function(e){var t=o[this._predefinedCombineShader];"ShaderPass"===t.type?(this.stereoPass=new i(t.combineShader,void 0,"stereoPass"),e.composerContext.setPassRenderToCanvas(this.stereoPass,!0)):"RenderPass"===t.type&&(this.clearPass=new a("combineClearPass"),e.addPass(this.clearPass),e.composerContext.setPassRenderToCanvas(this.clearPass,!0),this.stereoPass=new r(null,null,null,null,null,null,"combineStereoPass"),this.stereoPass.setDepthFunc("ALWAYS"),this.stereoPass.setDisableBackFaceCulling(!0),this.stereoScene=new n.Scene,this.stereoScene.renderResultIndices={},t.fillScene(this.stereoScene),this.stereoPass.scene=this.stereoScene,e.composerContext.setPassClear(this.clearPass,!0,new n.Color(0),1),e.composerContext.setPassRenderToCanvas(this.stereoPass,!0)),e.addPass(this.stereoPass)},updatePasses:function(e,t,i){var r,n=o[this._predefinedCombineShader];if("ShaderPass"===n.type){for(r=0;r<e.length;r++){var a=this.getUniformName(r);this.stereoPass.uniforms[a].value=i[e[r]]}this.applyShaderParameters(this.stereoPass.uniforms)}else if("RenderPass"===n.type){var s=this.stereoPass.scene;for(r=0;r<s.myMeshes.length;r++){var l;for(l in s.myMeshes[r].material.uniforms.tEye.value=i[e[s.renderResultIndices[s.myMeshes[r].id]]],n.parameters[r])s.myMeshes[r].material.uniforms[l].value=n.parameters[r][l];if(this._shaderParameters)for(l in this._shaderParameters[r])s.myMeshes[r].material.uniforms[l].value=this._shaderParameters[r][l]}}this.stereoPass.renderToScreen=t},isStereo:function(){return!0},setExternalFrameBuffer:function(e){this._extFrameBuffer=e},getExternalFrameBuffer:function(){return this._extFrameBuffer}}),o={leftRight:{getViewportSize:function(e,t){return{width:Math.floor(e/2),height:t}},combineShader:t.leftRight,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},oculusDK1:{getViewportSize:function(e,t){return{width:Math.floor(e/2),height:t}},combineShader:t.oculusDK1,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},anaglyph:{getViewportSize:function(e,t){return{width:e,height:t}},combineShader:t.anaglyph,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},oculusDK2:{getViewportSize:function(e,t){return{width:Math.floor(e/2),height:t}},ready:!1,warmup:function(){require(["DS/OculusDK2/OculusDK2DeformationMeshCreator"],function(e){o.oculusDK2.ready=!0,o.oculusDK2.OculusDK2DeformationMeshCreator=e})},fillScene:function(e){var i=o.oculusDK2;i.uniforms=n.UniformsUtils.clone(t.oculusDK2.uniforms);var r=new n.ShaderMaterial({uniforms:i.uniforms,vertexShader:t.oculusDK2.vertexShader,fragmentShader:t.oculusDK2.fragmentShader});i.OculusDK2DeformationMeshCreator.fillScene(e,r)},parameters:[{eyeToSourceUVScale:new n.Vector2(.464894474,.376141697),eyeToSourceUVOffset:new n.Vector2(.492164134,.5)},{eyeToSourceUVScale:new n.Vector2(.464894474,.376141697),eyeToSourceUVOffset:new n.Vector2(.507835866,.5)}],type:"RenderPass"}};return s}),define("DS/Visualization/WebGLViewerEffectSettings",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Effects/ESMEffect"],function(e,t,i){"use strict";var r={AntiAliasing:{static:"NoAA",dynamic:"NoAA",override:"NoAA",contentChecker:!1},Outline:{static:!0,dynamic:!1,override:!0},PixelCulling:{static:4.5,dynamic:4.5,override:4.5},Transparency:{static:"AlphaBlending",dynamic:"AlphaBlending",override:"AlphaBlending"},GroundShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowGroundShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},InterObjectShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowInterObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},TransparentObjectShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowTransparentObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},ShadowQuality:{static:"PCF",dynamic:"PCF",override:"PCF"},ShadowFilter:{static:"Low",dynamic:"Low",override:"Low"},FlakesQuality:{static:"Low",dynamic:"Low",override:"Low"},DefaultMaterialQuality:{static:"Low",dynamic:"Low",override:"Low"},DownsamplingFactor:{static:1,dynamic:1,override:1},GroundReflection:{static:!1,dynamic:!1,override:!1},AllowGroundReflection:{static:!0,dynamic:!0,override:!0},SSAO:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSAO:{static:!0,dynamic:!0,override:!0,contentChecker:!1},SSAONbSamples:{static:16,dynamic:16,override:16},Bloom:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowBloom:{static:!0,dynamic:!0,override:!0,contentChecker:!1},DepthOfField:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowDepthOfField:{static:!0,dynamic:!0,override:!0,contentChecker:!1},ZPrePass:{static:!1,dynamic:!1,override:!1,contentChecker:!1},SSR:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSR:{static:!0,dynamic:!0,override:!0,contentChecker:!1},SSRefraction:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSRefraction:{static:!0,dynamic:!0,override:!0,contentChecker:!1}};class n{constructor(e,t){this.viewer=e,this.settings={AntiAliasing:{static:e.antiAliasing,dynamic:"MSAA"!==e.antiAliasing?e.antiAliasing:"SMAA",override:e.antiAliasing,contentChecker:!1},Outline:{static:!0,dynamic:!1,override:!0},PixelCulling:{static:4.5,dynamic:4.5,override:4.5},Transparency:{static:t.enableOIT?"WeightedAverage":"AlphaBlending",dynamic:t.enableOIT?"WeightedAverage":"AlphaBlending",override:t.enableOIT?"WeightedAverage":"AlphaBlending"},GroundShadows:{static:e.useGroundShadow,dynamic:e.useGroundShadow,override:e.useGroundShadow,contentChecker:!1},AllowGroundShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},InterObjectShadows:{static:e.useShadowMap,dynamic:e.useShadowMap,override:e.useShadowMap,contentChecker:!1},AllowInterObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},TransparentObjectShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowTransparentObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},ShadowQuality:{static:e.shadowQuality,dynamic:e.shadowQuality,override:e.shadowQuality},ShadowFilter:{static:e.shadowFilter,dynamic:e.shadowFilter,override:e.shadowFilter},FlakesQuality:{static:"Ultra",dynamic:"Ultra",override:"Ultra"},DefaultMaterialQuality:{static:"High",dynamic:"High",override:"High"},DownsamplingFactor:{static:1,dynamic:1,override:1},GroundReflection:{static:e.useMirror,dynamic:e.useMirror,override:e.useMirror},AllowGroundReflection:{static:!0,dynamic:!0,override:!0},SSAO:{static:e.useSSAO,dynamic:e.useSSAO,override:e.useSSAO,contentChecker:!1},AllowSSAO:{static:!0,dynamic:!0,override:!0,contentChecker:!1},SSAONbSamples:{static:16,dynamic:16,override:16},Bloom:{static:e.useBloom,dynamic:e.useBloom,override:e.useBloom,contentChecker:!1},AllowBloom:{static:!0,dynamic:!0,override:!0,contentChecker:!1},DepthOfField:{static:e.useDOF,dynamic:e.useDOF,override:e.useDOF,contentChecker:!1},AllowDepthOfField:{static:!0,dynamic:!0,override:!0,contentChecker:!1},ZPrePass:{static:!1,dynamic:!1,override:!1,contentChecker:!1},SSR:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSR:{static:!0,dynamic:!0,override:!0,contentChecker:!1},SSRefraction:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSRefraction:{static:!0,dynamic:!0,override:!0,contentChecker:!1}},this._lqFallback=!1,this._blackListedEffects=new Set,e.useSSLR&&(this._blackListedEffects.add("SSRefraction"),this._blackListedEffects.add("SSR"))}_checkCompatibility(){this.viewer.renderer.isDeviceCompatibleWithSSR()||(this._blackListedEffects.add("SSRefraction"),this._blackListedEffects.add("SSR")),this.viewer.renderer.isDeviceCompatibleWithOIT()||this._blackListedEffects.add("Transparency"),this.viewer.renderer.isDeviceCompatibleWithSSAO()||this._blackListedEffects.add("SSAO")}updateViewerSettings(e,i){var r=this.viewer;this._setPixelCulling(e),this._setAntiAliasing(i),this._setShadow(e),this._setTransparentShadow(e),this._setShadowFilter(e),this._setShadowQuality(e),this._setGroundShadow(e),this._setOIT(e),this._setFlakesQuality(e),r.renderer.renderer._defaultAppearanceType!==t.DefaultAppearanceMode.__QA_AUTOMATION__&&this._setDefaultMaterialQuality(e),this._enableZPrePass(e),this._setMirror(e),this._setSSAO(e),this._setBloom(e),this._setDOF(e),this._setSSLR(e),this._setSSLRefraction(e),r.renderer.renderer.currentRendererMode=t.RendererMode[e];var n=r.renderer.SSAOEffect,a=r.renderer.SSAOIterativeEffect,s=this,o=function(t){t.setDynamicRadius(r.ssaoParams.dynamicRadius),t.setAdaptativeRadius(r.ssaoParams.adaptativeRadius),t.setRadius(r.ssaoParams.radius),t.setRadiusRange(r.ssaoParams.radiusMin,r.ssaoParams.radiusMax),t.setMinPixelRadius(r.ssaoParams.minPixelRadius),t.setAttenuation(r.ssaoParams.attenuation),t.setContrast(r.ssaoParams.contrast),t.setPower(r.ssaoParams.power),t.setThresholdAngle(r.ssaoParams.thresholdAngle),t.setNbSamples(s.getSSAONbSamples(e))};n&&o(n),a&&o(a)}_isBlackListed(e){return this._blackListedEffects.has(e)}getSetting(e,t){return this._blackListedEffects.has(e)?r[e][t]:this.settings[e][t]}setSetting(e,t,i){this._blackListedEffects.has(e)||(this.settings[e][t]=i)}updateAmbienceBackScale(e){var t=this.viewer;"FSAA"===this.getAntiAliasing(e)?t.ambience.getBackground().setBackplateScale(2):t.ambience.getBackground().setBackplateScale(1),t.ambience.update()}copySettings(e,t){var i=this;Object.entries(this.settings).forEach(r=>{i.settings[r[0]][e]=r[1][t]})}_setFromJson(e,t){var i=this;Object.entries(t).forEach(t=>{i.settings[t[0]]&&(i.settings[t[0]][e]=t[1])})}_updateState(e,i,r){var n=this.viewer,a=this.getSetting(e,i);this.setSetting(e,i,r),a!==this.getSetting(e,i)&&(n.renderer&&n.renderer.recompileAllShaders([t.RendererMode[i]]),n.render())}_updateQM(e,t,i){var r=this.viewer;r[e]&&r[e](i,t)}setShadow(t,i,r){var n=this.viewer.directionalLight;if(null!==n&&(n.LiSPSM=i,n.shadowCascade))for(var a=0;a<n.shadowCascadeArray.length;a++)n.shadowCascadeArray[a].LiSPSM=i;var s=this.getShadow("static"),o=r?[r]:["static","dynamic"];for(a=0;a<o.length;a++){var l=o[a];this._updateState("InterObjectShadows",l,t)}var h=this.getShadow("static");h!==s&&e.publish({event:"/WUX/AFR/CMD/VisuToggleShadow/"+(h?"BEGIN":"END")})}getShadow(e){return e=e||"static",this.getSetting("InterObjectShadows",e)}setAllowShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowShadow",n,e),this._updateState("AllowInterObjectShadows",n,e)}}getAllowShadow(e){return e=e||"static",this.getSetting("AllowInterObjectShadows",e)}_setShadow(e){this.viewer.useShadowMap=this.getShadow(e)&&this.getAllowShadow(e)}setShadowFilter(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetShadowFilter",n,e),this._updateState("ShadowFilter",n,e)}}_setShadowFilter(e){var r=this.viewer;if(this.getShadowFilter(e)!==r.shadowFilter){switch(r.shadowFilter=this.getShadowFilter(e),r.shadowFilter){case"PCF":r.renderer.renderer.shadowMapType=t.PCFShadowMap;break;case"PCFInterpol":r.renderer.renderer.shadowMapType=t.PCFInterpolShadowMap;break;case"PCFPoisson":case"poisson":r.renderer.renderer.shadowMapType=t.PCFPoissonShadowMap;break;case"PCFOptimized":r.renderer.renderer.shadowMapType=t.PCFOptimizedShadowMap;break;case"ESM":r.renderer.renderer.shadowMapType=t.ESMShadowMap,r.renderer.renderer.esmEffect||(r.renderer.renderer.esmEffect=new i(r.renderer.renderer,r.renderer.renderTargetPool));break;default:r.renderer.renderer.shadowMapType=t.BasicShadowMap}r._updateShadowMaps()}}getShadowFilter(e){return e=e||"static",this.getSetting("ShadowFilter",e)}setShadowQuality(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetShadowQuality",n,e),this._updateState("ShadowQuality",n,e)}}_setShadowQuality(e){var i=this.viewer;this.getShadowQuality(e)!==i.shadowQuality&&(i.shadowQuality=this.getShadowQuality(e),"Medium"===i.shadowQuality?i.renderer.renderer.shadowMapQuality=t.MediumQuality:"High"===i.shadowQuality?i.renderer.renderer.shadowMapQuality=t.HighQuality:i.renderer.renderer.shadowMapQuality=t.LowQuality,i._updateShadowMaps())}getShadowQuality(e){return e=e||"static",this.getSetting("ShadowQuality",e)}setGroundShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateState("GroundShadows",n,e)}}getGroundShadow(e){return e=e||"static",this.getSetting("GroundShadows",e)}_setGroundShadow(e){var t=this.getGroundShadow(e)&&this.getAllowGroundShadow(e),i=this.viewer;i.useGroundShadow!==t&&(i.useGroundShadow=t,i.renderer.resetGSSOCache(),i.dirLightGroundShadow.groundMaterial&&(i.useGroundShadow?i.dirLightGroundShadow.groundMaterial.defines.GROUND_SHADOW=1:i.dirLightGroundShadow.groundMaterial.defines.GROUND_SHADOW=0,i.dirLightGroundShadow.groundMaterial.needsUpdate=!0))}setAllowGroundShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowGroundShadow",n,e),this._updateState("AllowGroundShadows",n,e)}}getAllowGroundShadow(e){return e=e||"static",this.getSetting("AllowGroundShadows",e)}setTransparentShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateState("TransparentObjectShadows",n,e)}}getTransparentShadow(e){return e=e||"static",this.getSetting("TransparentObjectShadows",e)}setAllowTransparentShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowTransparentShadow",n,e),this._updateState("AllowTransparentObjectShadows",n,e)}}getAllowTransparentShadow(e){return e=e||"static",this.getSetting("AllowTransparentObjectShadows",e)}_setTransparentShadow(e){var t=this.viewer,i=this.getTransparentShadow(e)&&this.getAllowTransparentShadow(e);t.renderer.renderer.transparentShadowEnabled!==i&&(t._updateShadowMaps(),t.renderer.renderer.transparentShadowEnabled=i)}setOIT(e,t){var i=this.viewer;i.renderer&&!i.renderer.isDeviceCompatibleWithOIT()&&(console.warn("Warning: OIT is not compatible with this device"),e=!1,t=null);for(var r=t?[t]:["static","dynamic"],n=0;n<r.length;n++){var a=r[n],s=e?"WeightedAverage":"AlphaBlending";this._updateQM("_qmSetTransparency",a,s),this._updateState("Transparency",a,s)}}_setOIT(e){var t=this.getOIT(e),i=this.viewer;t&&i.getRenderPriority()?console.warn("Warning: OIT is not compatible with render priority"):i.renderer.renderer.useOIT!==t&&(i.renderer.setEffect("OIT",t),i.renderer.setEffect("OITnoZ",t))}getOIT(e){return e=e||"static","WeightedAverage"===this.getSetting("Transparency",e)}setFlakesQuality(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetFlakesQuality",n,e),this._updateState("FlakesQuality",n,e)}}_setFlakesQuality(e){this.viewer.renderer.renderer.flakesMode={Low:3,Medium:2,High:1,Ultra:0}[this.getFlakesQuality(e)]}getFlakesQuality(e){return e=e||"static",this.getSetting("FlakesQuality",e)}setDownsamplingFactor(e){for(var t=["static","dynamic"],i=0;i<t.length;i++){var r=t[i];this._updateQM("_qmSetDownsamplingFactor",r,e),this.setSetting("DownsamplingFactor",r,e)}}_setDownsamplingFactor(e){this.viewer.renderer.renderer._renderScale=this.getDownsamplingFactor()}getDownsamplingFactor(){return this.getSetting("DownsamplingFactor","static")}setDefaultMaterialQuality(e){for(var t=["static","dynamic"],i=0;i<t.length;i++){var r=t[i];this._updateQM("_qmSetDefaultMaterialQuality",r,e),this._updateState("DefaultMaterialQuality",r,e)}}_setDefaultMaterialQuality(e){var t=this.viewer,i={Low:!0,Medium:!0,High:!1,Ultra:!1}[this.getDefaultMaterialQuality()];t.renderer.renderer.gasAsPhong!=i&&(t.renderer.renderer.gasAsPhong=i,t.renderer.resetGSSOCache())}getDefaultMaterialQuality(){return this.getSetting("DefaultMaterialQuality","static")}enableZPrePass(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmEnableZPrePass",n,e),this.setSetting("ZPrePass",n,e)}}_enableZPrePass(e){this.viewer.renderer._enableZPrePass(this.zPrePassEnabled(e))}zPrePassEnabled(e){return e=e||"static",this.getSetting("ZPrePass",e)}setMirror(t,i,r,n,a){var s=this.viewer;n=void 0!==n?n:.3,a=void 0!==a?a:.85,i=void 0!==i?i:s.blurryMirror,s.renderer&&s.renderer.mirrorBlendPass&&(s.renderer.mirrorBlendPass.uniforms.reflectivity.value=n),s.blurryMirror=i,s.blurryMirror&&s.ambience.setGroundGlossiness(a);for(var o=this.getMirror("static"),l=r?[r]:["static","dynamic"],h=0;h<l.length;h++){var c=l[h];this.setSetting("GroundReflection",c,t)}var d=this.getMirror("static");d!==o&&e.publish({event:"/WUX/AFR/CMD/VisuToggleMirror/"+(d?"BEGIN":"END")})}getMirror(e){return e=e||"static",this.getSetting("GroundReflection",e)}setAllowMirror(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowMirror",n,e),this.setSetting("AllowGroundReflection",n,e)}}getAllowMirror(e){return e=e||"static",this.getSetting("AllowGroundReflection",e)}_setMirror(e){var t=this.getMirror(e)&&this.getAllowMirror(e),i=this.viewer;!i.useHDR&&i.cameraSystem&&(t=!1),i.useMirror!==t&&(i.renderer.resetGSSOCache(),i.useMirror=t)}setPixelCulling(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetPixelCulling",n,e),this.setSetting("PixelCulling",n,e)}}getPixelCulling(e){return e=e||"static",this.getSetting("PixelCulling",e)}_setPixelCulling(e){var t=this.viewer;t.currentViewpoint&&t.currentViewpoint._setPixelCulling(this.getPixelCulling(e))}setBloom(e,t){for(var i=this.viewer,r=t?[t]:["static","dynamic"],n=0;n<r.length;n++){var a=r[n];this.setSetting("Bloom",a,e)}e&&!i.getEffect("Bloom")&&(i.renderer.setEffect("Bloom",!0),i.renderer.setEffect("Bloom",!1))}getBloom(e){return e=e||"static",this.getSetting("Bloom",e)}_setBloom(e){var t=this.viewer,i=this.getBloom(e)&&this.getAllowBloom(e);t.useBloom!==i&&(t.useBloom=i,t.renderer.setEffect("Bloom",t.useBloom))}setAllowBloom(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("qmSetAllowBloom",n,e),this.setSetting("AllowBloom",n,e)}}getAllowBloom(e){return e=e||"static",this.getSetting("AllowBloom",e)}setSSLRefraction(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateState("SSRefraction",n,e)}}getSSLRefraction(e){return e=e||"static",this.getSetting("SSRefraction",e)}setAllowSSLRefraction(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowSSRefraction",n,e),this._updateState("AllowSSRefraction",n,e)}}getAllowSSLRefraction(e){return e=e||"static",this.getSetting("AllowSSRefraction",e)}_setSSLRefraction(e){var t=this.viewer,i=this.getSSLRefraction(e)&&this.getAllowSSLRefraction(e);t.useSSLRefraction!==i&&(t.useSSLRefraction=i,this.getTransparentShadow(e)&&this.getAllowTransparentShadow(e)&&(t._updateShadowMaps(),t.renderer.resetGSSOCache()),t.renderer.setEffect("SSLRefraction",t.useSSLRefraction))}setSSLR(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateState("SSR",n,e)}}getSSLR(e){return e=e||"static",this.getSetting("SSR",e)}setAllowSSLR(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowSSR",n,e),this._updateState("AllowSSR",n,e)}}getAllowSSLR(e){return e=e||"static",this.getSetting("AllowSSR",e)}_setSSLR(e){var t=this.viewer,i=this.getSSLR(e)&&this.getAllowSSLR(e);t.useSSLRDirect!==i&&(t.useSSLRDirect=i,t.renderer.setEffect("SSLRDirect",i),t.renderer.renderer.useSSLR=i)}setDOF(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSetting("DepthOfField",n,e)}var a=this.viewer;e&&!a.getEffect("DOF")&&(a.renderer.setEffect("DOF",!0),a.renderer.setEffect("DOF",!1))}getDOF(e){return e=e||"static",this.getSetting("DepthOfField",e)}setAllowDOF(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowDOF",n,e),this.setSetting("AllowDepthOfField",n,e)}}getAllowDOF(e){return e=e||"static",this.getSetting("AllowDepthOfField",e)}_setDOF(e){var t=this.viewer,i=this.getDOF(e)&&this.getAllowDOF(e);if(t.useDOF!==i&&(t.useDOF=i,t.renderer.setEffect("DOF",t.useDOF)),"static"===e){var r="MSAA"===this.getAntiAliasing(e),n=t.getEffect("DOF");n&&n.setIterative(t.useDOFIterative&&r)}}setSSAONbSamples(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetSSAONbSamples",n,e),this.setSetting("SSAONbSamples",n,e)}}getSSAONbSamples(e){return e=e||"static",this.getSetting("SSAONbSamples",e)}setSSAO(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSetting("SSAO",n,e)}}getSSAO(e){return e=e||"static",this.getSetting("SSAO",e)}setAllowSSAO(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowSSAO",n,e),this.setSetting("AllowSSAO",n,e)}}getAllowSSAO(e){return e=e||"static",this.getSetting("AllowSSAO",e)}_setSSAO(e){var t=this.viewer,i=this.getSSAO(e)&&this.getAllowSSAO(e),r="MSAA"===this.getAntiAliasing(e);t.useSSAO=i;var n=t.useSSAOIterative&&r&&t.renderIteration>0;t.renderer.setEffect("SSAO",t.useSSAO&&!n),t.renderer.setEffect("SSAOIterative",t.useSSAO&&n)}setAntiAliasing(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r],a=null;"SMAA"===e||"MLAA"===e||"FXAA"===e||"FSAA"===e||"MSAA"===e||"SSAA"===e||"TAA"===e?a="dynamic"===n&&"MSAA"===e?"SMAA":e:"NoAA"===e||!1===e?a="NoAA":!0===e?a="SMAA":"MSMAA"===e&&(console.warn("MSMAA is deprecated"),a="dynamic"===n?"SMAA":"MSAA"),a&&(this._updateQM("_qmSetAntiAliasing",n,a),this.setSetting("AntiAliasing",n,a))}}getAntiAliasing(e){return this.getSetting("AntiAliasing",e)}_setAntiAliasing(e){var t=this.viewer,i=this.getAntiAliasing(e);"TAA"===i&&"static"===e&&"TAA"!==this.getAntiAliasing("dynamic")&&(i="MSAA"),t.antiAliasing!==i&&(t.renderer.setEffect(t.antiAliasing,!1),t.antiAliasing=i,t.renderer.setEffect(t.antiAliasing,!0))}}class a extends n{constructor(e,t){super(e,t),this._blackListedEffects.add("Bloom"),this._blackListedEffects.add("DepthOfField"),this._blackListedEffects.add("AntiAliasing")}}return{Desktop:n,NoHDR:a,Mobile:class extends a{constructor(e,t){super(e,t),this._blackListedEffects.add("GroundShadows"),this._blackListedEffects.add("InterObjectShadows"),this._blackListedEffects.add("TransparentObjectShadows"),this._blackListedEffects.add("GroundReflection"),this._blackListedEffects.add("SSAO"),this._blackListedEffects.add("SSR"),this._blackListedEffects.add("SSRefraction"),"true"===localStorage.getItem("__WEBVISU_MOBILE_QM_POC__")&&(this._blackListedEffects.delete("GroundShadows"),this._blackListedEffects.delete("InterObjectShadows"),this._blackListedEffects.delete("TransparentObjectShadows"),this._blackListedEffects.delete("GroundReflection"),this._blackListedEffects.delete("SSAO"))}},None:class extends n{constructor(e,t){super(e,t),this._blackListedEffects.add("Bloom"),this._blackListedEffects.add("Transparency"),this._blackListedEffects.add("DepthOfField"),this._blackListedEffects.add("AntiAliasing"),this._blackListedEffects.add("GroundShadows"),this._blackListedEffects.add("InterObjectShadows"),this._blackListedEffects.add("TransparentObjectShadows"),this._blackListedEffects.add("GroundReflection"),this._blackListedEffects.add("SSAO"),this._blackListedEffects.add("SSR"),this._blackListedEffects.add("SSRefraction"),this._lqFallback=!0}}}}),define("DS/Visualization/TrapSelection",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent"],function(e,t,i,r,n,a,s){"use strict";var o=function(e){this.extremities={xPix:0,x:0,yPix:0,y:0},this.originPoint=null,this.isActive=!1,this.isInterrupted=!1,this.advancedSelection=!1,this.userTransformationCB=null,this.createCallbacks(),e&&(this.viewer=e),this.viewer&&this.viewer.divTrap&&this.setDiv(this.viewer.divTrap);var t=this.viewer.currentViewpoint?this.viewer.currentViewpoint.getControl():null;this.mode=t?t._mode:1,this.downEvent=0===this.mode?"onLeftMouseDown":"onHoldLeftMouseDown"};return o.prototype.set=function(e){switch(e){case!0:this.activate(!1);break;case"advanced":this.activate(!0);break;case!1:this.disable()}},o.prototype.setUserTransformation=function(e){this.userTransformationCB=e},o.prototype.updateMode=function(e,t){var i=this.viewer.picking.trapSelection;e.setSpinnerOnHold(!(0===this.mode||!i)),t!==this.mode&&(this.mode=t,n.removeEvent(this.viewer.canvas,this.downEvent,this.downCB),this.downEvent=0===this.mode?"onLeftMouseDown":"onHoldLeftMouseDown",i&&n.addEvent(this.viewer.canvas,this.downEvent,this.downCB))},o.prototype.setDiv=function(e){this.divTrap=e,this.divTrap.setStyles({position:"absolute",opacity:"0.8",pointerEvents:"none",border:"1px dashed black"}),this.divTrap.hide()},o.prototype.activate=function(e){this.downEvent=0===this.mode?"onLeftMouseDown":"onHoldLeftMouseDown",this.forwardSelect=null,this.advancedSelection=e,!this.divTrap&&this.viewer&&this.viewer.divTrap&&this.setDiv(this.viewer.divTrap),n.addEvent(this.viewer.canvas,this.downEvent,this.downCB),n.addEvent(this.viewer.canvas,"onHold",this.downCB),n.addEvent(this.viewer.canvas,"onLongHold",this.interrupt)},o.prototype.disable=function(){this.userTransformationCB=null,n.removeEvent(this.viewer.canvas,this.downEvent,this.downCB),n.removeEvent(this.viewer.canvas,"onHold",this.downCB),n.removeEvent(this.viewer.canvas,"onLongHold",this.interrupt)},o.prototype.getExtremities=function(){return this.extremities},o.prototype.setExtremities=function(e,t){if(t){var i,r={},n={},a=!0;if(e.xPix<t.xPix?(a=!0,r.xPix=e.xPix,r.x=e.x,n.xPix=t.xPix,n.x=t.x):(a=!1,r.xPix=t.xPix,r.x=t.x,n.xPix=e.xPix,n.x=e.x),e.yPix<t.yPix?(r.yPix=e.yPix,r.y=e.y,n.yPix=t.yPix,n.y=t.y):(r.yPix=t.yPix,r.y=t.y,n.yPix=e.yPix,n.y=e.y),this.extremities=r,this.extremities.pt=n,this.advancedSelection&&this.divTrap&&this.forwardSelect!==a)i=a?{border:"2px solid #f5c77e",backgroundColor:"rgba(245, 200, 125, 0.5)"}:{border:"2px dashed #75cdf0",backgroundColor:"rgba(117, 205, 240, 0.5)"},this.divTrap.setStyles(i),this.forwardSelect=a}else this.extremities=e},o.prototype.createCallbacks=function(){var e=this;this.interrupt=function(){e.softInterrupt(),e.viewer.setCursor("Auto")},this.softInterrupt=function(){e.isActive=!1,e.isInterrupted=!0,n.removeEvent(document,"onMouseMove",e.moveCB),n.removeEvent(document,"onLeftMouseUp",e.upCB),n.removeEvent(document,"onSwipe",e.moveCB),n.removeEvent(document,"onRelease",e.upCB),e.setExtremities({x:-1,y:-1})},this.downCB=function(t){var i=t.from[0].getCurrentPosition(e.viewer.canvas);e.userTransformationCB&&(i=e.userTransformationCB(i)),e.originPoint=e.viewer.getMousePosition(i),e.setExtremities(e.originPoint),e.startTime=Date.now(),e.isActive=!0,e.isInterrupted||(e.viewer.setCursor("TrapSelection",100),n.addEvent(document,"onMouseMove",e.moveCB),n.addEvent(document,"onLeftMouseUp",e.upCB),n.addEvent(document,"onSwipe",e.moveCB),n.addEvent(document,"onRelease",e.upCB)),e.isInterrupted=!1},this.moveCB=function(t){var i=t.from[0].getCurrentPosition(e.viewer.canvas);e.userTransformationCB&&(i=e.userTransformationCB(i));var r=e.viewer.getMousePosition(i);e.setExtremities(e.originPoint,r);var n=e.viewer.devicePixelRatio;e.divTrap&&(e.divTrap.show(),e.divTrap.setStyles({width:(e.extremities.pt.xPix-e.extremities.xPix)/n,height:(e.extremities.pt.yPix-e.extremities.yPix)/n,left:e.extremities.xPix/n,top:e.extremities.yPix/n,pointerEvents:"none"}))},this.upCB=function(t){e.divTrap&&(e.divTrap.hide(),e.divTrap.setStyles({width:"0px",height:"0px",left:"0px",top:"0px",pointerEvents:"none"})),e.interrupt(),e.isInterrupted=!1}},o}),define("DS/Visualization/IESUtils",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t={nbTexturesBeingLoaded:0,crossOrigin:"anonymous",loadIESTexture:function(i,r,n,a,s,o){var l=new e.DataTexture(null,128,128,e.LuminanceFormat,e.FloatType);l.mapping=r,l.generateMipmaps=!1,l.loadEndStatus=e.AssetLoadingStatus.LOADING;var h=new XMLHttpRequest;return h.onload=function(){t.nbTexturesBeingLoaded--;var i,r=t.parserIES(h.response);for(l.image.data=r,l.loadEndStatus=e.AssetLoadingStatus.READY,l.generateMipmaps=!1,l.minFilter=e.LinearFilter,l.magFilter=e.LinearFilter,l.needsUpdate=!0,n&&n(l),i=0;i<l.onLoadCallbacks.length;i++)l.onLoadCallbacks[i](l)},h.onerror=function(){a(),t.nbTexturesBeingLoaded--,l.loadEndStatus=e.AssetLoadingStatus.ERROR},o?(l.loadEndStatus=e.AssetLoadingStatus.PAUSED,l.onRequest=function(){l.loadEndStatus=e.AssetLoadingStatus.LOADING,t.nbTexturesBeingLoaded++,h.open("GET",i,!0),h.responseType="text",h.withCredentials=!!s,h.send(null),l.onRequest=null}):(l.loadEndStatus=e.AssetLoadingStatus.LOADING,t.nbTexturesBeingLoaded++,h.open("GET",i,!0),h.responseType="text",h.withCredentials=!!s,h.send(null)),l},parserIES:function(e){var t=e.lastIndexOf("TILT="),i=e.slice(t);t=i.indexOf("\n"),i=(i=(i=(i=i.slice(t+1)).replace(/\n|\s|\r/g,"_")).replace("__","_")).split("_");for(var r=[],n=0;n<i.length;n++)""!=i[n]&&(r[r.length]=parseFloat(i[n]));i=null;var a,s,o,l,h,c,d=-1,u=-1,p=-1;r[0],r[1],r[2],a=r[3],s=r[4],o=r[5],r[6],r[7],r[8],r[9],r[10],r[11],r[12],c=13,l=[a],h=[s];for(var f=[],g=new Float32Array(16384),m=0;m<128;m++)for(var v=0;v<128;v++)g[128*m+v]=0;for(var y=0;y<a;y++)l[y]=r[y+c];c+=parseInt(a);for(var S=0;S<s;S++)h[S]=r[S+c];if(c+=parseInt(s),1==o){90==l[a-1]?u=1:180==l[a-1]&&(u=2),1==s&&0==h[0]?d=0:90==h[s-1]?d=1:180==h[s-1]&&(d=2);for(S=0;S<s;S++)for(y=0;y<a;y++){var _=r[y+S*a+c];p=p<_?_:p}if(0==d){s=2,h[1]=180;for(y=0;y<a;y++)r[y+a+c]=r[y+c]}if(1==d){if(1==u){for(S=0;S<s;S++){var x=90-(h[S]-90);f[h[S]]=[2*a],f[x]=[2*a];for(y=0;y<a;y++){var b=90-(l[y]-90);f[h[S]][l[y]]=f[x][l[y]]=f[h[S]][b]=f[x][b]=r[y+S*a+c]/p}}for(y=0;y<a-1;y++)l.push(90-(l[y]-90))}else if(2==u)for(S=0;S<s;S++){x=90-(h[S]-90);f[h[S]]=[2*a],f[x]=[2*a];for(y=0;y<a;y++)f[h[S]][l[y]]=f[x][l[y]]=r[y+S*a+c]/p}for(S=0;S<s-1;S++)h.push(90-(h[S]-90))}else if(0==d||2==d){if(1==u){for(S=0;S<s;S++){f[h[S]]=[2*a];for(y=0;y<a;y++){b=90-(l[y]-90);f[h[S]][l[y]]=f[h[S]][b]=r[y+S*a+c]/p}}for(y=0;y<a-1;y++)l.push(90-(l[y]-90))}else if(2==u)for(S=0;S<s;S++){f[h[S]]=[a];for(y=0;y<a;y++)f[h[S]][l[y]]=r[y+S*a+c]/p}}else console.log("Erreur symetricHType "+d);h=h.sort(function(e,t){return e-t}),l=l.sort(function(e,t){return e-t});var w=h[0],M=h[1],C=1;for(S=0;S<180;S+=1.40625){for(;S>M;)w=M,M=h[C+1],C++;var P=l[0],E=l[1],A=1,T=(S-w)/(M-w);for(y=0;y<180;y+=1.40625){for(;y>E;)P=E,E=l[A+1],A++;var D=(y-P)/(E-P),I=(1-D)*f[w][P]+D*f[w][E],R=(1-D)*f[M][P]+D*f[M][E];g[S/1.40625*128+y/1.40625]=(1-T)*I+T*R}}}else console.log("Mauvais Gonio Type");return g}};return t}),define("DS/Visualization/SubElement",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/VisuIdentification/Node","DS/VisuIdentification/Pattern"],function(e,t,i,r,n){"use strict";var a={},s=30,o=0,l=e.extend({init:function(e,t){if(t!==a&&s>0){var i=(new Error).stack;i=i&&i.substring(i.indexOf("\n")+1),console.warn("Use of deprecated constructor.\nUse SubElement.getFromSGNode() instead.\n"+i),s--}this.sgNode=e,this._internalGeometryData=null,this.id=o++},getDimension:function(){if(this.sgNode){var e=this.sgNode;switch(e.getFirstPrimitive&&(e=e.getFirstPrimitive()),e.getGroup().glType){case 0:return"point";case 1:case 2:case 3:return"line";case 4:case 5:case 6:return"surface";default:return""}}return""},getCellDimension:function(){if(this.sgNode){var e=this.sgNode;switch(e.getFirstPrimitive&&(e=e.getFirstPrimitive()),e.getGroup().glType){case 0:return 0;case 1:case 2:case 3:return 1;case 4:case 5:case 6:return 2;default:return-1}}return-1},getBodyDimension:function(){if(this.sgNode){var e=this.sgNode;e.getFirstPrimitive&&(e=e.getFirstPrimitive());var t=e.getRep?e.getRep():e.rep;return t&&t.solid?3:2}return-1},getType:function(){if(this.sgNode){var e=this.sgNode;if(e.getFirstPrimitive)return"selectionGroup";switch(e.getType?e.getType():e.type){case 0:return"node";case 1:return"bag";case 2:return"rep";case 3:return"primitive";default:return""}}return""},getGeometricType:function(){if(this.sgNode&&"primitive"===this.getType()){var e=this.sgNode.getGroup();if(e)return i.GeomTypeString[e._geomType]}return null},getParent:function(){if(this.sgNode){var e=this.sgNode;e.getFirstPrimitive&&(e=e.getFirstPrimitive());var t="primitive"===this.getType()?e.getRep():e.parents?e.parents[0]:null;if(t)return THREEDS.SubElement.getFromSGNode(t)}return null},getChildren:function(){var e,t=[];if(this.sgNode){var r=this.getType();if("rep"===r)for(e=0;e<this.sgNode.getPrimitivesCount();e++){var n=new i.SGPrimitiveHelper;n.set(this.sgNode,e),t.push(THREEDS.SubElement.getFromSGNode(n))}else if("selectionGroup"===r){var a=this.sgNode.getPrimitives();for(e=0;e<a.length;e++)t.push(THREEDS.SubElement.getFromSGNode(a[e]))}else for(e=0;e<this.sgNode.children.length;e++)t.push(THREEDS.SubElement.getFromSGNode(this.sgNode.children[e]))}return t},getPrimitives:function(e){var t=e||[],r=this.getType();if("primitive"===r)t.push(this.sgNode);else if("rep"===r)for(var n=0;n<this.sgNode.getPrimitivesCount();n++){var a=new i.SGPrimitiveHelper;a.set(this.sgNode,n),t.push(a)}else for(n=0;n<this.sgNode.children.length;n++)THREEDS.SubElement.getFromSGNode(this.sgNode.children[n]).getPrimitives(t);return t},getCGMID:function(){return this.sgNode&&!this.sgNode.getFirstPrimitive?this.sgNode.getCgmId?this.sgNode.getCgmId():this.sgNode.cgmId:""},getModelIdentification:function(){return this.getIdentificationObject()},getIdentificationObject:function(){var e,t=this.sgNode;return t&&(t.getFirstPrimitive&&(t=t.getFirstPrimitive()),t.getIdentificationObject&&(e=t.getIdentificationObject())),e},getMeshes:function(){var e=[],t=[];if(this.sgNode&&"primitive"===this.getType()){var i=this.sgNode.getGroup();if(i&&i.geometry)for(var r=i.geometry.meshList,n=0;n<r.length;n++){var a=r[n];t.push(a._occurrence.node)}}var s=-1,o=null;t.length&&(t.sort(function(e,t){return e.id-t.id}),s=t[0].id,e.push(t[0]));for(var l=1;l<t.length;l++)s!==(o=t[l]).id&&(s=o.id,e.push(o));return e},getReps:function(){var e,t=[];if("rep"===this.getType())t.push(this);else for(e=0;e<this.children.length;e++)t=t.concat(this.children[e].getReps());return t}});return l.getFromSGNode=function(e){if(e instanceof i.SGPrimitive){var t=e.group,r=t._primitives.indexOf(e);(e=new i.SGPrimitiveHelper).set(t,r)}return e._setInternalNode?(e._getInternalNode()||e._setInternalNode(new THREEDS.SubElement(e,a)),e._getInternalNode()):(e.internalNode||(e.internalNode=new THREEDS.SubElement(e,a)),e.internalNode)},UWA.namespace("THREEDS/SubElement",l)}),define("Visualization/SubElement",["DS/Visualization/SubElement","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SubElement"),e}),define("DS/Visualization/PathElement",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/Visualization/SubElement"],function(e,t,i,r,n){"use strict";var a=0,s=t.__visibleInCurrentSpace,o=e.extend({init:function(e){this._uid=a++,this.externalPath=[],this.internalPath=[],this._key=null,this.setFromArray(e)},getUID:function(){return this._uid},getLength:function(){return this.externalPath.length+this.internalPath.length},getLastElement:function(e){return!e&&this.internalPath.length?this.internalPath[this.internalPath.length-1]:this.externalPath.length?this.externalPath[this.externalPath.length-1]:null},getElement:function(e,t){return e<this.externalPath.length?this.externalPath[e]:!t&&e<this.getLength()?this.internalPath[e-this.externalPath.length]:null},isEqual:function(e){var t;if(!e)return!1;if(this.externalPath.length!==e.externalPath.length)return!1;if(this.internalPath.length!==e.internalPath.length)return!1;if(this.instanceId!==e.instanceId)return!1;for(t=0;t<this.externalPath.length;t++)if(this.externalPath[t]!==e.externalPath[t])return!1;for(t=0;t<this.internalPath.length;t++){var i=this.internalPath[t].sgNode,n=e.internalPath[t].sgNode;if(i instanceof r.SGPrimitive||i instanceof r.SGPrimitiveHelper){if(!(n instanceof r.SGPrimitive||n instanceof r.SGPrimitiveHelper))return!1;if(!i.isEqual(n))return!1}else if(i!==n)return!1}return!0},empty:function(){this.externalPath=[],this.internalPath=[]},clone:function(){for(var e=new THREEDS.PathElement(this.externalPath),t=0;t<this.internalPath.length;t++){var i=this.internalPath[t];i&&e.internalPath.push(i)}return this._key&&(e._key=this._key),this.instanceId&&(e.instanceId=this.instanceId),e},copy:function(e){this.externalPath=e.externalPath.slice(),this.internalPath=e.internalPath.slice()},addElement:function(e){return e&&(e.getNotAllowedInPathElement?e.getNotAllowedInPathElement()&&l():e.notAllowedInPathElement&&l()),this._key&&delete this._key,e instanceof THREEDS.Nodes.Node3D?(this.externalPath.push(e),!0):e instanceof THREEDS.SubElement&&(this.internalPath.push(e),!0)},setFromArray:function(e,t){var i;if(this._key=null,void 0===e||!(e instanceof Array))return!1;var r=[];for(i=0;i<e.length;i++){var n=e[i];if(n.getNotAllowedInPathElement&&n.getNotAllowedInPathElement()||n.notAllowedInPathElement)l();else{if(null===n)return!1;r.push(n)}}var a=[];if(t&&t instanceof Array)for(i=0;i<t.length;i++){var s=t[i];if(null===s)return!1;a.push(s)}return this.getLength()&&this.empty(),this.externalPath=r,this.internalPath=a,!0},setFromOccurrence:function(e,t,i,r){if(null==e)return!1;var n=e.node,a=n&&n._getDisablePrimPicking(),s=e.parent;this.externalPath=[n];for(var o=!1;null!==s&&!o&&(n=s.node,s=s.parent,!n.getNotAllowedInPathElement());)this.externalPath.unshift(n),i&&n===i&&(o=!0);var l=i&&o||!i;if(null==t||a&&r)return l;s=t.getParent();for(this.internalPath=[t];null!==s;)this.internalPath.unshift(s),s=s.getParent();return l},setFromOccurrencePath:function(e,t){if(null==e)return!1;var i=e.getSize();if(!i)return!1;for(var r=[],n=0;n<i;n++){var a=e.getNodeName(n);if(null===a)return!1;var s=t.getChildByName(a);if(null===s)return!1;s.getNotAllowedInPathElement()?l():r.push(s)}return this.getLength()&&this.empty(),this.externalPath=r,!0},addSubstituteMaterial:function(e,t,i){this._getOccurrences(e).forEach((e,r,n)=>e._addSubstituteMaterial(t,i))},removeSubstituteMaterial:function(e,t){this._getOccurrences(e).forEach((e,i,r)=>e._removeSubstituteMaterial(t))},_getOccurrences:function(e){var t,i,r,n,a,s,o,l;if(!this.externalPath.length)return[];if(null===(t=this.externalPath[0]))return[];for(n=t._occurrences,e&&(n=n.filter(function(t){return t.scene3js===e.internalSceneGraph.root3js})),a=[],l=1;l<this.externalPath.length;l++){for(t=this.externalPath[l],s=0;s<n.length;s++)for(i=n[s].children,o=0;o<i.length;o++)(r=i[o]).node===t&&a.push(r);n=a,a=[]}return n},_getOccurrenceFromRootOccurrence:function(e){if(e.node!==this.externalPath[0])return null;var t,i,r,n,a,s=e;for(t=1;t<this.externalPath.length;t++){for(r=this.externalPath[t],a=null,i=0;i<s.children.length&&null==a;i++)(n=s.children[i]).node===r&&(a=n);if(null===a)return null;s=a}return s},_getRenderableOccurrences:function(e,t){var i,r,n,a,s;if(r=[],i=this._getOccurrences(e))for(a=0;a<i.length;a++)for(n=i[a]._getRenderableOccurrences(t),s=0;s<n.length;s++)r.push(n[s]);return r},_getUniqueOccurrence:function(e){var t=this._getOccurrences(e);return t&&1===t.length?t[0]:null},getKey:function(){if(!this._key){var e=0,t="";for(e=0;e<this.externalPath.length;e++)t+=(0===e?"":"/")+this.externalPath[e].id;for(t+="//",e=0;e<this.internalPath.length;e++)t+=(0===e?"":"/")+this.internalPath[e].id;this._key=t}return this._key},hash:function(){if(!this._hash){var e,t=0,i="";if(this.internalPath.length){if(!((e=this.internalPath[this.internalPath.length-1])instanceof n))throw new Error("Unknown node");var r=e.sgNode;r&&(r.getStart?i+=r.getStart()+"/":r.start&&(i+=r.start+"/"))}for(t=this.externalPath.length-1;t>=0;t--)i+=this.externalPath[t].id+"/";this._hash=i}return this._hash},getParentPath:function(){var e=this.externalPath.concat(this.internalPath);if(e.length<=1)return null;var t,i=new THREEDS.PathElement;for(t=0;t<e.length-1;t++)i.addElement(e[t]);return i},getChildrenPathes:function(e){var t,i,r=[],n=this.getLastElement(),a=e?e.getKey():null;if(null===n)return!1;if(n.children)for(t=0;t<n.children.length;t++)(i=this.clone()).addElement(n.children[t]),i.getKey()!==a&&r.push(i);return r},getSiblingsPathes:function(){var e=this.getParentPath();return e?e.getChildrenPathes(this):[]},getAncestorsPathes:function(){for(var e=this,t=[];e;)t.unshift(e),e=e.getParentPath();return t},getSubPath:function(e){if(this.internalPath.length>0)return null;var t,i=null,r=null;for(t=this.externalPath.length-2;t>=0&&null===i;t--)e(this.externalPath[t])&&(i=t);if(null!==i)for(r=new o,t=0;t<=i;t++)r.addElement(this.externalPath[t]);return r},getPathesFromSelectionGroupPath:function(){var e=this.getLastElement(!1);if(!(e&&e.sgNode&&e.sgNode instanceof r.SelectionGroup))return null;for(var t=[],i=e.sgNode.getPrimitives(),a=0;a<i.length;a++){var s=i[a],o=this.getParentPath();o.addElement(n.getFromSGNode(s)),t.push(o)}return t},toJSON:function(e){for(var t,i={},r=[],n=this.externalPath[0];n;)r=[n].concat(r),n=n.parents.length&&n!==e?n.parents[0]:null;function a(e){return e.getPersistentId?{persistent:!0,value:e.getPersistentId()}:{persistent:!1,value:e.parents[0].children.indexOf(e)}}for(i.firstElementPath=[],t=0;t<r.length;t++)((n=r[t]).parents.length||n!==e)&&i.firstElementPath.push(a(n));for(i.externalPathRest=[],t=1;t<this.externalPath.length;t++)i.externalPathRest.push(a(this.externalPath[t]));return i},setFromJSON:function(e,t){var i,r=t;function n(e,t){var i,r;if(!t.persistent)return e.children[t.value];for(i=0;i<e.children.length;i++)if((r=e.children[i]).getPersistentId&&r.getPersistentId()===t.value)return r;return null}for(i=0;i<e.firstElementPath.length;i++)r=n(r,e.firstElementPath[i]);var a=[r];for(i=0;i<e.externalPathRest.length;i++)a.push(n(a[a.length-1],e.externalPathRest[i]));for(i=0;i<a.length;i++)a[i].getNotAllowedInPathElement()||this.addElement(a[i])},_dbgPrint:function(){for(var e="ext:[",t=this.externalPath.length,i=0;i<t;i++){(r=this.externalPath[i])&&(e+=r.name),i<t-1&&(e+=", ")}e+="] int:[",t=this.internalPath.length;for(i=0;i<t;i++){var r;(r=this.internalPath[i])&&(e+=r.getCGMID()),i<t-1&&(e+=", ")}return e+="]"},getMatrix:function(e){var t=this._getUniqueOccurrence(e);if(!t)return null;if(t.originalOverrideSet){var i=t.originalOverrideSet.getSubstituteMatrix();if(i)return i.clone()}var r=this.getLastElement(!0);return null===r?null:r.getMatrix()},getWorldMatrix:function(e,t){var i=this._getUniqueOccurrence(e);return i?(i._tryOverridesUpdateWithAncestors(e),t?(t.copy(i.matrix),t):i.matrix.clone()):null},getMatrixInAxisSystem:function(e,i){var r=this.getWorldMatrix(i);if(!r)return null;var n=new t.Matrix4,a=new t.Matrix4;return a.getInverse(e),n.multiplyMatrices(a,r),n},getBoundingSphere:function(e,t,i){"show"===t&&(console.warn("DEPRECATED: use visibleSpace instead of show"),t="visibleSpace"),"noShow"===t&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),t="invisibleSpace");var r=this.getWorldMatrix(e);if(!r)return null;var n=this._getUniqueOccurrence(e);if(!n)return null;e=e||n.scene3js.viewer,n._tryOverridesUpdateWithAncestors(e);var a=null;i&&0!==this.internalPath.length?a=this.getLastElement().sgNode.computeBoundingSphere().clone():a=n.getBoundingSphere(t).clone();return a.center.applyMatrix4(r),a},getBoundingBox:function(e,t,i){if(t){"show"===i&&(console.warn("DEPRECATED: use visibleSpace instead of show"),i="visibleSpace"),"noShow"===i&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),i="invisibleSpace");var r=this.getWorldMatrix(t);if(!r)return null;e&&e.copy(r);var n=this._getUniqueOccurrence(t);return n?(t=t||n.scene3js.viewer,n._tryOverridesUpdateWithAncestors(t),n.getBoundingBox(i).clone()):null}},getFilterGeomType:function(e){if(!e)return 0;var t=this._getUniqueOccurrence(e);if(!t)return 0;var i=t.renderable;return i?i.getFilterGeomType():0},getOrientedBoundingBox:function(e,i,r,n,a,o){if(!i)return null;var l=n||(1===i.visibleSpace?"visibleSpace":"invisibleSpace"),h=this._getUniqueOccurrence(i);if(o=!!o,!h)return null;r=r||t.FixedSizeFiltering.Include,a=a||[];for(var c=0,d=0;d<a.length;d++){c|=a[d]}if(h._tryOverridesUpdateWithAncestors(i),o&&0!==this.internalPath.length){var u=h.renderable;if(!u)return h.computeAccurateBoundingBox(l,e,r,c);if(!s(u.visible,u.visibilityFree,"visibleSpace"===l,h))return new t.Box3;var p=h._isFixedSize();if(p&&r===t.FixedSizeFiltering.Exclude)return new t.Box3;var f=new t.Matrix4;null!==e?f.multiplyMatrices((new t.Matrix4).getInverse(e),u._getMMMatrix()):f=u._getMMMatrix();var g=h._getRenderModes(),m=u.getFilterGeomType();return this.getLastElement().sgNode._computeOrientedBoundingBox(f,g&~c,r,p,m?m._geomType:0)}return h.computeAccurateBoundingBox(l,e,r,c)},checkExternalPath:function(){var e,t,i,r=!0;for(e=0;e<this.externalPath.length-1&&r;e++)t=this.externalPath[e],i=this.externalPath[e+1],t.children.indexOf(i)<0&&(r=!1);return r},isAParentOf:function(e){function t(e,t){var i=[],r=(e[0],e[0]);if(1===r.parents.length&&r!==t){for(r=r.parents[0];1===r.parents.length&&r!==t;)i.unshift(r),r=r.parents[0];i.unshift(r)}return i=i.concat(e)}var i,r,n,a=this.externalPath[0],s=e.externalPath[0];if(a===s?(i=this.externalPath,r=e.externalPath):this.externalPath.indexOf(s)>0?(i=this.externalPath,r=t(e.externalPath,a)):(i=t(this.externalPath,s),r=e.externalPath),r[0]===i[0]){if(i.length<=r.length){for(n=0;n<i.length&&i[n]===r[n];)n++;return n===i.length}return!1}return!1},concatenatePathes:function(e,t){var i=e.externalPath.concat(t.externalPath);this.setFromArray(i)},substractPath:function(e,t){var i,r=t.externalPath.concat([]),n=e.externalPath;r.indexOf(n[n.length-1]);for(i=0;i<n.length;i++)if(n[i]!==r[i])return!1;return r.splice(0,n.length-1),this.setFromArray(r),!0},setRenderPasses:function(e){for(var t=this._getRenderableOccurrences(),i=0;i<t.length;i++)t[i].setVisibleInPasses(e)},getParentOccurrencePath:function(){return this.getParentPath.apply(this,arguments)},getChildrenOccurrencePathes:function(){return this.getChildrenPathes.apply(this,arguments)},getSiblingsOccurrencePathes:function(){return this.getSiblingsPathes.apply(this,arguments)},getAncestorsOccurrencePathes:function(){return this.getAncestorsPathes.apply(this,arguments)},_getIndexFromNode:function(e){return this.externalPath.indexOf(e)},_findSGNodeByLocalId:function(e,t){var i,r=e.getIdentificationObject?e.getIdentificationObject():null;r&&(r.getLocalId()===t&&(i=e));if(!i&&e.children)for(var n=e.children,a=0;a<n.length&&void 0===(i=this._findSGNodeByLocalId(n[a],t));a++);return i},findAssociatedSGNode:function(e,t){var i;if(e.parents)for(var r=e.parents,n=0;n<r.length;n++)if(r[n]instanceof THREEDS.Nodes.CGRNode)i=this._findSGNodeByLocalId(r[n].internalSceneGraph,t);else if(void 0!==(i=this.findAssociatedSGNode(r[n],t)))break;return i}});function l(){console.warn("An attempt to add an unauthorized node to a PathElement has been countered.\nPlease remove the node from your PathElement creation.\nNode returned by viewer.getRootNode() and any of its parents may not be part of a PathElement")}return UWA.namespace("THREEDS/PathElement",o)}),define("Visualization/PathElement",["DS/Visualization/PathElement","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/PathElement"),e}),define("DS/Visualization/Filters/VisuFilter",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return class{constructor(){}}}),define("DS/Visualization/Filters/LookFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this.material=e,this.shadowReceive=-1,this.shadowCast=-1}usingShadowReceive(e){return this.shadowReceive=!0===e?1:!1===e?0:-1,this}usingShadowCast(e){return this.shadowCast=!0===e?1:!1===e?0:-1,this}}}),define("DS/Visualization/Filters/DoNotPickUnderFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this._doNotPickUnder=e}}}),define("DS/Visualization/Filters/PolygonOffsetFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e,t){super(),this.factor=e,this.unit=t}enabled(){return 0!==this.factor&&0!==this.unit}}}),define("DS/Visualization/MaterialManager",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/CoreEvents/ModelEvents"],function(e,t,i,r,n){"use strict";function a(e,t){return i.ImageUtils.loadTextureCube(e,t)}function s(e,t){return i.ImageUtils.loadTexture(e,void 0,null,null,t)}i.ParticleBasicMaterial,i.LineBasicMaterial,i.DSPBR22xMaterial,i.MeshBasicMaterial;var o=["Generic","Metal","Glass","Plastic","Textile","Leather","Car Paint","Emissive","Basic","Wood"],l=[1,1,2,3,4,5,6,7,8],h=["NO_TRANSCODE","RGB","RGBA","RGBHQ","NORMAL_MAP","GRAYSCALE"],c=null,d=new i.Matrix3,u=null,p=null,f=e.extend({init:function(e,t,r,a){if(null!==u){if(this.viewerList=u.viewerList,a&&this.viewerList.set(a.id,a),u.multiViewer||!t)return this.multiViewer=u.multiViewer,this.canvas=u.canvas,this.context=u.context,this.materials=u.materials,this.gasMaterialsMap=u.gasMaterialsMap,this.gasSGOrederMaterialsMap=u.gasSGOrederMaterialsMap,this.threeDXSharedGas=u.threeDXSharedGas,this.CGRSharedMaterials=u.CGRSharedMaterials,this.textures=u.textures,this.texturesPoint=u.texturesPoint,this.resources=[],this.PointSymbolEnum=u.PointSymbolEnum,this._modelEvent=u._modelEvent,this.backgroundColor=u.backgroundColor,this.backgroundColorMaterial=u.backgroundColorMaterial,this.backgroundColorMaterials=u.backgroundColorMaterials,this.backgroundColorInit=u.backgroundColorInit,this.blankingRepMaterials=u.blankingRepMaterials,!this.backgroundColorInit&&a&&this.initBackgroundColor(a),this.displayBlanking=u.displayBlanking,this.lineTypes=u.lineTypes,this.precomputedTexture=u.precomputedTexture,this.noiseTexture3D=u.noiseTexture3D,this.precomputedAreaGGX1texture=u.precomputedAreaGGX1texture,this.precomputedAreaGGX2texture=u.precomputedAreaGGX2texture,this.precomputedAreaAshikmintexture=u.precomputedAreaAshikmintexture,this.precomputedAreaEsteveztexture=u.precomputedAreaEsteveztexture,this.precomputedAreaBeckmanntexture=u.precomputedAreaBeckmanntexture,this;u.precomputedTexture&&u.precomputedTexture.dispose(),u.noiseTexture3D&&u.noiseTexture3D.dispose(),u.precomputedAreaGGX1texture&&u.precomputedAreaGGX1texture.dispose(),u.precomputedAreaGGX2texture&&u.precomputedAreaGGX2texture.dispose(),u.precomputedAreaAshikmintexture&&u.precomputedAreaAshikmintexture.dispose(),u.precomputedAreaEsteveztexture&&u.precomputedAreaEsteveztexture.dispose(),u.precomputedAreaBeckmanntexture&&u.precomputedAreaBeckmanntexture.dispose()}else this.viewerList=new Map,a&&this.viewerList.set(a.id,a);return this.gasMaterialsMap=new Map,this.gasSGOrederMaterialsMap=new Map,this.materials=[],this.threeDXSharedGas=new Map,this.CGRSharedMaterials=new Map,this.textures=[],this.texturesPoint=new Array(10),this.resources=[],this._currentMatHasTexture=!1,this._modelEvent=new n,p=null,this.backgroundColorMaterial=null,this.backgroundColorMaterials=[],this.blankingRepMaterials=[],this.displayBlanking=!1,this.blankingInit=!1,this.backgroundColor=new i.Color,this.backgroundColorInit=!1,this.lineTypes={shapes:[],patterns:[],types:[]},u=this,f.singleton=u,this.debugWebgl2=a&&a.debugWebgl2,this.initResources(e,t,r),a&&this.initBackgroundColor(a),this.PointSymbolEnum={NOSPRITE:0,CROSS:1,PLUS:2,CONCENTRIC:3,COINCIDENT:4,FULLCIRCLE:5,FULLSQUARE:6,STAR:7,DOT:8,SMALLDOT:9},this},cleanAll:function(){u.materials=[],u.gasMaterialsMap=new Map,u.gasSGOrederMaterialsMap=new Map,u.threeDXSharedGas.clear(),u.CGRSharedMaterials.clear(),u.backgroundColorMaterial=null,u.backgroundColorMaterials=[],u.blankingRepMaterials=[],u.precomputedTexture&&u.precomputedTexture.dispose(),u.noiseTexture3D&&u.noiseTexture3D.dispose(),u.precomputedAreaGGX1texture&&u.precomputedAreaGGX1texture.dispose(),u.precomputedAreaGGX2texture&&u.precomputedAreaGGX2texture.dispose(),u.precomputedAreaAshikmintexture&&u.precomputedAreaAshikmintexture.dispose(),u.precomputedAreaEsteveztexture&&u.precomputedAreaEsteveztexture.dispose(),u.precomputedAreaBeckmanntexture&&u.precomputedAreaBeckmanntexture.dispose(),c&&c.dispose(),this.deallocateSharedMaterials()},clearLineTypes:function(){this.lineTypes.shapes=[],this.lineTypes.patterns=[],this.lineTypes.types=[]},hasLineTypes:function(){return this.lineTypes.types.length>0},getPDSFX:function(e){require(["DS/"+e.name+"/"+e.name],function(t){t(e.material,e.parameters)})},setLineTypes:function(e){if(null==e)return void this.clearLineTypes();if(1!==e.version)throw new Error(`Unsupported custom lines specifications (version ${e.version}, expected 1)`);function t(e,t){return!!e||(console.error(t),!1)}e.shapes||(e.shapes=[]),e.patterns||(e.patterns=[]),e.types||(e.types=[]);const n=(e,i)=>t(void 0!==e,`Missing ${i}`),a=(e,i)=>t(Number.isFinite(e),`Invalid ${i}, expected a finite number, got '${e}'`);function s(e){let t=0,i=0;for(let r=0;r<e.length;r++)t+=e[r].length,i+=2*(e[r].length/3-1);const r=new Float32Array(t),n=t>196608?new Uint32Array(i):new Uint16Array(i);let a=0,s=0;for(let t=0;t<e.length;t++){const i=e[t].length/3,o=a/3;for(let e=0;e+1<i;e++)n[s++]=o+e,n[s++]=o+e+1;r.set(e[t],a),a+=e[t].length}return{vertices:r,indices:n}}let o=[];for(let n=0;n<e.shapes.length;n++){const a=e.shapes[n];let l=null,h=null;if(a instanceof i.BufferGeometryDS)h=(l=a).drawingGroups[0];else{if(l=new i.BufferGeometryDS,a.triangles){if(!t(a.triangles.length%3==0,`Invalid shape ${n}, indices do not form a set of triangles`))return;l.vertexPositionArray=new Float32Array(a.vertices),l.vertexPositionArray.length>=196608?l.vertexIndexArray=new Uint32Array(a.triangles):l.vertexIndexArray=new Uint16Array(a.triangles),h=new r.DrawingGroup(void 0,void 0,4,0,l.vertexIndexArray.length)}else if(a.polylines){for(let e=0;e<a.polylines.length;e++)if(!t(a.polylines[e].length%3==0,`Invalid shape ${n}, polyline nÂ°${e} does not form a set of 3D vertices`))return;const{vertices:e,indices:i}=s(a.polylines);l.vertexPositionArray=e,l.vertexIndexArray=i,h=new r.DrawingGroup(null,null,1,0,l.vertexIndexArray.length)}if(!t(0!==l.vertexPositionArray.length,`Invalid shape ${n}, missing vertices`))return;if(!t(0!==l.vertexIndexArray.length,`Invalid shape ${n}, missing indices`))return;h&&(h._primitives=[{group:h,start:h.start,count:h.count}],h.geometry=l,l.drawingGroups.push(h))}o.push(h)}let l=[];for(let t=0;t<e.patterns.length;t++){let r=[];for(let s=0;s<e.patterns[t].length;s++){const l=e.patterns[t][s];if(!a(l.length,`length of segment ${s} of pattern ${t}`))return;if(void 0!==l.shape&&null!==l.shape&&!n(o[l.shape],`shape of segment ${s} of pattern ${t}`))return;const h=void 0;try{16===l.matrix.length?h=new i.Matrix4(...l.matrix):12===l.matrix.length&&(h=new i.Matrix3(...l.matrix))}catch(e){}r.push({length:l.length,shape:l.shape,matrix:h})}l.push(r)}let h=[];for(let t=0;t<e.types.length;t++){if(void 0!==e.types[t].pattern&&null!==e.types[t].pattern&&!n(l[e.types[t].pattern],`pattern of type ${t}`))return;if(void 0!==e.types[t].scale&&!a(e.types[t].scale,`scale of type ${t}`))return;if(!a(e.types[t].pixelWidth,`pixel width of type ${t}`))return;if(!a(e.types[t].printWidth,`print width of type ${t}`))return;h.push({pattern:e.types[t].pattern,scale:e.types[t].scale||1,pixelWidth:e.types[t].pixelWidth,printWidth:e.types[t].printWidth})}this.lineTypes.shapes=o,this.lineTypes.patterns=l,this.lineTypes.types=h},_createLineTypeMaterial:function(e,t){if(!this.hasLineTypes())return console.error(`Cannot create material for line type '${e}' material: no line types defined`),null;if(!this.lineTypes.types[e])return console.warn(`Cannot create material for line type '${e}' material: unknown line type`),null;const r=this.lineTypes.types[e];return t||(t={}),t.isCPUPattern=!0,t.force=!0,t.scale=r.scale||1,t.lineWidth=r.pixelWidth,t.pattern=void 0!==r.pattern&&null!==r.pattern?this.lineTypes.patterns[r.pattern]:void 0,t.patternShapes=this.lineTypes.shapes,new i.LineBasicMaterial(t)},deallocateSharedMaterials:function(){for(var e=["Invisible","Normal","Depth","NormalDepth","ShadowMapDepth","Picking","Highlight","PreHighlight","HighlightMobile"],t=["Face","Line","Point"],r=["0","1","2"],n=["true","false"],a=[1],s=0;s<e.length;s++){var o=i.DefaultMaterials[e[s]];if(o)for(var l=0;l<t.length;l++){var h=o[t[l]];if(h)for(var c=0;c<r.length;c++){var d=h[r[c]];if(d)for(var u=0;u<n.length;u++){var p=d[n[u]];if(p){var f=p[a[0]];f&&(f.needsUpdate=!0)}}}}}},initBackgroundColor:function(e){this.backgroundColorInit=!0;var t=this;this.backgroundColor=e.ambience.getBackgroundColor(),e.onBackgroundModify(function(e){t.backgroundColor=new i.Color(e),t.updateBackgroundColorMaterial()})},updateBackgroundColorMaterial:function(){for(var e=0;e<this.blankingRepMaterials.length;e++)this.blankingRepMaterials[e].color=this.backgroundColor;for(e=0;e<this.backgroundColorMaterials.length;e++)this.backgroundColorMaterials[e].color=this.backgroundColor;this.backgroundColorMaterial&&(this.backgroundColorMaterial.color=this.backgroundColor)},initResources:function(e,r,n){if(this.multiViewer=r,r){this.canvas=document.createElement("canvas");var a=null;if(this.debugWebgl2&&(a=this.canvas.getContext("webgl2",{alpha:!0,premultipliedAlpha:!1,antialias:n,stencil:!0,preserveDrawingBuffer:e||!1,powerPreference:i._webglPerformanceProfile()}),i.WebGLVersion=2),!a){var s={alpha:!0,premultipliedAlpha:!1,antialias:n,stencil:!0,preserveDrawingBuffer:e||!1,powerPreference:i._webglPerformanceProfile()};a=this.canvas.getContext("webgl",s)||this.canvas.getContext("experimental-webgl",s),i.WebGLVersion=1}this.context=a}var o=t.getWebappsAssetUrl("Effects",""),l=i.ImageUtils.loadTGATexture(o+"precomputedTexture.bin",new i.UVMapping,null,null,!0,!0);l.minFilter=i.NearestFilter,l.magFilter=i.NearestFilter,this.precomputedTexture=l,this.noiseTexture3D=new i.DataTexture(new Uint8Array(16),2,2,i.RGBAFormat,i.UnsignedByteType,new i.LatLongReflectionMapping,i.ClampToEdgeWrapping,i.ClampToEdgeWrapping,i.LinearFilter,i.LinearFilter),this.noiseTexture3D.generateMipmaps=!1,this.noiseTexture3D.needsUpdate=!0,this.noiseTexture3D.onRequest=function(){this.loadEndStatus=i.AssetLoadingStatus.READY;for(var e=new Uint8Array(1048576),t=0;t<262144;t++){var r=255*Math.random();e[4*t]=r,e[4*t+1]=r,e[4*t+2]=r,e[4*t+3]=255}this.image.data=e,this.image.width=512,this.image.height=512,this.needsUpdate=!0,this.onRequest=null};var h=i.ImageUtils.loadCompressedTexture(o+"AreaLightGGX1.dds",new i.UVMapping,null,null,!1,!0);h.minFilter=i.LinearFilter,h.magFilter=i.LinearFilter,this.precomputedAreaGGX1texture=h;var c=i.ImageUtils.loadCompressedTexture(o+"AreaLightGGX2.dds",new i.UVMapping,null,null,!1,!0);c.minFilter=i.LinearFilter,c.magFilter=i.LinearFilter,this.precomputedAreaGGX2texture=c;var d=i.ImageUtils.loadCompressedTexture(o+"AreaLightSheenAshikmin.dds",new i.UVMapping,null,null,!1,!0);d.minFilter=i.LinearFilter,d.magFilter=i.LinearFilter,this.precomputedAreaAshikmintexture=d;var u=i.ImageUtils.loadCompressedTexture(o+"AreaLightSheenEstevez.dds",new i.UVMapping,null,null,!1,!0);u.minFilter=i.LinearFilter,u.magFilter=i.LinearFilter,this.precomputedAreaEsteveztexture=u;var p=i.ImageUtils.loadCompressedTexture(o+"AreaLightSheenBeckmann.dds",new i.UVMapping,null,null,!1,!0);p.minFilter=i.LinearFilter,p.magFilter=i.LinearFilter,this.precomputedAreaBeckmanntexture=p},setCanvasSize:function(e,t,i){if(this.multiViewer){var r=t,n=i;for(var a of this.viewerList.values())if(e!==a){var s=a.getCanvasSize();r=Math.max(s.width,r),n=Math.max(s.height,n)}this.canvas.width=r,this.canvas.height=n}},getCanvas:function(){return this.canvas},getContext:function(){return this.context},onPDSFXMaterial:function(e){return this._modelEvent.subscribe({event:"PDSFXMaterial"},e)},cleanResources:function(){u.textures=[],this.textures=[],this.materials=this.materials.filter(function(e){return!e.hasTexture})},getMaterialById:function(e){var t;for(t=0;t<this.materials.length;t++)if(this.materials[t].threejs_mat.id===e)return this.materials[t].threejs_mat;return null},getMaterialByName:function(e){var t;for(t=0;t<this.materials.length;t++)if(this.materials[t].threejs_mat.name===e)return this.materials[t].threejs_mat;return null},getBackgroundColorMaterial:function(){return this.backgroundColorMaterial?this.backgroundColorMaterial:(this.backgroundColorMaterial=new i.MeshBasicMaterial({side:i.DoubleSide,color:this.backgroundColor}),this.backgroundColorMaterial)},displayBlankingPolygon:function(e,t){this.displayBlanking=e;for(var i=0;i<this.blankingRepMaterials.length;i++)this.blankingRepMaterials[i].opacity=e?1:0},getBlankingRepMaterial:function(){var e=new i.MeshBasicMaterial({color:this.backgroundColor,overridable:!1,side:i.DoubleSide,opacity:this.displayBlanking?1:0,depthTest:!1,shading:i.FlatShading});return this.blankingRepMaterials.push(e),e},_getDashPattern:function(e){var t;switch(console.error("Error: accessing private method on MaterialManager"),e){case r.LinePatternEnum.DOTTED:(t=new Float32Array(2))[0]=2,t[1]=2;break;case r.LinePatternEnum.DASHED:(t=new Float32Array(2))[0]=3,t[1]=1;break;case r.LinePatternEnum.DOTDASHED:(t=new Float32Array(4))[0]=3,t[1]=2,t[2]=1,t[3]=2;break;case r.LinePatternEnum.PHANTOM:(t=new Float32Array(6))[0]=6,t[1]=2,t[2]=2,t[3]=2,t[4]=2,t[5]=2;break;case r.LinePatternEnum.SMALLDOTTED:(t=new Float32Array(2))[0]=1,t[1]=1;break;case r.LinePatternEnum.JISAXIS:(t=new Float32Array(4))[0]=2,t[1]=1,t[2]=12,t[3]=2;break;default:(t=new Float32Array(1))[0]=-1}return t},extractMaterialApplicationMappingInfos(e,t,r){if(e)if(t.isPhysicalMaterial){var n=t.__physicalMode>=1,a=!!e.type,s=!e.UvTransfoInfos||e.type||!!e.UvTransformation,o=null;e.ObjectTransformation&&((o=new i.Matrix4).elements=e.ObjectTransformation);var l=!1,h=!1;n?(h=!0,a||(l=!0)):(l=!0,a&&(h=!0));var c=null;h&&e.UvTransformation&&((c=new i.Matrix3).elements=e.UvTransformation);var d=null;if(l&&e.UvTransfoInfos){d=new i.Matrix3;var u=Math.cos(e.UvTransfoInfos[2]),p=Math.sin(e.UvTransfoInfos[2]),f=e.UvTransfoInfos[3],g=[e.UvTransfoInfos[0],e.UvTransfoInfos[1]];d.set(f*u,-f*p,g[0],f*p,f*u,g[1],0,0,1)}c&&d?c.multiplyMatrices(c,d):d&&(c=d);var m=e.type;n||("SPHERICAL_NORMALIZED"===m&&(m="SPHERICAL"),"INFINITE_CYLINDRICAL_NORMALIZED"===m&&(m="INFINITE_CYLINDRICAL")),s||-1==t.mappingType?t.setMappingOperator(m,o,c,!0):t.mappingUVTransformation.multiplyMatrices(c,t.mappingUVTransformation),t.mappingTransformSemantic=null!=e.transformSemantic?e.transformSemantic:1}else{c=null;if(e.UvTransfoInfos){c=new i.Matrix3;u=Math.cos(e.UvTransfoInfos[2]),p=Math.sin(e.UvTransfoInfos[2]),f=e.UvTransfoInfos[3],g=[e.UvTransfoInfos[0],e.UvTransfoInfos[1]];c.set(f*u,-f*p,g[0],f*p,f*u,g[1],0,0,1),r&&c.multiplyMatrices(uvTransfo,r),t.setMappingOperator(0,null,c,!0)}else r&&t.setMappingOperator(0,null,r,!0)}},getMaterialCgr:function(e,t,r,n,a){var s,o,l;if("true"===localStorage.getItem("NoCGRMaterials"))return null;if(void 0!==e.backgoundColor)return this.getBackgroundColorMaterial();if(void 0!==e.blankingRep)return this.getBlankingRepMaterial();if(void 0!==e.external3DXid){var h=this.getCGRSharedMaterial(e.external3DXid);return h&&this.extractMaterialApplicationMappingInfos(e.mapping,h),h}var c=!!i._CATGraphicalAsPBR;for(o=0;o<this.materials.length;o++)if("material"===(l=(s=this.materials[o]).params).type&&!l.shaderMaterial&&l.ambientCoef===e.ambientCoef&&l.diffuseCoef===e.diffuseCoef&&l.specularCoef===e.specularCoef&&l.colorAmbient[0]===e.colorAmbient[0]&&l.colorAmbient[1]===e.colorAmbient[1]&&l.colorAmbient[2]===e.colorAmbient[2]&&l.colorDiffuse[0]===e.colorDiffuse[0]&&l.colorDiffuse[1]===e.colorDiffuse[1]&&l.colorDiffuse[2]===e.colorDiffuse[2]&&l.colorSpecular[0]===e.colorSpecular[0]&&l.colorSpecular[1]===e.colorSpecular[1]&&l.colorSpecular[2]===e.colorSpecular[2]&&(void 0===l.url||-1!==e.textureId)&&(void 0!==l.url||-1===e.textureId)&&-1===e.textureId&&l.transparent===e.transparent&&l.shininess===e.shininess&&l.textureImageNumberComposante===e.textureImageNumberComposante&&l.textureBlending===e.textureBlending&&l.magFilter===e.magFilter&&l.minFilter===e.minFilter&&l.mappingFunction===e.mappingFunction&&l.textureWrapS===e.textureWrapS&&l.textureWrapT===e.textureWrapT&&l.addedComposantInTexEnv===e.addedComposantInTexEnv&&(!1!==l._pbr||!c)&&(!0!==l._pbr||c)&&(!l.mapping||e.mapping&&l.mapping.type===e.mapping.type&&l.mapping.ObjectTransformation===e.mapping.ObjectTransformation&&l.mapping.UvTransformation===e.mapping.UvTransformation))return s.threejs_mat;return(s=this.createMaterial(e,t,r,n,null,a))&&(s._source=i.AssetSource.MATERIAL_MANAGER),s},getMaterial3DXML:function(e,t,r,n,a){var s,o,l,h=!!i._CATGraphicalAsPBR;for(o=0;o<this.materials.length;o++)if("material3DXML"===(l=(s=this.materials[o]).params).type&&l.shading===e.shading&&l.reflectivityCoef===e.reflectivityCoef&&l.shininess===e.shininess&&l.specularCoef===e.specularCoef&&l.WrappingModeU===e.WrappingModeU&&l.WrappingModeV===e.WrappingModeV&&l.FlipU===e.FlipU&&l.FlipV===e.FlipV&&l.transparency===e.transparency&&l.transparent===e.transparent&&l.alphaTest===e.alphaTest&&l.mappingFunction===e.mappingFunction&&l.MappingType===e.MappingType&&l.TextureDimension===e.TextureDimension&&l.TextureFunction===e.TextureFunction&&l.DiffuseMap===e.DiffuseMap&&l.DiffuseMapRepeat[0]===e.DiffuseMapRepeat[0]&&l.DiffuseMapRepeat[1]===e.DiffuseMapRepeat[1]&&l.DiffuseMapWrap[0]===e.DiffuseMapWrap[0]&&l.DiffuseMapWrap[1]===e.DiffuseMapWrap[1]&&l.colorAmbient[0]===e.colorAmbient[0]&&l.colorAmbient[1]===e.colorAmbient[1]&&l.colorAmbient[2]===e.colorAmbient[2]&&l.colorDiffuse[0]===e.colorDiffuse[0]&&l.colorDiffuse[1]===e.colorDiffuse[1]&&l.colorDiffuse[2]===e.colorDiffuse[2]&&!(!l.colorSpecular&&e.colorSpecular||l.colorSpecular&&!e.colorSpecular)&&(!l.colorSpecular||!e.colorSpecular||l.colorSpecular[0]===e.colorSpecular[0]&&l.colorSpecular[1]===e.colorSpecular[1]&&l.colorSpecular[2]===e.colorSpecular[2])&&(!1!==l._pbr||!h)&&(!0!==l._pbr||h))return a&&(0===l.__nbTexturesToLoad?a(s.threejs_mat):(l.__cbLoadedImages||(l.__cbLoadedImages=[]),l.__cbLoadedImages.push(a))),s.threejs_mat;return(s=this.createMaterial(e,t,r,null,a))._source=i.AssetSource.MATERIAL_MANAGER,s},getTexture:function(e){this._currentMatHasTexture=!0;var t,r,n,a,s=[];if(e.offset||(e.offset=[0,0]),e.repeat||(e.repeat=[1,1]),e.wrap&&!e.overrideWrap||(e.resources&&e.resources.wrap?e.wrap=e.resources.wrap:e.wrap||(e.wrap=[1,1])),e.filter||(e.resources&&e.resources.filter?e.filter=e.resources.filter:e.filter=[5,1]),void 0!==e.resourceId&&this.textures[e.resourceId]&&(s=this.textures[e.resourceId]),s.length){for(n=0;n<s.length;n++)if(a=t=s[n],r=t.params,e.texturePoint===r.texturePoint)return e.offset[0]!==r.offset[0]||e.offset[1]!==r.offset[1]||e.repeat[0]!==r.repeat[0]||e.repeat[1]!==r.repeat[1]||e.wrap[0]!==r.wrap[0]||e.wrap[1]!==r.wrap[1]||e.filter[0]!==r.filter[0]||(e.filter[1],r.filter[1]),t.threejs_texture;switch((t=a.threejs_texture.clone()).offset.set(e.offset[0],e.offset[1]),t.repeat.set(e.repeat[0],e.repeat[1]),1===e.wrap[0]||"repeat"==e.wrap[0]?t.wrapS=i.RepeatWrapping:t.wrapS=i.ClampToEdgeWrapping,1===e.wrap[1]||"repeat"==e.wrap[0]?t.wrapT=i.RepeatWrapping:t.wrapT=i.ClampToEdgeWrapping,e.filter[0]){case 0:t.min=i.NearestFilter;break;case 1:t.min=i.LinearFilter;break;case 2:t.min=i.NearestMipMapNearestFilter;break;case 3:t.min=i.NearestMipMapLinearFilter;break;case 4:t.min=i.LinearMipMapNearestFilter;break;case 5:t.min=i.LinearMipMapLinearFilter}switch(e.filter[1]){case 0:t.mag=i.NearestFilter;break;case 1:t.mag=i.LinearFilter;break;case 2:t.mag=i.NearestMipMapNearestFilter;break;case 3:t.mag=i.NearestMipMapLinearFilter;break;case 4:t.mag=i.LinearMipMapNearestFilter;break;case 5:t.mag=i.LinearMipMapLinearFilter}var o={offset:e.offset,repeat:e.repeat,wrap:e.wrap,filter:e.filter,texturePoint:e.texturePoint};return this.textures[e.resourceId]=[{params:o,threejs_texture:t}],t._source=i.AssetSource.MATERIAL_MANAGER,t}if(t=this.createTexture(e),void 0!==e.resourceId){o={offset:e.offset,repeat:e.repeat,wrap:e.wrap,filter:e.filter,texturePoint:e.texturePoint};this.textures[e.resourceId]=[{params:o,threejs_texture:t}]}return t._source=i.AssetSource.MATERIAL_MANAGER,t},createMaterial:function(e,r,n,l,h,u){function f(){return Y}function g(e){return(255*e[0]<<16)+(255*e[1]<<8)+255*e[2]}this._currentMatHasTexture=!1,e.__nbTexturesToLoad=0,e.__cbLoadedImages=[],h&&e.__cbLoadedImages.push(h);var m="MeshPhongMaterial",v={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,blending:i.NormalBlending,side:i.DoubleSide};if(e.physicalMaterial){var y={},S=e.physicalMaterial.PhysicalMaterial,_=i.PhysicalMaterial;if(S.isVisDescription){var x=this,b="Visu.DSPBR@21x"===S.type,w="Visu.EVisuPBR"===S.type,M="Visu.DSPBR@22x"===S.type,C="Visu.DSPBR@23x"===S.type,P="Visu.SpecularGlossiness@21x"===S.type||w||b||M||C,E=e.mapping&&e.mapping.type||P,A=function(e,t,r){var n=null;r&&(n=r);var a=S[t];if(a&&(n=a),n){var s=new i.Matrix3;s.set(n[0],n[2],n[4],n[1],n[3],n[5],0,0,1),y[e]=s.isIdentity()?d:s}},T=function(e,t,r,n){var a=S[t];if(void 0!==a){if(a.length)return y[e]=new i.Color,void y[e].setRGB(a[0],a[1],a[2]);if(void 0!==a.MADCoefficients){var s=a.MADCoefficients;y[e+"MulCoef"]=new i.Vector3(s[0],s[1],s[2]),y[e+"AddCoef"]=new i.Vector3(s[3],s[4],s[5])}void 0!==a.value?(y[e]=new i.Color,y[e].setRGB(a.value[0],a.value[1],a.value[2])):void 0!==a.texture&&n?(y[e+"Map"]=x.getTexture({wrap:I,overrideWrap:!0,type:"data",resources:l[a.texture],resourceId:a.texture}),E&&A(e+"UvTransform",t+"UvTransform",l[a.texture].uvTransform)):null!==r&&(y[e]=new i.Color,y[e].setRGB(r.x,r.y,r.z))}else null!==r&&(y[e]=new i.Color,y[e].setRGB(r.x,r.y,r.z))},D=function(e,t,i,r){var n=S[t];if(void 0!==n){if("object"!=typeof n)return void(y[e]=n);if(void 0!==n.MADCoefficients){var a=n.MADCoefficients;y[e+"MulCoef"]=a[0],y[e+"AddCoef"]=a[1]}void 0!==n.value?y[e]=n.value:void 0!==n.texture&&r?(y[e+"Map"]=x.getTexture({wrap:I,overrideWrap:!0,type:"data",resources:l[n.texture],resourceId:n.texture}),y.transparent=y.transparent||"opacity"===e||"transparency"===e,E&&A(e+"UvTransform",t+"UvTransform",l[n.texture].uvTransform)):null!==i&&(y[e]=i)}else null!==i&&(y[e]=i)};if("Visu.SpecularGlossiness"===S.type||"Visu.SpecularGlossiness@21x"===S.type){var I=[0,0];S.RepeatU&&(I[0]=1),S.RepeatV&&(I[1]=1)}else I=null;var R=S.diffuse||S.albedo;if(R){if(R.MADCoefficients){var O=R.MADCoefficients;y.diffuseMulCoef=new i.Vector3(O[0],O[1],O[2]),y.diffuseAddCoef=new i.Vector3(O[3],O[4],O[5])}R.value?(y.color=new i.Color,y.color.setRGB(R.value[0],R.value[1],R.value[2])):null!=R.texture&&(y.map=this.getTexture({wrap:I,overrideWrap:!0,type:"data",resources:l[R.texture],resourceId:R.texture}),E&&A("diffuseUvTransform","diffuseUvTransform",l[R.texture].uvTransform))}if(w||b||M||C){_=i.DSPBR19xMaterial;var L=function(e,t){var r=S[t];if(void 0!==r){if(void 0!==r.MADCoefficients){var n=r.MADCoefficients;y[e+"MulCoef"]=new i.Vector3(n[0],n[1],n[2]),y[e+"AddCoef"]=new i.Vector3(n[3],n[4],n[5])}void 0!==r.texture&&(y[e+"Map"]=x.getTexture({wrap:I,overrideWrap:!0,type:"data",resources:l[r.texture],resourceId:r.texture}),A(e+"UvTransform",e+"UvTransform",l[r.texture].uvTransform))}};D("metalness","metallic",0,!0),D("roughness","roughness",0,!0),D("anisotropyAngle","anisotropyRotation",0,!0),L("normal","normal"),D("opacity","cutoutOpacity",1,!0),D("thickness","thickness",0,!0),w||(D("translucency","translucency",0,!0),L("displacement","displacement"),D("subsurfaceAnisotropy","subsurfaceAnisotropy",0,!1),b?(_=i.DSPBR21xMaterial,T("sheenColor","sheenColor",new i.Vector3(1,1,1),!0),D("sheenRoughness","sheenRoughness",.3,!0)):(_=i.DSPBR22xMaterial,T("sheenColor","sheenColor",new i.Vector3(0,0,0),!0),D("sheenRoughness","sheenRoughness",.5,!0),T("flipFlopColor","flipFlopColor",new i.Vector3(1,1,1),!0),D("flipFlop","flipFlop",0,!0),void 0!==S.subtype&&(y._subtype=i.DSPBRSubTypes[o[S.subtype]]),C&&(_=i.DSPBR23xMaterial,T("translucencyColor","translucencyColor",new i.Vector3(0,0,0),!0),D("iridescence","iridescence",0,!0),D("iridescenceThickness","iridescenceThickness",1,!0),D("iridescenceIoR","iridescenceIoR",1.5,!1)))),(w||b)&&D("sheen","sheen",0,!0),D("specularContrib","specular",1,!0),T("specular","specularTint",new i.Vector3(1,1,1),!0),T("flakesColor","flakeColor",new i.Vector3(1,1,1),!0),D("flakesCoverage","flakeCoverage",0,!0),D("flakesCoverage","flakeDensity",null,!0),D("flakesSize","flakeSize",.5,!0),D("flakesRoughness","flakeRoughness",0,!0),D("clearCoat","clearcoat",0,!0),L("clearCoatNormal","clearcoatNormal"),D("clearCoatRoughness","clearcoatRoughness",0,!0),D("orangePeel","orangePeel",!1,!1),D("orangePeelScale","orangePeelScale",0,!1),T("emissionColor","emissionColor",new i.Vector3(1,1,1),!0),D("emissionValue","emissionValue",0,!1),D("emissionNormalized","emissionEnergyNormalization",!1,!1),D("thinWalled","thinWalled",!1,!1),D("ior","ior",1.5,!1),T("attenuationColor","attenuationColor",new i.Vector3(1,1,1),!1),T("subsurfaceColor","subsurfaceColor",new i.Vector3(0,0,0),!1),D("attenuationDistance","attenuationDistance",1e8,!1),S.cutoutFromAlbedoAlpha||S.UseAlphaDiffuseChannel?(y.transparent=!0,y.useAlphaFromDiffuseMap=!0):y.useAlphaFromDiffuseMap=!1}else{y.specGlossNRE=!0;L=function(e,t){var i=S[t+"Map"];void 0!==i&&(y[e+"Map"]=x.getTexture({wrap:I,overrideWrap:!0,type:"data",resources:l[i.texture],resourceId:i.texture}),E&&A(e+"UvTransform",t+"MapUvTransform",l[i.texture].uvTransform))};T("specular","fresnelCoefficient",new i.Vector3(.04,.04,.04),!0),T("emissionColor","emissive",new i.Vector3(0,0,0),!0),y.emissionValue=1,T("flakesColor","flakesColor",new i.Vector3(0,0,0),!1),y.flakesColorMulCoef=new i.Vector3(.12,.12,.12),y.flakesColorAddCoef=new i.Vector3(0,0,0),T("pearlFlakesColor","pearlFlakesColor",new i.Vector3(0,0,0),!1),y.pearlFlakesColorMulCoef=new i.Vector3(.08,.08,.08),y.pearlFlakesColorAddCoef=new i.Vector3(0,0,0),T("clearCoatColor","coatingFresnelCoefficient",new i.Vector3(.04,.04,.04),!0),D("glossiness","glossiness",1,!0),D("opacity","opacity",1,!0),D("anisotropyAngle","anisotropyAngle",0,!0),D("clearCoat","Coating",0,!1),function(e,t,r,n){var a=S[t];if(void 0!==a){if(void 0!==a.MADCoefficients){var s=a.MADCoefficients;y[e+"MulCoef"]=s[0],y[e+"AddCoef"]=s[1]}void 0!==a.value?y[e]=new i.Vector2(a.value,a.value):void 0!==a.texture&&n?(y[e+"Map"]=x.getTexture({wrap:I,overrideWrap:!0,type:"data",resources:l[a.texture],resourceId:a.texture}),E&&A(e+"UvTransform",t+"UvTransform",l[a.texture].uvTransform)):null!==r&&(y[e]=r)}else null!==r&&(y[e]=r)}("normalScale","bumpScale",new i.Vector2(1,1),!0),D("coatingGlossiness","coatingGlossiness",1,!1),D("clearCoatNormalScale","coatingBump",0,!1),D("orangePeel","ProceduralCoating",!1,!1),D("orangePeelScale","coatingScale",1,!1),D("flakes","Flakes",!1,!1),D("flakesDensity","flakesDensity",0,!0),D("flakesBump","flakesBump",1,!1),D("flakesScale","flakesScale",.5,!1),D("flakesRoughness","flakesRoughness",.25,!1),D("pearlFlakesBump","pearlFlakesBump",1,!1),D("pearlFlakesDensity","pearlFlakesDensity",1,!1),L("normal","normal"),S.NormalMapConventionPositiveY?y.normalMapFlipY=!0:y.normalMapFlipY=!1,L("clearCoatNormal","coatingNormal"),S.CoatingNormalMapConventionPositiveY?y.clearCoatNormalMapFlipY=!0:y.clearCoatNormalMapFlipY=!1,D("displacement","displacement",0,!0);var V=S.displacement;if(void 0!==V&&void 0!==V.MADCoefficients){O=V.MADCoefficients;y.displacementScale=O[0],y.displacementBias=O[1]}S.UseAlphaDiffuseChannel?(y.transparent=!0,y.useAlphaFromDiffuseMap=!0):y.useAlphaFromDiffuseMap=!1}D("anisotropy","anisotropy",0,!0),D("anisotropyAngle","anisotropyAngle",0,!0),D("transparency","transparency",0,!0),(1==y.opacity&&y.transparency>0||y.opacityMap)&&(y.transparent=!0),S.IsAlphaTestEnabled&&(y.transparent=!1,y.alphaTest=.5)}else{y.specGlossNRE=!0;var F=S.MappingOperator.Type;if("None"!=F&&(y.mappingUseFragment=!0,y.mappingObjTransformation=new i.Matrix4,y.mappingObjTransformation.elements=S.MappingOperator.ObjectTransformation,"Planar"==F?y.mappingType=1:"Spherical"==F?y.mappingType=2:"Spherical Normalized"==F?y.mappingType=2:"Cubic"==F?y.mappingType=3:"FiniteCylindrical"==F?y.mappingType=4:"InfiniteCylindrical"==F?y.mappingType=5:"InfiniteCylindrical Normalized"==F&&(y.mappingType=5)),y.mappingUVTransformation=new i.Matrix3,y.mappingUVTransformation.elements=S.MappingOperator.UvTransformation,S.Float3Parameter){var B=S.Float3Parameter;if(B.diffuse){O=B.diffuse.MADCoefficients;if(0==B.diffuse.AsTexture)y.color=new i.Color,y.color.setRGB(B.diffuse.Value[0],B.diffuse.Value[1],B.diffuse.Value[2]),y.diffuseMulCoef=new i.Vector3(O[0],O[1],O[2]),y.diffuseAddCoef=new i.Vector3(O[3],O[4],O[5]);else{I=[0,0];if("eRepeat"==B.diffuse.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==B.diffuse.Sampling.TexCoordVWrap&&(I[1]=1),B.diffuse.UvTransform&&"None"!=F){var N=B.diffuse.UvTransform;y.diffuseUvTransform=new i.Matrix3(N[0],N[4],N[8],N[1],N[5],N[9],N[2],N[6],N[10])}y.diffuseMulCoef=new i.Vector3(O[0],O[1],O[2]),y.diffuseAddCoef=new i.Vector3(O[3],O[4],O[5]),y.map=this.getTexture({wrap:I,type:"data",resources:l[B.diffuse.Texture],resourceId:B.diffuse.Texture})}}if(B.fresnelCoefficient){O=B.fresnelCoefficient.MADCoefficients;if(0==B.fresnelCoefficient.AsTexture)y.specular=new i.Color,y.specular.setRGB(B.fresnelCoefficient.Value[0],B.fresnelCoefficient.Value[1],B.fresnelCoefficient.Value[2]),y.specularMulCoef=new i.Vector3(O[0],O[1],O[2]),y.specularAddCoef=new i.Vector3(O[3],O[4],O[5]);else{I=[0,0];if("eRepeat"==B.fresnelCoefficient.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==B.fresnelCoefficient.Sampling.TexCoordVWrap&&(I[1]=1),B.fresnelCoefficient.UvTransform&&"None"!=F){var G=B.fresnelCoefficient.UvTransform;y.specularUvTransform=new i.Matrix3(G[0],G[4],G[8],G[1],G[5],G[9],G[2],G[6],G[10])}y.specularMulCoef=new i.Vector3(O[0],O[1],O[2]),y.specularAddCoef=new i.Vector3(O[3],O[4],O[5]),y.specularMap=this.getTexture({wrap:I,type:"data",resources:l[B.fresnelCoefficient.Texture],resourceId:B.fresnelCoefficient.Texture})}}if(B.emissive){O=B.emissive.MADCoefficients;if(0==B.emissive.AsTexture)y.emissive=new i.Color,y.emissive.setRGB(B.emissive.Value[0],B.emissive.Value[1],B.emissive.Value[2]),y.emissiveMulCoef=new i.Vector3(O[0],O[1],O[2]),y.emissiveAddCoef=new i.Vector3(O[3],O[4],O[5]);else{y.emissive=new i.Color,y.emissive.setRGB(1,1,1);I=[0,0];if("eRepeat"==B.emissive.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==B.emissive.Sampling.TexCoordVWrap&&(I[1]=1),B.emissive.UvTransform&&"None"!=F){var k=B.emissive.UvTransform;y.emissiveUvTransform=new i.Matrix3(k[0],k[4],k[8],k[1],k[5],k[9],k[2],k[6],k[10])}y.emissiveMulCoef=new i.Vector3(O[0],O[1],O[2]),y.emissiveAddCoef=new i.Vector3(O[3],O[4],O[5]),y.emissiveMap=this.getTexture({wrap:I,type:"data",resources:l[B.emissive.Texture],resourceId:B.emissive.Texture})}}if(B.coatingFresnelCoefficient&&!1===B.coatingFresnelCoefficient.AsTexture&&(y.coatingSpecularColor=new i.Color,y.coatingSpecularColor.setRGB(B.coatingFresnelCoefficient.Value[0],B.coatingFresnelCoefficient.Value[1],B.coatingFresnelCoefficient.Value[2])),B.flakesColor){O=B.flakesColor.MADCoefficients;!1===B.flakesColor.AsTexture&&(y.flakesColor=new i.Color,y.flakesColor.setRGB(B.flakesColor.Value[0],B.flakesColor.Value[1],B.flakesColor.Value[2]),y.flakesColorMulCoef=new i.Vector3(O[0],O[1],O[2]),y.flakesColorAddCoef=new i.Vector3(O[3],O[4],O[5]))}if(B.pearlFlakesColor){O=B.pearlFlakesColor.MADCoefficients;!1===B.pearlFlakesColor.AsTexture&&(y.pearlFlakesColor=new i.Color,y.pearlFlakesColor.setRGB(B.pearlFlakesColor.Value[0],B.pearlFlakesColor.Value[1],B.pearlFlakesColor.Value[2]),y.pearlFlakesColorMulCoef=new i.Vector3(O[0],O[1],O[2]),y.pearlFlakesColorAddCoef=new i.Vector3(O[3],O[4],O[5]))}}if(S.FloatParameter){var U=S.FloatParameter;if(U.glossiness){O=U.glossiness.MADCoefficients;if(0==U.glossiness.AsTexture)y.glossiness=U.glossiness.Value,y.glossinessMulCoef=O[0],y.glossinessAddCoef=O[1];else{I=[0,0];if("eRepeat"==U.glossiness.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==U.glossiness.Sampling.TexCoordVWrap&&(I[1]=1),U.glossiness.UvTransform&&"None"!=F){var z=U.glossiness.UvTransform;y.glossinessUvTransform=new i.Matrix3(z[0],z[4],z[8],z[1],z[5],z[9],z[2],z[6],z[10])}y.glossinessMulCoef=O[0],y.glossinessAddCoef=O[1],y.glossinessMap=this.getTexture({wrap:I,type:"data",resources:l[U.glossiness.Texture],resourceId:U.glossiness.Texture})}}if(U.bumpScale){O=U.bumpScale.MADCoefficients;if(0==U.bumpScale.AsTexture){var H=U.bumpScale.Value;y.normalScale=new i.Vector2(H,H),y.normalScaleMulCoef=O[0],y.normalScaleAddCoef=O[1]}}if(U.opacity){O=U.opacity.MADCoefficients;if(0==U.opacity.AsTexture)y.opacity=U.opacity.Value,y.opacityMulCoef=O[0],y.opacityAddCoef=O[1];else{I=[0,0];if("eRepeat"==U.opacity.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==U.opacity.Sampling.TexCoordVWrap&&(I[1]=1),U.opacity.UvTransform&&"None"!=F){var W=U.opacity.UvTransform;y.opacityUvTransform=new i.Matrix3(W[0],W[4],W[8],W[1],W[5],W[9],W[2],W[6],W[10])}y.opacityMulCoef=O[0],y.opacityAddCoef=O[1],y.opacityMap=this.getTexture({wrap:I,type:"data",resources:l[U.opacity.Texture],resourceId:S.MapParameter.normalMap.Texture})}}if(U.transparency){O=U.transparency.MADCoefficients;0==U.transparency.AsTexture&&(y.transparency=U.transparency.Value,y.transparencyMulCoef=O[0],y.transparencyAddCoef=O[1])}if(U.anisotropy){O=U.anisotropy.MADCoefficients;if(0==U.anisotropy.AsTexture)y.anisotropy=U.anisotropy.Value,y.anisotropyMulCoef=O[0],y.anisotropyAddCoef=O[1];else{I=[0,0];if("eRepeat"==U.anisotropy.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==U.anisotropy.Sampling.TexCoordVWrap&&(I[1]=1),U.anisotropy.UvTransform&&"None"!=F){var j=U.anisotropy.UvTransform;y.anisotropyUvTransform=new i.Matrix3(j[0],j[4],j[8],j[1],j[5],j[9],j[2],j[6],j[10])}y.anisotropyMulCoef=O[0],y.anisotropyAddCoef=O[1],y.anisotropyMap=this.getTexture({wrap:I,type:"data",resources:l[U.anisotropy.Texture],resourceId:U.anisotropy.Texture})}}if(U.anisotropyAngle)if(0==U.anisotropyAngle.AsTexture){O=U.anisotropyAngle.MADCoefficients;y.anisotropyAngle=U.anisotropyAngle.Value,y.anisotropyAngleMulCoef=O[0],y.anisotropyAngleAddCoef=O[1]}else{I=[0,0];if("eRepeat"==U.anisotropyAngle.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==U.anisotropyAngle.Sampling.TexCoordVWrap&&(I[1]=1),U.anisotropyAngle.UvTransform&&"None"!=F){var X=U.anisotropyAngle.UvTransform;y.anisotropyAngleUvTransform=new i.Matrix3(X[0],X[4],X[8],X[1],X[5],X[9],X[2],X[6],X[10])}y.anisotropyAngleMulCoef=O[0],y.anisotropyAngleAddCoef=O[1],y.anisotropyAngleMap=this.getTexture({wrap:I,type:"data",resources:l[U.anisotropyAngle.Texture],resourceId:U.anisotropyAngle.Texture})}if(U.coatingGlossiness){O=U.coatingGlossiness.MADCoefficients;if(!1===U.coatingGlossiness.AsTexture){H=O[1]+U.coatingGlossiness.Value*O[0];y.coatingGlossiness=H}else{I=[0,0];if("eRepeat"==U.coatingGlossiness.Sampling.TexCoordUWrap&&(I[0]=1),"eRepeat"==U.coatingGlossiness.Sampling.TexCoordVWrap&&(I[1]=1),U.coatingGlossiness.UvTransform&&"None"!=F){var q=U.coatingGlossiness.UvTransform;y.coatingGlossinessUvTransform=new i.Matrix3(q[0],q[4],q[8],q[1],q[5],q[9],q[2],q[6],q[10])}y.coatingGlossinessMulCoef=O[0],y.coatingGlossinessAddCoef=O[1],y.coatingGlossinessMap=this.getTexture({wrap:I,type:"data",resources:l[U.coatingGlossiness.Texture],resourceId:U.coatingGlossiness.Texture})}}if(U.coatingBump){O=U.coatingBump.MADCoefficients;if(!1===U.coatingBump.AsTexture){H=O[1]+U.coatingBump.Value*O[0];y.clearCoatNormalScale=H}}if(U.coatingScale){O=U.coatingScale.MADCoefficients;if(!1===U.coatingScale.AsTexture){H=O[1]+U.coatingScale.Value*O[0];y.orangePeelScale=H}}if(U.flakesBump){O=U.flakesBump.MADCoefficients;if(!1===U.flakesBump.AsTexture){H=O[1]+U.flakesBump.Value*O[0];y.flakesBump=H}}if(U.flakesDensity){O=U.flakesDensity.MADCoefficients;if(!1===U.flakesDensity.AsTexture){H=O[1]+U.flakesDensity.Value*O[0];y.flakesDensity=H}}if(U.flakesScale){O=U.flakesScale.MADCoefficients;if(!1===U.flakesScale.AsTexture){H=O[1]+U.flakesScale.Value*O[0];y.flakesScale=H}}if(U.flakesRoughness){O=U.flakesRoughness.MADCoefficients;if(!1===U.flakesRoughness.AsTexture){H=O[1]+U.flakesRoughness.Value*O[0];y.flakesRoughness=H}}if(U.pearlFlakesBump){O=U.pearlFlakesBump.MADCoefficients;if(!1===U.pearlFlakesBump.AsTexture){H=O[1]+U.pearlFlakesBump.Value*O[0];y.pearlFlakesBump=H}}if(U.pearlFlakesDensity){O=U.pearlFlakesDensity.MADCoefficients;if(!1===U.pearlFlakesDensity.AsTexture){H=O[1]+U.pearlFlakesDensity.Value*O[0];y.pearlFlakesDensity=H}}}if(y.useAlphaFromDiffuseMap=!1,"eDiffuseChannel"==S.AlphaMode?(y.transparent=!0,y.useAlphaFromDiffuseMap=!0):(1==y.opacity&&y.transparency>0||y.opacityMap)&&(y.transparent=!0),1==S.AlphaTest&&(y.transparent=!1,y.alphaTest=.5),!0===S.Coating&&(y.coating=1),!0===S.ProceduralCoating&&(y.orangePeel=!0),!0===S.Flakes&&(y.flakes=!0),S.NormalMap&&1==S.NormalMap.UseNormalMap&&(y.normalMap=this.getTexture({type:"data",resources:l[S.NormalMap.Texture],resourceId:S.NormalMap.Texture})),S.MapParameter&&S.MapParameter.normalMap&&1==S.MapParameter.normalMap.Enabled){if(y.normalMap=this.getTexture({type:"data",resources:l[S.MapParameter.normalMap.Texture],resourceId:S.MapParameter.normalMap.Texture}),S.MapParameter.normalMap.UvTransform&&"None"!=F){var Z=S.MapParameter.normalMap.UvTransform;y.normalUvTransform=new i.Matrix3(Z[0],Z[4],Z[8],Z[1],Z[5],Z[9],Z[2],Z[6],Z[10])}"PositiveY"!=S.NormalMapConvention?y.normalMapFlipY=!1:y.normalMapFlipY=!0}if(S.MapParameter&&S.MapParameter.coatingBumpMap&&1==S.MapParameter.coatingBumpMap.Enabled){if(y.clearCoatNormalMap=this.getTexture({type:"data",resources:l[S.MapParameter.coatingBumpMap.Texture],resourceId:S.MapParameter.coatingBumpMap.Texture}),S.MapParameter.coatingBumpMap.UvTransform&&"None"!=F){Z=S.MapParameter.coatingBumpMap.UvTransform;y.clearCoatNormalUvTransform=new i.Matrix3(Z[0],Z[4],Z[8],Z[1],Z[5],Z[9],Z[2],Z[6],Z[10])}"PositiveY"!=S.CoatingBumpMapConvention?y.clearCoatNormalMapFlipY=!1:y.clearCoatNormalMapFlipY=!0}}y.NRECompatibility=!0;var Y=new _(y);return this.extractMaterialApplicationMappingInfos(e.mapping,Y),Y}if(e.shaderMaterial)return e.shaderMaterial.PDSFX?(Y=function(e,t,r,n,a){var s=0,o=e.param;for(s in o){var l=o[s].imgId;void 0!==l&&(t[l]&&t[l].url&&(o[s].url=t[l].url),o[s].map=r.getTexture({type:"data",resources:t[l],resourceId:l}),r.resources[l]=o[s].map)}var h={name:e.name,parameters:e.param,material:null},c=localStorage.getItem("A2XPDSFXConvention"),d="DS/Shaders/"+e.name;return c&&(d="DS/"+e.name+"/"+e.name),require([d],function(t){if(a.material=i.MaterialUtils.createShinyFaceMaterial(),t(a.material,e.param),a.material&&(a.material.needsUpdate=!0),a.geometry&&a.geometry.meshList)for(var r=0;r<a.geometry.meshList.length;r++)a.geometry.meshList[r]._flagAsGSSOInvalidated()}),r._modelEvent.publish({event:"PDSFXMaterial",data:h}),h.material?h.material:null}(e.shaderMaterial,l,this,e.transparent,u))||null:Y=function(e,r,n,o){if(null!=e){var l=e.param,h=0;null!=l.transparency_multiply_blend&&(h=l.transparency_multiply_blend);var c,d=t.getWebappsAssetUrl("Visualization","");switch(null==p&&(p=a(u=[d+"studio_pure_white_Specular_Map/posx.jpg",d+"studio_pure_white_Specular_Map/negx.jpg",d+"studio_pure_white_Specular_Map/posy.jpg",d+"studio_pure_white_Specular_Map/negy.jpg",d+"studio_pure_white_Specular_Map/posz.jpg",d+"studio_pure_white_Specular_Map/negz.jpg"])),e.name){case"MPM_basic":case"MPM_material":case"MPM_colored_glass":case"MPM_diffuse":case"MPM_soft_plastic":case"MPM_polished_plastic":case"MPM_clear_glass":case"MPM_frosted_glass":case"MPM_diamond":case"MPM_satinated_metal":case"MPM_anisotropic_metal":case"MPM_polished_metal":case"MPM_emissive":var u=[(d=t.getWebappsAssetUrl("Visualization",""))+"studio_pure_white_Diffuse_Map/posx.jpg",d+"studio_pure_white_Diffuse_Map/negx.jpg",d+"studio_pure_white_Diffuse_Map/posy.jpg",d+"studio_pure_white_Diffuse_Map/negy.jpg",d+"studio_pure_white_Diffuse_Map/posz.jpg",d+"studio_pure_white_Diffuse_Map/negz.jpg"],f=l.mapping_world_to_object_position_1st_column,g=l.mapping_world_to_object_position_2nd_column,m=l.mapping_world_to_object_position_3rd_column,v=l.mapping_world_to_object_position_4th_column,y=new i.Matrix4(f[0],f[1],f[2],f[3],g[0],g[1],g[2],g[3],m[0],m[1],m[2],m[3],v[0],v[1],v[2],v[3]);(new i.Matrix4).getInverse(y),a(u);var S={};!function(e,i,r,n){var a=t.getWebappsAssetUrl("Visualization",""),o=s(a+"default_white_color.png"),l=s(a+"slot_normal_default.jpg"),h=s(a+"slot_specular_anisotropy_direction_default.jpg");e.AmbientOcclusion2D&&"slot_ambient_occlusion_default.tif"==e.AmbientOcclusion2D.url?r.AmbientOcclusion2D=o:r.AmbientOcclusion2D=n.getTexture({type:"data",resources:i[e.AmbientOcclusion2D.imgId],resourceId:e.AmbientOcclusion2D.imgId}),e.Clarity2D&&"slot_clarity_default.tif"==e.Clarity2D.url?r.Clarity2D=o:r.Clarity2D=n.getTexture({type:"data",resources:i[e.Clarity2D.imgId],resourceId:e.Clarity2D.imgId}),e.Diffuse2D&&"slot_diffuse_default.tif"==e.Diffuse2D.url?r.Diffuse2D=o:r.Diffuse2D=n.getTexture({type:"data",resources:i[e.Diffuse2D.imgId],resourceId:e.Diffuse2D.imgId,checkTransparency:!0}),e.Emissive2D&&"slot_emissive_default.tif"==e.Emissive2D.url?r.Emissive2D=o:r.Emissive2D=n.getTexture({type:"data",resources:i[e.Emissive2D.imgId],resourceId:e.Emissive2D.imgId}),e.Height2D&&"slot_displacement_default.tif"==e.Height2D.url?r.Height2D=o:r.Height2D=n.getTexture({type:"data",resources:i[e.Height2D.imgId],resourceId:e.Height2D.imgId}),e.Normal2D&&"slot_normal_default.tif"==e.Normal2D.url?r.Normal2D=l:r.Normal2D=n.getTexture({type:"data",resources:i[e.Height2D.imgId],resourceId:e.Height2D.imgId}),e.Specular2D&&"slot_specular_default.tif"==e.Specular2D.url?r.Specular2D=o:r.Specular2D=n.getTexture({type:"data",resources:i[e.Specular2D.imgId],resourceId:e.Specular2D.imgId}),e.SpecularAnisotropyDirection2D&&"slot_specular_anisotropy_direction_default.tif"==e.SpecularAnisotropyDirection2D.url?r.SpecularAnisotropyDirection2D=h:r.SpecularAnisotropyDirection2D=n.getTexture({type:"data",resources:i[e.SpecularAnisotropyDirection2D.imgId],resourceId:e.SpecularAnisotropyDirection2D.imgId}),e.SpecularGlossiness2D&&"slot_specular_glossiness_default.tif"==e.SpecularGlossiness2D.url?r.SpecularGlossiness2D=o:r.SpecularGlossiness2D=n.getTexture({type:"data",resources:i[e.SpecularGlossiness2D.imgId],resourceId:e.SpecularGlossiness2D.imgId}),e.Transparency2D&&"slot_transparency_default.tif"==e.Transparency2D.url?r.Transparency2D=o:r.Transparency2D=n.getTexture({type:"data",resources:i[e.Transparency2D.imgId],resourceId:e.Transparency2D.imgId})}(l,r,S,n),(E=new Array(3))[0]=l.default_generic_brdf_diffuse_color[0]*l.default_generic_brdf_diffuse_weight,E[1]=l.default_generic_brdf_diffuse_color[1]*l.default_generic_brdf_diffuse_weight,E[2]=l.default_generic_brdf_diffuse_color[2]*l.default_generic_brdf_diffuse_weight,E[0]+=l.default_generic_btdf_transparency_weight*l.default_vp_color[0],E[1]+=l.default_generic_btdf_transparency_weight*l.default_vp_color[1],E[2]+=l.default_generic_btdf_transparency_weight*l.default_vp_color[2],c=new i.DSPBR22xMaterial({needTangentBinormal:!0,diffuseMulCoef:(new i.Vector3).setFromArray(E),diffuseAddCoef:new i.Vector3(0,0,0),specularMulCoef:(new i.Vector3).setFromArray(l.default_generic_brdf_specular_color),specularAddCoef:new i.Vector3(0,0,0),emissionColorMulCoef:(new i.Vector3).setFromArray(l.default_generic_edf_diffuse_color),emissionColorAddCoef:new i.Vector3(0,0,0),opacity:l.default_sp_opacity,ior:l.default_generic_brdf_ior,roughness:1-l.default_generic_brdf_specular_glossiness,specularContrib:l.default_generic_brdf_specular_weight,anisotropy:l.default_generic_brdf_specular_anisotropy/Math.PI,anisotropyAngle:l.default_generic_brdf_specular_anisotropy_rotation/Math.PI,emissionValue:l.default_generic_edf_diffuse_weight,transparency:l.default_generic_btdf_transparency_weight,metalness:0,normalUvSlot:l.default_slot_normal,opacityUvSlot:l.default_slot_opacity,diffuseUvSlot:l.default_slot_diffuse_color,specularUvSlot:l.default_slot_specular_color,roughnessUvSlot:l.default_slot_specular_glossiness,anisotropyAngleUvSlot:l.default_slot_specular_anisotropy_direction,transparencyUvSlot:l.default_slot_transparency,emissionColorUvSlot:l.default_slot_emissive_color,thinWalled:!!l.thin_walled,map:S.Diffuse2D,emissionColorMap:S.Emissive2D,specularMap:S.Specular2D,roughnessMap:S.SpecularGlossiness2D,roughnessAddCoef:S.SpecularGlossiness2D?1:null,roughnessMulCoef:S.SpecularGlossiness2D?-1:null,anisotropyAngleMap:S.SpecularAnisotropyDirection2D,opacityMap:S.Opacity2D,transparent:S.Opacity2D||S.Transparency2D,mappingType:l.mapping_type,mappingUVTransformation:new i.Matrix3(l.mapping_scale_u,0,l.mapping_offset_u,0,l.mapping_scale_v,l.mapping_offset_v,0,0,1)});break;case"mia_phen_polished_metal":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:0,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(A=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,A[1]=l.diffuse?l.diffuse[1]:1,A[2]=l.diffuse?l.diffuse[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specularContrib:l.reflectivity,specular:new i.Color(A),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,ior:null!=l.refr_ior?l.refr_ior:8,opacity:1-h});break;case"mia_phen_satinated_metal":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:0,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(A=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,A[1]=l.diffuse?l.diffuse[1]:1,A[2]=l.diffuse?l.diffuse[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specularContrib:l.reflectivity,specular:new i.Color(A),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refl_gloss?l.refl_gloss:.25),ior:null!=l.refr_ior?l.refr_ior:8,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_anisotropic_metal":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:0,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(A=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,A[1]=l.diffuse?l.diffuse[1]:1,A[2]=l.diffuse?l.diffuse[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(A),specularContrib:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refl_gloss?l.refl_gloss:.25),ior:null!=l.refr_ior?l.refr_ior:8,opacity:1-h,needTangentBinormal:!0,anisotropy:null!=l.anisotropy?l.anisotropy/Math.PI:.1,anisotropyAngle:null!=l.anisotropy_rotation?l.anisotropy_rotation/Math.PI:0});break;case"mia_phen_soft_plastic":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:.77,l.reflectivity=null!=l.reflectivity?l.reflectivity:.7,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(A=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,A[1]=l.refl_color?l.refl_color[1]:1,A[2]=l.refl_color?l.refl_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(A),specularContrib:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refl_gloss?l.refl_gloss:.25),metalness:0,ior:null!=l.refr_ior?l.refr_ior:2,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_polished_plastic":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:.77,l.reflectivity=null!=l.reflectivity?l.reflectivity:.75,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(A=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,A[1]=l.refl_color?l.refl_color[1]:1,A[2]=l.refl_color?l.refl_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(A),specularContrib:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,metalness:0,ior:null!=l.refr_ior?l.refr_ior:2,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_diffuse":(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specularContrib:0,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_frosted_glass":(E=new Array(3))[0]=l.refr_falloff_color?l.refr_falloff_color[0]:1,E[1]=l.refr_falloff_color?l.refr_falloff_color[1]:1,E[2]=l.refr_falloff_color?l.refr_falloff_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refr_gloss?l.refr_gloss:1),transparency:1,ior:null!=l.refr_ior?l.refr_ior:1.45,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_clear_glass":c=new i.DSPBR22xMaterial({color:new i.Color(8947848),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:0,transparency:1,ior:null!=l.refr_ior?l.refr_ior:1.45,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_colored_glass":l.reflectivity=null!=l.reflectivity?l.reflectivity:.66,(E=new Array(3))[0]=l.refr_falloff_color?l.refr_falloff_color[0]:1,E[1]=l.refr_falloff_color?l.refr_falloff_color[1]:1,E[2]=l.refr_falloff_color?l.refr_falloff_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specularContrib:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refr_gloss?l.refr_gloss:1),transparency:1,ior:null!=l.refr_ior?l.refr_ior:1.45,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"diamond":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(E=new Array(3))[0]=l.refr_color?l.refr_color[0]:1,E[1]=l.refr_color?l.refr_color[1]:1,E[2]=l.refr_color?l.refr_color[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(A=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,A[1]=l.refl_color?l.refl_color[1]:1,A[2]=l.refl_color?l.refl_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(A),specularContrib:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,metalness:0,transparency:.5,ior:null!=l.refr_ior?l.refr_ior:2.4,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_emissive":c=new i.DSPBR22xMaterial({color:new i.Color(0),specularContrib:0,emissionColor:new i.Color(null!=l.color?l.color:[1,1,1,1]),emissionValue:null!=l.intensity?l.intensity:1e3,opacity:1-h,needTangentBinormal:!0});break;case"CATIATemplateUseMapCubic":case"CATIATemplateUseMapSpheric":var _;_=n.getTexture({type:"data",resources:r[l.KdText.imgId],resourceId:l.KdText.imgId,checkTransparency:!0}),l.Kd=null!=l.Kd?l.Kd:1,l.KsShi=null!=l.KsShi?l.KsShi:.75,l.Ks=null!=l.Ks?l.Ks:.75,(E=new Array(3))[0]=l.KdColor?l.KdColor[0]:1,E[1]=l.KdColor?l.KdColor[1]:1,E[2]=l.KdColor?l.KdColor[2]:1,E[0]*=l.Kd,E[1]*=l.Kd,E[2]*=l.Kd,(A=new Array(3))[0]=l.KsColor?l.KsColor[0]:1,A[1]=l.KsColor?l.KsColor[1]:1,A[2]=l.KsColor?l.KsColor[2]:1,c=new i.DSPBR22xMaterial({diffuseMulCoef:(new i.Vector3).setFromArray(E),diffuseAddCoef:new i.Vector3,map:_,specular:new i.Color(A),specularContrib:l.Ks,roughness:l.KsShi,metalness:0,transparency:null!=l.Kt?l.Kt:0,ior:2+(null!=l.Kr?l.Kr:1),opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_material":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:.77,l.reflectivity=null!=l.reflectivity?l.reflectivity:0;var x=null!=l.transparency?l.transparency:0;(E=new Array(3))[0]=(l.diffuse?l.diffuse[0]:1)*l.diffuse_weight*(1-x),E[1]=(l.diffuse?l.diffuse[1]:1)*l.diffuse_weight*(1-x),E[2]=(l.diffuse?l.diffuse[2]:1)*l.diffuse_weight*(1-x),E[0]+=(l.refr_color?l.refr_color[0]:1)*x,E[1]+=(l.refr_color?l.refr_color[1]:1)*x,E[2]+=(l.refr_color?l.refr_color[2]:1)*x,(A=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,A[1]=l.refl_color?l.refl_color[1]:1,A[2]=l.refl_color?l.refl_color[2]:1;var b=1-(null!=l.refl_gloss?l.refl_gloss:0),w=x*(1-(null!=l.refl_gloss?l.refr_gloss:1))+(1-x)*b;c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(A),specularContrib:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:w,metalness:0,transparency:x,ior:null!=l.refr_ior?l.refr_ior:1.5,opacity:1-h,alphaTest:null!=l.cutout_opacity?l.cutout_opacity:1,anisotropy:null!=l.anisotropy?l.anisotropy/Math.PI:1,anisotropyAngle:null!=l.anisotropy_rotation?l.anisotropy_rotation/Math.PI:1,needTangentBinormal:!0});break;case"mia_phen_reflective_translucent":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.reflectivity=null!=l.reflectivity?l.reflectivity:0,x=null!=l.transparency?l.transparency:.8,(E=new Array(3))[0]=(l.diffuse?l.diffuse[0]:1)*l.diffuse_weight,E[1]=(l.diffuse?l.diffuse[1]:1)*l.diffuse_weight,E[2]=(l.diffuse?l.diffuse[2]:1)*l.diffuse_weight;var M=new Array(3);M[0]=l.refr_trans_color?l.refr_trans_color[0]:1,M[1]=l.refr_trans_color?l.refr_trans_color[1]:1,M[2]=l.refr_trans_color?l.refr_trans_color[2]:1,w=1-(null!=l.refl_gloss?l.refr_gloss:1),c=new i.DSPBR23xMaterial({color:new i.Color(E),translucency:null!=l.refr_trans_weight?l.refr_trans_weight:1,translucencyColor:new i.Color(M),specularContrib:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:w,metalness:0,transparency:x,ior:null!=l.refr_ior?l.refr_ior:1.3,opacity:1-h,needTangentBinormal:!0});break;case"mip_metallic_paint":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.spec_weight=null!=l.spec_weight?l.spec_weight:.2,w=(null!=l.spec_exp?l.spec_exp:60)/150;var C=null!=l.spec_sec_weight?l.spec_sec_weight:.25,P=(null!=l.spec_sec_exp?l.spec_sec_exp:25)/150;(E=new Array(3))[0]=(l.base_color?l.base_color[0]:0)*l.diffuse_weight,E[1]=(l.base_color?l.base_color[1]:1)*l.diffuse_weight,E[2]=(l.base_color?l.base_color[2]:0)*l.diffuse_weight,(A=new Array(3))[0]=l.spec?l.spec[0]:1,A[1]=l.spec?l.spec[1]:1,A[2]=l.spec?l.spec[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(A),specularContrib:l.spec_weight,clearCoat:C,clearCoatRoughness:P,roughness:w,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"mip_car_paint":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.spec_weight=null!=l.spec_weight?l.spec_weight:.2,w=(null!=l.spec_exp?l.spec_exp:60)/150;var E,A,T=(null!=l.flake_exp?l.flake_exp:45)/150;(E=new Array(3))[0]=(l.base_color?l.base_color[0]:0)*l.diffuse_weight,E[1]=(l.base_color?l.base_color[1]:1)*l.diffuse_weight,E[2]=(l.base_color?l.base_color[2]:0)*l.diffuse_weight,(A=new Array(3))[0]=l.spec?l.spec[0]:1,A[1]=l.spec?l.spec[1]:1,A[2]=l.spec?l.spec[2]:1;var D=new Array(3);D[0]=l.flake_color?l.spec[0]:1,D[1]=l.flake_color?l.spec[1]:1,D[2]=l.flake_color?l.spec[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(A),flakesColor:new i.Color(A),specularContrib:l.spec_weight,clearCoat:1,clearCoatRoughness:.05,roughness:w,flakesRoughness:T,flakesCoverage:null!=l.flake_density?l.flake_density:.5,flakesSize:null!=l.flake_scale?l.flake_scale:5,metalness:0,opacity:1-h,ior:null!=l.__incident_ior?l.__incident_ior:1,needTangentBinormal:!0});break;default:return i.MaterialUtils.createShinyFaceMaterial()}return c.force=!0,c.lights=!0,c._usePhongLighting=!0,c.uniforms&&c.uniforms.ReflectionCUBEMap&&(c.uniforms.ReflectionCUBEMap.value=p),void 0!==o&&0!==o&&(c.transparent=!0),c}return i.MaterialUtils.createShinyFaceMaterial()}(e.shaderMaterial,l,this,e.transparent);if(null===e)return i.MaterialUtils.createShinyFaceMaterial();void 0!==e.wireframe&&(v.wireframe=e.wireframe),void 0!==e.transparent&&(v.opacity=1-e.transparent,1!==v.opacity&&(v.transparent=!0));var Q,K=i._CATGraphicalAsPBR;if(e.shading&&("Phong"===e.shading?m="MeshPhongMaterial":"Basic"===e.shading&&(K=!1,m="MeshBasicMaterial")),e.blending&&("Additive"===e.blending?v.blending=i.AdditiveBlending:"Subtractive"===e.blending?v.blending=i.SubtractiveBlending:"Multiply"===e.blending&&(v.blending=i.MultiplyBlending)),void 0!==e.depthTest&&(v.depthTest=e.depthTest),void 0!==e.vertexColors&&("face"===e.vertexColors?v.vertexColors=i.VertexColorType.Face:e.vertexColors&&(v.vertexColors=i.VertexColorType.RGBA)),e.colorDiffuse?void 0!==e.diffuseCoef?(Q=[e.colorDiffuse[0]*e.diffuseCoef,e.colorDiffuse[1]*e.diffuseCoef,e.colorDiffuse[2]*e.diffuseCoef],v.color=g(Q)):v.color=g(e.colorDiffuse):e.DbgColor&&(v.color=e.DbgColor),e.colorSpecular&&(void 0!==e.specularCoef?(Q=[e.colorSpecular[0]*e.specularCoef,e.colorSpecular[1]*e.specularCoef,e.colorSpecular[2]*e.specularCoef],v.specular=g(Q)):v.specular=g(e.colorSpecular)),e.colorAmbient&&(void 0!==e.ambientCoef?(Q=[e.colorAmbient[0]*e.ambientCoef,e.colorAmbient[1]*e.ambientCoef,e.colorAmbient[2]*e.ambientCoef],v.ambient=g(Q)):v.ambient=g(e.colorAmbient)),e.transparency&&(v.opacity=e.transparency,1!==v.opacity&&(v.transparent=!0)),e.shininess&&(v.shininess=e.shininess,K&&(v.shininess/="material3DXML"===e.type?128:255)),e.reflectivityCoef&&(v.reflectivity=e.reflectivityCoef),e.alphaTest&&(v.alphaTest=e.alphaTest),e.reflectivityCoef>.1&&void 0===e.ReflectionMap){if(null===c){var J=s(t.getWebappsAssetUrl("Visualization","")+"defaultEnvMap.png",i.ImageUtils.crossOriginPolicy);J.flipY=!0,J.mapping=new i.SphericalReflectionMapping,c=J}v.envMap=c,v.combine=i.MixOperation,v.perPixel=!0}var $=null;if(v.textureBlending=i.TextureBlendOperations.MODULATE,void 0!==e.textureId&&-1!==e.textureId)if(void 0!==e.textureBlending&&(v.textureBlending=e.textureBlending),"SPHERICAL_ENV_MAP"===e.mappingFunction)v.sphereMap=!0;else{v.map=this.getTexture({type:"data",resources:l[e.textureId],filter:[e.minFilter,e.magFilter],wrap:[e.textureWrapS,e.textureWrapT],resourceId:e.textureId,checkTransparency:!0}),v.map.transparent&&(v.transparent=!0,v.alphaTest=1e-4);var ee=l[e.textureId].uvTransform;ee&&($=new i.Matrix3).set(ee[0],ee[1],ee[4],ee[2],ee[3],ee[5],0,0,1)}if(e.DiffuseMap&&r&&(v.map=this.getTexture({type:"url",sourceFile:e.DiffuseMap,texturePath:r,material:e,cb:f,repeat:e.DiffuseMapRepeat,offset:e.DiffuseMapOffset,wrap:e.DiffuseMapWrap,checkTransparency:!0,format:n})),e.mapLight&&r&&(v.lightMap=this.getTexture({type:"url",sourceFile:e.mapLight,material:e,cb:f,texturePath:r,repeat:e.mapLightRepeat,offset:e.mapLightOffset,wrap:e.mapLightWrap})),e.mapNormal&&r&&(v.normalMap=this.getTexture({type:"url",sourceFile:e.mapNormal,material:e,cb:f,texturePath:r,repeat:e.mapNormalRepeat,offset:e.mapNormalOffset,wrap:e.mapNormalWrap})),e.mapSpecular&&r&&(v.specularMap=this.getTexture({type:"url",sourceFile:e.mapSpecular,material:e,cb:f,texturePath:r,repeat:e.mapSpecularRepeat,offset:e.mapSpecularOffset,wrap:e.mapSpecularWrap})),e.ReflectionMap&&r&&(v.envMap=this.getTexture({type:"url_envMap",sourceFile:e.mapSpecular,material:e,cb:f,texturePath:r,repeat:e.mapSpecularRepeat,offset:e.mapSpecularOffset,wrap:e.mapSpecularWrap})),e._pbr=!1,K){var te=i.MaterialUtils.convertShininessToIoRRoughness(v.shininess?v.shininess:0);v.roughness=te.roughness,v.reflectivityEnvMap=v.envMap,v.envMap=null,v.ior=te.ior,m="_CATGraphicalMaterial",e._pbr=!0,v.diffuseUvTransform=$,$=null}if(Y=new i[m](v),this.extractMaterialApplicationMappingInfos(e.mapping,Y,$),void 0!==e.DbgName&&(Y.name=e.DbgName),void 0!==e.textureId&&-1!==e.textureId&&(e.url=l[e.textureId].url),this.materials.push({params:e,threejs_mat:Y,hasTexture:this._currentMatHasTexture}),0===e.__nbTexturesToLoad)for(var ie=0;ie<e.__cbLoadedImages.length;ie++)e.__cbLoadedImages[ie](Y);return Y.map&&Y.map.needToCheckTransparency&&(Y.map.transparentCb=function(e){Y.transparent=e}),Y},_getPointMaterial:function(e){var r=this,n=function(e,t){return r.texturesPoint[e]?r.texturesPoint[e]:(r.texturesPoint[e]=s(t,i.ImageUtils.crossOriginPolicy),r.texturesPoint[e])},a=9,o=(e.symbol&&e.symbol,e.color),l=null,h=!1,c=t.getWebappsAssetUrl("Visualization","");switch(e.symbol){case this.PointSymbolEnum.NOSPRITE:l=null;break;case this.PointSymbolEnum.CROSS:l=n(1,c+"textures/point/cross.png"),h=!0;break;case this.PointSymbolEnum.PLUS:l=n(2,c+"textures/point/plus.png"),h=!0;break;case this.PointSymbolEnum.COINCIDENT:l=n(3,c+"textures/point/concentric.png"),h=!0;break;case this.PointSymbolEnum.CONCENTRIC:l=n(4,c+"textures/point/coincident.png"),h=!0;break;case this.PointSymbolEnum.FULLCIRCLE:l=n(5,c+"textures/point/fullCircle.png"),h=!0,a=5;break;case this.PointSymbolEnum.FULLSQUARE:l=n(6,c+"textures/point/fullSquare.png"),a=7;break;case this.PointSymbolEnum.STAR:l=n(7,c+"textures/point/star.png"),h=!0;break;case this.PointSymbolEnum.DOT:l=n(8,c+"textures/point/dot.png"),a=3;break;case this.PointSymbolEnum.SMALLDOT:l=n(9,c+"textures/point/smallDot.png"),a=2;break;default:l=null}return e.size&&(a=e.size),e.withoutDPR||(a=Math.round(a*(i.getDevicePixelRatio()||1))),e.scale&&(a=e.scale*a),new i.ParticleBasicMaterial({size:a,color:o,map:l,sizeAttenuation:!1,blending:i.NormalBlending,depthTest:!1,transparent:h,alphaTest:.01})},createPointMaterial:function(e){var r=this;if(!e._cgr)return this._getPointMaterial(e);var n,a=function(e,t){return r.texturesPoint[e]?r.texturesPoint[e]:(r.texturesPoint[e]=s(t,i.ImageUtils.crossOriginPolicy),r.texturesPoint[e])},o=null,l=9,h=e.color,c=e.opacity,d=!1,u=t.getWebappsAssetUrl("Visualization","");if(void 0!==e.symbol){switch(c=void 0,e.symbol){case 0:n=null,e.size&&(l=e.size);break;case 1:n=a(1,u+"textures/point/cross.png"),d=!0;break;case 2:n=a(2,u+"textures/point/plus.png"),d=!0;break;case 3:n=a(3,u+"textures/point/concentric.png"),d=!0;break;case 4:n=a(4,u+"textures/point/coincident.png"),d=!0;break;case 5:n=a(5,u+"textures/point/fullCircle.png"),d=!0,l=5;break;case 6:n=a(6,u+"textures/point/fullSquare.png"),l=7;break;case 7:n=a(7,u+"textures/point/star.png"),d=!0;break;case 8:n=a(8,u+"textures/point/dot.png"),l=3;break;case 9:n=a(9,u+"textures/point/smallDot.png"),l=2;break;default:n=a(1,u+"textures/point/cross.png"),d=!0}l=Math.round(l*(i.getDevicePixelRatio()||1))}else l=e.size;return o=new i.ParticleBasicMaterial({size:l,color:h,map:n,blending:i.NormalBlending,depthTest:!1,sizeAttenuation:!1,transparent:d,alphaTest:.01}),c&&(o.opacity=c),o},createTexture:function(e){function t(t,r){var n,a,s=new Image;i.ImageUtils.nbTexturesBeingLoaded++,e.material.__nbTexturesToLoad++,t.loadEndStatus=i.AssetLoadingStatus.LOADING,s.onload=function(){t.loadEndStatus=i.AssetLoadingStatus.READY,i.ImageUtils.is_pow2(s.width)&&i.ImageUtils.is_pow2(s.height)?t.image=s:(n=i.ImageUtils.nearest_pow2(s.width),a=i.ImageUtils.nearest_pow2(s.height),t.image.width=n,t.image.height=a,t.image.getContext("2d").drawImage(s,0,0,n,a)),t.needsUpdate=!0,i.ImageUtils.nbTexturesBeingLoaded--,e.material.__nbTexturesToLoad--;for(var r=0;r<t.onLoadCallbacks.length;r++)t.onLoadCallbacks[r](t);if(0===e.material.__nbTexturesToLoad)for(r=0;r<e.material.__cbLoadedImages.length;r++)e.material.__cbLoadedImages[r](e.cb())},s.onerror=function(){if(i.ImageUtils.nbTexturesBeingLoaded--,e.material.__nbTexturesToLoad--,t.loadEndStatus=i.AssetLoadingStatus.ERROR,0===e.material.__nbTexturesToLoad)for(var r=0;r<e.material.__cbLoadedImages.length;r++)e.material.__cbLoadedImages[r](e.cb())},s.crossOrigin="anonymous",s.src=r}function r(e,t,i,r,n,a){var s,o,l,h,c,d,u,p,f,g,m,v,y=t/r,S=new Float32Array(i*r*a);if(1!==y)for(d=y/2,u=0;u<r;u++,d+=y)for(o=(s=Math.floor(d))>=i-1?0:a,l=d-s,h=u*a,c=s*a,p=0;p<i;p++,h+=r*a,c+=t*a)for(f=0;f<a;f++)S[h+f]=e[c+f]*(1-l)+e[c+o+f]*l;else for(g=0;g<i*r*a;g++)S[g]=e[g];if(m=i/n,v=new Uint8Array(n*r*a),1!==m)for(d=m/2,p=0;p<n;p++,d+=m)for(o=(s=Math.floor(d))>=i-1?0:a*r,l=d-s,h=p*r*a,c=s*r*a,u=0;u<r;u++,h+=a,c+=a)for(f=0;f<a;f++)v[h+f]=S[c+f]*(1-l)+S[c+o+f]*l;else for(g=0;g<n*r*a;g++)v[g]=S[g];return v}function n(e){var t;for(t=3;t<e.length;t+=4)if(255!=e[t])return!0;return!1}var a,s,o,l,c;switch(a=1===e.wrap[0]||"repeat"==e.wrap[0]?i.RepeatWrapping:i.ClampToEdgeWrapping,s=1===e.wrap[1]||"repeat"==e.wrap[0]?i.RepeatWrapping:i.ClampToEdgeWrapping,e.filter[0]){case 0:l=i.NearestFilter;break;case 1:l=i.LinearFilter;break;case 2:l=i.NearestMipMapNearestFilter;break;case 3:l=i.NearestMipMapLinearFilter;break;case 4:l=i.LinearMipMapNearestFilter;break;case 5:l=i.LinearMipMapLinearFilter}switch(e.filter[1]){case 0:o=i.NearestFilter;break;case 1:o=i.LinearFilter;break;case 2:o=i.NearestMipMapNearestFilter;break;case 3:o=i.NearestMipMapLinearFilter;break;case 4:o=i.LinearMipMapNearestFilter;break;case 5:o=i.LinearMipMapLinearFilter}switch(e.type){case"url":if("dds"===(d=/(?:\.([^.]+))?$/.exec(e.sourceFile.filename)[1])?c=i.ImageUtils.loadCompressedTextureFromBuffer(e.sourceFile.buffer):(u=document.createElement("canvas"),c=new i.Texture(u),"XMLV6"===e.format?c.sourceFile=e.sourceFile:c.sourceFile=window.URL.createObjectURL(e.sourceFile.buffer)),c.wrapS=a,c.wrapT=s,c.magFilter=o,c.minFilter=l,e.offset&&c.offset.set(e.offset[0],e.offset[1]),"dds"===d){c&&c.mipmaps&&(1==(p=c.mipmaps)[p.length-1].height&&1==p[p.length-1].width||(l=o=i.LinearFilter)),c.flipY=!0;break}"XMLV6"===e.format?t(c,e.texturePath+"/"+e.sourceFile):t(c,c.sourceFile),c&&(c.flipY=!0);break;case"url_envMap":var d,u,p;if("dds"===(d=/(?:\.([^.]+))?$/.exec(sourceFile.filename)[1])?c=i.ImageUtils.loadCompressedTextureFromBuffer(sourceFile.buffer):(u=document.createElement("canvas"),c=new i.Texture(u),"XMLV6"===e.format?c.sourceFile=sourceFile:c.sourceFile=window.URL.createObjectURL(sourceFile.buffer)),c.wrapS=a,c.wrapT=s,c.magFilter=o,c.minFilter=l,e.offset&&c.offset.set(e.offset[0],e.offset[1]),"dds"===d){c&&c.mipmaps&&(1==(p=c.mipmaps)[p.length-1].height&&1==p[p.length-1].width||(c.minFilter=c.magFilter=i.LinearFilter)),c.flipY=!0;break}!function(e,t){var r;for(e.image=[],i.ImageUtils.nbTexturesBeingLoaded++,e.image.loadCount=0,r=0;r<6;++r)e.image[r]=new Image,e.image[r].onload=function(){if(e.image.loadCount+=1,6===e.image.loadCount){e.needsUpdate=!0,i.ImageUtils.nbTexturesBeingLoaded--;for(var t=0;t<e.onLoadCallbacks.length;t++)e.onLoadCallbacks[t](e)}},e.image[r].onerror=function(){e.image.loadCount+=1,6===e.image.loadCount&&i.ImageUtils.nbTexturesBeingLoaded--},e.image[r].crossOrigin="anonymous",e.image[r].src=t}(c,e.texturePath+"/"+sourceFile),c&&(c.flipY=!0);break;case"data":var f=!1,g=!1,m=e.resources.img,v=e.resources.format,y=!1;switch((e.filter[0]>1||e.filter[1]>1)&&(y=!0),a!=i.RepeatWrapping&&s!=i.RepeatWrapping||(y=!0),e.resources.imgType){case 1:var S=e.resources.width,_=e.resources.height;switch(v){case 0:v=i.LuminanceFormat;break;case 1:v=i.LuminanceAlphaFormat;break;case 2:v=i.RGBFormat;break;case 3:v=i.RGBAFormat,e.checkTransparency&&(f=n(m))}if((!i.ImageUtils.is_pow2(S)||!i.ImageUtils.is_pow2(_))&&y){var x=i.ImageUtils.nearest_pow2(S),b=i.ImageUtils.nearest_pow2(_);v===i.RGBAFormat?m=r(m,S,_,x,b,4):v===i.RGBFormat&&(m=r(m,S,_,x,b,3)),S=x,_=b}if(c=new i.DataTexture(m,S,_,v,void 0,void 0,a,s,o,l)){if(c.size=S,c.flipY=!1,f&&(c.transparent=!0),v==i.RGBFormat){var w=3*S;w%4&&(c.unpackAlignment=2,w%2&&(c.unpackAlignment=1))}v==i.LuminanceFormat&&(c.unpackAlignment=1)}c.needsUpdate=!0;break;case 2:var M=e.resources,C=0;switch(M.format){case 3:C=i.RGBAFormat;break;case 6:C=i.RGB_S3TC_DXT1_Format,g=!0;break;case 7:C=i.RGBA_S3TC_DXT1_Format,g=!0;break;case 8:C=i.RGBA_S3TC_DXT3_Format,g=!0;break;case 9:C=i.RGBA_S3TC_DXT5_Format,g=!0}g&&function(e,t,r,n,a){var s,o,l,h,c,d,u,p,f,g,m,v,y,S,_,x,b,w,M,C,P;function E(e){x=e[4],e[4]=e[7],e[7]=x,x=e[5],e[5]=e[6],e[6]=x}function A(e,t){var i;for(i=0;i<e.length;i++)e[i]=t[i]}switch(n){case i.RGB_S3TC_DXT1_Format:l=8,s=E,o=function(e){x=e[4],e[4]=e[5],e[5]=x};break;case i.RGBA_S3TC_DXT3_Format:l=16,s=function(e){x=e[0],e[0]=e[6],e[6]=x,x=e[1],e[1]=e[7],e[7]=x,x=e[2],e[2]=e[4],e[4]=x,x=e[3],e[3]=e[5],e[5]=x,E(e.subarray(8,16))},o=function(e){x=e[0],e[0]=e[2],e[2]=x,x=e[1],e[1]=e[3],e[3]=x,E(e.subarray(8,16))};break;case i.RGBA_S3TC_DXT5_Format:l=16,s=function(e){w=e[2]+256*(e[3]+256*e[4]),C=e[5]+256*(e[6]+256*e[7]),M=(4095&w)<<12|(16773120&w)>>12,P=(4095&C)<<12|(16773120&C)>>12,e[2]=255&P,e[3]=(65280&P)>>8,e[4]=(16711680&P)>>8,e[5]=255&M,e[6]=(65280&M)>>8,e[7]=(16711680&M)>>8,E(e.subarray(8,16))},o=function(e){w=e[2]+256*(e[3]+256*e[4]),M=(4095&w)<<12,e[2]=255&M,e[3]=(65280&M)>>8,e[4]=(16711680&M)>>8,E(e.subarray(8,16))};break;default:return console.error("flip dds error"),a}for(h=e,c=t,f=0;f<r&&(v=a[f].data,p=(d=Math.floor((h+3)/4))*(u=Math.floor((c+3)/4)),1!=c);++f){if(2==c)for(g=0;g<d;g++)o(v.subarray(m,g*l)),m=+l;else{for(m=0,g=1;g<=p;g++)s(v.subarray(m,g*l)),m+=l;b=l*d,_=new Uint8Array(b);for(var T=0;T<u/2;++T)y=v.subarray(T*b,(T+1)*b),S=v.subarray((u-T-1)*b,(u-T)*b),A(_,y),A(y,S),A(S,_)}(h/=2)<1&&(e=1),(c/=2)<1&&(t=1)}}(M.width,M.height,M.mipmapCount,C,M.mipmaps),(c=new i.CompressedTexture(M.mipmaps,M.width,M.height,C,void 0,new i.UVMapping,a,s,o,l)).flipY=!1,c.generateMipmaps=!1,c.needsUpdate=!0;break;case 3:var P=new Blob([m],{type:"image/png"}),E=URL.createObjectURL(P);return(c=i.ImageUtils.loadTexture(E,void 0,function(e){var t=e.image;if((c=e).wrapS=a,c.wrapT=s,c.magFilter=o,c.minFilter=l,c.needsUpdate=!0,c.transparentCb){var i=document.createElement("canvas");i.width=t.width,i.height=t.height,i.getContext("2d").drawImage(t,0,0,t.width,t.height);var r=i.getContext("2d").getImageData(0,0,t.width,t.height);c.transparent=n(r.data),c.transparent&&c.transparentCb(c.transparent)}},null,i.ImageUtils.crossOriginPolicy,y)).needToCheckTransparency=!!e.checkTransparency,c;case 4:var A=new Uint32Array(m.buffer);return(c=i.ImageUtils.loadCompressedTextureFromBuffer(A)).wrapS=a,c.wrapT=s,c.magFilter=o,c.minFilter=l,c;case 5:(c=i.ImageUtils.loadBasisTexture(e.resources.img,null,null,null,null,i.BasisUsage[h[e.resources.format]])).wrapS=a,c.wrapT=s,c.magFilter=o,c.minFilter=l;break;case 6:(c=i.ImageUtils.loadKTX2Texture(e.resources.img,null,null,null,null,i.BasisUsage[h[e.resources.format]])).wrapS=a,c.wrapT=s,c.magFilter=o,c.minFilter=l;break;default:c=null}break;default:c=null}return c},set3DXSharedGas:function(e,t){this.threeDXSharedGas.set(e,t)},get3DXSharedGas:function(e){return this.threeDXSharedGas.has(e)?this.threeDXSharedGas.get(e):null},getDashPatternArrayMaterial:function(e){var t,n,a;for(null==e.color&&(e.color=new i.Color),void 0===e.opacity&&(e.opacity=1),a=0;a<this.materials.length;a++)if("color"===(n=(t=this.materials[a]).params).type&&!(void 0!==e.pattern&&n.pattern!==e.pattern||n.color.r!==e.color.r||n.color.g!==e.color.g||n.color.b!==e.color.b||n.opacity!==e.opacity||void 0!==e.lineWidth&&n.lineWidth!==e.lineWidth))return t.threejs_mat;return void 0!==e.lineWidth?(n={type:"color",color:e.color,opacity:e.opacity,lineWidth:e.lineWidth,pattern:e.pattern},t=new i.LineBasicMaterial({color:e.color.getHex(),lineWidth:e.lineWidth,opacity:e.opacity,transparent:e.opacity<1}),e.pattern instanceof Array?(t.setDashPatternArray(e.pattern),t.setScale(1)):(t.setDashPatternType(e.pattern),t.setScale(e.pattern===r.LinePatternEnum.SMALLDOTTED?2:4)),this.materials.push({params:n,threejs_mat:t,hasTexture:!1}),t._source=i.AssetSource.MATERIAL_MANAGER,t):(console.warn("getMaterialFromGAS"),new i.LineBasicMaterial)},getMaterialFromGAS:function(e){if(this._currentMatHasTexture=!1,void 0!==e.pattern&&e.pattern instanceof Array)return this.getDashPatternArrayMaterial(e);var t,i,n=251924482,a=255,s=[255,255,255],o=function(e){n&=-4,n|=3&e},l=function(e){n&=-49,n|=(3&e)<<4};void 0!==e.solid&&e.solid?l(3):l(2),void 0!==e.color&&null!==e.color&&(s[0]=255*e.color.r,s[1]=255*e.color.g,s[2]=255*e.color.b),void 0!==e.symbol&&(o(0),l(0),i=e.symbol,n&=268435455,n|=(15&i)<<28,void 0!==e.size&&(t=e.size,n&=-258049,n|=(63&t)<<12)),void 0!==e.lineWidth&&(o(1),l(1),function(e){n&=-258049,n|=(63&e)<<12}(e.lineWidth),void 0!==e.pattern&&function(e){n&=-3932161,n|=(15&e)<<18}(e.pattern)),e.basic&&(n&=-5,n|=4),void 0!==e.opacity&&(a=255*e.opacity);var h=s[0]<<24^s[1]<<16^s[2]<<8^a<<0,c={};return void 0!==e.depthPriority&&-1!==e.depthPriority&&(c.depthPriority=e.depthPriority),this._getMaterialFromGAS(new r.GraphicAttributeSet(n,h),c)},setCGRSharedMaterial:function(e,t){this.CGRSharedMaterials.set(e,t)},getCGRSharedMaterial:function(e){return this.CGRSharedMaterials.has(e)?this.CGRSharedMaterials.get(e):null},getMaterialFromGAS2:function(e){var t,n;this._currentMatHasTexture=!1,null==e.color&&(e.color=new i.Color),void 0===e.opacity&&(e.opacity=1);var a=!!i._GASFaceMaterialsAsPBR;for(n=0;n<this.materials.length;n++)if("color"===(t=(s=this.materials[n]).params).type&&(void 0===e.symbol||"point"===t.style)&&(void 0===e.lineWidth||"line"===t.style)&&(void 0!==e.lineWidth||void 0!==e.symbol||"fill"===t.style)&&(void 0===e.pattern||t.pattern===e.pattern)&&t.color.r===e.color.r&&t.color.g===e.color.g&&t.color.b===e.color.b&&t.opacity===e.opacity&&(void 0===e.lineWidth||t.lineWidth===e.lineWidth)&&(void 0===e.symbol||t.symbol===e.symbol)&&(void 0===e.size||t.size===e.size)&&(void 0===e.solid||t.solid===e.solid)&&(!e.basic||t.basic===e.basic)&&(!1!==t._pbr||!a)&&(!0!==t._pbr||a))return s.threejs_mat;if(void 0!==e.symbol){t={type:"color",style:"point",color:e.color,opacity:e.opacity,symbol:e.symbol,size:e.size};var s=this.createPointMaterial({symbol:e.symbol,color:e.color,opacity:e.opacity,resource:e.resource,size:e.size,_cgr:!0})}else if(void 0!==e.lineWidth)t={type:"color",style:"line",color:e.color,opacity:e.opacity,lineWidth:e.lineWidth,pattern:e.pattern},s=new i.LineBasicMaterial({color:e.color.getHex(),lineWidth:e.lineWidth,opacity:e.opacity,transparent:e.opacity<1}),e.pattern instanceof Array?(s.setDashPatternArray(e.pattern),s.setScale(1)):(s.setDashPatternType(e.pattern),s.setScale(e.pattern===r.LinePatternEnum.SMALLDOTTED?2:4));else if(e.basic){t={type:"color",style:"fill",color:e.color,opacity:e.opacity,basic:e.basic,solid:e.solid};var o={color:e.color.getHex(),side:1===e.solid?i.FrontSide:i.DoubleSide,opacity:e.opacity,transparent:e.opacity<1};s=new i.MeshBasicMaterial(o)}else{t={type:"color",style:"fill",color:e.color,opacity:e.opacity,solid:e.solid,_pbr:!1};o={color:e.color.getHex(),opacity:e.opacity,transparent:e.opacity<1,side:1===e.solid?i.FrontSide:i.DoubleSide,specular:16777215,shininess:76};if(s=new i.MeshPhongMaterial(o),a){var l=s;t._pbr=!0;var h=i.MaterialUtils.convertShininessToIoRRoughness(null);o={color:e.color.getHex(),opacity:e.opacity,transparent:e.opacity<1,side:1===e.solid?i.FrontSide:i.DoubleSide,ior:h.ior,specular:16777215,roughness:h.roughness},s=new i._GASPBRMaterial(o,l)}}return this.materials.push({params:t,threejs_mat:s,hasTexture:this._currentMatHasTexture}),s._source=i.AssetSource.MATERIAL_MANAGER,s},_getLineWidth:function(e){var t=e.set>>12&63;return t=t>l.length?1:l[t]},_gasAllowNMIR:function(e){return!((e.set>>18&15)>1||this._getLineWidth(e.set)>1)},_getNbGasMaterial:function(){var e=0;return this.gasMaterialsMap.forEach(function(t,i){t.forEach(function(t,i){e++})}),this.gasSGOrederMaterialsMap.forEach(function(t,i){t.forEach(function(t,i){e++})}),e},_getMaterialFromGAS:function(e,t){var n=this,a=function(e){var t=e.getDisplayedColor();return t[0]=t[0]/255,t[1]=t[1]/255,t[2]=t[2]/255,t[3]=t[3]/255,t},s=t&&void 0!==t.depthPriority,o=t&&t.sceneGraphOrderMode||s?this.gasSGOrederMaterialsMap:this.gasMaterialsMap,l=null,h=null,c=null,d=!!i._GASFaceMaterialsAsPBR,u=3&e.set,p=function(e){return e.set>>2&1}(e),f=e.getType();if(u>1&&!p&&d&&(e.set&=-65,e.set|=64),o.has(e.set)){if((l=o.get(e.set)).has(e.rgba)){if(!s)return l.get(e.rgba);if((h=l.get(e.rgba)).has(t.depthPriority))return h.get(t.depthPriority)}}else l=new Map,o.set(e.set,l);switch(u){case 0:c=function(e,t){var r=a(e),s=(new i.Color).setRGB(r[0],r[1],r[2]),o=e.set>>28&15,l=e.set>>12&63,h=1==(e.set>>23&1),c=(3==e.getType()?i.FrontSide:i.DoubleSide,n.createPointMaterial({symbol:o,color:s,opacity:r[3],size:l,_cgr:!0,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0}));return h&&(c.vertexColors=i.VertexColorType.RGB),c}(e,t);break;case 1:c=function(e,t){var s=a(e),o=(new i.Color).setRGB(s[0],s[1],s[2]);if(n.hasLineTypes()){const r=64*(e.set>>12&63)+(e.set>>18&63);let a=n._createLineTypeMaterial(r,{color:o.getHex(),opacity:s[3],transparent:s[3]<1});return a||new i.LineBasicMaterial({color:o.getHex(),lineWidth:1,opacity:s[3],transparent:s[3]<1,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0})}{const n=e.set>>18&15,a=e.getLineThickness();let l=new i.LineBasicMaterial({color:o.getHex(),lineWidth:a,opacity:s[3],transparent:s[3]<1,linecap:"butt",_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0});return l.setDashPatternType(n),l.setScale(n===r.LinePatternEnum.SMALLDOTTED?2:4),l}}(e,t);break;case 2:case 3:c=function(e){return e.set>>22&1}(e)?this.getBlankingRepMaterial():p||f<2?function(e,t){var r=a(e),n=(new i.Color).setRGB(r[0],r[1],r[2]),s=3==e.getType()?i.FrontSide:i.DoubleSide,o={color:n.getHex(),side:s,opacity:r[3],transparent:r[3]<1,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0};return c=new i.MeshBasicMaterial(o)}(e,t):function(e,t){var r=a(e),n=(new i.Color).setRGB(r[0],r[1],r[2]),s=3==e.getType()?i.FrontSide:i.DoubleSide,o=function(e){return e.set>>6&1}(e),l={color:n.getHex(),opacity:r[3],transparent:r[3]<1,side:s,specular:16777215,shininess:76,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0},h=new i.MeshPhongMaterial(l);if(o){var c=h,d=i.MaterialUtils.convertShininessToIoRRoughness(null);l={color:n.getHex(),opacity:r[3],transparent:r[3]<1,side:s,specular:16777215,ior:d.ior,roughness:d.roughness,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0},h=new i._GASPBRMaterial(l,c)}return h}(e,t)}return s?h?h.set(t.depthPriority,c):((h=new Map).set(t.depthPriority,c),l.set(e.rgba,h)):l.set(e.rgba,c),c._source=i.AssetSource.MATERIAL_MANAGER,e.isBackgroundColor()&&(c.color=this.backgroundColor,this.backgroundColorMaterials.push(c)),t&&void 0!==t.depthPriority&&function(e,t){e.activatePDSFX();var i={depthPriority:{type:"f",value:t}};e.setPDSFXUniforms(i);var r={ComputeCommonValues:["void ComputeCommonValues() {","vSetFragDepth((16777216.0 -depthPriority)/16777216.0);","}"].join("\n")};e.setPDSFXOverridableFunctions({},r)}(c,t.depthPriority),t&&2==t.sceneGraphOrderMode&&function(e){e.activatePDSFX();e.setPDSFXVaryings({depthSGOrder:{type:"f"}});var t={ComputeVaryingValues:["void ComputeVaryingValues() {","depthSGOrder = vGetAttribPosition().z;","}"].join("\n"),ComputeObjectPosition:["vec3 ComputeObjectPosition() {","return vec3(vGetAttribPosition().xy,0.0);","}"].join("\n"),ComputeObjectFollowingPosition:["vec3 ComputeObjectFollowingPosition() {","return vec3(vGetAttribFollowingPosition().xy,0.0);","}"].join("\n"),ComputeObjectPreviousPosition:["vec3 ComputeObjectPreviousPosition() {","return vec3(vGetAttribPreviousPosition().xy,0.0);","}"].join("\n")},i={ComputeCommonValues:["void ComputeCommonValues() {","vSetFragDepth((16777216.0 -depthSGOrder)/16777216.0);","}"].join("\n")};e.setPDSFXOverridableFunctions(t,i)}(c),c},recompileShaders:function(){for(var e=0;e<this.materials.length;e++){var t=this.materials[e];t&&t.threejs_mat&&t.threejs_mat.recompileShaders(!1)}}});return UWA.namespace("THREEDS/MaterialManager",f)}),define("Visualization/MaterialManager",["DS/Visualization/MaterialManager","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/MaterialManager"),e}),define("DS/Visualization/GraphicAttributeSet",["DS/Visualization/ThreeJS_DS","DS/Visualization/MaterialManager","DS/Mesh/Mesh","DS/CoreEvents/Events"],function(e,t,i,r){"use strict";e.GASEnum={NO_INHERIT:0,RESET_INHERITANCE:0,HIGHLIGHT_INHERITANCE_ON:1,HIGHLIGHT_INHERITANCE_OFF:2,COLOR_INHERITANCE_ON:4,COLOR_INHERITANCE_OFF:8,LINEWIDTH_INHERITANCE_ON:16,LINEWIDTH_INHERITANCE_OFF:32,LINETYPE_INHERITANCE_ON:64,LINETYPE_INHERITANCE_OFF:128,BACKGROUND3DVIEWMODE_ON:256,BACKGROUND3DVIEWMODE_OFF:512,ASMCOLOR_INHERITANCE_ON:1024,ASMCOLOR_INHERITANCE_OFF:2048,ALPHA_INHERITANCE_ON:4096,ALPHA_INHERITANCE_OFF:8192,DEFAULTLOOK_INHERITANCE_ON:16384,DEFAULTLOOK_INHERITANCE_OFF:32768,TOP_PRIORITY_ON:65536,TOP_PRIORITY_OFF:131072,_2DMODE_INHERITANCE_ON:262144,_2DMODE_INHERITANCE_OFF:524288,SYMBOLTYPE_INHERITANCE_ON:1048576,SYMBOLTYPE_INHERITANCE_OFF:2097152,DIMENSION_INHERITANCE_ON:4194304,DIMENSION_INHERITANCE_OFF:8388608},e.GASEnum.COLOR_INHERIT=e.GASEnum.COLOR_INHERITANCE_ON,e.GASEnum.ALPHA_INHERIT=e.GASEnum.ALPHA_INHERITANCE_ON,e.GASEnum.LINEWIDTH_INHERIT=e.GASEnum.LINEWIDTH_INHERITANCE_ON,e.GASEnum.LINETYPE_INHERIT=e.GASEnum.LINETYPE_INHERITANCE_ON,e.GASEnum.ASMCOLOR_INHERIT=e.GASEnum.ASMCOLOR_INHERITANCE_ON,e.GASEnum.SYMBOLTYPE_INHERIT=e.GASEnum.SYMBOLTYPE_INHERITANCE_ON,e.GASEnum.RGBA_INHERITANCE_ON=e.GASEnum.COLOR_INHERITANCE_ON|e.GASEnum.ALPHA_INHERITANCE_ON,e.GASEnum.RGBA_INHERIT=e.GASEnum.RGBA_INHERITANCE_ON,e.GASEnum.RGBA_INHERITANCE_OFF=e.GASEnum.COLOR_INHERITANCE_OFF|e.GASEnum.ALPHA_INHERITANCE_OFF,e.GASTypeEnum={NOZ:0,EDGE:1,SKIN:2,VOLUME:3};var n=[0,0,0,.25999999046325684,.4000000059604645,.33000001311302185,1,.46000000834465027,0,1,1,1,1,0,0,0,1,0,0,.4000000059604645,1,.8600000143051147,.8600000143051147,0,.05999999865889549,.05999999865889549,.05999999865889549,.12999999523162842,.12999999523162842,.12999999523162842,.20000000298023224,.20000000298023224,.20000000298023224,.25999999046325684,.25999999046325684,.25999999046325684,.33000001311302185,.25999999046325684,.25999999046325684,.4000000059604645,.4000000059604645,.4000000059604645,.46000000834465027,.46000000834465027,.46000000834465027,.5299999713897705,.5299999713897705,.5299999713897705,.6000000238418579,.6000000238418579,.6000000238418579,.6600000262260437,.6600000262260437,.6600000262260437,.7300000190734863,.7300000190734863,.7300000190734863,.800000011920929,.800000011920929,.800000011920929,.8600000143051147,.8600000143051147,.8600000143051147,.9300000071525574,.9300000071525574,.9300000071525574,1,1,1,.05999999865889549,0,0,.12999999523162842,0,0,.20000000298023224,0,0,.25999999046325684,0,0,.25999999046325684,0,0,.4000000059604645,0,0,.46000000834465027,0,0,.5299999713897705,0,0,.6000000238418579,0,0,.6600000262260437,0,0,.7300000190734863,0,0,.800000011920929,0,0,.8600000143051147,0,0,.9300000071525574,0,0,1,0,0,0,.05999999865889549,0,0,.12999999523162842,0,0,.20000000298023224,0,0,.25999999046325684,0,0,.25999999046325684,0,0,.4000000059604645,0,0,.46000000834465027,0,0,.5299999713897705,0,0,.6000000238418579,0,0,.6600000262260437,0,0,.7300000190734863,0,0,.800000011920929,0,0,.8600000143051147,0,0,.9300000071525574,0,0,1,0,0,0,.05999999865889549,0,0,.12999999523162842,0,0,.20000000298023224,0,0,.25999999046325684,0,0,.25999999046325684,0,0,.4000000059604645,0,0,.46000000834465027,0,0,.5299999713897705,0,0,.6000000238418579,0,0,.6600000262260437,0,0,.7300000190734863,0,0,.800000011920929,0,0,.8600000143051147,0,0,.9300000071525574,0,0,1,.05999999865889549,.05999999865889549,0,.12999999523162842,.12999999523162842,0,.20000000298023224,.20000000298023224,0,.25999999046325684,.25999999046325684,0,.25999999046325684,.25999999046325684,0,.4000000059604645,.4000000059604645,0,.46000000834465027,.46000000834465027,0,.5299999713897705,.5299999713897705,0,.6000000238418579,.6000000238418579,0,.6600000262260437,.6600000262260437,0,.7300000190734863,.7300000190734863,0,.800000011920929,.800000011920929,0,.8600000143051147,.8600000143051147,0,.9300000071525574,.9300000071525574,0,1,1,0,.05999999865889549,0,.05999999865889549,.12999999523162842,0,.12999999523162842,.20000000298023224,0,.20000000298023224,.25999999046325684,0,.25999999046325684,.25999999046325684,0,.25999999046325684,.4000000059604645,0,.4000000059604645,.46000000834465027,0,.46000000834465027,.5299999713897705,0,.5299999713897705,.6000000238418579,0,.6000000238418579,.6600000262260437,0,.6600000262260437,.7300000190734863,0,.7300000190734863,.800000011920929,0,.800000011920929,.8600000143051147,0,.8600000143051147,.9300000071525574,0,.9300000071525574,1,0,1,0,.05999999865889549,.05999999865889549,0,.12999999523162842,.12999999523162842,0,.20000000298023224,.20000000298023224,0,.25999999046325684,.25999999046325684,0,.25999999046325684,.25999999046325684,0,.4000000059604645,.4000000059604645,0,.46000000834465027,.46000000834465027,0,.5299999713897705,.5299999713897705,0,.6000000238418579,.6000000238418579,0,.6600000262260437,.6600000262260437,0,.7300000190734863,.7300000190734863,0,.800000011920929,.800000011920929,0,.8600000143051147,.8600000143051147,0,.9300000071525574,.9300000071525574,0,1,1,.05999999865889549,.5,.5,.12999999523162842,.5,.5,.20000000298023224,.5,.5,.25999999046325684,.5,.5,.33000001311302185,.5,.5,.4000000059604645,.5,.5,.46000000834465027,.5,.5,.5299999713897705,.5,.5,.6000000238418579,.5,.5,.6600000262260437,.5,.5,.7300000190734863,.5,.5,.800000011920929,.5,.5,.8600000143051147,.5,.5,.9300000071525574,.5,.5,1,.5,.5,.5,.05999999865889549,.5,.5,.12999999523162842,.5,.5,.20000000298023224,.5,.5,.25999999046325684,.5,.5,.33000001311302185,.5,.5,.4000000059604645,.5,.5,.46000000834465027,.5,.5,.5299999713897705,.5,.5,.6000000238418579,.5,.5,.6600000262260437,.5,.5,.7300000190734863,.5,.5,.800000011920929,.5,.5,.8600000143051147,.5,.5,.9300000071525574,.5,.5,1,.5,.5,.5,.05999999865889549,.5,.5,.12999999523162842,.5,.5,.20000000298023224,.5,.5,.25999999046325684,.5,.5,.33000001311302185,.5,.5,.4000000059604645,.5,.5,.46000000834465027,.5,.5,.5299999713897705,.5,.5,.6000000238418579,.5,.5,.6600000262260437,.5,.5,.7300000190734863,.5,.5,.800000011920929,.5,.5,.8600000143051147,.5,.5,.9300000071525574,.5,.5,1,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,1,0,0,1,0,0,0,1,0,0,.8999999761581421,.8999999761581421,.8999999761581421,0,.8999999761581421,.8600000143051147,.8600000143051147,0,0,.4000000059604645,1,0,1,0,1,0,0,1,1,1,0,0,0,.8235294818878174,.8235294818878174,1,0,.7843137383460999,.7843137383460999,.26274511218070984,.4000000059604645,.3333333432674408,1,1,1,.2352941334247589,.40000003576278687,.501960813999176,0,0,0];e._colorMaps=new Map,e._getColorMap=function(t){if(e._colorMaps.has(t))return e._colorMaps.get(t);for(var i=new Array(256),r=0;r<i.length;r++){var a=n[3*r],s=n[3*r+1],o=n[3*r+2];i[r]=(new e.Color).setRGB(a,s,o)}return i[e.COLORMAP_INDEX.HIGHLIGHT]=(new e.Color).setRGB(0,.784313738,.784313738),i[e.COLORMAP_INDEX.LOWLIGHT]=(new e.Color).setRGB(.262745112,.400000006,.333333343),i[e.COLORMAP_INDEX.BACKGROUND]=(new e.Color).setRGB(.92549026,.92549026,.92549026),e._colorMaps.set(t,i),i},r.subscribe({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE"},function(t){var i=t.parameters,r=i.viewer.renderer.renderer,n=e._getColorMap(r);if(!(i.slot<0||i.slot>255))if(i.slot>=0)n[i.slot]=i.color;else for(var a=0;a<i.colorMap.length;a++)n[a]=i.colorMap[a]}),r.subscribe({event:"/VISU/VIEWER/VIEWER_DISPOSED"},function(t){var i=t.parameters.viewer.renderer.renderer;e._colorMaps.delete(i)}),e.COLORMAP_INDEX={EDGE_HIGHLIGHT:239,UPDATENEEDED:240,HANDLECOLOR:241,CYAN:242,MAGENTA:243,YELLOW:244,BLUE:245,GREEN:246,RED:247,WHITE:248,BLACK:249,PREHIGHLIGHT:250,HIGHLIGHT:251,LOWLIGHT:252,FOREGROUND:253,BACKGROUND:254,TRUECOLOR:255};const a=new e.Color(0);new e.Color(16448250);var s=[1,2,3,4,5,6,7,8,9],o=[9,9,9,9,5,7,9,3,2],l=new Float64Array(1),h=new Uint8Array(l.buffer),c=function(t){this._attr=0,this._rgba=0,this._color=null,this._colorSet=!1,this._colorIndex=e.COLORMAP_INDEX.TRUECOLOR,this._alpha=1,this._lineWidth=1,this._lineType=i.LinePatternEnum.SOLID,this._symbolType=i.PointSymbolEnum.DOT,this._basic=!1,this._lowlight=!1,this._highlight=!1,this._show=!0,this._showFree=!1,this._noPick=!1,this._transparent=!0,this._inheritance=e.GASEnum.RGBA_INHERITANCE_ON,this._type=e.GASTypeEnum.SKIN,this._priority=4,t&&t.NREInit&&(this._inheritance=e.GASEnum.NO_INHERIT),t&&this.setParameters(t)};Object.defineProperty(c.prototype,"_colorIndex",{get:function(){return l[0]=this._attr,h[0]},set:function(e){l[0]=this._attr,h[0]=e,this._attr=l[0]}}),Object.defineProperty(c.prototype,"_lineWidth",{get:function(){return l[0]=this._attr,h[1]},set:function(e){l[0]=this._attr,h[1]=e,this._attr=l[0]}}),Object.defineProperty(c.prototype,"_lineType",{get:function(){return l[0]=this._attr,h[2]},set:function(e){l[0]=this._attr,h[2]=e,this._attr=l[0]}}),Object.defineProperty(c.prototype,"_basic",{get:function(){return l[0]=this._attr,(1&h[3])>0},set:function(e){l[0]=this._attr,e?h[3]|=1:h[3]&=-2,this._attr=l[0]}}),Object.defineProperty(c.prototype,"_lowlight",{get:function(){return l[0]=this._attr,(2&h[3])>0},set:function(e){l[0]=this._attr,e?h[3]|=2:h[3]&=-3,this._attr=l[0]}}),Object.defineProperty(c.prototype,"_highlight",{get:function(){return l[0]=this._attr,(4&h[3])>0},set:function(e){l[0]=this._attr,e?h[3]|=4:h[3]&=-5,this._attr=l[0]}}),Object.defineProperty(c.prototype,"_noPick",{get:function(){return l[0]=this._attr,(8&h[3])>0},set:function(e){l[0]=this._attr,e?h[3]|=8:h[3]&=-9,this._attr=l[0]}}),Object.defineProperty(c.prototype,"_show",{get:function(){return l[0]=this._attr,(16&h[3])>0},set:function(e){l[0]=this._attr,e?h[3]|=16:h[3]&=-17,this._attr=l[0]}}),Object.defineProperty(c.prototype,"_showFree",{get:function(){return l[0]=this._attr,(32&h[3])>0},set:function(e){l[0]=this._attr,e?h[3]|=32:h[3]&=-33,this._attr=l[0]}}),Object.defineProperty(c.prototype,"_transparent",{get:function(){return l[0]=this._attr,(64&h[3])>0},set:function(e){l[0]=this._attr,e?h[3]|=64:h[3]&=-65,this._attr=l[0]}}),Object.defineProperty(c.prototype,"_colorSet",{get:function(){return l[0]=this._attr,(128&h[3])>0},set:function(e){l[0]=this._attr,e?h[3]|=128:h[3]&=-129,this._attr=l[0]}}),Object.defineProperty(c.prototype,"_type",{get:function(){return l[0]=this._attr,h[4]},set:function(e){l[0]=this._attr,h[4]=e,this._attr=l[0]}}),Object.defineProperty(c.prototype,"_priority",{get:function(){return l[0]=this._attr,h[5]},set:function(e){l[0]=this._attr,h[5]=e,this._attr=l[0]}}),Object.defineProperty(c.prototype,"_symbolType",{get:function(){return l[0]=this._attr,h[6]},set:function(e){l[0]=this._attr,h[6]=e,this._attr=l[0]}});var d=new e.Color;Object.defineProperty(c.prototype,"_color",{get:function(){return this._colorSet?(l[0]=this._rgba,d.setRGB(h[0]/255,h[1]/255,h[2]/255),d):null},set:function(e){this._colorSet=!!e,l[0]=this._rgba,h[0]=e?255*e.r:0,h[1]=e?255*e.g:0,h[2]=e?255*e.b:0,this._rgba=l[0]}}),Object.defineProperty(c.prototype,"_alpha",{get:function(){return l[0]=this._rgba,h[3]/255},set:function(e){l[0]=this._rgba,h[3]=255*e,this._rgba=l[0]}}),Object.defineProperty(c.prototype,"side",{get:function(){return this._type===e.GASTypeEnum.VOLUME?e.FrontSide:e.DoubleSide},set:function(t){this._type=t===e.FrontSide?e.GASTypeEnum.VOLUME:e.GASTypeEnum.SKIN}}),c._createFromGASAttributes=function(t){var i={colorRGB:t.color,colorA:t.opacity,side:1===t.solid?e.FrontSide:e.DoubleSide,inheritance:e.GASEnum.RGBA_INHERITANCE_ON};return t.lineWidth&&(i.lineWidth=t.lineWidth,i.inheritance|=e.GASEnum.LINEWIDTH_INHERITANCE_ON),t.linewidth&&(i.lineWidth=t.linewidth,i.inheritance|=e.GASEnum.LINEWIDTH_INHERITANCE_ON),t.pattern&&(i.lineType=t.pattern,i.inheritance|=e.GASEnum.LINETYPE_INHERITANCE_ON),void 0!==t.symbol&&(i.symbolType=t.symbol,i.inheritance|=e.GASEnum.SYMBOLTYPE_INHERITANCE_ON),new c(i)},c.prototype.isGAS=!0,c.prototype.setParameters=function(t){var i=this._doesInherit(e.GASEnum.SYMBOLTYPE_INHERITANCE_ON);void 0!==t.colorRGB&&(this._color=t.colorRGB),void 0!==t.colorIndex&&(this._colorIndex=t.colorIndex),void 0!==t.colorA&&(this._alpha=t.colorA),void 0!==t.lineWidth&&(this._lineWidth=t.lineWidth),void 0!==t.lineType&&(this._lineType=t.lineType),void 0!==t.symbolType&&(this._symbolType=t.symbolType),void 0!==t.side&&(this.side=t.side),void 0!==t.inheritance&&(this._inheritance=t.inheritance),void 0!==t.lowlight&&(this._lowlight=t.lowlight),void 0!==t.highlight&&(this._highlight=t.highlight),void 0!==t.noPick&&(this._noPick=t.noPick),void 0!==t.show&&(this._show=t.show),void 0!==t.showFree&&(this._showFree=t.showFree),void 0!==t.transparent&&(this._transparent=t.transparent),void 0!==t.type&&(this._type=t.type),void 0!==t.basic&&(this._basic=t.basic),void 0!==t.priority&&(this._priority=t.priority),void 0===t.inheritance&&(!1===t.defaultRGB?this._inheritance|=e.GASEnum.COLOR_INHERITANCE_ON:!0===t.defaultRGB&&(this._inheritance&=~e.GASEnum.COLOR_INHERITANCE_ON),!1===t.defaultO?this._inheritance|=e.GASEnum.ALPHA_INHERITANCE_ON:!0===t.defaultO&&(this._inheritance&=~e.GASEnum.ALPHA_INHERITANCE_ON),!1===t.defaultLineType?this._inheritance|=e.GASEnum.LINETYPE_INHERITANCE_ON:!0===t.defaultLineType&&(this._inheritance&=~e.GASEnum.LINETYPE_INHERITANCE_ON),!1===t.defaultLineWidth?this._inheritance|=e.GASEnum.LINEWIDTH_INHERITANCE_ON:!0===t.defaultLineWidth&&(this._inheritance&=~e.GASEnum.LINEWIDTH_INHERITANCE_ON)),!1===t.defaultPointType||i?this._inheritance|=e.GASEnum.SYMBOLTYPE_INHERITANCE_ON:!0===t.defaultPointType&&(this._inheritance&=~e.GASEnum.SYMBOLTYPE_INHERITANCE_ON)},c.prototype.merge=function(t,i){return!!i&&i.canBeUsed()?(i.getInheritance()&e.GASEnum.COLOR_INHERITANCE_ON)>0?(this._color=t._color,this._colorIndex=t._colorIndex,this._inheritance|=e.GASEnum.COLOR_INHERITANCE_ON,t._doesInherit(e.GASEnum.COLOR_INHERITANCE_ON)||(this._color=i._GAS._color,this._colorIndex=i._GAS._colorIndex)):(i.getInheritance()&e.GASEnum.ASMCOLOR_INHERITANCE_ON)>0&&(this._color=t._color,this._colorIndex=t._colorIndex,this._inheritance|=e.GASEnum.ASMCOLOR_INHERITANCE_ON,t._doesInherit(e.GASEnum.ASMCOLOR_INHERITANCE_ON)||(this._color=i._asmGAS._color,this._colorIndex=i._asmGAS._colorIndex)):(t._doesInherit(e.GASEnum.COLOR_INHERITANCE_ON)&&(this._color=t._color,this._colorIndex=t._colorIndex,this._inheritance|=e.GASEnum.COLOR_INHERITANCE_ON),t._doesInherit(e.GASEnum.ASMCOLOR_INHERITANCE_ON)&&(this._color=t._color,this._colorIndex=t._colorIndex,this._inheritance|=e.GASEnum.ASMCOLOR_INHERITANCE_ON)),t._doesInherit(e.GASEnum.ALPHA_INHERITANCE_ON)&&(this._alpha=t._alpha,this._transparent=t._transparent,this._inheritance|=e.GASEnum.ALPHA_INHERITANCE_ON),t._doesInherit(e.GASEnum.LINEWIDTH_INHERITANCE_ON)&&(this._lineWidth=t._lineWidth,this._inheritance|=e.GASEnum.LINEWIDTH_INHERITANCE_ON),t._doesInherit(e.GASEnum.LINETYPE_INHERITANCE_ON)&&(this._lineType=t._lineType,this._inheritance|=e.GASEnum.LINETYPE_INHERITANCE_ON),t._doesInherit(e.GASEnum.SYMBOLTYPE_INHERITANCE_ON)&&(this._symbolType=t._symbolType,this._inheritance|=e.GASEnum.SYMBOLTYPE_INHERITANCE_ON),t._doesInherit(e.GASEnum.DEFAULTLOOK_INHERITANCE_ON)&&(this._inheritance|=e.GASEnum.DEFAULTLOOK_INHERITANCE_ON),this._doesInherit(e.GASEnum.DIMENSION_INHERITANCE_ON)&&(this._type=t._type),this._lowlight=this._lowlight||t._lowlight,this._highlight=this._highlight||t._highlight,this},c.prototype.copy=function(e){this._inheritance=e._inheritance,this._rgba=e._rgba,this._attr=e._attr};var u=e.__visibleInCurrentSpaceSimple;return c.prototype.visibleInCurrentSpace=function(e,t){return u(e.visible&&this._show,e.visibilityFree||this._showFree,t,null)},c.prototype.clone=function(){var e=new c;return e.copy(this),e},c.prototype._dump=function(){var e=this.getJSON();return e.type="StructGAS",e},c.prototype.getPointSize=function(){var t=this._symbolType;return Math.round(o[t]*(e.getDevicePixelRatio()||1))},c.prototype.getMaterial=function(r,n,o,l,h){var c=new t,d={},u=r&&r.isGAS;if(d.opacity=1,this._doesInherit(e.GASEnum.ALPHA_INHERITANCE_ON)?d.opacity=this._transparent?this._alpha:1:r&&(d.opacity=u?r._transparent?r._alpha:1:r.opacity),this._doesInherit(e.GASEnum.COLOR_INHERITANCE_ON|e.GASEnum.ASMCOLOR_INHERITANCE_ON)?(d.color=this._color,this._colorIndex!==e.COLORMAP_INDEX.TRUECOLOR&&(d.color=e._getColorMap(l)[this._colorIndex])):r&&(d.color=u?r._color:r.color,u&&r._colorIndex!==e.COLORMAP_INDEX.TRUECOLOR&&(d.color=e._getColorMap(l)[r._colorIndex])),r?u||"Basic"!==r.getType()?u&&(d.basic=r._basic):(d.basic=!0,0===r.opacity&&(d.opacity=0)):d.basic=this._basic,o&&o._basic&&(d.basic=!0),n>1&&(r?u?r._doesInherit(e.GASEnum.DIMENSION_INHERITANCE_ON)?d.solid=this._type===e.GASTypeEnum.VOLUME?1:0:d.solid=r._type===e.GASTypeEnum.VOLUME?1:0:d.solid=r.side===e.FrontSide?1:0:d.solid=this._type===e.GASTypeEnum.VOLUME?1:0),1===n&&(d.lineWidth=1,this._doesInherit(e.GASEnum.ASMCOLOR_INHERITANCE_ON)&&(d.color=a,d.opacity=1),this._doesInherit(e.GASEnum.LINEWIDTH_INHERITANCE_ON)?d.lineWidth=this._lineWidth:r&&(d.lineWidth=u?r._lineWidth:r.lineWidth),d.lineWidth||(d.lineWidth=1),this._doesInherit(e.GASEnum.LINETYPE_INHERITANCE_ON)?d.pattern=this._lineType:r&&(d.pattern=u?r._lineType:r.dashPattern),d.pattern||(d.pattern=i.LinePatternEnum.SOLID)),0===n){var p=i.PointSymbolEnum.DOT;this._doesInherit(e.GASEnum.SYMBOLTYPE_INHERITANCE_ON)?p=this._symbolType:u&&(p=r._symbolType),d.symbol=s[p]}return(this._highlight||u&&r._highlight)&&(d.color=e._getColorMap(l)[e.COLORMAP_INDEX.HIGHLIGHT],d.opacity=1),(this._lowlight||u&&r._lowlight)&&(d.color=e._getColorMap(l)[e.COLORMAP_INDEX.LOWLIGHT],d.opacity=1),this._transparent||void 0===h||-1===h||(d.depthPriority=h),c.getMaterialFromGAS(d)},c.prototype.hasASMInherit=function(){return(this._inheritance&e.GASEnum.ASMCOLOR_INHERITANCE_ON)>0},c.prototype._doesInherit=function(e){return(this._inheritance&e)>0},c.prototype.__updateGAS=function(e){return e&&e.isGAS?(e.copy(this),e):this.__getGAS(e).clone()},c.prototype.__getGAS=function(e){return this},c.prototype.getJSON=function(){return{attr:this._attr,rgba:this._rgba}},(c.IncrementalGraphicAttributeSet=function(e){e=e||{},this.NREInit=!1,this.colorRGB=e.colorRGB,this.colorIndex=e.colorIndex,this.colorA=e.colorA,this.lineWidth=e.lineWidth,this.lineType=e.lineType,this.symbolType=e.symbolType,this.inheritance=e.inheritance,this.lowlight=e.lowlight,this.highlight=e.highlight,this.noPick=e.noPick,this.type=e.type,this.basic=e.basic,this.priority=e.priority,this.show=e.show,this.showFree=e.showFree,this.transparent=e.transparent,this.defaultRGB=e.defaultRGB,this.defaultO=e.defaultO,this.defaultLineType=e.defaultLineType,this.defaultLineWidth=e.defaultLineWidth,this.defaultPointType=e.defaultPointType}).prototype.usingNREInit=function(e){return this.NREInit=!!e,this},c.IncrementalGraphicAttributeSet.prototype.__getGAS=function(e){var t;return e&&e.isGAS?(t=e.clone()).setParameters(this):t=new c(this),t},c.IncrementalGraphicAttributeSet.prototype.__updateGAS=function(e){return e&&e.isGAS?(e.setParameters(this),e):this.__getGAS(e)},e.GraphicAttributeSet=c,c}),define("DS/Visualization/Filters/GASInheritFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter","DS/Visualization/GraphicAttributeSet"],function(e,t,i){"use strict";var r=new i({NREInit:!0});return class extends t{constructor(){super(),this._inheritance=e.GASEnum.NO_INHERIT,this._GAS=r,this._asmGAS=r}usingColorInherit(t,i){return null!==i&&(this._inheritance|=i?e.GASEnum.COLOR_INHERITANCE_ON:e.GASEnum.COLOR_INHERITANCE_OFF),this._GAS=t||r,this}usingASMColorInherit(t,i){return null!==i&&(this._inheritance|=i?e.GASEnum.ASMCOLOR_INHERITANCE_ON:e.GASEnum.ASMCOLOR_INHERITANCE_OFF),this._asmGAS=t||r,this}getInheritance(){return this._inheritance}canBeUsed(){return this._inheritance!==e.GASEnum.NO_INHERIT}}}),define("DS/Visualization/RenderMode",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=e.extend({init:function(e){this._mask=0,this._maskWithDefault=0,this._setFromMasks(0,0,t.GeomTypeEnum.FACE),this._useRenderLineMask=!0,this._useRenderFaceMask=!0,this._useRenderPointMask=!0,this._halfVisibleSmoothEdges=-1,this._hiddenEdges=-1,this._outlineWidth=1,e&&void 0!==e.renderLineMode&&this._setRenderLineMode(e.renderLineMode)},clone:function(){var e=new i;return e._mask=this._mask,e._maskWithDefault=this._maskWithDefault,e._useRenderLineMask=this._useRenderLineMask,e._useRenderPointMask=this._useRenderPointMask,e._useRenderFaceMask=this._useRenderFaceMask,e._outlineWidth=this._outlineWidth,e._halfVisibleSmoothEdges=this._halfVisibleSmoothEdges,e._hiddenEdges=this._hiddenEdges,e},combine:function(e){e&&(this._mask=e._mask)},setOutlineWidth:function(e){this._outlineWidth=e},setHalfVisibleSmoothEdges:function(e){this._halfVisibleSmoothEdges=e},setHiddenEdges:function(e){this._hiddenEdges=e},setRenderMode:function(e,i){if("@InternalEdge"===e)this.setRenderMode("InternalSharpEdge",i),this.setRenderMode("InternalSmoothEdge",i);else if("@Edge"===e)this.setRenderMode("InternalSharpEdge",i),this.setRenderMode("InternalSmoothEdge",i),this.setRenderMode("BoundaryEdge",i),this.setRenderMode("WireEdge",i),this.setRenderMode("Edge",i);else if("@Point"===e)this.setRenderMode("BoundaryPoint",i),this.setRenderMode("SharpPoint",i),this.setRenderMode("SmoothPoint",i),this.setRenderMode("SurfacicPoint",i),this.setRenderMode("FreePoint",i);else{var r={Edge:"EDGE",InternalSharpEdge:"SHARP_EDGE",InternalSmoothEdge:"SMOOTH_EDGE",BoundaryEdge:"BOUNDARY_EDGE",WireEdge:"WIRE_EDGE",Outline:"_OUTLINE",SectionLine:"_SECTION_LINE",Face:"FACE",BoundaryPoint:"BOUNDARY_POINT",SharpPoint:"SHARP_POINT",SurfacicPoint:"SURFACIC_POINT",SmoothPoint:"SMOOTH_POINT",FreePoint:"FREE_POINT",AxisSystem:"AXIS_SYSTEM",InfiniteFace:"INFINITE_FACE"}[e];if(r){var n,a,s=t.GeomTypeEnum[r];n=this._mask||0,a=i?n|s:n&~s,this._setMask(a)}else console.warn(e+"unknown category")}},_setRenderLineMode:function(e){e=e||0;var t,r=this._mask,n=i.linesMask;t=e&n|(r&=~n),this._setMask(t)},_setFromMasks:function(e,t,i){this._setMask(e&r|t&n|i&s)},getMask:function(){return this._mask},getMasks:function(){return[this._mask&s,this._mask&n,this._mask&r]},areFacesVisible:function(){return!!(this._mask&t.GeomTypeEnum.FACE)},_displayNothing:function(){this._setMask(0)},_setMask:function(e){this._mask=e,this._maskWithDefault=e|i.defaultMask}});i.createChild=function(e,t){var i=null;return(e||t)&&(e?(i=e.clone()).combine(t):i=t),i},i.defaultMask=t.GeomTypeEnum.UNKNOWN|t.GeomTypeEnum.UNKNOWN_1D|t.GeomTypeEnum.UNKNOWN_2D;var r=t.GeomTypeEnum.BOUNDARY_POINT|t.GeomTypeEnum.SHARP_POINT|t.GeomTypeEnum.SMOOTH_POINT|t.GeomTypeEnum.SURFACIC_POINT|t.GeomTypeEnum.FREE_POINT|t.GeomTypeEnum.HIDDEN_SEAM_POINT;i.pointsMask=r;var n=t.GeomTypeEnum.EDGE|t.GeomTypeEnum.WIRE_EDGE|t.GeomTypeEnum.BOUNDARY_EDGE|t.GeomTypeEnum.SHARP_EDGE|t.GeomTypeEnum.SMOOTH_EDGE|t.GeomTypeEnum.HIDDEN_SEAM_EDGE|t.GeomTypeEnum._OUTLINE|t.GeomTypeEnum._SECTION_LINE;i.linesMask=n;var a=t.GeomTypeEnum.EDGE|t.GeomTypeEnum.WIRE_EDGE|t.GeomTypeEnum.BOUNDARY_EDGE|t.GeomTypeEnum.SHARP_EDGE|t.GeomTypeEnum.SMOOTH_EDGE|t.GeomTypeEnum.HIDDEN_SEAM_EDGE;i.linesPickingMask=a;var s=t.GeomTypeEnum.INFINITE_FACE|t.GeomTypeEnum.FACE|t.GeomTypeEnum.AXIS_SYSTEM;return i.facesMask=s,i.unknownMask=i.defaultMask,t.RenderMode=i,i}),define("DS/Visualization/PickingMode",["DS/Visualization/ThreeJS_DS","DS/Visualization/RenderMode","DS/Mesh/Mesh"],function(e,t,i){"use strict";const r=new t;class n{constructor(){this.pickingModeMSB=e.ShowAllFaces|e.AllPointsButSurfacicPointsRenderPointMask|e.WireEdgeRenderLineModeMask,this.pickingModeLSB=e.BodyLinesMask|e.SurfacicPointRenderPointMask}clone(){var e=new n;return e.pickingModeMSB=this.pickingModeMSB,e.pickingModeLSB=this.pickingModeLSB,e}applyToAll(e){this.setPickingMode("Face",e),this.setPickingMode("InternalSharpEdge",e),this.setPickingMode("Edge",e),this.setPickingMode("InternalSmoothEdge",e),this.setPickingMode("BoundaryEdge",e),this.setPickingMode("WireEdge",e),this.setPickingMode("BoundaryPoint",e),this.setPickingMode("SharpPoint",e),this.setPickingMode("SmoothPoint",e),this.setPickingMode("FreePoint",e),this.setPickingMode("AxisSystem",e),this.setPickingMode("InfiniteFace",e)}_fromRenderer(e){this.pickingModeLSB=e.pickingModeLSB,this.pickingModeMSB=e.pickingModeMSB}_getPickingMasks(e){var i=this.pickingModeLSB,r=this.pickingModeMSB,n=~r&i|r&i&~e|e&(r^i),a=n&t.pointsMask;return[n&t.facesMask,n&t.linesPickingMask,a]}getPickingMasks(e){var t=e.getMask();return this._getPickingMasks(t)}_setPickingMode(e,t){var r=this.pickingModeLSB,n=this.pickingModeMSB;switch(t){case i.PICK_NEVER:this.pickingModeMSB=n&~e,this.pickingModeLSB=r&~e;break;case i.PICK_ALWAYS:this.pickingModeMSB=n&~e,this.pickingModeLSB=r|e;break;case i.PICK_VISIBLE:this.pickingModeMSB=n|e,this.pickingModeLSB=r&~e;break;case i.PICK_INVISIBLE:this.pickingModeMSB=n|e,this.pickingModeLSB=r|e}}setPickingMode(e,t){r._mask=0,r.setRenderMode(e,!0),this._setPickingMode(r.getMask(),t)}}return e.PickingMode=n,n}),define("DS/Visualization/MaterialApplication",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";e.MaterialLayerUndefined=Number.MAX_SAFE_INTEGER||Math.pow(2,53)-1,e.MaterialLayerMax=e.MaterialLayerUndefined-1;var t=new e.Matrix3,i=new e.Matrix4,r=function(e){e=e||{},this.mappingType=-1,this.mappingObjTransformation=i,this.mappingUVTransformation=t,this.mappingUseFragment=!0,this.mappingNormTransformation=t,this.textureUVTransforms={normalUvTransform:t,bumpUvTransform:t,bumpScaleUvTransform:t,normalScaleUvTransform:t,displacementUvTransform:t,thicknessUvTransform:t,diffuseUvTransform:t,specularUvTransform:t,metalnessUvTransform:t,emissionColorUvTransform:t,specularContribUvTransform:t,transparencyUvTransform:t,opacityUvTransform:t,translucencyUvTransform:t,translucencyColorUvTransform:t,roughnessUvTransform:t,anisotropyUvTransform:t,anisotropyAngleUvTransform:t,sheenUvTransform:t,sheenRoughnessUvTransform:t,sheenColorUvTransform:t,clearCoatRoughnessUvTransform:t,clearCoatUvTransform:t,clearCoatNormalUvTransform:t,clearCoatColorUvTransform:t,flakesRoughnessUvTransform:t,flakesSizeUvTransform:t,flakesCoverageUvTransform:t,flakesColorUvTransform:t,flipFlopUvTransform:t,flipFlopColorUvTransform:t,iridescenceUvTransform:t,iridescenceThicknessUvTransform:t},this.textureUVSlots={normalUvSlot:1,bumpUvSlot:1,bumpScaleUvSlot:1,normalScaleUvSlot:1,displacementUvSlot:1,thicknessUvSlot:1,diffuseUvSlot:1,specularUvSlot:1,metalnessUvSlot:1,emissionColorUvSlot:1,specularContribUvSlot:1,transparencyUvSlot:1,opacityUvSlot:1,translucencyUvSlot:1,translucencyColorUvSlot:1,roughnessUvSlot:1,anisotropyUvSlot:1,anisotropyAngleUvSlot:1,sheenUvSlot:1,sheenRoughnessUvSlot:1,sheenColorUvSlot:1,clearCoatRoughnessUvSlot:1,clearCoatUvSlot:1,clearCoatNormalUvSlot:1,clearCoatColorUvSlot:1,flakesRoughnessUvSlot:1,flakesSizeUvSlot:1,flakesCoverageUvSlot:1,flakesColorUvSlot:1,flipFlopUvSlot:1,flipFlopColorUvSlot:1,iridescenceUvSlot:1,iridescenceThicknessUvSlot:1},this.mappingTransformSemantic=1,this._set(e)};r.prototype._set=function(r){if(void 0!==r.mappingType&&(this.mappingType=r.mappingType),void 0!==r.mappingObjTransformation&&(this.mappingObjTransformation=r.mappingObjTransformation,(null===this.mappingObjTransformation||this.mappingObjTransformation.isIdentity())&&(this.mappingObjTransformation=i)),void 0!==r.mappingUVTransformation&&(this.mappingUVTransformation=r.mappingUVTransformation,(null===this.mappingUVTransformation||this.mappingUVTransformation.isIdentity())&&(this.mappingUVTransformation=t)),void 0!==r.mappingUseFragment&&(this.mappingUseFragment=r.mappingUseFragment),void 0!==r.textureUVTransforms)for(var n in Object.assign(this.textureUVTransforms,r.textureUVTransforms),this.textureUVTransforms)(null===this.textureUVTransforms[n]||this.textureUVTransforms[n].isIdentity())&&(this.textureUVTransforms[n]=t);void 0!==r.textureUVSlots&&Object.assign(this.textureUVSlots,r.textureUVSlots),void 0!==r.mappingTransformSemantic&&(this.mappingTransformSemantic=r.mappingTransformSemantic),this.mappingObjTransformation&&(this.mappingObjTransformation!==i?this.mappingNormTransformation=(new e.Matrix3).getInverse(this.mappingObjTransformation).transpose():this.mappingNormTransformation=t)};var n=function(e){this.uvSlot=1,this.mode=1,this.linear=!0,this.texture=null,this.uvTransform=t,this._set(e)};n.prototype._set=function(e){void 0!==e.uvSlot&&(this.uvSlot=e.uvSlot),void 0!==e.mode&&(this.mode=e.mode),void 0!==e.linear&&(this.linear=e.linear),void 0!==e.texture&&(this.texture=e.texture),void 0!==e.uvTransform&&(this.uvTransform=e.uvTransform),(null===this.uvTransform||this.uvTransform.isIdentity())&&(this.uvTransform=t)};var a=function(t){this.isMatApp=!0,this._checkForceFlag=!1,this._material=null,this._materialGeomFace=null,this._materialLine=null,this._materialPoint=null,this._lightMap=null,this._mappingOperator=null,this._programID=0,this._inheritance=1,this._layer=e.MaterialLayerMax,this._depth=-1,this._enableDepth=!1,this.setParameters(t)};return a.prototype._dump=function(){return{layer:this.layer,inheritance:this._inheritance,material:this._material?this._material._dump():null,materialGeomFace:this._materialGeomFace?this._materialGeomFace._dump():null,materialLine:this._materialLine?this._materialLine._dump():null,materialPoint:this._materialPoint?this._materialPoint._dump():null,lightMap:!!this._lightMap&&!!this._lightMap.texture,defaultMapping:!this._mappingOperator||this._mappingOperator.mappingType<=0}},a.prototype.copy=function(e){this._checkForceFlag=e._checkForceFlag,this._material=e._material,this._materialGeomFace=e._materialGeomFace,this._materialLine=e._materialLine,this._materialPoint=e._materialPoint,this._lightMap=e._lightMap,this._mappingOperator=e._mappingOperator,this._programID=e._programID,this._inheritance=e._inheritance,this._layer=e._layer,this._depth=e._depth,this._enableDepth=e._enableDepth},a.prototype.clone=function(){var e=new a({faceMaterial:this._material,geometricalFaceMaterial:this._materialGeomFace,lineMaterial:this._materialLine,pointMaterial:this._materialPoint,inheritance:this._inheritance,lightMap:this._lightMap,layer:this._layer,mappingOperator:this._mappingOperator});return e._checkForceFlag=this._checkForceFlag,e._depth=this._depth,e._enableDepth=this._enableDepth,e},a.prototype.setParameters=function(t){t.faceMaterial&&(this._material=t.faceMaterial),t.geometricalFaceMaterial&&(this._materialGeomFace=t.geometricalFaceMaterial),t.lineMaterial&&(this._materialLine=t.lineMaterial),t.pointMaterial&&(this._materialPoint=t.pointMaterial),void 0!==t.inheritance&&(this._inheritance=t.inheritance),void 0!==t.layer&&(this._layer=t.layer),t.lightMap&&(this._lightMap=new n(t.lightMap)),t.mappingOperator&&(this._mappingOperator=new r(t.mappingOperator)),void 0!==t.enableDepth&&(this._enableDepth=t.enableDepth),this._lightMap&&this._lightMap.texture&&(this._programID|=e.ProgramIDs.LIGHT_MAP),this._mappingOperator&&(this._mappingOperator.mappingType>-1&&(this._programID|=e.ProgramIDs.MAPPING_OPERATOR),this._mappingOperator.mappingUseFragment?this._programID&=~e.ProgramIDs.MAPPING_OPERATOR_VERTEX:this._programID|=e.ProgramIDs.MAPPING_OPERATOR_VERTEX)},a.prototype.updateMappingOperator=function(t){if(null!==this._mappingOperator){t=t||{};var i={};Object.assign(i,this._mappingOperator),Object.assign(i,t),this._mappingOperator._set(i),this._mappingOperator&&(this._mappingOperator.mappingType>-1&&(this._programID|=e.ProgramIDs.MAPPING_OPERATOR),this._mappingOperator.mappingUseFragment?this._programID&=~e.ProgramIDs.MAPPING_OPERATOR_VERTEX:this._programID|=e.ProgramIDs.MAPPING_OPERATOR_VERTEX)}},a.prototype._getMaterialFromGLType=function(t,i){var r=null;if(4===t?r=i===e.GeomTypeEnum.FACE&&this._materialGeomFace?this._materialGeomFace:this._material:1===t?r=this._materialLine:0===t&&(r=this._materialPoint),this._checkForceFlag){if(this._material||this._materialGeomFace)return this._material&&this._material.force||this._materialGeomFace&&this._materialGeomFace.force?r:null;if(r&&!r.force)return null}return r},a.prototype.isPrioritary=function(t,i){if(!t)return!0;var r=this.getLayer(i),n=t.getLayer(i);return 0!==this._inheritance&&r===n&&r===e.MaterialLayerMax||0!==this._inheritance&&(r<n||r===n&&(r<e.MaterialLayerMax||2===this._inheritance||1===this._inheritance&&0===t._inheritance))},a.prototype.getLayer=function(t){var i=32768*(this._enableDepth?this._depth<0?t:this._depth:0)+this._layer;return i>e.MaterialLayerMax?e.MaterialLayerMax:i},a.prototype.solveInheritance=function(e,t){return this.isPrioritary(e,t)?this:e},a.prototype.getMaterial=function(e,t,i){throw new Error("coucou")},a.prototype.recompileShaders=function(e){for(var t=[this._material,this._materialGeomFace,this._materialLine,this._materialPoint],i=0;i<t.length;i++){var r=t[i];if(r&&(e&&e.onlyDeferred||(e&&e.callback&&e.callback(r),r.needsUpdate=!0),r._deferredMaterialsInit)){var n=r._deferredMaterials,a=e?e.deferredChannels:null;if(a&&a.length>0)for(var s=0;s<a.length;s++){(o=n[a[s]])&&(e&&e.callback&&e.callback(o),o.needsUpdate=!0)}else for(s=0;s<n.length;s++){var o;(o=n[s])&&(e&&e.callback&&e.callback(o),o.needsUpdate=!0)}}}},a.prototype._loadMappingOperatorUniforms=function(e,t,i){var r=e.program.uniformLocations;e._loadTextureInfo(this._mappingOperator.textureUVTransforms,this._mappingOperator.textureUVSlots,t,i,r,!0),e._loadMappingInfo(this._mappingOperator,t,i,r)},a}),define("DS/Visualization/WorldOrientation",["DS/Visualization/ThreeJS_DS"],function(e){var t=function(t){this._woName=t.name,this.upVector=t.upVector,this.rightVector=t.rightVector,this.frontVector=(new e.Vector3).crossVectors(this.rightVector,this.upVector),this.fromZUpMatrix=t.fromZUpMatrix,this.upAttribute=t.upAttribute,this.rightAttribute=t.rightAttribute,this.frontAttribute=t.frontAttribute,this._anglesOrderForLockedRotation=t.anglesOrderForLockedRotation,this._eulerOrderForReframe=t.eulerOrderForReframe};return t.prototype.getOrientationForLockedRotation=function(t,i,r){var n=this.upAttribute,a=this.rightAttribute,s=this.frontAttribute,o=this._anglesOrderForLockedRotation,l=(new e.Matrix4).makeRotationFromQuaternion(r),h=(new e.Vector3).setEulerFromRotationMatrix(l,o);return h[n]-=t,"y"===n?(h[a]-=i,h[s]=0):"z"===n&&(h[s]-=i,h[a]=0),(new e.Quaternion).setFromEuler(h,o)},t.prototype.getAxisForSideRotation=function(t){var i=new e.Vector3,r=this._eulerOrderForReframe;if("ZXY"!==r&&"YZX"!==r)throw"Unsupported euler order";return"right"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,Math.PI):"YZX"===r&&(i=new e.Vector3(0,.5*Math.PI,0)):"left"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,0):"YZX"===r&&(i=new e.Vector3(0,-.5*Math.PI,0)):"top"===t?"ZXY"===r?i=new e.Vector3(0,0,.5*Math.PI):"YZX"===r&&(i=new e.Vector3(-.5*Math.PI,0,0)):"bottom"===t?"ZXY"===r?i=new e.Vector3(Math.PI,0,.5*Math.PI):"YZX"===r&&(i=new e.Vector3(.5*Math.PI,0,0)):"front"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,.5*Math.PI):"YZX"===r&&(i=new e.Vector3(0,0,0)):"back"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,-.5*Math.PI):"YZX"===r&&(i=new e.Vector3(0,-Math.PI,0)):"iso"===t&&("ZXY"===r?i=new e.Vector3(.35*Math.PI,0,.75*Math.PI):"YZX"===r&&(i=new e.Vector3(-.15*Math.PI,.25*Math.PI,0))),i},t.prototype.buildSnapRobotMatrix=function(e){return"zup"===this._woName?this.buildSnapRobotMatrix_zup(e):"yup"===this._woName?this.buildSnapRobotMatrix_yup(e):void 0},t.prototype.buildSnapRobotMatrix_zup=function(t){var i,r=t.normal;r.normalize();var n=new e.Vector3(1,0,0).projectOnPlane(r),a=n.length(),s=new e.Vector3(0,1,0).projectOnPlane(r),o=s.length(),l=(new e.Vector3).crossVectors(new e.Vector3(0,0,1),r),h=new e.Vector3(0,0,1).dot(r);return Math.abs(h)>.999?Math.abs(a-o)<5e-4?(n.normalize(),s.normalize()):a<o?((s=new e.Vector3(0,1,0).projectOnPlane(r)).normalize(),n=(new e.Vector3).crossVectors(s,r).normalize()):((n=new e.Vector3(1,0,0).projectOnPlane(r)).normalize(),s=(new e.Vector3).crossVectors(r,n).normalize()):(n=l.normalize(),s=(new e.Vector3).crossVectors(r,n).normalize()),(i=new e.Matrix4(n.x,s.x,r.x,0,n.y,s.y,r.y,0,n.z,s.z,r.z,0,0,0,0,1)).setPosition(t.position),i},t.prototype.buildSnapRobotMatrix_yup=function(t){var i,r=t.normal;r.normalize();var n=new e.Vector3(0,0,1).projectOnPlane(r),a=n.length(),s=new e.Vector3(1,0,0).projectOnPlane(r),o=s.length(),l=(new e.Vector3).crossVectors(new e.Vector3(0,1,0),r),h=new e.Vector3(0,1,0).dot(r);return Math.abs(h)>.999?Math.abs(a-o)<5e-4?(n.normalize(),s.normalize()):a<o?((s=new e.Vector3(1,0,0).projectOnPlane(r)).normalize(),n=(new e.Vector3).crossVectors(s,r).normalize()):((n=new e.Vector3(0,0,1).projectOnPlane(r)).normalize(),s=(new e.Vector3).crossVectors(r,n).normalize()):(n=l.normalize(),s=(new e.Vector3).crossVectors(r,n).normalize()),(i=new e.Matrix4(s.x,r.x,n.x,0,s.y,r.y,n.y,0,s.z,r.z,n.z,0,0,0,0,1)).setPosition(t.position),i},{YUpXRight:new t({name:"yup",upVector:new e.Vector3(0,1,0),rightVector:new e.Vector3(1,0,0),fromZUpMatrix:(new e.Matrix4).setRotationFromEuler(new e.Vector3(-Math.PI/2,0,-Math.PI/2),"XYZ"),upAttribute:"y",rightAttribute:"x",frontAttribute:"z",anglesOrderForLockedRotation:"YZX",eulerOrderForReframe:"YZX"}),ZUpYRight:new t({name:"zup",upVector:new e.Vector3(0,0,1),rightVector:new e.Vector3(0,1,0),fromZUpMatrix:new e.Matrix4,upAttribute:"z",rightAttribute:"y",frontAttribute:"x",anglesOrderForLockedRotation:"ZYX",eulerOrderForReframe:"ZXY"})}}),define("DS/Visualization/KDTree",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],function(e,t,i){"use strict";var r=new t.Box3,n=function(e,t,i){return e.setValues(t[i],t[i+1],t[i+2],t[i+3],t[i+4],t[i+5]),e},a=function(e,i){this.renderable=null,this.nodesUint8=null,this.nodesUint32=null,this.nodesFloat32=null,this.nbAllocatedNodes=0,this.nextFreeNode=0,this.aabb=new t.Box3,this.eltsAsBinary=!0,this.elts=this.eltsAsBinary?null:[],this.eltIndices=null,this.nextFreeIndex=0,this.nbAllocatedIndices=0,this.maxElts=void 0!==e?e:100,this.maxDepth=void 0!==i?i:8,this.intersectionCost=80,this.traversalCost=1,this.emptyBonus=.5,this.debugInfos={initTime:0,totalTime:0,computeCostTime:0,sortTime:0,nbLeafNodesBiggerThanMaxElts:0}};return a.prototype={constructor:a,resetDebugInfos:function(){this.debugInfos.initTime=0,this.debugInfos.totalTime=0,this.debugInfos.computeCostTime=0,this.debugInfos.sortTime=0,this.debugInfos.nbLeafNodesBiggerThanMaxElts=0},printDebugInfos:function(){console.log("init time: "+this.debugInfos.initTime+" ms"),console.log("total time: "+this.debugInfos.totalTime+" ms"),console.log("cost time: "+this.debugInfos.computeCostTime+" ms"),console.log("sort time: "+this.debugInfos.sortTime+" ms"),console.log("number of allocated nodes: "+this.nbAllocatedNodes),console.log("number of used nodes: "+this.nextFreeNode),console.log("number of leaf nodes above maxElts: "+this.debugInfos.nbLeafNodesBiggerThanMaxElts),console.log("number of stored indices: "+this.nbAllocatedIndices);var e=this.eltsAsBinary?this.elts?4*this.elts.length:0:8*this.elts.length,t=8*this.nbAllocatedNodes+e+4*this.nbAllocatedIndices;console.log("estimated kd-tree allocation = "+t/1048576+" MB")},reallocateTreeNodes:function(e){var t=new ArrayBuffer(8*e),i=new Uint8Array(t),r=new Uint32Array(t),n=new Float32Array(t);if(this.nbAllocatedNodes>0)for(var a=0;a<8*this.nbAllocatedNodes;a++)i[a]=this.nodesUint8[a];this.nbAllocatedNodes=e,this.nodesUint8=i,this.nodesUint32=r,this.nodesFloat32=n},reallocateIndices:function(e){var t=new Uint32Array(e);if(this.nbAllocatedIndices>0)for(var i=0;i<this.nbAllocatedIndices;i++)t[i]=this.eltIndices[i];this.nbAllocatedIndices=e,this.eltIndices=t},optimizeMemory:function(){this.nbAllocatedNodes>this.nextFreeNode&&this.reallocateTreeNodes(this.nextFreeNode),this.nbAllocatedIndices>this.nextFreeIndex&&this.reallocateIndices(this.nextFreeIndex)},buildFast:function(e,t){var i=this.eltsAsBinary?e.length/4:e.length;this.elts=e,console.log("kd-tree #elts = "+i),this.resetDebugInfos();var a=performance.now();if(this.eltsAsBinary)for(var s=0;s<i;s++)n(r,t,6*s),this.aabb.union(r);else for(s=0;s<i;s++)this.aabb.union(t[s]);var o=new Uint32Array(i),l=new Uint32Array((this.maxDepth+1)*i),h=new Uint32Array(i);for(s=0;s<i;s++)h[s]=s;this.debugInfos.initTime=performance.now()-a,this._buildFast(0,this.aabb,t,{ptr:h,offset:0},i,this.maxDepth,{ptr:o,offset:0},{ptr:l,offset:0}),this.optimizeMemory(),this.debugInfos.totalTime=performance.now()-a,this.printDebugInfos()},_buildFast:function(e,t,i,a,s,o,l,h){if(this.nextFreeNode===this.nbAllocatedNodes&&this.reallocateTreeNodes(Math.max(512,2*this.nbAllocatedNodes)),this.nextFreeNode++,s<=this.maxElts||0===o)this.initLeafNode(e,a,s);else{for(var c=t.size().getMaxAxis(),d=.5*(t.min.getComponent(c)+t.max.getComponent(c)),u=0,p=0,f=0;f<s;f++){var g,m=a.ptr[a.offset+f];(g=this.eltsAsBinary?n(r,i,6*m):i[m]).min.getComponent(c)<=d&&(l.ptr[l.offset+u++]=m),g.max.getComponent(c)>=d&&(h.ptr[h.offset+p++]=m)}var v=t.clone(),y=t.clone();v.max.setComponent(c,d),y.min.setComponent(c,d),this._buildFast(e+1,v,i,l,u,o-1,l,{ptr:h.ptr,offset:h.offset+s});var S=this.nextFreeNode;this.initInteriorNode(e,c,S,d),this._buildFast(S,y,i,h,p,o-1,l,{ptr:h.ptr,offset:h.offset+s})}},initInteriorNode:function(e,t,i,r){var n=i<<2;n|=t,this.nodesUint32[2*e]=n,this.nodesFloat32[2*e+1]=r},initLeafNode:function(e,t,i){var r=i<<2;r|=3,this.nodesUint32[2*e]=r,i>this.maxElts&&this.debugInfos.nbLeafNodesBiggerThanMaxElts++;var n=0;if(0===i)n=0;else if(1===i)n=t.ptr[t.offset];else{n=this.nextFreeIndex,this.nextFreeIndex+i>=this.nbAllocatedIndices&&this.reallocateIndices(Math.max(512,2*this.nbAllocatedIndices));for(var a=0;a<i;a++)this.eltIndices[this.nextFreeIndex+a]=t.ptr[t.offset+a];this.nextFreeIndex+=i}this.nodesUint32[2*e+1]=n},isLeafNode:function(e){return 3==(3&this.nodesUint32[2*e])},getSplitAxis:function(e){return 3&this.nodesUint32[2*e]},getSplitPosition:function(e){return this.nodesFloat32[2*e+1]},getNbElts:function(e){return this.nodesUint32[2*e]>>2},getNbTotalElts:function(){return this.eltsAsBinary?this.elts?this.elts.length/4:0:this.elts.length},getNbNodes:function(){return this.nbAllocatedNodes},getEltIndices:function(e){return this.nodesUint32[2*e+1]},getAboveChild:function(e){return this.nodesUint32[2*e]>>2},setBoundEdge:function(e,t,i,r,n){var a=r<<1;a|=n,e.float32View[2*t]=i,e.uint32View[2*t+1]=a},getBoundEdgeValue:function(e,t){return e.float32View[2*t]},getBoundEdgeEltNum:function(e,t){return e.uint32View[2*t+1]>>1},getBoundEdgeType:function(e,t){return 1&e.uint32View[2*t+1]},intersect:function(e,i,r,n){var a=new t.Vector2;if(!e.intersectBox(this.aabb,void 0,a))return!1;for(var s=new t.Vector3(1/e.direction.x,1/e.direction.y,1/e.direction.z),o=[],l=0,h=0,c=this.aabb.clone();h>=0&&!(n&&n<a.x);)if(r&&r({aabb:c,nodeId:h}),this.isLeafNode(h)){var d=this.getNbElts(h);if(1===d){var u,p=this.getEltIndices(h);if(this.eltsAsBinary){var f=this.renderable.geometry[this.elts[4*p]],g=this.elts[4*p+3];u={dg:f.drawingGroups[this.elts[4*p+1]],primitive:this.elts[4*p+2],offset:4294967295===g?-1:g}}else u=this.elts[p];i&&i(u,h,p)}else for(var m=0;m<d;m++){p=this.eltIndices[this.getEltIndices(h)+m];if(this.eltsAsBinary){f=this.renderable.geometry[this.elts[4*p]],g=this.elts[4*p+3];u={dg:f.drawingGroups[this.elts[4*p+1]],primitive:this.elts[4*p+2],offset:4294967295===g?-1:g}}else u=this.elts[p];i&&i(u,h,p)}if(!(l>0))break;h=o[--l].nodeId,a.copy(o[l].tMinMax),c=o[l].aabb}else{var v,y,S,_,x=this.getSplitAxis(h),b=this.getSplitPosition(h),w=e.origin.getComponent(x),M=(b-w)*s.getComponent(x),C=c.clone(),P=c.clone();C.max.setComponent(x,b),P.min.setComponent(x,b),w<b||w===b&&e.direction.getComponent(x)<=0?(v=h+1,y=this.getAboveChild(h),S=C,_=P):(v=this.getAboveChild(h),y=h+1,S=P,_=C),M>a.y||M<=0?(h=v,c=S):M<a.x?(h=y,c=_):(o[l]={nodeId:y,tMinMax:new t.Vector2(M,a.y),aabb:_},l++,h=v,c=S,a.y=M)}return!1},buildFromMesh:function(e,r,n,a,s,o){this.renderable=e;var l=!n||n.isIdentity(),h=null,c=0,d=new i.SGPrimitiveHelper;if(e.geometry.length>=0?(h=e.geometry[0],c=e.geometry.length):2===e.geometry._type&&(h=e.geometry,c=1),!h||h.vertexIndexArray){for(var u=0,p=1024,f=a||(this.eltsAsBinary?new Uint32Array(4096):[]),g=s||(this.eltsAsBinary?new Float32Array(6144):[]),m=new t.Vector3,v=new t.Vector3,y=new t.Vector3,S=new t.Box3,_=new t.Box3,x=0;x<c;x++){for(var b=h.drawingGroups,w=b.length,M=h.vertexIndexArray,C=0;C<w;C++)for(var P=b[C],E=P.getPrimitivesCount(),A=0;A<E;A++){d.set(P,A);var T=d.getStart(),D=T+d.getCount(),I=this.eltsAsBinary?S:new t.Box3;switch(this.eltsAsBinary&&I.makeEmpty(),P.glType){case 4:case 5:for(var R=T;R<D;R+=3){var O,L,V;if(P.nonIndexed?(O=R,L=R+1,V=R+2):(O=M[R],L=M[R+1],V=M[R+2]),h.getVertexPosition(O,m),h.getVertexPosition(L,v),h.getVertexPosition(V,y),l||(m.applyMatrix4(n),v.applyMatrix4(n),y.applyMatrix4(n)),r)I.expandByPoint(m),I.expandByPoint(v),I.expandByPoint(y);else{var F=this.eltsAsBinary?_:new t.Box3;if(F.setFromPoints([m,v,y]),this.eltsAsBinary){if(u>=p){var B=new Uint32Array(2*p*4),N=new Float32Array(2*p*6);B.set(f),N.set(g),p*=2,f=B,g=N}f[4*u]=x,f[4*u+1]=C,f[4*u+2]=A,f[4*u+3]=R,g[6*u]=F.min.x,g[6*u+1]=F.min.y,g[6*u+2]=F.min.z,g[6*u+3]=F.max.x,g[6*u+4]=F.max.y,g[6*u+5]=F.max.z,u++}else f.push({dg:P,primitive:A,offset:R}),g.push(F)}}}if(r)if(this.eltsAsBinary){if(u>=p){B=new Uint32Array(2*p*4),N=new Float32Array(2*p*6);B.set(f),N.set(g),p*=2,f=B,g=N}f[4*u]=x,f[4*u+1]=C,f[4*u+2]=A,f[4*u+3]=4294967295,g[6*u]=I.min.x,g[6*u+1]=I.min.y,g[6*u+2]=I.min.z,g[6*u+3]=I.max.x,g[6*u+4]=I.max.y,g[6*u+5]=I.max.z,u++}else f.push({dg:P,primitive:A,offset:-1}),g.push(I)}h=e.geometry[x+1]}if(!o){if(this.eltsAsBinary&&u<p){B=new Uint32Array(4*u),N=new Float32Array(6*u);for(var G=0;G<6*u;G++)N[G]=g[G];for(G=0;G<4*u;G++)B[G]=f[G];f=B,g=N}this.buildFast(f,g)}return this}console.warn("kdtree build impossible, make sure noMeshInRAM is inactive")}},t.KDTree=a,a}),define("DS/Visualization/TrackballControls",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Animation/ANIM","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent","DS/VisuEvents/MouseEvent","DS/WebRecordEnabler/Adapter"],function(e,t,i,r,n,a,s,o,l,h,c,d){"use strict";var u=0,p=function(e,i){void 0===o._isInit&&o.init(),this.manipulatedViewList=[i],t.EventTarget.call(this),this.viewpoint=e,this.viewer=e.viewer,this.domElement=void 0!==i?i:document,this.isMac=navigator.platform.toUpperCase().indexOf("MAC")>=0,this.camera=e.camera,this.id=u++,window.DSWebRecord&&o._record_registerObject(this,"TrackballControls"),this.viewer.forceRenderTargetSize?(this.radius=.5*Math.max(this.viewer._getDivClientWidth(),this.viewer._getDivClientHeight()),this.radiusZoom=.25*(this.viewer._getDivClientWidth()+this.viewer._getDivClientHeight())):(this.radius=.5*Math.max(this.domElement.clientWidth,this.domElement.clientHeight),this.radiusZoom=.25*(this.domElement.clientWidth+this.domElement.clientHeight)),this.panSpeed=1,this.rotateSpeed=1,this.zoomSpeed=5,this.lockZ=!1,this.rollingForTouchAvailable=!1,this.lockRotation=!1,this.lockMouseRotation=!1,this.lockTouchRotation=!1,this.lockMouseRotationForSimpleMode=!1,this.lockMouseZoomForCtrlKeyWheelMode=!1,this.lockZoom=!1,this.lockPan=!1,this.lockMouse=!1,this.lockReframe=!1,this.lockReframeOnDblTap=!1,this.lockPreventDefaultForCtrlKeyWheel=!0,this.mouseInertia=!1,this.touchInertia=!0,this.rotateDirection=1,this.lastLockZState=null,this.lockZRotationSpeed=.002,this.target=e.target,this.position=e.position,this.orientation=new t.Quaternion,this.distanceToTarget=700,this._state=p.State.NONE,this._clickTimer=null,this._leftClicking=!1,this._middleClicking=!1,this._rightClicking=!1,this._leftButtonPressed=!1,this._middleButtonPressed=!1,this._rightButtonPressed=!1,this._ctrlKeyPressed=!1,this._shiftKeyPressed=!1,this._clickTolerancy=10,this._blockVptOnHold=!0,this._showSpinnerOnHold=!1,this._pickingCB=!0,this._avatarDistance=0,this._forcePan=!1,this._forceRotate=!1,this._forceZoom=!1,this._forcePanCmd=null,this._forceRotateCmd=null,this._forceZoomCmd=null,this._2DMode=!1,this._lockUpDirection=null,this._lockUpMode=null,this.oldManipActive=!1,this._mode=p.Mode.COMBINED,this._zoomType=p.ZoomType.ZOOM_POS_CHANGE;var r=this;this._onWindowResize=function(e){r._resize(e)},this._onContextMenu=function(e){e.preventDefault()},this._onBlurCB=function(){r._ctrlKeyPressed=!1,r._shiftKeyPressed=!1},this._onDragEndCB=function(e){var t=o._getMouseButton(e.button);let i=new c(t,e);r._onLeftMouseUp({from:[i]})},this.basicEventID=0,this.editEventBeginID=0,this.editEventKOID=0,this.infiniteRender=!1,this._mouseDownPos=null,this._oldCursor="",this._modelEvent=new s,this.attachEvents(),this.setMode(p.Mode.COMBINED),this._createShortHoldSpinner(1,"#3da4e0"),this._customZoomTokens=[],this._customPanTokens=[],this._customRotateTokens=[],this.needsRotationFinalized=!1,this.deltaPosition=null,this.previousTime=0,this.deltaTime=0,this._isIE11=t.IsIE11,this._isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,this._wheelMoving=!1,this._wheelTimer=null,this._flyWalkStateInfo={bActive:!1,forceStopRequests:0,oldControlState:p.State.NONE}};return Object.defineProperty(p.prototype,"_finalizeRotateLockZ",{set:function(e){this._finalizeRotateLockWorldUpVector=e}}),p.Mode={CATIA:0,SIMPLE:1,COMBINED:2,LOOKAROUND:3},p.State={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,FORCE_ROTATE:3,FORCE_ZOOM:4,FORCE_PAN:5,HOLD:6,ZOOM_PAN_ROTATE:7,STOP:8},p.changeEvent={type:"change"},p.prototype.setActive=function(e){e instanceof Object?(void 0!==e.viewpoint&&this._changeState(e.viewpoint?p.State.NONE:p.State.STOP),void 0!==e.picking&&(this._pickingCB=e.picking)):this._changeState(e?p.State.NONE:p.State.STOP)},p.prototype.setMouseActive=function(e){this.lockMouse=!e},p.prototype.setRotationActive=function(e){this.lockRotation=!e},p.prototype.setMouseRotationActive=function(e){this.lockMouseRotation=!e},p.prototype.setTouchRotationActive=function(e){this.lockTouchRotation=!e},p.prototype.setMouseRotationForSimpleModeActive=function(e){this.lockMouseRotationForSimpleMode=!e},p.prototype.setMouseZoomForCtrlKeyWheelActive=function(e){this.lockMouseZoomForCtrlKeyWheelMode=!e},p.prototype.getMouseRotationActive=function(){return this.lockMouseRotation},p.prototype.getTouchRotationActive=function(){return this.lockTouchRotation},p.prototype.setZoomActive=function(e){this.lockZoom=!e},p.prototype.setPanActive=function(e){this.lockPan=!e},p.prototype.setReframeActive=function(e){this.lockReframe=!e},p.prototype.setReframeOnDoubleTap=function(e){this.lockReframeOnDblTap=!e},p.prototype.setRotationRolling=function(e){this.lockZ=!e},p.prototype.setLockUpDirection=function(e,t){this._lockUpDirection=e,this._lockUpMode=t},p.prototype.setNativeGravity=function(e,t,i){0!=e?(this.setRotationRolling(!1),this.setLockUpDirection(t,e)):(this.setRotationRolling(!0),this.setLockUpDirection(null,null))},p.prototype.setRollingForTouchAvailable=function(e){this.rollingForTouchAvailable=e},p.prototype.setPreventDefaultForCtrlKeyWheelActive=function(e){this.lockPreventDefaultForCtrlKeyWheel=!e},p.prototype.setRotationInertia=function(e){void 0!==e.mouse&&(this.mouseInertia=e.mouse),void 0!==e.touch&&(this.touchInertia=e.touch)},p.prototype.setRotationSpeed=function(e){this.rotateSpeed=e,this.lockZRotationSpeed=.0015*e},p.ZoomType={ZOOM_POS_CHANGE:0,ZOOM_FOV_CHANGE:1},p.prototype.setZoomType=function(e){this._zoomType=e},p.prototype.onPan=function(e){if(e){var t=this._modelEvent.subscribe({event:"Pan"},e);return this._customPanTokens.push(t),t}for(var i=0;i<this._customPanTokens.length;i++)this._modelEvent.unsubscribe(this._customPanTokens[i]);this._customPanTokens=[]},p.prototype.onRotate=function(e){if(e){var t=this._modelEvent.subscribe({event:"Rotate"},e);return this._customRotateTokens.push(t),t}for(var i=0;i<this._customRotateTokens.length;i++)this._modelEvent.unsubscribe(this._customRotateTokens[i]);this._customRotateTokens=[]},p.prototype.onZoom=function(e){if(e){var t=this._modelEvent.subscribe({event:"Zoom"},e);return this._customZoomTokens.push(t),t}for(var i=0;i<this._customZoomTokens.length;i++)this._modelEvent.unsubscribe(this._customZoomTokens[i]);this._customZoomTokens=[]},p.prototype.blockViewpointOnHold=function(e){this._blockVptOnHold=e},p.prototype.setSpinnerOnHold=function(e){this._showSpinnerOnHold=e},p.prototype.isCurrentViewpoint=function(){return this.viewpoint.viewer._viewpointManager.getManipulatedViewpoint()==this.viewpoint},p.prototype.isLeftButtonPressed=function(){return this._leftButtonPressed},p.prototype.isMiddleButtonPressed=function(){return this._middleButtonPressed},p.prototype.isRightButtonPressed=function(){return this._rightButtonPressed},p.prototype.isCtrlKeyPressed=function(){return this._ctrlKeyPressed},p.prototype.isShiftKeyPressed=function(){return this._shiftKeyPressed},p.prototype.isLeftClick=function(){return this._leftClicking},p.prototype.isMiddleClick=function(){return this._middleClicking},p.prototype.isRightClick=function(){return this._rightClicking},p.prototype.startLeftClick=function(){var e=this;this._leftClicking=!0,this._clickTimer&&clearTimeout(this._clickTimer),d.isReplaying()||(this._clickTimer=setTimeout(function(){o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(e.viewer,"TrackballControls","TrackballControlCancelLeftClick"),e.cancelLeftClick()},300))},p.prototype.cancelLeftClick=function(){this._leftClicking=!1},p.prototype.cancelMiddleClick=function(){this._middleClicking=!1},p.prototype.cancelRightClick=function(){this._rightClicking=!1},p.prototype.resetLeftClick=function(){this._leftClicking=!1,this._clickTimer&&clearTimeout(this._clickTimer),this._clickTimer=null},p.prototype.getManipulationState=function(){return this._state},p.prototype.isMoving=function(){return this._state!==p.State.NONE&&this._state!==p.State.STOP&&this._state!==p.State.HOLD&&!(this._targetAnim&&!this._targetAnim.isRunning())},p.prototype.updateEditGesture=function(){var e=o._getGesture(document,"onEdit");e&&e.setTimerMouse(this._mode>0?o.getHoldTime():0)},p.prototype.setMode=function(e){void 0!==e&&e!==this._mode&&(this._mode=e,this.updateEditGesture(),this.viewer.trapSelection&&this.viewer.trapSelection.updateMode(this,this._mode))},p.prototype.setDebugEvents=function(e){o.setDebugEvents(e)},p.prototype.attachEvents=function(){this.initGestureCB(),this.domElement.addEventListener("contextmenu",this._onContextMenu,!1),window.addEventListener("blur",this._onBlurCB),window.addEventListener("dragend",this._onDragEndCB)},p.prototype.detachEvents=function(){this.resetGestureCB(),this.domElement.removeEventListener("contextmenu",this._onContextMenu,!1),window.removeEventListener("blur",this._onBlurCB),window.removeEventListener("dragend",this._onDragEndCB)},p.prototype._setCapture=function(){var e=this.viewer?this.viewer.div:null;e&&(!e.setCapture||!(this._isIE11||this._isFirefox&&!e.draggable)||e.tagName&&"input"===e.tagName.toLowerCase()||e.setCapture(!1))},p.prototype._releaseCapture=function(){(this._isIE11||this._isFirefox)&&document.releaseCapture&&document.releaseCapture()},p.prototype.initGestureCB=function(){if(!this.gestureCBReady){var e=this;this._onLeftMouseDownCB=function(t){e._onLeftMouseDown.call(e,t)},this._onMiddleMouseDownCB=function(t){e._onMiddleMouseDown.call(e,t)},this._onRightMouseDownCB=function(t){e._onRightMouseDown.call(e,t)},this._onLeftMouseUpCB=function(t){e._onLeftMouseUp.call(e,t)},this._onMiddleMouseUpCB=function(t){e._onMiddleMouseUp.call(e,t)},this._onRightMouseUpCB=function(t){e._onRightMouseUp.call(e,t)},this._onMouseMoveCB=function(t){e._onMouseMove.call(e,t)},this._onMouseOutCB=function(t){e._onMouseOut.call(e,t)},this._onSwipeCB=function(t){e._onSwipe.call(e,t)},this._onTapCB=function(t){e._onTap.call(e,t)},this._onPinchPanRotateCB=function(t){e._onPinchPanRotate.call(e,t)},this._onDoubleTapCB=function(t){e._onDoubleTap.call(e,t)},this._onDoublePinchTapCB=function(t){e._onDoublePinchTap.call(e,t)},this._onHoldCB=function(t){e._onHold.call(e,t)},this._onTouchCB=function(t){e._onTouch.call(e,t)},this._onReleaseCB=function(t){e._onRelease.call(e,t)},this._onEditCB=function(t){e._onStopManip.call(e,t)},o.addEvent(document,"onLeftMouseDown",this._onLeftMouseDownCB),o.addEvent(document,"onRightMouseDown",this._onRightMouseDownCB),o.addEvent(document,"onLeftMouseUp",this._onLeftMouseUpCB),o.addEvent(document,"onMiddleMouseUp",this._onMiddleMouseUpCB),o.addEvent(document,"onRightMouseUp",this._onRightMouseUpCB),o.addEvent(document,"onMouseMove",this._onMouseMoveCB),o.addEvent(document,"onMouseOut",this._onMouseOutCB),o.addEvent(this.domElement,"onDoubleTap",this._onDoubleTapCB),o.addEvent(this.domElement,"onDoublePinchTap",this._onDoublePinchTapCB),o.addEvent(this.domElement,"onHold",this._onHoldCB),o.addEvent(document,"onRelease",this._onReleaseCB),o.addEvent(document,"onEdit",this._onEditCB),this.updateEditGesture(),this.addViewToGestures(this.domElement),this.viewer&&this.viewer.divCssElement&&this.addViewToManipulation(this.viewer.divCssElement),this.basicEventID=a.subscribe({event:"/VISU/onBasicEvent"},function(t){e._onBasicEvent.call(e,t)}),this.editEventBeginID=a.subscribe({event:"/VISU/onEditEventBegin"},function(t){e._showSpinnerOnHold&&e._onEditEventBegin.call(e,t)}),this.editEventKOID=a.subscribe({event:"/VISU/onEditEventKO"},function(t){e._onEditEventKO.call(e,t)}),this.gestureCBReady=!0}},p.prototype.resetGestureCB=function(){if(this.gestureCBReady){o.removeEvent(document,"onLeftMouseDown",this._onLeftMouseDownCB),o.removeEvent(document,"onRightMouseDown",this._onRightMouseDownCB),o.removeEvent(document,"onLeftMouseUp",this._onLeftMouseUpCB),o.removeEvent(document,"onMiddleMouseUp",this._onMiddleMouseUpCB),o.removeEvent(document,"onRightMouseUp",this._onRightMouseUpCB),o.removeEvent(document,"onMouseMove",this._onMouseMoveCB),o.removeEvent(document,"onMouseOut",this._onMouseOutCB),o.removeEvent(this.domElement,"onDoubleTap",this._onDoubleTapCB),o.removeEvent(this.domElement,"onDoublePinchTap",this._onDoublePinchTapCB),o.removeEvent(this.domElement,"onHold",this._onHoldCB),o.removeEvent(document,"onRelease",this._onReleaseCB),o.removeEvent(document,"onEdit",this._onEditCB);for(var e=0;e<this.manipulatedViewList.length;e++){var t=this.manipulatedViewList[e];this.removeViewFromGestures(t)}a.unsubscribe(this.basicEventID),a.unsubscribe(this.editEventBeginID),a.unsubscribe(this.editEventKOID),this.gestureCBReady=!1}},p.prototype.addViewToGestures=function(e){o.addEvent(e,"onMiddleMouseDown",this._onMiddleMouseDownCB),o.addEvent(e,"onTouch",this._onTouchCB),o.addEvent(e,"onSwipe",this._onSwipeCB),o.addEvent(e,"onPinchPanRotate",this._onPinchPanRotateCB),o.addEvent(e,"onTap",this._onTapCB)},p.prototype.removeViewFromGestures=function(e){o.removeEvent(e,"onMiddleMouseDown",this._onMiddleMouseDownCB),o.removeEvent(e,"onTouch",this._onTouchCB),o.removeEvent(e,"onSwipe",this._onSwipeCB),o.removeEvent(e,"onPinchPanRotate",this._onPinchPanRotateCB),o.removeEvent(e,"onTap",this._onTapCB)},p.prototype.addViewToManipulation=function(e){return-1===this.manipulatedViewList.indexOf(e)&&(this.manipulatedViewList.push(e),this.addViewToGestures(e),!0)},p.prototype.removeViewFromManipulation=function(e){var t=this.manipulatedViewList.indexOf(e);return-1!==t&&(this.manipulatedViewList.splice(t,1),this.removeViewFromGestures(e),!0)},p.prototype.setTarget=function(e){this.target.copy(e)},p.prototype.onMove=function(e){return this._modelEvent.subscribe({event:"ViewpointMove"},e)},p.prototype.unsubscribe=function(e){var t=this._customZoomTokens.indexOf(e);-1!==t?this._customZoomTokens.splice(t,1):-1!==(t=this._customPanTokens.indexOf(e))?this._customPanTokens.splice(t,1):-1!==(t=this._customRotateTokens.indexOf(e))&&this._customRotateTokens.splice(t,1),this._modelEvent.unsubscribe(e)},p.prototype.updateNativeZoom=function(e){if(this.camera.isOrtho&&null!=this.viewpoint._nativeZoomType){this.camera.setVisualizedHeight(e);let t=1/this.viewpoint.getMMInSupportUnit();switch(this.viewpoint._nativeZoomType){case this.viewpoint.NativeZoomTypes.MillimeterScreenBased:this.viewpoint._nativeZoom=this.viewer.SCREEN_HEIGHT*t/(this.camera.top-this.camera.bottom);break;case this.viewpoint.NativeZoomTypes.HalfWindowHeightBased:case this.viewpoint.NativeZoomTypes.HalfWindowWidthAndHeigthBased:this.viewpoint._nativeZoom=2/(this.camera.top-this.camera.bottom)}}},p.prototype.update=function(){var e=this.camera.position.clone(),i=this.camera.quaternion.clone(),r=new t.Vector3(0,0,1),n=!1;if(this.camera.useQuaternion=!0,r.applyQuaternion(this.orientation),r.setLength(this.distanceToTarget),this.camera.position.addVectors(this.target,r),this.camera.isOrtho&&null==this.viewpoint._nativeZoomType&&(this.camera.setVisualizedHeight(this.distanceToTarget),this.camera.updateProjectionMatrix()),null!=this.viewpoint._nativeZoomType){let e=this.viewpoint.updateNative2D(),t=.5*(this.camera.top-this.camera.bottom)/Math.tan(this.camera.fov*Math.PI/360);this.distanceToTarget=t,r.setLength(t);var s=e.clone().sub(r);this.setTarget(s),this.camera.position.addVectors(this.target,r)}this.camera.quaternion.copy(this.orientation),this.camera.up=new t.Vector3(0,1,0),this.camera.up.applyQuaternion(this.orientation),e.sub(this.camera.position),i.sub(this.camera.quaternion),this.position.copy(this.camera.position),this.camera.updateMatrix(),this.camera.matrixWorld.copy(this.camera.matrix),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this.camera.updateProjectionMatrix(),(this.infiniteRender||e.lengthSq()>1e-7||i.lengthSq()>1e-7||this.camera._hasChanged)&&(n=!0,this.dispatchEvent(p.changeEvent),this.viewpoint._updateFrustum(),this._modelEvent.publish({event:"ViewpointMove",context:this}),this._2DMode&&this.viewer.svgRoot&&this.viewer._updateSVGVisu(),this.viewer&&(this.viewer.renderIteration=0)),this.camera._hasChanged=!1;var o={eventChannel:n?"/VISU/":"/VISU/SpriteNodeInit",eventType:"@onViewpointChange",viewpoint:this.viewpoint,cameraEye:this.position,cameraTarget:this.target,cameraUp:this.camera.up};return a.publish({event:n?"/VISU/":"/VISU/SpriteNodeInit",data:o}),n},p.prototype.moveTo=function(e){console.log("TrackballControls.prototype.moveTo is DEPRECATED: use Viewpoint.moveTo instead.");var s,o,l,h={position:e.position,target:e.target||this.target.clone(),orientation:e.orientation||this.orientation.clone(),distanceToTarget:e.distanceToTarget||this.distanceToTarget,duration:e.duration||0};if(e instanceof t.Vector3&&(console.warn("TrackballControls.prototype.moveTo now uses options litteral object as argument."),h.target=arguments[0],arguments[1]&&(h.orientation=arguments[1]),void 0!==arguments[2]&&(h.distanceToTarget=arguments[2]),void 0!==arguments[3]&&(h.duration=arguments[3])),this._targetAnim&&this._targetAnim.stop(),this._orientationAnim&&this._orientationAnim.stop(),this._distanceToTargetAnim&&this._distanceToTargetAnim.stop(),h.position&&e.target){var c=(new t.Vector3).subVectors(e.target,h.position);if(h.distanceToTarget=c.length(),!e.orientation){var d=(new t.Matrix4).lookAt(h.position,e.target,new t.Vector3(0,0,1));h.orientation.setFromRotationMatrix(d)}}else if(h.position){var u=new t.Vector3(0,0,1);u.applyQuaternion(h.orientation),u.setLength(h.distanceToTarget);var p=(new t.Vector3).subVectors(h.position,u);h.target=p}if(0===h.duration)this.setTarget(h.target),this.orientation=h.orientation,this.distanceToTarget=h.distanceToTarget,this.update();else{(s=new r(this.target.clone(),h.target,h.duration)).setInterpolator(function(e,t,i){var r=t.clone();return r.lerp(i,e),r});var f=this;this._targetAnim=new n(this,"setTarget",s,function(e){if(e===i.State.STOPPED){var t={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:f.viewpoint,cameraEye:f.camera.position,cameraUp:f.camera.up};a.publish({event:"/VISU/",data:t})}}),(o=new r(this.orientation,h.orientation,h.duration)).setInterpolator(function(e,i,r){var n=new t.Quaternion;return t.Quaternion.slerp(i,r,n,e),n}),this._orientationAnim=new n(this,"orientation",o),l=new r(this.distanceToTarget,h.distanceToTarget,h.duration),this._distanceToTargetAnim=new n(this,"distanceToTarget",l),this._targetAnim.start(),this._orientationAnim.start(),this._distanceToTargetAnim.start()}},p.prototype.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)},p.prototype.startPan=function(e){this.endRotate(),this.endZoom(),this._forcePan=!0,e&&(this._forcePanCmd=e),this.viewer&&(this.oldManipActive=this.viewer.getManipulators(),this.viewer.setManipulators({activated:!1}),this.viewer.setCursor("Pan",0))},p.prototype.startRotate=function(e){this.endPan(),this.endZoom(),this._forceRotate=!0,e&&(this._forceRotateCmd=e),this.viewer&&(this.oldManipActive=this.viewer.getManipulators(),this.viewer.setManipulators({activated:!1}),this.viewer.setCursor("Rotate",0))},p.prototype.startZoom=function(e){this.endPan(),this.endRotate(),this._forceZoom=!0,e&&(this._forceZoomCmd=e),this.viewer&&(this.oldManipActive=this.viewer.getManipulators(),this.viewer.setManipulators({activated:!1}),this.viewer.setCursor("Zoom",0))},p.prototype.endPan=function(e){this._forcePan&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive}),this._forcePan=!1,this._forcePanCmd&&(this._forcePanCmd.end(!0),this.viewer.setCursor("Auto",0),this._changeState(p.State.NONE),this.viewer.trapSelection&&(this.viewer.trapSelection.isInterrupted=!1))},p.prototype.endRotate=function(e){this._forceRotate&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive}),this._forceRotate=!1,this._forceRotateCmd&&(this._forceRotateCmd.end(!0),this.viewer.setCursor("Auto",0),this._changeState(p.State.NONE),this.viewer.trapSelection&&(this.viewer.trapSelection.isInterrupted=!1))},p.prototype.endZoom=function(e){this._forceZoom&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive}),this._forceZoom=!1,this._forceZoomCmd&&(this._forceZoomCmd.end(!0),this.viewer.setCursor("Auto",0),this._changeState(p.State.NONE),this.viewer.trapSelection&&(this.viewer.trapSelection.isInterrupted=!1))},p.prototype._getMouseProjectionOnBall=function(e){var i,r,n,a;return(r=(i=new t.Vector3((e.x-.5*this.domElement.clientWidth)/this.radius,(.5*this.domElement.clientHeight-e.y)/this.radius,0)).length())>1?i.normalize():i.z=Math.sqrt(1-r*r),n=(new t.Vector3).subVectors(this.camera.position,this.target),(a=new t.Vector3).add(this.camera.up.clone().cross(n).setLength(i.x)),a.add(this.camera.up.clone().setLength(i.y)),a.add(n.clone().setLength(i.z)),a},p.prototype._pan=function(e,t){this.update(),this._doPan(e.x-t.x,e.y-t.y)},p.prototype._doPan=function(e,i){var r,n,a;0===e&&0===i||(r=(new t.Vector3).copy(this.camera.position).sub(this.target),this.camera.isOrtho?n=(this.camera.top-this.camera.bottom)/this.viewer._getDivClientHeight():(n=2*this.distanceToTarget*Math.tan(.5*this.camera.fov*Math.PI/180)/this.viewer._getDivClientHeight(),this._mode===p.Mode.LOOKAROUND&&(n=-n)),(a=new t.Vector3).add(r.clone().cross(this.camera.up).setLength(n*e)),a.add(this.camera.up.clone().setLength(n*i)),this.target.add(a))},p.prototype._rotate=function(e,i){var r,n,a,s,o;this.update(),r=this._getMouseProjectionOnBall(i),n=this._getMouseProjectionOnBall(e),(a=Math.acos(r.dot(n)/(r.length()*n.length())))&&(s=(new t.Vector3).crossVectors(r,n).normalize(),a*=this.rotateSpeed,o=(new t.Quaternion).setFromAxisAngle(s,-a),this.orientation.multiplyQuaternions(o,this.orientation.clone()))},p.prototype._rotateLockZ=function(e,t){this._rotateLockWorldUpVector(e,t)},p.prototype._getAvatarPositionFromCamera=function(e,t){var i=e.clone();return this._avatarDistance>0&&e&&(i=i.add(t.clone().multiplyScalar(this._avatarDistance))),i},p.prototype._getCameraFromAvatarPosition=function(e,t){var i=e.clone();return this._avatarDistance>0&&e&&(i=i.sub(t.clone().multiplyScalar(this._avatarDistance))),i},p.prototype._turnHeadLockWorldUpVector=function(e,i,r){this.update(),this._stopRotation();var n=this.distanceToTarget,a=this.camera.getLookAt(),s=this.camera.up,o=this.camera.position,l=new t.Vector3(0,0,1);"y"===this.viewpoint.getWorldOrientation().upAttribute&&(l=new t.Vector3(0,1,0));var h=this.viewpoint.getAngle()*Math.PI/180,c=o.clone();this._getAvatarPositionFromCamera&&(c=this._getAvatarPositionFromCamera(o,a));var d=-e*h/this.viewer.SCREEN_HEIGHT,u=-i*h/this.viewer.SCREEN_HEIGHT,p=new t.Vector3(0,0,0);p.crossVectors(a,s);var f=l.angleTo(s),g=new t.Vector3(0,0,0);g.crossVectors(l,s),g.dot(p)<0&&(f=-f),f+u>Math.PI/2&&(u=Math.PI/2-f),f+u<-Math.PI/2&&(u=-Math.PI/2-f),p.applyAxisAngle(l,d),a.applyAxisAngle(l,d),0!==u&&a.applyAxisAngle(p,u),s.crossVectors(p,a);var m=new t.Vector3(0,0,0);if(m.crossVectors(a,l),m&&m.length()>.1){var v=s.dot(m);m.setLength(v),m.multiplyScalar(-1),s.add(m),s.normalize()}this._getCameraFromAvatarPosition&&(o=this._getCameraFromAvatarPosition(c,a));var y=o.clone().add(a.clone().multiplyScalar(n)),S=new t.Quaternion,_=new t.Matrix4;_.lookAt(o,y,s),S.setFromRotationMatrix(_),this.setTarget(y),this.orientation=S,this.needsRotationFinalized=!0,this.deltaPosition=r.deltaPosition.clone(),this.previousTime>0&&(this.deltaTime=r.currentTime-this.previousTime),this.previousTime=r.currentTime},p.prototype._finalizeTurnHeadLockWorldUpVector=function(e,a){if(this.update(),this._stopRotation(),this.needsRotationFinalized&&(this.needsRotationFinalized=!1,(!this.viewpoint._viewpointAnimation||this.viewpoint._viewpointAnimation.state()!==i.State.RUNNING)&&!this.lockRotation&&(!a||!this.lockTouchRotation)&&(a||!this.lockMouseRotation))){var s=new t.Vector2;s.copy(this.deltaPosition),s.multiplyScalar(1/this.deltaTime);if(!(s.length()<.3)){s.length()>6&&s.setLength(6);var o=this.distanceToTarget,l=this.camera.position,h=new t.Vector3(0,0,1);"y"===this.viewpoint.getWorldOrientation().upAttribute&&(h=new t.Vector3(0,1,0));var c=this.viewpoint.getAngle()*Math.PI/180,d=this.viewer.SCREEN_HEIGHT,u=new r(0,0,800),p=this.camera.getLookAt(),f=this.camera.up,g=(new t.Quaternion).copy(this.orientation),m=l.clone(),v=l.clone().add(p.clone().multiplyScalar(o)),y=0,S=this;u.setInterpolator(function(e,i,r){var n=m.clone();S._getAvatarPositionFromCamera&&(n=S._getAvatarPositionFromCamera(m,p));var a=s.clone().multiplyScalar(1-e);e*=800;var l=a.x*(e-y),u=a.y*(e-y);y=e;var _=-l*c/d,x=-u*c/d,b=new t.Vector3(0,0,0);b.crossVectors(p,f);var w=h.angleTo(f),M=new t.Vector3(0,0,0);M.crossVectors(h,f),M.dot(b)<0&&(w=-w),w+x>Math.PI/2&&(x=Math.PI/2-w),w+x<-Math.PI/2&&(x=-Math.PI/2-w),b.applyAxisAngle(h,_),p.applyAxisAngle(h,_),0!==x&&p.applyAxisAngle(b,x),f.crossVectors(b,p);var C=new t.Vector3(0,0,0);if(C.crossVectors(p,h),C&&C.length()>.1){var P=f.dot(C);C.setLength(P),C.multiplyScalar(-1),f.add(C),f.normalize()}S._getCameraFromAvatarPosition&&(m=S._getCameraFromAvatarPosition(n,p)),v=m.clone().add(p.clone().multiplyScalar(o));var E=new t.Matrix4;E.lookAt(m,v,f),g.setFromRotationMatrix(E)});var _={me:this,setOrientation:function(e){this.me.setTarget(v),this.me.orientation=g}};this._orientationAnim=new n(_,"setOrientation",u),this._orientationAnim.start()}}},p.prototype._rotateLockWorldUpVector=function(e,t){this.update(),this._stopRotation();var i=this.viewpoint._worldOrientation.upAttribute;if(this._state===p.State.ZOOM_PAN_ROTATE){if(!this.rotateDirection||this._state!==this.lastLockZState)0===(r=+(r=this.camera.getLookAt()[i]))||isNaN(r)?this.rotateDirection=r:this.rotateDirection=r>0?1:-1;this.orientation=this.viewpoint._worldOrientation.getOrientationForLockedRotation(-this.rotateDirection*e*this.lockZRotationSpeed,t*this.lockZRotationSpeed,this.orientation)}else{var r;if(!this.rotateDirection||this._state!==this.lastLockZState)0===(r=+(r=this.camera.up[i]))||isNaN(r)?this.rotateDirection=r:this.rotateDirection=r>0?1:-1;this.orientation=this.viewpoint._worldOrientation.getOrientationForLockedRotation(this.rotateDirection*e*this.lockZRotationSpeed,t*this.lockZRotationSpeed,this.orientation)}this.lastLockZState=this._state,this.needsRotationFinalized=!0},p.prototype._finalizeRotateLockZ=function(e,t){this._finalizeRotateLockWorldUpVector(e,t)},p.prototype._finalizeRotateLockWorldUpVector=function(e,i){this._stopRotation();var a=this.viewpoint._worldOrientation,s=a.upAttribute;a.frontAttribute,a.rightAttribute;if(this.needsRotationFinalized&&!this.lockRotation&&(!i||!this.lockTouchRotation)&&(i||!this.lockMouseRotation)){var o=e.currentTime-e.startTime,l=new t.Vector2;if(l.copy(e.offsetPosition),l.multiplyScalar(.003/o),!(l.length()<1e-7)){l.length()>.01&&l.setLength(.01);var h=(new t.Quaternion).copy(this.orientation),c=l.clone().normalize().multiplyScalar(6e-6),d=l.length()/c.length(),u=new r(0,0,d),p=0,f=this.camera.up[s];p=0===(f=+f)||isNaN(f)?f:f>0?1:-1,u.setInterpolator(function(e,t,i){e*=d;var r=l.x*e-.5*c.x*e*e,n=l.y*e-.5*c.y*e*e;return a.getOrientationForLockedRotation(p*r,n,h)});var g={me:this,setOrientation:function(e){this.me.orientation=e}};this._orientationAnim=new n(g,"setOrientation",u),this._orientationAnim.start(),this.needsRotationFinalized=!1}}},p.prototype._zoom=function(e,i){var r,n;this.update(),r=e.y-i.y,1!==(n=1+(r*=.5/this.radiusZoom)*this.zoomSpeed)&&n>0&&(this._zoomType===p.ZoomType.ZOOM_FOV_CHANGE?this._zoomFOVChange(new t.Vector2(Math.floor(.5*this.viewer.SCREEN_WIDTH),Math.floor(.5*this.viewer.SCREEN_HEIGHT)),n<1,n):this.distanceToTarget*=n),this.updateNativeZoom(this.distanceToTarget)},p.prototype._zoomPanRotate=function(e,i){this.update(),this._stopRotation();var r=e.getEvents(),n=r[0],a=r[1];if(!(this.lockZoom||i&&1!==i)){var s;s=e.distance-e.lastDistance;var o={gesture:e,factor:h=1-(s*=.5/this.radiusZoom)*this.zoomSpeed,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:o,context:this}),o.defaultBehavior&&1!==h&&h>0){var l=(new t.Vector2).addVectors(n.lastPosition,a.lastPosition).multiplyScalar(.5);if(this._zoomType===p.ZoomType.ZOOM_FOV_CHANGE)this._zoomFOVChange(l,h<1,h);else if(this._mode===p.Mode.LOOKAROUND){var h=this._getZoomFOVOnCursorFactorForTwoPointers(n.currentPosition,a.currentPosition,n.lastPosition,a.lastPosition);this._zoomFOVOnCursor(l,h<0,180*h/Math.PI)}else this._zoomSimple(l,h<1,h)}}if(!(this.lockPan||i&&2!==i)){var c,d=n.getCurrentPosition(this.domElement),u=a.getCurrentPosition(this.domElement),f=n.getLastPosition(this.domElement),g=a.getLastPosition(this.domElement);c=.5*(d.x+u.x)-.5*(f.x+g.x),s=.5*(d.y+u.y)-.5*(f.y+g.y);var m={gesture:e,defaultBehavior:!0};this._modelEvent.publish({event:"Pan",data:m,context:this}),m.defaultBehavior&&this._doPan(c,s)}if(!(this.lockRotation||this.lockTouchRotation||i&&3!==i||this._mode===p.Mode.LOOKAROUND)){var v={gesture:e,defaultBehavior:!0};if(this._modelEvent.publish({event:"Rotate",data:v,context:this}),v.defaultBehavior)if(this.rollingForTouchAvailable&&this.lockZ||!this.rollingForTouchAvailable)this._rotateLockWorldUpVector(-200*e.getDeltaAngle(),0);else{d=n.getCurrentPosition(this.domElement),u=a.getCurrentPosition(this.domElement),n.getLastPosition(this.domElement),a.getLastPosition(this.domElement);for(var y=new t.Vector2,S=0;S<2;S++)y.add(r[S].getCurrentPosition(this.domElement)),y.add(r[S].getLastPosition(this.domElement));y.divideScalar(4);var _=e.getDeltaAngle();this._rotateTwoTouch(_,y)}}},p.prototype._intersectLines=function(e,i,r,n){var a=new t.Vector2;a.subVectors(i,e);var s=new t.Vector2;s.subVectors(r,n);var o=a.y,l=-a.x,h=a.x*e.y-a.y*e.x,c=s.y,d=-s.x,u=s.x*r.y-s.y*r.x,p=o*d-l*c;if(0===p)return null;var f=(l*u-h*d)/p,g=-(o*u-h*c)/p;return new t.Vector2(f,g)},p.prototype._rotateTwoTouch=function(e,i){this.update();var r=this.viewpoint.create3DRayFrom2DPoint(i).origin;if(Number.isFinite(e)){var n=this.camera.getLookAt();n.negate();var a=(new t.Quaternion).setFromAxisAngle(n,e),s=this.camera.position,o=(new t.Vector3).subVectors(s,r),l=(new t.Vector3).addVectors(r,o.applyQuaternion(a));this.viewpoint.moveTo({eyePosition:l,orientation:a.multiply(this.orientation.clone())})}},p.prototype._zoomSimpleOnCenter=function(e,t,i){var r;r=void 0!==i?i:t?.9:1.1;var n=this.distanceToTarget*r;this.distanceToTarget=n,this.updateNativeZoom(this.distanceToTarget)},p.prototype._zoomSimple=function(e,i,r){var n,a=new t.Projector,s=this.viewer.getMousePosition(e);n=void 0!==r?r:i?.9:1.1;s=this.viewer.getMousePosition(e);var o=this.camera.getLookAt(),l=this.camera.position,h=this.target.clone().sub(o.clone().multiplyScalar(this.distanceToTarget*n)),c=new t.Vector3(s.x,s.y,.5),d=new t.Vector3(s.x,s.y,.5);a.unprojectVector(c,this.camera);var u=null;if(this.camera instanceof t.OrthographicCamera)this.camera.setVisualizedHeight(this.distanceToTarget*n),a.unprojectVector(d,this.camera),u=c.sub(d);else{var f,g;this.camera.matrixWorld.setPosition(h),a.unprojectVector(d,this.camera),this.camera.matrixWorld.setPosition(l),f=new t.Ray(l,c.clone().sub(l).normalize()),g=new t.Ray(h,d.clone().sub(h).normalize());var m=this.viewpoint.getBoundingSphere(),v=f.at(this.camera.near/f.direction.clone().dot(o)),y=f.direction.clone().dot(m.center.clone().sub(v)),S=Math.max(0,y-m.radius),_=Math.max(0,y+m.radius),x=v.add(f.direction.clone().multiplyScalar(.5*(S+_))),b=o.negate(),w=-b.clone().dot(x),M=new t.Plane(b,w),C=g.intersectPlane(M);u=x.clone().sub(C)}h.add(u);var P=this.distanceToTarget*n;if(this._state===p.State.ZOOM_PAN_ROTATE){var E=this.camera.getLookAt();this.setTarget((new t.Vector3).addVectors(h,E.clone().multiplyScalar(P))),this.distanceToTarget=P,this.update()}else this.viewpoint.moveTo({eyePosition:h,distanceToTarget:P});this.updateNativeZoom(P)},p.prototype._zoomSimpleOnCursor=function(e,i,r){var n;n=void 0!==r?r:i?.9:1.1;var a=this.distanceToTarget*n,s=this.viewer.getMousePosition(e),o=this.camera.getLookAt(),l=this.camera.position,h=new t.Vector3(s.x,s.y,.5),c=new t.Vector3(s.x,s.y,.5),d=new t.Projector;d.unprojectVector(h,this.camera);var u=null;if(this.camera instanceof t.OrthographicCamera){u=this.target.clone().sub(o.clone().multiplyScalar(a)),this.camera.setVisualizedHeight(a),d.unprojectVector(c,this.camera);var p=h.sub(c);u.add(p)}else{p=(new t.Vector3).subVectors(h,l).normalize().multiplyScalar(this.distanceToTarget-a);u=this.camera.position.clone().add(p)}this.viewpoint.moveTo({eyePosition:u,distanceToTarget:a}),this.updateNativeZoom(a)},p.prototype._getZoomFOVAngle=function(e,i){var r=this.viewer.getMousePosition(i),n=this.viewer.getMousePosition(e),a=new t.Vector3(r.x,r.y,.5),s=new t.Vector3(n.x,n.y,.5),o=new t.Projector;o.unprojectVector(a,this.camera),o.unprojectVector(s,this.camera);var l=this.camera.position,h=a.clone().sub(l),c=s.clone().sub(l);return h.angleTo(c)},p.prototype._getZoomFOVOnCursorFactorForOnePointer=function(e,t){var i=e,r=t;i.x=r.x;var n=this._getZoomFOVAngle(i,r);return r.y<i.y&&(n=-n),2*n},p.prototype._getZoomFOVOnCursorFactorForTwoPointers=function(e,t,i,r){var n=this._getZoomFOVAngle(r,i);return this._getZoomFOVAngle(t,e)-n},p.prototype._zoomFOVOnCursor=function(e,i,r){var n=4;n=void 0!==r?-r:i?-n:n;var a=null;e&&(a=this.viewer.getMousePosition(e));var s=this.distanceToTarget,o=this.camera.getLookAt(),l=this.camera.position,h=this.camera.up,c=new t.Vector3(0,0,1);"y"===this.viewpoint.getWorldOrientation().upAttribute&&(c=new t.Vector3(0,1,0));var d=this.viewer.SCREEN_WIDTH,u=this.viewer.SCREEN_HEIGHT,p=this.viewpoint.getAngle(),f=null;if(!(p>=100&&n>=0||p<=20&&n<=0)){if((f=p+n)>100?f=100:f<20&&(f=20),a){var g=.03*n,m=.03*n*u/d,v=a.x/2*g,y=-a.y/2*m,S=new t.Vector3(0,0,0);S.crossVectors(o,h);var _=c.angleTo(h),x=new t.Vector3(0,0,0);x.crossVectors(c,h),x.dot(S)<0&&(_=-_),_+y>Math.PI/2&&(y=Math.PI/2-_),_+y<-Math.PI/2&&(y=-Math.PI/2-_),S.applyAxisAngle(c,v),o.applyAxisAngle(c,v),0!==y&&o.applyAxisAngle(S,y),h.crossVectors(S,o)}var b=new t.Vector3(0,0,0);if(b.crossVectors(o,c),b&&b.length()>.1){var w=h.dot(b);b.setLength(w),b.multiplyScalar(-1),h.add(b),h.normalize()}var M=l.clone().add(o.clone().multiplyScalar(s)),C=new t.Quaternion,P=new t.Matrix4;P.lookAt(l,M,h),C.setFromRotationMatrix(P),a&&(this.setTarget(M),this.orientation=C),this.viewpoint.setAngle(f),this.camera.updateProjectionMatrix(),this.camera._hasChanged=!0}},p.prototype._zoomFOVChange=function(e,i,r){var n,a=new t.Projector,s=this.viewer.getMousePosition(e);n=void 0!==r?r:i?.9:1/.9;s=this.viewer.getMousePosition(e);var o=this.camera.getLookAt(),l=this.camera.position,h=l.clone(),c=new t.Vector3(s.x,s.y,.5),d=new t.Vector3(s.x,s.y,.5);a.unprojectVector(c,this.camera);var u,p,f,g,m=this.viewpoint.getBoundingSphere(),v=this.viewpoint.getAngle()/2,y=o.clone().dot(m.center.clone().sub(l)),S=2*m.radius;if(y<S){var _=y-S,x=o.clone().multiplyScalar(_),b=Math.tan(t.Math.degToRad(.5*this.viewpoint.getAngle())),w=t.Math.radToDeg(Math.atan(b*(y+_)/y));w>22.5||w<0?w=22.5:(l.add(x),h=l.clone()),v=w,this.viewpoint.setAngle(2*w),this.camera.updateProjectionMatrix(),y=S}if(i){E=v*n;var M=n;if(y>S){var C=y-S,P=S/y;if(P<n)C=y-y*n,M=1;else M=E/(v*P);C>0&&h.add(o.clone().multiplyScalar(C))}1!=M&&(this.viewpoint.setAngle(M*v*2),this.camera.updateProjectionMatrix())}else{var E,A=1;if(v<22.5)(E=v*n)>22.5?(this.viewpoint.setAngle(45),A=E/22.5):this.viewpoint.setAngle(2*E),this.camera.updateProjectionMatrix();else A=n;if(1!=A){var T=A*y;x=o.clone().multiplyScalar(y-T);h.add(x)}}g=this.target.clone().sub(h).length(),this.camera.matrixWorld.setPosition(h),a.unprojectVector(d,this.camera),this.camera.matrixWorld.setPosition(l),p=new t.Ray(l,c.clone().sub(l).normalize()),f=new t.Ray(h,d.clone().sub(h).normalize());var D=p.at(this.camera.near/p.direction.clone().dot(o)),I=p.direction.clone().dot(m.center.clone().sub(D)),R=Math.max(0,I-m.radius),O=Math.max(0,I+m.radius),L=D.add(p.direction.clone().multiplyScalar(.5*(R+O))),V=o.negate(),F=-V.clone().dot(L),B=new t.Plane(V,F),N=f.intersectPlane(B);u=L.clone().sub(N),h.add(u),this.viewpoint.setAngle(Math.min(this.viewpoint.getAngle(),45)),this.camera instanceof t.OrthographicCamera&&this.camera.setVisualizedHeight(g),this.camera._hasChanged=!0,this.viewpoint.moveTo({eyePosition:h,distanceToTarget:g})},p.prototype._mouseWheel=function(e){e.event.preventDefault();var t=UWA.Event.wheelDelta(e.getJSEvent());this.isMac&&(t*=-1);var i={evt:e,factor:t,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:i,context:this}),this.isCurrentViewpoint()){var r=this;if(this._wheelMoving=!0,this._wheelTimer&&clearTimeout(this._wheelTimer),this._wheelTimer=setTimeout(function(){r._wheelMoving=!1,clearTimeout(r._wheelTimer),r._wheelTimer=null},300),i.defaultBehavior){var n=!1;if(this.lockMouseZoomForCtrlKeyWheelMode){var a=e.getJSEvent();a&&!0===a.ctrlKey&&(n=!0)}this._zoomType===p.ZoomType.ZOOM_FOV_CHANGE?!this.lockZoom&&!n&&this._zoomFOVChange(e.getCurrentPosition(this.domElement),t>0):this._mode===p.Mode.LOOKAROUND?this.lockZoom:!this.lockZoom&&!n&&this._zoomSimple(e.getCurrentPosition(this.domElement),t>0)}}},p.prototype._resize=function(e,t){this.radius=.5*Math.max(e,t),this.radiusZoom=.25*(e+t)},p.prototype._stopRotation=function(e){this._orientationAnim&&this._orientationAnim.stop()},p.prototype._changeState=function(e){var t=this._state;switch(this._state===p.State.NONE&&(this._oldCursor=this.viewer.getCursor()),this.rotateDirection=0,this._state=e,e){case p.State.ZOOM:case p.State.FORCE_ZOOM:!this.lockZoom&&this.viewer.setCursor("Zoom",100);break;case p.State.PAN:case p.State.FORCE_PAN:!this.lockPan&&this.viewer.setCursor("Pan",100);break;case p.State.ROTATE:case p.State.FORCE_ROTATE:!this.lockRotation&&this.viewer.setCursor("Rotate",100);break;case p.State.HOLD:break;default:this.viewer.setCursor(this._oldCursor,0,!0)}if(this.viewpoint){var i=e!==p.State.NONE&&e!==p.State.HOLD&&e!==p.State.STOP;if(this.viewpoint._isMoving===i)return;this.viewpoint._isMoving=i;var r={eventChannel:"/VISU/",eventType:i?"@onViewpointBeginMove":"@onViewpointEndMove",viewpoint:this.viewpoint,cameraEye:this.viewpoint.camera.position,cameraUp:this.viewpoint.camera.up,from:"controller"};a.publish({event:"/VISU/",data:r})}!d.isRecording()||this._state!==p.State.NONE||this._state===t||this.isLeftClick()||this.isRightClick()||(window.WebVisuCurrentGesture.highLevelRecordJSON||(window.WebVisuCurrentGesture.highLevelRecordJSON={}),window.WebVisuCurrentGesture.highLevelRecordJSON.TrackBallControls={name:this._recordRegisterName,setViewPoint:this.positionToJSON()})},p.prototype._onBasicEvent=function(e){if(e.from)for(var t=0;t<e.from.length;t++){var i=e.from[t],r=i.getType(),n=i.getState();if("Keyboard"===r){var a=i.getKey();if(n===l.State.BEGIN){if(a===l.KeyboardKey.CTRL&&(this._ctrlKeyPressed=!0),a===l.KeyboardKey.SHIFT)if(this._shiftKeyPressed=!0,this._mode>0)(s=o._getGesture(document,"onEdit"))&&s.setTimerMouse(0);this._mode>0&&this._ctrlKeyPressed&&this._state===p.State.ROTATE&&this._changeState(p.State.FORCE_PAN)}else if(n===l.State.END){var s;if(a===l.KeyboardKey.CTRL&&(this._ctrlKeyPressed=!1),a===l.KeyboardKey.SHIFT)if(this._shiftKeyPressed=!1,this._mode>0)(s=o._getGesture(document,"onEdit"))&&s.setTimerMouse(o.getHoldTime());this._mode>0&&(this._ctrlKeyPressed||this._state!==p.State.PAN||this.isCurrentViewpoint()&&this._changeState(p.State.ROTATE))}o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this,"TrackballControls","UpdateControlKeys",{ctrl:this._ctrlKeyPressed,shift:this._shiftKeyPressed})}else if("Mouse"===r){if(this.lockMouse)continue;var h=i.button;if(n===l.State.BEGIN){var c=!1;if(h!==l.MouseButton.MIDDLE&&h!==l.MouseButton.WHEEL||!i.isInView(this.manipulatedViewList)||(c=!0,i.getJSEvent().stopPropagation&&i.getJSEvent().stopPropagation()),h===l.MouseButton.WHEEL&&this._mode>0&&i.isInView(this.manipulatedViewList)&&this._state!==p.State.STOP&&this._mouseWheel(i),!c||h===l.MouseButton.WHEEL&&this._mode===p.Mode.CATIA){if(c&&!this.lockPreventDefaultForCtrlKeyWheel&&h===l.MouseButton.WHEEL){var d=i.getJSEvent();d&&!0===d.ctrlKey&&UWA.Event.preventDefault(i.getJSEvent())}}else UWA.Event.preventDefault(i.getJSEvent())}else n===l.State.MOVE&&i.offsetPosition.length()>this._clickTolerancy&&(h===l.MouseButton.LEFT&&this._leftButtonPressed&&(this._leftClicking&&o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelLeftClick"),this.resetLeftClick()),h===l.MouseButton.MIDDLE&&this._middleButtonPressed&&(this._middleClicking&&o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelMiddleClick"),this._middleClicking=!1),h===l.MouseButton.RIGHT&&this._rightButtonPressed&&(this._rightClicking&&o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelRightClick"),this._rightClicking=!1))}}},p.prototype._onEditEventBegin=function(e){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){var i=t instanceof h;if(this._mode>0||i){var r=t.getCurrentPosition(this.domElement),n=i?80:40;this._setPositionSpinner(this.ShortHoldSpinner,r,n),this._shortHoldCircleAnim=this._showSpinner(this.ShortHoldSpinner,this.SVGCircle,n,6)}}},p.prototype._onEditEventKO=function(e){this._hideSpinner(this.ShortHoldSpinner,this._shortHoldCircleAnim)},p.prototype._onLeftMouseDown=function(e){if(!this.handleRecordData(e)&&!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}var r=t.isInView(this.manipulatedViewList);if(this._publishWUXEvent("PrimaryPointerDown",e,!1),this._leftButtonPressed=!0,this.startLeftClick(),this.isCurrentViewpoint()){this._mouseDownPos=this.viewer.getMousePosition(t.getCurrentPosition(this.viewer.canvas));var n=this._forcePan||this._forceRotate||this._forceZoom;this._state===p.State.STOP||this._state===p.State.HOLD&&!n?this._pickingCB&&this.viewer&&this.viewer.leftMouseDownCB&&this.viewer.leftMouseDownCB(t,this):(r&&n&&(this._state===p.State.NONE||this._state===p.State.HOLD)?(this._setCapture(),this._forcePan?this._changeState(p.State.FORCE_PAN):this._forceRotate?this._changeState(p.State.FORCE_ROTATE):this._forceZoom&&this._changeState(p.State.FORCE_ZOOM)):this._2DMode&&this._mode>0?r&&(this._setCapture(),this._changeState(p.State.PAN)):this._mode===p.Mode.SIMPLE?r&&!this.lockMouseRotationForSimpleMode&&(this._setCapture(),this._changeState(p.State.ROTATE)):this._mode===p.Mode.LOOKAROUND?r&&(this._setCapture(),this._changeState(p.State.ROTATE)):(this._state!==p.State.PAN&&this._state!==p.State.ZOOM||(r&&this._setCapture(),this._changeState(p.State.ROTATE)),this._mode===p.Mode.CATIA&&this.viewer.trapSelection&&this.viewer.trapSelection.interrupt(),this._mode!==p.Mode.COMBINED||!r||this.lockRotation||this.lockMouseRotationForSimpleMode||(this._setCapture(),this._changeState(p.State.ROTATE))),this._pickingCB&&this.viewer&&this.viewer.leftMouseDownCB&&(this.viewer.leftMouseDownCB(t,this),this.viewer.trapSelection&&n&&this.viewer.trapSelection.softInterrupt()),this.tagEventIfModeNotNONE(e))}}}},p.prototype._onMiddleMouseDown=function(e){if(!this.handleRecordData(e)&&!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}t.isInView(this.manipulatedViewList)&&this._setCapture(),this._middleButtonPressed=!0,this._middleClicking=!0,this.isCurrentViewpoint()&&(this._state!==p.State.STOP&&this._state!==p.State.HOLD?(this._mode>0?this._changeState(p.State.PAN):this._state===p.State.NONE&&(this._leftButtonPressed||this._rightButtonPressed||this._changeState(p.State.PAN)),this._pickingCB&&this.viewer&&this.viewer.centerMouseDownCB&&this.viewer.centerMouseDownCB(t,this),this.tagEventIfModeNotNONE(e)):this._pickingCB&&this.viewer&&this.viewer.centerMouseDownCB&&this.viewer.centerMouseDownCB(t,this))}}},p.prototype._onRightMouseDown=function(e){if(!this.handleRecordData(e)&&!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}t.isInView(this.manipulatedViewList)&&this._setCapture(),this._rightClicking=!0,this._rightButtonPressed=!0,this.isCurrentViewpoint()&&this._state!==p.State.STOP&&this._state!==p.State.HOLD&&(this._mode===p.Mode.LOOKAROUND?this._changeState(p.State.ZOOM):this._mode>0&&this._state===p.State.NONE?t.isInView(this.manipulatedViewList)&&this._changeState(p.State.ZOOM):this._state!==p.State.PAN&&this._state!==p.State.ZOOM||this._changeState(p.State.ROTATE),this.tagEventIfModeNotNONE(e))}}},p.prototype._onLeftMouseUp=function(e){if(this.handleRecordData(e))return this._leftButtonPressed=!1,void(this._mouseDownPos=null);if(!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}if(this._releaseCapture(),this._publishWUXEvent("PrimaryPointerUp",e,!1),this._leftButtonPressed=!1,this.isCurrentViewpoint()){if(this._state===p.State.STOP)return this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),void this.resetLeftClick();this._state===p.State.FORCE_PAN||this._state===p.State.FORCE_ROTATE||this._state===p.State.FORCE_ZOOM?this._changeState(p.State.NONE):this._mode===p.Mode.SIMPLE?this._changeState(p.State.NONE):this._2DMode&&this._mode===p.Mode.COMBINED?this._changeState(p.State.NONE):this._state===p.State.HOLD?this._changeState(p.State.NONE):this._state===p.State.ROTATE&&(this._mode===p.Mode.CATIA||this._mode===p.Mode.COMBINED&&this._middleButtonPressed?this._rightButtonPressed||this._changeState(p.State.ZOOM):(this._mode===p.Mode.LOOKAROUND?this.mouseInertia&&!this.lockMouseRotationForSimpleMode&&this._finalizeTurnHeadLockWorldUpVector&&this._finalizeTurnHeadLockWorldUpVector(t,!1):this.mouseInertia&&!this.lockMouseRotationForSimpleMode&&this.lockZ&&this._finalizeRotateLockWorldUpVector&&this._finalizeRotateLockWorldUpVector(t,!1),this._changeState(p.State.NONE))),this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),this.resetLeftClick(),this._mouseDownPos=null,this.tagEventIfModeNotNONE(e)}else this.resetLeftClick()}}},p.prototype._onMiddleMouseUp=function(e){if(this.handleRecordData(e))return this._middleButtonPressed=!1,void(this._middleClicking=!1);if(!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}this._releaseCapture();var r=t.isInView(this.manipulatedViewList);if(this._middleButtonPressed=!1,this.isCurrentViewpoint()){if(t.currentTime-t.startTime>300&&(this._middleClicking=!1),this._state===p.State.STOP)return r&&this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB&&this.viewer.centerMouseUpCB(t,this),void(this._middleClicking=!1);this._changeState(p.State.NONE),r&&this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB&&this.viewer.centerMouseUpCB(t,this),this._middleClicking=!1,this.tagEventIfModeNotNONE(e)}else this._middleClicking=!1}}},p.prototype._onRightMouseUp=function(e){if(this.handleRecordData(e))return this._rightButtonPressed=!1,void(this._rightClicking=!1);if(!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}if(this._releaseCapture(),this._rightButtonPressed=!1,this.isCurrentViewpoint()){if(this._state===p.State.STOP)return this._pickingCB&&this.viewer&&this.viewer.rightMouseUpCB&&this.viewer.rightMouseUpCB(t,this),void(this._rightClicking=!1);this._mode>0&&this._state===p.State.ZOOM?this._changeState(p.State.NONE):this._state===p.State.HOLD?this._changeState(p.State.NONE):this._state===p.State.ROTATE&&(this._mode===p.Mode.CATIA||this._mode===p.Mode.COMBINED&&this._middleButtonPressed?this._leftButtonPressed||this._changeState(p.State.ZOOM):(this.mouseInertia&&!this.lockMouseRotationForSimpleMode&&this.lockZ&&this._finalizeRotateLockWorldUpVector&&this._finalizeRotateLockWorldUpVector(t,!1),this._changeState(p.State.NONE),this.endRotate())),this._pickingCB&&this.viewer&&this.viewer.rightMouseUpCB&&this.viewer.rightMouseUpCB(t,this),this._rightClicking=!1,this.tagEventIfModeNotNONE(e)}else this._rightClicking=!1}}},p.prototype._onMouseMove=function(e){if(!this.handleRecordData(e)&&!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t&&(this._state===p.State.STOP||this._state===p.State.NONE||t.event._simul||0!==t.event.buttons||this._changeState(p.State.NONE),this._publishWUXEvent("PrimaryPointerMove",e,!0),this.isCurrentViewpoint())){if(this._state!==p.State.STOP&&this._state!==p.State.HOLD){for(var i=t.getCurrentPosition(this.domElement),r=t.getLastPosition(this.domElement),n=0;n<e.from.length;n++){var a=e.from[n];if(a.getButton&&a.getButton()!==l.MouseButton.NONE){i=a.getCurrentPosition(this.domElement),r=a.getLastPosition(this.domElement);break}}if(!d.isReplaying())if(this.lockPan||this._state!==p.State.PAN&&this._state!==p.State.FORCE_PAN)if(this.lockRotation||this.lockMouseRotation||this._state!==p.State.ROTATE&&this._state!==p.State.FORCE_ROTATE){if(!this.lockZoom&&(this._state===p.State.ZOOM||this._state===p.State.FORCE_ZOOM)){var s={gesture:e.gesture,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:s,context:this}),s.defaultBehavior)if(this._mode===p.Mode.LOOKAROUND){var o=this._getZoomFOVOnCursorFactorForOnePointer(i,r);this._zoomFOVOnCursor(null,o<0,180*o/Math.PI)}else this._zoom(i,r)}}else{var h={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Rotate",data:h,context:this}),h.defaultBehavior&&(this._mode===p.Mode.LOOKAROUND?this._turnHeadLockWorldUpVector(i.x-r.x,i.y-r.y,t):this.lockZ?this._rotateLockWorldUpVector(i.x-r.x,i.y-r.y):this._rotate(i,r))}else{var c={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Pan",data:c,context:this}),c.defaultBehavior&&this._pan(i,r)}this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB&&this.viewer.mouseMoveCB(t,this),this.tagEventIfModeNotNONE(e)}else this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB&&this.viewer.mouseMoveCB(t,this)}}},p.prototype._onMouseOut=function(e){if(!this.handleRecordData(e)&&!this.lockMouse&&(this._leftButtonPressed=!1,this._rightButtonPressed=!1,this._middleButtonPressed=!1,this.isCurrentViewpoint())){var t=e.from&&e.from.length?e.from[0]:null;if(t){var i=t.getJSEvent(),r=i.target;if(r||(r=i.srcElement),r!==this.viewer.canvas)return;for(var n=i.toElement;n;){if(n===this.viewer.divCssElement)return;n=n.parentNode}}this._state!==p.State.STOP&&this._changeState(p.State.NONE),this.tagEventIfModeNotNONE(e)}},p.prototype._onSwipe=function(e){if(!this.handleRecordData(e)){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t&&(this._publishWUXEvent("PrimaryPointerMove",e,!0),this.isCurrentViewpoint()&&(this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB&&this.viewer.mouseMoveCB(t,this),this._state!==p.State.STOP&&this._state!==p.State.HOLD))){var i=t.currentPosition,r=t.lastPosition;if(this.lockPan||this._state!==p.State.FORCE_PAN)if(this.lockRotation||this.lockTouchRotation||this._state!==p.State.ROTATE&&this._state!==p.State.FORCE_ROTATE){if(!this.lockZoom&&this._state===p.State.FORCE_ZOOM){var n={gesture:e.gesture,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:n,context:this}),n.defaultBehavior)if(this._mode===p.Mode.LOOKAROUND){var a=this._getZoomFOVOnCursorFactorForOnePointer(i,r);this._zoomFOVOnCursor(null,a<0,180*a/Math.PI)}else this._zoom(i,r)}}else{var s={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Rotate",data:s,context:this}),s.defaultBehavior&&(this._mode===p.Mode.LOOKAROUND?this._turnHeadLockWorldUpVector(i.x-r.x,i.y-r.y,t):this.rollingForTouchAvailable&&this.lockZ||!this.rollingForTouchAvailable?this._rotateLockWorldUpVector(i.x-r.x,i.y-r.y):this._rotate(i,r))}else{var o={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Pan",data:o,context:this}),o.defaultBehavior&&this._pan(i,r)}this.tagEventIfModeNotNONE(e)}}},p.prototype._onTap=function(e){if(!this.handleRecordData(e)){var t=e.from&&e.from.length?e.from[0]:null;null!==t&&this.isCurrentViewpoint()&&(this.startLeftClick(),this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),this.resetLeftClick(),this.tagEventIfModeNotNONE(e))}},p.prototype._onDoubleTap=function(e){if(!this.handleRecordData(e)){var t=e.from&&e.from.length?e.from[0]:null;null!==t&&this.isCurrentViewpoint()&&(this._middleClicking=!0,this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB&&this.viewer.centerMouseUpCB(t,this),this._middleClicking=!1,this.tagEventIfModeNotNONE(e))}},p.prototype._onDoublePinchTap=function(e){if(!this.handleRecordData(e)&&!this.lockReframe){var t=e.gesture.getEvents();if(t.length&&this.isCurrentViewpoint()&&this._state!==p.State.STOP){this._stopRotation();var i=this.viewer.getMousePosition(t[0].currentPosition),r=this.viewer.pick(i,"mesh",!1),n=null;if(r.length){var a=r.path[0]._getRenderableOccurrences();a.length&&(n=a[0])}this.viewpoint.reframe(null,void 0,n),this.tagEventIfModeNotNONE(e)}}},p.prototype._onHold=function(e){this.handleRecordData(e)||this.isCurrentViewpoint()&&((2===o.debugEvents||o.debugEvents>=4)&&console.log(data),this.tagEventIfModeNotNONE(e))},p.prototype._onStopManip=function(e){this.handleRecordData(e)||this._blockVptOnHold&&this.isCurrentViewpoint()&&(this._state!==p.State.STOP&&this._state!==p.State.FORCE_PAN&&this._state!==p.State.FORCE_ZOOM&&this._state!==p.State.FORCE_ROTATE&&this._changeState(p.State.HOLD),this.tagEventIfModeNotNONE(e))},p.prototype._onPinchPanRotate=function(e,t){if(!this.handleRecordData(e)){var i=e.gesture;this.isCurrentViewpoint()&&this._state!==p.State.HOLD&&this._state!==p.State.STOP&&"end"!==e.state&&(this._changeState(p.State.ZOOM_PAN_ROTATE),this._zoomPanRotate(i,t),this.tagEventIfModeNotNONE(e))}},p.prototype._onTouch=function(e){this.handleRecordData(e)||(this._publishWUXEvent("PrimaryPointerDown",e,!1),this.isCurrentViewpoint()&&this._state!==p.State.HOLD&&this._state!==p.State.STOP&&(this._forcePan?this._changeState(p.State.FORCE_PAN):this._forceRotate?this._changeState(p.State.FORCE_ROTATE):this._forceZoom?this._changeState(p.State.FORCE_ZOOM):this.lockTouchRotation||this._changeState(p.State.ROTATE),this.tagEventIfModeNotNONE(e)))},p.prototype._onRelease=function(e){if(!this.handleRecordData(e)){var t=e.from&&e.from.length?e.from[0]:null;null!==t&&(this._publishWUXEvent("PrimaryPointerUp",e,!1),this.isCurrentViewpoint()&&(this._state!==p.State.STOP?(this._state!==p.State.ROTATE&&this._state!==p.State.ZOOM_PAN_ROTATE||(this._mode===p.Mode.LOOKAROUND?this._finalizeTurnHeadLockWorldUpVector(t,!0):this.touchInertia&&this._finalizeRotateLockWorldUpVector&&this._finalizeRotateLockWorldUpVector(t,!0)),this._state===p.State.HOLD&&this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),this._changeState(p.State.NONE),this.tagEventIfModeNotNONE(e)):this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this)))}},p.prototype._publishWUXEvent=function(e,t,i){var r={eventChannel:"/VISU/",eventType:"@on"+e,eventID:"",from:t.from};a.publish({event:"/VISU/on"+e,data:r}),(!i&&(2===o.debugEvents||o.debugEvents>=4)||i&&o.debugEvents>=3)&&console.log(r)},p.prototype._createShortHoldSpinner=function(e,t){var i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("id","svgNode"),i.style.position="absolute",i.style.top=0,i.style.left=0,i.style.right=0,i.style.bottom=0,i.style.setProperty("pointer-events","none"),i.style.setProperty("z-index",1e4);var r=document.createElementNS("http://www.w3.org/2000/svg","circle");r.setAttribute("id","svgCircle"),r.setAttribute("fill","none"),r.style.fill="none",r.style.stroke=t,r.style.setProperty("stroke-linecap","square"),e?(this.SVGCircle=r,this.ShortHoldSpinner=i):(this.SVGCircleLarge=r,this.ShortHoldSpinnerLarge=i),i.appendChild(r),this.viewer.div.appendChild(i)},p.prototype._showSpinner=function(e,t,i,r){var a=i-.5*r;e.style.display="block",e.setAttribute("width",2*i+"px"),e.setAttribute("height",2*i+"px"),t.setAttribute("cx",i),t.setAttribute("cy",i),t.setAttribute("r",a),t.setAttribute("transform","rotate(-90, "+i+","+i+")"),t.style.setProperty("stroke-width",r),t.style.setProperty("stroke-dasharray",2*Math.PI*a+1),t.style.setProperty("stroke-dashoffset",2*Math.PI*a+1);var s=!0,l=2*Math.PI*a+1,h=new n({circle:t,setOffset:function(t){t===l?s&&(e.style.display="none",s=!1):(s||(e.style.display="block",s=!0),this.circle.style.setProperty("stroke-dashoffset",t))}},"setOffset",new function(e,t,i,r,n){this._nbLoops=1,this._duration=i,this.duration=function(){return this._duration},this.valueAt=function(i){var a=this._duration,s=i%a/a;if(s>=0&&s<r)return e;if(s<1-n){var o=(s-r)/(1-r-n);return e*(1-o)+t*o}return t}}(l,0,1.2*o.getHoldTime(),.6,0));return h.start(),h},p.prototype._hideSpinner=function(e,t){t&&t.stop(),e.style.display="none"},p.prototype._setPositionSpinner=function(e,t,i){e.style.left=t.x-i+"px",e.style.top=t.y-i+"px"},p.prototype._setCursor=function(t){var i="auto";if("Auto"!==t){var r=e.getWebappsAssetUrl("Visualization","")+"icons/";i="url('"+r+"WebViewer"+t+".png'), url('"+r+"WebViewer"+t+".cur'), auto"}this.viewer.canvas.style.cursor=i},p.prototype.tagEventIfModeNotNONE=function(e){d.isRecording()&&this._state!==p.State.NONE&&e.gesture&&(e.gesture.highLevelRecordJSON||(e.gesture.highLevelRecordJSON={}),e.gesture.highLevelRecordJSON.TrackBallControls={ignore:!0})},p.prototype.handleRecordData=function(e){if(d.isReplaying()&&this.testRecordMoveViewpoint(e))return!0},p.prototype.getRecordData=function(e,t){var i=e.gesture&&e.gesture.highLevelRecordJSON&&e.gesture.highLevelRecordJSON.TrackBallControls;return i&&(!i.name||i.name===this._recordRegisterName)&&i[t]},p.prototype.testRecordMoveViewpoint=function(e){if(this.getRecordData(e,"setViewPoint")){var t=this.getRecordData(e,"setViewPoint");return this.setPositionFromJSON(t),this.viewer.render(),!0}return!1},p.prototype.positionToJSON=function(){return{target:this.target.createJSON(),orientation:this.orientation.createJSON(),distanceToTarget:this.distanceToTarget}},p.prototype.setPositionFromJSON=function(e){this.target.setFromJSON(e.target),this.orientation.setFromJSON(e.orientation),this.distanceToTarget=e.distanceToTarget},p.prototype.setFlyWalkState=function(e){e?(this._flyWalkStateInfo.oldControlState=this._state,this._flyWalkStateInfo.forceStopRequests||this._changeState(p.State.STOP)):this._flyWalkStateInfo.bActive&&this._changeState(this._flyWalkStateInfo.oldControlState),this._flyWalkStateInfo.bActive=!!e},p.prototype.setForceFlyWalkState=function(e){e?(this._flyWalkStateInfo.forceStopRequests++,this._flyWalkStateInfo.bActive&&1===this._flyWalkStateInfo.forceStopRequests&&this._changeState(this._flyWalkStateInfo.oldControlState)):(this._flyWalkStateInfo.forceStopRequests--,this._flyWalkStateInfo.bActive&&!this._flyWalkStateInfo.forceStopRequests&&(this._flyWalkStateInfo.oldControlState=this._state,this._changeState(p.State.STOP)))},p.prototype.isFlyWalkForcedStop=function(){return this._flyWalkStateInfo.forceStopRequests>0},p.prototype.getFlyWalkStateInfo=function(){return this._flyWalkStateInfo},p}),define("Visualization/TrackballControls",["DS/Visualization/TrackballControls","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/TrackballControls"),e}),define("DS/Visualization/ClippingPolyLineData",["DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/PolyLineSectionUtils"],function(e,t){"use strict";function i(e){this.polyLines=null,this.clippingPolygonTexture=null,this.boundingSphere=null,this.hasOpenPolyLine=!1,this.hasTransform=!1,this.lastFrameIndex=-1,this.lastCamera=null,e&&this.setParams(e)}function r(){this.transform=!1,this.planeU=null,this.planeV=null,this.points2d=null,this.closedPoints2d=null,this.isOpen=!1,this.viewPlaneU=null,this.viewPlaneV=null,this.viewPoints2d=null,this.matrix=null}return i.prototype.setParams=function(e){this.polyLines=[],this.clippingPolygonTexture=null,this.boundingSphere=null,this.hasOpenPolyLine=!1,this.lastFrameIndex=-1,this.lastCamera=null,this.hasTransform=e.csiParams&&e.csiParams.transform||!1,e.csiParams?this.setCSI(e.csiParams):this.setSingle(e)},i.prototype.getForOccurrenceOverride=function(e){if(this.hasTransform){var t,r=new i(null,e);for(r.hasOpenPolyLine=this.hasOpenPolyLine,r.polyLines=[],t=0;t<this.polyLines.length;t++)r.polyLines.push(this.polyLines[t].getForOccurrenceOverride(e));return r.hasTransform=this.hasTransform,r}return this},i.prototype.setCSI=function(e){this.polyLinePoints=[];var t,i=[];for(t=0;t<e.vertexCounts.length;t++)i.push(e.vertexCounts[t]);var r,n=0;e.vertices.length;for(t=0;t<e.curveCount;t++)r=this.createPolyLineFromCSI(e,t,n,i[t]),this.polyLines.push(r),n+=i[t]},i.prototype.createPolyLineFromCSI=function(t,i,n,a){var s,o,l=new e.Vector3(t.normals[3*i],t.normals[3*i+1],t.normals[3*i+2]);l.normalize(),s=new e.Vector3(1,0,0),(o=new e.Vector3(0,0,0)).crossVectors(l,s),o.norm<.001&&(s=new e.Vector3(0,1,0),o.crossVectors(l,s)),o.normalize();var h,c,d=[],u=new e.Vector3;for(h=0;h<a;h++)c=3*(n+h),u.x=t.vertices[c],u.y=t.vertices[c+1],u.z=t.vertices[c+2],d.push(new e.Vector2(u.dot(s),u.dot(o)));var p=!1;d[0].distanceTo(d[d.length-1])<1e-9?d.splice(d.length-1,1):(this.hasOpenPolyLine=!0,p=!0);var f=new r;return f.set(s,o,new e.Vector3,d,p,t.transform),f},i.prototype.createTexture=function(){this.clippingPolygonTexture&&(this.clippingPolygonTexture.dispose(),this.clippingPolygonTexture=null);var t,i,r=0;for(t=0;t<this.polyLines.length;t++)r+=(i=this.polyLines[t]).viewPoints2d.length;var n,a,s=new Float32Array(4*r),o=0;for(t=0;t<this.polyLines.length;t++)for(a=(i=this.polyLines[t]).viewPoints2d.length,n=0;n<a;n++)s[o]=i.viewPoints2d[n].x,s[o+1]=i.viewPoints2d[n].y,s[o+2]=0,s[o+3]=1,o+=4;this.clippingPolygonTexture=new e.DataTexture(s,r,1,e.RGBAFormat,e.FloatType,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),this.clippingPolygonTexture.needsUpdate=!0},i.prototype.setSingle=function(t){var i=t.planeOrigin?t.planeOrigin.clone():new e.Vector3,n=t.planeU.clone();n.normalize();var a=t.planeV.clone();a.normalize();var s=new r;s.set(n,a,i,t.polyLinePoints,!1,!1),this.polyLines.push(s)},i.prototype.getMaxSize=function(){var e,t=0;for(e=0;e<this.polyLines.length;e++){var i=this.polyLines[e].getClosedSize();i>t&&(t=i)}return t},i.prototype.updateCamera=function(t,i){if(t!==this.lastCamera||this.lastFrameIndex!==i||!this.clippingPolygonTexture){var r,n=t.matrixWorldInverse,a=null,s=null,o=null;for(r=0;r<this.polyLines.length;r++)(o=this.polyLines[r]).transform?(o.matrix!==s&&((a=new e.Matrix4).multiplyMatrices(t.matrixWorldInverse,o.matrix),s=o.matrix),o.applyViewMatrix(a)):o.applyViewMatrix(n);this.lastCamera=t,this.lastFrameIndex=i,this.clippingPolygonTexture=null}},i.prototype.getTexture=function(e,t){return this.clippingPolygonTexture||this.createTexture(),this.clippingPolygonTexture},i.prototype.updateBoundingSphere=function(e){var t,i;if(e&&this.hasOpenPolyLine&&(!this.boundingSphere||!e.equals(this.boundingSphere)))for(this.boundingSphere=e.clone(),i=0;i<this.polyLines.length;i++)(t=this.polyLines[i]).isOpen&&(t.applyBoundingSphere(e),this.clippingPolygonTexture=null)},i.prototype.dbgDump=function(){var e,t={count:this.polyLines.length,planeU:[],planeV:[],polyLineSize:[]};for(e=0;e<this.polyLines.length;e++){var i=this.polyLines[e];t.planeU.push(i.planeU),t.planeV.push(i.planeV),t.polyLineSize.push(i.points2d.length)}return t},i.prototype.getCount=function(){return this.polyLines.length},i.merge=function(e,t){var r=null;return e&&t?((r=new i(null,null)).polyLines=e.polyLines.concat(t.polyLines),r.hasOpenPolyLine=e.hasOpenPolyLine||t.hasOpenPolyLine,r.hasTransform=e.hasTransform||t.hasTransform):r=e||t,r},r.prototype.set=function(t,i,r,n,a,s){var o;for(this.transform=!!s,this.planeU=t,this.planeV=i,this.points2d=[],o=0;o<n.length;o++)this.points2d.push(new e.Vector2(n[o].x+t.dot(r),n[o].y+i.dot(r)));this.closedPoints2d=a?null:this.points2d,this.isOpen=a,this.viewPlaneU=new e.Vector3,this.viewPlaneV=new e.Vector3,this.viewPoints2d=[]},r.prototype.getClosedSize=function(){return this.closedPoints2d.length},r.prototype.applyViewMatrix=function(t){this.viewPlaneU.copy(this.planeU),this.viewPlaneV.copy(this.planeV),this.viewPlaneU.applyRotation(t),this.viewPlaneV.applyRotation(t);var i=new e.Vector3;i.applyMatrix4(t),this.viewPoints2d=[];var r,n=new e.Vector2,a=new e.Vector2(i.dot(this.viewPlaneU),i.dot(this.viewPlaneV));for(r=0;r<this.closedPoints2d.length;r++)n=this.closedPoints2d[r],this.viewPoints2d.push(new e.Vector2(a.x+n.x,a.y+n.y))},r.prototype.applyBoundingSphere=function(i){if(this.isOpen){var r=t.makeClosedPolyLine({planeOrigin:new e.Vector3,planeU:this.planeU,planeV:this.planeV,polyLinePoints:this.points2d},i,!1);this.closedPoints2d=r.polyLinePoints}},r.prototype.getForOccurrenceOverride=function(e){if(e){var t=new r;return t.transform=this.transform,t.planeU=this.planeU,t.planeV=this.planeV,t.points2d=this.points2d,t.closedPoints2d=this.closedPoints2d,t.isOpen=this.isOpen,t.viewPlaneU=this.viewPlaneU,t.viewPlaneV=this.viewPlaneV,t.viewPoints2d=this.viewPoints2d,t.matrix=this.matrix||e,t}return this},i}),define("DS/Visualization/RenderTargetPool",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return e.extend({init:function(e){var i=t.FloatType,r=t.HalfFloatType,n=t.FloatType,a=t._mobileDevice?t.HalfFloatType:t.FloatType;e.supportsFloatTextures()||(i=t.UnsignedByteType,n=t.HalfFloatType,a=t.HalfFloatType),e.supportsHalfFloatTextures()||(n=t.UnsignedByteType,a=t.UnsignedByteType,r=t.UnsignedByteType),e.supportsFloatTextures()&&!e.supportsHalfFloatTextures()&&(n=t.FloatType,a=t.FloatType,r=t.FloatType),t.IsIE11&&(r=i,n=i,a=i),this.rtOptionsMap={linear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:i},nearest:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!0,format:t.RGBAFormat,type:i},maxPrecisionLinear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:n},maxPrecisionNearest:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!0,format:t.RGBAFormat,type:n},halfLinear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:r},halfNearest:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!0,format:t.RGBAFormat,type:r},uint:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:t.UnsignedByteType},uintNearest:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!0,format:t.RGBAFormat,type:t.UnsignedByteType},uintRGBLinear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBFormat,type:t.UnsignedByteType},uintRGBLinearNoStencil:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!1,format:t.RGBFormat,type:t.UnsignedByteType},uintRGBNearest:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!0,format:t.RGBFormat,type:t.UnsignedByteType},uintRGBNearestNoStencil:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,format:t.RGBFormat,type:t.UnsignedByteType},cubelinear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:i},decal:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,format:t.RGBAFormat,type:a},decalTex:{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,format:t.RGBAFormat,type:a},iblLinear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!1,format:t.RGBAFormat,type:a},oitAccumLinear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:r},oitRevealLinear:{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBFormat,type:t.UnsignedByteType}},this.renderTargetPool=[]},areRenderTargetOptionsEqual:function(e,t){return e&&t?e.height===t.height&&e.width===t.width&&e.options===t.options:e===t},resetRenderTargetPool:function(){var e=0;for(e=0;e<this.renderTargetPool.length;e++)this.renderTargetPool[e].dispose();this.renderTargetPool=[]},rtpStats:{nbCreation:0},dumpPool:function(){var e,t="dumpPool: [";for(e=0;e<this.renderTargetPool.length;e++)e>0&&(t+=", "),t+=this.renderTargetPool[e].uniqueID;t+="]",console.log(t)},buildRenderTarget:function(e,i,r,n,a,s){var o,l,h=this.rtOptionsMap[r],c=null,d=-1;if(!s){for(l=0;l<this.renderTargetPool.length&&d<0;l++)(o=this.rtOptionsMap[this.renderTargetPool[l].optionsId])&&o.type===h.type&&r===this.renderTargetPool[l].optionsId&&this.renderTargetPool[l].width===e&&this.renderTargetPool[l].height===i&&((c=this.renderTargetPool[l]).reset(this.rtOptionsMap[r]),d=l);d>=0&&this.renderTargetPool.splice(d,1)}return c||(c="cubelinear"===r?new t.WebGLRenderTargetCube(e,i,this.rtOptionsMap[r]):new t.WebGLRenderTarget(e,i,this.rtOptionsMap[r]),e>0&&i>0&&this.rtpStats.nbCreation++),a&&(c.shareDepthFrom=a),c.optionsId=r,c},pushRenderTarget:function(e,t){if(e){for(var i=!1,r=0;r<this.renderTargetPool.length;r++)this.renderTargetPool[r].uniqueID==e.uniqueID&&(i=!0);i||this.renderTargetPool.push(e)}}})}),define("Visualization/RenderTargetPool",["DS/Visualization/RenderTargetPool","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/RenderTargetPool"),e}),define("DS/Visualization/GeometryHelper",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],function(e,t,i){"use strict";var r=document.createElement("canvas");r.width=512,r.height=64;var n=e.extend({init:function(){return this},CreateVis3DCuboid:function(e,r,n,a,s,o,l){var h,c,d,u,p,f,g,m,v,y,S,_,x,b,w,M;if(e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.fill=void 0!==o?o:1,this.cornerPoint=void 0!==e?e:new t.Vector3(0,0,0),this.firstAxis=void 0!==r?r:new t.Vector3(1,0,0),this.secondAxis=void 0!==n?n:new t.Vector3(0,1,0),this.thirdAxis=void 0!==a?a:new t.Vector3(0,0,1),this.color=void 0!==s?s:new i.Color(.5,.5,.5,1),M=l||0):(this.fill=void 0!==e.fill?e.fill:1,this.cornerPoint=void 0!==e.cornerPoint?e.cornerPoint:new t.Vector3(0,0,0),this.firstAxis=void 0!==e.firstAxis?e.firstAxis:new t.Vector3(1,0,0),this.secondAxis=void 0!==e.secondAxis?e.secondAxis:new t.Vector3(0,1,0),this.thirdAxis=void 0!==e.thirdAxis?e.thirdAxis:new t.Vector3(0,0,1),this.color=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),M=e.layerNb?e.layerNb:0),(h=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,h.lineAttr=new i.LineAttributes,h.pointAttr=new i.PointAttributes,(c=new i.Buffer).size=24,c.component=i.VertexComponentEnum.POSITION,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(24),(d=new i.Buffer).size=18,d.component=i.VertexComponentEnum.NORMAL,d.format=i.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(18),(u=new i.Buffer).size=12,u.component=i.VertexComponentEnum.TEX_COORD_0,u.format=i.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(12),(p=new i.Buffer).indexBuffer=!0,p.size=24,p.format=i.DataTypeEnum.UINT,p.dimension=1,p.data=new Uint16Array(24),(f=new i.Buffer).indexBuffer=!0,f.size=24,f.format=i.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(24),(g=new i.Buffer).indexBuffer=!0,g.size=24,g.format=i.DataTypeEnum.UINT,g.dimension=1,g.data=new Uint16Array(24),h.addBuffer(0,c),h.addBuffer(1,d),h.addBuffer(2,u),h.addBuffer(3,p),h.addBuffer(4,f),h.addBuffer(5,g),m=c.data,v=0,(S=new t.Vector3).addVectors(this.cornerPoint,this.thirdAxis),m[v++]=S.x,m[v++]=S.y,m[v++]=S.z,S.add(this.firstAxis),m[v++]=S.x,m[v++]=S.y,m[v++]=S.z,S.add(this.secondAxis),m[v++]=S.x,m[v++]=S.y,m[v++]=S.z,S.addVectors(this.cornerPoint,this.thirdAxis),S.add(this.secondAxis),m[v++]=S.x,m[v++]=S.y,m[v++]=S.z,S.addVectors(this.cornerPoint,this.secondAxis),m[v++]=S.x,m[v++]=S.y,m[v++]=S.z,S.add(this.firstAxis),m[v++]=S.x,m[v++]=S.y,m[v++]=S.z,S.addVectors(this.cornerPoint,this.firstAxis),m[v++]=S.x,m[v++]=S.y,m[v++]=S.z,m[v++]=this.cornerPoint.x,m[v++]=this.cornerPoint.y,m[v++]=this.cornerPoint.z,this.fill){for(v=0,y=0,(m=p.data)[v++]=0,m[v++]=1,m[v++]=3,m[v++]=2,m[v++]=4,m[v++]=5,m[v++]=7,m[v++]=6,m[v++]=0,m[v++]=3,m[v++]=7,m[v++]=4,m[v++]=6,m[v++]=5,m[v++]=1,m[v++]=2,m[v++]=5,m[v++]=4,m[v++]=2,m[v++]=3,m[v++]=7,m[v++]=6,m[v++]=0,m[v++]=1,m=f.data,v=0,y=0;y<6;y++)m[v++]=y,m[v++]=y,m[v++]=y,m[v++]=y;for(m=g.data,v=0,y=0;y<6;y++)m[v++]=2,m[v++]=3,m[v++]=0,m[v++]=1,m[v++]=1,m[v++]=0,m[v++]=3,m[v++]=2,m[v++]=3,m[v++]=1,m[v++]=2,m[v++]=0,m[v++]=3,m[v++]=1,m[v++]=2,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=3,m[v++]=2,m[v++]=2,m[v++]=3,m[v++]=0,m[v++]=1;v=0,(m=d.data)[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=0,m[v++]=-1,m[v++]=-1,m[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=0,m[v++]=-1,m[v++]=0,v=0,(m=u.data)[v++]=0,m[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=1,m[v++]=1,m[v++]=0}else v=0,y=0,(m=p.data)[v++]=0,m[v++]=3,m[v++]=3,m[v++]=2,m[v++]=2,m[v++]=1,m[v++]=1,m[v++]=0,m[v++]=7,m[v++]=4,m[v++]=4,m[v++]=5,m[v++]=5,m[v++]=6,m[v++]=6,m[v++]=7,m[v++]=0,m[v++]=7,m[v++]=3,m[v++]=4,m[v++]=2,m[v++]=5,m[v++]=1,m[v++]=6;for(y=0;y<6;y++)(_=new i.Primitive).nbIndices=4,_.connectivity=this.fill?i.ConnectivityTypeEnum.TRIANGLE_STRIP:i.ConnectivityTypeEnum.LINES,_.attr={fill:new i.FillAttributes(this.color,1),line:new i.LineAttributes,point:new i.PointAttributes},(x=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,x.nbVertices=4,x.nbValuesPerVertex=3,x.format=i.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=0,x.indices=new i.IndexArray,x.indices.format=i.DataTypeEnum.UINT,x.indices.bufferId=3,x.indices.offset=4*y,_.addVertexComponent(x),this.fill&&((b=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,b.nbVertices=4,b.nbValuesPerVertex=3,b.format=i.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=1,b.indices=new i.IndexArray,b.indices.format=i.DataTypeEnum.UINT,b.indices.bufferId=4,b.indices.offset=4*y,(w=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,w.nbVertices=4,w.nbValuesPerVertex=3,w.format=i.DataTypeEnum.FLOAT,w.cardinality=0,w.bufferId=2,w.indices=new i.IndexArray,w.indices.format=i.DataTypeEnum.UINT,w.indices.bufferId=5,w.indices.offset=4*y,_.addVertexComponent(b),_.addVertexComponent(w)),h.addPrimitive(_);return h.noz=M>0,h},CreateVis3DSphere:function(e,r,n,a,s,o,l,h,c){var d,u,p,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A,T,D,I,R,O,L,V,F,B,N,G,k=!1;for(e instanceof t.Matrix4||void 0===e?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.matrix=void 0!==e?e:null,this.radius=void 0!==r?r:1,this.meridianStart=void 0!==n?n:0,this.meridianEnd=void 0!==a?a:2*Math.PI,this.parallelStart=void 0!==s?s:0,this.parallelEnd=void 0!==o?o:2*Math.PI,this.sag=void 0!==l?l:80,L=void 0!==h?h:new i.Color(.5,.5,.5,1),G=c||0):(this.matrix=void 0!==e.matrix?e.matrix:null,this.radius=void 0!==e.radius?e.radius:1,this.meridianStart=void 0!==e.meridianStart?e.meridianStart:0,this.meridianEnd=void 0!==e.meridianEnd?e.meridianEnd:2*Math.PI,this.parallelStart=void 0!==e.parallelStart?e.parallelStart:0,this.parallelEnd=void 0!==e.parallelEnd?e.parallelEnd:2*Math.PI,this.sag=void 0!==e.sag?e.sag:80,L=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),G=e.layerNb?e.layerNb:0,k=!!e.tgtBinorm&&e.tgtBinorm),this.parallelStart<0&&(this.parallelStart=0),this.parallelStart>Math.PI&&(this.parallelStart=Math.PI),(d=this.parallelEnd-this.parallelStart)<0&&(d=0),this.parallelStart+d>Math.PI&&(d=Math.PI-this.parallelStart),this.meridianStart<0&&(this.meridianStart=0),this.meridianStart>2*Math.PI&&(this.meridianStart=2*Math.PI),(u=this.meridianEnd-this.meridianStart)<0&&(u=0),this.meridianStart+u>2*Math.PI&&(u=2*Math.PI-this.meridianStart),p=3*(this.sag+1)*this.sag,f=6*this.sag*(this.sag-1),(g=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,g.lineAttr=new i.LineAttributes,g.pointAttr=new i.PointAttributes,(m=new i.Buffer).size=3*p,m.component=i.VertexComponentEnum.POSITION,m.format=i.DataTypeEnum.FLOAT,m.dimension=3,m.data=new Float32Array(m.size),(v=new i.Buffer).size=3*p,v.component=i.VertexComponentEnum.NORMAL,v.format=i.DataTypeEnum.FLOAT,v.dimension=3,v.data=new Float32Array(v.size),(y=new i.Buffer).size=3*p,y.component=i.VertexComponentEnum.TEX_COORD_0,y.format=i.DataTypeEnum.FLOAT,y.dimension=3,y.data=new Float32Array(y.size),k&&((S=new i.Buffer).size=3*p,S.component=i.VertexComponentEnum.TEX_COORD_2,S.format=i.DataTypeEnum.FLOAT,S.dimension=3,S.data=new Float32Array(S.size),(_=new i.Buffer).size=3*p,_.component=i.VertexComponentEnum.TEX_COORD_3,_.format=i.DataTypeEnum.FLOAT,_.dimension=3,_.data=new Float32Array(_.size),g.addBuffer(5,S),g.addBuffer(6,_)),(x=new i.Buffer).indexBuffer=!0,x.size=f,x.format=i.DataTypeEnum.UINT,x.dimension=1,x.data=new Uint16Array(x.size),g.addBuffer(0,m),g.addBuffer(1,v),g.addBuffer(2,y),g.addBuffer(3,x),b=x.data,E=0,A=0;A<this.sag-1;A++)for(T=0;T<this.sag;T++)b[E++]=A*(this.sag+1)+T,b[E++]=(A+1)*(this.sag+1)+T,b[E++]=(A+1)*(this.sag+1)+T+1,b[E++]=A*(this.sag+1)+T,b[E++]=(A+1)*(this.sag+1)+T+1,b[E++]=A*(this.sag+1)+T+1;for(b=m.data,w=v.data,M=y.data,k&&(C=S.data,P=_.data),E=0,D=1/(this.sag-1),I=new t.Vector3,A=0;A<this.sag;A++)for(R=A*D,T=0;T<=this.sag;T++,E+=3)O=T/this.sag,w[E]=Math.sin(this.parallelStart+R*d)*Math.cos(this.meridianStart+O*u),I.x=this.radius*w[E],M[E]=T/this.sag,w[E+1]=Math.sin(this.parallelStart+R*d)*Math.sin(this.meridianStart+O*u),I.y=this.radius*w[E+1],M[E+1]=A/this.sag,w[E+2]=Math.cos(this.parallelStart+R*d),I.z=this.radius*w[E+2],M[E+2]=0,k&&(C[E]=w[E+1],C[E+1]=-w[E],C[E+2]=0,P[E]=w[E]*w[E+2],P[E+1]=w[E+1]*w[E+2],P[E+2]=-w[E]*w[E]-w[E+1]*w[E+1]),this.matrix&&I.applyMatrix4(this.matrix),b[E]=I.x,b[E+1]=I.y,b[E+2]=I.z;if((V=new i.Primitive).nbIndices=f,V.connectivity=i.ConnectivityTypeEnum.TRIANGLES,V.attr={fill:new i.FillAttributes(L,1),line:new i.LineAttributes,point:new i.PointAttributes},(F=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,F.nbVertices=p,F.nbValuesPerVertex=3,F.format=i.DataTypeEnum.FLOAT,F.cardinality=0,F.bufferId=0,F.indices=new i.IndexArray,F.indices.format=i.DataTypeEnum.UINT,F.indices.bufferId=3,F.indices.offset=0,(B=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,B.nbVertices=p,B.nbValuesPerVertex=3,B.format=i.DataTypeEnum.FLOAT,B.cardinality=0,B.bufferId=1,B.indices=new i.IndexArray,B.indices.format=i.DataTypeEnum.UINT,B.indices.bufferId=3,B.indices.offset=0,(N=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,N.nbVertices=p,N.nbValuesPerVertex=3,N.format=i.DataTypeEnum.FLOAT,N.cardinality=0,N.bufferId=2,N.indices=new i.IndexArray,N.indices.format=i.DataTypeEnum.UINT,N.indices.bufferId=3,N.indices.offset=0,V.addVertexComponent(F),V.addVertexComponent(B),V.addVertexComponent(N),k){var U=new i.VertexComponent;U.component=i.VertexComponentEnum.TEX_COORD_2,U.nbVertices=p,U.nbValuesPerVertex=3,U.format=i.DataTypeEnum.FLOAT,U.cardinality=0,U.bufferId=5,U.indices=new i.IndexArray,U.indices.format=i.DataTypeEnum.UINT,U.indices.bufferId=3,U.indices.offset=0;var z=new i.VertexComponent;z.component=i.VertexComponentEnum.TEX_COORD_3,z.nbVertices=p,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=6,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=0,V.addVertexComponent(U),V.addVertexComponent(z)}return g.addPrimitive(V),g.noz=G>0,g},CreateVis3DTube:function(e,r,n,a,s,o,l){var h,c,d,u,p,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A,T,D,I,R,O,L,V,F,B;if(e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),h=e,(c=new t.Vector3(0,0,0)).addVectors(e,r),d=a||1,u=n||1,D=void 0!==o?o:new i.Color(.2,.8,.2,1),F=l||0,B=s):(h=e.bottomCenterPoint,(c=new t.Vector3(0,0,0)).addVectors(e.bottomCenterPoint,e.extrusionVector),d=e.externalRadius?e.externalRadius:1,u=e.internalRadius?e.internalRadius:1,B=e.sag?e.sag:0,D=void 0!==e.color?e.color:new i.Color(.2,.8,.2,1),F=e.layerNb?e.layerNb:0),u===d)return this.CreateVis3DCylinderCustom({bottomCenterPoint:h,topCenterPoint:c,bottomRadius:d,topRadius:d,sag:B,bottomCap:!1,topCap:!1,internal:!1,layerNb:F});p=this.CreateVis3DCylinderCustom({bottomCenterPoint:h,topCenterPoint:c,bottomRadius:d,topRadius:d,sag:B,bottomCap:!1,topCap:!1,internal:!1,layerNb:F}),f=this.CreateVis3DCylinderCustom({bottomCenterPoint:h,topCenterPoint:c,bottomRadius:u,topRadius:u,sag:B,bottomCap:!1,topCap:!1,internal:!0,layerNb:F}),g=3*(B+1)*8,m=3*(B+1)*8,v=24*B,(y=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,y.lineAttr=new i.LineAttributes,y.pointAttr=new i.PointAttributes,(S=new i.Buffer).size=g,S.component=i.VertexComponentEnum.POSITION,S.format=i.DataTypeEnum.FLOAT,S.dimension=3,S.data=new Float32Array(S.size),(_=new i.Buffer).size=m,_.component=i.VertexComponentEnum.NORMAL,_.format=i.DataTypeEnum.FLOAT,_.dimension=3,_.data=new Float32Array(_.size),(x=new i.Buffer).size=g,x.component=i.VertexComponentEnum.TEX_COORD_0,x.format=i.DataTypeEnum.FLOAT,x.dimension=3,x.data=new Float32Array(x.size),(b=new i.Buffer).indexBuffer=!0,b.size=v,b.format=i.DataTypeEnum.UINT,b.dimension=1,b.data=new Uint16Array(b.size),S.data.set(p.buffers[0].data.subarray(0,6*(B+1)),0),S.data.set(f.buffers[0].data.subarray(0,6*(B+1)),6*(B+1)),S.data.set(p.buffers[0].data.subarray(0,3*(B+1)),12*(B+1)),S.data.set(f.buffers[0].data.subarray(0,3*(B+1)),15*(B+1)),S.data.set(p.buffers[0].data.subarray(3*(B+1),6*(B+1)),18*(B+1)),S.data.set(f.buffers[0].data.subarray(3*(B+1),6*(B+1)),21*(B+1)),x.data.set(p.buffers[2].data.subarray(0,6*(B+1)),0),x.data.set(f.buffers[2].data.subarray(0,6*(B+1)),6*(B+1)),x.data.set(p.buffers[2].data.subarray(0,3*(B+1)),12*(B+1)),x.data.set(f.buffers[2].data.subarray(0,3*(B+1)),15*(B+1)),x.data.set(p.buffers[2].data.subarray(3*(B+1),6*(B+1)),18*(B+1)),x.data.set(f.buffers[2].data.subarray(3*(B+1),6*(B+1)),21*(B+1)),_.data.set(p.buffers[1].data.subarray(0,3*(B+1)*2),0),_.data.set(f.buffers[1].data.subarray(0,3*(B+1)*2),3*(B+1)*2),w=3*(B+1)*4;for(var N=0;N<2*(B+1);N++)_.data[w++]=0,_.data[w++]=0,_.data[w++]=-1;for(N=0;N<2*(B+1);N++)_.data[w++]=0,_.data[w++]=0,_.data[w++]=1;for(b.data.set(p.buffers[3].data,0),C=p.buffers[3].size,P=p.buffers[0].size/3,p.buffers[1].size/3,M=0;M<C;M++)b.data[M+C]=f.buffers[3].data[M]+P;for(w=p.buffers[3].size+f.buffers[3].size,P*=2,(p.buffers[1].size+f.buffers[1].size)/3,E=0;E<B;++E)A=E+1,b.data[w++]=E+P,b.data[w++]=B+1+E+P,b.data[w++]=A+P,b.data[w++]=B+1+E+P,b.data[w++]=B+1+A+P,b.data[w++]=A+P;for(1,P+=2*(B+1),E=0;E<B;++E)A=E+1,b.data[w++]=B+1+E+P,b.data[w++]=E+P,b.data[w++]=A+P,b.data[w++]=A+P,b.data[w++]=B+1+A+P,b.data[w++]=B+1+E+P;for(y.addBuffer(0,S),y.addBuffer(1,_),y.addBuffer(2,x),y.addBuffer(3,b),y.addPrimitive(p.primitives[0]),y.addPrimitive(f.primitives[0]),T=f.primitives[0].vertexComponents,M=0;M<T.length;M++)T[M].indices.offset+=C;return(I=new i.Primitive).nbIndices=6*this.sag,I.connectivity=i.ConnectivityTypeEnum.TRIANGLES,I.attr={fill:new i.FillAttributes(D,1),line:new i.LineAttributes,point:new i.PointAttributes},(R=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,R.nbVertices=2*(this.sag+1),R.nbValuesPerVertex=3,R.format=i.DataTypeEnum.FLOAT,R.cardinality=0,R.bufferId=0,R.indices=new i.IndexArray,R.indices.format=i.DataTypeEnum.UINT,R.indices.bufferId=3,R.indices.offset=p.buffers[3].size+f.buffers[3].size,(O=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,O.nbVertices=2*(this.sag+1),O.nbValuesPerVertex=3,O.format=i.DataTypeEnum.FLOAT,O.cardinality=0,O.bufferId=1,O.indices=new i.IndexArray,O.indices.format=i.DataTypeEnum.UINT,O.indices.bufferId=3,O.indices.offset=p.buffers[3].size+f.buffers[3].size,(L=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,L.nbVertices=2*(this.sag+1),L.nbValuesPerVertex=3,L.format=i.DataTypeEnum.FLOAT,L.cardinality=0,L.bufferId=2,L.indices=new i.IndexArray,L.indices.format=i.DataTypeEnum.UINT,L.indices.bufferId=3,L.indices.offset=p.buffers[3].size+f.buffers[3].size,I.addVertexComponent(R),I.addVertexComponent(O),I.addVertexComponent(L),y.addPrimitive(I),(V=new i.Primitive).nbIndices=6*this.sag,V.connectivity=i.ConnectivityTypeEnum.TRIANGLES,V.attr={fill:new i.FillAttributes(D,1),line:new i.LineAttributes,point:new i.PointAttributes},(R=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,R.nbVertices=2*(this.sag+1),R.nbValuesPerVertex=3,R.format=i.DataTypeEnum.FLOAT,R.cardinality=0,R.bufferId=0,R.indices=new i.IndexArray,R.indices.format=i.DataTypeEnum.UINT,R.indices.bufferId=3,R.indices.offset=p.buffers[3].size+f.buffers[3].size+6*B,(O=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,O.nbVertices=2*(this.sag+1),O.nbValuesPerVertex=3,O.format=i.DataTypeEnum.FLOAT,O.cardinality=0,O.bufferId=1,O.indices=new i.IndexArray,O.indices.format=i.DataTypeEnum.UINT,O.indices.bufferId=3,O.indices.offset=p.buffers[3].size+f.buffers[3].size+6*B,(L=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,L.nbVertices=2*(this.sag+1),L.nbValuesPerVertex=3,L.format=i.DataTypeEnum.FLOAT,L.cardinality=0,L.bufferId=2,L.indices=new i.IndexArray,L.indices.format=i.DataTypeEnum.UINT,L.indices.bufferId=3,L.indices.offset=p.buffers[3].size+f.buffers[3].size+6*B,V.addVertexComponent(R),V.addVertexComponent(O),V.addVertexComponent(L),y.addPrimitive(V),y.noz=F>0,y},CreateVis3DCylinder:function(e,i,r,n,a){var s;return e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),s={bottomCenterPoint:e,topCenterPoint:i,bottomRadius:r,topRadius:r,sag:n,bottomCap:!0,topCap:!0,internal:!1,layerNb:a}):s={bottomCenterPoint:e.bottomCenterPoint,topCenterPoint:e.topCenterPoint,bottomRadius:e.radius,topRadius:e.radius,sag:e.sag,bottomCap:!0,topCap:!0,internal:!1,color:e.color,layerNb:e.layerNb},this.CreateVis3DCylinderCustom(s)},CreateVis3DCone:function(e,r,n,a,s,o,l){var h;return e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),h={bottomCenterPoint:e,topCenterPoint:r,bottomRadius:void 0!==n?n:1,topRadius:void 0!==a?a:1,sag:s,bottomCap:!0,topCap:!0,internal:!1,color:void 0!==o?o:new i.Color(.2,.8,.2,1),layerNb:l||0}):h={bottomCenterPoint:e.bottomCenterPoint,topCenterPoint:e.topCenterPoint,bottomRadius:void 0!==e.bottomRadius?e.bottomRadius:1,topRadius:void 0!==e.topRadius?e.topRadius:1,sag:e.sag,bottomCap:!0,topCap:!0,internal:!1,color:void 0!==e.color?e.color:new i.Color(.2,.8,.2,1),layerNb:e.layerNb||0},h.topRadius<=0&&(h.topCap=!1),h.bottomRadius<=0&&(h.bottomCap=!1),this.CreateVis3DCylinderCustom(h)},CreateVis3DCylinderCustom:function(e,r,n,a,s,o,l,h,c,d){var u,p,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A,T,D,I,R,O,L,V,F,B,N,G,k,U,z,H,W,j,X,q,Z;e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.bottomCenterPoint=void 0!==e?e:new t.Vector3(0,0,0),this.topCenterPoint=void 0!==r?r:new t.Vector3(0,5,0),this.bottomRadius=void 0!==n?n:1,this.topRadius=void 0!==a?a:1,this.sag=void 0!==s?s:80,u=void 0===l||l,p=void 0===o||o,f=void 0!==h&&h,Z=d||0,k=c||new i.Color(.2,.8,.2,1)):(this.bottomCenterPoint=void 0!==e.bottomCenterPoint?e.bottomCenterPoint:new t.Vector3(0,0,0),this.topCenterPoint=void 0!==e.topCenterPoint?e.topCenterPoint:new t.Vector3(0,5,0),this.bottomRadius=void 0!==e.bottomRadius?e.bottomRadius:1,this.topRadius=void 0!==e.topRadius?e.topRadius:1,this.sag=void 0!==e.sag?e.sag:80,u=void 0===e.topCap||e.topCap,p=void 0===e.bottomCap||e.bottomCap,f=void 0!==e.internal&&e.internal,Z=e.layerNb?e.layerNb:0,k=e.color?e.color:new i.Color(.2,.8,.2,1)),(g=new t.Vector4(0,0,0,0)).subVectors(this.topCenterPoint,this.bottomCenterPoint),g.w=0,g.normalize(),m=new t.Matrix4,0===g.x&&0===g.y?m.identity():m.set(g.x/Math.sqrt(g.x*g.x+g.y*g.y),g.y/Math.sqrt(g.x*g.x+g.y*g.y),0,0,-g.y/Math.sqrt(g.x*g.x+g.y*g.y),g.x/Math.sqrt(g.x*g.x+g.y*g.y),0,0,0,0,1,0,0,0,0,1),v=new t.Matrix4,0===g.x&&0===g.y&&0===g.z?v.identity():v.set(g.z/Math.sqrt(g.x*g.x+g.y*g.y+g.z*g.z),0,-Math.sqrt(g.x*g.x+g.y*g.y)/Math.sqrt(g.x*g.x+g.y*g.y+g.z*g.z),0,0,1,0,0,Math.sqrt(g.x*g.x+g.y*g.y)/Math.sqrt(g.x*g.x+g.y*g.y+g.z*g.z),0,g.z/Math.sqrt(g.x*g.x+g.y*g.y+g.z*g.z),0,0,0,0,1),(y=new t.Matrix4).multiplyMatrices(v,m),y.transpose(),y.clone(),_=new t.Vector3(this.bottomCenterPoint.x,this.bottomCenterPoint.y,this.bottomCenterPoint.z),S=y.clone(),y.elements[12]=_.x,y.elements[13]=_.y,y.elements[14]=_.z,x=Math.sqrt((this.bottomCenterPoint.x-this.topCenterPoint.x)*(this.bottomCenterPoint.x-this.topCenterPoint.x)+(this.bottomCenterPoint.y-this.topCenterPoint.y)*(this.bottomCenterPoint.y-this.topCenterPoint.y)+(this.bottomCenterPoint.z-this.topCenterPoint.z)*(this.bottomCenterPoint.z-this.topCenterPoint.z)),b=(this.bottomRadius-this.topRadius)/x,w=6*this.sag,M=2*(this.sag+1),C=2*(this.sag+1);var Y=M;if(u&&(w+=3*(this.sag-2),Y+=this.sag,C+=this.sag,M+=this.sag),p&&(w+=3*(this.sag-2),Y+=this.sag,C+=this.sag,M+=this.sag),(P=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,P.lineAttr=new i.LineAttributes,P.pointAttr=new i.PointAttributes,(E=new i.Buffer).size=3*M,E.component=i.VertexComponentEnum.POSITION,E.format=i.DataTypeEnum.FLOAT,E.dimension=3,E.data=new Float32Array(E.size),(A=new i.Buffer).size=3*C,A.component=i.VertexComponentEnum.NORMAL,A.format=i.DataTypeEnum.FLOAT,A.dimension=3,A.data=new Float32Array(A.size),(T=new i.Buffer).size=3*Y,T.component=i.VertexComponentEnum.TEX_COORD_0,T.format=i.DataTypeEnum.FLOAT,T.dimension=3,T.data=new Float32Array(T.size),(D=new i.Buffer).indexBuffer=!0,D.size=w,D.format=i.DataTypeEnum.UINT,D.dimension=1,D.data=new Uint16Array(D.size),P.addBuffer(0,E),P.addBuffer(1,A),P.addBuffer(2,T),P.addBuffer(3,D),I=D.data,R=0,f)for(L=0;L<this.sag;++L)V=L+1,I[R++]=V,I[R++]=L,I[R++]=this.sag+1+L,I[R++]=V,I[R++]=this.sag+1+L,I[R++]=this.sag+1+V;else for(L=0;L<this.sag;++L)V=L+1,I[R++]=L,I[R++]=V,I[R++]=this.sag+1+L,I[R++]=this.sag+1+L,I[R++]=V,I[R++]=this.sag+1+V;if(u)for(L=0;L<this.sag-2;L++)I[R++]=2*this.sag+2,I[R++]=2*this.sag+2+L+1,I[R++]=2*this.sag+2+L+2;if(p)if(u)for(L=0;L<this.sag-2;L++)I[R++]=3*this.sag+2,I[R++]=3*this.sag+2+L+1,I[R++]=3*this.sag+2+L+2;else for(L=0;L<this.sag-2;L++)I[R++]=2*this.sag+2,I[R++]=2*this.sag+2+L+1,I[R++]=2*this.sag+2+L+2;F=E.data,B=T.data;var Q=0;for(L=0;L<this.sag+1;L++,Q+=3)N=L/this.sag*2*Math.PI,F[Q]=this.bottomRadius*Math.cos(N),F[Q+1]=this.bottomRadius*Math.sin(N),F[Q+2]=0,B[Q]=L/this.sag,B[Q+1]=1,B[Q+2]=0;for(Q=3*(this.sag+1),L=0;L<this.sag+1;L++,Q+=3)N=L/this.sag*2*Math.PI,F[Q]=this.topRadius*Math.cos(N),F[Q+1]=this.topRadius*Math.sin(N),F[Q+2]=x,B[Q]=L/this.sag,B[Q+1]=0,B[Q+2]=0;if(u)for(N=0,O=0;O<this.sag;O++)N=O/this.sag*2*Math.PI,F[Q]=F[3*(this.sag+O+1)],B[Q++]=(Math.cos(N)+1)/2,F[Q]=F[3*(this.sag+O+1)+1],B[Q++]=1-(Math.sin(N)+1)/2,F[Q]=F[3*(this.sag+O+1)+2],B[Q++]=0;if(p)for(N=0,O=0;O<this.sag;O++)N=O/this.sag*2*Math.PI,F[Q]=F[3*(this.sag-1-O)],B[Q++]=(Math.cos(N)+1)/2,F[Q]=F[3*(this.sag-1-O)+1],B[Q++]=1-(Math.sin(N)+1)/2,F[Q]=F[3*(this.sag-1-O)+2],B[Q++]=0;F=A.data,Q=0;for(var K=0;K<2;K++)for(L=0;L<this.sag+1;L++)N=L/this.sag*2*Math.PI,(G=new t.Vector3).x=E.data[3*L],G.y=E.data[3*L+1],G.z=E.data[3*L+2],G.z=Math.sqrt(G.x*G.x+G.y*G.y)*b,G.normalize(),f?(F[Q++]=-G.x,F[Q++]=-G.y,F[Q++]=-G.z):(F[Q++]=G.x,F[Q++]=G.y,F[Q++]=G.z);if(u)for(K=0;K<this.sag;K++)F[Q++]=0,F[Q++]=0,F[Q++]=1;if(p)for(K=0;K<this.sag;K++)F[Q++]=0,F[Q++]=0,F[Q++]=-1;for(O=0;O<M;O++)(G=new t.Vector3).x=E.data[3*O],G.y=E.data[3*O+1],G.z=E.data[3*O+2],G.applyMatrix4(y),E.data[3*O]=G.x,E.data[3*O+1]=G.y,E.data[3*O+2]=G.z;for(O=0;O<C;O++)(G=new t.Vector3).x=A.data[3*O],G.y=A.data[3*O+1],G.z=A.data[3*O+2],G.applyMatrix4(S),A.data[3*O]=G.x,A.data[3*O+1]=G.y,A.data[3*O+2]=G.z;return(U=new i.Primitive).nbIndices=6*this.sag,U.connectivity=i.ConnectivityTypeEnum.TRIANGLES,U.attr={fill:new i.FillAttributes(k,1),line:new i.LineAttributes,point:new i.PointAttributes},(z=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,z.nbVertices=2*this.sag,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=0,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=0,(H=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,H.nbVertices=2*this.sag,H.nbValuesPerVertex=3,H.format=i.DataTypeEnum.FLOAT,H.cardinality=0,H.bufferId=1,H.indices=new i.IndexArray,H.indices.format=i.DataTypeEnum.UINT,H.indices.bufferId=3,H.indices.offset=0,(W=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,W.nbVertices=2*this.sag,W.nbValuesPerVertex=3,W.format=i.DataTypeEnum.FLOAT,W.cardinality=0,W.bufferId=2,W.indices=new i.IndexArray,W.indices.format=i.DataTypeEnum.UINT,W.indices.bufferId=3,W.indices.offset=0,U.addVertexComponent(z),U.addVertexComponent(H),U.addVertexComponent(W),P.addPrimitive(U),u&&((j=new i.Primitive).nbIndices=3*(this.sag-2),j.connectivity=i.ConnectivityTypeEnum.TRIANGLES,j.attr={fill:new i.FillAttributes(k,1),line:new i.LineAttributes,point:new i.PointAttributes},(z=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,z.nbVertices=this.sag,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=0,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=6*this.sag,(H=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,H.nbVertices=this.sag,H.nbValuesPerVertex=3,H.format=i.DataTypeEnum.FLOAT,H.cardinality=0,H.bufferId=1,H.indices=new i.IndexArray,H.indices.format=i.DataTypeEnum.UINT,H.indices.bufferId=3,H.indices.offset=6*this.sag,(W=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,W.nbVertices=this.sag,W.nbValuesPerVertex=3,W.format=i.DataTypeEnum.FLOAT,W.cardinality=0,W.bufferId=2,W.offset=2*(this.sag+1),j.addVertexComponent(z),j.addVertexComponent(H),j.addVertexComponent(W),P.addPrimitive(j)),p&&(X=6*this.sag,u&&(X+=3*(this.sag-2)),(q=new i.Primitive).nbIndices=3*(this.sag-2),q.connectivity=i.ConnectivityTypeEnum.TRIANGLES,q.attr={fill:new i.FillAttributes(k,1),line:new i.LineAttributes,point:new i.PointAttributes},(z=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,z.nbVertices=this.sag,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=0,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=X,(H=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,H.nbVertices=this.sag,H.nbValuesPerVertex=3,H.format=i.DataTypeEnum.FLOAT,H.cardinality=0,H.bufferId=1,H.indices=new i.IndexArray,H.indices.format=i.DataTypeEnum.UINT,H.indices.bufferId=3,H.indices.offset=X,(W=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,W.nbVertices=this.sag+2,W.nbValuesPerVertex=3,W.format=i.DataTypeEnum.FLOAT,W.cardinality=0,W.bufferId=2,W.offset=u?this.sag:0,W.offset+=2*(this.sag+1),q.addVertexComponent(z),q.addVertexComponent(H),q.addVertexComponent(W),P.addPrimitive(q)),P.noz=Z>0,P},createLine:function(e,t,r,n){var a,s,o,l,h,c,d,u,p=i.ConnectivityTypeEnum.LINE_STRIP,f=!1,g=!1,m=!1;if(e instanceof Array)console.warn("DEPRECATED: Please use a litteral object to define your primitive."),a=e,h=r,s=[],o=[],d=void 0!==t?t:new i.Color(.5,.5,.5,1),u=n||0;else if(e instanceof Object){if(a=e.points,s=e.colors?e.colors:[],o=e.idx?e.idx:[],p=e.drawMode?e.drawMode:p,f=!!e.editable&&e.editable,l=e.patternOffsets?e.patternOffsets:[],p!==i.ConnectivityTypeEnum.LINES&&p!==i.ConnectivityTypeEnum.LINE_STRIP&&(console.warn("Invalid draw mode for the line, passing to strip mode"),p=i.ConnectivityTypeEnum.LINE_STRIP),p===i.ConnectivityTypeEnum.LINES&&0===o.length)for(var v=0;v<a.length-1;v++)o.push(v),o.push(v+1);if(e.hasOwnProperty("material")){h=e.material.lineWidth,g=function(){if(0===o.length)return!1;if(e.material.is2DLine)return e.material.isDashedLine;for(var t=new Set,i=0,r=0;r<o.length;r++){var n=o[r];if(t.has(n)&&n!==i)return!0;i=n,t.add(n)}return!1}(),d=void 0!==e.material.color?e.material.color:new i.Color(.5,.5,.5,1),l.length&&l.length===o.length&&(m=!0)}else h=e.width,d=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1);u=e.layerNb?e.layerNb:0}if(g){var y=[],S=[],_=[];for(v=0;v<o.length;v++){var x=o[v];y.push(a[x]),s.length&&S.push(s[x]),m&&_.push(l[x]),o[v]=v}a=y,s=S,l=_}var b=a.length,w=s.length,M=o.length;if(!b)return null;var C=function(e,t,r,n,a){var s=new i.Buffer;return s.size=e*t,s.component=r,s.format=n,s.dimension=e,s.data=new Float32Array(s.size),s},P=new i.PrimitiveGroup;P.fillAttr=new i.FillAttributes,P.lineAttr=new i.LineAttributes(d,h),P.pointAttr=new i.PointAttributes;var E=0,A=C(3,b,i.VertexComponentEnum.POSITION,i.DataTypeEnum.FLOAT),T=E++;P.addBuffer(T,A),c=A.data;for(v=0;v<b;v++){var D=a[v];c[3*v]=D.x,c[3*v+1]=D.y,c[3*v+2]=D.z}var I=!1,R=0;if(w===b){I=C(4,w,i.VertexComponentEnum.DIFFUSE_COLOR,i.DataTypeEnum.FLOAT),R=E++,P.addBuffer(R,I),c=I.data;for(v=0;v<w;v++){var O=s[v];c[4*v]=O.x,c[4*v+1]=O.y,c[4*v+2]=O.z,c[4*v+3]=O.w}}var L,V,F=!1,B=0;if(M){B=E++,L=o.length,(V=new i.Buffer).indexBuffer=!0,V.size=L,V.format=i.DataTypeEnum.UINT,V.dimension=1,V.data=L>65535?new Uint32Array(V.size):new Uint16Array(V.size),F=V,P.addBuffer(B,F),c=F.data;for(v=0;v<M;v++)c[v]=o[v]}m&&(P.patternOffsets=l);var N=new i.Primitive;N.nbIndices=M||b,N.connectivity=p,N.attr={fill:new i.FillAttributes(d),line:new i.LineAttributes(d,h),point:new i.PointAttributes};var G,k=function(e,t,r,n,a,s){var o=new i.VertexComponent;return o.component=e.component,o.nbValuesPerVertex=e.dim,o.format=e.format,o.nbVertices=r,o.cardinality=0,o.bufferId=t,n&&(o.indices=new i.IndexArray,o.indices.format=n.format,o.indices.bufferId=a,o.indices.offset=s),o},U=k(A,T,b,F,B,0);return N.addVertexComponent(U),w&&(G=k(I,R,w,F,B,0),N.addVertexComponent(G)),P.addPrimitive(N),P.noz=u>0,P.editable=f,P},createRectangle:function(e,r,n,a,s,o){var l,h,c,d,u,p,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A,T;e instanceof Object?(w=e.width?e.width:1,M=e.height?e.height:1,C=!!e.fill&&e.fill,v=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),P=!!e.noEdge&&e.noEdge,E=e.layerNb?e.layerNb:0,A=!!e.sharing&&e.sharing,T=e.cornerPoint?e.cornerPoint:new t.Vector2(0,0)):(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),w=e||1,M=r||1,C=n||!1,v=void 0!==a?a:new i.Color(.5,.5,.5,1),P=s||!1,E=o||0,T=new t.Vector2(0,0),A=!1),(l=new i.PrimitiveGroup).sharing=A,l.fillAttr=new i.FillAttributes,l.lineAttr=new i.LineAttributes,l.pointAttr=new i.PointAttributes,(h=new i.Buffer).size=15,h.component=i.VertexComponentEnum.POSITION,h.format=i.DataTypeEnum.FLOAT,h.dimension=3,h.data=new Float32Array(h.size),(c=new i.Buffer).size=3,c.component=i.VertexComponentEnum.NORMAL,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(c.size),(d=new i.Buffer).size=12,d.component=i.VertexComponentEnum.TEX_COORD_0,d.format=i.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(d.size),(u=new i.Buffer).indexBuffer=!0,u.size=C?9:5,u.format=i.DataTypeEnum.UINT,u.dimension=1,u.data=new Uint16Array(u.size),(p=new i.Buffer).indexBuffer=!0,p.size=5,p.format=i.DataTypeEnum.UINT,p.dimension=1,p.data=new Uint16Array(p.size),(f=new i.Buffer).indexBuffer=!0,f.size=C?4:0,f.format=i.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(f.size),l.addBuffer(0,h),l.addBuffer(1,c),l.addBuffer(2,u),l.addBuffer(3,p),l.addBuffer(4,d),l.addBuffer(5,f),m=0,(g=u.data)[m++]=0,g[m++]=1,g[m++]=2,g[m++]=3,g[m++]=4,C&&(g[m++]=0,g[m++]=1,g[m++]=3,g[m++]=2),m=0,(g=p.data)[m++]=0,g[m++]=0,g[m++]=0,g[m++]=0,g[m++]=0,g=f.data,m=0,C&&(g[m++]=0,g[m++]=1,g[m++]=3,g[m++]=2),g=h.data,m=0;var D=e.delta&&e.delta.x?e.delta.x:0,I=e.delta&&e.delta.y?e.delta.y:0;return g[m++]=T.x+D,g[m++]=T.y+I,g[m++]=0,g[m++]=w+T.x+D,g[m++]=T.y+I,g[m++]=0,g[m++]=w+T.x+D,g[m++]=M+T.y+I,g[m++]=0,g[m++]=T.x+D,g[m++]=M+T.y+I,g[m++]=0,g[m++]=T.x+D,g[m++]=T.y+I,g[m++]=0,m=0,(g=c.data)[m++]=0,g[m++]=0,g[m++]=1,m=0,(g=d.data)[m++]=0,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=1,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=0,P||((y=new i.Primitive).nbIndices=5,y.connectivity=i.ConnectivityTypeEnum.LINE_STRIP,y.attr={fill:new i.FillAttributes(v),line:new i.LineAttributes(v),point:new i.PointAttributes},(S=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,S.nbVertices=5,S.nbValuesPerVertex=3,S.format=i.DataTypeEnum.FLOAT,S.cardinality=0,S.bufferId=0,S.indices=new i.IndexArray,S.indices.format=i.DataTypeEnum.UINT,S.indices.bufferId=2,S.indices.offset=0,(b=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,b.nbVertices=1,b.nbValuesPerVertex=3,b.format=i.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=1,b.indices=new i.IndexArray,b.indices.format=i.DataTypeEnum.UINT,b.indices.bufferId=3,b.indices.offset=0,y.addVertexComponent(S),y.addVertexComponent(b),l.addPrimitive(y)),C&&((x=new i.Primitive).nbIndices=4,x.connectivity=i.ConnectivityTypeEnum.TRIANGLE_STRIP,x.attr={fill:new i.FillAttributes(v),line:new i.LineAttributes,point:new i.PointAttributes},(S=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,S.nbVertices=4,S.nbValuesPerVertex=3,S.format=i.DataTypeEnum.FLOAT,S.cardinality=0,S.bufferId=0,S.indices=new i.IndexArray,S.indices.format=i.DataTypeEnum.UINT,S.indices.bufferId=2,S.indices.offset=5,(b=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,b.nbVertices=1,b.nbValuesPerVertex=3,b.format=i.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=1,b.indices=new i.IndexArray,b.indices.format=i.DataTypeEnum.UINT,b.indices.bufferId=3,b.indices.offset=0,(_=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,_.nbVertices=4,_.nbValuesPerVertex=3,_.format=i.DataTypeEnum.FLOAT,_.cardinality=0,_.bufferId=4,_.indices=new i.IndexArray,_.indices.format=i.DataTypeEnum.UINT,_.indices.bufferId=5,_.indices.offset=0,x.addVertexComponent(S),x.addVertexComponent(b),x.addVertexComponent(_),l.addPrimitive(x)),l.noz=E>0,l},createCircle:function(e,t,r,n,a,s,o){var l,h,c,d,u,p,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A,T,D,I,R,O;for(e instanceof Object?(D=e.radius?e.radius:1,I=e.segments?e.segments:24,E=void 0!==e.startAngle?e.startAngle:0,A=void 0!==e.endAngle?e.endAngle:2*Math.PI,R=!!e.fill&&e.fill,_=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),T=!!e.noEdge&&e.noEdge,O=e.layerNb?e.layerNb:0):(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),D=e||1,I=t||24,E=void 0!==n?n:0,A=void 0!==a?a:2*Math.PI,R=r||!1,T=!1,_=void 0!==s?s:new i.Color(.5,.5,.5,1),O=o||0),P=A-E,(l=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,l.lineAttr=new i.LineAttributes,l.pointAttr=new i.PointAttributes,(h=new i.Buffer).size=3*(I+2),h.component=i.VertexComponentEnum.POSITION,h.format=i.DataTypeEnum.FLOAT,h.dimension=3,h.data=new Float32Array(h.size),(c=new i.Buffer).size=3,c.component=i.VertexComponentEnum.NORMAL,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(c.size),(d=new i.Buffer).size=6,d.component=i.VertexComponentEnum.TEX_COORD_0,d.format=i.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(d.size),(u=new i.Buffer).indexBuffer=!0,u.size=R?2*(I+1)+1:I+1,u.format=i.DataTypeEnum.UINT,u.dimension=1,u.data=new Uint16Array(u.size),(p=new i.Buffer).indexBuffer=!0,p.size=I+2,p.format=i.DataTypeEnum.UINT,p.dimension=1,p.data=new Uint16Array(p.size),(f=new i.Buffer).indexBuffer=!0,f.size=R?I+2:0,f.format=i.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(f.size),l.addBuffer(0,h),l.addBuffer(1,c),l.addBuffer(2,d),l.addBuffer(3,u),l.addBuffer(4,p),l.addBuffer(5,f),g=u.data,m=0,v=1;v<I+2;v++)g[m++]=v;if(R)for(m=I+1,g[m++]=0,v=1;v<I+2;v++)g[m++]=v;for(g=p.data,m=0,m=0;m<=I+2;m++)g[m++]=0;if(R)for((g=f.data)[0]=0,m=1;m<=I+2;m++)g[m]=1;for(m=0,(g=h.data)[m++]=0,g[m++]=0,g[m++]=0,v=0;v<I+2;v++)S=v/I*P+E,g[m++]=D*Math.cos(S),g[m++]=D*Math.sin(S),g[m++]=0;return y=0,(g=c.data)[y++]=0,g[y++]=0,g[y++]=1,y=0,(g=d.data)[y++]=0,g[y++]=0,g[y++]=0,g[y++]=1,g[y++]=0,g[y++]=0,T||((x=new i.Primitive).nbIndices=I+1,x.connectivity=i.ConnectivityTypeEnum.LINE_STRIP,x.attr={fill:new i.FillAttributes(_),line:new i.LineAttributes,point:new i.PointAttributes},(b=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,b.nbVertices=I+2,b.nbValuesPerVertex=3,b.format=i.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=0,b.indices=new i.IndexArray,b.indices.format=i.DataTypeEnum.UINT,b.indices.bufferId=3,b.indices.offset=0,(M=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,M.nbVertices=1,M.nbValuesPerVertex=3,M.format=i.DataTypeEnum.FLOAT,M.cardinality=0,M.bufferId=1,M.indices=new i.IndexArray,M.indices.format=i.DataTypeEnum.UINT,M.indices.bufferId=4,M.indices.offset=0,x.addVertexComponent(b),x.addVertexComponent(M),l.addPrimitive(x)),R&&((w=new i.Primitive).nbIndices=I+2,w.connectivity=i.ConnectivityTypeEnum.TRIANGLE_FAN,w.attr={fill:new i.FillAttributes(_),line:new i.LineAttributes,point:new i.PointAttributes},(b=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,b.nbVertices=I+2,b.nbValuesPerVertex=3,b.format=i.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=0,b.indices=new i.IndexArray,b.indices.format=i.DataTypeEnum.UINT,b.indices.bufferId=3,b.indices.offset=I+1,(M=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,M.nbVertices=1,M.nbValuesPerVertex=3,M.format=i.DataTypeEnum.FLOAT,M.cardinality=0,M.bufferId=1,M.indices=new i.IndexArray,M.indices.format=i.DataTypeEnum.UINT,M.indices.bufferId=4,M.indices.offset=0,(C=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,C.nbVertices=2,C.nbValuesPerVertex=3,C.format=i.DataTypeEnum.FLOAT,C.cardinality=0,C.bufferId=2,C.indices=new i.IndexArray,C.indices.format=i.DataTypeEnum.UINT,C.indices.bufferId=5,C.indices.offset=0,w.addVertexComponent(b),w.addVertexComponent(M),w.addVertexComponent(C),l.addPrimitive(w)),l.noz=O>0,l},createTorus:function(e,r,n,a,s,o,l,h){var c,d,u,p,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A,T,D,I,R,O,L,V,F,B,N;for(e instanceof t.Matrix4?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.axis=e||null,this.majorRadius=r||100,this.minorRadius=n||40,this.majorStartAngle=a||0,this.majorEndAngle=s||2*Math.PI,this.sag=o||8,O=void 0!==l?l:new i.Color(.5,.5,.5,1),N=h||0):e instanceof Object&&(this.axis=e.axis||null,this.majorRadius=e.majorRadius||100,this.minorRadius=e.minorRadius||40,this.majorStartAngle=e.majorStartAngle||0,this.majorEndAngle=e.majorEndAngle||2*Math.PI,this.sag=e.sag||8,O=e.color||(void 0!==l?l:new i.Color(.5,.5,.5,1)),N=h||0),c=(this.majorEndAngle-this.majorStartAngle)/this.sag,d=(this.sag+1)*(this.sag+1),u=6*this.sag*this.sag,(p=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,p.lineAttr=new i.LineAttributes,p.pointAttr=new i.PointAttributes,(f=new i.Buffer).size=3*d,f.component=i.VertexComponentEnum.POSITION,f.format=i.DataTypeEnum.FLOAT,f.dimension=3,f.data=new Float32Array(f.size),(I=new i.Buffer).size=3*d,I.component=i.VertexComponentEnum.NORMAL,I.format=i.DataTypeEnum.FLOAT,I.dimension=3,I.data=new Float32Array(I.size),(g=new i.Buffer).size=3*d,g.component=i.VertexComponentEnum.TEX_COORD_0,g.format=i.DataTypeEnum.FLOAT,g.dimension=3,g.data=new Float32Array(g.size),(m=new i.Buffer).indexBuffer=!0,m.size=u,m.format=i.DataTypeEnum.UINT,m.dimension=1,m.data=new Uint16Array(m.size),p.addBuffer(0,f),p.addBuffer(1,I),p.addBuffer(2,g),p.addBuffer(3,m),v=m.data,_=0,w=0;w<this.sag;++w)for(T=w+1,M=0;M<this.sag;++M)D=M+1,v[_]=w*(this.sag+1)+M,v[_+1]=T*(this.sag+1)+M,v[_+2]=w*(this.sag+1)+D,v[_+3]=T*(this.sag+1)+D,v[_+4]=w*(this.sag+1)+D,v[_+5]=T*(this.sag+1)+M,_+=6;for(v=f.data,y=I.data,S=g.data,x=0,b=new t.Vector3,w=0;w<this.sag+1;w++)for(C=this.majorStartAngle+w*c,M=0;M<this.sag+1;M++,x+=3)P=M/this.sag*2*Math.PI,b.x=this.majorRadius*Math.cos(C),b.y=this.majorRadius*Math.sin(C),(E=new t.Vector3).x=(this.majorRadius+this.minorRadius*Math.cos(P))*Math.cos(C),E.y=(this.majorRadius+this.minorRadius*Math.cos(P))*Math.sin(C),E.z=this.minorRadius*Math.sin(P),A=E.clone(),this.axis&&E.applyMatrix4(this.axis),v[x]=E.x,v[x+1]=E.y,v[x+2]=E.z,(R=new t.Vector3).subVectors(A,b).normalize(),this.axis&&R.applyMatrix4(this.axis),R.normalize(),y[x]=R.x,y[x+1]=R.y,y[x+2]=R.z,S[x]=w/this.sag,S[x+1]=1-M/this.sag,S[x+2]=0;return(L=new i.Primitive).nbIndices=u,L.connectivity=i.ConnectivityTypeEnum.TRIANGLES,L.attr={fill:new i.FillAttributes(O,1),line:new i.LineAttributes,point:new i.PointAttributes},(V=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,V.nbVertices=d,V.nbValuesPerVertex=3,V.format=i.DataTypeEnum.FLOAT,V.cardinality=0,V.bufferId=0,V.indices=new i.IndexArray,V.indices.format=i.DataTypeEnum.UINT,V.indices.bufferId=3,V.indices.offset=0,(B=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,B.nbVertices=d,B.nbValuesPerVertex=3,B.format=i.DataTypeEnum.FLOAT,B.cardinality=0,B.bufferId=1,B.indices=new i.IndexArray,B.indices.format=i.DataTypeEnum.UINT,B.indices.bufferId=3,B.indices.offset=0,(F=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,F.nbVertices=d,F.nbValuesPerVertex=3,F.format=i.DataTypeEnum.FLOAT,F.cardinality=0,F.bufferId=2,F.indices=new i.IndexArray,F.indices.format=i.DataTypeEnum.UINT,F.indices.bufferId=3,F.indices.offset=0,L.addVertexComponent(V),L.addVertexComponent(B),L.addVertexComponent(F),p.addPrimitive(L),p.noz=N>0,p},createPoints:function(e,t,r,n){var a=this.createMesh(e,void 0,void 0,void 0,i.ConnectivityTypeEnum.POINTS,t,n,void 0,void 0,void 0,r);return a.pointAttr.size=r,a.noz=n>0,a},createMesh:function(e,r,n,a,s,o,l,h,c,d,u){var p,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A,T,D,I,R;if(C=new t.Vector3,P=new t.Vector3,this.bufferPosition=void 0!==e?e:[],this.bufferNormal=void 0!==r?r:[],this.bufferUV=void 0!==n?n:[],this.bufferColor=void 0!==d?d:[],this.bufferIndex=void 0!==a?a:[],this.glType=void 0!==s?s:i.ConnectivityTypeEnum.TRIANGLES,p=this.bufferPosition.length,f=this.bufferNormal.length,g=this.bufferUV.length,m=this.bufferColor.length,v=this.bufferIndex.length,(y=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,y.lineAttr=new i.LineAttributes,y.pointAttr=new i.PointAttributes,_=null,x=null,b=null,(S=new i.Buffer).size=p,S.component=i.VertexComponentEnum.POSITION,S.format=i.DataTypeEnum.FLOAT,S.dimension=3,S.data=new Float32Array(this.bufferPosition),y.addBuffer(0,S),f&&((_=new i.Buffer).size=f,_.component=i.VertexComponentEnum.NORMAL,_.format=i.DataTypeEnum.FLOAT,_.dimension=3,_.data=new Float32Array(this.bufferNormal),y.addBuffer(1,_)),g&&((x=new i.Buffer).size=g,x.component=i.VertexComponentEnum.TEX_COORD_0,x.format=i.DataTypeEnum.FLOAT,x.dimension=3,x.data=new Float32Array(this.bufferUV),y.addBuffer(2,x)),m&&((b=new i.Buffer).size=m,b.component=i.VertexComponentEnum.DIFFUSE_COLOR,b.format=i.DataTypeEnum.FLOAT,b.dimension=3,b.data=new Float32Array(this.bufferColor),y.addBuffer(4,b)),v&&((w=new i.Buffer).indexBuffer=!0,w.size=v,w.format=i.DataTypeEnum.UINT,w.dimension=1,w.data=v>65535?new Uint32Array(this.bufferIndex):new Uint16Array(this.bufferIndex),y.addBuffer(3,w)),h){for(M=0;M<p/3;M++)C.x=S.data[3*M],C.y=S.data[3*M+1],C.z=S.data[3*M+2],h.multiplyVector3(C),S.data[3*M]=C.x,S.data[3*M+1]=C.y,S.data[3*M+2]=C.z;for(M=0;M<f/3;M++)P.x=_.data[3*M],P.y=_.data[3*M+1],P.z=_.data[3*M+2],h.multiplyVector3(P),_.data[3*M]=P.x,_.data[3*M+1]=P.y,_.data[3*M+2]=P.z}E="undefined"!==o?o:new i.Color(.5,.5,.5,1);var O=u||1;return(A=new i.Primitive).nbIndices=v||p/3,A.connectivity=this.glType,A.attr={fill:new i.FillAttributes(E),line:new i.LineAttributes(E),point:new i.PointAttributes(E,O)},(T=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,T.nbVertices=p/3,T.nbValuesPerVertex=3,T.format=i.DataTypeEnum.FLOAT,T.cardinality=0,T.bufferId=0,T.indices=null,v&&(T.indices=new i.IndexArray,T.indices.format=i.DataTypeEnum.UINT,T.indices.bufferId=3,T.indices.offset=0),A.addVertexComponent(T),f&&((D=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,D.nbVertices=f/3,D.nbValuesPerVertex=3,D.format=i.DataTypeEnum.FLOAT,D.cardinality=0,D.bufferId=1,D.indices=null,v&&(D.indices=new i.IndexArray,D.indices.format=i.DataTypeEnum.UINT,D.indices.bufferId=3,D.indices.offset=0),A.addVertexComponent(D)),g&&((I=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,I.nbVertices=g/3,I.nbValuesPerVertex=3,I.format=i.DataTypeEnum.FLOAT,I.cardinality=0,I.bufferId=2,I.indices=null,v&&(I.indices=new i.IndexArray,I.indices.format=i.DataTypeEnum.UINT,I.indices.bufferId=3,I.indices.offset=0),A.addVertexComponent(I)),m&&((R=new i.VertexComponent).component=i.VertexComponentEnum.DIFFUSE_COLOR,R.nbVertices=m/3,R.nbValuesPerVertex=3,R.format=i.DataTypeEnum.FLOAT,R.cardinality=0,R.bufferId=4,R.indices=null,v&&(R.indices=new i.IndexArray,R.indices.format=i.DataTypeEnum.UINT,R.indices.bufferId=3,R.indices.offset=0),A.addVertexComponent(R)),y.addPrimitive(A),l&&(l.force=!0,y.material=l),y.noz=c>0,y},createText:function(e,i,n,a,s,o){var l,h,c,d,u,p,f,g,m;void 0===s&&(s=32),l="font-family: "+i+"; font-size: "+s+"px;",u=(c=(h=this._determineTextSize(e,l)).width)/(d=h.height),(p=r).width=c,p.height=d,(f=p.getContext("2d")).fillStyle="#"+a.getHexString(),f.lineWidth=0,f.strokeStyle="#"+a.getHexString(),f.font=s+"px "+i,f.textAlign="left",f.textBaseline="top",f.fillText(e,0,0),f.restore(),g=c/s,m=this.createRectangle(n*g,n*g/u,!0,void 0,void 0,o);var v=void 0;if(0!=p.width||0!=p.height){for(var y=f.getImageData(0,0,p.width,p.height),S=new ArrayBuffer(y.data.length),_=new Uint8Array(S),x=0;x<4*p.width*p.height;++x)_[x]=y.data[x];(v=new t.DataTexture(_,p.width,p.height,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearMipMapLinearFilter)).needsUpdate=!0}return m.material=new t.MeshBasicMaterial({map:v,transparent:!0}),m.material.force=!0,m.noz=o>0,m},convertFromTHREEMesh:function(e){if(e instanceof t.Mesh){var r,n,a,s,o,l,h,c,d,u,p,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A,T,D,I,R,O=function(e,t,i,r){return Math.abs(e.x-t[i])<1e-5&&Math.abs(e.y-t[i+1])<1e-5&&(2===r||Math.abs(e.z-t[i+2])<1e-5)},L={x:0,y:0};if(0===(R=e.geometry)._type){D=[],I=[],A=!1;var V=R.faces,F=R.faceVertexUvs[0];for(r=0;r<V.length;r++)I[r]={face:V[r],uv:F?F[r]:null};for(e.material instanceof t.MeshFaceMaterial&&(A=!0,I.sort(function(e,t){return e.face.materialIndex-t.face.materialIndex})),o=0,l=0,C=0,M=[],P=0,T=I.length&&void 0!==I[0].face.materialIndex?I[0].face.materialIndex:-1,r=0;r<I.length;r++){var B=I[r].face;A&&T!==B.materialIndex&&(M[C]={nbIndices:o,nbVertices:l,start:P,end:r,material:A?e.material.materials[T]:e.material},C+=1,P=r,o=0,l=0,T=B.materialIndex),B instanceof t.Face3?(o+=3,l+=3):(o+=6,l+=4)}0!=o&&(M[C]={nbIndices:o,nbVertices:l,start:P,end:r,material:A?e.material.materials[T]:e.material}),f=R.vertices;var N=new Int32Array(f.length),G=["a","b","c","d"];for(s=0;s<M.length;s++){var k=M[s],U=!1;l=k.nbVertices,o=k.nbIndices,h=new Float32Array(3*l),c=new Float32Array(3*l),d=new Float32Array(3*l),u=new Float32Array(3*l),p=new Uint32Array(o);var z=0;for(r=0;r<N.length;r++)N[r]=-1;for(P=k.start,E=k.end,a=0,r=P;r<E;r++){g=I[r].face,b=I[r].uv,v=g.vertexNormals&&g.vertexNormals.length?g.vertexNormals:null,y=g.vertexColors&&g.vertexColors.length?g.vertexColors:null,S=g.normal,null,v&&v.length||(v=null),y&&y.length||(y=null);var H=g instanceof t.Face4?4:3;for(n=0;n<H;n++){var W;_=v?v[n]:S,x=y?y[n]:null,w=b?b[n]:L,-1===(W=N[g[G[n]]])||!O(_,c,3*W,3)||!O(w,u,3*W,2)||x&&!O(x,d,3*W,3)?(N[g[G[n]]]=z,m=f[g[G[n]]],h[3*z]=m.x,h[3*z+1]=m.y,h[3*z+2]=m.z,c[3*z]=_.x,c[3*z+1]=_.y,c[3*z+2]=_.z,x&&(U=!0,d[3*z]=x.r,d[3*z+1]=x.g,d[3*z+2]=x.b),u[3*z]=w.x,u[3*z+1]=w.y,u[3*z+2]=0,3===n&&(p[a++]=p[a-4],p[a++]=p[a-3]),p[a++]=z++):(3===n&&(p[a++]=p[a-4],p[a++]=p[a-3]),p[a++]=W)}}var j=new Float32Array(3*z),X=new Float32Array(3*z),q=new Float32Array(3*z),Z=new Float32Array(3*z);for(r=0;r<3*z;r++)j[r]=h[r],X[r]=c[r],q[r]=d[r],Z[r]=u[r];h=j,c=X,d=U?q:null,u=Z,U&&(k.material.vertexColors=t.VertexColorType.RGBA),D[D.length]={bufPos:h,bufNorm:c,bufCol:d,bufUV:u,bufInd:p,connectivity:i.ConnectivityTypeEnum.TRIANGLES,material:k.material}}return this.createPrimGroup(D)}}},createPrimGroup:function(e){var t,r,n,a,s,o,l,h,c,d,u,p,f,g,m,v,y,S;for((o=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,o.lineAttr=new i.LineAttributes,o.pointAttr=new i.PointAttributes,p=0;p<e.length;p++){var _=(x=!!e[p].bufCol)?5:4;t=e[p].bufPos.length,r=e[p].bufNorm.length,x&&(n=e[p].bufCol.length),a=e[p].bufUV.length,s=e[p].bufInd.length,(l=new i.Buffer).size=t,l.component=i.VertexComponentEnum.POSITION,l.format=i.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(e[p].bufPos),(h=new i.Buffer).size=r,h.component=i.VertexComponentEnum.NORMAL,h.format=i.DataTypeEnum.FLOAT,h.dimension=3,h.data=new Float32Array(e[p].bufNorm),x&&((c=new i.Buffer).size=n,c.component=i.VertexComponentEnum.DIFFUSE_COLOR,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(e[p].bufCol)),(d=new i.Buffer).size=a,d.component=i.VertexComponentEnum.TEX_COORD_0,d.format=i.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(e[p].bufUV),(u=new i.Buffer).indexBuffer=!0,u.size=s,u.format=i.DataTypeEnum.UINT,u.dimension=1,u.data=new Uint32Array(e[p].bufInd),o.addBuffer(p*_,l),o.addBuffer(1+p*_,h),o.addBuffer(2+p*_,d),o.addBuffer(3+p*_,u),x&&o.addBuffer(4+p*_,c)}for(f=new i.Color(.5,.5,.5,1),p=0;p<e.length;p++){var x;_=(x=!!e[p].bufCol)?5:4;switch(t=e[p].bufPos.length,r=e[p].bufNorm.length,x&&(n=e[p].bufCol.length),a=e[p].bufUV.length,s=e[p].bufInd.length,(g=new i.Primitive).nbIndices=s,g.connectivity=e[p].connectivity,g.connectivity){case i.ConnectivityTypeEnum.TRIANGLES:case i.ConnectivityTypeEnum.TRIANGLE_FAN:case i.ConnectivityTypeEnum.TRIANGLE_STRIP:g.geomType="FACE";break;case i.ConnectivityTypeEnum.LINES:case i.ConnectivityTypeEnum.LINE_STRIP:case i.ConnectivityTypeEnum.LINE_LOOP:g.geomType="WIRE_EDGE";break;case i.ConnectivityTypeEnum.POINTS:g.geomType="FREE_POINT";break;default:g.geomType=null}g.attr={fill:new i.FillAttributes(f),line:new i.LineAttributes,point:new i.PointAttributes},(m=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,m.nbVertices=t/3,m.nbValuesPerVertex=3,m.format=i.DataTypeEnum.FLOAT,m.cardinality=0,m.bufferId=p*_,m.indices=new i.IndexArray,m.indices.format=i.DataTypeEnum.UINT,m.indices.bufferId=3+p*_,m.indices.offset=0,(v=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,v.nbVertices=r/3,v.nbValuesPerVertex=3,v.format=i.DataTypeEnum.FLOAT,v.cardinality=0,v.bufferId=1+p*_,v.indices=new i.IndexArray,v.indices.format=i.DataTypeEnum.UINT,v.indices.bufferId=3+p*_,v.indices.offset=0,x&&((y=new i.VertexComponent).component=i.VertexComponentEnum.DIFFUSE_COLOR,y.nbVertices=n/3,y.nbValuesPerVertex=3,y.format=i.DataTypeEnum.FLOAT,y.cardinality=0,y.bufferId=4+p*_,y.indices=new i.IndexArray,y.indices.format=i.DataTypeEnum.UINT,y.indices.bufferId=3+p*_,y.indices.offset=0),(S=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,S.nbVertices=a/3,S.nbValuesPerVertex=3,S.format=i.DataTypeEnum.FLOAT,S.cardinality=0,S.bufferId=2+p*_,S.indices=new i.IndexArray,S.indices.format=i.DataTypeEnum.UINT,S.indices.bufferId=3+p*_,S.indices.offset=0,g.addVertexComponent(m),g.addVertexComponent(v),x&&g.addVertexComponent(y),g.addVertexComponent(S),g.material=e[p].material,o.addPrimitive(g)}return e[0]&&e[0].material&&(o.material=e[0].material),o},CreateVis3DCuboidFromBox3:function(e,t){var r,n,a,s,o,l,h,c,d,u,p=void 0!==t.color?t.color:new i.Color(.5,.5,.5,1);for((r=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,r.lineAttr=new i.LineAttributes,r.pointAttr=new i.PointAttributes,(n=new i.Buffer).size=72,n.component=i.VertexComponentEnum.POSITION,n.format=i.DataTypeEnum.FLOAT,n.dimension=3,n.data=new Float32Array(n.size),(a=new i.Buffer).size=72,a.component=i.VertexComponentEnum.NORMAL,a.format=i.DataTypeEnum.FLOAT,a.dimension=3,a.data=new Float32Array(a.size),(s=new i.Buffer).indexBuffer=!0,s.size=36,s.format=i.DataTypeEnum.UINT,s.dimension=1,s.data=new Uint16Array(36),r.addBuffer(0,n),r.addBuffer(1,a),r.addBuffer(2,s),o=s.data,l=0,h=0;h<6;h++)o[l++]=4*h,o[l++]=4*h+1,o[l++]=4*h+2,o[l++]=4*h,o[l++]=4*h+2,o[l++]=4*h+3;var f=e.min.x,g=e.max.x,m=e.min.y,v=e.max.y,y=e.min.z,S=e.max.z;for(l=0,(o=n.data)[l++]=g,o[l++]=m,o[l++]=y,o[l++]=g,o[l++]=v,o[l++]=y,o[l++]=g,o[l++]=v,o[l++]=S,o[l++]=g,o[l++]=m,o[l++]=S,o[l++]=g,o[l++]=v,o[l++]=y,o[l++]=f,o[l++]=v,o[l++]=y,o[l++]=f,o[l++]=v,o[l++]=S,o[l++]=g,o[l++]=v,o[l++]=S,o[l++]=g,o[l++]=m,o[l++]=S,o[l++]=g,o[l++]=v,o[l++]=S,o[l++]=f,o[l++]=v,o[l++]=S,o[l++]=f,o[l++]=m,o[l++]=S,o[l++]=f,o[l++]=m,o[l++]=y,o[l++]=g,o[l++]=m,o[l++]=y,o[l++]=g,o[l++]=m,o[l++]=S,o[l++]=f,o[l++]=m,o[l++]=S,o[l++]=f,o[l++]=v,o[l++]=y,o[l++]=f,o[l++]=m,o[l++]=y,o[l++]=f,o[l++]=m,o[l++]=S,o[l++]=f,o[l++]=v,o[l++]=S,o[l++]=g,o[l++]=m,o[l++]=y,o[l++]=f,o[l++]=m,o[l++]=y,o[l++]=f,o[l++]=v,o[l++]=y,o[l++]=g,o[l++]=v,o[l++]=y,o=a.data,l=0,h=0;h<4;h++)o[l++]=1,o[l++]=0,o[l++]=0;for(h=0;h<4;h++)o[l++]=0,o[l++]=1,o[l++]=0;for(h=0;h<4;h++)o[l++]=0,o[l++]=0,o[l++]=1;for(h=0;h<4;h++)o[l++]=0,o[l++]=-1,o[l++]=0;for(h=0;h<4;h++)o[l++]=-1,o[l++]=0,o[l++]=0;for(h=0;h<4;h++)o[l++]=0,o[l++]=0,o[l++]=-1;for(h=0;h<6;h++)c=new i.Primitive({nbIndices:6,connectivity:i.ConnectivityTypeEnum.TRIANGLES,fillGAS:new i.FillAttributes(p,1),lineGAS:new i.LineAttributes,pointGAS:new i.PointAttributes}),d=new i.VertexComponent({nbVertices:4,bufferId:0,indices:new i.IndexArray({bufferId:2,offset:6*h})}),u=new i.VertexComponent({nbVertices:4,bufferId:1,indices:new i.IndexArray({bufferId:2,offset:6*h})}),c.addVertexComponent(d),c.addVertexComponent(u),r.addPrimitive(c);return r},_determineTextSize:function(e,t,i){var r,n,a,s,o;r=document.getElementsByTagName("body")[0],(n=document.createElement("div")).setAttribute("style",t);var l=i||"nowrap";return(a=document.createElement("span")).setAttribute("style","white-space: "+l),s=document.createTextNode(e),a.appendChild(s),n.appendChild(a),r.appendChild(n),(o={width:0,height:0}).width=a.offsetWidth,o.height=a.offsetHeight,r.removeChild(n),o}});return UWA.namespace("THREEDS/GeometryHelper",n)}),define("Visualization/GeometryHelper",["DS/Visualization/GeometryHelper","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/GeometryHelper"),e}),define("DS/Visualization/Filters/MaterialToUseFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this.materialToUse=e}}}),define("DS/Visualization/IdPath",["DS/Visualization/PathElement"],function(e){"use strict";var t=function(e){this.ids=e,this._key=null};return t.prototype.removeLastId=function(){this.ids.length>0&&this.ids.length--,this._key=null},t.prototype.clone=function(){var e,i=[];for(e=0;e<this.ids.length;e++)i.push(this.ids[e]);var r=new t(i);return r._key=this._key,r},t.prototype.buildPathElement=function(t){var i,r,n=[];for(r=0;r<this.ids.length;r++){if(!(i=t.idToNode(this.ids[r])))return null;n.push(i)}return new e(n)},t.prototype.getElement=function(e){return this.ids[e]},t.prototype.getLength=function(){return this.ids.length},t.prototype.getFirstElement=function(e){return this.ids[0]},t.prototype.getKey=function(){return null===this._key&&(this._key=t.buildIdPathKey(this.ids)),this._key},t.prototype.getLastId=function(){return this.ids[this.ids.length-1]},t.buildIdPathKey=function(e){var t,i="";for(t=e.length-1;t>=0;t--)i+=e[t],0!==t&&(i+="/");return i},t}),define("DS/Visualization/Filters/ZModeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this.enableZ=e}}}),define("DS/Visualization/MaterialConnection",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=-1,i=1,r=2,n=function(e){e=e||{},this.setParams(e)};return n.prototype.setParams=function(e){this.appearanceId=e.appearanceId||null,this.pathElement=e.pathElement||null,this.type=e.type||n._UNKNOWN,this.status=null!==this.pathElement?i:t,this.vLayer=e.vLayer||0},n.prototype.isComplete=function(){return this.status===i},n.prototype.isIncomplete=function(){return this.status===t},n.prototype.isError=function(){return this.status===r},n.prototype.computeLayer=function(t){var i=this.pathElement.externalPath.length,r=this.vLayer;return this.type===n.CORE_MATERIAL?e.MaterialLayerMax:0+16*i+r},n._UNKNOWN=0,n.COVERAGE_MATERIAL=1,n.CORE_MATERIAL=2,n}),define("DS/Visualization/Measurable",["UWA/Class","DS/Visualization/ThreeJS_R57"],function(e,t){"use strict";var i=[0,8,8,2,2],r=new Uint8Array(4),n=new DataView(r.buffer,0,4),a=new Uint8Array(8),s=new DataView(a.buffer,0,8),o=e.extend({init:function(e){this.sgNode=e,this.size=-1;var t,i=e.getDecoration();if(i){if(i instanceof Array)this.string=i,this.size=this.string[0];else if(e&&(t=e.getGroup())&&t.geometry)if(t.geometry.decorations&&t.geometry.decorations.length){var r=t.geometry.decorations,n=i-1;this.size=r[n]+1,this.string=new Array(this.size);for(var a=0;a<this.size;a++)this.string[a]=r[n++]}else this.string=[]}else this.string=[];this.type=null,this.version=0,this.conversion=!0},getType:function(){return 0==this.size?this.type=o.TYPEUNKNOWN:this.size>0?this.readHeader():this.type=null,this.type},readHeader:function(){var e=0;if(this.size>=i[3]){if(0==this.string[1]){if(this.size>=i[1]){var t=this.readInt(1,2);return this.version=t[0],void(this.type=t[1])}}else this.string[1]=="2".charCodeAt(0)?this.version=2:this.string[1]=="3".charCodeAt(0)?this.version=3:this.string[1]=="4".charCodeAt(0)?this.version=4:this.string[1]=="5".charCodeAt(0)&&(this.version=5),e=this.string[2];switch(e){case 49:this.type=o.TYPEUNKNOWN;break;case 50:this.type=o.TYPEPLANE;break;case 51:this.type=o.TYPECYLINDER;break;case 52:this.type=o.TYPECONE;break;case 53:this.type=o.TYPESPHERE;break;case 54:this.type=o.TYPELINE;break;case 55:this.type=o.TYPECIRCLE;break;case 56:this.type=o.TYPETORUS}}},getPlane:function(){return this.type==o.TYPEPLANE?this.readPlane():null},getCone:function(){return this.type==o.TYPECONE?this.readCone():null},getSphere:function(){return this.type==o.TYPESPHERE?this.readSphere():null},getCircle:function(){return this.type==o.TYPECIRCLE?this.readCircle():null},getCylinder:function(){return this.type==o.TYPECYLINDER?this.readCylinder():null},getLine:function(){return this.type==o.TYPELINE?this.readLine():null},getTorus:function(){return this.type==o.TYPETORUS?this.readTorus():null},readTorus:function(){var e=[0,0,0],t=[0,0,1],r=0,n=0,a=[];if(3==this.version){var s=(a=this.readFloat(i[this.version]+1,8))[0],o=a[1],l=a[2],h=a[3],c=a[4],d=a[5],u=a[6],p=1-h*h-c*c,f=p>=0?Math.sqrt(p):0;d<0&&(f=-f,d=-d),e=[s,o,l],t=[h,c,f],r=u,n=d}else 1==this.version||2==this.version||4==this.version?(e=[(a=this.readDouble(i[this.version]+1,8))[0],a[1],a[2]],t=[a[3],a[4],a[5]],r=a[7],n=a[6]):this.version;return{center:e,axis:t,maxRadius:n,minRadius:r}},readCone:function(){var e=[0,0,0],t=[0,0,1],r=0,n=[];if(3==this.version){var a=(n=this.readFloat(i[this.version]+1,7))[0],s=n[1],o=n[2],l=n[3],h=n[4],c=n[5],d=1-l*l-h*h,u=d>=0?Math.sqrt(d):0;c<0&&(u=-u,c=-c);e=[a,s,o],t=[l,h,u],r=c}else 1==this.version||2==this.version||4==this.version?(e=[(n=this.readDouble(i[this.version]+1,7))[0],n[1],n[2]],t=[n[3],n[4],n[5]],r=n[6]):this.version;return{center:e,axis:t,semiAngle:r}},readCircle:function(){var e=[0,0,0],r=[0,0,1],n=0,a=[];if(3==this.version){e=[(a=this.readFloat(i[this.version]+1,7))[0],a[1],a[2]],n=a[3];var s=this.sgNode.getStart(),o=this.sgNode.getGroup().geometry,l=o.vertexIndexArray[s],h=[o.vertexPositionArray[3*l],o.vertexPositionArray[3*l+1],o.vertexPositionArray[3*l+2]],c=(l=o.vertexIndexArray[s+1],[o.vertexPositionArray[3*l],o.vertexPositionArray[3*l+1],o.vertexPositionArray[3*l+2]]),d=new t.Vector3(h[0],h[1],h[2]),u=new t.Vector3(c[0],c[1],c[2]),p=new t.Vector3(e[0],e[1],e[2]);u.sub(d),p.sub(d),u.cross(p),u.normalize(),r=[u.x,u.y,u.z]}else 1==this.version||2==this.version||4==this.version?(e=[(a=this.readDouble(i[this.version]+1,7))[0],a[1],a[2]],r=[a[3],a[4],a[5]],n=a[6]):this.version;return{center:e,axis:r,radius:n}},readCylinder:function(){var e=[0,0,0],t=[0,0,1],r=0,n=[];if(3==this.version){var a=(n=this.readFloat(i[this.version]+1,7))[0],s=n[1],o=n[2],l=n[3],h=n[4];r=n[5];var c=1-l*l-h*h,d=c>=0?Math.sqrt(c):0;r<0&&(d=-d,r=-r),e=[a,s,o],t=[l,h,d]}else 1==this.version||2==this.version||4==this.version?(e=[(n=this.readDouble(i[this.version]+1,7))[0],n[1],n[2]],t=[n[3],n[4],n[5]],r=n[6]):this.version;return{center:e,axis:t,radius:r}},readSphere:function(){var e=[0,0,0],t=0,r=[];if(3==this.version){var n=(r=this.readFloat(i[this.version]+1,4))[0],a=r[1],s=r[2];t=r[3],e=[n,a,s]}else 1==this.version||2==this.version||4==this.version?(e=[(r=this.readDouble(i[this.version]+1,4))[0],r[1],r[2]],t=r[3]):this.version;return{center:e,radius:t}},readLine:function(){var e=[0,0,0],t=[1,0,0],r=[];if(3==this.version||5==this.version){var n=this.sgNode.getStart(),a=this.sgNode.getGroup().geometry,s=a.vertexIndexArray[n];e=[a.vertexPositionArray[3*s],a.vertexPositionArray[3*s+1],a.vertexPositionArray[3*s+2]];s=a.vertexIndexArray[n+1];t=[a.vertexPositionArray[3*s],a.vertexPositionArray[3*s+1],a.vertexPositionArray[3*s+2]]}else 1!=this.version&&2!=this.version&&4!=this.version||(e=[(r=this.readDouble(i[this.version]+1,6))[0],r[1],r[2]],t=[r[3],r[4],r[5]]);return{startPosition:e,endPosition:t}},readPlane:function(){var e=[0,0,0],t=[1,0,0],r=[];if(3==this.version||5==this.version){var n=this.sgNode.getStart(),a=this.sgNode.getGroup().geometry,s=a.vertexIndexArray[n];e=[a.vertexPositionArray[3*s],a.vertexPositionArray[3*s+1],a.vertexPositionArray[3*s+2]],t=[a.vertexNormalArray[3*s],a.vertexNormalArray[3*s+1],a.vertexNormalArray[3*s+2]]}else 1!=this.version&&2!=this.version&&4!=this.version||(e=[(r=this.readDouble(i[this.version]+1,6))[0],r[1],r[2]],t=[r[3],r[4],r[5]]);return{normal:t,position:e}},readFloat:function(e,t){for(var i=new Array(t),a=0;a<t;a++)r[3]=this.string[e+4*a],r[2]=this.string[e+4*a+1],r[1]=this.string[e+4*a+2],r[0]=this.string[e+4*a+3],i[a]=n.getFloat32(0,this.conversion);return i},readInt:function(e,t){for(var i=new Array(t),a=0;a<t;a++)r[3]=this.string[e+4*a],r[2]=this.string[e+4*a+1],r[1]=this.string[e+4*a+2],r[0]=this.string[e+4*a+3],i[a]=n.getUint32(0,this.conversion);return i},readDouble:function(e,t){for(var i=new Array(t),r=0;r<t;r++)a[7]=this.string[e+8*r],a[6]=this.string[e+8*r+1],a[5]=this.string[e+8*r+2],a[4]=this.string[e+8*r+3],a[3]=this.string[e+8*r+4],a[2]=this.string[e+8*r+5],a[1]=this.string[e+8*r+6],a[0]=this.string[e+8*r+7],i[r]=s.getFloat64(0,this.conversion);return i}});return o.TYPEUNKNOWN=1,o.TYPEPLANE=2,o.TYPECYLINDER=3,o.TYPECONE=4,o.TYPESPHERE=5,o.TYPELINE=7,o.TYPECIRCLE=8,o.TYPETORUS=9,UWA.namespace("THREEDS/Measurable",o)}),define("Visualization/Measurable",["DS/Visualization/Measurable","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Measurable"),e}),define("DS/Visualization/PLMMaterialConnectionFactory",["DS/Visualization/MaterialConnection","DS/Visualization/PathElement","DS/Visualization/IdPathWatcher","DS/Visualization/IdPath"],function(e,t,i,r){"use strict";var n=function(){this.loadAppearanceCB=null,this.getNodeFromIdCB=null,this.computePathElementCB=null,this.idPathWatcher=null,this.appearanceIdMap=new Map,this.internalPathIds=new Map,this.legacyUVIds=new Map,this.oocManager=null};return n.prototype.setParams=function(e){e.loadAppearanceCB&&(this.loadAppearanceCB=e.loadAppearanceCB),e.getNodeFromIdCB&&(this.getNodeFromIdCB=e.getNodeFromIdCB),e.useIdPathMatcher&&e.viewer&&(this.idPathWatcher=new i({viewer:e.viewer,onIdPathActiveCB:this._onIdPathActive.bind(this),onIdPathInactiveCB:this._onIdPathInactive.bind(this)})),e.oocManager&&(this.oocManager=e.oocManager)},n.prototype.addMaterialConnection=function(e,t){if(this.idPathWatcher){if(t.legacyUV){var i=(n=t.idPath)[n.length-1];this._addLegacyUVId(i)}if(t.internalPath){var n,a="##REP##"+(i=(n=t.idPath)[n.length-1]);t.idPath=n.concat([a]),this._addInternalIdPathId(i)}var s=t.appearanceId,o=this.appearanceIdMap.get(s);o?o[1]=t:(o=[e,t],this.appearanceIdMap.set(s,o),this.idPathWatcher.addIdPath(new r(t.idPath),o))}else this._addMaterialConnectionOnMaterializedIdPath.apply(this,arguments)},n.prototype.removeMaterialConnection=function(e){var t=this.appearanceIdMap.get(e);if(t){var i=t[1];if(i&&i.internalPath){var r=i.idPath[i.idPath.length-2];r&&this._removeInternalIdPath(r),r&&this._removeLegacyUVId(r)}this.idPathWatcher.removeIdObject(t),this.appearanceIdMap.delete(e)}},n.prototype._addMaterialConnectionOnMaterializedIdPath=function(t,i){var r=this.idPathWatcher&&this.idPathWatcher.getIdPathMatcher(),n=r?r.idToNode(t):this.getNodeFromIdCB(t);if(n){var a=n.getPLMMaterialData(),s=i.pathElement,o=s?[s]:[];if(!s){var l=i.idPath;if((s=this.getPathElementFromIdPath(l))&&o.push(s),s&&(i.internalUUIDPath||i.internalPath)){var h=s.externalPath.length,c=h>0?s.externalPath[h-1]:s.externalPath[0];if(i.internalUUIDPath)o=c.getPathElementsFromUUIDs(s,i.internalUUIDPath,i.cgmIdRep,i.cgmIdPrimitive?[i.cgmIdPrimitive]:null);else{var d=[];null!==i.internalPath&&void 0!==i.internalPath&&d.push(i.internalPath),null!==i.cgmIdRep&&void 0!==i.cgmIdRep&&d.push(i.cgmIdRep),null!==i.cgmIdPrimitive&&void 0!==i.cgmIdPrimitive&&d.push(i.cgmIdPrimitive);var u=i.cgmIdPrimitives?i.cgmIdPrimitives:i.cgmIdPrimitive?[i.cgmIdPrimitive]:null;o=c.getPathElementsFromDiezeEle(s,i.internalPath?[i.internalPath]:null,i.cgmIdRep,u)}}}if(o)for(var p=0;p<o.length;p++){var f=new e({pathElement:o[p],appearanceId:i.appearanceId,type:i.type,depth:i.depth,vLayer:i.vLayer});a.addMaterialConnection(f)}}},n.prototype.getPathElementFromIdPath=function(e){var i,r,n=[],a=this.idPathWatcher&&this.idPathWatcher.getIdPathMatcher();for(i=0;i<e.length;i++){var s=e[i];if(!(r=a?a.idToNode(s):this.getNodeFromIdCB(s)))return null;n.push(r)}return new t(n)},n.prototype.hasInternalPath=function(e){return(this.internalPathIds.get(e)||0)>0},n.prototype.hasLegacyUV=function(e){return(this.legacyUVIds.get(e)||0)>0},n.prototype._onIdPathActive=function(e){this._addMaterialConnectionOnMaterializedIdPath.apply(this,e)},n.prototype._onIdPathInactive=function(e){},n.prototype._addInternalIdPathId=function(e){var t=this.internalPathIds.get(e)||0;t++,this.internalPathIds.set(e,t)},n.prototype._removeInternalIdPath=function(e){var t=this.internalPathIds.get(e)||0;t>0&&(0===--t?this.internalPathIds.delete(e):this.internalPathIds.set(e,t))},n.prototype._addLegacyUVId=function(e){var t=this.legacyUVIds.get(e)||0;if(t++,this.legacyUVIds.set(e,t),1===t&&this.oocManager){var i=this.oocManager._getLDHReference(e,!0);i&&i.setLegacyUV()}},n.prototype._removeLegacyUVId=function(e){var t=this.legacyUVIds.get(e)||0;t>0&&(0===--t?this.legacyUVIds.delete(e):this.legacyUVIds.set(e,t))},n.prototype.COVERAGE_MATERIAL=e.COVERAGE_MATERIAL,n.prototype.CORE_MATERIAL=e.CORE_MATERIAL,new n}),define("DS/Visualization/BoundingBoxGPUCompute",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=e.extend({init:function(e){return this.renderer=e,this.minMaxExtension=t.supportedExtensions.minMaxBlending,this.useBackUpAlgorithm=!0,//!(this.renderer.renderer.supportsFloatTextures() && this.minMaxExtension);
this._pixels=this.useBackUpAlgorithm?1:32,this.renderTarget=null,this.zRenderTarget=null,this.zMaterial=null,this.material=null,this._useUnindexed=null!=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),this},setPixelCount:function(e){this._pixels=e,this.renderTarget&&_initRenderTarget()},_initBackUpMaterial:function(){var e=new t.ParticleBasicMaterial;e.sizeAttenuation=!1,e.activatePDSFX();var i={composante:{type:"v3",value:new t.Vector3},orientationMatrix:{type:"m4",value:new t.Matrix4},zMin:{type:"f",value:0},zMax:{type:"f",value:0}};e.setPDSFXUniforms(i);e.setPDSFXVaryings({vZ:{type:"f"}});var r={ComputeVaryingValues:["void ComputeVaryingValues() {","vZ=dot(composante,vec3(orientationMatrix * modelMatrix * vec4( position, 1.0 )));","gl_Position=vec4(0.0,0.0,2.0*(vZ)/(zMax-zMin)-(zMin+zMax)/(zMax-zMin),1.0);","}"].join("\n"),ComputeObjectTexCoord0:["vec4 ComputeObjectTexCoord0() {","\treturn vec4(0.0,0.0, 0.0, 0.0);","}"].join("\n"),ComputeObjectNormal:["vec3 ComputeObjectNormal() {","\treturn vec3(0.0,0.0,1.0);","}"].join("\n")},n={ProcessFinalColor:["float shift_right(float v, float amt) {","v = floor(v) + 0.5;","return floor(v / exp2(amt));","}","float shift_left(float v, float amt) {","return floor(v * exp2(amt) + 0.5);","}","float mask_last(float v, float bits) {","return mod(v, shift_left(1.0, bits));","}","float extract_bits(float num, float from, float to) {","from = floor(from + 0.5);","to = floor(to + 0.5);","return mask_last(shift_right(num, from), to - from);","}","vec4 encode_float(float val) {","if (val == 0.0)","return vec4(0, 0, 0, 0);","float sign = val > 0.0 ? 0.0 : 1.0;","val = abs(val);","float exponent = floor(log2(val));","float biased_exponent = exponent + 127.0;","float fraction = ((val / exp2(exponent)) - 1.0) * 8388608.0;","float t = biased_exponent / 2.0;","float last_bit_of_biased_exponent = fract(t) * 2.0;","float remaining_bits_of_biased_exponent = floor(t);","float byte4 = extract_bits(fraction, 0.0, 8.0) / 255.0;","float byte3 = extract_bits(fraction, 8.0, 16.0) / 255.0;","float byte2 = (last_bit_of_biased_exponent * 128.0 + extract_bits(fraction, 16.0, 23.0)) / 255.0;","float byte1 = (sign * 128.0 + remaining_bits_of_biased_exponent) / 255.0;","return vec4(byte4, byte3, byte2, byte1);","}","void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = encode_float(vZ);","}"].join("\n")};return e.setPDSFXOverridableFunctions(r,n),e},_initRenderTarget:function(){if(this.useBackUpAlgorithm){var e={minFilter:t.NearestFilter,magFilter:t.NearestFilter,type:t.UnsignedByteType,format:t.RGBAFormat};this.renderTarget=new t.WebGLRenderTarget(6,this._pixels,e)}else{e={minFilter:t.NearestFilter,magFilter:t.NearestFilter,type:t.FloatType,format:t.RGBAFormat};this.renderTarget=new t.WebGLRenderTarget(this._pixels,2,e)}},_initZRenderTarget:function(){var e={minFilter:t.NearestFilter,magFilter:t.NearestFilter,type:t.UnsignedByteType,format:t.RGBAFormat};this.zRenderTarget=new t.WebGLRenderTarget(1,1,e)},_drawBBDGsDepth:function(e,i,r,n,a){this.material||(this.material=this._initBackUpMaterial()),this.material.updatePDSFXUniform("orientationMatrix",i),this.material.updatePDSFXUniform("composante",a),this.material.updatePDSFXUniform("zMin",r),this.material.updatePDSFXUniform("zMax",n),this.material.id++;var s=!0,o=new t.OrthographicCamera;if(this._useUnindexed)for(c=0;c<e.length;c++){var l=e[c].renderable;for(u=0;u<l.geometry.length;u++){var h=l.geometry[u];p={glType:0,start:0,count:h.getVertexCount()||h.vertexCountGPU,nonIndexed:!0};this.renderer.renderer.renderInterval(o,[],l,this.material,null,h,p,p.start,p.count,null,null,s,null,null,null,null,0),s=!1}}else for(var c=0;c<e.length;c++)for(var d=e[c],u=0;u<d.obj.length;u++){var p,f=(p=d.obj[u]).glType;p.glType=0,this.renderer.renderer.renderInterval(o,[],d.renderable,this.material,null,p.geometry,p,p.start,p.count,null,null,s,null,null,null,null,0),p.glType=f,s=!1}},_drawZMinDGsDepth:function(e,i,r){this.zMaterial||(this.zMaterial=this._initBackUpMaterial()),this.zMaterial.updatePDSFXUniform("orientationMatrix",new t.Matrix4),this.zMaterial.updatePDSFXUniform("composante",new t.Vector3(0,0,1)),this.zMaterial.updatePDSFXUniform("zMin",i),this.zMaterial.updatePDSFXUniform("zMax",r),this.zMaterial.id++;for(var n=!0,a=new t.OrthographicCamera,s=0;s<e.length;s++)for(var o=e[s],l=0;l<o.geometry.length;l++){var h=o.geometry[l];var c={glType:0,start:0,count:h.getVertexCount()||h.vertexCountGPU,nonIndexed:!0};this.renderer.renderer.renderInterval(a,[],o,this.zMaterial,null,h,c,c.start,c.count,null,null,n,null,null,null,null,0),n=!1}},_setRendererState:function(){var e,t,i=this.renderer.gl.getParameter(this.renderer.gl.SCISSOR_BOX);t=this.renderer.renderer.getViewport(),e=this.renderer.renderer.getScissorTest();var r=this.renderer.renderer.enablerenderPluginsPre;this.renderer.renderer.enableRenderPluginsPre=!1;var n=this.renderer.renderer.renderPointMode;return this.renderer.renderer.renderPointMode=!0,this.renderer.renderer.materialToUse=0,{scissor:e,scissorValue:i,viewport:t,enablerenderpluginsPre:r,renderPointMode:n,depthTest:this.renderer.renderer._oldDepthTest}},_resetRendererState:function(e){this.renderer.renderer.setViewport(e.viewport.x,e.viewport.y,e.viewport.width,e.viewport.height),this.renderer.renderer.enableScissorTest(e.scissor),this.renderer.renderer.setScissor(e.scissorValue[0],e.scissorValue[1],e.scissorValue[2],e.scissorValue[3]),this.renderer.renderer.renderPointMode=e.renderPointMode,this.renderer.renderer.setDepthTest(e.depthTest),this.renderer.renderer.enableRenderPluginsPre=e.enablerenderpluginsPre;var t=this.renderer.renderer.getClearColor(),i=this.renderer.renderer.getClearAlpha();this.renderer.gl.clearColor(t.r,t.g,t.b,i)},computeZMinGPU:function(e,t){this.zRenderTarget||this._initZRenderTarget(),this.renderer.renderer.setRenderTarget(this.zRenderTarget);var i=this._setRendererState(),r=e.getSceneBoundingSphere();if(r.pixelRadius>0){var n=e.currentViewpoint.camera,a=n.getWorldSizeFromPixelSize(1,r.center,e._getDivClientHeight());if(void 0!==n.fullWidth&&n.fullWidth>0)a*=Math.max(1*n.width/n.fullWidth,1*n.height/n.fullHeight);r.radius+=a*r.pixelRadius}var s=this._computeZMin(t,r);return this._resetRendererState(i),s},computeBoundingBoxGPU:function(e,i,r){r||(r=new t.Matrix4);var n=(new t.Matrix4).getInverse(r);this.renderTarget||this._initRenderTarget(),this.renderer.renderer.setRenderTarget(this.renderTarget),this.renderer.renderer.clearCurrentBuffer();var a,s=this._setRendererState(),o=e.getSceneBoundingSphere();if(o.center.applyMatrix4(n),o.pixelRadius>0){var l=e.currentViewpoint.camera,h=l.getWorldSizeFromPixelSize(1,o.center,e._getDivClientHeight());if(void 0!==l.fullWidth&&l.fullWidth>0)h*=Math.max(1*l.width/l.fullWidth,1*l.height/l.fullHeight);o.radius+=h*o.pixelRadius}return a=this.useBackUpAlgorithm?this._computeBoundingBoxBackUp(i,n,o):this._computeBoundingBoxMain(i,n,o),this._resetRendererState(s),a},_computeZMin:function(e,t){this.renderer.gl.clearColor(0,0,0,0),this.renderer.renderer.clear(),this.renderer.gl.disable(this.renderer.gl.BLEND),this.renderer.renderer.setDepthTest(!0);var i=this.renderer.renderer.getDepthFunc();this.renderer.renderer.setDepthFunc(this.renderer.gl.LESS);var r=t.center.z;this._drawZMinDGsDepth(e,r-t.radius,r+t.radius),this.renderer.renderer.setDepthFunc(i),this.renderer.renderer.setViewport(0,0,1,1);var n=new Uint8Array(4);return this.renderer.gl.readPixels(0,0,1,1,this.renderer.gl.RGBA,this.renderer.gl.UNSIGNED_BYTE,n),new Float32Array(n.buffer)[0]},_computeBoundingBoxBackUp:function(e,i,r){this.renderer.gl.clearColor(0,0,0,0),this.renderer.renderer.clear(),this.renderer.gl.disable(this.renderer.gl.BLEND),this.renderer.renderer.setDepthTest(!0);var n=this.renderer.renderer.getDepthFunc();this.renderer.renderer.setDepthFunc(this.renderer.gl.LEQUAL);for(var a=0;a<6;a++){this.renderer.renderer.setViewport(a,0,1,this._pixels);new t.Matrix4;var s=new t.Vector3(0,0,1),o=r.center.z;1==a?(s.set(1,0,0),o=r.center.x):2==a?(s.set(0,1,0),o=r.center.y):3==a?(this.renderer.renderer.setDepthFunc(this.renderer.gl.GEQUAL),this.renderer.gl.clearDepth(-1),this.renderer.renderer.clear(!1,!0,!1)):4==a?(s.set(1,0,0),o=r.center.x):5==a&&(s.set(0,1,0),o=r.center.y),this._drawBBDGsDepth(e,i,o-r.radius,o+r.radius,s)}this.renderer.gl.clearDepth(1),this.renderer.renderer.setDepthFunc(n);var l=new Uint8Array(24*this._pixels);this.renderer.gl.readPixels(0,0,6,this._pixels,this.renderer.gl.RGBA,this.renderer.gl.UNSIGNED_BYTE,l);var h=new Float32Array(l.buffer),c=h[0],d=h[1],u=h[2],p=h[3],f=h[4],g=h[5];for(a=1;a<this._pixels;a++)c=Math.min(c,h[6*a]),d=Math.min(d,h[6*a+1]),u=Math.min(u,h[6*a+2]),p=Math.max(p,h[6*a+3]),f=Math.max(f,h[6*a+4]),g=Math.max(g,h[6*a+5]);return new t.Box3(new t.Vector3(d,u,c),new t.Vector3(f,g,p))}});return UWA.namespace("THREEDS/BoundingBoxGPUCompute",i)}),define("DS/Visualization/WebGLV6Renderer",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass","DS/Shaders/CompositeShader","DS/Shaders/MirrorShaders","DS/Shaders/BloomShaders","DS/Effects/FXAAEffect","DS/Effects/MLAAEffect","DS/Effects/MSAAEffect","DS/Effects/TAAEffect","DS/Effects/SMAAEffect","DS/Effects/HighlightEffect","DS/Effects/HighlightMobileEffect","DS/Effects/SSAOEffect","DS/Effects/SSAOIterativeEffect","DS/Effects/SSLREffect","DS/Effects/NoPowerOfTwoEffect","DS/Effects/SSLReflectionEffect","DS/Effects/SSLRefractionEffect","DS/Effects/BokehDOFEffect","DS/Effects/ComputeSkyScattering","DS/Effects/BloomsEffect","DS/Effects/ToneMappingEffect","DS/Effects/FlareEffect","DS/Effects/VolumeRenderingEffect","DS/Effects/DebugPassEffect","DS/Effects/DebugShadowMapsEffect","DS/Shaders/DeferredShaders","DS/Effects/PreHighlightEffect","DS/Plugins/ComposerContext","DS/Plugins/ClearPass","DS/Visualization/RenderTargetPool","DS/Plugins/PluginPass","DS/Shaders/StereoShaders","DS/CoreEvents/Events","DS/Effects/OITEffect","DS/Plugins/CSSNodesPass","DS/Visualization/BoundingBoxGPUCompute","DS/Visualization/RenderMode","DS/Usage/TrackerAPI","DS/Effects/XRevealStructureEffect","DS/Effects/HighlightMobileNonEffect","DS/Effects/PreHighlightMobileNonEffect","DS/Effects/NativeOnTopEffect"],function(e,t,r,n,a,s,o,l,h,c,d,u,p,f,g,m,v,y,S,_,x,b,w,M,C,P,E,A,T,D,I,R,O,L,V,F,B,N,G,k,U,z,H,W,j,X){"use strict";var q=0,Z=new Set;Z.add("compareModelPass"),Z.add("oitPass"),Z.add("oitnozPass"),Z.add("xRevealStructurePass");var Y=new Set;Y.add("OIT"),Y.add("OITnoZ"),Y.add("xRevealStructure"),Y.add("NativeOnTop"),"true"===localStorage.getItem("__WEBVISU_MOBILE_QM_POC__")&&(Y.add("SSAO"),Z.add("SSAOEffect"),Z.add("SSAOEffectBlurH"),Z.add("SSAOEffectBlurV"),Z.add("GroundShadowEffect"),Z.add("GroundShadowEffectBlurH"),Z.add("GroundShadowEffectBlurV"),Z.add("mirrorBlendPass"));var Q=new Set;Q.add("OIT"),Q.add("OITnoZ"),Q.add("xRevealStructure"),Q.add("Highlight"),Q.add("Canvas2DHighlight"),Q.add("PreHighlight"),Q.add("Canvas2DPreHighlight"),Q.add("SSAO"),Q.add("SSLRDirect"),Q.add("SSLReflection"),Q.add("SSLRefraction"),Q.add("NativeOnTop");var K=e.extend({init:function(e){if(this.ODTMode=e.viewer.ODTMode,this.useCompositing=void 0===e.useCompositing||e.useCompositing,this.NoOperator=0,this.SimpleOperator=1,this.LinearOperator=2,this.ReinhardOperator=3,this.FilmicOperator=4,this.UnchartedOperator=5,this.needClippingUpdate=!1,void 0!==e.canvas){if(this.canvas=e.canvas,this.divCSS=e.divCSS,this.useOffscreenCanvas=e.useOffscreenCanvas,this.antiAliasing=void 0!==e.antiAliasing?e.antiAliasing:"NoAA",this.useOffscreenCanvas?(this.cssWidth=Math.max(2,e.canvas.width),this.cssHeight=Math.max(2,e.canvas.height)):(this.cssWidth=Math.max(2,e.canvas.offsetWidth),this.cssHeight=Math.max(2,e.canvas.offsetHeight)),this.devicePixelRatio=t.getDevicePixelRatio()||1,this.deviceWidth=Math.floor(this.devicePixelRatio*this.cssWidth),this.deviceHeight=Math.floor(this.devicePixelRatio*this.cssHeight),this.viewportWidth=this.deviceWidth,this.viewportHeight=this.deviceHeight,this.brightness=void 0!==e.brightness?e.brightness:0,this.tonemapping=void 0!==e.tonemapping?e.tonemapping:1,this.disableBackFaceCulling=!1,this.visibleSpace=void 0!==e.visibleSpace?e.visibleSpace:1,this.compareSettings=e.compareSettings,this.mobile=t.mobileVersion,this._postProHighlight=!e.viewer._viewerEffectSettings._lqFallback&&(!this.mobile||!!e.forcePostProHighlight),this._postProHighlight&&(Y.add("Highlight"),Z.add("HighlightEffect"),Y.add("Canvas2DHighlight"),Z.add("Canvas2DHighlightEffect"),Y.add("PreHighlight"),Z.add("PreHighlightEffect"),Y.add("Canvas2DPreHighlight"),Z.add("Canvas2DPreHighlightEffect"),t._mobileHighlight=!1),t.isMacOS()&&(Q.delete("Highlight"),Q.delete("Canvas2DHighlight"),Q.delete("PreHighlight"),Q.delete("Canvas2DPreHighlight")),this.useAuxiliaryAsForward=!1,this.renderer=new t.WebGLRenderer({context:e.context,debugWebgl2:e.debugWebgl2||!1,alpha:!0,premultipliedAlpha:!1,antialias:!0===this.antiAliasing,canvas:this.canvas,divCSS:this.divCSS,visibleSpace:this.visibleSpace,preserveDrawingBuffer:e.preserveDrawingBuffer,debugContext:e.debugContext,sortRenderListByBuffer:!0,useCompositing:this.useCompositing}),!e.viewer.ODTMode){var i=this.renderer.getRendererInfo().gpu;"true"!==localStorage.getItem("WebVisu_Renderer_Info")&&z&&(z.trackPageEvent({eventCategory:"WebVisualization",eventAction:"WebGL-GPU",eventLabel:i,appID:"WEBVISUALIZATION_FW",persDim:{pd1:e.viewer.getWidgetID()}}),localStorage.setItem("WebVisu_Renderer_Info",!0))}this.bgColor=void 0!==e.bgColor?e.bgColor:0,this.bgAlpha=void 0!==e.bgAlpha?e.bgAlpha:1,this.setBackgroundColor(this.bgColor,this.bgAlpha),this.renderTargetPool=new L(this.renderer),this.renderer.renderTargetPool=this.renderTargetPool,this.useOffscreenCanvas?this.renderer.setGLSize(Math.max(2,this.canvas.width),Math.max(2,this.canvas.height),this.viewportWidth,this.viewportHeight,Math.max(2,this.canvas.width),Math.max(2,this.canvas.height)):this.renderer.setGLSize(this.cssWidth,this.cssHeight,this.cssWidth,this.cssHeight,this.cssWidth,this.cssHeight),this.renderer.setClearColorHex(0,0),this.renderer.gammaInput=!0,this.renderer.gammaOutput=!this.useCompositing,this.renderer.autoClear=!1,this.renderer.shadowMapCascade=!1,this._adaptativeShadows=!1,this.renderer.packESM=!0,this.renderer._gpuPickingTolerance=2,this.renderer._smallTargetPicking=this.mobile,this.gl=this.renderer.context,this.compPickingGPU=null,this.compDepth=null,this.compNormal=null,this.compNormalDepth=null,this.compMirror=null,this.compForward=null,this.composers=[],this.passPickingGPU=null,this.passDepth=null,this.passNormal=null,this.passColor=null,this.passNormalDepth=null,this.passMirror=null,this.passMirrorBlur=null,this.passMirrorBlur1=null,this.passMirrorBlur2=null,this.passMirrorBlur3=null,this.infPlanePass=null,this.mirrorBlendPass=null,this.zPostPass=null,this.forwardPass=null,this.ZOnlyPass=null,this.backgroundPass=null,this.passLightFullscreen=null,this.passLightProxy=null,this.XRevealStructureEffect=null,this.OITEffect=null,this.OITnoZEffect=null,this.PreHighlightEffect=null,this._PreHighlightMobileNonEffect=null,this.Canvas2DPreHighlightEffect=null,this.BokehDOFEffect=null,this.SkyScatteringEffect=null,this.BloomEffect=null,this.ToneMappingEffect=null,this.FlareEffect=null,this.HighlightEffect=null,this._HighlightMobileNonEffect=null,this.Canvas2DHighlightEffect=null,this.SSAOEffect=null,this.SSAOIterativeEffect=null,this.SSLREffect=null,this.SSLReflectionEffect=null,this.SSLRefractionEffect=null,this.FXAAEffect=null,this.MLAAEffect=null,this.SMAAEffect=null,this.MSAAEffect=null,this.TAAEffect=null,this.VolumeRenderingEffect=null,this.NoPowerOfTwoEffect=null,this.NativeOnTopEffect=null,this.DebugPassEffect=null,this.DebugShadowMapsEffect=null,this.customEffects=[],this.allEffects=[],this.effectStatusMap=new Map,this.renderer.sectionCappingEnabled=!1,this.meshesGPU={},this.positionsGPU={},this.normalsGPU={},this.currentGPUPickPosition={x:-1,y:-1};var n=t.FloatType,a=t.LinearFilter;this.renderer.supportsFloatTextures()||(n=t.UnsignedByteType),this.renderer.supportsFloatLinearTextures()||(a=t.NearestFilter),this.rtParamsFloatLinear={minFilter:a,magFilter:a,stencilBuffer:!0,format:t.RGBAFormat,type:n},this.rtParamsFloatNearest={minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,format:t.RGBAFormat,type:n},this.rtParamsFloatNearestStencilBuffer={minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!0,format:t.RGBAFormat,type:n},this.rtParamsUByteNearest={minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,format:t.RGBAFormat,type:t.UnsignedByteType},this.rtParamsUByteWithStencilBuffer={minFilter:t.NearestFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:t.UnsignedByteType},this.rtParamsUByte2={minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!1,format:t.RGBAFormat,type:t.UnsignedByteType},this.boundingBoxGPUCompute=new k(this);this.mainComposer=new r(this.renderer,void 0,this.renderTargetPool,["--\x3e(initClear)","initClearPass","--\x3einfPlane","infPlanePass","mirrorClearDepth","mirrorBlendPass","afterMirrorClearDepth","--\x3emain","backgroundPassCapping","backgroundPass","renderPriorityClear","renderPriorityStencilP4","renderPriorityStencilP3","renderPriorityStencilP2","renderPriorityStencilP1","renderPriorityStencilP0","renderPriorityDrawP3","renderPriorityDrawP2","renderPriorityDrawP1","renderPriorityDrawP0","passSectionCappingFrontFaces","cssPass","iso_0","forwardPass","iso_2","iso_3","zPostPass","ZOnlyPassCapping","ZOnlyPass","oitPass","lensFlarePass","--\x3edialog","dialogPass","fallBackOnTopPass","--\x3e(postEffects1)","passMirrorBlur","passMirrorBlur1","passMirrorBlur2","passMirrorBlur3","SSAOEffect","SSAOIterativeEffect","compareModelPass","skyScatteringPass","BokehDOFEffect","--\x3enoz","nozClearPass","nozPass","oitnoZPass","--\x3e(postEffects2)","bloomPass","compositePass","SSLREffect","VolumeRenderingEffect","FlareEffect","MSAAEffect","TAAEffect","--\x3enoEffectNoz","noEffectNozClearPass","noEffectNozPass","--\x3e(highlight)","HighlightEffect","PreHighlightEffect","highlightClearPass","highlightSinglePass","preHighlightSinglePass","DebugPassEffect","DebugShadowMapsEffect","--\x3eafterHighlightNoz","noEffectAfterHighlightNozClearPass","noEffectAfterHighlightNozPass","xRevealStructurePass","--\x3eonTop","onTopDepthSetPass","onTopPass","--\x3efurtive","furtiveClearPass","furtivePass","--\x3erobot","noEffectRobotClearPass","noEffectRobotPass","noEffectRobotOrthoPass","--\x3e(postEffects3)","FXAAEffect","MLAAEffect","SMAAEffect","--\x3ecanvas2D","noEffectCanvas2DClearPass","noEffectCanvas2DPass","Canvas2DHighlightEffect","Canvas2DPreHighlightEffect","Canvas2DhighlightClearPass","Canvas2DhighlightSinglePass","Canvas2DpreHighlightSinglePass"]),this.initForwardRender(),this.highlightPass=null,this.shadowComposerContext=null,this.pickingGPUComposerContext=null,this.pickingGPUInstancingComposerContext=null,this.normalComposerContext=null,this.depthComposerContext=null,this.normalDepthIoRRoughnessComposerContext=null,this.normalDepthComposerContext=null,this.outlineDepthComposerContext=null,this.mirrorOutlineDepthComposerContext=null,this.highlightDepthComposerContext=null,this.opaqueOnlyComposerContext=null,this.colorComposerContext=null,this.occlusionDepthComposerContext=null,this.clippingScene=null,this.superFinalComposer=null,this.customComposerContexts=null}},_updateOITScene:function(e){this.OITEffect&&(this.OITEffect.revealPass.scene=e,this.OITEffect.accumPass.scene=e),this.OITnoZEffect&&(this.OITnoZEffect.revealPass.scene=e,this.OITnoZEffect.accumPass.scene=e)},initEffect:function(e){if(this.mobile&&!Y.has(e))return null;if(!this.useCompositing&&!Q.has(e))return null;var i=null;switch(e){case"xRevealStructure":this.XRevealStructureEffect=new H(this.renderer,this.renderTargetPool),i=this.XRevealStructureEffect;break;case"noPowerOfTwoEffect":this.NoPowerOfTwoEffect=new S(this.renderer,this.renderTargetPool),i=this.NoPowerOfTwoEffect;break;case"OIT":this.OITEffect=new N(this.renderer,this.renderTargetPool,this.forwardPass,"oitPass"),i=this.OITEffect;break;case"OITnoZ":this.OITnoZEffect=new N(this.renderer,this.renderTargetPool,this.nozPass,"oitnoZPass"),(i=this.OITnoZEffect).idString="noz";break;case"FXAA":this.FXAAEffect=new h(this.renderer,this.renderTargetPool),i=this.FXAAEffect;break;case"MLAA":this.MLAAEffect=new c(this.renderer,this.renderTargetPool),i=this.MLAAEffect;break;case"MSAA":this.MSAAEffect=new d(this.renderer,this.renderTargetPool),i=this.MSAAEffect;break;case"TAA":this.TAAEffect=new u(this.renderer,this.renderTargetPool),i=this.TAAEffect;break;case"SMAA":this.SMAAEffect=new p(this.renderer,this.renderTargetPool),i=this.SMAAEffect;break;case"Highlight":this.HighlightEffect=t.__unrolledHighlight()?new g(this.renderer,this.renderTargetPool,null,""):new f(this.renderer,this.renderTargetPool,null,""),i=this.HighlightEffect;break;case"PreHighlight":this.PreHighlightEffect=new I(this.renderer,this.renderTargetPool,null,""),i=this.PreHighlightEffect;break;case"Canvas2DHighlight":this.Canvas2DHighlightEffect=t.__unrolledHighlight()?new g(this.renderer,this.renderTargetPool,"canvas2D","Canvas2D"):new f(this.renderer,this.renderTargetPool,"canvas2D","Canvas2D"),i=this.Canvas2DHighlightEffect;break;case"Canvas2DPreHighlight":this.Canvas2DPreHighlightEffect=new I(this.renderer,this.renderTargetPool,"canvas2D","Canvas2D"),i=this.Canvas2DPreHighlightEffect;break;case"SSAO":this.SSAOEffect=new m(this.renderer,this.renderTargetPool),i=this.SSAOEffect;break;case"SSAOIterative":this.SSAOIterativeEffect=new v(this.renderer,this.renderTargetPool),i=this.SSAOIterativeEffect;break;case"SSLR":this.SSLREffect=new y(this.renderer,this.renderTargetPool),i=this.SSLREffect;break;case"SSLRDirect":case"SSLReflection":this.SSLReflectionEffect=new _(this.renderer,this.renderTargetPool),i=this.SSLReflectionEffect;break;case"SSLRefraction":this.SSLRefractionEffect=new x(this.renderer,this.renderTargetPool),i=this.SSLRefractionEffect;break;case"VolumeRendering":this.VolumeRenderingEffect=new E(this.renderer,this.renderTargetPool,this.ODTMode),i=this.VolumeRenderingEffect;break;case"DOF":this.BokehDOFEffect=new b(this.renderer,this.renderTargetPool),i=this.BokehDOFEffect;break;case"Bloom":this.BloomEffect=new M(this.renderer,this.renderTargetPool,!1),i=this.BloomEffect;break;case"SkyScattering":this.SkyScatteringEffect=new w(this.renderer,this.renderTargetPool),i=this.SkyScatteringEffect;break;case"ToneMapping":this.ToneMappingEffect=new C(this.renderer,this.renderTargetPool),i=this.ToneMappingEffect;break;case"Flare":this.FlareEffect=new P(this.renderer,this.renderTargetPool),i=this.FlareEffect;break;case"DebugPass":this.DebugPassEffect=new A(this.renderer,this.renderTargetPool),i=this.DebugPassEffect;break;case"DebugShadowMaps":this.DebugShadowMapsEffect=new T(this.renderer,this.renderTargetPool),i=this.DebugShadowMapsEffect;break;case"NativeOnTop":this.NativeOnTopEffect=new X(this.renderer,this.renderTargetPool),i=this.NativeOnTopEffect}return null!==i&&(i.updateComposersName(e),i.setSize(this.viewportWidth,this.viewportHeight),i.initEffect(!this.useCompositing,this),this.allEffects.push(i)),i},setEffect:function(e,t){var i=null,r=!1;if((!this.mobile||Y.has(e))&&(this.useCompositing||Q.has(e))){switch(this.effectStatusMap.set(e,t),e){case"xRevealStructure":i=this.XRevealStructureEffect;break;case"OIT":i=this.OITEffect,r=!this.isDeviceCompatibleWithOIT();var n=t&&!r;this.compForwardComposerContext.needRequiredReadBuffer=n,this.zPostPass.isOITPass=n,this.forwardPass.isOITPass=n,this.renderer.useOIT=n;break;case"OITnoZ":i=this.OITnoZEffect,r=!this.isDeviceCompatibleWithOIT();n=t&&!r;this.compForwardComposerContext.needRequiredReadBuffer=n,this.nozPass.isOITPass=n,this.renderer.useOIT=n;break;case"FXAA":i=this.FXAAEffect,this.antiAliasing=t?e:"NoAA";break;case"MLAA":i=this.MLAAEffect,this.antiAliasing=t?e:"NoAA";break;case"MSAA":i=this.MSAAEffect,this.antiAliasing=t?e:"NoAA";break;case"TAA":i=this.TAAEffect,this.antiAliasing=t?e:"NoAA";break;case"SMAA":i=this.SMAAEffect,this.antiAliasing=t?e:"NoAA";break;case"FSAA":case"SSAA":this.antiAliasing=t?e:"NoAA";break;case"Vignetting":i=this.ToneMappingEffect;break;case"Highlight":i=this.HighlightEffect;break;case"PreHighlight":i=this.PreHighlightEffect;break;case"Canvas2DHighlight":i=this.Canvas2DHighlightEffect;break;case"Canvas2DPreHighlight":i=this.Canvas2DPreHighlightEffect;break;case"SSAO":i=this.SSAOEffect,r=!this.isDeviceCompatibleWithSSAO();break;case"SSAOIterative":i=this.SSAOIterativeEffect,r=!this.isDeviceCompatibleWithSSAO();break;case"SSLR":i=this.SSLREffect;break;case"SSLRDirect":case"SSLReflection":i=this.SSLReflectionEffect,r=!this.isDeviceCompatibleWithSSR(),this.renderer.useSSLR=t&&!r;break;case"SSLRefraction":i=this.SSLRefractionEffect,r=!this.isDeviceCompatibleWithSSR(),this.renderer.useSSLRefraction=t&&!r;break;case"VolumeRendering":i=this.VolumeRenderingEffect;break;case"DOF":i=this.BokehDOFEffect;break;case"Bloom":i=this.BloomEffect;break;case"ToneMapping":i=this.ToneMappingEffect;break;case"SkyScattering":i=this.SkyScatteringEffect;break;case"Flare":i=this.FlareEffect;break;case"DebugPass":i=this.DebugPassEffect;break;case"DebugShadowMaps":i=this.DebugShadowMapsEffect;break;case"NativeOnTop":i=this.NativeOnTopEffect}if(t&&!r&&(i||(i=this.initEffect(e))),null!==i){var a=t&&!r;"Vignetting"===e?i.setVignettingPower(a?10:0):i.setEnabled(a),!this.compMirrorComposerContext||"OIT"!==e&&"OITnoZ"!=e||(this.compMirrorComposerContext.enablePass(i.mixPass,this.renderer.useOIT),this.compMirrorComposerContext.needRequiredReadBuffer=this.renderer.useOIT)}this.setScale(!1),this.updateFinalComposer(!0)}},getCustomEffect:function(e){return this.customEffects[e]},addCustomEffect:function(e){if(!e)return-1;var t=this.customEffects.length;return this.customEffects.push(e),e.updateComposersName("customEffect_"+this.customEffects.length),e.setSize(this.viewportWidth,this.viewportHeight),e.initEffect(!this.useCompositing,this),t},setCustomEffect:function(e,t){var i=this.customEffects[e];null!==i&&(i.setEnabled(t),t&&i.setSize(this.viewportWidth,this.viewportHeight)),this.updateFinalComposer(!0)},updateEffects:function(e,t,i,r){this.XRevealStructureEffect&&this.XRevealStructureEffect.enabled&&this.XRevealStructureEffect.update("deferred",e,t),this.SSAOEffect&&this.SSAOEffect.enabled&&this.SSAOEffect.update("deferred",e,t,i),this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&this.SSAOIterativeEffect.update("deferred",e,t,i),this.SSLREffect&&this.SSLREffect.enabled&&this.SSLREffect.update("deferred",e,t),this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&this.SSLReflectionEffect.update("deferred",e,t,i),this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&this.SSLRefractionEffect.update("deferred",e,t,i),this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled&&this.VolumeRenderingEffect.update("deferred",e,t,i),this.HighlightEffect&&this.HighlightEffect.enabled&&this.HighlightEffect.update("forward",e,t,i,r),this._HighlightMobileNonEffect&&this._HighlightMobileNonEffect.enabled&&this._HighlightMobileNonEffect.update(e),this.PreHighlightEffect&&this.PreHighlightEffect.enabled&&this.PreHighlightEffect.update("forward",e,t,i,r),this._PreHighlightMobileNonEffect&&this._PreHighlightMobileNonEffect.enabled&&this._PreHighlightMobileNonEffect.update(e),this.Canvas2DHighlightEffect&&this.Canvas2DHighlightEffect.enabled&&this.Canvas2DHighlightEffect.update("forward",e,t,i,r),this.Canvas2DPreHighlightEffect&&this.Canvas2DPreHighlightEffect.enabled&&this.Canvas2DPreHighlightEffect.update("forward",e,t,i,r),this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&this.BokehDOFEffect.update("deferred",e,t),this.DebugShadowMapsEffect&&this.DebugShadowMapsEffect.enabled&&this.DebugShadowMapsEffect.update("forward",e,t),this.MSAAEffect&&this.MSAAEffect.enabled&&this.MSAAEffect.update("forward",e,t,i),this.TAAEffect&&this.TAAEffect.enabled&&this.TAAEffect.update("forward",e,t,i),this.SkyScatteringEffect&&this.SkyScatteringEffect.enabled&&this.SkyScatteringEffect.update("deferred",e,t),this.BloomEffect&&this.BloomEffect.enabled&&this.BloomEffect.update("deferred",e,t),this.ToneMappingEffect&&this.ToneMappingEffect.enabled&&this.ToneMappingEffect.update("deferred",e,t),this.NativeOnTopEffect&&this.NativeOnTopEffect.enabled&&this.NativeOnTopEffect.update("forward",e,t);for(var n=0;n<this.customEffects.length;n++){var a=this.customEffects[n];a&&a.enabled&&a.update("forward",e,t)}},getMaxIterationEffects:function(){var e=0;return this.SSAOEffect&&this.SSAOEffect.enabled&&(e=Math.max(e,this.SSAOEffect.getMaxIteration())),this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&(e=Math.max(e,this.SSAOIterativeEffect.getMaxIteration())),this.MSAAEffect&&this.MSAAEffect.enabled&&(e=Math.max(e,this.MSAAEffect.getMaxIteration())),this.TAAEffect&&this.TAAEffect.enabled&&(e=Math.max(e,this.TAAEffect.getMaxIteration())),e},setRendererSize:function(e,t,i,r,n,a,s,o){if(this.cssWidth!==e||this.cssHeight!==t||this.devicePixelRatio!==a||i){this.devicePixelRatio=a,this.cssWidth=Math.max(2,e),this.cssHeight=Math.max(2,t),this.deviceWidth=Math.floor(a*this.cssWidth),this.deviceHeight=Math.floor(a*this.cssHeight),this.viewportWidth=Math.floor(a*Math.max(2,r)),this.viewportHeight=Math.floor(a*Math.max(2,n));var l=this.cssWidth,h=this.cssHeight;void 0!==s&&(l=Math.max(2,s)),void 0!==o&&(h=Math.max(2,o)),this.renderer.setGLSize(this.cssWidth,this.cssHeight,r,n,l,h),this.setScale(!0)}},setBackgroundColor:function(e,i){this.bgColor=e,this.bgAlpha=i;var r=new t.Color(this.bgColor);this.renderer._backgroundColor=r,this.useCompositing&&r.copyToLinear(r,this.renderer.simpleGamma),this.bgColor=r.getHex()},resetGSSOCache:function(){this.renderer.resetGSSOCache()},_createVirtualLight:function(e,i){var r=new t.DirectionalLight;return r.originalLight=e,r.target=e.target,r.isVirtual=!0,r.LiSPSM=e.LiSPSM,r.onlyShadow=!0,r.castShadow=!0,r.shadowCameraNear=e.shadowCameraNear,r.shadowCameraFar=e.shadowCameraFar,r.shadowCameraLeft=e.shadowCameraLeft,r.shadowCameraRight=e.shadowCameraRight,r.shadowCameraBottom=e.shadowCameraBottom,r.shadowCameraTop=e.shadowCameraTop,r.shadowCameraVisible=e.shadowCameraVisible,r.shadowDarkness=e.shadowDarkness,r.shadowBias=e.shadowCascadeBias[i],r.shadowMapWidth=e.shadowCascadeWidth[i],r.shadowMapHeight=e.shadowCascadeHeight[i],r},_updateVirtualLight:function(e,t){var i=e.shadowCascadeArray[t];i.virtualLightIndex=t,i.position.copy(e.position),e.target&&(i.target.position=e.target.position,i.lookAt(i.target.position)),i.shadowCameraVisible=e.shadowCameraVisible,i.shadowDarkness=e.shadowDarkness,i.shadowBias=e.shadowCascadeBias[t]},_computeNearFarFromConvexHull:function(e,i){for(var r=i.getPoints(),n=(r.length,1/0),a=-1/0,s=new t.Vector4,o=0;o<r.length;o++)s.copy(r[o]),s.applyMatrix4(e.matrixWorldInverse),-s.z<n&&(n=-s.z),-s.z>a&&(a=-s.z);return{near:n=Math.max(e.near,n),far:a}},_clipConvexHullFromNearFar:function(e,i,r,n,a){var s=i.matrixWorld.elements,o=e.matrixWorld.elements,l=new t.Vector3(o[8],o[9],o[10]),h=new t.Vector3(-o[8],-o[9],-o[10]),c=(new t.Vector3(s[8],s[9],s[10]),(new t.Vector3).copy(l).multiplyScalar(n).add(e.position)),d=(new t.Vector3).copy(l).multiplyScalar(a).add(e.position),u=new t.Plane(l,-l.dot(c)),p=new t.Plane(h,-h.dot(d));return r.clipByPlanes([u,p])},_extrudeConvexHullAlongLightDir:function(e,i,r,n){var a=r.getPoints(),s=a.length,o=new t.CGPoly;o.setFromBox(i),o.applyMatrix4(n.matrixWorldInverse);for(var l=[],h=0;h<s;h++){var c=a[h].clone();c.applyMatrix4(n.matrixWorldInverse),l.push(c)}var d=(new t.Box3).setFromPoints(l).getPlanes();return o.clipByPlanes([d[0],d[1],d[2],d[3],d[4]])},_updateShadowCamera:function(e,i,r,n,a,s,o){var l=i.matrixWorld.elements,h=e.matrixWorld.elements,c=new t.Vector3(h[8],h[9],h[10]),d=new t.Vector3(l[8],l[9],l[10]),u=r.getPoints(),p=u.length,f=(new t.Box3).setFromPoints(u);if(i.LiSPSM){for(var g=c.dot(d),m=Math.sqrt(1-g*g),v=(n+Math.sqrt(n*a))/m,y=v+(T=Math.abs(f.max.y-f.min.y)),S=new t.Vector3(0,f.min.y-v,.5*(f.min.z+f.max.z)),_=0;_<p;_++){(w=u[_]).sub(S)}var x=0,b=0;for(_=0;_<p;_++){var w=u[_],M=Math.abs(v*w.x/w.y);(!x||M>x)&&(x=M);var C=Math.abs(v*w.z/w.y);(!b||C>b)&&(b=C)}S.applyMatrix4(o.matrixWorld),o.position.copy(S),o.matrix.elements[12]=o.position.x,o.matrix.elements[13]=o.position.y,o.matrix.elements[14]=o.position.z,o.matrixWorld.elements[12]=o.position.x,o.matrixWorld.elements[13]=o.position.y,o.matrixWorld.elements[14]=o.position.z,o.matrixWorldInverse.getInverse(o.matrixWorld);var P=(y+v)/(y-v),E=-2*y*v/(y-v),A=v/x,T=-v/b;o.projectionMatrix.set(A,0,0,0,0,P,0,E,0,0,T,0,0,1,0,0)}else o.left=f.min.x,o.right=f.max.x,o.top=f.max.y,o.bottom=f.min.y,o.near=-f.max.z,o.far=-f.min.z,o.updateProjectionMatrix()},computeShadows:function(e,i,r,n,a,s){var o,l,h,c,d,u,p,f,g=r,m=this.renderer,v=[],y=0;for(i.__lights.sort(i._lightSort),M=0,o=i.__lights.length;M<o;M++)if(((f=i.__lights[M]).castShadow||f.castGroundShadow)&&(!f.castShadow||s)&&!f.isVirtual)if(f instanceof t.DirectionalLight&&f.shadowCascade){for(l=f.shadowCascadeCount;l<f.shadowCascadeArray.length;l++){(S=f.shadowCascadeArray[l])&&(S.cameraHelper&&(S.cameraHelper.visible=!1),S.convexHullHelper&&(S.convexHullHelper.visible=!1))}for(l=0;l<f.shadowCascadeCount;l++){var S;f.shadowCascadeArray[l]?S=f.shadowCascadeArray[l]:((S=this._createVirtualLight(f,l)).originalCamera=_,f.shadowCascadeArray[l]=S,i.add(S)),this._updateVirtualLight(f,l),v[y]=S,y++}}else v[y]=f,y++;if(v.length){this.shadowComposerContext||this.initComposer("Shadow");var _=n[e];this.mainComposer.updateScene(i),this._updateOITScene(i),this.mainComposer.setComposerContext(this.shadowComposerContext);for(var x=new t.Frustum,b=(new t.Matrix4,new t.Vector3,new t.Vector3,new t.Vector3),w=[],M=0;M<129;M++){var C=t.RandomLib.LowDiscrepancy2D(M);w.push({x:C.x-.5,y:C.y-.5})}var P=m.materialToUse,E=this.disableBackFaceCulling,A=(g.isEnabled(g.BLEND),m.getScissorTest()),T=function(){m.materialToUse=t.MaterialToUse.shadowMapDepthMaterial,m.setDisableBackFaceCulling(!0),m.setDepthTest(!0),m.enableScissorTest(!1)},D=function(e){var i=m.getClearColor(),r=m.getClearAlpha();g.clearColor(i.r,i.g,i.b,r),m.setDisableBackFaceCulling(E),e?(m.enableScissorTest(A),m.materialToUse=P):m.materialToUse=t.MaterialToUse.originalMaterial};T();var I=null,R=null;if(i.boundingBox)I=i.boundingBox;else{for(var O=0;O<i.children.length;O++){var L=i.children[O];if(L.boundingSphere&&(R=L.boundingSphere),L.boundingBox){I=L.boundingBox;break}}!I&&R&&(I=R.getBoundingBox())}if(I){var V=new t.Matrix4;V.multiplyMatrices(_.projectionMatrix,_.matrixWorldInverse),x.setFromMatrix(V);var F=x.getCorners(),B=new t.CGPoly;B.setFromFrustumPoints(F);var N=I.getPlanes(),G=B.clipByPlanes(N),k=this,U=function(e){var i=_.matrixWorld.elements,r=f.matrixWorld.elements,n=new t.Vector3(-i[8],-i[9],-i[10]),a=new t.Vector3(r[8],r[9],r[10]);if(f.LiSPSM){var s=new t.Vector3;s.crossVectors(a,n),(d=new t.Vector3).crossVectors(s,a),d.normalize();var o=new t.Vector3,l=new t.Vector3,h=new t.Vector3;h.crossVectors(a,d),h.normalize(),l.crossVectors(h,a),l.normalize(),o.copy(a),o.normalize(),e.position.getPositionFromMatrix(_.matrixWorld),e.up.copy(l),b.copy(e.position),b.add(o),e.lookAt(b)}else if(e.position.copy(f.position),f.target)e.lookAt(f.target.position);else if(f instanceof t.PointLight){var c,d;switch(K){case 0:u=(new t.Vector3).set(1,0,0),c=(new t.Vector3).set(0,0,-1);break;case 1:u=(new t.Vector3).set(-1,0,0),c=(new t.Vector3).set(0,0,1);break;case 2:u=(new t.Vector3).set(0,1,0),c=(new t.Vector3).set(1,0,0);break;case 3:u=(new t.Vector3).set(0,-1,0),c=(new t.Vector3).set(1,0,0);break;case 4:u=(new t.Vector3).set(0,0,1),c=(new t.Vector3).set(1,0,0);break;case 5:u=(new t.Vector3).set(0,0,-1),c=(new t.Vector3).set(-1,0,0)}(d=new t.Vector3).crossVectors(c,u),d.normalize(),e.up.copy(d),e.lookAt((new t.Vector3).copy(f.position).add(u))}else{var u;(u=(new t.Vector3).copy(k.renderer.baseLightDirection).multiplyScalar(-1)).applyMatrix4((new t.Matrix4).extractRotation(f.matrixWorld)),e.lookAt((new t.Vector3).copy(f.position).add(u))}e.updateMatrix(),e.matrixWorld.copy(e.matrix),e.matrixWorldInverse.getInverse(e.matrixWorld),e.matrixWorldNeedsUpdate=!1,e.matrixAutoUpdate=!1},z=function(e,i){var r=e.adaptativeShadowCamera,n=e.shadowCamera;r||(r=new t.OrthographicCamera,n.clone(r),e.adaptativeShadowCamera=r);for(var a=[],s=0;s<F.length;s++){var o=F[s].clone();o.applyMatrix4(n.matrixWorldInverse),a.push(o)}var l=new t.Box3;l.setFromPoints(a);var h=new t.Box3;h.setValues(n.left,n.bottom,-n.far,n.right,n.top,-n.near),h.intersect(l);var c=h.bottom,d=h.top,u=h.right,p=h.left,f=h.near;u=h.min.x,p=h.max.x,c=h.max.y,d=h.min.y,f=-h.min.z,r.top==c&&r.bottom==d&&r.left==u&&r.right==p||(r.top=c,r.bottom=d,r.left=u,r.right=p,r.far=f,r.updateProjectionMatrix(),e.updateShadowMap=!0)};for(M=0,o=v.length;M<o;M++){var H=!(f=v[M]).shadowMap,W=m.shadowMapType===t.ESMShadowMap||m.shadowMapType===t.ESMImprovedShadowMap,j=W&&!this.renderer.packESM;if(f.shadowMap&&(H=j&&f.shadowMap.type===t.UnsignedByteType||!j&&f.shadowMap.type===t.FloatType),H){f.shadowMap&&f.shadowMap.dispose();var X=t.LinearFilter;(m.shadowMapType===t.PCFSoftShadowMap||m.shadowMapType===t.ESMShadowMap&&!j)&&(X=t.NearestFilter);var q={minFilter:X,magFilter:X,type:j?t.FloatType:t.UnsignedByteType,format:t.RGBAFormat};f instanceof t.PointLight?(W&&(f.tempRT=new t.WebGLRenderTarget(f.shadowMapWidth,f.shadowMapHeight,q)),f.shadowMap=new t.WebGLRenderTargetCube(f.shadowMapWidth,f.shadowMapHeight,q)):f.shadowMap=new t.WebGLRenderTarget(f.shadowMapWidth,f.shadowMapHeight,q),f.shadowMapSize=new t.Vector2(f.shadowMapWidth,f.shadowMapHeight),f.shadowMatrix=new t.Matrix4}if(m.transparentShadowEnabled&&!f.transparentShadowMap){q={minFilter:X=t.LinearFilter,magFilter:X,type:t.UnsignedByteType,format:t.RGBAFormat};f instanceof t.PointLight?f.transparentShadowMap=new t.WebGLRenderTargetCube(f.shadowMapWidth,f.shadowMapHeight,q):f.transparentShadowMap=new t.WebGLRenderTarget(f.shadowMapWidth,f.shadowMapHeight,q),f.transparentShadowMap.shareDepthFrom=f.shadowMap}var Z=[],Y=[];if(f instanceof t.SpotLight)f.shadowCamera||(f.shadowCamera=new t.PerspectiveCamera(f.shadowCameraFov,f.shadowMapWidth/f.shadowMapHeight,f.shadowCameraNear,f.shadowCameraFar),f.transparentShadowCamera=new t.PerspectiveCamera,m.autoUpdateScene&&i.updateMatrixWorld()),Z=[f.shadowCamera],Y=[f.transparentShadowCamera];else if(f instanceof t.DirectionalLight)f.shadowCamera||(f.shadowCamera=new t.OrthographicCamera(f.shadowCameraLeft,f.shadowCameraRight,f.shadowCameraTop,f.shadowCameraBottom,f.shadowCameraNear,f.shadowCameraFar),f.transparentShadowCamera=new t.OrthographicCamera,m.autoUpdateScene&&i.updateMatrixWorld()),this._adaptativeShadows?(U(f.shadowCamera),z(f),Z=[f.adaptativeShadowCamera]):Z=[f.shadowCamera],Y=[f.transparentShadowCamera];else{if(!(f instanceof t.PointLight)){console.error("Unsupported light type for shadow");continue}if(!f.shadowCameras){f.shadowCameras=[],f.transparentShadowCameras=[];for(M=0;M<6;M++)f.shadowCameras.push(new t.PerspectiveCamera(f.shadowCameraFov,f.shadowMapWidth/f.shadowMapHeight,f.shadowCameraNear,f.shadowCameraFar)),f.transparentShadowCameras.push(new t.PerspectiveCamera);m.autoUpdateScene&&i.updateMatrixWorld()}Z=f.shadowCameras,Y=f.transparentShadowCameras}for(var Q=f.updateShadowMap,K=0;K<Z.length;K++){if(T(),u=Z[K],p=Y[K],f instanceof t.PointLight&&(f.shadowMap.activeCubeFace=K,f.transparentShadowMap&&(f.transparentShadowMap.activeCubeFace=K),f.updateShadowMap=Q),m.renderIteration){var J=f.offsetShadowCamera;J?u=Z[K].clone(J):(u=Z[K].clone(),f.offsetShadowCamera=u);var $=Math.abs(Z[K].right-Z[K].left),ee=Math.abs(Z[K].top-Z[K].bottom);u.left=Z[K].left+w[m.renderIteration].x*$/f.shadowMapWidth,u.right=Z[K].right+w[m.renderIteration].x*$/f.shadowMapWidth,u.bottom=Z[K].bottom+w[m.renderIteration].y*ee/f.shadowMapHeight,u.top=Z[K].top+w[m.renderIteration].y*ee/f.shadowMapHeight,u.updateProjectionMatrix()}if(f.shadowCameraVisible&&!f.cameraHelper&&(i.add(Z[K]),f.cameraHelper=new t.CameraHelper(Z[K]),Z[K].add(f.cameraHelper)),m.renderIteration<=1)if(f.isVirtual){if(!f.originalLight.updateShadowMap)continue}else if(!f.updateShadowMap)continue;if(!f.castGroundShadow||f.updateShadowMap){f.isVirtual||(f.updateShadowMap=!1),h=f.shadowMap,c=f.transparentShadowMap,d=f.shadowMatrix,U(u);var te=G.clone(),ie={near:_.near,far:_.far};if(f.isVirtual){ie=this._computeNearFarFromConvexHull(_,te);var re=f.originalLight.shadowCascadeCount,ne=f.originalLight.shadowCascadeSubNear&&f.originalLight.shadowCascadeSubNear[M],ae=f.originalLight.shadowCascadeSubFar&&f.originalLight.shadowCascadeSubFar[M];void 0===ne&&(ne=-Math.exp((1-f.virtualLightIndex/re)*Math.log(ie.near)+f.virtualLightIndex/re*Math.log(ie.far))),void 0===ae&&(ae=-Math.exp((1-(1+f.virtualLightIndex)/re)*Math.log(ie.near)+(1+f.virtualLightIndex)/re*Math.log(ie.far))),ie.near=ne,ie.far=ae,te=this._clipConvexHullFromNearFar(_,f,te,ie.near,ie.far),te=this._extrudeConvexHullAlongLightDir(f,I,te,u)}else te=this._extrudeConvexHullAlongLightDir(f,I,te,u);if((f.isVirtual||f.LiSPSM)&&this._updateShadowCamera(_,f,te,ie.near,ie.far,i,u),f.shadowCameraVisible)if(te.applyMatrix4(u.matrixWorld),f.convexHullHelper){if(f.shadowCameraHelperToUpdate){var se=new t.Color(255),oe=[new t.Color(16711680),new t.Color(65280),new t.Color(255)];f.isVirtual&&(se=f.virtualLightIndex<3?oe[f.virtualLightIndex]:(new t.Color).setRGB(0,0,.1*f.virtualLightIndex)),f.convexHullHelper.update(te,se)}}else f.convexHullHelper=new t.CGPolyHelper(te),i.add(f.convexHullHelper);if(f.convexHullHelper&&(f.convexHullHelper.visible=f.shadowCameraVisible),f.cameraHelper&&(f.cameraHelper.visible=f.shadowCameraVisible),f.shadowCameraVisible&&(f.shadowCameraHelperToUpdate?(f.cameraHelper.update(),f.cameraHelper.matrixWorld=Z[K].matrixWorld,f.cameraHelper.toUpdate=!0):f.cameraHelper.toUpdate&&(f.cameraHelper.matrixWorld=(new t.Matrix4).copy(Z[K].matrixWorld),f.cameraHelper.matrixWorldNeedsUpdate=!1,f.cameraHelper.toUpdate=!1)),d.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),d.multiply(u.projectionMatrix),f.castGroundShadow)d.multiply(u.matrixWorldInverse),f._matrixWorldReceiver&&d.multiply(f._matrixWorldReceiver);else{var le=(new t.Matrix4).copy(u.matrixWorldInverse);le.setPosition(new t.Vector3(0,0,0)),d.multiply(le)}if(W&&f instanceof t.PointLight?m.setRenderTarget(f.tempRT):m.setRenderTarget(h),W&&f instanceof t.PointLight?this.shadowComposerContext.writeBuffer=f.tempRT:this.shadowComposerContext.writeBuffer=h,W?j?g.clearColor(Math.exp(80),1,1,1):g.clearColor(.1836426750336792,.28627450980392155,.5529411764705882,.13725490196078433):g.clearColor(1,1,1,1),m.clear(),this.mainComposer.render(void 0,void 0,{main:u,mainNoJittering:u},a),m.transparentShadowEnabled){u.clone(p);var he=function(e){return!e.hasTranspar};this.zPostPass.setDLsToDisableFunc(he),this.forwardPass.setDLsToDisableFunc(he),this.ZOnlyPass.setDLsToDisableFunc(he),this.backgroundPass.setDLsToDisableFunc(he),m.materialToUse=t.MaterialToUse.transparentShadowMaterial,m.setDisableBackFaceCulling(!1),m.setDepthTest(!0),m.setDepthWrite(!1),m.enableScissorTest(!1),m.setRenderTarget(c),this.shadowComposerContext.writeBuffer=c,g.clearColor(1,1,1,1),m.clear(!0,!1,!1),this.mainComposer.render(void 0,void 0,{main:p,mainNoJittering:p},a),this.zPostPass.setDLsToDisableFunc(null),this.forwardPass.setDLsToDisableFunc(null),this.ZOnlyPass.setDLsToDisableFunc(null),this.backgroundPass.setDLsToDisableFunc(null)}(f.castGroundShadow||W)&&(D(),!f.castGroundShadow&&W?(m.esmEffect.setSize(f.shadowMap.width,f.shadowMap.height),f instanceof t.PointLight?m.esmEffect.setInput(f.tempRT):m.esmEffect.setInput(f.shadowMap),m.esmEffect.passBlurV.setForceRenderTarget(f.shadowMap),m.esmEffect.execute()):f.castGroundShadow&&f.blurShadowEffect&&(f.blurShadowEffect.setSize(512,512),f.blurShadowEffect.setInput(f.shadowMap,d),f.blurShadowEffect.execute(),f.groundMaterial&&f.groundMaterial.updatePDSFXUniform("groundShadow",f.blurShadowEffect.getResult())))}}}D(!0)}}},_applyPickingPriorityMappingToAllPasses:function(e,t,i,r){if(e)for(var n=0;n<i.length;n++){var a=i[n];if(a&&a.id&&a.id.startsWith("R")){var s=a.getUsedStateSortingResult(this.renderer,r);s&&this.renderer.setPickingPriorityMapping(t,s)}}},computeIntersectionGPU:function(e,i,r,n,a,s,o,l,h,c,d){this.gl;var u,p=e.scene,f={},g=new Array,m=i.camera,v={main:m,mainNoJittering:m,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho};this.renderer.increaseFrameCount(t._FrameTypes.GPU_INTERSECTION),this.renderer.info.renderTime.pushRoot(t._FrameTypes.GPU_INTERSECTION),this.pickingGPUComposerContext||this.initComposer("PickingGPU"),this.renderer.gammaInput=!1;var y=this.renderer.gammaOutput;this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.mainComposer.updateScene(p),this._updateOITScene(p),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.materialToUse=t.MaterialToUse.pickingMaterial;var S=this.renderer.renderHiddenEdges;this.renderer.renderHiddenEdges=!1,this.mainComposer.setComposerContext(this.pickingGPUComposerContext);var _=this.pickingGPUComposerContext.composer.getAllPasses();this._applyPickingPriorityMappingToAllPasses(h,h,_,this.pickingGPUComposerContext),this.mainComposer.render(void 0,void 0,v,"main"),this.pickingGPUComposerContext.needsUpdate=!1,this._applyPickingPriorityMappingToAllPasses(h,null,_,this.pickingGPUComposerContext);var x,b,w=this.computeMeshPick(e,r,a,h,d),M=w.tab;for(u=0;u<M.length;++u){if((P=M[u])&&P._instancingInfos&&P._instancingInfos.isInstanceNode3D&&"instance"===P._instancingInfos.instancingSelectionMode){x=x||new t.Scene;var C=P.clone();P.copyInstancingInfos(C),x.add(C)}}for(n=n||c&&x,x&&(null===this.pickingGPUInstancingComposerContext&&this.initComposer("PickingGPUInstancing"),this.renderer.autoUpdateScene=!0,x.updateMatrixWorld(),this.mainComposer.updateScene(x),this._updateOITScene(x),this.renderer.materialToUse=t.MaterialToUse.pickingMaterialInstancing,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.pickingGPUInstancingComposerContext),this.pickingGPUInstancingComposerContext.needsUpdate=!0,this.mainComposer.render(void 0,void 0,v,"main"),this.pickingGPUInstancingComposerContext.needsUpdate=!1,b=this.computeInstancePick(e,r,a),this.pickingGPUInstancingComposerContext.needsUpdate=!0,x.dispose(),x=null),u=0;u<M.length;++u){var P;if(P=M[u])if(b&&b.has(P))b.get(P).forEach(function(e){var t={};t.object=P,t.type=w.type,t.instanceId=e,g.push(t)});else(f={}).object=P,f.type=w.type,g.push(f)}if(g.length||g.push({object:null}),n){var E=p;this.normalComposerContext||this.initComposer("Normal"),this.depthComposerContext||this.initComposer("Depth"),this.renderer.autoUpdateScene=!0,E.updateMatrixWorld(),this.mainComposer.updateScene(E),this._updateOITScene(E),this.renderer.materialToUse=t.MaterialToUse.normalMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.normalComposerContext),this.mainComposer.render(void 0,void 0,v,"main"),this.normalComposerContext.needsUpdate=!1,this.computeNormalPick(g,m,w.outMouse),this.renderer.autoUpdateScene=!0,E.updateMatrixWorld(),this.mainComposer.updateScene(E),this._updateOITScene(E),this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.depthComposerContext),this.mainComposer.render(void 0,void 0,v,"main"),this.depthComposerContext.needsUpdate=!1;var A=g[0].object&&g[0].object._occurrence?g[0].object._occurrence.node:null,T="";A&&""!==(T=A._getPickingCameraName())&&(m=i[T]),this.computePositionPick(g,m,w.outMouse)}return this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=y,this.renderer.renderHiddenEdges=S,this.renderer.info.renderTime.popRoot(t._FrameTypes.GPU_INTERSECTION),g},computeIntersectionGPUSmallTarget:function(e,i,r,n,a,s,o){this.gl;var l,h=e.scene,c={},d=new Array,u=this.renderer.getViewport(),p=u.width,f=u.height,g=Math.round(r.xPix),m=Math.round(r.yPix);this.renderer.setViewport(0,0,2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1);var v=i.camera,y={main:v,mainNoJittering:v,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho},S=null;v.fullWidth&&(S={fullWidth:v.fullWidth,fullHeight:v.fullHeight,x:v.x,y:v.y,width:v.width,height:v.height}),y.main.useRealSize=!0,y.connectedRobotCamera.useRealSize=!0,y.robotCameraOrtho.useRealSize=!0;var _=2*this.gpuPickingTolerance+1,x=this.gpuPickingTolerance,b=this.gpuPickingTolerance,w=0,M=0;if(a&&r.pt&&(w=Math.round(Math.abs(r.xPix-r.pt.xPix)),M=Math.round(Math.abs(r.yPix-r.pt.yPix))),S){var C,P;C=S.width/S.fullWidth,P=S.height/S.fullHeight;var E=S.fullWidth/p,A=S.fullHeight/f;p=S.fullWidth,f=S.fullHeight,m*=A,g=(g*=E)*C+S.x,m=m*P+S.y,x*=C,b*=P,w*=C,M*=P}var T=a&&0!==w?w:2*x+1,D=a&&0!==M?M:2*b+1,I=a?g:g-x,R=a?m:m-b;i._setPickingViewOffset({cameraSet:y,fullHeight:f,fullWidth:p,x:I,y:R-1,width:T,height:D,pickingRatioW:_/u.width,pickingRatioH:_/u.height}),this.renderer.increaseFrameCount(t._FrameTypes.GPU_INTERSECTION_SMALL),this.renderer.info.renderTime.pushRoot(t._FrameTypes.GPU_INTERSECTION_SMALL),this.pickingGPUComposerContext||this.initComposer("PickingGPU",!0),a&&this.pickingGPUComposerContext.setSize(w,M);var O=!!a;this.currentGPUPickPosition.x==g&&this.currentGPUPickPosition.y==m||(this.currentGPUPickPosition.x=g,this.currentGPUPickPosition.y=m,O=!0),this.renderer.gammaInput=!1;var L=this.renderer.gammaOutput;this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.mainComposer.updateScene(h),this._updateOITScene(h),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.materialToUse=t.MaterialToUse.pickingMaterial;var V=this.renderer.renderHiddenEdges;this.renderer.renderHiddenEdges=!1,this.mainComposer.setComposerContext(this.pickingGPUComposerContext);var F=this.pickingGPUComposerContext.composer.getAllPasses();this._applyPickingPriorityMappingToAllPasses(s,s,F,this.pickingGPUComposerContext),this.pickingGPUComposerContext.needsUpdate=O||this.pickingGPUComposerContext.needsUpdate,this.mainComposer.render(void 0,void 0,y,"main"),this.pickingGPUComposerContext.needsUpdate=!1,this._applyPickingPriorityMappingToAllPasses(s,null,F,this.pickingGPUComposerContext);var B,N,G=this.computeMeshPickSmallTarget(e,r,a,s),k=G.tab;for(l=0;l<k.length;++l){if((z=k[l])&&z._instancingInfos&&z._instancingInfos.isInstanceNode3D&&"instance"===z._instancingInfos.instancingSelectionMode){B=B||new t.Scene;var U=z.clone();z.copyInstancingInfos(U),B.add(U)}}for(n=n||o&&B,B&&(this.pickingGPUInstancingComposerContext||this.initComposer("PickingGPUInstancing",!0),a&&this.pickingGPUInstancingComposerContext.setSize(w,M),this.renderer.autoUpdateScene=!0,B.updateMatrixWorld(),this.mainComposer.updateScene(B),this._updateOITScene(B),this.renderer.materialToUse=t.MaterialToUse.pickingMaterialInstancing,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.pickingGPUInstancingComposerContext),this.pickingGPUInstancingComposerContext.needsUpdate=!0,this.mainComposer.render(void 0,void 0,y,"main"),this.pickingGPUInstancingComposerContext.needsUpdate=!1,N=this.computeInstancePickSmallTarget(e,r,a),this.pickingGPUInstancingComposerContext.needsUpdate=!0,B.dispose(),B=null),l=0;l<k.length;++l){var z;if(z=k[l])if(N&&N.has(z))N.get(z).forEach(function(e){var t={};t.object=z,t.type=G.type,t.instanceId=e,d.push(t)});else(c={}).object=z,c.type=G.type,d.push(c)}if(d.length||d.push({object:null}),n){this.normalComposerContext||this.initComposer("Normal",!0),this.depthComposerContext||this.initComposer("Depth",!0),a&&i._setPickingViewOffset({cameraSet:y,fullHeight:u.height,fullWidth:u.width,x:g-x,y:m-b-1,width:2*x+1,height:2*b+1}),this.renderer.autoUpdateScene=!0,h.updateMatrixWorld(),this.mainComposer.updateScene(h),this._updateOITScene(h),this.renderer.materialToUse=t.MaterialToUse.normalMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.normalComposerContext),this.normalComposerContext.needsUpdate=O||this.normalComposerContext.needsUpdate,this.mainComposer.render(void 0,void 0,y,"main"),this.normalComposerContext.needsUpdate=!1,this.computeNormalPickSmallTarget(d,v,G.outMouse),this.renderer.autoUpdateScene=!0,h.updateMatrixWorld(),this.mainComposer.updateScene(h),this._updateOITScene(h),this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.depthComposerContext),this.depthComposerContext.needsUpdate=O||this.depthComposerContext.needsUpdate,this.mainComposer.render(void 0,void 0,y,"main"),this.depthComposerContext.needsUpdate=!1;var H=d[0].object&&d[0].object._occurrence?d[0].object._occurrence.node:null,W="";H&&""!==(W=H._getPickingCameraName())&&(v=i[W]),this.computePositionPickSmallTarget(d,v,G.outMouse)}return this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=L,this.renderer.renderHiddenEdges=V,i._setPickingViewOffset({cameraSet:y,reset:!0}),S&&i.setViewOffset(S,!0),this.renderer.setViewport(u.x,u.y,u.width,u.height),y.main.useRealSize=!1,y.connectedRobotCamera.useRealSize=!1,y.robotCameraOrtho.useRealSize=!1,a&&(this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.pickingGPUInstancingComposerContext&&this.pickingGPUInstancingComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)),this.renderer.info.renderTime.popRoot(t._FrameTypes.GPU_INTERSECTION_SMALL),d},computeDepthBuffer:function(e,i,r){var n={main:i.camera,mainNoJittering:i.camera,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho},a=e.scene;this.depthComposerContext||this.initComposer("Depth"),r&&(this.depthComposerContext.needsUpdate=!0),this.renderer.gammaInput=!1;var s=this.renderer.gammaOutput;this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoUpdateScene=!0,a.updateMatrixWorld(),this.mainComposer.updateScene(a),this._updateOITScene(a),this.mainComposer.setComposerContext(this.depthComposerContext),this.mainComposer.render(void 0,void 0,n,"main"),this.depthComposerContext.needsUpdate=!1,this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=s},computePositionGPU:function(e,i,r){this.gl;var n=e.scene,a=[],s={main:i.camera,mainNoJittering:i.camera,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho};this.renderer.gammaInput=!1;var o=this.renderer.gammaOutput;return this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.depthComposerContext||this.initComposer("Depth"),this.renderer.autoUpdateScene=!0,n.updateMatrixWorld(),this.mainComposer.updateScene(n),this._updateOITScene(n),this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.depthComposerContext),this.mainComposer.render(void 0,void 0,s,"main"),this.depthComposerContext.needsUpdate=!1,a[0]={point:null},this.computePositionPick(a,camera,r),this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=o,a[0].point},overrideUpdate:function(e){var t=e.root._getViewer();if(e.root._getTreeModified()&&t.getCurrentSceneGraphState()&&function(){var t,i=e.root._occurrences;for(t=0;t<i.length;t++)i[t].requestOverridesUpdate()}(),e.root._getTreeModified()&&t._sceneGraphOverrideSetManager&&t._sceneGraphOverrideSetManager._updateOverridesWithMissingTarget(t),e.root._tryOverridesUpdate(t),e.root._getTreeModified()){var i=new Set;e.root.traverseUnique(function(e){if(!e._getTreeModified())return!0;i.add(e)}),i.forEach(function(e){e.__setTreeModified(!1)})}},renderRealDepth:function(e,t,i,r,n,a,s,o){this.outlineDepthComposerContext||(this.initComposer("OutlineDepth"),this.initComposer("MirrorOutlineDepth")),this.renderer.dBuffer=this.renderRealDepth_internal(e,t,i,r,n,a,s,o?this.mirrorOutlineDepthComposerContext:this.outlineDepthComposerContext,!1)},renderOcclusionRealDepth:function(e,t,i,r,n,a,s){return this.occlusionDepthComposerContext||this.initComposer("OcclusionDepth"),this.renderRealDepth_internal(e,t,i,r,n,a,s,this.occlusionDepthComposerContext,!0)},renderRealDepth_internal:function(e,i,r,n,a,s,o,l,h){l.setCameraName(e),this.mainComposer.updateScene(i),this._updateOITScene(i);var c=this.renderer.supportsFloatTextures();this.renderer.materialToUse=c&&!h?t.MaterialToUse.normalDepthMaterial:t.MaterialToUse.depthRGBAMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),r.stencilFunc(r.ALWAYS,1,4294967295),r.clearStencil(0),this.renderer.lensFlareEnabled=!1;var d,u,p=function(e){return!e.hasOcclusionDepth};return this.zPostPass.setDLsToDisableFunc(p),this.forwardPass.setDLsToDisableFunc(p),this.ZOnlyPass.setDLsToDisableFunc(p),this.backgroundPass.setDLsToDisableFunc(p),l.setPassClear(this.initClearPass,!0,new t.Color(0),0),l.enableRenderCuttingElementsPasses(s),this.mainComposer.setComposerContext(l),this.renderer.splitScreenMode&&(d=this.renderer.getScissorTest(),this.renderer.enableScissorTest(!1),u=this.renderer.getViewport(),this.renderer.setViewport(0,0,u.width,u.height)),this.renderer.initWebGLObjects(i),this.mainComposer.render(void 0,void 0,n,a),this.renderer.splitScreenMode&&(this.renderer.setViewport(u.x,u.y,u.width,u.height),this.renderer.enableScissorTest(d)),this.renderer.lensFlareEnabled=!0,this.zPostPass.setDLsToDisableFunc(null),this.forwardPass.setDLsToDisableFunc(null),this.ZOnlyPass.setDLsToDisableFunc(null),this.backgroundPass.setDLsToDisableFunc(null),this.mainComposer.getRenderResult("main")},renderOpaqueScene:function(e,i,r,n,a,s){this.opaqueOnlyComposerContext||this.initComposer("Opaque");var o,l,h=this.renderer;this.opaqueOnlyComposerContext.setCameraName(e),this.mainComposer.updateScene(i),this._updateOITScene(i),h.materialToUse=t.MaterialToUse.originalMaterial,h.autoClearDepth=!0,h.autoClearStencil=!0,r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),r.stencilFunc(r.ALWAYS,1,4294967295),r.clearStencil(0),h.lensFlareEnabled=!1,this.opaqueOnlyComposerContext.setPassClear(this.initClearPass,!0,new t.Color(0),0),this.opaqueOnlyComposerContext.enableRenderCuttingElementsPasses(s),this.mainComposer.setComposerContext(this.opaqueOnlyComposerContext),h.splitScreenMode&&(o=h.getScissorTest(),h.enableScissorTest(!1),l=h.getViewport(),h.setViewport(0,0,l.width,l.height)),this.mainComposer.render(void 0,void 0,n,a),h.splitScreenMode&&(h.setViewport(l.x,l.y,l.width,l.height),h.enableScissorTest(o)),h.lensFlareEnabled=!0},renderColorScene:function(e,i,r,n,a,s){this.colorComposerContext||this.initComposer("Color");var o,l,h=this.renderer;this.colorComposerContext.setCameraName(e),this.mainComposer.updateScene(i),this._updateOITScene(i),h.materialToUse=t.MaterialToUse.originalMaterial,h.autoClearDepth=!0,h.autoClearStencil=!0,r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),r.stencilFunc(r.ALWAYS,1,4294967295),r.clearStencil(0),h.lensFlareEnabled=!1,this.colorComposerContext.setPassClear(this.initClearPass,!0,new t.Color(0),0),this.colorComposerContext.enableRenderCuttingElementsPasses(s),this.mainComposer.setComposerContext(this.colorComposerContext),h.splitScreenMode&&(o=h.getScissorTest(),h.enableScissorTest(!1),l=h.getViewport(),h.setViewport(0,0,l.width,l.height)),this.mainComposer.render(void 0,void 0,n,a),h.splitScreenMode&&(h.setViewport(l.x,l.y,l.width,l.height),h.enableScissorTest(o)),h.lensFlareEnabled=!0},renderPoliteDepth:function(e,i,r,n,a,s,o){this.highlightDepthComposerContext||this.initComposer("HighlightDepth");var l=this.renderer;this.highlightDepthComposerContext.setCameraName(e),this.mainComposer.updateScene(i),this._updateOITScene(i),l.materialToUse=t.MaterialToUse.depthRGBAMaterial,l.autoClearDepth=!0,l.autoClearStencil=!0,r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),r.stencilFunc(r.ALWAYS,1,4294967295),r.clearStencil(0),l.lensFlareEnabled=!1;var h,c,d=function(e){return!e.hasPoliteDepth};this.zPostPass.setDLsToDisableFunc(d),this.forwardPass.setDLsToDisableFunc(d),this.ZOnlyPass.setDLsToDisableFunc(d),this.backgroundPass.setDLsToDisableFunc(d),this.highlightDepthComposerContext.setPassClear(this.initClearPass,!0,new t.Color(16777215),1),this.highlightDepthComposerContext.enableRenderCuttingElementsPasses(s),this.mainComposer.setComposerContext(this.highlightDepthComposerContext),l.splitScreenMode&&(h=l.getScissorTest(),l.enableScissorTest(!1),c=l.getViewport(),l.setViewport(0,0,c.width,c.height)),this.mainComposer.render(void 0,void 0,n,a),l.splitScreenMode&&(l.setViewport(c.x,c.y,c.width,c.height),l.enableScissorTest(h)),l.politeDepthBuffer=this.mainComposer.getRenderResult("main"),l.lensFlareEnabled=!0,this.zPostPass.setDLsToDisableFunc(null),this.forwardPass.setDLsToDisableFunc(null),this.ZOnlyPass.setDLsToDisableFunc(null),this.backgroundPass.setDLsToDisableFunc(null)},renderPostEffectNormalDepth:function(e,i,r,n,a,s,o){var l,h;this.mainComposer.updateScene(r),this._updateOITScene(r),this.renderer.materialToUse=i,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,n.stencilOp(n.REPLACE,n.REPLACE,n.REPLACE),n.stencilFunc(n.ALWAYS,1,4294967295),n.clearStencil(0),this.renderer.lensFlareEnabled=!1,e.setPassClear(this.initClearPass,!0,new t.Color(0),0),e.enableRenderCuttingElementsPasses(o),this.mainComposer.setComposerContext(e),this.renderer.splitScreenMode&&(l=this.renderer.getScissorTest(),this.renderer.enableScissorTest(!1),h=this.renderer.getViewport(),this.renderer.setViewport(0,0,h.width,h.height)),this.mainComposer.render(void 0,void 0,a,s),this.renderer.splitScreenMode&&(this.renderer.setViewport(h.x,h.y,h.width,h.height),this.renderer.enableScissorTest(l)),this.renderer.lensFlareEnabled=!0},render:function(e,i,r,n,a,s,o,l,h,c,d,u,p,f,g,m,v,y,S,_,x){this.renderer.renderIteration=m,this.renderer.increaseFrameCount(t._FrameTypes.MAIN),this.renderer.info.renderTime.pushRoot(t._FrameTypes.MAIN),a.mainNoJittering=a.main;var b=this.MSAAEffect&&this.MSAAEffect.enabled,w=this.TAAEffect&&this.TAAEffect.enabled,M=b||w,C=M?w?this.TAAEffect:this.MSAAEffect:null;if(this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&this.BokehDOFEffect.iterative){var P=null;M&&(P=C.computeJitterValues(a.main,m)),a.main=this.BokehDOFEffect.computeJitterCamera(a.main,m,P),a.cameraBackground=this.BokehDOFEffect.computeJitterCamera(a.cameraBackground,m,P)}else M&&(q++,q%=128,a.main=C.computeJitterCamera(a.main,m||q),a.cameraBackground=C.computeJitterCamera(a.cameraBackground,m||q),a.mirrorCamera&&(a.mirrorCamera=C.computeJitterCamera(a.mirrorCamera,m)));this.overrideUpdate(s,d);var E,A,T,D,I,R=this.gl;this.renderer.gammaInput=!0,this.renderer.materialToUse=t.MaterialToUse.originalMaterial,T=s.scene;!u&&(h||this.renderer.getViewportSize().width===this.viewportWidth&&(this.renderer.getViewportSize().height,this.viewportHeight)),WUX.Selection.HSOManager,WUX.Selection.PSOManager;D=(this.HighlightEffect||this.Canvas2DHighlightEffect)&&!S,I=this.PreHighlightEffect||this.Canvas2DPreHighlightEffect,this.HighlightEffect&&this.HighlightEffect.setEnabled(D),D&&this.HighlightEffect.setSize(this.viewportWidth,this.viewportHeight),this.Canvas2DHighlightEffect&&this.Canvas2DHighlightEffect.setEnabled(D),D&&this.Canvas2DHighlightEffect.setSize(this.viewportWidth,this.viewportHeight),I&&this.PreHighlightEffect.setEnabled(I),I&&this.PreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight),I&&this.Canvas2DPreHighlightEffect.setEnabled(I),I&&this.Canvas2DPreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight),this.updateFinalComposer(h);var O=!1;if(!c||!this.useCompositing||!this.highlightPass||this.renderer._requestPoliteDepthBuffer&&null===this.renderer.politeDepthBuffer){this.pickingGPUComposerContext&&(this.pickingGPUComposerContext.needsUpdate=!0,this.meshesGPU={}),this.normalComposerContext&&(this.normalComposerContext.needsUpdate=!0,this.normalsGPU={}),this.depthComposerContext&&(this.depthComposerContext.needsUpdate=!0,this.positionsGPU={}),this.currentGPUPickPosition={x:-1,y:-1},this.renderer.reflectionColorBuffer=null,this.renderer.refractionColorBuffer=null,this.renderer.autoUpdateScene=!0,T.updateMatrixWorld(),this.renderer.initWebGLObjects(T),this.useAuxiliaryAsForward||(this.updateClippingGlobals(s,T,this,_,x),this.renderer.sectionCappingEnabled&&this.renderer.clipPlanes.length>0&&(O=!0),O&&this.updateSectionCappingScene(s,T)),this.afterMirrorClearDepth&&this.afterMirrorClearDepth.setClearStencil(O),this.renderer.shadowMapEnabled=r,this.renderer.shadowMapSoft=r,this.computeShadows("main",T,R,a,y,r),this.renderer.materialToUse=t.MaterialToUse.originalMaterial,(!m||v)&&(this.SSLREffect&&this.SSLREffect.enabled||this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled||this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled)&&(this.normalDepthIoRRoughnessComposerContext||this.initComposer("NormalDepthIoRRoughness"),this.renderPostEffectNormalDepth(this.normalDepthIoRRoughnessComposerContext,t.MaterialToUse.normalDepthIoRRoughnessMaterial,T,R,a,y,O));var L=(!m||v)&&(this.SSAOEffect&&this.SSAOEffect.enabled||this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled||this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&!this.BokehDOFEffect.iterative||T.__webglFlares&&T.__webglFlares.length||this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled);(L=L||this.TAAEffect&&this.TAAEffect.enabled||this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&(1===m||m>1&&this.MSAAEffect&&this.MSAAEffect.enabled))&&(this.normalDepthComposerContext||this.initComposer("NormalDepth"),this.renderPostEffectNormalDepth(this.normalDepthComposerContext,t.MaterialToUse.normalDepthMaterial,T,R,a,y,O)),(!m||v)&&this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&this.renderOpaqueScene("main",T,R,a,y,O),this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&(this.renderer.refractionColorBuffer=this.SSLRefractionEffect.execute()),(!m||v)&&this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&this.renderColorScene("main",T,R,a,y,O),this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&(this.renderer.reflectionColorBuffer=this.SSLReflectionEffect.execute()),this.renderer._requestPoliteDepthBuffer&&this.renderPoliteDepth(this.mobile?"main":"mainNoJittering",T,R,a,y,O,s),this.renderer.materialToUse=t.MaterialToUse.originalMaterial;var V=this.renderer.requestDBuffer||this.SkyScatteringEffect&&this.SkyScatteringEffect.enabled||this.renderer.getRenderMode(null).getMask()&t.OutlineMask;if(i){V&&this.renderRealDepth("mirrorCamera",T,R,a,y,O,s,!0),this.renderer.materialToUse=t.MaterialToUse.originalMaterial,this.compMirrorComposerContext.setPassClear(this.initClearPass,!0,new t.Color(0),0),this.compMirrorComposerContext.enableRenderCuttingElementsPasses(O),this.mainComposer.updateScene(T),this._updateOITScene(T);var F=!1;null!==o&&(F=o.visible,o.visible=!1);var B=!1,N=20*(1-l);this.passMirrorBlur.uniforms.radius.value=this.renderer._renderScale*N,N>0&&(B=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur,B),B=!1,N>12&&(B=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur1,B),B=!1,N>16&&(B=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur2,B),B=!1,N>18&&(B=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur3,B),this.compMirrorComposerContext.setRenderPlugins(this.forwardPass,!0);var G=this.renderer.renderFaceMode;this.renderer.renderFaceMode=this.renderer.renderFaceMode&~t.GeomTypeEnum.INFINITE_FACE&~t.GeomTypeEnum.AXIS_SYSTEM;var k=this.renderer.renderLineMode;this.renderer.renderLineMode=this.renderer.renderLineMode&~t.GeomTypeEnum.WIRE_EDGE;var U=this.renderer.renderPointMode;this.renderer.renderPointMode=0,this.mainComposer.setComposerContext(this.compMirrorComposerContext),this.mainComposer.render(.1,void 0,a,y),this.renderer.renderFaceMode=G,this.renderer.renderLineMode=k,this.renderer.renderPointMode=U,null!==o&&(o.visible=F)}if(V&&this.renderRealDepth("main",T,R,a,y,O,s,!1),this.renderer.materialToUse=t.MaterialToUse.originalMaterial,this.renderer.autoClear=!1,this.compForwardComposerContext.enablePass(this.infPlanePass,e),this.compForwardComposerContext.setPassClear(this.initClearPass,!0,new t.Color(this.bgColor).multiplyScalar(this.bgAlpha),this.bgAlpha),this.infPlanePass.scene=n,this.compForwardComposerContext.enableRenderCuttingElementsPasses(O),this.compForwardComposerContext.enablePass(this.mirrorBlendPass,e&&i),this.compForwardComposerContext.enablePass(this.mirrorClearDepth,e&&i),this.compForwardComposerContext.enablePass(this.afterMirrorClearDepth,i),this.compForwardComposerContext.setPassClear(this.mirrorClearDepth,!0,new t.Color(0),1),this.compForwardComposerContext.setPassClear(this.afterMirrorClearDepth,!1,new t.Color(0),1),this.compForwardComposerContext.setPassClearDepth(this.afterMirrorClearDepth,!0),this.compForwardComposerContext.setPassClear(this.initClearPass,!0,new t.Color(this.bgColor).multiplyScalar(this.bgAlpha),this.bgAlpha),this.forwardPass.scene=T,this.zPostPass.scene=T,this.backgroundPass.scene=T,this.ZOnlyPass.scene=T,this.mainComposer.updateScene(T),this._updateOITScene(T),this._postProHighlight||this._HighlightMobileNonEffect.hide(S),this.customComposerContexts){var z=this.mainComposer.getPostEffectPasses();for(A=0;A<z.length;A++)for(E=0;E<this.customComposerContexts.length;E++)this.customComposerContexts[E].enablePass(z[A],!1);for(E=0;E<this.customComposerContexts.length;E++)this.customComposerContexts[E].enablePass(this.afterMirrorClearDepth,!1),this.customComposerContexts[E].enableRenderCuttingElementsPasses(O),this.mainComposer.setComposerContext(this.customComposerContexts[E]),this.mainComposer.render(void 0,void 0,a,y)}if(p){var H=new t.WebGLRenderTargetProperties(f,f,"cubelinear"),W=this.compForwardComposerContext.originalRenderTargetProperties,j=this.compForwardComposerContext.keepResult,X=this.compForwardComposerContext.renderResults.main,Z=X.useCount;this.compForwardComposerContext.keepResult=!0,X.useCount=1,this.compForwardComposerContext.releaseRenderTargets(this.mainComposer.renderTargetPool),this.compForwardComposerContext.originalRenderTargetProperties=H,this.mainComposer.setComposerContext(this.compForwardComposerContext),this.ToneMappingEffect&&this.compForwardComposerContext.setAsLastPass(this.ToneMappingEffect.mixPass,!0),this.mainComposer.render(.1,g,a,y),this.ToneMappingEffect&&this.compForwardComposerContext.setAsLastPass(this.ToneMappingEffect.mixPass,!1),this.compForwardComposerContext.originalRenderTargetProperties=W,this.compForwardComposerContext.keepResult=j,X.useCount=Z}else this.useAuxiliaryAsForward?this.mainComposer.setComposerContext(this.auxiliaryViewpointComposerContext):this.mainComposer.setComposerContext(this.compForwardComposerContext),this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled&&this.VolumeRenderingEffect.execute(),this.mainComposer.render(.1,void 0,a,y);this.renderer.shadowMapEnabled=!1,this.renderer.shadowMapSoft=!1}else if(this.useAuxiliaryAsForward)this.mainComposer.updateScene(T),this._updateOITScene(T),this.mainComposer.setComposerContext(this.auxiliaryViewpointComposerContext),this.mainComposer.render(.1,void 0,a,y);else{if(this.customComposerContexts){this.renderer.initWebGLObjects(T),this.updateClippingGlobals(s,T,this,_,x),this.renderer.sectionCappingEnabled&&this.renderer.clipPlanes.length>0&&(O=!0),O&&this.updateSectionCappingScene(s,T);z=this.mainComposer.getPostEffectPasses();for(A=0;A<z.length;A++)for(E=0;E<this.customComposerContexts.length;E++)this.customComposerContexts[E].enablePass(z[A],!1);for(E=0;E<this.customComposerContexts.length;E++)this.customComposerContexts[E].enablePass(this.afterMirrorClearDepth,!1),this.customComposerContexts[E].enableRenderCuttingElementsPasses(O),this.mainComposer.setComposerContext(this.customComposerContexts[E]),this.mainComposer.render(void 0,void 0,a,y)}this.mainComposer.setComposerContext(this.compForwardComposerContext),this.mainComposer.updateLinks(y),this.mainComposer.setComposerContext(this.compForwardComposerContext),this.mainComposer.render(.1,void 0,a,y,this.highlightPass)}this.renderer.renderAssets(),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.setDepthFunc(R.LEQUAL),this.renderer.info.renderTime.popRoot(t._FrameTypes.MAIN)},combineResults:function(e,i,n){if(!n.isReady())return!1;if(!this.superFinalComposer){var a=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint");a.generateMipmaps=!1,this.superFinalComposer=new r(this.renderer,a,this.renderTargetPool),this.superFinalComposer.composerContext.name="superFinalComposer",n.createPasses(this.superFinalComposer)}n.updatePasses(e,i,this.compForwardComposerContext.renderResults);var s=this.renderer.getViewportSize();return this.renderer.setViewport(0,0,this.deviceWidth,this.deviceHeight),this.superFinalComposer.render(.1,void 0,{},"superFinal"),this.renderer.setViewport(0,0,s.width,s.height),!0},computeMeshPick:function(e,t,i,r,n){var a,s;n&&void 0!==t.x&&void 0!==t.y?(a=Math.round(Math.round((t.x+1)*this.viewportWidth/2)),s=Math.round(this.viewportHeight-Math.round((t.y+1)*this.viewportHeight/2))):(a=Math.round(t.xPix),s=Math.round(t.yPix));var o,l,h,c,d=i&&t.pt&&0!==Math.round(t.xPix-t.pt.xPix)?Math.round(Math.abs(t.xPix-t.pt.xPix)):1,u=i&&t.pt&&0!==Math.round(t.yPix-t.pt.yPix)?Math.round(Math.abs(t.yPix-t.pt.yPix)):1,p=this.viewportHeight,f={},g=new Set,m=a,v=s,y=!0;if(0==i){for(y=this.pickingGPUComposerContext.needsUpdate,l=a-this.gpuPickingTolerance;l<=a+this.gpuPickingTolerance;++l)for(h=s-this.gpuPickingTolerance;h<=s+this.gpuPickingTolerance;++h)this.meshesGPU[h*this.viewportWidth+l]||(y=!0);m=a-this.gpuPickingTolerance,v=s-this.gpuPickingTolerance,d=2*this.gpuPickingTolerance+1,u=2*this.gpuPickingTolerance+1}if(y){var S=new Uint8Array(4*d*u);for(this.gl.readPixels(m,p-v-u+1,d,u,this.gl.RGBA,this.gl.UNSIGNED_BYTE,S),l=0;l<d;++l)for(h=0;h<u;++h){o=(63&S[c=4*(h*d+l)])<<16|S[c+1]<<8|S[c+2];var _=S[c]>>6&3,x=f[o];void 0===x&&(x=this.getObjectById(e.scene,o),f[o]=x,x&&x.pickable&&g.add(x)),this.meshesGPU[(v+u-h-1)*this.viewportWidth+m+l]={object:x,glType:_}}}return i?{tab:Array.from(g),outMouse:t}:this._computePixelMeshPick(m,a,d,v,s,u,t,r)},computeInstancePick:function(e,t,i){var r,n,a,s,o=Math.round(t.xPix),l=Math.round(t.yPix),h=i&&t.pt&&0!==Math.round(t.xPix-t.pt.xPix)?Math.round(Math.abs(t.xPix-t.pt.xPix)):1,c=i&&t.pt&&0!==Math.round(t.yPix-t.pt.yPix)?Math.round(Math.abs(t.yPix-t.pt.yPix)):1,d=this.viewportHeight,u=o,p=l;i||(u=o-this.gpuPickingTolerance,p=l-this.gpuPickingTolerance,h+=2*this.gpuPickingTolerance,c+=2*this.gpuPickingTolerance);var f=new Uint8Array(4*h*c);this.gl.readPixels(u,d-p-c+1,h,c,this.gl.RGBA,this.gl.UNSIGNED_BYTE,f);var g=new Map,m=i?0:this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;for(n=0;n<h;++n)for(a=0;a<c;++a)if(!(0===(r=f[s=4*(a*h+n)]<<16|f[s+1]<<8|f[s+2])||r>16777215)){var v=r%5;if(0!==v&&(v>3?r=r+5-v:v<3?r-=v:r=void 0),0!==r&&void 0!==r)if(i){if(y=this.meshesGPU[(p+c-a-1)*this.viewportWidth+u+n])if(g.has(y.object))g.get(y.object).add(r);else(S=new Set).add(r),g.set(y.object,S)}else{var y,S,_=n+u-o,x=a+p-l;if(_*_+x*x<m)if(y=this.meshesGPU[(p+c-a-1)*this.viewportWidth+u+n])if(g.has(y.object))g.get(y.object).add(r);else(S=new Set).add(r),g.set(y.object,S)}}return g},computePositionPick:function(e,i,r){var n,a,s,o=r.xPix,l=r.yPix,h=this.viewportHeight,c=new Uint8Array(4);!this.depthComposerContext.needsUpdate&&this.positionsGPU[l*this.viewportWidth+o]?n=this.positionsGPU[l*this.viewportWidth+o]:(this.gl.readPixels(o,h-l,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,c),s=(a=new Float32Array(c.buffer))[0]?2*a[0]-1:1,(n=new t.Vector4(r.x,r.y,s,1)).applyMatrix4(i.projectionMatrixInverse),n.multiplyScalar(1/n.w),n.applyMatrix4(i.matrixWorld),this.positionsGPU[l*this.viewportWidth+o]=n.clone());for(var d=0;d<e.length;++d)e[d].point=new t.Vector3(n.x,n.y,n.z)},computeNormalPick:function(e,i,r){var n,a=r.xPix,s=r.yPix,o=this.viewportHeight,l=new Uint8Array(4);if(!this.normalComposerContext.needsUpdate&&this.normalsGPU[s*this.viewportWidth+a])n=this.normalsGPU[s*this.viewportWidth+a];else{this.gl.readPixels(a,o-s,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,l);var h=(n=new t.Vector4(l[0]/255*2-1,l[1]/255*2-1,l[2]/255*2-1,0)).x,c=n.y,d=n.z,u=i.matrixWorld.elements,p=1/(u[3]*h+u[7]*c+u[11]*d+u[15]);n.x=(u[0]*h+u[4]*c+u[8]*d)*p,n.y=(u[1]*h+u[5]*c+u[9]*d)*p,n.z=(u[2]*h+u[6]*c+u[10]*d)*p,this.normalsGPU[s*this.viewportWidth+a]=n.clone()}for(var f=0;f<e.length;++f)e[f].normal=new t.Vector3(n.x,n.y,n.z),e[f].tangent=null},_computePixelMeshPick:function(e,t,i,r,n,a,s,o){for(var l=0,h=0,c=0,d=0,u=null,p=!1,f=2,g=this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance,m=null,v=-1/0,y=0,S=["points","edges","faces"],_=[g,g,0],x=[g,g,0],b=function(e){return e.id===this},w=e;w<e+i;++w)for(var M=w-t,C=r;C<r+a;++C){var P=C-n,E=M*M+P*P,A=this.meshesGPU[C*this.viewportWidth+w];if(A){var T=A.object,D=A.glType,I=T&&T.hasPriorityManipulators&&T.hasPriorityManipulators();if(p&&!I)continue;y=0,T&&T.pickable&&(o&&T.pickingPriorityID&&(m=!!T.pickingPriorityID[S[D]]&&o.find(b,T.pickingPriorityID[S[D]]))&&(y=m.priority),(!p&&I||y>v&&E<=x[D]||y===v&&D<=f&&E<=_[D])&&(p=I,_[D]=E,u=T,f=D,v=y,l=w,h=C,c=w-e,d=C-r))}}return u?{tab:[u],outMouse:{xPix:l,yPix:h,xDev:c,yDev:d,x:(l-this.viewportWidth/2)/(this.viewportWidth/2),y:(this.viewportHeight/2-h)/(this.viewportHeight/2)},type:f}:{tab:[],outMouse:s}},computeMeshPickSmallTarget:function(e,t,i,r){var n,a,s=Math.round(t.xPix),o=Math.round(t.yPix),l=i&&t.pt&&0!==Math.round(t.xPix-t.pt.xPix)?Math.round(Math.abs(t.xPix-t.pt.xPix)):1,h=i&&t.pt&&0!==Math.round(t.yPix-t.pt.yPix)?Math.round(Math.abs(t.yPix-t.pt.yPix)):1,c=(this.viewportHeight,{}),d=new Set,u=s,p=o,f=!0;if(0==i){f=this.pickingGPUComposerContext.needsUpdate;for(var g=s-this.gpuPickingTolerance;g<=s+this.gpuPickingTolerance;++g)for(var m=o-this.gpuPickingTolerance;m<=o+this.gpuPickingTolerance;++m)this.meshesGPU[m*this.viewportWidth+g]||(f=!0);u=s-this.gpuPickingTolerance,p=o-this.gpuPickingTolerance,l=2*this.gpuPickingTolerance+1,h=2*this.gpuPickingTolerance+1}if(f){var v=new Uint8Array(4*l*h);for(this.gl.readPixels(0,0,l,h,this.gl.RGBA,this.gl.UNSIGNED_BYTE,v),g=0;g<l;++g)for(m=0;m<h;++m){n=(63&v[a=4*(m*l+g)])<<16|v[a+1]<<8|v[a+2];var y=v[a]>>6&3,S=c[n];void 0===S&&(S=this.getObjectById(e.scene,n),c[n]=S,S&&S.pickable&&d.add(S)),this.meshesGPU[(p+h-m-1)*this.viewportWidth+u+g]={object:S,glType:y}}}return i?{tab:Array.from(d),outMouse:t}:this._computePixelMeshPick(u,s,l,p,o,h,t,r)},computeInstancePickSmallTarget:function(e,t,i){var r,n,a,s,o=Math.round(t.xPix),l=Math.round(t.yPix),h=i&&t.pt&&0!==Math.round(t.xPix-t.pt.xPix)?Math.round(Math.abs(t.xPix-t.pt.xPix)):1,c=i&&t.pt&&0!==Math.round(t.yPix-t.pt.yPix)?Math.round(Math.abs(t.yPix-t.pt.yPix)):1,d=(this.viewportHeight,o),u=l;i||(d=o-this.gpuPickingTolerance,u=l-this.gpuPickingTolerance,h=2*this.gpuPickingTolerance+1,c=2*this.gpuPickingTolerance+1);var p=new Uint8Array(4*h*c);this.gl.readPixels(0,0,h,c,this.gl.RGBA,this.gl.UNSIGNED_BYTE,p);var f=new Map,g=i?0:this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;for(n=0;n<h;++n)for(a=0;a<c;++a)if(!(0===(r=p[s=4*(a*h+n)]<<16|p[s+1]<<8|p[s+2])||r>16777215)){var m=r%5;if(0!==m&&(m>3?r=r+5-m:m<3?r-=m:r=void 0),0!==r&&void 0!==r)if(i){if(v=this.meshesGPU[(u+c-a-1)*this.viewportWidth+d+n])if(f.has(v.object))f.get(v.object).add(r);else(y=new Set).add(r),f.set(v.object,y)}else{var v,y,S=n+d-o,_=a+u-l;if(S*S+_*_<g)if(v=this.meshesGPU[(u+c-a-1)*this.viewportWidth+d+n])if(f.has(v.object))f.get(v.object).add(r);else(y=new Set).add(r),f.set(v.object,y)}}return f},computePositionPickSmallTarget:function(e,i,r){var n,a,s,o=r.xPix,l=r.yPix,h=(this.viewportHeight,new Uint8Array(4));if(!this.depthComposerContext.needsUpdate&&this.positionsGPU[l*this.viewportWidth+o])n=this.positionsGPU[l*this.viewportWidth+o];else{var c=2*this.gpuPickingTolerance+1;this.gl.readPixels(r.xDev,c-r.yDev-1,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,h),s=(a=new Float32Array(h.buffer))[0]?2*a[0]-1:1,(n=new t.Vector4(r.x,r.y,s,1)).applyMatrix4(i.realProjectionMatrixInverse),n.multiplyScalar(1/n.w),n.applyMatrix4(i.matrixWorld),this.positionsGPU[l*this.viewportWidth+o]=n.clone()}for(var d=0;d<e.length;++d)e[d].point=new t.Vector3(n.x,n.y,n.z)},computeNormalPickSmallTarget:function(e,i,r){var n,a=r.xPix,s=r.yPix,o=(this.viewportHeight,new Uint8Array(4));if(!this.normalComposerContext.needsUpdate&&this.normalsGPU[s*this.viewportWidth+a])n=this.normalsGPU[s*this.viewportWidth+a];else{var l=2*this.gpuPickingTolerance+1;this.gl.readPixels(r.xDev,l-r.yDev-1,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,o);var h=(n=new t.Vector4(o[0]/255*2-1,o[1]/255*2-1,o[2]/255*2-1,0)).x,c=n.y,d=n.z,u=i.matrixWorld.elements,p=1/(u[3]*h+u[7]*c+u[11]*d+u[15]);n.x=(u[0]*h+u[4]*c+u[8]*d)*p,n.y=(u[1]*h+u[5]*c+u[9]*d)*p,n.z=(u[2]*h+u[6]*c+u[10]*d)*p,this.normalsGPU[s*this.viewportWidth+a]=n.clone()}for(var f=0;f<e.length;++f)e[f].normal=new t.Vector3(n.x,n.y,n.z),e[f].tangent=null},getObjectById:function(e,t){var i,r,n;if(e.pickingID===t)return e;for(i=0,r=e.children.length;i<r;i++)if(null!==(n=this.getObjectById(e.children[i],t)))return n;return null},insertComposer:function(e,t){this.mobile&&!Z.has(t.name)||(null!==e&&this.composers.push(e),t.disabledByDefault=!0,this.mainComposer.addPass(t),this.compForwardComposerContext.enablePass(t,!0),"HighlightEffect"===t.name&&(this.highlightPass=t),this.updateFinalComposer(!0))},updateFinalComposer:function(e){if(!this.mobile){var t=this.mainComposer,i=this.compForwardComposerContext;if(t){var r,s,o,l=t.getAllPasses(),h=l.length;for(r=0;r<h;r++)i.setPassRenderToCanvas(l[r],!1);if(e){for(r=h-1;r>=0;r--)if(o=l[r],i.passStates[r].enabled&&o instanceof a){i.setPassRenderToCanvas(o,!0);break}for(s=h-1;s>=0&&(o=l[s],!(i.passStates[s].enabled&&o instanceof a));s--)i.passStates[s].enabled&&(o instanceof n||o instanceof O)&&i.setPassRenderToCanvas(o,!0)}}}},getComposer:function(e){if("normalDepthIoRRoughness"===e)return this.normalDepthIoRRoughnessComposerContext||this.initComposer("NormalDepthIoRRoughness"),this.normalDepthIoRRoughnessComposerContext;if("normalDepth"===e)return this.normalDepthComposerContext||this.initComposer("NormalDepth"),this.normalDepthComposerContext;if("HighlightDepth"===e)return this.highlightDepthComposerContext||this.initComposer("HighlightDepth"),this.highlightDepthComposerContext;if("Depth"===e)return this.depthComposerContext||this.initComposer("Depth"),this.depthComposerContext;if("result"===e)return this.compForwardComposerContext;if("previousColor"===e){if(this.TAAEffect&&this.TAAEffect.enabled)return this.TAAEffect.composers[0].composerContext;if(this.MSAAEffect&&this.MSAAEffect.enabled)return this.MSAAEffect.composers[0].composerContext}else{if("opaque"===e)return this.opaqueOnlyComposerContext||this.initComposer("Opaque"),this.opaqueOnlyComposerContext;if("color"===e)return this.colorComposerContext||this.initComposer("Color"),this.colorComposerContext}return null},getInfos:function(){var e={},i=this.renderer.info.renderMap.get(t._FrameTypes.MAIN);if(i){var r={};Object.assign(r,i.getCulling()),Object.assign(r,i.getRendering()),Object.assign(r,i.getGeometries()),Object.assign(e,{memory:this.renderer.info.memory,render:r})}return e},setScale:function(e){e&&this.renderTargetPool.resetRenderTargetPool();var t="FSAA"===this.antiAliasing||"SSAA"===this.antiAliasing?2:1,i="true"===localStorage.getItem("__HALF_RES_SSAO__")||this.mobile?.707:1,r="true"===localStorage.getItem("__HALF_RES_RAYMARCHING__")||this.mobile?.707:1;i="true"===localStorage.getItem("__QUARTER_RES_SSAO__")?.5:i,r="true"===localStorage.getItem("__QUARTER_RES_RAYMARCHING__")?.5:r,this.compForwardComposerContext&&this.compForwardComposerContext.setSize(t*this.viewportWidth,t*this.viewportHeight),this.compMirrorComposerContext&&this.compMirrorComposerContext.setSize(t*this.viewportWidth,t*this.viewportHeight),this.normalDepthIoRRoughnessComposerContext&&this.normalDepthIoRRoughnessComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.normalDepthComposerContext&&this.normalDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.outlineDepthComposerContext&&this.outlineDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.mirrorOutlineDepthComposerContext&&this.mirrorOutlineDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.occlusionDepthComposerContext&&this.occlusionDepthComposerContext.setSize(this.getQuarterWidth(),this.getQuarterHeight()),this.highlightDepthComposerContext&&this.highlightDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.opaqueOnlyComposerContext&&this.opaqueOnlyComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.colorComposerContext&&this.colorComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.smallTargetPicking||(this.pickingGPUComposerContext&&this.pickingGPUComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.pickingGPUInstancingComposerContext&&this.pickingGPUInstancingComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.normalComposerContext&&this.normalComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.depthComposerContext&&this.depthComposerContext.setSize(this.viewportWidth,this.viewportHeight)),this.auxiliaryViewpointComposerContext&&this.auxiliaryViewpointComposerContext.setSize(this.viewportWidth*t,this.viewportHeight*t),this.FXAAEffect&&this.FXAAEffect.enabled&&this.FXAAEffect.setSize(this.viewportWidth,this.viewportHeight),this.MLAAEffect&&this.MLAAEffect.enabled&&this.MLAAEffect.setSize(this.viewportWidth,this.viewportHeight),this.MSAAEffect&&this.MSAAEffect.enabled&&this.MSAAEffect.setSize(this.viewportWidth,this.viewportHeight),this.TAAEffect&&this.TAAEffect.enabled&&this.TAAEffect.setSize(this.viewportWidth,this.viewportHeight),this.SMAAEffect&&this.SMAAEffect.enabled&&this.SMAAEffect.setSize(this.viewportWidth,this.viewportHeight),this.SSAOEffect&&this.SSAOEffect.enabled&&this.SSAOEffect.setSize(i*this.viewportWidth,i*this.viewportHeight),this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&this.SSAOIterativeEffect.setSize(i*this.viewportWidth,i*this.viewportHeight),this.SSLREffect&&this.SSLREffect.enabled&&this.SSLREffect.setSize(this.viewportWidth,this.viewportHeight),this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&this.SSLReflectionEffect.setSize(r*this.viewportWidth,r*this.viewportHeight),this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&this.SSLRefractionEffect.setSize(r*this.viewportWidth,r*this.viewportHeight),this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled&&this.VolumeRenderingEffect.setSize(this.viewportWidth,this.viewportHeight),this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&this.BokehDOFEffect.setSize(this.viewportWidth,this.viewportHeight),this.SkyScatteringEffect&&this.SkyScatteringEffect.enabled&&this.SkyScatteringEffect.setSize(this.viewportWidth,this.viewportHeight),this.BloomEffect&&this.BloomEffect.enabled&&this.BloomEffect.setSize(this.viewportWidth,this.viewportHeight),this.ToneMappingEffect&&this.ToneMappingEffect.enabled&&this.ToneMappingEffect.setSize(this.viewportWidth,this.viewportHeight),this.FlareEffect&&this.FlareEffect.enabled&&this.FlareEffect.setSize(this.viewportWidth,this.viewportHeight),this.HighlightEffect&&this.HighlightEffect.enabled&&this.HighlightEffect.setSize(this.viewportWidth,this.viewportHeight),this.PreHighlightEffect&&this.PreHighlightEffect.enabled&&this.PreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight),this.Canvas2DHighlightEffect&&this.Canvas2DHighlightEffect.enabled&&this.Canvas2DHighlightEffect.setSize(this.viewportWidth,this.viewportHeight),this.Canvas2DPreHighlightEffect&&this.Canvas2DPreHighlightEffect.enabled&&this.Canvas2DPreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight),this.NativeOnTopEffect&&this.NativeOnTopEffect.enabled&&this.NativeOnTopEffect.setSize(this.viewportWidth,this.viewportHeight),this.DebugPassEffect&&this.DebugPassEffect.enabled&&this.DebugPassEffect.setSize(this.viewportWidth,this.viewportHeight),this.DebugShadowMapsEffect&&this.DebugShadowMapsEffect.enabled&&this.DebugShadowMapsEffect.setSize(this.viewportWidth,this.viewportHeight),this.OITEffect&&this.OITEffect.enabled&&this.OITEffect.setSize(t*this.viewportWidth,t*this.viewportHeight),this.OITnoZEffect&&this.OITnoZEffect.enabled&&this.OITnoZEffect.setSize(t*this.viewportWidth,t*this.viewportHeight);for(var n=0;n<this.customEffects.length;n++){var a=this.customEffects[n];a&&a.enabled&&a.setSize(this.viewportWidth,this.viewportHeight)}null!==this.passMirrorBlur&&(this.passMirrorBlur.uniforms.invSize.value.x=1/this.viewportWidth,this.passMirrorBlur.uniforms.invSize.value.y=1/this.viewportHeight)},initComposer:function(e,i){var r;switch(e){case"Shadow":this.shadowComposerContext=new R(null,this.mainComposer,"shadowComposerContext"),this.shadowComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.setupOneMaterialComposerContext(this.shadowComposerContext,null,null,!1),this.shadowComposerContext._checkCamera=!0,r=this.shadowComposerContext;break;case"Depth":var n;(n=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest")).generateMipmaps=!1,this.depthComposerContext=new R(n,this.mainComposer,"depthComposerContext"),this.setupOneMaterialComposerContext(this.depthComposerContext,0,0,!0),r=this.depthComposerContext;break;case"Normal":var a;a=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest"),this.normalComposerContext=new R(a,this.mainComposer,"normalComposerContext"),this.setupOneMaterialComposerContext(this.normalComposerContext,0,1,!0),r=this.normalComposerContext;break;case"NormalDepth":(s=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"maxPrecisionNearest")).generateMipmaps=!1,this.normalDepthComposerContext=new R(s,this.mainComposer,"normalDepthComposerContext"),this.normalDepthComposerContext.keepResult=!0,this.normalDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT,this.normalDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.normalDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.normalDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.normalDepthComposerContext.enablePass(this.infPlanePass,!1),this.normalDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.normalDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),this.normalDepthComposerContext.linkTo_internal(this.lensFlarePass.plugin._lensFlare.uniforms.tNormalDepth,void 0,"main"),r=this.normalDepthComposerContext;break;case"NormalDepthIoRRoughness":var s;(s=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"nearest")).generateMipmaps=!1,this.normalDepthIoRRoughnessComposerContext=new R(s,this.mainComposer,"normalDepthIoRRoughnessComposerContext"),this.normalDepthIoRRoughnessComposerContext.keepResult=!0,this.normalDepthIoRRoughnessComposerContext.enablePass(this.mirrorBlendPass,!1),this.normalDepthIoRRoughnessComposerContext.enablePass(this.mirrorClearDepth,!1),this.normalDepthIoRRoughnessComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.normalDepthIoRRoughnessComposerContext.enablePass(this.infPlanePass,!1),this.normalDepthIoRRoughnessComposerContext.setRenderPlugins(this.forwardPass,!1),this.normalDepthIoRRoughnessComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.normalDepthIoRRoughnessComposerContext;break;case"OutlineDepth":var o=this.renderer.supportsFloatTextures();(l=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,o?"nearest":"uintNearest")).generateMipmaps=!1,this.outlineDepthComposerContext=new R(l,this.mainComposer,"outlineDepthComposerContext"),this.outlineDepthComposerContext.keepResult=!0,this.outlineDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.outlineDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.outlineDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.outlineDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.outlineDepthComposerContext.enablePass(this.infPlanePass,!1),this.outlineDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.outlineDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.outlineDepthComposerContext;break;case"MirrorOutlineDepth":var l;o=this.renderer.supportsFloatTextures();(l=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,o?"nearest":"uintNearest")).generateMipmaps=!1,this.mirrorOutlineDepthComposerContext=new R(l,this.mainComposer,"mirrorOutlineDepthComposerContext"),this.mirrorOutlineDepthComposerContext.keepResult=!0,this.mirrorOutlineDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.mirrorOutlineDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.mirrorOutlineDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.mirrorOutlineDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.mirrorOutlineDepthComposerContext.enablePass(this.infPlanePass,!1),this.mirrorOutlineDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.mirrorOutlineDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.mirrorOutlineDepthComposerContext;break;case"OcclusionDepth":var h=new t.WebGLRenderTargetProperties(this.getQuarterWidth(),this.getQuarterHeight(),"uintNearest");h.generateMipmaps=!1,this.occlusionDepthComposerContext=new R(h,this.mainComposer,"occlusionDepthComposerContext"),this.occlusionDepthComposerContext.keepResult=!0,this.occlusionDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.occlusionDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.occlusionDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.occlusionDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.occlusionDepthComposerContext.enablePass(this.infPlanePass,!1),this.occlusionDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.occlusionDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.occlusionDepthComposerContext;break;case"HighlightDepth":var c=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest");c.generateMipmaps=!1,this.highlightDepthComposerContext=new R(c,this.mainComposer,"highlightDepthComposerContext"),this.highlightDepthComposerContext.keepResult=!0,this.highlightDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.highlightDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.highlightDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.highlightDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.highlightDepthComposerContext.enablePass(this.infPlanePass,!1),this.highlightDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.highlightDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.highlightDepthComposerContext;break;case"Opaque":var d=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"nearest");d.generateMipmaps=!1,this.opaqueOnlyComposerContext=new R(d,this.mainComposer,"opaqueOnlyComposerContext"),this.opaqueOnlyComposerContext.keepResult=!0,this.opaqueOnlyComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.opaqueOnlyComposerContext.enablePass(this.mirrorBlendPass,!1),this.opaqueOnlyComposerContext.enablePass(this.mirrorClearDepth,!1),this.opaqueOnlyComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.opaqueOnlyComposerContext.enablePass(this.infPlanePass,!1),this.opaqueOnlyComposerContext.setRenderPlugins(this.forwardPass,!1),this.opaqueOnlyComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.opaqueOnlyComposerContext;break;case"Color":var u=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"nearest");u.generateMipmaps=!1,this.colorComposerContext=new R(u,this.mainComposer,"colorComposerContext"),this.colorComposerContext.keepResult=!0,this.colorComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.colorComposerContext.enablePass(this.mirrorBlendPass,!1),this.colorComposerContext.enablePass(this.mirrorClearDepth,!1),this.colorComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.colorComposerContext.enablePass(this.infPlanePass,!1),this.colorComposerContext.setRenderPlugins(this.forwardPass,!1),this.colorComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.colorComposerContext;break;case"PickingGPUInstancing":(p=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest")).generateMipmaps=!1,this.pickingGPUInstancingComposerContext=new R(p,this.mainComposer,"pickingGPUInstancingComposerContext"),this.setupOneMaterialComposerContext(this.pickingGPUInstancingComposerContext,0,1,!0),this.pickingGPUInstancingComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,r=this.pickingGPUInstancingComposerContext;break;case"PickingGPU":var p;(p=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest")).generateMipmaps=!1,this.pickingGPUComposerContext=new R(p,this.mainComposer,"pickingGPUComposerContext"),this.pickingGPUComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.setupOneMaterialComposerContext(this.pickingGPUComposerContext,0,1,!0),r=this.pickingGPUComposerContext;break;case"auxiliaryViewpoint":let v=null;this.auxiliaryViewpointComposerContext=new R(v,this.mainComposer,"auxiliaryViewpointComposerContext");for(var f,g=this.mainComposer.getAllPasses(),m=0;m<g.length;m++)f=g[m],this.auxiliaryViewpointComposerContext.enablePass(f,!1);this.auxiliaryViewpointComposerContext.setPassClear(this.nozClearPass,!1),this.auxiliaryViewpointComposerContext.setPassClearDepth(this.nozClearPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.forwardPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.nozClearPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.nozPass,!0),r=this.auxiliaryViewpointComposerContext}var v=this.compForwardComposerContext.getPassState(this.zPostPass);this.__enablePassOnAllComposerContexts(this.zPostPass,v.enabled),r&&!this._postProHighlight&&(this._HighlightMobileNonEffect.disableOnComposer(r),this._PreHighlightMobileNonEffect.disableOnComposer(r))},setupOneMaterialComposerContext:function(e,i,r,n){if(e.keepResult=!0,n){e.setPassClear(this.initClearPass,!0,new t.Color(i),r);for(var a=this.mainComposer.getAllPasses(),s=0;s<a.length;s++)(o=a[s]).renderCuttingElements&&e.enablePass(o,!1)}else{var o;for(a=this.mainComposer.getAllPasses(),s=0;s<a.length;s++)o=a[s],e.enablePass(o,!1);e.enablePass(this.forwardPass,!0)}e.enablePass(this.iso_0pass,!0),e.enablePass(this.iso_2pass,!0),e.enablePass(this.iso_3pass,!0),e.enablePass(this.infPlanePass,!1),e.enablePass(this.mirrorBlendPass,!1),e.enablePass(this.mirrorClearDepth,!1),e.enablePass(this.afterMirrorClearDepth,!1),n&&(e.enablePass(this.noEffectRobotClearPass,!0),e.setPassClear(this.noEffectRobotClearPass,!1),e.setPassClearDepth(this.noEffectRobotClearPass,!0),e.enablePass(this.noEffectRobotPass,!0),e.enablePass(this.noEffectRobotOrthoPass,!0),e.enablePass(this.noEffectCanvas2DPass,!0)),n&&(e.enablePass(this.nozClearPass,!0),e.setPassClear(this.nozClearPass,!1),e.setPassClearDepth(this.nozClearPass,!0)),e.enablePass(this.nozPass,!0),n&&(e.enablePass(this.noEffectNozClearPass,!0),e.setPassClear(this.noEffectNozClearPass,!1),e.setPassClearDepth(this.noEffectNozClearPass,!0)),e.enablePass(this.noEffectNozPass,!0),n&&(e.enablePass(this.noEffectAfterHighlightNozClearPass,!0),e.setPassClear(this.noEffectAfterHighlightNozClearPass,!1),e.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,!0)),e.enablePass(this.noEffectAfterHighlightNozPass,!0),e.enablePass(this.dialogPass,!0),n&&(e.enablePass(this.furtiveClearPass,!0),e.setPassClear(this.furtiveClearPass,!1),e.setPassClearDepth(this.furtiveClearPass,!0)),e.enablePass(this.furtivePass,!1),this.NativeOnTopEffect.disablePasses(e),n&&(e.enablePass(this.noEffectCanvas2DClearPass,!0),e.setPassClear(this.noEffectCanvas2DClearPass,!1),e.setPassClearDepth(this.noEffectCanvas2DClearPass,!0)),e.setRenderPlugins(this.forwardPass,!1)},initForwardRender:function(){var e,i=null;(this.initClearPass=new O("initClearPass"),this.infPlanePass=new n(null,null,null,U.facesMask,null,null,"infPlanePass"),this.infPlanePass.lockScene=!0,this.infPlanePass.setCameraName("cameraBackground"),this.zPostPass=new n(null,null,null,null,null,null,"zPostPass"),this.zPostPass.setDisableDepthWrite(!0),this.zPostPass.forcePolygonOffset=t.PolygonOffsetForceStatus.DISABLED,this.zPostPass.disabledByDefault=!0,this.forwardPass=new n(null,null,null,null,null,null,"forwardPass"),this.cssPass=new G(null,"cssPass"),this.backgroundPass=new n(null,null,null,U.facesMask,null,null,"backgroundPass"),this.backgroundPass.idString="background",this.backgroundPass.setMaterialToUse(t.MaterialToUse.ZOnlyMaterial),this.ZOnlyPass=new n(null,null,null,null,null,null,"ZOnlyPass"),this.ZOnlyPass.idString="ZOnly",this.ZOnlyPass.setMaterialToUse(t.MaterialToUse.ZOnlyMaterial),this.lensFlarePass=new V(null,null,"lensFlarePass",new t.LensFlarePlugin,this.renderer),this.forwardPass.setDisableBackFaceCulling(this.disableBackFaceCulling),this.zPostPass.setDisableBackFaceCulling(this.disableBackFaceCulling),this.zPostPass.setStateSortingResultFrom(this.forwardPass,!1),this.iso_0Pass=new n(null,null,null,void 0,void 0,void 0,"iso_0"),this.iso_0Pass.idString="iso_0",this.iso_2Pass=new n(null,null,null,void 0,void 0,void 0,"iso_2"),this.iso_2Pass.idString="iso_2",this.iso_3Pass=new n(null,null,null,void 0,void 0,void 0,"iso_3"),this.iso_3Pass.idString="iso_3",this.mirrorBlendPass=new a(o.blend,void 0,"mirrorBlendPass"),e=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear"),this.useCompositing&&(i=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear")),this.useCompositing||(this.mirrorBlendPass.disabledByDefault=!0,this.mirrorBlendPass.needsSwap=!1,this.mirrorBlendPass.material.defines.POSTPRO=0,this.mirrorBlendPass.material.transparent=!0,this.mirrorBlendPass.material.needsUpdate=!0),this.compForwardComposerContext=new R(i,this.mainComposer,"compForwardComposerContext"),this.compForwardComposerContext.keepResult=!0,this.mainComposer.addPass(this.initClearPass),this.mainComposer.addPass(this.infPlanePass),null!==this.mirrorBlendPass&&(this.mirrorClearDepth=new O("mirrorClearDepth"),this.mirrorClearDepth.clear=!1,this.mirrorClearDepth.setClearDepth(!1),this.afterMirrorClearDepth=new O("afterMirrorClearDepth"),this.mainComposer.addPass(this.mirrorBlendPass),this.mainComposer.addPass(this.afterMirrorClearDepth)),this.passSectionCappingFrontFaces=new n(null,null,null,void 0,!1,!1,"passSectionCappingFrontFaces"),this.passSectionCappingFrontFaces.setRenderCuttingElements(!0),this.passSectionCappingFrontFaces.setEnableStencilTest(!0),this.passSectionCappingFrontFaces.setEnableStencilWrite(!0),this.passSectionCappingFrontFaces.setDisableColorWrite(!0),this.passSectionCappingFrontFaces.setDisableDepthWrite(!0),this.passSectionCappingFrontFaces.setStencilFunc("ALWAYS"),this.passSectionCappingFrontFaces.setStencilOps("INCR_WRAP","DECR_WRAP"),this.passSectionCappingFrontFaces.setDisableBackFaceCulling(!0),this.passSectionCappingFrontFaces.setHideSurfacesAndUnclippedMeshes(!0),this.passSectionCappingFrontFaces.setDisableBackFaceClipPlanes(1),this.passSectionCappingFrontFaces.setRenderPluginsPre(!1),this.passSectionCappingFrontFaces.setRenderPluginsPost(!1),this.passSectionCappingFrontFaces.ignoreNoZ=!0,this.mainComposer.addPass(this.cssPass),this.mainComposer.addPass(this.iso_0Pass),this.mainComposer.addPass(this.forwardPass),this.mainComposer.addPass(this.iso_2Pass),this.mainComposer.addPass(this.iso_3Pass),this.mainComposer.addPass(this.zPostPass),this.mainComposer.addPass(this.backgroundPass),this.mainComposer.addPass(this.ZOnlyPass),this.mainComposer.addPass(this.lensFlarePass),this.mainComposer.addPass(this.passSectionCappingFrontFaces),this.ZOnlyPassCapping=new n(null,null,null,void 0,!1,!1,"ZOnlyPassCapping"),this.ZOnlyPassCapping.setRenderCuttingElements(!0),this.ZOnlyPassCapping.setEnableStencilTest(!0),this.ZOnlyPassCapping.setEnableStencilWrite(!0),this.ZOnlyPassCapping.setDisableColorWrite(!0),this.ZOnlyPassCapping.setDisableDepthWrite(!0),this.ZOnlyPassCapping.setStencilFunc("ALWAYS"),this.ZOnlyPassCapping.setStencilOps("INCR_WRAP","DECR_WRAP"),this.ZOnlyPassCapping.setDisableBackFaceCulling(!0),this.ZOnlyPassCapping.setHideSurfacesAndUnclippedMeshes(!0),this.ZOnlyPassCapping.setDisableBackFaceClipPlanes(1),this.ZOnlyPassCapping.setRenderPluginsPre(!1),this.ZOnlyPassCapping.setRenderPluginsPost(!1),this.ZOnlyPassCapping.ignoreNoZ=!0,this.ZOnlyPassCapping.setMaterialToUse(t.MaterialToUse.ZOnlyMaterial),this.ZOnlyPassCapping.idString="ZOnly",this.mainComposer.addPass(this.ZOnlyPassCapping),this.backgroundPassCapping=new n(null,null,null,void 0,!1,!1,"backgroundPassCapping"),this.backgroundPassCapping.setRenderCuttingElements(!0),this.backgroundPassCapping.setEnableStencilTest(!0),this.backgroundPassCapping.setEnableStencilWrite(!0),this.backgroundPassCapping.setDisableColorWrite(!0),this.backgroundPassCapping.setDisableDepthWrite(!0),this.backgroundPassCapping.setStencilFunc("ALWAYS"),this.backgroundPassCapping.setStencilOps("INCR_WRAP","DECR_WRAP"),this.backgroundPassCapping.setDisableBackFaceCulling(!0),this.backgroundPassCapping.setHideSurfacesAndUnclippedMeshes(!0),this.backgroundPassCapping.setDisableBackFaceClipPlanes(1),this.backgroundPassCapping.setRenderPluginsPre(!1),this.backgroundPassCapping.setRenderPluginsPost(!1),this.backgroundPassCapping.ignoreNoZ=!0,this.backgroundPassCapping.setMaterialToUse(t.MaterialToUse.ZOnlyMaterial),this.backgroundPassCapping.idString="background",this.mainComposer.addPass(this.backgroundPassCapping),this.compForwardComposerContext.enablePass(this.zPostPass,!1),this.compForwardComposerContext.setRenderPlugins(this.forwardPass,!0),this.compForwardComposerContext.enablePass(this.lensFlarePass,!0),this.compForwardComposerContext.enablePass(this.backgroundPass,!0),this.compForwardComposerContext.enablePass(this.ZOnlyPass,!0),this.compForwardComposerContext.enablePass(this.cssPass,!0),this.passMirrorBlur=new a(l.PoissonBlur,void 0,"passMirrorBlur"),this.passMirrorBlur.material.needsUpdate=!0,this.passMirrorBlur.disabledByDefault=!0,this.passMirrorBlur1=new a(l.PoissonBlur,void 0,"passMirrorBlur1"),this.passMirrorBlur1.disabledByDefault=!0,this.passMirrorBlur2=new a(l.PoissonBlur,void 0,"passMirrorBlur2"),this.passMirrorBlur2.disabledByDefault=!0,this.passMirrorBlur3=new a(l.PoissonBlur,void 0,"passMirrorBlur3"),this.passMirrorBlur3.disabledByDefault=!0,this.passMirrorBlur.uniforms.invSize.value.x=1/this.viewportWidth,this.passMirrorBlur.uniforms.invSize.value.y=1/this.viewportHeight,this.passMirrorBlur3.uniforms.invSize=this.passMirrorBlur2.uniforms.invSize=this.passMirrorBlur1.uniforms.invSize=this.passMirrorBlur.uniforms.invSize,this.mainComposer.addPass(this.passMirrorBlur),this.mainComposer.addPass(this.passMirrorBlur1),this.mainComposer.addPass(this.passMirrorBlur2),this.mainComposer.addPass(this.passMirrorBlur3),this.nozClearPass=new O("nozClearPass"),this.nozClearPass.idString="noz",this.nozPass=new n(null,null,null,void 0,void 0,void 0,"nozPass"),this.nozPass.idString="noz",this.mainComposer.addPass(this.nozClearPass),this.mainComposer.addPass(this.nozPass),this.noEffectNozClearPass=new O("noEffectNozClearPass"),this.noEffectNozClearPass.idString="noEffectNoz",this.noEffectNozPass=new n(null,null,null,void 0,void 0,void 0,"noEffectNozPass"),this.noEffectNozPass.idString="noEffectNoz",this.mainComposer.addPass(this.noEffectNozClearPass),this.mainComposer.addPass(this.noEffectNozPass),this._postProHighlight||(this._HighlightMobileNonEffect=new W(this),this._PreHighlightMobileNonEffect=new j(this)),this.noEffectAfterHighlightNozClearPass=new O("noEffectAfterHighlightNozClearPass"),this.noEffectAfterHighlightNozClearPass.idString="afterHighlightNoZ",this.noEffectAfterHighlightNozClearPass.order=60,this.noEffectAfterHighlightNozPass=new n(null,null,null,void 0,void 0,void 0,"noEffectAfterHighlightNozPass"),this.noEffectAfterHighlightNozPass.idString="afterHighlightNoZ",this.noEffectAfterHighlightNozPass.order=61,this.noEffectAfterHighlightNozPass.setCameraName("mainNoJittering"),this.mainComposer.addPass(this.noEffectAfterHighlightNozClearPass),this.mainComposer.addPass(this.noEffectAfterHighlightNozPass),this.dialogPass=new n(null,null,null,void 0,void 0,void 0,"dialogPass"),this.dialogPass.setGSSOCache(!1),this.dialogPass.idString="dialog",this.mainComposer.addPass(this.dialogPass),this.furtiveClearPass=new O("furtiveClearPass"),this.furtiveClearPass.idString="furtive",this.furtivePass=new n(null,null,null,void 0,void 0,void 0,"furtivePass"),this.furtivePass.idString="furtive",this.mainComposer.addPass(this.furtiveClearPass),this.mainComposer.addPass(this.furtivePass),this.noEffectRobotClearPass=new O("noEffectRobotClearPass"),this.noEffectRobotClearPass.order=70,this.noEffectRobotPass=new n(null,null,null,U.facesMask,void 0,void 0,"noEffectRobotPass"),this.noEffectRobotPass.idString="robot",this.noEffectRobotPass.setDisableClippingPlanes(!0),this.noEffectRobotPass.setDisableToneMapping(!0),this.noEffectRobotPass.isRobotPass=!0,this.noEffectRobotPass.setCameraName("connectedRobotCamera"),this.noEffectRobotPass.order=71,this.noEffectRobotPass.setForceMaterialMode(!0),this.noEffectRobotOrthoPass=new n(null,null,null,U.facesMask,void 0,void 0,"noEffectRobotOrthoPass"),this.noEffectRobotOrthoPass.idString="robotOrtho",this.noEffectRobotOrthoPass.setDisableClippingPlanes(!0),this.noEffectRobotOrthoPass.setCameraName("robotCameraOrtho"),this.noEffectRobotOrthoPass.order=72,this.noEffectRobotOrthoPass.isRobotPass=!0,this.noEffectRobotOrthoPass.setDisableToneMapping(!0),this.noEffectRobotOrthoPass.setForceMaterialMode(!0),this.noEffectCanvas2DClearPass=new O("noEffectCanvas2DClearPass"),this.noEffectCanvas2DClearPass.disabledByDefault=!0,this.noEffectCanvas2DClearPass.idString="canvas2D",this.noEffectCanvas2DPass=new n(null,null,null,void 0,void 0,void 0,"noEffectCanvas2DPass"),this.noEffectCanvas2DPass.idString="canvas2D",this.noEffectCanvas2DPass.disabledByDefault=!0,this.noEffectCanvas2DPass.setDisableClippingPlanes(!0),this.noEffectCanvas2DPass.order=1e5,this.noEffectCanvas2DPass.setDisableToneMapping(!0),this.noEffectCanvas2DPass.setCameraName("mainNoJittering"),this.mainComposer.addPass(this.noEffectRobotClearPass),this.mainComposer.addPass(this.noEffectRobotPass),this.mainComposer.addPass(this.noEffectRobotOrthoPass),this.mainComposer.addPass(this.noEffectCanvas2DClearPass),this.mainComposer.addPass(this.noEffectCanvas2DPass),this.compForwardComposerContext.enablePass(this.noEffectCanvas2DPass,!0),this.compForwardComposerContext.enablePass(this.noEffectCanvas2DClearPass,!0),this.compMirrorComposerContext=new R(e,this.mainComposer,"compMirrorComposerContext"),this.compMirrorComposerContext.linkToShaderPassUniform(this.mirrorBlendPass,this.mirrorBlendPass.uniforms.tReflectedScene),this.compMirrorComposerContext.enablePass(this.mirrorBlendPass,!1),this.compMirrorComposerContext.enablePass(this.mirrorClearDepth,!1),this.compMirrorComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.compMirrorComposerContext.enableRenderCuttingElementsPasses(!0),this.compMirrorComposerContext.enablePass(this.infPlanePass,!1),this.compMirrorComposerContext.enablePass(this.noEffectRobotClearPass,!1),this.compMirrorComposerContext.enablePass(this.noEffectRobotOrthoPass,!1),this.compMirrorComposerContext.setPassClear(this.noEffectRobotClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.noEffectRobotClearPass,!0),this.compMirrorComposerContext.enablePass(this.nozPass,!1),this.compMirrorComposerContext.setPassClear(this.nozClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.nozClearPass,!0),this.compMirrorComposerContext.enablePass(this.noEffectNozPass,!1),this.compMirrorComposerContext.setPassClear(this.noEffectNozClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.noEffectNozClearPass,!0),this.compMirrorComposerContext.enablePass(this.noEffectAfterHighlightNozPass,!1),this.compMirrorComposerContext.setPassClear(this.noEffectAfterHighlightNozClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,!0),this.compMirrorComposerContext.enablePass(this.dialogPass,!1),this.compMirrorComposerContext.enablePass(this.furtivePass,!1),this.compMirrorComposerContext.setPassClear(this.furtiveClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.furtiveClearPass,!0),this.compMirrorComposerContext.setCameraName("mirrorCamera"),this.compMirrorComposerContext.setBeforeRenderCB(function(e){e.composer.renderer.initWebGLObjects(e.composer.renderScene);var t,i,r=e.composer.renderScene.getAllWebGLObjects(e.composer.renderer.currentFrameIndex);for(i=0;i<r.length;i++)null!==r[i]&&(t=r[i].object).disableMirror&&t.visible&&(t.visible=!1,t.disableMirror=2)}),this.compMirrorComposerContext.setAfterRenderCB(function(e){var t,i,r=e.composer.renderScene.getAllWebGLObjects(e.composer.renderer.currentFrameIndex);for(i=0;i<r.length;i++)null!==r[i]&&2===(t=r[i].object).disableMirror&&(t.visible=!0,t.disableMirror=1)}),this.useCompositing)&&(new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint").generateMipmaps=!1,this.compositeClearPass=new O("compositeClearPass"),this.compositeClearPass.invertTarget=!0,this.canvas2DPass=new n(null,null,null,void 0,void 0,void 0,"canvas2DPass"),this.canvas2DPass.order=1100,this.canvas2DPass.idString="canvas2D",this.canvas2DPass.setDisableToneMapping(!0),this.canvas2DPass.setDisableClippingPlanes(!0),this.compositeClearPass.order=5,this.setEffect("ToneMapping",!0),this.ToneMappingEffect.setBrightness(this.brightness),this.ToneMappingEffect.setToneMapping(this.tonemapping));this.setEffect("NativeOnTop",!0),this.compForwardComposerContext.setPassClear(this.noEffectRobotClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectRobotClearPass,!0),this.compForwardComposerContext.setPassClear(this.nozClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.nozClearPass,!0),this.compForwardComposerContext.setPassClear(this.noEffectNozClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectNozClearPass,!0),this.compForwardComposerContext.setPassClear(this.noEffectAfterHighlightNozClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,!0),this.compForwardComposerContext.setPassClear(this.furtiveClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.furtiveClearPass,!0),this.compForwardComposerContext.setPassClear(this.noEffectCanvas2DClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectCanvas2DClearPass,!0)},resetClippingScene:function(){this.clippingScene=null},__enablePassOnAllComposerContexts:function(e,t){this.compForwardComposerContext&&this.compForwardComposerContext.enablePass(e,t),this.compMirrorComposerContext&&this.compMirrorComposerContext.enablePass(e,t),this.shadowComposerContext&&this.shadowComposerContext.enablePass(e,t),this.depthComposerContext&&this.depthComposerContext.enablePass(e,t),this.normalComposerContext&&this.normalComposerContext.enablePass(e,t),this.normalDepthIoRRoughnessComposerContext&&this.normalDepthIoRRoughnessComposerContext.enablePass(e,t),this.normalDepthComposerContext&&this.normalDepthComposerContext.enablePass(e,t),this.outlineDepthComposerContext&&this.outlineDepthComposerContext.enablePass(e,t),this.mirrorOutlineDepthComposerContext&&this.mirrorOutlineDepthComposerContext.enablePass(e,t),this.occlusionDepthComposerContext&&this.occlusionDepthComposerContext.enablePass(e,t),this.highlightDepthComposerContext&&this.highlightDepthComposerContext.enablePass(e,t),this.opaqueOnlyComposerContext&&this.opaqueOnlyComposerContext.enablePass(e,t),this.colorComposerContext&&this.colorComposerContext.enablePass(e,t),this.pickingGPUComposerContext&&this.pickingGPUComposerContext.enablePass(e,t),this.pickingGPUInstancingComposerContext&&this.pickingGPUInstancingComposerContext.enablePass(e,t)},_enableZPrePass:function(e){this.forwardPass&&(this.compForwardComposerContext.getPassState(this.zPostPass).enabled!==e&&(e?(this.forwardPass.setDisableColorWrite(!0),this.forwardPass.forcePolygonOffset=t.PolygonOffsetForceStatus.ENABLED,this.__enablePassOnAllComposerContexts(this.zPostPass,!0)):(this.forwardPass.forcePolygonOffset=t.PolygonOffsetForceStatus.DEFAULT,this.forwardPass.setDisableColorWrite(!1),this.__enablePassOnAllComposerContexts(this.zPostPass,!1))))},dispose:function(){this.compForwardComposerContext&&(this.compForwardComposerContext.dispose(),this.compForwardComposerContext=null),this.compMirrorComposerContext&&(this.compMirrorComposerContext.dispose(),this.compMirrorComposerContext=null),this.shadowComposerContext&&(this.shadowComposerContext.dispose(),this.shadowComposerContext=null),this.depthComposerContext&&(this.depthComposerContext.dispose(),this.depthComposerContext=null),this.normalComposerContext&&(this.normalComposerContext.dispose(),this.normalComposerContext=null),this.normalDepthIoRRoughnessComposerContext&&(this.normalDepthIoRRoughnessComposerContext.dispose(),this.normalDepthIoRRoughnessComposerContext=null),this.normalDepthComposerContext&&(this.normalDepthComposerContext.dispose(),this.normalDepthComposerContext=null),this.outlineDepthComposerContext&&(this.outlineDepthComposerContext.dispose(),this.outlineDepthComposerContext=null),this.mirrorOutlineDepthComposerContext&&(this.mirrorOutlineDepthComposerContext.dispose(),this.mirrorOutlineDepthComposerContext=null),this.occlusionDepthComposerContext&&(this.occlusionDepthComposerContext.dispose(),this.occlusionDepthComposerContext=null),this.highlightDepthComposerContext&&(this.highlightDepthComposerContext.dispose(),this.highlightDepthComposerContext=null),this.opaqueOnlyComposerContext&&(this.opaqueOnlyComposerContext.dispose(),this.opaqueOnlyComposerContext=null),this.colorComposerContext&&(this.colorComposerContext.dispose(),this.colorComposerContext=null),this.pickingGPUComposerContext&&(this.pickingGPUComposerContext.dispose(),this.pickingGPUComposerContext=null),this.pickingGPUInstancingComposerContext&&(this.pickingGPUInstancingComposerContext.dispose(),this.pickingGPUInstancingComposerContext=null),this.lensFlarePass&&(this.lensFlarePass.dispose(),this.lensFlarePass=null);for(var e=0;e<this.allEffects.length;e++)this.allEffects[e]&&this.allEffects[e].dispose&&this.allEffects[e].dispose();for(e=0;e<this.customEffects.length;e++)this.customEffects[e]&&this.customEffects[e].dispose&&this.customEffects[e].dispose();for(var t in this.renderer.fixedSizeArrayPool.dispose(),this.allEffects=null,this.customEffects=null,this.mainComposer.dispose(),this.renderer.dispose(),this)this.hasOwnProperty(t)&&(this[t]=null)},isDeviceCompatibleWithSSR:function(){return this.renderer.supportsFloatTextures()},isDeviceCompatibleWithSSAO:function(){return this.renderer.supportsFloatTextures()||this.renderer.supportsHalfFloatTextures()},isDeviceCompatibleWithOIT:function(){return this.renderer.supportsFloatTextures()||this.renderer.supportsHalfFloatTextures()},setDisableBackFaceCulling:function(e){this.disableBackFaceCulling=e,this.forwardPass&&(this.forwardPass.setDisableBackFaceCulling(this.disableBackFaceCulling),this.zPostPass.setDisableBackFaceCulling(this.disableBackFaceCulling))},clearCameraSystemData:function(){this.superFinalComposer=null},resizeNPOTTexture:function(){this.NoPowerOfTwoEffect||this.initEffect("noPowerOfTwoEffect");for(let i of this.renderer._texturesToResize){var e=new t.NonPowerOfTwoTexture(i,i.mipmaps);this.NoPowerOfTwoEffect.setTextures(e),this.NoPowerOfTwoEffect.copyToDataTexture(this.gl,i),i.format=1021,i.needsUpdate=!0}this.renderer._texturesToResize.clear(),this.NoPowerOfTwoEffect.dispose()},recompileAllShaders:function(e){this.renderer.recompileAllShaders(e)},updateClippingScene:function(e){var i,r=e.getBoundingSphere(),n=new t.Vector3;for(i=0;i<this.renderer.clipPlanes.length;i++){var a=this.renderer.clipPlanes[i];a.projectPoint(r.center,n);var s=this.clippingScene.children[i];s.matrixAutoUpdate=!1,s.matrixWorldNeedsUpdate=!1;var o=a.normal.clone().multiplyScalar(-1),l=(a.constant,new t.Vector3),h=new t.Vector3(1,0,0);Math.abs(o.y)<=.01&&Math.abs(o.z)<=.01&&(h=new t.Vector3(0,1,0)),l.crossVectors(o,h),l.normalize(),h.crossVectors(o,l),s.matrixWorld.set(1*l.x,1*h.x,1*o.x,n.x,1*l.y,1*h.y,1*o.y,n.y,1*l.z,1*h.z,1*o.z,n.z,0,0,0,1)}},setSectionCappingMaterial:function(e,i){this.resetGSSOCache();var r,n=this.renderer;e.clippingContext||(e.clippingContext={}),e.clippingContext[n.id]||(e.clippingContext[n.id]={useCount:0}),r=e.clippingContext[n.id],i||0===i?i instanceof t.Material?r.sectionCappingMaterial=i.clone():r.sectionCappingMaterial=new t.MeshBasicMaterial({color:new t.Color(i)}):(r.sectionCappingMaterial=t.MaterialUtils.createShinyFaceMaterial({color:new t.Color(0)}),r.sectionCappingMaterial.clipPlaneUseModelMaterial=!0),this.resetClippingScene()},requestClippingUpdate:function(){this.needClippingUpdate=!0},updateClippingGlobals:function(e,i,r,n,a){if(e._needClippingUpdate){var s=r.renderer,o=i.getAllWebGLObjects(s.currentFrameIndex);if(o){e._needClippingUpdate=!1;var l,h,c,d,u,p,f=null,g=0,m=!1,v=0,y=0,S=0;if(n.length>0)for(f=new Set,l=0;l<n.length;l++)f.add(n[l]);for(l=0;l<o.length;l++)if(o[l]&&(h=o[l].object._occurrence)){if(c=h.clippingContext){for(d=0;d<c.planes.length;d++)null===f&&(f=new Set),f.add(c.planes[d]);c._clipPolyLine&&(c._clipPolyLine.updateBoundingSphere(e.getBoundingSphere()),(p=c._clipPolyLine.getMaxSize())>g&&(g=p),c._clipPolyLine.getCount()>S&&(S=c._clipPolyLine.getCount())),c._getScissorPolyLineSize()>v&&(v=c._getScissorPolyLineSize()),c._getScissorNbPolygons()>y&&(y=c._getScissorNbPolygons()),c.cylinder&&(m=!0)}h.occurrenceRenderingOverride&&((u=h.occurrenceRenderingOverride.clipPolyLine)&&(u.updateBoundingSphere(e.getBoundingSphere()),(p=u.getMaxSize())>g&&(g=p),u.getCount()>S&&(S=u.getCount())),h.occurrenceRenderingOverride.clipCylinder&&(m=!0))}var _=!1;s.maxPolyLineSize===g&&s.useClippingCylinder===m&&s.maxScissorSize===v&&s.maxNbScissor===y&&s.maxNbPolyLine===S||(s.maxPolyLineSize=g,s.maxScissorSize=v,s.maxNbScissor=y,s.maxNbPolyLine=S,s.useClippingCylinder=m,_=!0);var x=s.clipPlanes,b=f?f.size:0,w=!1;if(b!==x.length)w=!0;else if(b>0)for(l=0;l<b&&!w;l++)f.has(x[l])||(w=!0);if(w){var M=s.clipPlanes,C=[];s.clipPlanes=C,f&&f.forEach(function(e){e.upVector||(e.upVector=new t.Vector3(0,0,1)),e.clippingContext||(e.clippingContext={}),e.clippingContext[s.id]||(e.clippingContext[s.id]={}),e.clippingContext[s.id].sectionCappingMaterial||r.setSectionCappingMaterial(e,null),e.clippingContext[s.id].clippingPlaneAdded=!0,C.push(e)}),0!==M.length&&0!==C.length||(_=!0),a&&(a.updateShadowMap=!0),r.resetClippingScene()}_&&s.recompileAllShaders(null)}}},updateSectionCappingScene:function(e,r){if(!this.clippingScene){this.clippingScene=new t.Scene,this.clippingScene.autoUpdateScene=!1,this.clippingScene.matrixWorldNeedsUpdate=!1,this.clippingScene.matrixAutoUpdate=!1;var n,a=e.getBoundingSphere(),s=new t.PlaneGeometry(50*a.radius,50*a.radius);for(i=0;i<this.renderer.clipPlanes.length;i++){var o=(n=this.renderer.clipPlanes[i].clippingContext[this.renderer.id]).sectionCappingMaterial;o&&((o=o.clone()).clipPlaneIndex=i+1);var l=new t.Mesh(s,o||t.MaterialUtils.createShinyFaceMaterial({color:"purple"}));l.clippingPlane=this.renderer.clipPlanes[i],n.clippingMeshIndex=i+1,this.clippingScene.add(l)}for(i=0;i<r.children.length;i++){var h=r.children[i];h instanceof t.Light&&this.clippingScene.add(h.clone())}}var c,d=this.mainComposer.getAllPasses();for(i=0;i<d.length;i++)(c=d[i]).renderCuttingElements&&c.setCuttingScene(this.clippingScene);this.updateClippingScene(e)},getQuarterWidth:function(){return Math.ceil(.25*this.viewportWidth)},getQuarterHeight:function(){return Math.ceil(.25*this.viewportHeight)}});return Object.defineProperty(K.prototype,"gpuPickingTolerance",{get:function(){return this.renderer._gpuPickingTolerance},set:function(e){this.renderer._gpuPickingTolerance=e,this.smallTargetPicking&&(this.pickingGPUComposerContext&&(this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.pickingGPUComposerContext.needsUpdate=!0),this.normalComposerContext&&(this.normalComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.normalComposerContext.needsUpdate=!0),this.depthComposerContext&&(this.depthComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.depthComposerContext.needsUpdate=!0))}}),Object.defineProperty(K.prototype,"smallTargetPicking",{get:function(){return this.renderer._smallTargetPicking},set:function(e){this.renderer._smallTargetPicking=e,e?(this.pickingGPUComposerContext&&this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.normalComposerContext&&this.normalComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.depthComposerContext&&this.depthComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)):(this.pickingGPUComposerContext&&this.pickingGPUComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.normalComposerContext&&this.normalComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.depthComposerContext&&this.depthComposerContext.setSize(this.viewportWidth,this.viewportHeight))}}),K.testMode=!1,K}),define("Visualization/WebGLV6Renderer",["DS/Visualization/WebGLV6Renderer","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/WebGLV6Renderer"),e}),define("DS/Visualization/ScissorPolyLineData",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";function t(e){this.type="polyline",this.polyLines=[],this.lastFrameIndex=-1,this.lastCamera=null,this.texture=null,e&&this.polyLines.push(new r(e))}function r(t,r){for(this.nbPolygon=t.nbPolygon,this.nbVertices=t.nbVertices,this.vertices=t.vertices,this.point=t.point,this.dirX=t.dirX,this.dirY=t.dirY,this.matrix=r,this.points3D=[],i=0;i<this.vertices.length;i+=2){var n=this.vertices[i],a=this.vertices[i+1],s=this.dirX,o=this.dirY,l=this.point,h=new e.Vector3(l.x+n*s.x+a*o.x,l.y+n*s.y+a*o.y,l.z+n*s.z+a*o.z);r&&h.applyMatrix4(r),this.points3D.push(h)}}return t.prototype.getNbVertices=function(){var e,t,i,r=[];for(e=0;e<this.polyLines.length;e++)for(i=this.polyLines[e],t=0;t<i.nbVertices.length;t++)r.push(i.nbVertices[t]);return r},t.prototype.getVerticesCount=function(){var e,t,i,r=0;for(e=0;e<this.polyLines.length;e++)for(i=this.polyLines[e],t=0;t<i.nbVertices.length;t++)r+=i.nbVertices[t];return r},t.prototype.getForOccurrenceOverride=function(e){if(e){var i,r,n=new t;for(i=0;i<this.polyLines.length;i++)r=this.polyLines[i].matrix||e,n.polyLines.push(this.polyLines[i].getForOccurrenceOverride(r));return n}return this},t.prototype.updateTexture=function(t,i){if(t!==this.lastCamera||this.lastFrameIndex!==i||!this.texture){this.lastCamera=t,this.frameIndex=i;var r,n=0;for(r=0;r<this.polyLines.length;r++)n+=this.polyLines[r].points3D.length;var a=new Float32Array(4*n),s=new e.Matrix4;new e.Vector3;s.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);var o,l=0;for(r=0;r<this.polyLines.length;r++)(o=this.polyLines[r]).fillBuffer(s,l,a),l+=4*o.points3D.length;var h=new e.DataTexture(a,n,1,e.RGBAFormat,e.FloatType,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter);h.needsUpdate=!0,this.texture&&this.texture.dispose(),this.texture=h}},t.prototype.getNbPolygon=function(){var e,t=0;for(e=0;e<this.polyLines.length;e++)t+=this.polyLines[e].nbPolygon;return t},t.merge=function(e,i){var r=null;return e&&i&&"polyline"===e.type&&"polyline"===i.type?(r=new t(null)).polyLines=e.polyLines.concat(i.polyLines):r=e||i,r},r.prototype.getForOccurrenceOverride=function(e){return e?new r({nbPolygon:this.nbPolygon,nbVertices:this.nbVertices,vertices:this.vertices,point:this.point,dirX:this.dirX,dirY:this.dirY},e):this},r.prototype.fillBuffer=function(t,i,r){var n,a,s=new e.Vector4;for(n=0;n<this.points3D.length;n++)a=this.points3D[n],s.set(a.x,a.y,a.z,1),s.applyMatrix4(t),r[i+4*n]=s.x/s.w,r[i+4*n+1]=s.y/s.w,r[i+4*n+2]=0,r[i+4*n+3]=1},t}),define("DS/Visualization/PLMMaterialLoader",["DS/Visualization/PLMMaterialConnectionFactory"],function(e){"use strict";var t=function(){this.toLoadMaterialConnectionArray=[],this.token_toLoadMaterialConnectionArray=null,this.materialConnectionToPLMMaterialDataMap=new Map};return t.prototype.loadMaterials=function(e,t){var i,r,n=this.toLoadMaterialConnectionArray;for(i=0;i<e.length;i++)r=e[i],this.materialConnectionToPLMMaterialDataMap.set(r,t),r.isComplete()&&n.push(r);n.length>0&&null===this.token_toLoadMaterialConnectionArray&&(this.token_toLoadMaterialConnectionArray=setTimeout(this.loadMaterials_internal.bind(this),0))},t.prototype.getPathElementFromIdPath=function(t){var i,r,n=[];for(i=0;i<t.length;i++)r=e.loadAppearanceCB(t[i]),n.push(r);return new PathElement(n)},t.prototype.loadMaterials_internal=function(){var t;if(null!==this.token_toLoadMaterialConnectionArray){for(t=0;t<this.toLoadMaterialConnectionArray.length;t++)e.loadAppearanceCB(this.toLoadMaterialConnectionArray[t],this.onMaterialLoadedCB.bind(this),this.onMaterialErrorCB.bind(this));this.toLoadMaterialConnectionArray=[],this.token_toLoadMaterialConnectionArray=null}},t.prototype.onMaterialLoadedCB=function(e,t){this.materialConnectionToPLMMaterialDataMap.get(e)._applyMaterialApplication(e,t)},t.prototype.onMaterialErrorCB=function(e,t){},t}),define("DS/Visualization/RenderStyle",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/RenderMode"],function(e,t,i){"use strict";var r=e.extend({init:function(e){if(e=e||{},this._renderMode=new i,this._renderMode._setMask(t.ShowAllRenderLineMode|t.ShowAllFaces),e.hasOwnProperty("faceMode")){this._materialMode=!1;var n=e.faceMode;"MATERIAL"!==n&&"GAS"!==n||(this._materialMode="MATERIAL"===n,n="COLOR"),this._faceMode=n?r.FaceModes[n]:r.FaceModes.unset}else this._materialMode=!0,this._faceMode=r.FaceModes.COLOR;this._materialMode=e.hasOwnProperty("materialMode")?!!e.materialMode:this._materialMode,this._combineRenderModeValue=e.combineRenderMode?r.CombineRenderMode[e.combineRenderMode]:r.CombineRenderMode.REPLACE,this._locked=!1},setOutlineWidth:function(e){this._renderMode.setOutlineWidth(e)},setHalfVisibleSmoothEdges:function(e){this._renderMode.setHalfVisibleSmoothEdges(e)},setHiddenEdges:function(e){this._renderMode.setHiddenEdges(e)},setRenderMode:function(e,t){return!this._locked&&(this._renderMode.setRenderMode(e,t),!0)},setFaceMode:function(e){if(this._locked)return!1;var t=e;return"MATERIAL"!==t&&"GAS"!==t||(this._materialMode="MATERIAL"===e,t="COLOR"),this._faceMode=r.FaceModes[t],!0},setMaterialMode:function(e){return!this._locked&&(this._materialMode=!!e,!0)},clone:function(){var e=new r;return e._renderMode=this._renderMode.clone(),e._faceMode=this._faceMode,e._materialMode=this._materialMode,e._combineRenderModeValue=this._combineRenderModeValue,e},dumpToJSON:function(){return{version:1,renderModeMask:this._renderMode.getMask(),faceMode:this._faceMode,materialMode:this._materialMode,combineMode:this._combineRenderModeValue,outlineWidth:this._renderMode._outlineWidth}},_lock:function(){this._locked=!0},_combineFaceMode:function(e){return 0!==this._faceMode?{face:this._faceMode,material:this._faceMode===r.FaceModes.COLOR&&this._materialMode}:e},_combineRenderMode:function(e,t){var i,r;switch(this._combineRenderModeValue){case 0:return t||e;case 1:return this._renderMode;case 2:return e?(r=(i=this._renderMode.clone()).getMask()|e.getMask(),i._setMask(r),i):this._renderMode;case 3:return e?(r=(i=this._renderMode.clone()).getMask()&e.getMask(),i._setMask(r),i):this._renderMode}return null},_displayNothingRenderMode:function(){this._renderMode._displayNothing()}});return r.FaceModes={unset:0,COLOR:1,ZONLY:2,BACKGROUND:3},r.CombineRenderMode={IGNORE:0,REPLACE:1,OR:2,AND:3},r.compareDumpJSON=function(e,t){return e.renderModeMask===t.renderModeMask&&e.faceMode===t.faceMode&&e.materialMode===t.materialMode&&e.combineMode===t.combineMode&&e.outlineWidth===t.outlineWidth},t.RenderStyle=r,r}),define("DS/Visualization/ClippingContext",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/SessionNodesWithSectionProfile","DS/Visualization/ScissorPolyLineData","DS/Visualization/ClippingPolyLineData"],function(e,t,i,r,n){"use strict";var a=0,s=e.extend({init:function(e){this.id=a++,this.planes=e||[],this.planesParams=null,this.cylinder=null,this.excludeFromClippingPlanes=[],this.clippingSettings=null,this.sectionCappingMaterials=null,this.sectionLinesProperties=null,this._scissor=null,this._enableClippingProfile=0,this._clipPolyLine=null,this._uncut=!1,window.sealWebVisuObjects&&Object.seal(this)},setPlanes:function(e,t){var i;if(this.planes=e||[],this._planesParams=null,t)if(1===t.length&&"all"===t[0])this.planes=[];else for(i=this.planes.length-1;i>=0;i--)t.indexOf(this.planes[i])>=0&&this.planes.splice(i,1)},setExcludeFromClippingPlanes:function(e){this.excludeFromClippingPlanes=e||[]},setUncut:function(e){this._uncut=!!e},setFrontAndBackOpacity:function(e,t){this.clippingSettings=null===e||null===t?null:{frontOpacity:e,backOpacity:t}},getFrontOpacity:function(){return this.frontOpacity},getBackOpacity:function(){return this.backOpacity},setSectionCappingMaterial:function(e,t){this.sectionCappingMaterials||(this.sectionCappingMaterials=[],this.sectionCappingMaterials.defaultMaterial=null);var i=t||null;if(i){var r=0,n=-1;for(r=0;-1===n&&r<this.sectionCappingMaterials.length;r++)this.sectionCappingMaterials[r].clippingPlane===i&&(n=r);n>=0?this.sectionCappingMaterials[n].material=e:this.sectionCappingMaterials.push({clippingPlane:i,material:e})}else this.sectionCappingMaterials.defaultMaterial=e},setSectionLinesProperties:function(e){this.sectionLinesProperties=e?{color:void 0===e.color?null:e.color,width:e.width}:null},getSectionCappingMaterial:function(e){if(this.sectionCappingMaterials){if(!e)return this.sectionCappingMaterials.defaultMaterial;var t;for(t=0;t<this.sectionCappingMaterials.length;t++)if(this.sectionCappingMaterials[t].clippingPlane===e)return this.sectionCappingMaterials[t].material}return null},removeSectionCappingMaterial:function(e){if(this.sectionCappingMaterials){var t=e||null,i=0;for(i=0;i<this.sectionCappingMaterials.length;i++)this.sectionCappingMaterials[i].clippingPlane===t&&this.sectionCappingMaterials.splice(i,1);this.sectionCappingMaterials.length||(this.sectionCappingMaterials=null)}},clone:function(){var e,t,i=new s(this.planes);if(i._planesParams=this._planesParams,i.cylinder=this.cylinder,i._scissor=this._scissor,i._clipPolyLine=this._clipPolyLine,i._enableClippingProfile=this._enableClippingProfile,i._uncut=this._uncut,i.excludeFromClippingPlanes=[].concat(this.excludeFromClippingPlanes),this.clippingSettings&&(i.clippingSettings={frontOpacity:this.clippingSettings.frontOpacity,backOpacity:this.clippingSettings.backOpacity}),this.sectionCappingMaterials)for(i.sectionCappingMaterials=[],i.sectionCappingMaterials.defaultMaterial=this.sectionCappingMaterials.defaultMaterial,e=0;e<this.sectionCappingMaterials.length;e++)t=this.sectionCappingMaterials[e],i.sectionCappingMaterials.push({clippingPlane:t.clippingPlane,material:t.material});return i.sectionLinesProperties=this.sectionLinesProperties,i},addPlane:function(e){return this.planes.indexOf(e)<0&&(this.planes.push(e),!0)},removePlane:function(e){var t=this.planes.indexOf(e);return t>=0&&(this.planes.splice(t,1),this._planesParams&&t<=this._planesParams.length-1&&this._planesParams.splice(t,1),!0)},isPointVisible:function(e){var t,i,r=this.clippingSettings&&this.clippingSettings.frontOpacity<.5;for(t=0;t<this.planes.length;t++)if(i=this.planes[t],this.excludeFromClippingPlanes.indexOf(i)<0&&i.distanceToPoint(e)<0)return!!r;return!r},setClippingProfile:function(e){this._clipPolyLine=e?new n(e):null},setEnableClippingProfile:function(e){this._enableClippingProfile="on"===e?1:"off"===e?-1:0},isClippingProfileEnabled:function(){return this._enableClippingProfile>=0},setScissorBox:function(e,t){this._scissor=e?{type:"box",data:new o(t)}:null},setScissorPolyLine:function(e,t){this._scissor=e?new r(t):null},_getScissorPolyLineSize:function(){return this._scissor&&"polyline"===this._scissor.type?this._scissor.getVerticesCount():0},_getScissorNbPolygons:function(){return this._scissor&&"polyline"===this._scissor.type?this._scissor.getNbPolygon():0},setScissorCircle:function(e,t){this._scissor=e?{type:"circle",x:t.x,y:t.y,radius:t.radius}:null},setPlaneParams:function(e,t){var i=this.planes.indexOf(e);i>=0&&(!this._planesParams&&t&&(this._planesParams=[]),this._planesParams&&(this._planesParams[i]=t?new l(t):null))},_mergeWithParent:function(e){if(!e)return this;var t=new s;t._enableClippingProfile=0!==this._enableClippingProfile?this._enableClippingProfile:e._enableClippingProfile,this._uncut||(t._clipPolyLine=n.merge(e._clipPolyLine,this._clipPolyLine)),t.cylinder=this._uncut?null:this.cylinder||e.cylinder,this._uncut||(t._scissor=r.merge(e._scissor,this._scissor));var i,a,o,l,h=[].concat(this.planes);if(!this._uncut)for(i=0;i<e.planes.length;i++)h.indexOf(e.planes[i])<0&&h.push(e.planes[i]);if(t.setPlanes(h,this.excludeFromClippingPlanes),this._planesParams||e._planesParams)for(i=0;i<h.length;i++)a=null,o=h[i],(l=this.planes.indexOf(o))>=0?a=this._getPlaneParams(l):(l=e.planes.indexOf(o))>=0&&(a=this._getPlaneParams(l)),this.setPlaneParams(o,a);t.clippingSettings=this.clippingSettings||e.clippingSettings;var c=null;if(this.sectionCappingMaterials&&e.sectionCappingMaterials){(c=[].concat(this.sectionCappingMaterials||[])).defaultMaterials=this.sectionCappingMaterials.defaultMaterial||e.sectionCappingMaterials.defaultMaterial;var d,u,p=e.sectionCappingMaterials||[];for(i=0;i<p.length;i++){for(u=!1,d=0;d<c.length&&!u;d++)c[d].clippingPlane===p[i].clippingPlane&&(u=!0);u||c.push(p[i])}}else c=this.sectionCappingMaterials||e.sectionCappingMaterials;return t.sectionCappingMaterials=c,t},_getPlaneParams:function(e){return this._planesParams&&this._planesParams[e]||null},_getPlaneParamsFromPlane:function(e){if(this._planesParams){var t=this.planes.indexOf(e);if(t>=0)return this._planesParams[t]||null;console.warn("unknown plane!")}return null},_hasPlaneCapping:function(e){var t=this._getPlaneParamsFromPlane(e);return!t||t.capping},_hasPlaneSectionLine:function(e){var t=this._getPlaneParamsFromPlane(e);return!t||t.sectionLines},_getSectionLinesArray:function(){if(this._planesParams){var e,t=[];for(e=0;e<this.planes.length;e++)!this._planesParams[e]||this._planesParams[e].sectionLines?t.push(!0):t.push(!1);return t}return null},dbgDumpClippingContext:function(){return{planes:this.planes,excludeFromClippingPlanes:this.excludeFromClippingPlanes,clipPolyLine:this._clipPolyLine?this._clipPolyLine.dbgDump():null,enableClippingProfile:this._enableClippingProfile}},setAntiPlanes:function(){this.setExcludeFromClippingPlanes.apply(this,arguments)}});function o(e){this.box=new t.Box3(new t.Vector3(e.box.min.x,e.box.min.y,0),new t.Vector3(e.box.max.x,e.box.max.y,0)),this.clipX=0,this.clipY=0,this.clipWidth=0,this.clipHeight=0,this.frame=-1}function l(e){this.capping=void 0===e.capping||!!e.capping,this.sectionLines=void 0===e.sectionLines||!!e.sectionLines}return o.prototype.projectPoint=function(e,t,i,r,n){var a=i.clone();return e.projectVector(a,t),a.x=.5*r*(a.x+1),a.y=.5*n*(a.y+1),a},o.prototype.updateClipRect=function(e,i,r,n){if(i!==this.frame){this.frame=i;var a=new t.Projector,s=this.projectPoint(a,e,this.box.min,r,n),o=this.projectPoint(a,e,this.box.max,r,n);this.clipX0=Math.round(s.x),this.clipY0=Math.round(o.y),this.clipX1=Math.round(o.x),this.clipY1=Math.round(s.y)}},s}),define("DS/Visualization/PLMMaterialData",["DS/Visualization/StaticOverrideSet","DS/Visualization/PLMMaterialLoader"],function(e,t){"use strict";var i=new t,r=function(e){this._node=e,this._materialConnections=[],this._staticOverrideSet=null};return r.prototype._getStaticOverrideSet=function(){var t=this._staticOverrideSet;return null===t&&(t=new e(this._node),this._staticOverrideSet=t),t},r.prototype.addMaterialConnection=function(e){this._materialConnections.push(e),i.loadMaterials([e],this)},r.prototype._applyMaterialApplication=function(e,t){t=t.clone();var i=this._getStaticOverrideSet(),r=e.computeLayer(this);t._layer=r,i.addStaticOverride(e.pathElement,t),this._node._requestStaticOverridesUpdate()},r.prototype.getNbConnections=function(){return this._materialConnections.length},r}),define("DS/Visualization/Node3D",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/OccurrencePath","DS/Visualization/PathElement","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/Visualization/OccurrenceRenderingOverride","DS/Visualization/SessionNodesWithSectionProfile","DS/Visualization/ClippingContext","DS/Visualization/RenderMode","DS/Visualization/RenderStyle","DS/Visualization/MaterialApplication","DS/Visualization/PLMMaterialData","DS/Visualization/KDTree","DS/Visualization/ClippingPolyLineData"],function(e,t,i,r,n,a,s,o,l,h,c,d,u,p,f,g){"use strict";var m=i.NoOccurrences,v=5,y=0,S=new i.Matrix4,_=i.__visibleInCurrentSpace;const x=i._VisuFilterType,b=new Set;b.add(x.GAS_INHERIT);var w=function(e,t){return this.node=void 0!==e?e:null,this.parent=null,this.depth=0,this.children=[],this.occBooleanAttr=0,this.matrix=null,this.material=null,this.matApp=null,this.matAppOverride=null,this.gas=null,this._setVisible(!0),this._setVisibilityFree(!1),this._setDepthMode(!0),this._setAdvancedPriority(!1),this._setPickable(!0),this.setIsInBackground(!0),this._setIsAlwaysInForeground(!1),this.setNoPickThrough(!0),this.scene3js=void 0!==t?t:null,this.renderable=null,this.renderMode=null,this.layerFilter=null,this.faceMode=null,this._setNeedBEUpdate(!0),this.passes=null,this.forcePasses=null,this.forceGAS=null,this.pickingPriorityID=null,this.clippingContext=null,this.__rdo_visited=0,this._filters=null,this.__overrideData=null,this._manipulators={},this._setNeedOverridesUpdate(!1),this._setDescendantNeedsOverridesUpdate(!1),this._substituteMaterials=null,this.__solvedSubstituteMaterials=null,this},M=function(){this.renderPriority=null,this.localMatrixOverride=null,this._relativeMatrix=null,this._relativeVisibility=null,this._bsShow=void 0,this._bsNoShow=void 0,this._bbShow=void 0,this._bbNoShow=void 0,this.occurrenceRenderingOverride=null,this.originalOverrideSet=null,this.overrideLink=null};Object.defineProperty(w.prototype,"renderPriority",{get:function(){return this.__overrideData?this.__overrideData.renderPriority:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.renderPriority=e)}}),Object.defineProperty(w.prototype,"occurrenceRenderingOverride",{get:function(){return this.__overrideData?this.__overrideData.occurrenceRenderingOverride:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.occurrenceRenderingOverride=e)}}),Object.defineProperty(w.prototype,"originalOverrideSet",{get:function(){return this.__overrideData?this.__overrideData.originalOverrideSet:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.originalOverrideSet=e)}}),Object.defineProperty(w.prototype,"overrideLink",{get:function(){return this.__overrideData?this.__overrideData.overrideLink:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.overrideLink=e)}}),Object.defineProperty(w.prototype,"localMatrixOverride",{get:function(){return this.__overrideData?this.__overrideData.localMatrixOverride:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.localMatrixOverride=e)}}),Object.defineProperty(w.prototype,"_relativeMatrix",{get:function(){return this.__overrideData?this.__overrideData._relativeMatrix:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._relativeMatrix=e)}}),Object.defineProperty(w.prototype,"_relativeVisibility",{get:function(){return this.__overrideData?this.__overrideData._relativeVisibility:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._relativeVisibility=e)}}),Object.defineProperty(w.prototype,"_bsShow",{get:function(){return this.__overrideData?this.__overrideData._bsShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._bsShow=e)}}),Object.defineProperty(w.prototype,"_bsNoShow",{get:function(){return this.__overrideData?this.__overrideData._bsNoShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._bsNoShow=e)}}),Object.defineProperty(w.prototype,"_bbShow",{get:function(){return this.__overrideData?this.__overrideData._bbShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._bbShow=e)}}),Object.defineProperty(w.prototype,"_bbNoShow",{get:function(){return this.__overrideData?this.__overrideData._bbNoShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._bbNoShow=e)}}),w.prototype._createOverrideData=function(){this.__overrideData||(this.__overrideData=new M)},w.prototype._getMaterialApplication=function(){return this.matAppOverride?this.matAppOverride:this.node._getMaterialApplication()},w.prototype._getFilter=function(e){return this._filters?this._filters.get(e):null},w.prototype._isFurtiveFiltered=function(){return!(!this._getFilter(x.FURTIVE)||!this.isFurtive())},w.prototype._getShadow=function(){var e=null,t=null;if(this.renderable&&this._filters&&this._filters.has(x.LOOK)){var i=this._filters.get(x.LOOK);1===i.shadowReceive?e=!0:0===i.shadowReceive&&(e=!1),1===i.shadowCast?t=!0:0===i.shadowCast&&(t=!1)}return[t,e]},w.prototype._addSubstituteMaterial=function(e,t){this._substituteMaterials||(this._substituteMaterials=new Map),this._substituteMaterials.set(e,t),this.parent&&this.parent.node._updateOccurrences(this.parent,this,!1,!0,!1)},w.prototype._removeSubstituteMaterial=function(e){this._substituteMaterials&&(this._substituteMaterials.delete(e),0===this._substituteMaterials.size&&(this._substituteMaterials=null),this.parent&&this.parent.node._updateOccurrences(this.parent,this,!1,!0,!1))},w.prototype._propagateSubstituteMaterials=function(e){if(this.__solvedSubstituteMaterials=null,e||this._substituteMaterials){var t=new Map;this._substituteMaterials&&this._substituteMaterials.forEach((e,i,r)=>t.set(i,e)),e&&e.forEach((e,i,r)=>t.set(i,e)),t.size>0&&(this.__solvedSubstituteMaterials=t)}},w.prototype.updateMatrix=function(e,t){t?e?this.localMatrixOverride?this.localMatrixOverride.copy(e):this.localMatrixOverride=e.clone():this.localMatrixOverride.identity():this.localMatrixOverride=null;var r=this.parent;if(this.node._isDecal&&this.node._decalAttachedTo.size>0&&r){for(var n=r;n&&!this.node._decalAttachedTo.has(n.node);)n=n.parent;n?r=n:console.warn("Inconsistent decal attachement, the attachement is not a parent of the application, the decal is attached to its application")}r?e&&!e.isIdentity()?r.matrix?r.matrix.isIdentity()?this.matrix=e.clone():(this.matrix=new i.Matrix4,this.matrix.multiplyMatrices(r.matrix,e)):this.matrix=e.clone():r.matrix&&!r.matrix.isIdentity()?this.matrix=r.matrix:this.matrix=S:e&&!e.isIdentity()?this.matrix=e.clone():this.matrix=S},w.prototype.getViewer=function(){return this.scene3js&&this.scene3js.viewer},w.prototype.getLocalMatrix=function(){return this.localMatrixOverride||this.node._matrix||S},w.prototype.requestOverridesUpdate=function(){for(var e=this.parent;e&&!e._getDescendantNeedsOverridesUpdate();)e._setDescendantNeedsOverridesUpdate(!0),e=e.parent;this.traverseWithCondition(function(e){return e._getNeedOverridesUpdate()?null:(e.parent&&e.parent._setDescendantNeedsOverridesUpdate(!0),e._setNeedOverridesUpdate(!0),!0)})},w.prototype.doesADescendantNeedOverrideUpdate=function(){return this._getDescendantNeedsOverridesUpdate()},w.prototype.isOverridesUpdateRequested=function(){return this._getNeedOverridesUpdate()},w.prototype.clearOverridesUpdateRequest=function(){this.traverseWithCondition(function(e){var t=!!e._getDescendantNeedsOverridesUpdate()||null;return e._setNeedOverridesUpdate(!1),e._setDescendantNeedsOverridesUpdate(!1),t})},w.prototype.updateOverrideStatus=function(e){if(e?this.traverse(function(e){!function(e){var t=e.originalOverrideSet;t&&t.lib&&(t.lib.length=0);var i=null,r=null;e.parent&&(i=e.parent.overrideLink,r=e.parent.originalOverrideSet),i&&i.lib&&(i.lib.length=0);var n,a=e.overrideLink,s=t||i;a||s&&(n=t&&t.visibilityFix||i&&i.visibilityFix,a=s.createOverrideLink(n),e.overrideLink=a),a&&a.combine(t,i,r)}(e)}):this.traverse(function(e){e.overrideLink&&e.overrideLink.reset()}),this.parent)this.parent.node._updateOccurrences(this.parent,this,!1);else{var t=this.children,i=0;for(i=0;i<t.length;i++)this.node._updateOccurrences(this,t[i],!e)}},w.prototype._tryOverridesUpdateWithAncestors=function(e){if(this._needOverridesUpdate||this._descendantNeedsOverridesUpdate){for(var t=this;t.parent;)t=t.parent;t.node._tryOverridesUpdate(e||this.scene3js&&this.scene3js.viewer)}},w.prototype._compactChildrenArray=function(e){var t=this.children;this.children=new Array(t.length);for(var i=0;i<t.length;i++)this.children[i]=t[i];this.renderable&&this.renderable._compactArrays&&this.renderable._compactArrays(e)},w.prototype.lightCopy=function(){var e,t=this.node,i=new w(t,this.scene3js);if(null!==this.renderable&&((e=t.createRenderable()).name=t.name,e._occurrence=i,i.renderable=e,t._occurrences[0]&&t._occurrences[0]._manipulators)){var r,n=t._occurrences[0]._manipulators;for(r in n){var a=n[r];i._manipulators||(i._manipulators={}),i._manipulators[r]=a}}return i},w.prototype.traverse=function(e,t){var i,r,n=this.children.length;for(r=e(this,t),i=0;i<n;i++)this.children[i].traverse(e,r)},w.prototype.traverseWithCondition=function(e,t){var i,r,n=this.children.length;if(r=e(this,t))for(i=0;i<n;i++)this.children[i].traverseWithCondition(e,r)},w.prototype._getRenderableOccurrences=function(e){var t,i,r,n,a,s;for(t=[],i=this.children,null!==this.renderable&&t.push(this.renderable),n=0;n<i.length;n++)if(s=i[n],!e||!s.node.getExcludeFromBounding())for(r=s._getRenderableOccurrences(),a=0;a<r.length;a++)t.push(r[a]);return t},w.prototype.getBoundingSphere=function(e,t){var i=this._getBoundingSphere(e,t);return i?i.clone():null},w.prototype.getBoundingBox=function(e){return this._getBoundingBox(e)},w.prototype._getRenderModes=function(){var e=this.scene3js&&this.scene3js.viewer;return e&&null!==this.renderable?e.renderer.renderer.getRenderMode(this.renderable)._maskWithDefault:0},w.prototype._getAccurateRenderableOccurrences=function(e,t,r,n){var a=n||this.node.getRatio()>0;if(r.fixedSizeNodesStatus===i.FixedSizeFiltering.Exclude&&a)return e;var s,o=this.children,l=r.mask||0;if(null!==this.renderable){var h=this.renderable;if(!h.filtered&&_(h.visible,h.visibilityFree,r.space,h.layer,this)){var c=[],d=this._getRenderModes(),u=this._getFilter(x._STATIC_GEOM_TYPE)||this._getFilter(x.GEOM_TYPE);if(h.layer){var p=h.layer.layers;for(v=0;v<p.length;v++){var f=p[v];f.drawableInterval.skip(h,r.space)||(f.drawableGroup.isFiltered(d&~l,u?u._geomType:0)||c.push(f))}}else for(var g=0;g<h.geometry.length;g++)for(var m=h.geometry[g],v=0;v<m.drawingGroups.length;v++){var y=m.drawingGroups[v];y.isFiltered(d&~l,u?u._geomType:0)||c.push(y)}if(c.length>0){var S=new i.Matrix4;null!==r.handleMatrix?S.multiplyMatrices((new i.Matrix4).getInverse(r.handleMatrix),h._getMMMatrix()):S=h._getMMMatrix();var b=r.fixedSizeNodesStatus===i.FixedSizeFiltering.CenterOnly&&a?new i.Box3(new i.Vector3(0,0,0),new i.Vector3(0,0,0)):h.boundingBox.clone(),w=new i.DGBoundingBoxArray({fastBBox:b.applyMatrix4(S),matrix:S,renderable:h});w.setDGs(c),e.push(w)}}}for(g=0;g<o.length;g++)s=o[g],t&&s.node.getExcludeFromBounding()||s._getAccurateRenderableOccurrences(e,t,r,a);return e},w.prototype._isFixedSize=function(){for(var e=!1,t=this;null!=t&&(e=e||t.node.getRatio()>0,t=t.parent,!e););return e},w.prototype.computeAccurateBoundingBox=function(e,t,r,n){var a="visibleSpace"===e,s=[],o=this._isFixedSize();this._getAccurateRenderableOccurrences(s,!0,{space:a,handleMatrix:t,fixedSizeNodesStatus:r||i.FixedSizeFiltering.Include,mask:n||0},o);for(var l=[],h=s.length-1;h>=0;h--)s[h].renderable.geometry[0].vertexPositionArray||(l.push(s[h]),s.splice(h,1));var c=new i.Box3;if(c.fromDGBoundingBoxArray(s),l.length){var d=this.getViewer();c.union(d.renderer.boundingBoxGPUCompute.computeBoundingBoxGPU(d,l,t))}return c},w.prototype.needsBoundingElement=function(){var e,t=this.children.length;for(e=0;e<t;e++){var i=this.children[e];if(i.localMatrixOverride||void 0!==i._bsShow||void 0!==i._bsNoShow||void 0!==i._bbShow||void 0!==i._bbNoShow||i.overrideLink&&i.overrideLink.hasVisibilityOverride())return!0}return!1},w.prototype._isFiltered=function(){return!(!(this.layerFilter&&this.node._layer<this.layerFilter.length)||this.layerFilter[this.node._layer])},w.prototype._getBoundingSphere=function(e,t){e=e||"visibleSpace",this._updateBoundingElements();var r=null,n=void 0!==this._bsShow?this._bsShow:this.node._bsShow,a=void 0!==this._bsNoShow?this._bsNoShow:this.node._bsNoShow;return(r=this._getVisibilityFree()?this._getVisible()?n:null:this._getVisible()?"visibleSpace"===e?n:a:"visibleSpace"===e?null:i.mergeBoundingSphereInto(n&&n.clone(),a,this.node.getRatio()))||t||(r=new i.Sphere),r},w.prototype._getBoundingBox=function(e){e=e||"visibleSpace",this._updateBoundingElements();var t=null,r=void 0!==this._bbShow?this._bbShow:this.node._bbShow,n=void 0!==this._bbNoShow?this._bbNoShow:this.node._bbNoShow;return(t=this._getVisibilityFree()?this._getVisible()?r:null:this._getVisible()?"visibleSpace"===e?r:n:"visibleSpace"===e?null:i.mergeBoundingBoxInto(r&&r.clone(),n))||(t=new i.Box3),t},w.prototype.updateVisibilityFlag=function(){this._invalidateBoundingElements(!1)},w.prototype.updateVisibilityFreeFlag=function(){this._invalidateBoundingElements(!1)},w.prototype._invalidateBoundingElements=function(e){this._getNeedBEUpdate()||(this._setNeedBEUpdate(!0),!this.parent||this.node.getExcludeFromBounding()&&!e||this.parent._invalidateBoundingElements(!1))},w.prototype._updateBoundingElements=function(e,t){if(e||this.node._updateBoundingElements(),this._getNeedBEUpdate()){if(!this.node._getForceBoundingElements()){t=this.node._updateShadowMapsIfNeeded(t);var r=0;for(r=0;r<this.children.length;r++)this.children[r]._updateBoundingElements(!0,t);this._updateBoundingElements_internal("_bsShow","_bsNoShow",i.mergeBoundingSphereInto,"bSphere"),this._updateBoundingElements_internal("_bbShow","_bbNoShow",i.mergeBoundingBoxInto,"bBox")}this._setNeedBEUpdate(!1),this.parent||this.scene3js&&(this.scene3js.boundingSphere=this._getBoundingSphere("visibleSpace").clone(),this.scene3js.boundingSphere.radius=100,this.scene3js.boundingBox=this._getBoundingBox("visibleSpace").clone())}},w.prototype._updateBoundingElements_internal=function(e,t,i,r){if(!this.node._getForceBoundingElements())if(this.needsBoundingElement()){if(this.children.length){var n,a,s,o,l=0,h=null,c=null;for(l=0;l<this.children.length;l++)(n=this.children[l]).node.getExcludeFromBounding()||(a=void 0!==n[e]?n[e]:n.node[e],s=void 0!==n[t]?n[t]:n.node[t],o=n.localMatrixOverride||n.node._matrix,n._getVisibilityFree()?(n._getVisible()||n.needsBoundingElement()&&!n.isMesh())&&(h=i(h,a,o,n.node.getRatio()),c=i(c,a,o,n.node.getRatio())):n._getVisible()||n.needsBoundingElement()&&!n.isMesh()?(h=i(h,a,o,n.node.getRatio()),c=i(c,s,o,n.node.getRatio())):(c=i(c,a,o,n.node.getRatio()),c=i(c,s,o,n.node.getRatio())))}else this._getHasExplicitBE()&&(h=void 0!==this[e]?this[e]:this.node[r],c=null);this[e]=h,this[t]=c}else this[e]=void 0,this[t]=void 0},w.prototype.isInCanvas2DPass=function(){var e=this.passes;return!!(e&&e.indexOf("canvas2D")>=0)},w.prototype.isInNozPass=function(){var e=this.passes;return!!(e&&e.indexOf("noz")>=0)||(!!(e&&e.indexOf("NoZ")>=0)||(!!(e&&e.indexOf("Noz")>=0)||(!!(e&&e.indexOf("robot")>=0)||(!!(e&&e.indexOf("canvas2D")>=0)||!!(e&&e.indexOf("-noPoliteHL")>=0)))))},w.prototype.isFurtive=function(){var e=this.passes;return!!(e&&e.indexOf("furtive")>=0)},w.prototype.isMesh=function(){return this.node._isMesh3D};var C=e.extend({init:function(e,t){if(this.id=y,y++,this.node3DBooleanAttr=0,this.modelIdentification=null,this.name=void 0!==e?e:"",this.parents=[],this.children=[],this.setLinkedToSceneGraph(!1),this._bsShow=null,this._bsNoShow=null,this._bbShow=null,this._bbNoShow=null,this._setForceBoundingElements(!1),this.setIsInBackground(!0),this._setIsAlwaysInForeground(!1),this._matrix=null,this.setExcludeFromBounding(!1),this.userData=null,this._setNeedBEUpdate(!0),this._material=null,this._matApp=null,this._gas=window.newMaterialInheritance?new i.GraphicAttributeSet({NREInit:!0,type:i.GASTypeEnum.SKIN}):null,this._filters=null,this._setVisible(!0),this._setVisibilityFree(!1),this._setPickable(!0),this.setNoPickThrough(!0),this._occurrences=[],!m||t){var r=new w(this,this.scene3js);this._occurrences.push(r)}return this._setPickParent(!1),this.__setTreeModified(!1),this.passes=null,this.clippingContext=null,this._renderMode=null,this._pickingMode=null,this._layer=0,this._layerFilter=null,this._depthMode=!1,this._depthPriority=0,this._priority=4,this.setNotAllowedInPathElement(!1),this.modelEvents=void 0,this.productType="",this.persistentId=0,this._setVisibilityInTree(!0),this._iconInTree="",this.pickingPriorityID=null,this.clipPolyLine=null,this.setIsManipulator(!1),this._PLMMaterialData=null,this._setExcludeFromCSO(!1),this._setExcludeFromHSO(!1),this._setExcludeFromPSO(!1),this._setExcludeFromHL(!1),this._setExcludeFromPreHL(!1),this._setPropagateXSOExclusion(!1),this._setForbidHierarchyUpdate(!1),this.decalCount=0,this._overrideSetManager=null,this},_linkingClone:function(e,t){return(t=t||new C(this.name)).node3DBooleanAttr=this.node3DBooleanAttr,t._matrix=this._matrix,t._setNeedBEUpdate(!0),t._material=this._material,t._matApp=this._matApp,t._gas=this._gas,this._filters&&(t._filters=new Map,this._filters.forEach((e,i,r)=>t._filters.set(i,e))),t.passes=this.passes,t.clippingContext=this.clippingContext,t._renderMode=this._renderMode,t._pickingMode=this._pickingMode,t._layer=this._layer,t._layerFilter=this._layerFilter,t._depthPriority=this._depthPriority,t._priority=this._priority,t.modelEvents=this.modelEvents,t.productType=this.productType,t.persistentId=this.persistentId,t._iconInTree=this._iconInTree,t.pickingPriorityID=this.pickingPriorityID,t.clipPolyLine=this.clipPolyLine,t._PLMMaterialData=this._PLMMaterialData,t._overrideSetManager=this._overrideSetManager,t},_compactHierarchy:function(e,t){if(!e.has(this)){e.add(this);var i=this.parents;this.parents=new Array(i.length);for(var r=0;r<i.length;r++)this.parents[r]=i[r];var n=this._occurrences;this._occurrences=new Array(n.length);for(r=0;r<n.length;r++){var a=n[r];this._occurrences[r]=a,a._compactChildrenArray(t)}var s=this.children;this.children=new Array(s.length);for(r=0;r<s.length;r++){var o=s[r];this.children[r]=o,o._compactHierarchy(e,t)}}},_getPickingCameraName:function(){var e=this._occurrences[0].passes;if(e&&1===e.length){if("robot"===e[0])return"connectedRobotCamera";if("robotOrtho"===e[0])return"robotCameraOrtho"}return""},_setTreeModified:function(){if(!this._getTreeModified()){this.__setTreeModified(!0);var e=0;for(e=0;e<this.parents.length;e++)this.parents[e]._setTreeModified()}},getModelIdentification:function(){return this.modelIdentification},setModelIdentification:function(e){this.modelIdentification=e},getIdentificationObject:function(){return this.modelIdentification},setIdentificationObject:function(e){this.modelIdentification=e},setNodeUsage:function(e){this.persistentId=e},getNodeUsage:function(){return this.persistentId},isOOCPLMNode:function(){var e=this.getNodeUsage();return null!==this.modelIdentification&&void 0!==this.modelIdentification&&e!==C.TILESET_NODE},isOOCRepReference:function(){return this.getNodeUsage()===C.REPRESENTATION_NODE},isOOCReference:function(){return this.getNodeUsage()===C.REFERENCE_NODE},isOOCInstance:function(){return this.getNodeUsage()===C.INSTANCE_NODE&&!this.isOOCRepInstance()},isOOCRepInstance:function(){var e;if(this.getNodeUsage()===C.INSTANCE_NODE)for(e=0;e<this.children.length;e++)if(this.children[e].isOOCRepReference())return!0;return!1},isOOCTileSetNode:function(){return this.getNodeUsage()===C.TILESET_NODE},addChild:function(e){if(e){if(P>0)throw new Error("Attempt to modify locked node hierarchy.");if(this._getForbidHierarchyUpdate()||e._getForbidHierarchyUpdate())return!1;var r,n,a,s;if(this._setTreeModified(),e instanceof i.Object3D&&console.warn("THREE.Object3D can not be a child of Node3D. This is probably due to a migration problem."),-1!==(e.parents.length<this.children.length?e.parents.indexOf(this):this.children.indexOf(e)))return!1;e._invalidateBoundingElements(!1,!1),this.children.push(e),e.parents.push(this),e._isDecal&&this.decalCount++;var o=null,l=this;if(e.traverse(function(e){var t,i,r=e.clippingContext&&e.clippingContext.planes;if(r)for(o||(o=l._getAllOwningViewers()),t=0;t<o.length;t++){for(i=0;i<r.length;i++)o[t]._addClippingPlane(r[i]);o[t]._requestClippingUpdate()}}),r=this._occurrences.length,n=e._occurrences.length,u=0,!r||!n)return!1;var h=!1;for((e._getOverrideExists()||this._getOverrideExists())&&(this._setOverrideExistsTraverse(),h=!0),e._getOverrideSetManagerUnder()&&this._setOverrideSetManagerUnder(),u=0;u<r;u++){if(a=this._occurrences[u],s=e._occurrences[0],a&&a.originalOverrideSet&&a.originalOverrideSet.onAddChild){var c=a.scene3js&&a.scene3js.viewer;a.originalOverrideSet.onAddChild(c)}(n>1||null!==s.parent)&&(s=this._copyTree(s)),a.children.push(s),s.parent=a,this._updateOccurrences(a,s,!0),h&&s.requestOverridesUpdate()}this._getNeedBEUpdate()||e._areBoundingElementsIncludedInParent(this)||this._invalidateBoundingElements(!1,!1),e.traverseUnique(function(e){e._getStaticOverrideSet()&&e._requestStaticOverridesUpdate()}),this.onLinkToSceneGraph(e);for(var d={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"ADD",fromNode:this,toNode:e},u=(o=this._getAllOwningViewers(),0);u<o.length;u++)i.DecalManager.updateDecalsData(o[u],!1);return t.publish({event:"/VISU/onSceneGraphUpdate",data:d}),!0}},removeChild:function(e){if(e){if(P>0)throw new Error("Attempt to modify locked node hierarchy.");if(this._getForbidHierarchyUpdate()||e._getForbidHierarchyUpdate&&e._getForbidHierarchyUpdate())return!1;var r,n,a,s,o,l,h;if(this._setTreeModified(),-1===(r=this.children.indexOf(e)))return!1;if(this.children.splice(r,1),-1===(n=e.parents.indexOf(this)))return!1;e.parents.splice(n,1),e._isDecal&&this.decalCount--,this.onLinkToSceneGraph(e);var c=this._getAllOwningViewers();if(e.traverse(function(e){var t,i,r=e.clippingContext&&e.clippingContext.planes;if(r)for(t=0;t<c.length;t++){for(i=0;i<r.length;i++)c[t]._removeClippingPlane(r[i]);c[t]._requestClippingUpdate()}}),a=this._occurrences.length,s=e._occurrences.length,!a||!s)return!1;for(p=0;p<a;p++)if(o=this._occurrences[p],s=e._occurrences.length,l=e._occurrences[0],1===s){-1!==(r=o.children.indexOf(l))&&o.children.splice(r,1),l.parent=null,l.material=e._material,e._matrix?l.matrix=e._matrix.clone():l.matrix=null,null!==l.renderable&&(l.renderable.setMatrix(l.matrix,!1),"Mesh3D"===l.node.getNodeType()||"ParticlesNode3D"===l.node.getNodeType()?(null!==l.material&&(l.renderable.material=l.material),null!==l.matApp&&(l.renderable.matApp=l.matApp),null!==l.gas&&(l.renderable.gas=l.gas),null!==l.scene3js&&l.scene3js.containsObject(l.renderable)&&(this._removeFromVisuSelection(l.renderable),l.scene3js.remove(l.renderable),"Mesh3D"===l.node.getNodeType()&&l.renderable.releaseVBO(!1))):"LightNode3D"===l.node.getNodeType()?null!==l.scene3js&&l.scene3js.containsLight(l.renderable)&&l.scene3js.remove(l.renderable):"LensFlareNode3D"===l.node.getNodeType()?null!==l.scene3js&&l.scene3js.containsLensFlare(l.renderable)&&l.scene3js.remove(l.renderable):"CSS2DNode"!==l.node.getNodeType()&&"CSS3DNode"!==l.node.getNodeType()||(l.renderable.element.parentNode&&l.renderable.element.parentNode.removeChild(l.renderable.element),null!==l.scene3js&&l.scene3js.remove(l.renderable)));var d=l.scene3js&&l.scene3js.viewer;for(d&&2===d._sceneGraphStateVersion&&l.traverse(function(e){e.originalOverrideSet&&(e.originalOverrideSet.onDetach(d,e),e.originalOverrideSet=null),e.overrideLink=null}),l.scene3js=null,h=0;h<l.children.length;h++)this._updateOccurrences(l,l.children[h],!0)}else{for(h=0;h<o.children.length&&(l=o.children[h]).node!==e;h++);o.children.splice(h,1),this._deleteTree(l)}this._removeInvalidElementsInXSO(e),e.getExcludeFromBounding()||this._invalidateBoundingElements(!1,!1),e.traverseUnique(function(e){e._getStaticOverrideSet()&&e._requestStaticOverridesUpdate()});for(var u={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"REMOVE",fromNode:this,toNode:e},p=0;p<c.length;p++)i.DecalManager.updateDecalsData(c[p],!0);return t.publish({event:"/VISU/onSceneGraphUpdate",data:u}),!0}},removeChildren:function(){if(this._getForbidHierarchyUpdate())return!1;for(;this.children.length;)this.removeChild(this.children[0],!1);return this._invalidateBoundingElements(!1,!1),!0},traverse:function(e,t,i){var r,n,a=!1;a=e(this,t);var s=i?this.parents:this.children;if(n=s.length,!a)for(r=0;r<n&&!(a=s[r].traverse(e,t,i));r++);return a},traverseUnique:function(e,t,i,r){if(!m){var n=new Set;this._traverse_internal(e,t,i,r,n);var a=[];return n.forEach(e=>{a.push(e)}),a}},_traverse_internal:function(e,t,i,r,n){if(!m&&!n.has(this)){n.add(this);var a,s,o;o=e(this,t);var l=i?this.parents:this.children;if(s=l.length,!o)for(a=0;a<s;a++)l[a]._traverse_internal(e,t,i,r,n)}},getChildrenByName:function(e,t){var i={root:this,nodes:[]};return this.traverse(function(t,i){return t.name===e&&i.nodes.push(t),!1},i,t),i.nodes},_forceGeomType:function(e){for(var t=0;t<this.children.length;t++)this.children[t]._forceGeomType(e)},_setRatio:function(e){for(var t=0;t<this.children.length;t++)this.children[t]._setRatio(e)},_setFixedSizeCameraName:function(e){for(var t=0;t<this.children.length;t++)this.children[t]._setFixedSizeCameraName(e)},_setBillboardData:function(e,t,i){for(var r=0;r<this.children.length;r++)this.children[r]._setBillboardData(e,t,i)},_setFixedSizeCenter:function(e,t){for(var i=0;i<this.children.length;i++)this.children[i]._setFixedSizeCenter(e,t)},getChildByName:function(e,t){var i={root:this,node:null};return this.traverse(function(t,i){return t.name===e&&(i.node=t,!0)},i,t),i.node},getChildById:function(e,t){var i={root:this,node:null};return this.traverse(function(t,i){return t.persistentId===e&&(i.node=t,!0)},i,t),i.node},_reduceMaterial:function(){if(this.getLinkedToSceneGraph())for(var e=0;e<this._occurrences.length;e++)for(var t=this._occurrences[e]._getRenderableOccurrences(),i=0;i<t.length;i++)t[i].releaseVBO(!0)},_incrementMaterial:function(){if(this.getLinkedToSceneGraph())for(var e=0;e<this._occurrences.length;e++)for(var t=this._occurrences[e]._getRenderableOccurrences(),i=0;i<t.length;i++)t[i].addRefVBO(!0)},oldSetMaterial:function(e){var t,r,n,a,s,o;for(this._reduceMaterial(),this._material=e,t=this._occurrences.length,s=0;s<t;s++)(n=this._occurrences[s]).material=e,null!==n.renderable&&(n.renderable._flagAsGSSOInvalidated(),i.disableJHGDev&&null===n.material||(n.renderable.material=n.material));for(s=0;s<t;s++)for(r=(n=this._occurrences[s]).children.length,o=0;o<r;o++)a=n.children[o],this._updateOccurrences(n,a,!1);this._incrementMaterial()},setMaterial:function(e){if(window.newMaterialInheritance){var t=null;if(this._matApp&&this._matApp._material===e&&(t=this._matApp),this._reduceMaterial(),t)this._matApp=t,this._updateMaterial();else{this._matApp=null;var r={layer:0};e&&(e.line||e.point?(e.line&&(r.lineMaterial=e.line),e.point&&(r.pointMaterial=e.point),"forceGeomTypeFACE"===e.force?r.geometricalFaceMaterial=e:r.faceMaterial=e):"forceGeomTypeFACE"===e.force?r.geometricalFaceMaterial=e:e instanceof i.LineBasicMaterial?r.lineMaterial=e:e instanceof i.ParticleBasicMaterial?r.pointMaterial=e:e instanceof i.ShaderMaterialDS?(r.faceMaterial=e,r.lineMaterial=e,r.pointMaterial=e):r.faceMaterial=e),(t=new u(r))._checkForceFlag=!0,this.__setMaterialApplication(t)}this._incrementMaterial()}else this.oldSetMaterial(e)},getMaterialApplication:function(){return this._matApp},setMaterialApplication:function(e){this._reduceMaterial(),this.__setMaterialApplication(e),this._incrementMaterial()},removeMaterialApplication:function(){this._reduceMaterial(),this.__removeMaterialApplication(),this._incrementMaterial()},_getMaterialApplication:function(){return this._matApp},_setMaterialApplication:function(e){console.error("Do not use private internal APIs: please use setMaterialApplication(iMatApp) instead"),this.setMaterialApplication(e)},__setMaterialApplication:function(e){var t=this._getMaterialApplication();t?(e._layer<t._layer||e._layer===t._layer&&e._inheritance>=t._inheritance)&&(this._matApp=e):this._matApp=e,this._updateMaterial()},_removeMaterialApplication:function(){console.error("Do not use private internal APIs: please use removeMaterialApplication() instead"),this.removeMaterialApplication()},__removeMaterialApplication:function(){this._matApp=null,this._updateMaterial()},_updateMaterial:function(){var e,t,i,r;e=this._occurrences.length;var n=this._getMaterialApplication();for(r=0;r<e;r++)!(i=(t=this._occurrences[r]).parent)&&n?t.matApp=n:this._updateOccurrences(i,t,!1),null!==t.renderable&&(t.renderable.matApp=t.matApp)},setGAS:function(e){this._reduceMaterial(),this._setGAS(e),this._incrementMaterial()},getGAS:function(){return this._gas},_setGAS:function(e){var t,i,r,n;if(e)for(this._gas=e.__getGAS(this._gas),t=this._occurrences.length,n=0;n<t;n++)(r=(i=this._occurrences[n]).parent)?this._updateOccurrences(r,i,!1):i.gas=this._gas?this._gas.clone():null,null!==i.renderable&&(i.renderable.gas=i.gas)},_getGAS:function(){return this._gas},setVisibility:function(e,r){if(this._getVisible()!==e){var n,a,s,o,l,h,c;if(this._setVisible(e),r)(u=this._getViewer())&&(c=u.getRobot()),c&&c.isTargetGone(u.visibleSpace)&&c.setConnectionState(!1);for(n=this._occurrences.length,l=0;l<n;l++){if((s=this._occurrences[l]).parent?s._setVisible(s.parent._getVisible()&&this._getVisible()):s._setVisible(this._getVisible()),null!==s.renderable){s.renderable.visible=s._getVisible();var d,u=null;if(void 0!==s.renderable.highlightMeshes&&null!==s.renderable.highlightMeshes)if(!(u=s.scene3js&&s.scene3js.viewer)||!u.picking.forceVisibility)for(d=0;d<s.renderable.highlightMeshes.length;d++)s.renderable.highlightMeshes[d].renderable.visible=s._getVisible();if(void 0!==s.renderable.preHighlight&&null!==s.renderable.preHighlight&&(u||(u=s.scene3js&&s.scene3js.viewer),u&&u.pPicking.forceVisibility||(s.renderable.preHighlight.visible=s._getVisible())),s.renderable instanceof i.CSS2DNode||s.renderable instanceof i.CSS3DNode){var p=!0;this._getViewer()&&(p=this._getViewer().visibleSpace);(s._getVisibilityFree()?s._getVisible():p?s._getVisible():!s._getVisible())||(s.renderable.element.style.display="none")}}s.updateVisibilityFlag()}for(l=0;l<n;l++)for(a=(s=this._occurrences[l]).children.length,h=0;h<a;h++)o=s.children[h],this._updateOccurrences(s,o,!0);this._updateVisibilityFlag();var f={eventChannel:"/VISU/onSceneGraphUpdate",eventType:e?"SHOWTREE":"HIDETREE",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:f})}},setVisibilityFree:function(e){if(this._getVisibilityFree()!==e){var r,n,a,s,o,l,h;for(this._setVisibilityFree(e),(d=this._getViewer())&&(h=d.getRobot()),h&&h.isTargetGone(d.visibleSpace)&&h.setConnectionState(!1),r=this._occurrences.length,o=0;o<r;o++){if((a=this._occurrences[o]).parent?a._setVisibilityFree(a.parent._getVisibilityFree()||this._getVisibilityFree()):a._setVisibilityFree(this._getVisibilityFree()),null!==a.renderable){a.renderable.visibilityFree=a._getVisibilityFree();var c,d=null;if(void 0!==a.renderable.highlightMeshes&&null!==a.renderable.highlightMeshes)if(!(d=a.scene3js&&a.scene3js.viewer)||!d.picking.forceVisibility)for(c=0;c<a.renderable.highlightMeshes.length;c++)a.renderable.highlightMeshes[c].renderable.visibilityFree=a._getVisibilityFree();if(void 0!==a.renderable.preHighlight&&null!==a.renderable.preHighlight&&(d||(d=a.scene3js&&a.scene3js.viewer),d&&d.pPicking.forceVisibility||(a.renderable.preHighlight.visibilityFree=a._getVisibilityFree())),a.renderable instanceof i.CSS2DNode||a.renderable instanceof i.CSS3DNode){var u=!0;this._getViewer()&&(u=this._getViewer().visibleSpace);(a._getVisibilityFree()?a._getVisible():u?a._getVisible():!a._getVisible())||(a.renderable.element.style.display="none")}}a.updateVisibilityFreeFlag()}for(o=0;o<r;o++)for(n=(a=this._occurrences[o]).children.length,l=0;l<n;l++)s=a.children[l],this._updateOccurrences(a,s,!1);this._updateVisibilityFreeFlag();var p={eventChannel:"/VISU/onSceneGraphUpdate",eventType:e?"VISIBILITYFREE":"VISIBILITYDEPENDENT",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:p})}},setMatrix:function(e,t){if(e&&!e.isIdentity){e=(new i.Matrix4).copy(e);var r=new Error;console.error(r.stack),console.error("ERROR: setMatrix requires a THREE.Matrix4!")}!e||e.isIdentity()?this._matrix=null:this._matrix?this._matrix.copy(e):this._matrix=(new i.Matrix4).copy(e),this._updateMatrix(t)},applyMatrix:function(e){if(e&&!e.isIdentity){e=(new i.Matrix4).copy(e);var t=new Error;console.error(t.stack),console.error("ERROR: setMatrix requires a THREE.Matrix4!")}e&&!e.isIdentity()&&(this._matrix?(this._matrix.multiplyMatrices(e,this._matrix),this._matrix.isIdentity()&&(this._matrix=null)):(this._matrix=new i.Matrix4,this._matrix.copy(e))),this._updateMatrix()},setVisibilityInTree:function(e){if(this._getVisibilityInTree()!==e){this._setVisibilityInTree(e);for(var i=0;i<this.parents.length;i++){var r={eventChannel:"/VISU/onSceneGraphUpdate",eventType:e?"ADDTREE":"REMOVETREE",fromNode:this.parents[i],toNode:this};t.publish({event:"/VISU/onSceneGraphUpdate",data:r})}}},getVisibilityInTree:function(){return void 0===this._getVisibilityInTree()||this._getVisibilityInTree()},setIcon:function(e){this._iconInTree=""===e?"":e;var i={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"CHANGEICON",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:i})},getIcon:function(){return void 0!==this._iconInTree?this._iconInTree:""},setName:function(e){this.name=e;var i={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"CHANGENAME",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:i})},getName:function(){return this.name},getPickable:function(){return this.getNoPickThrough()?this._getPickable()?a.PICKABLE:a.NOPICKABLE:a.PICKTHROUGH},setPickable:function(e){var t,i,r,n,s,o;for("boolean"==typeof e&&console.log("boolean is DEPRECATED in setPickable() method.\n Use ENUM Mesh"),this._setPickable(e===a.PICKABLE),this.setNoPickThrough(e!==a.PICKTHROUGH),t=this._occurrences.length,s=0;s<t;s++)(r=this._occurrences[s]).parent?(r._setPickable(r.parent._getPickable()&&this._getPickable()),r.setNoPickThrough(r.parent.getNoPickThrough()&&this.getNoPickThrough())):(r._setPickable(this._getPickable()),r.setNoPickThrough(this.getNoPickThrough())),null!==r.renderable&&(r.renderable.pickable=r._getPickable(),r.renderable.noPickThrough=r.getNoPickThrough(),r.renderable._flagAsGSSOInvalidated());for(s=0;s<t;s++)for(i=(r=this._occurrences[s]).children.length,o=0;o<i;o++)n=r.children[o],this._updateOccurrences(r,n,!1)},isPickable:function(){return this._getPickable()},getNoZPriority:function(){return this._getNoZPriority()},setNoZPriority:function(e){var t,i,r,n,a,s;for(this._setNoZPriority(e),t=this._occurrences.length,a=0;a<t;a++){var o=(r=this._occurrences[a]).parent;if(o)this._updateOccurrences(o,r,!1);else for(i=r.children.length,s=0;s<i;s++)n=r.children[s],this._updateOccurrences(r,n,!1)}},setPickParent:function(e){this._setPickParent(e)},getPickParent:function(){return!!this._getPickParent()},setPickingPriorityId:function(e){var t,i,r,n,a,s;for(this.pickingPriorityID||(this.pickingPriorityID={faces:null,edges:null,points:null}),"string"==typeof e&&(this.pickingPriorityID.faces=e,this.pickingPriorityID.edges=e,this.pickingPriorityID.points=e),(e.faces||null===e.faces)&&(this.pickingPriorityID.faces=e.faces),(e.edges||null===e.edges)&&(this.pickingPriorityID.edges=e.edges),(e.points||null===e.points)&&(this.pickingPriorityID.points=e.points),t=this._occurrences.length,a=0;a<t;a++)(r=this._occurrences[a]).pickingPriorityID=this.pickingPriorityID,null!==r.renderable&&(r.renderable.pickingPriorityID=r.pickingPriorityID);for(a=0;a<t;a++)for(i=(r=this._occurrences[a]).children.length,s=0;s<i;s++)n=r.children[s],this._updateOccurrences(r,n,!1)},getPickingPriorityId:function(){return this.pickingPriorityID},exludeFromBounding:function(e){this.setExcludeFromBounding(e),this._invalidateBoundingElements(!1,!0)},translate:function(e,t){var r=new i.Vector3;this._matrix&&(t.transformDirection(this._matrix),r.getPositionFromMatrix(this._matrix)),r.add(t.multiplyScalar(e)),this._matrix||(this._matrix=new i.Matrix4),this._matrix.setPosition(r),this._updateMatrix()},translateX:function(e){var t=new i.Vector3(1,0,0);this.translate(e,t)},translateY:function(e){var t=new i.Vector3(0,1,0);this.translate(e,t)},translateZ:function(e){var t=new i.Vector3(0,0,1);this.translate(e,t)},getMaterial:function(e){var t=this._filters?this._filters.get(x.LOOK):null,i=this._getMaterialApplication();if(!i||t){var r=t?t.material:this._material;if(r)switch(e){case"Face":case"GeomFace":return r;case"Line":return r.line;case"Point":return r.point}return r}switch(e){case"Face":return i._material;case"GeomFace":return i._materialGeomFace;case"Line":return i._materialLine;case"Point":return i._materialPoint}return i._material?i._material:i._materialGeomFace?i._materialGeomFace:i._materialLine?i._materialLine:i._materialPoint?i._materialPoint:null},isVisible:function(){return this._getVisible()},getMatrix:function(){return this._matrix?this._matrix.clone():new i.Matrix4},getChildren:function(){return[].concat(this.children)},getParents:function(){return[].concat(this.parents)},getNodeType:function(){return"Node3D"},whiteVectorInBlack:function(){this.modifyColor(new i.Color(0),new i.Color(16777215))},modifyColor:function(e,t,r){if(!m){if("Mesh3D"===this.getNodeType()){var n=this._occurrences[0].renderable.geometry;if(!(n instanceof Array))return;for(var a=0;a<n.length;a++)for(var s=n[a].drawingGroups,o=0;o<s.length;o++){var l=s[o];if(l.gas&&l.gas.color){if(l.gas instanceof i.ParticleBasicMaterial)continue;var h=l.gas.color;if(r&&r!==l.glType)continue;if(h.equals(t)){var c=l.gas.clone();c.color=e,l.gas=c}}if(l.material&&l.material.color){if(l.material instanceof i.ParticleBasicMaterial)continue;h=l.material.color;if(r&&r!==l.glType)continue;if(h.equals(t)){var d=l.material.clone();d.color=e,l.material=d}}}}for(o=0;o<this.children.length;o++)this.children[o].modifyColor(e,t,r)}},getBoundingSphere:function(e,t){"show"===e&&(console.warn("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace");var i=this._getBoundingSphere(e,t);return i?i.clone():null},createOverrideSetManager:function(){return!this._overrideSetManager&&C.SceneGraphOverrideSetManager&&this._setOverrideSetManager(new C.SceneGraphOverrideSetManager({node:this})),this._overrideSetManager},getOverrideSetManager:function(){return this._overrideSetManager},removeOverrideSetManager:function(){this._overrideSetManager&&(this._overrideSetManager.clear(),this._overrideSetManager=null)},_setOverrideSetManager:function(e){this._overrideSetManager=e,this._setOverrideSetManagerUnder(!0)},_getViewer:function(){return this._occurrences.length>0&&this._occurrences[0].scene3js?this._occurrences[0].scene3js.viewer:null},_getAllOwningViewers:function(){var e,t,i=[];for(e=0;e<this._occurrences.length;e++)this._occurrences[e].scene3js&&(t=this._occurrences[e].scene3js.viewer)&&i.indexOf(t)<0&&i.push(t);return i},_hasOccurrenceInViewer:function(e){var t;for(t=0;t<this._occurrences.length;t++)if(this._occurrences[t].scene3js&&e===this._occurrences[t].scene3js.viewer)return!0;return!1},_tryOverridesUpdate:function(e){var t=e.getSceneGraphOverrideSetManager();t&&t._fullOccurrencesUpdate();var i,r,n=e?e.hasSceneGraphOverrideSet():null,a=this._occurrences,s=!1;if(this._getOverrideSetManagerUnder())for(i=0;i<a.length;i++)((r=a[i]).isOverridesUpdateRequested()||r.doesADescendantNeedOverrideUpdate())&&(s=!0);for(s&&this.traverseUnique(function(e){e._overrideSetManager&&(e._overrideSetManager._refresh(),n=!0)}),i=0;i<a.length;i++)a[i].traverseWithCondition(function(e){return e.isOverridesUpdateRequested()?(e.updateOverrideStatus(n),null):!!e.doesADescendantNeedOverrideUpdate()||null}),a[i].clearOverridesUpdateRequest()},forceBoundingElements:function(e,t,r){function n(e){var t=null;return void 0===e.sphere&&void 0===e.box||(t={sphere:e.sphere||function(e){if(!e)return null;var t=new i.Vector3(.5*(e.min.x+e.max.x),.5*(e.min.y+e.max.y),.5*(e.min.z+e.max.z)),r=t.distanceTo(e.max),n=new i.Sphere;return n.center=t,n.radius=r,n}(e.box),box:e.box||function(e){if(!e)return null;var t=new i.Vector3(2*e.radius,2*e.radius,2*e.radius),r=new i.Box3;return r.setFromCenterAndSize(e.center,t),r}(e.sphere)}),t}if(e){r=r||{};var a=n(t=t||{}),s=n(r);this.__forceBoundingElements(a,s)}else this._getForceBoundingElements()&&(this._setForceBoundingElements(!1),this._invalidateBoundingElements(!1,!1))},__forceBoundingElements:function(e,t){this._setForceBoundingElements(!0),this._bsShow=e&&e.sphere,this._bsNoShow=t&&t.sphere,this._bbShow=e&&e.box,this._bbNoShow=t&&t.box,this._invalidateBoundingElements(!1,!1)},getBoundingBox:function(e){return"show"===e&&(console.warn("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace"),this._getBoundingBox(e).clone()},_getBoundingSphere:function(e,t){e=e||"visibleSpace";var r,n,a=null;return this.getHasExplicitBE()?(r=this.explicitBSphere,n=null):(this._updateBoundingElements(),r=this._bsShow,n=this._bsNoShow),(a=this._getVisibilityFree()?this._getVisible()?r:null:this._getVisible()?"visibleSpace"===e?r:n:"visibleSpace"===e?null:i.mergeBoundingSphereInto(r&&r.clone(),n,this.getRatio()))||t||(a=new i.Sphere),a},_getBoundingBox:function(e){e=e||"visibleSpace";var t,r,n=null;return this.getHasExplicitBE()?(t=this.explicitBBox,r=null):(this._updateBoundingElements(),t=this._bbShow,r=this._bbNoShow),(n=this._getVisibilityFree()?this._getVisible()?t:null:this._getVisible()?"visibleSpace"===e?t:r:"visibleSpace"===e?null:i.mergeBoundingBoxInto(t&&t.clone(),r))||(n=new i.Box3),n},_invalidateBoundingElements:function(e,t){if(!e){var i=0;for(i=0;i<this._occurrences.length;i++)this._occurrences[i]._invalidateBoundingElements(t)}if(!this._getNeedBEUpdate()&&(this._setNeedBEUpdate(!0),!this.getExcludeFromBounding()||t)){var r=0;for(r=0;r<this.parents.length;r++)this.parents[r]._invalidateBoundingElements(!0,!1)}},_updateVisibilityFlag:function(){this._invalidateBoundingElements(!1,!1)},_updateVisibilityFreeFlag:function(){this._invalidateBoundingElements(!1,!1)},_updateShadowMapsIfNeeded:function(e){var t=this._getViewer(),i=e;return t&&t.useShadowMap&&(void 0===i&&(i=!0,this.traverse(function(e){return!!e.getExcludeFromBounding()&&(i=!1,!0)},void 0,!0)),(i=i&&!this.getExcludeFromBounding())&&t._updateShadowMaps()),i},_updateBoundingElements:function(e,t){var r;if(this._getNeedBEUpdate()){if(t=this._updateShadowMapsIfNeeded(t),!this._getForceBoundingElements()){for(r=0;r<this.children.length;r++)this.children[r]._updateBoundingElements(!0,t);this.updateBoundingElements_internal("_bsShow","_bsNoShow",i.mergeBoundingSphereInto,"bSphere"),this.updateBoundingElements_internal("_bbShow","_bbNoShow",i.mergeBoundingBoxInto,"bBox")}if(!e)for(r=0;r<this._occurrences.length;r++)this._occurrences[r]._updateBoundingElements(!0);this._setNeedBEUpdate(!1)}},_areBoundingElementsIncludedInParent:function(e){var t=new i.Sphere,r=new i.Box3,n=this._matrix;function a(e,i){return!(e&&!i)&&(!e||(t.copy(e),n&&t.applyMatrix4(n),!!i.containsSphere(t)))}function s(e,t){return!(e&&!t)&&(!e||(r.copy(e),n&&r.applyMatrix4(n),!!t.containsBox(r)))}return this._updateBoundingElements(),a(this._bsShow,e._bsShow)&&s(this._bbShow,e._bbShow)&&a(this._bsNoShow,e._bsNoShow)&&s(this._bbNoShow,e._bbNoShow)},updateBoundingElements_internal:function(e,t,i,r){if(!this._getForceBoundingElements()){var n=null,a=null;if(this.children.length){var s,o,l,h=0;for(h=0;h<this.children.length;h++)(s=this.children[h]).getExcludeFromBounding()||(o=s[e],l=s[t],s._getVisibilityFree()?s._getVisible()&&(n=i(n,o,s._matrix,s.getRatio()),a=i(a,o,s._matrix,s.getRatio())):s._getVisible()?(n=i(n,o,s._matrix,s.getRatio()),a=i(a,l,s._matrix,s.getRatio())):(a=i(a,o,s._matrix,s.getRatio()),a=i(a,l,s._matrix,s.getRatio())))}else this.getHasExplicitBE()&&(n=this[r],a=null);this[e]=n,this[t]=a}},getRatio:function(){return 0},updateBoundingSphere:function(){this._invalidateBoundingElements(!1,!1)},updateBoundingSphereFromParentToChildren:function(){C.DEPRECATED_Method(new Error)},updateBoundingBox:function(){this._invalidateBoundingElements(!1,!1)},isIncludedIn:function(e){if(!this.bSphere.radius)return!0;var t=this.bSphere.clone();return this._matrix&&t.applyMatrix4(this._matrix),t.center.distanceTo(e.bSphere.center)+t.radius<=e.bSphere.radius},getMatrixWorld:function(e){if(m)return null;var t,a;if(1===this._occurrences.length)return this._occurrences[0].matrix?this._occurrences[0].matrix.clone():new i.Matrix4;if(void 0===e)return console.warn("This node is an instance. An occurrence path has to be specified."),null;if(e instanceof r){var s=new n;s.setFromOccurrencePath(e),e=s}if((a=e._getOccurrences()).length>1)return console.warn("More than one occurrence satisfies this occurrence path. Unable to return a unique matrixWorld."),null;if(!a.length)return console.warn("No occurrence satisfies this occurrence path. Unable to return a matrixWorld."),null;for(t=0;t<this._occurrences.length;t++)if(a[0]===this._occurrences[t])return a[0].matrix?a[0].matrix.clone():new i.Matrix4;return console.warn("The occurrence path has to terminate with the current node name. Unable to return a matrixWorld."),null},isInstance:function(){return this._occurrences.length>1},buildAccelerationStructure:function(e){for(var t=this._occurrences.length,i=0;i<t;i++)for(var r=this._occurrences[i]._getRenderableOccurrences(),n=0;n<r.length;n++){r[n].computeKDTree(e)}},setScene:function(e){var t,i,r,n,a,s;for(t=this._occurrences.length,a=0;a<t;a++)(r=this._occurrences[a]).scene3js=e;for(a=0;a<t;a++)for(i=(r=this._occurrences[a]).children.length,s=0;s<i;s++)n=r.children[s],this._updateOccurrences(r,n,!0)},subscribe:function(e,t){void 0===this.modelEvents&&(this.modelEvents=new s),this.modelEvents.subscribe(e,t)},isReady:function(){return!0},_updateMatrix:function(e){var t,i,r,n,a,s,o;for(t=this._occurrences.length,a=0;a<t;a++)if((r=this._occurrences[a]).updateMatrix(this._matrix),null!==r.renderable){var l;if(r.renderable.setMatrix(r.matrix,!1),r.renderable.orientation=!r.matrix||r.matrix.determinant()>0?1:-1,void 0!==r.renderable.highlightMeshes&&null!==r.renderable.highlightMeshes)for(l=0;l<r.renderable.highlightMeshes.length;l++)r.renderable.highlightMeshes[l].renderable.setMatrix(r.matrix,!1);if(void 0!==r.renderable.preHighlight&&null!==r.renderable.preHighlight&&r.renderable.preHighlight.setMatrix(r.matrix,!1),r.scene3js&&r.scene3js.viewer&&r.renderable.castShadow)for(var h=0;h<r.scene3js.parent.__lights.length;h++){var c=r.scene3js.parent.__lights[h];c.blockUpdate||(c.updateShadowMap=!0)}}for(a=0;a<t;a++)for(i=(r=this._occurrences[a]).children.length,r.overrideLink&&(r.overrideLink.setMatrixUpdate(),r.requestOverridesUpdate()),s=0;s<i;s++)n=r.children[s],this._updateOccurrences(r,n,!0,e,!0);if(!e)for(a=0,o=this.parents.length;a<o;a++)this.getExcludeFromBounding()||this.parents[a]._invalidateBoundingElements(!1,!1)},_copyTree:function(e){var t,i,r,n,a;for(t=e.lightCopy(),e.node._occurrences.push(t),e._invalidateBoundingElements(!1),r=e.children.length,a=0;a<r;a++)n=e.children[a],(i=this._copyTree(n)).parent=t,t.children.push(i),t._invalidateBoundingElements(!1);return t},_deleteTree:function(e){var t,i,r,n,a;-1!==(i=(t=e.node)._occurrences.indexOf(e))&&t._occurrences.splice(i,1),null!==e.renderable&&null!==e.scene3js&&("Mesh3D"===e.node.getNodeType()||"ParticlesNode3D"===e.node.getNodeType()?e.scene3js.containsObject(e.renderable)&&(this._removeFromVisuSelection(e.renderable),e.scene3js.remove(e.renderable),"Mesh3D"===e.node.getNodeType()&&e.renderable.releaseVBO(!1)):"LightNode3D"===e.node.getNodeType()?e.scene3js.containsLight(e.renderable)&&e.scene3js.remove(e.renderable):"LensFlareNode3D"===e.node.getNodeType()?e.scene3js.containsLensFlare(e.renderable)&&e.scene3js.remove(e.renderable):"CSS2DNode"!==e.node.getNodeType()&&"CSS3DNode"!==e.node.getNodeType()||e.scene3js.containsObject(e.renderable)&&(e.scene3js.remove(e.renderable),e.renderable.element.parentNode&&e.renderable.element.parentNode.removeChild(e.renderable.element)));var s=e.scene3js&&e.scene3js.viewer;for(s&&2===s._sceneGraphStateVersion&&(e.originalOverrideSet&&(e.originalOverrideSet.onDetach(s,e),e.originalOverrideSet=null),e.overrideLink=null),e.scene3js=null,n=e.children.length,r=0;r<n;r++)a=e.children[r],this._deleteTree(a)},forceUpdate:function(){this._forceUpdate()},_forceUpdate:function(){var e,t,i=this._getAllOwningViewers();for(e=0;e<i.length;e++)i[e]&&this._tryOverridesUpdate(i[e]);if(this.parents.length>0)for(e=0;e<this._occurrences.length;e++)t=this._occurrences[e],this._updateOccurrences(t.parent,t,!0);else for(e=0;e<this.children.length;e++)this.children[e]._forceUpdate()},onLinkToSceneGraph:function(e){if(!m){var t,i,r=e.traverseUnique(function(e){}),n=[],a=[];for(t=0;t<r.length;t++)(i=r[t])._occurrences[0].__rdo_visited=0;for(t=0;t<r.length;t++){for(i=r[t],s=0;s<i.children.length;s++)i.children[s]._occurrences[0].__rdo_visited++}for(e._onLinkToSceneGraph_internal(!0,n,a),t=0;t<r.length;t++){var s;(i=r[t])._occurrences[0].__rdo_visited=0}for(t=n.length-1;t>=0;t--)(i=n[t])._onLinkedToSceneGraph(),i._requestClippingUpdate();for(t=a.length-1;t>=0;t--)(i=a[t])._onUnlinkedToSceneGraph(),i._requestClippingUpdate();null!==C._onLinkToSceneGraph_DEBUG&&C._onLinkToSceneGraph_DEBUG(r,n,a)}},_onLinkToSceneGraph_internal:function(e,t,i){var r,n=!1;if(!m){var a,s=e;for(r=0;!s&&r<this.parents.length;r++)(a=this.parents[r])._occurrences.length>0&&-1===a._occurrences[0].__rdo_visited&&(s=!0);if(s){for(r=0;r<this.parents.length;r++)if(this.parents[r].getLinkedToSceneGraph()){n=!0;break}var o;for(this.getLinkedToSceneGraph()!==n&&(this.setLinkedToSceneGraph(n),this._occurrences[0].__rdo_visited=-1,n?t.push(this):i.push(this)),r=0;r<this.children.length;r++)(o=this.children[r])._occurrences[0].__rdo_visited--,0===o._occurrences[0].__rdo_visited&&o._onLinkToSceneGraph_internal(!1,t,i)}}},_propagateGAS:function(e,t){t?e.gas?e.gas.copy(t):e.gas=t.clone():e.gas=null},_propagateMatApp:function(e,t){t?(e.matApp?e.matApp.copy(t):e.matApp=t.clone(),-1===e.matApp._depth&&(e.matApp._depth=e.depth)):e.matApp=null},_updateOccurrences:function(e,t,r,a,s){if(!m){var l,h,c,u;l=e.node,h=t.node,e.parent||(e.depth=0),t.depth=e.depth+1,t._copyForceShowStatusFromOcc(e),c=t.scene3js;var p=null,f=null,g=null,v=null,y=null,S=null,_=null,b=null,w=!1,M=!1,P=!1;if(t.overrideLink){if(t.renderable&&(t.overrideLink.internalMaterialOverrideReset&&(t.overrideLink.internalMaterialOverrideReset=!1,t.renderable.layer=null),t.overrideLink.internalMaterialOverride&&t.originalOverrideSet)){var E=t.overrideLink.internalMaterialOverride;E.material&&((u=new n).setFromArray(t.originalOverrideSet.pathElement.externalPath,E.internalPath),C._applyMaterialToPath(u,E.material)),t.overrideLink.internalMaterialOverrideReset=!0}p=t.overrideLink.getSubstituteMatrix(),f=t.overrideLink.getVisibility(),S=t.overrideLink.getVisibilityFree(),g=t.overrideLink.getPickability(),v=t.overrideLink.getPickingPriorityID(),y=t.overrideLink.getClipping(),_=t.overrideLink.getRenderStyle(),M=t.overrideLink.visibilityFix,t.originalOverrideSet&&t.originalOverrideSet.invalidateBE&&(t.originalOverrideSet.unsetInvalidateBE(),w=!0),t.overrideLink.getMatrixUpdate()&&(t.overrideLink.clearMatrixUpdate(),P=!0),f&&t.overrideLink.getForceShowVisibility()&&!f.visibility&&t._setForceShowHide(!0),g&&t.overrideLink.getForceShowPickability()&&("NOT_PICKABLE"===g?t._setForceShowNoPickability(!0):"IGNORED"===g&&(t._setForceShowNoPickability(!0),t._setForceShowNoDrawHL(!0)))}t.setIsInBackground(e.isInBackground()&&h.isInBackground()),t._setIsAlwaysInForeground(e._isAlwaysInForeground()||h._isAlwaysInForeground());var T=null;if(t&&t.originalOverrideSet&&(t.originalOverrideSet.hasMaterialOverride()||t.originalOverrideSet.internalMaterialOverride)&&(T=t.overrideLink),2===e._relativeVisibility&&(t._relativeVisibility=e._relativeVisibility),null!==t._relativeVisibility&&(M=2!==t._relativeVisibility,f={visibility:t._relativeVisibility}),null!==t){if(t.scene3js=e.scene3js,r||h._isDynamic||P)if(p)t.updateMatrix(p,!0);else{if(p=h._matrix,h._isDynamic&&t.scene3js){var D=t.scene3js.viewer.currentViewpoint;if(D){var I=h._getDynamicMatrix(e.matrix,null,D);I&&(p=I,h._matrix||(h._matrix=new i.Matrix4),h._matrix.copy(p),a||h._invalidateBoundingElements(!1,!1))}}t.localMatrixOverride&&(w=!0),t._relativeMatrix&&(p=t._relativeMatrix),t.updateMatrix(p)}b=e.getViewer(),t.renderMode=_?_._combineRenderMode(e.renderMode,h._renderMode):h._renderMode||e.renderMode,t.pickingMode=h._pickingMode||e.pickingMode,t.layerFilter=h._layerFilter?h._layerFilter:e.layerFilter,t.renderable&&(t.renderable.filtered=t._isFiltered()),t._setAdvancedPriority(h._getAdvancedPriority()?h._getAdvancedPriority():e._getAdvancedPriority()),t._setDepthMode(h._getDepthMode()?h._getDepthMode():e._getDepthMode()),b&&b.currentViewpoint&&b.currentViewpoint.isNative2D()&&b.currentViewpoint._depthMode&&(h._gas?h._depthPriority=h._gas._priority-4+l._depthPriority:h._depthPriority=l._depthPriority);var R=_;t.faceMode=R&&R._combineFaceMode(e.faceMode)||e.faceMode;var O=h.passes?h.passes:e.passes;t.forcePasses&&(O=t.forcePasses);var L=t.scene3js&&t.scene3js.parent instanceof i.Scene?t.scene3js.parent:null;if(t.renderable&&t.renderable.fromLoadedModel){var V=b&&b._renderStyle,F=t.faceMode&&t.faceMode.face||V&&V._faceMode;F===d.FaceModes.ZONLY?O=["ZOnly"]:F===d.FaceModes.BACKGROUND&&(O=["background"])}var B=O,N=null;(t.renderPriority||e.renderPriority)&&(N=function(e,t){if(!t)return e&&(e.userPriority||e.userOpacity)?{userPriority:!1,priority:e.priority,userOpacity:!1,opacity:e.opacity,lastRenderPriority:e.lastRenderPriority}:{userPriority:e.userPriority,priority:e.priority,userOpacity:e.userOpacity,opacity:e.opacity,lastRenderPriority:e.lastRenderPriority};if(!e)return{userPriority:t.userPriority,priority:t.priority,userOpacity:t.userOpacity,opacity:t.opacity,lastRenderPriority:t.lastRenderPriority};return{userPriority:t.userPriority,priority:t.userPriority?t.priority:e.priority,userOpacity:t.userOpacity,opacity:t.userOpacity?t.opacity:e.opacity,lastRenderPriority:t.lastRenderPriority}}(e.renderPriority,t.renderPriority));var G=b&&b._renderPriorityManager&&b._renderPriorityManager.enabled;t.renderPriority=N;var k=-1;G&&(N||(N={userPriority:!1,priority:0,userOpacity:!1,opacity:-1,lastRenderPriority:-1},t.renderPriority=N),B=function(e,t){if(!e||1===e.length&&"main"===e[0])return A[t];var i,r,n=[];for(i=0;i<e.length;i++)"main"===(r=e[i])?n=n.concat(A[t]):n.push(r);return n}(O,k=N&&N.priority||0));var U,z=B!==t.passes||t.renderPriority&&k!==t.renderPriority.lastRenderPriority;if(t.renderPriority&&(t.renderPriority.lastRenderPriority=k),t.renderable&&L&&z&&L.updateObjectPasses(t.renderable,B),t.passes=O,h._isDecal)t.material=h._material,(U=t._getMaterialApplication())&&this._propagateMatApp(t,U);else e.material&&"forceGeomTypeFACE"===e.material.force?t.material=h._material||e.material:t.material=null!==e.material?e.material:h._material,t.forceGAS?t.gas=t.forceGAS:(e.gas&&!h._gas?this._propagateGAS(t,e.gas):this._propagateGAS(t,h._gas),e.gas&&h._gas&&t.gas.merge(e.gas,l._filters&&l._filters.get(x.GAS_INHERIT))),(U=t._getMaterialApplication())&&e.matApp?U.isPrioritary(e.matApp,t.depth)?this._propagateMatApp(t,U):this._propagateMatApp(t,e.matApp):U?this._propagateMatApp(t,U):this._propagateMatApp(t,e.matApp);t._setInvertMode(!f&&(e._getInvertMode()||h._getInvertMode())),t._setInvertPickMode(!g&&(e._getInvertPickMode()||h._getInvertPickMode()));var H=t._getVisible(),W=t._getVisibilityFree();M?(t._setVisible(Ee(e._getVisible(),f,f&&f.visibility,h._getVisible(),t.overrideLink&&t.overrideLink.getForceShowVisibility(),t._getForceShowHide())),t._setPickable(Ee(e._getPickable(),g,"PICKABLE"===g,h._getPickable(),t.overrideLink&&t.overrideLink.getForceShowPickability(),t._getForceShowNoPickability())),t.setNoPickThrough(Ee(e.getNoPickThrough(),g,"IGNORED"!==g,h.getNoPickThrough(),t.overrideLink&&t.overrideLink.getForceShowPickability(),t._getForceShowNoDrawHL())),t._setVisibilityFree(e._getVisibilityFree()||(S?S.visibilityFree:h._getVisibilityFree()))):(t._setVisible(f?f.visibility:e._getVisible()&&h._getVisible()),t._setVisibilityFree(e._getVisibilityFree()||h._getVisibilityFree()),t._setPickable(g?"PICKABLE"===g:e._getPickable()&&h._getPickable()),t.setNoPickThrough(g?"IGNORED"!==g:e.getNoPickThrough()&&h.getNoPickThrough())),t._setNoZPriority(e._getNoZPriority()||h._getNoZPriority()),h._propagateVisuFilters(t,e._filters),t._propagateSubstituteMaterials(e.__solvedSubstituteMaterials),e._filters&&e._filters.has(x.DO_NOT_PICK_UNDER)&&h.setPickParent(e._filters.get(x.DO_NOT_PICK_UNDER)._doNotPickUnder),t._getVisible()!==H&&t.updateVisibilityFlag(),t._getVisibilityFree()!==W&&t.updateVisibilityFreeFlag(),e.pickingPriorityID&&e.pickingPriorityID._override?t.pickingPriorityID=e.pickingPriorityID:t.pickingPriorityID=v||(h.pickingPriorityID?h.pickingPriorityID:e.pickingPriorityID),l._getPropagateXSOExclusion()&&(h._setPropagateXSOExclusion(!0),h._setExcludeFromCSO(l._getExcludeFromCSO()),h._setExcludeFromHSO(l._getExcludeFromHSO()),h._setExcludeFromPSO(l._getExcludeFromPSO()),h._setExcludeFromHL(l._getExcludeFromHL()),h._setExcludeFromPreHL(l._getExcludeFromPreHL()))}if(null!==t.renderable){if(!s&&t.renderable._flagAsGSSOInvalidated(),t.renderable.setMatrix(t.matrix,!1),t.renderable._ratioData=h._ratioData,t.renderable._billboardData=h._billboardData,t.renderable.orientation=!t.matrix||t.matrix.determinant()>0?1:-1,t.renderable._noZPriority=t._getNoZPriority(),b&&b.currentViewpoint&&b.currentViewpoint.isNative2D()?b.currentViewpoint._depthMode?(t.renderable._priorityMode=i.PriorityMode.DepthPriority,t.renderable._depthPriority=h._depthPriority):t.renderable._priorityMode=i.PriorityMode.ClassicPriority2D:t._getDepthMode()?t._getAdvancedPriority()?t.renderable._priorityMode=i.PriorityMode.Advanced:t.renderable._priorityMode=i.PriorityMode.ClassicPriority:t.renderable._priorityMode=i.PriorityMode.SceneGraphOrder,t.renderable._advancedPriority=t.advancedPriority,t.renderable._noZPriority||t.passes){var j=!!t._filters&&t._filters.has(x.LOOK)&&!!t._filters.get(x.LOOK).material,X="_refplaneitem_"===h.name;if(j||X){if(t.passes){var q=t.passes.indexOf("noz");-1!==q&&(t.passes=t.passes.slice(),t.passes[q]="main",L&&L.updateObjectPasses(t.renderable,t.passes))}t.renderable._noZPriority=!1}}h._isDecal?t.renderable._programID|=i.ProgramIDs.DECALS:t.renderable._programID&=~i.ProgramIDs.DECALS;b=null;var Z=t.renderable.highlightMeshes;if(null!=Z){b=t.scene3js&&t.scene3js.viewer;var Y,Q=t._getVisible()&&!t._getInvertMode(),K=t._getVisibilityFree();for(ie=0;ie<Z.length;ie++)(Y=Z[ie].renderable).setMatrix(t.matrix,!1),b&&b.picking.forceVisibility||(Y.visible=Q,Y.visibilityFree=K),Y._ratioData=h._ratioData,Y._billboardData=h._billboardData}if(void 0!==t.renderable.preHighlight&&null!==t.renderable.preHighlight&&(b||(b=t.scene3js&&t.scene3js.viewer),t.renderable.preHighlight.setMatrix(t.matrix,!1),b&&b.pPicking.forceVisibility||(t.renderable.preHighlight.visible=t._getVisible()&&!t._getInvertMode(),t.renderable.preHighlight.visibilityFree=t._getVisibilityFree()),t.renderable.preHighlight._ratioData=h._ratioData,t.renderable.preHighlight._billboardData=h._billboardData),t.renderable instanceof i.CSS2DNode||t.renderable instanceof i.CSS3DNode){var J=!0;this._getViewer()&&(J=this._getViewer().visibleSpace);(t._getVisibilityFree()?t._getVisible()&&!t._getInvertMode():J?t._getVisible()&&!t._getInvertMode():!(t._getVisible()&&!t._getInvertMode()))||(t.renderable.element.style.display="none")}if(i.disableJHGDev)null!==t.material&&(t.renderable.material=t.material);else if(!t.material&&t.renderable._3dxmlMaterial)t.renderable.material=t.renderable._3dxmlMaterial;else{var $=t.renderable.material;$&&$.canvasNodeTextureSize||(t.renderable.material=t.material)}if(t.renderable.matApp=t.matApp,t.renderable.gas=t.gas,t.renderable.visible=t._getVisible()&&!t._getInvertMode(),t.renderable.visibilityFree=t._getVisibilityFree(),t.renderable.pickable=t._getPickable()&&!t._getInvertPickMode(),t.renderable.noPickThrough=t.getNoPickThrough()&&!t._getInvertPickMode(),t.renderable.pickingPriorityID=t.pickingPriorityID,null!==t.scene3js){if("Mesh3D"===t.node.getNodeType()||"ParticlesNode3D"===t.node.getNodeType()||"CSS3DNode"===t.node.getNodeType()||"CSS2DNode"===t.node.getNodeType()?t.scene3js.containsObject(t.renderable)||(t.scene3js.add(t.renderable,t.passes),"Mesh3D"===t.node.getNodeType()&&t.renderable.addRefVBO(!1)):"LightNode3D"===t.node.getNodeType()?t.scene3js.containsLight(t.renderable)||t.scene3js.add(t.renderable):"LensFlareNode3D"===t.node.getNodeType()&&(t.scene3js.containsLensFlare(t.renderable)||t.scene3js.add(t.renderable)),t.scene3js.viewer&&(t.scene3js.viewer._lockRenderIteration||(t.scene3js.viewer.renderIteration=0),t.renderable.castShadow))for(var ee=0;ee<t.scene3js.parent.__lights.length;ee++){var te=t.scene3js.parent.__lights[ee];te.blockUpdate||(te.updateShadowMap=!0)}}else null!==c&&("Mesh3D"===t.node.getNodeType()||"ParticlesNode3D"===t.node.getNodeType()?c.containsObject(t.renderable)&&(this._removeFromVisuSelection(t.renderable),c.remove(t.renderable),"Mesh3D"===t.node.getNodeType()&&t.renderable.releaseVBO(!1)):"LightNode3D"===t.node.getNodeType()?c.containsLight(t.renderable)&&c.remove(t.renderable):"LensFlareNode3D"===t.node.getNodeType()?c.containsLensFlare(t.renderable)&&c.remove(t.renderable):"CSS2DNode"!==t.node.getNodeType()&&"CSS3DNode"!==t.node.getNodeType()||c.containsObject(t.renderable)&&(c.remove(t.renderable),t.renderable.element.parentNode&&t.renderable.element.parentNode.removeChild(t.renderable.element)))}var ie,re=!!t.clippingContext,ne=!1,ae=y||h.clippingContext;if(t.clippingContext=ae?ae._mergeWithParent(e.clippingContext):e.clippingContext,t.clippingContext!==e.clippingContext&&(ne=!0),t.renderPriority!==e.renderPriority&&(ne=!0),t.clippingContext&&(re=!0),re&&(b||(b=e.getViewer()),b&&b._requestClippingUpdate()),T&&(e.occurrenceRenderingOverride&&e.occurrenceRenderingOverride.materialOverride&&e.occurrenceRenderingOverride.materialOverride===T||(ne=!0)),ne){t.occurrenceRenderingOverride=new o,t.occurrenceRenderingOverride.clipPlanes=t.clippingContext&&t.clippingContext.planes,t.occurrenceRenderingOverride.sectionLinesProperties=t.clippingContext&&t.clippingContext.sectionLinesProperties,t.occurrenceRenderingOverride.sectionCappingMaterials=t.clippingContext&&t.clippingContext.sectionCappingMaterials,t.occurrenceRenderingOverride.clippingContext=t.clippingContext,t.occurrenceRenderingOverride.clipCylinder=t.clippingContext&&t.clippingContext.cylinder;var se=t.clippingContext&&t.clippingContext._scissor;t.occurrenceRenderingOverride.scissor=se&&(se.getForOccurrenceOverride?se.getForOccurrenceOverride(t.matrix):se),t.occurrenceRenderingOverride.materialOverride=T||e.occurrenceRenderingOverride&&e.occurrenceRenderingOverride.materialOverride,t.occurrenceRenderingOverride.setRenderPriority(t.renderPriority),t.clippingContext&&t.clippingContext._clipPolyLine&&t.clippingContext.isClippingProfileEnabled()&&(t.occurrenceRenderingOverride.clipPolyLine=t.clippingContext._clipPolyLine.getForOccurrenceOverride(t.matrix))}else t.occurrenceRenderingOverride=e.occurrenceRenderingOverride;if(t.renderable)if(t.renderable.occurrenceRenderingOverride=t.occurrenceRenderingOverride,Z=t.renderable.highlightMeshes)for(ie=0;ie<Z.length;ie++)Z[ie].renderable.occurrenceRenderingOverride=t.occurrenceRenderingOverride;for(ie=0;ie<t.children.length;ie++)this._updateOccurrences(t,t.children[ie],r||h._isDynamic||P,a,s);return w&&e._invalidateBoundingElements(!1),!0}},_getOccurrencesFromOccurrencePath:function(e){var t,i,r,n,a,s,o,l,h;if(!e.path.length)return[];if(null===(t=this.getChildByName(e.path[0]))&&(t=this.getChildByName(e.path[0],1)),null===t)return[];for(a=t._occurrences,s=[],h=1;h<e.path.length;h++){for(i=e.path[h],o=0;o<a.length;o++)for(r=a[o].children,l=0;l<r.length;l++)(n=r[l]).node.name===i&&s.push(n);a=s,s=[]}return a},_getRenderableOccurrencesFromOccurrencePath:function(e){var t,i,r,n,a,s;for(t=this._getOccurrencesFromOccurrencePath(e),i=[],a=0;a<t.length;a++)for(n=t[a],r=this._getRenderableOccurrencesFromOccurrence(n),s=0;s<r.length;s++)i.push(r[s]);return i},_getRenderableOccurrencesFromOccurrence:function(e){var t,i,r,n,a;for(t=[],i=e.children,null!==e.renderable&&t.push(e.renderable),n=0;n<i.length;n++)for(r=this._getRenderableOccurrencesFromOccurrence(i[n]),a=0;a<r.length;a++)t.push(r[a]);return t},_removeFromVisuSelection:function(e){t.publish({event:"/VISU/SELECTION/REMOVE",data:e})},_removeInvalidElementsInXSO:function(e){var t,i,r=[WUX.Selection.CSOManager,WUX.Selection.HSOManager,WUX.Selection.PSOManager];for(t=0;t<r.length;t++){var n=r[t],a=[],s=n.get();for(i=0;i<s.length;i++){var o=s[i],l=o.pathElement;if(!l&&o.options&&(l=o.options.pathElement),l){var h=l._getIndexFromNode(this);if(-1===h)l.getElement(0,!0);else l.getElement(h+1,!0)===e&&a.push(o)}}for(i=0;i<a.length;i++)n.remove(a[i])}},addAsyncDependancies:function(e){console.warn("The addAsyncDependancies function doesn't do anything anymore: it shouldn't be called anymore.")},onAsyncDependancyCompleted:function(){this._onAllAsyncDependanciesCompleted()},_onAllAsyncDependanciesCompleted:function(){void 0!==this.modelEvents&&this.modelEvents.publish("onReady")},_onLinkedToSceneGraph:function(){},_onUnlinkedToSceneGraph:function(){},setNoZ:function(e){this.setRenderPasses(e?["noz"]:["main"])},setNoEffectNoZ:function(e){this.setRenderPasses(e?["noEffectNoz"]:["main"])},setNoHighlightNoZ:function(e){this.setRenderPasses(e?["afterHighlightNoZ"]:["main"])},setAsNativeIsoBag:function(e){switch(e){case 0:this.setRenderPasses(["iso_0"]);break;case 2:this.setRenderPasses(["iso_2"]);break;case 3:this.setRenderPasses(["iso_3"]);break;case 1:default:this.setRenderPasses(["main"])}},getNativeIsoLevel:function(){if(!this.passes||!this.passes.length)return 1;switch(this.passes[0]){case"iso_0":return 0;case"main":return 1;case"iso_2":return 2;case"iso_3":return 3}},setAsNativeDialog:function(e){if(this.setRenderPasses(e?["dialog"]:["main"]),e){this.propagateXSOExclusion(!0),this.exludeFromBounding(!0),this.excludeFromHSO(!0),this.excludeFromHighlight(!0),this.excludeFromPSO(!0);var t=this.createOverrideSetManager(),i=t.createSceneGraphOverrideSet();t.pushSceneGraphOverrideSet(i);var r=i.createOverride(new n([this])),a=new h([]);a.setUncut(!0),r.setClippingContext(a);var s=new d;s.setRenderMode("Face",!0),s.setRenderMode("@Edge",!1),s.setRenderMode("@Point",!1),s.setRenderMode("Outline",!1),s.setFaceMode("MATERIAL"),r.setRenderStyle(s)}else this.exludeFromBounding(!1),this.excludeFromHSO(!1),this.excludeFromHighlight(!1),this.excludeFromPSO(!1),this.enableLocalRenderEdgeMode(!1),this.removeOverrideSetManager();this._forceUpdate()},setAsNativeOnTop:function(e){this.setRenderPasses(e?["onTop"]:["main"]);let t=this._getViewer();t&&t.renderer.renderer.requestPoliteDepthBuffer()},setAsNativeFurtive:function(e){if(this.setRenderPasses(e?["furtive"]:["main"]),e){var t=this.createOverrideSetManager(),r=t.createSceneGraphOverrideSet();t.pushSceneGraphOverrideSet(r);var a=r.createOverride(new n([this])),s=new u({lineMaterial:new i.LineBasicMaterial({color:16760604,lineWidth:1}),faceMaterial:new i.MeshBasicMaterial({color:16760604}),pointMaterial:new i.ParticleBasicMaterial({color:16760604,size:1,opacity:1})});a.setMaterial(s,!0)}else this.removeOverrideSetManager()},setRenderPasses:function(e){var t,i=e.concat([]);for(t=0;t<e.length;t++)e[t]&&e[t]._getIdString&&(i[t]=e[t]._getIdString());var r=e=i;4===e.length&&e.indexOf("colorOld")>=0&&e.indexOf("depthOld")>=0&&e.indexOf("colorOldCapping")>=0&&e.indexOf("depthOldCapping")>=0&&(r=["compareOld"]),2===e.length&&e.indexOf("depthNew")>=0&&e.indexOf("depthNewCapping")>=0&&(r=["compareNew"]),this.passes=r,this._forceUpdate()},setRenderLineMode:function(e){var t=this._renderMode;t||((t=new c)._useRenderPointMask=!1,t._useRenderFaceMask=!1,this._renderMode=t),t._setRenderLineMode(e),this._requestOverridesUpdate()},enableLocalRenderEdgeMode:function(e){var t=null;e&&((t=new c({renderLineMode:i.HideAllRenderLineMode}))._useRenderFaceMask=!1,t._useRenderPointMask=!1),this._renderMode=t,this._requestOverridesUpdate()},setRenderMode:function(e,t){!e||e.indexOf("Edge")<0||this._renderMode&&(this._renderMode.setRenderMode(e,t),this._requestOverridesUpdate())},setAdvancedPriority:function(e){this._setAdvancedPriority(e)},setZDepthMode:function(e){this._setDepthMode(e)},setLayerFilter:function(e,t){if(this._layerFilter){switch(t){case i.FilterMode.Cumulative:for(r=0;r<e.length;r++)this._layerFilter[r]=this._layerFilter[r]&&(e[r]?1:0);break;case i.FilterMode.None:case i.FilterMode.Replace:case i.FilterMode.V4Master:default:if(1024!==e.length){this._layerFilter=new Array(1024);for(r=0;r<e.length;r++)this._layerFilter[r]=e[r]}else this._layerFilter=e}this._forceUpdate()}else{if(1024!==e.length){this._layerFilter=new Array(1024);for(var r=0;r<e.length;r++)this._layerFilter[r]=e[r]}else this._layerFilter=e;this._forceUpdate()}},setLayerNumber:function(e){this._layer=e,this._forceUpdate()},_propagateVisuFilters:function(e,t){t?(e._filters=new Map,t.forEach(function(t,i,r){t&&!b.has(i)&&e._filters.set(i,t)})):e._filters=null,this._filters&&(e._filters=e._filters||new Map,this._filters.forEach(function(t,i,r){t&&!b.has(i)&&e._filters.set(i,t)}))},setVisuFilters:function(e){this._filters||(this._filters=new Map);var t=!1;if(void 0!==e.gasInheritFilter&&(this._filters.set(x.GAS_INHERIT,e.gasInheritFilter),e.gasInheritFilter||this._filters.delete(x.GAS_INHERIT),t=!0),void 0!==e.polygonOffsetFilter&&(this._filters.set(x.POLYGON_OFFSET,e.polygonOffsetFilter),e.polygonOffsetFilter||this._filters.delete(x.POLYGON_OFFSET),t=!0),void 0!==e.zModeFilter&&(this._filters.set(x.ZMODE,e.zModeFilter),e.zModeFilter||this._filters.delete(x.ZMODE),t=!0),void 0!==e.lookFilter&&(this._filters.set(x.LOOK,e.lookFilter),e.lookFilter||this._filters.delete(x.LOOK),t=!0),void 0!==e.geomTypeFilter&&(this._filters.set(x.GEOM_TYPE,e.geomTypeFilter),(!e.geomTypeFilter||e.geomTypeFilter._geomType<0)&&this._filters.delete(x.GEOM_TYPE),t=!0),void 0!==e._staticGeomTypeFilter&&(this._filters.set(x._STATIC_GEOM_TYPE,e._staticGeomTypeFilter),(!e._staticGeomTypeFilter||e._staticGeomTypeFilter._geomType<0)&&this._filters.delete(x._STATIC_GEOM_TYPE),t=!0),void 0!==e.furtiveFilter&&(e.furtiveFilter?this._filters.set(x.FURTIVE,!0):this._filters.delete(x.FURTIVE),t=!0),void 0!==e._materialToUseFilter&&(this._filters.set(x._MATERIAL_TO_USE,e._materialToUseFilter),(!e._materialToUseFilter||e._materialToUseFilter.materialToUse<0)&&this._filters.delete(x._MATERIAL_TO_USE),t=!0),e.doNotPickUnderFilter&&(this._filters.set(x.DO_NOT_PICK_UNDER,e.doNotPickUnderFilter),t=!0),t){var i=this._filters.has(x.DO_NOT_PICK_UNDER)&&!this._filters.get(x.DO_NOT_PICK_UNDER)._doNotPickUnder;i&&this._forceUpdate(),i&&this._filters.delete(x.DO_NOT_PICK_UNDER),0===this._filters.size&&(this._filters=null),this._forceUpdate()}},setPickingMode:function(e){this._pickingMode=e,this._requestOverridesUpdate()},getLocalBoundingBox:function(){if(m)return new i.Box3(new i.Vector3(0,0,0),new i.Vector3(0,0,0));var e=new i.Matrix4,t=new i.Matrix4,r=new i.Vector3,n=null,a=null,s=this._occurrences[0],o=s.matrix;e.getInverse(o);for(var l=s._getRenderableOccurrences(),h=0;h<l.length;h++){var c=l[h];t.multiplyMatrices(e,c.matrix);for(var d=0;d<c.geometry.length;d++){var u=c.geometry[d].vertexPositionArray;if(u){var p=u.length;if(p>=3){n||(r.set(u[0],u[1],u[2]),r.applyMatrix4(t),n=(new i.Vector3).copy(r),a=(new i.Vector3).copy(r));for(var f=0;f<p;f+=3)r.set(u[f],u[f+1],u[f+2]),r.applyMatrix4(t),r.x<n.x&&(n.x=r.x),r.y<n.y&&(n.y=r.y),r.z<n.z&&(n.z=r.z),r.x>a.x&&(a.x=r.x),r.y>a.y&&(a.y=r.y),r.z>a.z&&(a.z=r.z)}}}}return new i.Box3(n,a)},enableClippingPlane:function(e,t){var i,r;if(t){if(this.clippingContext||(this.clippingContext=new h),this.clippingContext.addPlane(e))for(this._forceUpdate(),r=this._getAllOwningViewers(),i=0;i<r.length;i++)r[i]._addClippingPlane(e)}else if(this.clippingContext&&this.clippingContext.removePlane(e))for(this._forceUpdate(),r=this._getAllOwningViewers(),i=0;i<r.length;i++)r[i]._removeClippingPlane(e)},disableClipping:function(e){this.clippingContext||(this.clippingContext=new h),this.clippingContext.setExcludeFromClippingPlanes(e?["all"]:[]),this._forceUpdate()},setSectionCappingMaterial:function(e,t){this.clippingContext||(this.clippingContext=new h),this.clippingContext.setSectionCappingMaterial(e,t),this.requestOverridesUpdate()},deleteSectionCappingMaterial:function(e){if(this.sectionCappingMaterials){var t=e||null,i=0;for(i=0;i<this.sectionCappingMaterials.length;i++)this.sectionCappingMaterials[i].clippingPlane===t&&this.sectionCappingMaterials.splice(i,1);this.sectionCappingMaterials.length||(this.sectionCappingMaterials=null)}},getSectionCappingMaterial:function(e){return this.clippingContext&&this.clippingContext.getSectionCappingMaterial(e)},removeSectionCappingMaterial:function(e){this.clippingContext&&this.clippingContext.removeSectionCappingMaterial(e)},requestOverridesUpdate:function(){var e=0;for(e=0;e<this._occurrences.length;e++)this._occurrences[e].requestOverridesUpdate()},excludeFromCSO:function(e){this._setExcludeFromCSO(e)},excludeFromHSO:function(e){this._setExcludeFromHSO(e)},excludeFromPSO:function(e){this._setExcludeFromPSO(e)},excludeFromHighlight:function(e,t){this._setExcludeFromHL(e),this._setExcludeFromPreHL(t)},propagateXSOExclusion:function(e){this._setPropagateXSOExclusion(e)},createRenderable:function(){return null},add:function(){this.addChild.apply(this,arguments)},remove:function(){this.removeChild.apply(this,arguments)},_requestOverridesUpdate:function(){var e;for(e=0;e<this._occurrences.length;e++)this._occurrences[e].requestOverridesUpdate()},_requestClippingUpdate:function(){var e,t=this._getAllOwningViewers();for(e=0;e<t.length;e++)t[e]._requestClippingUpdate()},setClippingCylinder:function(e){if(!this.clippingContext){if(!e)return;this.clippingContext=new h}this.clippingContext.cylinder=e?{center:e.center,axisU:e.axisU.clone(),axisV:e.axisV.clone(),clipOutside:null===e.clipOutside||void 0===e.clipOutside||e.clipOutside}:null,this._requestClippingUpdate(),this._requestOverridesUpdate()},setScissoringPolyLine:function(e){if(!this.clippingContext){if(!e)return;this.clippingContext=new h}e?this.clippingContext.setScissorPolyLine(!0,e):this.clippingContext.setScissorPolyLine(!1),this._requestClippingUpdate(),this._requestOverridesUpdate()},setClippingProfile:function(e){if(!this.clippingContext){if(!e)return;this.clippingContext=new h}e?this.clippingContext.setClippingProfile(e):this.clippingContext.setClippingProfile(null),this._requestClippingUpdate(),this._requestOverridesUpdate()},isPointOfViewDependant:function(){return!1},_setOverrideExistsTraverse:function(){!function e(t){var i;if(!t._getOverrideExists())for(t._setOverrideExists(!0),i=0;i<t.parents.length;i++)e(t.parents[i])}(this)},getPLMMaterialData:function(e){var t=this._PLMMaterialData;return e||null!==t||(this._PLMMaterialData=new p(this),t=this._PLMMaterialData),t},_getStaticOverrideSet:function(e){var t=this.getPLMMaterialData(!e);return t&&t._getStaticOverrideSet(e)},addStaticMaterialApplicationOverride:function(e,t){this._getStaticOverrideSet(!0).addStaticOverride(e,t),this._requestStaticOverridesUpdate()},clearStaticMaterialApplicationOverrides:function(){var e=this._getStaticOverrideSet();e&&(e.clear(),this._requestStaticOverridesUpdate())},_requestStaticOverridesUpdate:function(){var e,t;for(e=0;e<this._occurrences.length;e++)(t=this._occurrences[e].getViewer())&&(t._updateStaticOverrides=!0)},setLocalRenderEdgeMode:function(){this.setRenderMode.apply(this,arguments)},setUserData:function(e){this.userData=e},getUserData:function(e){return this.userData}});C.prototype._isMesh3D=!1,C.prototype._isDecal=!1;var P=0;C._LockNodeHierarchy=function(){P++},C._UnlockNodeHierarchy=function(){P--},C._applyMaterialToPath=function(e,t){if(null===e)return!1;var i=e._getRenderableOccurrences(),r=i.length;for(a=0;a<r;a++)(s=i[a])&&s._flagAsGSSOInvalidated();var n=e.getLastElement();if(null===n)return!1;if(n instanceof C)for(var a=0;a<r;a++){var s=i[a];null!==t?(s.userData.oldMaterial||(s.userData.oldMaterial=s.material),s.material=t):s.userData.oldMaterial&&(s.material=s.userData.oldMaterial)}else{if(1!==r)return!1;var o=[];if("rep"===n.getType()){var l=n.getChildren();for(a=0;a<l.length;a++)o.push(l[a].sgNode)}else"primitive"===n.getType()&&o.push(n.sgNode);null===i[0].layer&&i[0].initLayers(1),i[0].layer.addPrimitivesToLayers(o,1,t)}return!0},C.DEPRECATED_SceneGraph=function(e,t){if(0!==v&&(console.log("[SceneGraph] DEPRECATED API USE\n"+e.stack),v--),!window.I_solemnly_swear_I_am_up_to_no_good&&!t)throw e},C.DEPRECATED_Method=function(e,t){0!==v&&(console.log("[Node3D] DEPRECATED API USE\n"+e.stack),v--)},C.DEPRECATED_matrix=function(e){0!==v&&(console.warn("Node3D API : use getMatrix() accessor instead of .matrix  "+e.stack),--v||console.warn("Node3D API : too many errors, no more errors will be reported."))},Object.defineProperty(C.prototype,"root",{get:function(){return C.DEPRECATED_SceneGraph(new Error),this}}),Object.defineProperty(C.prototype,"bSphere",{get:function(){return this.getHasExplicitBE()?this.explicitBSphere:this.getBoundingSphere()},set:function(e){if(!this.getHasExplicitBE())throw new Error("bSphere is read-only");this.explicitBSphere=e}}),Object.defineProperty(C.prototype,"bBox",{get:function(){return this.getHasExplicitBE()||this.hasExplicitBE?this.explicitBBox:this.getBoundingBox()},set:function(e){if(!this.getHasExplicitBE()&&!this.hasExplicitBE)throw new Error("bBox is read-only");this.explicitBBox=e}}),Object.defineProperty(C.prototype,"matrix",{get:function(){return C.DEPRECATED_matrix(new Error),this._matrix},set:function(e){C.DEPRECATED_matrix(new Error),this._matrix=e}});var E=30;C.FORBIDDEN_ACCESS_occurrences=function(e){0!==E&&(console.log("[Node3D] INTERNAL PROPERTY ACCESS\nAccess to 'occurrences' member is strictly forbidden.\nYou must use authorized APIs.\nIf you are trying to create a pathElement using setFromOccurrence, please consider using ?new PathElement([node3d])? instead.\n"+e.stack),E--)},Object.defineProperty(C.prototype,"occurrences",{get:function(){return C.FORBIDDEN_ACCESS_occurrences(new Error),this._occurrences},set:function(e){C.FORBIDDEN_ACCESS_occurrences(new Error),this._occurrences=e}}),Object.defineProperty(C.prototype,"clippingPlanes",{get:function(){return this.clippingContext&&this.clippingContext.planes},set:function(){}});var A=[["renderPriority","p0"],["renderPriority","p1"],["renderPriority","p2"],["renderPriority","p3"],["renderPriority","p4"]];C.REFERENCE_NODE=-1,C.INSTANCE_NODE=-2,C.REPRESENTATION_NODE=-3,C.TILESET_NODE=-4,C._onLinkToSceneGraph_DEBUG=null;var T=1,D=2,I=4,R=8,O=16,L=32,V=64,F=128,B=256,N=512,G=1024,k=2048,U=4096,z=8192,H=16384,W=32768,j=65536;function X(e){return function(){return(this.occBooleanAttr&e)>0}}function q(e){return function(t){this.occBooleanAttr=t?this.occBooleanAttr|e:this.occBooleanAttr&~e}}w.prototype._getVisible=X(T),w.prototype._setVisible=q(T),w.prototype._getVisibilityFree=X(D),w.prototype._setVisibilityFree=q(D),w.prototype._getPickable=X(I),w.prototype._setPickable=q(I),w.prototype._getNoZPriority=X(F),w.prototype._setNoZPriority=q(F),w.prototype.getNoPickThrough=X(R),w.prototype.setNoPickThrough=q(R),w.prototype._getNeedBEUpdate=X(O),w.prototype._setNeedBEUpdate=q(O),w.prototype._getNeedOverridesUpdate=X(L),w.prototype._setNeedOverridesUpdate=q(L),w.prototype._getDescendantNeedsOverridesUpdate=X(V),w.prototype._setDescendantNeedsOverridesUpdate=q(V),w.prototype._getForceShowHide=X(B),w.prototype._setForceShowHide=q(B),w.prototype._getForceShowNoPickability=X(N),w.prototype._setForceShowNoPickability=q(N),w.prototype._getForceShowNoDrawHL=X(G),w.prototype._setForceShowNoDrawHL=q(G),w.prototype.isInBackground=X(k),w.prototype.setIsInBackground=q(k),w.prototype._isAlwaysInForeground=X(U),w.prototype._setIsAlwaysInForeground=q(U),w.prototype._getAdvancedPriority=X(H),w.prototype._setAdvancedPriority=q(H),w.prototype._getDepthMode=X(z),w.prototype._setDepthMode=q(z),w.prototype._getInvertMode=X(W),w.prototype._setInvertMode=q(W),w.prototype._getInvertPickMode=X(j),w.prototype._setInvertPickMode=q(j),w.prototype._copyForceShowStatusFromOcc=function(e){var t=B|N|G;this.occBooleanAttr=this.occBooleanAttr&~t|e.occBooleanAttr&t},Object.defineProperty(w.prototype,"visible",{get:function(){return this._getVisible()},set:function(e){this._setVisible(e)}}),Object.defineProperty(w.prototype,"visibilityFree",{get:function(){return this._getVisibilityFree()},set:function(e){this._setVisibilityFree(e)}}),Object.defineProperty(w.prototype,"pickable",{get:function(){return this._getPickable()},set:function(e){this._setPickable(e)}}),Object.defineProperty(w.prototype,"drawInHLRender",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(w.prototype,"noPickThrough",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(w.prototype,"_needBEUpdate",{get:function(){return this._getNeedBEUpdate()},set:function(e){this._setNeedBEUpdate(e)}}),Object.defineProperty(w.prototype,"_needOverridesUpdate",{get:function(){return this._getNeedOverridesUpdate()},set:function(e){this._setNeedOverridesUpdate(e)}}),Object.defineProperty(w.prototype,"_descendantNeedsOverridesUpdate",{get:function(){return this._getDescendantNeedsOverridesUpdate()},set:function(e){this._setDescendantNeedsOverridesUpdate(e)}}),C.SceneGraphOverrideSetManager=null;var Z=1,Y=2,Q=4,K=8,J=16,$=32,ee=64,te=128,ie=256,re=512,ne=1024,ae=2048,se=4096,oe=8192,le=16384,he=32768,ce=65536,de=1<<17,ue=1<<18,pe=1<<19,fe=1<<20,ge=1<<21,me=1<<22,ve=1<<23,ye=1<<24,Se=1<<25,_e=1<<26,xe=1<<27,be=1<<28,we=1<<29,Me=1<<30;function Ce(e){return function(){return(this.node3DBooleanAttr&e)>0}}function Pe(e){return function(t){this.node3DBooleanAttr=t?this.node3DBooleanAttr|e:this.node3DBooleanAttr&~e}}function Ee(e,t,i,r,n,a,s){return!a&&!s&&(!(!n||!t)||e&&(t?i:r))}return C.prototype.getLinkedToSceneGraph=Ce(Z),C.prototype.setLinkedToSceneGraph=Pe(Z),C.prototype._getForceBoundingElements=Ce(Y),C.prototype._setForceBoundingElements=Pe(Y),C.prototype.getExcludeFromBounding=Ce(Q),C.prototype.setExcludeFromBounding=Pe(Q),C.prototype._getNeedBEUpdate=Ce(K),C.prototype._setNeedBEUpdate=Pe(K),C.prototype._getVisible=Ce(J),C.prototype._setVisible=Pe(J),C.prototype._getVisibilityFree=Ce($),C.prototype._setVisibilityFree=Pe($),C.prototype._getPickable=Ce(ee),C.prototype._setPickable=Pe(ee),C.prototype._getNoZPriority=Ce(ue),C.prototype._setNoZPriority=Pe(ue),C.prototype.getNoPickThrough=Ce(te),C.prototype.setNoPickThrough=Pe(te),C.prototype._getPickParent=Ce(ie),C.prototype._setPickParent=Pe(ie),C.prototype._getTreeModified=Ce(re),C.prototype.__setTreeModified=Pe(re),C.prototype.getNotAllowedInPathElement=Ce(ne),C.prototype.setNotAllowedInPathElement=Pe(ne),C.prototype._getVisibilityInTree=Ce(ae),C.prototype._setVisibilityInTree=Pe(ae),C.prototype.getIsManipulator=Ce(se),C.prototype.setIsManipulator=Pe(se),C.prototype._getExcludeFromCSO=Ce(de),C.prototype._setExcludeFromCSO=Pe(de),C.prototype._getExcludeFromHSO=Ce(oe),C.prototype._setExcludeFromHSO=Pe(oe),C.prototype._getExcludeFromPSO=Ce(le),C.prototype._setExcludeFromPSO=Pe(le),C.prototype._getExcludeFromHL=Ce(ce),C.prototype._setExcludeFromHL=Pe(ce),C.prototype._getExcludeFromPreHL=Ce(he),C.prototype._setExcludeFromPreHL=Pe(he),C.prototype._getPropagateXSOExclusion=Ce(ve),C.prototype._setPropagateXSOExclusion=Pe(ve),C.prototype._getOverrideExists=Ce(fe),C.prototype._setOverrideExists=Pe(fe),C.prototype._getDisablePrimPicking=Ce(pe),C.prototype._setDisablePrimPicking=Pe(pe),C.prototype._getDepthMode=Ce(_e),C.prototype._setDepthMode=Pe(_e),C.prototype._getAdvancedPriority=Ce(xe),C.prototype._setAdvancedPriority=Pe(xe),C.prototype._getInvertMode=Ce(be),C.prototype._setInvertMode=Pe(be),C.prototype._getInvertPickMode=Ce(we),C.prototype._setInvertPickMode=Pe(we),C.prototype._getForbidHierarchyUpdate=Ce(Me),C.prototype._setForbidHierarchyUpdate=Pe(Me),C.prototype.isInBackground=Ce(ye),C.prototype.setIsInBackground=function(e){if(this.node3DBooleanAttr=e?this.node3DBooleanAttr|ye:this.node3DBooleanAttr&~ye,this._occurrences)for(let t=0;t<this._occurrences.length;t++){const i=this._occurrences[t];if(i.parent)this._updateOccurrences(i.parent,i);else{i.setIsInBackground(e);for(let e=0;e<i.children.length;e++)this._updateOccurrences(i,i.children[e])}}},C.prototype._isAlwaysInForeground=Ce(Se),C.prototype._setIsAlwaysInForeground=function(e){if(this.node3DBooleanAttr=e?this.node3DBooleanAttr|Se:this.node3DBooleanAttr&~Se,this._occurrences)for(let t=0;t<this._occurrences.length;t++){const i=this._occurrences[t];i.parent?this._updateOccurrences(i.parent,i):i._setIsAlwaysInForeground(e)}},C.prototype._getOverrideSetManagerUnder=function(){return(this.node3DBooleanAttr&ge)>0},C.prototype._setOverrideSetManagerUnder=function(){var e;for(this.node3DBooleanAttr=this.node3DBooleanAttr|ge,e=0;e<this.parents.length;e++)this.parents[e]._setOverrideSetManagerUnder()},C.prototype.getHasExplicitBE=function(){return!1},C.prototype._getForceShowMode=function(){return(this.node3DBooleanAttr&me)>0},C.prototype._setForceShowMode=function(e){var t=e;e?t||this.traverse(e=>{e.node3DBooleanAttr=e.node3DBooleanAttr|me}):t&&this.traverse(e=>{e.node3DBooleanAttr=e.node3DBooleanAttr&~me})},Object.defineProperty(C.prototype,"material",{get:function(){return this.getMaterial()},set:function(e){console.warn("do not use node.material=myMaterial but node.setMaterial(myMaterial)"),this.setMaterial(e)}}),Object.defineProperty(C.prototype,"linkedToSceneGraph",{get:function(){return this.getLinkedToSceneGraph()},set:function(e){this.setLinkedToSceneGraph(e)}}),Object.defineProperty(C.prototype,"_forceBoundingElements",{get:function(){return this._getForceBoundingElements()},set:function(e){this._setForceBoundingElements(e)}}),Object.defineProperty(C.prototype,"excludeFromBounding",{get:function(){return this.getExcludeFromBounding()},set:function(e){this.setExcludeFromBounding(e)}}),Object.defineProperty(C.prototype,"_needBEUpdate",{get:function(){return this._getNeedBEUpdate()},set:function(e){this._setNeedBEUpdate(e)}}),Object.defineProperty(C.prototype,"visible",{get:function(){return this._getVisible()},set:function(e){this._setVisible(e)}}),Object.defineProperty(C.prototype,"visibilityFree",{get:function(){return this._getVisibilityFree()},set:function(e){this._setVisibilityFree(e)}}),Object.defineProperty(C.prototype,"pickable",{get:function(){return this._getPickable()},set:function(e){this._setPickable(e)}}),Object.defineProperty(C.prototype,"drawInHLRender",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(C.prototype,"noPickThrough",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(C.prototype,"pickParent",{get:function(){return this._getPickParent()},set:function(e){this._setPickParent(e)}}),Object.defineProperty(C.prototype,"_treeModified",{get:function(){return this._getTreeModified()},set:function(e){this.__setTreeModified(e)}}),Object.defineProperty(C.prototype,"notAllowedInPathElement",{get:function(){return this.getNotAllowedInPathElement()},set:function(e){this.setNotAllowedInPathElement(e)}}),Object.defineProperty(C.prototype,"_visibilityInTree",{get:function(){return this._getVisibilityInTree()},set:function(e){this._setVisibilityInTree(e)}}),Object.defineProperty(C.prototype,"isManipulator",{get:function(){return this.getIsManipulator()},set:function(e){this.setIsManipulator(e)}}),Object.defineProperty(C.prototype,"_excludeFromCSO",{get:function(){return this._getExcludeFromCSO()},set:function(e){this._setExcludeFromCSO(e)}}),Object.defineProperty(C.prototype,"_excludeFromHSO",{get:function(){return this._getExcludeFromHSO()},set:function(e){this._setExcludeFromHSO(e)}}),Object.defineProperty(C.prototype,"_excludeFromPSO",{get:function(){return this._getExcludeFromPSO()},set:function(e){this._setExcludeFromPSO(e)}}),Object.defineProperty(C.prototype,"_excludeFromHL",{get:function(){return this._getExcludeFromHL()},set:function(e){this._setExcludeFromHL(e)}}),Object.defineProperty(C.prototype,"_excludeFromPreHL",{get:function(){return this._getExcludeFromPreHL()},set:function(e){this._setExcludeFromPreHL(e)}}),UWA.namespace("THREEDS/Nodes/Node3D",C)}),define("Visualization/Node3D",["DS/Visualization/Node3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Node3D"),e}),define("DS/Visualization/VolumeRenderingManagerSimple",["UWA/Class","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Node3D"],function(e,t,i,r){"use strict";for(var n=null,a=function(e,t){for(var i=t||1;i<e;)i*=2;return i},s=[],o={},l={},h=0;h<7;h++){var c=Math.pow(2,h+2);s[h]=c*a(Math.ceil(Math.sqrt(c))),o[s[h]]=h,l[c]=h}var d=[16384,4096,1024,512,512,128,128],u=[0,0,0,0,0,0,0];window.nbTextures=[0,0,0,0,0,0,0];var p=[];window.nbCallsToFreeTexture=0;var f=function(e){nbCallsToFreeTexture++;var t=l[e];return p[t].length?p[t].pop():nbTextures[t]<d[t]?m(!0,s[t],s[t]):null},g=function(e,t){var i=Math.log2(t)-2;p[i].push(e)},m=function(e,i,r,a){var s,l=!a;if(l){s=new Uint8Array(i*r*(e?1:4));for(var h=0;h<i*r;h++)e?s[h]=0:(s[4*h]=0,s[4*h+1]=0,s[4*h+2]=0,s[4*h+3]=255)}else{s=new Float32Array(i*r);for(h=0;h<i*r;h++)s[h]=0}var c=new t.DataTexture(s,i,r,l?e?t.AlphaFormat:t.RGBAFormat:t.LuminanceFormat,l?t.UnsignedByteType:t.FloatType,new t.LatLongReflectionMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearFilter);return c.generateMipmaps=!1,c.needsUpdate=!0,e&&void 0!==o[i]&&nbTextures[o[i]]++,n.setTexture(c,0),c};return e.extend({init:function(e){n=e.renderer.renderer,this.viewer=e,this.camera=null,function(){for(var e=0;e<7;e++){p[e]=[];for(var t=Math.pow(2,e+2),i=t*a(Math.ceil(Math.sqrt(t))),r=0;r<u[e];r++){var n=m(!0,i,i);p[e].push(n)}}}(),this.maxAllowedSize=4294967296,this.loadedSize=0,this.debugMemoryMap=null,this.pathToModel="",this.modelLoader=null,this.rootNode=new r,this.volumeChunks=[],this.overrideRange=!1,this.minValue=0,this.maxValue=1,this.tileSetRange=[0,1],this.invisibleRanges=[],this.clipPlane=null,this.colorMap=m(!1,2,1),this.colorData=null,this.transferFunctionMap=m(!1,1024,1,!0);for(var t=0;t<1024;t++)this.transferFunctionMap.image.data[t]=.5;return this.transferFunctionMap.needsUpdate=!0,this.binnedMap=m(!1,1024,512,!1),this.binnedValues=new Uint32Array(256),this.binnedMaxValue=0,this.needsRender=!0,this},sortChunks:function(e){var i=new t.Vector3,r=e.position;this.volumeChunks.sort(function(e,t){return i.subVectors(e.data.position,r).length()-i.subVectors(t.data.position,r).length()})},update:function(e){var t=e._renderedCamera;t&&(this.camera=t,t.matrixWorldInverse.getInverse(t.matrixWorld),this.sortChunks(t))},updateTransferFunction:function(e){for(var t=this.transferFunctionMap.image.data,i=1;i<e.length;i++)for(var r=e[i-1],n=Math.floor(1024*r.position),a=r.value,s=e[i],o=1024*s.position,l=s.value,h=(l-a)/(o-n),c=l-h*o,d=n;d<o;d++)t[d]=h*d+c;this.updateInvisibleRanges(),this.transferFunctionMap.needsUpdate=!0},updateTransferFunctionRaw:function(e){var t=this.transferFunctionMap.image.data,i=1023/(e.length-1);if(i>=1)for(var r=1;r<e.length;r++)for(var n=e[r],a=e[r-1],s=Math.floor(i*r),o=Math.floor(i*(r-1)),l=(n-a)/(s-o),h=n-l*s,c=o;c<=s;c++)t[c]=l*c+h;else for(r=0;r<1024;r++)t[r]=e[Math.floor(r/i)];this.updateInvisibleRanges(),this.transferFunctionMap.needsUpdate=!0},updateInvisibleRanges:function(){this.invisibleRanges=[];for(var e=this.transferFunctionMap.image.data,t=null,i=0;i<e.length;i++)0===e[i]?t||(t=[i,i],this.invisibleRanges.push(t)):t&&(t[1]=i,t=null);t&&(t[1]=1023);for(i=0;i<this.invisibleRanges.length;i++){var r=this.invisibleRanges[i];r[0]=this.minValue+r[0]/1023*(this.maxValue-this.minValue),r[1]=this.minValue+r[1]/1023*(this.maxValue-this.minValue)}},updateBinnedValues:function(e){if(e&&e.data){var t=e.data.voxelRepartition;if(t)for(var i=255*this.minValue/(this.tileSetRange[1]-this.tileSetRange[0]),r=255*this.maxValue/(this.tileSetRange[1]-this.tileSetRange[0]),n=0;n<256;n++)this.binnedValues[n]+=t[Math.floor(i+(r-i)*n/255)],this.binnedValues[n]>this.binnedMaxValue&&(this.binnedMaxValue=this.binnedValues[n])}},updateBinnedMap:function(){for(var e,t,i,r=this.binnedMap.image.data,n=this.colorMap.image.width,a=0;a<1024;a++){var s=Math.round((n-1)*a/1023);this.colorData?(e=this.colorData[4*s],t=this.colorData[4*s+1],i=this.colorData[4*s+2]):(e=255,t=255,i=255);for(var o=this.transferFunctionMap.image.data[a],l=this.binnedValues[Math.round(.25*a)]/this.binnedMaxValue,h=0;h<512;h++){var c=1024*h+a,d=512*o>512-h,u=512*l>512-h,p=u?e:255;p*=d?.8:1;var f=u?t:255;f*=d?.8:1;var g=u?i:255;g*=d?.8:1,r[4*c]=p,r[4*c+1]=f,r[4*c+2]=g,r[4*c+3]=255}}this.binnedMap.needsUpdate=!0},setTileSetRange:function(e){this.tileSetRange=[e[0],e[1]]},setMinValue:function(e){this.overrideRange=!0,this.minValue=e},setMaxValue:function(e){this.overrideRange=!0,this.maxValue=e},setColorMap:function(e){var i=this;this.colorMap=t.ImageUtils.loadTexture(e,new t.UVMapping),this.colorMap.onLoadCallbacks.push(function(e){var t=e.image,r=document.createElement("canvas");r.width=t.width,r.height=t.height;var n=r.getContext("2d");n.drawImage(t,0,0),i.colorData=n.getImageData(0,0,t.width,1).data})},setColorMapRaw:function(e){for(var i=new Uint8Array(4*e.length),r=new t.Color,a=0;a<e.length;a++)r.set(e[a]),i[4*a]=255*r.r,i[4*a+1]=255*r.g,i[4*a+2]=255*r.b,i[4*a+3]=255;this.colorMap=new t.DataTexture(i,e.length,1,t.RGBAFormat,t.UnsignedByteType,new t.LatLongReflectionMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearFilter),this.colorMap.generateMipmaps=!1,this.colorMap.needsUpdate=!0,n.setTexture(this.colorMap,0),this.colorData=this.colorMap.image.data},computeChunkVoxelDensity:function(e,t){var i=t.data.position,r=e.pixelCullingCst/e.pixelCulling;if(!e.isOrtho){var n=e.matrixWorldInverse.elements;r*=Math.abs(n[2]*i.x+n[6]*i.y+n[10]*i.z+n[14])}var a=t.data.radius/r,s=t.data.mapDim,o=Math.pow(s.x*s.y*s.z,1/3);return t.data._voxelDensity=a/o,a},freeChunk:function(e){var t=e.data;if(null!==t&&0!==e.lastTimeLoaded){var i=t.mapData.data?t.mapData.data.byteLength:t.buffer.byteLength;this.loadedSize-=i,t.map&&g(t.map,t.chunkSize),e.data=null,e.isLoaded=!1,e.isLoading=!1,e.lastTimeLoaded=0}},getTexturePool:function(){return p},getFreeTexture:function(e){var t=f(e.data.chunkSize);if(t)return t;for(var i=0;i<this.volumeChunks.length;i++){var r=this.volumeChunks[i];if(r!==e&&(r.data&&r.data.map&&r.data.chunkSize===e.data.chunkSize)){var n=r.data.map;return r.data.map=null,n}}return null},isRangeVisible:function(e){var t=this.maxValue-this.minValue;if((e.max-e.min)/t<.005)return!1;if(e.min>this.maxValue||e.max<this.minValue)return!1;for(var i=0;i<this.invisibleRanges.length;i++){var r=this.invisibleRanges[i];if(e.min>r[0]&&e.max<r[1])return!1}return!0},getVolumeData:function(e,i){var r=e.targetSGNode;if(i){for(var n=0;n<r.children.length;n++)if("VoxelVolumeNode"===r.children[n].getNodeType()){r=r.children[n];break}}else for(;r.children[0];)r=r.children[0];var a=r.volumeData;if(a){var s=a.mapData.data?a.mapData.data.byteLength:a.buffer.byteLength;this.loadedSize+=s;var o=e.node._boundingBox,l=new t.Vector3(o.max.x-o.min.x,o.max.y-o.min.y,o.max.z-o.min.z),h=new t.Vector3(.5*(o.max.x+o.min.x),.5*(o.max.y+o.min.y),.5*(o.max.z+o.min.z));a.position=h;var c=new t.Vector3;a.radius=.5*o.size(c).length(),a.gridSize=new t.Vector3(l.x,l.y,l.z),a.modelMatrix=(new t.Matrix4).makeTranslation(h.x,h.y,h.z),a.tileSetRange.min=this.tileSetRange[0],a.tileSetRange.max=this.tileSetRange[1];var d=this.tileSetRange[1]-this.tileSetRange[0];a.valueRange.min=this.tileSetRange[0]+d*a.valueRange.min,a.valueRange.max=this.tileSetRange[0]+d*a.valueRange.max,e.data=a,r.volumeData=null}},addChunk:function(e){return!(!e||!e.data)&&(this.volumeChunks.push(e),!0)},removeChunk:function(e){if(!e||!e.data)return!1;var t=this.volumeChunks.indexOf(e);return-1!==t&&(this.volumeChunks.splice(t,1),e.data.map&&g(e.data.map,e.data.chunkSize),e.data.map=null,!0)},loadChunk:function(e,i,a){if(this.modelLoader&&!i.isLoaded){i.isLoading=!0;var s=this,o=new r(e);this.rootNode.addChild(o),this.modelLoader.setOnErrorCallback(function(){0,0,i.isLoading=!1,i.isLoaded=!0,s.needsRender=!0}),this.modelLoader.setOnLoadedCallback(function(e){0,0,i.isLoading=!1,i.isLoaded=!0,s.needsRender=!0;for(var r=o;r.children[0];)r=r.children[0];var l=r.volumeData;if(l){var h=l.mapData.data?l.mapData.data.byteLength:l.buffer.byteLength;s.loadedSize+=h;var c=i.extent,d=new t.Vector3(c[1][0]-c[0][0],c[1][1]-c[0][1],c[1][2]-c[0][2]),u=new t.Vector3(c[1][0]+c[0][0],c[1][1]+c[0][1],c[1][2]+c[0][2]);l.gridSize=new t.Vector3(d.x,d.y,d.z),l.modelMatrix=(new t.Matrix4).makeTranslation(.5*u.x,.5*u.y,.5*u.z),i.data=l,i.data.map=f(l.chunkSize),i.data.map&&(i.data.map.image=i.data.mapData,i.data.map.needsUpdate=!0,n.setTexture(i.data.map,0)),r.volumeData=null,a&&a(i)}}),0,this.modelLoader.loadModel({provider:"FILE",serverurl:"",filename:this.pathToModel+e,requiredAuth:null,proxyurl:"none",loaderSettings:{volumeChunkType:"uint8"}},o)}}})}),define("DS/Visualization/Mesh3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/GraphicAttributeSet"],function(e,t,i,r,n){"use strict";var a=0,s=e.NoOccurrences,o=t.extend({init:function(t,i){this._parent(i),this.mesh3DBooleanAttr=0,this.setHasExplicitBE(!0),this.explicitBSphere=new e.Sphere,this.explicitBBox=new e.Box3,this.mesh3js=void 0!==t?t:new e.Mesh,this.setIsInstanceNode3D(!1),this.nbInstances=0,this._bodyDim=0,this._ratioData={ratio:0,center:null,cameraName:null},this._billboardData={type:0,axis:null,rotation:null},this.mesh3js.matrixAutoUpdate=!1,this.mesh3js.matrixWorldNeedsUpdate=!1;var r=this._occurrences[0];if(s||(r.renderable=this.mesh3js,r.renderable.name=this.name,r.renderable._occurrence=r),this.mesh3js.geometry.boundingSphere&&this.explicitBSphere.copy(this.mesh3js.geometry.boundingSphere),this.mesh3js.geometry.boundingBox)this.explicitBBox.copy(this.mesh3js.geometry.boundingBox);else{var n=new e.Vector3(2*this.explicitBSphere.radius,2*this.explicitBSphere.radius,2*this.explicitBSphere.radius);this.explicitBBox.setFromCenterAndSize(this.explicitBSphere.center,n)}if(!e.disableJHGDev){var a=t.geometry;(1===a._type||a.length>0&&1===a[0]._type)&&t.material&&this.setMaterial(t.material)}return this._updateBEInternal(),this},_linkingClone:function(e,i){return i=i||new o(this.mesh3js,this.name),t.prototype._linkingClone.call(this,e,i),i.mesh3DBooleanAttr=this.mesh3DBooleanAttr,i._bodyDim=this._bodyDim,i._ratioData=this._ratioData,i._billboardData=this._billboardData,i._updateBEInternal(),i},getRatio:function(){return this._ratioData.ratio},getFixedSizeCenter:function(){return this._ratioData.center?this._ratioData.center.clone():null},setRatio:function(e){if(e!==this._ratioData.ratio){var t=this._occurrences[0];if(t){var i=t.renderable;i&&(this._ratioData.ratio=e,this.explicitBBox.copy(i.geometry.boundingBox),this.explicitBSphere.copy(i.geometry.boundingSphere),this._updateBEInternal())}}},_compactHierarchy:function(e,t){if(!e.has(this)){e.add(this);var i=this.parents;this.parents=new Array(i.length);for(var r=0;r<i.length;r++)this.parents[r]=i[r];var n=this._occurrences;this._occurrences=new Array(n.length);for(r=0;r<n.length;r++){var a=n[r];this._occurrences[r]=a,a._compactChildrenArray(t)}this.mesh3js&&this.mesh3js._compactArrays(t)}},setBillboardData:function(e,t,i){var r=this._occurrences[0];if(r){var n=r.renderable;n&&(this._billboardData.type=e,this._billboardData.axis=t,this._billboardData.rotation=i,this.explicitBBox.copy(n.geometry.boundingBox),this.explicitBSphere.copy(n.geometry.boundingSphere),this._updateBEInternal())}},setFixedSizeCenter:function(e,t){var i=this._occurrences[0];if(i){var r=i.renderable;r&&(this._ratioData.center=e?e.clone():null,t&&this._ratioData.center.multiplyScalar(t),this.explicitBBox.copy(r.geometry.boundingBox),this.explicitBSphere.copy(r.geometry.boundingSphere),this._updateBEInternal())}},setFixedSizeCameraName:function(e){this._ratioData.cameraName=e||"camera"},_setRatio:function(e){this.setRatio(e)},_setFixedSizeCameraName:function(e){this.setFixedSizeCameraName(e)},_setBillboardData:function(e,t,i){this.setBillboardData(e,t,i)},_setFixedSizeCenter:function(e,t){this.setFixedSizeCenter(e,t)},_updateBEInternal:function(){if(0!==this._billboardData.type&&(this.explicitBSphere&&(this.explicitBSphere.radius+=this.explicitBSphere.center.length(),this.explicitBSphere.center.set(0,0,0),this.explicitBBox&&this.explicitBBox.setFromCenterAndSize(this.explicitBSphere.center,this.explicitBSphere.radius)),!this.explicitBSphere&&this.explicitBBox&&(this.explicitBBox.max=new e.Vector3(0,0,0),this.explicitBBox.min=new e.Vector3(0,0,0))),this._ratioData.ratio>0&&(this.explicitBBox&&(this.explicitBBox.max=new e.Vector3(0,0,0),this.explicitBBox.min=new e.Vector3(0,0,0)),this.explicitBSphere)){if(this._ratioData.center){var t=this._ratioData.center.clone();t.multiplyScalar(1/this._ratioData.ratio),this.explicitBSphere.center.add(t)}this.explicitBSphere._updateRatio(this._ratioData.ratio)}this._invalidateBoundingElements(!1,!1)},computeBoundingElements:function(){var t=this._occurrences[0];if(t&&(a=t.renderable)){for(var i=a.geometry.boundingBox,r=a.geometry.boundingSphere,n=0;n<a.geometry.length;n++){(s=a.geometry[n]).computeBoundingBox(),s.computeBoundingSphere(),n?(i.expandByPoint(s.boundingBox.min),i.expandByPoint(s.boundingBox.max),r.clone().mergeWithSphere(s.boundingSphere,r)):(i.copy(s.boundingBox),r.copy(s.boundingSphere))}for(n=0;n<this._occurrences.length;n++){var a,s;this._occurrences[n];(s=(a=this._occurrences[n].renderable).geometry).boundingBox.copy(i),s.boundingSphere.copy(r),a.boundingBox||(a.boundingBox=new e.Box3),a.boundingSphere||(a.boundingSphere=new e.Sphere),a.boundingBox.copy(i),a.boundingSphere.copy(r),a._updateWorldCenterAndRadius()}this.explicitBBox.copy(i),this.explicitBSphere.copy(r),this._updateBEInternal()}},forceBoundingSphere:function(e){this.forceBoundingElements(!0,{sphere:e}),this._updateBEInternal()},_forceBoundingSphere:function(t){this.mesh3js&&this.mesh3js.geometry?(this.setHasExplicitBE(!0),this.mesh3js.geometry.boundingSphere||(this.mesh3js.geometry.boundingSphere=new e.Sphere),this.mesh3js.geometry.boundingSphere.copy(t),this.explicitBSphere.copy(t)):console.log("Couldn't force bounding sphere.")},forceBoundingBox:function(e){this.forceBoundingElements(!0,{box:e}),this._updateBEInternal()},_forceBoundingBox:function(t){this.mesh3js&&this.mesh3js.geometry?(this.mesh3js.geometry.boundingBox||(this.mesh3js.geometry.boundingBox=new e.Box3),this.setHasExplicitBE(!0),this.mesh3js.geometry.boundingBox.copy(t),this.explicitBBox.copy(t)):console.log("Couldn't force bounding box.")},__forceBoundingElements:function(e,t){if(e){var i;e.sphere&&this._forceBoundingSphere(e.sphere),e.box&&this._forceBoundingBox(e.box);for(var r=0;r<this._occurrences.length;r++)null!==(i=this._occurrences[r]).renderable&&i.renderable._updateWorldCenterAndRadius()}},_forceGeomType:function(e){this.mesh3js&&this.mesh3js._forceGeomType(e)},createRenderable:function(){var t=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);t.matrixAutoUpdate=!1,t.matrixWorldNeedsUpdate=!1,t.visible=this.mesh3js.visible,t.pickable=this.mesh3js.pickable,t.noPickThrough=this.mesh3js.noPickThrough,t.renderDepth=this.mesh3js.renderDepth,t.frustumCulled=this.mesh3js.frustumCulled,t.enableNormalDepth=this.mesh3js.enableNormalDepth,t.castShadow=this.mesh3js.castShadow,t.receiveShadow=this.mesh3js.receiveShadow,t.beforeRenderCB=this.mesh3js.beforeRenderCB,t.fromLoadedModel=this.mesh3js.fromLoadedModel,t.lightMapData=this.mesh3js.lightMapData,t._ratioData=this.mesh3js._ratioData,t._programID=this.mesh3js._programID?this.mesh3js._programID:t._programID,t._vertexColors=this.mesh3js._vertexColors,t._skinning=this.mesh3js._skinning,t._skinningInstancing=this.mesh3js._skinningInstancing,t._billboardData=this.mesh3js._billboardData,t.materialMode=this.mesh3js.materialMode,t._bodyDim=this._bodyDim,t.kdTree=this.mesh3js.kdTree,t.hasPoint=this.mesh3js.hasPoint,this.mesh3js.disableMirror&&(t.disableMirror=this.mesh3js.disableMirror);var i=s?null:this._occurrences[0].renderable;if(i){i.layer&&(t.layer=i.layer.clone());var r=i.selectionGroups;if(r)for(var n=0;n<r.length;n++)t.addSelectionGroup(r[n].clone())}return this.mesh3js.copyInstancingInfos(t),t},add:function(){return!1},setRenderDepth:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.renderDepth=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.renderDepth=e)},setFrustumCulled:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.frustumCulled=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.frustumCulled=e)},setVertexColors:function(e){null!==this.mesh3js&&this.mesh3js.setVertexColors(e);for(var t=0;t<this._occurrences.length;t++){var i=this._occurrences[t];null!==i.renderable&&i.renderable.setVertexColors(e)}},setSkinningTransformations:function(e){null!==this.mesh3js&&this.mesh3js.setSkinningTransformations(e);for(var t=0;t<this._occurrences.length;t++){var i=this._occurrences[t];null!==i.renderable&&i.renderable.setSkinningTransformations(e)}},setSkinningTransformationsInstancing:function(e){null!==this.mesh3js&&this.mesh3js.setSkinningTransformationsInstancing(e);for(var t=0;t<this._occurrences.length;t++){var i=this._occurrences[t];null!==i.renderable&&i.renderable.setSkinningTransformationsInstancing(e)}},setSSAO:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.enableNormalDepth=e,this.mesh3js._flagAsGSSOInvalidated()),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.enableNormalDepth=e,i.renderable._flagAsGSSOInvalidated())},setShadow:function(e,t){var i,r;for(null!==this.mesh3js&&(this.mesh3js.castShadow=e,this.mesh3js.receiveShadow=t),i=0;i<this._occurrences.length;i++)null!==(r=this._occurrences[i]).renderable&&(r.renderable.castShadow=e,r.renderable.receiveShadow=t)},setMirror:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.disableMirror=e?0:1),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.disableMirror=e?0:1)},clone:function(t){var i=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);!!t&&(this.mesh3js.geometry.boundingSphere&&(i.geometry.boundingSphere=this.mesh3js.geometry.boundingSphere.clone()),this.mesh3js.geometry.boundingBox&&(i.geometry.boundingBox=this.mesh3js.geometry.boundingBox.clone())),this.mesh3js.copyInstancingInfos(i),i.castShadow=this.mesh3js.castShadow,i.receiveShadow=this.mesh3js.receiveShadow;var r=new THREEDS.Nodes.Mesh(i,this.name);return this.getIsInstanceNode3D()&&r.setIsInstanceNode3D(!0),r},getPrimitive:function(e,t){var i=this._getPrimitives(e,t);return i.length?i[0]:null},getPrimitives:function(e,t){return this._getPrimitives(void 0,e,t)},show:function(e){e?this._setLayer(e,1):this._initLayer(1)},hide:function(e){e?this._setLayer(e,0):this._initLayer(0)},setMaterial:function(t,i){!t||t instanceof e.Material?this._parent(t):t&&(this._initLayer(1),this._setLayer(t,1,i))},setNoZPriority:function(e,t){e&&e instanceof Object?e&&(this._initLayer(1),this._setLayer(e,1,void 0,void 0,t?4:-1)):this._parent(e)},_setGAS:function(e,t){e instanceof Array?e&&(this._initLayer(1),this._setLayer(e,1,void 0,t)):this._parent(e)},_setNoZOnGeomTypes:function(e,t){this._initLayer(1),this._setLayerOnGeomTypes(e,void 0,void 0,void 0,t?4:-1)},_setMaterialOnGeomTypes:function(e,t){this._initLayer(1),this._setLayerOnGeomTypes(e,void 0,t)},_setGASOnGeomTypes:function(e,t){this._initLayer(1),this._setLayerOnGeomTypes(e,void 0,void 0,t)},_getGas:function(e){return this._getMaterials(e,!0)},_getMaterials:function(e,t){var r=this._getPrimitivesFromElts(e);if(!r.length)return!1;var n=r[0].container instanceof i.DrawingGroup,a=[],s=this._occurrences[0].renderable;if(!s)return!1;var o=new i.SGPrimitiveHelper;if(s.layer)for(var l=0;l<r.length;l++)for(var h=r[l],c=0;c<s.layer.layers.length;c++){var d=s.layer.layers[c].drawableGroup,u=s.layer.layers[c].drawableInterval;if(-1!==u.layerNum&&((t||u.material)&&(!t||u.gas))){if(n){if(h.container!==d)continue;if(h.index<u.primitiveStart||h.index>=u.primitiveStart+u.primitiveCount)continue;return t?a.push(u.gas):a.push(u.material),a}for(var p=u.primitiveStart;p<u.primitiveStart+u.primitiveCount;p++)if(o.set(d,p),o.isEqual(h))return t?a.push(u.gas):a.push(u.material),a}}return a},setMaterialMode:function(e){var t=e?1:null===e?2:0;null!==this.mesh3js&&(this.mesh3js.materialMode=t);for(var i=0;i<this._occurrences.length;i++){var r=this._occurrences[i];null!==r.renderable&&(r.renderable.materialMode=t)}},getNodeType:function(){return"Mesh3D"},getBodyDimension:function(){return this._bodyDim?this._bodyDim:-1},isEditable:function(){return!1},setInstancingParameters:function(t,i,r){var n,s;if(void 0!==this.mesh3js)if(n=this.mesh3js,this._matApp&&((s=this._matApp._getMaterialFromGLType(4,e.GeomTypeEnum.FACE))||(s=this._matApp._getMaterialFromGLType(1)),s||(s=this._matApp._getMaterialFromGLType(0))),s||(s=this.material),s){s.isInstancingMaterial=!0,this.setIsInstanceNode3D(!0),this.nbInstances=t,n._instancingInfos={isInstanceNode3D:!0,nbInstances:t,instancingSelectionMode:r||"instance",instanceAttribArrays:null,pickedInstanceId:-1};for(var o=new Float32Array(t),l=0;l<t;l++)o[l]=5+5*l;var h={};h.id=a,a++,s.attributes={},h.instanceId={},h.instanceId.array=o,h.instanceId.buffer=null,h.instanceId.itemSize=1,s.attributes.instanceId={type:"f"};for(var c=0;c<i.length;c++){switch(h[i[c].attribName]={},i[c].type){case"f":h[i[c].attribName].array=new Float32Array(i[c].data),s.attributes[i[c].attribName]={type:"f"},h[i[c].attribName].itemSize=1;break;case"v2":if(i[c].isFlattened)h[i[c].attribName].array=new Float32Array(i[c].data);else{h[i[c].attribName].array=new Float32Array(2*t);for(var d=0;d<t;d++)h[i[c].attribName].array[2*d]=i[c].data[d].x,h[i[c].attribName].array[2*d+1]=i[c].data[d].y}s.attributes[i[c].attribName]={type:"v2"},h[i[c].attribName].itemSize=2;break;case"v3":if(i[c].isFlattened)h[i[c].attribName].array=new Float32Array(i[c].data);else{h[i[c].attribName].array=new Float32Array(3*t);for(d=0;d<t;d++)h[i[c].attribName].array[3*d]=i[c].data[d].x,h[i[c].attribName].array[3*d+1]=i[c].data[d].y,h[i[c].attribName].array[3*d+2]=i[c].data[d].z}s.attributes[i[c].attribName]={type:"v3"},h[i[c].attribName].itemSize=3;break;case"v4":if(i[c].isFlattened)h[i[c].attribName].array=new Float32Array(i[c].data);else{h[i[c].attribName].array=new Float32Array(4*t);for(d=0;d<t;d++)h[i[c].attribName].array[4*d]=i[c].data[d].x,h[i[c].attribName].array[4*d+1]=i[c].data[d].y,h[i[c].attribName].array[4*d+2]=i[c].data[d].z,h[i[c].attribName].array[4*d+3]=i[c].data[d].w}s.attributes[i[c].attribName]={type:"v4"},h[i[c].attribName].itemSize=4;break;case"m4":if(i[c].isFlattened)h[i[c].attribName].array=new Float32Array(i[c].data);else{h[i[c].attribName].array=new Float32Array(16*i[c].data.length);for(var u=0;u<i[c].data.length;u++){var p=new Float32Array(16);p=i[c].data[u].elements;for(l=0;l<16;l++)h[i[c].attribName].array[16*u+l]=p[l]}}s.attributes[i[c].attribName]={type:"m4"},h[i[c].attribName].itemSize=4,h[i[c].attribName].isMat4=!0}h[i[c].attribName].buffer=null}if(n._instancingInfos.instanceAttribArrays=h,s._PDSFXData&&s._PDSFXData.PDSFX){var f="";for(c=0;c<i.length;c++)f+="attribute "+e.ToGLSLTypes[i[c].type].t+" "+i[c].attribName+";\n";s._PDSFXData.pdsfxAttributesCode=f}for(var g=0;g<this._occurrences.length;g++)n.copyInstancingInfos(this._occurrences[g].renderable)}else console.error("Error: An instancing material wasn't set to the Mesh3D.")},updateInstanceAttribValue:function(t){if(t.instanceId&&t.attribName&&void 0!==t.value){var i;this._matApp&&((i=this._matApp._getMaterialFromGLType(4,e.GeomTypeEnum.FACE))||(i=this._matApp._getMaterialFromGLType(1)),i||(i=this._matApp._getMaterialFromGLType(0))),i||(i=this.material);var r=this.mesh3js;if(r._instancingInfos)if(t.instanceId%5!=0||t.instanceId<5||t.instanceId>5*r._instancingInfos.nbInstances)console.error("Error: the instance id is incorrect or out of range.");else if(r._instancingInfos.instanceAttribArrays[t.attribName]&&i.attributes[t.attribName]){var n=t.instanceId/5-1,a=i.attributes[t.attribName].type,s=!0,o=r._instancingInfos.instanceAttribArrays;switch(a){case"f":"number"!=typeof t.value||isNaN(t.value)?s=!1:o[t.attribName].array[n]=t.value;break;case"v2":t.value instanceof e.Vector2?(o[t.attribName].array[2*n]=t.value.x,o[t.attribName].array[2*n+1]=t.value.y):s=!1;break;case"v3":t.value instanceof e.Vector3?(o[t.attribName].array[3*n]=t.value.x,o[t.attribName].array[3*n+1]=t.value.y,o[t.attribName].array[3*n+2]=t.value.z):s=!1;break;case"v4":t.value instanceof e.Vector4?(o[t.attribName].array[4*n]=t.value.x,o[t.attribName].array[4*n+1]=t.value.y,o[t.attribName].array[4*n+2]=t.value.z,o[t.attribName].array[4*n+3]=t.value.w):s=!1;break;case"m4":if(t.value instanceof e.Matrix4){var l=new Float32Array(16);l=t.value.elements;for(var h=0;h<16;h++)o[t.attribName].array[16*n+h]=l[h]}else s=!1;break;default:s=!0}if(s){var c;o[t.attribName].isDynamic=!0;for(var d=0;d<this._occurrences.length;d++){var u;if((c=this._occurrences[d].renderable)._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0,c.highlightMeshes)for(u=0;u<c.highlightMeshes.length;u++)c.highlightMeshes[u].renderable._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0}}else console.error("Error: the type of the new value doesn't match the type of the attribute data.")}else console.error("Error: the attribute "+t.attribName+" doesn't exist for this mesh node.");else console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).")}else console.error("Error: all parameters params.instanceId, params.attribName and params.value are needed.")},updateInstanceAttribArray:function(t){if(t.attribName&&t.array){var i;this._matApp&&((i=this._matApp._getMaterialFromGLType(4,e.GeomTypeEnum.FACE))||(i=this._matApp._getMaterialFromGLType(1)),i||(i=this._matApp._getMaterialFromGLType(0))),i||(i=this.material);var r=this.mesh3js;if(r._instancingInfos)if(r._instancingInfos.instanceAttribArrays[t.attribName]&&i.attributes[t.attribName]){var n=!0,a=r._instancingInfos.instanceAttribArrays;if(t.isFlattened)t.array instanceof Array&&(t.array=new Float32Array(t.array)),a[t.attribName].array=t.array;else{var s=i.attributes[t.attribName].type,o=t.array[0];switch(s){case"f":"number"!=typeof o||isNaN(o)?n=!1:a[t.attribName].array.set(new Float32Array(t.array));break;case"v2":if(o instanceof e.Vector2)for(var l=0;l<r._instancingInfos.nbInstances;l++)a[t.attribName].array[2*l]=t.array[l].x,a[t.attribName].array[2*l+1]=t.array[l].y;else n=!1;break;case"v3":if(o instanceof e.Vector3)for(l=0;l<r._instancingInfos.nbInstances;l++)a[t.attribName].array[3*l]=t.array[l].x,a[t.attribName].array[3*l+1]=t.array[l].y,a[t.attribName].array[3*l+2]=t.array[l].z;else n=!1;break;case"v4":if(o instanceof e.Vector4)for(l=0;l<r._instancingInfos.nbInstances;l++)a[t.attribName].array[4*l]=t.array[l].x,a[t.attribName].array[4*l+1]=t.array[l].y,a[t.attribName].array[4*l+2]=t.array[l].z,a[t.attribName].array[4*l+3]=t.array[l].w;else n=!1;break;case"m4":if(o instanceof e.Matrix4){var h;for(l=0;l<r._instancingInfos.nbInstances;l++){h=t.array[l].elements;for(var c=0;c<16;c++)a[t.attribName].array[16*l+c]=h[c]}}else n=!1;break;default:n=!0}}if(n){var d;a[t.attribName].isDynamic=!0;for(var u=0;u<this._occurrences.length;u++){var p;if((d=this._occurrences[u].renderable)._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0,d.highlightMeshes)for(p=0;p<d.highlightMeshes.length;p++)d.highlightMeshes[p].renderable._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0}}else console.error("Error: the type of the new values don't match the type of the attribute data.")}else console.error("Error: the attribute "+t.attribName+" doesn't exist for this mesh node.");else console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).")}},setInstancingSelectionMode:function(e){if(this.mesh3js._instancingInfos&&this.mesh3js._instancingInfos.isInstanceNode3D){this.mesh3js._instancingInfos.instancingSelectionMode=e;for(var t=this._occurrences,i=t.length,r=0;r<i;r++)t[r].renderable._instancingInfos.instancingSelectionMode=e}},_getPrimitivesFromElts:function(e){var t=[];if(e.length)if(e[0]instanceof r)for(var n=0;n<e.length;n++)if("rep"===e[n].getType())for(var a=0;a<e[n].sgNode.getPrimitivesCount();a++){var s=new i.SGPrimitiveHelper;s.set(e[n].sgNode,a),t.push(s)}else t.push(e[n].sgNode);else t=e.slice();return t},_setLayer:function(e,t,i,r,n){var a,s,o=[];if(s=this._getPrimitivesFromElts(e),-1===t){var l;if(!(l=this._occurrences[0].renderable))return;o=l.getRenderablesFromGeometries()}else for(a=0;a<this._occurrences.length;a++)o.push(this._occurrences[a].renderable);for(a=0;a<o.length;a++)if(l=o[a]){var h;if(l._flagAsGSSOInvalidated(),null===l.layer)if(l.initLayers(1),l.highlightMeshes)for(h=0;h<l.highlightMeshes.length;h++)l.highlightMeshes[h].renderable.layer=l.layer.clone();l.layer.addPrimitivesToLayers(s,t,i,r,null,n)}},_setLayerOnGeomTypes:function(e,t,i,r,n){var a=[];if(-1===t){if(!(o=this._occurrences[0].renderable))return;a=o.getRenderablesFromGeometries()}else for(s=0;s<this._occurrences.length;s++)a.push(this._occurrences[s].renderable);for(var s=0;s<a.length;s++){var o;if(o=a[s]){var l;if(o._flagAsGSSOInvalidated(),null===o.layer)if(o.initLayers(1),o.highlightMeshes)for(l=0;l<o.highlightMeshes.length;l++)o.highlightMeshes[l].renderable.layer=o.layer.clone();for(var h=0;h<o.geometry.length;h++)for(var c=o.geometry[h],d=0;d<c.drawingGroups.length;d++){var u=c.drawingGroups[d],p=void 0!==u._initialGeomType?u._initialGeomType:u._geomType;-1!==e.indexOf(p)&&o.layer.setDGToLayer(c,u,t,i,r,void 0,n)}}}},_initLayer:function(e){var t,i;for(t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable._flagAsGSSOInvalidated(),null===i.renderable.layer&&i.renderable.initLayers(e))},_removePrimitives:function(e){e&&this._setLayer(e,-1)},_addDynamicGeometry:function(e,t,i){var r=null,n=this._occurrences[0].renderable;if(!n)return!1;for(var a=0;a<n.geometry.length;a++)if(n.geometry[a].dynamic){r=n.geometry[a];break}if(r)r.merge(e,t,i);else{e.dynamic=!0;for(a=0;a<this._occurrences.length;a++)(n=this._occurrences[a].renderable)&&n.addGeometry(e)}},_optimizeBuffers:function(e){var t={invalidRatio:e&&void 0!==e.invalidRatio?e.invalidRatio:.5};if(l=this._occurrences[0].renderable){var r=l.geometry;if(r instanceof Array){var n=l.layer?l.layer.layers:null;if(n){var a=new Map,s=i.mergeGeometries({geometries:r,layers:n,invalidRatio:t.invalidRatio,force:!1},a);if(s)for(var o=0;o<this._occurrences.length;o++){var l;if(l=this._occurrences[o].renderable){l.releaseVBO(!1),l.geometry.length=0;for(var h=0;h<s.length;h++)l.geometry.push(s[h]);for(h=0;h<s.length;h++)s[h].addRefVBO(l,!1);s.boundingBox&&(l.geometry.boundingBox=s.boundingBox.clone()),s.boundingSphere&&(l.geometry.boundingSphere=s.boundingSphere.clone());var c=l.layer.layers,d=!1,u=[];for(h=0;h<c.length;h++){var p=[],f=c[h].drawableGroup,g=c[h].drawableInterval;if(g.layerNum>0&&g.material){d=!0;for(var m=g.primitiveStart;m<g.primitiveStart+g.primitiveCount;m++)if(a.has(f)){var v=a.get(f);v.has(m)&&p.push(v.get(m))}u.push({layerInterval:g,primitives:p})}}if(l.layer=null,d){l.initLayers(1);for(h=0;h<u.length;h++)l.layer.addPrimitivesToLayers(u[h].primitives,u[h].layerInterval.layerNum,u[h].layerInterval.material)}}}}}}},_getPrimitives:function(e,t,n){""===e&&(e=null);var a=[],s=this._occurrences[0].renderable;if(!s)return!1;var o=new i.SGPrimitiveHelper;if(s.layer)for(var l=0;l<s.layer.layers.length;l++){var h=s.layer.layers[l].drawableGroup,c=s.layer.layers[l].drawableInterval;if(void 0!==n)if((void 0!==h._initialGeomType?h._initialGeomType:h._geomType)!==n)continue;if(-1!==c.layerNum&&(!t||c.layerNum))for(var d=c.primitiveStart;d<c.primitiveStart+c.primitiveCount;d++)if(o.set(h,d),void 0!==e){if(o.getCgmId()===e)return a.push(r.getFromSGNode(o.clone())),a}else a.push(r.getFromSGNode(o.clone()))}else{var u=s.geometry;if(!(u instanceof Array))return a;for(d=0;d<u.length;d++){var p=u[d].drawingGroups;for(l=0;l<p.length;l++){h=p[l];if(void 0!==n)if((void 0!==h._initialGeomType?h._initialGeomType:h._geomType)!==n)continue;for(var f=0;f<h.getPrimitivesCount();f++)if(o.set(h,f),void 0!==e){if(o.getCgmId()===e)return a.push(r.getFromSGNode(o.clone())),a}else a.push(r.getFromSGNode(o.clone()))}}}return a},_setBeforeRenderCB:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.beforeRenderCB=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.beforeRenderCB=e)}});o.prototype._isMesh3D=!0;var l=1,h=2;return o.prototype.getHasExplicitBE=function(){return(this.mesh3DBooleanAttr&l)>0},o.prototype.setHasExplicitBE=function(e){this.mesh3DBooleanAttr=e?this.mesh3DBooleanAttr|l:this.mesh3DBooleanAttr&~l},o.prototype.getIsInstanceNode3D=function(){return(this.mesh3DBooleanAttr&h)>0},o.prototype.setIsInstanceNode3D=function(e){this.mesh3DBooleanAttr=e?this.mesh3DBooleanAttr|h:this.mesh3DBooleanAttr&~h},o.prototype.forceNoMeshInRAM=function(){var e,t,i=this.mesh3js.geometry;for(e=0;e<i.length;e++){if((t=i[e]).sharedBuffers)throw new Error("Cannot force no mesh in RAM on geometry with sharedBuffers");t.noMeshInRAM||(t.noMeshInRAM=!0,t.vertexBufferGPU&&t.clearMeshInRAM(!1))}},Object.defineProperty(o.prototype,"hasExplicitBE",{get:function(){return this.getHasExplicitBE()},set:function(e){this.setHasExplicitBE(e)}}),Object.defineProperty(o.prototype,"isInstanceNode3D",{get:function(){return this.getIsInstanceNode3D()},set:function(e){this.setIsInstanceNode3D(e)}}),UWA.namespace("THREEDS/Nodes/Mesh",o)}),define("Visualization/Mesh3D",["DS/Visualization/Mesh3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Mesh3D"),e}),define("DS/Visualization/PrimitiveIterator",["UWA/Class","DS/Mesh/MeshUtils","DS/Visualization/Mesh3D","DS/Visualization/PathElement"],function(e,t,i,r){"use strict";var n={},a=e.extend({init:function(e,t){if(t===n){var a=e;if(this._primitives=null,this._sgRep=null,this._sgPrimitive=null,e instanceof r&&(a=e.getLastElement()),a instanceof i)this._primitives=a.getPrimitives();else if(a.sgNode)switch(a.sgNode.getType?a.sgNode.getType():a.sgNode.type){case 2:this._sgRep=a.sgNode;break;case 3:this._sgPrimitive=a.sgNode;break;default:console.log("PrimitiveIterator: unsupported SubElement type")}}},getNbPrimitives:function(){if(this._primitives)return this._primitives.length;if(this._sgPrimitive)return 1;if(this._sgRep)return this._sgRep.getPrimitivesCount();throw new Error("Internal error")},getConnectivityType:function(e){return this._getSGNode(e).getGroup().glType},getLength:function(e){return this._getSGNode(e).getCount()},getOffset:function(e){return this._getSGNode(e).getStart()},getIndexArray:function(e){return this._getSGNode(e).getGroup().geometry.vertexIndexArray},getPositionArray:function(e){return this._getSGNode(e).getGroup().geometry.vertexPositionArray},getNormalArray:function(e){return this._getSGNode(e).getGroup().geometry.vertexNormalArray},getMaterial:function(e){return this._getSGNode(e).getGroup().material},getGas:function(e){return this._getSGNode(e).getGroup().gas},getGeomType:function(e){var i=this._getSGNode(e);return t.GeomTypeString[i.getGroup()._geomType]},_getSGNode:function(e){if(this._primitives)return this._primitives[e].sgNode;if(this._sgPrimitive&&0===e)return this._sgPrimitive;if(this._sgRep){var i=new t.SGPrimitiveHelper;return i.set(this._sgRep,e),i}}});return a.POINTS=0,a.LINES=1,a.LINE_LOOP=2,a.LINE_STRIP=3,a.TRIANGLES=4,a.TRIANGLE_STRIP=5,a.TRIANGLE_FAN=6,a._authorizedTeamsOnly_getKey=function(){return n},a}),define("DS/Visualization/CompareModelsServices",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Effects/CompareModelsEffect","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/GraphicAttributeSet"],function(e,t,i,r,n,a,s){"use strict";var o=e.extend({init:function(e){return this.viewer=e,this._oldMatInherit=!1,this.compareEffect=null,this.effectID=-1,this._tmpNodes=[],this._occurrences=[],this},startCompare:function(e){this._oldMatInherit=this.viewer.renderer.renderer.newMaterialInheritance,this.viewer.renderer.renderer.newMaterialInheritance=!0;for(var r=new t.Color(e.first.color),n=new t.Color(e.second.color),a=new t.Color(e.common.color),o=new s({colorRGB:r,colorA:e.first.opacity}),l=new s({colorRGB:n,colorA:e.second.opacity}),h=new s({colorRGB:a,colorA:e.common.opacity}),c=e.first.pathElements,d=e.second.pathElements,u=[],p=[],f=0;f<c.length;f++){var g=this._createTemporaryNode(c[f]);u.push(g)}for(f=0;f<d.length;f++){g=this._createTemporaryNode(d[f]);p.push(g)}for(f=0;f<u.length;f++)u[f].setVisibility(!1);for(f=0;f<p.length;f++)p[f].setVisibility(!1);for(f=0;f<c.length;f++)this._applyColorsAndPasses(0,c[f],u[f],o,h);for(f=0;f<d.length;f++)this._applyColorsAndPasses(1,d[f],p[f],l);if(!this.compareEffect){var m=new i(this.viewer.renderer.renderer,this.viewer.renderer.renderTargetPool);this.effectID=this.viewer.renderer.addCustomEffect(m),this.compareEffect=this.viewer.renderer.getCustomEffect(this.effectID)}this.compareEffect.set2DMode(e.compareMode&&"2D"===e.compareMode),this.viewer.renderer.setCustomEffect(this.effectID,!0)},stopCompare:function(){this.viewer.renderer.setCustomEffect(this.effectID,!1),this._cleanTemporaryNodes(),this.viewer.renderer.renderer.newMaterialInheritance=this._oldMatInherit},_createTemporaryNode:function(e){var t=e.externalPath[e.externalPath.length-2],i=new r;return this._tmpNodes.push(i),t.addChild(i),i.addChild(e.getLastElement()),i},_hideOccurrences:function(e){for(var t=0;t<e._occurrences.length;t++){e._occurrences[t].setVisibility(!1)}},_applyColorsAndPasses:function(e,t,i,r,n){var s=t.externalPath.slice();s.splice(t.externalPath.length-1,0,i);for(var o=new a(s),l=t._getOccurrences(this.viewer),h=o._getOccurrences(this.viewer),c=0;c<l.length;c++){var d=l[c];this._updateGASOccurrence(d,r)}for(c=0;c<h.length;c++){(d=h[c])._relativeVisibility=2,1===e?this._updateRenderPassesOccurrence(d,["compareNew"]):(this._updateRenderPassesOccurrence(d,["compareOld"]),this._updateGASOccurrence(d,n))}},_cleanTemporaryNodes:function(){for(var e=0;e<this._occurrences.length;e++){var t=this._occurrences[e];this._resetOccurrence(t)}this._occurrences=[];for(e=0;e<this._tmpNodes.length;e++){var i=this._tmpNodes[e];i.removeChildren();for(var r=0;r<i.parents.length;r++)i.parents[r].removeChild(i)}this._tmpNodes=[]},_updateGASOccurrence:function(e,t){this._occurrences.push(e),e.forceGAS=t,e.gas=t,e.node._updateOccurrences(e.parent,e,!1)},_updateRenderPassesOccurrence:function(e,t){this._occurrences.push(e),e.forcePasses=t,e.node._updateOccurrences(e.parent,e,!1)},_resetOccurrence:function(e){e.forceGAS=null,e.gas=null,e.forcePasses=null,e._relativeVisibility=null,e.traverse(function(e){e._relativeVisibility=null});for(var t=0;t<e.children.length;t++){var i=e.children[t];i.node._updateOccurrences(e,i,!1)}}});return UWA.namespace("THREEDS/CompareModelsServices",o)}),define("DS/Visualization/EditableMesh3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement"],function(e,t,i,r){"use strict";var n=t.extend({init:function(e,t){return this._parent(e,t),this},clone:function(){var t=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);return this.mesh3js.copyInstancingInfos(t),new THREEDS.Nodes.EditableMesh(t,this.name)},getNodeType:function(){return"Mesh3D"},isEditable:function(){return!0},getBuffer:function(e,t){var i=t||this.mesh3js.geometry[0],r=this._getDataArray(e);return r?i[r]:null},getIndexBuffer:function(e){var t=e||this.mesh3js.geometry[0];return this._getIndexArray(t)},updateIndexBuffer:function(e,t,i){this._clearGSSOCache(),(i||this.mesh3js.geometry[0]).markIndexStale(e,e+t)},updateBuffer:function(e,t,i,r){this._clearGSSOCache();var n=r||this.mesh3js.geometry[0],a=this._getDataArray(e);n.markAttributeStale({vertexPositionArray:"position",vertexNormalArray:"normal",vertexUvArray:"uv",vertexUv2Array:"uv2",vertexTangentArray:"tangent",vertexBinormalArray:"binormal",vertexColorArray:"color",vertexLineDistancesArray:"lineDistance",vertexPatternStartEndArray:"patternStartEnd",vertexPreviousPositionArray:"previousPos",vertexNextPositionArray:"followingPos",vertexSideExtrusionArray:"sideExtrusion",vertexSkinIndexArray:"skinIndex",vertexSkinWeightArray:"skinWeight"}[a],t,t+i),n.vertexBufferGPU&&(n.vertexBufferGPU.needsUpdate=!0),n.wideLinesLinker&&n.wideLinesLinker.linkedGeometry.vertexBufferGPU&&(n.wideLinesLinker.linkedGeometry.vertexBufferGPU.needsUpdate=!0)},addBuffer:function(e,t,r){this._clearGSSOCache();var n=r||this.mesh3js.geometry[0],a=this._getDataArray(e);if(!(a?n[a]:null))switch(n.needsUpdate=!0,e){case i.VertexComponentEnum.POSITION:n.vertexPositionArray=t;break;case i.VertexComponentEnum.NORMAL:n.vertexNormalArray=t;break;case i.VertexComponentEnum.DIFFUSE_COLOR:n.vertexColorArray=t;break;case i.VertexComponentEnum.TEX_COORD_0:n.vertexUvArray=t;break;case i.VertexComponentEnum.TEX_COORD_1:n.vertexUv2Array=t;break;case i.VertexComponentEnum.TEX_COORD_2:n.vertexTangentArray=t;break;case i.VertexComponentEnum.TEX_COORD_3:n.vertexBinormalArray=t}},removeBuffer:function(e,t){this._clearGSSOCache();var r=t||this.mesh3js.geometry[0],n=this._getDataArray(e);if(n?r[n]:null)switch(r.needsUpdate=!0,e){case i.VertexComponentEnum.POSITION:r.vertexPositionArray=null;break;case i.VertexComponentEnum.NORMAL:r.vertexNormalArray=null;break;case i.VertexComponentEnum.DIFFUSE_COLOR:r.vertexColorArray=null;break;case i.VertexComponentEnum.TEX_COORD_0:r.vertexUvArray=null;break;case i.VertexComponentEnum.TEX_COORD_1:r.vertexUv2Array=null;break;case i.VertexComponentEnum.TEX_COORD_2:r.vertexTangentArray=null;break;case i.VertexComponentEnum.TEX_COORD_3:r.vertexBinormalArray=null}},_getIndexArray:function(e){return e.vertexIndexArray},_getDataArray:function(e){switch(e){case i.VertexComponentEnum.POSITION:return"vertexPositionArray";case i.VertexComponentEnum.NORMAL:return"vertexNormalArray";case i.VertexComponentEnum.DIFFUSE_COLOR:return"vertexColorArray";case i.VertexComponentEnum.TEX_COORD_0:return"vertexUvArray";case i.VertexComponentEnum.TEX_COORD_1:return"vertexUv2Array";case i.VertexComponentEnum.TEX_COORD_2:return"vertexTangentArray";case i.VertexComponentEnum.TEX_COORD_3:return"vertexBinormalArray"}return null},_clearGSSOCache:function(){var e,t=null;for(e=0;e<this._occurrences.length;e++)(t=this._occurrences[e].renderable)&&(t._flagAsGSSOInvalidated(),t.outlinesGeometry&&(t.outlinesGeometry.upToDate=!1))}});return UWA.namespace("THREEDS/Nodes/EditableMesh",n)}),define("Visualization/EditableMesh3D",["DS/Visualization/EditableMesh3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/EditableMesh3D"),e}),define("DS/Visualization/Selection",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Visualization/PathElement","DS/Selection/HSOManager","DS/Selection/PSOManager"],function(e,t,i,r,n,a,s,o,l,h){"use strict";function c(e,t,i){if(t(e,i),"bag"===e.getType())for(var r=e.getChildren(),n=0;n<r.length;n++)c(r[n],t,i)}function d(e){for(var t=0;t<e.externalPath.length;t++){var i=e.externalPath[t];if(i instanceof THREEDS.Nodes.CGRNode&&"3DSyncBatch"===i.productType)return i}return null}function u(e,t,i,s){var l,h=[],d=[];if(e.sgNode instanceof r.SGPrimitiveHelper){(g=s.children[1]instanceof a?s.children[1]:s.children[0]).mesh3js&&d.push({mesh:g.mesh3js,element:e})}else{var u=function(e){var t=new Map;return c(e,function(e,t){if("rep"===e.getType()){var i=e.getIdentificationObject?e.getIdentificationObject():null,r=i?i.getLocalId():0;r&&t.set(r,e)}},t),t}(e),p=t.getLastElement(!0),f=s.children[1]instanceof n?s.children[1]:s.children[0],g=s.children[1]instanceof a?s.children[1]:s.children[0],m=f.children,v=(l=f,p.traverse(function(e,t){return e===t.parent},{parent:l},!0));v&&(m=[p]);for(var y=0;y<m.length;y++){var S=m[y],_=S.persistentId;if(_)if(u.get(_)){var x=new o;x.externalPath=t.externalPath.slice(),v||(x.addElement(f),x.addElement(S));for(var b=x._getRenderableOccurrences(),w=0;w<b.length;w++){var M=b[w];i.scene.containsMesh(M)&&h.push(M)}u.delete(_)}}if(u.size>0){var C=new o;C.externalPath=t.externalPath.slice(),C.addElement(g);var P=C._getRenderableOccurrences();if(1===P.length){if(!i.scene.containsMesh(P[0]))return!1;var E=u[Symbol.iterator]();for(var A of E)d.push({mesh:P[0],element:A[1]})}}}return{meshes:h,sgNodes:d}}var p=0;return e.extend({init:function(e,t){this.id=p++,this.sceneGraph=e,this.eventType=t,this.sceneHL=new i.Scene,this.selectedMeshes=new Map,this.selectedMeshesFromPrim=new Map,this.selectedMeshesFromAdjacence=new Map,this.doubleSideHighlight=!0,this.matHL=null,this.node3DMap=new Map;var r={HSO:l,PSO:h};return this._xsoManager=r[this.eventType],this.toUnsubscribe=[],this._attachEvents(),this},_attachEvents:function(){this._detachEvents(!1,!1);var e=this,i=this._xsoManager;this.onSceneGraphUpdate=t.subscribe({event:"/VISU/onSceneGraphUpdate"},function(t){if(e.node3DMap.has(t.fromNode)){if("ADD"==t.eventType){var i=e.node3DMap.get(t.fromNode);e.addNodeToMap(t.toNode,e.node3DMap,i);for(var r=0;r<i.length;r++){var n=i[r].getLastElement(),a=t.toNode,s=[];e._getPaths(n,a,[],s);for(var l=0;l<s.length;l++){var h=new o(i[r].externalPath.slice());h.externalPath=h.externalPath.concat(s[l]),e._add(t.toNode,h)}}}"REMOVE"==t.eventType&&e.removeNodeToMap(t.toNode,e.node3DMap)}}),this.toUnsubscribe.push(i.onPostAdd(function(t){if(null!==t){var i=t.pathElement,r=!!t.forceVisibility;!i&&t.options&&(i=t.options.pathElement,r=!!t.options.forceVisibility),i&&(e.add(i,t.parameters,r),e.sceneGraph.viewer&&e.sceneGraph.viewer.render({onlyPostProcess:!0})),t instanceof Array&&(t.forEach(function(t){e.add(t.pathElement,t.parameters,!!t.forceVisibility)}),e.sceneGraph.viewer&&e.sceneGraph.viewer.render({onlyPostProcess:!0}))}})),this.toUnsubscribe.push(i.onPostRemove(function(t){if(null!==t){var i=t.pathElement;!i&&t.options&&(i=t.options.pathElement),i&&(e.remove(i,t.parameters),e.sceneGraph.viewer&&e.sceneGraph.viewer.render({onlyPostProcess:!0})),t instanceof Array&&(t.forEach(function(t){e.remove(t.pathElement,t.parameters)}),e.sceneGraph.viewer&&e.sceneGraph.viewer.render({onlyPostProcess:!0}))}})),this.toUnsubscribe.push(i.onEmpty(function(){e.sceneGraph.viewer&&e.sceneGraph.viewer.render({onlyPostProcess:!0})}))},_detachEvents:function(e,i){var r;for(r=0;r<this.toUnsubscribe.length;r++)this._xsoManager.unsubscribe(this.toUnsubscribe[r]);this.toUnsubscribe=[],e||(t.unsubscribe(this.onSceneGraphUpdate),this.onSceneGraphUpdate=null)},setDoubleSideHighlight:function(e){this.doubleSideHighlight=e},_getPaths:function(e,t,i,r){var n,a;if(t!=e){i.unshift(t);var s=t.parents;for(a=s.length,n=0;n<a;n++)this._getPaths(e,s[n],i,r);i.shift(t)}else r.push(i.slice(0))},addNodeToMap:function(e,t,i){e.traverse(function(e){var r;if(e instanceof n)if((r=t.get(e))&&r.length){var a,s,o,l,h=r.concat([]);for(a=0;a<i.length;a++){for(o=i[a],l=!0,h.indexOf(o)>=0&&(l=!1),s=0;s<h.length&&l;s++)h[s].hash()===o.hash()&&(l=!1);l&&h.push(o)}t.set(e,h)}else t.set(e,i)})},removeNodeToMap:function(e,t){e.traverse(function(e){e instanceof n&&t.delete(e)})},add:function(e,t,i){var r;if(null!=e){if(null===(r=e.getLastElement()))return!1;r instanceof n&&this.addNodeToMap(r,this.node3DMap,[e]),this._add(r,e,i)}return!0},_add:function(e,t,i){var a=null;if(THREEDS.Nodes.CGRNode&&(a=d(t))&&e instanceof THREEDS.Nodes.CGRNode){var o=s.getFromSGNode(e.internalSceneGraph);t.internalPath.push(o),e=o}var l=t._getRenderableOccurrences(this.sceneGraph.viewer),h=l.length;if(e instanceof n){if(h)for(var c=0;c<h;c++){var p=l[c];void 0!==t.instanceId&&p._instancingInfos&&(p._instancingInfos.pickedInstanceId=[t.instanceId]),this.sceneGraph.scene.containsMesh(p)&&this.addMesh(p,i)}}else if(a&&(e.sgNode instanceof r.SGRep||e.sgNode instanceof r.SGBag||h>1&&e.sgNode instanceof r.SGPrimitiveHelper)){var f=u(e,t,this.sceneGraph,a);for(c=0;c<f.meshes.length;c++)this.addMesh(f.meshes[c],i);for(c=0;c<f.sgNodes.length;c++)this.addPrimitive(f.sgNodes[c].mesh,f.sgNodes[c].element,i,!1)}else{if(1!==h)return!1;if(!this.sceneGraph.scene.containsMesh(l[0]))return!1;this.addPrimitive(l[0],e,i,!1)}},remove:function(e){var t;if(e){var i=e._getRenderableOccurrences(this.sceneGraph.viewer),a=i.length;if(null===(t=e.getLastElement()))return;var o=null;if(THREEDS.Nodes.CGRNode&&(o=d(e))&&t instanceof THREEDS.Nodes.CGRNode){var l=s.getFromSGNode(t.internalSceneGraph);e.internalPath.push(l),t=l}if(t instanceof n){if(this.node3DMap.has(t)&&this.removeNodeToMap(t,this.node3DMap),a)for(var h=0;h<a;h++){var c=i[h];void 0!==e.instanceId&&c._instancingInfos&&(c._instancingInfos.pickedInstanceId=[e.instanceId]),this.sceneGraph.scene.containsMesh(c)&&this.removeMesh(c)}}else if(o&&(t.sgNode instanceof r.SGRep||t.sgNode instanceof r.SGBag||a>1&&t.sgNode instanceof r.SGPrimitiveHelper)){var p=u(t,e,this.sceneGraph,o);for(h=0;h<p.meshes.length;h++)this.removeMesh(p.meshes[h]);for(h=0;h<p.sgNodes.length;h++)this.removePrimitive(p.sgNodes[h].mesh,p.sgNodes[h].element,!1)}else{if(1!==a)return!1;if(!this.sceneGraph.scene.containsMesh(i[0]))return!1;this.removePrimitive(i[0],t,!1)}}},addPrimitive:function(e,t,i,r){var n=null,a=r?this.selectedMeshesFromAdjacence:"rep"===t.getType()?this.selectedMeshes:this.selectedMeshesFromPrim;if(a.has(e)){var s=a.get(e);s.nbSelections++,s.hlMeshPrimScene||(s.hlMeshPrimScene=this.duplicateMeshForHighlight(e,!0,i,a===this.selectedMeshesFromPrim,a===this.selectedMeshesFromAdjacence),this.sceneHL.add(s.hlMeshPrimScene)),n=s.hlMeshPrimScene}else n=this.duplicateMeshForHighlight(e,!0,i,a===this.selectedMeshesFromPrim,a===this.selectedMeshesFromAdjacence),a.set(e,{hlMeshScene:null,hlMeshPrimScene:n,nbSelections:1}),this.sceneHL.add(n),e.addRefVBO(!1);if("rep"===t.getType()||"selectionGroup"===t.getType()){for(var o=!1,l=[],h=t.getChildren(),d=0;d<h.length;d++){var u=h[d];-1===n._findHLIndex(u.sgNode)?l.push(u):o=!0}if(o||"selectionGroup"===t.getType())for(d=0;d<l.length;d++)n.addHighLightPrimitive(l[d].sgNode);else n.addHighLightRep(t.sgNode)}else if("bag"===t.getType()){c(t,function(e,t){if("rep"===e.getType())for(var i=e.getChildren(),r=0;r<i.length;r++){var a=i[r];-1===n._findHLIndex(a.sgNode)&&t.push(a)}},h=[]);for(d=0;d<h.length;d++)n.addHighLightPrimitive(h[d].sgNode)}else if("primitive"===t.getType()){-1===n._findHLIndex(t.sgNode)&&n.addHighLightPrimitive(t.sgNode)}return n},addMesh:function(e,t){var i=null,r=e._occurrence,n=r&&r.isInCanvas2DPass()?["canvas2D"]:null;if(this.selectedMeshes.has(e)){var a=this.selectedMeshes.get(e);a.nbSelections++,a.hlMeshScene||(a.hlMeshScene=this.duplicateMeshForHighlight(e,!1,t,!1,!1),this.sceneHL.add(a.hlMeshScene,n)),i=a.hlMeshScene}else i=this.duplicateMeshForHighlight(e,!1,t,!1,!1),this.selectedMeshes.set(e,{hlMeshScene:i,hlMeshPrimScene:null,nbSelections:1}),this.sceneHL.add(i,n),e.addRefVBO(!1);if(i._instancingInfos&&"instance"===i._instancingInfos.instancingSelectionMode&&e._instancingInfos.pickedInstanceId.length){for(var s=!1,o=e._instancingInfos.pickedInstanceId[0],l=i._instancingInfos.pickedInstanceId,h=0;h<l.length;h++)if(l[h]==o){s=!0;break}s||(i._instancingInfos.pickedInstanceId.push(o),i._instancingInfos.nbInstances++,this.updateInstancedHighLightMesh(i,e))}return i},removeMesh:function(e){var t=null;if(e&&this.selectedMeshes.has(e)){var i=this.selectedMeshes.get(e);if(!(t=i.hlMeshScene))return null;if(i.nbSelections--,i.nbSelections){if(t._instancingInfos&&e._instancingInfos.pickedInstanceId.length){for(var r=-1,n=e._instancingInfos.pickedInstanceId[0],a=t._instancingInfos.pickedInstanceId,s=0;s<a.length;s++)if(a[s]==n){r=s;break}-1!=r&&(t._instancingInfos.pickedInstanceId.splice(r,1),t._instancingInfos.nbInstances--,this.updateInstancedHighLightMesh(t,e))}}else i.hlMeshScene=null,this.sceneHL.remove(t),i.hlMeshPrimScene||(this.selectedMeshes.delete(e),e.releaseVBO(!1),t=null)}return t},getHighlightMeshIndex:function(e){var t;if(e.highlightMeshes)for(t=0;t<e.highlightMeshes.length;t++)if(e.highlightMeshes[t].selectionId===this.id)return t;return-1},setHighlightMesh:function(e,t){if("highlight"===this.attr){!e.highlightMeshes&&t&&(e.highlightMeshes=[]);var i=this.getHighlightMeshIndex(e),r=i>=0?e.highlightMeshes[i]:null;r?t?r.renderable=t:e.highlightMeshes.length>1?e.highlightMeshes.splice(i,1):e.highlightMeshes=null:t&&e.highlightMeshes.push(new HighlightMeshData(this.id,t))}else e[this.attr]=t},removeMeshAndPrimitives:function(e){if(e){var t=this,i=function(i){if(i.has(e)){var r=i.get(e),n=r.hlMeshScene,a=r.hlMeshPrimScene;n&&t.sceneHL.remove(n),a&&t.sceneHL.remove(a),i.delete(e),e.releaseVBO(!1)}};i(this.selectedMeshesFromPrim),i(this.selectedMeshesFromAdjacence),i(this.selectedMeshes)}},removePrimitive:function(e,t,i){var r=null;if(e){var n=i?this.selectedMeshesFromAdjacence:"rep"===t.getType()?this.selectedMeshes:this.selectedMeshesFromPrim;if(n.has(e)){var a=n.get(e);if(!(r=a.hlMeshPrimScene))return null;if(a.nbSelections--,"rep"===t.getType())r.removeHighLightRep(t.sgNode);else if("selectionGroup"===t.getType())for(var s=t.getChildren(),o=0;o<s.length;o++)r.removeHighLightPrimitive(s[o].sgNode);else"primitive"===t.getType()&&r.removeHighLightPrimitive(t.sgNode);r.isMeshHiddenByLayer()&&(a.hlMeshPrimScene=null,this.sceneHL.remove(r)),a.nbSelections||a.hlMeshPrimScene||(n.delete(e),e.releaseVBO(!1),r=null)}}return r},updateHighlight:function(e){},_needsDepth:function(){return!1},duplicateMeshForHighlight:function(e,t,r,n,a){var s,o=e.material;if(e.isCurvedPipe?((s=new i.CurvedPipeMesh(e.geometry,o))._capWorldRadius=e._capWorldRadius,s._nbLODsMinusOne=e._nbLODsMinusOne,s.currentLOD=e.currentLOD,i.InstancedCurvedPipeManager.addHLCurvedPipe(s,e)):s=new i.Mesh(e.geometry,o),s.highLight={map:new Map,primitives:[],nbSelected:[]},s.matApp=e.matApp,s.gas=e.gas,s.materialMode=e.materialMode,s.occurrenceRenderingOverride=e.occurrenceRenderingOverride,s._occurrence=e._occurrence,s.matrixAutoUpdate=!1,s.visible=r||e.visible,s.visibilityFree=r||e.visibilityFree,s.fromLoadedModel=e.fromLoadedModel,s.receiveShadow=!1,s._programID=e._programID,s._vertexColors=e._vertexColors,s._skinning=e._skinning,s._skinningInstancing=e._skinningInstancing,a?s._programID|=i.ProgramIDs.ADJACENCE_HIGHLIGHT:n&&(s._programID|=i.ProgramIDs.PRIMITIVE_HIGHLIGHT),this._needsDepth()&&(s._programID|=i.ProgramIDs.POLITE_HIGHLIGHT),s._ratioData=e._ratioData,s._billboardData=e._billboardData,e.layer&&(s.layer=e.layer.clone(t)),s.frustumCulled=e.frustumCulled,s.setMatrix(e.matrix),e._instancingInfos&&e._instancingInfos.isInstanceNode3D){if(s._instancingInfos={isInstanceNode3D:!0,nbInstances:-1,instancingSelectionMode:e._instancingInfos.instancingSelectionMode,instanceAttribArrays:null,pickedInstanceId:[]},"instance"===e._instancingInfos.instancingSelectionMode){var l,h,c,d,u,p=e._instancingInfos.instanceAttribArrays;for(l in s._instancingInfos.nbInstances=1,s._instancingInfos.instanceAttribArrays={id:p.id},p)"id"!==l&&(d=p[l].itemSize,s._instancingInfos.instanceAttribArrays[l]={itemSize:d},16===(u=p[l].isMat4?16:d)&&(s._instancingInfos.instanceAttribArrays[l].isMat4=!0),c=(h=(e._instancingInfos.pickedInstanceId[0]/5-1)*u)+u,s._instancingInfos.instanceAttribArrays[l].array=p[l].array.subarray(h,c),s._instancingInfos.instanceAttribArrays[l].buffer=null);s._instancingInfos.pickedInstanceId.push(e._instancingInfos.pickedInstanceId[0])}else s._instancingInfos.nbInstances=e._instancingInfos.nbInstances,s._instancingInfos.instanceAttribArrays=e._instancingInfos.instanceAttribArrays;e._instancingInfos.pickedInstanceId=[]}return s},addNewInstanceToMesh:function(e,t,i){},updateInstancedHighLightMesh:function(e,t){var i,r,n,a,s,o,l,h=t._instancingInfos.instanceAttribArrays;for(i in e._instancingInfos.instanceAttribArrays={id:h.id},h)if("id"!==i){a=h[i].itemSize,e._instancingInfos.instanceAttribArrays[i]={itemSize:a},16===(s=h[i].isMat4?16:a)&&(e._instancingInfos.instanceAttribArrays[i].isMat4=!0),o=new Float32Array(e._instancingInfos.nbInstances*s),l=0;for(var c=0;c<e._instancingInfos.nbInstances;c++){n=(r=(e._instancingInfos.pickedInstanceId[c]/5-1)*s)+s;for(var d=r;d<n;d++)o[l++]=h[i].array[d]}e._instancingInfos.instanceAttribArrays[i].array=o,e._instancingInfos.instanceAttribArrays[i].buffer=null}},clearAll:function(){var e=this,t=function(t){t.forEach(function(t,i,r){var n=t.hlMeshScene,a=t.hlMeshPrimScene;n&&e.sceneHL.remove(n),a&&e.sceneHL.remove(a),i.releaseVBO(!1)}),t.clear()};t(this.selectedMeshes),t(this.selectedMeshesFromPrim),t(this.selectedMeshesFromAdjacence),this.node3DMap.clear()}})}),define("Visualization/Selection",["DS/Visualization/Selection","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Selection"),e}),define("DS/Visualization/AbstractHighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Selection"],function(e,t,i,r){"use strict";return r.extend({init:function(e,i){return this._parent(e,i),this.attr="",this.nodeMethod="",this.defaultSetting=null,this.highlightData=new t.HaloHighlightData,this.advanced=this.highlightData instanceof t.AdvancedPoliteHighlightData,this.sceneHL.highlightData=this.highlightData,this.onSelectionRemove=null,this.enabled=!0,this},getHighlightData:function(){this.advanced;var e=null;Object.assign(e,this.highlightData)},_detachEvents:function(t,i){i||(e.unsubscribe(this.onSelectionRemove),this.onSelectionRemove=null),this._parent(t,i)},enable:function(e){this.enabled=e},addMesh:function(e,i){if(e instanceof t.CSS2DNode)return e.element.classList.add("wux-css2dnode-highlighted"),null;if(!e||!e._occurrence)return null;var r=e._occurrence.node;if(r&&r[this.nodeMethod]())return null;var n=this._parent(e,i);return n&&this.setHighlightMesh(e,n),n},removeMesh:function(e){if(e instanceof t.CSS2DNode)return e.element.classList.remove("wux-css2dnode-highlighted"),null;var i=this._parent(e);this.setHighlightMesh(e,i)},addPrimitive:function(e,t,i){var r=this._parent(e,t,i);return r&&this.setHighlightMesh(e,r),r},removePrimitive:function(e,t){var i=this._parent(e,t);this.setHighlightMesh(e,i)},getColorHighlight:function(){return console.warn("Warning: deprecated, use getHighlightData instead"),this.highlightData},getHighlightData:function(){return this.highlightData},isEqualColor:function(e){return!!e&&this.highlightData.isEqual(e)},setColorHighlight:function(e){console.warn("Warning: deprecated, use setHighlightData instead"),this.setHighlightData(this.advanced,e)},setHighlightData:function(e,i){var r=0===this.highlightData.priority;if(e!==this.advanced&&(this.advanced=e,this.highlightData=e?new t.AdvancedPoliteHighlightData(this.defaultSetting.advancedpolite):new t.HaloHighlightData(this.defaultSetting.halo),this.sceneHL.highlightData=this.highlightData,this.sceneHL.__webglObjectsAll))for(var n=this.sceneHL.getAllWebGLObjects(0),a=0;a<n.length;a++){var s=n[a].object;e?s._programID|=t.ProgramIDs.POLITE_HIGHLIGHT:s._programID&=~t.ProgramIDs.POLITE_HIGHLIGHT,this.sceneHL.flagAsGSSOInvalidated(s)}i?this.highlightData._setData(i):this.highlightData._setData(this.advanced?this.defaultSetting.advancedpolite:this.defaultSetting.halo),r&&(this.highlightData.priority=0)},_needsDepth:function(){return this.advanced}})}),define("Visualization/AbstractHighlightSelection",["DS/Visualization/AbstractHighlightSelection","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/AbstractHighlightSelection"),e}),define("DS/Visualization/PreHighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/AbstractHighlightSelection"],function(e,t,i,r){"use strict";return r.extend({init:function(e){return this._parent(e,"PSO"),this.attr="preHighlight",this.linkToPSO=!0,this.nodeMethod="_getExcludeFromPreHL",this.defaultSetting=t.DefaultPreHighlightData,this.highlightData._setData(this.highlightData._needsDepth?this.defaultSetting.advancedpolite:this.defaultSetting.halo),this},_attachEvents:function(){this._parent();var t=this;this.onSelectionRemove=e.subscribe({event:"/VISU/SELECTION/REMOVE"},function(e){t.removeMeshAndPrimitives(e),e.preHighlight=null}),this.onCSIAddPreHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_ADD"},function(e){t.add(e.path,e.parameters)}),this.onCSIRemovePreHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_REMOVE"},function(e){t.remove(e.path,e.parameters)}),this.onCSIPreHighlightUpdate=e.subscribe({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_UPDATE"},function(e){t.__matches(e.parameters)&&t.setHighlightData(e.parameters.advanced,e.parameters.newColor)})},__matches:function(e){var t=this.sceneGraph.viewer;return!e||!e.viewer||e.viewer===t},remove:function(e,t){return!!this.__matches(t)&&this._parent(e)},add:function(e,t,i){return!!this.__matches(t)&&this._parent(e,t,i)},_detachEvents:function(t,i){i||(e.unsubscribe(this.onCSIAddPreHighlight),this.onCSIAddPreHighlight=null,e.unsubscribe(this.onCSIRemovePreHighlight),this.onCSIRemovePreHighlight=null,e.unsubscribe(this.onCSIPreHighlightUpdate),this.onCSIPreHighlightUpdate=null),this._parent(t,i)},detachToPSO:function(){this.linkToPSO&&(this.linkToPSO=!1,this._detachEvents(!0,!0))},attachToPSO:function(){this.linkToPSO||(this.linkToPSO=!0,this._attachEvents())}})}),define("Visualization/PreHighlightSelection",["DS/Visualization/PreHighlightSelection","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/PreHighlightSelection"),e}),define("DS/Visualization/HighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/AbstractHighlightSelection"],function(e,t,i,r){"use strict";return r.extend({init:function(e){return this._parent(e,"HSO"),this.attr="highlight",this.nodeMethod="_getExcludeFromHL",this.defaultSetting=t.DefaultHighlightData,this.isMultiColorSet=!1,this.linkToHSO=!0,this.passes=[],this.highlightData._setData(this.highlightData._needsDepth?this.defaultSetting.advancedpolite:this.defaultSetting.halo),this},_attachEvents:function(){this._parent();var t=this;this.onSelectionRemove=e.subscribe({event:"/VISU/SELECTION/REMOVE"},function(e){t.removeMeshAndPrimitives(e),t.setHighlightMesh(e,null)}),this.onCSIAddHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_HIGHLIGHT_ADD"},function(e){t.add(e.path,e.parameters)}),this.onCSIRemoveHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_HIGHLIGHT_REMOVE"},function(e){t.remove(e.path,e.parameters)}),this.onCSIHighlightUpdate=e.subscribe({event:"/VISU/SELECTION/CSI_HIGHLIGHT_UPDATE"},function(e){t.__matches(e.parameters)&&t.setHighlightData(e.parameters.advanced,e.parameters.newColor)})},_detachEvents:function(t,i){i||(e.unsubscribe(this.onCSIAddHighlight),this.onCSIAddHighlight=null,e.unsubscribe(this.onCSIRemoveHighlight),this.onCSIRemoveHighlight=null,e.unsubscribe(this.onCSIHighlightUpdate),this.onCSIHighlightUpdate=null),this._parent(t,i)},__matches:function(e){var t=this.sceneGraph.viewer;if(this.isMultiColorSet){if(e&&e.highlightColor&&this.highlightData.isEqual(e.highlightColor))return!e.viewer||e.viewer===t}else if(e&&!e.highlightColor||!e)return!e||!e.viewer||e.viewer===t;return!1},remove:function(e,t){return!!this.__matches(t)&&this._parent(e)},add:function(e,t,i){return!!this.__matches(t)&&this._parent(e,t,i)},clearAll:function(){this._parent()},detachToHSO:function(){this.linkToHSO&&(this.linkToHSO=!1,this._detachEvents(!0,!0))},attachToHSO:function(){this.linkToHSO||(this.linkToHSO=!0,this._attachEvents())},setMultiColorMode:function(e){this.isMultiColorSet=e}})}),define("Visualization/HighlightSelection",["DS/Visualization/HighlightSelection","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/HighlightSelection"),e}),define("DS/Visualization/InternalSceneGraph",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents"],function(e,t,i,r,n,a,s,o,l,h,c){"use strict";var d,u,p,f=t.__visibleInCurrentSpace,g=e.extend({init:function(e,r,n){this.parentSceneGraph=null,this.bShowReferenceAxisSystem=!0,this.lockShowReferenceAxisSystem=n,this.scene=new t.Scene,this.scene.matrixWorldNeedsUpdate=!1,this.viewer=e,this.drivesTheRobot=!1,this.viewpointAdded=!1,this.root=new i("",!0),this.root.setLinkedToSceneGraph(!0),this.root.setNotAllowedInPathElement(!0),this.userRoot=new i,this.userRoot.setLinkedToSceneGraph(!0),(r||window.userRootOutOfPathElements)&&this.userRoot.setNotAllowedInPathElement(!0),this.root.addChild(this.userRoot),this.viewer._svgMode&&(this.svgRoot=new i,this.svgRoot._isSVGRoot=!0,this.root.addChild(this.svgRoot),this.svgRoot._setIsAlwaysInForeground(!0)),this.robotRoot=new i,this.robotRoot.exludeFromBounding(!0),this.robotRoot._setVisibilityFree(!0),this.root.addChild(this.robotRoot),this.robotRoot._setIsAlwaysInForeground(!0),this._robot=null,this._customReferenceAxisSystem=null;var a=this;return this.root.subscribe("onready",function(){a.modelEvents.publish("onready")}),this.root3js=new t.Object3D,this.root3js.isRoot3ds=!0,this.root3js.viewer=e,this.root3js.matrixAutoUpdate=!1,this.root3js.matrixWorldNeedsUpdate=!1,this.root.setScene(this.root3js),this.root3js.node=this.root,this.scene.add(this.root3js),this.modelEvents=new c,this._needClippingUpdate=!1,this.selectionHL=new s(this),this.selectionHL.highlightData.priority=0,this.selectionPreHL=new o(this),this.selectionPreHL.highlightData.priority=0,this._subscribedEvents=[],this._onViewpointChangedEvent=null,this},onSelectViewpoint:function(){this.subscribeToOnViewpointChanged()},subscribeToOnViewpointChanged:function(){var e=this.viewer.currentViewpoint,t=this._onViewpointChangedEvent,i=!1;if(t){if(e===t.object)return;t.object.unsubscribe(t.token),this._onViewpointChangedEvent=null,i=!0}var r=this.viewer.currentViewpoint.onMove(this.onViewpointChange.bind(this));this._onViewpointChangedEvent={object:this.viewer.currentViewpoint,token:r},i&&this.onViewpointChange()},onAddViewpoint:function(){if(this.subscribeToOnViewpointChanged(),!this.viewpointAdded){var e=this.viewer.onViewerResize(this.onViewpointChange.bind(this));this._subscribedEvents.push({object:this.viewer,token:e})}this.viewpointAdded=!0,this.lockShowReferenceAxisSystem||this.showReferenceAxisSystem(this.bShowReferenceAxisSystem,!0)},onViewpointChange:function(){var e=this.viewer.currentViewpoint;e&&(e._updateRobotCamera(this),this._robot&&this._robot.onViewpointChange(),this.referenceAxisSystemNode&&this.referenceAxisSystemNode.onViewpointChange())},_detachXSOHLEvents:function(){this.selectionPreHL.detachToPSO(),this.selectionHL.detachToHSO()},_attachXSOHLEvents:function(){this.selectionPreHL.attachToPSO(),this.selectionHL.attachToHSO()},_detachEvents:function(){var e,t;for(this.selectionPreHL._detachEvents(!1,!1),this.selectionHL._detachEvents(!1,!1),e=0;e<this._subscribedEvents.length;e++)(t=this._subscribedEvents[e]).object.unsubscribe(t.token);this._subscribedEvents=[]},getChildByName:function(e){return this.root.getChildByName(e)},getMeshMin:function(e,i){var r,n,a,s,o,l=void 0!==i?i:"z",h=null,c=new t.Vector3;for(n=null,a=0,e.geometry.length>=0?(n=e.geometry[0],a=e.geometry.length):2===e.geometry._type&&(n=e.geometry,a=1),s=0;s<a;s++){if(null===n.vertexPositionArray){n=e.geometry[s+1];continue}r=e._getMMMatrix();const t=n.getVertexCount();for(o=0;o<t;o++)n.getVertexPosition(o,c),c.applyMatrix4(r),(c[l]<h||null===h)&&(h=c[l]);n=e.geometry[s+1]}return h},getSceneMin:function(e,i){if(!this.root3js)return 0;var r="z";if(i&&i.upVector.y>0&&(r="y"),e){if(this.root){var n=this.root.getBoundingBox("show");if(n)return n.min[r]}return 0}var a,s,o,l,h,c=this.root3js.children,d=null,u=null,p=new t.Vector3;for(a=0,s=c.length;a<s;a++)if(o=c[a],f(o.visible,o.visibilityFree,this.viewer.visibleSpace,o.layer,o._occurrence)&&o.frustumCulled&&o.geometry&&null!==o.geometry.boundingSphere&&o.geometry.boundingSphere.radius&&(o.geometry.length&&o.geometry[0].drawingGroups.length||o.isCurvedPipe)){var g=o._getMMMatrix();p.copy(o.geometry.boundingSphere.center),p.applyMatrix4(g),o._centerZ=p[r],l=g?g.getMaxScaleOnAxis():1,h=o._centerZ+o.geometry.boundingSphere.radius*l,(null===d||h<d)&&(d=h)}var m=[];for(a=0,s=c.length;a<s;a++){if(o=c[a],f(o.visible,o.visibilityFree,this.viewer.visibleSpace,o.layer,o._occurrence)&&o.frustumCulled&&o.geometry&&null!==o.geometry.boundingSphere&&o.geometry.boundingSphere.radius&&(o.geometry.length&&o.geometry[0].drawingGroups.length||o.isCurvedPipe))if(l=(g=o._getMMMatrix())?g.getMaxScaleOnAxis():1,o._centerZ-o.geometry.boundingSphere.radius*l<d)if(o.isCurvedPipe||o.geometry[0].vertexPositionArray){var v=o.getMin(r);(null===u||v<u)&&(u=v)}else m.push(o)}if(m.length){var y=this.viewer.renderer.boundingBoxGPUCompute.computeZMinGPU(this.viewer,m);u=null===u?y:Math.min(y,u)}return u},updateShaders:function(){this.viewer.renderer.recompileAllShaders(null)},getBoundingSphere:function(e,i){var r=this.root._occurrences[0]?this.root._occurrences[0].getBoundingSphere(e,!0):null;return i||r&&!(r.radius<=0&&r.pixelRadius<=0)||(r=new t.Sphere(new t.Vector3,100)),r},clearSelection:function(){this.selectionHL.clearAll(),this.selectionPreHL.clearAll()},addRobotNode:function(e){this.robotRoot.addChild(e)},addUserNode:function(e,t){t?this.userRoot.children[0].addChild(e):this.userRoot.addChild(e)},removeUserNode:function(e,t){t?this.userRoot.children[0].removeChild(e,!0):e instanceof i||!e?this.userRoot.removeChild(e,!0):this.userRoot.removeChild(e._private_root,!0)},setRobot:function(e,t,i,r){return e&&!r&&(this.lockShowReferenceAxisSystem=!1),t=t||{},this.drivesTheRobot=!0,this.createAxisSystem(),this._robot&&e&&(this.robotRoot.remove(this._robot,!0),this._robot._dispose(),this._robot=null,this.robot=null),this._robot||this.createRobot(i,t,d),e?this._robot.setHiddenMode(!1):this._robot.setHiddenMode(!0),r||(this.robot=e?this._robot:void 0),!0},getRobot:function(){return this.drivesTheRobot?this.robot:this.getChildByName("robot")},setCustomReferenceAxisSystem:function(e){this._customReferenceAxisSystem&&(this.robotRoot.removeChild(this._customReferenceAxisSystem),this._customReferenceAxisSystem._dispose(),this._customReferenceAxisSystem=null),e&&(this._customReferenceAxisSystem=new p(this.viewer,e),this._customReferenceAxisSystem.setRenderPasses(["robotOrtho"]),this.robotRoot.addChild(this._customReferenceAxisSystem),this._customReferenceAxisSystem.onViewpointChange())},clearScene:function(e,t,i){this.clearSelection();var r,n=this.userRoot.children.length;if("deprecated"===i)for(var a=this.userRoot.children[0];a.children.length;)a.remove(a.children[0]);else for(r=0;r<n;r++)this.userRoot.remove(this.userRoot.children[0])},getUserNodes:function(e){var t,i=[],r=this.getUserRoot(e);for(t=0;t<r.children.length;t++)i.push(r.children[t]);return i},getUserRoot:function(e){return e?this.userRoot.children[0]:this.userRoot},addDebugNode:function(e){this.debugRoot||(this.debugRoot=new i,this.debugRoot.excludeFromBounding=!0,this.root.addChild(this.debugRoot)),this.debugRoot.addChild(e)},removeDebugNode:function(e){this.debugRoot.removeChild(e)},showReferenceAxisSystem:function(e,t){t||(this.lockShowReferenceAxisSystem=!1),this.bShowReferenceAxisSystem=e,this.viewpointAdded&&(this.createAxisSystem(),this.updateReferenceAxisSystemVisibility())},createAxisSystem:function(){this.referenceAxisSystemNode||(this.referenceAxisSystemNode=new u("referenceAxisSystem",this.viewer),this.robotRoot.addChild(this.referenceAxisSystemNode),this.referenceAxisSystemNode.setCameraName("robotCameraOrtho"),this.referenceAxisSystemNode.setRenderPasses(["robotOrtho"]))},createRobot:function(e,t,i){this._robot=new i(this,"robot",e,t.snapOnFace,t.showOnlyManipulated,"I solemnly swear that I am up to no good.",t.touchMode);var r=e.getWorldOrientation();"zup"!==r._woName&&this._robot._setWorldOrientation(r),this.onViewpointChange(),this.updateReferenceAxisSystemVisibility()},updateReferenceAxisSystemVisibility:function(){this.referenceAxisSystemNode&&this.referenceAxisSystemNode._setEnabled(this.bShowReferenceAxisSystem)},setRobotAndRefAxisSystemEnabled:function(e){this._robot&&this._robot._setEnabled(e),this.referenceAxisSystemNode&&this.referenceAxisSystemNode._setEnabled(e)},dispose:function(){for(this._robot&&this._robot._dispose(),this.referenceAxisSystemNode&&this.referenceAxisSystemNode._dispose(),this._customReferenceAxisSystem&&this._customReferenceAxisSystem._dispose(),this._robot=null,this.robot=null,this.referenceAxisSystemNode=null,this._detachEvents(),this.clearScene();this.root.children.length;)this.root.removeChild(this.root.children[0]);var e;for(e in this.scene.dispose(),this.selectionHL=null,this.selectionPreHL=null,this)this[e]=null},setWorldOrientation:function(e){this._robot&&this._robot._setWorldOrientation(e)},forceHighlightVisibility:function(e){if(this.selectionHL&&this.selectionHL.sceneHL){var t=this.selectionHL.sceneHL.children;this.forceHLVisibility(t,e)}},forcePreHighlightVisibility:function(e){if(this.selectionPreHL&&this.selectionPreHL.sceneHL){var t=this.selectionPreHL.sceneHL.children;this.forceHLVisibility(t,e)}},forceHLVisibility:function(e,t){if(t)for(var i=0;i<e.length;i++){(r=e[i]).visible=!0,r.visibilityFree=!0}else for(i=0;i<e.length;i++){var r,n=(r=e[i])._occurrence;n&&n.renderable&&(r.visible=n.renderable.visible,r.visibilityFree=n.renderable.visibilityFree)}},updateStaticOverrides:function(){g._enableStaticOverrides&&(this.root.traverseUnique(function(e){var t=e._getStaticOverrideSet();null!==t&&t._deactivateStaticOverrides()}),this.root.traverseUnique(function(e){var t=e._getStaticOverrideSet();null!==t&&t.applyStaticOverrides()}),this.root.forceUpdate())}});return g.setRobotClasses=function(e,t,i){d=e,u=t,p=i},g._enableStaticOverrides=!0,UWA.namespace("THREEDS/InternalSceneGraph",g)}),define("Visualization/InternalSceneGraph",["DS/Visualization/InternalSceneGraph","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/InternalSceneGraph"),e}),define("DS/Visualization/ViewpointManager",["DS/Visualization/InternalSceneGraph"],function(e){"use strict";var t=function(e){this.viewer=e,this.vpList=[],this.attachedScenegraphs=new Map,this.viewports=new Map,this.manipulated=null,this.warnCount=0};return t.prototype.addViewpoint=function(t,i){if(t.control&&(t.isMain()&&null==this.manipulated?this.setManipulatedViewpoint(t):t.control.setActive(!1)),null!=this.manipulated&&this.manipulated.control&&this.manipulated.control.updateEditGesture(),this.vpList.push(t),!i){let i=new e(this.viewer,!0,!1);t._setInternalSceneGraph(i),this.attachedScenegraphs.set(t,i)}},t.prototype.clearNonCSIViewpoints=function(){for(let e=this.vpList.length-1;e>=0;e--){let t=this.vpList[e];null===t.getCsiUID()&&this.removeViewpoint(t)}},t.prototype.removeViewpoint=function(e){let t=this.vpList.indexOf(e);this.manipulated&&this.manipulated.camera.id==e.camera.id&&this.setManipulatedViewpoint(null),t>=0&&this.vpList.splice(t,1)},t.prototype.addMainViewpoint=function(e,t){e._isMain=!0,this.addViewpoint(e,t)},t.prototype.setManipulatedViewpoint=function(e){this.manipulated&&this.manipulated.control.setActive(!1),e?(e.control.setActive(!0),this.manipulated=e):this.manipulated=null},t.prototype.getManipulatedViewpoint=function(e){return this.manipulated},t.prototype.setViewpointViewport=function(e,t,i,r,n,a){this.viewports.set(e,{fixed:t,x:i,y:r,width:n,height:a}),this.resizeViewpoint(e)},t.prototype.getViewpointViewport=function(e){let t=this.viewports.get(e);if(t){if(t.fixed)return t;{let e=Math.round(t.x*this.viewer.SCREEN_WIDTH),i=Math.round(t.width*this.viewer.SCREEN_WIDTH);return{x:e,y:Math.round(t.y*this.viewer.SCREEN_HEIGHT),width:i,height:Math.round(t.height*this.viewer.SCREEN_HEIGHT)}}}return null},t.prototype.resizeViewpoint=function(e,t,i){let r=this.getViewpointViewport(e),n=t||this.viewer.SCREEN_WIDTH,a=i||this.viewer.SCREEN_HEIGHT;r&&(n=r.width,a=r.height),e.camera.aspect=n/a,e.camera.updateProjectionMatrix(),e.connectedRobotCamera.aspect=n/a,e.connectedRobotCamera.updateProjectionMatrix(),e.robotCameraOrtho.aspect=n/a,e.robotCameraOrtho.setVisualizedHeight(null,e.robotCameraOrtho.aspect),e.robotCameraOrtho.updateProjectionMatrix(),e.resize(n,a)},t.prototype.resize=function(e,t){if(this.isViewpointManagerOverridenBadly())this.resizeViewpoint(this.viewer.currentViewpoint,e,t);else for(let i=0;i<this.vpList.length;i++){let r=this.vpList[i];this.resizeViewpoint(r,e,t)}},t.prototype.getViewpointScenegraph=function(e){return this.attachedScenegraphs.get(e)},t.prototype.isViewpointManagerOverridenBadly=function(){let e=this.viewer.currentViewpoint;if(e){for(let t=0;t<this.vpList.length;t++)if(this.vpList[t]==e)return!1;return this.warnCount<10&&(console.warn("viewer.currentViewpoint wasn't properly processed, you have to go through AddViewpoint/SelectViewpoint api to replace currentViewpoint"),this.warnCount++),!0}return!1},t.prototype.getVpList=function(){return this.isViewpointManagerOverridenBadly()?[this.viewer.currentViewpoint]:this.vpList},t.prototype.addNodeToViewpoint=function(e,t){},t.prototype.getAuxiliaryScenegraphs=function(){let e=[];for(let t=0;t<this.vpList.length;t++)this.attachedScenegraphs.has(this.vpList[t])&&e.push(this.attachedScenegraphs.get(this.vpList[t]));return e},t.prototype.dispose=function(){for(let e=0;e<this.vpList.length;e++){let t=this.vpList[e],i=this.getViewpointScenegraph(t);t.dispose(),i&&i.dispose()}this.viewports=null,this.attachedScenegraphs=null,this.vpList=null},UWA.namespace("THREEDS/ViewpointManager",t)}),define("DS/Visualization/DecalNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){if(!e.DecalManager._creatingDecal)throw"Use Decal Manager to create decals";return this._parent(t,i),this.decalNode3DBooleanAttr=0,this._setHasExplicitUv(!1),this._decalAttachedTo=new Set,this.setVisibilityFree(!0),this.setMaterialMode(1),e.DecalManager.activated=!0,this},setExplicitUv:function(t){this._setHasExplicitUv(t);for(var i=this._getAllOwningViewers(),r=0;r<i.length;r++)e.DecalManager.updateDecalsData(i[r],!0)},isExplicitUv:function(){return this._getHasExplicitUv()},__shareAttachementFrom:function(e){this._decalAttachedTo=e},attachTo:function(e){return!e._isDecal&&(this._decalAttachedTo.add(e),this._updateMatrix(),!0)},getAttachedTo:function(){return Array.from(decalNode._decalAttachedTo)},applyOn:function(e){return e.addChild(this)},getAppliedOn:function(){return this.parents.slice()},applyAndAttach:function(e){return this.attachTo(e)&&this.applyOn(e)},unapply:function(e){if(!this.parents.length)return!1;if(e)return e.removeChild(this);for(var t=0;t<this.parents.length;t++)this.parents[t].removeChild(this);return!0},detach:function(e){return e?this._decalAttachedTo.delete(e):this._decalAttachedTo.clear(),this._updateMatrix(),!0},unapplyAndDetach:function(){return this.unapply(null)&&this.detach(null)},addChild:function(e){return!1},removeChild:function(e){return!1},setMaterialMode:function(i){e.DecalManager._creatingDecal&&t.prototype.setMaterialMode.call(this,i)},_propagateVisuFilters:function(e,t){},setVisuFilters:function(e){}});i.prototype._isDecal=!0;var r=1;return i.prototype._getHasExplicitUv=function(){return(this.decalNode3DBooleanAttr&r)>0},i.prototype._setHasExplicitUv=function(e){this.decalNode3DBooleanAttr=e?this.decalNode3DBooleanAttr|r:this.decalNode3DBooleanAttr&~r},UWA.namespace("THREEDS/Nodes/DecalNode3D",i)}),define("Visualization/DecalNode3D",["DS/Visualization/DecalNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/DecalNode3D"),e}),define("DS/Visualization/SceneGraphFactory",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/DecalNode3D","DS/Visualization/EditableMesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/CanvasNodeTexture","DS/SceneGraphNodes/CanvasNode","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/Canvas2DNode","DS/SceneGraphNodes/Canvas2DInstancingNode","DS/Effects/ComputeSDFFontIterative","DS/Effects/DownSamplingEffect","DS/Effects/ComputeSDFFontMergeTiles","DS/Visualization/MaterialApplication"],function(e,t,i,r,n,a,s,o,l,h,c,d,u,p,f,g,m,v,y){"use strict";var S,_,x,b,w,M,C,P,E,A,T,D,I,R=new h,O={textCanvas:null,iterativeCompute:null,downSampling:null,mergeTiles:null},L=["left","center","right"],V=[0,.5,1],F=["top","bottom","middle","alphabetic","hanging"],B=[0,1,.5,1,0],N={createMeshNode:function(t,a,o,l,h,c){var d,u,p,f,g,m,v,y,S=void 0!==o?o:0,_=void 0!==a?a:t.material;e.disableJHGDev&&null==_&&(d=new e.Color,u=new e.Color(6710886),p=new e.Color,(_=e.MaterialUtils.createShinyFaceMaterial({color:d.getHex(),opacity:1})).line=new e.LineBasicMaterial({color:u.getHex(),lineWidth:1,opacity:1}),_.point=new e.ParticleBasicMaterial({color:p.getHex(),size:1,opacity:1})),f=new s.SGBag,g=new s.SGRep({cgmId:S,parent:f}),s.validatePrimitiveGroup(t);var x,b=s.checkMeshOptimizable(t),w=b&&t.editable,M=b&&(t.editable||t.optimized),C=!w&&t.sharing;if(M)v=[s.createGeometryOptimized(t,g)],w&&(v[0].editable=!0);else{t.editable?console.warn("Could not make the mesh editable since it does not satisfy the editability rules : no strips and fans, no multi-indexation, 1 buffer per vertex component, 1 index buffer."):t.optimized&&console.warn("Could not optimize the mesh build since it does not satisfy the editability rules : no strips and fans, no multi-indexation, 1 buffer per vertex component, 1 index buffer.");for(var P=0;P<t.buffers.length;P++){var E=t.buffers[P];if(E&&E.component===s.VertexComponentEnum.DIFFUSE_COLOR){if(3===E.dimension){E.dimension=4,E.size*=4/3;for(var A=E.data,T=A.length/3,D=new Float32Array(4*T),I=0,R=0;R<T;R++)D[I]=A[3*R],D[I+1]=A[3*R+1],D[I+2]=A[3*R+2],D[I+3]=1,I+=4;E.data=D}else 4!==E.dimension&&console.error("ERROR : Your Color Buffer should have 4 values per vertex (RGBA)");break}}(m=s.convertToGeometry3js(t,void 0,void 0,void 0,l,!1,h)).rep=g,(v=s.divideRep(m)).sceneGraph=f,t.patternOffsets&&(v.patternOffsets=t.patternOffsets)}return y=s.convertTo3jsMesh(v,_,!0,C),x=c?new r(y):w?new n(y):new i(y),!e.disableJHGDev&&_&&x.setMaterial(_),t.noz&&x.setRenderPasses(["noz"]),x},isReady:function(){return this.root.isReady()},applyMaterialOpacityOverrideToPath:function(){return!1},applyMaterialOverrideToPath:function(){return!1},removeAnyMaterialOverride:function(){return!1},createCuboidNode:function(e){var t=R.CreateVis3DCuboid(e);return this.createMeshNode(t,e.material,void 0,void 0,void 0,!!e._decal)},createCuboidNodeFromBox3:function(e,t){var i=R.CreateVis3DCuboidFromBox3(e,{});return this.createMeshNode(i,t,void 0,"mono")},createSphereNode:function(e){var t=R.CreateVis3DSphere(e);return this.createMeshNode(t,e.material,void 0,"mono")},createTubeNode:function(e){var t=R.CreateVis3DTube(e);return this.createMeshNode(t,e.material,void 0,"mono")},createCylinderNode:function(e){var t=R.CreateVis3DCylinder(e);return this.createMeshNode(t,e.material,void 0,"mono")},createConeNode:function(e){var t=R.CreateVis3DCone(e);return this.createMeshNode(t,e.material,void 0,"mono")},createCylinderCustomNode:function(e){var t=R.CreateVis3DCylinderCustom(e);return this.createMeshNode(t,e.material,void 0,"mono")},createLineNode:function(e){var t=R.createLine(e);return this.createMeshNode(t,e.material)},createRectangleNode:function(e){var t=R.createRectangle(e);return this.createMeshNode(t,e.material)},createCircleNode:function(e){var t=R.createCircle(e);return this.createMeshNode(t,e.material)},createTorusNode:function(e){var t=R.createTorus(e);return this.createMeshNode(t,e.material)},createPointsNode:function(e){var t=R.createPoints(e.positions,e.color,e.size,e.layerNb);return this.createMeshNode(t,e.material)},createSimpleMeshNode:function(e){var t=R.createMesh(e.bufferPosition,e.bufferNormal,e.bufferUV,e.bufferIndex,e.glType,e.color,void 0,e.axis,e.layerNb);return this.createMeshNode(t,e.material)},createTessellatedCurvedPipe:(S=new e.Vector3,_=new e.Vector3,x=new e.Vector3,b=new e.Vector3,w=new e.Vector3,M=new e.Vector3,C=new e.Vector3,P=new e.Vector3,E=new e.Vector3,A=new e.Vector3,T=new e.Vector3,D=new e.Vector3,I=new e.Vector3,function(t,r,n,a,o,l,h,c,d){var u=new e.BufferGeometryDS;u.sharedBuffers=!0;var p=n.length/3;S.set(n[0]+a.x,n[1]+a.y,n[2]+a.z),_.set(n[3*(p-1)]+o.x,n[3*(p-1)+1]+o.y,n[3*(p-1)+2]+o.z),u.drawingGroups=[];var f=6*t*(p-1)+6*(t-2),g=new s.DrawingGroup(c,d,4,0,f);g.geometry=u,u.drawingGroups.push(g);for(var m=(p+2)*t,v=new Float32Array(3*m),y=new Float32Array(3*m),R=0,O=new Array(t),L=new Array(t),V=0;V<t;V++){var F=2*Math.PI*(V/t);O[V]=Math.cos(F),L[V]=Math.sin(F)}P.copy(l);for(var B=[],N=[],G=0;G<p;G++){b.set(n[3*G],n[3*G+1],n[3*G+2]),0===G?x.copy(S):x.set(n[3*(G-1)],n[3*(G-1)+1],n[3*(G-1)+2]),G===p-1?w.copy(_):w.set(n[3*(G+1)],n[3*(G+1)+1],n[3*(G+1)+2]),M.subVectors(b,x).normalize(),C.subVectors(w,b).normalize(),T.addVectors(M,C).normalize();var k=P.dot(T);for(D.copy(T).multiplyScalar(k),I.subVectors(P,D),E.crossVectors(T,I),V=0;V<t;V++){A.set(O[V]*I.x+L[V]*E.x,O[V]*I.y+L[V]*E.y,O[V]*I.z+L[V]*E.z).normalize();var U=r*A.x,z=r*A.y,H=r*A.z;0===G&&(B.push(-T.x),B.push(b.x+U),B.push(-T.y),B.push(b.y+z),B.push(-T.z),B.push(b.z+H)),G===p-1&&(N.push(T.x),N.push(b.x+U),N.push(T.y),N.push(b.y+z),N.push(T.z),N.push(b.z+H)),y[R]=U,v[R++]=b.x+U,y[R]=z,v[R++]=b.y+z,y[R]=H,v[R++]=b.z+H}P=I}for(V=0;V<B.length/2;V++)y[R]=B[2*V],v[R++]=B[2*V+1];for(V=0;V<N.length/2;V++)y[R]=N[2*V],v[R++]=N[2*V+1];u.vertexPositionArray=v,u.vertexNormalArray=y;var W=new Uint16Array(f),j=0,X=0,q=0,Z=0,Y=0,Q=0;for(G=0;G<p-1;G++)for(V=0;V<t;V++)X=(Q=G*t)+V,q=Q+(V+1)%t,Z=Q+V+t,Y=V===t-1?Q+t:(Q+V+t+1)%m,W[j++]=X,W[j++]=q,W[j++]=Z,W[j++]=q,W[j++]=Y,W[j++]=Z;for(Q=p*t,V=0;V<t-2;V++)W[j++]=Q,W[j++]=Q+V+2,W[j++]=Q+V+1,W[j++]=Q+t,W[j++]=Q+t+V+1,W[j++]=Q+t+V+2;u.vertexIndexArray=W;var K=[];K.push(u);var J=new e.Mesh(K,d);J.matrixAutoUpdate=!1;var $=function(t,i){for(var r=new e.Vector3(1/0,1/0,1/0),n=new e.Vector3(-1/0,-1/0,-1/0),a=new e.Vector3,s=new e.Vector3,o=new e.Vector3,l=new e.Vector3,h=new e.Vector3,c=new e.Vector3,d=new e.Vector3,u=new e.Vector3,p=null,f=i.length/3-1,g=0;g<f;g++){s.set(i[3*g],i[3*g+1],i[3*g+2]),o.set(i[3*g+3],i[3*g+4],i[3*g+5]),a.subVectors(o,s);var m=a.dot(a);l.set(t*Math.sqrt(1-a.x*a.x/m),t*Math.sqrt(1-a.y*a.y/m),t*Math.sqrt(1-a.z*a.z/m)),h.subVectors(s,l),d.subVectors(o,l),h.min(d),c.addVectors(s,l),u.addVectors(o,l),c.max(u),p=new e.Box3(h,c),r.min(p.min),n.max(p.max)}var v=(new e.Vector3).addVectors(r,n).multiplyScalar(.5),y=(new e.Vector3).addVectors(v,(new e.Vector3).subVectors(r,v).multiplyScalar(1.05)),S=(new e.Vector3).addVectors(v,(new e.Vector3).subVectors(n,v).multiplyScalar(1.05));return new e.Box3(y,S)}(r,n),ee=new i(J,"");return ee.forceBoundingBox($),ee}),createTextNode:function(e){return e.sdf?this.createSDFTextNode.apply(this,arguments):this.createTextNodeZoomable.apply(this,arguments)},createSDFTextNode:function(t){var i,r,n,a,s,o,l,h,c;t.resolutionCoef=256,t.color||(t.color=new e.Color("white")),i="font-family: "+t.font+"; font-size: "+t.resolutionCoef+"px;",s=(n=(r=t.precomputedTextSize||R._determineTextSize(t.text,i,"pre")).width)/(a=r.height),O.textCanvas||(O.textCanvas=document.createElement("canvas")),(o=O.textCanvas).width=n,o.height=a,(l=o.getContext("2d")).fillStyle="#ffffff",l.fillRect(0,0,n,a),l.fillStyle="#000000",l.lineWidth=0,l.strokeStyle="#000000",l.font=t.resolutionCoef+"px "+t.font,l.textAlign="left",l.textBaseline="top",l.fillText(t.text,0,0),l.restore(),h=n/t.resolutionCoef,(c=R.createRectangle(t.fontSize*h,t.fontSize*h/s,!0,void 0,void 0,t.layerNb)).noz=t.layerNb>0;var d=null;if(0!==o.width||0!==o.height){O.iterativeCompute||(O.iterativeCompute=new g(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool)),O.downSampling||(O.downSampling=new m(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool)),O.mergeTiles||(O.mergeTiles=new v(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool));for(var u=O.iterativeCompute.gl,p=performance.now(),f=p,y=l.getImageData(0,0,o.width,o.height),S=(new ArrayBuffer(y.data.length),Math.floor(o.width/8)),_=Math.floor(o.height/8),x=1+Math.ceil((o.width-512)/448),b=1+Math.ceil((o.height-512)/448),w=new Uint8Array(1048576),M=(new Uint8Array(16384),new Uint8Array(4*S*_)),C=null,P=(performance.now(),0);P<b;P++)for(var E=448*P,A=E/8,T=0;T<x;T++){var D=448*T,I=D/8,L=T===x-1?o.width-448*T:512,V=P===b-1?o.height-448*P:512,F=Math.floor(L/8),B=Math.floor(V/8),N=E*o.width+D,G=0;p=performance.now();for(var k=0;k<512;k++)for(var U=0;U<512;U++)if(U<L&&k<V){var z=N+k*o.width+U;w[G++]=y.data[4*z],w[G++]=y.data[4*z+1],w[G++]=y.data[4*z+2],w[G++]=y.data[4*z+3]}else w[G++]=255,w[G++]=255,w[G++]=255,w[G++]=255;C||(C=new e.DataTexture(w,512,512,e.RGBAFormat,e.UnsignedByteType,new e.UVMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),O.iterativeCompute.setMap(C,50),O.downSampling.setSize(512,512),O.downSampling.setInput(O.iterativeCompute.composers[1]),O.mergeTiles.setSize(S,_),O.mergeTiles.setInput(O.downSampling.composers[2])),C.needsUpdate=!0,p=performance.now();for(var H=0;H<50;H++)O.iterativeCompute.executeStep(H,49===H);O.downSampling.execute(),O.mergeTiles.setTileInfos(I,A,64,64,F,B),O.mergeTiles.execute()}p=performance.now(),u.readPixels(0,0,S,_,u.RGBA,u.UNSIGNED_BYTE,M),(d=new e.DataTexture(M,S,_,e.RGBAFormat,e.UnsignedByteType,new e.UVMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearMipMapLinearFilter)).needsUpdate=!0,d.flipY=!0,console.log(">>>>> generated SDF from bitmap in "+(performance.now()-f)+"ms")}c.material=new e.MeshBasicMaterial({force:!0,side:t.side?t.side:e.FrontSide,transparent:!0}),c.material.activatePDSFX();var W={fontMap:{type:"t2",value:d},_color:{type:"v3",value:new e.Vector3(t.color.r,t.color.g,t.color.b)},ratio:{type:"f",value:_/S}};c.material.setPDSFXUniforms(W);c.material.setPDSFXVaryings({_uv:{type:"v2"}}),c.material.setPDSFXGlobalShaderCode("","float alpha;");var j={ComputeCommonValues:["void ComputeCommonValues() {","float epsilon = 0.003;","float texel = texture2D(fontMap, _uv).r;","#if defined(GL_OES_standard_derivatives) || defined(GLSL300ES)","    float w = clamp(200.0 * epsilon * (abs(dFdx(texel)) + abs(dFdy(texel))), 0.0, 0.5);","#else","    float w = epsilon;","#endif","alpha = smoothstep(0.5 - w, 0.5 + w, 1.0 - texel);","alpha = pow(alpha, 1.0/2.2);","}"].join("\n"),ComputeDiscard:["bool ComputeDiscard() {","float alphaTest = 0.01;","return (alpha < alphaTest);","}"].join("\n"),ComputeAlbedo:"vec3 ComputeAlbedo() { return _color; }",ComputeOpacity:"float ComputeOpacity() { return alpha; }"};return c.material.setPDSFXOverridableFunctions({ComputeVaryingValues:"void ComputeVaryingValues() { _uv = vGetAttribTexCoord0().xy; }"},j),this.createMeshNode(c)},createTextNodeZoomable:function(t){var i=t.resolutionCoef||32,r="";t.bold&&(r+="font-weight : bold; "),t.italic&&(r+="font-style: italic;");var n=r+"font-family: '"+t.font+"'; font-size: "+i+"px;",a=t.precomputedTextSize||R._determineTextSize(t.text,n),s=a.width,o=a.height,l=s/o,h=t.side?t.side:e.FrontSide,u=t.textAlign?L[t.textAlign]:"left",p=t.textBaseline?F[t.textBaseline]:"top",f=t.textAlign?V[t.textAlign]:0,g=t.textBaseline?B[t.textBaseline]:0,m=t.zoom||1,v=s/i,y=t.fontSize*v*m,S=t.fontSize*v/l*m,_=!!t.stroke&&t.stroke,x=s,b=o;if(t._fix&&(!x||!b||!isFinite(b)||!isFinite(x)))return null;var w=new c({width:x,height:b,drawCB:function(e,r,n){var a=f*x,s=g*b;try{r.fillStyle="#"+t.color.getHexString(),r.lineWidth=0,r.strokeStyle="#"+t.color.getHexString();var o=(t.bold?"bold ":"")+(t.italic?"italic ":"");if(r.font=o+i+"px '"+t.font+"',Arra",r.textAlign=u,r.textBaseline=p,_?r.strokeText(t.text,a,s):r.fillText(t.text,a,s),t._debug&&(r.strokeStyle="red",r.moveTo(0,s),r.lineTo(x,s),r.stroke(),r.moveTo(0,0),r.moveTo(a,0),r.lineTo(a,b),r.stroke(),r.moveTo(0,0)),window.WUXDisableTextNodes)return void r.clearRect(0,0,x,b)}catch(e){console.log(failed)}},rectangleTexture:!0,maxZoom:8,depthWrite:t.depthWrite}),M=t.hotspot||{x:0,y:0};return t.bbox?new d({name:t.name,bottomLeftcorner:new e.Vector3(t.bbox[0],t.bbox[2],0),widthVector:new e.Vector3(t.bbox[1]-t.bbox[0],0,0),heightVector:new e.Vector3(0,t.bbox[3]-t.bbox[2],0),canvasNodeTexture:w,side:h},N):new d({name:t.name,bottomLeftcorner:new e.Vector3(-M.x*y,-M.y*S,0),widthVector:new e.Vector3(y,0,0),heightVector:new e.Vector3(0,S,0),canvasNodeTexture:w,side:h},N)},createCanvasNode:function(e){return new d(e,N)},createCanvas2DNode:function(e){return new p(e,N)},createCanvas2DInstancingNode:function(e){return new f(e,N)},createNodeFromTHREEMesh:function(e){var t=R.convertFromTHREEMesh(e);return this.createMeshNode(t)},createFixedSizeNode:function(e){return new u({name:(e=e||{}).name,ratio:e.ratio||1})}};return N}),define("Visualization/SceneGraphFactory",["DS/Visualization/SceneGraphFactory","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SceneGraphFactory"),e}),define("DS/Visualization/Ambience",["DS/Visualization/ThreeJS_DS","DS/Effects/ConvertCubemapToLatlong","DS/Visualization/SceneGraphFactory","DS/Visualization/Utils","DS/Visualization/WorldOrientation","DS/CoreEvents/Events","DS/Effects/ExtractLightFromIBL","DS/Effects/MergeMainMipsEffect","WebappsUtils/WebappsUtils"],function(e,t,i,r,n,a,s,o,l){"use strict";var h=e._AmbianceGenerators._dummyRoughnessTexture,c=function(t,i){var r=void 0!==(t=t||{}).image?t.image:null,n=void 0!==t.format?t.format:null,a=void 0!==t.sRGB?t.sRGB:"hdr"!=n,s=void 0!==t.type?t.type:"url",o=void 0!==t.texture?t.texture:null,l=void 0!==i?i:null,h=function(){console.log("loading image error")};this.stream=function(){return o?{texture:o,format:n}:null},this.getTexture=function(){return o},this.getImage=function(){return r},this.getFormat=function(){return n},this.isSRGB=function(){return a},this.isTextureHDRFloat=function(){return!(!o||o.type!=e.FloatType||o.format!=e.RGBFormat)},this.getType=function(){return s},this.setTexture=function(e){a=(o=e).sRGB},this.setFormat=function(e){n=e,"hdr"==e&&(a=!1)},this.setSRGB=function(e){a=e},this.setType=function(e){s=e},this.loadImage=function(t){var i=this.getImage(),r=this;if("url"==this.getType())if("hdr"==this.getFormat())(o=e.ImageUtils.loadHDRTexture(i,t,l,h,!1,!1)).minFilter=e.NearestFilter,o.magFilter=e.NearestFilter;else if("dds"==this.getFormat()){o=e.ImageUtils.loadCompressedTexture(i,t,function(e){r.isTextureHDRFloat()&&(r.setFormat("hdr"),e.hdr=!0,e.rgbHdr=!0),r.setSRGB(e.sRGB),l(e)})}else o=new e.ImageUtils.loadTexture(i,t,l,null,e.ImageUtils.crossOriginPolicy);"urlCube"==this.getType()?o=e.ImageUtils.loadTextureCube(i,t,l):i&&i instanceof e.Texture&&((o=i).loadEndStatus===e.AssetLoadingStatus.READY?l():o.onLoadCallbacks.push(l))}},d=function(){var t=!1;this.needUpdate=!1,this.needUpdateParameters=!1;var i="latlong",r=[],n=0,a=new c,s="bestFit",o=1,l=1,h=null,d=0,u=1,p={transition:0,image:new c,ambienceMatrix:new e.Matrix4,inverseMatrix:new e.Matrix4,radius:0},f=this,g=function(e){f.needUpdate=!0};this.setFromJson=function(h){if(t=!0,this.needUpdate=!0,h.type&&(i=h.type),h.sizeScaling&&(s=h.sizeScaling),h.intensity&&(o=h.intensity),h.blur&&(d=h.blur),h.ratio&&(l=h.ratio),h.horizonHeight&&(n=h.horizonHeight),h.image&&h.image.texture&&(a.setTexture(h.image.texture),a.setFormat(h.image.format)),h.colors)for(var c=0;c<h.colors.length;c++)r.push((new e.Color).setRGB(h.colors[c][0],h.colors[c][1],h.colors[c][2]))},this.stream=function(){if(t){var e={};if(e.type=i,r.length){for(var h=[],c=0;c<r.length;c++)h.push([r[c].r,r[c].g,r[c].b]);e.colors=h}return e.horizonHeight=n,e.sizeScaling=s,e.intensity=o,e.blur=d,e.ratio=l,e.image=a.stream(),e}return null},this.isActivated=function(){return t},this.getType=function(){return i},this.initDefaultColors=function(t){r=[];for(var i=0;i<t;i++)r.push(new e.Color)},this.getColors=function(){switch(this.getType()){case"gradient":2!=r.length&&this.initDefaultColors(2);break;case"gradient3":3!=r.length&&this.initDefaultColors(3);break;case"gradientWithHorizon":4!=r.length&&this.initDefaultColors(4)}return r},this.getHorizonHeight=function(){return n},this.getBackplateScale=function(){return u},this.setBackplateScale=function(e){e!==u&&(u=e,"backplate"==i&&(this.needUpdateParameters=!0))},this.getImage=function(){return a},this.getSizeScaling=function(){return s},this.getIntensity=function(){return o},this.getBlur=function(){return d},this.getRatio=function(){return l},this.getBackplateCB=function(){return h},this.setActivated=function(e){e!=t&&(this.needUpdate=!0),t=e},this.setType=function(e){i!=e&&(i=e,this.needUpdate=!0),t||this.setActivated(!0)},this.setColors=function(e){var t;switch((r=e).length){case 2:t="gradient";break;case 3:t="gradient3";break;case 4:t="gradientWithHorizon";break;default:return!1}this.setType(t),this.needUpdateParameters=!0},this.setHorizonHeight=function(e){n=e,this.needUpdateParameters=!0},this.setSizeScaling=function(e){s=e,this.needUpdateParameters=!0},this.setIntensity=function(e){o=e,this.needUpdateParameters=!0},this.setBlur=function(e){d=e,this.needUpdateParameters=!0},this.setRatio=function(e){l=e,this.needUpdateParameters=!0},this.setBackplateCB=function(e){h=e,this.needUpdateParameters=!0},this.hasGradient=function(){return t&&("gradient"==i||"gradientWithHorizon"==i)},this.loadImage=function(t){t.doneCallback&&(g=function(){t.doneCallback(),f.needUpdate=!0}),t.type="url",t&&t.image&&t.image instanceof e.Texture&&(t.type="THREETexture"),t&&t.image&&t.image instanceof Array&&(t.type="urlCube"),(a=new c(t,g)).loadImage(function(t,i){switch(t){case"cubemap":return new e.CubeEnvMapping;case"environment":return new e.LatLongReflectionMapping;case"latlong":return new e.LatLongEnvMapping;case"backplate":return new e.SimpleEnvMapping}}(this.getType(),this.getSizeScaling()))},this.withImage=function(){if(!a.getTexture())return!1;var e=this.getType();return"cubemap"==e||"latlong"==e||"backplate"==e||"transition"==e},this.getTransitionInfos=function(){return p},this.setTransitionInfos=function(e){p=e}},u=function(){var t=!1;this.needUpdate=!1,this.needUpdateParameters=!1;var i=!1,r="sphere",n=5e3,a=new e.Vector3(0,0,.5),s=!1;this.setFromJson=function(e){t=!0,this.needUpdate=!0,e.type&&(r=e.type),e.size&&(n=e.size),e.shootPosition&&a.set(e.shootPosition[0]/n,e.shootPosition[1]/n,e.shootPosition[2]/n)},this.setYUp=function(e){i=e},this.stream=function(){if(t){var e={};return e.type=r,e.size=n,e.shootPosition=a.toArray(),e}return null},this.isActivated=function(){return t},this.getType=function(){return r},this.getSize=function(){return n},this.isAutoUpdateSize=function(){return s},this.getShootPosition=function(){return i?new e.Vector3(a.x,a.z,a.y):a},this.getWorldShootPosition=function(t){var i=(new e.Matrix4).extractRotation(t);return this.getShootPosition().clone().applyMatrix4(i)},this.setActivated=function(e){e!=t&&(this.needUpdate=!0),t=e},this.setType=function(e){r=e,this.needUpdate=!0},this.setSize=function(e){n>0&&(n=e),this.needUpdateParameters=!0},this.setAutoUpdateSize=function(e){s=e},this.setShootPosition=function(e){a=e,this.needUpdateParameters=!0}},p=function(){var t=!1;this.needUpdate=!1,this.needUpdateParameters=!1,this.needsUpdateShadowIntensity=!1;var i="transparent",r=0,n=0,a=1,s=0,o=new e.Color;this.disableDefaultGroundShadow=!1;var h=null,c=!0;this.setFromJson=function(e){t=!0,this.needUpdate=!0,e.type&&(i=e.type),e.planeColor&&this.setPlaneColor(e.planeColor),void 0!==e.height&&(r=e.height),void 0!==e.reflectivity&&(n=e.reflectivity),void 0!==e.glossiness&&(a=e.glossiness),void 0!==e.shadowIntensity&&(s=e.shadowIntensity),e.material},this.stream=function(){if(t){var e={};return e.type=i,e.height=r,e.autoHeight=c,e.reflectivity=n,e.glossiness=a,e.shadowIntensity=s,e.material=h,e}return null},this.isActivated=function(){return t},this.getPlaneColor=function(){return o},this.isPhysical=function(){return!!h&&"physical"==this.getType()},this.getType=function(){return i},this.getHeight=function(){return r},this.getAutoHeight=function(){return c},this.getReflectivity=function(){return n},this.getGlossiness=function(){return a},this.getShadowIntensity=function(){return s},this.getMaterial=function(){return h},this.setActivated=function(e){e!=t&&(this.needUpdate=!0,this.needUpdateParameters=!0),t=e},this.setGroundOutDoor=function(){this.needUpdate=!0,i="physical",function(){h=new e.DSPBR19xMaterial({side:0,opacity:.99,roughness:.9});var t=l.getWebappsAssetUrl("Visualization","")+"OCA/",i=e.ImageUtils.loadTexture(t+"Outdoor_Ground_Diffuse.jpg");i.generateMipmap=!0,i.minFilter=e.LinearMipMapLinearFilter,i.magFilter=e.LinearFilter,i.repeat=new e.Vector2(10,10),i.wrapS=1e3,i.wrapT=1e3;var r=e.ImageUtils.loadTexture(t+"Outdoor_Ground_MainMap.jpg");r.generateMipmap=!0,r.minFilter=e.LinearMipMapLinearFilter,r.magFilter=e.LinearFilter,r.repeat=new e.Vector2(1,1),r.wrapS=1e3,r.wrapT=1e3,h.side=0,h.forceSide=!0,h.force=!0,h.needsUpdate=!0,h.depthWrite=!1,h.activatePDSFX();var n={fadingStrenght:{type:"f",value:5},fadingRatio:{type:"f",value:1},s_MaterialMap:{type:"t2",value:r},s_BaseColorMap:{type:"t2",value:i}};h.setPDSFXUniforms(n);h.setPDSFXVaryings({_vUv:{type:"v2"}});var a=["float ratio = 1.0;","vec2 uv[2];","float dUV = 1.0;","vec4 groundColor = vec4(290.0/255.0, 214.0/255.0, 164.0/255.0, 1.0) ;","mat3 MainMatrix_UVTransfo = mat3(10, 0.0, 0.0,","                                 0.0, 10, 0.0,","                                 0.0, 0.0, 1.0);","mat3 Matrix1_UVTransfo = mat3(1.0024, 0.9758, 0.0,","                              -0.9758, 1.0024, 0.0,","                              0.0, 0.0, 1.0);","mat3 Matrix2_UVTransfo = mat3(1.7, 0.0, 0.0,","                              0.0, 1.6, 0.0,","                              0.01, 0.78, 1.0);","vec2 TransformUV(vec2 iUV, mat3 iMatrix) {","    vec3 uv = iMatrix*vec3(iUV, 1.0);","    return uv.xy;","}"].join("\n");h.setPDSFXGlobalShaderCode("",a);var s={ComputeVaryingValues:["void ComputeVaryingValues() {","_vUv = vGetAttribTexCoord0().xy;","}"].join("\n")},o={ComputeAlbedo:["vec3 ComputeAlbedo() {","return mix(texture2D(s_BaseColorMap, uv[0]).xyz, texture2D(s_BaseColorMap, uv[1]).xyz, ratio);","}"].join("\n"),ComputeCommonValues:["void ComputeCommonValues() {","dUV = smoothstep(0.0,0.8,(length(2.0 * _vUv - 1.0)));","vec2  p_vUv = TransformUV(_vUv, MainMatrix_UVTransfo);","uv[0] =  TransformUV(p_vUv, Matrix1_UVTransfo);","uv[1] =  TransformUV(p_vUv, Matrix2_UVTransfo);","float ratio  = texture2D(s_MaterialMap, TransformUV(p_vUv, MainMatrix_UVTransfo)).r;","}"].join("\n"),ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","  ioFinalColor.a = 1.0 - dUV;","}"].join("\n")};h.setPDSFXOverridableFunctions(s,o)}()},this.setPlaneColor=function(e){o=e,this.needUpdateParameters=!0},this.setType=function(e){t&&i!=e&&(this.needUpdate=!0),i=e},this.setHeight=function(e){r=e,this.needUpdateParameters=!0},this.setAutoHeight=function(e){c=e,this.needUpdateParameters=!0},this.setReflectivity=function(e){0!==n&&0!==e||!(n>0||e>0)||(this.needUpdate=!0),n=e,this.needUpdateParameters=!0},this.setGlossiness=function(e){a=e,this.needUpdateParameters=!0},this.setShadowIntensity=function(e){s!==e&&(this.needsUpdateShadowIntensity=!0),0!==s&&0!==e||!(s>0||e>0)||(this.needUpdate=!0,this.needUpdateParameters=!0),s=e},this.setMaterial=function(e){h=e,this.needUpdateParameters=!0}},f=function(t){var i=!1;this.needUpdate=!1,this.needUpdateParameters=!1;var r=t,n=new c,a="latlong",s=new e.Color(16777215),o=1,l=1,h=new e.Matrix4,d=new e.Matrix4,u=!1,p=this,f=function(){p.needUpdate=!0};this.setFromJson=function(t,c,d){if(c&&(r=!0,d&&h.multiplyMatrices(h,(new e.Matrix4).extractRotation(d))),i=!0,t.projection&&(a=t.projection),t.emissionColor&&(s=s.setRGB(t.emissionColor[0],t.emissionColor[1],t.emissionColor[2])),t.emissionValue&&(o=t.emissionValue,l=t.emissionValue),r){if(t.matrix){var u=(new e.Matrix4).setFromArray(t.matrix);h.multiplyMatrices(h,u)}this.updateMatrix()}else if(h.rotateZ(-Math.PI/2),t.matrix){u=(new e.Matrix4).setFromArray(t.matrix);var p=(new e.Matrix4).getInverse(u);h.multiplyMatrices(h,p)}t.image&&t.image.texture&&(n.setTexture(t.image.texture),n.setFormat(t.image.format),this.needUpdate=!0)},this.updateMatrix=function(){d.identity(),d.rotateZ(-Math.PI/2),u&&d.rotateX(Math.PI/2);var t=(new e.Matrix4).getInverse(h);d.multiplyMatrices(d,t)},this.stream=function(){if(i){var e={};return e.projection=a,e.emissionColor=[s.r,s.g,s.b],e.emissionValue=o,e.matrix=h.elements.slice(0),e.image=n.stream(),e}return null},this.isActivated=function(){return i},this.setYUp=function(e){u=e,this.updateMatrix()},this.getImage=function(){return n},this.getProjection=function(){return scale},this.getValue=function(){return value},this.getMatrix=function(){return h},this.getInverseMatrix=function(){return d},this.getIntensity=function(){return o},this.getDiffuseIntensity=function(){return l},this.setActivated=function(e){e!=i&&(this.needUpdate=!0,i=e)},this.setValue=function(e){value=e,this.needUpdateParameters=!0},this.setIntensity=function(e){o=e,l=e,this.needUpdateParameters=!0},this.setSpecularIntensity=function(e){o=e,this.needUpdateParameters=!0},this.setDiffuseIntensity=function(e){l=e,this.needUpdateParameters=!0},this.setMatrix=function(e){h=e,r&&this.updateMatrix(),this.needUpdateParameters=!0},this.loadImage=function(t){var i;t.type="url",t&&t.image&&t.image instanceof e.Texture&&(t.type="THREETexture"),t&&t.image&&t.image instanceof Array&&(t.type="urlCube"),i=t.cb?function(e){t.cb(e),f()}:f,(n=new c(t,i)).loadImage(new e.LatLongReflectionMapping)},this.updateMatrix()},g=function(){var t=new e.Vector3(0,0,0),i=new e.Vector3(0,0,1),r=(new e.Vector3(0,0,1),new e.Vector3(0,0,0)),n=1,a=!0,s=!1;this.needUpdateParameters=!1,this.setFromJson=function(e){e.groundPosition&&(t=e.groundPosition),e.groundNormal&&(i=e.groundNormal),e.sceneHeight&&(r=e.sceneHeight),e.groundScale&&(n=e.groundScale),e.withGround&&(a=e.withGround)},this.updateMatrix=function(){i.set(0,0,1),s&&i.set(0,1,0)},this.updateFromMatrix=function(i){t.getPositionFromMatrix(i),i=(new e.Matrix4).extractRotation(i),this.updateMatrix()},this.setYUp=function(e){s=e,this.setSceneHeight(r),this.updateMatrix()},this.stream=function(){var e={};return e.groundPosition=t,e.groundNormal=i,e.sceneHeight=r,e.groundScale=n,e.withGround=a,e},this.isWithGround=function(){return a},this.getGroundPosition=function(){return t},this.getGroundNormal=function(){return i},this.getSceneHeight=function(){return r},this.getGroundScale=function(){return n},this.setGroundPosition=function(e){t.copy(e),this.needUpdateParameters=!0},this.setWithGround=function(e){a=e},this.setGroundNormal=function(e){console.warn("DEPRECATED: use setTransfrom instead of setGroundNormal")},this.setSceneHeight=function(t){r=s?new e.Vector3(0,t.z,0):t.clone(),this.needUpdateParameters=!0},this.setGroundScale=function(e){n=e,this.needUpdateParameters=!0}},m=function(l){var c=this;l||(l={}),this.requestIBLLightExtraction=a.subscribe({event:"/VISU/requestIBLLightExtraction"},function(e){c._extractIBLLight(e.extraData.rendererID)});var v=void 0!==l.viewer?l.viewer:null,y=void 0!==l.roughnessMap?l.roughnessMap:h,S="",_=!0,x=new d,b=new u,w=new p,M=new f(_),C=new g,P=new e.Matrix4,E=new e.Matrix4,A={},T=!1,D=!1,I=[],R=[],O=!1,L=null,V=[],F=[],B=null,N=null,G=!1,k=!1,U=!1,z=!1,H=null,W=0,j=0,X=0,q=0,Z=0,Y=0,Q=0,K=0,J=0,$=new e.Vector2(1,1),ee=new e.Vector2(0,0);l.finiteEnv&&b.setActivated(!0),this.usePlaneV2=!1,l.usePlaneV2&&(this.usePlaneV2=!0);var te=null,ie=!1;!1===l.autoGroundOffset&&w.setAutoHeight(!1);var re=new e.Color(0),ne=1,ae=!1;v&&v.currentViewpoint&&v.currentViewpoint.camera&&v.currentViewpoint.camera.isOrtho&&(ae=!0);var se=!1,oe=null,le=1920,he=1080,ce=1,de=!1;this.needUpdateIBL=new Set;this.isOCA=!1,this.keepIBLTexture=!0,this.keepBackgroundTexture=!0,this.setCameraOrtho=function(e){ae!=e&&(ae=e,de=!0,this.update())},this.useRenderToTarget=function(e){e},this.setWorldOrientation=function(e){var t=e==n.YUpXRight;M.setYUp(t),C.setYUp(t),b.setYUp(t),z=t,this.updateMatrix(),this.update()},this.updateAmbience=function(){Ce(),pe(),this.needUpdateIBL=new Set},this.setGroundOptions=function(e){v&&(v.setGroundOptions(e),A=v._getGroundOptions())},this.setOnComputeRoughnessMapCb=function(e){L=e};this.isComputingRoughnessMap=function(){return O};var ue=function(){if(v){var e=v.getRenderer().ambianceGenerators;e.setCallBack(function(){O=!1,e.setCallBack(null),L&&L()})}};this.isTextureLoading=function(){return T||D},this.updateMatrix=function(){E.identity(),E.rotateZ(-Math.PI/2),z&&E.rotateX(Math.PI/2);var t=(new e.Matrix4).getInverse(P);t.elements[12]=P.elements[12],t.elements[13]=P.elements[13],t.elements[14]=P.elements[14],E.multiplyMatrices(E,t);var i=x.getTransitionInfos();i.inverseMatrix.identity(),i.inverseMatrix.rotateZ(-Math.PI/2),z&&i.inverseMatrix.rotateX(Math.PI/2),(t=(new e.Matrix4).getInverse(i.ambienceMatrix)).elements[12]=i.ambienceMatrix.elements[12],t.elements[13]=i.ambienceMatrix.elements[13],t.elements[14]=i.ambienceMatrix.elements[14],i.inverseMatrix.multiplyMatrices(i.inverseMatrix,t)},this.loadFrom3dx=function(t,i,r,n,a){var s=t;r&&(_=!0);var o=null;if(s.name&&(S=s.name),_)s.transform&&(o=(new e.Matrix4).setFromArray(s.transform),P.multiplyMatrices(P,o),C.updateFromMatrix(P)),this.updateMatrix();else if(P.rotateZ(-Math.PI/2),s.transform){o=(new e.Matrix4).setFromArray(s.transform);var l=(new e.Matrix4).getInverse(o);l.elements[12]=o.elements[12],l.elements[13]=o.elements[13],l.elements[14]=o.elements[14],P.multiplyMatrices(P,l)}s.backgroundGeometry&&b.setFromJson(s.backgroundGeometry),s.ground?w.setFromJson(s.ground):r&&this.setGroundGeometry(!1);var c={useSky:!1,background:!0,dir:null,intensity:1,height:null,groundHeight:w.getHeight()};if(s.environmentLight)if(s.environmentLight.sun_direction&&!1!==s.environmentLight.enabled){c.useSky=!0;var d=s.environmentLight.sun_direction;if(c.dir=new e.Vector3(-d[0],-d[1],-d[2]),o){var u=(new e.Matrix4).extractRotation(o);c.dir.applyMatrix4(u)}null!=s.environmentLight.altitude&&(c.height=s.environmentLight.altitude),null!=s.environmentLight.intensity&&(c.intensity=s.environmentLight.intensity)}else r?M.setFromJson(s.environmentLight,r,o):M.setFromJson(s.environmentLight,r);if(w.setAutoHeight(!1),s.background)if("color"==s.background.type&&"color"==s.background.type){var p=s.background.colors[0];re.setRGB(p[0],p[1],p[2]),ne=p[3],v&&v.setBackgroundColor(re.getHex(),ne)}else x.setFromJson(s.background);if(i?this.loadImageFrom3dx(i,n,a):y||(y=!r&&M.getImage().getTexture()?null:h,this.needUpdateIBL=new Set),c.useSky&&v){var f=null==c.height?v.currentViewpoint.camera.position.z-c.groundHeight:c.height;f*=s.unitScale/1e6,this.setSkyLighting(c.dir,Math.max(f,.001),c.intensity,c.background)}},this._extractIBLLight=function(e){if(!N){var t=this.getIblMap();if(t&&v&&v.renderer&&v.renderer.renderer&&v.renderer.renderer.id===e){k=!1;var i=new s(v.renderer.renderer,v.renderer.renderTargetPool);i.setEnvMap(t),N=i.execute(V.filter(function(e){return e.light.castShadow&&e.light.intensity>0}).length>0),i.dispose(),a.publish({event:"/VISU/IBLLightExtracted",data:{eventChannel:"/VISU/IBLLightExtracted",eventType:"@IBLLightExtracted"}})}N&&(U=!0)}},this._solveSceneRoughnessMap=function(e,t){if(v){var i=this.getIblMap();if(i){var r=new o(v.renderer.renderer,v.renderer.renderTargetPool);r.setTextures(e.textures,i,e.ggx0,e.ggxMapping),this.setRoughnessMap({texture:r.execute()}),r.dispose(),a.publish({event:"/VISU/3DXMipsMerged",data:{eventChannel:"/VISU/3DXMipsMerged",eventType:"@3DXMipsMerged"}}),t&&t({ambiance:this})}}},this.setLights=function(e,t,i,r){G=!0,k=!0,e._phongReduction=!0,t?F.push({light:e,dirLight:i,linkToSceneGraph:!1}):V.push({light:e,dirLight:i,linkToSceneGraph:!1}),r&&(B={light:r,dirLight:i,linkToSceneGraph:!1})},this.updateLights=function(t,i,r,n,a){if(G&&i){for(var s=0;s<V.length;s++)V[s].light.linkToSceneGraph||i.add(V[s].light);for(s=0;s<F.length;s++)F[s].light.linkToSceneGraph||i.add(F[s].light)}G&&a&&B&&!B.light.linkToSceneGraph&&a.add(B.light),U&&i&&(i.add(N.light),U=!1),k&&N&&(i.remove(N.light),N=null,k=!1),(i||a)&&(G=!1);var o=t.getUpDirection(),l=t.getSightDirection(),h=(new e.Vector3).crossVectors(l,o);for(s=0;s<F.length;s++){var c=F[s].light,d=F[s].dirLight,u=(new e.Vector3(h.x*d.x+o.x*d.y+l.x*d.z,h.y*d.x+o.y*d.y+l.y*d.z,h.z*d.x+o.z*d+l.z*d.z),new e.Vector4(d.x,d.y,d.z,0));u.applyMatrix4(t.camera.matrix),c.position=new e.Vector3(u.x,u.y,u.z).multiplyScalar(r.radius)}var p=function(t,i){var n=t.light,a=t.dirLight;n.target.position.copy(r.center),n.target.updateMatrixWorld(),n.position=(new e.Vector3).copy(a).multiplyScalar(2*r.radius).add(r.center),null!==i&&n.position.applyMatrix4(i)};for(s=0;s<V.length;s++){p(V[s],null)}N&&p(N,this.getEnvironmentLightMatrix(!0)),B&&(B.light.castShadow=!1,p(B,null))},this.removeLights=function(e,t){if(e){for(var i=0;i<V.length;i++)V[i].light.dispose(),e.remove(V[i].light);for(i=0;i<F.length;i++)F[i].light.dispose(),e.remove(F[i].light);N&&(N.light.dispose(),e.remove(N.light)),B&&(B.light.dispose(),t.remove(B.light))}},this.loadImageFrom3dx=function(i,r,n){if(k=!0,l.images){var a=0,s=0;l.images.background&&a++,l.images.environmentLight&&a++;var o=this,c=function(){++s==a&&(T=!1,D=!1,de=!0,r&&r({ambiance:o}))};if(l.images.background&&(T=!0,x.loadImage({image:l.images.background.data,format:l.images.background.format,doneCallback:c})),l.images.environmentLight){if("hdr"==l.images.environmentLight.format)d=n?function(){o.needUpdateIBL=new Set,c()}:function(){o.needUpdateIBL=new Set;var t=o.getEnvironmentLight().getImage().getTexture();if(t&&t.image){var i=t.image,r=parseInt(i.width,10),n=parseInt(i.height,10);if(isNaN(r)||isNaN(n)||2*n!=r&&console.warn("##3DX LOADING## ibl width should be 2x ibl height"),r<8||n<4){for(var a=new Uint8Array(128),s=0;s<32;s++)a[4*s]=i.data[0],a[4*s+1]=i.data[1],a[4*s+2]=i.data[2],a[4*s+3]=i.data[3];i.height="4",i.width="8",i.data=a;var l=new Uint8Array(256);for(s=0;s<64;s++)l[4*s]=i.data[0],l[4*s+1]=i.data[1],l[4*s+2]=i.data[2],l[4*s+3]=i.data[3];return(y=new e.DataTexture(l,8,8,e.RGBAFormat,void 0,void 0)).hdr=t.hdr,y.sRGB=t.sRGB,y.minFilter=e.NearestFilter,y.magFilter=e.NearestFilter,y.wrapS=e.RepeatWrapping,y.wrapT=e.RepeatWrapping,y.mapping=t.mapping,void c()}}O=!0,ue(),o.needUpdateIBL=new Set,y=null,c()},D=!0,M.loadImage({cb:d,image:l.images.environmentLight.data,format:l.images.environmentLight.format});else if("dds"==l.images.environmentLight.format){d=n?function(e){var i=null;if(e.isCubeMap&&e.isCubeMap()){if(v){oe||(oe=new t(v.renderer.renderer,v.renderer.renderTargetPool));var r=M.getImage().getTexture();oe.setEnvMap(r,2),oe.execute(),i=oe.getResultRGBE(!0)}}else i=e;M.getImage().setTexture(i),o.needUpdateIBL=new Set,c()}:function(i){var r=null;if(i.isCubeMap&&i.isCubeMap()){if(v){oe||(oe=new t(v.renderer.renderer,v.renderer.renderTargetPool));var n=M.getImage().getTexture();oe.setEnvMap(n,2),oe.execute(),r=oe.getResultRGBE(!0)}}else if((r=i)&&r.mipmaps){var a=r.mipmaps[0],s=parseInt(a.width,10),l=parseInt(a.height,10);if(isNaN(s)||isNaN(l)||2*l!=s&&console.warn("##3DX LOADING## ibl width should be 2x ibl height"),s<8||l<4){var h,d;i.type==e.FloatType?(r.hdr=!0,r.rgbHdr=!0,r.sRGB=!1,h=new Float32Array(128)):h=new Uint8Array(128);for(var u=0;u<32;u++)h[4*u]=a.data[0],h[4*u+1]=a.data[1],h[4*u+2]=a.data[2],h[4*u+3]=a.data[3];a.height="4",a.width="8",a.data=h,d=i.type==e.FloatType?new Float32Array(256):new Uint8Array(256);for(u=0;u<64;u++)d[4*u]=a.data[0],d[4*u+1]=a.data[1],d[4*u+2]=a.data[2],d[4*u+3]=a.data[3];return(y=new e.DataTexture(d,8,8,e.RGBAFormat,void 0,void 0)).hdr=r.hdr,y.sRGB=r.sRGB,y.minFilter=e.NearestFilter,y.magFilter=e.NearestFilter,y.wrapS=e.RepeatWrapping,y.wrapT=e.RepeatWrapping,y.mapping=r.mapping,M.getImage().setTexture(r),o.needUpdateIBL=new Set,void c()}}M.getImage().setTexture(r),O=!0,ue(),o.needUpdateIBL=new Set,y=null,c()},D=!0,M.loadImage({cb:d,image:l.images.environmentLight.data,format:l.images.environmentLight.format})}else if("png"==l.images.environmentLight.format){var d=function(){y=M.getImage().getTexture(),o.needUpdateIBL=new Set};c();d=function(){var e=M.getImage().getTexture();e.rgbHdr=!0,e.hdr=!0,e.sRGB=!0,O=!0,c(),ue(),o.needUpdateIBL=new Set,y=null};D=!0,M.loadImage({cb:d,image:l.images.environmentLight.data,format:l.images.environmentLight.format})}}else this.needUpdateIBL=new Set,y=h}},this.setRenderTargetSize=function(e,t,i,r){W=0,j=0,X=i,q=r,e&&(W=e),t&&(j=t)},this.isFiniteMode=function(){return b.isActivated()},this.getTransform=function(){return P},this.setTransform=function(e){P=e,_&&(this.updateMatrix(),C.updateFromMatrix(P)),de=!0},this.getEnvironmentLightMatrix=function(e){return e&&_?M.getInverseMatrix():M.getMatrix()},this._getEnvironmentLightMatrix=function(){var t=new e.Matrix4;return t.getInverse(M.getInverseMatrix()),t},this.getGroundOptions=function(){return A},this.setEnvironmentLightMatrix=function(e){M.setMatrix(e),de=!0},this.getBackgroundGeometryEditor=function(){return C},this.getBackgroundGeometry=function(){return b},this.getBackground=function(){return x},this.getGround=function(){return w},this.getEnvironmentLight=function(){return M},this.getBackgroundColor=function(){return re},this.getBackgroundAlpha=function(){return ne},this.setBackgroundAlpha=function(e){ne=e,de=!0},this.setBackgroundColor=function(t){re=new e.Color(t),de=!0},this.updateParameters=function(){de=!0,this.update()},this.update=function(){x.needUpdate&&(pe(),x.needUpdate=!1,x.needUpdateParameters=!1,M.needUpdateParameters=!1),b.needUpdate&&(pe(),b.needUpdate=!1,x.needUpdateParameters=!1,M.needUpdateParameters=!1,b.needUpdateParameters=!1),M.needUpdate&&(M.needUpdate=!1),w.needUpdate&&(w.needUpdate=!1,Ce()),(de||w.needUpdateParameters||x.needUpdateParameters||M.needUpdateParameters||b.needUpdateParameters||C.needUpdateParameters)&&(fe(),x.needUpdateParameters=!1,M.needUpdateParameters=!1,w.needUpdateParameters=!1,b.needUpdateParameters=!1,C.needUpdateParameters=!1,de=!1)};var pe=function(){if(x.isActivated())switch(x.getType()){case"gradient":case"gradient3":case"gradientWithHorizon":be();break;case"cubemap":b.isActivated()?"sphere"==b.getType()&&we():Ee();break;case"latlong":b.isActivated()?"sphere"==b.getType()&&we():Pe();break;case"transition":Me();break;case"backplate":Ae();break;default:return!1}te&&(te.side=e.DoubleSide,te.depthTest=!1,te.force=!0,te.forceSide=!0,ie=!0),fe()},fe=function(){if(te&&x.isActivated()){if(x.withImage()){var e=x.getImage();e.getTexture()&&(te.tEnvMap=e.getTexture(),te.tEnvMap.envMapExposure&&(te.tEnvMap.envMapExposure=x.getIntensity()),te.envMapExposure=x.getIntensity(),te.defines.HDR!=("hdr"==e.getFormat())&&(te.defines.HDR="hdr"==e.getFormat(),te.needsUpdate=!0),te.defines.sRGB!=e.isSRGB()&&(te.defines.sRGB=e.isSRGB(),te.needsUpdate=!0),te.defines.HDR_FLOAT!=e.isTextureHDRFloat()&&(te.defines.HDR_FLOAT=e.isTextureHDRFloat(),te.needsUpdate=!0))}b.isActivated()?"gradient"==x.getType()||"gradientWithHorizon"==x.getType()||"gradient3"==x.getType()?me("gradientWithHorizon"==x.getType()):"backplate"==x.getType()?ve():"transition"==x.getType()?xe():_e():("latlong"==x.getType()&&Se(),"cubemap"==x.getType()&&ye(),"backplate"==x.getType()&&ve(),"gradient"!=x.getType()&&"gradientWithHorizon"!=x.getType()&&"gradient3"!=x.getType()||me("gradientWithHorizon"==x.getType()))}if(M.isActivated()){var t=M.getImage().getTexture();t&&(t.envMapExposureSpecular=M.getIntensity(),t.envMapExposureDiffuse=M.getDiffuseIntensity())}w.isActivated()&&ge()},ge=function(){if(w.getReflectivity()>0){var e=function(){if(v&&v.renderer&&v.renderer.mirrorBlendPass)return v.renderer.mirrorBlendPass}();e&&(e.uniforms.reflectivity.value=w.getReflectivity())}},me=function(e){te.colors=[];var t=te.colors,i=x.getColors();te.YUp=z?1:0,te.ratio=x.getRatio();for(var r=0;r<i.length;r++){var n=i[r];t.push(n.r),t.push(n.g),t.push(n.b)}e&&(te.horizonHeight=x.getHorizonHeight())},ve=function(){x.getImage().getTexture();te.backgroundColor.set(re),te.backgroundAlpha=ne,Ie()},ye=function(){x.getImage().getTexture()&&(te.ambienceMatrix=_?E:P)},Se=function(){var t=x.getImage().getTexture();t&&(t.minFilter=e.LinearFilter,te.ambienceMatrix=_?E:P,x.getBlur()&&y&&y!==h&&(te.tEnvMap2=y,te.blurCoef=x.getBlur(),te.defines.ENVMAP2||(te.defines.ENVMAP2=!0,te.needsUpdate=!0)),w.isPhysical()?(te.planeColor=w.getPlaneColor(),te.withPlane=1):te.withPlane=0)},_e=function(){var t=x.getImage().getTexture();te.side=ae?e.BackSide:e.DoubleSide,t&&(t.minFilter=e.LinearFilter,te.tEnvMap=t,_?(te.ambienceMatrix=E,te.groundHeight=b.getWorldShootPosition(P)):(te.ambienceMatrix=P,te.groundHeight=b.getShootPosition()),te.groundPosition=C.getGroundPosition(),te.groundNormal=C.getGroundNormal(),te.groundOffset=w.getHeight(),te.sceneHeight=C.getSceneHeight(),te.groundRadius=b.getSize(),te.groundScale=C.getGroundScale(),te.withGround=C.isWithGround(),te.projectionConic=!ae,te.defines.LATLONG_MAP!=!("cubemap"==x.getType())&&(te.defines.LATLONG_MAP=!("cubemap"==x.getType()),te.needsUpdate=!0))},xe=function(){var t=x.getImage().getTexture();te.side=e.DoubleSide,t&&(t.minFilter=e.LinearFilter,te.tEnvMap=t,te.ambienceMatrix=E,te.groundPosition=C.getGroundPosition(),te.groundRadius=b.getSize(),te.groundScale=C.getGroundScale(),te.defines.LATLONG_MAP!=!("cubemap"==x.getType())&&(te.defines.LATLONG_MAP=!("cubemap"==x.getType()),te.needsUpdate=!0));var i=x.getTransitionInfos();te.transitionCoef=i.transition;var r=i.image.getTexture();r&&(r.minFilter=e.LinearFilter,te.tEnvMap2=r,te.groundPosition2.set(i.ambienceMatrix.elements[12],i.ambienceMatrix.elements[13],i.ambienceMatrix.elements[14]),te.ambienceMatrix2=i.inverseMatrix,te.groundRadius2=i.radius,te.groundScale2=C.getGroundScale())},be=function(){var t;switch(x.getType()){case"gradient":t=e.GradientBackgroundMaterial2;break;case"gradient3":t=e.GradientBackgroundMaterial3;break;case"gradientWithHorizon":t=e.GradientBackgroundMaterial4;break;default:return!1}te=new t(null)},we=function(){var t=x.getImage(),i={defines:{HDR:"hdr"==t.getFormat(),sRGB:t.isSRGB(),LATLONG_MAP:"latlong"==x.getType(),AMBIENCE_V2:!!_}};te=new e.FiniteEnvMapMaterial(i)},Me=function(){te=new e.FiniteTransitionEnvMapMaterial(null)},Ce=function(){v&&(w.isActivated()&&w.getReflectivity()>0?v.setMirror(!0,void 0,null,w.getReflectivity(),w.getGlossiness()):v.setMirror(!1),w.isActivated()&&w.getShadowIntensity()>0?(v.setShadowPlane(!0),w.disableDefaultGroundShadow?v.setGroundShadow(!1):v.setGroundShadow(!0)):v.setGroundShadow(!1))},Pe=function(){var t=x.getImage(),i={defines:{HDR:"hdr"==t.getFormat(),sRGB:t.isSRGB(),HDR_FLOAT:t.isTextureHDRFloat(),ENVMAP2:y&&y!==h&&x.getBlur()>=0}};te=new e.LatLongMapMaterial(i)},Ee=function(){te=new e.CubeMapMaterial},Ae=function(){var t=x.getImage(),i={defines:{HDR:"hdr"==t.getFormat(),HDR_FLOAT:t.isTextureHDRFloat(),sRGB:t.isSRGB()}};te=new e.SimpleMapMaterial(i),Ie()},Te=function(i){var r;if(i.url){var n=i.onMapsLoaded,a=null;if(i.onlyOnRequest&&i.fallbackColor&&(n=null,a=function(t){r=function(t){var i=4;t[0]&&(i=8);for(var r=new Uint8Array(8*i*4),n=0;n<8*i;n++)r[4*n]=t[1],r[4*n+1]=t[2],r[4*n+2]=t[3],r[4*n+3]=t[4];var a=new e.DataTexture(r,8,i,e.RGBAFormat);return a.needsUpdate=!0,a.hdr=!0,a.sRGB=!1,a.minFilter=e.NearestFilter,a.magFilter=e.NearestFilter,a.wrapS=e.RepeatWrapping,a.wrapT=e.RepeatWrapping,a.loadEndStatus=e.AssetLoadingStatus.READY,a}(i.fallbackColor),i.fallbackColor[0]?c.setIblMap({texture:r}):c.setRoughnessMap({texture:r})}),i.url instanceof Array)r=e.ImageUtils.loadTextureCube(i.url,i.mapping,i.onMapsLoaded);else if(i.hdr)r=e.ImageUtils.loadHDRTexture(i.url,i.mapping,n,null,null,!1,!1,e.ImageUtils.crossOriginPolicy,i.onlyOnRequest),i.onlyOnRequest&&i.onMapsLoaded(r);else{var s=i.url.split("."),o=(s[s.length-2],s[s.length-1]);"hdr"==(o=o.toLowerCase())||i.hdr?(r=e.ImageUtils.loadHDRTexture(i.url,i.mapping),i.hdr=!0,r.onLoadCallbacks.push(i.onMapsLoaded)):"dds"==o||i.dds?r=e.ImageUtils.loadCompressedTexture(i.url,new e.LatLongReflectionMapping,function(){v&&(oe||(oe=new t(v.renderer.renderer,v.renderer.renderTargetPool)),oe.setEnvMap(r,2),oe.execute(),r=oe.getResultRGBE(!0),i.onMapsLoaded(r))}):(r=new e.ImageUtils.loadTexture(i.url,i.mapping,n,a,e.ImageUtils.crossOriginPolicy,!1,i.onlyOnRequest),i.onlyOnRequest&&i.onMapsLoaded(r))}}return r},De=function(t,i,r){var n=x.getImage();n.setTexture(t);var a=r?"hdr":"png";n.setFormat(a);var s,o,l=t,h=!!r;i instanceof e.SimpleEnvMapping?(s="backplate",o="simple"):i instanceof e.SimpleEnvMappingCustom?(s="backplate",o="custom"):i instanceof e.SimpleEnvMappingFit?(s="backplate",o="fit"):i instanceof e.SimpleEnvMappingPreserveRatio?(s="backplate",o="bestFit"):i instanceof e.SimpleEnvMappingFitWidth?(s="backplate",o="fitWidth"):i instanceof e.SimpleEnvMappingFitHeight?(s="backplate",o="fitHeight"):i instanceof e.LatLongEnvMapping?s="latlong":i instanceof e.CubeEnvMapping&&(s="cubemap"),h&&(l.minFilter=e.NearestFilter,l.magFilter=e.NearestFilter,l.wrapS=e.RepeatWrapping,l.wrapT=e.RepeatWrapping),s!=x.getType()||!te||"backplate"==x.getType()&&x.getSizeScaling()!=o?(x.setType(s),o&&x.setSizeScaling(o),pe()):de=!0},Ie=function(e){var t=x.getImage().getTexture();if("backplate"==x.getType()&&t){var i=2048,r=1024;t.image?(i=t.image.width,r=t.image.height):t.width&&t.height&&(i=t.width,r=t.height);var n=i/r,a=le,s=he;W&&j&&(a=W,s=j),e&&(i*=2,r*=2,a*=2,s*=2);var o,l=(a*=x.getBackplateScale())/(s*=x.getBackplateScale()),h=X,c=q;if(J)if(a=J,s=K,h=-Z,c=-(K-Q-Y),W&&j&&(a=W,s=j,h=X,c=q),l=a/s,"custom"==x.getSizeScaling())(o=x.getBackplateCB())&&o({textureWidth:i,textureHeight:r,viewportWidth:a,viewportHeight:s,devicePixelRatio:ce});else if("simple"==x.getSizeScaling())i=a,r=s,te.offset.set(ce*(h+ee.x*i),ce*(c-ee.y*r-($.y-1)*r)),te.invSize.set(1/(ce*i*$.x),1/(ce*r*$.y));else if("fitHeight"==x.getSizeScaling()){i=s*n,r=s,h+=.5*(a-(d=(u=s*$.y)/n)),te.offset.set(ce*h,ce*(c-ee.y*r-($.y-1)*r)),te.invSize.set(1/(ce*u),1/(ce*u))}else if("fitWidth"==x.getSizeScaling()){i=a,r=a/n,c+=.5*(s-(u=(d=a*$.x)/n)),te.offset.set(ce*(h+ee.x*i),ce*c),te.invSize.set(1/(ce*d),1/(ce*u))}else if("bestFit"==x.getSizeScaling()){if(n>l){i=(r=s)*n;var d=(u=r*$.y)/n}else{r=(i=a)/n;var u=(d=i*$.x)/n}te.offset.set(ce*(h+ee.x*i),ce*(c-ee.y*r-($.y-1)*r)),te.invSize.set(1/(ce*i*$.x),1/(ce*u))}else"fit"==x.getSizeScaling()&&(n>l?(i=a,c+=.5*(s-(r=a/n))):(r=s,h+=.5*(a-(i=s*n))),te.offset.set(ce*(h+ee.x*i),ce*(c-ee.y*r-($.y-1)*r)),te.invSize.set(1/(ce*i*$.x),1/(ce*r*$.y)));else if("custom"==x.getSizeScaling())(o=x.getBackplateCB())&&o({textureWidth:i,textureHeight:r,viewportWidth:a,viewportHeight:s,devicePixelRatio:ce});else"simple"==x.getSizeScaling()?(i=a,r=s,te.offset.set(ce*h,ce*c),te.invSize.set(1/(ce*i),1/(ce*r))):"fitHeight"==x.getSizeScaling()?(i=s*n,r=s,h=.5*(le*x.getBackplateScale()-i),te.offset.set(ce*h,ce*c),te.invSize.set(1/(ce*i),1/(ce*r))):"fitWidth"==x.getSizeScaling()?(i=a,r=a/n,c=.5*(he*x.getBackplateScale()-r),te.offset.set(ce*h,ce*c),te.invSize.set(1/(ce*i),1/(ce*r))):"bestFit"==x.getSizeScaling()?(n>l?i=(r=s)*n:r=(i=a)/n,te.offset.set(ce*h,ce*c),te.invSize.set(1/(ce*i),1/(ce*r))):"fit"==x.getSizeScaling()&&(n>l?(i=a,c+=.5*(s-(r=a/n))):(r=s,h+=.5*(a-(i=s*n))),te.offset.set(ce*h,ce*c),te.invSize.set(1/(ce*i),1/(ce*r)))}};this.getIblMap=function(){if(M.isActivated()){var t=M.getImage().getTexture();if(t&&(t.loadEndStatus==e.AssetLoadingStatus.READY||t.loadEndStatus==e.AssetLoadingStatus.PAUSED||null==t.loadEndStatus))return t}return null},this.getRoughnessMap=function(){return M.isActivated()?y:null},this.getRadiusEnvMap=function(){return b.getSize()*C.getGroundScale()*2},this.getCenter=function(){var e,t;return _?((e=C.getSceneHeight().clone()).multiplyScalar(b.getSize()),e.add(C.getGroundPosition())):((e=C.getGroundNormal().clone().multiply(C.getSceneHeight())).multiplyScalar(b.getSize()),t=C.getGroundPosition().clone().applyMatrix4(P),e.add(t)),e},this.getRadius=function(){return b.getSize()*C.getGroundScale()},this.getProjectionCenter=function(){var e,t;return _?((e=b.getShootPosition().clone()).multiplyScalar(b.getSize()),e.add(C.getGroundPosition())):((e=C.getGroundNormal().clone().multiply(b.getShootPosition())).multiplyScalar(b.getSize()),t=C.getGroundPosition().clone().applyMatrix4(P),e.add(t),e.z+=w.getHeight()),e},this.updateCamera=function(t,i,r){if(t.camera&&this.setCameraOrtho(t.camera.isOrtho),te&&"latlong"==x.getType()){if(r.fullWidth)te.invScreenSize.x=1/r.width,te.invScreenSize.y=1/r.height,te.startOffset.x=r.x/r.fullWidth,te.endOffset.y=1-r.y/r.fullHeight,te.endOffset.x=(r.x+r.width)/r.fullWidth,te.startOffset.y=1-(r.y+r.height)/r.fullHeight;else{var n=i.renderer.getViewportSize();te.invScreenSize.x=1/n.width,te.invScreenSize.y=1/n.height,te.startOffset.x=0,te.startOffset.y=0,te.endOffset.x=1,te.endOffset.y=1}if(t.camera.isOrtho&&this.isFiniteMode()){var a=Math.tan(.5*e.Math.degToRad(t.camera.fov)),s=t.getSightDirection().normalize(),o=t.camera.up.normalize();te.cameraRight.crossVectors(t.getSightDirection(),t.camera.up).normalize(),te.cameraSight.copy(s),te.cameraUp.copy(o),te.invScreenSize.x=1/i.deviceWidth,te.invScreenSize.y=1/i.deviceHeight,te.near=t.camera.near,te.right=t.camera.right,te.up=t.camera.top}else{a=Math.tan(.5*e.Math.degToRad(t.camera.fov));te.cameraSight.copy(t.getSightDirection()),te.cameraUp.copy(t.camera.up).multiplyScalar(a),te.cameraRight.crossVectors(t.getSightDirection(),t.camera.up),te.cameraRight.multiplyScalar(t.camera.aspect*a),te.invScreenSize.x=1/i.deviceWidth,te.invScreenSize.y=1/i.deviceHeight}}if(te&&"backplate"==x.getType()){var l="SSAA"==i.antiAliasing;r.fullWidth?(Z=r.x,Y=r.y,r.width,Q=r.height,K=r.fullHeight,J=r.fullWidth,Ie(l)):(Z=0,Y=0,0,Q=0,K=0,J=0,Ie(l))}},this.resize=function(e,t,i,r){if(le=e,he=t,ce=i,"backplate"==x.getType()){var n="SSAA"==r.antiAliasing;Ie(n)}},this.getSphere=function(){return(e=i.createSphereNode({radius:1,sag:64,material:te})._occurrences[0].renderable).frustumCulled=!1,e.renderDepth=2,e.visible=!0,e.visibilityFree=!0,e;var e};this.getGroundGeometry=function(){return(t=i.createRectangleNode({width:1,noEdge:!0,height:1,cornerPoint:new e.Vector2(-.5,-.5),fill:!0,material:w.getMaterial()?w.getMaterial():new e.PhysicalMaterial})._occurrences[0].renderable).frustumCulled=!1,t.renderDepth=2,t.visible=!0,t.visibilityFree=!0,t;var t},this.updateSphere=function(e,t,i){var r,n;se||(r=t,n=e,i.position.set(r.x,r.y,r.z),i.scale.set(n,n,n),i.updateMatrix(),te&&(i.material=te),i.visible=!0,ie&&(i._flagAsGSSOInvalidated(),ie=!1))},this.setNearValue=function(e){te&&(te.near=e)},this.updateGround=function(e){if(!se){var t=5*this.getBackgroundGeometry().getSize(),i=this.getCenter();e.position.set(i.x,i.y,i.z),e.scale.set(t,t,t),e.rotation.x=z?-Math.PI/2:0,e.updateMatrix(),w.getMaterial()&&(e.material=w.getMaterial()),e.visible=!0}},this._removePhysicalGround=function(){w.setMaterial(null),w.setType("transparent")},this.setIblMap=function(t){var i=this,r=null;if(k=!0,t.mapping||(t.mapping=new e.LatLongReflectionMapping),t.onMapsLoaded=function(r){t.pngHdr&&(r.sRGB=!1,r.hdr=!0);var n=r;if(M.getImage().setTexture(n),M.setActivated(!0),n.minFilter=e.NearestFilter,n.magFilter=e.NearestFilter,n.wrapS=e.RepeatWrapping,n.wrapT=e.RepeatWrapping,t.mapping&&(n.mapping=t.mapping),t.hdr&&(n.hdr=t.hdr),(t.generateRougnessMap||t.generateRoughnessMap)&&v){v.getRenderer().ambianceGenerators;D=!1;for(var a=0;a<R.length;a++)R[a].setIblMap({texture:n,mapping:t.mapping,hdr:t.hdr});R=[],O=!0,t.doneCallback&&t.doneCallback(),ue(),i.needUpdateIBL=new Set,y=null}if(t.doneCallback&&(!t.generateRougnessMap||!t.generateRoughnessMap)){D=!1;for(a=0;a<R.length;a++)R[a].setIblMap({texture:n,mapping:t.mapping,hdr:t.hdr});R=[],t.doneCallback()}de=!0,i.needUpdateIBL=new Set},t.url)D=!0,r=Te(t);else if(t.texture&&t.texture instanceof e.Texture)D=!0,(r=t.texture).loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded(r):r.onLoadCallbacks.push(t.onMapsLoaded);else if(t.texture&&t.texture instanceof e.WebGLRenderTarget){var n=t.texture;if(M.getImage().setTexture(n),M.setActivated(!0),n.minFilter=e.NearestFilter,n.magFilter=e.NearestFilter,n.wrapS=e.RepeatWrapping,n.wrapT=e.RepeatWrapping,t.mapping&&(n.mapping=t.mapping),t.hdr&&(n.hdr=t.hdr),t.generateRougnessMap&&v){v.getRenderer().ambianceGenerators;O=!0,t.doneCallback&&t.doneCallback(n),i.needUpdateIBL=new Set,y=null,ue()}}},this.setReflectionMap=function(i){var n=this,a=null,s=i.url,o=h;if(i.onMapsLoaded=function(){var t=a;M.getImage().setTexture(t),M.setActivated(!0),y=o,t.minFilter=y.minFilter=e.NearestFilter,t.magFilter=y.magFilter=e.NearestFilter,t.wrapS=y.wrapS=e.RepeatWrapping,t.wrapT=y.wrapT=e.RepeatWrapping,i.doneCallback&&i.doneCallback(),n.needUpdateIBL=new Set},"dds"===r.getExtension(s))var l=e.ImageUtils.loadCompressedTexture(s,new e.LatLongReflectionMapping,function(){v&&(oe||(oe=new t(v.renderer.renderer,v.renderer.renderTargetPool)),oe.setEnvMap(l,2),oe.execute(),o=null,a=oe.getResultRGBE(!0),i.onMapsLoaded())})},this.setRoughnessMap=function(t){var i=this,r=h;t.onMapsLoaded=function(n){y=n||r,t.pngHdr&&(y.sRGB=!1,y.hdr=!0),t.hasDiffuse&&(y.hasDiffuse=!0),y.minFilter=e.NearestFilter,y.magFilter=e.NearestFilter,y.wrapS=e.RepeatWrapping,y.wrapT=e.RepeatWrapping,t.mapping&&(y.mapping=t.mapping),t.hdr&&(y.hdr=t.hdr),t.doneCallback&&t.doneCallback(),i.needUpdateIBL=new Set},t.url?r=Te(t):t.texture&&t.texture instanceof e.Texture?(r=t.texture).loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded(r):r.onLoadCallbacks.push(t.onMapsLoaded):t.texture&&t.texture instanceof e.WebGLRenderTarget&&(r=t.texture,t.onMapsLoaded(r))},this.setBackplateMap=function(t){var i=null,r=this;t.onMapsLoaded=function(){r.setFiniteMode(!1),De(i,t.mapping,t.hdr),t.doneCallback&&t.doneCallback()},t.url?i=Te(t):t.texture&&t.texture instanceof e.Texture&&(i=t.texture,t.mapping||(t.mapping=i.mapping),t.hdr||(t.hdr=i.hdr),i.loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded():i.onLoadCallbacks.push(t.onMapsLoaded))},this.generateIBLFromColor=function(t){for(var i=new Uint8Array(128),r=0;r<32;r++)i[4*r]=t[0],i[4*r+1]=t[1],i[4*r+2]=t[2],i[4*r+3]=t[3];var n=new e.DataTexture(i,8,4,e.RGBAFormat,void 0,void 0);n.hdr=!0,n.sRGB=!1,n.mapping=new e.LatLongReflectionMapping,n.needsUpdate=!0;var a=new Uint8Array(256);for(r=0;r<64;r++)a[4*r]=t[0],a[4*r+1]=t[1],a[4*r+2]=t[2],a[4*r+3]=t[3];(y=new e.DataTexture(a,8,8,e.RGBAFormat,void 0,void 0)).hdr=!0,y.sRGB=!1,y.needsUpdate=!0,y.minFilter=e.NearestFilter,y.magFilter=e.NearestFilter,y.wrapS=e.RepeatWrapping,y.wrapT=e.RepeatWrapping,y.mapping=new e.LatLongReflectionMapping,M.getImage().setTexture(n),M.setActivated(!0),this.needUpdateIBL=new Set},this.setBackGroundMap=function(t){var i=null;t.onMapsLoaded=function(){t.pngHdr&&(i.sRGB=!1,i.hdr=!0,t.hdr=!0),De(i,t.mapping,t.hdr),T=!1;for(var e=0;e<I.length;e++)I[e].setBackGroundMap({texture:i,mapping:t.mapping,hdr:t.hdr});I=[],t.doneCallback&&t.doneCallback()},t.url?(T=!0,i=Te(t)):t.texture&&t.texture instanceof e.Texture?(T=!0,i=t.texture,t.mapping||(t.mapping=i.mapping),t.hdr||(t.hdr=i.hdr),i.loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded():i.onLoadCallbacks.push(t.onMapsLoaded)):t.texture&&t.texture instanceof e.WebGLRenderTarget&&De(t.texture,t.mapping,t.hdr)},this.setExposure=function(e){x.setIntensity(e),M.setIntensity(e)},this.getEnvMapExposure=function(){return x.getIntensity()},this.lockAmbiance=function(e){se=e},this.setFiniteMode=function(e){b.isActivated()!=e&&b.setActivated(e)},this.setGroundGeometry=function(e){C.setWithGround(e)},this.getGroundPosition=function(){return C.getGroundPosition()},this.setGroundPosition=function(e){C.setGroundPosition(e)},this.setGroundNormal=function(e){console.warn("DEPRECATED: use setTransfrom instead of setGroundNormal"),C.setGroundNormal(e)},this.setSceneHeight=function(e){C.setSceneHeight(e)},this.setGroundHeight=function(e){b.setShootPosition(e)},this.setGroundRadius=function(e){b.setSize(e),v&&v.planeV2&&v.planeGrid&&(v.planeGrid.size=2*e)},this.displayGround=function(e){w.setActivated(e),v&&v.displayInfinitePlane(e)},this.setGroundScale=function(e){C.setGroundScale(e)},this.updateScene=function(e){C.setGroundPosition(e)},this.isAutoGroundOffset=function(){return w.getAutoHeight()},this.setAutoGroundOffset=function(e){w.setAutoHeight(e)},this.setGroundOffset=function(e){w.setHeight(e)},this.setEnvMapBlur=function(e){x.setBlur(e)},this.getOffset=function(){return w.getHeight()},this.setEnvMapOffset=function(e){P.makeRotationZ(e),M.getMatrix().makeRotationZ(e),_&&(M.updateMatrix(),this.updateMatrix()),de=!0},this.setGroundReflectivitiy=function(e){w.setReflectivity(e),w.setActivated(!0)},this.setGroundReflectivity=function(e){w.setReflectivity(e),w.setActivated(!0)},this.setGroundShadowIntensity=function(e){w.setShadowIntensity(e),w.setActivated(!0)},this.isUsedMirror=function(){return w.isActivated()&&"transparent"==w.getType()&&w.getReflectivity()>0},this._setMirror=function(e){(e||"transparent"==w.getType())&&(w.setActivated(e),w.setType("transparent"),w.setReflectivity(.3))},this.getGroundGlossiness=function(){return w.getGlossiness()},this.setCustomBackplateCallback=function(e){x.setType("backplate"),x.setSizeScaling("custom"),x.setBackplateCB(e)},this.setBackplateOffset=function(e,t){te.offset.set(e,t)},this.setBackplateSize=function(e,t){te.invSize.set(e,t)},this.setGroundGlossiness=function(e){w.setGlossiness(e)},this.setTranslation=function(e){P.translate(e),_&&this.updateMatrix()},this.setSkyLighting=function(t,i,r,n){if(v){v.renderer.SkyScatteringEffect?v.renderer.SkyScatteringEffect.setEnabled(!0):v.renderer.initEffect("SkyScattering");var a=this;if(v.setShadow(!0),this.getGround().disableDefaultGroundShadow=!0,this.setExposure(r),H)H.dirLight=t;else{var s=new e.DirectionalLight(16777215,5.5*Math.PI*r);s.castShadow=!0,s.shadowBias=-.005,s.shadowMapWidth=v.shadowMapWidth,s.shadowMapHeight=v.shadowMapHeight,s._sceneShadow=!0,this.setLights(s,!1,t),H=V[V.length-1]}v.renderer.SkyScatteringEffect.setGenerationInput({sunDirection:t,viewAltitude:i}),v.renderer.SkyScatteringEffect.execute(!0,function(t){a.setIblMap({texture:t,hdr:!0,mapping:new e.LatLongReflectionMapping,generateRougnessMap:!0}),a.keepIBLTexture=!0,n&&(a.setBackGroundMap({texture:t,hdr:!0,mapping:new e.LatLongEnvMapping}),a.keepBackgroundTexture=!0)})}},this.setTransitionBackground=function(t,i,r){this.setFiniteMode(!0),t.radius&&b.setSize(t.radius),this.setTransform(t.matrix),(o=x.getImage()).setTexture(t.map);var n=t.hdr?"hdr":"png";o.setFormat(n);var a=t.map;!!t.hdr&&(a.minFilter=e.NearestFilter,a.magFilter=e.NearestFilter,a.wrapS=e.RepeatWrapping,a.wrapT=e.RepeatWrapping);var s=x.getTransitionInfos();if(i&&i.map&&i.map.loadEndStatus===e.AssetLoadingStatus.READY){var o;(o=s.image).setTexture(i.map);n=i.hdr?"hdr":"png";o.setFormat(n);a=i.map;!!i.hdr&&(a.minFilter=e.NearestFilter,a.magFilter=e.NearestFilter,a.wrapS=e.RepeatWrapping,a.wrapT=e.RepeatWrapping),s.ambienceMatrix=i.matrix,s.radius=i.radius,s.transition=r}else s.transition=0;x.setTransitionInfos(s),"transition"==x.getType()&&te?de=!0:(x.setType("transition"),pe())},this.dispose=function(){y&&y!==h&&y.dispose(),this.getIblMap()&&!this.keepIBLTexture&&this.getIblMap().dispose();var e=x.getImage().getTexture();e&&!this.keepBackgroundTexture&&e.dispose(),x.setActivated(!1),M.setActivated(!1),b.setActivated(!1),te&&te.dispose(),this.needUpdateIBL=new Set,a.unsubscribe(this.requestIBLLightExtraction)},this.clone=function(e){e||(e={});var t=void 0!==e.viewer?e.viewer:null,i={viewer:t},r={};r.name=S,r.usePlaneV2=this.usePlaneV2,r.backgroundGeometryEditor=C.stream(),r.transform=P.elements.slice(0),r.background=x.stream(),r.backgroundGeometry=b.stream(),r.environmentLight=M.stream(),r.ground=w.stream(),i.v2=_,i.ambiance=r;var n=new m(i);return n.getGround().setAutoHeight(!0),n.setBackgroundColor(re.getHex()),n.setBackgroundAlpha(ne),t&&t.setBackgroundColor(re.getHex(),ne),T&&I.push(n),D&&R.push(n),y&&n.setRoughnessMap({texture:y}),n},v&&this.setWorldOrientation(v._worldOrientation),this.updateMatrix(),l.ambiance&&this.loadFrom3dx(l.ambiance,l.images,l.from3DX,l.doneCallback,!!l.roughnessMap),pe()};return m}),define("DS/Visualization/PolygonTessellator",["UWA/Class","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Mesh/MeshUtils","libtess/libtess.min"],function(e,t,i,r,n){"use strict";var a=0,s=e.extend({init:function(){this.polygons=[],this.polygonGroupEnd=[],this.currentPolygon=this._createEmptyPolygon()},addPointToCurrentPolygonLoop:function(e,t,i){var r;0===this.currentPolygon.points.length&&(this.currentPolygon.userData=i),this.currentPolygon.points.length>0&&(r=this.currentPolygon.points.length-2,this.currentPolygon.points[r]===e&&this.currentPolygon.points[r+1]===t)||(this.currentPolygon.points.push(e),this.currentPolygon.points.push(t))},closeCurrentPolygonLoop:function(){this.currentPolygon.points.length>2&&(this.currentPolygon.closed=!0,this.polygons.push(this.currentPolygon)),this.currentPolygon=this._createEmptyPolygon()},endCurrentPolygon:function(){this._startNewPolygon(),this.polygonGroupEnd.push(this.polygons.length)},createNode3D:function(e,n){var a,s,o,h,c,d,u,p,f=new i,g=[],m=this.polygonGroupEnd.length;for(u=0;u<m;u++){for(p=!0,h=[],a=0===u?0:this.polygonGroupEnd[u-1];a<this.polygonGroupEnd[u]&&p;a++)if(this.polygons[a].closed){for(c=[],s=this.polygons[a].points,o=0;o<s.length;o+=2)c.push(s[o],-s[o+1]);c.push(s[0],-s[1]),h.push(c)}else p=!1;if(h.length&&p)d=l(h,n),g=g.concat(d);else if(h.length)throw new Error("fill open polygon")}if(0===g.length)return null;for(var v=new Uint32Array(g.length/3),y=0;y<v.length;++y)v[y]=y;var S=[];for(y=0;y<g.length;y+=3)S.push(0,0,1);var _=t.createSimpleMeshNode({bufferPosition:g,bufferIndex:v,glType:r.ConnectivityTypeEnum.TRIANGLES,material:e,bufferNormal:S});return f.addChild(_),f},_startNewPolygon:function(){this.currentPolygon.points.length>2&&this.polygons.push(this.currentPolygon),this.currentPolygon=this._createEmptyPolygon()},_createEmptyPolygon:function(){return{points:[],closed:!1,userData:null,id:a++}}}),o=function(){var e=new n.GluTesselator;return e.gluTessCallback(n.gluEnum.GLU_TESS_VERTEX_DATA,function(e,t){t[t.length]=e[0],t[t.length]=e[1],t[t.length]=e[2]}),e.gluTessCallback(n.gluEnum.GLU_TESS_BEGIN,function(e){e!==n.primitiveType.GL_TRIANGLES&&console.log("expected TRIANGLES but got type: "+e)}),e.gluTessCallback(n.gluEnum.GLU_TESS_ERROR,function(e){console.log("error callback"),console.log("error number: "+e)}),e.gluTessCallback(n.gluEnum.GLU_TESS_COMBINE,function(e,t,i){return[e[0],e[1],e[2]]}),e.gluTessCallback(n.gluEnum.GLU_TESS_EDGE_FLAG,function(e){}),e}();function l(e,t){o.gluTessNormal(0,0,1);var i=[];o.gluTessBeginPolygon(i);for(var r=0;r<e.length;r++){o.gluTessBeginContour();for(var n=e[r],a=0;a<n.length;a+=2){var s=[n[a],n[a+1],t];o.gluTessVertex(s,s)}o.gluTessEndContour()}return o.gluTessEndPolygon(),i}return s}),define("DS/Visualization/DecalManager",["DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS"],function(e,t,i){"use strict";var r=1,n=1,a=0,s=new Map,o=!1,l=function(e){e.setPickable(o?t.PICKABLE:t.PICKTHROUGH),o?e.excludeFromHighlight(!1,!1):e.excludeFromHighlight(!0,!0)},h=function(){this.activated=!1,this._creatingDecal=!1};h.prototype={_attachViewer:function(e){s.has(e)||s.set(e,new Set)},detachViewer:function(e){s.delete(e)},createDecal:function(t){if(!(!!i.supportedExtensions.textureHalfFloat&&!!i.supportedExtensions.renderToHalfFloatTexture&&!!i.supportedExtensions.textureHalfFloatLinear||!!i.supportedExtensions.textureFloat&&!!i.supportedExtensions.renderToFloatTexture&&!!i.supportedExtensions.textureFloatLinear))return console.error("Error: float/half float textures not supported, decals disabled"),null;if(!i.supportedExtensions.fragDepth)return console.error("Error: frag depth not supported, decals disabled"),null;if(!t.material&&!t.materialApplication)return console.error("Error: you need to give a material to a decal node"),null;if(t.material&&!t.material.isPhysicalMaterial)return console.error("Error: unsupported decal material, expected PhysicalMaterial"),null;if(t.materialApplication&&!t.materialApplication._material&&!t.materialApplication._material.isPhysicalMaterial)return console.error("Error: unsupported decal material, expected PhysicalMaterial"),null;this._creatingDecal=!0;var r=new i.Matrix4,n=t.material,a=t.materialApplication;t.matrix&&(r=t.matrix);var s=e.createCuboidNode({cornerPoint:new i.Vector3(-.5,-.5,-.5),firstAxis:new i.Vector3(1,0,0),secondAxis:new i.Vector3(0,1,0),thirdAxis:new i.Vector3(0,0,1),_decal:!0});return s._setHasExplicitUv(!!t.explicitUv),a?s.setMaterialApplication(a):s.setMaterial(n),s.setMatrix(r),l(s),s.setVisibilityInTree(!1),this._creatingDecal=!1,s},updateDecalsPickable:function(e){o=e,s.forEach(function(e,t,i){e.forEach(function(e,t,i){l(e)})})},updateDecalsData:function(e,t){this._attachViewer(e),r=1,n=0,a=0;var i=this.activated;i&&t&&(i=s.get(e).size>0);if(i){var o=new Set;s.set(e,o),this._updateDecalsData(e.getRootNode()._occurrences[0],o,!1)}},_updateDecalsData:function(e,t,i){if(!e.node._isDecal){var s=e.node.decalCount>0;if(s){a++,n++;for(var o=0;o<e.children.length;o++){(l=e.children[o]).node._isDecal&&(l.renderable._decalData={key:0,stencilID:n,explicitUv:l.node._getHasExplicitUv(),needDrawUvs:!1},i=i||l.renderable._decalData.explicitUv,t.add(l.node),l.renderable._flagAsGSSOInvalidated())}}for(o=0;o<e.children.length;o++)this._updateDecalsData(e.children[o],t,i);if(e.renderable&&(e.renderable._decalData=a>0?{key:4*r,stencilID:n,explicitUv:!1,needDrawUvs:i}:null,e.renderable._flagAsGSSOInvalidated()),s){a--;for(o=0;o<e.children.length;o++){var l;(l=e.children[o]).node._isDecal&&(l.renderable._decalData.key=4*r+1,l.renderable._flagAsGSSOInvalidated())}r++}}},displayDecalInfo:function(e){console.clear(),this._displayInfo(e.getRootNode()._occurrences[0],0)},_displayInfo:function(e,t){for(var i="",r=0;r<t;r++)i+=" ";if(e.renderable){var n=e.renderable;console.log(""),console.log(i+(e.node._isDecal?"decal:":"geometry:")),n._decalData&&(console.log(i+" key: "+n._decalData.key),console.log(i+" stencil: "+n._decalData.stencilID))}var a=2*t+2;for(r=0;r<e.children.length;r++)this._displayInfo(e.children[r],a)}};var c=new h;return i.DecalManager=c,c}),define("DS/Visualization/SceneGraphUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Visualization/PathElement","DS/SceneGraphNodes/AxisSystemNode"],function(e,t,i,r,n,a,s,o,l,h,c,d,u,p){"use strict";var f=null,g={_getUniqueOccurrence(e){if(!e)return null;var t=e._getOccurrences();return 1!==t.length?null:t[0]},getCurrentVisibility:function(e){if(!e)return!1;for(var t=0;t<e.externalPath.length;t++){if(!e.externalPath[t].isVisible())return!1}return!0},_getDGorLayers:function(e,t){var i=[],r=e.layer;if(r)for(var n=r.layers.length,a=0;a<n;a++){var s=r.layers[a];s.drawableInterval.layerNum<=0||(t&&4!==s.drawableGroup.glType||i.push(s))}else{var o=e.geometry.length;for(a=0;a<o;a++)for(var l=e.geometry[a].drawingGroups,h=l.length,c=0;c<h;c++)t&&4!==l[c].glType||i.push(l[c])}return i},_getCurrentGraphicProperties:function(t,i,r,n,a){for(var s=[],o=t.getLastElement(!0),l=t._getRenderableOccurrences(i),h=0;h<l.length;h++){var c=l[h],d=c.visible,p=c.layer,f=c.matApp,g=c.meshMaterial,m=c.gas,v=new u(t.externalPath),y={path:v,materials:[],gas:[],visible:d};s.push(y);for(var S=[],_=c._occurrence;_.node!==o;)S.unshift(_.node),_=_.parent;for(var x=0;x<S.length;x++)v.addElement(S[x]);var b=this._getDGorLayers(c,!0);for(x=0;x<b.length;x++){var w=b[x],M=null;p&&(M=w.drawableInterval,w=w.drawableGroup);var C=w.glType,P=null,E=null,A=f&&f._getMaterialFromGLType(C,w._geomType),T=M&&M.material?M.material:w.material,D=M&&M.gas?M.gas:w.gas;T&&(T.isMatApp&&(P=T.solveInheritance(f,c._occurrence.depth)===f?A:T._getMaterialFromGLType(C,w._geomType)),P||T.isMatApp||(A?f:null,(P=A)||(P=T instanceof e.Material?T:null))),P||(f,P=A),!P&&g&&g.force&&(P=g),E=m?m.getMaterial(D,C,null,null):D.isGAS?D.getMaterial(null,C,null,null):D,r||(P=null),n||(E=null);for(var I=!1,R=0;R<y.materials.length;R++){var O=y.materials[R],L=y.gas[R];if(O===P&&L===E){I=!0;break}}I||(y.materials.push(P),y.gas.push(E))}}return s},getCurrentGraphicProperties:function(e){for(var t=[],i=this._getCurrentGraphicProperties(e.pathElement,e.viewer,e.getMaterial,e.getColor||e.getOpacity,e.getVisibility),r=0;r<i.length;r++)for(var n=i[r],a=0;a<n.materials.length;a++){var s={pathElement:n.path};e.getMaterial&&(s.material=n.materials[a]);var o=n.gas[a];e.getOpacity&&(s.opacity=o?o.isGAS?o._alpha:o.opacity:1),e.getColor&&(s.color=o?o.isGAS?o._color:o.color:null),e.getVisibility&&(s.visibility=n.visible),t.push(s)}return t},_getCurrentMaterialOrGAS:function(e,t){var i="matApp"===t?"material":t,r=g._getUniqueOccurrence(e);if(!r)return null;for(var n=null;!n&&r;){if(r[t])return r[t];if(n=r.renderable){if(n[t])return n[t];var a=null;if(n.layer)for(var s=0;s<n.layer.layers.length;s++){var o=n.layer.layers[s];if(!(o.drawableInterval.layerNum<=0)&&(a=o.drawableInterval[i],4===o.drawableGroup.glType&&o.drawableInterval[i]))return a}else for(s=0;s<n.geometry.length;s++)for(var l=n.geometry[s],h=0;h<l.drawingGroups.length;h++){var c=l.drawingGroups[h];if(a=c[i],4===c.glType&&c[i])return a}return a}if(1!==r.children.length)break;r=r.children[0]}return null},getCurrentOpacity:function(e){var t=this._getCurrentMaterialOrGAS(e,"gas");return t?t.isGAS?t._alpha:t.opacity:1},getCurrentColor:function(e){var t=this._getCurrentMaterialOrGAS(e,"gas");return t?t.isGAS?t._color:t.color:null},getCurrentMaterial:function(e,t){var i=this._getCurrentMaterialOrGAS(e,"matApp");return i?"Face"===t?i._material:"GeomFace"===t?i._materialGeomFace:"Line"===t?i._materialLine:"Point"===t?i._materialPoint:i._material?i._material:i._materialGeomFace?i._materialGeomFace:i._materialLine?i._materialLine:i._materialPoint?i._materialPoint:null:null},applyMaterialToOccurrencePath:function(e,t,i){var r,n=e._getRenderableOccurrencesFromOccurrencePath(t);for(r=0;r<n.length;r++)n[r].material=i},applyMaterialToPath:function(e,t){return i._applyMaterialToPath(e,t)},applyVisibilityToPaths:function(e,t){for(var r=new Map,n=0;n<e.length;n++){for(var a=e[n],s=a._getRenderableOccurrences(),o=s.length,l=0;l<o;l++)(u=s[l])&&u._flagAsGSSOInvalidated();var h=a.getLastElement();if(null===h)return!1;if(h instanceof i)2===t?h.setVisibility(!h.visible,!0):h.setVisibility(t,!0);else if(1===o)if((p=r.get(s[0]))||(p=[],r.set(s[0],p)),"rep"===h.getType()){var c=h.getChildren();for(l=0;l<c.length;l++)p.push(c[l].sgNode)}else"primitive"===h.getType()&&p.push(h.sgNode)}const d=r[Symbol.iterator]();for(const e of d){var u=e[0],p=e[1];null===u.layer&&u.initLayers(1),u.layer.addPrimitivesToLayers(p,t)}},applyVisibilityToPath:function(e,t,r){if(null===e)return!1;var n=e._getRenderableOccurrences(),a=n.length;for(h=0;h<a;h++)(o=n[h])&&o._flagAsGSSOInvalidated();var s=e.getLastElement();if(null===s)return!1;if(r){if(1!==a)return!1;var o;null===(o=n[0]).layer&&o.initLayers(1),o.layer.addPrimitivesToLayers(r,t)}else if(s instanceof i)2===t?s.setVisibility(!s.visible,!0):s.setVisibility(t,!0);else{if(1!==a)return!1;r=[];if("rep"===s.getType())for(var l=s.getChildren(),h=0;h<l.length;h++)r.push(l[h].sgNode);else"primitive"===s.getType()&&r.push(s.sgNode);null===n[0].layer&&n[0].initLayers(1),n[0].layer.addPrimitivesToLayers(r,t)}return!0},getVisibilityFromPath:function(e){if(!e)return!1;var t=e._getRenderableOccurrences(),r=t.length,n=e.getLastElement();if(!n)return!1;if(n instanceof i)return n.isVisible();if(1!==r)return!1;var a,s=t[0];if(null===s.layer)return!0;if("rep"===n.getType()){var o=n.getChildren();o[0]&&(a=o[0].sgNode)}else"primitive"===n.getType()&&(a=n.sgNode);for(var l=a.getGroup(),h=a.getStart(),c=s.layer.layers,d=0;d<c.length;d++){var u=c[d];if(l===u.drawableGroup){var p=u.drawableInterval;if(!(h<p.start||h>=p.start+p.count))return 1===p.layerNum}}return!1},getOrientedBoundingBoxFromPathElements:function(t,i,r,n){for(var a=new e.Box3,s=(new e.Matrix4).extractRotation(i),o=0;o<t.length;++o){var l=t[o].getOrientedBoundingBox(i,r,null,null,null,!!n);l&&(a=a.union(l))}return{cornerPoint:(new e.Vector3).copy(a.min).applyMatrix4(i),firstAxis:new e.Vector3(a.max.x-a.min.x,0,0).applyMatrix4(s),secondAxis:new e.Vector3(0,a.max.y-a.min.y,0).applyMatrix4(s),thirdAxis:new e.Vector3(0,0,a.max.z-a.min.z).applyMatrix4(s),localBBox:a}},getMaterialsFromPath:function(e,t,i){e.getRootNode()._tryOverridesUpdate(e);var r=t._getUniqueOccurrence(),n=null,a=null,s=null;return r&&r.renderable&&(a=[],this._traversePathMaterials(r,function(e){a.indexOf(e)<0&&a.push(e)},function(){},null,!1),r.overrideLink&&(s={color:r.overrideLink.getColor(),opacity:r.overrideLink.getOpacity(),material:r.overrideLink.getFullMaterial()}),n={materials:a,overrides:s}),n},buildModelIdPath:function(e){var t,i,r,n={elements:[],subElements:[]},a=e.getLastElement();if(a instanceof p&&a._sgRep)t={id:a._sgRep.cgmId,namingContext:a._sgRep.namingContext},n.elements.push(t);else for(i=0;i<e.internalPath.length;i++)(r=e.internalPath[i].sgNode).getType&&3===r.getType()?n.subElements.push(r.getCgmId()):1!==r.type&&2!==r.type||(t={id:r.cgmId,namingContext:r.namingContext},n.elements.push(t));return n},buildPathElementFromModelIdPath:function(e,t){var i=e.getLastElement(!0);if(!(i instanceof r))return null;var s,o,l,h,c,d,p,f,g=null,m=t.elements,v=null,y=new a.SGPrimitiveHelper,S=!1;if(t.subElements.length>0&&(g=t.subElements[0])>0)for(s=0;s<i.mesh3js.geometry.length&&!S;s++)for(d=i.mesh3js.geometry[s],o=0;o<d.drawingGroups.length&&!S;o++)for(p=d.drawingGroups[o],l=0;l<p.getPrimitivesCount()&&!S;l++)if(y.set(p,l),y.getCgmId()===g){for(h=m.length-1,c=y.getRep();c&&h>=0&&c.cgmId===m[h].id;)c=c.parents[0],h--;!c&&h<0&&(S=!0)}if(S)(f=e._getUniqueOccurrence())&&(v=new u).setFromOccurrence(f,n.getFromSGNode(y));else if(1===m.length){var _=i.parents[0],x=_&&_.getChildByName("AxisSystems");if(x){for(s=0;s<x.children.length&&!S;s++){var b=x.children[s]._sgRep;b&&b.cgmId===m[0].id&&(S=x.children[s])}if(S){for(v=new u,s=0;s<e.externalPath.length&&e.externalPath[s]!==i;s++)v.addElement(e.externalPath[s]);v.addElement(x),v.addElement(S)}}}return v},buildPathesLeadingToNode:function(e,t){var i,r,n,a=[];for(i=0;i<e._occurrences.length;i++)r=e._occurrences[i],(n=new u).setFromOccurrence(r,null,t)&&a.push(n);return a},setRenderPriority:function(e,t,i){if(m.indexOf(t)<0)return console.warn("SceneGraphUtils.setRenderPriority invalid input priority value"),!1;var r=e._getUniqueOccurrence(i);if(r){var n=r.renderPriority,a={userPriority:null!==t,priority:t,userOpacity:!(!n||!n.userOpacity),opacity:n?n.opacity:null,lastRenderPriority:n?n.lastRenderPriority:-1};return r.renderPriority=a,r.node._forceUpdate(),!0}return console.warn("SceneGraphUtils.setRenderPriority error: invalid pathElement"),!1},setRenderPriorityOpacity:function(e,t,i){t||0===t||(t=null);var r=e._getUniqueOccurrence(i);if(r){var n=r.renderPriority,a={userPriority:!(!n||!n.userPriority),priority:n?n.priority:null,userOpacity:null!==t,opacity:t,lastRenderPriority:n?n.lastRenderPriority:-1};return r.renderPriority=a,r.node._forceUpdate(),!0}return console.warn("SceneGraphUtils.setRenderPriority error: invalid pathElement"),!1},_traversePathMaterials:function(t,i,r,n,a,s){if(null===t)return null;var o={};function l(e){var t=[],i=0;for(i=0;i<e.geometry.length;i++){var r=0,n=e.geometry[i];for(r=0;r<n.drawingGroups.length;r++){var a=n.drawingGroups[r];if(t[o[a.glType]]){if(t[o[a.glType]]!==a.gas)return null}else t[o[a.glType]]=a.gas}}return t}o[0]=0,o[3]=1,o[2]=1,o[1]=1,o[5]=2,o[6]=2,o[4]=2;var h=[];t.renderable&&h.push(t.renderable);for(var c=h.length,d=0;d<c;d++){var u=h[d],p=!s&&l(u);if(u.material&&u.material.force){var f=u.userData&&u.userData.oldMaterial?u.userData.oldMaterial:u.material;i(f,f,function(e){u.material=e},u)}else if(p){var g=p[2];g||(g=new e.MeshBasicMaterial),p[0]&&(g.point=p[0]),p[1]&&(g.line=p[1]),i(p[2],g,function(e){e.force=!0,u.material=e},u)}else if(a||u.layer){var m=0;for(m=0;m<u.layer.layers.length;m++){var v=u.layer.layers[m];s&&v.drawableGroup._geomType!==s||(v.drawableInterval.material?i(v.drawableInterval.material,v.drawableInterval.material,function(e){v.drawableInterval.material=e}):i(v.drawableGroup.gas,v.drawableGroup.gas,function(e){v.drawableInterval.material=e}))}}else{n&&n(u);var y=0;for(y=0;y<u.geometry.length;y++){var S=0,_=u.geometry[y];for(S=0;S<_.drawingGroups.length;S++){var x=_.drawingGroups[S];!x||s&&x._geomType!==s||i(x.gas,x.gas,function(e){u.layer.addPrimitivesToLayers(x.primitives,1,e)})}}}r()}},streamVisu:function(i){var r=["vertexIndexArray","vertexPositionArray","vertexNormalArray","vertexUvArray","vertexUv2Array","vertexTangentArray","vertexBinormalArray","vertexColorArray"],n=i.layers||!1,s=i.node?i.node:i,o=(i.nodejsContext,i.nodeCallback),l=i.imageCallback,h=i.loadedTexturesCallback,c=null,d=i.embeddedTextures||!1,u=0,p={textures:{},materials:{},geometries:{},nodes:{}},g=1e8,m=0,v=[{size:0,buffers:[],data:null}],y={json:p,chunks:v};function S(e){v[m].size+e.byteLength>g&&(v[++m]={size:0,buffers:[],data:null});var t=v[m],i=t.size;return t.buffers.push({buffer:new Uint8Array(e.buffer,e.byteOffset,e.byteLength),offset:i}),t.size+=e.byteLength,t.size%4&&(t.buffers.push({buffer:new Uint8Array(4-t.size%4),offset:t.size}),t.size+=4-t.size%4),i}function _(){u--,console.log("nb textures loading: "+u),c&&!u&&c(y)}function x(t,i){if(t.image)if(t.image.getContext||t.image.tagName&&"img"===t.image.tagName.toLowerCase()){if(t.sourceFile&&"blob:"===t.sourceFile.substring(0,5)){var r=new XMLHttpRequest;r.open("GET",t.sourceFile,!0),r.responseType="blob",r.onload=function(e){if(200===this.status){var t=this.response.type;i.format="image/jpeg"===t?"jpeg":"png",i.data=this.response,i.path="texture_"+i.id+"."+i.format,console.log("canvas blob"),_()}},r.send()}else if(t.image.getContext){var n=(l=t.image.getContext("2d")).getImageData(0,0,t.image.width,t.image.height);i.format="png",i.data=n,i.path="texture_"+i.id+"."+i.format,console.log("png"),_()}}else if(t.mipmaps&&t.mipmaps.length){var a=t.image.width,s=t.image.height;i.format="dds",i.data=new Blob([e.ImageUtils.streamDDS(t)],{type:"arraybuffer"}),i.path="texture_"+i.id+"."+i.format,console.log("dds"),_()}else{a=t.image.width,s=t.image.height;var o=f||document.createElement("canvas");o.width=a,o.height=s;for(var l,h=(n=(l=o.getContext("2d")).getImageData(0,0,a,s)).data,c=0;c<s;c++)for(var d=0;d<4*a;d++)h[4*(s-c-1)*a+d]=t.image.data[4*c*a+d];l.putImageData(n,0,0,0,0,a,s);var u=atob(o.toDataURL("image/png").split(",")[1]),p=new Array(u.length);for(c=0;c<u.length;c++)p[c]=u.charCodeAt(c);var g=new Uint8Array(p);i.format="png",i.data=new Blob([g],{type:"image/png"}),i.path="texture_"+i.id+"."+i.format,console.log("uncompressed"),_()}}function b(i,r){if(!r.textures[i.id]){var n={id:i.id,anisotropy:i.anisotropy,magFilter:i.magFilter,minFilter:i.minFilter,wrapS:i.wrapS,wrapT:i.wrapT,repeat:i.repeat};if(l)l(i,n);else if(d)if(i.loadEndStatus&&i.loadEndStatus!==e.AssetLoadingStatus.READY){if(i.loadEndStatus===e.AssetLoadingStatus.ERROR)return void console.log("texture was not loaded: impossible to embed it in streamvisu.");u++,console.log("nb textures loading: "+u),i.onLoadCallbacks.push(function(e){x(e,n)})}else u++,console.log("nb textures loading: "+u),x(i,n);else if(i.sourceFile){n.format=t.getExtension(i.sourceFile);var a=function(e){var t="";if("blob:"===e.substring(0,5))return null;if("http://"===e.substring(0,7))t=e;else if("https://"===e.substring(0,8))t=e;else if("/"===e.substring(0,1))t=e;else{if("file://"===e.substring(0,7))return null;var i=location.href,r=i.indexOf("?");-1!==r&&(i=i.substring(0,r));var n=i.lastIndexOf("/");-1!==n&&(i=i.substring(0,n+1)),t=i+e}return t}(i.sourceFile);a&&(n.path=a)}r.textures[i.id]=n}return i.id}function w(t,i){var r="MeshPhong";t instanceof e.LineBasicMaterial?r="LineBasic":t instanceof e.PhysicalMaterial?r="Physical":t instanceof e.MeshLambertMaterial&&(r="MeshLambert");var n={id:t.id,type:r,visible:t.visible,force:t.force,side:t.side,enableClipPlanes:t.enableClipPlanes,transparent:t.transparent,opacity:t.opacity,alphaTest:t.alphaTest,depthTest:t.depthTest,depthWrite:t.depthWrite};return t.color&&(n.color=t.color),(t instanceof e.MeshPhongMaterial||t instanceof e.MeshLambertMaterial||t instanceof e.PhysicalMaterial)&&(n.ambient=t.ambient,n.emissive=t.emissive,n.specular=t.specular,n.shininess=t.shininess,n.vertexColors=t.vertexColors,void 0!==t.glossiness&&(n.glossiness=t.glossiness),void 0!==t.metalness&&(n.metalness=t.metalness),t.map&&(n.diffuseMap=b(t.map,i)),t.bumpMap&&(n.bumpMap=b(t.bumpMap,i)),t.normalMap&&(n.normalMap=b(t.normalMap,i)),t.specularMap&&(n.specularMap=b(t.specularMap,i)),t.emissiveMap&&(n.emissiveMap=b(t.emissiveMap,i)),t.metalnessMap&&(n.metalnessMap=b(t.metalnessMap,i)),t.glossinessMap&&(n.glossinessMap=b(t.glossinessMap,i)),t.bumpMap&&void 0!==t.bumpScale&&(n.bumpScale=t.bumpScale),t.coating&&(n.coating=t.coating),t.coating&&void 0!==t.coatingGlossiness&&(n.coatingGlossiness=t.coatingGlossiness)),n}return s.traverse(function(t,i){var s=i.nodes[t.id];if(!s){var l=t.getNodeType();if(s={id:t.id,type:l},t._matrix&&!t._matrix.isIdentity()){var h=[];t._matrix.flattenToArray(h),s.matrix=h}if(t.material&&((j=i.materials[t.material.id])||(j=t.material,i.materials[t.material.id]=w(j,i)),s.material=t.material.id),i.nodes[t.id]=s,"Node3D"===l){for(var c=[],d=0;d<t.children.length;d++)c.push(t.children[d].id);s.children=c}else{var u=t._occurrences[0].renderable,p=u.boundingSphere,f=u.boundingBox;f||(f=p.getBoundingBox());var g=!1;if(n)for(d=0;d<t._occurrences.length;d++)if(t._occurrences[d].renderable.layer){g=!0;break}var v=[];for(d=0;d<u.geometry.length;d++){var y=u.geometry[d].id;v.push(y);var _=i.geometries[y];if(!_){_=u.geometry[d];var x={};x.id=_.id;for(var b=0;b<r.length;b++){var M=_[r[b]];if(M){var C=S(M),P={chunk:m,offset:C,byteLength:M.byteLength,bpe:M.BYTES_PER_ELEMENT,itemSize:M.itemSize};x[r[b]]=P}}for(x.dgs=[],b=0;b<_.drawingGroups.length;b++){var E=_.drawingGroups[b];n&&g&&(E.__id__=b);for(var A=E.getPrimitivesCount(),T=0,D=0;D<A;D++)(L=E.getPrimitiveDecoration(D))&&L.length&&(T+=L.length);var I=new Uint32Array(4*A),R=new Uint8Array(T),O=0;for(D=0;D<A;D++){var L,V=E.getPrimitiveCgmId(D),F=E.getPrimitiveRep(D),B=E.getPrimitiveStart(D),N=E.getPrimitiveCount(D);if(I[4*D]=V,I[4*D+1]=F?F.cgmId:0,I[4*D+2]=B,I[4*D+3]=N,(L=E.getPrimitiveDecoration(D))&&L.length){console.log(L.length),L.length>255&&console.log("panic"),R[O++]=L.length;for(var G=0;G<L.length;++G)R[O++]=L[G]}else R[O++]=0}C=S(I);var k={chunk:m,offset:C,byteLength:I.byteLength,bpe:I.BYTES_PER_ELEMENT,itemSize:I.itemSize},U=void 0;if(T){var z=S(R);U={chunk:m,offset:z,byteLength:R.byteLength,bpe:R.BYTES_PER_ELEMENT,itemSize:R.itemSize}}x.dgs[b]={start:E.start,count:E.count,geomType:a.GeomTypeString[E._geomType],glType:E.glType,primitives:k,canonicals:U},E.material instanceof e.Material?(i.materials[E.material.id]||(i.materials[E.material.id]=w(E.material,i)),x.dgs[b].material=E.material.id):E.gas&&(i.materials[E.gas.id]||(i.materials[E.gas.id]=w(E.gas,i)),x.dgs[b].gas=E.gas.id)}i.geometries[y]=x}}if(s.mesh3js={bs:{c:[p.center.x,p.center.y,p.center.z],r:p.radius},bbox:{min:[f.min.x,f.min.y,f.min.z],max:[f.max.x,f.max.y,f.max.z]},geometries:v},n&&g)for(s.occurrences={},d=0;d<t._occurrences.length;d++){var H=t._occurrences[d].renderable;if(H.layer){var W=[];for(s.occurrences[d]={index:d,layers:W},b=0;b<H.layer.layers.length;b++){var j,X=H.layer.layers[b],q={start:X.drawableInterval.start,count:X.drawableInterval.count,primitiveStart:X.drawableInterval.primitiveStart,primitiveCount:X.drawableInterval.primitiveCount,layerNum:X.drawableInterval.layerNum};X.drawableInterval.material&&(q.material=X.drawableInterval.material.id,(j=i.materials[q.material])||(j=X.drawableInterval.material,i.materials[q.material]=w(j,i))),W.push({geometry:X.geometry.id,drawableGroup:X.drawableGroup.__id__,drawableInterval:q})}}}u.material&&((j=i.materials[u.material.id])||(j=u.material,i.materials[u.material.id]=w(j,i)),s.mesh3js.material=u.material.id)}o&&o(t,s)}},p),p.nbChunks=v.length,h&&(c=h),y.chunks=function(){for(var e=0;e<v.length;e++){var t=v[e];t.data=new Uint8Array(t.size);for(var i=0;i<t.buffers.length;i++)for(var r=t.buffers[i],n=r.buffer,a=r.offset,s=0;s<n.byteLength;s++)t.data[a+s]=n[s]}return v}(),!u&&c&&c(y),y}},m=[0,1,2,3,4];return g}),define("DS/Visualization/SceneGraph",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Visualization/SceneGraphUtils"],function(e,t,i,r,n,a,s,o,l,h,c,d,u){"use strict";if(!window.undoSceneGraphMigrationStep2)return function(){}}),define("Visualization/SceneGraph",["DS/Visualization/SceneGraph","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SceneGraph"),e}),define("DS/Visualization/ModelLoader",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/SceneGraph","DS/VisuEvents/EventsManager","DS/Visualization/WorldOrientation","DS/Visualization/MaterialManager"],function(e,t,i,r,n,a,s){"use strict";var o=e.extend({init:function(e,i){return this._viewer=null,this.fileType="xmlv43",this.geometryMode="3dxmlgeometry",this.smartLoading=!1,this.filterNavReps=!1,this.modelName="",this._internalTarget=null,this.Ox4MQLV6Loader=null,this.cgrLoader=null,this.uvrLoader=null,this.xmlv43Loader=null,this.xmlv6Loader=null,this.xmlv6SmartLoader=null,this.colladaLoader=null,this.jsonLoader=null,this.objLoader=null,this.xcadLoader=null,this.particlesLoader=null,this.streamVisuLoader=null,this.threeDXLoader=null,this.multipartMode=!1,this.CGRNewInfra=!0,this.keepLoaderMode=!1,this.expandMode=!1,this.readDecoration=!1,this.primitiveWithBS=!1,this.forceGPUCurvedPipes=localStorage.getItem("curvedPipesInstancing")?"true"===localStorage.getItem("curvedPipesInstancing"):null,this.repWithBS=!1,this.withSAG=!1,this.useDefaultTCSet=!1,this.accuracyInfo={sag2D:0,sag3D:0},this.withBagUUID=!1,this.useUvrWorker=!0,this.withSceneGraph=!1,this.withBlanking=!1,this.sceneGraphOrderMode=0,this.smartStaticBatching=!0,this.edgeTransparency=!0,this.sharedBuffers=!0,this.noMeshInRAM=!1,this.processText=!1,this.accelStruct=!1,this.materialManager=null,this.targetNode=null,this.glContext=e,this.renderer=null,this.renderCB=null,this.onLoadedCB=function(){n.RecordEventsManager&&n.RecordEventsManager.sendSynchroPoint("ModelLoaded"),window.webVisuPerfo.endPerfo("load"),t.loadingModels=!1},this.onLoadedPrdCB=null,this.onProgressCB=null,this.onErrorCB=null,this.refreshTime=2e3,this.debugBBox=void 0!==i&&i,this.poolOfModels={xmlv43:{loading:!1,models:[]},xmlv6:{loading:!1,models:[]},Ox4MQLV6:{loading:!1,models:[]},OxMQLV5:{loading:!1,models:[]},cgr:{loading:!1,models:[]},streamvisu:{loading:!1,models:[]},"3dx":{loading:!1,models:[]}},this._Ox4ProxyAbstraction=null,this},setSceneGraph:function(e){this.targetNode=e},setSceneGraphOrderMode:function(e){this.sceneGraphOrderMode=e},getSceneGraphOrderMode:function(){return this.sceneGraphOrderMode},setViewer:function(e){this._viewer=e},setTargetNode:function(e){this.targetNode=e},setWebGLContext:function(e){this.glContext=e},getCGROptions:function(){return{readDeco:this.readDecoration,optimizeCurvedPipes:this.forceGPUCurvedPipes,primWithBS:this.getPrimitivesWithBoundingSphere(),repWithBS:this.getRepsWithBoundingSphere(),edgeTransparency:this.getEdgeTransparency(),cgrWithSG:this.getCGRWithSG(),sharedBuffers:this.getSharedBuffers(),noMeshInRAM:this.getNoMeshInRAM(),smartStaticBatching:this.smartStaticBatching,sceneGraphOrderMode:this.getSceneGraphOrderMode(),withSAG:this.withSAG,withBagUUID:this.withBagUUID,sagInfo:this.accuracyInfo,withSceneGraph:this.getCGRWithSG(),withBlanking:this.getCGRWithBlanking(),uvrWorker:this.useUvrWorker,cgrMultipartMode:this.getMultipartMode(),cgrExpandMode:this.getExpandMode(),processText:this.processText}},setRenderCallback:function(e,t){this.renderCB=e,this.refreshTime=t||2e3},setOnLoadedCallback:function(e){var i=this;this.onLoadedCB=function(r){if(window.webVisuPerfo.endPerfo("load"),n.RecordEventsManager&&n.RecordEventsManager.sendSynchroPoint("ModelLoaded"),t.loadingModels=!1,i._internalTarget){var a=new Set,s=new Set;i._internalTarget._compactHierarchy(a,s)}i._internalTarget=null,e&&e.call(this,r)}},setOnLoadedProductStructureCallback:function(e){this.onLoadedPrdCB=e},setOnProgressCallback:function(e){this.onProgressCB=e},setOnErrorCallback:function(e){this.onErrorCB=e},activateSmartLoading:function(e){null!==e&&(this.renderer=e,this.smartLoading=!0)},deactivateSmartLoading:function(){this.smartLoading=!1},setFilterNavReps:function(e){this.filterNavReps=e},getFileType:function(){return this.fileType},setFileType:function(e){this.fileType=e},getGeometryMode:function(){return this.geometryMode},setGeometryMode:function(e){this.geometryMode=e,null!==this.xmlv6Loader&&this.xmlv6Loader.setGeometryMode(e)},getMultipartMode:function(){return this.multipartMode},setMultipartMode:function(e){this.multipartMode=e},getCGRNewInfra:function(){return this.CGRNewInfra},setKeepLoaderMode:function(e){this.cgrLoader&&this.cgrLoader.setKeepLoaderMode(e),this.keepLoaderMode=e},getKeepLoaderMode:function(){return this.keepLoaderMode},setCGRNewInfra:function(e){this.CGRNewInfra=e},setPrimitivesWithBoundingSphere:function(e){t._BinaryPrimitives||!e?this.primitiveWithBS=!!e:console.warn("Primitives must be in binary form for primitive bounding spheres")},getPrimitivesWithBoundingSphere:function(){return this.primitiveWithBS&&t._BinaryPrimitives},setRepsWithBoundingSphere:function(e){this.repWithBS=!!e},getRepsWithBoundingSphere:function(){return this.repWithBS},getCGRWithSG:function(){return this.withSceneGraph},getCGRWithBlanking:function(){return this.withBlanking},setCGRWithBlanking:function(e){this.withBlanking=e},setCGRWithSG:function(e){this.withSceneGraph=e},getCGRWithUUID:function(){return this.withBagUUID},set3DAccuracy:function(e){this.accuracyInfo.sag3D=e},setCGRWithUUID:function(e){this.withBagUUID=e},getOptimizeCurvedPipes:function(){return this.forceGPUCurvedPipes},setOptimizeCurvedPipes:function(e){this.forceGPUCurvedPipes=e},set2DAccuracy:function(e){this.accuracyInfo.sag2D=e},getEdgeTransparency:function(){return this.edgeTransparency},setEdgeTransparency:function(e){this.edgeTransparency=e},getSharedBuffers:function(){return this.sharedBuffers},setSharedBuffers:function(e){this.sharedBuffers=e},getNoMeshInRAM:function(){return this.noMeshInRAM},setNoMeshInRAM:function(e){this.noMeshInRAM=e},getExpandMode:function(){return this.expandMode},setExpandMode:function(e){this.expandMode=e},setAccelerationStructure:function(e){this.accelStruct=e},enableLDH:function(e,t,i,r,n,a){var s=this;require(["DS/SelectiveLoading/SelectiveLoadingAsync"],function(o){s.LDH=o,s.LDH.Helpers._enableLDH(s,e,t,i,n,a),void 0!==s.LDHAsyncDestruction?s.destructLDH():r&&r()},function(e){var t=e.requireModules&&e.requireModules[0];console.error("Module "+t+" is missing."),s.onErrorCB&&s.onErrorCB()})},getLDHInterface:function(){return this._ldhInterface},destructLDH:function(){void 0===this.LDH?this.LDHAsyncDestruction=!0:(this.LDH.Helpers._ldhCleanup(this),delete this.LDHAsyncDestruction,delete this.LDH)},_onModuleError:function(e,t){return function(i){var r=i.requireModules&&i.requireModules[0];console.log("Module "+r+" is missing."),e&&e({url:t,type:"FORMAT"})}},_xmlv43LoaderCB:function(e){var t=this;this.xmlv43Loader.load(e.jsonSettings,function(i,r){t._viewer&&(1===r?t._viewer.setWorldOrientation(a.YUpXRight):t._viewer.setWorldOrientation(a.ZUpYRight)),e.destination.addChild(i),null!==e.loadedProductCB&&e.loadedProductCB(i),null!==e.renderCB&&e.renderCB({needReframe:!1}),e.destination=null},e.loadedProductCB,e.progressCB,e.loadedCB,e.errorCB,e.filterNavReps,e.refreshTime,e.readDecoration,e.cgrNewInfra,e.primitiveWithBS,e.edgeTransparency,e.cgrWithSG,e.cgrWithBlanking,e.sharedBuffers,e.noMeshInRAM,e.smartStaticBatching,e.cgrWithSAG,e.accuracyInfo,e.uvrWorker,e.applicativeContainers,e.processText,e.cgrWithBagUUID,e.repWithBS,e.optimizeCurvedPipes)},_xmlv6LoaderCB:function(e){this.xmlv6Loader.load(e.modelName,function(t){e.destination.addChild(t),null!==e.loadedProductCB&&e.loadedProductCB(t),null!==e.renderCB&&e.renderCB({needReframe:!0}),e.destination=null},e.progressCB,e.loadedCB)},_Ox4MQLV6LoaderCB:function(e){this.Ox4MQLV6Loader.load(e.jsonSettings,function(t){e.destination.addChild(t),null!==e.loadedProductCB&&e.loadedProductCB(t),null!==e.renderCB&&e.renderCB({needReframe:!1}),e.destination=null},e.progressCB,e.loadedCB,e.errorCB,{edgeTransparency:e.edgeTransparency})},_OxMQLV5LoaderCB:function(e){this.OxMQLV5Loader.load(e.jsonSettings,function(t){e.destination.addChild(t),null!==e.loadedProductCB&&e.loadedProductCB(t),null!==e.renderCB&&e.renderCB({needReframe:!1})},e.progressCB,e.loadedCB,e.errorCB,{edgeTransparency:e.edgeTransparency})},_cgrLoaderCB:function(e){var t={isBuffer:e.isBuffer,destination:e.destination,isMultipartMode:e.cgrMultipartMode,isExpandMode:e.cgrExpandMode,isCGRNewInfra:e.cgrNewInfra,readDeco:e.readDecoration,optimizeCurvedPipes:e.optimizeCurvedPipes,primWithBS:e.primitiveWithBS,repWithBS:e.repWithBS,smartStaticBatching:e.smartStaticBatching,sceneGraphOrderMode:e.sceneGraphOrderMode,withSAG:e.cgrWithSAG,withSAG:e.cgrWithSAG,useDefaultTCSet:e.useDefaultTCSet,withBagUUID:e.cgrWithBagUUID,sagInfo:e.accuracyInfo,edgeTransparency:e.edgeTransparency,sharedBuffers:e.sharedBuffers,noMeshInRAM:e.noMeshInRAM,withSceneGraph:e.cgrWithSG,cgrWithBlanking:e.cgrWithBlanking,applicativeContainers:e.applicativeContainers,processText:e.processText,accelStruct:e.accelStruct},i={readyCallback:function(t){null!==e.loadedProductCB&&e.loadedProductCB(t)},doneCallback:e.loadedCB,errorCallback:e.errorCB,progressCallback:e.progressCB};this.cgrLoader.load(e.jsonSettings,i,t),e.destination=null},_streamVisuLoaderCB:function(e){this.streamVisuLoader.load(e.modelName,function(t){null!==e.loadedProductCB&&e.loadedProductCB(t)},null,e.loadedCB,e.destination)},_threeDXLoaderCB:function(e){this.threeDXLoader.setMode("3dxc"===e.fileType?"concat":"zipped"),this.threeDXLoader.setSharedBuffers(e.sharedBuffers),this.threeDXLoader.setNoMeshInRAM(e.noMeshInRAM);var t=!0,i=!1,r=!1,n=this.accelStruct,a=e.jsonSettings&&e.jsonSettings.loaderSettings;a&&(t=a.primitives,i=a.reps,r=a.ssb,n=a.accelerationStructure),this.threeDXLoader.load({url:e.modelName,primitives:t,reps:i,ssb:r,accelStruct:n,lightMapAsIrradiance:a&&a.lightMapAsIrradiance,destinationNode:e.destination,readyCallback:function(t){null!==e.loadedProductCB&&e.loadedProductCB(t)},doneCallback:e.loadedCB,errorCallback:e.errorCB,gasSharing:!(!a||!a.gasSharing)})},_buildFileInfos:function(e){var t=this.buildPath(e);return this.modelName=t.serverurl?t.serverurl:"",this.modelName+=t.filename?t.filename:"",this.setFileTypeFromSpec(t),t},loadModelFromBuffer:function(e,t,i){return this.loadModel(e,t,!0,i)},loadModel:function(e,r,n,a){if(window.webVisuPerfo.startPerfo("load",-1),t.loadingModels=!0,void 0!==this.LDH&&void 0!==e.localAABox)return this.LDH.Helpers._onLoadModel(this,e,r,n);var s=this,o=null,l=void 0!==r?r:s.targetNode;if(null===l)return!1;(n=void 0!==n&&n)||(o=this._buildFileInfos(e)),this._internalTarget=l;var h={modelName:this.modelName,fileType:this.fileType,jsonSettings:o,destination:l,isBuffer:n,geometryMode:this.geometryMode,renderCB:this.renderCB,loadedProductCB:this.onLoadedPrdCB,progressCB:this.onProgressCB,loadedCB:this.onLoadedCB,errorCB:this.onErrorCB,filterNavReps:this.filterNavReps,refreshTime:this.refreshTime,readDecoration:this.readDecoration,cgrNewInfra:this.getCGRNewInfra(),optimizeCurvedPipes:this.forceGPUCurvedPipes,primitiveWithBS:this.getPrimitivesWithBoundingSphere(),repWithBS:this.getRepsWithBoundingSphere(),edgeTransparency:this.getEdgeTransparency(),cgrWithSG:this.getCGRWithSG(),withBlanking:this.getCGRWithBlanking(),useDefaultTCSet:this.useDefaultTCSet,sharedBuffers:this.getSharedBuffers(),noMeshInRAM:this.getNoMeshInRAM(),smartStaticBatching:this.smartStaticBatching,sceneGraphOrderMode:this.getSceneGraphOrderMode(),cgrWithSAG:this.withSAG,cgrWithBagUUID:this.withBagUUID,accuracyInfo:this.accuracyInfo,uvrWorker:this.useUvrWorker,cgrMultipartMode:this.getMultipartMode(),cgrExpandMode:this.getExpandMode(),waitMaterial:this.waitMaterial,processText:this.processText,accelStruct:this.accelStruct};if("xmlv43"===this.fileType){if(n)return!1;if(a&&a.applicativeContainers&&(h.applicativeContainers=a.applicativeContainers),this.xmlv43Loader)this._xmlv43LoaderCB(h);else if(this.poolOfModels.xmlv43.models.push(h),!this.poolOfModels.xmlv43.loading){this.poolOfModels.xmlv43.loading=!0;var c=["DS/VisuLoaders/XMLV43Loader"];require(c,function(e){s.poolOfModels.xmlv43.loading=!1,s.xmlv43Loader=new e(s.glContext,s.renderCB);for(var t=s.poolOfModels.xmlv43.models,i=0;i<t.length;i++)s._xmlv43LoaderCB(t[i]);s.poolOfModels.xmlv43.models=[]},this._onModuleError(h.errorCB,h.modelName))}}else if("xmlv6"===this.fileType){if(n)return!1;this.xmlv6Loader?this._xmlv6LoaderCB(h):(this.poolOfModels.xmlv6.models.push(h),this.poolOfModels.xmlv6.loading||(this.poolOfModels.xmlv6.loading=!0,require(["DS/VisuLoaders/XMLV6Loader","DS/VisuLoaders/XMLV6SmartLoaderPassPlugin"],function(e,t){s.poolOfModels.xmlv6.loading=!1,s.xmlv6Loader=new e(s.glContext,s.renderCB,s.debugBBox,s.geometryMode),s.smartLoading&&null===s.xmlv6SmartLoader?(s.xmlv6SmartLoader=new t(s.xmlv6Loader),s.xmlv6SmartLoader.enabled=!0,s.xmlv6SmartLoader.renderTarget=null,s.renderer.addPrePlugin(s.xmlv6SmartLoader)):s.smartLoading||null===s.xmlv6SmartLoader?null!==s.xmlv6SmartLoader&&(s.xmlv6SmartLoader.enabled=!0):s.xmlv6SmartLoader.enabled=!1;for(var i=s.poolOfModels.xmlv6.models,r=0;r<i.length;r++)s._xmlv6LoaderCB(i[r]);s.poolOfModels.xmlv6.models=[]},this._onModuleError(h.errorCB,h.modelName))))}else if("Ox4MQLV6"==this.fileType)this.Ox4MQLV6Loader?(i.setProxyFromSpec(h.jsonSettings,this._Ox4ProxyAbstraction),this._Ox4MQLV6LoaderCB(h)):(this.poolOfModels.Ox4MQLV6.models.push(h),this.poolOfModels.Ox4MQLV6.loading||(this.poolOfModels.Ox4MQLV6.loading=!0,require(["DS/VisuDataAccess/Ox4MQLV6Loader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(e,t){s.poolOfModels.Ox4MQLV6.loading=!1,s._Ox4ProxyAbstraction=t,s.Ox4MQLV6Loader=new e(s.glContext,s.renderCB,s.debugBBox,s.geometryMode);for(var r=s.poolOfModels.Ox4MQLV6.models,n=0;n<r.length;n++)i.setProxyFromSpec(r[n].jsonSettings,t),s._Ox4MQLV6LoaderCB(r[n]);s.poolOfModels.Ox4MQLV6.models=[]},this._onModuleError(h.errorCB,h.modelName))));else if("svg"==this.fileType)require(["DS/SVGLoader/SVGLoader"],function(e){new e({renderCB:s.renderCB,onProgressCB:s.onProgressCB,onLoadedCB:s.onLoadedCB,onErrorCB:s.onErrorCB}).load(o,l)});else if("OxMQLV5"==this.fileType){if(this.OxMQLV5Loader)i.setProxyFromSpec(h.jsonSettings,s._Ox4ProxyAbstraction),this._OxMQLV5LoaderCB(h);else if(this.poolOfModels.OxMQLV5.models.push(h),!this.poolOfModels.OxMQLV5.loading){this.poolOfModels.OxMQLV5.loading=!0;c=["DS/EV53DPlay/OxMQLV5Loader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"];require(c,function(e,t){s.poolOfModels.OxMQLV5.loading=!1,s._Ox4ProxyAbstraction=t,s.OxMQLV5Loader=new e(s.glContext,s.renderCB);for(var r=s.poolOfModels.OxMQLV5.models,n=0;n<r.length;n++)i.setProxyFromSpec(r[n].jsonSettings,t),s._OxMQLV5LoaderCB(r[n]);s.poolOfModels.OxMQLV5.models=[]},this._onModuleError(h.errorCB,h.modelName))}}else if("cgr"===this.fileType||"uvr"===this.fileType)a&&a.applicativeContainers&&(h.applicativeContainers=a.applicativeContainers),this.cgrLoader?(n&&(h.jsonSettings=e),this._cgrLoaderCB(h)):(n&&(h.jsonSettings=e),this.poolOfModels.cgr.models.push(h),this.poolOfModels.cgr.loading||(this.poolOfModels.cgr.loading=!0,require(["DS/VisuLoaders/CGRReader"],function(e){s.poolOfModels.cgr.loading=!1,s.cgrLoader=new e(s.glContext,s.renderCB,{keepLoader:s.getKeepLoaderMode()});for(var t=s.poolOfModels.cgr.models,i=0;i<t.length;i++)s._cgrLoaderCB(t[i]);s.poolOfModels.cgr.models=[]},this._onModuleError(h.errorCB,h.modelName))));else if("dae"===this.fileType){if(n)return!1;require(["DS/VisuLoaders/DAEReader"],function(e){null===s.colladaLoader&&(s.colladaLoader=new e(s.glContext,s.renderCB)),s.waitMaterial&&s.colladaLoader.setWaitMaterial(s.waitMaterial),s.colladaLoader.loadFromSpec(o,function(e){l.addChild(e),null!==s.onLoadedPrdCB&&s.onLoadedPrdCB(e),null!==s.renderCB&&s.renderCB({needReframe:!1}),l=null},null,s.onLoadedCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),s.onErrorCB&&s.onErrorCB({url:s.modelName,type:"FORMAT"})})}else if("json"===this.fileType){if(n)return!1;require(["DS/VisuLoaders/JSONReader"],function(e){null===s.jsonLoader&&(s.jsonLoader=new e(s.glContext,s.renderCB)),s.jsonLoader.load(s.modelName,function(e){l.addChild(e),null!==s.onLoadedPrdCB&&s.onLoadedPrdCB(e),null!==s.renderCB&&s.renderCB({needReframe:!1}),l=null},null,s.onLoadedCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),s.onErrorCB&&s.onErrorCB({url:s.modelName,type:"FORMAT"})})}else if("obj"===this.fileType){if(n)return!1;require(["DS/VisuLoaders/OBJReader"],function(e){null===s.objLoader&&(s.objLoader=new e(s.glContext,s.renderCB,a)),s.objLoader.load(o,function(e){l.addChild(e),null!==s.onLoadedPrdCB&&s.onLoadedPrdCB(e),null!==s.renderCB&&s.renderCB({needReframe:!1}),l=null},null,s.onLoadedCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),s.onErrorCB&&s.onErrorCB({url:s.modelName,type:"FORMAT"})})}else if("streamvisu"===this.fileType){if(n)return!1;this.streamVisuLoader?this._streamVisuLoaderCB(h):(this.poolOfModels.streamvisu.models.push(h),this.poolOfModels.streamvisu.loading||(this.poolOfModels.streamvisu.loading=!0,require(["DS/VisuLoaders/StreamVisuLoader"],function(e){s.poolOfModels.streamvisu.loading=!1,s.streamVisuLoader=new e(s.renderCB);for(var t=s.poolOfModels.streamvisu.models,i=0;i<t.length;i++)s._streamVisuLoaderCB(t[i]);s.poolOfModels.streamvisu.models=[]},this._onModuleError(h.errorCB,h.modelName))))}else if("3dx"===this.fileType||"3dxc"===this.fileType||"3dxm"===this.fileType){if(n)return!1;this.threeDXLoader?this._threeDXLoaderCB(h):(this.poolOfModels["3dx"].models.push(h),this.poolOfModels["3dx"].loading||(this.poolOfModels["3dx"].loading=!0,require(["DS/VisuLoaders/ThreeDXLoader"],function(e){s.poolOfModels["3dx"].loading=!1,s.threeDXLoader=new e;for(var t=s.poolOfModels["3dx"].models,i=0;i<t.length;i++)s._threeDXLoaderCB(t[i]);s.poolOfModels["3dx"].models=[]},this._onModuleError(h.errorCB,h.modelName))))}else if("stp"===this.fileType||"step"===this.fileType||"stl"===this.fileType){c=["DS/XCADLoader/XCADModelLoaderPlug"];require(c,function(t){for(var i=[new t],r=function(e){l.addChild(e),null!==s.onLoadedPrdCB&&s.onLoadedPrdCB(e),null!==s.renderCB&&s.renderCB({needReframe:!1})},a=0;a<i.length;a++)if(i[a].isManagedType(s.fileType)){var h=null;n&&(h=e),i[a].loadModel(s.fileType,s.glContext,s.renderCB,s.modelName,r,s.onProgressCB,s.onLoadedCB,s.onErrorCB,s.filterNavReps,s.refreshTime,l,o,h)}},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),s.onErrorCB&&s.onErrorCB({url:s.modelName,type:"FORMAT"})})}else"particles"===this.fileType?require(["DS/VisuLoaders/ParticlesLoader"],function(t){null===s.particlesLoader&&(s.particlesLoader=new t(s.sceneGraph,s.renderCB));var i=o;n&&(i=e),s.particlesLoader.load(i,function(e){l.add(e),null!==s.onLoadedPrdCB&&s.onLoadedPrdCB(e),null!==s.renderCB&&s.renderCB({needReframe:!1}),l=null},null,s.onLoadedCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),s.onErrorCB&&s.onErrorCB({url:s.modelName,type:"FORMAT"})}):require(["DS/ModelLoader_"+this.fileType.toLowerCase()+"/loader"],function(t){var i=new t,r=o;n&&(r=e),i.load(r,function(e){l.addChild(e),null!==s.onLoadedPrdCB&&s.onLoadedPrdCB(e),l=null},s.onProgressCB,s.onLoadedCB,s.onErrorCB,s.renderCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),s.onErrorCB&&s.onErrorCB({url:s.modelName,type:"FORMAT"})});return!0},addRessourceLibrary(e,t,i){this.materialManager||(this.materialManager=new s),i||this.clearRessourceLibrary();var r=this,n=this._buildFileInfos(e),a={modelName:this.modelName,fileType:this.fileType,jsonSettings:n,destination:null,isBuffer:!1,geometryMode:!1,renderCB:null,loadedProductCB:null,progressCB:null,loadedCB:function(e){for(var i=e.materials,n=0;n<i.length;n++)r.materialManager.setCGRSharedMaterial(n,i[n]);t&&t()},errorCB:this.onErrorCB};this.threeDXLoader?this._threeDXLoaderCB(a):(this.poolOfModels["3dx"].models.push(a),this.poolOfModels["3dx"].loading||(this.poolOfModels["3dx"].loading=!0,require(["DS/VisuLoaders/ThreeDXLoader"],function(e){r.poolOfModels["3dx"].loading=!1,r.threeDXLoader=new e;for(var t=r.poolOfModels["3dx"].models,i=0;i<t.length;i++)r._threeDXLoaderCB(t[i]);r.poolOfModels["3dx"].models=[]},this._onModuleError(a.errorCB,a.modelName))))},clearRessourceLibrary(){this.materialManager||(this.materialManager=new s),this.materialManager.CGRSharedMaterials.clear()},getLoader:function(e,t){var i=this;switch(e){case"3dx":require(["DS/VisuLoaders/ThreeDXLoader"],function(e){null===i.threeDXLoader&&(i.threeDXLoader=new e),t&&t(i.threeDXLoader)})}return this.threeDXLoader},setLineTypes:function(e){this.materialManager||(this.materialManager=new s),this.materialManager.setLineTypes(e)},clearLineTypes:function(){this.materialManager&&this.materialManager.clearLineTypes()},buildPath:function(e){if("string"==typeof e){var t="",r="";if("blob:"===e.substring(0,5))return{provider:"FILE",serverurl:"",filename:e,requiredAuth:null,proxyurl:"none"};if("http://"===e.substring(0,7))t=e;else if("https://"===e.substring(0,8))t=e;else if("/"===e.substring(0,1))t=e;else if("ms-appx://"===e.substring(0,10))t=e;else if("file://"===e.substring(0,7))t=e;else{var n=location.href,a=n.indexOf("?");-1!==a&&(n=n.substring(0,a));var s=n.lastIndexOf("/");-1!==s&&(n=n.substring(0,s+1)),t=n+e}r=(t=i.parseUrl(t)).protocol,""!==t.protocol&&(r+="://"),r+=t.authority+t.path.substring(0,t.path.lastIndexOf("/"))+"/";var o=t.path.substring(t.path.lastIndexOf("/")+1,t.path.length);return""!==t.query&&(o=o+"?"+t.query),e={provider:"FILE",serverurl:r,filename:o,requiredAuth:null,proxyurl:"none"}}return"EV6"===e.provider&&(t=i.parseUrl(e.serverurl),e.serverdefinition={},e.serverdefinition.protocol=t.protocol,e.serverdefinition.hostname=""!==t.user?t.user+"@"+t.domain:t.domain,e.serverdefinition.port=t.port,e.serverdefinition.rooturi=t.path,"/"===e.serverdefinition.rooturi.slice(0,1)&&(e.serverdefinition.rooturi=e.serverdefinition.rooturi.slice(1,e.serverdefinition.rooturi.length))),e},setFileTypeFromSpec:function(e){var t="";if("string"==typeof e)t=i.getExtension(e);else if(e.provider&&"FILE"!==e.provider)"EV6"===e.provider?this.fileType="Ox4MQLV6":"EV5"===e.provider?this.fileType="OxMQLV5":this.fileType=e.provider;else if(e.format&&""!==e.format)t=e.format;else{var r=e.serverurl?e.serverurl:"";r+=e.filename?e.filename:"",t=i.getExtension(r)}""!==t&&(t.toLowerCase&&(t=t.toLowerCase()),this.fileType="3dxml"===t?"xmlv43":t)},reloadUVR:function(e,t,r,n){var a=this;require(["DS/VisuUnstreamers/UnstreamTaskDriver","DS/VisuUnstreamers/FileInZipStreamObject","DS/Visualization/ProxyAbstraction"],function(s,o,l){var h=a.buildPath(e),c=new l;i.setProxyFromSpec(h,c);var d=h.serverurl?h.serverurl:"";d+=h.filename?h.filename:"";for(var u=[],p=0;p<t.length;p++)u.push(t[p].name);c.executeGetHttpRequest(d,"blob",null,function(e){for(var i=0;i<u.length;i++){var l=new o(e,u[i]);!function(e){s.getTask("CGR",l,t[e],function(i){var s=a.getCGROptions();n&&n.applicativeContainers&&(s.applicativeContainers=n.applicativeContainers),s.unlinkToSG=!0,s.destination=[];for(var o=0;o<t[e].parents.length;o++)s.destination.push(t[e].parents[o]);i.run(function(i){var r=i.nodes;if(t&&t[e]&&t[e].parents)for(var n=t[e].parents.length,a=0;a<n;a++){var s=t[e].parents[a];s.removeChildren();for(var o=0;o<r.length;o++)s.addChild(r[o])}},r?r.onLoadedCB:null,r?r.onErrorCB:null,s)})}(i)}},a.onErrorCB)})},setWaitMaterial:function(e){this.waitMaterial=e.clone()},abort:function(){null!==this.cgrLoader&&this.cgrLoader.abort(),null!==this.xmlv43Loader&&this.xmlv43Loader.abort()}});return UWA.namespace("THREEDS/ModelLoader",o)}),define("Visualization/ModelLoader",["DS/Visualization/ModelLoader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ModelLoader"),e}),define("DS/Visualization/Viewpoint",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Animation/ANIM","DS/Animation/PropertyAnimation","DS/Animation/AnimationPath","DS/Visualization/TrackballControls","DS/Visualization/SceneGraph","DS/Visualization/SceneGraphUtils","DS/Visualization/Node3D","DS/Visualization/WorldOrientation","DS/WAFData/WAFData"],function(e,t,i,r,n,a,s,o,l,h,c,d){"use strict";var u=new i.Projector,p=new i.Matrix4,f=e.extend({init:function(e,t,r,n,a){var s,o,l;e.hasOwnProperty("viewer")?(this.viewer=e.viewer,this.projectionType=void 0!==e.projectionType?e.projectionType:f.PERSPECTIVE,s=void 0!==e.angle?e.angle:void 0!==e.fov?e.fov:45,e.fov&&console.warn("Deprecated. Use options.angle instead."),o=void 0!==e.near?e.near:10,l=void 0!==e.far?e.far:2500,h=void 0===e.defaultController||e.defaultController):(console.warn("Deprecated. You must use a litteral object to define your viewpoint."),this.viewer=e,s=void 0!==t?t:45,o=void 0!==r?r:10,l=void 0!==n?n:2500,this.projectionType=f.PERSPECTIVE,h=void 0===a||a),this._isMain=!1,this._worldOrientation=c.ZUpYRight,e.inactive||this.createDivCSS();var h,d=(this.viewer.canvas.offsetWidth?this.viewer._getCanvasOffsetWidth():1)/(this.viewer.canvas.offsetHeight?this.viewer._getCanvasOffsetHeight():1);return this.projectionType===f.PERSPECTIVE?this.camera=new i.PerspectiveCamera(s,d,o,l):(this.camera=new i.OrthographicCamera(0,0,0,0,o,l),this.camera.setVisualizedHeight(null,d,s)),this.camera._renderingRole=i._CameraRoles.PRINCIPAL,this._renderedCamera=this.camera,this.camera._viewpoint=this,this.robotCameraOrtho=new i.OrthographicCamera(0,0,0,0,o,l),this.camera.clone(this.robotCameraOrtho),this.robotCameraOrtho.setVisualizedHeight(null,d,s),this.robotCameraOrtho._viewpoint=this,this.robotCameraOrtho._renderingRole=i._CameraRoles.ROBOT_ORTHO,this.connectedRobotCamera=this.camera.clone(),this.connectedRobotCamera._viewpoint=this,this.connectedRobotCamera._renderingRole=i._CameraRoles.ROBOT_CONNECTED,this.target=new i.Vector3,this.position=new i.Vector3,this.sceneGraphRoot=null,this._internalSceneGraph=null,this.control=null,this._mePreferenceSetting=null,this._forcedController=null,this._2DModePreviousController=null,this._currentDefaultController="COMBINED",this._isMoving=!1,this.updateAnimation=function(e){},this._viewpointAnimation=null,this._frustum=new i.Frustum,this.setDefaultController(h),h||this.resetCameraOrientation(),this.viewer.internalSceneGraph&&this._updateRobotCamera(this.viewer.internalSceneGraph),this._customReframeCB=null,this._customCenterCameraCB=null,this._2DMode=!1,this._nativeTranslationOffset=null,this._nativeZoomType=null,this._nativeZoomRatio=null,this._nativeZoom=1,this._clip=0,this._bottomleftClip=null,this._toprightClip=null,this._anchor=0,this._XMaxTranslationBound=1e10,this._XMinTranslationBound=-1e10,this._YMaxTranslationBound=1e10,this._YMinTranslationBound=-1e10,this._depthMode=0,this._focusMode=f._FOCUS_MODE.TRANSLATION,this._SWXCoreViewManipulation=null,this._csiUID=null,this},createDivCSS:function(){this.divCameraCSSElement=UWA.createElement("div"),this.divCameraCSSElement.style.WebkitTransformStyle="preserve-3d",this.divCameraCSSElement.style.MozTransformStyle="preserve-3d",this.divCameraCSSElement.style.oTransformStyle="preserve-3d",this.divCameraCSSElement.style.transformStyle="preserve-3d",this.divCameraCSSElement.id="camera",this.viewer.divCss3DElement.appendChild(this.divCameraCSSElement),this.viewer.divCss3DElement.style.overflow="hidden",this.divCameraCSSElement.style.width=this.viewer.divCss3DElement.style.width,this.divCameraCSSElement.style.height=this.viewer.divCss3DElement.style.height},isMain:function(){return this._isMain},setCsiUID:function(e){this._csiUID=e},getCsiUID:function(){return this._csiUID},getWorldOrientation:function(){return this._worldOrientation},getCamera:function(){return this.camera},getCameraTarget:function(){return console.warn("DEPRECATED"),this.target},getCameraPosition:function(){return console.warn("DEPRECATED"),this.position},getControl:function(){return this.control},setEyePosition:function(e){var t=e.clone().add(this.getSightDirection().multiplyScalar(this.getTargetDistance()));this.control.setTarget(t),this.control.update()},getEyePosition:function(){return this.camera.position.clone()},setSightDirection:function(e){e.normalize();var t=this.camera.getLookAt();t.normalize();var r=Math.acos(e.clone().dot(t));if(r){var n=e.clone().cross(t);n.normalize();var a=(new i.Quaternion).setFromAxisAngle(n,-r);this.control.orientation.multiplyQuaternions(a,this.control.orientation.clone());var s=this.getEyePosition().add(e.clone().multiplyScalar(this.getTargetDistance()));this.control.setTarget(s)}this.control.update()},getSightDirection:function(){return this.camera.getLookAt()},setUpDirection:function(e){e.normalize();var t=this.camera.up.clone(),r=Math.acos(e.dot(t));if(r){var n=e.clone().cross(t);n.normalize();var a=(new i.Quaternion).setFromAxisAngle(n,-r);this.control.orientation.multiplyQuaternions(a,this.control.orientation.clone())}this.control.update()},getUpDirection:function(){return this.camera.up.clone()},setAngle:function(e){this.camera.fov=(360+e)%360,this.control.update()},getAngle:function(){return this.camera.fov},setTarget:function(e){var t=this.getEyePosition(),r=e.clone().sub(t).normalize(),n=Math.acos(r.dot(this.getSightDirection()));if(n){var a=r.clone().cross(this.getSightDirection()).normalize(),s=(new i.Quaternion).setFromAxisAngle(a,-n);this.getControl().orientation.multiplyQuaternions(s,this.control.orientation.clone())}this.getControl().setTarget(e),this.getControl().distanceToTarget=e.distanceTo(t),this.control.update()},getTarget:function(){return this.target.clone()},setTargetDistance:function(e){var t=this.getEyePosition().add(this.getSightDirection().multiplyScalar(e));this.control.setTarget(t),this.control.distanceToTarget=e,this.projectionType===f.ORTHOGRAPHIC&&this.camera.setVisualizedHeight(e),this.control.update()},getTargetDistance:function(){return this.getControl().distanceToTarget},setProjectionType:function(e){if((!this._2DMode||1===e)&&e!==this.projectionType){if(this.projectionType=e,!this.cameraOther){var t=this.camera.near,r=this.camera.far;e===f.PERSPECTIVE?this.cameraOther=new i.PerspectiveCamera(this.camera.fov,this.camera.aspect,t,r):this.cameraOther=new i.OrthographicCamera(0,0,0,0,t,r),this.cameraOther._renderingRole=i._CameraRoles.PRINCIPAL,this.cameraOther._viewpoint=this}this.cameraOther.position=this.camera.position,this.cameraOther.fov=this.camera.fov,this.cameraOther.aspect=this.camera.aspect,this.cameraOther.pixelCulling=this.camera.pixelCulling,this.camera.fullWidth&&this.cameraOther.setViewOffsetInternal(this.camera.fullWidth,this.camera.fullHeight,this.camera.x,this.camera.y,this.camera.width,this.camera.height);var n=this.camera;this.camera=this.cameraOther,this.connectedRobotCamera=this.camera.clone(),this.connectedRobotCamera._renderingRole=i._CameraRoles.ROBOT_CONNECTED,this.connectedRobotCamera._viewpoint=this,this.cameraOther=n,this.camera.updateMatrix(),this.camera.matrixWorld.copy(this.camera.matrix),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this.camera._hasChanged=!0,this.control.camera=this.camera,this.control.update(),this.viewer.render()}},getProjectionType:function(){return this.projectionType},_setIntraOccularDistance:function(e){},setPixelCulling:function(e,t){this.viewer&&this.viewer.setPixelCulling(e,t)},_setPixelCulling:function(e){this.camera.pixelCulling=e},_setApplicationDefaultController:function(e){if(null===this.control)return;var t=this,i=function(){};let r="3dexperience",n="catia",a="solidworks",s="COMBINED",o="CATIA",l="SWX";if(this._mePreferenceSetting=null,window.widget&&window.widget.getValue("x3dPlatformId")){var h=function(e){e&&e.toLowerCase&&((e=e.toLowerCase())==r?(t._mePreferenceSetting=s,t._2DMode||t.setDefaultController(!0,s)):e==n?(t._mePreferenceSetting=o,t._2DMode||t.setDefaultController(!0,o)):e==a&&(t._mePreferenceSetting=l,t._2DMode||t.setDefaultController(!0,l)))};if(require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(e){var t=window.widget,r=function(e){if(e&&e.repositories){var t=e.repositories[0].preferences[0].value;h(t)}};e.getServiceUrl({serviceName:"mepreferences",platformId:t.getValue("x3dPlatformId"),onComplete:function(e){if(void 0!==e){var t=e+"/api/v1/preferences";d.authenticatedRequest(t,{method:"POST",type:"json",data:JSON.stringify({repositories:[{name:"VisualizationRepository",preferenceNames:["SWNavigationMode"]}]}),headers:{"Content-Type":"application/json"},onComplete:r,onFailure:i})}},onFailure:i})}),!e){require(["DS/PlatformAPI/PlatformAPI"],function(e){e.subscribe("com.ds.mep:onPrefUpdate",function(e,t){if(e){let t=e[2].tenantId,i=JSON.parse(e[1].preferences).repositories;if(t&&t!=window.widget.getValue("x3dPlatformId"))return;let r=null,n=null;if(i){for(let e=0;e<i.length;e++)if("VisualizationRepository"==i[e].name){i[e].preferences.length&&(r=i[e].preferences);break}if(r)for(let e=0;e<r.length;e++)if("SWNavigationMode"==r[e].name){n=r[e].value;break}h(n)}}})})}}},getDefaultController:function(){return this.control?this._currentDefaultController:null},setDefaultController:function(e,t,i){if(!this._forcedController||t==this._forcedController){var r={SIMPLE:s.Mode.SIMPLE,CATIA:s.Mode.CATIA,COMBINED:s.Mode.COMBINED,LOOKAROUND:s.Mode.LOOKAROUND};if(e||null!==this.control)if("FLY_WALK"===t&&this.control)this.control.setForceFlyWalkState(!e);else{if(e){let e=null;var n=!1;if(null==this.control&&(this.control=new s(this,this.viewer.canvas),e="COMBINED",n=!0),!this._2DMode&&("SWX"==t||localStorage.getItem("forceSWXControls")&&"true"===localStorage.getItem("forceSWXControls"))){if(null==this._SWXCoreViewManipulation){var a=this;require(["DS/SWXCoreManipulation/SWXCoreViewManipulation"],function(e){let t={viewer:a.viewer};a._SWXCoreViewManipulation=new e,a._SWXCoreViewManipulation.setup(t),a._SWXCoreViewManipulation.enable(),a._SWXCoreViewManipulation.enableViewerCallbacks=!0,i&&i()})}else this._SWXCoreViewManipulation.enable(),i&&i();e="SWX"}else void 0!==t&&(null!=r[t]&&(e=t),this._SWXCoreViewManipulation&&this._SWXCoreViewManipulation.disable(),this.control.setMode(r[t]));if(null!=e&&(this._currentDefaultController=e),!n)return;this.control.rotateSpeed=1,this.control.lockZRotationSpeed=.002,this.control.zoomSpeed=5,this.control.panSpeed=1.1}else null!==this.control&&this.control.detachEvents(),this.control=null;this.resetCameraOrientation()}}},setControlActive:function(e){null!==this.control&&this.control.setActive(e)},addDivToManipulation:function(e){return!!this.control&&this.control.addViewToManipulation(e)},removeDivToManipulation:function(e){return!!this.control&&this.control.removeViewFromManipulation(e)},onReframe:function(e){this._customReframeCB=e},onCenterCamera:function(e){this._customCenterCameraCB=e},_setFocusMode:function(e){this._focusMode=e},__rotatedFocusMoveTo:function(e){e.sight=e.sightDirection,e.position=e.eyePosition;var s,o,l,h;if(l=e.distanceToTarget,e.orientation)h=e.orientation,(m=new i.Vector3(0,0,-1)).applyQuaternion(h),m.normalize(),s=m;else if(e.sight){s=e.sight.clone().normalize();var c=this.camera.getLookAt().clone().normalize(),d=Math.acos(s.dot(c));if(d){var u=s.clone().cross(c).normalize(),p=(new i.Quaternion).setFromAxisAngle(u,-d);h=(new i.Quaternion).multiplyQuaternions(p,this.control.orientation.clone())}else h=this.control.orientation.clone(),s=c}var f={position:o=e.position,target:v=(new i.Vector3).addVectors(o,s.clone().multiplyScalar(l)),distanceToTarget:l,orientation:h,duration:e.duration||0};this._viewpointAnimation&&this._viewpointAnimation.stop();var g={eventChannel:"/VISU/",eventType:"@onViewpointBeginMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};if(0===f.duration){var m;t.publish({event:"/VISU/",data:g}),(m=new i.Vector3(0,0,-1)).applyQuaternion(f.orientation),m.normalize();var v=(new i.Vector3).addVectors(this.control.position,m.multiplyScalar(f.distanceToTarget));this.control.setTarget(v),this.control.orientation=f.orientation.clone(),this.control.distanceToTarget=f.distanceToTarget,this.control.update();var y={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};t.publish({event:"/VISU/",data:y})}else{var S=new a({orientation:this.control.orientation.clone(),distanceToTarget:this.control.distanceToTarget},{orientation:f.orientation,distanceToTarget:f.distanceToTarget},f.duration);S.setInterpolator(function(e,t,r){var n={},a=new i.Quaternion;return i.Quaternion.slerp(t.orientation,r.orientation,a,e),n.orientation=a,n.distanceToTarget=t.distanceToTarget+(r.distanceToTarget-t.distanceToTarget)*e,n}),this.updateAnimation=function(e){if(this.control){var t=new i.Vector3(0,0,-1);t.applyQuaternion(e.orientation),t.normalize();var r=(new i.Vector3).addVectors(this.control.position,t.multiplyScalar(e.distanceToTarget));this.control.setTarget(r),this.control.orientation=e.orientation.clone(),this.control.distanceToTarget=e.distanceToTarget,this.control.update()}};var _=this;this._viewpointAnimation=new n(this,"updateAnimation",S,function(e){if(e===r.State.STOPPED){var i={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:_,cameraEye:_.camera.position,cameraUp:_.camera.up};t.publish({event:"/VISU/",data:i})}}),this._viewpointAnimation.start(),t.publish({event:"/VISU/",data:g})}},NativeZoomTypes:{MillimeterScreenBased:"MillimeterScreenBased",HalfWindowHeightBased:"HalfWindowHeightBased",HalfWindowWidthAndHeightBased:"HalfWindowWidthAndHeightBased"},setNative2DZoomType:function(e,t){this._nativeZoomType=e,this._nativeZoomRatio=t},setNative2DClip:function(e,t,r){this._clip=e,this._bottomleftClip=new i.Vector2(t[0],t[1]),this._toprightClip=new i.Vector2(r[0],r[1])},setNative2DTranslationBounds:function(e,t){this._XMaxTranslationBound=e[1],this._XMinTranslationBound=e[0],this._YMaxTranslationBound=t[1],this._YMinTranslationBound=t[0]},setNative2DAnchor:function(e){this._anchor=e},setNative2DDepthMode:function(e){this._depthMode=e},isNative2D:function(){return null!=this._nativeZoomType},getScaleFactor:function(){if(this.isNative2D()){let e=1/this.getMMInSupportUnit(),t=1;switch(this._nativeZoomType){case this.NativeZoomTypes.MillimeterScreenBased:t=e/this._nativeZoom;break;case this.NativeZoomTypes.HalfWindowHeightBased:case this.NativeZoomTypes.HalfWindowWidthAndHeightBased:t=2/(this._nativeZoom*this.viewer.SCREEN_HEIGHT)}return t}return 1},getPixelFromModelRatio:function(){return this.isNative2D()?this.getScaleFactor():1},_native2DModelFromPixel:function(e,t,i,r,n,a){let s,o,l=1*a,h=1/n,c=this._nativeZoom*this._nativeZoomRatio/l,d=this._nativeZoom;if(this._clip<=1){switch(3&this._anchor){case 0:s=i/2;break;case 1:s=0;break;case 2:s=i}switch(12&this._anchor){case 0:o=r/2;break;case 4:o=0;break;case 8:o=r}}else{switch(3&this._anchor){case 0:s=.5*(this._bottomleftClip.x+this._toprightClip.x);break;case 1:s=this._bottomleftClip.x;break;case 2:s=this._toprightClip.x}switch(12&this._anchor){case 0:o=.5*(this._bottomleftClip.y+this._toprightClip.y);break;case 4:o=this._toprightClip.y;break;case 8:o=this._bottomleftClip.y}}let u=0,p=0;switch(this._nativeZoomType){case this.NativeZoomTypes.MillimeterScreenBased:u=this.camera.position.x+h/c*(e-s),p=this.camera.position.y+h/d*(o-t);break;case this.NativeZoomTypes.HalfWindowHeightBased:u=this.camera.position.x+1/c*(e-s)/(r/2),p=this.camera.position.y+1/d*(o-t)/(r/2);break;case this.NativeZoomTypes.HalfWindowWidthAndHeightBased:u=this.camera.position.x+1/c*(e-s)/(i/2),p=this.camera.position.y+1/d*(o-t)/(r/2)}return[u,p]},_native2DViewportBounds:function(e,t,i,r){let[n,a]=this._native2DModelFromPixel(0,0,e,t,i,r),[s,o]=this._native2DModelFromPixel(e,t,e,t,i,r),l=this.getEyePosition();if(s-n>this._XMaxTranslationBound-this._XMinTranslationBound){let e=l.x;switch(3&_Anchor){case 0:l.x=(this._XMinTranslationBound+this._XMaxTranslationBound)/2;break;case 1:l.x=this._XMinTranslationBound;break;case 2:l.x=this._XMaxTranslationBound}n+=l.x-e,s+=l.x-e}else this._XMinTranslationBound>n?(l.x+=this._XMinTranslationBound-n,s+=this._XMinTranslationBound-n,n+=this._XMinTranslationBound-n):this._XMaxTranslationBound<s&&(l.x+=this._XMaxTranslationBound-s,n+=this._XMaxTranslationBound-s,s+=this._XMaxTranslationBound-s);if(a-o>this._YMaxTranslationBound-this._YMinTranslationBound){let e=l.y;switch(12&_Anchor){case 0:l.y=(this._YMinTranslationBound+this._YMaxTranslationBound)/2;break;case 4:l.y=this._YMaxTranslationBound;break;case 8:l.y=this._YMinTranslationBound}o+=l.y-e,a+=l.y-e}else this._YMinTranslationBound>o?(l.y+=this._YMinTranslationBound-o,a+=this._YMinTranslationBound-o,o+=this._YMinTranslationBound-o):this._YMaxTranslationBound<a&&(l.y+=this._YMaxTranslationBound-a,o+=this._YMaxTranslationBound-a,a+=this._YMaxTranslationBound-a);return n-=l.x,s-=l.x,o-=l.y,[n,s,a-=l.y,o,l]},getMMInSupportUnit:function(){return i.getPixelsPerMM()},updateNative2D(){let e=this.getMMInSupportUnit(),[t,i,r,n,a]=this._native2DViewportBounds(this.viewer.SCREEN_WIDTH,this.viewer.SCREEN_HEIGHT,e,1);return this.camera.setViewportInfos(r,n,t,i),a},moveTo:function(e){var s,o,l,h,c,d;if(e.up||e.sight||e.position?console.log("DEPRECATED Naming: options.up => options.upDirection, options.sight => options.sightDirection, options.position => options.eyePosition."):(e.up=e.upDirection,e.sight=e.sightDirection,e.position=e.eyePosition),h=e.distanceToTarget||this.control.distanceToTarget,e.orientation)d=e.orientation,(v=new i.Vector3(0,1,0)).applyQuaternion(d),v.normalize(),s=v,(y=new i.Vector3(0,0,-1)).applyQuaternion(d),y.normalize(),o=y;else if(e.up&&e.sight)s=e.up.clone().normalize(),o=e.sight.clone().normalize();else if(e.up){s=e.up.clone().normalize();var u=this.camera.up.clone().normalize();if(g=Math.acos(s.dot(u))){var p=s.clone().cross(u).normalize(),f=(new i.Quaternion).setFromAxisAngle(p,-g);o=this.camera.getLookAt().clone().applyQuaternion(f).normalize(),d=(new i.Quaternion).multiplyQuaternions(f,this.control.orientation.clone())}else d=this.control.orientation.clone(),s=u,o=this.camera.getLookAt().clone().normalize()}else if(e.sight){o=e.sight.clone().normalize();var g,m=this.camera.getLookAt().clone().normalize();if(g=Math.acos(o.dot(m))){p=o.clone().cross(m).normalize(),f=(new i.Quaternion).setFromAxisAngle(p,-g);s=this.camera.up.clone().applyQuaternion(f).normalize(),d=(new i.Quaternion).multiplyQuaternions(f,this.control.orientation.clone())}else d=this.control.orientation.clone(),o=m,s=this.camera.up.clone().normalize()}else{var v,y;d=this.control.orientation.clone(),(v=new i.Vector3(0,1,0)).applyQuaternion(this.control.orientation),v.normalize(),s=v,(y=new i.Vector3(0,0,-1)).applyQuaternion(this.control.orientation),y.normalize(),o=y}if(e.position?(l=e.position,c=(new i.Vector3).addVectors(l,o.clone().multiplyScalar(h))):(l=(new i.Vector3).subVectors(this.control.target,o.clone().multiplyScalar(h)),c=this.control.target.clone()),!d){d=new i.Quaternion;var S=new i.Matrix4;S.lookAt(l,c,s),d.setFromRotationMatrix(S)}if(e.ratioOffset||e.ratioSize){h/=Math.max(.01,Math.min(e.ratioSize.x,e.ratioSize.y));var _=Math.tan(i.Math.degToRad(.5*this.camera.fov))*h,x=_*this.camera.aspect,b=new i.Vector2(x,_);b.x*=-(1-Math.max(.01,e.ratioSize.x)),b.y*=-(1-Math.max(.01,e.ratioSize.y));var w=new i.Vector2(2*x,2*_);w.x*=e.ratioOffset.x,w.y*=e.ratioOffset.y,w.add(b);var M=(new i.Vector3).crossVectors(s,o);c.add(s.multiplyScalar(w.y)),c.add(M.multiplyScalar(w.x)),e.interpolationType&&(l=(new i.Vector3).subVectors(c,o.clone().multiplyScalar(h)))}var C={position:l,target:c,distanceToTarget:h,orientation:d,duration:e.duration||0};this._viewpointAnimation&&this._viewpointAnimation.stop();var P={eventChannel:"/VISU/",eventType:"@onViewpointBeginMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};if(0===C.duration){t.publish({event:"/VISU/",data:P}),this.control.setTarget(C.target),this.control.orientation=C.orientation,this.control.distanceToTarget=C.distanceToTarget,this.control.update();var E={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};t.publish({event:"/VISU/",data:E}),e.onEndCB&&e.onEndCB(this)}else{var A=new a({position:this.control.position.clone(),target:this.control.target.clone(),orientation:this.control.orientation.clone(),distanceToTarget:this.control.distanceToTarget},{position:C.position,target:C.target,orientation:C.orientation,distanceToTarget:C.distanceToTarget},C.duration);A.setInterpolator(function(e,t,r){var n={},a=t.position.clone();a.lerp(r.position,e),n.position=a;var s=t.target.clone();s.lerp(r.target,e),n.target=s;var o=new i.Quaternion;return i.Quaternion.slerp(t.orientation,r.orientation,o,e),n.orientation=o,n.distanceToTarget=t.distanceToTarget+(r.distanceToTarget-t.distanceToTarget)*e,n}),e.interpolationType?this.updateAnimation=function(t){if(this.control){this.control.position=t.position.clone();var r=new i.Vector3(0,0,-1);r.applyQuaternion(t.orientation),r.normalize();var n=(new i.Vector3).addVectors(t.position,r.multiplyScalar(t.distanceToTarget));this.control.setTarget(n),this.control.orientation=t.orientation.clone(),this.control.distanceToTarget=t.distanceToTarget,this.control.update(),e.onUpdateCB&&e.onUpdateCB(T)}}:this.updateAnimation=function(t){this.control&&(this.control.setTarget(t.target),this.control.orientation=t.orientation.clone(),this.control.distanceToTarget=t.distanceToTarget,this.control.update(),e.onUpdateCB&&e.onUpdateCB(T))};var T=this;this._viewpointAnimation=new n(this,"updateAnimation",A,function(i){if(i===r.State.STOPPED){var n={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:T,cameraEye:T.camera.position,cameraUp:T.camera.up};t.publish({event:"/VISU/",data:n}),e.onEndCB&&e.onEndCB(T)}}),this._viewpointAnimation.start(),t.publish({event:"/VISU/",data:P})}},onMove:function(e){if(this.control)return this.control.onMove(e)},unsubscribe:function(e){this.control&&this.control.unsubscribe(e)},isMoving:function(){return this._isMoving},_isAnimated:function(){var e=!!this._viewpointAnimation&&this._viewpointAnimation.state()===r.State.RUNNING;return e=e||this.control&&this.control._wheelMoving},resize:function(e,t){this.robotCameraOrtho&&this.camera&&this.robotCameraOrtho.setVisualizedHeight(null,void 0,this.camera.fov),null!==this.control&&this.control._resize(e,t)},setSceneGraph:function(e){h.DEPRECATED_SceneGraph(new Error),e instanceof o&&(this.sceneGraph=e)},_setInternalSceneGraph(e){this._setNode(e.root),e.scene.add(this.getCamera()),this._internalSceneGraph=e},_setNode:function(e){this.sceneGraphRoot=e},_lockController:function(e){this._forcedController=e?this._currentDefaultController:null},_set2DMode:function(e,t){var r=this._2DMode!=e;if(this._2DMode=e,e){if(this.setSightDirection(new i.Vector3(0,0,-1)),this.setUpDirection(new i.Vector3(0,1,0)),this.setProjectionType(1),this.control){var n=null,a=!1;"CATIA"!=t&&"COMBINED"!=t||(n=t,this._forcedController?this._lockController(!1):this._2DModePreviousController=this._currentDefaultController,a=!0),"SWX"!=this._currentDefaultController||n||(n="COMBINED"),n&&this.setDefaultController(!0,n),this._lockController(a),this.control._2DMode=!0,this.control.setMouseRotationActive(!1),this.control.setTouchRotationActive(!1)}}else this._lockController(!1),r&&(this._mePreferenceSetting||this._2DModePreviousController)&&this.setDefaultController(!0,this._mePreferenceSetting||this._2DModePreviousController),this._2DModePreviousController=null,this.control._2DMode=!1,this.control.setMouseRotationActive(!0),this.control.setTouchRotationActive(!0)},resetCameraOrientation:function(){var e,t,r;if(!this._2DMode)if(t=new i.Quaternion,this._worldOrientation===c.ZUpYRight?(e=new i.Vector3(.35*Math.PI,0,.75*Math.PI),t.setFromEuler(e,this._worldOrientation._eulerOrderForReframe)):t.set(-.21567539362612123,.37210985866635193,.08933567311009524,.8983526674850427),r=1.1*100/Math.tan(22.5*Math.PI/180),null!==this.sceneGraphRoot&&(r=1.1*this.getBoundingSphere().radius/Math.tan(22.5*Math.PI/180)),this.camera.position=new i.Vector3(r,r,r).multiplyScalar(1/Math.sqrt(3)),null===this.control)this.camera.quaternion=t,this.camera.useQuaternion=!0,this.camera.updateMatrix();else{this.control.orientation=t;var n=new i.Vector3(0,0,-1);n.applyQuaternion(t),n.normalize(),this.moveTo({orientation:t,eyePosition:n.clone().multiplyScalar(-r),distanceToTarget:r,duration:0})}},reframe:function(e,t,r,n,a){if(this.sceneGraphRoot&&null!==this.control){var s=null,o=null;if(n&&("string"==typeof n?s=n:(s=n.reframeSpace,a=n.radiusIfEmpty,o=n.targetBoundingBox)),!s&&this.viewer&&(s=this.viewer.visibleSpace?"visibleSpace":"invisibleSpace"),this._customReframeCB)this._customReframeCB(e,t,r,s);else{var l,h,c;if(h=void 0!==t?t:400,this._2DMode&&o){var d=new i.Box2(new i.Vector2(o.min.x,o.min.y),new i.Vector2(o.max.x,o.max.y));c=this._buildReframeTarget2DFromBBox(d)}else r||!this._2DMode?(void 0!==r&&r instanceof i.Mesh?(l=r.boundingSphere.clone()).applyMatrix4(r.matrixWorld):l=void 0!==r&&r instanceof i.Sphere&&!r.isNaN()?r.clone():this.getBoundingSphere(s,a),c=this._buildReframeTarget(l,e)):c=this._buildReframeTarget2D(s);if(c){var u=new i.Vector3(0,0,-1);u.applyQuaternion(c.orientation),u.normalize(),this.moveTo({orientation:c.orientation,eyePosition:(new i.Vector3).addVectors(c.target,u.clone().multiplyScalar(-c.distanceToTarget)),distanceToTarget:c.distanceToTarget,duration:h})}}}},reframeOn:function(e,t,r){r=r||{};var n=new i.Matrix4,a=l.getOrientedBoundingBoxFromPathElements(t,n,this.viewer,!!r.withInternalSceneGraph),s=a.localBBox,o=Math.sqrt(Math.pow(s.min.x-s.max.x,2)+Math.pow(s.min.z-s.max.z,2)+Math.pow(s.min.y-s.max.y,2))/2,h=a.cornerPoint,c=(new i.Vector3).add(h).add(a.firstAxis).add(a.secondAxis).add(a.thirdAxis),d=(new i.Vector3).add(h).add(c);d.divideScalar(2),isNaN(o)||isNaN(d.x)||isNaN(d.y)||isNaN(d.z)?this._reframeOnWarningCount<10&&(console.warn("reframeOn: no usable path for reframe"),this._reframeOnWarningCount++):this.reframe(void 0,e,new i.Sphere(d,o),r)},_reframeOnWarningCount:0,_buildReframeTarget2DFromBBox:function(e){var t,r,n,a;e.empty()&&e.set(new i.Vector2(-100,-100),new i.Vector2(100,100)),t=new i.Vector3((e.min.x+e.max.x)/2,(e.min.y+e.max.y)/2,0);var s=this.camera.aspect,o=.5/Math.tan(this.camera.fov*Math.PI/360);return n=o*(e.max.x-e.min.x)/s,a=o*(e.max.y-e.min.y),r=Math.max(n,a),{target:t,orientation:new i.Quaternion,distanceToTarget:r}},_buildReframeTarget2D:function(e){var t=this.getBoundingBox2D(e);return this._buildReframeTarget2DFromBBox(t)},_buildReframeTarget:function(e,t){var r,n,a,s,o=null;if(e||boundingBox2D){if(n=this.target.clone(),r=this.control.orientation.clone(),a=this.control.distanceToTarget,null==t||this._2DMode){var l=Math.max(this.viewer._getDivClientHeight()/this.viewer._getDivClientWidth(),1);a=1.1*e.radius*l/Math.tan(this.camera.fov*Math.PI/360),n=e.center.clone()}else s=this._worldOrientation.getAxisForSideRotation(t);if(s){var h=this._worldOrientation._eulerOrderForReframe;(r=new i.Quaternion).setFromEuler(s,h)}o={target:n,orientation:r,distanceToTarget:a}}return o},centerCamera:function(e){if(null!==this.control)if(this._customCenterCameraCB)this._customCenterCameraCB(e);else if(null!==e){var t=e.clone(),r=this.control.orientation.clone(),n=t.distanceTo(this.camera.position);if(this._focusMode===f._FOCUS_MODE.TRANSLATION){var a=new i.Vector3(0,0,-1);a.applyQuaternion(r),a.normalize();var s=this.viewer.ODTMode,o=(new i.Vector3).addVectors(t.clone(),a.clone().multiplyScalar(-n));this.moveTo({eyePosition:o,distanceToTarget:n,duration:s?0:200})}else if(this._focusMode===f._FOCUS_MODE.ROTATION){var l=(new i.Vector3).subVectors(t,this.control.position).normalize();s=this.viewer.ODTMode;if(this.control.lockZ||i.mobileVersion){var h=this.camera.getLookAt().clone().normalize(),c=null,d=Math.acos(l.dot(h));if(d){var u=l.clone().cross(h).normalize(),p=(new i.Quaternion).setFromAxisAngle(u,-d);c=(new i.Quaternion).multiplyQuaternions(p,this.control.orientation.clone())}else c=this.control.orientation.clone(),l=h;var g=c.toEuler();g.y=0,c=(new i.Quaternion).setFromEuler(g,"ZYX"),this.__rotatedFocusMoveTo({eyePosition:this.control.position,orientation:c,distanceToTarget:n,duration:s?0:200})}else this.__rotatedFocusMoveTo({eyePosition:this.control.position,sightDirection:l,distanceToTarget:n,duration:s?0:200})}}},centerCameraSVG:function(e,t){this.control.update();var r,n,a,s=e.x-t.x,o=e.y-t.y;if(0!==s||0!==o){r=(new i.Vector3).copy(this.camera.position).sub(this.target),n=(this.camera.top-this.camera.bottom)/this.viewer._getDivClientHeight(),(a=new i.Vector3).add(r.clone().cross(this.camera.up).setLength(n*s)),a.add(this.camera.up.clone().setLength(n*o));var l=this.viewer.ODTMode,h=this.camera.position.clone().add(a);this.moveTo({eyePosition:h,duration:l?0:200})}},pan:function(e){if(null!==this.control){var t,r,n=new i.Vector3;switch(e){case"left":n.x=-1;break;case"right":n.x=1;break;case"top":n.y=1;break;case"bottom":n.y=-1;break;default:n.x=1}n.applyQuaternion(this.control.orientation),n.setLength(.05*this.control.distanceToTarget),t=this.target.clone().add(n),this.control.orientation.clone(),r=this.control.distanceToTarget;var a=this.viewer.ODTMode;this.moveTo({eyePosition:(new i.Vector3).addVectors(t,this.getCamera().getLookAt().clone().normalize().multiplyScalar(-r)),duration:a?0:100})}},zoom:function(e){if(null!==this.control){var t,r,n=.9;"out"===e&&(n=1.1),t=this.target.clone(),this.control.orientation.clone(),r=this.control.distanceToTarget*n;var a=this.viewer.ODTMode;this.moveTo({eyePosition:(new i.Vector3).addVectors(t,this.getCamera().getLookAt().clone().normalize().multiplyScalar(-r)),distanceToTarget:r,duration:a?0:100})}},rotateCameraForPerfos:function(e,t,r){if(null!==this.control){var a=new function(){var r=new i.Vector3(.35*Math.PI,0,.75*Math.PI);this._orientation=(new i.Quaternion).setFromEuler(r,"ZXY"),this._key1=new i.Quaternion,this._key2=(new i.Quaternion).setFromAxisAngle(new i.Vector3(0,0,1),Math.PI/2),this._key3=(new i.Quaternion).setFromAxisAngle(new i.Vector3(0,0,1),Math.PI),this._key4=(new i.Quaternion).setFromAxisAngle(new i.Vector3(0,0,1),3*Math.PI/2),this._nbLoops=void 0!==e?e:5,this._duration=void 0!==t?t:1e4,this.duration=function(){return this._duration},this.valueAt=function(e){var t,r,n,a,s=this._duration/this._nbLoops,o=e%s/s;return o>=0&&o<.25?(t=this._key1,r=this._key2,a=o/.25):o>=.25&&o<.5?(t=this._key2,r=this._key3,a=(o-.25)/.25):o>=.5&&o<.75?(t=this._key3,r=this._key4,a=(o-.5)/.25):(t=this._key4,r=this._key1,a=(o-.75)/.25),n=new i.Quaternion,i.Quaternion.slerp(t,r,n,a),n.multiply(this._orientation)}},s=new n(this.control,"orientation",a);r&&s.setLoop(1),s.start()}},zoomCameraInAndOutForPerfos:function(e,t){if(null!==this.control){this.resetCameraOrientation(),this.reframe(void 0,0);var i=1.2*this.getTargetDistance(),r=new function(){this._duration=void 0!==e?e:3e3,this.duration=function(){return this._duration},this.valueAt=function(t){var r=t%e/e;return(r>=0&&r<.5?r/.5:1-(r-.5)/.5)*i}},a=new n(this.control,"distanceToTarget",r);t&&a.setLoop(1),a.start()}},getBoundingBox2D:function(e){if(!this._2DMode)return null;var t,r=this.viewer||this.sceneGraphRoot._getViewer();if(r.svgRoot){var n=this.viewer.svgRoot.getBBox();t=new i.Box2(new i.Vector2(n.x,-n.y-n.height),new i.Vector2(n.x+n.width,-n.y))}let a=this.internalSceneGraph?this.internalSceneGraph:r?r._safeInternalSceneGraph:null;var s=r?r.getSceneBoundingBox(e,a):this.sceneGraphRoot.getBoundingBox(e),o=new i.Box2(new i.Vector2(s.min.x,s.min.y),new i.Vector2(s.max.x,s.max.y));return t&&o.union(t),o},getBoundingSphere:function(e,t){var r=this.viewer||this.sceneGraphRoot._getViewer();let n=this.internalSceneGraph?this.internalSceneGraph:r?r._safeInternalSceneGraph:null;var a=r?r.getSceneBoundingSphere(e,!0,n):this.sceneGraphRoot.getBoundingSphere(e,!0);return a?0===a.radius&&a.pixelRadius>0?a.radius=void 0!==t?t:a.pixelRadius:0===a.radius&&(a.radius=void 0!==t?t:100):a=new i.Sphere(new i.Vector3,100),a},setViewOffset:function(e,t){var r=this.camera;!function(i,r){if(e){e.camera&&(i=e.camera);var n=e.fullWidth?e.fullWidth:r.SCREEN_WIDTH,a=e.fullHeight?e.fullHeight:r.SCREEN_HEIGHT,s=e.x?e.x:0,o=e.y?e.y:0,l=e.width?e.width:r.SCREEN_WIDTH,h=e.height?e.height:r.SCREEN_HEIGHT;i.setViewOffsetInternal(n,a,s,o,l,h,null,t)}else i.setViewOffsetInternal(0,0,0,0,r.SCREEN_WIDTH,r.SCREEN_HEIGHT,null,t)}(r,this.viewer),r.clone(this.robotCameraOrtho),this.robotCameraOrtho.setVisualizedHeight(null,void 0,r.fov),this.robotCameraOrtho._renderingRole=i._CameraRoles.ROBOT_ORHTO},project:function(e,t){var i=t||this.camera,r=e.clone();return u.projectVector(r,i),r.x=.5*this.viewer._getCanvasOffsetWidth()*(r.x+1),r.y=.5*this.viewer._getCanvasOffsetHeight()*(1-r.y),r},unProject:function(e,t){var r=t||this.camera,n=e.x/this.viewer._getCanvasOffsetWidth()*2-1,a=-e.y/this.viewer._getCanvasOffsetHeight()*2+1,s=new i.Vector3(n,a,e.z);return u.unprojectVector(s,r),s},create3DRayFrom2DPoint:function(e,t){var r=e.x/this.viewer.canvas.offsetWidth*2-1,n=-e.y/this.viewer.canvas.offsetHeight*2+1,a=new i.Vector3(r,n,-1);u.unprojectVector(a,t||this.camera);var s=new i.Vector3(r,n,1);u.unprojectVector(s,t||this.camera);var o=(new i.Vector3).copy(s).sub(a);return o.normalize(),new i.Ray(a,o)},dump:function(){var e="viewpoint.control.target = new THREE.Vector3("+this.control.target.x+", "+this.control.target.y+", "+this.control.target.z+");\nviewpoint.control.orientation = new THREE.Quaternion("+this.control.orientation.x+", "+this.control.orientation.y+", "+this.control.orientation.z+", "+this.control.orientation.w+");\nviewpoint.control.distanceToTarget = "+this.control.distanceToTarget+";";console.log(e)},setFromJSON:function(e){},_setPickingViewOffset:function(e){function t(t,i){if(e.reset)t.setViewOffsetInternal(0,0,0,0,i.SCREEN_WIDTH,i.SCREEN_HEIGHT,{},!0);else{var r=e.fullWidth?e.fullWidth:i.SCREEN_WIDTH,n=e.fullHeight?e.fullHeight:i.SCREEN_HEIGHT,a=e.x?e.x:0,s=e.y?e.y:0,o=e.width?e.width:i.SCREEN_WIDTH,l=e.height?e.height:i.SCREEN_HEIGHT;t.setViewOffsetInternal(r,n,a,s,o,l,{ratioW:e.pickingRatioW,ratioH:e.pickingRatioH},!0)}}e&&e.cameraSet&&(t(e.cameraSet.main,this.viewer),t(e.cameraSet.robotCameraOrtho,this.viewer),t(e.cameraSet.connectedRobotCamera,this.viewer))},_updateRobotCamera:function(e){function t(e,t){var r=(new i.Vector3).subVectors(e.center,t.position),n=t.getLookAt(),a=r.dot(n),s=a+e.radius,o=a-e.radius;return t.isOrtho||(o=Math.max(o,.001*s)),{near:o,far:s}}var r=this.camera;r.clone(this.robotCameraOrtho),this.robotCameraOrtho.setVisualizedHeight(null,void 0,this.camera.fov),this.robotCameraOrtho.position.set(0,0,0),this.robotCameraOrtho.updateMatrix(),this.robotCameraOrtho.updateMatrixWorld(),this.robotCameraOrtho.updateProjectionMatrix(),this.robotCameraOrtho.projectionMatrixInverse.getInverse(this.robotCameraOrtho.projectionMatrix),this.robotCameraOrtho._renderingRole=i._CameraRoles.ROBOT_ORTHO,r.clone(this.connectedRobotCamera),this.connectedRobotCamera._renderingRole=i._CameraRoles.ROBOT_CONNECTED;var n,a,s,o,l,h=e.robotRoot;if(h.getMatrixWorld(),(a=h.getBoundingSphere()).pixelRadius>0){var c=this.robotCameraOrtho.getWorldSizeFromPixelSize(1,a.center,this.viewer._getDivClientHeight());if(void 0!==this.robotCameraOrtho.fullWidth&&this.robotCameraOrtho.fullWidth>0)c*=Math.max(1*this.robotCameraOrtho.width/this.robotCameraOrtho.fullWidth,1*this.robotCameraOrtho.height/this.robotCameraOrtho.fullHeight);a.radius+=c*a.pixelRadius}if(0===a.radius&&(a.radius=10),a){o=t(a,this.robotCameraOrtho),this.robotCameraOrtho.near=o.near,this.robotCameraOrtho.far=o.far,this.robotCameraOrtho.updateProjectionMatrix(),this.robotCameraOrtho.projectionMatrixInverse.getInverse(this.robotCameraOrtho.projectionMatrix);var d=e._robot;if(d)if(!(!d.isConnected||d.isManipulatedInPlane)){if(n=d.getMatrixWorld(),(s=d.getBoundingSphere()).applyMatrix4(n),s.pixelRadius>0){c=this.connectedRobotCamera.getWorldSizeFromPixelSize(1,s.center,this.viewer._getDivClientHeight());if(void 0!==this.connectedRobotCamera.fullWidth&&this.connectedRobotCamera.fullWidth>0)c*=Math.max(1*this.connectedRobotCamera.width/this.connectedRobotCamera.fullWidth,1*this.connectedRobotCamera.height/this.connectedRobotCamera.fullHeight);s.radius+=c*s.pixelRadius}l=t(s,this.camera),this.connectedRobotCamera.near=Math.min(l.near,r.near),this.connectedRobotCamera.far=Math.max(l.far,r.far),this.connectedRobotCamera.updateProjectionMatrix(),this.connectedRobotCamera.projectionMatrixInverse.getInverse(this.connectedRobotCamera.projectionMatrix)}}},_updateFrustum:function(){var e=this.camera;p.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromMatrix(p)},_setWorldOrientation:function(e){if(e!==this._worldOrientation){var t=this._worldOrientation.upAttribute,r=this._worldOrientation.rightAttribute,n=this._worldOrientation.frontAttribute;this._worldOrientation=e;var a=this._worldOrientation.upAttribute,s=this._worldOrientation.rightAttribute,o=this._worldOrientation.frontAttribute,l=new i.Vector3,h=this.getEyePosition();l[a]=h[t],l[s]=h[r],l[o]=h[n];var c=new i.Vector3,d=this.getUpDirection();c[a]=d[t],c[s]=d[r],c[o]=d[n];var u=new i.Vector3,p=this.getSightDirection();u[a]=p[t],u[s]=p[r],u[o]=p[n],this.moveTo({eyePosition:l,upDirection:c,sightDirection:u})}},dispose:function(){this._lockController(!1),this.setDefaultController(!1),this._setNode(null)}});return f._FOCUS_MODE={TRANSLATION:0,ROTATION:1},f.PERSPECTIVE=0,f.ORTHOGRAPHIC=1,UWA.namespace("THREEDS/Viewpoint",f)}),define("Visualization/Viewpoint",["DS/Visualization/Viewpoint","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Viewpoint"),e}),define("DS/Visualization/CollisionServices",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Plugins/ComposerContext","DS/Visualization/Viewpoint","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/GraphicAttributeSet"],function(e,t,i,r,n,a,s){"use strict";var o=e.singleton({init:function(){return this.collisionDepthComposers=new Map,this.collisionNormalComposers=new Map,this._clearCurrentData(),this.useDebug=!1,this.renderNormals=!1,this.disableBackFaceCulling=!0,this.skipTransparentItems=!1,this.readPixelPerfs=0,this.readPixelCount=0,this.currentCollision=null,window.__collisionService=this,this._bufferPool=new Map,this},_getBuffer(e,t){let i=e;"float32"==t&&(i*=4),this._bufferPool.has(i)||this._bufferPool.set(i,[]);let r,n=this._bufferPool.get(i);return r=n.length?n.splice(0,1)[0]:new Uint8Array(i),"float32"==t?r=new Float32Array(r.buffer):"uint8"==t&&(r=new Uint8Array(r.buffer)),r},_releaseBuffer(e){let t=e.BYTES_PER_ELEMENT*e.length;this._bufferPool.get(t).push(e)},setViewer:function(e){this.viewer=e,this.gl=this.viewer.getWebGLContext();let t={viewer:this.viewer,defaultController:!1};return this.vp=new r(t),this.vp.camera.pixelCulling=0,t.projectionType=r.ORTHOGRAPHIC,this.vpOrtho=new r(t),this.vpOrtho.camera.pixelCulling=0,this},_clearCurrentData:function(e){if(e){let t=this.data.get(e);t?(t.camera=null,t.frustumInfos=null,t.width=null,t.height=null,t.normalData&&this._releaseBuffer(t.normalData),t.normalData=null,t.depthData&&this._releaseBuffer(t.depthData),t.depthData=null,t.positionData&&this._releaseBuffer(t.positionData),t.positionData=null,t.cameraPositionData=null,t.farthest=null,t.nearest=null,t.depthComposer=null,t.normalComposer=null,t.colliderInfos=null):(t={camera:null,frustumInfos:null,width:null,height:null,normalData:null,depthData:null,positionData:null,farthest:null,nearest:null,depthComposer:null,normalComposer:null,colliderInfos:null},this.data.set(e,t))}else this.data=new Map},setCurrentData:function(e){this.currentData=this.data.get(e)},_setDebugInfos:function(e){this.debugInfos=e},_debug:function(){let e=this.currentData.width,t=this.currentData.height,i=this,r=document.getElementById("normal"),n=null,a=null;if(r){r.width=e,r.height=t,a=(n=r.getContext("2d")).createImageData(e,t);let s=i.getNormalData();for(let r=0;r<e*t;r++){let n=s[3*r],o=s[3*r+1],l=s[3*r+2],h=i.convertIndexToXY(r),c=h[0]+(t-1-h[1])*e;a.data[4*c+0]=255*n,a.data[4*c+1]=255*o,a.data[4*c+2]=255*l,a.data[4*c+3]=255}n.putImageData(a,0,0)}if(r=document.getElementById("depth")){r.width=e,r.height=t,a=(n=r.getContext("2d")).createImageData(e,t);let s=i.getDepthData();for(let r=0;r<e*t;r++){let n=255*(s[r]+1)/2,o=n,l=n,h=n;if(r==Math.floor(e/2)*t+Math.floor(e/2)&&(l=0,h=0),this.debugInfos)for(let e=0;e<this.debugInfos.length;e++){let t=this.debugInfos[e];if(this.isDirectAsymetricCollider(r,t.up,t.down,t.left,t.right,t.near,t.far)){o*=t.color[0],l*=t.color[1],h*=t.color[2];break}if(this.isDirectAsymetricCollider(r,t.up,t.down,t.left,t.right)){o*=.5*t.color[0],l*=.5*t.color[1],h*=.5*t.color[2];break}}let c=i.convertIndexToXY(r),d=c[0]+(t-1-c[1])*e;a.data[4*d+0]=o,a.data[4*d+1]=l,a.data[4*d+2]=h,a.data[4*d+3]=255}n.putImageData(a,0,0)}if(r=document.getElementById("position")){r.width=e,r.height=t,a=(n=r.getContext("2d")).createImageData(e,t);let s=i.getPositionData();for(let r=0;r<e*t;r++){let n=s[3*r],o=s[3*r+1],l=s[3*r+2],h=i.convertIndexToXY(r),c=h[0]+(t-1-h[1])*e;a.data[4*c+0]=255*n,a.data[4*c+1]=255*o,a.data[4*c+2]=255*l,a.data[4*c+3]=255}n.putImageData(a,0,0)}},_dlDepthTexture:function(e){let t=this.currentData.width,i=this.currentData.height,r=this;var n=document.createElement("canvas");n.width=t,n.height=i;let a=n.getContext("2d"),s=a.createImageData(t,i),o=r.getDepthData();for(let n=0;n<t*i;n++){let a=255*o[n],l=a,h=a,c=a;if(this.debugInfos&&e)for(let e=0;e<this.debugInfos.length;e++){let t=this.debugInfos[e];if(this.isDirectAsymetricCollider(n,t.up,t.down,t.left,t.right)){l*=t.color[0],h*=t.color[1],c*=t.color[2];break}}let d=r.convertIndexToXY(n),u=d[0]+(i-1-d[1])*t;s.data[4*u+0]=l,s.data[4*u+1]=h,s.data[4*u+2]=c,s.data[4*u+3]=255}a.putImageData(s,0,0);var l=document.createElement("a");l.download="depth.png",a.canvas.toBlob(function(e){l.href=URL.createObjectURL(e),l.click()})},_getViewpointFromCameraInfos:function(e){if(!e)return this.viewer.currentViewpoint;let i,r=e.near?e.near:this.viewer.currentViewpoint.camera.near,n=e.far?e.far:this.viewer.currentViewpoint.camera.far;if(e.camera)(i=this.vp).camera=e.camera,this.currentData.frustumInfos={near:r,far:n};else{let a,s,o,l,h,c;if(e.useOrtho){i=this.vpOrtho,c=e.top?e.top:1,h=e.bottom?e.bottom:1,l=e.right?e.right:1,o=e.left?e.left:1,i.camera.projectionMatrix.makeOrthographic(o,l,c,h,r,n),a=l-o,s=c-h}else{i=this.vp;let d=e.hfov?e.hfov:this.viewer.currentViewpoint.camera.fov,u=e.vfov?e.vfov:this.viewer.currentViewpoint.camera.fov;h=-(c=Math.tan(t.Math.degToRad(.5*u))*r),o=-(l=Math.tan(t.Math.degToRad(.5*d))*r),i.camera.projectionMatrix.makeFrustum(o,l,h,c,r,n),a=(l-o)*n/r,s=(c-h)*n/r}this.currentData.frustumInfos={left:o,right:l,bottom:h,top:c,near:r,far:n},this.currentData.colliderInfos={farH:a,farV:s},i.camera._renderingRole=t._CameraRoles.NONE;let d=e.position?e.position:this.viewer.currentViewpoint.getEyePosition(),u=e.sight?e.sight:this.viewer.currentViewpoint.getSightDirection(),p=e.up?e.up:this.viewer.currentViewpoint.getUpDirection(),f=i.camera.quaternion,g=i.camera.position,m=new t.Vector3;i.camera.matrix.lookAt(d,(new t.Vector3).addVectors(d,u),p),i.camera.matrix.setPosition(d),i.camera.matrix.decompose(g,f,m)}return i.camera.matrixWorld.copy(i.camera.matrix),i.camera.matrixWorldInverse.getInverse(i.camera.matrixWorld),i.camera.projectionMatrixInverse.getInverse(i.camera.projectionMatrix),i},_buildNormalArray:function(){let e=this.currentData.normalComposer.getResult(this.currentData.name);this.viewer.renderer.renderer.setRenderTarget(e);let t=this._getBuffer(4*this.currentData.width*this.currentData.height,"uint8");this.currentData.normalData=this._getBuffer(3*this.currentData.width*this.currentData.height,"float32");let i=this.currentData.normalData;this.gl.readPixels(0,0,this.currentData.width,this.currentData.height,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t);for(let e=0;e<this.currentData.width*this.currentData.height;e++){var r=t[4*e+0]/255*2-1,n=t[4*e+1]/255*2-1,a=t[4*e+2]/255*2-1,s=this.currentData.camera.matrixWorld.elements,o=1/(s[3]*r+s[7]*n+s[11]*a+s[15]);i[3*e]=(s[0]*r+s[4]*n+s[8]*a)*o,i[3*e+1]=(s[1]*r+s[5]*n+s[9]*a)*o,i[3*e+2]=(s[2]*r+s[6]*n+s[10]*a)*o}this._releaseBuffer(t)},_buildDepthArray:function(){let e=this.currentData.depthComposer.getResult(this.currentData.name);this.viewer.renderer.renderer.setRenderTarget(e);let t=this._getBuffer(4*this.currentData.width*this.currentData.height,"uint8"),i=performance.now();this.gl.readPixels(0,0,this.currentData.width,this.currentData.height,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t);let r=performance.now()-i;this.readPixelPerfs+=r,this.readPixelCount++,this.currentData.depthData=new Float32Array(t.buffer);let n=this.currentData.depthData,a=1,s=null,o=0,l=null;for(let e=0;e<this.currentData.width*this.currentData.height;e++)n[e]||(n[e]=1),n[e]<a&&(a=n[e],s=e),n[e]>o&&(o=n[e],l=e);this.currentData.farthest={index:l,depth:o},this.currentData.nearest={index:s,depth:a}},_buildPositionArray:function(){let e=this.getDepthData();this.currentData.positionData=this._getBuffer(3*this.currentData.width*this.currentData.height,"float32");let i=this.currentData.positionData;for(let r=0;r<this.currentData.width*this.currentData.height;r++){let n=this.convertIndexToXY(r);n[0]=n[0]/this.currentData.width*2-1,n[1]=n[1]/this.currentData.height*2-1;let a=2*e[r]-1,s=new t.Vector4(n[0],n[1],a,1);s.applyMatrix4(this.currentData.camera.projectionMatrixInverse),s.multiplyScalar(1/s.w),s.applyMatrix4(this.currentData.camera.matrixWorld),i[3*r]=s.x,i[3*r+1]=s.y,i[3*r+2]=s.z}},convertIndexToXY:function(e){let t=Math.floor(e/this.currentData.width);return[e-t*this.currentData.width,t]},convertXYToIndex:function(e,t){return t*this.currentData.width+e},computeCollision:function(e){let r=e||{};if(null!=e.near&&null!=e.far&&e.near>=e.far)return void console.warn("CollisionService: incoherent input infos, collision not computed");r.name||(r.name="default"),this._clearCurrentData(r.name),this.setCurrentData(r.name),this.currentData.name=r.name;let n=r.width?r.width:100,a=r.height?r.height:100;this.currentData.cameraPositionData=[];for(let e=0;e<n*a;e++)this.currentData.cameraPositionData[e]=null;let s=this.viewer.renderer;s.renderer.increaseFrameCount(t._FrameTypes.COLLISION);let o=this.collisionDepthComposers.get(r.name);if(!o){var l=new t.WebGLRenderTargetProperties(n,a,"uintNearest");l.generateMipmaps=!1,(o=new i(l,s.mainComposer,"depthCollisionComposerContext")).setPassClear(s.initClearPass,!0,new t.Color(0),0),s.setupOneMaterialComposerContext(o,0,0,!1),o.enablePass(s.initClearPass,!0),this.collisionDepthComposers.set(r.name,o)}this.currentData.depthComposer=o;let h=this.collisionNormalComposers.get(r.name);if(!h){var c=new t.WebGLRenderTargetProperties(n,a,"uintNearest");c.generateMipmaps=!1,(h=new i(c,s.mainComposer,"normalCollisionComposerContext")).setPassClear(s.initClearPass,!0,new t.Color(0),1),s.setupOneMaterialComposerContext(h,0,1,!1),h.enablePass(s.initClearPass,!0),this.collisionNormalComposers.set(r.name,h)}this.currentData.normalComposer=h;var d=!!s.compForwardComposerContext.getPassState(s.zPostPass).enabled;o.enablePass(s.zPostPass,d),h.enablePass(s.zPostPass,d),o.setSize(n,a,r.name),h.setSize(n,a,r.name),o.writeBuffer=null,h.writeBuffer=null,o.readBuffer=null,h.readBuffer=null,o.needsUpdate=!0,h.needsUpdate=!0,this.currentData.width=n,this.currentData.height=a;var u=this._getViewpointFromCameraInfos(e);this.currentData.camera=u.camera;var p=this.viewer.internalSceneGraph.scene,f=u.camera,g={main:f,mainNoJittering:f,connectedRobotCamera:u.connectedRobotCamera,robotCameraOrtho:u.robotCameraOrtho};if(this.disableBackFaceCulling){var m=this.viewer.renderer.renderer.disableBackFaceCulling;this.viewer.renderer.renderer.setDisableBackFaceCulling(!0)}this.skipTransparentItems?(o._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,h._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE):(o._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,h._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE),this.renderNormals&&(s.renderer.autoUpdateScene=!0,p.updateMatrixWorld(),s.mainComposer.updateScene(p),s._updateOITScene(p),s.renderer.materialToUse=t.MaterialToUse.normalMaterial,s.renderer.autoClearDepth=!0,s.renderer.autoClearStencil=!0,s.mainComposer.setComposerContext(h),s.mainComposer.render(void 0,void 0,g,r.name),h.needsUpdate=!1),s.renderer.autoUpdateScene=!0,p.updateMatrixWorld(),s.mainComposer.updateScene(p),s._updateOITScene(p),s.renderer.materialToUse=t.MaterialToUse.depthMaterial,s.renderer.autoClearDepth=!0,s.renderer.autoClearStencil=!0,s.mainComposer.setComposerContext(o),s.mainComposer.render(void 0,void 0,g,r.name),o.needsUpdate=!1,this.disableBackFaceCulling&&this.viewer.renderer.renderer.setDisableBackFaceCulling(m),this.useDebug&&this._debug()},getDepthData:function(){return this.currentData.depthData||this._buildDepthArray(),this.currentData.depthData},getNormalData:function(){return this.currentData.normalData||this._buildNormalArray(),this.currentData.normalData},getPositionData:function(){return this.currentData.positionData||this._buildPositionArray(),this.currentData.positionData},get3DpositionAtIndex:function(e){let i=2*this.getDepthData()[e]-1,r=this.convertIndexToXY(e);r[0]=r[0]/this.currentData.width*2-1,r[1]=r[1]/this.currentData.height*2-1;let n=new t.Vector4(r[0],r[1],i,1);return n.applyMatrix4(this.currentData.camera.projectionMatrixInverse),n.multiplyScalar(1/n.w),n.applyMatrix4(this.currentData.camera.matrixWorld),new t.Vector3(n.x,n.y,n.z)},get3DCameraPositionAtIndex:function(e){let i=2*this.getDepthData()[e]-1,r=this.convertIndexToXY(e);r[0]=r[0]/this.currentData.width*2-1,r[1]=r[1]/this.currentData.height*2-1;let n=new t.Vector4(r[0],r[1],i,1);return n.applyMatrix4(this.currentData.camera.projectionMatrixInverse),n.multiplyScalar(1/n.w),new t.Vector3(n.x,n.y,n.z)},getOptimized3DCameraPositionAtIndex:function(e){if(null==this.currentData.cameraPositionData[e]){let i=this.getDepthData()[e],r=this.convertIndexToXY(e),n=this.currentData.colliderInfos.farH,a=this.currentData.colliderInfos.farV,s=r[0]/this.currentData.width-.5;s*=n;let o=r[1]/this.currentData.height-.5;o*=a;let l=Math.min(this.getCameraDepth(i),this.currentData.frustumInfos.far),h=l/this.currentData.frustumInfos.far,c=s*h,d=o*h;this.currentData.cameraPositionData[e]=new t.Vector3(c,d,l)}return this.currentData.cameraPositionData[e]},getFarthest:function(){return this.currentData.farthest||this._buildDepthArray(),this.currentData.farthest},getNearest:function(){return this.currentData.nearest||this._buildDepthArray(),this.currentData.nearest},getCameraDepth:function(e){let t=this.currentData.frustumInfos.near,i=this.currentData.frustumInfos.far;return t*i/(e*(t-i)+i)},getNoLinearCameraDepth:function(e){let t=this.currentData.frustumInfos.near,i=this.currentData.frustumInfos.far;return(t*i/e-i)/(t-i)},isDirectCollider:function(e,t,i,r,n){let a=void 0!==r?r:this.currentData.frustumInfos.near,s=void 0!==n?n:this.currentData.frustumInfos.far;return this.isDirectAsymetricCollider(e,t,-t,-i,i,a,s)},isDirectAsymetricCollider:function(e,t,i,r,n,a,s){let o=void 0!==a?a:this.currentData.frustumInfos.near,l=void 0!==s?s:this.currentData.frustumInfos.far;return this.isGenericCollider(e,function(e){let a=e.x,s=e.y,h=e.z;return a<=n&&a>=r&&s<=t&&s>=i&&h>=o&&h<=l})},isEdgingCollider:function(e,t,i,r,n,a,s,o){let l=void 0!==a?a:this.currentData.frustumInfos.near;return this.isGenericCollider(e,function(e){let a=e.x,h=e.y,c=e.z,d=(a-r)/(n-r);return a<=n&&a>=r&&h<=t&&h>=i&&c>=l&&c<=s*(1-d)+o*d})},isArcingDepthFromTopCollider:function(e,t,i,r,n,a,s){let o=void 0!==a?a:this.currentData.frustumInfos.near,l=void 0!==s?s:this.currentData.frustumInfos.far;return this.isGenericCollider(e,function(e){let a=e.x,s=e.y,h=e.z;if(a<=n&&a>=r&&s<=t&&s>=i){let e=1-s/(t-i),r=o+(l-o)*Math.sqrt(1-e*e);return h>=o&&h<=r}return!1})},isArcingDepthFromBottomCollider:function(e,t,i,r,n,a,s){let o=void 0!==a?a:this.currentData.frustumInfos.near,l=void 0!==s?s:this.currentData.frustumInfos.far;return this.isGenericCollider(e,function(e){let a=e.x,s=e.y,h=e.z;if(a<=n&&a>=r&&s<=t&&s>=i){let e=s/(t-i),r=o+(l-o)*Math.sqrt(1-e*e);return h>=o&&h<=r}return!1})},isInsideCylinder:function(e,t){let i=this.currentData.frustumInfos.near;return this.isGenericCollider(e,function(e){let r=e.x,n=(e.y,e.z);return(n-t-i)*(n-t-i)+r*r<t*t})},isGenericCollider:function(e,t){return t(this.getOptimized3DCameraPositionAtIndex(e))},getPrecisePositionAtPick_firstImpl(e){var t=this.viewer.currentViewpoint.camera.clone(this.vp.camera),i=null;t.fullWidth&&(i={fullWidth:t.fullWidth,fullHeight:t.fullHeight,x:t.x,y:t.y,width:t.width,height:t.height}),t.useRealSize=!0;var r=Math.round(e.xPix),n=Math.round(e.yPix),a=this.viewer.renderer.renderer.getViewportSize(),s=a.width,o=a.height;if(i){var l,h;l=i.width/i.fullWidth,h=i.height/i.fullHeight;var c=i.fullWidth/s,d=i.fullHeight/o;s=i.fullWidth,o=i.fullHeight,n*=d,r=(r*=c)*l+i.x,n=n*h+i.y,currentPickingToleranceX*=l,currentPickingToleranceY*=h,trapXdist*=l,trapYdist*=h}t.setViewOffsetInternal(s,o,r,n,1,1,{ratioW:1/a.width,ratioH:1/a.height},!0);let u=this.currentData?this.currentData.name:null,p=t.far,f=t.near,g={name:"PreciseDepth",camera:t,near:f,far:p,width:1,height:1};this._setDebugInfos([]),this.computeCollision(g);let m=this.getDepthData()[0],v=this.getCameraDepth(m),y=(this.get3DpositionAtIndex(0),v-f);if(f=v-.001*y,p=v+.001*(y=p-v),t.near=f,t.far=p,t.updateProjectionMatrix(),g.near=f,g.far=p,this.computeCollision(g),this.getDepthData()[0]==m){this.computeCollision(g);this.getDepthData()[0]}let S=this.get3DpositionAtIndex(0);return u&&this.setCurrentData(u),S},getPrecisePositionAtPick(e,i){var r=Math.round(e.xPix),n=Math.round(e.yPix);let a=this.viewer.renderer.renderer.getViewportSize();var s=this.viewer.currentViewpoint,o=s.camera,l=s.getEyePosition(),h=s.getSightDirection().normalize(),c=s.getUpDirection().normalize(),d=(new t.Vector3).crossVectors(h,c).normalize(),u=s.getAngle()/2;h.multiplyScalar(1/Math.tan(u*Math.PI/180));let p=2*(r/a.width-.5),f=2*(n/a.height-.5);c.multiplyScalar(-f),d.multiplyScalar(p*a.width/a.height),h.addVectors(h,c),h.addVectors(h,d),h.normalize(),c.set(-h.z,h.x,-h.y),d.crossVectors(h,c),c.crossVectors(d,h);let g,m=o.far,v=o.near,y={name:"PreciseDepth2",near:v,far:m,useOrtho:!0,top:.5,bottom:-.5,left:-.5,right:.5,position:l,sight:h,up:c,width:1,height:1},S=this.currentData?this.currentData.name:null;this._setDebugInfos([]),i&&(g=this.renderNormals,this.renderNormals=!0),this.computeCollision(y),i&&(this.renderNormals=g);let _=1*Math.floor(.5)+Math.floor(.5),x=this.getDepthData()[_],b=null;if(1!=x){i&&(i.x=this.getNormalData()[3*_],i.y=this.getNormalData()[3*_+1],i.z=this.getNormalData()[3*_+2]);b=this.get3DpositionAtIndex(_)}return S&&this.setCurrentData(S),b}});return UWA.namespace("THREEDS/Collision",o)}),define("DS/Visualization/WebGLV6Viewer",["DS/Visualization/WebGLViewer","DS/Robot/Robot","DS/Robot/ReferenceAxisSystemNode","DS/Robot/CustomReferenceAxisSystem","DS/Visualization/InternalSceneGraph","DS/SceneGraphOverrides/SceneGraphState","DS/SceneGraphOverrides/SceneGraphOverrideSetManager","DS/Visualization/OccurrenceRenderingOverride","DS/SceneGraphOverrides/OverrideLink2","DS/QualityManager/QMController","DS/Visualization/ThreeJS_DS","DS/ViewPanel/ViewPanelController","DS/WAFData/WAFData","DS/Visualization/Node3D","DS/SceneGraphOverrides/IdPathOverrideWatcherTree"],function(e,t,i,r,n,a,s,o,l,h,c,d,u,p,f){p.SceneGraphOverrideSetManager=s;var g=e.extend({init:function(e){this._useQM=!1,this._QMModif=!1,this._useViewPanel=!1,this._QMSettings={AntiAliasing:{modified:!1,value:{static:"SMAA",dynamic:"SMAA"}},AllowOutline:{modified:!1,value:{static:!0,dynamic:!0}},PixelCulling:{modified:!1,value:{static:4.5,dynamic:4.5}},Transparency:{modified:!1,value:{static:"AlphaBlending",dynamic:"AlphaBlending"}},AllowGroundShadows:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},AllowInterObjectShadows:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},AllowTransparentObjectShadows:{modified:!1,value:{static:!1,dynamic:!1,override:!0}},ShadowQuality:{modified:!1,value:{static:"Medium",dynamic:"Medium"}},ShadowFilter:{modified:!1,value:{static:"PCFOptimized",dynamic:"PCFOptimized"}},FlakesQuality:{modified:!1,value:{static:"Ultra",dynamic:"Ultra"}},DefaultMaterialQuality:{modified:!1,value:{static:!1,dynamic:!1}},Downsampling:{modified:!1,value:{static:1,dynamic:1}},AllowGroundReflection:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},AllowInterObjectReflections:{modified:!1,value:{static:!1,dynamic:!1,override:!0}},AllowInterObjectRefractions:{modified:!1,value:{static:!1,dynamic:!1,override:!0}},AllowSSAO:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},NoOfSamples:{modified:!1,value:{static:16,dynamic:16}},AllowBloom:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},AllowDepthOfField:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},DepthFlickeringReduction:{modified:!1,value:{static:!1,dynamic:!1}}},h.isInitialized||(h.init(),h.initPresetDB("QualityPresets")),h.linkToViewer(this),this._parent(e),!(!navigator.webdriver||localStorage.getItem("WebVisuEnableAAWithWebdriver"))&&!window.__karma__&&localStorage.setItem("WebVisu_GPU_Profile","WebVisu Profile Medium"),h.computeDefaultPreset(),void 0!==e.useQualityManager&&e.useQualityManager&&this._initQMSettings(),this._viewPanelController=null,void 0!==e.useViewPanel&&e.useViewPanel&&(this._viewPanelController=new d(this,e.viewPanelConfig),this._initViewPanelSettings()),this._sceneGraphOverrideSetManager=new s({viewer:this}),this._configAmbiences&&this._configAmbiences.effects&&void 0!==this._configAmbiences.effects.OIT&&this.setOIT(this._configAmbiences.effects.OIT),this._idPathOverrideWatcher=null},_initViewPanelSettings:function(){this._useViewPanel||null===this._viewPanelController||(this._useViewPanel=!0,this._viewPanelController.init())},restoreViewPanelSettings:function(){if(null===this._viewPanelController)return null;this._viewPanelController.restore()},dumpViewPanelSettings:function(){return null===this._viewPanelController?null:this._viewPanelController.dumpSettings()},applyViewPanelSettings:function(e){null!==this._viewPanelController&&this._viewPanelController.apply(e)},restoreVisualizationMode:function(t){return this._useViewPanel?[]:e.prototype.restoreVisualizationMode.call(this,t)},restoreProjectionMode:function(){return this._useViewPanel?[]:e.prototype.restoreProjectionMode.call(this)},restoreAmbiance:function(){if(this._useViewPanel)return[];var t=localStorage.getItem("visuEnv");if(!t&&this._useQM&&!window.__karma__){var i=[];return t="WhiteExperienceOCA",i.push("Visu"+t+"Cmd"),t=t.replace("OCA",""),this.setVisuEnvOCA(t),i}return e.prototype.restoreAmbiance.call(this)},setV6Ambience:function(){if(!this._useViewPanel)return e.prototype.setV6Ambience.call(this)},updateViewPanelUIConfiguration:function(e){this._useViewPanel&&(this._viewPanelController._updateViewPanelUIConfiguration(e),this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}}))},_onRequestViewPanelReconstruction:function(e){return this._modelEvent.subscribe({event:"RequestViewPanelReconstruction"},e)},setPlanesFilter:function(e){var t=this.planesFilterStatus!==e,i=this.getBagNode?this.getBagNode():this.getRootNode?this.getRootNode():null;if(i){var r=i.getChildrenByName("RefPlanes");r&&r.length>0&&r.forEach(function(t){t.setVisibility(e),t.setVisibilityFree(!e)})}t&&(this.planesFilterStatus=e,this.addRenderModeLock("InfiniteFace",e),this._modelEvent.publish({event:"RefPlaneFilterMode",data:{viewer:this,state:this.planesFilterStatus}})),this.render()},setAxisOnlyFilter:function(e){var t=this.axisFilterStatus!==e,i=this.getBagNode?this.getBagNode():this.getRootNode?this.getRootNode():null;if(i){var r=i.getChildrenByName("AxisSystems");r&&r.length>0&&r.forEach(function(t){t.setVisibility(e),t.setVisibilityFree(!e)})}t&&(this.axisFilterStatus=e,this.addRenderModeLock("AxisSystem",e),this._modelEvent.publish({event:"AxisFilterMode",data:{viewer:this,state:this.axisFilterStatus}})),this.render()},setAxisAndPlanesFilter:function(e){this.setPlanesFilter(e),this.setAxisOnlyFilter(e)},_initQMSettings:function(){if(!this._useQM){this._useQM=!0;var e=this,t=function(t,i){var r=h.getCurrentGlobalPreset(t),n=h.getPresetValue(t,r);if(n){var a={AntiAliasing:n.AntiAliasing.IterativeAntiAliasing?"MSAA":n.AntiAliasing.AntiAliasing,PixelCulling:n.PixelCulling.PixelCulling,Transparency:n.Transparency.Transparency,AllowGroundShadows:n.Shadows.AllowGroundShadows,AllowInterObjectShadows:n.Shadows.AllowInterObjectShadows,AllowTransparentObjectShadows:n.Shadows.AllowTransparentObjectShadows,ShadowQuality:n.Shadows.ShadowQuality,ShadowFilter:n.Shadows.ShadowFilter,AllowGroundReflection:n.Reflections.AllowGroundReflection,AllowSSAO:n.AmbientOcclusion.AllowSSAO};void 0!==n.AmbientOcclusion.NoOfSamples&&(a.NoOfSamples=n.AmbientOcclusion.NoOfSamples),void 0!==n.DepthBufferOptions&&(a.DepthFlickeringReduction=n.DepthBufferOptions.DepthFlickeringReduction),void 0!==n.Reflections.AllowInterObjectReflections&&(a.AllowInterObjectReflections=n.Reflections.AllowInterObjectReflections),n.Refractions&&void 0!==n.Refractions.AllowInterObjectRefractions&&(a.AllowInterObjectRefractions=n.Refractions.AllowInterObjectRefractions),void 0!==n.Material&&(a.DefaultMaterialQuality=n.Material.DefaultMaterialQuality,a.FlakesQuality=n.Material.FlakesQuality),void 0!==n.Downsampling&&(a.Downsampling=n.Downsampling.Downsampling),!e.ODTMode&&e._setQMSettings(a,i)}};t("Static","static"),t("Dynamic","dynamic")}},setRobot:function(e,t){this.internalSceneGraph&&this.internalSceneGraph.setRobot(e,t,this)&&this.render()},getRobot:function(){return this.internalSceneGraph?this.internalSceneGraph.getRobot():null},setCustomReferenceAxisSystem:function(e){this.internalSceneGraph&&(this.internalSceneGraph.setCustomReferenceAxisSystem(e),this.render())},getCustomReferenceAxisSystem:function(){return this.internalSceneGraph&&this.internalSceneGraph._customReferenceAxisSystem},setReferenceAxisSystem:function(e){this.internalSceneGraph.showReferenceAxisSystem(e,void 0)},getReferenceAxisSystemNode:function(){return this.internalSceneGraph&&this.internalSceneGraph.referenceAxisSystemNode},createSceneGraphState:function(){if(this._sceneGraphStateVersion&&1!==this._sceneGraphStateVersion)throw console.warn("Cannot use both v1 and v2 sceneGraphStates"),Error();if(this._sceneGraphStateVersion||(this._sceneGraphStateVersion=1),this.getRootNode())return new a(this,this.getRootNode())},setCurrentSceneGraphState:function(e){if(this._sceneGraphStateMode&&1!==this._sceneGraphStateVersio)throw console.warn("Cannot use both v1 and v2 sceneGraphStates"),Error();if(this._sceneGraphStateVersion||(this._sceneGraphStateVersion=1),e instanceof a||this.sceneGraphState instanceof a&&!e){var t=this.getRootNode();(!e||e.viewer===this&&e.sceneGraph===t)&&e!==this.sceneGraphState&&(this.sceneGraphState&&this.sceneGraphState.onDeactivation(t),e&&e.onActivation(t),this.sceneGraphState=e,this.internalSceneGraph.root._occurrences[0].requestOverridesUpdate())}},_setDefaultMaterialQuality:function(t){(e.prototype._setDefaultMaterialQuality.call(this,t),this._useQM&&!this._useViewPanel)&&("Ultra"===this.getDefaultMaterialQuality(t)?this.setVisuAppearanceMode(c.DefaultAppearanceMode.GASLOOK):this.setVisuAppearanceMode(c.DefaultAppearanceMode.BASIC))},_qmSetAllowShadow:function(e,t){return this._QMSettings.AllowInterObjectShadows.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowInterObjectShadows",value:e,staticValue:this._QMSettings.AllowInterObjectShadows.value.static,dynamicValue:this._QMSettings.AllowInterObjectShadows.value.dynamic,viewer:this}}),!0},_qmSetAllowTransparentShadow:function(e,t){return this._QMSettings.AllowTransparentObjectShadows.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowTransparentObjectShadows",value:e,staticValue:this._QMSettings.AllowTransparentObjectShadows.value.static,dynamicValue:this._QMSettings.AllowTransparentObjectShadows.value.dynamic,viewer:this}}),!0},_qmSetTransparency:function(e,t){var i=e;return this._QMSettings.Transparency.value[t]=i,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"Transparency",value:i,staticValue:this._QMSettings.Transparency.value.static,dynamicValue:this._QMSettings.Transparency.value.dynamic,viewer:this}}),!0},_qmEnableZPrePass:function(e,t){return this._QMSettings.DepthFlickeringReduction.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"DepthFlickeringReduction",value:e,staticValue:this._QMSettings.DepthFlickeringReduction.value.static,dynamicValue:this._QMSettings.DepthFlickeringReduction.value.dynamic,viewer:this}}),!0},_qmSetFlakesQuality:function(e,t){return this._QMSettings.FlakesQuality.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"FlakesQuality",value:e,staticValue:this._QMSettings.FlakesQuality.value.static,dynamicValue:this._QMSettings.FlakesQuality.value.dynamic,viewer:this}}),!0},_qmSetDownsamplingFactor:function(e,t){return this._QMSettings.Downsampling.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"Downsampling",value:e,staticValue:this._QMSettings.Downsampling.value.static,dynamicValue:this._QMSettings.Downsampling.value.dynamic,viewer:this}}),!0},_qmSetDefaultMaterialQuality:function(e,t){return this._QMSettings.DefaultMaterialQuality.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"DefaultMaterialQuality",value:e,staticValue:this._QMSettings.DefaultMaterialQuality.value.static,dynamicValue:this._QMSettings.DefaultMaterialQuality.value.dynamic,viewer:this}}),!0},_qmSetShadowFilter:function(e,t){return this._QMSettings.ShadowFilter.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"ShadowFilter",value:e,staticValue:this._QMSettings.ShadowFilter.value.static,dynamicValue:this._QMSettings.ShadowFilter.value.dynamic,viewer:this}}),!0},_qmSetShadowQuality:function(e,t){return this._QMSettings.ShadowQuality.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"ShadowQuality",value:e,staticValue:this._QMSettings.ShadowQuality.value.static,dynamicValue:this._QMSettings.ShadowQuality.value.dynamic,viewer:this}}),!0},_qmSetAllowGroundShadow:function(e,t){return this._QMSettings.AllowGroundShadows.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowGroundShadows",value:e,staticValue:this._QMSettings.AllowGroundShadows.value.static,dynamicValue:this._QMSettings.AllowGroundShadows.value.dynamic,viewer:this}}),!0},_qmSetAllowMirror:function(e,t){return this._QMSettings.AllowGroundReflection.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowGroundReflection",value:e,staticValue:this._QMSettings.AllowGroundReflection.value.static,dynamicValue:this._QMSettings.AllowGroundReflection.value.dynamic,viewer:this}}),!0},_qmSetAntiAliasing:function(e,t){return"MSAA"===e&&(e="Iterative"),this._QMSettings.AntiAliasing.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AntiAliasing",value:e,staticValue:this._QMSettings.AntiAliasing.value.static,dynamicValue:this._QMSettings.AntiAliasing.value.dynamic,viewer:this}}),!0},_qmSetPixelCulling:function(e,t){return this._QMSettings.PixelCulling.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"PixelCulling",value:e,staticValue:this._QMSettings.PixelCulling.value.static,dynamicValue:this._QMSettings.PixelCulling.value.dynamic,viewer:this}}),!0},_qmSetAllowSSAO:function(e,t){return this._QMSettings.AllowSSAO.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowSSAO",value:e,staticValue:this._QMSettings.AllowSSAO.value.static,dynamicValue:this._QMSettings.AllowSSAO.value.dynamic,viewer:this}}),!0},_qmSetSSAONbSamples:function(e,t){return this._QMSettings.NoOfSamples.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"NoOfSamples",value:e,staticValue:this._QMSettings.NoOfSamples.value.static,dynamicValue:this._QMSettings.NoOfSamples.value.dynamic,viewer:this}}),!0},_qmSetAllowSSR:function(e,t){return this._QMSettings.AllowInterObjectReflections.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowInterObjectReflections",value:e,staticValue:this._QMSettings.AllowInterObjectReflections.value.static,dynamicValue:this._QMSettings.AllowInterObjectReflections.value.dynamic,viewer:this}}),!0},_qmSetAllowSSRefraction:function(e,t){return this._QMSettings.AllowInterObjectRefractions.value[t]=e,this._QMModif||this._modelEvent.publish({event:"QMSettingModified",data:{parameter:"AllowInterObjectRefractions",value:e,staticValue:this._QMSettings.AllowInterObjectRefractions.value.static,dynamicValue:this._QMSettings.AllowInterObjectRefractions.value.dynamic,viewer:this}}),!0},setVisuEnv:function(e){this._useViewPanel&&"None"!==e&&"No"!==e?console.warn("Warning: deprecated API usage, please use setVisuEnvOCA instead. API disabled."):this._parent(e)},setVisuEnvOCA:function(e,t){return this._parent(e,t)},_setQMSettings:function(e,t){if(this._useQM){this._QMModif=!0,"static"!==(t=t.toLowerCase())&&"dynamic"!==t&&(t="static"),this.renderer&&this.renderer.recompileAllShaders([c.RendererMode[t]]);var i=e.AntiAliasing;if(void 0!==i&&("Iterative"===i&&(i="MSAA"),this.setAntiAliasing(i,t)),void 0!==e.PixelCulling&&this.setPixelCulling(e.PixelCulling,t),void 0!==e.Transparency&&(this._QMSettings.Transparency.modified||this.setOIT("WeightedAverage"===e.Transparency,t)),void 0!==e.FlakesQuality&&(this._QMSettings.FlakesQuality.modified||this.setFlakesQuality(e.FlakesQuality,t)),void 0!==e.DefaultMaterialQuality&&(this._QMSettings.DefaultMaterialQuality.modified||"dynamic"!==t&&this.setDefaultMaterialQuality(e.DefaultMaterialQuality)),void 0!==e.Downsampling&&(this._QMSettings.Downsampling.modified||"dynamic"!==t&&this.setDownsamplingFactor(e.Downsampling)),void 0!==e.AllowGroundShadows&&(this._QMSettings.AllowGroundShadows.modified||this.setAllowGroundShadow(e.AllowGroundShadows,t)),void 0!==e.AllowInterObjectShadows&&(this._QMSettings.AllowInterObjectShadows.modified||this.setAllowShadow(e.AllowInterObjectShadows,t)),void 0!==e.AllowTransparentObjectShadows&&(this._QMSettings.AllowTransparentObjectShadows.modified||this.setAllowTransparentShadow(e.AllowTransparentObjectShadows,t)),void 0!==e.ShadowQuality&&(this._QMSettings.ShadowQuality.modified||this.setShadowQuality(e.ShadowQuality,t)),void 0!==e.ShadowFilter&&!this._QMSettings.ShadowFilter.modified){var r="PCF"===e.ShadowFilter?"PCFOptimized":e.ShadowFilter;this.setShadowFilter(r,t)}if(void 0!==e.AllowGroundReflection&&(this._QMSettings.AllowGroundReflection.modified||this.setAllowMirror(e.AllowGroundReflection,t)),void 0!==e.AllowInterObjectReflections&&(this._QMSettings.AllowInterObjectReflections.modified||this.setAllowSSLR(e.AllowInterObjectReflections,t)),void 0!==e.AllowInterObjectRefractions&&(this._QMSettings.AllowInterObjectRefractions.modified||this.setAllowSSLRefraction(e.AllowInterObjectRefractions,t)),void 0!==e.NoOfSamples&&!this._QMSettings.NoOfSamples.modified){var n=parseInt(e.NoOfSamples);0===n?(this.setAllowSSAO(!1,t),this._QMSettings.NoOfSamples.value[t]=0):(this.setAllowSSAO(!0,t),this.setSSAOParameters({nbOfSamples:n},t))}void 0!==e.DepthFlickeringReduction&&(this._QMSettings.DepthFlickeringReduction.modified||this.enableZPrePass(e.DepthFlickeringReduction,t)),this._QMModif=!1,this.render()}},_getQMSetting:function(e){var t=this._QMSettings[e];return"IterativeAntiAliasing"===e?{modified:(t=this._QMSettings.AntiAliasing).modified,staticValue:"MSAA"===t.value.static,dynamicValue:!1}:t?{modified:t.modified,staticValue:t.value.static,dynamicValue:t.value.dynamic}:null},getQMSetting:function(e){return this._getQMSetting(e)},onQMSettingModified:function(e){return this._modelEvent.subscribe({event:"QMSettingModified"},e)},_isControlPanelActivated:!0,displayIntroductoryControlPreferencePanel:function(){var e=null;if(this._isControlPanelActivated&&window.widget&&window.widget.getValue("x3dPlatformId")){var t=function(){console.warn("Failure to interact with mePreference service")},i=function(){console.warn("Failure to access mePreference service")};require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(r){var n=window.widget,a=function(i){i&&i.repositories&&(i.repositories[0].preferences[0].userOverloadFlag||require(["DS/SWXCoreManipulation/xAppControlPreferencesPanel"],function(i){(new i).show().then(function(i){if(-1!=i&&e){var r=0==i?"3DEXPERIENCE":1==i?"CATIA":"SOLIDWORKS",n=e+"/api/v1/preferences";let a={onFailure:t,onComplete:function(){},method:"PUT",type:"json",data:JSON.stringify({repositories:[{name:"VisualizationRepository",preferences:[{name:"SWNavigationMode",value:r,locked:!1,datatype:"enum"}]}]})};u.authenticatedRequest(n,a)}})}))};r.getServiceUrl({serviceName:"mepreferences",platformId:n.getValue("x3dPlatformId"),onComplete:function(r){if(void 0!==r){e=r;var n=r+"/api/v1/preferences?showUserOverloadFlag=true";u.authenticatedRequest(n,{method:"POST",type:"json",data:JSON.stringify({repositories:[{name:"VisualizationRepository",preferenceNames:["SWNavigationMode"]}]}),headers:{"Content-Type":"application/json"},onComplete:a,onFailure:t})}else i()},onFailure:i})})}},_getIdPathOverrideWatcher:function(){return!this._idPathOverrideWatcher&&this.idPathMatcher&&(this._idPathOverrideWatcher=new f({viewer:this})),this._idPathOverrideWatcher},dispose:function(){this._viewPanelController&&this._viewPanelController.dispose(),h.dispose(),this._parent()}});return n.setRobotClasses(t,i,r),o.setOverrideLink2Class(l),UWA.namespace("THREEDS/WebGLV6Viewer",g)}),define("Visualization/WebGLV6Viewer",["DS/Visualization/WebGLV6Viewer","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/WebGLV6Viewer"),e}),define("DS/Visualization/CGRNode",["UWA/Class","DS/Visualization/SceneGraphUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/PathElement"],function(e,t,i,r,n,a,s){"use strict";var o=function(e,t,i){var r,a=e.children?e.children.length:0,s=e._primitives?e.getPrimitivesCount():0;for(t(e,i),r=0;r<a;r++)o(e.children[r],t,i);if(s)for(r=0;r<s;r++){var l=new n.SGPrimitiveHelper;l.set(e,r),t(l,i)}},l=function(e,t,i){var r,a,s=e.children?e.children.length:0,o=e._primitives?e.getPrimitivesCount():0;if((a=t(e,i)).stop)a.stop=!1;else{for(r=0;r<s;r++)l(e.children[r],t,a);if(o){for(r=0;r<o;r++){var h=new n.SGPrimitiveHelper;h.set(e,r),a=t(h,a),i.index&&i.index--}return}}i.index&&i.index--},h=function(e,t,i){var r=t(e,i);if(!r&&e.type<=i.nodeType)for(var n=e.children,a=n?n.length:0,s=0;s<a;s++)r=h(n[s],t,i);return r},c=function(e,t){(e.getCgmId?e.getCgmId():e.cgmId)==t.cgmId&&t.results.nodes.push(e)},d=function(e,t){var i=!1,r=!0,a=e.getCgmId?e.getCgmId():e.cgmId;if(a==t.path[t.index]?(t.index==t.path.length-1&&t.results.nodes.push(e),r=!1):0==a&&(i=!0,r=!1),!r){var s=e.children;e._primitives&&(s=function(e){for(var t=[],i=0;i<e.getPrimitivesCount();i++){var r=new n.SGPrimitiveHelper;r.set(e,i),t.push(r)}return t}(e)),i||t.index++;for(var o=s?s.length:0,l=0;l<o;l++)d(s[l],t);i||t.index--}},u=r.extend({init:function(e,t){return this._parent(t),this.internalSceneGraph=e,this},setInternalSceneGraph:function(e){this.internalSceneGraph=e},setHighlight:function(e){var t=0,i=0,r=!1,n=this._getPrimitives(e);for(t in n){r=!0;var a=WUX.Selection.HSOManager,o=n[t].mesh._occurrence,l=new s,h=n[t].primitives;for(i=0;i<h.length;i++){(l=new s).setFromOccurrence(o,h[i]);var c={pathElement:l};c.pathElement.getLastElement(!0)._getExcludeFromHL()||a.add(c)}}return r},removeHighlight:function(e){var t=0,i=0,r=!1,n=this._getPrimitives(e);for(t in n){r=!0;var a=WUX.Selection.HSOManager,o=n[t].mesh._occurrence,l=n[t].primitives;for(i=0;i<l.length;i++){(d=new s).setFromOccurrence(o,l[i]);var h={pathElement:d},c=a.get();for(t=0;t<c.length;t++){var d,u=c[t];if(!(d=u.pathElement)&&u.options&&(d=u.options.pathElement),d&&d.isEqual(h.pathElement)){a.remove(u),!0;break}}}}return r},show:function(e){var t=0,i=!1,r=this._getPrimitives(e);for(t in r){i=!0;var n=r[t].mesh._occurrence.node,a=r[t].primitives;n.show(a)}return i},hide:function(e){var t=0,i=!1,r=this._getPrimitives(e);for(t in r){i=!0;var n=r[t].mesh._occurrence.node,a=r[t].primitives;n.hide(a)}return i},getHideShowPathElement:function(e,t,i){var r=this._getPathElements(e,t,i);return{visiblePath:r.pathElementsToShow,hiddenPath:r.pathElementsToHide}},getPathElement:function(e,t){var i=this._getPrimitivesNew4(e);return this.buildPathElementsFromNodes(i,t)},getPathElementsFromIDs:function(e,t,i,r,a){for(var s=new n.UUID,o=function(e,t){return s.setFromUint32(e.uuid_1,e.uuid_2,e.uuid_3,e.uuid_4),!!t.id.isEqual(s)&&(t.res.nodes.push(e),!0)},l=function(e,t){return t.id===e.cgmId&&(t.res.nodes.push(e),!0)},c=function(e,t){t.id===e.cgmId&&t.res.nodes.push(e)},d=function(e,t){for(var i=[],r=e.getPrimitivesCount(),a=0;a<r;a++)for(var s=0;s<t.length;s++)if(e.getPrimitiveCgmId(a)===t[s]){var o=new n.SGPrimitiveHelper;o.set(e,a),i.push(o);break}return i},u=[this.internalSceneGraph],p=[],f=0;f<t.length;f++){for(var g=[],m=0;m<u.length;m++){var v={nodes:[]};h(u[m],0===a?o:l,{id:t[f],nodeType:1,res:v}),v.nodes.length&&(g=g.concat(v.nodes))}if(!g.length)return null;u=g}if(0!==i&&null!=i){for(g=[],m=0;m<u.length;m++){v={nodes:[]};h(u[m],c,{id:i,nodeType:2,res:v}),v.nodes.length&&(g=g.concat(v.nodes))}if(!g.length)return null;if(u=g,null!=r)for(m=0;m<u.length;m++){v={nodes:[]};for(var y=d(u[m],r),S=0;S<y.length;S++)p.push(y[S])}}return this.buildPathElementsFromNodes(p.length>0?p:u,e)},getPathElementsFromUUIDs:function(e,t,i,r){return this.getPathElementsFromIDs(e,t,i,r,0)},getPathElementsFromDiezeEle:function(e,t,i,r){return this.getPathElementsFromIDs(e,t,i,r,1)},_getPrimitives:function(e){var t={};if(!(e instanceof Array))return t;var i=function(e,t){if(e.getType&&3===e.getType()){var i=new a(e),r=e.getGroup();if(r&&r.geometry){var n=r.geometry.meshList[0],s=n.id;t.res[s]?function(e,t){var i,r=e.length;for(i=0;i<r;i++)if(e[i].id==t)return!0;return!1}(t.res[s].primitives,i.id)||t.res[s].primitives.push(i):t.res[s]={mesh:n,primitives:[i]}}}return t},r=function(e,t){l(e,function(e,t){return e.cgmId==t.path[t.index]?(t.index++,t.path.length==t.index?(t.res.push(e),t.stop=!0,t):t):(t.stop=!0,t)},t)};return l(this.internalSceneGraph,function(e,t){e.children&&e.children.length;var n,a=t.idArray.length;for(n=0;n<a;n++)if(e.getCgmId&&e.getCgmId()==t.idArray[n][0]||!e.getCgmId&&e.cgmId==t.idArray[n][0]){var s=[];r(e,{path:t.idArray[n],index:0,res:s,stop:!1}),s.length&&l(s[0],i,t)}return t},{idArray:e,res:t,stop:!1}),t},_getPrimitiveWithMesh:function(e,t){var i=function(e,t){var i,r=e.length;for(i=0;i<r;i++)if(e[i].id==t)return!0;return!1};if(e)if(e.getType){var r=THREEDS.SubElement.getFromSGNode(e),n=e.getGroup();if(n&&n.geometry&&n.geometry.meshList.length>0){var a=n.geometry.meshList[0],s=a.id;t.res[s]?i(t.res[s].reps,r.id)||t.res[s].reps.push(r):t.res[s]={mesh:a,reps:[r]}}}else l(e,function(e,t){if(2==e.type&&(t.stop=!0,e.getPrimitivesCount())){var r=e.getPrimitiveGroup(0),n=THREEDS.SubElement.getFromSGNode(e);if(r&&r.geometry){var a=r.geometry.meshList[0],s=a.id;t.res[s]?i(t.res[s].reps,n.id)||t.res[s].reps.push(n):t.res[s]={mesh:a,reps:[n]}}}return t},t);return t.res},_buildPaths:function(e,t){var i=e,r=[];for(var n in i){for(var a=i[n].mesh._occurrence.node,o=[];a.id!==this.id&&a.parents&&a.parents[0];)o.unshift(a),a=a.parents[0];t&&t.externalPath&&(o=t.externalPath.concat(o));for(var l=i[n].reps,h=0;h<l.length;h++){var c=[l[h]];a=l[h];for("primitive"==l[h].getType()&&(a=THREEDS.SubElement.getFromSGNode(l[h].sgNode.getRep()),c.unshift(a));a&&a.sgNode&&a.sgNode.parents[0];){var d=THREEDS.SubElement.getFromSGNode(a.sgNode.parents[0]);c.unshift(d),a=d}var u=new s;u.setFromArray(o,c),r.push(u)}}return r},buildPathElementsFromNodes:function(e,t){for(var i=[],r=0;r<e.length;r++)this._getPrimitiveWithMesh(e[r],{stop:!1,res:i});return this._buildPaths(i,t)},_getPathElements:function(e,t,i){var r={pathElementsToHide:[],pathElementsToShow:[]};if(!(e instanceof Array))return r;if(!(t instanceof Array))return r;for(var n=[],a=[],s=this._getPrimitivesNew4(e),o=0;o<s.length;o++){(h=s[o]).getCgmId||1!=h.type||h.noShow||(h.noShow=!0,n.push(h))}r.pathElementsToHide=this.buildPathElementsFromNodes(s,i);var l=this._getPrimitivesNew4(t);for(o=0;o<l.length;o++){var h;(h=l[o]).getCgmId||1!=h.type||h.noShow&&(h.noShow=!1,a.push(h))}var c,d=[],u=[];for(o=0;o<l.length;o++)this._getPrimitiveWithMesh(l[o],{stop:!1,res:d});for(c in d)for(var p=d[c].reps,f=0;f<p.length;f++){var g=!0,m=p[f];for("primitive"==m.getType()&&(m=THREEDS.SubElement.getFromSGNode(m.sgNode.getRep()));m&&m.sgNode&&m.sgNode.parents[0];){if("rep"!=m.getType()&&m.sgNode.noShow){g=!1;break}m=THREEDS.SubElement.getFromSGNode(m.sgNode.parents[0])}g&&(u[c]?u[c].reps.push(p[f]):u[c]={mesh:d[c].mesh,reps:[p[f]]})}r.pathElementsToShow=this._buildPaths(u,i);for(o=0;o<n.length;o++)n[o].noShow=!1;for(o=0;o<a.length;o++)a[o].noShow=!0;return r},_getPrimitivesNew2:function(e){for(var t={nodes:[]},i=0;i<e.length;i++)o(this.internalSceneGraph,d,{index:0,results:t,path:e[i]});return t.nodes},getNodeFromIdPath:function(e,t,i,r){var a=i._primitives?i.getPrimitivesCount():0,s=i.getCgmId?i.getCgmId():i.cgmId;if(s>0){if(s!=e[t])return!1;if(++t===e.length)return r.push(i),!0}else if(0==s&&0==e[t]&&++t===e.length)return r.push(i),!0;var o=i.children;if(o)for(var l=0;l<o.length;++l)this.getNodeFromIdPath(e,t,o[l],r);else if(a)for(l=0;l<a;l++){var h=new n.SGPrimitiveHelper;if(h.set(i,l),h.getCgmId()===e[t])return r.push(h),!0}},_getPrimitivesNew4:function(e){for(var t=[],i=0;i<e.length;++i)this.getNodeFromIdPath(e[i],0,this.internalSceneGraph,t);return t},_getPrimitivesNew3:function(e){for(var t=[],i={nodes:[]},r=0;r<e.length;r++){var n=e[r],a=n.length;o(this.internalSceneGraph,c,{results:i,cgmId:n[a-1]});for(var s=0;s<i.nodes.length;s++)for(var l=i.nodes[s],h=0,d=l.getCgmId?l.getCgmId():l.cgmId;d==n[a-1-h]||0==d;){if(d==n[a-1-h]&&h++,h==a){t.push(i.nodes[s]);break}if(l.getType&&3==l.getType())l=l.getRep();else{if(!l.parents||!l.parents[0])break;l=l.parents[0]}d=l.getCgmId?l.getCgmId():l.cgmId}}return t},_buildSGBagNodes:function(){var e=this.internalSceneGraph;e&&1===e.type&&(this.internalSceneGraph=this._buildSGBag(e))},_buildSGBag:function(e){var t,i,r,a=new n.SGBag;for(a.copyNoChildren(e),t=0;t<e.children.length;t++)(r=1===(i=e.children[t]).type?this._buildSGBag(i):i).parents[0]=a,a.children.push(r);return a}});return UWA.namespace("THREEDS/Nodes/CGRNode",u)}),define("Visualization/CGRNode",["DS/Visualization/CGRNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/CGRNode"),e}),define("DS/Visualization/SpriteNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],function(e,t,i){"use strict";var r=t.extend({init:function(t,i){this._parent(i),this.anchor=t;var r=this;return this.cbInit=function(t){var i=(new e.Matrix4).lookAt(t.cameraEye,t.cameraTarget,t.cameraUp);i.setPosition(r.anchor),r.setMatrix(i)},this.cbChange=function(t){if("@onViewpointChange"===t.eventType){var i=(new e.Matrix4).lookAt(t.cameraEye,t.cameraTarget,t.cameraUp);i.setPosition(r.anchor),r.setMatrix(i)}},this},_onLinkedToSceneGraph:function(){this.tokenInit=i.subscribe({event:"/VISU/SpriteNodeInit"},this.cbInit),this.tokenChange=i.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenInit),i.unsubscribe(this.tokenChange)},getNodeType:function(){return"SpriteNode3D"}});return UWA.namespace("THREEDS/Nodes/Sprite",r)}),define("Visualization/SpriteNode3D",["DS/Visualization/SpriteNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SpriteNode3D"),e}),define("DS/Visualization/LensFlareNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){this._parent(i),this.lensflare3js=void 0!==t?t:new e.ParticleSystem,t=this.createRenderable();var r=this._occurrences[0];return r.renderable=t,r.renderable.name=this.name,r.renderable._occurrence=r,this},createRenderable:function(){var e=this.lensflare3js.clone();return e.matrixAutoUpdate=!1,e.matrixWorldNeedsUpdate=!1,e.visible=this.lensflare3js.visible,e.pickable=!1,e.noPickThrough=!1,e.enableNormalDepth=!1,e},add:function(){return!1},getNodeType:function(){return"LensFlareNode3D"}});return UWA.namespace("THREEDS/Nodes/LensFlare",i)}),define("Visualization/LensFlareNode3D",["DS/Visualization/LensFlareNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/LensFlareNode3D"),e}),define("DS/Visualization/FontUtils",["DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/CanvasNodeTexture","DS/SceneGraphNodes/CanvasNode","DS/Visualization/SceneGraphFactory","DS/Visualization/ProxyAbstraction","WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/Visualization/ModelLoader"],function(e,t,i,r,n,a,s,o,l){"use strict";var h=null,c=null,d=null,u=new Set,p=new Set,f=[],g=!1,m=function(e,t){var i=function(e,t){return e.font="64px "+t,e.measureText("cwmli64dr").width},r=function(e,t,i){return e.font="64px '"+t+"','"+i,e.measureText("cwmli64dr").width};return i(t,"monospace")!=r(t,e,"monospace")||(i(t,"serif")!=r(t,e,"serif")||i(t,"sans-serif")!=r(t,e,"sans-serif"))},v=function(e){d=c.getContext("2d"),u.has(e.fn)||(m(e.fn,d)?u.add(e.fn):p.add(e.fn))},y=function(e,t){c||((c=document.createElement("canvas")).height=128),d||(d=c.getContext("2d")),d.font=e;var i=d.measureText(t);c.height=128,c.width=i.width,d.font=e,d.textAlign="left",d.textBaseline="middle",d.clearRect(0,0,c.width,c.height),d.fillStyle="#FFFFFF",d.fillText(t,0,63);for(var r=d.getImageData(0,0,c.width,c.height).data,n=0,a=c.height-1,s=0;s<c.height-1;s++)for(var o=0;o<c.width-1;o++)if(r[s*c.width*4+4*o]){n=s,s=c.height;break}for(s=c.height-1;s>=0;s--)for(o=0;o<c.width-1;o++)if(r[s*c.width*4+4*o]){a=s,s=-1;break}return{width:c.width,height:a-n,topLine:n}},S=function(t){var a,s,o,l,h,c,d,u=new i({width:t.width,height:t.height,drawCB:function(i,r,n,a,s){var o=t.topOffset;try{var l=t.color;if(s&&t.colorIndex&&(l=e._getColorMap(s)[t.colorIndex]),r.fillStyle="#"+l.getHexString(),r.font=t.fontOption,r.textAlign="left",r.textBaseline="middle",r.fillText(t.text,0,o),window.WUXDisableTextNodes)return void r.clearRect(0,0,t.width,t.height)}catch(e){console.log(failed)}},rectangleTexture:!0,maxZoom:8,alphaTest:.01,webGLV6Viewer:t.viewer}),p=(t.hotspot,t.bbox[0]),f=t.bbox[1],g=t.bbox[2],m=t.bbox[3],v=t.orientationAngle,y=f-p,S=m-g,_=v%90;switch(d=v/90,isNaN(d)?NaN:d>0?Math.floor(d):Math.ceil(d)){case 1:a=new e.Vector3(f,g,0),s=new e.Vector3(f,m,0),h=new e.Vector3(0,1,0),c=new e.Vector3(-1,0,0),o=S,l=y;break;case 2:a=new e.Vector3(f,m,0),s=new e.Vector3(p,m,0),h=new e.Vector3(-1,0,0),c=new e.Vector3(0,-1,0),o=y,l=S;break;case 3:a=new e.Vector3(p,m,0),s=new e.Vector3(p,g,0),h=new e.Vector3(0,-1,0),c=new e.Vector3(1,0,0),o=S,l=y;break;default:a=new e.Vector3(p,g,0),s=new e.Vector3(f,g,0),h=new e.Vector3(1,0,0),c=new e.Vector3(0,1,0),o=y,l=S}var x=l,b=0;(_=_*(Math.PI/180))>0&&(b=o-Math.cos(_)*t.widthRigth,x=Math.tan(Math.PI/2-_)*b);var w=l-x;h.multiplyScalar(b);var M=(new e.Vector3).copy(c).multiplyScalar(w);c.multiplyScalar(x);var C=(new e.Vector3).addVectors(a,h),P=(new e.Vector3).addVectors(a,c).sub(C),E=M.add(s).sub(C);return new r({name:"test",bottomLeftcorner:C,widthVector:E,heightVector:P,canvasNodeTexture:u,side:e.DoubleSide,_noZPriority:t._noZPriority},n)},_=function(i,r,n){var a=[];c||((c=document.createElement("canvas")).height=128);for(var s=i.length,o=0;o<s;o++){(l=h[i[o].fontName])&&v(l)}p.forEach(function(e,t,i){var r;r=e,d=c.getContext("2d"),u.has(r)||m(r,d)&&u.add(r)}),p.clear();for(o=0;o<s;o++){var l;(l=h[i[o].fontName])||(l={fn:"nofont"});var f=(l.B?"bold ":"")+(l.I?"italic ":"")+"64px '"+l.fn,g=y(f,i[o].text),_=63-g.topLine,x=(i[o].colorIndex&&i[o].colorIndex,i[o].viewer&&i[o].viewer,new e.Color({r:i[o].color.r,g:i[o].color.g,b:i[o].color.b}));r.textureInBlack&&1==i[o].color.r&&1==i[o].color.g&&1==i[o].color.b&&(x.r=x.g=x.b=0);var b=S({text:i[o].text,width:g.width,height:g.height+1,color:x,fontOption:f,topOffset:_,bbox:i[o].bbox,widthRigth:i[o].width,orientationAngle:i[o].orientationAngle,_noZPriority:i[o]._noZPriority});if(i[o].matrix&&b.setMatrix((new e.Matrix4).setFromArray(i[o].matrix.elements)),i[o].attachedPoint){var w=new t({type:"Spherical"});w.setMatrix((new e.Matrix4).setFromArray(i[o].attachedPoint.elements)),w.addChild(b),a.push(w)}else a.push(b)}n(a)},x={table:h,createTexts:function(e,t,i){h?_(e,t,i):(f.push({cgrTexts:e,options:t,doneCallback:i}),g||(g=!0,require(["text!Visualization/assets/fonts/fontTable.json"],function(e){h=JSON.parse(e),function(){for(var e=0;e<f.length;e++)_(f[e].cgrTexts,f[e].options,f[e].doneCallback);f=[]}()})))},measureText:y};return UWA.namespace("THREEDS/FontUtils",x)}),define("DS/Visualization/LoaderUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/CGRNode","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Mesh/Mesh","DS/SceneGraphNodes/AxisSystemNode","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/FixedSizePlaneNode","DS/Visualization/SceneGraphFactory","DS/Visualization/KDTree","DS/Visualization/FontUtils","DS/SceneGraphNodes/CurvedPipeBatchDummyNode","DS/SceneGraphNodes/RefPlaneNode","DS/SceneGraphNodes/VoxelVolumeNode","DS/SceneGraphNodes/FixedSizeArrowNode"],function(e,t,i,r,n,a,s,o,l,h,c,d,u,p,f,g,m){"use strict";var v=null,y=function(t,i){var r=i.materialLibrary,a=i.baseUrl,s=new n,o=r[t];if(void 0===o)return null;var l=r[o.instance];if(void 0===l)return null;var h=r[l.instance];return void 0===h?null:(void 0===h.material&&void 0!==h.params?(h.material=s.getMaterial3DXML(h.params,a,"XMLV43"),h.material.force=!0):void 0===h.params&&(h.material=e.MaterialUtils.createMatteFaceMaterial(),h.material.force=!0),h.material)},S=function(e,t,i,r,n){for(var s=e.buffer?e:e.prims,o=e.buffer?null:e.bs,l=s.length/5,h=new a.BinarySGPrimitiveArray(s,i,t,o,5),c=[],d=null,u=null,p=new Set,f=0;f<l;f++){(d=t[s[5*f+1]])._binary=!0,p.has(d)&&d!==u&&console.error("Non contiguious primitive reps"),p.add(d);var g=d._primitives[d._primitives.length-1];g&&d===u?g.count++:d._primitives.push({binary:h,start:f,count:1}),u=d}if(r&&r.noShowPrim&&r.noShowPrim.length){var m=new a.SGPrimitiveHelper;for(f=0;f<r.noShowPrim.length;f++)m.set(i,r.noShowPrim[f]),c.push(m.clone())}return{primitives:h,noShowPrim:c}},_=function(e,t,i,r,n){for(var s=e.buffer?e:e.prims,o=(e.buffer||e.bs,s.length/5),l=new Array(o),h=[],c=-1,d=null,u=0,p=0,f=0,g=null,m=0,v=0;v<o;v++)c=s[m++]-1,d=t[s[m++]],u=s[m++],p=s[m++],f=s[m++],g=new a.SGPrimitive({cgmId:c,rep:d,start:u,count:p,decoration:f,group:i}),l[v]=g,d._primitives.push(g);if(r&&r.noShowPrim&&r.noShowPrim.length){var y=new a.SGPrimitiveHelper;for(v=0;v<r.noShowPrim.length;v++)y.set(i,r.noShowPrim[v]),h.push(y.clone())}return{primitives:l,noShowPrim:h}},x=function(t,i,s,o,l,h,c){for(var d,u,p=null,f=null,g=[],m=null,v=null,x=new e.Sphere,b=new e.Box3,w=[],M=c.sgRep,C=c.decorations,P=new n,E=0;E<t.length;E++){var A=t[E],T=c.noMeshInRAM,D=new e.BufferGeometryDS,I=new e.Vector3(A.AABB.min[0],A.AABB.min[1],A.AABB.min[2]),R=new e.Vector3(A.AABB.max[0],A.AABB.max[1],A.AABB.max[2]);D.boundingBox=new e.Box3(I,R),D.boundingSphere=D.boundingBox.getBoundingSphere(),null===m&&(m=I),null===v&&(v=R),I.x<m.x&&(m.x=I.x),I.y<m.y&&(m.y=I.y),I.z<m.z&&(m.z=I.z),R.x>v.x&&(v.x=R.x),R.y>v.y&&(v.y=R.y),R.z>v.z&&(v.z=R.z),b.set(m,v),x.radius=v.clone().sub(m).multiplyScalar(.5).length(),x.center=v.clone().add(m).multiplyScalar(.5);for(var O=0;O<A.drawingGroups.length;O++){if(p=A.drawingGroups[O],A.drawingGroups[O]=new a.DrawingGroup(p.gas,p.material,p.glType,p.start,p.count,p._primitives,null,p._geomType,p.gasIndex),A.drawingGroups[O].cullingData=p.cullingData,c.fromCGR){var L;e._BinaryPrimitives?(L=S(p._primitives,M,A.drawingGroups[O],p),A.drawingGroups[O]._nonBinary=!1):L=_(p._primitives,M,A.drawingGroups[O],p),A.drawingGroups[O]._primitives=L.primitives,w=w.concat(L.noShowPrim)}else{u=(p=A.drawingGroups[O])._primitives;for(var V=0;V<u.length;V++)u[V]=new a.SGPrimitive(u[V]),u[V].group=p}(p=A.drawingGroups[O]).geometry=D;var F=p.gas,B=!1;F.set&&(B=(F.set>>4&3)>1);var N=p.material;if(p.gas=null,p.material=null,null!==N&&""!==N.file?p.material=y(N.id,h):null===N||-1===N.id||4!==p.glType&&!B||(l[N.id]?d=l[N.id]:(N.shading&&(s[N.id].shading=N.shading),(d=P.getMaterialCgr(s[N.id],void 0,"CGR",o,p))&&(d._sceneGraphOrderMode=c.sceneGraphOrderMode,l[N.id]=d,s[N.id]&&s[N.id].useAsGas&&(F=null,p.gas=d),void 0!==d.needTangentBinormal&&(d.needTangentBinormal&&A.vertexTangentArray&&A.vertexBinormalArray||(d.needTangentBinormal=!1)))),p.material=d),null!==F)if(F.set){c&&!c.edgeTransparency&&P._getLineWidth(F)>1&&(F.opacity=1),P._gasAllowNMIR(F)||(T=!1);var G=-1;0==(F.set>>4&3)&&((G=F.set>>8&15)||(G=4),p._geomType!=e.GeomTypeEnum.EDGE&&p._geomType!=e.GeomTypeEnum.BOUNDARY_EDGE&&p._geomType!=e.GeomTypeEnum.SMOOTH_EDGE&&p._geomType!=e.GeomTypeEnum.SHARP_EDGE||(G=-1),F.set|=3840),p.gas=P._getMaterialFromGAS(new a.GraphicAttributeSet(F.set,F.rgba),{sceneGraphOrderMode:c.sceneGraphOrderMode}),p._noZPriority=G}else{var k=new e.Color;k.setRGB(F.color.r,F.color.g,F.color.b),F.lineWidth&&c&&!c.edgeTransparency&&(F.opacity=1),(F.pattern>1||F.lineWidth>1)&&(T=!1),p.gas=P.getMaterialFromGAS({color:k,opacity:F.opacity,pattern:F.pattern,lineWidth:F.lineWidth,forceLineWidth:F.forceLineWidth,solid:F.solid,symbol:F.symbol,basic:F.basic,resource:o})}}D.drawingGroups=A.drawingGroups,D.decorations=C,D.vertexPositionArray=A.vertexPositionArray,null!==A.vertexNormalArray&&(D.vertexNormalArray=A.vertexNormalArray),null!==A.vertexUvArray&&(D.vertexUvArray=A.vertexUvArray),null!==A.vertexTangentArray&&(D.vertexTangentArray=A.vertexTangentArray),null!==A.vertexBinormalArray&&(D.vertexBinormalArray=A.vertexBinormalArray),null!==A.vertexColorArray&&(D.vertexColorArray=A.vertexColorArray),D.vertexIndexArray=A.vertexIndexArray,c&&c.sharedBuffers&&(D.sharedBuffers=!0),D.noMeshInRAM=T,g.push(D)}(N=P._getMaterialFromGAS(new a.GraphicAttributeSet(251658274,-1))).line=P._getMaterialFromGAS(new a.GraphicAttributeSet(251924497,-1)),g.boundingSphere=x,g.boundingBox=b,(f=new e.Mesh(g,N)).fromLoadedModel=!0;for(E=0;E<g.length;E++){a.unindexPoints(g[E])&&(g[E].sharedBuffers=!1)}f.matrixAutoUpdate=!1,f.castShadow=!0,f.receiveShadow=!0;var U=new r(f);(w.length&&U.hide(w),c.accelStruct)&&U._occurrences[0].renderable.computeKDTree(!1);return U},b={__storeCGRNames:1,getEmptyMesh:function(){return v||(v=this.createEmptyMesh()),v},createEmptyMesh:function(){var t=new e.BufferGeometryDS;t.boundingSphere=new e.Sphere(new e.Vector3,0),t.boundingBox=new e.Box3;var i=e.MaterialUtils.createShinyFaceMaterial(),n=new e.Mesh(t,i);return n.matrixAutoUpdate=!1,n.castShadow=!0,n.receiveShadow=!0,new r(n)},processData:function(r,l,d,v,y,S){var _=function(e,t){if(e&&t&&e.children)for(var i=e.children,r=null,n=i.length,a=0;a<n;a++)i[a].children?_(i[a],t):i[a].parents&&i[a].parents[0]||(t[i[a]].parents[0]=e,r=t[i[a]],i[a]=r)},w=function(){this.children=[]};w.prototype.addChild=function(e){this.children.push(e)};var M,C=null,P=null,E=null,A=[],T=[],D=!1,I=!1,R=function(){if(!D&&I){if(r&&!y.unlinkToSG)if(v)for(var e=0;e<r.length;e++)r[e]&&(L?((C=b.createEmptyMesh()).name=l.node,r[e].addChild(C)):(r[e].addChild(M),T=[M]),l.sceneGraph&&l.sceneGraph.noShow&&M.setVisibility(!1));else for(e=0;e<r.length;e++)if(r[e])if(r[0].length&&(r=r[0]),L)(C=b.createEmptyMesh()).name=l.node,r[e].addChild(C);else for(var t=0;t<M.children.length;t++)r[e].addChild(M.children[t]);S&&S(T)}};y||(y={}),y&&y.textureInBlack&&l&&function(e){e.length;for(var t=0;t<e.length;t++){var i=e[t].img,r=e[t].format;if(2==r)for(var n=0;n<i.length;n+=3)255==i[n]&&255==i[n+1]&&255==i[n+2]&&(i[n]=0,i[n+1]=0,i[n+2]=0);if(3==r)for(n=0;n<i.length;n+=4)255==i[n]&&255==i[n+1]&&255==i[n+2]&&(i[n]=0,i[n+1]=0,i[n+2]=0)}}(l.resource),M=v?new t(l.sceneGraph):new w;var O=new n;O.cleanResources();var L=!0;if(l.rep)l.rep.length>0&&(C=x(l.rep,0,l.material,l.resource,A,d,y)),C&&(M.addChild(C),L=!1);else{y.fromCGR=!0;var V=function(e,t){if(!e)return[];var i=3;t.withSAG&&(i+=1),t.repWithBS&&(i+=4);var r=e.length/i,n=new Array(r),s=0;if(t.withSAG)if(t.repWithBS)for(var o=0;o<r;o++)n[o]=new a.SGRep({cgmId:e[s++]-1,solid:e[s++],namingContext:e[s++],sag:e[s++],boundingSphere:{radius:e[s++],center:[e[s++],e[s++],e[s++]]}});else for(o=0;o<r;o++)n[o]=new a.SGRep({cgmId:e[s++]-1,solid:e[s++],namingContext:e[s++],sag:e[s++]});else if(t.repWithBS)for(o=0;o<r;o++)n[o]=new a.SGRep({cgmId:e[s++]-1,solid:e[s++],namingContext:e[s++],boundingSphere:{radius:e[s++],center:[e[s++],e[s++],e[s++]]}});else for(o=0;o<r;o++)n[o]=new a.SGRep({cgmId:e[s++]-1,solid:e[s++],namingContext:e[s++]});return n}(l.sgRep,y);v&&_(l.sceneGraph,V),y.sgRep=V,y.decorations=l.decorations;for(var F=0;F<l.reps.length;F++)if(l.reps[F].length){if(1&F||8&F){if((C=new i).name=l.node+"_parallelToScreen",!(1&F)){for(B=0;B<l.reps[F].length;++B){(G=x(l.reps[F][B].tab,0,l.material,l.resource,A,d,y)).setRatio(1);k=l.reps[F][B].globalMatrix;(N=new o(le={type:"Spherical"})).addChild(G),k&&N.setMatrix((new e.Matrix4).setFromArray(k.elements)),C.addChild(N)}0==C.children.length&&(C=null),C&&(T.push(C),M.addChild(C),L=!1);continue}for(var B=0;B<l.reps[F].length;++B){var N,G=x(l.reps[F][B].tab,0,l.material,l.resource,A,d,y),k=l.reps[F][B].globalMatrix;(N=new o(le={type:"Spherical"})).addChild(G),k&&N.setMatrix((new e.Matrix4).setFromArray(k.elements)),C.addChild(N)}0==C.children.length&&(C=null)}else C=x(l.reps[F],0,l.material,l.resource,A,d,y),1===this.__storeCGRNames&&(C.name=l.node);2&F&&C.setExcludeFromBounding(!0),4&F&&C.setNoZ(!0),C&&(T.push(C),M.addChild(C),L=!1)}}if(y.processText&&l.texts&&l.texts.length>0){D=!0,L=!1;u.createTexts(l.texts,y,function(e){for(var t=0;t<e.length;++t){var i=e[t];T.push(i),M.addChild(i)}D=!1,R()})}if(l.voxelReps&&l.voxelReps.length>0){var U=l.voxelReps;for(F=0;F<U.length;F++){var z=U[F],H=new g(z);T.push(H),M.addChild(H),L=!1}}if(l.refPlanes&&l.refPlanes.length>0){var W=new i;(E=new i("RefPlanes")).setNoZ(!0),E.setVisibility(!1),E.setVisibilityInTree(!1);var j=1/e.getPixelsPerMM(),X=e.getDevicePixelRatio()/j;for(F=0;F<l.refPlanes.length;++F)for(B=0;B<l.refPlanes[F].length;B++){var q=l.refPlanes[F][B],Z=null,Y=q.lengthX*X,Q=q.lengthY*X,K=new e.Vector3(q.xAxis[0],q.xAxis[1],q.xAxis[2]),J=new e.Vector3(q.yAxis[0],q.yAxis[1],q.yAxis[2]),$=((new e.Vector3).crossVectors(K,J),new e.Vector3(q.origin[0],q.origin[1],q.origin[2])),ee=new a.Color(q.color[0]/255,q.color[1]/255,q.color[2]/255,q.color[3]/255);new e.Color(ee);if("CAT3DReferencePlaneRep"===q.type){var te=q.mode;te?(q.lengthX*=1/j,q.lengthY*=1/j):q.autoSize&&(q.lengthX*=1.05,q.lengthY*=1.05);var ie=q.refPlaneData,re=!ie||!ie._wireframeMode,ne=(!!ie&&ie._orientationVisibility,!ie||ie._labelVisibility),ae=ie?ie._opacity/255:.075,se=ie?new e.Color(ie._frontColor):new e.Color("#005686"),oe=ie?new e.Color(ie._backColor):new e.Color("#a3c8dc"),le={name:"ref Plane "+F,fill:!0,newLook:re,fixedSize:te,size:new e.Vector2(q.lengthX,q.lengthY),planeAttributes:{front:{color:se,opacity:ae},back:{color:oe,opacity:ae}},borderAttributes:{front:{color:se,opacity:.8,width:1},back:{color:oe,opacity:.8,width:1}}};ne&&(le.textAttributes={fixedSize:!0,front:{data:q.label,color:se,opacity:1,size:30},back:{data:q.label,color:oe,opacity:1,size:30}}),Z=new f(le)}else if(q.zoomable){(Z=c.createRectangleNode({color:ee,width:Y,height:Q,fill:!1})).setShadow(!1),Z.setFrustumCulled(!1);var he=new e.Vector3(.7071068*-Y/2,.7071068*-Q/2,0),ce=(new e.Matrix4).setPosition(he);Z.setMatrix(ce)}else{le={sgRep:V[q.rep],origin:$,direction2:new e.Vector3(q.xAxis[0]+q.yAxis[0],q.xAxis[1]+q.yAxis[1],q.xAxis[2]+q.yAxis[2]),direction1:new e.Vector3(q.xAxis[0]-q.yAxis[0],q.xAxis[1]-q.yAxis[1],q.xAxis[2]-q.yAxis[2]),sceneGraph:W,color:ee,length1:.7071068*Y,length2:.7071068*Q,name:"ref Plane "+F};Z=new h(le)}E.addChild(Z)}}if(E&&(E._forceGeomType("INFINITE_FACE"),T.push(E),M.addChild(E),L=!1),l.arrows&&l.arrows.length>0){W=new i;var de=new i("Arrows");de.setNoZ(!0);for(j=.264583333,X=e.getDevicePixelRatio()/j,F=0;F<l.arrows.length;++F)for(B=0;B<l.arrows[F].length;B++){var ue=l.arrows[F][B],pe=null,fe=ue.length*X,ge=new e.Vector3(ue.direction[0],ue.direction[1],ue.direction[2]);ge.normalize();var me=new e.Vector3(0,1,0),ve=new e.Vector3(1,0,0);$=new e.Vector3(ue.origin[0],ue.origin[1],ue.origin[2]);if(1!==ge.z)(me=(new e.Vector3).cross(new e.Vector3(0,0,1),ge)).normalize(),(ve=(new e.Vector3).cross(me,ge)).normalize();(Fe=(new e.Matrix4).makeBasis(ve,me,ge)).setPosition($);le={name:"arrow"+F,pickable:!0,color:ee=new a.Color(ue.color[0]/255,ue.color[1]/255,ue.color[2]/255,ue.color[3]/255),head:m.types.ARROW,arrowLength:fe,arrowWidth:1};pe=new m(le),ue.noShow&&pe.setVisibility(!1),pe.setMatrix(Fe),ue.infiniteFace&&pe._forceGeomType("AXIS_SYSTEM"),de.addChild(pe)}de&&(T.push(de),M.addChild(de),L=!1)}if(l.curvedPipes&&l.curvedPipes.length>0){var ye=null,Se={curvedPipes:[]};for(F=0;F<l.curvedPipes.length;++F){var _e=l.curvedPipes[F],xe=(_e.matId,_e.gas),be={radius:_e.radius,curvePoints:_e.curveVertices,baseNormal:new e.Vector3(_e.startNormal[0],_e.startNormal[1],_e.startNormal[2]),endNormal:new e.Vector3(_e.endNormal[0],_e.endNormal[1],_e.endNormal[2]),baseSideVector:new e.Vector3(_e.startSideVector[0],_e.startSideVector[1],_e.startSideVector[2])};if(Se.curvedPipes.push(be),null!==xe)(ee=new e.Color).setRGB(xe.color.r,xe.color.g,xe.color.b),ye=O.getMaterialFromGAS({color:ee,opacity:xe.opacity}),be.gas=ye,ye._source=e.AssetSource.MANUAL}var we=new p(Se);T.push(we),M.addChild(we),L=!1}if(l.canonicals&&l.canonicals.length>0){var Me={Cone:0,Cylinder:1,Pipe:2,Cuboid:3,Sphere:4,PartialSphere:5,Tore:6,PartialTore:7};switch(l.canonicals[0].canonicalType){case Me.Cone:console.log("Cone");break;case Me.Cylinder:console.log("Cylinder");break;case Me.Pipe:console.log("Pipe");break;case Me.Cuboid:console.log("Cuboid");break;case Me.PartialSphere:console.log("PartialSphere");break;case Me.Sphere:console.log("Sphere");break;case Me.PartialTore:console.log("PartialTore");break;case Me.Tore:console.log("Tore")}}if(l.axisSystems&&l.axisSystems.length>0){W=new i;(P=new i("AxisSystems")).setVisibility(!1),P.setVisibilityFree(!0),P.setVisibilityInTree(!1);for(j=1/e.getPixelsPerMM(),F=0;F<l.axisSystems.length;++F){var Ce=l.axisSystems[F],Pe=null,Ee=Ce.zoomable||!1;le={sgRep:V[Ce.rep],headLength:10,arrowLength:Ee?Ce.length:50,arrowWidth:2,sceneGraph:W,colors:{colorX:new a.Color(Ce.color[0]/255,Ce.color[1]/255,Ce.color[2]/255,Ce.color[3]/255),colorY:new a.Color(Ce.color[0]/255,Ce.color[1]/255,Ce.color[2]/255,Ce.color[3]/255),colorZ:new a.Color(Ce.color[0]/255,Ce.color[1]/255,Ce.color[2]/255,Ce.color[3]/255)},name:"axis System 1",head:s.types.ARROW,zoomable:Ee};Pe=new s(le);var Ae=new e.Matrix4,Te=[];if(Te[0]=Ce.xAxis[0],Te[1]=Ce.xAxis[1],Te[2]=Ce.xAxis[2],Te[3]=0,Te[4]=Ce.yAxis[0],Te[5]=Ce.yAxis[1],Te[6]=Ce.yAxis[2],Te[7]=0,Te[8]=Ce.zAxis[0],Te[9]=Ce.zAxis[1],Te[10]=Ce.zAxis[2],Te[11]=0,Te[12]=Ce.origin[0],Te[13]=Ce.origin[1],Te[14]=Ce.origin[2],Te[15]=1,Ae.setFromArray(Te),Pe.setMatrix(Ae),P.addChild(Pe),void 0!==Ce.refPlanes){var De=null;if(Ee){De=new i;for(var Ie=null,Re=0;Re<Ce.refPlanes.length;Re++){ee=new a.Color(Ce.color[0]/255,Ce.color[1]/255,Ce.color[2]/255,Ce.color[3]/255);Ie=Ce.refPlanes[Re];var Oe=[new e.Vector3(Ie[0],Ie[1],Ie[2]),Ve=new e.Vector3(Ie[3],Ie[4],Ie[5]),new e.Vector3(Ie[6],Ie[7],Ie[8])];(Z=c.createLineNode({points:Oe,color:ee})).setShadow(!1),Z.setFrustumCulled(!1),De.addChild(Z)}}else{De=new i("fixedSizeHalfPlanes");var Le=(new e.Matrix4).getInverse(Ae);for(Ce.xAxis,Ce.yAxis,Ce.zAxis,Re=0;Re<Ce.refPlanes.length&&1===Ce.refPlanes[Re].mode;Re++){fe=Ce.refPlanes[Re].length*e.getDevicePixelRatio()/j,ee=new a.Color(Ce.color[0]/255,Ce.color[1]/255,Ce.color[2]/255,Ce.color[3]/255),K=Ce.refPlanes[Re].direction1,J=Ce.refPlanes[Re].direction2;var Ve=new e.Vector3(.5*fe*K[0],.5*fe*K[1],.5*fe*K[2]);Oe=[new e.Vector3(Ve.x+.25*fe*(K[0]+J[0]),Ve.y+.25*fe*(K[1]+J[1]),Ve.z+.25*fe*(K[2]+J[2])),Ve,new e.Vector3(Ve.x+.25*fe*(K[0]-J[0]),Ve.y+.25*fe*(K[1]-J[1]),Ve.z+.25*fe*(K[2]-J[2]))];(Z=c.createLineNode({points:Oe,color:ee})).setShadow(!1),Z.setFrustumCulled(!1),De.addChild(Z)}var Fe=(new e.Matrix4).multiplyMatrices(Le,(new e.Matrix4).setPosition(new e.Vector3(Ce.origin[0],Ce.origin[1],Ce.origin[2])));De.setMatrix(Fe),De._setRatio(1)}De.setNoZ(!0),Pe.addChild(De)}}}P&&(P._forceGeomType("AXIS_SYSTEM"),T.push(P),M.addChild(P),L=!1),r&&!y.unlinkToSG&&v&&M._buildSGBagNodes(),I=!0,R()},isProcessDataAsynchronous:!0};return b}),define("DS/Visualization/Filters/GeomTypeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this._geomType=e}}}),define("DS/Visualization/Filters/StaticGeomTypeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/GeomTypeFilter"],function(e,t){"use strict";return class extends t{constructor(e){throw super(e),"Unsupported class"}}}),define("DS/Visualization/TextNode",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/EditableMesh3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/GraphicAttributeSet","DS/Visualization/MaterialApplication"],function(e,t,i,r,n,a,s){"use strict";var o={},l={count:97,width:256,height:256,chars:{0:{yoffset:1.5,width:4,xadvance:0,y:238,x:223,height:4,xoffset:-1.5},13:{yoffset:1.5,width:4,xadvance:9.25,y:252,x:250,height:4,xoffset:-1.5},32:{yoffset:1.5,width:4,xadvance:9.25,y:252,x:246,height:4,xoffset:-1.5},33:{yoffset:27.063,width:12,xadvance:9.5,y:0,x:186,height:30,xoffset:-.688},34:{yoffset:27.063,width:15,xadvance:18,y:15,x:210,height:14,xoffset:3},35:{yoffset:26.438,width:24,xadvance:19.5,y:125,x:48,height:28,xoffset:-1.875},36:{yoffset:32.125,width:24,xadvance:19.938,y:65,x:24,height:40,xoffset:-1.625},37:{yoffset:27.938,width:30,xadvance:31.813,y:94,x:48,height:31,xoffset:1.5},38:{yoffset:24.75,width:36,xadvance:33.25,y:38,x:0,height:27,xoffset:-.25},39:{yoffset:27.063,width:8,xadvance:10.875,y:238,x:246,height:14,xoffset:3},40:{yoffset:33,width:16,xadvance:12,y:105,x:24,height:41,xoffset:-.5},41:{yoffset:33,width:16,xadvance:12,y:211,x:48,height:41,xoffset:-2.188},42:{yoffset:28.938,width:19,xadvance:16.375,y:238,x:227,height:18,xoffset:.438},43:{yoffset:20.688,width:19,xadvance:18.875,y:237,x:135,height:19,xoffset:.25},44:{yoffset:6.938,width:11,xadvance:9.5,y:15,x:225,height:15,xoffset:-2.25},45:{yoffset:14.938,width:15,xadvance:15.063,y:247,x:181,height:7,xoffset:.25},46:{yoffset:6.938,width:10,xadvance:9.5,y:243,x:92,height:10,xoffset:-.875},47:{yoffset:31.875,width:22,xadvance:19.25,y:94,x:135,height:38,xoffset:-1},48:{yoffset:26.875,width:22,xadvance:21.25,y:65,x:81,height:29,xoffset:.188},49:{yoffset:26.375,width:16,xadvance:15.75,y:0,x:74,height:28,xoffset:0},50:{yoffset:26.875,width:21,xadvance:19,y:65,x:190,height:29,xoffset:-1.438},51:{yoffset:26.813,width:22,xadvance:18.938,y:65,x:147,height:29,xoffset:-2.188},52:{yoffset:27.063,width:22,xadvance:20.188,y:65,x:125,height:29,xoffset:-.938},53:{yoffset:26.375,width:23,xadvance:19.688,y:182,x:48,height:29,xoffset:-1.688},54:{yoffset:26.813,width:21,xadvance:20.375,y:65,x:211,height:29,xoffset:.125},55:{yoffset:26.438,width:20,xadvance:16.875,y:65,x:232,height:29,xoffset:.188},56:{yoffset:26.813,width:22,xadvance:21.125,y:65,x:103,height:29,xoffset:-.688},57:{yoffset:26.813,width:21,xadvance:20.375,y:222,x:24,height:30,xoffset:.438},58:{yoffset:20.188,width:11,xadvance:9.5,y:185,x:243,height:23,xoffset:-.875},59:{yoffset:20.25,width:13,xadvance:9.5,y:0,x:173,height:29,xoffset:-2.25},60:{yoffset:22.563,width:20,xadvance:18.875,y:0,x:121,height:21,xoffset:.25},61:{yoffset:18.75,width:20,xadvance:18.875,y:0,x:210,height:15,xoffset:.688},62:{yoffset:22.563,width:20,xadvance:18.875,y:0,x:141,height:21,xoffset:-.563},63:{yoffset:27.625,width:19,xadvance:18.625,y:185,x:0,height:30,xoffset:.938},64:{yoffset:27.625,width:38,xadvance:37.75,y:0,x:0,height:38,xoffset:.188},65:{yoffset:27.125,width:26,xadvance:21.563,y:209,x:201,height:29,xoffset:-3.125},66:{yoffset:27.063,width:23,xadvance:22.875,y:123,x:233,height:29,xoffset:.188},67:{yoffset:27.625,width:24,xadvance:21.063,y:187,x:109,height:30,xoffset:.25},68:{yoffset:27.063,width:25,xadvance:24.188,y:123,x:183,height:29,xoffset:.188},69:{yoffset:27.063,width:22,xadvance:19.5,y:94,x:234,height:29,xoffset:.188},70:{yoffset:27.063,width:21,xadvance:18.188,y:65,x:169,height:29,xoffset:.188},71:{yoffset:27.625,width:25,xadvance:23.625,y:153,x:230,height:30,xoffset:.25},72:{yoffset:27.063,width:25,xadvance:24.625,y:94,x:184,height:29,xoffset:.188},73:{yoffset:27.063,width:12,xadvance:10.813,y:0,x:198,height:29,xoffset:.188},74:{yoffset:27.063,width:16,xadvance:11,y:215,x:0,height:35,xoffset:-3.75},75:{yoffset:27.063,width:26,xadvance:22.438,y:209,x:227,height:29,xoffset:.188},76:{yoffset:27.063,width:19,xadvance:18.563,y:0,x:38,height:29,xoffset:.188},77:{yoffset:27.063,width:31,xadvance:29.188,y:94,x:78,height:29,xoffset:-1.25},78:{yoffset:27.063,width:25,xadvance:24.75,y:123,x:208,height:29,xoffset:.188},79:{yoffset:27.625,width:26,xadvance:25.5,y:123,x:157,height:30,xoffset:.25},80:{yoffset:27.125,width:24,xadvance:21.875,y:123,x:78,height:29,xoffset:.188},81:{yoffset:27.625,width:26,xadvance:25.5,y:94,x:109,height:34,xoffset:.25},82:{yoffset:27.125,width:24,xadvance:22.375,y:217,x:109,height:29,xoffset:.188},83:{yoffset:27.625,width:24,xadvance:20.313,y:157,x:109,height:30,xoffset:-1.75},84:{yoffset:27.063,width:23,xadvance:19.375,y:153,x:48,height:29,xoffset:.125},85:{yoffset:27.063,width:25,xadvance:24.25,y:153,x:205,height:30,xoffset:.75},86:{yoffset:27.063,width:25,xadvance:21.625,y:94,x:209,height:29,xoffset:.438},87:{yoffset:27.125,width:33,xadvance:30.875,y:65,x:48,height:29,xoffset:.813},88:{yoffset:27.063,width:27,xadvance:21.063,y:94,x:157,height:29,xoffset:-3},89:{yoffset:27.063,width:25,xadvance:21,y:128,x:109,height:29,xoffset:.125},90:{yoffset:27.063,width:24,xadvance:19.438,y:152,x:78,height:29,xoffset:-2.125},91:{yoffset:31.813,width:17,xadvance:12,y:146,x:24,height:38,xoffset:-1.625},92:{yoffset:31.875,width:20,xadvance:19.375,y:209,x:181,height:38,xoffset:-.438},93:{yoffset:31.875,width:17,xadvance:12,y:184,x:24,height:38,xoffset:-1.938},94:{yoffset:32.688,width:22,xadvance:19.875,y:238,x:201,height:15,xoffset:.5},95:{yoffset:-.563,width:22,xadvance:19.25,y:248,x:157,height:7,xoffset:-3.313},96:{yoffset:31.875,width:14,xadvance:12.125,y:243,x:78,height:11,xoffset:-.438},97:{yoffset:21.625,width:22,xadvance:21.375,y:38,x:60,height:24,xoffset:-.375},98:{yoffset:29.438,width:22,xadvance:21.75,y:132,x:135,height:32,xoffset:-.125},99:{yoffset:21.625,width:20,xadvance:17.25,y:38,x:211,height:24,xoffset:-.375},100:{yoffset:29.438,width:24,xadvance:21.688,y:153,x:181,height:32,xoffset:-.375},101:{yoffset:21.625,width:21,xadvance:19.25,y:38,x:169,height:24,xoffset:-.375},102:{yoffset:29.5,width:24,xadvance:12.375,y:65,x:0,height:40,xoffset:-4.188},103:{yoffset:21.688,width:23,xadvance:21.625,y:216,x:157,height:32,xoffset:-1.125},104:{yoffset:29.438,width:22,xadvance:21.25,y:212,x:78,height:31,xoffset:-.25},105:{yoffset:30.938,width:13,xadvance:10,y:0,x:108,height:33,xoffset:-.375},106:{yoffset:30.938,width:17,xadvance:10,y:196,x:135,height:41,xoffset:-4.938},107:{yoffset:29.438,width:22,xadvance:20.813,y:181,x:78,height:31,xoffset:-.25},108:{yoffset:29.438,width:12,xadvance:10.438,y:0,x:161,height:32,xoffset:0},109:{yoffset:21.625,width:32,xadvance:31.375,y:185,x:181,height:24,xoffset:-.25},110:{yoffset:21.625,width:22,xadvance:21.25,y:38,x:104,height:24,xoffset:-.25},111:{yoffset:21.625,width:22,xadvance:21.313,y:38,x:82,height:24,xoffset:-.375},112:{yoffset:21.625,width:24,xadvance:21.75,y:153,x:157,height:32,xoffset:-1.375},113:{yoffset:21.625,width:22,xadvance:21.563,y:164,x:135,height:32,xoffset:-.375},114:{yoffset:21.625,width:18,xadvance:14.313,y:0,x:90,height:24,xoffset:-.25},115:{yoffset:21.563,width:20,xadvance:17.563,y:38,x:231,height:24,xoffset:-1.938},116:{yoffset:26,width:17,xadvance:13.75,y:0,x:57,height:29,xoffset:-.563},117:{yoffset:21.063,width:21,xadvance:21.063,y:38,x:148,height:24,xoffset:.313},118:{yoffset:21.125,width:22,xadvance:18.375,y:38,x:126,height:23,xoffset:-.375},119:{yoffset:21.125,width:30,xadvance:27.125,y:185,x:213,height:23,xoffset:0},120:{yoffset:21.063,width:24,xadvance:18,y:38,x:36,height:23,xoffset:-3.438},121:{yoffset:21.125,width:24,xadvance:18.313,y:185,x:157,height:31,xoffset:-2.25},122:{yoffset:21.063,width:21,xadvance:16.375,y:38,x:190,height:23,xoffset:-2.5},123:{yoffset:32.438,width:16,xadvance:12,y:145,x:0,height:40,xoffset:-.813},124:{yoffset:31.375,width:12,xadvance:14.375,y:211,x:64,height:37,xoffset:1.688},125:{yoffset:32.438,width:16,xadvance:12,y:105,x:0,height:40,xoffset:-2.313},126:{yoffset:16.125,width:21,xadvance:18.875,y:246,x:109,height:9,xoffset:-.438}},base:41},h=t.getWebappsAssetUrl("Visualization",""),c=new e.ImageUtils.loadTexture(h+"fonts/default.png",void 0,null,null,!0);c.flipY=!0,c.anisotropy=16;var d=new e.Vector3,u=i.extend({init:function(t,i,r){this.lineHeight=1,this.nbChars=0,this.textArray={},this.primitivePicking=!0,this._paramsLocked=!!r,this.billboard=!(!r||void 0===r.billboard)&&!!r.billboard,this.billboardAxis=!(!r||void 0===r.billboardAxis)&&!!r.billboardAxis,this.fixedSize=!(!r||void 0===r.fixedSize)&&!!r.fixedSize,this.viewSpace=!(!r||void 0===r.viewSpace)&&!!r.viewSpace,this.projectionSpace=!(!r||void 0===r.projectionSpace)&&!!r.projectionSpace,this.textMaterial=null,this.textGas=new a({colorRGB:new e.Color(0),side:e.FrontSide}),this._initMaterialPDSFX(this._paramsLocked),this._setFont();var n=new e.Mesh(void 0,null);return this._token=0,this.mesh3js=null,this._parent(n,t),this.mesh3js=this._occurrences[0].renderable,this._reallocate(r&&r.allocSize?r.allocSize:512),this.setFrustumCulled(!0),this.matInherit=window.newMaterialInheritance,this.matInherit?(this.matApp=new s({faceMaterial:this.textMaterial,layer:0}),this.textMaterial.useGASColor=!0,this.textMaterial.useGASOpacity=!0,this.setMaterialApplication(this.matApp)):this.setMaterial(this.textMaterial),this.setMaterialMode(!0),this},clone:function(){var t=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);return new u(t,this.name)},getNodeType:function(){return"Mesh3D"},setPrimitivePicking:function(e){this.primitivePicking=e},setBillboard:function(e,t){this._paramsLocked||this.billboard===e&&this.billboardAxis===t||(this.billboard=e,this.billboardAxis=t,this._updateDefines())},setFixedSize:function(e){this._paramsLocked||this.fixedSize!==e&&(this.fixedSize=e,e&&(this.billboard=!0),this._updateDefines())},_setViewSpace:function(e){this._paramsLocked||this.viewSpace!==e&&(this.viewSpace=e,this.projectionSpace=!e,this._updateDefines())},_setProjectionSpace:function(e){this._paramsLocked||this.projectionSpace!==e&&(this.projectionSpace=e,this.viewSpace=!e,this._updateDefines())},_updateDefines:function(){var e={USE_BILLBOARD:this.billboard,USE_AXIS:this.billboardAxis,USE_FIXEDSIZE:this.fixedSize,USE_VIEWSPACE:this.viewSpace,USE_PROJSPACE:this.projectionSpace};this.textMaterial.defines=e,this.textMaterial.updateDeferredMaterials(),this.textMaterial.needsUpdate=!0},getBillboard:function(){return this.billboard},addText:function(e){var t=e.string.length;if(0==t)return-1;var i=this._addText(e);if(i){e.primitive=i;var r=i.getCgmId();return this.textArray[r]=e,this.nbChars+=t,r}var n=this._reallocate(t),a=this._occurrences[0].renderable;if(i=this._addText(e,null!==n?a.layer.layers[n]:null,n)){e.primitive=i;r=i.getCgmId();return this.textArray[r]=e,this.nbChars+=t,r}return-1},removeText:function(e){var t=this.textArray[e];t&&(this.hide([n.getFromSGNode(t.primitive)]),this.nbChars-=t.string.length,delete this.textArray[e])},_setFont:function(){this.textMaterial&&this.textMaterial.updatePDSFXUniform("fontMap",c)},_reallocate:function(t){var i=this._occurrences[0].renderable,n=4*t,a=i.geometry.length,s=a?i.geometry[a-1]:null,o=s?s.vertexPositionArray.length/3:0,l=!a||65536===o,h=l?e.ImageUtils.nearest_greater_pow2(n):e.ImageUtils.nearest_greater_pow2(o+n),c=new e.BufferGeometryDS;c.editable=!0,c.vertexIndexArray=new Uint16Array(6*h/4),c.vertexPositionArray=new Float32Array(3*h),c.vertexColorArray=new Float32Array(4*h),c.vertexNormalArray=new Float32Array(3*h),c.vertexUvArray=new Float32Array(3*h),c.vertexUv2Array=new Float32Array(3*h),c.vertexTangentArray=new Float32Array(3*h),c.vertexBinormalArray=new Float32Array(3*h);for(var d=0;d<3*h;d+=3)c.vertexPositionArray[d]=NaN;var u=null;if(l){var p=new r.SGPrimitive({cgmId:this._token,rep:null,start:0,count:6*h/4});this._token++,(g=new r.DrawingGroup(this.textGas,null,4,0,6*h/4,[p])).geometry=c,c.drawingGroups.push(g),p.group=g;for(var f=0;f<this._occurrences.length;f++){(x=this._occurrences[f].renderable).geometry.push(c),c.addRefVBO(x,!1),x._initLayersForGeometry(0,c),u=(b=x.layer.getIntervals(c,null,!0)).length?x.layer.layers.indexOf(b[0]):-1}}else{for(d=0;d<4*o;d++)c.vertexColorArray[d]=s.vertexColorArray[d],d<3*o&&(c.vertexPositionArray[d]=s.vertexPositionArray[d],c.vertexNormalArray[d]=s.vertexNormalArray[d],c.vertexUvArray[d]=s.vertexUvArray[d],c.vertexUv2Array[d]=s.vertexUv2Array[d],c.vertexTangentArray[d]=s.vertexTangentArray[d],c.vertexBinormalArray[d]=s.vertexBinormalArray[d]);for(d=0;d<6*o/4;d++)c.vertexIndexArray[d]=s.vertexIndexArray[d];var g,m=s.drawingGroups[0]._primitives.slice(),v=m[m.length-1],y=v.start+v.count,S=6*h/4-y,_=new r.SGPrimitive({cgmId:this._token,rep:null,start:y,count:S});m.push(_),this._token++,(g=new r.DrawingGroup(this.textGas,null,4,0,6*h/4,m)).geometry=c,c.drawingGroups.push(g);for(f=0;f<m.length;f++)m[f].group=g;for(f=0;f<this._occurrences.length;f++){for(var x,b=(x=this._occurrences[f].renderable).layer.getIntervals(x.geometry[a-1],null,!0),w=0;w<b.length;w++)b[w].geometry=c,b[w].drawableGroup=c.drawingGroups[0];var M=b[b.length-1],C=x.layer.layers.indexOf(M);if(M.drawableInterval.layerNum){var P=new e.DrawableInterval(0,y,S);P.primitiveStart=m.length-1,P.primitiveCount=1;var E=new e.LayerInterval(c,c.drawingGroups[0],P);x.layer.layers.splice(C+1,0,E),u=C+1}else M.drawableInterval.count+=S,M.drawableInterval.primitiveCount++,u=C;c.addRefVBO(x,!1),x.geometry[a-1].releaseVBO(x,!1),x.geometry.splice(a-1,1),x.geometry.push(c)}}return u},_initMaterialPDSFX:function(t){var i="_";if(t&&(this.billboard&&(i+="bi_"),this.billboardAxis&&(i+="ax_"),this.fixedSize&&(i+="fi_"),this.viewSpace&&(i+="vi_"),this.projectionSpace&&(i+="pr_"),o[i]))this.textMaterial=o[i];else{if(this.textMaterial=new e.MeshBasicMaterial({force:!this.matInherit,side:e.FrontSide,needTangentBinormal:!0,vertexColors:e.VertexColorType.RGB,transparent:!0}),t){var r={USE_BILLBOARD:this.billboard,USE_AXIS:this.billboardAxis,USE_FIXEDSIZE:this.fixedSize,USE_VIEWSPACE:this.viewSpace,USE_PROJSPACE:this.projectionSpace};this.textMaterial.defines=r}this.textMaterial.activatePDSFX();var n={fontMap:{type:"t2",value:null},quad:{type:"fv1",value:[-.5,-.5,.5,-.5,.5,.5,-.5,.5],length:8},invSize:{type:"v2",value:new e.Vector2(512,512)},screenRatio:{type:"f",value:1}};this.textMaterial.setPDSFXUniforms(n);this.textMaterial.setPDSFXVaryings({_color:{type:"v4"},_uv:{type:"v2"}}),this.textMaterial.setPDSFXGlobalShaderCode("","float alpha;");var a={ComputeVaryingValues:["void ComputeVaryingValues() {","_color = vec4(vGetAttribColor().rgb, 1.0);","_uv = vGetAttribTexCoord0().xy;","}"].join("\n"),ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) {","vec3 mPos = vGetAttribPosition();","vec3 mNormal = vGetAttribNormal();","vec4 mUV2 = vGetAttribTexCoord1();","vec3 mTangent = vGetAttribTangent();","vec3 mBinormal = vGetAttribBinormal();","vec3 uncompressedUp = mTangent;","vec3 uncompressedRight = mBinormal;","vec3 corner = vec3(quad[2*int(_vGetAttribColorAlpha())], quad[2*int(_vGetAttribColorAlpha()) + 1], 0.0);","#ifdef USE_BILLBOARD","#ifdef USE_FIXEDSIZE","#ifdef USE_VIEWSPACE","vec4 mvPosition = (modelMatrix * vec4(mPos, 1.0));","#elif defined(USE_PROJSPACE)","vec4 projPosition = vec4(mPos.xy, 0.0, 1.0);","#else",e._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPosition","vec4(mPos, 1.0)"),"#endif","#ifdef USE_AXIS","#ifdef USE_VIEWSPACE","vec4 mvPosition2 = (modelMatrix * vec4(mPos + uncompressedRight, 1.0));","#elif defined(USE_PROJSPACE)","vec4 projPosition2 = vec4(uncompressedRight.xy, 0.0, 1.0);","#else",e._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPosition2","vec4(mPos + uncompressedRight, 1.0)"),"#endif","#endif","#else",e._DefaultShaderChunk.getModelViewTransformationChunk("vec4 _mvPos","vec4(mPos, 1.0)"),"vec4 mvPosition = _mvPos + vec4(mNormal, 0.0) + vec4(corner * vec3(mUV2.xy, 1.0), 0.0);","#endif","#else","vec3 newPosition = mPos + mat3(uncompressedRight, uncompressedUp, vec3(0.0, 0.0, 1.0)) * (mNormal + corner * vec3(mUV2.xy, 1.0));",e._DefaultShaderChunk.getModelViewTransformationChunk("vec4 mvPosition","vec4(newPosition, 1.0)"),"#endif","vec3 mvNormal;","#ifdef USE_PROJSPACE","ioPosition = projPosition;","#else","ioPosition = vGetProjectionMatrix() * mvPosition;","#endif","#ifdef USE_FIXEDSIZE","#ifdef USE_AXIS","#ifdef USE_PROJSPACE","vec2 toPixels = 0.5 / invSize;","vec2 projPt1 = toPixels * projPosition.xy;","vec2 projPt2 = toPixels * projPosition2.xy;","#else","vec4 glPosition2 = vGetProjectionMatrix() * mvPosition2;","vec2 toPixels1 = 0.5 / (invSize * ioPosition.w);","vec2 toPixels2 = 0.5 / (invSize * glPosition2.w);","vec2 projPt1 = toPixels1 * ioPosition.xy;","vec2 projPt2 = toPixels2 * glPosition2.xy;","#endif","vec2 rightVecPx = normalize(projPt2.xy - projPt1.xy);","vec2 upVecPx = vec2(-rightVecPx.y, rightVecPx.x);","vec2 offsetVec = (mNormal.xy + corner.xy * mUV2.xy);","offsetVec = offsetVec.x * rightVecPx + offsetVec.y * upVecPx;","#ifdef USE_PROJSPACE","ioPosition.xy += 2.0 * invSize * offsetVec;","#else","ioPosition.xy += 2.0 * invSize * offsetVec * ioPosition.w;","#endif","#else","ioPosition.xy += 2.0 * invSize * (mNormal.xy + corner.xy * mUV2.xy) * ioPosition.w;","#endif","#endif","}"].join("\n")},s={ComputeCommonValues:["void ComputeCommonValues() {","float epsilon = 0.1;","vec4 texture = texture2D(fontMap, _uv);","#if defined(GL_OES_standard_derivatives) || defined(GLSL300ES)","    float w = clamp(200.0 * epsilon * (abs(dFdx(_uv.x)) + abs(dFdy(_uv.y))), 0.0, 0.5);","#else","    float w = epsilon;","#endif","alpha = smoothstep(0.5 - w, 0.5 + w, texture.r);","alpha = pow(alpha, 1.0/2.2);","}"].join("\n"),ComputeDiscard:["bool ComputeDiscard() {","float alphaTest = 0.01;","return (alpha < alphaTest);","}"].join("\n"),ProcessFinalColor:"void ProcessFinalColor(inout vec4 ioFinalColor) { ioFinalColor = vec4(ComputeAlbedo() * _color.xyz, alpha * ComputeOpacity()); }"};this.textMaterial.setPDSFXOverridableFunctions(a,s),this.textMaterial.enableClipPlanes=!0,t&&(o[i]=this.textMaterial)}},_addText:function(e,t,i){var r=e.string.length,n=this._occurrences[0].renderable;if(!t)for(var a=0;a<n.layer.layers.length;a++){var s=n.layer.layers[a],o=s.drawableInterval;if(!o.layerNum&&o.count>=6*r){t=s,i=a;break}}if(t){var l=this._updatePrimitives(t,i,r);return this._updateBuffers(l,e),l}return null},_encodeUnitVector:function(e){var t=Math.abs(e.x)+Math.abs(e.y)+Math.abs(e.z),i=e.x/t,r=e.y/t;if(e.z<0){var n=(1-Math.abs(r))*(i>=0?1:-1),a=(1-Math.abs(i))*(r>=0?1:-1);i=n,r=a}return 4096*(i=Math.round(4095*(.5*i+.5)))+(r=Math.round(4095*(.5*r+.5)))},_updateBuffers:function(t,i){for(var n=new e.Box2,a=t.getGroup().geometry,s=t.getStart(),o=4*(s/6),h=i,c=h.string.length,u=h.offset?h.offset:d,p=this.getBuffer(r.VertexComponentEnum.POSITION,a),f=this.getBuffer(r.VertexComponentEnum.NORMAL,a),g=this.getBuffer(r.VertexComponentEnum.DIFFUSE_COLOR,a),m=this.getBuffer(r.VertexComponentEnum.TEX_COORD_0,a),v=this.getBuffer(r.VertexComponentEnum.TEX_COORD_1,a),y=this.getBuffer(r.VertexComponentEnum.TEX_COORD_2,a),S=this.getBuffer(r.VertexComponentEnum.TEX_COORD_3,a),_=this.getIndexBuffer(a),x=h.size/l.base,b=h.lineLength?h.lineLength:0,w=0,M=new e.Vector3,C=s,P=o,E=3*o,A=4*o,T=3*o,D=3*o,I=3*o,R=3*o,O=3*o,L=0,V=0;V<c;V++){var F=h.string[V];if("\n"===F)M.x=0,M.y-=x*this.lineHeight*l.base,w=0;else{if(b&&" "===F&&w>b){M.x=0,M.y-=x*this.lineHeight*l.base,w=0;continue}if(!(F=l.chars[F.charCodeAt(0)]))continue;L++,_[C++]=P,_[C++]=P+1,_[C++]=P+2,_[C++]=P,_[C++]=P+2,_[C++]=P+3,P+=4,m[I++]=F.x/l.width,m[I++]=(l.height-(F.y+F.height))/l.height,m[I++]=0,m[I++]=(F.x+F.width)/l.width,m[I++]=(l.height-(F.y+F.height))/l.height,m[I++]=0,m[I++]=(F.x+F.width)/l.width,m[I++]=(l.height-F.y)/l.height,m[I++]=0,m[I++]=F.x/l.width,m[I++]=(l.height-F.y)/l.height,m[I++]=0;var B=M.x+x*(.5*F.width+F.xoffset),N=M.y+x*(F.yoffset-.5*F.height);M.z;M.x+=x*F.xadvance,w+=x*F.xadvance,n&&(B-.5*x*F.width<n.min.x&&(n.min.x=B-.5*x*F.width),B+.5*x*F.width>n.max.x&&(n.max.x=B+.5*x*F.width),N-.5*x*F.height<n.min.y&&(n.min.y=N-.5*x*F.height),N+.5*x*F.height>n.max.y&&(n.max.y=N+.5*x*F.height));for(var G=0;G<4;G++)f[E++]=u.x+B,f[E++]=u.y+N,f[E++]=u.z,p[T++]=h.anchor.x,p[T++]=h.anchor.y,p[T++]=h.anchor.z,v[D++]=x*F.width,v[D++]=x*F.height,v[D++]=0,g[A++]=h.color.r,g[A++]=h.color.g,g[A++]=h.color.b,g[A++]=G,y[R++]=h.up.x,y[R++]=h.up.y,y[R++]=h.up.z,S[O++]=h.right.x,S[O++]=h.right.y,S[O++]=h.right.z}}for(V=0;V<6*(c-L);V++)_[C++]=0;this.updateBuffer(r.VertexComponentEnum.POSITION,o,4*c,a),this.updateBuffer(r.VertexComponentEnum.NORMAL,o,4*c,a),this.updateBuffer(r.VertexComponentEnum.DIFFUSE_COLOR,o,4*c,a),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_0,o,4*c,a),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_1,o,4*c,a),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_2,o,4*c,a),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_3,o,4*c,a),this.updateIndexBuffer(s,6*c,a);var k=new e.Vector3(n.min.x,n.min.y,-.5),U=new e.Vector3(n.max.x,n.max.y,.5),z=this.getBoundingBox(),H=new e.Box3(k,U);this.forceBoundingBox(z.union(H)),i.labelExtent||(i.labelExtent=n)},getTextExtent:function(t){var i=new e.Box2;t.labelExtent=i;for(var r=t,n=r.string.length,a=r.size/l.base,s=r.lineLength?r.lineLength:0,o=0,h=new e.Vector2,c=0;c<n;c++){var d=r.string[c];if("\n"===d)h.x=0,h.y-=a*this.lineHeight*l.base,o=0;else{if(s&&" "===d&&o>s){h.x=0,h.y-=a*this.lineHeight*l.base,o=0;continue}if(!(d=l.chars[d.charCodeAt(0)]))continue;var u=h.x+a*(.5*d.width+d.xoffset),p=h.y+a*(d.yoffset-.5*d.height);h.x+=a*d.xadvance,o+=a*d.xadvance,u-.5*a*d.width<i.min.x&&(i.min.x=u-.5*a*d.width),u+.5*a*d.width>i.max.x&&(i.max.x=u+.5*a*d.width),p-.5*a*d.height<i.min.y&&(i.min.y=p-.5*a*d.height),p+.5*a*d.height>i.max.y&&(i.max.y=p+.5*a*d.height)}}return i},_updatePrimitives:function(e,t,i){this._mergePrimitives(e,t);var n=e.geometry,a=n.drawingGroups[0],s=e.drawableInterval,o=a.getPrimitiveCount(s.primitiveStart);a._setPrimitiveCount(6*i,s.primitiveStart);var l=new r.SGPrimitiveHelper;l.set(a,s.primitiveStart);var h=o-l.getCount();if(h>0){var c=new r.SGPrimitive({cgmId:this._token,rep:null,group:l.getGroup(),start:l.getStart()+l.getCount(),count:h});this._token++,a._primitives.splice(s.primitiveStart+1,0,c)}for(var d=0;d<this._occurrences.length;d++){var u=this._occurrences[d].renderable,p=u.layer.layers[t],f=t?u.layer.layers[t-1]:null,g=f&&f.geometry===p.geometry;if(f&&g&&1===f.drawableInterval.layerNum)f.drawableInterval.count+=l.getCount(),f.drawableInterval.primitiveCount++,h>0?(p.drawableInterval.start=l.getStart()+l.getCount(),p.drawableInterval.count=h,p.drawableInterval.primitiveStart++):u.layer.layers.splice(t,1);else if(p.drawableInterval.count=6*i,p.drawableInterval.layerNum=1,h>0){var m=p.clone();m.drawableInterval.layerNum=0,m.drawableInterval.start=l.getStart()+l.getCount(),m.drawableInterval.count=h,u.layer.layers.splice(t+1,0,m)}if(h>0)for(var v=t+1;v<u.layer.layers.length&&u.layer.layers[v].geometry===n;v++)u.layer.layers[v].drawableInterval.primitiveStart++}return l},_mergePrimitives:function(e,t){var i=e.geometry,r=i.drawingGroups[0]._primitives,n=e.drawableInterval;if(!(n.primitiveCount<=1)){var a=r[n.primitiveStart],s=r[n.primitiveStart+n.primitiveCount-1];a.count=s.start+s.count-a.start,r.splice(n.primitiveStart+1,n.primitiveCount-1);for(var o=0;o<this._occurrences.length;o++)for(var l=this._occurrences[o].renderable,h=t+1;h<l.layer.layers.length&&l.layer.layers[h].geometry===i;h++)l.layer.layers[h].drawableInterval.primitiveStart-=n.primitiveCount-1;n.primitiveCount=1}}});return UWA.namespace("THREEDS/Nodes/TextNode",u)}),define("DS/Visualization/PlaneGrid",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/TextNode"],function(e,t,i,r,n){"use strict";var a=(new i.Color).setRGB(1,1,1),s=(new i.Vector3(0,0,1),new i.Vector3(0,0,-1),new i.Vector3(1,0,0)),o=new i.Vector3(0,1,0),l=new i.Vector3(0,0,1),h=new i.Vector3(-1,0,0),c=new i.Vector3(0,-1,0),d=new i.Vector3(0,0,-1),u=new i.Vector3,p=new i.Vector2,f=new i.Vector2;return Math.round10||(Math.round10=function(e,t){return function(e,t,i){return void 0===i||0==+i?Math[e](t):(t=+t,i=+i,isNaN(t)||"number"!=typeof i||i%1!=0?NaN:(t=t.toString().split("e"),+((t=(t=Math[e](+(t[0]+"e"+(t[1]?+t[1]-i:-i)))).toString().split("e"))[0]+"e"+(t[1]?+t[1]+i:i))))}("round",e,t)}),e.extend({init:function(e){this.viewer=e,this.worldOrientation=null,this.position=new i.Vector3,this.size=100,this.displayLabels=!1,this.gridLabels=null,this.labelColor=a,this.labelCB=null,this.displayLabelCB=null,this.labels={rightNS:[],rightWE:[],bottomNS:[],bottomWE:[],all:[]},this.displayGrid=e.displayGrid,this.displayGridFromBelow=e.displayGridFromBelow,this.gridScreenSize=50,this.gridNbSteps=e.gridNbSteps,this.gridUnit=1,this.gridOffset=new i.Vector2,this.gridCoeff=0,this.gridFalloff=0,this.gridColor=e.gridColor,this.displayPlane=1,this.planeFalloff=0,this.planeColor=e.planeColor,this.planeOpacity=1,this.planeTexture=null,this.planeTextureScale=1,this._onlyDiffuse=!1,this.planeBorder=!1,this.edgeColor=new i.Color,this.mesh=null,this.matrix=new i.Matrix4,this.material=null,this.gridTextures={},this.viewProjMatrix=new i.Matrix4,this.tmpFrustum=new i.Frustum,this.tmpPoly1=new i.CGPolygon,this.tmpPoly2=new i.CGPolygon,this.tmpLine=new i.Line3(new i.Vector3,new i.Vector3)},setGridNbSteps:function(e){this.gridNbSteps=e,this.setGridTextures()},setLabels:function(e){if(e!==this.displayLabels){if(this.displayLabels=e,e&&!this.gridLabels){this.gridLabels=new n("gridLabels"),this.gridLabels.setBillboard(!0,!0),this.gridLabels.setFixedSize(!0),this.gridLabels._setProjectionSpace(!0);var t=this.gridLabels._occurrences[0].renderable;t.renderDepth=0,t.receiveShadow=!1,this.viewer.sceneBackground.add(t)}this.gridLabels&&(this.gridLabels.setVisibility(e),this.gridLabels.setVisibilityFree(e))}},setLabelColor:function(e){this.labelColor=new i.Color,this.labelColor.set(e)},setLabelCallback:function(e){this.labelCB=e},setDisplayLabelCallback:function(e){this.displayLabelCB=e},getUnitGridTexture:function(e){if(this.gridTextures[e])return this.gridTextures[e];for(var t=new Uint8Array(e*e),r=0;r<e;++r)t[r]=255,t[e*(e-1)+r]=255,t[e*r]=255,t[e*r+e-1]=255;var n=new i.DataTexture(t,e,e,i.AlphaFormat,i.UnsignedByteType,new i.UVMapping,i.RepeatWrapping,i.RepeatWrapping,i.LinearFilter,i.LinearMipMapLinearFilter,16);return n.needsUpdate=!0,this.gridTextures[e]=n,n},setGridTextures:function(){if(this.material){var e=this.gridNbSteps/2,t=i.ImageUtils.nearest_pow2(64*e),r=i.ImageUtils.nearest_pow2(64*e*e),n=Math.min(i.ImageUtils.nearest_pow2(64*e*e*e),4096);this.material.updatePDSFXUniform("gridTexture",this.getUnitGridTexture(64)),this.material.updatePDSFXUniform("gridTexture2",this.getUnitGridTexture(t)),this.material.updatePDSFXUniform("gridTexture3",this.getUnitGridTexture(r)),this.material.updatePDSFXUniform("gridTexture4",this.getUnitGridTexture(n))}},createPlaneGrid:function(e,t,n,a,s,o){this.size=e,this.position=t,this.worldOrientation=n.getWorldOrientation();var l=this.worldOrientation.upVector,h="zup"===this.worldOrientation._woName;this.computeGridUnit(n.camera,Math.abs(n.camera.position.dot(l)-this.position.dot(l)));var c=this.gridNbSteps*this.gridUnit;if(this.gridOffset.x=a?t.x-c*Math.floor(t.x/c):0,h?this.gridOffset.y=a?t.y-c*Math.floor(t.y/c):0:this.gridOffset.z=a?t.z-c*Math.floor(t.z/c):0,!this.mesh){this.material=new i.PlaneMaterial,this.material.setPlaneV2(!0),this.material.ambient.copy(new i.Color(328965)),this.setGridTextures();var d=r.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:this.material});d.setVisibilityFree(!0),this.mesh=d._occurrences[0].renderable,this.mesh.frustumCulled=!1,this.mesh.receiveShadow=!1,this.mesh.renderDepth=1,this.viewer.sceneBackground.add(this.mesh),this.mesh.pickable=!1}this.mesh.visible=!0;var u=new i.Vector3,p=new i.Vector3,f=(new i.Matrix4).copy(s);u.copy(this.worldOrientation.frontVector),u.multiplyScalar(t.x-.5*e),p.copy(this.worldOrientation.rightVector),p.multiplyScalar(t.y-.5*e),u.add(p),p.copy(this.worldOrientation.upVector),p.multiplyScalar(t.z),u.add(p),f.setPosition(u),f.scale(new i.Vector3(e,e,e)),this.mesh.setMatrix(f),this.material.updatePDSFXUniform("displayPlane",this.displayPlane),this.material.updatePDSFXUniform("displayGrid",this.displayGrid),this.material.updatePDSFXUniform("gridFromBelow",this.displayGridFromBelow),this.material.color.copy(this.planeColor),this.material.updatePDSFXUniform("planeOpacity",this.planeOpacity),this.material.setPlaneTexture(this.planeTexture),this.material.updatePDSFXUniform("uvScale",this.planeTextureScale);var g=new i.Color;g.copyToLinear(this.edgeColor,o),this.material.updatePDSFXUniform("border",g),this.material.updatePDSFXUniform("attenuation",this.viewer.planeAttenuation?1:0),this.material.updatePDSFXUniform("planeBorder",this.planeBorder?1:0),this.material.updatePDSFXUniform("planeFalloff",this.planeFalloff),this.material.updatePDSFXUniform("gridFalloff",this.gridFalloff),this.material.updatePDSFXUniform("gridUnit",this.gridUnit),this.material.updatePDSFXUniform("gridOffset",this.gridOffset),this.material.updatePDSFXUniform("gridCoeff",this.gridCoeff);var m=new i.Color;m.copyToLinear(this.gridColor,o),this.material.updatePDSFXUniform("gridColor",m),this.material.updatePDSFXUniform("planeSize",e),this.material.updatePDSFXUniform("nbSteps",this.gridNbSteps),this.material.updatePDSFXUniform("onlyDiffuse",this._onlyDiffuse)},computeGridUnit:function(e,t){var r=1;e instanceof i.PerspectiveCamera?r=2*this.gridScreenSize*Math.tan(Math.PI*e.fov/360)*t/this.viewer._getDivClientHeight():e instanceof i.OrthographicCamera&&(r=this.gridScreenSize*(e.top-e.bottom)/this.viewer._getDivClientHeight());for(var n=1/(this.gridNbSteps*this.gridNbSteps);n<r;)1===this.gridNbSteps?n++:n*=this.gridNbSteps,0;this.gridUnit=n,1===this.gridNbSteps?this.gridCoeff=r-n-1:this.gridCoeff=(r-n/this.gridNbSteps)/(n-n/this.gridNbSteps)},updateLabels:function(e){if(this.displayLabels&&(this.cleanLabels(),this.computeLabelPositions(e.camera),this.displayLabelsFunc(),this.gridLabels)){var t=this.gridLabels.textMaterial;t.updatePDSFXUniform("invSize",new i.Vector2(1/this.viewer.renderer.deviceWidth,1/this.viewer.renderer.deviceHeight)),t.updatePDSFXUniform("screenRatio",this.viewer.renderer.deviceWidth/this.viewer.renderer.deviceHeight)}},addLabel:function(e,t,r,n,a,f,g){var m="x"===f?s:"y"===f?o:l,v={string:e,anchor:t,color:this.labelColor,size:20*i.getDevicePixelRatio(),lineLength:500,up:this.worldOrientation.upVector,right:m,isRight:!1},y=this.gridLabels.getTextExtent(v),S=Math.abs(y.max.x-y.min.x),_=Math.abs(y.max.y-y.min.y);y.min.x=-_,y.min.y=-_,y.max.x=_,y.max.y=_,y.translate(r),u.addVectors(t,m);var x=this.viewer.currentViewpoint.project(u,g);p.set(x.x-r.x,x.y-r.y),p.normalize(),p.x<0&&(v.right="x"===f?h:"y"===f?c:d);var b=!1;if(a?(b=!0,p.x>0&&p.negate()):((p.x<0&&p.y<0||p.x>0&&p.y>0)&&(b=!0),p.x>0&&p.y>0&&p.negate()),b&&(p.multiplyScalar(S),r.x+=p.x,r.y+=p.y),v.anchor=this.viewer.currentViewpoint.unProject(r,g),v.right=(new i.Vector3).addVectors(v.anchor,v.right),v.anchor.applyProjection(this.viewProjMatrix),v.right.applyProjection(this.viewProjMatrix),p.set(v.right.x-v.anchor.x,v.right.y-v.anchor.y),p.normalize(),v.right.copy(v.anchor),v.right.x+=p.x,v.right.y+=p.y,!this.displayLabelCB)for(var w=0;w<n.length;w++)if(y.isIntersectionBox(n[w]._text.labelExtent))return;var M={token:null,_text:v,isRight:a,display:!0};n.push(M),this.labels.all.push(M)},isBottomRightEdge:function(e){return!(e.x<2)&&!(e.y<2)},isRightEdgeFunc:function(e){return e.x>this.viewer.SCREEN_WIDTH-2},isInsideFrustum:function(e){return!(e.x<-1||e.x>this.viewer.SCREEN_WIDTH+1)&&(!(e.y<-1||e.y>this.viewer.SCREEN_HEIGHT+1)&&!(e.z<-1.001||e.z>1.001))},cleanLabels:function(){for(var e=0;e<this.labels.all.length;e++)null!==this.labels.all[e].token&&this.gridLabels.removeText(this.labels.all[e].token);this.labels={rightNS:[],rightWE:[],bottomNS:[],bottomWE:[],all:[]}},displayLabelsFunc:function(){this.displayLabelCB&&this.displayLabelCB(this.labels.all);for(var e=0;e<this.labels.all.length;e++){var t=this.labels.all[e];if(t.display){if(t.offset||t.offsetFromScreenEdge||t.offsetFromAxis){var r=t.offset?t.offset.x:0,n=t.offset?t.offset.y:0;p.set(.5*this.viewer.SCREEN_WIDTH*(t._text.right.x-t._text.anchor.x),.5*this.viewer.SCREEN_HEIGHT*(t._text.right.y-t._text.anchor.y)),p.normalize(),f.set(-p.y,p.x),(t.isRight||p.y<0)&&p.negate(),!t.isRight&&p.y<0&&f.negate(),f.multiplyScalar(t.offsetFromAxis||0),p.multiplyScalar(t.offsetFromScreenEdge||0),t._text.anchor.x+=2*(r+f.x+p.x)/this.viewer.SCREEN_WIDTH,t._text.anchor.y+=2*(n+f.y+p.y)/this.viewer.SCREEN_HEIGHT,t._text.right.x+=2*(r+f.x+p.x)/this.viewer.SCREEN_WIDTH,t._text.right.y+=2*(n+f.y+p.y)/this.viewer.SCREEN_HEIGHT}t.size&&(t._text.size=t.size*i.getDevicePixelRatio()),t.color&&(t._text.color=t.color);var a=this.gridLabels.addText(t._text);t.token=a}}},computeIntersectionsForLabels:function(e,t,i,r,n,a,s){var o="zup"===this.worldOrientation._woName,l=o?"y":"x",h=o?"z":"y",c=this.labels.rightWE,d=this.labels.bottomWE,u="E",p="W";o?"y"===e&&(l="x",u="N",p="S"):"x"===e&&(l="z",u="N",p="S");var f=Math.round((t.min[e]-this.position[e])/this.gridUnit),g=Math.round((t.max[e]-this.position[e])/this.gridUnit);i<0?g=Math.min(f+1e3,g):f=Math.max(g-1e3,f);for(var m=this.tmpLine,v=f;v<=g;v++){m.start[e]=v*this.gridUnit+this.position[e],m.start[l]=-.5*this.size+this.position[l],m.start[h]=this.position[h],m.end[e]=m.start[e],m.end[l]=.5*this.size+this.position[l],m.end[h]=this.position[h];var y=r.planes[n].intersectLine(m),S=y&&a.project(y,s),_=!!y&&this.isInsideFrustum(S)&&this.isBottomRightEdge(S),x=_&&this.isRightEdgeFunc(S);if(_){var b,w=v*this.gridUnit+this.position[e],M=Math.round10(w,-2),C=M>=0;b=this.labelCB?this.labelCB(w,C?u:p):Math.abs(M)+" "+(C?u:p),this.addLabel(b,y,S,x?c:d,x,l,s)}}},removeMesh:function(){this.mesh&&this.viewer.sceneBackground.remove(this.mesh)},updateVisibility:function(){this.material&&(this.material.updatePDSFXUniform("displayPlane",this.displayPlane),this.material.updatePDSFXUniform("displayGrid",this.displayGrid),this.material.updatePDSFXUniform("gridFromBelow",this.displayGridFromBelow))},computeLabelPositions:function(){var e=this.viewer.currentViewpoint,t="zup"===this.worldOrientation._woName,r=this.viewer.cameraBackground;this.viewProjMatrix.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse);var n=this.tmpFrustum;n.setFromMatrix(this.viewProjMatrix);var a=n.getCorners(),s=this.tmpPoly1;s.addPoints([(new i.Vector3).copy(a[0]),(new i.Vector3).copy(a[1]),(new i.Vector3).copy(a[5]),(new i.Vector3).copy(a[4])]);var o=this.tmpPoly2;o.addPoints([(new i.Vector3).copy(a[1]),(new i.Vector3).copy(a[2]),(new i.Vector3).copy(a[6]),(new i.Vector3).copy(a[5])]);var l=new i.Plane,h=(new i.Vector3).copy(this.worldOrientation.upVector);h.multiplyScalar(-1),l.setFromNormalAndCoplanarPoint(h,this.position);var c,d,u,p,f=s.clipByPlane(l,new i.CGPolygon),g=o.clipByPlane(l,new i.CGPolygon),m=new i.Vector3,v=new i.Vector3,y=null,S=null;2===f.corner.length&&(m.subVectors(f.corner[1],f.corner[0]),m.normalize(),c=m.dot(this.worldOrientation.frontVector),d=m.dot(this.worldOrientation.rightVector),y=(new i.Box3).setFromPoints([f.corner[0],f.corner[1]])),2===g.corner.length&&(v.subVectors(g.corner[1],g.corner[0]),v.normalize(),u=v.dot(this.worldOrientation.frontVector),p=v.dot(this.worldOrientation.rightVector),S=(new i.Box3).setFromPoints([g.corner[0],g.corner[1]])),Math.abs(c)>.707?(y&&this.computeIntersectionsForLabels(t?"x":"z",y,c,n,2,e,r),S&&this.computeIntersectionsForLabels(t?"y":"x",S,p,n,0,e,r)):(y&&this.computeIntersectionsForLabels(t?"y":"x",y,d,n,2,e,r),S&&this.computeIntersectionsForLabels(t?"x":"z",S,u,n,0,e,r)),this.gridLabels.setFrustumCulled(!1)}})}),define("DS/Visualization/OccurrenceInterface",["UWA/Class","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS"],function(e,t,i){"use strict";function r(e){if(!e._occurrenceExplorer._occurrenceInterfaceList){var t=new Error("Use of expired OccurrenceInterface (= outside of callback function given to OccurrenceExplorer.explore())");throw t.expiredOccurrenceInterfaceError=!0,t}return e._occurrenceExplorer._occurrenceList[e._node][e._index].occurrence}return e.extend({init:function(e,t,i){this._node=e,this._index=t,this._occurrenceExplorer=i},getNbChildren:function(){return r(this).children.length},getParent:function(){var e=r(this);return this._occurrenceExplorer.getOccurrenceInterface(e.parent)},getChild:function(e){var t=r(this);return this._occurrenceExplorer.getOccurrenceInterface(t.children[e])},getChildren:function(){var e,t=r(this),i=[];for(e=0;e<t.children.length;e++)i.push(this._occurrenceExplorer.getOccurrenceInterface(t.children[e]));return i},traverse:function(e,t){var i=r(this);if(!e(this,t)){var n=0;for(n=0;n<i.children.length;n++)this._occurrenceExplorer.getOccurrenceInterface(i.children[n]).traverse(e,t)}},getNode:function(){return r(this).node},getMesh3D:function(){var e=r(this);return"Mesh3D"===e.node.getNodeType()?e.node:null},getColor:function(e){var t=r(this);if(this._tryOverridesUpdate(t),t.renderable){var n=t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.materialOverride,a=n&&n.getColor()||null,s=n&&n.getFullMaterial(),o=t.renderable.matApp&&t.renderable.matApp._getMaterialFromGLType(4,i.GeomTypeEnum.FACE),l=!1;!o&&t.renderable.material?(l=!0,!(o=t.renderable.material)||!e&&o.force||(o=null)):o&&e&&(o=null);var h=null;null===a&&!s||o&&o.color&&!o.overridable?h=o&&o.color&&(!l||o.force)&&o.color.clone():(h=s&&s.color&&s.color.clone(),null===a||h&&!s.overridable||(h=new i.Color(a)))}return h},getWorldMatrix:function(e){var t=r(this);return this._tryOverridesUpdate(t),e?(e.copy(t.matrix),e):t.matrix.clone()},getMatrix:function(e){var t=r(this);this._tryOverridesUpdate(t);var i=t.getLocalMatrix();return e?(e.copy(i),e):i.clone()},getMatrixInAxisSystem:function(e,t){var r=this.getWorldMatrix();if(!r)return null;var n=t||new i.Matrix4,a=new i.Matrix4;return a.getInverse(e),n.multiplyMatrices(a,r),n},getRenderableDescendants:function(){var e=r(this),t=[],i=this;return e.traverse(function(e){e.renderable&&t.push(i._occurrenceExplorer.getOccurrenceInterface(e))}),t},buildPathElement:function(e){var i=new t,n=r(this);return i.setFromOccurrence(n,null,e)?i:null},getVisibility:function(){var e=r(this);return this._tryOverridesUpdate(e),e._getVisible()},getBoundingSphere:function(e){return r(this).getBoundingSphere(e,!1)},getBoundingBox:function(e){return r(this).getBoundingBox(e)},isAParentOf:function(e){for(var t=e;t&&this!==t;)t=t.getParent();return t===this},findAncestor:function(e){for(var t=this.getParent(),i=null;t&&!i;)e(t)&&(i=t),t=t.getParent();return i},_tryOverridesUpdate:function(e){var t,i=this._occurrenceExplorer.viewer;if(e._getNeedOverridesUpdate()){for(t=e;t.parent;)t=t.parent;i=i||e.scene3js&&e.scene3js.viewer,t.node._tryOverridesUpdate(i)}}})}),define("DS/Visualization/OccurrenceExplorer",["UWA/Class","DS/Visualization/OccurrenceInterface","DS/Visualization/Node3D","DS/Visualization/OccurrenceInterfaceFactory"],function(e,t,i,r){"use strict";var n=e.extend({init:function(e){this.viewer=e},explore:function(e){e&&this._exploreInternal(null,e)},exploreQuick:function(e,t){e&&t&&this._exploreInternal(e,t)},_exploreInternal:function(e,t){var n=new a,s=new r(n,this.viewer);i._LockNodeHierarchy();try{if(e)t(s.getOccurrenceItf(e),s);else t(s);i._UnlockNodeHierarchy(),n.cleanUp()}catch(e){throw i._UnlockNodeHierarchy(),n.cleanUp(),e}}}),a=function(){this._occurrenceList=[],this._occurrenceInterfaceList=[]};return a.prototype.cleanUp=function(){this._occurrenceList=null,this._occurrenceInterfaceList=null},a.prototype.getOccurrenceInterface=function(e){if(!e||!this._occurrenceList)return null;this._occurrenceList[e.node.id]||(this._occurrenceList[e.node.id]=[]);var i,r,n=this._occurrenceList[e.node.id],a=-1;for(r=0;a<0&&r<n.length;r++)n[r].occurrence===e&&(a=n[r].index);return a<0?(i=new t(e.node.id,n.length,this),n.push({occurrence:e,index:this._occurrenceInterfaceList.length}),this._occurrenceInterfaceList.push(i)):i=this._occurrenceInterfaceList[a],i},n}),define("DS/Visualization/ViewManager",["UWA/Class","DS/CoreEvents/ModelEvents","DS/CoreEvents/Events","DS/CSICommandBinder/CSICommandBinder","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/Visualization/Filters/MaterialToUseFilter"],function(e,t,i,r,n,a,s,o){"use strict";var l={},h={},c={},d={},u=new Map,p={},f=null;function g(e,t){e.viewer=t.viewer,e.views=t.views,e._updatePlane=t._updatePlane,e._sceneEnvRootForLights=t._sceneEnvRootForLights,e._sceneEnvRootForAmbiance=t._sceneEnvRootForAmbiance,e._sceneEnvRootForTransientHighlight=t._sceneEnvRootForTransientHighlight,e._viewpointMap=t._viewpointMap}i.subscribe({event:"/VISU/VIEWER/VIEWER_DISPOSED"},function(e){var t=e.parameters.viewer;u.delete(t),f&&f.viewer===t&&(u.delete(p),f=null,u.forEach(function(e,t,i){null===f&&(f=e)}),f&&u.set(p,f))});var m=e.extend({init:function(e){if(e=e||p,f||(f=this),f.viewer!==p&&e===p)u.set(e,this),g(this,f);else if(f.viewer===p&&e!==p)f.viewer=e,u.set(e,this),g(this,f);else if(u.has(e)){g(this,u.get(e))}else u.set(e,this),this.viewer=e,this.views={},this._updatePlane=!0,this._sceneEnvRootForLights=new a("3DSyncSceneEnvRootForLights"),this._sceneEnvRootForAmbiance=new a("3DSyncSceneEnvRootForAmbiance"),this._sceneEnvRootForAmbiance._setIsAlwaysInForeground(!0),this._sceneEnvRootForTransientHighlight=new a("3DSyncSceneEnvRootForTransientHighlight"),this._sceneEnvRootForTransientHighlight.setPickable(s.PICKTHROUGH),this._sceneEnvRootForTransientHighlight.exludeFromBounding(!0),this._sceneEnvRootForTransientHighlight.setVisuFilters({_materialToUseFilter:new o(n.MaterialToUse.highlightMaterial)}),this._viewpointMap=new Map;return this},_executeParameter:function(e){e.setStaticMaterials(l),e.setDefaultMaterials(c),e.setTemporaryBodies(d),e.execute(this),this.viewer._modelEvent.publish({event:"VisuAnswer",context:this}),this.viewer.render({updateInfinitePlane:this._updatePlane})},clear:function(){for(var e in this.views)delete this.views[e]},addView:function(e,t){var i=this.views[e];return i||(i=t,this.views[e]=i),i},removeView:function(e){var t=this.views[e];return t&&(t=null,this.views[e]=t),t},getView:function(e){var t=this.views[e];return t||(t=new a,this.viewer.addNode(t),this.views[e]=t),t},getKey:function(e){for(var t in this.views)if(e===this.views[t])return t;return null},onVisuAnswer:function(e){return this.viewer._modelEvent.subscribe({event:"VisuAnswer"},e)},unsubscribe:function(e){this.viewer._modelEvent.unsubscribe(e)},_publishVisuAnswer:function(e){e&&this.viewer._modelEvent.publish({event:"VisuAnswer",context:this}),this.viewer.render({updateInfinitePlane:this._updatePlane,ekTrace:!0})},setStaticMaterial:function(e,t){return!(""===e||!t)&&(l[e]=t,!0)},getStaticMaterial:function(e){return l[e]},setStaticLook:function(e,t){return!(""===e||!t)&&(h[e]=t,!0)},getStaticLook:function(e){return h[e]},setDefaultMaterials:function(e){c=e},getDefaultMaterials:function(){return c},setTemporaryBodies:function(e){d=e||{}},updatePlaneOnViewMessage:function(e){this._updatePlane=e,u.get(this.viewer).updatePlaneOnViewMessage(e)}});return UWA.namespace("THREEDS/ViewManager",m)}),define("DS/Visualization/CSIViewer",["DS/Visualization/WebGLV6Viewer","DS/Visualization/ViewManager","DS/SceneGraphOverrides/CSIOverrideManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/ZModeFilter"],function(e,t,i,r,n){"use strict";var a=e.extend({init:function(e){return window.newMaterialInheritance=!0,this._parent(e),this.viewManager=new t(this),this._csiViewModelManager=e&&e.CSIViewModelManager?e.CSIViewModelManager:null,this._csiOverrideManager=new i(this),this._scissorOutlineNodes=null,this},setCSIViewModelManager:function(e){this._csiViewModelManager=e},swapVisibleSpace:function(){if(e.prototype.swapVisibleSpace.call(this),!this.visibleSpace&&this._csiViewModelManager){var t=this;this._csiViewModelManager.forceSend3DNoShowData({onAnswer:function(){t.render()}})}},forceZDisplay:function(e){e&&!this.renderer.renderer._GlobalZModeFilter?(this.renderer.renderer._GlobalZModeFilter=new n(!0),this.renderer.resetGSSOCache()):!e&&this.renderer.renderer._GlobalZModeFilter&&(this.renderer.renderer._GlobalZModeFilter=null,this.renderer.resetGSSOCache())},onVisuAnswer:function(e){return this.viewManager.onVisuAnswer(e)},setStaticMaterial:function(e,t){console.warn("setStaticMaterial method is deprecated. Use setStaticLook instead."),this.viewManager.setStaticMaterial(e,t)},setStaticLook:function(e,t){this.viewManager.setStaticLook(e,t)},setDefaultMaterials:function(e){this.viewManager.setDefaultMaterials(e)},setAlternativeEditDisplay:function(e){this.viewManager.setTemporaryBodies(e)},empty:function(e,t){this._parent(e,t),this.viewManager.clear()},updatePlaneOnViewMessage:function(e){this.viewManager.updatePlaneOnViewMessage(e)},_getCSIOverrideManager:function(){return this._csiOverrideManager},getVisuContextViewMode:function(){var e=this.getVisuShadingMode();if(!e||!r.__ViewModeType__||!r.__ViewAppearanceMap__)return null;for(var t=this.getCustomMaterialModeParameters(),i={mask:r.__ViewModeType__.VIEW_APPEARANCE,appearanceName:null,shininess:t.shininess,opacity:t.opacity,color:t.color.toArray(),useObjectColor:t.colorFromGAS},n=this.renderer.renderer._defaultAppearanceType,a=Object.keys(r.__ViewAppearanceMap__),s=0;s<a.length;s++)if(r.__ViewAppearanceMap__[a[s]]===n){i.appearanceName=a[s];break}return i.appearanceName?(e.includes("Wireframe")?i.mask|=r.__ViewModeType__.VIEW_EDGE:e.includes("Illustration")?i.mask|=r.__ViewModeType__.VIEW_HRD:(i.mask|=r.__ViewModeType__.VIEW_MESH,this.getMaterialMode()&&(i.mask|=r.__ViewModeType__.VIEW_MATERIAL),e.includes("Edges")&&(i.mask|=r.__ViewModeType__.VIEW_EDGE,e.includes("NoSmoothEdges")?i.mask|=r.__ViewModeType__.VIEW_WITHOUT_SMOOTH_EDGE:e.includes("HalfSmoothEdges")&&(i.mask|=r.__ViewModeType__.VIEW_WITH_HALF_SMOOTH_EDGE),e.includes("HiddenEdges")&&(i.mask|=r.__ViewModeType__.VIEW_HIDDEN_EDGE))),this.getAxisFilter()||(i.mask|=r.__ViewModeType__.VIEW_WITHOUT_AXIS),this.getPointsFilter()||(i.mask|=r.__ViewModeType__.VIEW_WITHOUT_POINTS),this.getLinesFilter()||(i.mask|=r.__ViewModeType__.VIEW_WITHOUT_WIRES),this.getVerticesFilter()||(i.mask|=r.__ViewModeType__.VIEW_WITHOUT_VERTEX),this._getVisuOutlineMode()&&(i.mask|=r.__ViewModeType__.VIEW_OUTLINE),i):null},onVisuContextViewModeModified:function(e){if(e){var t=[];return t.push(this.onAxisFilterChange(e)),t.push(this.onPlanesFilterChange(e)),t.push(this.onLinesFilterChange(e)),t.push(this.onPointsFilterChange(e)),t.push(this.onVerticesFilterChange(e)),t.push(this.onVisuAppearanceModeChange(e)),t.push(this.onCustomMaterialModeParametersChange(e)),t.push(this._onVisuOutlineModeChange(e)),t.push(this.onVisuShadingModeChange(e)),t}},_refreshPLMViewMode:function(e){return this._csiOverrideManager.refreshPLMViewMode(e)},_updatePLMViewMode:function(e,t){return this._csiOverrideManager.updatePLMViewMode(e,t)},_setViewpointPLMViewMode:function(e,t){this._csiOverrideManager.setViewpointPLMViewMode(e,t)},_setNodePLMViewMode:function(e,t,i){this._csiOverrideManager.setNodePLMViewMode(e,t,i)},_setOutlineNode:function(e,t,i){if(t||this._scissorOutlineNodes){this._scissorOutlineNodes||(this._scissorOutlineNodes=new WeakMap);var r=this._scissorOutlineNodes.get(e);r&&e.removeChild(r),t?(i&&e.addChild(i),this._scissorOutlineNodes.set(e,i)):this._scissorOutlineNodes.delete(e)}}});return UWA.namespace("THREEDS/CSIViewer",a)}),define("DS/Visualization/LightNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i,r){this._parent(i),this.light3js=void 0!==t?t:new e.AmbientLight,t=this.createRenderable(),this._matrix=(new e.Matrix4).setPosition(new e.Vector3(0,0,1)),this._intensity=t.intensity,this._color=t.color,this._attachedToVpt=!!r;var n=this._occurrences[0];return n.renderable=t,n.renderable.name=this.name,n.renderable._occurrence=n,this},createRenderable:function(){var e=this.light3js.clone();return e.matrixAutoUpdate=!1,e.visible=this.light3js.visible,e.matrixWorldNeedsUpdate=!1,e.castShadow=this.light3js.castShadow,e.shadowCameraLeft=this.light3js.shadowCameraLeft,e.shadowCameraRight=this.light3js.shadowCameraRight,e.shadowCameraTop=this.light3js.shadowCameraTop,e.shadowCameraBottom=this.light3js.shadowCameraBottom,e.shadowCameraNear=this.light3js.shadowCameraNear,e.shadowCameraFar=this.light3js.shadowCameraFar,e.shadowBias=this.light3js.shadowBias,e.shadowDarkness=this.light3js.shadowDarkness,e.shadowMapWidth=this.light3js.shadowMapWidth,e.shadowMapHeight=this.light3js.shadowMapHeight,e.shadowCameraVisible=this.light3js.shadowCameraVisible,e},add:function(){return!1},updateShadowMap:function(e){var t,i;for(void 0===e&&(e=!0),null!==this.light3js&&(this.light3js.updateShadowMap=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.updateShadowMap=e)},attachToViewpoint:function(e){this._attachedToVpt=e},setIntensity:function(e){this._intensity=void 0===e?1:e,this._updateIntensity()},_updateIntensity:function(){var e,t;for(this.light3js.intensity=this._intensity,e=this._occurrences.length,t=0;t<e;t++)this._occurrences[t].renderable.intensity=this._intensity},setColor:function(t){t instanceof e.Color?this._color=t:this._color=new e.Color(hex),this._updateColor()},_updateColor:function(){var e,t;for(this.light3js.color=this._color,e=this._occurrences.length,t=0;t<e;t++)this._occurrences[t].renderable.color=this._color},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"LightNode3D"}});return UWA.namespace("THREEDS/Nodes/Light",i)}),define("Visualization/LightNode3D",["DS/Visualization/LightNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/LightNode3D"),e}),define("DS/Visualization/ParticlesNode3D",["DS/Mesh/Mesh","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t,i){"use strict";var r=i.extend({init:function(e,i){this._parent(i);var r=e.material?e.material:null;t.disableJHGDev||(this.material=r),this.particles3js=void 0!==e?e:new t.ParticleSystem;var n=t.convertParticleSystemToBufferGeometryDS(this.particles3js.geometry);this.particles3js=new t.Mesh(n,r),this.particles3js.frustumCulled=!1,e=this.createRenderable();var a=this._occurrences[0];return a.renderable=e,a.renderable.name=this.name,a.renderable._occurrence=a,this.hasExplicitBE=!0,this.explicitBSphere=null,this.explicitBBox=null,void 0!==this.particles3js.geometry.boundingSphere&&(this.explicitBSphere=this.particles3js.geometry.boundingSphere.clone()),this},createRenderable:function(){var e=this.particles3js.clone();return e.matrixAutoUpdate=!1,e.matrixWorldNeedsUpdate=!1,e.visible=this.particles3js.visible,e.pickable=this.particles3js.pickable,e.noPickThrough=this.particles3js.noPickThrough,e.renderDepth=this.particles3js.renderDepth,e.frustumCulled=this.particles3js.frustumCulled,e.enableNormalDepth=!1,e},add:function(){return!1},setPickable:function(t){var i,r;for("boolean"==typeof t&&console.log("boolean is DEPRECATED in setPickable() method.\n Use ENUM Mesh"),null!==this.particles3js&&(this.particles3js.pickable=t===e.PICKABLE,this.particles3js.noPickThrough=t!==e.PICKTHROUGH),i=0;i<this._occurrences.length;i++)null!==(r=this._occurrences[i]).renderable&&(r.renderable.pickable=this.particles3js.pickable,r.renderable.noPickThrough=this.particles3js.noPickThrough,r.renderable._flagAsGSSOInvalidated())},getNodeType:function(){return"ParticlesNode3D"}});return UWA.namespace("THREEDS/Nodes/Particles",r)}),define("Visualization/ParticlesNode3D",["DS/Visualization/ParticlesNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ParticlesNode3D"),e}),define("DS/Visualization/AnnotationServices",["UWA/Class","DS/Visualization/Utils","DS/Formats/CGRFile","DS/Visualization/ModelLoader","DS/Visualization/ProxyAbstraction","DS/ZipJS/LoaderInflate"],function(e,t,i,r,n,a){"use strict";var s=null,o=e.extend({init:function(){return null!==s?(this.loader=s.loader,this.modelLoader=s.modelLoader,this):(this.loader=new i,this.modelLoader=new r,s=this,this)},cleanAll:function(){this.loader=null,this.modelLoader=null},getApplicativeContainerNew:function(e,i,r,a){var s=this.modelLoader.buildPath(e),o=new n;t.setProxyFromSpec(s,o);var l=s.serverurl?s.serverurl:"";l+=s.filename?s.filename:"";var h,c=this,d=(h=i,function(e){c.loader.setFileBuffer(new Uint8Array(e));var t=c.loader.getApplicativeContainer(h);r(t)});o.executeGetHttpRequest(l,"arraybuffer",null,d,a)},processFTABuffer:function(e){if(!e)return null;var t=e.buffer.subarray(e.options.offset,e.options.compressed+e.options.offset);if(t.length<=2)return null;if(120!==t[0])return null;if(218!==t[1])return null;var i=t.subarray(2,e.options.compressed);return function(e){var t,i,r,n,a,s;for(t="",r=e.length,i=0;i<r;)switch((n=e[i++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(n);break;case 12:case 13:a=e[i++],t+=String.fromCharCode((31&n)<<6|63&a);break;case 14:a=e[i++],s=e[i++],t+=String.fromCharCode((15&n)<<12|(63&a)<<6|(63&s)<<0)}return t}((new a).Inflate(i))},getFTAContainer:function(e,t,i,r){var n=this;this.getApplicativeContainerNew(e,t,function(e){var t=n.processFTABuffer(e);t?i({xml:t}):i()},r)},openSceneGraph:function(e){return this.loader.openSceneGraph(e)}});return UWA.namespace("THREEDS/AnnotationServices",o)}),define("Visualization/AnnotationServices",["DS/Visualization/AnnotationServices","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/AnnotationServices"),e});