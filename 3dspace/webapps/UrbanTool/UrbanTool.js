define("DS/UrbanTool/FocusManager",["DS/XCityTools/EventDispatcher"],function(e){"use strict";var t=null;function n(){if(null!==t)throw new Error("Cannot instantiate more than one MySingleton, use MySingleton.getInstance()");this.initialize()}var i=function(e){t.hasFocus=!0,t.renderer&&t.renderer.allowRendering(!0)},r=function(e){e.target==window&&(document.hasFocus()||top.document.hasFocus()||(t.hasFocus=!1,t.renderer&&t.renderer.allowRendering(!1)))},o=function(e){var n="visible"==document.visibilityState;t.hasFocus=n,t.renderer&&t.renderer.allowRendering(n)},a=function(){t.renderer&&t.renderer.render()};return n.getInstance=function(){return null===t&&(t=new n),t},n.prototype={initialize:function(){this.hasFocus=!0,this._enabled=!1},setRenderer:function(e){this.renderer=e},activate:function(){this._enabled=!0,window.addEventListener("focus",i),window.addEventListener("blur",r),window.addEventListener("visibilitychange",o),window.addEventListener("resize",a),e.publish(e.eventsList.focusManager,!0)},deactivate:function(){this._enabled=!1,window.removeEventListener("focus",i),window.removeEventListener("blur",r),window.removeEventListener("visibilitychange",o),window.removeEventListener("resize",a),this.hasFocus=!0,this.renderer&&this.renderer.allowRendering(!0),e.publish(e.eventsList.focusManager,!1)},enabled:function(){return this._enabled}},n.getInstance()}),define("DS/UrbanTool/Url",["DS/Visualization/ThreeJS_DS","UWA/Class"],function(e){"use strict";return UWA.Class.extend({init:function(e){if(this.arguments=new Array,this.options=new Array,-1!==location.href.indexOf("?")){this.url=e.substring(0,location.href.indexOf("?"));for(var t=e.substring(location.href.indexOf("?")+1).split("&"),n=0;n<t.length;n++){var i=null,r=t[n],o=!1;-1!==t[n].indexOf("=")&&(r=t[n].substring(0,t[n].indexOf("=")),i=t[n].substring(t[n].indexOf("=")+1));var a=r.split(".");if(a.length>1&&(o=!0),o)void 0===(s=this.arguments[a[0]])?(this.arguments[a[0]]={value:a[0],options:new Object},this.arguments[a[0]].options[a[1]]=i):Array.isArray(s)?s[s.length-1].options[a[1]]=i:this.arguments[a[0]].options[a[1]]=i;else if(r,void 0!==this.arguments[r]){var s=this.arguments[r];if(Array.isArray(s))s.push({value:i,options:new Object});else{var u=[];u.push(s),u.push({value:i,options:new Object}),this.arguments[r]=u}}else this.arguments[r]={value:i,options:new Object}}}else this.url=e;this.updateSlots=[]},getArgument:function(e){return this.arguments[e]},hasArgument:function(e){return void 0!==this.arguments[e]},setArgument:function(e,t){this.arguments[e]=t},removeArgument:function(e){delete this.arguments[e]},apply:function(e,t){var n=this.arguments[e];void 0!==n&&(Array.isArray(n)?n.map(t):t(n))},updateUrl:function(e){for(var t=0;t<this.updateSlots.length;t++)this.updateSlots[t](this);var n="",i=0,r=void 0,o=function(e){if(null!==e&&(void 0===e.value&&void 0!==e.options||(i>0&&(n+="&"),n+=r,void 0!==e.value?n+="="+e.value:void 0===e.options&&(n+="="+e),i++)),void 0!==e.options)for(var t in e.options)i>0&&(n+="&"),n+=r+"."+t+"="+e.options[t],i++};for(r in this.arguments)if(this.arguments.hasOwnProperty(r)){0===i&&(n+="?");var a=this.arguments[r];Array.isArray(a)?a.map(o):o(a)}window.history.replaceState("","UrbanWebGL",this.url+n)},getParameters:function(){for(var e=0;e<this.updateSlots.length;e++)this.updateSlots[e](this);var t={},n=void 0,i=function(e){if(void 0!==e.value?t[n]=e.value:void 0===e.options&&(t[n]=e),void 0!==e.options)for(var i in t[n]={},e.options)t[n][i]=e.options[i]};for(n in this.arguments)if(this.arguments.hasOwnProperty(n)){var r=this.arguments[n];Array.isArray(r)?r.map(i):i(r)}return t},setParameters:function(e){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];if(n instanceof Object)for(var i in this.arguments[t]={value:n.value,options:{}},n)"value"!==i&&(this.arguments[t].options[i]=n[i]);else this.arguments[t]={value:n}}return this}})}),define("DS/UrbanTool/DrawingManipulatorTool",["UWA/Class","UWA/Core"],function(e,t){"use strict";var n={polyline:"LineString",polygon:"polygon",building:"polygon",house:"polygon",point:"point"};return e.extend({init:function(e){this.type="drawingManipulator",this.creationCursor=null,this.additionCursor=null,this.suppressionCursor=null,this.segmentRemovalCursor=null,this.creationCursorHotSpot=null,this.additionCursorHotSpot=null,this.suppressionCursorHotSpot=null,this.segmentRemovalCursorHotSpot=null,this.parentDiv=e.frmWindow.getUIFrame(),this.measureType="polyline",this.defaultContext={Line:{id:"drawing_line_id",name:"Drawed Line"},Folder:{id:"subTemporaryFolder",temporary:!0,name:"Sub Temporary Folder"}},this.setCurrentContext(this.defaultContext)},setCurrentContext:function(e){return this.context=this._contextCopyOf(this.defaultContext),Utils.is(e)&&(Utils.is(e.Line)&&(this.context.Line={id:e.Line.id||this.defaultContext.Line.id,name:e.Line.name||this.defaultContext.Line.name,nameBase:e.Line.nameBase||this.defaultContext.Line.nameBase}),Utils.is(e.Folder)&&(this.context.Folder={id:e.Folder.id||this.defaultContext.Folder.id,name:e.Folder.name||this.defaultContext.Folder.name},this.context.Folder.temporary=Utils.is(e.Folder.temporary)?e.Folder.temporary:this.defaultContext.Folder.temporary)),this.context},_contextCopyOf:function(e){return{Line:{id:e.Line.id,name:e.Line.name,nameBase:e.Line.nameBase},Folder:{id:e.Folder.id,name:e.Folder.name}}},getCurrentContext:function(){return this.context},getGeoJSONType:function(e){return n[this.measureType]},isPoint:function(){return"point"===this.measureType},isPolygon:function(){return"polygon"===this.getGeoJSONType()},isFlat:function(){return this.isPolygon()},isRectangle:function(){return this.isHouse()},isSquare:function(){return!1},isBuilding:function(){return"building"===this.measureType},isHouse:function(){return"house"===this.measureType},isPolyline:function(){return"polyline"===this.measureType},onStart:function(e){return!0},onFinish:function(e){return!0},onAddAnchor:function(e,t){return e},onRemoveAnchor:function(e,t){return!0},onCreateLoop:function(e){return!0},onBreakLoop:function(e){return!0},onBeginPreactivateAnchor:function(e,t){return!0},onEndPreactivateAnchor:function(e,t){return!0},onManipulateAnchor:function(e,t){return!0},onUpdate:function(e,t){return!0},onCameraUpdate:function(e){return!0},onDestroy:function(e,t){return!0},onItemCreated:function(e){},isRobotEnabled:function(){return!1},hasVerticalHandle:function(){return!0}})}),define("DS/UrbanTool/SplashScreen",["UWA/Core","UWA/Class","UWA/Class/Events","DS/WebappsUtils/WebappsUtils","DS/xCityBasicUtils/Utils","DS/UIKIT/Mask","css!DS/UIKIT/UIKIT.css"],function(e,t,n,i,r,o){"use strict";var a=null,s=t.extend(n,{init:function(){this._counter=0,this._ready=!0,this.start()},start:function(){if(this._ready){if(this._ready=!1,this._counter=1,r.is(widget)&&r.is(widget.body)&&r.is(widget.body.hasClassName))return o.mask(widget.body),void widget.body.getElement(".mask").setStyle("z-index","100000");var e=setInterval(function(){r.is(widget)&&r.is(widget.body)&&r.is(widget.body.hasClassName)&&(clearInterval(e),o.mask(widget.body),widget.body.getElement(".mask").setStyle("z-index","100000"))},100)}},end:function(){r.is(widget)&&r.is(widget.body)&&o.unmask(widget.body),this.dispatchEvent("onPageReady",!0),this._ready=!0},loading:function(){0===this._counter?this.start():this._counter++},ready:function(){this._counter--,this._counter<0&&(this._counter=0),0===this._counter&&this.end()},isReady:function(){return this._ready}});return s.getInstance=function(){return null===a&&(a=new s),a},s.getInstance()}),define("DS/UrbanTool/Utils",["UWA/Data","DS/WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/XCityTools/Debug","DS/XCityTools/Downloader"],function(e,t,n,i,r,o,a){"use strict";var s=null;function u(){if(null!==s)throw new Error("Cannot instantiate more than one MySingleton, use MySingleton.getInstance()");this.initialize()}return u.getInstance=function(){return null===s&&(s=new u),s},u.prototype={initialize:function(){window.Utils=this,this.nbImages=10,this.conccurentTextureLoading=0,this.images=new Array(this.nbImages),this.current=0;for(var e=0;e<this.nbImages;e++)this.images[e]=new Image;this.refX=new n.Vector3(0,0,-1),this.refY=new n.Vector3(-1,0,0),this.refZ=new n.Vector3(0,1,0),this.right=new n.Vector3(-1,0,0),this.zero=new n.Vector3,this.zeroQuat=new n.Quaternion,this.vertical=new n.Vector3(0,0,1),this.north=new n.Vector3(0,1,0)},loadTextureOld:function(e,t,n,i){a.download(n,{image:!0},void 0!==i?i:1,function(e,t,n,i){i(t,e,n)},void 0,t)},loadTextureCube:function(e,t,n){a.download(n,{image:!0},1,function(e,t,n,i){i(t,e,n)},void 0,t)},_downloadOrderedTree:function(e,t,n,i,r){var s=this,u=!1,l=void 0;void 0===r?(u=!0,l={all:e.length,current:0,success:0},r={}):(l=r.state).all+=e.length;var d=new Array(e.length);r.result=d;var h=function(){if(l.current===l.all){var e=[],t=function(e,n){for(var i=0;i<e.result.length;i++)e.result[i]&&(e.result[i].link&&t(e.result[i],n),n.push(e.result[i].data))};t(r,e),n&&n(e)}},c=function(e,i,r,o){if(l.current++,t){var a=t(e,i);a&&(d[r]=a,a.state=l,a.link&&s._downloadOrderedTree(a.link,t,u?h:n,o,a))}u?h():n()};!function(e){for(var t=function(t,n,i,r){var o;t&&(d[r]=n,o=e[r].url.slice(0,e[r].url.lastIndexOf("/"))+"/",l.success++),c(n,t,r,o)},n=0;n<e.length;n++){var r=e[n].url;r?("http"!==r.substring(0,4)&&i&&(e[n].url=i+r),o.log("Load: ",i,r),a.download(e[n].url,{},1,t,void 0,n)):(d[n]=e[n],l.success++,c(e[n],void 0,n,i))}}(e)},downloadOrderedTree:function(e,t,n,i){this._downloadOrderedTree(e,t,n,i)},download:function(e,t,n,i,r){a.download(i,{responseType:e},void 0!==r?r:1,function(e,t,n,i){i(t,e,n)},void 0,n)},template:function(e){var t=new RegExp("(<%)[^]+?($|%>)","g"),n=new RegExp("(<=)[^]+?($|(=>))","g"),i="var _html = '";i='var _html = "'+(i=(i=(e=e.toString()).replace(n,function(e){return'"+\n'+e.replace("<=","").replace("=>","")+' +\n"'})).replace(t,function(e){return'";\n'+e.replace("<%","").replace("%>","")+'\n _html +="'})+'"\n return _html;');var r=void 0;try{r=new Function("attr",i)}catch(e){throw e.code=i,e}return r},toDeg:function(e){return 57.29577951308232*e},toRad:function(e){return.017453292519943295*e},mercatorPosFromQuad:function(e,t,i,r){var o=e.worldSize*(t.X+i*t.Size)-e.halfWorldSize,a=e.worldSize*(t.Y+r*t.Size)-e.halfWorldSize;return new n.Vector2(o,a)},latlonFromQuad:function(e,t,n,i){e.worldSize,t.X,t.Size,e.halfWorldSize,e.worldSize,t.Y,t.Size,e.halfWorldSize},getColorGradient:function(e,t){var i,r,o,a,s,u=void 0===t.min?0:t.min,l=void 0===t.max?1:t.max;e=Math.max(0,Math.min((e-u)/l,1));var d=void 0===t.minHue?0:t.minHue,h=void 0===t.maxHue?360:t.maxHue,c=void 0===t.sat?1:t.sat,f=(e*(h-d)+d)/360;function m(e,t,n){return n<0?n++:n>1&&n--,(n=255*(n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e)|0)?(n=n.toString(16)).length>1?n:"0"+n:"00"}return 0===c?i=r=o=(e=127)?(e=e.toString(16)).length>1?e:"0"+e:"00":(i=m(a=1-(s=.5+c-.5*c),s,f+1/3),r=m(a,s,f),o=m(a,s,f-1/3)),new n.Color("#"+i+r+o)},toColor:function(e,t,n,i){return this.getColorGradient(e,{minHue:t,maxHue:n,sat:i}).getHex()},transitionEndEventName:function(){var e,t={transition:"transitionend",OTransition:"otransitionend",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(e in t)if(void 0!==t.hasOwnProperty(e))return t[e]},is:function(e){return UWA.is(e)},cleandot:function(e,t){var n=e.clone().dot(t);return n=Math.max(n,-1),n=Math.min(1,n)},displayVector:function(e){if(!this.is(e))return null;var t=" x: "+e.x.toFixed(3)+" y: "+e.y.toFixed(3);return this.is(e.z)&&(t+=" z: "+e.z.toFixed(3)),this.is(e.w)&&(t+=" w: "+e.w.toFixed(3))," "+t+" "},displayMatrix:function(e){if(!this.is(e)||!this.is(e.elements))return null;var t=new n.Vector4(e.elements[12],e.elements[13],e.elements[14],e.elements[15]);return" "+this.displayVector(t)+" "},getAngleBetween:function(e,t){if(this.is(this.zero)||(this.zero=new n.Vector3),e.equals(this.zero)||t.equals(this.zero))return null;var i=this.cleandot(e.normalize(),t.normalize());return Math.acos(i)},endsWith:function(e,t){return-1!==e.indexOf(t,e.length-t.length)},dataURItoBlob:function(e){for(var t=e.split(",")[0].split(":")[1].split(";")[0],n=atob(e.split(",")[1]),i=new Uint8Array(n.length),r=0;r<n.length;r++)i[r]=n.charCodeAt(r);return new Blob([i.buffer],{type:t})},getQuaternionBetween:function(e,t){var i=new n.Quaternion,r=this.getAngleBetween(e,t);if(0===r)return i;var o=e.normalize().clone().cross(t.normalize()).normalize();if(o.equals(this.zero))return null;i.setFromAxisAngle(o,r),i.normalize();var a=e.clone().normalize().applyQuaternion(i).normalize(),s=t.clone().normalize();return a.equals(s),i},getNorthAngle:function(e,t){var n=e.clone().add(t);n.z=0,n.normalize();var i=n.x<0?1:-1,r=this.cleandot(n,this.north);return Math.acos(r)*i},getQuaternion:function(e,t){var n=e.clone(),i=e.clone().multiplyScalar(2);return this.getQuaternion2(n,i,t)},equals:function(e,t){var i=Number(e.x.toFixed(4)),r=Number(e.y.toFixed(4)),o=Number(e.y.toFixed(4));if(this.is(e.w))var a=Number(e.w.toFixed(4)),s=new n.Quaternion(i,r,o,a);else s=new n.Vector3(i,r,o);i=Number(t.x.toFixed(4)),r=Number(t.y.toFixed(4)),o=Number(t.y.toFixed(4));if(this.is(t.w)){a=Number(t.w.toFixed(4));var u=new n.Quaternion(i,r,o,a)}else u=new n.Vector3(i,r,o);return s.equals(u)},quatFromAngles:function(e,t,i){var r=new n.Vector3(0,0,-1),o=new n.Vector3(1,0,0),a=new n.Vector3(0,-1,0),s=new n.Quaternion,u=new n.Quaternion,l=new n.Quaternion;s.setFromAxisAngle(r,e),u.setFromAxisAngle(o,t),l.setFromAxisAngle(a,i);var d=s.multiply(u);return d=d.multiply(l)},getQuaternionFromEye:function(e){if(e.normalize(),e.equals(this.refX))return new n.Quaternion;var t=this.getNorthAngle(e,new n.Vector3),i=new n.Quaternion;i.setFromAxisAngle(this.vertical,t);var r=this.refX.clone().applyQuaternion(i),o=this.getQuaternionBetween(r,e);o.multiply(i),r=this.refX.clone().applyQuaternion(o);this.refZ.clone().applyQuaternion(o);return o},getQuaternion2:function(e,t,i){var r=new n.Matrix4;r.lookAt(e,t,i);var o=new n.Quaternion;return o.setFromRotationMatrix(r),o},getUpFromCameraEye:function(e){var t=e.clone().normalize(),i=t.clone();if(i.z=0,0!==t.x||0!==t.y){i.normalize();var r=new n.Quaternion;return r.setFromAxisAngle(this.vertical,.5*-Math.PI),(i=i.applyQuaternion(r)).normalize(),i.cross(t).normalize()}return this.refZ.clone()},isOut:function(e,t){if(!this.is(e))return!0;var n=e.clone().sub(t.shiftedPosition),i=n.length();if(n.x>t.worldSize)return!0;if(t.sphericalMode){if(n.length()>1.1*t.earthRadius)return!0}else{if(n.x<0)return!0;if(n.y>t.worldSize)return!0;if(n.y<0)return!0;if(i>2*t.worldSize)return!0}return!1},clone:function(e){return JSON.parse(JSON.stringify(e))},toDownloadFile:function(e,t){var n="downloadFile",i=document.getElementById(n);this.is(i)?URL.revokeObjectURL(i.href):((i=document.createElement("a")).id=n,i.innerHTML="Download File",document.body.appendChild(i)),i.href=window.URL.createObjectURL(t),i.download=e,i.style.display="none",i.click()},areSamePosition:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z},offsetVerticesXY:function(e,t){var i=[];i.push(new n.Vector3(e[0].x-t.x,e[0].y-t.y,e[0].z));for(var r=e.length-1;r>=0;r--)i.push(new n.Vector3(e[r].x-t.x,e[r].y-t.y,e[r].z));return i},getBuildingGISPropertiesMap:function(){return{floors:"floorsNumber",height:"HEIGHT",altitude:"ALTITUDE",floorHeight:"floorHeight",groundFloorHeight:"groundFloorHeight",roofShape:"roofShape",roofHeight:"ROOFHGT",roofAngle:"ROOFANGLE"}}},u.getInstance()}),define("DS/UrbanTool/MeasureDistance",["DS/UrbanTool/DrawingManipulatorTool","UWA/Core","i18n!DS/UrbanTool/assets/nls/measureDistance"],function(e,t,n){"use strict";return e.extend({init:function(e,t){this._parent(e),this.urban=e,this.type=t,"distance"===t?this.measureType="polyline":"surface"===t?this.measureType="polygon":console.warn("unknown measuretool type (distance / surface)"),this.parentDiv=this.urban.frmWindow.getUIFrame(),this.textSegment=n.get("3DXCity.MeasureDistance.UI.Text.Segment"),this.textPolyline=n.get("3DXCity.MeasureDistance.UI.Text.Polyline"),this.textPolygon=n.get("3DXCity.MeasureDistance.UI.Text.Polygon"),this.textArea=n.get("3DXCity.MeasureDistance.UI.Text.Area"),this.textStart=n.get("3DXCity.MeasureDistance.UI.Text.Start"),this.defaultContext={Line:{id:"drawnLine",name:n.get("3DXCity.MeasureDistance.Treeview.Text.DrawnLine")},Folder:{id:"mesure",name:n.get("3DXCity.MeasureDistance.Treeview.Text.Mesure")}},this.cssStylesContent={position:"absolute",margin:"auto",padding:"6px",textAlign:"center",backgroundColor:"rgba(161, 229, 255, 0.78)",border:"solid 2px rgba(161, 229, 255, 0.8)",pointerEvents:"none",borderRadius:"6px"},this.setCurrentContext(this.defaultContext)},setCurrentContext:function(e){return this.context=this._contextCopyOf(this.defaultContext),Utils.is(e)&&(Utils.is(e.Line)&&(this.context.Line={id:e.Line.id||this.defaultContext.Line.id,name:e.Line.name||this.defaultContext.Line.name}),Utils.is(e.Folder)&&(this.context.Folder={id:e.Folder.id||this.defaultContext.Folder.id,name:e.Folder.name||this.defaultContext.Folder.name})),this._parent(e)},onBreakLoop:function(e){this._parent(e),2===e.length&&(e[1].ph.div.style.visibility="visible"),e[0].ph.text.innerHTML=this.textStart},onAddAnchor:function(e,n){if((e=this._parent(e,n)).div=t.createElement("div",{id:"anchorDiv",styles:this.cssStylesContent}),e.div.inject(this.parentDiv),e.text=document.createElement("p"),e.text.style.pointerEvents="none",e.text.style.textAlign="justify",e.div.appendChild(e.text),n.length>1){var i=this._computeDistance(n.length-1,n),r=this._formatMeasures(i);2!==n.length?(e.text.innerHTML=this.textSegment+r.fpl.value+" "+r.fpl.unit+".<BR>",e.text.innerHTML+=this.textPolyline+r.total.value+" "+r.total.unit+"."):e.text.innerHTML+=this.textSegment+r.total.value+" "+r.total.unit+"."}else e.text.innerHTML=this.textStart;this.divStyleHeight=parseFloat(window.getComputedStyle(e.div).height),e.div.style.top=e.pos2D.y-this.divStyleHeight+"px",e.div.style.left=e.pos2D.x+20+"px";for(var o=1;o<n.length-1;o++)n[o].ph.div.style.visibility="hidden"},onCreateLoop:function(e){return e[e.length-1].ph.div.style.visibility="hidden",!0},onRemoveAnchor:function(e,t){return e.index===t.length-1&&t.length>1&&(t[e.index-1].ph.div.style.visibility="visible"),void 0!==e.div&&this.parentDiv.removeChild(e.div),!0},onManipulateAnchor:function(e){e.div.style.top=e.pos2D.y-this.divStyleHeight+"px",e.div.style.left=e.pos2D.x+20+"px"},onBeginPreactivateAnchor:function(e){return e.div.style.visibility="visible",!0},onEndPreactivateAnchor:function(e,t){return e.locked||0===e.index||e.index===t.length-1||(e.div.style.visibility="hidden"),!0},_computeDistance:function(e,t){if(e>=1){for(var n=t[e].ph.pos3D.clone().sub(t[e-1].ph.pos3D),i=n.length(),r=0,o=1;o<=e;o++)r+=(n=t[o].ph.pos3D.clone().sub(t[o-1].ph.pos3D)).length();return{fpl:i,total:r}}return{fpl:0,total:0}},_computePolygonArea:function(e){for(var t={},n={},i=0,r=e[0].ph.pos3D,o=e.length,a=2;a<o;a++){var s=e[a-1].ph.pos3D,u=e[a].ph.pos3D;t.x=r.x-u.x,t.y=r.y-u.y,n.x=r.x-s.x,n.y=r.y-s.y,i+=t.x*n.y-t.y*n.x}return{polygonArea:Math.abs(i/2)}},onUpdate:function(e,t){this.loop=e;var n=t.length;this.loop&&n--,this._updateDistanceMeasure(n,t)},_updateDistanceMeasure:function(e,t){var n;for(n=0;n<e;n++)0!==n?this._updateAnchorText(n,t):this.loop&&this._updateLastAnchorText(e,t)},_updateAnchorText:function(e,t){var n=this._computeDistance(e,t),i=this._formatMeasures(n);1!==e?(t[e].ph.text.innerHTML=this.textSegment+i.fpl.value+" "+i.fpl.unit+".<BR>",t[e].ph.text.innerHTML+=this.textPolyline+i.total.value+" "+i.total.unit+"."):t[e].ph.text.innerHTML=this.textSegment+i.total.value+" "+i.total.unit+"."},_updateLastAnchorText:function(e,t){var n=this._computeDistance(e,t),i=this._formatMeasures(n);t[0].ph.text.innerHTML=this.textPolygon+i.total.value+" "+i.total.unit+".<BR>","surface"===this.type&&(n=this._computePolygonArea(t),i=this._formatMeasures(n),t[0].ph.text.innerHTML+=this.textArea+i.area.value+" "+i.area.unit+".")},_formatMeasures:function(e){var t=function(e){if(Utils.is(e)){var t=Math.round(100*e)/100,n="m";return t>1e3&&(t=Math.round(100*t/1e3)/100,n="km"),{value:t,unit:n}}};return{fpl:t(e.fpl),total:t(e.total),area:function(e){if(Utils.is(e)){var t=Math.round(100*e)/100,n="m2";return t>1e6&&(t=Math.round(100*t/1e6)/100,n="km2"),{value:t,unit:n}}}(e.polygonArea)}},onCameraUpdate:function(e){if(this.urban.getViewpoint().camMoved){var t=e.length;this.loop&&t--;for(var n=0;n<t;n++){var i=this.urban.getView3D().viewpoint.getScreenPosition(e[n].ph.pos3D);e[n].ph.div.style.top=i.y-this.divStyleHeight+"px",e[n].ph.div.style.left=i.x+20+"px"}}},onFinish:function(e){this._parent(e),this._removeAllAnchorDiv(e),this._removeMeasureFeature()},onDestroy:function(e,t){this.onFinish(t)},_removeAllAnchorDiv:function(e){if(e)for(var t=0;t<e.length;t++)void 0!==e[t].ph.div&&this.parentDiv.removeChild(e[t].ph.div)},_removeMeasureFeature:function(){var e=xCity.findItem({id:this.context.Line.id});void 0!==e&&"mesure"===e.getParentFolder().get("id")&&xCity.removeChild(e)}})}),define("DS/UrbanTool/Recorder",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityTools/Debug","DS/UrbanTool/Utils"],function(e,t,n,i,r,o){"use strict";return UWA.Class.extend({init:function(e){this._urban=e,this._controls=this._urban.controls,this._capture=!1,this._shootFrame=!1,this._animId=1,this._lastFrameTimeShooted=0,this._videoFrameRate=25,this._maxTimeBetweenTwoFrames=3e4,this._singleCapture=!1,this._frameId=1,this._fileName=void 0},setVideoFrameRate:function(e){this._videoFrameRate=e},takeSingleSnap:function(e){var t=this._urban.getView3D().getGLViewer(),n="ddl",i=t.SCREEN_WIDTH,r=t.SCREEN_HEIGHT,a="";(e&&void 0!==e.output&&(n=e.output),e&&void 0!==e.width&&(i=e.width),e&&void 0!==e.height&&(r=e.height),e&&void 0!==e.fileName)?a=".png"===e.fileName.substring(e.fileName.length-4).toLowerCase()?e.fileName:e.fileName+".png":(a="xCitySnap_"+this._frameId+".png",this._frameId++);var s={width:i,height:r,data:null};t.renderToTarget(s,this._urban.getView3D().viewpoint);var u=s.data;if(null===s.data)return null;var l=document.createElement("canvas");l.width=s.width,l.height=s.height;for(var d=l.getContext("2d"),h=d.createImageData(s.width,s.height),c=new Uint8ClampedArray(4*s.width*s.height),f=0;f<s.width;f++)for(var m=0;m<s.height;m++){var p=m*s.width+f,v=(s.height-1-m)*s.width+f;c[4*p]=u[4*v],c[4*p+1]=u[4*v+1],c[4*p+2]=u[4*v+2],c[4*p+3]=u[4*v+3]}return h.data.set(c),d.putImageData(h,0,0),"blob"===n?o.dataURItoBlob(l.toDataURL()):"URI"===n?l.toDataURL():void o.toDownloadFile(a,o.dataURItoBlob(l.toDataURL()))},_captureCanvas:function(){return o.dataURItoBlob(this._urban.getView3D().getCanvas().toDataURL())},takeASnap:function(){!0===this._capture?(this._urban.getView3D().forceUpdate=!0,!0===this._shootFrame&&(o.toDownloadFile("xCityFrame_"+this._animId+".png",this._captureCanvas()),this._lastFrameTimeShooted=Date.now(),this._animId++,r.log("[Recorder] capture frame "+this._animId))):!0===this._singleCapture&&(o.toDownloadFile(fileName,this.drawInCanvas()),this._singleCapture=!1)},check:function(){if(!0===this._capture){var e=Date.now()-this._lastFrameTimeShooted;if(!0===this._urban.USR.dataReadyForRender()||this._animId>1&&e>this._maxTimeBetweenTwoFrames?this._shootFrame=!0:this._shootFrame=!1,!0===this._shootFrame)this._urban.getControl().currentAnimation.setFrame(this._animId,this._videoFrameRate)||(this._capture=!1,this._animId=1)}},isRecording:function(){return this._capture},startRecord:function(){this._capture=!0},stopRecord:function(){this._capture=!1}})}),define("DS/UrbanTool/TemporaryFolder",["UWA/Core","UWA/Class","DS/UrbanTool/Utils","DS/XCityModel/Folder","i18n!DS/UrbanTool/assets/nls/measureDistance"],function(e,t,n,i,r){"use strict";var o=null,a=t.extend({start:function(e){n.is(this.dataModel)||(this.dataModel=e.getLayerRoot().getRoot())},getFolder:function(e,t){var r=t||e,o=this.dataModel.findChildById(e,!0);return n.is(o)||(o=new i({id:e,name:r}),this._addFolderToParent(o)),o},_addFolderToParent:function(e){var t=this.dataModel.findChildById("TemporaryItems",!0);return n.is(t)||((t=new i({id:"TemporaryItems",name:r.get("3DXCity.TemporaryFolder.Treeview.Text.TemporaryItem")})).get("children").addEvent("onRemove",this._remove.bind(this)),this.dataModel.addChild(t)),e.get("children").addEvent("onRemove",this._remove.bind(this)),t.addChild(e),t},_remove:function(e){var t=e.getItemParent(),n=t.getItemParent();e.addEvent("onDestroy",this._removeEmptyFolder.bind(this,t,n))},_removeEmptyFolder:function(e,t){0===e.get("children").length&&t&&t.removeChild(e)}});return a.getInstance=function(){return n.is(o)||(o=new a),o},a.getInstance()});