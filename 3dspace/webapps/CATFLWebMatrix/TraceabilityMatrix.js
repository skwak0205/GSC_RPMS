function _TraceabilityMatrixModule(e){"use strict";var t,i={},a=";",n=[20,0],r=[15,15],o=Math.cos(Math.PI/4),s={ROW:1,COLUMN:2},l={IN:"-2",OUT:"-1",NO_DIRECTION:"0",IN_OUT:"1"},d={};function h(t,i,n,r,o){var s,l,h,c;if(t.data.relations)for(h=0;h<t.data.relations.length;++h)if((!(l=t.data.relations[h]).direction||-1!==e.inArray(l.direction,n))&&(l.path&&i.id===l.path.join(a)||r&&l.refId&&l.refId===i.data.refId)&&-1===e.inArray(o,l)){for(c=0;c<o.length&&o[c].id!==l.id;++c);c===o.length&&o.push(l)}return r&&t.data.refId&&i.data.refId&&(s=d[t.data.refId])&&(l=s[i.data.refId])&&o.push(l),o}function c(t,i,n,r,o,s,l,h){var p,u,f,m,g,y,C,x,b=[];if(h||(h=[]),i&&(e.isArray(i)||(i=[i]),i.length>0))for(C=0;C<i.length;++C)if(i[C])if(i[C].referencingBlock){if(o&&(p=o[i[C].referencingBlock])&&p.length>0&&p[0].data.children)for(f=c(t,p[0].data.children,n,r,o,s,l,h),x=0;x<f.length;++x)b.push(f[x])}else{if((g=(u=new n(t,i[C])).data.refId)&&o&&(o[g]||(o[g]=[]),o[g].push(u),u.data.relations))for(x=u.data.relations.length-1;x>=0;--x)(m=u.data.relations[x]).refId?(d[g]||(d[g]={}),d[m.refId]||(d[m.refId]={}),d[g][m.refId]=m,d[m.refId][g]=m,u.data.relations.splice(x,1)):l.push({from:u,relation:m});for(y=0===h.length,h.push(u.id),u.id=h.join(a),u.depth=h.length,u.expanded=u.depth<=r,u.visible=(!y||t.showRoots)&&u.depth<=r+1,y&&(u.isRoot=y),s.onNewNode&&s.onNewNode(u),f=c(t,i[C].children,n,r,o,s,l,h),x=0;x<f.length;++x)u.addChild(f[x]);b.push(u),h.pop()}return b}function p(t){var a,n,r=this,o=!1;this.topHeader=e(document.createElement("div")).addClass("header-container"),this.leftHeader=e(document.createElement("div")).addClass("header-container"),this.maskHeader=e(document.createElement("div")).addClass("mask-header"),this.matrix=t,t.container.append(this.topHeader),t.container.append(this.leftHeader),t.container.append(this.maskHeader),this.firstCell=e(t.header.children()[0]),this.maskSize={width:this.firstCell.outerWidth(),height:t.header.outerHeight()},this.maskHeader.width(this.maskSize.width).height(this.maskSize.height-1),this.maskHeader.outerHeight()<this.maskSize.height&&this.maskHeader.height(this.maskHeader.outerHeight()+(this.maskHeader.outerHeight()-this.maskHeader.height())),this.headers=[document.createElement("table"),document.createElement("table")],this.topHeader.append(this.headers[0]),this.leftHeader.append(this.headers[1]),e(this.headers).addClass(t.table.attr("class")),this.maskOffset=this.firstCell.offset(),this.maskHeader.offset(this.maskOffset),this.updateOffset(),this.updateSize(),a=document.createElement("tr"),i.forEachNode(t.columns,function(e){var t=e.header.clone(!0);a.appendChild(t[0]),e.header.push(t[0])}),e(document.createElement("thead")).append(a).appendTo(this.headers[0]),n=document.createElement("tbody"),i.forEachNode(t.rows,function(e){var t=e.header.clone(!0),i=document.createElement("tr");i.appendChild(t[0]),n.appendChild(i),e.header.push(t[0]),e.row.push(t[0])}),this.headers[1].appendChild(n),t.container.scroll(this.updateScroll.bind(this)),e(window).scroll(this.updateOffset.bind(this)),e(window).resize(this.updateSize.bind(this)),e(window).resize(this.updateScroll.bind(this)),t.table.bind("expand",function(){o||(o=!0,setTimeout(function(){r.updateSize(),r.updateScroll(),o=!1},0))})}return i.Direction=l,i.HeaderType=s,"function"!=typeof Object.create&&(Object.create=(t=function(){},function(e){if(arguments.length>1)throw Error("Second argument not supported");if("object"!=typeof e)throw new TypeError("Argument must be an object");t.prototype=e;var i=new t;return t.prototype=null,i})),"function"!=typeof Object.keys&&(Object.keys=function(e){var t,i=[];for(t in e)e.hasOwnProperty(t)&&i.push(t);return i}),"function"!=typeof Function.prototype.bind&&(Function.prototype.bind=function(e){var t=Array.prototype.slice.call(arguments,1),i=this,a=function(){},n=function(){return i.apply(this instanceof a?this:e,t.concat(Array.prototype.slice.call(arguments)))};return this.prototype&&(a.prototype=this.prototype),n.prototype=new a,n}),e(document).ready(function(){i.SCROLLBAR_SIZE=function(){var e=document.createElement("p");e.style.width="100%",e.style.height="200px";var t=document.createElement("div");t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.visibility="hidden",t.style.width="200px",t.style.height="150px",t.style.overflow="hidden",t.style.boxSizing="content-box",t.appendChild(e),document.body.appendChild(t);var i=e.offsetWidth;t.style.overflow="scroll";var a=e.offsetWidth;return i===a&&(a=t.clientWidth),document.body.removeChild(t),i-a}()}),i.forEachNode=function(t,i){var a,n=e.isArray(t)?t:[t];for(a=0;a<n.length;++a)n[a].forEach(i)},i.findNode=function(e,t,a){var n;if(e)for(a=a||0,n=0;n<e.length;++n)if(e[n].data.id===t[a])return a+1===t.length?e[n]:i.findNode(e[n].children,t,a+1);return null},i.getVisibleNodes=function(e){var t,i=[];for(t=e;t;t=t.next(!0))t.dirty(),i.push(t);return i},i.CellState={NORMAL:0,LOADING:1,DISABLED:2},i.Matrix=function(t,a){var n,r,l,d,h,p,u,f,m,g,y,C=this,x=[];if(!t.rows&&!t.columns)throw Error("Matrix Error: missing property rows and/or columns.");for(C.selectedCells=[],C.callbacks=a||{},C.references={},C.metadata=t.metadata||{references:{},instances:{}},C.showRoots=!(!1===t.showRoots),C.rows=c(C,t.rows||t.columns,i.RowNode,t.expandLevel||0,C.references,C.callbacks,x),C.columns=c(C,t.columns||t.rows,i.ColumnNode,t.expandLevel||0,C.references,C.callbacks,x),C.currentRow=null,C.currentColumn=null,d=0;d<x.length;++d)(r=x[d])&&r.relation.path&&(r.from.isRow()&&(l=i.findNode(C.columns,r.relation.path))?C.registerRelation(r.from,l,r.relation):r.from.isColumn()&&(l=i.findNode(C.rows,r.relation.path))&&C.registerRelation(l,r.from,r.relation));C.display=t.display,C.hasFixedHeaders=t.fixedHeaders,C.singleTree=t.rows===t.columns||!t.rows||!t.columns,C.container=e(document.createElement("div")).addClass("traceability-container"),C.table=e(document.createElement("table")).addClass("traceability-matrix table-striped table-condensed").appendTo(C.container),C.table.bind("selectstart",function(e){return e.preventDefault(),!1}),C.header=e(document.createElement("tr")),e(document.createElement("thead")).appendTo(C.table).append(C.header),C.header.append(e(document.createElement("th")).addClass("tm-empty-header")),C.body=e(document.createElement("tbody")).appendTo(C.table),C.content=e(document.createElement("div")).addClass("traceability-matrix").appendTo(C.container),t.readOnly&&C.table.addClass("readOnly"),this.manipulators=(h=C,p=e(document.body).hasClass("ie8"),u=function(t){e(".tm-r-header > span").outerWidth(Math.max(200,t))},f=function(t){if(p)e(".tm-c-header > .header-content").outerHeight(Math.max(125,t)),e(".tm-c-header > .header-content > span").outerWidth(Math.max(128,t+3));else{var i=(t-13)/o;e(".tm-c-header > .header-content > span").outerWidth(Math.max(107/o,i)),e(".tm-c-header").outerHeight(Math.max(120,t))}},m=function(){var e,t,a,n=i.getVisibleNodes(h.currentColumn||h.columns[0]);for(e=h.currentRow||h.rows[0];e;e=e.next(!0))for(e.dirty(),a=0;a<n.length;++a)(t=h.getCell(e,n[a]))&&t.el&&t.updatePosition()},g={rowHandler:function(t){return h.dragging={size:e(".tm-r-header > span").outerWidth(),start:t.clientX,target:s.ROW},!1},columnHandler:function(t){return h.dragging={size:e(".tm-c-header").outerHeight(),start:t.clientY,target:s.COLUMN},!1},update:function(){u(e(".tm-r-header > span").outerWidth()),f(e(".tm-c-header").outerHeight()),h.fixedHeaders&&(h.fixedHeaders.updateOffset(),h.fixedHeaders.updateSize(),m())}},y=!1,e(document).on("mousemove",function(e){var t;if(h.dragging){switch(h.dragging.target){case s.ROW:t=e.clientX-h.dragging.start,h.dragging.newSize=h.dragging.size+t,u(h.dragging.newSize);break;case s.COLUMN:t=e.clientY-h.dragging.start,h.dragging.newSize=h.dragging.size+t,f(h.dragging.newSize)}h.fixedHeaders&&(h.fixedHeaders.updateOffset(),h.fixedHeaders.updateSize(),m()),e.preventDefault()}}),e(document).on("mouseup",function(e){h.dragging&&(h.callbacks.onHeaderResize&&h.callbacks.onHeaderResize(h.dragging),h.dragging=void 0,e.preventDefault())}),h.table.bind("expand",function(){y||(y=!0,setTimeout(function(){g.update(),y=!1},0))}),g.setRowSize=u,g.setColumnSize=f,g),n=[function(e,a,n){C.singleTree&&a.id===n.id&&(e.state=i.CellState.DISABLED),e.el&&(t.readOnly||e.el.bind("click",C.onCellSelected.bind(C,e,a,n)),e.el.bind("mouseover",C.onCellOver.bind(C,e,a,n)),e.el.bind("mouseout",C.onCellOut.bind(C,e,a,n)))}],C.callbacks.onNewCell&&n.push(C.callbacks.onNewCell),C.cellManager=new i.CellManager(C,n),i.forEachNode(C.rows,function(t){var i,a=t.createHeader();a.bind("mouseover",C.onHeaderOver.bind(C,t)),a.bind("mouseout",C.onHeaderOut.bind(C,t)),a.bind("expand",C.update.bind(C,t,null)),C.callbacks.onContextMenu&&a.bind("contextmenu",C.callbacks.onContextMenu.bind(C,t)),t.row=e(document.createElement("tr")),t.setVisible(t.visible),t.visible||t.row.css("display","none"),(i=e(document.createElement("div"))).addClass("header-manipulator"),a.append(i),i.bind("mousedown",C.manipulators.rowHandler),t.row.append(a),t.row.appendTo(C.body)}),i.forEachNode(C.columns,function(t){var a,n=t.createHeader();if(n.bind("mouseover",C.onHeaderOver.bind(C,t)),n.bind("mouseout",C.onHeaderOut.bind(C,t)),n.bind("expand",C.update.bind(C,null,t)),C.callbacks.onContextMenu&&n.bind("contextmenu",C.callbacks.onContextMenu.bind(C,t)),(a=e(document.createElement("div"))).addClass("header-manipulator"),n.append(a),a.bind("mousedown",C.manipulators.columnHandler),C.singleTree){var r=i.findNode(C.rows,t.getPath());r&&(r.header.bind("expand",function(){t.setExpanded(r.isExpanded(),!1),C.update(null,t)}),t.header.bind("expand",function(){r.setExpanded(t.isExpanded(),!1),C.update(r,null)}))}C.header.append(n)})},i.resetRefRefMap=function(){d={}},i.Matrix.prototype.updateLayout=function(){this.cellManager.updateCells(!0,!0)},i.Matrix.prototype.setCurrentRoot=function(e){var t;e.isRow()?(this.currentRow=e,t=this.rows):e.isColumn&&(this.currentColumn=e,t=this.columns),i.forEachNode(t,function(t){if(t===e)return!1;t.setVisible(!1)}),this.applyFilter(this.filter)},i.Matrix.prototype.restoreRoots=function(e,t){e&&(this.currentRow=null),t&&(this.currentColumn=null),this.applyFilter(this.filter)},i.Matrix.prototype.isVisibleWithFilter=function(e){var t=this.filter?this.filter.FilterNames:null;return!this.filter||!1!==this.filter.references[e.data.refType]&&!1!==this.filter.instances[e.data.type]&&(this.filter.allocation.allocated||(!e.data.relations||0===e.data.relations.length)&&!d.hasOwnProperty(e.data.refId))&&(this.filter.allocation.notAllocated||e.data.relations&&e.data.relations.length>0||d.hasOwnProperty(e.data.refId))&&function(e){var i=!0;if(t&&t.FilterNamesString&&t.FilterNamesString.length>0){var a=t.FilterCheckToDo?t.FilterCheckToDo:"";if(t.ApplyToColumns&&e.isColumn()||t.ApplyToRows&&e.isRow())switch(a){case"includes":i=-1!==e.data.name.indexOf(t.FilterNamesString);break;case"startsWith":i=0===e.data.name.lastIndexOf(t.FilterNamesString,0);break;case"endsWith":i=-1!==e.data.name.indexOf(t.FilterNamesString,e.data.name.length-t.FilterNamesString.length)}}return i}(e)},i.Matrix.prototype.applyFilter=function(e){this.filter=e;var t,a,n=this,r={},o=function(e){for(var t=e.parent;t;t=t.parent){if(!t.isExpanded())return!1;if(t===n.currentRow||t===n.currentColumn)break}return!0},s=function(t){var i,a=n.isVisibleWithFilter(t);if(e&&e.options.displayParents&&a)for(var s=t.parent;s;s=s.parent)(i=r[s.id])&&!i.visibility&&(r[s.id]={node:s,visibility:o(s)},s.setLowLight(!0));o(t)||(a=!1),t.setLowLight(!1),r[t.id]={node:t,visibility:a}};for(t in i.forEachNode(this.currentRow||this.rows,s),i.forEachNode(this.currentColumn||this.columns,s),r)(a=r[t]).node.setVisible(a.visibility);this.updateLayout()},i.Matrix.prototype.registerRelation=function(e,t,i){var n,r,o,s=function(e,t){var i;if(e.data.relations){for(i=0;i<e.data.relations.length;++i)if(e.data.relations[i].id===t.id)return}else e.data.relations=[];e.data.relations.push(t)};if(i.refId)n=e.data.refId===i.refId?t.data.refId:e.data.refId,d[n]||(d[n]={}),d[n][i.refId]=i;else if(i.path){e.id===i.path.join(a)?(o=e,r=t):(o=t,r=e),s(r,i);var l={id:i.id,name:i.name,path:r.path};i.color&&(l.color=i.color),s(o,l)}},i.Matrix.prototype.unregisterRelation=function(e,t,i){if(i.refId){var a=d[e.data.refId];a&&a[i.refId]&&delete a[i.refId]}else{var n=function(e,t){if(e)for(var i=e.length-1;i>=0;--i)(t.refId&&t.refId===e[i].id||e[i].id===t.id)&&e.splice(i,1)};n(e.data.relations,i),n(t.data.relations,i)}},i.Matrix.prototype.getCell=function(e,t,i){if(e&&t)return i?this.cellManager.requestCell(e,t):t.cells[e.id]},i.Matrix.prototype.getNodesFromReference=function(e){return this.references[e]||[]},i.Matrix.prototype.findCell=function(e,t){var n=i.findNode(this.columns,t),r=e.join(a);if(n)return n.cells[r]},i.Matrix.prototype.forEachCell=function(e,t){var a=this;e.isRow()?i.forEachNode(a.columns,function(i){t(a.getCell(e,i),e,i)}):e.isColumn()&&TraceabilityMatrix.forEachNode(a.rows,function(i){t(a.getCell(i,e),i,e)})},i.Matrix.prototype.inject=function(e){return this.container.appendTo(e),this.hasFixedHeaders&&(this.fixedHeaders=new p(this)),this},i.Matrix.prototype.setExpandLevel=function(e){var t=-1===e,a=!t&&(this.filter&&!this.filter.options.displayParents||this.currentRow||this.currentColumn)?function(t){var i,a=1;for(i=t;i&&(!i.isExpanded()||i.isVisible());i=i.parent)++a;t.setExpanded(a<=e)}:function(i){i.setExpanded(t||i.depth<=e)};i.forEachNode(this.currentRow||this.rows,a),this.singleTree||i.forEachNode(this.currentColumn||this.columns,a)},i.Matrix.prototype.getSelectedCells=function(){return this.selectedCells},i.Matrix.prototype.setSelectedCells=function(e){var t;for(t=0;t<this.selectedCells.length;++t)this.selectedCells[t].setSelected(!1);for(this.selectedCells=e,t=0;t<this.selectedCells.length;++t)this.selectedCells[t].setSelected(!0)},i.Matrix.prototype.update=function(e,t){var a=this;e=e||a.rows,t=t||a.columns,i.forEachNode(e,function(e){if(e.visible)return i.forEachNode(t,function(t){if(t.visible){var n=a.getCell(e,t);return n&&n.getState()!==i.CellState.DISABLED&&n.update(a.computeExposedRelations(e,t)),t.expanded}}),e.expanded})},i.Matrix.prototype.computeRelations=h,i.Matrix.prototype.computeExposedRelations=function(e,t){var i=this,a=[];return e.forEach(function(n){return!(n.data&&n.data.Links&&n.data.ChildrenLinks&&0===parseInt(n.data.ChildrenLinks)&&0===parseInt(n.data.Links))&&(t.forEach(function(e){return!(e.data&&e.data.Links&&e.data.ChildrenLinks&&0===parseInt(e.data.ChildrenLinks)&&0===parseInt(e.data.Links))&&(i.computeRelations(n,e,[l.OUT,l.NO_DIRECTION,l.IN_OUT],!0,a),i.computeRelations(e,n,[l.IN,l.NO_DIRECTION,l.IN_OUT],!1,a),!t.expanded||!e.expanded)}),!e.expanded||!n.expanded)}),a},i.Matrix.prototype.onCellSelected=function(e,t,a){if(e.getState()!==i.CellState.DISABLED){var n,r=[e];this.singleTree&&(n=this.findCell(a.getPath(),t.getPath()))&&r.push(n),this.setSelectedCells(r)}},i.Matrix.prototype.onCellOver=function(e,t,a){var n;this.onHeaderOver(t),this.onHeaderOver(a),e.getState()!==i.CellState.DISABLED&&(e.el.addClass("over"),this.singleTree&&(n=this.findCell(a.getPath(),t.getPath()))&&n.el&&n.el.addClass("over"))},i.Matrix.prototype.onCellOut=function(e,t,i){var a;this.onHeaderOut(t),this.onHeaderOut(i),e.el.hasClass("over")&&(e.el.removeClass("over"),this.singleTree&&(a=this.findCell(i.getPath(),t.getPath()))&&a.el&&a.el.removeClass("over"))},i.Matrix.prototype.onHeaderOver=function(e){e.header.addClass("current");for(var t=e.parent;t;t=t.parent)t.header.addClass("parent")},i.Matrix.prototype.onHeaderOut=function(e){e.header.removeClass("current");for(var t=e.parent;t;t=t.parent)t.header.removeClass("parent")},i.Matrix.prototype.generateCSV=function(){var e=this,t="";return i.forEachNode(e.columns,function(e){t+=","+e.data.name}),t+="\n",i.forEachNode(e.rows,function(a){t+=a.data.name,i.forEachNode(e.columns,function(i){var n,r=e.getCell(a,i,!0);if(t+=",",r&&r.relations){for(t+='"',n=0;n<r.relations.length;++n)n>0&&(t+="\n"),t+=r.relations[n].name;t+='"'}}),t+="\n"}),t},i.Matrix.prototype.generateExcelData=function(e){var t=this,a={},n={},r={},o={},s=1,l=1,d=function(t,i){var a,n="",r=e.prefixes[t.refType]||e.prefixes[t.type]||"";for(a=0;a<i;++a)n+="    ";return r.length&&n.length<=r.length&&(n=n.substr(r.length)),n+r+t.name};return e||(e={prefixes:{}}),a.styles={rHeader:{Font:{Bold:!0}},cHeader:{Alignment:{Vertical:"Bottom",Rotate:90},Font:{Bold:!0}},cell:{Alignment:{Vertical:"Bottom",Horizontal:"Center"}},disabled:{Interior:{Color:"#D9D9D9",Pattern:"Solid"},Alignment:{Vertical:"Bottom",Horizontal:"Center"}}},o[0]={},i.forEachNode(t.columns,function(e){return e.isVisible()&&(o[l++]={value:d(e.data,e.depth-1),style:"cHeader"}),e.isExpanded()}),r[s++]={cells:o,attributes:{Height:140}},i.forEachNode(t.currentRow||t.rows,function(e){return e.isVisible()&&(l=1,(o={})[l++]={value:d(e.data,e.depth-1),style:"rHeader"},i.forEachNode(t.currentColumn||t.columns,function(a){if(a.isVisible()){var n,r=t.getCell(e,a),s=!1;r||((r=new i.Cell(e,a,t.display,t.cellManager.callbacks,t.cellManager)).propagate(),n=r.computeContent(r.getState()===i.CellState.DISABLED?null:t.computeExposedRelations(r.row,r.column)),s=!0),r.exposedRelations&&r.exposedRelations.length>0&&(o[l]=function(e,t){return e.el?{value:"number"===e.display?parseInt(e.el.text()):"X",comment:e.el.attr("title"),style:"cell"}:t?{value:"number"===e.display?parseInt(t.numRelations||0):"X",comment:t.title,style:"cell"}:void 0}(r,n)),r.getState()===i.CellState.DISABLED&&(void 0===o[l]&&(o[l]={}),o[l].style="disabled"),s&&r.destroy(),l++}return a.isExpanded()}),r[s++]={cells:o}),e.isExpanded()}),n.rows=r,n.columns={1:{attributes:{Width:160}}},n.attributes={DefaultColumnWidth:20},a.sheets=[{tables:[n]}],a},i.CellManager=function(t,i){var a=this,n=function(){var e=t.container.context.offsetTop,i=t.container.context.offsetLeft,n=t.container.width(),r=t.container.height();a.visibleArea={minX:i-n/2,minY:e-r/2,maxX:i+1.5*n,maxY:e+1.5*r}},r=function(){var e=a.matrix.container.context.scrollTop,t=a.matrix.container.context.scrollLeft,i=a.dirty.x||Math.abs(t-a.scrollLeft)>10,n=a.dirty.y||Math.abs(e-a.scrollTop)>10;i&&(a.scrollLeft=t),n&&(a.scrollTop=e),a.updateCells(i,n),a.dirty={},a.updater=null};this._currentId=0,this.initialized=!1,this.matrix=t,this.createMap={},this.deleteMap={},this.scrollTop=0,this.scrollLeft=0,this.dirty={},this.callbacks=i,setTimeout(function(){a.initialized=!0,n(),a.updateCells(!0,!0)},0),e(window).resize(function(){setTimeout(function(){n(),a.updateCells(!0,!0)},0)}),t.container.scroll(function(){a.updater||(a.updater=setTimeout(r,0))}),t.table.bind("expand",function(e,t){t.isRow()?a.dirty.y=!0:t.isColumn()&&(a.dirty.x=!0),a.updater||(a.updater=setTimeout(r,0))})},i.CellManager.prototype.generateId=function(){return++this._currentId},i.CellManager.prototype.updateCells=function(e,t){var a,n,r,o,s,l,d,h=this,c=this.currentRow&&!t?this.currentRow:this.matrix.currentRow||this.matrix.rows[0],p=this.currentColumn&&!e?this.currentColumn:this.matrix.currentColumn||this.matrix.columns[0],u=i.getVisibleNodes(p),f=function(e){var t=h.matrix.getCell(r,e);t&&h.returnCell(t)};for(r=c;r;r=r.next(!0))if(r.dirty(),(s=r.offset().top-this.scrollTop)>this.visibleArea.minY&&s<this.visibleArea.maxY){for(a||(a=r),d=0;d<u.length;++d)if((l=(o=u[d]).offset().left-this.scrollLeft)>this.visibleArea.minX){if(!(l<this.visibleArea.maxX))break;n||(n=o),this.requestCell(r,o)}}else i.forEachNode(h.matrix.columns,f);this.currentRow=a,this.currentColumn=n,this.run()},i.CellManager.prototype.requestCell=function(e,t){var a;return e&&t&&((a=t.cells[e.id])||(a=new i.Cell(e,t,this.matrix.display,this.callbacks,this)),this.addAction(1,a)),a},i.CellManager.prototype.returnCell=function(e){this.addAction(2,e)},i.CellManager.prototype.addAction=function(e,t){1===e?(this.deleteMap.hasOwnProperty(t.id)&&delete this.deleteMap[t.id],this.createMap[t.id]=t):2===e&&(this.createMap.hasOwnProperty(t.id)&&delete this.createMap[t.id],this.deleteMap[t.id]=t)},i.CellManager.prototype.run=function(){(Object.keys(this.createMap).length>0||Object.keys(this.deleteMap).length>0)&&setTimeout(this.process.bind(this),0)},i.CellManager.prototype.process=function(){var e,t,a=0;for(e in this.createMap)if((t=this.createMap[e]).row.visible&&t.column.visible&&(t.create(),t.update(),(t.row.children||t.column.children)&&t&&t.getState()!==i.CellState.DISABLED&&t.update(this.matrix.computeExposedRelations(t.row,t.column))),delete this.createMap[e],++a>100)break;for(e in this.deleteMap)if((t=this.deleteMap[e]).destroy(),delete this.deleteMap[e],++a>100)break;this.run()},i.Cell=function(e,t,a,n,r){var o,s=[];for(r&&(this.id=r.generateId()),this.state=i.CellState.NORMAL,this.display=a,this.callbacks=n,this.manager=r,this.relations=[],this.row=e,this.column=t,t.cells[e.id]=this,h(e,t,[l.OUT,l.NO_DIRECTION,l.IN_OUT],!0,s),h(t,e,[l.IN,l.NO_DIRECTION,l.IN_OUT],!1,s),o=0;o<s.length;++o)this.addRelation(s[o])},i.Cell.prototype.addRelation=function(e,t){var i={id:(e=e||{}).id,name:e.name,isRefRef:e.isRefRef||void 0===e.path&&void 0!==e.refId,data:e};e.color&&(i.color=e.color),e.subContext&&(i.isSubContext=!0),this.relations.push(i),this.update(),null!=t&&!0===t&&(this.row.increaseLinks(),this.column.increaseLinks())},i.Cell.prototype.removeRelation=function(e,t){var i,a;switch(typeof e){case"number":i=e;break;case"undefined":i=0;break;case"object":for(a=0;a<this.relations.length;++a)if(this.relations[a].id===e.id&&this.relations[a].name===e.name){i=a;break}break;default:return!1}return i<this.relations.length&&(this.relations.splice(i,1),this.update(),null!=t&&!0===t&&(this.row.decreaseLinks(),this.column.decreaseLinks()),!0)},i.Cell.prototype.setState=function(e){this.state=e,this.updateState()},i.Cell.prototype.getState=function(){return this.state},i.Cell.prototype.setSelected=function(e){this.selected=e,this.el&&this.el.toggleClass("selected",e)},i.Cell.prototype.isSelected=function(){return this.selected},i.Cell.prototype.propagate=function(){if(this.callbacks)for(var e=0;e<this.callbacks.length;++e)this.callbacks[e](this,this.row,this.column)},i.Cell.prototype.create=function(){return this.el||(this.el=e(document.createElement("div")).addClass("cell")),0===this.el.parent().length&&(this.el.appendTo(this.row.matrix.content),this.propagate()),this.updatePosition(),this.el},i.Cell.prototype.remove=function(){this.el&&(this.el.unbind(),this.el.remove())},i.Cell.prototype.destroy=function(){this.el&&(this.el.unbind(),this.el.remove(),this.el=null),delete this.column.cells[this.row.id]},i.Cell.prototype.computeContent=function(e){var t,i,a,n="",r={};for(this.exposedRelations=e||this.relations,a=0;a<this.exposedRelations.length;++a)(i=this.exposedRelations[a])&&i.name&&(r[i.name]=(r[i.name]||0)+1);for(i in t="number"!==this.display?this.exposedRelations.length:Object.keys(r).length,r)r.hasOwnProperty(i)&&(n.length>0&&(n+="\n"),t>1&&(n+="- "),n+=i,r[i]>1&&(n+=" ("+r[i]+")"));return{title:n,numRelations:t}},i.Cell.prototype.update=function(e){if(this.el){var t=this.computeContent(e);if("number"===this.display?this.el.text(t.numRelations||""):(this.el.toggleClass("link",this.relations.length>0),this.el.toggleClass("nested-link",this.exposedRelations.length>this.relations.length)),this.el.attr("title",t.title),this.selected&&this.el.addClass("selected"),this.el.toggleClass("lowlight",this.row.lowlight||this.column.lowlight),this.relations.length>0){var i=this.relations[0].color;null!=i&&void 0!==i&&this.el.css("color","rgba("+i+")")}this.updateState()}},i.Cell.prototype.updatePosition=function(){this.el&&(this.el.context.style.top=this.row.offset().top+"px",this.el.context.style.left=this.column.offset().left+"px")},i.Cell.prototype.updateState=function(){if(this.el)switch(this.state){case i.CellState.NORMAL:this.el.removeClass("disabled"),this.el.removeClass("loading");break;case i.CellState.LOADING:this.el.addClass("loading");break;case i.CellState.DISABLED:this.el.addClass("disabled"),this.el.removeClass("loading"),this.el.removeClass("link"),this.el.removeClass("nested-link")}},i.Cell.prototype.setVisible=function(e){!e&&this.el&&(this.manager?this.manager.returnCell(this):this.destroy()),this.el&&this.el.css("display",e?"":"none")},i.Node=function(e,t){this.id=t.path||t.id,this.data=t,this.matrix=e,this.expanded=!0,this.parent=null,this.children=[],this.depth=0,this.visible=!0,this.lowlight=!1,this._offset={top:0,left:0},this._dirty=!0},i.Node.prototype.offset=function(){return this.header&&this._dirty&&(this._offset={top:this.header.context.offsetTop,left:this.header.context.offsetLeft},this._dirty=!1,setTimeout(this.dirty.bind(this),0)),this._offset},i.Node.prototype.dirty=function(){this._dirty=!0},i.Node.prototype.addChild=function(e){this.children.push(e),e.parent=this},i.Node.prototype.forEach=function(e){if(!1!==e(this))for(var t=0;t<this.children.length;++t)this.children[t].forEach(e)},i.Node.prototype.next=function(t){for(var i,a=this,n=this.children,r=0;n;){for(i=r;i<n.length;++i){if(!t||n[i].isVisible())return n[i];if(this.matrix.filter&&!this.matrix.filter.options.displayParents)return n[i].next(t)}if(!a||a===this.matrix.currentRow||a===this.matrix.currentColumn)break;n=a.parent?a.parent.children:a.isRow()?this.matrix.currentRow||this.matrix.rows:this.matrix.currentColumn||this.matrix.columns,r=e.inArray(a,n)+1,a=a.parent}return null},i.Node.prototype.computePath=function(){var e;for(this.path=[],e=this;e&&e.data.id;e=e.parent)this.path.splice(0,0,e.data.id);return this.path},i.Node.prototype.getPath=function(){return this.path||this.computePath()},i.Node.prototype.onExpand=function(e){this.expandCallback=e},i.Node.prototype.setExpanded=function(e,t){var i=this;i.expanded!==e&&(this.dirty(),i.expanded=e,i.forEach(function(t){if(t!==i)return t.setVisible(e&&(t.lowlight||i.matrix.isVisibleWithFilter(t))),t.expanded||void 0!==i.matrix.filter&&!i.matrix.filter.options.displayParents}),i.header.toggleClass("expanded",i.expanded),!1!==t&&i.header.trigger("expand",i))},i.Node.prototype.isExpanded=function(){return this.expanded},i.Node.prototype.setVisible=function(e){this.isRoot&&!this.matrix.showRoots?this.visible=!1:(this.visible=e,this.dirty())},i.Node.prototype.isVisible=function(){return this.visible},i.Node.prototype.setLowLight=function(e){this.lowlight=e},i.Node.prototype.isLowLight=function(){return this.lowlight},i.Node.prototype.createHeader=function(){},i.Node.prototype.isRow=function(){return!1},i.Node.prototype.isColumn=function(){return!1},i.Node.prototype.setName=function(e){this.data.name=e},i.Node.prototype.getName=function(){return this.data.name},i.Node.prototype.increaseLinks=function(){null===this.data.Links||void 0===this.data.Links?this.data.Links=0:this.data.Links=parseInt(this.data.Links),this.data.Links++;for(var e=this.parent;null!=e;)null!==e.data.ChildrenLinks&&void 0!==e.data.ChildrenLinks||(e.data.ChildrenLinks=0),e.data.ChildrenLinks++,e=e.parent},i.Node.prototype.decreaseLinks=function(){null===this.data.Links||void 0===this.data.Links?this.data.Links=0:0!==parseInt(this.data.Links)&&(this.data.Links=parseInt(this.data.Links),this.data.Links--);for(var e=this.parent;null!=e;)null===e.data.ChildrenLinks||void 0===e.data.ChildrenLinks?e.data.ChildrenLinks=0:0!==parseInt(e.data.ChildrenLinks)&&(e.data.ChildrenLinks=parseInt(e.data.ChildrenLinks),e.data.ChildrenLinks--),e=e.parent},i.RowNode=function(e,t){i.Node.call(this,e,t)},i.RowNode.prototype=Object.create(i.Node.prototype),i.RowNode.prototype.createHeader=function(){return this.header=e(document.createElement("td")),this.visible?this._buildHeader():this.header.css("display","none"),this.header},i.RowNode.prototype._buildHeader=function(){var t=this,i=e(document.createElement("span")),a=t.matrix.metadata.references[t.data.refType],o=this.data.icon||a&&a.icon;t.header.addClass("tm-r-header"),t.expanded&&t.header.addClass("expanded"),o&&i.append(e(document.createElement("img")).attr("src",o)),i.append(document.createTextNode(t.data.name)),i.attr("title",t.data.name).css("padding-left",n[0]+t.depth*r[0]+"px"),t.children.length>0&&(t.header.addClass("group"),i.bind("click",function(){t.setExpanded(!t.expanded)})),t.header.prepend(i),this._headerBuilt=!0},i.RowNode.prototype.setVisible=function(e){var t=this;i.Node.prototype.setVisible.call(this,e),this.visible&&!this._headerBuilt&&this._buildHeader(),this.header.css("display",this.visible?"":"none"),this.row.css("display",this.visible?"":"none"),i.forEachNode(this.matrix.columns,function(e){var i=e.cells[t.id];return i&&i.setVisible(t.visible&&e.visible),e.expanded})},i.RowNode.prototype.setLowLight=function(e){var t=this;i.Node.prototype.setLowLight.call(this,e),this.header.toggleClass("lowlight",e),i.forEachNode(this.matrix.columns,function(e){var i=e.cells[t.id];return i&&i.el&&i.el.toggleClass("lowlight",t.lowlight||e.lowlight),e.expanded})},i.RowNode.prototype.isRow=function(){return!0},i.RowNode.prototype.setName=function(e){i.Node.prototype.setName.call(this,e),this.header&&this.header.find("span").text(e).attr("title",e)},i.ColumnNode=function(e,t){i.Node.call(this,e,t),this.cells={}},i.ColumnNode.prototype=Object.create(i.Node.prototype),i.ColumnNode.prototype.createHeader=function(){return this.header=e(document.createElement("th")),this.visible?this._buildHeader():this.header.css("display","none"),this.header},i.ColumnNode.prototype._buildHeader=function(){var t=this,i=e(document.createElement("div")).addClass("header-content"),a=e(document.createElement("span")).appendTo(i),o=t.matrix.metadata.references[t.data.refType],s=this.data.icon||o&&o.icon;t.header.attr("title",t.data.name).addClass("tm-c-header"),t.expanded&&t.header.addClass("expanded"),s&&a.append(e(document.createElement("img")).attr("src",s)),a.append(document.createTextNode(t.data.name)),a.css("padding-left",n[1]+t.depth*r[1]+"px"),t.children.length>0&&(t.header.addClass("group"),i.bind("click",function(){t.setExpanded(!t.expanded)})),t.header.prepend(i),this._headerBuilt=!0},i.ColumnNode.prototype.setVisible=function(e){var t=this;i.Node.prototype.setVisible.call(this,e),this.visible&&!this._headerBuilt&&this._buildHeader(),this.header.css("display",this.visible?"":"none"),i.forEachNode(this.matrix.rows,function(e){var i=t.cells[e.id];return i&&i.setVisible(t.visible&&e.visible),e.expanded})},i.ColumnNode.prototype.setLowLight=function(e){var t=this;i.Node.prototype.setLowLight.call(this,e),this.header.toggleClass("lowlight",e),i.forEachNode(this.matrix.rows,function(e){var i=t.cells[e.id];return i&&i.el&&i.el.toggleClass("lowlight",t.lowlight||e.lowlight),e.expanded})},i.ColumnNode.prototype.isColumn=function(){return!0},i.ColumnNode.prototype.setName=function(e){i.Node.prototype.setName.call(this,e),this.header&&(this.header.attr("title",e),this.header.find("div > span").text(e))},p.prototype.updateScroll=function(){var t=this.matrix.container.scrollTop(),i=this.matrix.container.scrollLeft(),a=this.topHeader.offset(),n=this.leftHeader.offset();e(this.headers[0]).offset({top:a.top,left:a.left-i}),e(this.headers[1]).offset({top:n.top-t,left:n.left})},p.prototype.updateSize=function(){var e=this.matrix.container.innerWidth()-this.maskSize.width,t=this.matrix.container.innerHeight()-this.maskSize.height;this.matrix.container[0].scrollHeight>this.matrix.container.innerHeight()&&(e-=i.SCROLLBAR_SIZE),this.matrix.container[0].scrollWidth>this.matrix.container.innerWidth()&&(t-=i.SCROLLBAR_SIZE),this.topHeader.width(e),this.leftHeader.height(t)},p.prototype.updateOffset=function(){this.maskSize={width:this.firstCell.outerWidth(),height:this.matrix.header.outerHeight()},this.maskHeader.width(this.maskSize.width).height(this.maskSize.height-1),this.topHeader.offset({top:this.maskOffset.top,left:this.maskOffset.left+this.maskSize.width}),this.leftHeader.offset({top:this.maskOffset.top+this.maskSize.height,left:this.maskOffset.left})},i}if("function"==typeof define)define("DS/CATFLWebMatrix/TraceabilityMatrix",["DS/CATFLWebMatrix/jQueryPlugin","css!CATFLWebMatrix/css/TraceabilityMatrix.css"],_TraceabilityMatrixModule);else var TraceabilityMatrix=_TraceabilityMatrixModule($);