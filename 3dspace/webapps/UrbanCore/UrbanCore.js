define("DS/UrbanCore/Viewpoint",["UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/XCityTools/Geocoder","DS/XCityTools/Debug","DS/Visualization/PathElement","DS/CoreEvents/Events","DS/XCityModel/Item","DS/xCityBasicUtils/Utils","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/EventDispatcher"],function(e,t,i,n,r,s,a,o,h,d,l,u){"use strict";return i.extend(e,{init:function(e,i,n,r,s){this._parent({viewer:{canvas:{width:500,height:500},divCss3DElement:UWA.createElement("div")},angle:i,near:n,far:r,defaultController:s}),this.urban=e,this._numFrameCamNotMoved=0,this._numMinFrameNotMoved=10,this.camMoved=!1,this._camOldPosition=new t.Vector3(0,0,0),this._camOldTargetPosition=new t.Vector3(0,0,0),this._camShiftedTranslation=new t.Vector3(0,0,0),this.viewProjectionMatrix=new t.Matrix4,this.frustum=new t.Frustum,this._autoShift=!0,this._debugNode=void 0;var a=this.urban.worldSize;(!h.is(a)||a<=0)&&(a=100),this.camera.position.z=a,this.camera.position.x=.5*a,this.camera.position.y=.5*a,this.urban.cropBox&&(this.camera.position.z=Math.max(this.urban.cropBox.getSize().x,this.urban.cropBox.getSize().y),this.camera.position.x=this.urban.cropBox.getShiftedCenter().x,this.camera.position.y=this.urban.cropBox.getShiftedCenter().y),this.target.z=0,this.target.x=this.camera.position.x,this.target.y=this.camera.position.y,this._ngp=(new t.Vector3).copy(this.target),this._dist2ngp=this.camera.position.z,this.terrainHeight=0,this._initialPosition=this.camera.position.clone(),this._initialCenter=this.target.clone(),this._forceShift=!0,this.debugNearGround=!1,e.url.updateSlots.push(this.updateUrl.bind(this)),this.initByUrl(),this.addEvent("onCameraStopped",this.camerastopped.bind(this)),this.hasPointCloud=!1},camerastopped:function(){},getPosition:function(){return this._translateToAbsolutePosition(this.camera.position.clone(),!1)},getTarget:function(){return this._translateToAbsolutePosition(this.target.clone(),!1)},getHeightFromGround:function(){return this.camera.position.z-this.terrainHeight},getGroundHeight:function(){return this.terrainHeight},isInsideWorld:function(){var e=this._getPositionShifted(),t=void 0===this.urban.cropBox?[0,0]:this.urban.cropBox.getShiftedMin(),i=void 0===this.urban.cropBox?[this.urban.worldSize,this.urban.worldSize]:this.urban.cropBox.getShiftedMax();return e.x>t[0]&&e.x<i[0]&&e.y>t[1]&&e.y<i[1]},getScreenPosition:function(e){var t=.5*this.urban.USR.webGLV6Viewer.SCREEN_WIDTH,i=.5*this.urban.USR.webGLV6Viewer.SCREEN_HEIGHT,n=this._translateToRelativePosition(e.clone());return n.applyProjection(this.viewProjectionMatrix),n.x=(1+n.x)*t,n.y=(1-n.y)*i,n},getRadius:function(){r.log(this.camera.fov),r.log(this.camera.position.z),r.log(this.camera.position.z*Math.tan(this.camera.fov*Math.PI/180))},getDistanceCameraToNearGroundPoint:function(){return this._dist2ngp},getCameraNearGroundPoint:function(){return this._ngp},_getCameraNearGroundPoint:function(e){var t=this._getTargetShifted().sub(this._getPositionShifted()),i=t.clone();i.z=0,t.normalize(),i.normalize();var n=Math.min(Math.PI/2,Math.acos(-t.z));n=Math.max(0,n-.5*this.camera.fov*Math.PI/180);var r=i.multiplyScalar((this.camera.position.z-this.terrainHeight)*Math.tan(n)*e);this._ngp=this._getPositionShifted().add(r).setZ(this.terrainHeight);var s=void 0===this.urban.cropBox?[0,0]:this.urban.cropBox.getShiftedMin(),a=void 0===this.urban.cropBox?[this.urban.worldSize,this.urban.worldSize]:this.urban.cropBox.getShiftedMax();if(this._ngp.setX(Math.min(Math.max(s[0],this._ngp.x),a[0])),this._ngp.setY(Math.min(Math.max(s[1],this._ngp.y),a[1])),this._dist2ngp=this._getPositionShifted().sub(this._ngp).length(),this.debugNearGround){var o=this._debugNode.getMatrix(),h=this._translateToAbsolutePosition(this._ngp.clone().sub(this._camShiftedTranslation)),d=.005*this._dist2ngp;o.makeScale(d,d,d/this.urban.USR.scale),o.setPosition(h),this._debugNode.setMatrix(o)}},_debugNearGround:function(e){if(this.debugNearGround=e,this.debugNearGround){if(!h.is(this._debugNode)){var t=new d.Color(0,1,0,1);this._debugNode=l.createSphereNode({radius:10,color:t})}0===this._debugNode.getParents().length&&this.urban.getView3D().getScene().add(this._debugNode)}else h.is(this._debugNode)&&this._debugNode.getParents().length>0&&this.urban.getView3D().getScene().remove(this._debugNode)},_getRatioWorld:function(){var e=this._getPositionShifted();return{x:e.x/this.urban.worldSize,y:e.y/this.urban.worldSize}},_getPositionRelative:function(){return this.camera.position},_getPositionShifted:function(){return new t.Vector3(this.camera.position.x+this._camShiftedTranslation.x,this.camera.position.y+this._camShiftedTranslation.y,this.camera.position.z)},_getTargetShifted:function(){return new t.Vector3(this.target.x+this._camShiftedTranslation.x,this.target.y+this._camShiftedTranslation.y,this.target.z)},_translateToRelativePosition:function(e,t){return!0!==t&&e.sub(this.urban.shiftedPosition),e.sub(this._camShiftedTranslation),e},_translateToAbsolutePosition:function(e,t){return!0!==t&&e.add(this.urban.shiftedPosition),e.add(this._camShiftedTranslation),e},_setRenderer:function(e){e.viewpoints.length>0&&e.removeViewpoint(0),this.viewer=e,this.canvas=e.canvas,e.addViewpoint(this)},update:function(){var e=!1;this.control&&(e=this.control.update(!0)),this._isMoving=e;var i=this.isInsideWorld();if(this._autoShift&&i||this._forceShift){var n=Math.max(1e4,10*this.urban.worldSize/(1<<this.urban.USR.level));if(Math.abs(this.camera.position.x)>n||Math.abs(this.camera.position.y)>n||this._forceShift){this._forceShift=!1;var s=new t.Vector3(-this._camShiftedTranslation.x-this.camera.position.x,-this._camShiftedTranslation.y-this.camera.position.y,0);this.setCameraShift(s)}}else 1!==this.urban.USR.scale&&(this.urban.USR.scale=1,r.log("Scale:",this.urban.USR.scale,"Shift:",this._camShiftedTranslation.x,this._camShiftedTranslation.y),this.urban.USR._rootProjScaled.setMatrix((new t.Matrix4).identity().setPosition(this._camShiftedTranslation.clone().negate())),this.urban.USR._rootProj.setMatrix((new t.Matrix4).identity().setPosition(this._camShiftedTranslation.clone().negate())),this.dispatchEvent("onCameraShift",this));var o=this.camMoved,h=.001*(this.camera.position.z-this.terrainHeight);Math.abs(this.camera.position.x-this._camOldPosition.x)>h||Math.abs(this.camera.position.y-this._camOldPosition.y)>h||Math.abs(this.camera.position.z-this._camOldPosition.z)>h||Math.abs(this.target.x-this._camOldTargetPosition.x)>h||Math.abs(this.target.y-this._camOldTargetPosition.y)>h||Math.abs(this.target.z-this._camOldTargetPosition.z)>h?(this._camOldPosition.set(this.camera.position.x,this.camera.position.y,this.camera.position.z),this._camOldTargetPosition.set(this.target.x,this.target.y,this.target.z),this.camMoved=!0,this.numFrameCamNotMoved=0):this._numFrameCamNotMoved<this._numMinFrameNotMoved?this._numFrameCamNotMoved++:this.camMoved=!1,this.camMoved!==o&&(this.camMoved?this.dispatchEvent("onCameraMoved",this):this.dispatchEvent("onCameraStopped",this));var d=this._ngp.clone().add(this.urban.shiftedPosition);this.terrainHeight=this.urban.USR.getGroundHeight(d.x,d.y),isNaN(this.terrainHeight)?this.terrainHeight=0:this.terrainHeight*=this.urban.USR.scale,this.camera.updateMatrixWorld(),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this._getCameraNearGroundPoint(1);var l=Math.min(this._dist2ngp,this.camera.position.z-this.terrainHeight);this.camera.near=1+Math.max(0,.75*(l-1e3)),this.camera.far=Math.max(1e5,1e3*this.camera.near),this.camera.updateProjectionMatrix(),this.viewProjectionMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.frustum.setFromMatrix(this.viewProjectionMatrix),this._frustum=this.frustum,this.control&&this.control.setCurrentHeight(this.terrainHeight),this.camMoved&&(this.urban.USR._needRender=!0,u.publish(u.eventsList.pointOfView,this.get(),this));var c=this.camMoved,g={eventChannel:c?"/VISU/":"/VISU/SpriteNodeInit",eventType:"@onViewpointChange",viewpoint:this,cameraEye:this.camera.position,cameraTarget:this.target,cameraUp:this.camera.up};return a.publish({event:c?"/VISU/":"/VISU/SpriteNodeInit",data:g}),this.terrainHeight},initByUrl:function(){var e=this.urban.url.getArgument("camera");if(void 0!==e){var i=e.options,n=new t.Vector3(0,0,0),r=new t.Vector2(0,45,0),s=1e3;if(void 0!==i.target){var a=i.target.split(",");if(n.set(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2])),void 0!==i.angle){var o=i.angle.split(",");r.set(parseFloat(o[0]),parseFloat(o[1]))}void 0!==i.length&&(s=parseFloat(i.length)),this.setViewpoint(n,r,s)}}else{var h=this.urban.url.getArgument("viewpoint");if(void 0!==h){var d=h.value.split(",");6===d.length?(this.camera.position=this.urban.USR.viewpoint._translateToRelativePosition(new t.Vector3(parseFloat(d[0]),parseFloat(d[1]),parseFloat(d[2]))),this.camera.up=new t.Vector3(0,0,1),this.target=this.urban.USR.viewpoint._translateToRelativePosition(new t.Vector3(parseFloat(d[3]),parseFloat(d[4]),parseFloat(d[5])))):3===d.length&&(this.camera.position=this.urban.USR.viewpoint._translateToRelativePosition(new t.Vector3(parseFloat(d[0]),parseFloat(d[1]),parseFloat(d[2])+2e3)),this.camera.up=new t.Vector3(0,0,1),this.target=this.urban.USR.viewpoint._translateToRelativePosition(new t.Vector3(parseFloat(d[0]),parseFloat(d[1]),parseFloat(d[2])))),this.camera.lookAt(this.target)}}this.urban.url.hasArgument("viewpoint")&&this.urban.url.removeArgument("viewpoint")},updateUrl:function(e){var t=this.getViewpoint(),i={};i.target=parseFloat(t.target.x.toFixed(3))+","+parseFloat(t.target.y.toFixed(3))+","+parseFloat(t.target.z.toFixed(3)),i.angle=parseFloat(t.angle.x.toFixed(4))+","+parseFloat(t.angle.y.toFixed(4)),i.length=parseFloat(t.length.toFixed(3)),e.setArgument("camera",{options:i})},setLength:function(e){var t=this.getRotationAngle(),i=this.getTarget();return this.set({target:i,angle:t,length:e})},setRotationAngle:function(e){var t=this.getlength(),i=this.getTarget();return this.set({target:i,angle:e,length:t})},set:function(e){var i=e.target,n=e.angle,r=e.length,s=Math.PI/180,a=n.clone().multiplyScalar(s),o=new t.Vector3(-Math.sin(a.x)*Math.sin(a.y),-Math.cos(a.x)*Math.sin(a.y),Math.cos(a.y)).normalize().multiplyScalar(r);this.target=this._translateToRelativePosition(i.clone());var h=i.clone().add(o);return this._initialPosition=h.clone(),this.camera.position=this._translateToRelativePosition(h),this.camera.up=new t.Vector3(Math.sin(a.x)*Math.cos(a.y),Math.cos(a.x)*Math.cos(a.y),Math.sin(a.y)).normalize(),this.camera.lookAt(this.target),u.publish(u.eventsList.pointOfView,{target:i,angle:n,length:r}),this},get:function(){var e=180/Math.PI,i=this.target.clone().sub(this.camera.position),n=(i.clone().normalize(),i.length());i.divideScalar(n);var r=new t.Vector3(0,Math.acos(-i.z),0);return 0!==i.x&&0!==i.y?r.x=-(Math.atan2(i.y,i.x)-Math.PI/2):r.x=-(Math.atan2(this.camera.up.y,this.camera.up.x)-Math.PI/2),{target:this._translateToAbsolutePosition(this.target.clone()),angle:new t.Vector2(r.x*e,r.y*e),length:parseFloat(n.toFixed(3))}},getLength:function(){Math.PI;return this.target.clone().sub(this.camera.position).length()},getRotationAngle:function(){Math.PI;var e=this.target.clone().sub(this.camera.position),i=(e.clone().normalize(),e.length());e.divideScalar(i);var n=new t.Vector3(0,Math.acos(-e.z),0);return 0!==e.x&&0!==e.y?n.x=-(Math.atan2(e.y,e.x)-Math.PI/2):n.x=-(Math.atan2(this.camera.up.y,this.camera.up.x)-Math.PI/2),n},getViewpoint:function(){return this.get()},setViewpoint:function(e,t,i){return this.set({target:e,angle:t,length:i})},offsetCamera:function(e){return h.is(e)&&this.camera.position.add(e),this},offsetTarget:function(e){return h.is(e)&&this.target.add(e),this},setPosition:function(e){return h.is(e)&&(this.camera.position.copy(this._translateToRelativePosition(e.clone())),u.publish(u.eventsList.cameraPosition,e)),this},overwriteTarget:function(e){return h.is(e)&&(this.target.copy(this._translateToRelativePosition(e.clone())),this.camera.lookAt(this.target)),this},logPOV:function(){var e=this.get(),t={className:"Feature",name:"Point of view",visible:!0,PointOfView:{className:"PointOfView"}},i=e.target.toArray();i[0]=i[0].toFixed(4),i[1]=i[1].toFixed(4),i[2]=i[2].toFixed(4);var n=e.angle.toArray();n[0]=n[0].toFixed(4),n[1]=n[1].toFixed(4),t.PointOfView.position=i,t.PointOfView.rotation=n,t.PointOfView.length=e.length.toFixed(4),console.log(JSON.stringify(t))},getCurrentRay:function(e){var i=this.urban.USR.webGLV6Viewer.canvas.getBoundingClientRect(),n=e.clone().sub(new t.Vector2(Math.floor(i.left),Math.floor(i.top)));return this.create3DRayFrom2DPoint(n)},getMousePosition:function(e){var i=this.urban.USR.webGLV6Viewer,n=this.urban.USR.webGLV6Viewer.canvas.getBoundingClientRect(),r=e.clone().sub(new t.Vector2(Math.floor(n.left),Math.floor(n.top)));return r=new t.Vector2(r.x,r.y),i.getMousePosition(r)},fastPick:function(e,t){var i=this.getCurrentRay(e),n=null;return n=this.rayproject(i.origin,i,t),h.is(n)&&(n=this._translateToAbsolutePosition(n.clone())),n},rayproject:function(e,t,i){var n=t.direction.clone().normalize(),r=e.z-i;if(n.z>=0)return null;var s=-r/n.z,a=n.clone().setLength(s),o=e.clone().add(a);return o.clone().sub(e).normalize().sub(t).length()>5e-4&&(o=null),o},featureIntersect:function(e){var t,i=this.urban.USR.webGLV6Viewer;t=this.getMousePosition(e);var n,r=i.computeIntersection(t,i.picking.gpu,i.picking.primitive,!1,{ray:null});if(r.length&&(0,r[0].primitive&&r[0].object._occurrence)){if(r[0].primitive.userData)return r[0].primitive.userData,!0;var a;for(r[0].path=new s,r[0].path.setFromOccurrence(r[0].object._occurrence,THREEDS.SubElement.getFromSGNode(r[0].primitive)),n=0;n<r[0].path.externalPath.length&&!a;++n)r[0].path.externalPath[n].userData instanceof o&&(a=r[0].path.externalPath[n].userData);if(a&&a.get("selectable"))return!0}return!1},exactPick:function(e){var i,n;if(i=this.getMousePosition(e),h.is(i)){if(i.xPix<0)return null;if(i.yPix<0)return null}return n=this.urban.USR.webGLV6Viewer.computeIntersection(i,!0,!1,!0,{ray:null}),h.is(n)&&(n=n[0]),h.is(this.nullNormal)||(this.nullNormal=new t.Vector3(-1,-1,-1)),h.is(n)&&h.is(n.normal)&&!n.normal.equals(this.nullNormal)&&h.is(n.object)&&"XCityInfinitePlane"!==n.object.name?this._translateToAbsolutePosition(n.point.clone()):null},exactPickCPU:function(e){var i,n;if(i=this.getMousePosition(e),h.is(i)){if(i.xPix<0)return null;if(i.yPix<0)return null}return n=this.urban.USR.webGLV6Viewer.computeIntersection(i,!1,!0,!0,{ray:null}),h.is(n)&&(n=n[0]),h.is(this.nullNormal)||(this.nullNormal=new t.Vector3(-1,-1,-1)),h.is(n)&&h.is(n.normal)&&!n.normal.equals(this.nullNormal)&&h.is(n.object)?this._translateToAbsolutePosition(n.point.clone()):null},moveTo:function(e){console.warn("Moveto is not implemented on this controller")},getCamera:function(){if(this.hasPointCloud){var e=this._parent().clone(),t=this.getPosition();t.z=t.z/this.urban.USR.scale;var i=e.matrix.setPosition(t);return e.setMatrix(i),e.updateMatrixWorld(),e.matrixWorldInverse.getInverse(e.matrixWorld),e.updateProjectionMatrix(),e}return this._parent()},getInitialPosition:function(){return this._initialPosition.clone()},reset:function(){this.isInsideWorld();if(this._autoShift||this._forceShift){this._forceShift=!1;var e=this.urban.worldSize;(!h.is(e)||e<=0)&&(e=100);var i=new t.Vector3(-.5*e,-.5*e,0);this.setCameraShift(i)}},setCameraShift:function(e){this._camShiftedTranslation=new t.Vector3(-e.x,-e.y,0),this.target.x-=this.camera.position.x,this.target.y-=this.camera.position.y,this.camera.position.x=0,this.camera.position.y=0,"EPSG:3857"!==n.getDefaultProjection()&&"EPSG:900913"!==n.getDefaultProjection()||(this.urban.USR.scale=n.computeMercatorScaleFactor(this._camShiftedTranslation.x+this.urban.shiftedPosition.x,this._camShiftedTranslation.y+this.urban.shiftedPosition.y,n.getDefaultProjection())),this.urban.USR._rootProjScaled.setMatrix((new t.Matrix4).makeScale(1,1,this.urban.USR.scale).setPosition(e)),this.urban.USR._rootProj.setMatrix((new t.Matrix4).identity().setPosition(e)),h.is(this.urban.USR._freeRobot)&&this.urban.USR._freeRobot.setTarget(this.urban.USR.currentPath,null,this.urban.USR.webGLV6Viewer),this.dispatchEvent("onCameraShift",this)},getAreaInView:function(){var e=this.urban.USR.webGLV6Viewer.canvas.getBoundingClientRect(),t=this.fastPick(xCity.arrayToVector3([e.x,e.y]),0),i=this.fastPick(xCity.arrayToVector3([e.width,e.y]),0),n=this.fastPick(xCity.arrayToVector3([e.width,e.height]),0),r=this.fastPick(xCity.arrayToVector3([e.x,e.height]),0);if(null===t){var s=(a=this.getCurrentRay(xCity.arrayToVector3([e.x,e.height]))).direction.clone().normalize().clone().setLength(this.camera.far);(o=this._translateToAbsolutePosition(a.origin.clone())).x+=s.x,o.y+=s.y,o.z=0,t=o}if(null===i){var a,o;s=(a=this.getCurrentRay(xCity.arrayToVector3([e.width,e.height]))).direction.clone().normalize().clone().setLength(this.camera.far);(o=this._translateToAbsolutePosition(a.origin.clone())).x+=s.x,o.y+=s.y,o.z=0,i=o}var h=void 0!==this.urban.baseReferential.bbox?[this.urban.baseReferential.bbox.xmin,this.urban.baseReferential.bbox.ymin]:[0,0],d=void 0!==this.urban.baseReferential.bbox?[this.urban.baseReferential.bbox.xmax,this.urban.baseReferential.bbox.ymax]:[this.urban.worldSize,this.urban.worldSize],l=void 0===this.urban.cropBox?h:this.urban.cropBox._min,u=void 0===this.urban.cropBox?d:this.urban.cropBox._max,c=function(e,t){var i,n,r=function(e){return(h[0]-i[0])*(e[1]-i[1])>(h[1]-i[1])*(e[0]-i[0])},s=function(){var e=[i[0]-h[0],i[1]-h[1]],t=[n[0]-u[0],n[1]-u[1]],r=i[0]*h[1]-i[1]*h[0],s=n[0]*u[1]-n[1]*u[0],a=1/(e[0]*t[1]-e[1]*t[0]);return[(r*t[0]-s*e[0])*a,(r*t[1]-s*e[1])*a]},a=e;for(var o in i=t[t.length-1],t){var h=t[o],d=a;for(var l in a=[],n=d[d.length-1],d){var u;r(u=d[l])?(r(n)||a.push(s()),a.push(u)):r(n)&&a.push(s()),n=u}i=h}return a}([[l[0],l[1]],[l[0],u[1]],[u[0],u[1]],[u[0],l[1]]],[[t.x,t.y],[r.x,r.y],[n.x,n.y],[i.x,i.y]]);return c.push(c[0]),c}})}),define("DS/UrbanCore/RenderPassManager",["DS/XCityTools/RenderPassManager"],function(e){"use strict";return e}),define("DS/UrbanCore/UndergroundVisualizer",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Plugins/RenderPass","DS/Plugins/ClearPass","DS/UrbanManipulator/UndergroundSelectionManipulator","DS/UrbanManipulator/Manipulator","DS/UrbanManipulator/UndergroundManipulator","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/Mesh/MeshUtils","DS/XCityTools/ShaderTools","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/CanvasNodeTexture","DS/XCityGeometry/Polygon","DS/XCityTools/EventDispatcher","DS/Visualization/TrackballControls","DS/XCityCore/Terrain","DS/XCityRendering/RenderingHandlerPolygon","DS/WebappsUtils/WebappsUtils","DS/XCityTools/Downloader"],function(e,t,i,n,r,s,a,o,h,d,l,u,c,g,f,_,w,p,m,b,v){"use strict";var P=function(t,n,r,s){this._renderPassManager=s,this._viewer=t,this._viewerDiv=t.div,this._viewpoint=n,this._renderer=r,this._undergroundClearDepthPass_id="UNDERGROUND_CLEARDEPTHPASS",this._undergroundStencilPass_id="UNDERGROUND_CROPPASS",this._windowFillPass_id="UNDERGROUND_WINDOWFILLPASS",this._undergroundPrePass_id="UNDERGROUND_PREPASS",this._undergroundPostPass_id="UNDERGROUND_POSTPASS",this._undergroundBboxPass_id="UNDERGROUND_BBOXPASS",this._undergroundClearDepthPass=null,this._undergroundStencilPass=null,this._windowFillPass=null,this._undergroundPrePass=null,this._undergroundPostPass=null,this._windowNode=null,this._undergroundNode=new i("Undg"),this.areaBox=null,this.areaClippingPlanes=null,this.areaTicks=null,this.areaDepthPlanes=null,this.areaInfoNodes=null,this.windowInfoNodes=null,this.areaLevelMarkBLNodes=null,this.areaLevelMarkBRNodes=null,this.areaLevelMarkTLNodes=null,this.areaLevelMarkTRNodes=null,this.WindowLevelMarkBLNodes=null,this.areaLevelGradNodes=null,this.matW=null,this.matA=null,this.lineMat=new u.getCustomShaderMaterial([u.common,u.urbanLights]),this.lineMat.opacity=.2,this.lineMat.transparent=!0,this.lineMat.enableClipPlanes=!1,this.blueColor=new e.Color("#005686"),this.whiteColor=new e.Color("#FFFFFF"),this.lineMat.uniforms.ambient.value=this.whiteColor,this.lineMat.uniforms.diffuse.value=this.whiteColor,this.lineMat.uniforms.specular.value=this.whiteColor,this.lineMat.line=new e.LineBasicMaterial({lineWidth:2,opacity:.6,color:this.blueColor,enableClipPlanes:!1}),u.updateCommonUniforms(this.lineMat),this.window_radius_=1,this.window_position_x_=0,this.window_position_y_=0,this.window_position_z_=0,this.area_size_x_=null,this.area_size_y_=null,this.area_position_x_=null,this.area_position_y_=null,this.areaLeft=null,this.areaRight=null,this.areaTop=null,this.areaBottom=null,this.sizeX=0,this.sizeY=0,this.activated_=!1,this.selecting_area_=!1,this.selecting_window_=!1,this.areaSquare=void 0,this.areaInfoCanvas=void 0,this.areaInfoX=void 0,this.areaInfoY=void 0,this.windowInfoCanvas=void 0,this.windowInfoX=void 0,this.windowInfoY=void 0,this.mode_="DEFAULT",this.window_sizes_=[5,10,15,25,50],this.window_size_index_=2,this.window_moving_=!1,this.window_target_=new e.Vector3(0,0,0),this.last_timestamp_=(new Date).getTime(),this.first_timestamp_=(new Date).getTime(),this.movingPlane=!1,this.clipPlanes=[],this.initMovePlaneToken=null,this.movePlaneToken=null,this.endMovePlaneToken=null,this.initialPos=null,this.rightPlaneNode=null,this.leftPlaneNode=null,this.topPlaneNode=null,this.bottomPlaneNode=null,this.maxDepth=-Math.floor(xCity._urbanImpl.USR._root.children[0].children[0].bBox.min.z),this.maxDepth<=10&&(this.maxDepth=50),void 0!==xCity.widgetData&&(xCity.widgetData.underground_saveDepth=this.maxDepth),this.initialDepth=this.maxDepth,this.saveCircle=null,this.maxHeight=0,this.groundHeight=0,this.tickDistance=25,this.showTicks=!1,this.showPlanes=!1,this.showClippingPlanes=!0,this.init()};return P.prototype={init:function(){d.log("UNDERGROUND VISU DEBUG: init"),this.matW=new e.MeshLambertMaterial({color:16777215}),this.matW.force=!0;var t=function(e,t){t&&(this.matW.map=e,this.matW.force=!0,this.matW.needsUpdate=!0)}.bind(this);if(v.loadTexture(t,"textures/underground/graduation.jpg"),this.matA=new e.MeshLambertMaterial({color:16777215}),this.matA.force=!0,this._undergroundStencilPass=new n(null,null,void 0,!0,!1,!1,this._undergroundStencilPass_id),this._undergroundStencilPass.idString=this._undergroundStencilPass_id,this._undergroundStencilPass.setDisableColorWrite(!0),this._undergroundStencilPass.setDisableDepthWrite(!0),this._undergroundStencilPass.setEnableStencilTest(!0),this._undergroundStencilPass.setEnableStencilWrite(!0),this._undergroundStencilPass.setStencilFunc("ALWAYS"),this._undergroundStencilPass.setStencilOpsSeparate("KEEP","KEEP","INCR_WRAP","DECR_WRAP"),this._undergroundStencilPass.setDisableBackFaceCulling(!0),this._undergroundClearDepthPass=new r(this._undergroundClearDepthPass_id),this._undergroundClearDepthPass.defaults.clear=!1,this._undergroundClearDepthPass.defaults.doClearDepth=!0,this._windowFillPass=new n(null,null,void 0,!0,!1,!1,this._windowFillPass_id),this._windowFillPass.idString=this._windowFillPass_id,this._windowFillPass.setDepthFunc("GREATER"),this._windowFillPass.setEnableStencilTest(!0),this._windowFillPass.setStencilFunc("NOTEQUAL"),this._windowFillPass.setDisableBackFaceCulling(!0),this._undergroundPostPass=new n(null,null,void 0,!0,!1,!1,this._undergroundPostPass_id),this._undergroundPostPass.idString=this._undergroundPostPass_id,this._undergroundPostPass.setEnableStencilTest(!0),this._undergroundPostPass.setStencilFunc("NOTEQUAL"),this._undergroundPrePass=new n(null,null,void 0,!0,!1,!1,this._undergroundPrePass_id),this._undergroundPrePass.idString=this._undergroundPrePass_id,this._undergroundBboxPass=new n(null,null,void 0,!0,!1,!1,this._undergroundBboxPass_id),this._undergroundBboxPass.setEnableStencilTest(!1),this._undergroundBboxPass.idString=this._undergroundBboxPass_id,this._renderPassManager.addPass(this._undergroundPrePass_id,this._undergroundPrePass,{pre:!0}),this._renderPassManager.addPass(this._undergroundStencilPass_id,this._undergroundStencilPass,{post:!0}),this._renderPassManager.addPass(this._windowFillPass_id,this._windowFillPass,{after:this._undergroundStencilPass_id}),this._renderPassManager.addPass(this._undergroundClearDepthPass_id,this._undergroundClearDepthPass,{before:"ClearDepthPass"}),this._renderPassManager.addPass(this._undergroundPostPass_id,this._undergroundPostPass,{after:this._undergroundClearDepthPass_id}),this._renderPassManager.addPass(this._undergroundBboxPass_id,this._undergroundBboxPass,{after:this._undergroundPostPass_id}),this._renderPassManager.disablePass(this._undergroundPrePass_id),this._renderPassManager.disablePass(this._undergroundStencilPass_id),this._renderPassManager.disablePass(this._windowFillPass_id),this._renderPassManager.disablePass(this._undergroundClearDepthPass_id),this._renderPassManager.disablePass(this._undergroundPostPass_id),this._renderPassManager.disablePass(this._undergroundBboxPass_id),this.BL=new e.Vector3,this.TR=new e.Vector3,this.areaInfoNodes=new i("Area Info"),this.windowInfoNodes=new i("Window Info"),void 0===this._renderingProfileManager){this._renderingProfileManager=this._renderer.urban.getRenderingProfileManager(),this.undergroundProfileName="Underground";var s=this._renderingProfileManager.getProfile(this.undergroundProfileName);if(!h.is(s)){(s=this._renderingProfileManager.createProfile(this.undergroundProfileName)).addRendering("Ground",{enableClipPlanes:!0,opacity:.3})}}},reset:function(){"DEFAULT"===this.mode_||("VIEWER"===this.mode_?this._DeactivateViewer():"WINDOW"===this.mode_||!0===this.selecting_window_?this.deactivateWindowMode():"AREA"!==this.mode_&&!0!==this.selecting_area_||this.deactivateAreaMode()),this.removeFromSceneGraph();let e=this.parent_node_;P.call(this,this._viewer,this._viewpoint,this._renderer,this._renderPassManager),this.addToSceneGraph(e)},addToSceneGraph:function(e){this.parent_node_=e,this._undergroundNode.name="Udgnd",this.parent_node_.addChild(this._undergroundNode)},removeFromSceneGraph:function(){this.parent_node_.removeChild(this._undergroundNode)},activate:function(){d.log("UNDERGROUND VISU DEBUG : activate"),void 0===this._renderingProfileManager&&(this._renderingProfileManager=this._renderer.urban.getRenderingProfileManager()),this.activated_||(this._renderer.setControl(this.previousControl),this.activated_=!0)},deactivate:function(){d.log("UNDERGROUND VISU DEBUG : deactivate"),this._renderer.setControl(this.previousControl,{noAnimationOnActivation:!0}),this.activated_=!1,this.selecting_window_=!1,this.selecting_area_=!1},_setClipping:function(e,t){return e.enableClippingPlane(t.plane,t.activate),!1},autoDepth:function(){var e=Math.abs(this._renderer._rootProjScaled.children[0].children[1].bBox.min.z);return e!==1/0&&(this.maxDepth=Math.max(e+10,50)),this.maxDepth},_showGround:function(e){1==e?(this.matW.opacity=.8,this.matW.transparent=!0):(this.matW.opacity=1,this.matW.transparent=!1)},_setOpacity:function(e){this.matW.opacity=e,this.matW.transparent=e<1},_ViewerMode:function(){d.log("UNDERGROUND VISU DEBUG : activateViewerMode"),this._renderPassManager.enablePass(this._undergroundPrePass_id),this._previousProfile=this._renderingProfileManager.getCurrentProfileName(),this._renderingProfileManager.setProfile(this.undergroundProfileName),p.setupUndergroundMode(!0),this.mode_="VIEWER"},_DeactivateViewer:function(){d.log("UNDERGROUND VISU DEBUG : DeactivateViwerMode"),this._renderingProfileManager.setProfile(this._previousProfile),this._renderPassManager.disablePass(this._undergroundPrePass_id),p.setupUndergroundMode(!1),this.mode_="DEFAULT"},_changeRenderingMode:function(){void 0===this._renderingProfileManager&&(this._renderingProfileManager=this._renderer.urban.getRenderingProfileManager()),this._renderPassManager.enablePass(this._undergroundPrePass_id),this._previousProfile=this._renderingProfileManager.getCurrentProfileName(),this._renderingProfileManager.setProfile(this.undergroundProfileName)},activateAreaMode:function(t){var n;d.log("UNDERGROUND VISU DEBUG : activateAreaMode"),this._renderPassManager.enablePass(this._undergroundBboxPass_id),this._renderer.urban.environment.slab._slabCubeMesh3D.setRenderPasses([this._undergroundPrePass_id]),void 0!==xCity.widgetData&&!0===xCity.widgetData.underground_automaticArea_CF&&((t={}).xmin=xCity.widgetData.underground_area_Bbox.xmin,t.ymin=xCity.widgetData.underground_area_Bbox.ymin,t.xmax=xCity.widgetData.underground_area_Bbox.xmax,t.ymax=xCity.widgetData.underground_area_Bbox.ymax),void 0!==t?(this.areaLeft=t.xmin,this.areaBottom=t.ymin,this.areaRight=t.xmax,this.areaTop=t.ymax,n={xmin:this.areaLeft,xmax:this.areaRight,ymin:this.areaBottom,ymax:this.areaTop,height:0},this.previousControl=this._renderer.controls,this.groundHeight=0):(n=this._renderer.undergroundSelectionManip.getData(),this.groundHeight=n.height),this.maxHeight=xCity._urbanImpl.USR.vqt._node.bBox.max.z,this.maxHeight<=0&&(this.maxHeight=100),this.areaBox=new i("areaBox"),this.areaClippingPlanes=new i("areaClippingPlanes"),this.areaDepthPlanes=new i("areaDepthPlanes"),this.areaTicks=new i("areaTicks"),this.ticksHeight=Math.floor(this.groundHeight/this.tickDistance)*this.tickDistance,this._createAreaLine(this.groundHeight-this.maxDepth,this.groundHeight+this.maxHeight),this._createLevelPlanes(this.ticksHeight-this.maxDepth,this.ticksHeight),this._createLevelTicks(this.ticksHeight-this.maxDepth,this.ticksHeight),this.mode_="AREA",this.updateUndergroundSettingsView();var r={};r.target=this._viewpoint.target,r.position=this._viewpoint.camera.position,r.orientation=new e.Vector3(0,0,-1),r.distanceToTarget=r.position.distanceTo(r.target);var s=new e.Vector3((this.areaLeft+this.areaRight)/2,(this.areaBottom+this.areaTop)/2,this.groundHeight);this._renderer.controls.target=s;this.previousControl.params.defaultDistanceOnActivation;var a=Math.max(this.areaRight-this.areaLeft,this.areaTop-this.areaBottom)/(2*Math.tan(.5*this._viewpoint.camera.fov*Math.PI/180));this.activate(),this._renderer.undergroundManip=new o(this._renderer.urban,this._viewpoint,this._viewerDiv,this.previousControl.params,this),this._renderer.undergroundManip.params.defaultDistanceOnActivation=a,this._renderer.undergroundManip.params.minHeight=-1e4,this._renderer.setControl(this._renderer.undergroundManip),this._renderer.undergroundManip.update(!0);var h=new e.Vector3(0,.5,-.5);this._renderer.undergroundManip.moveTo3(this._renderer.undergroundManip.target,this._renderer.undergroundManip.params.defaultDistanceOnActivation,h,this._renderer.undergroundManip.params.manipTransitionDuration);var l=new e.Vector3(this.areaLeft,this.areaBottom,0),c=new e.Vector3(this.areaRight,this.areaTop,0);this._viewpoint._translateToRelativePosition(l),this._viewpoint._translateToRelativePosition(c),this.clipPlanes[0]=new e.Plane(new e.Vector3(1,0,0),-l.x),this.clipPlanes[1]=new e.Plane(new e.Vector3(-1,0,0),c.x),this.clipPlanes[2]=new e.Plane(new e.Vector3(0,1,0),-l.y),this.clipPlanes[3]=new e.Plane(new e.Vector3(0,-1,0),c.y),xCity._urbanImpl.USR.ugVisu.clipPlanes0=this.clipPlanes[0],xCity._urbanImpl.USR.ugVisu.clipPlanes1=this.clipPlanes[1],xCity._urbanImpl.USR.ugVisu.clipPlanes2=this.clipPlanes[2],xCity._urbanImpl.USR.ugVisu.clipPlanes3=this.clipPlanes[3];for(var g=0;g<4;++g)this._renderer.webGLV6Viewer.addClippingPlane(this.clipPlanes[g]);this._renderer.webGLV6Viewer.setClippingPlanes(!0),p.setupUndergroundMode(!0),this.initMovePlaneToken=_.subscribeTo("/VISU/onLeftMouseDown",this._pickingUnderground.bind(this,[])),this.movePlaneToken=_.subscribeTo("/VISU/onMouseMove",this._movePlane.bind(this,[])),this.endMovePlaneToken=_.subscribeTo("/VISU/onLeftMouseUp",this._endMovePlane.bind(this,[]));var f=new u.getCustomShaderMaterial([u.common,u.urbanLights]);f.uniforms.ambient.value=this.blueColor,f.uniforms.diffuse.value=this.blueColor,f.uniforms.specular.value=this.blueColor,f.force=!0,this._renderPassManager.enablePass(this._undergroundPrePass_id),this.oldInfPlaneX=this._renderer.urban.environment.slab._infPlaneMatrix.elements[12],this.oldInfPlaneY=this._renderer.urban.environment.slab._infPlaneMatrix.elements[13],this.oldInfPlaneZ=this._renderer.urban.environment.slab._infPlaneMatrix.elements[14],this.oldInfPlaneScale=this._renderer.urban.environment.slab._infPlaneMatrix.elements[0];var w=this.areaLeft-this._renderer.urban.shiftedPosition.x,m=this.areaRight-this._renderer.urban.shiftedPosition.x,b=this.areaBottom-this._renderer.urban.shiftedPosition.y,v=this.areaTop-this._renderer.urban.shiftedPosition.y;this.oldInfPlaneScale;this._renderer.urban.environment.slab._infPlaneMatrix.elements[12]=(w+m)/2,this._renderer.urban.environment.slab._infPlaneMatrix.elements[13]=(b+v)/2,this._renderer.urban.environment.slab._infPlaneMatrix.elements[14]=this.groundHeight-this.maxDepth-50,this._renderer.urban.environment.slab._infPlaneMesh3D.setMatrix(this._renderer.urban.environment.slab._infPlaneMatrix),document.dispatchEvent(new Event("xCityUndergroundSelectionDone"))},deactivateAreaMode:function(){d.log("UNDERGROUND VISU DEBUG : deactivateAreaMode"),this._renderer.urban.environment.slab._slabCubeMesh3D.setRenderPasses(["GenericOverlayPass"]),this._renderPassManager.disablePass(this._undergroundBboxPass_id),this._destroyAreaNodes(),this.area_size_x_=2,this.area_size_y_=2,this.area_position_x_=-1,this.area_position_y_=-1,_.unsubscribe(this.initMovePlaneToken),_.unsubscribe(this.movePlaneToken),_.unsubscribe(this.endMovePlaneToken),this.deactivate(),this._renderingProfileManager.setProfile(this._previousProfile),this._renderer.webGLV6Viewer.setClippingPlanes(!1),this._renderer.webGLV6Viewer.removeClippingPlane(this.clipPlanes[0]),this._renderer.webGLV6Viewer.removeClippingPlane(this.clipPlanes[1]),this._renderer.webGLV6Viewer.removeClippingPlane(this.clipPlanes[2]),this._renderer.webGLV6Viewer.removeClippingPlane(this.clipPlanes[3]);for(var e=0;e<4;++e)this.clipPlanes[e]=null;this.mode_="DEFAULT",this._renderPassManager.disablePass(this._undergroundPrePass_id),p.setupUndergroundMode(!1),this._renderer.urban.environment.slab._infPlaneMatrix.elements[12]=this.oldInfPlaneX,this._renderer.urban.environment.slab._infPlaneMatrix.elements[13]=this.oldInfPlaneY,this._renderer.urban.environment.slab._infPlaneMatrix.elements[14]=this.oldInfPlaneZ,this._renderer.urban.environment.slab._infPlaneMesh3D.setMatrix(this._renderer.urban.environment.slab._infPlaneMatrix)},activateWindowMode:function(){d.log("UNDERGROUND VISU DEBUG : activateWindowMode"),this.WindowTicks=new i("WindowTicks"),this.ticksHeight=25*Math.floor(this.groundHeight/25),this._createLevelTicksWindow(this.ticksHeight-this.maxDepth,this.ticksHeight),this.activate();var t={};t.target=this._viewpoint.target,t.position=this._viewpoint.camera.position,t.orientation=new e.Vector3(0,0,-1),t.distanceToTarget=t.position.distanceTo(t.target);var n=new e.Vector3(this.window_position_x_,this.window_position_y_,this.groundHeight);this._renderer.controls.target=n;this.previousControl.params.defaultDistanceOnActivation;var r=2*this.window_radius_/(2*Math.tan(.5*this._viewpoint.camera.fov*Math.PI/180));this._renderer.undergroundManip=new o(this._renderer.urban,this._viewpoint,this._viewerDiv,this.previousControl.params,this),this._renderer.undergroundManip.params.defaultDistanceOnActivation=r,this._renderer.undergroundManip.params.minHeight=-1e4,this._renderer.setControl(this._renderer.undergroundManip),this._renderer.undergroundManip.update(!0);var s=new e.Vector3(0,.5,-.5);this._renderer.undergroundManip.moveTo3(this._renderer.undergroundManip.target,this._renderer.undergroundManip.params.defaultDistanceOnActivation,s,this._renderer.undergroundManip.params.manipTransitionDuration),this.mode_="WINDOW",xCity._urbanImpl.USR.ugVisu.updateUndergroundSettingsView()},deactivateWindowMode:function(){d.log("UNDERGROUND VISU DEBUG : deactivateWindowMode"),xCity._urbanImpl.USR.ugVisu.updateUndergroundSettingsView(),this._undergroundNode.removeChild(this.windowInfoNodes),this.deactivate(),this._destroyWindowModel(),this._renderPassManager.disablePass(this._undergroundStencilPass_id),this._renderPassManager.disablePass(this._windowFillPass_id),this._renderPassManager.disablePass(this._undergroundPostPass_id),this.mode_="DEFAULT"},updateUndergroundSettingsView:function(){"AREA"==this.mode_&&(this.showTicks?(this.showPlanes?this._updatePlanes():this._undergroundNode.remove(this.areaDepthPlanes),this._updateTicks()):(this.areaTicks.remove(this.areaLevelMarkBLNodes),this.areaTicks.remove(this.areaLevelMarkBRNodes),this.areaTicks.remove(this.areaLevelMarkTLNodes),this.areaTicks.remove(this.areaLevelMarkTRNodes),this.areaTicks.remove(this.areaLevelGradNodes),this._undergroundNode.remove(this.areaDepthPlanes)),this.showClippingPlanes?(this.areaClippingPlanes.removeChildren(),this._createAreaPlanes(this.groundHeight-this.maxDepth,this.groundHeight+this.maxHeight,!0)):(this.areaClippingPlanes.removeChildren(),this._createAreaPlanes(this.groundHeight-this.maxDepth,this.groundHeight+this.maxHeight,!1))),"WINDOW"==this.mode_&&(this.showTicks?!1===xCity.widgetData.underground_showTicks_CF?this.WindowTicks.remove(this.WindowLevelMarkBLNodes):this._updateTicks():this.WindowTicks.remove(this.WindowLevelMarkBLNodes))},_updateBox:function(){"AREA"==this.mode_&&(this.areaBox.removeChildren(),this.areaClippingPlanes.removeChildren(),this._createAreaLine(this.groundHeight-this.maxDepth,this.groundHeight+this.maxHeight),this._createAreaPlanes(this.groundHeight-this.maxDepth,this.groundHeight+this.maxHeight,this.showClippingPlanes),this._renderer.urban.environment.slab._infPlaneMatrix.elements[14]=this.groundHeight-this.maxDepth-50,this._renderer.urban.environment.slab._infPlaneMesh3D.setMatrix(this._renderer.urban.environment.slab._infPlaneMatrix))},_updateTicks:function(){this.ticksHeight=Math.floor(this.groundHeight/this.tickDistance)*this.tickDistance,"AREA"==this.mode_&&(this.areaTicks.removeChildren(),this._createLevelTicks(this.ticksHeight-this.maxDepth,this.ticksHeight)),"WINDOW"==this.mode_&&(this.WindowTicks.removeChildren(),this._createLevelTicksWindow(this.ticksHeight-this.maxDepth,this.ticksHeight))},_updatePlanes:function(){"AREA"==this.mode_&&(this.areaDepthPlanes.removeChildren(),this._createLevelPlanes(this.ticksHeight-this.maxDepth,this.ticksHeight))},updateAreaInfo:function(){if("AREA"==this.mode_)this._updateBox(),this._updateTicks(),this._updatePlanes();else if("WINDOW"==this.mode_){var e=this._windowNode.getMatrix();e.elements[14]=-this.maxDepth,this._windowNode.setMatrix(e),this._windowNode._updateMatrix()}},update:function(){var i=(new Date).getTime();if("WINDOW"===this.mode_){if(1===this._renderer.controls.buttonDown&&-1===this._renderer.controls.currentState){xCity._urbanImpl.USR._needRender=!0,xCity._urbanImpl.USR.ugVisu.updateUndergroundSettingsView();var n=this._renderer.controls.exactPick(this._renderer.controls.currentXY,!0);if(n){(D=this._windowNode.getMatrix()).elements[12]=n.x,D.elements[13]=n.y,this._windowNode.setMatrix(D),this._windowNode._updateMatrix(),this.underground_Window_mvnt_ticks=!0,this.underground_NewposX=n.x,this.underground_NewposY=n.y;var r=parseInt(Math.abs(this.BL.y-this.TR.y).toFixed(0)),s=parseInt(Math.abs(this.BL.x-this.TR.x).toFixed(0));this.TR.x=n.x+s,this.TR.y=n.y,this.BL.x=n.x,this.BL.y=n.y-r;var a=this.windowInfoX.getMatrix();a.elements[12]=.6*this.BL.x+.4*this.TR.x,a.elements[13]=this.BL.y,this.windowInfoX.setMatrix(a),this.windowInfoX._updateMatrix();var o=this.windowInfoY.getMatrix();o.elements[12]=this.BL.x,o.elements[13]=.5*this.BL.y+.5*this.TR.y,this.windowInfoY.setMatrix(o),this.windowInfoY._updateMatrix();var h=this.windowInfoCanvas.getMatrix();h.elements[12]=.6*this.BL.x+.4*this.TR.x,h.elements[13]=.5*this.BL.y+.5*this.TR.y,this.windowInfoCanvas.setMatrix(h),this.windowInfoCanvas._updateMatrix()}}}else if("AREA"===this.mode_){xCity._urbanImpl.USR._needRender=!0;var d=new e.Vector3(this.areaLeft,this.areaBottom,0),l=new e.Vector3(this.areaRight,this.areaTop,0);if(this._viewpoint._translateToRelativePosition(d),this._viewpoint._translateToRelativePosition(l),this.clipPlanes[0].constant=-d.x,this.clipPlanes[1].constant=l.x,this.clipPlanes[2].constant=-d.y,this.clipPlanes[3].constant=l.y,this.showTicks){var u=this._viewpoint.getPosition(),c=new e.Vector3(this.areaLeft,this.areaBottom,u.z),_=new e.Vector3(this.areaRight,this.areaBottom,u.z),w=new e.Vector3(this.areaLeft,this.areaTop,u.z),p=new e.Vector3(this.areaRight,this.areaTop,u.z),b=(new e.Vector3).subVectors(u,c).length(),v=(new e.Vector3).subVectors(u,_).length(),P=(new e.Vector3).subVectors(u,w).length(),x=(new e.Vector3).subVectors(u,p).length();switch(Math.max(b,v,P,x)){case b:this.areaTicks.remove(this.areaLevelMarkBLNodes),this.areaTicks.addChild(this.areaLevelMarkTRNodes),this._sign(u,p,_)>0?this.areaTicks.addChild(this.areaLevelMarkBRNodes):this.areaTicks.remove(this.areaLevelMarkBRNodes),this._sign(u,w,p)>0?this.areaTicks.addChild(this.areaLevelMarkTLNodes):this.areaTicks.remove(this.areaLevelMarkTLNodes);break;case v:this.areaTicks.remove(this.areaLevelMarkBRNodes),this.areaTicks.addChild(this.areaLevelMarkTLNodes),this._sign(u,w,p)>0?this.areaTicks.addChild(this.areaLevelMarkTRNodes):this.areaTicks.remove(this.areaLevelMarkTRNodes),this._sign(u,c,w)>0?this.areaTicks.addChild(this.areaLevelMarkBLNodes):this.areaTicks.remove(this.areaLevelMarkBLNodes);break;case P:this.areaTicks.remove(this.areaLevelMarkTLNodes),this.areaTicks.addChild(this.areaLevelMarkBRNodes),this._sign(u,_,c)>0?this.areaTicks.addChild(this.areaLevelMarkBLNodes):this.areaTicks.remove(this.areaLevelMarkBLNodes),this._sign(u,p,_)>0?this.areaTicks.addChild(this.areaLevelMarkTRNodes):this.areaTicks.remove(this.areaLevelMarkTRNodes);break;case x:this.areaTicks.remove(this.areaLevelMarkTRNodes),this.areaTicks.addChild(this.areaLevelMarkBLNodes),this._sign(u,c,w)>0?this.areaTicks.addChild(this.areaLevelMarkTLNodes):this.areaTicks.remove(this.areaLevelMarkTLNodes),this._sign(u,_,c)>0?this.areaTicks.addChild(this.areaLevelMarkBRNodes):this.areaTicks.remove(this.areaLevelMarkBRNodes)}}}else if(this.selecting_area_){if(xCity._urbanImpl.USR._needRender=!0,this._renderer.undergroundSelectionManip.isSelectionDone()){this.selecting_area_=!1,this._undergroundNode.remove(this.areaInfoNodes);var M=this._renderer.undergroundSelectionManip.getFinalAreaBL(),S=this._renderer.undergroundSelectionManip.getFinalAreaTR();this.defineArea(M.x,M.y,S.x,S.y),this.activateAreaMode()}else if(this._renderer.undergroundSelectionManip.isPreviewEnabled()){M=this._renderer.undergroundSelectionManip.getAreaBL(),S=this._renderer.undergroundSelectionManip.getAreaTR();if(this.BL.x!==M.x||this.BL.y!==M.y||this.TR.x!==S.x||this.TR.y!==S.y){this.firstFrameSelection&&(this._undergroundNode.addChild(this.areaInfoNodes),this.firstFrameSelection=!1),this.BL=M,this.TR=S;var C={shape:[new e.Vector3(-.5,-.5,0),new e.Vector3(-.5,.5,0),new e.Vector3(.5,.5,0),new e.Vector3(.5,-.5,0)],rendering:new m(this._renderer.urban)};if(C.rendering.defaultRendering.addOver({renderMode:"overlay",geometricMode:"filled",color:this.blueColor,opacity:.7}),void 0===this.areaSquare){this.areaSquare=new f(this._renderer.urban,C),this.areaInfoNodes.addChild(this.areaSquare);let e=this.areaSquare.getMatrix();e.elements[14]=S.z,this.areaSquare.setMatrix(e)}(D=this.areaSquare.getMatrix()).elements[0]=S.x-M.x,D.elements[5]=S.y-M.y,D.elements[12]=(M.x+S.x)/2,D.elements[13]=(M.y+S.y)/2,this.areaSquare.setMatrix(D),this.areaSquare._updateMatrix();var y=function(e,t,i){e.beginPath(),e.moveTo(0,0),e.lineTo(t,0),e.lineTo(t,i),e.lineTo(0,i),e.lineTo(0,0),e.closePath(),e.fill()},R=160,T=15,V=this.blueColor;if(this.sizeX=Math.abs(M.x-S.x),this.sizeY=Math.abs(M.y-S.y),this.area=this.sizeX/2*(this.sizeY/2)*Math.PI,this.area>1e3?this.area=this.area.toFixed(0):this.area=this.area.toFixed(2),Math.round(Math.abs(M.x-S.x))>=Math.round(Math.abs(M.y-S.y))?this.saveCircle=Math.round(Math.abs(M.x-S.x)):this.saveCircle=Math.round(Math.abs(M.y-S.y)),void 0!==xCity.widgetData&&void 0!==xCity.widgetData.underground_saveCircle&&(xCity.widgetData.underground_saveCircle=this.saveCircle,console.warn("xCity.widgetData.underground_saveCircle should not be used anymore. Instead use xCityUndergroundWindow radius property")),void 0===this.areaInfoCanvas){this.areaInfoCanvasTexture=new g({width:R,height:T,drawCB:function(e,t,i){var n="Area : "+this.sizeX*this.sizeY+" m2";t.fillStyle="#"+V.getHexString(),y(t,7*n.length-8,T),t.font="9pt Arial",t.fillStyle="#b2ccda",t.fillText(n,3,T-3),t.globalAlpha=1,t.strokeStyle="black",t.lineWidth=3}.bind(this),alphaTest:.02}),this.areaInfoCanvas=t.createCanvas2DNode({canvasNodeTexture:this.areaInfoCanvasTexture}),this.areaInfoCanvas.name="AreaInfoCanvas",this.areaInfoNodes.addChild(this.areaInfoCanvas);let e=this.areaInfoCanvas.getMatrix();e.elements[14]=S.z,this.areaInfoCanvas.setMatrix(e)}else this.areaInfoCanvasTexture.requestRedraw();if((D=this.areaInfoCanvas.getMatrix()).elements[12]=.6*M.x+.4*S.x,D.elements[13]=.5*M.y+.5*S.y,this.areaInfoCanvas.setMatrix(D),this.areaInfoCanvas._updateMatrix(),void 0===this.areaInfoX){this.areaInfoXTexture=new g({width:R,height:T,drawCB:function(e,t,i){var n="X : "+this.sizeX+" m";t.fillStyle="#"+V.getHexString(),y(t,7*n.length-8,T),t.font="9pt Arial",t.fillStyle="#b2ccda",t.fillText(n,3,T-3),t.globalAlpha=1,t.strokeStyle="black",t.lineWidth=3}.bind(this),alphaTest:.02}),this.areaInfoX=t.createCanvas2DNode({canvasNodeTexture:this.areaInfoXTexture}),this.areaInfoX.name="areaInfoX",this.areaInfoNodes.addChild(this.areaInfoX);let e=this.areaInfoX.getMatrix();e.elements[14]=S.z,this.areaInfoX.setMatrix(e)}else this.areaInfoXTexture.requestRedraw();if((D=this.areaInfoX.getMatrix()).elements[12]=.6*M.x+.4*S.x,D.elements[13]=M.y,this.areaInfoX.setMatrix(D),this.areaInfoX._updateMatrix(),void 0===this.areaInfoY){this.areaInfoYTexture=new g({width:R,height:T,drawCB:function(e,t,i){var n="Y : "+this.sizeY+" m";t.fillStyle="#"+V.getHexString(),y(t,7*n.length-8,T),t.font="9pt Arial",t.fillStyle="#b2ccda",t.fillText(n,3,T-3),t.globalAlpha=1,t.strokeStyle="black",t.lineWidth=3}.bind(this),alphaTest:.02}),this.areaInfoY=t.createCanvas2DNode({canvasNodeTexture:this.areaInfoYTexture}),this.areaInfoY.name="areaInfoY",this.areaInfoNodes.addChild(this.areaInfoY);let e=this.areaInfoY.getMatrix();e.elements[14]=S.z,this.areaInfoY.setMatrix(e)}else this.areaInfoYTexture.requestRedraw();(D=this.areaInfoY.getMatrix()).elements[12]=M.x,D.elements[13]=.5*M.y+.5*S.y,this.areaInfoY.setMatrix(D),this.areaInfoY._updateMatrix()}}}else if(this.selecting_window_)if(xCity._urbanImpl.USR._needRender=!0,this._renderer.undergroundSelectionManip.isSelectionDone()){this.selecting_window_=!1,this._undergroundNode.remove(this.windowInfoNodes);M=this._renderer.undergroundSelectionManip.getFinalAreaBL(),S=this._renderer.undergroundSelectionManip.getFinalAreaTR();this.window_radius_=Math.max(Math.abs(S.x-M.x),Math.abs(S.y-M.y)),this.activateWindowMode(),document.dispatchEvent(new Event("xCityUndergroundSelectionDone"))}else if(this._renderer.undergroundSelectionManip.isPreviewEnabled()){M=this._renderer.undergroundSelectionManip.getAreaBL(),S=this._renderer.undergroundSelectionManip.getAreaTR();if(this.BL.x!==M.x||this.BL.y!==M.y||this.TR.x!==S.x||this.TR.y!==S.y){if(this.firstFrameSelection)this.windowInfoNodes.pickable=!1,this._undergroundNode.addChild(this.windowInfoNodes),this.firstFrameSelection=!1,this._buildWindowModel(),this._renderPassManager.enablePass(this._undergroundStencilPass_id),this._renderPassManager.enablePass(this._windowFillPass_id),this._renderPassManager.enablePass(this._undergroundClearDepthPass_id),this._renderPassManager.enablePass(this._undergroundPostPass_id),this.window_position_x_=M.x,this.window_position_y_=M.y,(D=this._windowNode.getMatrix()).elements[12]=M.x,D.elements[13]=M.y,this._windowNode.setMatrix(D);this.BL=M,this.TR=S,(D=this._windowNode.getMatrix()).elements[0]=Math.abs(S.x-M.x),D.elements[5]=Math.abs(S.y-M.y),this._windowNode.setMatrix(D),this._windowNode._updateMatrix();var D;y=function(e,t,i){e.beginPath(),e.moveTo(0,0),e.lineTo(t,0),e.lineTo(t,i),e.lineTo(0,i),e.lineTo(0,0),e.closePath(),e.fill()},R=160,T=15,V=this.blueColor;this.area=Math.abs(M.x-S.x)*Math.abs(M.y-S.y)*Math.PI,this.area>1e3?this.area=this.area.toFixed(0):this.area=this.area.toFixed(2),this.sizeX=Math.abs(M.x-S.x),this.sizeY=Math.abs(M.y-S.y),void 0===this.windowInfoCanvas?(this.windowInfoCanvasTexture=new g({width:R,height:T,drawCB:function(e,t,i){var n="Area : "+this.area+" m2";t.fillStyle="#"+V.getHexString(),y(t,7*n.length-8,T),t.font="9pt Arial",t.fillStyle="#b2ccda",t.fillText(n,3,T-3),t.globalAlpha=1,t.strokeStyle="black",t.lineWidth=3}.bind(this),alphaTest:.02}),this.windowInfoCanvas=t.createCanvas2DNode({canvasNodeTexture:this.windowInfoCanvasTexture}),this.windowInfoCanvas.name="WindowInfoCanvas",this.windowInfoNodes.addChild(this.windowInfoCanvas)):this.windowInfoCanvasTexture.requestRedraw(),(D=this.windowInfoCanvas.getMatrix()).elements[12]=.6*M.x+.4*S.x,D.elements[13]=.5*M.y+.5*S.y,this.windowInfoCanvas.setMatrix(D),this.windowInfoCanvas._updateMatrix(),void 0===this.windowInfoX?(this.windowInfoXTexture=new g({width:R,height:T,drawCB:function(e,t,i){var n="X : "+this.sizeX+" m";t.fillStyle="#"+V.getHexString(),y(t,7*n.length-8,T),t.font="9pt Arial",t.fillStyle="#b2ccda",t.fillText(n,3,T-3),t.globalAlpha=1,t.strokeStyle="black",t.lineWidth=3}.bind(this),alphaTest:.02}),this.windowInfoX=t.createCanvas2DNode({canvasNodeTexture:this.windowInfoXTexture}),this.windowInfoX.name="areaInfoX",this.windowInfoNodes.addChild(this.windowInfoX)):this.windowInfoXTexture.requestRedraw(),(D=this.windowInfoX.getMatrix()).elements[12]=.6*M.x+.4*S.x,D.elements[13]=M.y,this.windowInfoX.setMatrix(D),this.windowInfoX._updateMatrix(),void 0===this.windowInfoY?(this.windowInfoYTexture=new g({width:R,height:T,drawCB:function(e,t,i){var n="Y : "+this.sizeY+" m";t.fillStyle="#"+V.getHexString(),y(t,7*n.length-8,T),t.font="9pt Arial",t.fillStyle="#b2ccda",t.fillText(n,3,T-3),t.globalAlpha=1,t.strokeStyle="black",t.lineWidth=3}.bind(this),alphaTest:.02}),this.windowInfoY=t.createCanvas2DNode({canvasNodeTexture:this.windowInfoYTexture}),this.windowInfoY.name="areaInfoY",this.windowInfoNodes.addChild(this.windowInfoY)):this.windowInfoYTexture.requestRedraw(),(D=this.windowInfoY.getMatrix()).elements[12]=M.x,D.elements[13]=.5*M.y+.5*S.y,this.windowInfoY.setMatrix(D),this.windowInfoY._updateMatrix()}}this.last_timestamp_=i},updateWindowUV:function(){this._windowNode.mesh3js.boundingBox.min.clone(),this._windowNode.mesh3js.boundingBox.max.clone();for(var e,t=this.window_radius_,i=0,n=this._windowNode.mesh3js.geometry[0].vertexIndexArray.length;i<n;){var r=this._windowNode.mesh3js.geometry[0].vertexIndexArray[i],s=this._windowNode.mesh3js.geometry[0].vertexIndexArray[i+1],a=this._windowNode.mesh3js.geometry[0].vertexIndexArray[i+2],o=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*r],h=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*r+1],d=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*r+2],l=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*s],u=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*s+1],c=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*s+2],g=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*a],f=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*a+1],_=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*a+2];d===c&&d===_?(e=(o+t)/(2*t),e/=2,this._windowNode.mesh3js.geometry[0].vertexUvArray[3*r]=e,e=(h+t)/(2*t),e/=2,this._windowNode.mesh3js.geometry[0].vertexUvArray[3*r+1]=e,e=(l+t)/(2*t),e/=2,this._windowNode.mesh3js.geometry[0].vertexUvArray[3*s]=e,e=(u+t)/(2*t),e/=2,this._windowNode.mesh3js.geometry[0].vertexUvArray[3*s+1]=e,e=(g+t)/(2*t),e/=2,this._windowNode.mesh3js.geometry[0].vertexUvArray[3*a]=e,e=(f+t)/(2*t),e/=2,this._windowNode.mesh3js.geometry[0].vertexUvArray[3*a+1]=e):(30===d?this._windowNode.mesh3js.geometry[0].vertexUvArray[3*r+1]=.5:-30===d&&(this._windowNode.mesh3js.geometry[0].vertexUvArray[3*r+1]=1),30===c?this._windowNode.mesh3js.geometry[0].vertexUvArray[3*s+1]=.5:-30===c&&(this._windowNode.mesh3js.geometry[0].vertexUvArray[3*s+1]=1),30===_?this._windowNode.mesh3js.geometry[0].vertexUvArray[3*a+1]=.5:-30===_&&(this._windowNode.mesh3js.geometry[0].vertexUvArray[3*a+1]=1)),i+=3}},startAreaSelection:function(e){d.log("UNDERGROUND VISU DEBUG : startAreaSelection : "+e),this._renderer.undergroundSelectionManip=new s(this._renderer.urban,this._viewpoint,this._viewerDiv),this.previousControl=this._renderer.controls,this._renderer.setControl(this._renderer.undergroundSelectionManip),"AREA"===e?this.selecting_area_=!0:"WINDOW"===e&&(this.selecting_window_=!0),this.firstFrameSelection=!0},isSelectingArea:function(){return this.selecting_area_},defineArea:function(e,t,i,n){this.area_position_x_=e,this.area_position_y_=t,this.area_size_x_=i-e,this.area_size_y_=n-t,this.areaLeft=e,this.areaRight=i,this.areaTop=n,this.areaBottom=t},defineWindow:function(e,t,i){this.window_position_x_=e,this.window_position_y_=t,this.window_radius_=i},windowSizeUp:function(){this.window_size_index_<this.window_sizes_.length-1&&(this.window_size_index_++,this.mode_)},windowSizeDown:function(){this.window_size_index_>0&&(this.window_size_index_--,this.mode_)},buildParticuleCylinder:function(){var e,t,i,n,r=this.window_radius_,s=[];for(e=0;e<10;e++)for(i=Math.cos(e*(2*Math.PI)/10),i*=r,n=Math.sin(2*e*Math.PI/10),n*=r,-30,t=0;t<13;t++)s.push(i),s.push(n),s.push(5*t-30);return s},setMaxHeightForWindowMode:function(e){this.maxHeightForWindowMode=e},_scaleArea:function(t,i){(new e.Matrix4).makeScale(t,i,1);this.area_size_x_*=t,this.area_size_y_*=i},_resizeArea:function(e,t){e>=1&&t>=1&&this._scaleArea(e/this.area_size_x_,t/this.area_size_y_)},_moveArea:function(e,t){var i=e-this.area_position_x_,n=t-this.area_position_y_;0!==i&&0!==n&&(this.area_line_node_.translateX(i),this.area_line_node_.translateY(n),this.area_position_x_=e,this.area_position_y_=t)},_scaleWindow:function(e){var t=this._windowNode.getMatrix();t.elements[0]=e,t.elements[5]=e,this._windowNode.setMatrix(t),this._windowNode._updateMatrix(),this.window_radius_=e;var i=e,n=e,r=t.elements[12],s=t.elements[13];this.TR.x=r+n,this.TR.y=s,this.BL.x=r,this.BL.y=s-i;var a=this.windowInfoX.getMatrix();a.elements[12]=.6*this.BL.x+.4*this.TR.x,a.elements[13]=this.BL.y,this.windowInfoX.setMatrix(a),this.windowInfoX._updateMatrix();var o=this.windowInfoY.getMatrix();o.elements[12]=this.BL.x,o.elements[13]=.5*this.BL.y+.5*this.TR.y,this.windowInfoY.setMatrix(o),this.windowInfoY._updateMatrix();var h=this.windowInfoCanvas.getMatrix();h.elements[12]=.6*this.BL.x+.4*this.TR.x,h.elements[13]=.5*this.BL.y+.5*this.TR.y,this.windowInfoCanvas.setMatrix(h),this.windowInfoCanvas._updateMatrix(),this.area=Math.abs(this.BL.x-this.TR.x)*Math.abs(this.BL.y-this.TR.y)*Math.PI,this.area>1e3?this.area=this.area.toFixed(0):this.area=this.area.toFixed(2),this.sizeX=Math.abs(this.BL.x-this.TR.x),this.sizeY=Math.abs(this.BL.y-this.TR.y),this.windowInfoCanvasTexture.requestRedraw(),this.windowInfoXTexture.requestRedraw(),this.windowInfoYTexture.requestRedraw()},_resizeWindow:function(e){this._scaleWindow(e/this.window_radius_)},_moveWindow:function(e,t,i){},_destroyAreaLine:function(){this._undergroundNode.removeChild(this.area_line_node_),this.area_line_node_=null},_createAreaLine:function(n,r){var s,a;this.areaBox=new i("line_node"),(s=[]).push(new e.Vector3(this.areaLeft,this.areaBottom,r)),s.push(new e.Vector3(this.areaLeft,this.areaBottom,n)),(a=t.createLineNode({material:this.lineMat,points:s,color:this.blueColor,width:1})).name="line_node",this.areaBox.addChild(a),(s=[]).push(new e.Vector3(this.areaRight,this.areaBottom,r)),s.push(new e.Vector3(this.areaRight,this.areaBottom,n)),(a=t.createLineNode({material:this.lineMat,points:s,color:this.blueColor,width:1})).name="line_node",this.areaBox.addChild(a),(s=[]).push(new e.Vector3(this.areaRight,this.areaTop,r)),s.push(new e.Vector3(this.areaRight,this.areaTop,n)),(a=t.createLineNode({material:this.lineMat,points:s,color:this.blueColor,width:1})).name="line_node",this.areaBox.addChild(a),(s=[]).push(new e.Vector3(this.areaLeft,this.areaTop,r)),s.push(new e.Vector3(this.areaLeft,this.areaTop,n)),(a=t.createLineNode({material:this.lineMat,points:s,color:this.blueColor,width:1})).name="line_node",this.areaBox.addChild(a),(s=[]).push(new e.Vector3(this.areaLeft,this.areaBottom,r)),s.push(new e.Vector3(this.areaRight,this.areaBottom,r)),s.push(new e.Vector3(this.areaRight,this.areaTop,r)),s.push(new e.Vector3(this.areaLeft,this.areaTop,r)),s.push(new e.Vector3(this.areaLeft,this.areaBottom,r)),(a=t.createLineNode({material:this.lineMat,points:s,color:this.blueColor,width:5})).name="line_node",this.areaBox.addChild(a),(s=[]).push(new e.Vector3(this.areaLeft,this.areaBottom,n)),s.push(new e.Vector3(this.areaRight,this.areaBottom,n)),s.push(new e.Vector3(this.areaRight,this.areaTop,n)),s.push(new e.Vector3(this.areaLeft,this.areaTop,n)),s.push(new e.Vector3(this.areaLeft,this.areaBottom,n)),(a=t.createLineNode({material:this.lineMat,points:s,color:this.blueColor,width:1})).name="line_node",this.areaBox.addChild(a),this._undergroundNode.addChild(this.areaBox)},_createAreaPlanes:function(i,n,r){this.areaClippingPlanes.setRenderPasses([this._undergroundBboxPass_id]),r?(this.lineMat.side=e.DoubleSide,this.lineMat.forceSide=!0,void 0!==this.lineMat._deferredMaterials.depthMaterial&&(this.lineMat._deferredMaterials.depthMaterial.forceSide=!0,this.lineMat._deferredMaterials.depthMaterial.side=e.DoubleSide)):(this.lineMat.side=e.BackSide,this.lineMat.forceSide=!0,void 0!==this.lineMat._deferredMaterials.depthMaterial&&(this.lineMat._deferredMaterials.depthMaterial.forceSide=!0,this.lineMat._deferredMaterials.depthMaterial.side=e.BackSide)),this.bottomPlaneNode=t.createRectangleNode({material:this.lineMat,width:Math.abs(this.areaRight-this.areaLeft),height:Math.abs(n-i),fill:!0,noEdge:!0}),this.bottomPlaneNode.setMatrix((new e.Matrix4).translate(new e.Vector3(this.areaLeft,this.areaBottom,i)).rotateX(Math.PI/2)),r&&(this.bottomPlaneNode.name="BottomPlane"),this.areaClippingPlanes.addChild(this.bottomPlaneNode),this.topPlaneNode=t.createRectangleNode({material:this.lineMat,width:Math.abs(this.areaRight-this.areaLeft),height:Math.abs(n-i),fill:!0,noEdge:!0}),this.topPlaneNode.setMatrix((new e.Matrix4).translate(new e.Vector3(this.areaLeft,this.areaTop,n)).rotateX(-Math.PI/2)),r&&(this.topPlaneNode.name="TopPlane"),this.areaClippingPlanes.addChild(this.topPlaneNode),this.leftPlaneNode=t.createRectangleNode({material:this.lineMat,width:Math.abs(this.areaTop-this.areaBottom),height:Math.abs(n-i),fill:!0,noEdge:!0}),this.leftPlaneNode.setMatrix((new e.Matrix4).translate(new e.Vector3(this.areaLeft,this.areaTop,i)).rotateX(Math.PI/2).rotateY(-Math.PI/2)),r&&(this.leftPlaneNode.name="LeftPlane"),this.areaClippingPlanes.addChild(this.leftPlaneNode),this.rightPlaneNode=t.createRectangleNode({material:this.lineMat,width:Math.abs(this.areaTop-this.areaBottom),height:Math.abs(n-i),fill:!0,noEdge:!0}),this.rightPlaneNode.setMatrix((new e.Matrix4).translate(new e.Vector3(this.areaRight,this.areaBottom,i)).rotateX(Math.PI/2).rotateY(Math.PI/2)),r&&(this.rightPlaneNode.name="RightPlane"),this.areaClippingPlanes.addChild(this.rightPlaneNode),this._undergroundNode.addChild(this.areaClippingPlanes)},_createLevelPlanes:function(n,r){var s,a;this.areaDepthPlanes=new i;for(var o=r;o>=n;o-=this.tickDistance)(s=new u.getCustomShaderMaterial([u.common,u.urbanLights])).uniforms.ambient.value=this.blueColor,s.uniforms.diffuse.value=this.blueColor,s.uniforms.specular.value=this.blueColor,s.transparent=!0,s.uniforms.opacity.value=.4,(a=t.createCuboidNode({cornerPoint:new e.Vector3(this.areaLeft,this.areaBottom,o),firstAxis:new e.Vector3(this.areaRight-this.areaLeft,0,0),secondAxis:new e.Vector3(0,this.areaTop-this.areaBottom,0),thirdAxis:new e.Vector3(0,0,0),material:s})).name="plane_node",this.areaDepthPlanes.addChild(a);this.areaDepthPlanes.pickable=!1,this._undergroundNode.addChild(this.areaDepthPlanes)},_createLevelTicksWindow:function(n,r){this.groundHeight;var s,a,o,h=this.blueColor,d=function(e,t,i){e.beginPath(),e.moveTo(0,0),e.lineTo(t,0),e.lineTo(t,i),e.lineTo(0,i),e.lineTo(0,0),e.closePath(),e.fill()};this.WindowLevelMarkBLNodes=new i("BLNodes");for(var l=r;l>=n;l-=this.tickDistance){var u=new g({width:70,height:15,drawCB:function(e,t,i){var n=l+" m";t.fillStyle="#"+h.getHexString(),d(t,7*n.length+5,15),t.font="9pt Arial",t.fillStyle="#b2ccda",t.fillText(n,3,12),t.globalAlpha=1,t.strokeStyle="black",t.lineWidth=3},alphaTest:.02});this.sizeX>this.sizeY?(this.offset_y=this.window_radius_,this.offset_x=0):(this.offset_x=this.window_radius_,this.offset_y=0),!0===this.underground_Window_mvnt_ticks&&(this.window_position_x_=this.underground_NewposX,this.window_position_y_=this.underground_NewposY),(a=t.createCanvas2DNode({canvasNodeTexture:u})).setMatrix((new e.Matrix4).translate(new e.Vector3(this.window_position_x_+this.offset_y,this.window_position_y_+this.offset_x,l))),a.name="level mark node",this.WindowLevelMarkBLNodes.addChild(a)}this.WindowTicks.addChild(this.WindowLevelMarkBLNodes),this.WindowLevelGradNodes=new i("GradNodes");for(l=r;l>n;l-=this.tickDistance)(o=[]).push(new e.Vector3(this.window_position_x_,this.window_position_y_+this.window_radius_,l)),(s=t.createLineNode({material:this.lineMat,points:o,color:this.blueColor,width:1})).name="tick",this.WindowLevelGradNodes.addChild(s);this.WindowTicks.addChild(this.WindowLevelGradNodes),this.WindowTicks.pickable=!1,this._undergroundNode.addChild(this.WindowTicks),this.underground_Window_mvnt_ticks=!1},_createLevelTicks:function(n,r){this.groundHeight;var s,a,o=this.blueColor,h=function(e,t,i){e.beginPath(),e.moveTo(0,0),e.lineTo(t,0),e.lineTo(t,i),e.lineTo(0,i),e.lineTo(0,0),e.closePath(),e.fill()};this.areaLevelMarkBLNodes=new i("BLNodes"),this.areaLevelMarkBRNodes=new i("BRNodes"),this.areaLevelMarkTLNodes=new i("TLNodes"),this.areaLevelMarkTRNodes=new i("TRNodes");for(var d=r;d>=n;d-=this.tickDistance){var l=new g({width:70,height:15,drawCB:function(e,t,i){var n=d+" m";t.fillStyle="#"+o.getHexString(),h(t,7*n.length+5,15),t.font="9pt Arial",t.fillStyle="#b2ccda",t.fillText(n,3,12),t.globalAlpha=1,t.strokeStyle="black",t.lineWidth=3},alphaTest:.02});(a=t.createCanvas2DNode({canvasNodeTexture:l})).setMatrix((new e.Matrix4).translate(new e.Vector3(this.areaLeft,this.areaBottom,d))),a.name="level mark node",this.areaLevelMarkBLNodes.addChild(a),(a=t.createCanvas2DNode({canvasNodeTexture:l})).setMatrix((new e.Matrix4).translate(new e.Vector3(this.areaRight,this.areaBottom,d))),a.name="level mark node",this.areaLevelMarkBRNodes.addChild(a),(a=t.createCanvas2DNode({canvasNodeTexture:l})).setMatrix((new e.Matrix4).translate(new e.Vector3(this.areaRight,this.areaTop,d))),a.name="level mark node",this.areaLevelMarkTRNodes.addChild(a),(a=t.createCanvas2DNode({canvasNodeTexture:l})).setMatrix((new e.Matrix4).translate(new e.Vector3(this.areaLeft,this.areaTop,d))),a.name="level mark node",this.areaLevelMarkTLNodes.addChild(a)}this.areaTicks.addChild(this.areaLevelMarkBLNodes),this.areaTicks.addChild(this.areaLevelMarkBRNodes),this.areaTicks.addChild(this.areaLevelMarkTLNodes),this.areaTicks.addChild(this.areaLevelMarkTRNodes),this.areaLevelGradNodes=new i("GradNodes");var u,c=(this.areaRight-this.areaLeft)/25,f=(this.areaTop-this.areaBottom)/25;for(d=r;d>n;d-=this.tickDistance)(u=[]).push(new e.Vector3(this.areaLeft,this.areaBottom+f,d)),u.push(new e.Vector3(this.areaLeft,this.areaBottom,d)),u.push(new e.Vector3(this.areaLeft+c,this.areaBottom,d)),(s=t.createLineNode({material:this.lineMat,points:u,color:this.blueColor,width:1})).name="tick",this.areaLevelGradNodes.addChild(s),(u=[]).push(new e.Vector3(this.areaRight-c,this.areaBottom,d)),u.push(new e.Vector3(this.areaRight,this.areaBottom,d)),u.push(new e.Vector3(this.areaRight,this.areaBottom+f,d)),(s=t.createLineNode({material:this.lineMat,points:u,color:this.blueColor,width:1})).name="tick",this.areaLevelGradNodes.addChild(s),(u=[]).push(new e.Vector3(this.areaRight,this.areaTop-f,d)),u.push(new e.Vector3(this.areaRight,this.areaTop,d)),u.push(new e.Vector3(this.areaRight-c,this.areaTop,d)),(s=t.createLineNode({material:this.lineMat,points:u,color:this.blueColor,width:1})).name="tick",this.areaLevelGradNodes.addChild(s),(u=[]).push(new e.Vector3(this.areaLeft+c,this.areaTop,d)),u.push(new e.Vector3(this.areaLeft,this.areaTop,d)),u.push(new e.Vector3(this.areaLeft,this.areaTop-f,d)),(s=t.createLineNode({material:this.lineMat,points:u,color:this.blueColor,width:1})).name="tick",this.areaLevelGradNodes.addChild(s);this.areaTicks.addChild(this.areaLevelGradNodes),this.areaTicks.pickable=!1,this._undergroundNode.addChild(this.areaTicks)},_destroyAreaNodes:function(){this._undergroundNode.removeChildren(),this.areaBox=null,this.areaClippingPlanes=null,this.areaTicks=null,this.areaDepthPlanes=null,this.area_line_node_=null,this.area_grad_node_=null,this.area_info_node_=null,this._areaNode=null},_buildWindowModel:function(){this._windowNode=t.createCylinderNode({bottomCenterPoint:new e.Vector3(this.window_position_x_,this.window_position_y_,this.window_position_z_-this.maxDepth),topCenterPoint:new e.Vector3(this.window_position_x_,this.window_position_y_,this.window_position_z_+1e4),radius:1,material:this.matW}),this._windowNode.setShadow(!1,!1),this.updateWindowUV(),this._undergroundNode.addChild(this._windowNode),this._windowNode.setRenderPasses([this._undergroundStencilPass_id,this._windowFillPass_id])},_destroyWindowModel:function(){this._undergroundNode.removeChild(this._windowNode),this._windowNode=null,this.window_position_z_=0,this.window_position_y_=0,this.window_position_x_=0},_sign:function(e,t,i){return(e.x-i.x)*(t.y-i.y)-(t.x-i.x)*(e.y-i.y)},_pickingUnderground:function(t,i){var n=this._viewer,r=i.from&&i.from.length?i.from[0]:null,s=n.getMousePosition(r.currentPosition),a=n.computeIntersection(s,n.picking.gpu,n.picking.primitive,!0,{ray:null});if(a.length&&a[0].object&&a[0].object._occurrence&&(this.initial3dIntersectionPoint=a[0].point,this.initial3dIntersectionPointTranslated=a[0].point.clone(),"LeftPlane"==a[0].object._occurrence.node.name&&(this.initial3dIntersectionPointTranslated.add(new e.Vector3(1,0,0)),this.movingPlane=1),"RightPlane"==a[0].object._occurrence.node.name&&(this.initial3dIntersectionPointTranslated.add(new e.Vector3(1,0,0)),this.movingPlane=2),"TopPlane"==a[0].object._occurrence.node.name&&(this.initial3dIntersectionPointTranslated.add(new e.Vector3(0,1,0)),this.movingPlane=3),"BottomPlane"==a[0].object._occurrence.node.name&&(this.initial3dIntersectionPointTranslated.add(new e.Vector3(0,1,0)),this.movingPlane=4),this.movingPlane>0)){this._renderer.undergroundManip.enabled=!1;var o=b.getWebappsAssetUrl("UrbanWidget","")+"icons/32/",h="url('"+o+"UrbanPan.png') 15 15, url('"+o+"UrbanPan.cur') 15 15, auto";this._renderer.webGLV6Viewer.div.style.cursor=h,console.log("SET ICON")}},_initMovePlane:function(t,i){this._renderer.undergroundManip.enabled=!1,this.movingPlane=t.planeId,1==t.planeId&&(this.initial3dIntersectionPoint=(new e.Vector3).copy(this.leftPlaneNode.matrix.getPosition())),2==t.planeId&&(this.initial3dIntersectionPoint=(new e.Vector3).copy(this.rightPlaneNode.matrix.getPosition())),3==t.planeId&&(this.initial3dIntersectionPoint=(new e.Vector3).copy(this.topPlaneNode.matrix.getPosition())),4==t.planeId&&(this.initial3dIntersectionPoint=(new e.Vector3).copy(this.bottomPlaneNode.matrix.getPosition())),this.initial3dIntersectionPoint.z=0,this._viewpoint._translateToRelativePosition(this.initial3dIntersectionPoint),this.initial3dIntersectionPointTranslated=(new e.Vector3).copy(this.initial3dIntersectionPoint),1==t.planeId||2==t.planeId?this.initial3dIntersectionPointTranslated.add(new e.Vector3(1,0,0)):this.initial3dIntersectionPointTranslated.add(new e.Vector3(0,1,0))},_movePlane:function(t,i){if(this.movingPlane){var n=(new e.Vector2).copy(i.from[0].getCurrentPosition(this._viewer.canvas)),r=this._viewer.currentViewpoint.create3DRayFrom2DPoint(n).computeShortestPointToLine(this.initial3dIntersectionPoint,this.initial3dIntersectionPointTranslated);this._viewpoint._translateToAbsolutePosition(r),(new e.Matrix4).setPosition(r),1==this.movingPlane&&(this.areaLeft=r.x),2==this.movingPlane&&(this.areaRight=r.x),3==this.movingPlane&&(this.areaTop=r.y),4==this.movingPlane&&(this.areaBottom=r.y),this._updateBox(),this.showTicks&&(this._updateTicks(),this.showPlanes&&this._updatePlanes())}},_endMovePlane:function(e,t){this.movingPlane&&(this.movingPlane=0,this._renderer.undergroundManip.enabled=!0,this._renderer.webGLV6Viewer.div.style.cursor="auto")},_showInformation:function(e){e?this._undergroundNode.addChild(this.windowInfoNodes):this._undergroundNode.removeChild(this.windowInfoNodes)}},P}),define("DS/UrbanCore/PerformanceProfile",["DS/XCityCore/ProfileManager","DS/XCityTools/EventDispatcher","DS/XCityCore/Profile","DS/xCityBasicUtils/Utils"],function(e,t,i,n){"use strict";return i.extend({init:function(e,t){this._parent(e,t)},fromJSON:function(e){for(var t in e)n.is("disabledEffects"===t)?this.setDisabledEffects(e[t]):this.getManager().acceptedValues[t].callback(this._urban,e[t])},addfunction:function(e,t,i){this.hasNodeName(t)?(this.setByName(e,i,t),this._enabled&&e(this._urban,i)):this.getManager().addProfile(this.getName(),e,i,t)},setValue:function(e,t){var i=Math.min(Math.max(t,this.getManager().acceptedValues[e].min),this.getManager().acceptedValues[e].max);this.addfunction(this.getManager().acceptedValues[e].callback,e,i)},getValue:function(e){return this.getNode(e)},getDisabledEffects:function(){return this.getNode("disableEffects")},setDisabledEffects:function(e){var t=e.slice();this.addfunction(function(e,t){e.getEnvironment().disableEffects(t)},"disableEffects",t)},getManager:function(){return this._urban.getPerformanceProfileManager()},renameProfile:function(e,i){this._parent(e,i)&&t.publish(t.eventsList.performanceProfile,i)},_getInputProfile:function(){var e=this._parent(),t=this.getDisabledEffects();for(var i in n.is(t)&&(e.disabledEffects=t),this.getManager().acceptedValues){var r=this.getNode(i);n.is(r)&&(e[i]=r)}return e},clean:function(){this.setDisabledEffects([]);var e=this.getManager();for(var t in e.acceptedValues)n.is(this[t])&&(this[t]=e.acceptedValues[t].defaultValue)}})}),define("DS/UrbanCore/DateTime",["UWA/Class","UWA/Class/Events","DS/XCityTools/Geocoder","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher"],function(e,t,i,n,r,s){"use strict";return UWA.Class.extend(t,{init:function(e){this.urban=e;var t=new Date;this._date=new Date(t.getFullYear(),5,21,12,0,0,0),e.url.updateSlots.push(this.updateUrl.bind(this)),this.initByUrl(),this._initDate=!1,this._implicitShiftEnabled=!0,s.subscribeTo(s.eventsList.config,this.setup.bind(this)),s.publish(s.eventsList.date,this)},reset:function(){var e=new Date;this._initDate=!1,this._implicitShiftEnabled=!0,this._offsetPos=null,this.setDate(new Date(e.getFullYear(),5,21,12,0,0,0))},setup:function(){this._initDate=!0},initByUrl:function(){var e=this.urban.url.getArgument("date");if(void 0!==e){var t=e.value.split(","),i=" "+t[0]+"/"+t[1]+"/"+t[2]+" "+t[3]+":"+t[4]+":"+t[5]+" UTC",n=new Date(i);this.setDate(n)}},setFromConfig:function(e){if(r.is(e)){var t=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*))(?:Z|(\+|-)([\d|:]*))?$/,i=/^\/Date\((d|-|.*)\)[\/|\\]$/,n=JSON.parse(JSON.stringify(e),function(e,n){if("string"==typeof n){var r=t.exec(n);if(r)return new Date(n);if(r=i.exec(n)){var s=r[1].split(/[-+,.]/);return new Date(s[0]?+s[0]:0-+s[1])}}return n});this.setDate(n)}},updateUrl:function(e){e.setArgument("date",this._date.getUTCFullYear()+","+(this._date.getUTCMonth()+1)+","+this._date.getUTCDate()+","+this._date.getUTCHours()+","+this._date.getMinutes()+","+this._date.getSeconds())},setTime:function(e,t,i){return this._date.getHours()===e&&this._date.getMinutes()===t||(this._date.setHours(e),this._date.setMinutes(t),n.log(this._date.toUTCString()),s.publish(s.eventsList.date,this)),this},setLocalTime:function(e,t,n){var r=(new Date).getTimezoneOffset(),a=this.urban.USR.viewpoint.getPosition(),o=i.proj([a.x,a.y],i.getDefaultProjection(),"WGS84");e=Math.floor(o.x/15)-r,this._date.getUTCHours()===e&&this._date.getMinutes()===t||(this._date.setUTCHours(e),this._date.setMinutes(t),s.publish(s.eventsList.date,this))},keepLocalTime:function(){if(this._initDate&&this._implicitShiftEnabled){var e=this.urban.getViewpoint().getPosition();this.urban.baseReferential&&this.urban.baseReferential.bbox&&(e.x<this.urban.baseReferential.bbox.xmin&&(e.x=this.urban.baseReferential.bbox.xmin),e.x>this.urban.baseReferential.bbox.xmax&&(e.x=this.urban.baseReferential.bbox.xmax),e.y<this.urban.baseReferential.bbox.ymin&&(e.y=this.urban.baseReferential.bbox.ymin),e.y>this.urban.baseReferential.bbox.ymax&&(e.y=this.urban.baseReferential.bbox.ymax));var t=i.proj([e.x,e.y],i.getDefaultProjection(),"WGS84");if(r.is(this._offsetPos)){var n=Math.floor(-t.x/15)-this._offsetPos;if(0!==n){this._offsetPos+=n;this._date.getUTCHours()}}else{var s=this.urban.getViewpoint().getInitialPosition(),a=i.proj([s.x,s.y],i.getDefaultProjection(),"WGS84");this._offsetPos=Math.floor(-a.x/15)}}},getDate:function(){return this.urban.localTime?this._localDate:this._date},setDate:function(e,t){if(r.is(e)&&(e instanceof Date||(e=new Date(e)),this._date.getTime()!==e.getTime())){if(t){var i=this._date.getHours();this._date=new Date(e),this._date.setHours(i)}else this._date=new Date(e);s.publish(s.eventsList.date,this)}},enableImplicitShift:function(e){this._implicitShiftEnabled=e},isImplicitShiftenabled:function(){return this._implicitShiftEnabled}})}),define("DS/UrbanCore/PerformanceProfileManager",["DS/XCityCore/ProfileManager","DS/UrbanCore/PerformanceProfile","DS/XCityTools/EventDispatcher","DS/XCityCore/Profile","DS/xCityBasicUtils/Utils","DS/Core/Events"],function(e,t,i,n,r,s){"use strict";return e.extend({init:function(e){this._parent(e,"performance"),this.defaultNewProfile="performanceProfile",s.subscribe({event:"EVT_ACTIONBAR_READY"},function(){console.log("PROUT"),i.publish(i.eventsList.performanceProfile,xCity.performanceProfile)}),this.acceptedValues={quadsPerLevel:{min:6,max:40,defaultValue:6,callback:this.setQuadsPerLevel},maxtextureLOD:{min:-1,max:10,defaultValue:10,callback:this.setMaxTextureLOD},textureLODOffset:{min:-99,max:99,defaultValue:0,callback:this.setTextureLODOffset},textureLODDistanceFactor:{min:1,max:99,defaultValue:1,callback:this.setTextureLODDistanceFactor},maxPointPreview:{min:1e4,max:1e6,defaultValue:4e5,callback:this.setMaxPointPreview},maxLinePreview:{min:1e4,max:5e5,defaultValue:2e5,callback:this.setMaxLinePreview},maxPolygonPreview:{min:1e4,max:2e5,defaultValue:1e5,callback:this.setMaxPolygonPreview},forceWorkerUsageForPreview:{min:0,max:1,defaultValue:0,callback:this.initWebWorker}},this.initialprofile()},setDefaultProfile:function(){this.setProfile(this.initialProfile)},_initEnvironment:function(){var e={name:this.initialProfile,disabledEffects:[]};this._parseOneProfile(e)},initialprofile:function(){this.initialProfile="defaultProfile",r.is(this.getProfile(this.initialProfile))||(this.createProfile(this.initialProfile),this.dispatchAddedEvent(this.initialProfile))},removeProfile:function(e,t,i){e!==this.initialProfile&&this._parent(e,t,i)},_parseOneProfile:function(e,t){var i=!1;r.is(this.getProfile(e.name))||(this.createProfile(e.name),i=!0);var n=[];r.is(e.disabledEffects)&&(n=e.disabledEffects.slice());for(var s in this.addProfile(e.name,function(e,i){r.is(t)||(t=e.getEnvironment()),r.is(t)&&t.disableEffects(i)},n,"disableEffects"),this.acceptedValues){r.is(e[s])||(e[s]=this.acceptedValues[s].defaultValue);var a=Math.min(Math.max(e[s],this.acceptedValues[s].min),this.acceptedValues[s].max);this.addProfile(e.name,this.acceptedValues[s].callback,a,s)}i&&this.dispatchAddedEvent(e.name)},setQuadsPerLevel:function(e,t){r.is(e.USR.vqtPo._qt)&&e.USR.vqtPo._qt.setNbQuadsPerLevelArea(t)},setMaxTextureLOD:function(e,t){},setTextureLODOffset:function(e,t){},setTextureLODDistanceFactor:function(e,t){},initWebWorker:function(e,t){e._initWebWorkers(t)},setMaxPointPreview:function(e,t){},setMaxLinePreview:function(e,t){},setMaxPolygonPreview:function(e,t){},setProfile:function(e,t){this._parent(e,t)&&i.publish(i.eventsList.performanceProfile,e)},_createProfile:function(e,i){return new t(e,i)},dispatchAddedEvent:function(e){i.publish(i.eventsList.performanceProfileAdded,e)},dispatchRemovedEvent:function(e){i.publish(i.eventsList.performanceProfileRemoved,e)},getValue:function(e){var t,i=this.getCurrentProfile();return r.is(i)&&(t=i.getNode(e)),r.is(t)||(i=this.getDefaultProfile(),r.is(i)&&(t=i.getNode(e))),r.is(t)||(t=this.acceptedValues[e].defaultValue),t},reset:function(){(this._parent(),r.is(this.initialProfile))&&this.getProfile(this.initialProfile).clean()}})}),define("DS/UrbanCore/SceneRenderer",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/WebGLV6Viewer","DS/Visualization/Node3D","DS/Visualization/Ambience","DS/UrbanCore/Viewpoint","DS/XCityTools/EventDispatcher","DS/XCityRendering/RenderingManager","DS/UrbanCore/PerformanceProfileManager","DS/UrbanCore/UndergroundVisualizer","DS/UrbanManipulator/Manipulator","DS/UrbanManipulator/GroundManipulator","DS/UrbanManipulator/CarManipulator","DS/UrbanManipulator/FixedManipulator","DS/UrbanManipulator/DrawingManipulator","DS/UrbanManipulator/MeasureAltitudeManipulator","DS/UrbanFeature/View3DHighlighter","DS/UrbanFeature/View3DPicker","DS/XCityModel/View3DContextualMenuManager","DS/UrbanCore/RenderPassManager","DS/UrbanTool/MeasureDistance","DS/UrbanTool/SplashScreen","DS/UrbanTool/Recorder","DS/XCityTools/Downloader","DS/XCityTools/Disposer","DS/XCityTools/Debug","DS/XCityCore/VisuQuadTree","DS/XCityCore/VisuQuadTreeSirocco","DS/XCityCore/Terrain","DS/XCityCore/Store","DS/xCityBasicUtils/Utils","DS/UrbanFeature/Coordinate","DS/XCityEffects/AltitudeEffect","DS/XCityEffects/ViewshedEffect","DS/XCityEffects/AtmosphereEffect","DS/Robot/FreeRobot","DS/Plugins/ClearPass","DS/Plugins/RenderPass","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/UrbanManipulator/CityRobot"],function(e,t,i,n,r,s,a,o,h,d,l,u,c,g,f,_,w,p,m,b,v,P,x,M,S,C,y,R,T,V,D,N,L,E,I,U,k,A,B,G,W,F){"use strict";var O,X=function(e,i){this._initialized=!1,this._needRender=!0,this._oldcode=!1,this._allowRendering=!1,this.viewpoint=null,this.webGLV6Viewer=null,this.controls=null,this.fpscounter=0,this.currentfps=0,this.projector=null,this.renderRequestID=void 0,this.workers=!1,this.urban=e,this.div=this.urban.viewerContainer,this.width=window.getComputedStyle(this.div).width.replace("px",""),this.height=window.getComputedStyle(this.div).height.replace("px",""),this.touchDevice=navigator.maxTouchPoints>0,this._profileRendering=new h(this.urban),this._profilePerformance=new d(this.urban),this._recorder=new M(e),this._renderCallback=void 0,this.renderPassManager=null,this.clock=new t.Clock,this._allowRendering=!0,this.forceUpdate=!1,this.timeUpdate=0,this.timeRender=0,this.preciseTimeUpdate=0,this.preciseTimeRender=0,this.timeDelta=0,this.frameId=0,this.ugVisu=void 0,this._pointToProject={},this.featureSelected=[],this.initialRendering=null,this.initialPerformance=null,this.renderingCurrent="",this.performanceCurrent="",this.level=0,this.originalMaxLevel=20,this.lodBiasPointObject=0,this._numQuadPo=2,this.hwInstancing=!0,N.is(i.debugHWI)&&(this.hwInstancing=i.debugHWI),this.scale=1,this.urban.url.updateSlots.push(this.updateUrl.bind(this)),this._periodicTerrainUpdate=-1,this.INTERSECTED=null,this.projector=new t.Projector,this._root=new r,this._root.name="3DEXPERIENCitySceneRoot",this._rootProj=new r,this._rootProj.name="3DEXPERIENCitySceneRootProj",this._root.add(this._rootProj),this._rootProjScaled=new r,this._rootProjScaled.name="3DEXPERIENCitySceneRootProjScaled",this._root.add(this._rootProjScaled),this._rootProjScaledShifted=new r,this._rootProjScaledShifted.name="3DEXPERIENCitySceneRootProjScaledShifted",this._rootProjScaled.add(this._rootProjScaledShifted),this._rootProjShifted=new r,this._rootProj.name="3DEXPERIENCitySceneRootProjShifted",this._rootProj.add(this._rootProjShifted),this._rootShifted=new r,this._rootShifted.name="3DEXPERIENCitySceneRootShifted",this._root.add(this._rootShifted),this._createViewer(i),this._forceViewerParameters(),o.subscribeTo("/VISU/onSceneGraphUpdate",this._forceRender.bind(this)),o.subscribeTo("/xCity/needRender",this._forceRender.bind(this));var n=this.webGLV6Viewer.getWebGLContext().getSupportedExtensions();if(this.hwInstancing){-1!==n.indexOf("ANGLE_instanced_arrays")?console.log("Hardware instancing available: activated for usage."):(console.log("Hardware instancing NOT available: automatic downgrade to non hardware instancing mode."),this.hwInstancing=!1)}n.indexOf("EXT_shader_texture_lod")>=0?(this.webGLV6Viewer.getWebGLContext().getExtension("EXT_shader_texture_lod"),console.log("Texture Lod extension available : activated for usage")):console.log("Texture Lod extension NOT available : texturing might present some artefacts"),this.webGLV6Viewer.setPicking({activated:!0,displayHL:!0,gpu:!0,computeNormalDepth:!0,primitive:!1}),this.webGLV6Viewer.setPrePicking({activated:!0,gpu:!0,primitive:!1,computeNormalDepth:!1}),this.webGLV6Viewer.setManipulators({activated:!1,preActivate:!1}),this.webGLV6Viewer.ambience.setBackGroundMap({texture:G.whiteMap,mapping:new t.LatLongEnvMapping,pngHdr:!1}),this.renderPassManager=new v(this.webGLV6Viewer.renderer.mainComposer);var s=new A("ClearDepthPass");s.defaults.clear=!1,s.defaults.doClearDepth=!0,this.renderPassManager.addPass("ClearDepthPass",s,{post:!0});var l=new B(null,null,void 0,!0,!1,!1,"GenericOverlayPass");l.idString="GenericOverlayPass",this.renderPassManager.addPass("GenericOverlayPass",l,{after:"ClearDepthPass"});var u=new B(null,null,void 0,!0,!0,!1,"GenericOccludedPass");u.idString="GenericOccludedPass",this.renderPassManager.addPass("GenericOccludedPass",u,{before:"ClearDepthPass"}),G.initialize({webglViewer:this.getGLViewer()}),this.viewpoint=new a(this.urban,40,10,1e4,!1),this.viewpoint._setRenderer(this.webGLV6Viewer);var c=20;V.initialize({webglViewer:this.getGLViewer(),renderingProfileManager:this._profileRendering}),this.vqt=new R(this.urban,"DTM",{qtTest:function(){return++c>20&&(c=0,!0)}}),this._rootProjScaled.add(this.vqt._node);var g=10;this.vqtPo=new T(this.urban,"PointObjects",{qtTest:function(){return++g>20&&(g=0,!0)}}),this._rootProjScaledShifted.add(this.vqtPo._node),o.subscribeTo("/3DEXPERIENCity/onConfig",this.vqt.setup.bind(this.vqt)),o.subscribeTo("/3DEXPERIENCity/onConfig",this.vqtPo.setup.bind(this.vqtPo)),o.subscribeTo("/3DEXPERIENCity/onConfig",V.setup.bind(V)),o.subscribeTo("/3DEXPERIENCity/onConfig",this.initScene.bind(this));D.subscribeTimeStampTo("/3DEXPERIENCity/onPreUpdate"),D.subscribeCleanTo("/3DEXPERIENCity/onPostUpdate",function(){return!0});var f=this;o.subscribeTo("/3DEXPERIENCity/onUpdate",this._computeFPS.bind(this)),y.addCallback("Update",function(){return f.timeUpdate}.bind(this)),y.addCallback("Render",function(){return f.timeRender}.bind(this)),y.addCallback("DrawCalls",function(){return f.webGLV6Viewer.getInfos().render.calls}.bind(this)),y.addCallback("Textures",function(){return f.webGLV6Viewer.getInfos().memory.textures}.bind(this)),y.addCallback("Geometries",function(){return f.webGLV6Viewer.getInfos().memory.geometries}.bind(this)),y.addCallback("Time",function(e){return Math.round(1e3*e)}.bind(this)),y.addCallback("Fps",function(){return f.currentfps}.bind(this)),y.addStates("Viewer",this._debugViewer.bind(this)),y.addStates("Quadtree",this._debugQuadTree.bind(this)),y.addStates("Infos",this._infos.bind(this)),y.addStates("Camera",this._debugCamera.bind(this)),y.addStates("Downloader",this._debugDownloader.bind(this)),this.webGLV6Viewer.getWebGLContext().canvas.addEventListener("webglcontextlost",function(e){e.preventDefault(),y.warn("WebGL context lost...\n****************************"),this.releaseGL(e)}.bind(this),!1),window.onbeforeunload=function(e){y.log("###################################################################"),y.log("Page reloading !"),this.releaseGL(e)}.bind(this),this.webGLV6Viewer.canvas.addEventListener("webglcontextrestored",function(e){y.warn("WebGL context Restored...\n****************************")}.bind(this),!1)};return X.prototype={initPart2:function(e){if(null===this.controls){var t=new w(this.urban,this.viewpoint,this.webGLV6Viewer.div);this.manipulators={default:new u(this.urban,this.viewpoint,this.webGLV6Viewer.div),ground:new c(this.urban,this.viewpoint,this.webGLV6Viewer.div),fixed:new f(this.urban,this.viewpoint,this.webGLV6Viewer.div),altitude:t,measureAltitude:t},this.addDrawingManipulator(),this.addDrawingManipulator(new P(this.urban,"distance")),this.addDrawingManipulator(new P(this.urban,"surface")),this.setControl(this.manipulators.default)}else this.controls.object=this.viewpoint.camera,this.viewpoint.control=this.controls;this._modelPicker=new m(this.urban,this.urban.modelSelection),this._modelHightlighter=new p(this,this.urban.modelSelection),this.setRendering(this.initialRendering,!0),this.setPerformance(this.initialPerformance,!0)},addDrawingManipulator:function(e){N.is(this.manipulators)||(this.manipulators={});var t=new _(this.urban,e,this.viewpoint,this.webGLV6Viewer.div),i=t.type;return this.manipulators[i]||(this.manipulators[i]=t),i},initScene:function(){var e=new t.Matrix4;if(e.identity(),e.setPosition(new t.Vector3(-this.urban.shiftedPosition.x,-this.urban.shiftedPosition.y,0)),this._rootProjScaledShifted.setMatrix(e),this._rootProjShifted.setMatrix(e),this.setRendering(this.initialRendering,!0),this.setPerformance(this.initialPerformance,!0),void 0!==this.pov)N.is(this.pov.angle)?this.pov.angle=new t.Vector2(this.pov.angle.x,this.pov.angle.y):N.is(this.pov.rotation)&&(this.pov.angle=new t.Vector2(this.pov.rotation.x,this.pov.rotation.y)),N.is(this.pov.target)?this.pov.target=new t.Vector3(this.pov.target.x,this.pov.target.y,this.pov.target.z):N.is(this.pov.position)&&(this.pov.target=new t.Vector3(this.pov.position.x,this.pov.position.y,this.pov.position.z)),this.viewpoint.set(this.pov);else{var i=0,n=new t.Vector3(0,0,this.urban.slabAltitude);void 0!==this.urban.cropBox?(n.x=this.urban.cropBox.getCenter().x,n.y=this.urban.cropBox.getCenter().y,i=Math.max(this.urban.cropBox.getSize().x,this.urban.cropBox.getSize().y)):(n.x=.5*this.urban.worldSize+this.urban.shiftedPosition.x,n.y=.5*this.urban.worldSize+this.urban.shiftedPosition.y,i=this.urban.worldSize),this.getControl().teleport(n,i,new t.Vector3(0,0,-1))}o.publish("/3DEXPERIENCity/onSceneReady"),this._initialized=!0},setup:function(e){if(void 0!==e.fov&&(this.viewpoint.camera.fov=e.fov),void 0!==e.pov&&(this.pov=e.pov),e.freezeTerrain&&(this.freezeTerrain=!0),this.urban.environment.setup(),void 0!==e.renderProfiles&&this.getProfileRendering().loadProfiles([e.renderProfiles]),void 0!==e.rendering){var t=this._profileRendering.getProfile(e.rendering);N.is(t)||(t=this._profileRendering.createProfile(e.rendering),this._profileRendering.dispatchAddedEvent(e.rendering)),this._profileRendering.setProfile(e.rendering),this.initialRendering=e.rendering}if(void 0!==e.perfProfiles&&this.getProfilePerformance().loadProfiles([e.perfProfiles]),void 0!==e.performance){var i=this._profilePerformance.getProfile(e.performance);N.is(i)||(i=this._profilePerformance.createProfile(e.performance),this._profilePerformance.dispatchAddedEvent(e.performance)),this._profilePerformance.setProfile(e.performance),this.initialPerformance=e.performance}void 0!==e.defaultRenderingProfileName&&(this.getProfileRendering().renameProfile(this.getProfileRendering().sessionProfileName,e.defaultRenderingProfileName),this.getProfileRendering().sessionProfileName=e.defaultRenderingProfileName),void 0!==e.lodBiasPointObject&&(this.lodBiasPointObject=e.lodBiasPointObject),void 0!==e.numQuadPointObject&&(this._numQuadPo=e.numQuadPointObject),void 0!==e.periodicTerrainUpdate&&(this._periodicTerrainUpdate=e.periodicTerrainUpdate,y.warn("Terrain Quadtree update is "+this._periodicTerrainUpdate+" ms.")),void 0!==e.workers&&(this.workers=e.workers),this.initByUrl()},_createViewer:function(e){var t={div:this.div,defaultLights:!1,defaultAnimationLoop:!1,autoUpdateFrustum:!1,antiAliasing:!0,useShadowMap:!1,debugShadowLight:!1,infinitePlane:!1,displayGrid:!1,debugBSphere:!1,debugPrimitiveBSphere:!1,debugRepBBox:!1,debugPicking:!1,visuFaceMaterialsAsPBR:!0};this.webGLV6Viewer=this._getExternalViewer(e),N.is(this.webGLV6Viewer)?N.is(e.debugVisualOdt)&&console.warn("Debug visual Odt mode impossible on external viewer"):(N.is(e.debugVisualOdt)&&(t.debugContext=!1,t.preserveDrawingBuffer=!0,t.ODTMode=!0),this.webGLV6Viewer=new n(t))},_getExternalViewer:function(e){var t=null;return N.is(this.urban.frmWindow)&&N.is(this.urban.frmWindow.getViewer)&&(t=this.urban.frmWindow.getViewer(),window._frm=this.urban.frmWindow),N.is(e)&&e.viewer?t=e.viewer:N.is(e)&&N.is(e.frmWindow)&&N.is(e.frmWindow.getViewer)&&(t=e.frmWindow.getViewer()),t},_forceViewerParameters:function(){this.webGLV6Viewer.setAutoUpdateLights(!1),this.webGLV6Viewer.setRenderMode("@Point",!0),this.webGLV6Viewer.setRenderMode("@Edge",!0),this.webGLV6Viewer.addNode(this._root),this.webGLV6Viewer.displayPoints(!0),this.webGLV6Viewer.setMaterialMode(!0),this.webGLV6Viewer.displayInfinitePlane(!1),this.webGLV6Viewer.setPicking({primitive:!0}),this.webGLV6Viewer.setPrePicking({activated:!1}),this.webGLV6Viewer.setManipulators({activated:!1}),this.webGLV6Viewer.setIntensityCorrection(!0)},reset:function(e){this.forceUpdate=!1,this._allowRendering=!1,this._initialized=!1,this.workers=!1,this.maxLevel=this.originalMaxLevel,this._profileRendering.reset(),this._profilePerformance.reset(),this._profileRendering.initGroundRendering(V),this.viewpoint.reset(),this.getControl()&&"default"!==this.getControl().type&&this.setControl(this.manipulators.default,{noAnimationOnActivation:!0}),this.vqt.reset(),V.reset(),this.vqtPo.reset(),this.lodBiasPointObject=0,this._allowRendering=!0,void 0!==this.ugVisu&&this.ugVisu.reset(),this.ugVisu=void 0},releaseGL:function(e){y.warn("Release context GL..."),y.warn("-------------------------------------------------------"),this.forceUpdate=!1,this._allowRendering=!1,this._initialized=!1,cancelAnimationFrame(this.renderRequestID),this.renderRequestID=void 0,this.urban.modelSelection.clear(),this.urban.modelRoot.clear(),this.urban._dataModelPrivate.clear(),V.reset(),this.vqt.reset(),this.vqt=void 0,this.vqtPo.reset(),this.vqtPo=void 0,C.disposeV6(this._root,!0),this.webGLV6Viewer.dispose(),this._root=void 0,this._rootProjScaled=void 0,this._rootProjScaledShifted=void 0,this.viewpoint=void 0,this.webGLV6Viewer=void 0,this.controls=void 0,this.vectorDataSources=void 0,this._modelPicker=void 0,this._modelHightlighter=void 0,o.publish("/3DEXPERIENCity/webglcontextlost"),y.warn("-------------------------------------------------------")},initByUrl:function(){var e=this.urban.url.getArgument("render");void 0!==e&&this.setRendering(e.value,!0)},updateUrl:function(e){e.setArgument("render",this.renderingCurrent)},renderLoop:function(){var e=this;!function t(){e.renderRequestID=requestAnimationFrame(t),!0===e._allowRendering&&(e._renderCallback?e._renderCallback(this):e.render(),e.frameId++)}()},releaseScene:function(){C.disposeV6(this._root)},render:function(e){o.publish("/3DEXPERIENCity/onPreUpdate");var i,n,r=Date.now(),s=Date.now(),a=this.clock.getDelta();this.timeDelta=a,this.terrainHeight=this.viewpoint.update();var h=this.viewpoint.getCameraNearGroundPoint().clone(),d={x:h.x/this.urban.worldSize,y:h.y/this.urban.worldSize},l=this.viewpoint.getDistanceCameraToNearGroundPoint();if(this.level=this.getLevel(256,this.maxLevel,l),o.publish("/3DEXPERIENCity/onUpdate",{clockDelta:a,camMoved:this.viewpoint.camMoved,animatedTime:this._recorder._capture?this._recorder._animId/this._recorder._videoFrameRate:this.frameId/this._recorder._videoFrameRate}),this._initialized&&!this.urban.lockQuadtree){var u=new t.Vector2(-this.viewpoint.target.x+this.viewpoint.camera.position.x,-this.viewpoint.target.y+this.viewpoint.camera.position.y);Math.atan(u.length()/(this.viewpoint.camera.position.z-this.viewpoint.target.z));this.vqt.update(this.freezeTerrain?0:this.level,d.x,d.y,this.forceUpdate),this.vqt.display(s),this.vqtPo.update(this.level,d.x,d.y,this.forceUpdate),this.vqtPo.display(s),this.forceUpdate=!1}if(!this.viewpoint.camMoved&&!N.is(this._freeRobot)){var c,g,f=Object.keys(this._pointToProject);for(i=0,n=f.length;i<n;i++)g=(c=this._pointToProject[f[i]]).cbPosition(),c.callback(this.getGroundHeight(g.x,g.y));for(var _ in this._pointToProject)this._pointToProject.hasOwnProperty(_)&&(g=(c=this._pointToProject[_]).cbPosition(),c.callback(this.getGroundHeight(g.x,g.y)))}o.publish("/3DEXPERIENCity/onPostUpdate"),o.publish("/3DEXPERIENCity/onPreRender");var w=Date.now();this._recorder.check(),void 0!==this.ugVisu&&this.ugVisu.update(),this._needRender&&(this._needRender=!1,this.urban.environment.sun.updateLight(this.urban.date),this.webGLV6Viewer.render()),this.webGLV6Viewer.animate();var p=Date.now();this.preciseTimeUpdate=w-r,this.preciseTimeRender=p-w,this.timeUpdate=Math.round(this.preciseTimeUpdate),this.timeRender=Math.round(this.preciseTimeRender),o.publish("/3DEXPERIENCity/onPostRender"),this._recorder.takeASnap()},getLevel:function(e,t,i){var n=Math.min(this.webGLV6Viewer.SCREEN_WIDTH,this.webGLV6Viewer.SCREEN_HEIGHT),r=Math.round(n/e+.5),s=2*i*Math.tan(.5*this.viewpoint.camera.fov*Math.PI/180)/this.urban.worldSize,a=Math.round(Math.log(r)/Math.log(2))-Math.ceil(Math.log(s)/Math.log(2));return Math.min(t,Math.max(a,0))},getGLViewer:function(){return this.webGLV6Viewer},setPerformance:function(e,t){if(e!==this.performanceCurrent||t)return N.is(e)?(this._profilePerformance.setProfile(e),this.performanceCurrent=e):(this._profilePerformance.setDefaultProfile(),this.performanceCurrent=this._profilePerformance.getCurrentProfileName()),this.forceUpdate=!0,this},setRendering:function(e,t){if(e!==this.renderingCurrent||t)return N.is(e)?(this._profileRendering.setProfile(e),this.renderingCurrent=e):(this._profileRendering.setDefaultProfile(),this.renderingCurrent=this._profileRendering.getCurrentProfileName()),this.forceUpdate=!0,this},_debugCamera:function(e){return this.urban.getControl().getText()},_debugDownloader:function(e){return S._getDownloadLogs()},_addPointToProject:function(e,t,i){this._pointToProject[e]={cbPosition:t,callback:i}},_removePointToProject:function(e){delete this._pointToProject[e]},_updatePointToProject:function(e){},getProfileRendering:function(){return this._profileRendering},getProfilePerformance:function(){return this._profilePerformance},getScene:function(){return this._rootProjScaledShifted},getScale:function(){return this.scale},getViewpoint:function(){return this.viewpoint},getPicker:function(){return this._modelPicker},getGroundHeight:function(e,i){var n=new t.Vector2(e,i);if(!this._initialized||!this.isPointInsideWorld(n))return this.urban.slabAltitude;var r=e-this.urban.shiftedPosition.x,s=i-this.urban.shiftedPosition.y,a=this.vqt.getLoadedQuadAt(r/this.urban.worldSize,s/this.urban.worldSize);return void 0!==a?a.getGroundAltitude(r,s):this.urban.slabAltitude},getGroundColor:function(e,i){if(this._initialized){var n=this.viewpoint.exactPick(new t.Vector2(e,i)),r=n.x-this.urban.shiftedPosition.x,s=n.y-this.urban.shiftedPosition.y,a=this.vqt.getLoadedQuadAt(r/this.urban.worldSize,s/this.urban.worldSize);return void 0!==a?a.getGroundColor(r,s):void 0}},isPointInsideWorld:function(e){var t=void 0===this.urban.cropBox?[0,0]:this.urban.cropBox.getShiftedMin(),i=void 0===this.urban.cropBox?[this.urban.worldSize,this.urban.worldSize]:this.urban.cropBox.getShiftedMax();return e.x=e.x-this.urban.shiftedPosition.x,e.y=e.y-this.urban.shiftedPosition.y,e.x>t[0]&&e.x<i[0]&&e.y>t[1]&&e.y<i[1]},getControl:function(){return this.controls},setControl:function(e,t){var i=this.controls;if(N.is(e)){if(N.is(i)&&(i.deactivate(t),void 0!==i.getCurrentKeyframe&&void 0!==e.setKeyframe&&i!==e)){e instanceof _&&i.update(!0);var n=i.getCurrentKeyframe();e.setKeyframe(n)}return this.controls=e,this.viewpoint.control=e,this.controls.activate(t),i!==e&&o.publish(o.eventsList.manipulatorProfile,e.type),!0}return!1},setControlsMode:function(e){this.mode=e},getControlsMode:function(){return this.mode},displayContextualMenu:function(e){return e?b.enable():b.disable()},getQuadtree:function(){return y.warn("Deprecated: 'getQuadtree'."),this.vqt._qt},getRenderPassManager:function(){return this.renderPassManager},getCanvas:function(){return this.webGLV6Viewer.canvas},getRecorder:function(){return this._recorder},allowRendering:function(e){e?(this._allowRendering=!0,this.urban&&this.urban._frmViewerContainer&&(this.urban._frmViewerContainer.style.opacity="1.0")):this._recorder.isRecording()||(this._allowRendering=!1,this.urban&&this.urban._frmViewerContainer&&(this.urban._frmViewerContainer.style.opacity="0.5"))},_infos:function(e){return this.camAltitude=(this.viewpoint.camera.position.z-this.terrainHeight).toFixed(2),"altitude : "+this.camAltitude+" m.<br />height : "+this.terrainHeight+" m.<br />scale : x"+this.scale+"."},_debugQuadTree:function(e){var t="Level : "+this.level;return void 0!==this.vqt&&null!==this.vqt&&(t+=this.vqt.debug(e)),t},_computeFPS:function(){return this.fpscounter++,this.fps+=1e3/(Date.now()-this.initTime),10===this.fpscounter&&(this.currentfps=Math.floor(this.fps/10),this.fps=0,this.fpscounter=0),this.initTime=Date.now(),this.currentfps},_forceRender:function(){this._needRender=!0},_debugViewer:function(e){return"<br />FPS  : "+this.currentfps+"<br />calls  : "+this.webGLV6Viewer.getInfos().render.calls+"<br />texs : "+this.webGLV6Viewer.getInfos().memory.textures+"<br />geom : "+this.webGLV6Viewer.getInfos().memory.geometries+"<br />program  : "+this.webGLV6Viewer.getInfos().memory.programs+"<br />Update :"+this.timeUpdate+"  Render :"+this.timeRender},createUgVisu:function(){this.ugVisu=new l(this.webGLV6Viewer,this.viewpoint,this,this.renderPassManager),this.ugVisu.addToSceneGraph(this._rootProjScaledShifted)},activateAreaMode:function(){void 0===this.ugVisu&&this.createUgVisu(),this.ugVisu.startAreaSelection("AREA")},deactivateAreaMode:function(){void 0===this.ugVisu&&this.createUgVisu(),this.ugVisu.deactivateAreaMode()},activateWindowMode:function(){void 0===this.ugVisu&&this.createUgVisu(),this.ugVisu.startAreaSelection("WINDOW")},deactivateWindowMode:function(){void 0===this.ugVisu&&this.createUgVisu(),this.ugVisu.deactivateWindowMode()},updateCoordinatePosition:function(e){if(N.is(this._runtimeModifiedNodes)&&this._runtimeModifiedNodes.length>0){var i,n,r,s,a,o=this._runtimeModifiedNodes.length;this.webGLV6Viewer.getRobot();for(n=0;n<o;n++)if(i=this._runtimeModifiedNodes[n],N.is(this._identityMatrix)||(this._identityMatrix=new t.Matrix4,this._identityMatrix.identity()),r=i.userData,N.is(r)&&(N.is(r.impl)?a=r.impl.getContent():N.is(r.getContent)&&(a=r.getContent()),N.is(a))){s=a.get("Coordinate"),N.is(s)||(s=new L({projection:this.urban.getUserDefaultProjection()})).create(this.urban);var h=e;s.set("position",h),a.set("Coordinate",s),this._freeRobot.setTarget(this.currentPath,null,this.webGLV6Viewer)}}},askupdateCoordinatesFromMatrices:function(){N.is(this._updateCoordToken)||(this._updateCoordToken=!0,o.subscribeTo("/3DEXPERIENCity/onPostUpdate",this.updateCoordinatesFromMatrices.bind(this),!0))},updateCoordinatesFromMatrices:function(e,i){if(this._updateCoordToken=null,N.is(this._runtimeModifiedNodes)&&this._runtimeModifiedNodes.length>0){var n,r,s,a,h,d=this._runtimeModifiedNodes.length;this.webGLV6Viewer.getRobot();for(r=0;r<d;r++)if(n=this._runtimeModifiedNodes[r],N.is(this._identityMatrix)||(this._identityMatrix=new t.Matrix4,this._identityMatrix.identity()),s=this._robotFeature,N.is(s)&&(N.is(s.impl)?h=s.impl.getContent():N.is(s.getContent)&&(h=s.getContent()),N.is(h))){if(!h.customRobot){a=h.get("Coordinate"),N.is(a)||((a=new L({projection:this.urban.getUserDefaultProjection()})).create(this.urban),a.addEvent("onChange:matrix",this.centerRobot,this));a.get("position"),a.get("rotation");N.is(h._node)?a.setMatrix(h._node.getMatrix()):a.setMatrix(n.getMatrix()),h.set("Coordinate",a),o.publish("/3DEXPERIENCity/robotMoved",{Coordinate:a})}var l=null;if(N.is(this._v2Robot)){l=this.currentPath.getWorldMatrix(this.webGLV6Viewer);var u=this.currentPath.getBoundingSphere().center;h.customRobot||(u.z=a.get("position").z),h.getBaseAltitude&&(u.z=h.getBaseAltitude());var c=new t.Matrix4,g=this.currentPath.getParentPath();g&&g.getWorldMatrix(this.webGLV6Viewer,c);var f=l.clone(),_=(new t.Matrix4).setPosition(u);h.customRobot?h.customRobot():a.setOffsetToRobotCenter(f,_,this.currentPath,c),l.setPosition(u)}this._freeRobot.setTarget(this.currentPath,l,this.webGLV6Viewer)}}},askForCenterrobot:function(){N.is(this.centerRobotToken)||(this.centerRobotToken=o.subscribeTo("/3DEXPERIENCity/onPostUpdate",this.applyCenterRobot.bind(this),!0))},centerRobot:function(){this.askForCenterrobot()},applyCenterRobot:function(){if(N.is(this._freeRobot)&&N.is(this._runtimeModifiedNodes)&&this._runtimeModifiedNodes.length>0){var e,i,n,r,s,a=this._runtimeModifiedNodes.length;this.webGLV6Viewer.getRobot();for(i=0;i<a;i++)if(e=this._runtimeModifiedNodes[i],N.is(this._identityMatrix)||(this._identityMatrix=new t.Matrix4,this._identityMatrix.identity()),n=e.userData,N.is(n)&&(N.is(n.impl)?s=n.impl.getContent():N.is(n.getContent)&&(s=n.getContent()),N.is(s))){r=s.get("Coordinate"),N.is(r)||(r=new L({projection:this.urban.getUserDefaultProjection()})).create(this.urban);r.get("position"),r.get("rotation");var o=null;if(N.is(this._v2Robot)){o=this.currentPath.getWorldMatrix(this.webGLV6Viewer);var h=this.currentPath.getBoundingSphere().center;h.z=r.get("position").z,s.getBaseAltitude&&(h.z=s.getBaseAltitude());var d=new t.Matrix4,l=this.currentPath.getParentPath();l&&l.getWorldMatrix(this.webGLV6Viewer,d);var u=o.clone(),c=(new t.Matrix4).setPosition(h);r.setOffsetToRobotCenter(u,c,this.currentPath,d),o.setPosition(h)}this._freeRobot.setTarget(this.currentPath,o,this.webGLV6Viewer)}}this.centerRobotToken=null},enableRobotV2:function(){this._v2Robot=!0},disableRobotV2:function(){this._v2Robot=!1},_initRobot:function(e){if(!N.is(this._freeRobot)){var n,r=this;if(!0===this._v2Robot){var s;this._freeRobot=new F("robot",this.webGLV6Viewer,!0,!0,this.touchDevice),this._freeRobot.subscribe("ScreenPlaneTranslationBegin",function(e){var t,n=r._runtimeModifiedNodes[0].userData;N.is(n)&&(N.is(n.impl)?t=n.impl.getContent():N.is(n.getContent)&&(t=n.getContent()),N.is(t)&&(s=t._node.getPickable(),t._node.setPickable(i.NOPICKABLE)))}),this._freeRobot.subscribe("ScreenPlaneTranslationEnd",function(e){var t,i=r._runtimeModifiedNodes[0].userData;if(N.is(i)){N.is(i.impl)?t=i.impl.getContent():N.is(i.getContent)&&(t=i.getContent()),N.is(t)&&t._node.setPickable(s);var n=Date.now();N.is(O)&&n-O<500&&xCity.removeChild(i),O=n}});var a=function(){var e=r.getControl();e&&(e.enabled=!1)},o=function(){var e=r.getControl();e&&(e.enabled=!0)},h=(n=["LineTranslationEnd","PlaneTranslationEnd","RotationEnd","ScalingEnd","ScreenPlaneTranslationEnd","LineTranslationManipulation","PlaneTranslationManipulation","RotationManipulation","ScalingManipulation","ScreenPlaneTranslationManipulation"]).length;for(c=0;c<h;c++)u=n[c],this._freeRobot.subscribe(u,this.askupdateCoordinatesFromMatrices.bind(this));var d=["LineTranslationBegin","PlaneTranslationBegin","RotationBegin","ScalingBegin","ScreenPlaneTranslationBegin"];for(c=0;c<h;c++)u=d[c],this._freeRobot.subscribe(u,a.bind(this));var l=["LineTranslationEnd","PlaneTranslationEnd","RotationEnd","ScalingEnd","ScreenPlaneTranslationEnd"];for(c=0;c<h;c++)u=l[c],this._freeRobot.subscribe(u,o.bind(this))}else{this._freeRobot=new k("robot",this.webGLV6Viewer,!0),this._freeRobot.setDisplayScalingNodes(!1);var u,c;h=(n=["LineTranslationEnd","PlaneTranslationEnd","RotationEnd","ScalingEnd","ScreenPlaneTranslationEnd"]).length;for(c=0;c<h;c++)u=n[c],this._freeRobot.subscribe(u,this.updateCoordinatesFromMatrices.bind(this))}N.is(this._runtimeModifiedNodes)||(this._runtimeModifiedNodes=[]),this._runtimeModifiedNodes.push(e),this.webGLV6Viewer.getRobot()||this.webGLV6Viewer.setManipulators({activated:!0,preActivate:!0}),this._rootShifted.setMatrix((new t.Matrix4).identity()),this._rootShifted.addChild(this._freeRobot)}},setRobotVisibility:function(){if(N.is(this._freeRobot)&&N.is(this._robotFeature)){var e=this._robotFeature.get("visible");this._freeRobot.setVisibility(e)}},setRobotTarget:function(e,i){if(N.is(this._robotFeature)&&(this._robotFeature.removeEvent("onDestroy",this.setRobotTarget.bind(this)),this._robotFeature.removeEvent("onChange:visible",this.setRobotVisibility.bind(this)),this._robotFeature=null),N.is(e)&&i){var n;if(N.is(e.impl)?n=e.impl.getContent():N.is(e.getContent)&&(n=e.getContent()),!n)return;n.setRobot&&n.setRobot(i);var r=n._node;if(!N.is(r))return void console.log("no 3D node to modify");this._initRobot(r);var s=N.getUrbanPathElement(r),a=null;if(N.is(this._v2Robot)){if(this._freeRobot.setCityFeature(e),this._freeRobot.setPickingMethod(this.controls.exactPick.bind(this.controls)),a=s.getWorldMatrix(this.webGLV6Viewer),!N.is(a))return;var o=s.getBoundingSphere().center,h=0;N.is(e.impl)?_=e.impl.getContent():N.is(e.getContent)&&(_=e.getContent());var d=!1;if(N.is(_)){n.getBaseAltitude&&(h=n.getBaseAltitude(),d=!0);var l=_.get("Coordinate");if(N.is(l)){d||(h=l.get("position").z);var u=new t.Matrix4,c=s.getParentPath();c&&c.getWorldMatrix(this.webGLV6Viewer,u),o.z=h;var g=a.clone(),f=(new t.Matrix4).setPosition(o);l.setOffsetToRobotCenter(g,f,s,u),l.addEvent("onChange:matrix",this.centerRobot,this)}}o.z=h,a.setPosition(o)}this._freeRobot.setTarget(s,a,this.webGLV6Viewer),this._robotFeature=e,this._robotFeature.addEvent("onDestroy",this.setRobotTarget.bind(this)),this._robotFeature.addEvent("onChange:visible",this.setRobotVisibility.bind(this)),this.setRobotVisibility(),this.currentPath=s,e.set("selected",!0)}else{var _;if(this.disableRobot(),N.is(e))if(e.set("selected",!1),N.is(this._v2Robot))if(N.is(e.impl)?_=e.impl.getContent():N.is(e.getContent)&&(_=e.getContent()),_.setRobot&&_.setRobot(i),N.is(_)){l=_.get("Coordinate");N.is(l)&&l.removeEvent("onChange:matrix",this.centerRobot,this)}}},disableRobot:function(){N.is(this._freeRobot)&&(this._rootShifted.removeChild(this._freeRobot),this._freeRobot=null,this.currentPath=null,this.webGLV6Viewer.getRobot()||this.webGLV6Viewer.setManipulators({activated:!1,preActivate:!1}),this._runtimeModifiedNodes.pop())},getAltitudeEffect:function(){if(void 0===this.altitudeEffect){this.altitudeEffect=new E(this.webGLV6Viewer.renderer,this.webGLV6Viewer.renderer.renderTargetPool,this.urban),this.webGLV6Viewer.renderer.addCustomEffect(this.altitudeEffect);var e=this;o.subscribeTo("/VISU/onMouseMove",function(t){if(e||(e=xCity._urbanImpl.USR),e.altitudeEffect){var i=0;if(N.is(e.altitudeEffect._currentZ))i=e.altitudeEffect._currentZ;else{var n=this.exactPick(t.from[0].getCurrentPosition());n&&(i=n.z)}e.altitudeEffect.mixPass.uniforms.zRef.value=i}}.bind(this.controls))}return this.altitudeEffect},getViewshedEffect:function(){return void 0===this.viewshedEffect&&(this.viewshedEffect=new I(this.webGLV6Viewer.renderer,this.webGLV6Viewer.renderer.renderTargetPool,this._root,this.urban),this.webGLV6Viewer.renderer.addCustomEffect(this.viewshedEffect)),this.viewshedEffect},getAtmosphereEffect:function(){return void 0===this.atmosphereEffect&&(this.atmosphereEffect=new U(this.webGLV6Viewer.renderer,this.webGLV6Viewer.renderer.renderTargetPool,this._root,this.urban),this.webGLV6Viewer.renderer.addCustomEffect(this.atmosphereEffect)),this.atmosphereEffect},setMaxLevel:function(e){e>=0&&(this.maxLevel=e)},dataReadyForRender:function(){return!this.vqt.terrainInProcess&&!this.vqtPo.dataInProcess&&this.urban.environment.sky._iblReady},setOIT:function(e){this.webGLV6Viewer.setOIT(e)},getOIT:function(){return this.webGLV6Viewer.getOIT()},addHighlightSet:function(e,t){N.is(this._highlightsets)||(this._highlightsets={});var i=W._JSONToRendering({highlightSet:t});this._highlightsets[e]=this.webGLV6Viewer.createHighlightSet(i.highlightSet,!0)},getHighlightSet:function(e){var t=null;if(N.is(this._highlightsets)){var i=this._highlightsets[e];N.is(i)&&(t=W._RenderingToJSON({highlightSet:this._highlightsets[e].highlightData}).highlightSet)}return t},activateHighlightSet:function(e){if(N.is(this._highlightsets)){var t=this._highlightsets[e];t?this.webGLV6Viewer.setCurrentHighlightSet(t):this.webGLV6Viewer.setCurrentHighlightSet(null)}},getCurrentHighlightColor:function(){return N.is(this.webGLV6Viewer)&&N.is(this.webGLV6Viewer.highlightColor)?{highlightColor:this.webGLV6Viewer.highlightColor}:null},_addModel:function(){this.getControl().addModel(xCity.selectedItems[0])}},X}),define("DS/UrbanCore/Urban",["require","UWA/Core","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/UrbanCore/DateTime","DS/UrbanCore/SceneRenderer","DS/XCityTools/EventDispatcher","DS/UrbanTool/Url","DS/XCityTools/Geocoder","DS/UrbanTool/Utils","DS/XCityTools/Debug","DS/xCityBasicUtils/AABBox","DS/UrbanTool/FocusManager","DS/UrbanTool/SplashScreen","DS/XCityEnvironment/Environment","DS/XCityLoaders/XCityLoader","DS/XCityGeometry/PointOfInterestManager","DS/XCityGeometry/LabelManager","DS/UrbanFeature/DataModel","DS/UrbanFeature/DataModelSelection","DS/UrbanFeature/Geometry","DS/XCityModel/PointOfInterest","DS/XCityModel/Feature","DS/XCityModel/Folder","DS/UrbanFeature/PointOfView","DS/XCityModel/RasterOverlay","DS/UrbanFeature/Coordinate","DS/XCityModel/View3DContextualMenuManager","DS/XCityTools/Downloader","DS/ApplicationFrame/FrameWindow","DS/XCityCoreUI/DebugUI","DS/UrbanManipulator/Localisator","DS/CSIViewModel3DFrame/CSIViewModel3DFrame","DS/XCityTimeManager/xCityTimer","DS/WebappsUtils/WebappsUtils","DS/XCityModel/WebWorkerPool","DS/XCityModel/WorkerSemaphore","DS/xCityPlatformUtils/xCityPlatformIntegration"],function(e,t,i,n,r,s,a,o,h,d,l,u,c,g,f,_,w,p,m,b,v,P,x,M,S,C,y,R,T,V,D,N,L,E,I,U,k,A){"use strict";function B(e){if(d.is(e)||(e={}),this.url=new o(window.location.href),this._debugMode=void 0,this.viewerContainer=void 0,this.urbanLoaded=!1,this.baseURL="",h.setBaseUrl(this.baseURL),d.is(widget)&&T.setWidget(widget),this.quadKeyToDouble=!0,this.useNormalMap=!0,this.useSpecularMap=!0,this.showQuadtree=!1,this.showQuadtreeLevels=!1,this.showQuadtreeTileInfos=!1,this.showTriangles=!1,this.lockQuadtree=!1,this.baseReferential={},this.projectName="",this.baseProjection="EPSG:900913",this.shiftedPosition={x:0,y:0,z:0},this.worldSize=0,this.slabAltitude=0,this.cropBox=void 0,this.storage=void 0,_.init(this),this.modelLoader=_,this.date=new r(this),this.url.hasArgument("crop"))this.url.getArgument("crop").value.split(",");if(d.is(window.URBANODT))A.urlGlobe="/Web3DXCityVisuTests/assets/data/dataserver";else{this.storage=new UWA.Storage({adapter:"Cookies",database:"geoviacity"});var t=this.storage.get("app");t&&this.url.setParameters(t)}this.modelRoot=new m(this),this._dataModelPrivate=new m(this),this.loader={},this.loader.zae=this.modelRoot.loadModelUrl.bind(this.modelRoot),this.loader.dae=this.modelRoot.loadModelUrl.bind(this.modelRoot),this.loader.json=this.modelRoot.loadJSONUrl.bind(this.modelRoot),this.modelSelection=new b(this),this.modelSelection.addDataModel(this.modelRoot),this.modelSelection.addDataModel(this._dataModelPrivate)}return B.prototype={init:function(e){d.is(e)||(e={}),d.is(e.debugVisualOdt)&&(this._debugVisualOdt=!0),this._initFrmWindow(e),this._createViewerContainer(e),this.USR=new s(this,e),this.USR.getScene().add(this.modelRoot.getNode3D()),this.USR.getScene().add(this._dataModelPrivate.getNode3D()),e.visuPointCloud&&(this.USR.viewpoint.hasPointCloud=!0),c.setRenderer(this.getView3D()),this.url.hasArgument("focus")&&Number(this.url.getArgument("focus").value)&&c.activate(),this.oocManager=null,this.environment=new f(this),this._frmViewerContainer=this.frmWindow.getViewerFrame(),this.poiManager=new w(this),this.labelManager=new p(this),this.USR.initPart2(this),R.initialize(this.USR,this.modelSelection),d.is(e)&&(e.enableRenderLoop=!d.is(e.enableRenderLoop)||e.enableRenderLoop),d.is(e)&&d.is(e.enableRenderLoop)&&e.enableRenderLoop&&this.USR.renderLoop(),this.transitionEnd=d.transitionEndEventName();document.body.addEventListener("drop",function(e){l.log("Drop"),e.preventDefault();var t=e.dataTransfer.files;this.onLocalFile(t)}.bind(this),!1),document.body.addEventListener("dragover",function(e){e.preventDefault()},!1),a.subscribeTo("/3DEXPERIENCity/onUpdate",l.update.bind(l)),this.viewerContainer.parentElement!==this._frmViewerContainer&&this.viewerContainer.inject(this._frmViewerContainer),console.log("DS 3DEXPERIENCity v"+this.getPluginVersion()),g.ready(),a.publish("/3DEXPERIENCity/onInit",this)},_initWebWorkers:async function(e){if(!(window.URBANODT||window.jasmine)||"web_workers_geometries_building"===self.document.title||"3DEXPERIENCity | Web workers ODT"===self.document.title||"labels_visual"===self.document.title||"3DEXPERIENCity | Labels Sample"===self.document.title){const t=this;let i;const n=async function(){if(t.USR.forceUpdate=!0,t.USR.dataReadyForRender()||e){let e;if(i&&a.unsubscribe(i),e=d.is(I.getProxifiedWebappsBaseUrl())&&""!==I.getProxifiedWebappsBaseUrl()?I.getProxifiedWebappsBaseUrl():I.getWebappsBaseUrl(),t.lineSetWorker||(t.lineSetWorker=new U(e+"XCityModelWorkers/LineBuilderSubWorker.js",4,!1)),t.polygonSetWorker||(t.polygonSetWorker=new U(e+"XCityModelWorkers/PolygonBuilderSubWorker.js",6,!1)),t.featureSorterWorkerSem||(t.featureSorterWorkerSem=new k(e+"XCityModelWorkers/FeatureSorterWorker.js",2)),!t.generalWorkerSem){t.generalWorkerSem=new k(e+"XCityModelWorkers/GeneralWorker.js",1);const i=await t.generalWorkerSem.requestWorker();i.worker.postMessage({function:"load"}),i.release()}}},r=function(){i=a.subscribeTo("/3DEXPERIENCity/onPostUpdate",n)};1===e?n():i||setTimeout(r,1e4)}},_initFrmWindow:function(e){d.is(e)&&d.is(e.frmWindow)?this.frmWindow=e.frmWindow:(this.frmWindow=this._createFrameWindow(e),d.is(widget)&&this.frmWindow.inject(widget.body)),d.is(e)&&d.is(e.container)&&this.frmWindow.inject(e.container)},_createFrameWindow:function(e){return e.visuPointCloud?new L({height:"100%",language:d.is(widget)?widget.lang:navigator.language||navigator.userLanguage,viewerOptions:{defaultLights:!1,autoUpdateFrustum:!1,infinitePlane:!1,newModelIdentification:!1,antiAliasing:"SMAA",hdr:!1,useShadowMap:!1,useVignetting:!1,ssao:!1,dof:!1,deferred:!1,defaultAnimationLoop:!0,debugShadowLight:!1,debugBSphere:!1,debugBBox:!1,debugPicking:!1,mirror:!1,displayGrid:!0},uiOptions:{displayTree:!1}}):new V({viewer:"none",height:"100%",language:d.is(widget)?widget.lang:navigator.language||navigator.userLanguage})},_createViewerContainer:function(e){d.is(e)&&d.is(e.viewer)?d.is(e.viewer.div)?this.viewerContainer=e.viewer.div:console.warn("You don't have defined a div for the webGLV6Viewer."):d.is(e)&&d.is(e.div)?this.viewerContainer=e.div:d.is(e)&&d.is(e.frmWindow)&&d.is(e.frmWindow.getViewer)?this.viewerContainer=e.frmWindow.getViewer().div:this.frmWindow&&this.frmWindow.getViewer&&this.frmWindow.getViewer()?this.viewerContainer=this.frmWindow.getViewer().div:this.viewerContainer=UWA.Element("div"),this.viewerContainer.setStyles({position:"relative",backgroundColor:"white",width:"100%",height:"100%"}),this.viewerContainer.id="xCityViewer"},getPluginVersion:function(){return"R425.23.02"},reset:function(){g.loading(),this.baseReferential={},this.baseProjection="EPSG:900913",this.worldSize=0,this.shiftedPosition={x:0,y:0,z:0},h.setDefaultProjection(this.baseProjection),this.projectName="",document.title="3DEXPERIENCity",this.slabAltitude=0,this.url.hasArgument("crop")||(this.cropBox=void 0),T.reset(),this.poiManager.reset(),this.date.reset(),this.USR.reset(this),this.modelRoot.removeChildren(),this._dataModelPrivate.removeChildren(),this.modelSelection.clear(),a.publish("/3DEXPERIENCity/onReset",this),g.ready()},setup:function(e,t){var i=function(e,t,n,r,s){var o=!0;try{for(var l={},c=0;c<e.length;c++)UWA.extend(l,e[c],!0);var f=l.UrbanProject||{};if(this._coreVersion="R425.23.02",f.version)this._coreVersion=f.version;else if(f.date){void 0===Date.getWeek&&(Date.prototype.getWeek=function(){var e=new Date(this.getTime());e.setHours(0,0,0,0),e.setDate(e.getDate()+3-(e.getDay()+6)%7);var t=new Date(e.getFullYear(),0,4);return 1+Math.round(((e.getTime()-t.getTime())/864e5-3+(t.getDay()+6)%7)/7)});var _=new Date(f.date),w=_.getWeek(),p=_.getFullYear(),m="R425.23.02".split(".");m[0]=Number(m[0].split("R")[1]),m[1]=Number(m[1]),m[2]=Number(m[2]),p===2e3+m[1]&&w>=m[2]&&(this._coreVersion="R425.23.02")}d.is(f.referential)&&(this.baseReferential.title=f.referential.title,this.baseReferential.proj=f.referential.proj,this.baseReferential.yTopToBottom=f.referential.yTopToBottom,this.baseReferential.bbox=f.referential.bbox);var b=d.is(this.baseReferential.proj)?this.baseReferential.proj:f.proj4Projection,v=d.is(this.baseReferential.bbox)?this.baseReferential.bbox.xmax-this.baseReferential.bbox.xmin:f.worldSize,P=d.is(this.baseReferential.bbox)?{x:this.baseReferential.bbox.xmin,y:this.baseReferential.bbox.ymin}:f.shiftedPosition;if(!(d.is(b)&&d.is(v)&&d.is(P)&&d.is(P.x)&&d.is(P.y)))return console.warn("Missing information to configure new base!"),d.is(r)&&r(!1),d.is(s)?s():void 0;if(b!==this.baseProjection)return this.baseProjection=b,void h.setDefaultProjection(this.baseProjection,i.bind(this,e,t,n,r));this.worldSize=v,this.shiftedPosition=P,this.shiftedPosition.z=0,d.is(f.projectName)&&(this.projectName=f.projectName,document.title="3DEXPERIENCity | "+this.projectName),d.is(f.slabAltitude)&&(this.slabAltitude=f.slabAltitude),!this.url.hasArgument("crop")&&d.is(f.crop)&&(this.cropBox=new u(f.crop,this)),this.date.setFromConfig(f.date),this.poiManager.setup(f.poiSettings);var x,M=f.withCredentials||{};for(x in M)T.setCredentials(x,M[x]);T.setUrlParams(f.urlParams),d.is(f.stylesheets)&&("object"==typeof f.stylesheets?this.addStylesheets(f.stylesheets):"string"==typeof f.stylesheets&&this.addStylesheet(f.stylesheets)),void 0!==f.viewer&&this.USR.setup(f.viewer),a.publish("/3DEXPERIENCity/onConfig",this);var S=null;if(d.is(window.URBANODT)||(S=this.storage.get("context")),S)this.modelRoot.loadJSON(this,S);else if(f.contexts&&f.contexts.length>0){var C=this,y=!0;o=!1,d.downloadOrderedTree(f.contexts,function(e,t){if(!0===t){var i=JSON.parse(e);return{data:i,ref:i.link}}if(void 0===t)return{data:e,ref:e.link};g.end(),r(!1)},function(e){try{for(c=0;c<e.length;c++)C.modelRoot.loadJSON(C,e[c],void 0,void 0,void 0,function(e,t){e||(y=!1),r(e,t)});for(c=0;c<t.length;c++)this.modelRoot.loadJSON(this,t[c],void 0,void 0,void 0,function(e,t){e||(y=!1),r(e,t)});y&&(o=!0)}catch(e){console.error(e.stack),r(!1)}},n)}else try{for(c=0;c<t.length;c++)this.modelRoot.loadJSON(this,t[c],void 0)}catch(e){console.error(e.stack),d.is(r)&&r(!1)}}catch(e){console.error(e.stack),d.is(r)&&r(!1)}g.ready(),this.urbanLoaded=!0,o&&d.is(r)&&r(!0),T._datasetToCheckList<1&&a.publish(a.eventsList.onLoaded,this)}.bind(this);e=this._cloneConfig(e),this.reset();t=this._mergeOptions(t);if(this._readOptions(t),!d.is(e))return d.is(t.onComplete)?t.onComplete(!0):void 0;e="string"==typeof e?{url:e}:e;var n=[],r=[];g.loading();try{d.downloadOrderedTree([e],function(e,i){try{var s=void 0;if(!0===i?s=JSON.parse(e):void 0===i?s=e:(g.end(),t.onComplete(!1)),s)return s.UrbanProject||!s.Root&&!s.Content?r.push(s):n.push(s),{data:s,link:s.link}}catch(e){console.error(e.stack),t.onComplete(!1)}},function(e){r.length>0&&i(r,n,t.path,t.onComplete)},t.path)}catch(e){console.error(e.stack),t.onComplete(!1)}},_mergeOptions:function(e){var t=void 0!==e?e:{};for(var i in this._oldOptions=void 0!==this._oldOptions?this._oldOptions:e,this._oldOptions)void 0===t[i]&&t[i]!==this._oldOptions[i]&&(t[i]=this._oldOptions[i]);return t},_readOptions:function(e){d.is(e)&&((this.url.hasArgument("debug")&&Number(this.url.getArgument("debug").value)||this.url.hasArgument("console")&&Number(this.url.getArgument("console").value)||d.is(e)&&e.debug)&&this._setDebugMode(!0),this.getView3D().displayContextualMenu(void 0!==e.displayContextualMenu&&e.displayContextualMenu),e.displayCompass&&!d.is(this.compass)&&this._initCompass(),e.FocusManager&&!this._debugMode&&c.activate(),d.is(e.debugVisualOdt)&&(this._debugVisualOdt=!0,this.date.enableImplicitShift(!1)))},_initCompass:function(){this.compass=new N(this.frmWindow.getUIFrame(),this),this.compass.bindEvents(),this.compass.show(),this.compass.setAlignment("top")},setBaseURL:function(e,t){this.baseURL=e,h.setBaseUrl(this.baseURL,t)},saveCookies:function(){this.storage.set("app",this.url.getParameters()),this.storage.set("context",this.getLayerRoot().toJSON())},_cloneConfig:function(e){return"object"==typeof e?JSON.parse(JSON.stringify(e)):e},_setDebugMode:function(e){this._debugMode!==e&&(this._debugMode=e,l.initialize(e,!1),this._debugMode&&(window.THREE=i,window.utils=d,window.Feature=x,window.Folder=M,window.Geometry=v,window.PointOfInterest=P,window.PointOfView=S,window.OverlayRaster=C,window.Coordinate=y,window.modelRoot=this.modelRoot,window.modelSelection=this.modelSelection,window.SplashScreen=g),this._debugMode?d.is(this.debugUI)?this.debugUI.show():this.debugUI=new D(this):this.debugUI.hide())},getPerformanceProfileManager:function(){return this.USR.getProfilePerformance()},getRenderingProfileManager:function(){return this.USR.getProfileRendering()},getView3D:function(){return this.USR},getDateTime:function(){return this.date},getProjectName:function(){return t.clone(this.projectName)},getProjectProjection:function(){return t.clone(h.getProjectProjection())},getUserDefaultProjection:function(){return t.clone(h.getDefaultProjection())},getControl:function(){return this.USR.getControl()},getViewpoint:function(){return this.USR.viewpoint},getLayerRoot:function(){return this.modelRoot},getLayerSelection:function(){return this.modelSelection},getEnvironment:function(){return this.environment},addStylesheets:function(e){for(var t=0;t<e.length;t++)this.addStylesheet(e[t])},addStylesheet:function(e){var t=document.createElement("link");t.type="text/css",t.rel="stylesheet",t.href=T.resolveUrl(e),document.getElementsByTagName("head")[0].appendChild(t)},onLocalFile:function(e,t){l.log(e);for(var i=0;i<e.length;i++){var n=e[i];if(n){var r=n.name.split("."),s=r[r.length-1],a=window.URL.createObjectURL(n),o=this.loader[s];o&&o(a,t,s)}}},subscribeToSplashScreen:function(e){g.isReady()?e():g.addEvent("onPageReady",e)},initTimeFiltering:function(){this._timefilter||(this._timefilter=new E(this))},webglReport:function(){var e=this.USR.webGLV6Viewer.getWebGLContext();function t(e){return"["+e[0]+", "+e[1]+"]"}function i(e,t){return t?""+Math.pow(2,e):"2<sup>"+e+"</sup>"}function n(e,t){var n=t?" bit mantissa":"";return"[-"+i(e.rangeMin,t)+", "+i(e.rangeMax,t)+"] ("+e.precision+n+")"}function r(t){var i=e.getShaderPrecisionFormat(t,e.HIGH_FLOAT),r=e.getShaderPrecisionFormat(t,e.MEDIUM_FLOAT),s=e.getShaderPrecisionFormat(t,e.LOW_FLOAT),a=i;return 0===i.precision&&(a=r),'<span title="High: '+n(i,!0)+"\n\nMedium: "+n(r,!0)+"\n\nLow: "+n(s,!0)+'">'+n(a,!1)+"</span>"}function s(e){return 0!==e&&0==(e&e-1)}function a(e){var t={renderer:"",vendor:""},i=e.getExtension("WEBGL_debug_renderer_info");return null!=i&&(t.renderer=e.getParameter(i.UNMASKED_RENDERER_WEBGL),t.vendor=e.getParameter(i.UNMASKED_VENDOR_WEBGL)),t}return{glVersion:e.getParameter(e.VERSION),shadingLanguageVersion:e.getParameter(e.SHADING_LANGUAGE_VERSION),vendor:e.getParameter(e.VENDOR),renderer:e.getParameter(e.RENDERER),unMaskedVendor:a(e).vendor,unMaskedRenderer:a(e).renderer,antialias:e.getContextAttributes().antialias?"Available":"Not available",angle:function(e){var i=t(e.getParameter(e.ALIASED_LINE_WIDTH_RANGE));return"Win32"!==navigator.platform&&"Win64"!==navigator.platform||"Internet Explorer"===e.getParameter(e.RENDERER)||"Microsoft Edge"===e.getParameter(e.RENDERER)||i!==t([1,1])?"No":s(e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS))&&s(e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS))?"Yes, D3D11":"Yes, D3D9"}(e),maxColorBuffers:function(e){var t=1,i=e.getExtension("WEBGL_draw_buffers");return null!=i&&(t=e.getParameter(i.MAX_DRAW_BUFFERS_WEBGL)),t}(e),redBits:e.getParameter(e.RED_BITS),greenBits:e.getParameter(e.GREEN_BITS),blueBits:e.getParameter(e.BLUE_BITS),alphaBits:e.getParameter(e.ALPHA_BITS),depthBits:e.getParameter(e.DEPTH_BITS),stencilBits:e.getParameter(e.STENCIL_BITS),maxRenderBufferSize:e.getParameter(e.MAX_RENDERBUFFER_SIZE),maxCombinedTextureImageUnits:e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxCubeMapTextureSize:e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),maxFragmentUniformVectors:e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),maxTextureImageUnits:e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:e.getParameter(e.MAX_TEXTURE_SIZE),maxVaryingVectors:e.getParameter(e.MAX_VARYING_VECTORS),maxVertexAttributes:e.getParameter(e.MAX_VERTEX_ATTRIBS),maxVertexTextureImageUnits:e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexUniformVectors:e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),aliasedLineWidthRange:t(e.getParameter(e.ALIASED_LINE_WIDTH_RANGE)),aliasedPointSizeRange:t(e.getParameter(e.ALIASED_POINT_SIZE_RANGE)),maxViewportDimensions:t(e.getParameter(e.MAX_VIEWPORT_DIMS)),maxAnisotropy:function(){var t=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic");if(t){var i=e.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT);return 0===i&&(i=2),i}return"n/a"}(),vertexShaderBestPrecision:r(e.VERTEX_SHADER),fragmentShaderBestPrecision:r(e.FRAGMENT_SHADER),fragmentShaderFloatIntPrecision:function(e){var t=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),i=0!==t.precision?"highp/":"mediump/";return i+=0!==(t=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_INT)).rangeMax?"highp":"lowp"}(e),extensions:e.getSupportedExtensions(),draftExtensionsInstructions:-1!==navigator.userAgent.indexOf("Chrome")?'To see draft extensions in Chrome, browse to about:flags, enable the "Enable WebGL Draft Extensions" option, and relaunch.':-1!==navigator.userAgent.indexOf("Firefox")?"To see draft extensions in Firefox, browse to about:config and set webgl.enable-draft-extensions to true.":""}}},B});