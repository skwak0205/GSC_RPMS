define("DS/DMUMarker/DMUMarkerTextCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/DMUContextManager","DS/DMUPlayMarker/DMUMarker3DText","DS/DMUPlayMarker/DMUMarker3DStamp","DS/DMUPlayMarker/DMUMarker2DText","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUBaseUI/DMUToolsUsers","DS/Utilities/TouchUtils","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/DMUBaseUIServices/DMUObjectsServices","i18n!DS/DMUBaseUI/assets/nls/DMUBaseUI","i18n!DS/DMUMarker/assets/nls/DMUMarker"],function(e,t,n,r,i,a,o,s,l,c,d,u,m,D,h,g,M){"use strict";return t.extend({init:function(t){let v,p,f="markerTextCmdHdr"===t.ID||"DMUCreateRejectedMkrHdr"===t.ID||"DMUCreateValidatedMkrHdr"===t.ID?"3D":"2D",S="DMUCreateRejectedMkrHdr"===t.ID||"DMUCreateValidatedMkrHdr"===t.ID,C=this,U=null,P=!1,w=!0;function y(){U.fireEvent("onDMUObjectInitialized",{dmuObject:U}),C.addInCSO(U),w&&!m.getTouchMode()&&U.startEdition(),C.clean()}function b(){var e=null;if(C._clickEventData&&C._clickEventData.from&&C._clickEventData.from.length){var t=v.getMousePosition(C._clickEventData.from[0].getCurrentPosition(v.canvas)),n=v.pick(t,"primHybrid",!0);n&&n.path.length&&(e=n.path[0])}return e}function k(k,x){var E=k[0].position,F="3D"===f?i.getWindowPositionFromPoint(v,E,C._frmWindow):i.getViewerPositionFromPoint(v,E),A=i.getDistanceFromPixel(v,E,100,C._frmWindow);F.top<100&&(A=-A);var I,T=i.getViewpointInfo(v.currentViewpoint).up.clone().multiplyScalar(A),_=E.clone().add(T);if(x&&(_=x),p||(p=new c(v)),p.createHVAxis(E,{key:"Shift",keyCode:16},t.dragEventCallback),p.activate(),"3D"===f)I=[E.clone()];else{var L=i.getViewerPositionFromPoint(v,E);I=[new r.Vector2(L.left,L.top)]}var V=a.getReviewContext({viewer:C.getFrameWindow().getViewer()}),H=V.getCurrentSessionMarkup();let O;U=!1===S?"3D"===f?new o(v,H):new l(v,H):new s(v,H),S&&((O=d.getPreference("DMUCreateRejectedMkrHdr"===t.ID?"DMUMarkerRejectedStampLabel":"DMUMarkerValidatedStampLabel","string"))||(O="DMUCreateRejectedMkrHdr"===t.ID?g.defaultRejectedStampLabel:g.defaultValidatedStampLabel)),U.setAttributes([{name:"sID",value:H.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:H.computeNewName({object:U,prefix:"3D"===f?M.text3DPrefix:M.text2DPrefix})},{name:"sTextContents",value:S?[O]:[M.markertext.standard]},{name:"lLeaderPointingPoints",value:I},{name:"bHasALeader",value:"3D"===f},{name:"sLeaderEndType",value:"Arrow"},{name:"cLineStyleColor",value:new r.Color("#afafaf")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!0},{name:"fFontSize",value:4.23},{name:"fBorderRadius",value:!0===S?0:4},{name:"fPointedPageNumber",value:C.getPageNumber()},{name:"sPointedElementID",value:C.getElementId()}]),"3D"===f?U.setAttribute("vLeaderBreakPoint3D",_.clone()):U.setAttribute("vLeaderBreakPoint2D",I[0]),!0===S&&U.setAttributes([{name:"sOwner",value:u.getUserLogin()},{name:"sStampType",value:"DMUCreateRejectedMkrHdr"===t.ID?"Rejected":"Validated"},{name:"lTextComment",value:[""]},{name:"fCreationDate",value:Date.now()}]);var B=H.getCurrentSlide();if(B.addDMUObject(U),require(["DS/DMUBaseExperience/EXPUtils"],function(e){e._sendUsageProbe("command",(S?"CreateStamp":"CreateText")+f+B.getType())}),w=!0,"3D"===f){var R=!0,W=b();if(W&&(R=!1),!W&&k[0].pathElement?W=k[0].pathElement:!W&&C._selectedPathElement&&void 0!==x&&(W=C._selectedPathElement),W){if(n.isAPOIPath(W)){const{position:e,label:t}=h.getPOIInformationFromPathElement(W);e&&U.setAttributes([{name:"lLeaderPointingPoints",value:[e]},{name:S?"lTextComment":"sTextContents",value:[t||(S?O:M.markertext.standard)]}])}var N=function(e){return!!(e&&e.getLastElement(!0)&&e.getLastElement(!0).getDMUType&&"DMUSection"===e.getLastElement(!0).getDMUType())||!!e.getParentPath()&&N(e.getParentPath())};if(R&&N(W)&&(W=b()),W){let e="";if(W.internalPath.length){let t=[],n=D.giveDMUApplicativeContextManager({context:a.getContextViewer({viewer:C.getFrameWindow().getViewer()})});if(n){var j=n.getApplicativeControllers();if(j&&j.length)for(let e=0;e<=j.length;e++)if(j[e]&&j[e].getFeatureInformation){let n=j[e].getFeatureInformation(W);n&&n.name&&t.push(n.name)}1===t.length&&t[0]&&(e=t[0],U.setAttribute(!0===S?"lTextComment":"sTextContents",[e]),U.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:U}))}}if(!e){var z=n.getLastReference(W);if(z){var X=z.getLastElement(!0);X&&(X.associatedMarkers||(X.associatedMarkers=[]),X.associatedMarkers.push(U),w=!1,n.getName([X],function(e){if(e&&1===e.length&&e[0]){var t=e[0].slice();let r;if(t&&X.associatedMarkers&&X.associatedMarkers.length){for(var n=0;n<X.associatedMarkers.length;n++)X.associatedMarkers[n]&&(X.associatedMarkers[n].setAttribute(-1!==X.associatedMarkers[n].getType().indexOf("Stamp")?"lTextComment":"sTextContents",[t]),X.associatedMarkers[n].fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:X.associatedMarkers[n]}),r=X.associatedMarkers[n]);X.associatedMarkers=void 0,r&&r.startEdition&&!m.getTouchMode()&&r.startEdition(),v.render()}}},a.getContextViewer({reviewContext:V}),""))}}}}}P||y()}a.setAuthoringFeatureTypes("Marker"),t.dragEventCallback=function(e){if(U){var t=i.getViewerPositionFromPoint(v,e.vCurrentPosition);if(t=i.get2DSnappedPosition(new r.Vector2(t.left,t.top)),e.shiftKey||void 0===e.shiftKey&&e.iEventData.from&&e.iEventData.from.length&&e.iEventData.from[0].event&&e.iEventData.from[0].event.shiftKey){var n=i.getViewerPositionFromPoint(v,e.vStartPosition);Math.abs(t.y-n.top)>=Math.abs(t.x-n.left)?t.setX(n.left):t.setY(n.top)}"3D"===f?U.setAttribute("vLeaderBreakPoint3D",i.getPositionFromIntersection(v,t,e.vCurrentPosition)):U.setAttribute("vLeaderBreakPoint2D",t),U.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:U})}else P=!0,k([{position:e.vStartPosition}],e.vCurrentPosition);p.updateManipulationData(e),e.bLastUpdate&&y()},this.clean=function(){p&&p.remove(),P=!1,U=null},this._parent(t,function(e){P||U||k(e)},M.textPositionLabel,{},!0),v=this.getFrameWindow().getViewer()},beginExecute:function(){var e=a.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)?this._parent():this.end()},endExecute:function(){this._parent(),this.clean&&this.clean()}})}),define("DS/DMUMarker/DMUMarkerExport",["require","exports","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUPlayMarker/DMUMarker3DRectangle","DS/DMUPlayMarker/DMUMarker3DEllipse","DS/DMUPlayMarker/DMUMarker3DSpline","DS/DMUPlayMarker/DMUMarker3DCircle","DS/DMUPlayMarker/DMUMarker3DArrow","DS/DMUPlayMarker/DMUMarker3DLine","DS/DMUPlayMarker/DMUMarker3DPoint","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseUI/DMUToolsUsers"],function(e,t,n,r,i,a,o,s,l,c,d,u,m){"use strict";const D={1:[],2:[2,2],3:[3,1],4:[3,2,1,2],5:[6,2,2,2,2,2],6:[1,1],7:[2,1,12,1]};class h{static getCommentExportDefinition(e){return new Promise(t=>{(async()=>{const r=e.getAttribute("sOwner")||"",i=n.getPreference("CATWebUXPreferences_ExportPersonalData","boolean")?await m.getUserName(r):r;let a={id:e.getAttribute("sUuid")||"",content:(e.getAttribute("sTextContents")||[""]).join("\n"),owner:i,creationDate:new Date(e.getAttribute("fCreationDate")||Date.now()),lastModificationDate:new Date(e.getAttribute("fLastModificationDate")||Date.now())};t(a)})()})}static getExportDefinition(e){return new Promise((t,n)=>{(async()=>{let m,g=e.getPointedPosition(),M=e.getAttribute("sUuid")||"",v=e.getAttribute("bVisible")||!1;if(e instanceof r){let t=e.getAttribute("fWidth")||0,n=e.getAttribute("fHeight")||0;m={id:M,visible:v,type:e.getType(),position:{x:g.x,y:g.y},width:t,height:n,rotationAngle:e.getAttribute("fRotationAngle")}}else if(e instanceof o){let t=e.getAttribute("fRadius")||0;m={id:M,visible:v,type:e.getType(),position:{x:g.x,y:g.y},radius:t}}else if(e instanceof i){let t=e.getAttribute("fxAxisLength")||0,n=e.getAttribute("fyAxisLength")||0;m={id:M,visible:v,type:e.getType(),position:{x:g.x,y:g.y},rotationAngle:e.getAttribute("fRotationAngle"),xLength:t,yLength:n}}else if(e instanceof l){let t=e.getPoints()[1].getAttribute("vPosition");m={id:M,visible:v,type:e.getType(),points:{start:{x:g.x,y:g.y},end:{x:t.x,y:t.y}}}}else if(e instanceof a){let t=[],n=e.getPoints(),r=e.getManipulationData(),i=e.getAttribute("fRotationAngle"),a=d.getRelativePosition(e,r.position);n&&n.forEach(e=>{if(e instanceof c){let n=e.getAttribute("vPosition");if(i){let e=n.sub(a);t.push({x:e.x*Math.cos(i)-e.y*Math.sin(i)+a.x,y:e.x*Math.sin(i)+e.y*Math.cos(i)+a.y})}else t.push({x:n.x,y:n.y})}}),m={id:M,visible:v,type:e.getType(),rect:{width:r.width,height:r.height},position:{x:a.x,y:a.y},rotationAngle:r.rotation,points:t}}else if(e instanceof s){let t=e.getNode().getArrowSpecs(),n=e.getAttribute("vSecondPoint"),r=n.clone().sub(g),i=Math.acos(r.x/Math.sqrt(r.x*r.x+r.y*r.y))*Math.sign(r.y),a=Math.cos(i),o=Math.sin(i);m={id:M,visible:v,type:e.getType(),pointing:{x:g.x,y:g.y},ending:{x:n.x,y:n.y},points:t.coordinates.map(e=>({x:g.x+(e.x*a-e.y*o),y:g.y+(e.x*o+e.y*a)}))}}if(m){let n=u.getMMPerPixelRatio(e.getViewer(),g),r=D[e.getAttribute("sLineStylePattern")||1],i=r?r.map(e=>6*e*n):[],o={definition:m,pageNumber:e.getAttribute("fPointedPageNumber")||1,material:{fill:e.getAttribute("bIsFilled")?{color:e.getAttribute("cFillStyleColor"),opacity:e.getAttribute("fOpacity")||1}:void 0,border:e.getAttribute("bHasBorder")||e instanceof l||e instanceof a?{color:e.getAttribute("cLineStyleColor"),thickness:d.getLineThickness(e.getAttribute("fLineStyleThicknessIndex"),"mm")||d.convertLineThickness(e.getAttribute("fLineStyleThickness"),"mm")||0,pattern:i,opacity:e.getAttribute("fLineStyleOpacity")||1}:void 0}},s=e.getDMUComments();if(s.length){o.comments=[];for(let e=0;e<s.length;e++){let t=await h.getCommentExportDefinition(s[e]);o.comments.push(t)}}return t(o)}n(new Error("This type cannot be exported"))})()})}}return h}),define("DS/DMUMarker/DMUMarkerPictureCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUControls/EXPSnapshotControl","DS/DMUControls/EXPFileBrowser","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/EXPUtils","DS/StateCommandEngine/PathElementAgent","DS/CoreEvents/Events","DS/ApplicationFrame/ContextualBar","DS/DMUPlayMarker/DMUMarker3DPicture","DS/DMUPlayMarker/DMUMarker2DPicture","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUMarker/assets/nls/DMUMarker"],function(e,t,n,r,i,a,o,s,l,c,d,u,m,D,h,g){"use strict";var M;return t.extend({init:function(e){this.markerType="markerPictureCmdHdr"===e.ID?"3D":"2D",m.setAuthoringFeatureTypes("Marker"),this._parent(e,"exclusive",g.picturePositionLabel,{},!0)},beginExecute:function(){var e=m.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)?this._parent():this.end()},cancelExecute:function(){this._cleanData&&this._cleanData()},buildGraph:function(){var t,v=this,p="browser";function f(e){v.sendNotify("error",e,3e3)}function S(r){if(r.img){let U=o.convertImageDataUrl(r.img.src);if(U&&U.type&&U.data){var i=m.getReviewContext({viewer:v.getFrameWindow().getViewer()}).getCurrentSessionMarkup(),s=r.img.width,l=r.img.height;s>300&&(l=300*l/s,s=300),l>300&&(s=300*s/l,l=300),s=Math.round(s),l=Math.round(l);var c=t,D="3D"===v.markerType?n.getWindowPositionFromPoint(v._viewer,c,v._frmWindow):n.getViewerPositionFromPoint(v._viewer,c),h=n.getDistanceFromPixel(v._viewer,c,s,v._frmWindow);D.top<s&&(h=-h);var M,p=n.getViewpointInfo(v._viewer.currentViewpoint).up.clone().multiplyScalar(h);if(c=c.clone().add(p),"3D"===v.markerType)M=[t.clone()];else{var f=n.getViewerPositionFromPoint(v._viewer,t);M=[new a.Vector2(f.left,f.top)]}var S="3D"===v.markerType?new d(v._viewer,i):new u(v._viewer,i);S.setAttributes([{name:"sID",value:i.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:i.computeNewName({object:S,prefix:"3D"===v.markerType?g.picture3DPrefix:g.picture2DPrefix})},{name:"lLeaderPointingPoints",value:M},{name:"sTextContents",value:[r.name?r.name:""]},{name:"sImageType",value:U.type},{name:"sImageData",value:U.data},{name:"bHasALeader",value:"3D"===v.markerType},{name:"sLeaderEndType",value:"Arrow"},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"fFontSize",value:3.5},{name:"fBorderRadius",value:4},{name:"bShortDisplay",value:!0},{name:"fCreationDate",value:Date.now()},{name:"fImageWidth",value:"3D"===v.markerType?n.convertPixelToModel({sizeInPixels:s,viewer:v._viewer}):s},{name:"fImageHeight",value:"3D"===v.markerType?n.convertPixelToModel({sizeInPixels:l,viewer:v._viewer}):l}]),"3D"===v.markerType?S.setAttribute("vLeaderBreakPoint3D",c):S.setAttribute("vLeaderBreakPoint2D",M[0]);var C=i.getCurrentSlide();C.addDMUObject(S),S.fireEvent("onDMUObjectInitialized",{dmuObject:S}),v.addInCSO(S),o._sendUsageProbe("command","CreatePicture"+v.markerType+C.getType())}}}var C=new i({onFileLoadedCB:function(e){S(e),v._cleanData()},onErrorCB:function(){v._cleanData(),f(g.markerpicture.FileBrowserInvalidFile)}}),U=new s({agentId:"_pathElementAgent",frameWindow:v._frmWindow});function P(){var e=v._frmWindow.getViewer().currentViewpoint.project(t),n={subscribersOptions:[{onContextualBarReady:function(){return{cmdList:[{name:"DMUImportPictureFromFileStr",line:1,hdr_list:["DMUImportPictureFromFileHdr"]},{name:"DMUCreateSnapshotStr",line:1,hdr_list:["DMUCreateSnapshotHdr"]},{name:"DMUCancelPictureCmdStr",line:1,hdr_list:["DMUCancelPictureCmdHdr"]}]}},workbenchName:"DMUCreatePictureCtxCmds",module:"DMUMarker",context:m.getContextViewer({reviewContext:m.getReviewContext({viewer:v.getFrameWindow().getViewer()})}).getCommandContext(),cmdPrefix:"",fileName:"DMUCreatePictureCtxCmds.xml"}],viewerFrame:v._frmWindow.getViewer(),uiFrame:v._frmWindow.getUIFrame(),Xposition:e.x,Yposition:e.y,hideWithDistance:!1};c.show(n),v.sendNotify("info",g.markerpicture.notifypicturesource)}this._cleanData=function(){C&&C.cleanFileBrowser(),v.cleanNotify(),c.hide(),M&&clearInterval(M),c.hide(),C=U=t=null,v._frmWindow.getViewerFrame().setStyle("cursor","auto")};var w=function(e){S(e),v._cleanData()},y=function(){v._cleanData()},b=function(){f(g.markerpicture.onSnaphotErrorMsg)},k=function(e){"webcam"===p?new r({immersiveFrame:v._frmWindow.getImmersiveFrame(),onValidateSnapshotCB:w,onCloseSnapshotCB:y,onErrorCB:b}):"browser"===p&&(C.openFileBrowser(),setTimeout(function(){if(v.isRunning())var e=l.subscribe({event:"/VISU/"},function(){l.unsubscribe(e),v._cleanData()})},100)),e()},x=this.createInitialState("selectGeometryState");this.setEnterStateAction(x,function(){v._frmWindow.getViewerFrame().setStyle("cursor","crosshair"),v.sendNotify("info",g.markerpicture.notifypictureposition)}),this.setExitStateAction(x,function(){v._frmWindow.getViewerFrame().setStyle("cursor","auto"),v.cleanNotify()});var E=this.createState("selectOriginState"),F=this.createState("captureSnapshotState"),A=this.getFinalState();navigator.userAgent&&(-1!==navigator.userAgent.search("Chrome")||-1!==navigator.userAgent.search("Firefox"))&&(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia)?(this.setPictureCreationChoice=function(e){p=e,c.hide(),M&&clearInterval(M),M=setInterval(function(){v.isRunning()&&(clearInterval(M),v.publish({event:p?"contextBarOK":"contextBarCancel",data:null}))},10)},this.setEnterStateAction(E,P),this.setExitStateAction(E,function(){v.cleanNotify()}),this.addTransition({iEvent:U,iInitialState:x,iFinalState:E,iAction:function(e,n){t=null;const r=n[0].pathElement||v._selectedPathElement;if(h.isAPOIPath(r)){const{position:e}=D.getPOIInformationFromPathElement(r);e&&(t=e)}t||(t=n[0].position.clone()),e()}}),this.addEmptySelectionTransition(x,E,function(e,n){var r=v.computeEmptySelectionInformation(n);t=r[0].position.clone(),e()}),this.addTransition({iEvent:U,iInitialState:E,iFinalState:E,iAction:function(e,n){t=n[0].position.clone(),P(),e()}}),this.addEmptySelectionTransition(E,E,function(e,n){var r=v.computeEmptySelectionInformation(n);t=r[0].position.clone(),P(),e()})):(p="browser",this.addTransition({iEvent:U,iInitialState:x,iFinalState:A,iAction:function(e,n){t=null;const r=n[0].pathElement||v._selectedPathElement;if(h.isAPOIPath(r)){const{position:e}=D.getPOIInformationFromPathElement(r);e&&(t=e)}t||(t=n[0].position.clone()),k(e)}}),this.addEmptySelectionTransition(x,A,function(e,n){var r=v.computeEmptySelectionInformation(n);t=r[0].position.clone(),k(e)})),this.addTransition({iSender:this,iEvent:"contextBarOK",iInitialState:E,iFinalState:A,iAction:function(e){k(e)}}),this.addTransition({iSender:this,iEvent:"contextBarCancel",iInitialState:E,iFinalState:A,iAction:function(e){v._cleanData(),e()}}),this.addTransition({iSender:this,iEvent:"ActionOK",iInitialState:F,iFinalState:A,iAction:function(e){v._cleanData(),e()}})}})}),define("DS/DMUMarker/DMUMarkerCircleCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUBaseExperience/EXPToolsVisualization","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/DMUContextManager","DS/DMUPlayMarker/DMUMarker3DCircle","DS/DMUPlayMarker/DMUMarker2DCircle","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUMarker/assets/nls/DMUMarker"],function(e,t,n,r,i,a,o,s,l,c){"use strict";return t.extend({init:function(t){var d,u="markerCircleCmdHdr"===t.ID?"3D":"2D",m=this,D=null,h=!1;function g(){D.fireEvent("onDMUObjectInitialized",{dmuObject:D}),m.addInCSO(D),m.clean()}function M(t,M){var v,p=i.getReviewContext({viewer:m.getFrameWindow().getViewer()}),f=p?p.getCurrentSessionMarkup():null,S=t[0].position,C=M?S.clone().sub(M).length():100;if("3D"===u){const e=t[0].pathElement||m._selectedPathElement;if(l.isAPOIPath(e)){const{position:t}=s.getPOIInformationFromPathElement(e);t&&(v=t)}v||(v=S.clone())}else{var U=n.getViewerPositionFromPoint(d,S);v=new r.Vector2(U.left,U.top)}(D="3D"===u?new a(d,f):new o(d,f)).setAttributes([{name:"sID",value:f.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:f.computeNewName({object:D,prefix:"3D"===u?c.circle3DPrefix:c.circle2DPrefix})},{name:"vCenter",value:v},{name:"fRadius",value:"3D"===u?n.getDistanceFromPixel(d,S,C,m._frmWindow):C},{name:"cLineStyleColor",value:new r.Color("#cc092f")},{name:"cFillStyleColor",value:new r.Color("#cc092f")},{name:"fLineStyleThicknessIndex",value:4},{name:"bIsFilled",value:!1},{name:"bHasBorder",value:!0},{name:"fPointedPageNumber",value:m.getPageNumber()},{name:"sPointedElementID",value:m.getElementId()}]);var P=f.getCurrentSlide();P.addDMUObject(D),require(["DS/DMUBaseExperience/EXPUtils"],function(e){e._sendUsageProbe("command","CreateCircle"+u+P.getType())}),h||g()}i.setAuthoringFeatureTypes("Marker"),t.dragEventCallback=function(e){if(D){var t=e.vStartPosition.clone(),i=n.getPositionFromIntersection(d,e.vCurrentPosition,e.vCurrentPosition,!0);if("2D"===u){var a=n.getViewerPositionFromPoint(d,t);t=new r.Vector2(a.left,a.top),a=n.getViewerPositionFromPoint(d,i),i=new r.Vector2(a.left,a.top)}var o=t.sub(i);D.setAttributes([{name:"fRadius",value:Math.max(0,o.length())}]),D.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:D})}else h=!0,M([{position:e.vStartPosition}],e.vCurrentPosition);e.bLastUpdate&&g()},this.clean=function(){h=!1,D=null},this._parent(t,function(e){h||D||M(e)},c.circlePositionLabel,{},!0),d=this.getFrameWindow().getViewer()},beginExecute:function(){var e=i.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)?this._parent():this.end()},endExecute:function(){this._parent(),this.clean&&this.clean()}})}),define("DS/DMUMarker/DMUMarkerRectangleCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUBaseExperience/EXPToolsVisualization","DS/Visualization/ThreeJS_DS","DS/DMUPlayMarker/DMUMarker3DRectangle","DS/DMUPlayMarker/DMUMarker2DRectangle","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUMarker/assets/nls/DMUMarker"],function(e,t,n,r,i,a,o,s,l,c,d){"use strict";return t.extend({init:function(t){var u,m,D="DMU3DRectangleCmdHdr"===t.ID?"3D":"2D",h=this,g=null,M=!1;function v(){g.fireEvent("onDMUObjectInitialized",{dmuObject:g}),h.addInCSO(g),h.clean()}function p(p,f){var S=o.getReviewContext({viewer:h.getFrameWindow().getViewer()}).getCurrentSessionMarkup(),C=p[0].position;m||(m=new s(u)),m.addToListener("Control",t.dragEventCallback),m.addToListener("Shift",t.dragEventCallback),m.activate();var U,P=200,w=160,y=C.clone(),b=f;if("3D"===D){if(b){U=(new r.Plane).setFromNormalAndCoplanarPoint(u.currentViewpoint.getSightDirection(),C).projectPoint(b);var k=u.currentViewpoint.getUpDirection(),x=(new r.Vector3).crossVectors(k,u.currentViewpoint.getSightDirection());w=U.dot(k)-C.dot(k),P=U.dot(x)-C.dot(x),y=(new r.Vector3).addVectors(U,C).multiplyScalar(.5)}const e=p[0].pathElement||h._selectedPathElement;if(c.isAPOIPath(e)){const{position:t}=l.getPOIInformationFromPathElement(e);t&&(y=t)}}else{var E=n.getViewerPositionFromPoint(u,C);if(y=new r.Vector2(E.left,E.top),b)E=n.getViewerPositionFromPoint(u,b),P=2*(U=new r.Vector2(E.left,E.top).clone().sub(y)).x,w=2*U.y;else w=160,P=200}P="3D"===D?n.getDistanceFromPixel(u,C,200,h._frmWindow):P,w="3D"===D?n.getDistanceFromPixel(u,C,160,h._frmWindow):w,P=Math.abs(P),w=Math.abs(w),(g="3D"===D?new i(u,S):new a(u,S)).setAttributes([{name:"sID",value:S.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:S.computeNewName({object:g,prefix:"3D"===D?d.rectangle3DPrefix:d.rectangle2DPrefix})},{name:"vPosition",value:y},{name:"fWidth",value:P},{name:"fHeight",value:w},{name:"cLineStyleColor",value:new r.Color(13371695)},{name:"fLineStyleThicknessIndex",value:3},{name:"bIsFilled",value:!1},{name:"bHasBorder",value:!0},{name:"fPointedPageNumber",value:h.getPageNumber()},{name:"sPointedElementID",value:h.getElementId()}]);var F=S.getCurrentSlide();F.addDMUObject(g),require(["DS/DMUBaseExperience/EXPUtils"],function(e){e._sendUsageProbe("command","CreateRectangle"+D+F.getType())}),M||v()}t.dragEventCallback=function(e){if(g){var t,i,a,o;if("2D"===D){var s=n.getViewerPositionFromPoint(u,e.vStartPosition);o=new r.Vector2(s.left,s.top),s=n.getViewerPositionFromPoint(u,e.vCurrentPosition),t=2*(a=new r.Vector2(s.left,s.top).sub(o)).x,i=2*a.y}else{var d=e.ctrlKey||void 0===e.ctrlKey&&e.iEventData.from&&e.iEventData.from.length&&e.iEventData.from[0].event&&e.iEventData.from[0].event.ctrlKey,f=e.shiftKey||void 0===e.shiftKey&&e.iEventData.from&&e.iEventData.from.length&&e.iEventData.from[0].event&&e.iEventData.from[0].event.shiftKey;a=(new r.Plane).setFromNormalAndCoplanarPoint(u.currentViewpoint.getSightDirection(),e.vStartPosition).projectPoint(n.getPositionFromIntersection(u,e.vCurrentPosition,e.vCurrentPosition,!0));var S=u.currentViewpoint.getUpDirection(),C=(new r.Vector3).crossVectors(S,u.currentViewpoint.getSightDirection());if(f){var U=a.dot(S)-e.vStartPosition.dot(S),P=a.dot(C)-e.vStartPosition.dot(C),w=Math.max(Math.abs(U),Math.abs(P));i=w*Math.sign(U),t=w*Math.sign(P),(a=S.clone().multiplyScalar(i).add(C.clone().multiplyScalar(t))).add(e.vStartPosition)}else i=a.dot(S)-e.vStartPosition.dot(S),t=a.dot(C)-e.vStartPosition.dot(C);if(d){const n=h._selectedPathElement;if(n&&c.isAPOIPath(n)){const{position:e}=l.getPOIInformationFromPathElement(n);e&&(o=e)}else o=e.vStartPosition.clone();i*=2,t*=2}else o=(new r.Vector3).addVectors(a,e.vStartPosition).multiplyScalar(.5)}g.setAttributes([{name:"fWidth",value:Math.abs(t)},{name:"fHeight",value:Math.abs(i)},{name:"vPosition",value:o}]),g.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:g})}else M=!0,p([{position:e.vStartPosition}],e.vCurrentPosition);m.updateManipulationData(e),e.bLastUpdate&&v()},this.clean=function(){m&&m.remove(),M=!1,g=null},this._parent(t,function(e){M||g||p(e)},d.rectangleCreationLabel,{},!0),u=this.getFrameWindow().getViewer()},beginExecute:function(){var e=o.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)?this._parent():this.end()},endExecute:function(){this._parent(),this.clean&&this.clean()}})}),define("DS/DMUMarker/DMUMarkerBoxContextCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/DMUBaseExperience/DMUContextManager"],function(e,t,n){"use strict";return e.extend({init:function(e){var t=e||{};t.mode="shared",this._parent(t)},beginExecute:function(e){this._parent(e);for(var r=t.get(),i=[],a=n.getReviewContext({viewer:this.getFrameWindow().getViewer()}),o=0;o<r.length;o++){var s=a.getDMUObjectFromPathElement(r[o].pathElement);s&&i.push(s)}if("DMUMarkerShortDisplayHdr"===this._id){for(var l,c,d=0;d<i.length;d++)if("boolean"==typeof(c=i[d].getAttribute("bShortDisplay")))if(void 0===l)l=c;else if(l!==c){l=null;break}i.forEach(function(e){e.setAttribute("bShortDisplay",null===l||!l),e.refreshNode()})}this.getFrameWindow().getViewer().render(),a&&a.getCurrentSessionMarkup()&&a.getCurrentSessionMarkup().getCurrentSlide()&&a.getCurrentSessionMarkup().getCurrentSlide().fireEvent("onSlidePreviewRefreshRequired",{dmuObject:a.getCurrentSessionMarkup().getCurrentSlide()})}})}),define("DS/DMUMarker/DMUMarkerFreehandShapePreview",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/DMUBaseUIServices/DMUObjectsServices"],function(e,t,n,r){"use strict";return t.extend({init:function(t){if(t&&t.graphicProperties&&t.frameWindow){this._parent();var i,a,o,s={};s.lineCap=t.graphicProperties.lineCap?t.graphicProperties.lineCap:"round",s.lineJoin=t.graphicProperties.lineJoin?t.graphicProperties.lineJoin:"round",s.lineStyleOpacity=t.graphicProperties.lineStyleOpacity?t.graphicProperties.lineStyleOpacity:1,s.lineStyleColor=t.graphicProperties.lineStyleColor?t.graphicProperties.lineStyleColor:new n.Color(13371695),s.lineStyleThicknessIndex=t.graphicProperties.lineStyleThicknessIndex?t.graphicProperties.lineStyleThicknessIndex:4,this.setGraphicProperties=function(e){e&&(s.lineCap=e.lineCap?e.lineCap:s.lineCap,s.lineJoin=e.lineJoin?e.lineJoin:s.lineJoin,s.lineStyleOpacity=e.lineStyleOpacity?e.lineStyleOpacity:s.lineStyleOpacity,s.lineStyleColor=e.lineStyleColor?e.lineStyleColor:s.lineStyleColor,s.lineStyleThicknessIndex=e.lineStyleThicknessIndex?e.lineStyleThicknessIndex:s.lineStyleThicknessIndex,c())},this.startPreview=function(){if(!i||!a){var n=t.frameWindow.getUIFrame();i=new e.Element("canvas",{id:"freehandPreviewCanvas",styles:{zIndex:"2000",pointerEvents:"none",position:"absolute",top:0,left:0}}).inject(n);var r=t.frameWindow.getViewerFrame(),o=r.getDimensions();r.addEvent("resize",l),i.width=o.width,i.height=o.height,a=i.getContext("2d"),c()}},this.refreshPreview=function(){i&&a&&(a.clearRect(0,0,i.width,i.height),o=null)},this.destroy=function(){o=null,a&&i&&(t.frameWindow.getViewerFrame().removeEvent("resize",l),a.clearRect(0,0,i.width,i.height),a=null,i.remove(),i=null)},this.updatePreview=function(e,t){if(i&&a){if(!o)return c(),void(o=[]).push(e);t?o[1]=e:o.push(e),a.clearRect(0,0,i.width,i.height),a.beginPath(),a.moveTo(o[0].x,o[0].y);for(var n=1;n<o.length;n++)a.lineTo(o[n].x,o[n].y);a.stroke()}},this.getPreviewPoints=function(){return o}}function l(){var e=t.frameWindow.getViewerFrame().getDimensions();i.width=e.width,i.height=e.height}function c(){a&&(a.lineCap=s.lineCap,a.lineJoin=s.lineJoin,a.globalAlpha=s.lineStyleOpacity,a.strokeStyle=s.lineStyleColor.getStyle(),a.fillStyle=s.lineStyleColor.getStyle(),a.lineWidth=r.getLineThickness(s.lineStyleThicknessIndex))}}})}),define("DS/DMUMarker/DMUMarkerContextualBar",["DS/DMUBaseUI/DMUContextualBarAdapter","DS/DMUBaseExperience/EXPManagerSet","DS/ApplicationFrame/CommandsManager"],function(e,t,n){"use strict";return e.extend({getSharedContextualMenuCommandList:function(e){var t=[];return e&&e.length&&e.forEach(function(e){e.isReadOnly()||-1!==t.indexOf(e.getType())||t.push(e.getType())}),t.length&&-1===t.indexOf("DMUSlide")&&-1===t.indexOf("DMUFormat")?this.getContextualMenuCommandList(e):[]},getContextualMenuCommandList:function(e){var t,n=null;if(!this.isReadOnly())if(this.isEditable()){n=[{line:1,name:"DMUCutStr",hdr_list:["DMUCutHdr"]},{line:1,name:"DMUCopyStr",hdr_list:["DMUCopyHdr"]},{line:1,name:"DMUHideShowStr",hdr_list:["DMUHideShowHdr"]},{line:1,name:"DMUDeleteStr",hdr_list:["DMUDeleteHdr"]}];var r,i,a,o=!1,s=!0,l=!1,c=!1,d=!1;for(this.cmdHdrState_list=[],t=0;t<e.length;t++)e[t].getSharedHeaderTypes&&(r=e[t].getSharedHeaderTypes())&&(r.leaderProperties?(o=!0,r.hideShowLeaderProperties&&(l=!0)):s=!1,r.pointTypeProperties&&(i=e[t],c=!0),r.extremityTypeProperties&&(a=e[t],d=!0)),!s||e[0].getAttribute("sLeaderEndType")===e[t].getAttribute("sLeaderEndType")&&e[0].getAttribute("bHasALeader")===e[t].getAttribute("bHasALeader")||(s=!1);if(o){var u={line:1,name:"DMULeaderStr",hdr_list:["DMUArrowLeaderHdr","DMUBubbleLeaderHdr","DMUCrossLeaderHdr","DMUSquareLeaderHdr","DMUNoEndLeaderHdr"],resourceFile:"DMUBaseCtxCommands/DMUBaseCtxCommands"};if(l&&u.hdr_list.push("DMUNoLeaderHdr"),n.push(u),e.length>0){var m=!1,D=!1,h=!1,g=!1,M=!1,v=!1;if(s){var p=e[0].getAttribute("sLeaderEndType");switch(e[0].getAttribute("bHasALeader")||(p="None"),p){case"Arrow":m=!0;break;case"Bubble":D=!0;break;case"Cross":h=!0;break;case"Square":g=!0;break;case"No end":M=!0;break;case"None":v=!0}}var f=[{name:"DMUArrowLeaderHdr",state:m},{name:"DMUBubbleLeaderHdr",state:D},{name:"DMUCrossLeaderHdr",state:h},{name:"DMUSquareLeaderHdr",state:g},{name:"DMUNoEndLeaderHdr",state:M},{name:"DMUNoLeaderHdr",state:v}];for(t=0;t<f.length;t++)this.cmdHdrState_list.push(f[t])}}if(c&&i&&i.getPointTypeHdr){var S=i.getPointTypeHdr();if(S&&S.hdr_list.length>0){n.push(S);var C,U=[];for(C=0;C<S.hdr_list.length;C++)U.push({name:S.hdr_list[C],state:!1});for(C=0;C<U.length;C++)this.cmdHdrState_list.push(U[C])}}if(d&&a&&a.getExtremityTypeHdr){var P=a.getExtremityTypeHdr();if(P&&P.hdr_list.length>0){n.push(P);var w,y=[];for(w=0;w<P.hdr_list.length;w++)y.push({name:P.hdr_list[w],state:!1});for(w=0;w<y.length;w++)this.cmdHdrState_list.push(y[w])}}}else n=[{line:1,name:"DMUDeleteStr",hdr_list:["DMUDeleteHdr"]}];return n},getSharedContextualCommandList:function(e){var n=[],r=!1;if(e&&e.length&&e.forEach(function(e){!e.isReadOnly()&&e.isInEdition()&&(-1===n.indexOf(e.getType())&&n.push(e.getType()),e.isEditable()&&(r=!0))}),!n.length||-1!==n.indexOf("DMUSection")||!r)return[];if(1===n.length||2===n.length&&-1!==n.indexOf("DMUMarker2DPicture")&&-1!==n.indexOf("DMUMarker3DPicture")||2===n.length&&-1!==n.indexOf("DMUMarker2DText")&&-1!==n.indexOf("DMUMarker3DText"))return this.getContextualCommandList(e[0]);var i,a=[];for(i=0;i<e.length;i++){for(var o=!1,s=0;s<a.length;s++)if(a[s].type===e[i].getType()){o=!0;break}if(!o){if(!e[i].getSharedHeaderTypes)return[];a.push({sharedTypes:e[i].getSharedHeaderTypes()})}}var l=!1;for(i=0;i<a.length;i++)a[i].sharedTypes.fontProperties&&(l=!0);var c=[],d=t.getManager({name:"DMU2DSheetManager",context:this._frmWindow});return d&&d.isADocumentDisplayed()&&("Document"===d.getDocumentType()||"Requirement"===d.getDocumentType())&&(c=[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"]}]),l&&(c.push({name:"Marker_DMUStylesStr",line:1,hdr_list:["Marker_DMUDefaultStyleHdr","Marker_DMULightStyleHdr","Marker_DMUMeasureStyleHdr","Marker_DMUPostitStyleHdr","Marker_DMUValidateStyleHdr","Marker_DMUWarningStyleHdr","Marker_DMUCautionStyleHdr"],selectedHdr:"Marker_DMUDefaultStyleHdr"}),c.push({name:"Marker_DMUIncreaseFontSizeStr",line:1,hdr_list:["Marker_DMUIncreaseFontSizeHdr"]}),c.push({name:"Marker_DMUDecreaseFontSizeStr",line:1,hdr_list:["Marker_DMUDecreaseFontSizeHdr"]})),c=c.concat([{name:"DMUGraphicPropertiesPanelHdr",line:1,hdr_list:["DMUGraphicPropertiesPanelHdr"]}])},getContextualCommandList:function(){var e=[];if(this.isReadOnly()||!this.isInEdition()||!this.isEditable())return e;var n=t.getManager({name:"DMU2DSheetManager",context:this._frmWindow});return n&&n.isADocumentDisplayed()&&("Document"===n.getDocumentType()||"Requirement"===n.getDocumentType())&&(e=[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"]}]),e=e.concat([{name:"DMUGraphicPropertiesPanelHdr",line:1,hdr_list:["DMUGraphicPropertiesPanelHdr"]}])},getSharedHeaderTypes:function(){return{}},register:function(e){this._parent({frmWindow:e.frmWindow,contextualBar:{type:"DMUMarker",module:"DMUMarker",workbenchName:"DMUMarkerContextHdr"},contextualMenu:{type:"DMUMarker",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"}})},unregister:function(e){this._parent({frmWindow:e.frmWindow,contextualBar:{type:"DMUMarker",module:"DMUMarker",workbenchName:"DMUMarkerContextHdr"},contextualMenu:{type:"DMUMarker",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"}})},applyStateToContextHdr:function(e){if(e.length>0)for(var t=0;t<e.length;t++){var r=n.getCommand(e[t].name,"Default");void 0!==r&&r.setState&&r.setState(e[t].state)}},setCheckCmdHdrState:function(e){this.applyStateToContextHdr&&e.length>0&&this.applyStateToContextHdr(e)}})}),define("DS/DMUMarker/DMUMarkerCreatePictureCtxInternalCmd",["DS/ApplicationFrame/Command","DS/ApplicationFrame/CommandsManager"],function(e,t){"use strict";return e.extend({init:function(e){e.mode="shared",this._parent(e),this.setRepeatMode(!1)},beginExecute:function(){var e=t._getCurrent(this.options.context),n=t.getCommand("markerPictureCmdHdr",this._ctx);(!n||n&&!n.isPaused()||n&&!n.setPictureCreationChoice)&&(n=t.getCommand("marker2DPictureCmdHdr",this._ctx)),!n||n&&!n.setPictureCreationChoice||("DMUImportPictureFromFileHdr"===e?n.setPictureCreationChoice("browser"):"DMUCreateSnapshotHdr"===e?n.setPictureCreationChoice("webcam"):n.setPictureCreationChoice(null),this.end())}})}),define("DS/DMUMarker/DMUMarkerArrowCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUBaseExperience/EXPToolsVisualization","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/DMUContextManager","DS/DMUPlayMarker/DMUMarker3DArrow","DS/DMUPlayMarker/DMUMarker2DArrow","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUMarker/assets/nls/DMUMarker"],function(e,t,n,r,i,a,o,s,l,c,d){"use strict";return t.extend({init:function(t){var u,m,D,h,g="markerArrowCmdHdr"===t.ID||"marker3DDoubleArrowCmdHdr"===t.ID?"3D":"2D",M=this,v=null,p=!1;function f(){v.fireEvent("onDMUObjectInitialized",{dmuObject:v}),M.addInCSO(v),M.clean()}function S(S,C){var U=i.getReviewContext({viewer:M.getFrameWindow().getViewer()}),P=U?U.getCurrentSessionMarkup():null,w=S[0].position;D="false"!==localStorage.getItem("DMUSnapRotationToggle");var y=parseFloat(localStorage.getItem("DMUSnapRotationAngle"));h=(isNaN(y)?90:y)*Math.PI/180,m||(m=new s(u)),m.addToListener("Shift",t.dragEventCallback),m.activate();var b,k=w.clone(),x=C;if("3D"===g){var E=n.getDistanceFromPixel(u,w,100,M.getFrameWindow()),F=n.getViewpointInfo(u.currentViewpoint),A=F.right.clone().add(F.up).normalize().multiplyScalar(E);const e=S[0].pathElement||M._selectedPathElement;if(c.isAPOIPath(e)){const{position:t}=l.getPOIInformationFromPathElement(e);t&&(k=t)}x?b=x.clone().sub(w.clone()).length():(x=w.clone().add(A),b=E/10)}else{var I=n.getViewerPositionFromPoint(u,k);k=new r.Vector2(I.left,I.top),x?(I=n.getViewerPositionFromPoint(u,x),x=new r.Vector2(I.left,I.top)):(x=(new r.Vector2).copy(k)).add(new r.Vector2(150,0)),b=x.clone().sub(k).length()/10}(v="3D"===g?new a(u,P):new o(u,P)).setAttributes([{name:"sID",value:P.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:P.computeNewName({object:v,prefix:"3D"===g?d.arrow3DPrefix:d.arrow2DPrefix})},{name:"vFirstPoint",value:k},{name:"vSecondPoint",value:x},{name:"fWidth",value:b},{name:"cLineStyleColor",value:new r.Color("#cc092f")},{name:"cFillStyleColor",value:new r.Color("#cc092f")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sStyle",value:-1===t.ID.indexOf("DoubleArrow")?"beginSide":"bothSide"},{name:"fPointedPageNumber",value:M.getPageNumber()},{name:"sPointedElementID",value:M.getElementId()}]);var T=P.getCurrentSlide();T.addDMUObject(v),require(["DS/DMUBaseExperience/EXPUtils"],function(e){e._sendUsageProbe("command","CreateArrow"+g+T.getType())}),p||f()}i.setAuthoringFeatureTypes("Marker"),t.dragEventCallback=function(e){if(e.isCanvasToDraw){if(v){var t,i,a=n.getPositionFromIntersection(u,e.vCurrentPosition,e.vCurrentPosition,!0),o=e.iEventData.from[0].getCurrentPosition(u.canvas),s=M.getAbsolutePosition("2D"===g?e.vStartPosition:v.getAttribute("vFirstPoint")),l=n.getViewerPositionFromPoint(u,s);l=new r.Vector2(l.left,l.top);var c=(new r.Vector2).subVectors(o,l),d=new r.Vector2(1,0).dot(c.clone().normalize());i=o.y<=l.y?Math.acos(d):2*Math.PI-Math.acos(d);var C=e.shiftKey||void 0===e.shiftKey&&e.iEventData.from&&e.iEventData.from.length&&e.iEventData.from[0].event&&e.iEventData.from[0].event.shiftKey;if(D!==C){var U=Math.round(i/h)*h,P=new r.Vector2(Math.cos(U),-Math.sin(U));if(P.setLength(c.dot(P)),P.distanceTo(c)<m.ROTATION_SNAP_THRESHOLD){P.normalize();var w=(new r.Vector2).subVectors(n.get2DSnappedPosition(o,U),l);P.setLength(w.dot(P)),a=M.getRelativePosition(n.getPositionFromIntersection(u,l.add(P),s)),m.displayAxis(s,U,w.length()+20)}else m.removeAxis()}else m.removeAxis();if("2D"===g){var y=n.getViewerPositionFromPoint(u,a);a=new r.Vector2(y.left,y.top)}t=a.clone().sub(v.getAttribute("vFirstPoint")).length()/10,v.setAttributes([{name:"fWidth",value:t},{name:"vSecondPoint",value:a}]),v.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:v})}else p=!0,S([{position:e.vStartPosition}],e.vCurrentPosition);m.updateManipulationData(e)}e.bLastUpdate&&v&&f()},this.clean=function(){m&&m.remove(),p=!1,m=v=null},this._parent(t,function(e){p||v||S(e)},d.arrowPositionLabel,{},!0),u=this.getFrameWindow().getViewer()},beginExecute:function(){var e=i.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)?this._parent():this.end()},endExecute:function(){this._parent(),this.clean&&this.clean()}})}),define("DS/DMUMarker/DMUMarkerFreehandCreateCmd",["DS/DMUBaseCommands/EXPStateCommand","DS/DMUBaseUIManipulators/DMUCursorsController","DS/DMUBaseExperience/DMUContextManager","DS/DMUMarker/DMUMarkerFreehandShapePreview","DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/DMUPlayMarker/DMUMarkerFactory","DS/3DPlayAnnotationUtils/ShapeUtils","DS/DMUControls/DMUContextToolsMenu","DS/WebappsUtils/WebappsUtils","DS/Utilities/TouchUtils","DS/DMUBaseExperience/EXPManagerSet","i18n!DS/DMUMarker/assets/nls/DMUMarker"],function(e,t,n,r,i,a,o,s,l,c,d,u,m,D){"use strict";return e.extend({init:function(e){this._parent(e,"exclusive",!0);var h,g,M,v,p,f,S,C,U,P=this.getFrameWindow().getViewer(),w=this,y=!1,b=!1,k=localStorage.getItem("currentFreehandMode")?localStorage.getItem("currentFreehandMode"):"DMUFreehandAnnotate",x=localStorage.getItem("currentFreehandAnnotateColor")?localStorage.getItem("currentFreehandAnnotateColor"):"DMUFreehandColorRed",E=localStorage.getItem("currentFreehandHighlightColor")?localStorage.getItem("currentFreehandHighlightColor"):"DMUFreehandColorYellow",F=[],A={},I=d.getWebappsAssetUrl("DMUMarker","icons/");function T(){(F=M.getPreviewPoints())&&F.length>=2?(!function(){var e=n.getReviewContext({viewer:w.getFrameWindow().getViewer()}).getCurrentSessionMarkup(),t=l.shapeEval(F),r=g?g.getPageNumber(C):null,i=g?g.getElementId(C):null;if(p=s.create3DMarker({viewer:P,points:F,shape:t.shape,parent:e,graphicProperties:A,pageNb:r,pointedElement:i,getRelativePositionCB:function(e){if(C===P.canvas||!g)return e;var t=g.getElementMatrix(r||i);return e.clone().applyMatrix4((new o.Matrix4).getInverse(t))},getRelativeRotationCB:function(e){return C!==P.canvas&&g&&r?e-g.getPageRotation(r):e}})){var a=e.getCurrentSlide();a.addDMUObject(p),require(["DS/DMUBaseExperience/EXPUtils"],function(e){e._sendUsageProbe("command","CreateFreehand"+("DMUFreehandAnnotate"===k?"Annotate":"Highlight")+a.getType())})}}(),M.refreshPreview(),p&&(p.fireEvent("onDMUObjectInitialized",{dmuObject:p}),S||(S=[]),S.push(p))):M.refreshPreview()}function _(e){if(e&&e===C)return!0;for(var t=e.parentNode;t&&"___view___1"!==t.id;){if(t===C)return!0;t=t.parentElement}return!1}function L(e){w.isPaused()||w.getFrameWindow().getViewpoint().isMoving()||f&&f.isCornerButtonActive()||(b=!0,_(e.from[0].getView())&&("touchmove"!==e.from[0].event.type||e.from[0].event.pageX||e.from[0].event.pageY||(e.from[0].event.pageX=e.from[0].event.touches&&e.from[0].event.touches.length?e.from[0].event.touches[0].pageX:0,e.from[0].event.pageY=e.from[0].event.touches&&e.from[0].event.touches.length?e.from[0].event.touches[0].pageY:0),h||"begin"!==e.state||(h=e.from[0].getStartPosition(P.canvas)),M.updatePreview(e.from[0].getCurrentPosition(P.canvas),!1)),"end"===e.state&&(y=!1,b=!1,w.publish({event:"dragEnd"}),T()))}function V(e){w.getFrameWindow().getViewpoint().isMoving()||f&&f.isCornerButtonActive()||!_(e.from[0].getView())||b||(y=!0,"touchmove"!==e.from[0].event.type||e.from[0].event.pageX||e.from[0].event.pageY||(e.from[0].event.pageX=e.from[0].event.touches&&e.from[0].event.touches.length?e.from[0].event.touches[0].pageX:0,e.from[0].event.pageY=e.from[0].event.touches&&e.from[0].event.touches.length?e.from[0].event.touches[0].pageY:0),h||(h=e.from[0].getStartPosition(P.canvas)),M.updatePreview(e.from[0].getCurrentPosition(P.canvas),!0))}function H(e){var n,r;"DMUFreehandAnnotate"===k?(x=e.id,localStorage.setItem("currentFreehandAnnotateColor",x),n="22/I_MarkerFreehandCursor",r=") 11 11, auto"):(E=e.id,localStorage.setItem("currentFreehandHighlightColor",E),n="32/I_MarkerFreehandHighlightCursor",r=") 16 16, auto");var i=t.giveDMUCursorsController({context:w.getFrameWindow()});switch(e.id){case"DMUFreehandColorGreen":A.lineStyleColor=new o.Color(5748807),i&&i.setCursors({pages:U!==P.canvas?"url("+I+n+"Green.png"+r:null,canvas:U===P.canvas?"url("+I+n+"Green.png"+r:null});break;case"DMUFreehandColorOrange":A.lineStyleColor=new o.Color(16747054),i&&i.setCursors({pages:U!==P.canvas?"url("+I+n+"Orange.png"+r:null,canvas:U===P.canvas?"url("+I+n+"Orange.png"+r:null});break;case"DMUFreehandColorYellow":A.lineStyleColor=new o.Color(16703488),i&&i.setCursors({pages:U!==P.canvas?"url("+I+n+"Yellow.png"+r:null,canvas:U===P.canvas?"url("+I+n+"Yellow.png"+r:null});break;case"DMUFreehandColorRed":A.lineStyleColor=new o.Color(13371695),i&&i.setCursors({pages:U!==P.canvas?"url("+I+n+"Red.png"+r:null,canvas:U===P.canvas?"url("+I+n+"Red.png"+r:null})}M.setGraphicProperties(A)}function O(e){"DMUFreehandHighlight"===e.id?(localStorage.setItem("currentFreehandMode","DMUFreehandHighlight"),k=e.id,A.lineCap="square",A.lineStyleThicknessIndex=9,A.lineStyleOpacity=.4,A.isFilled=!0,A.hasBorder=!1,M.setGraphicProperties(A),f.setColor(E),H({id:E})):"DMUFreehandAnnotate"===e.id?(localStorage.setItem("currentFreehandMode","DMUFreehandAnnotate"),k=e.id,A.lineCap="round",A.lineStyleThicknessIndex=3,A.lineStyleOpacity=1,A.isFilled=!1,A.hasBorder=!0,M.setGraphicProperties(A),f.setColor(x),H({id:x})):w.publish({event:"lastClick"})}function B(e){w.isPaused()||f&&f.isCornerButtonActive()||(C=g?g.getElementToDraw(e.from[0].getView()):P.canvas)&&(h=e.from[0].getStartPosition(P.canvas),M.updatePreview(h,!1))}function R(e){w.isPaused()||f&&f.isCornerButtonActive()||!_(e.from[0].getView())||(!h||b||y||w.getFrameWindow().getViewpoint().isMoving()?y&&(y=!1,T(),a.removeEvent(U,"onMouseMove",V)):w.publish({event:"click",data:e.from[0].getCurrentPosition(P.canvas)}),h=null,b=!1)}function W(e){C&&!w.isPaused()&&(a.addEvent(U,"onMouseMove",V),y=!0,e())}function N(e){"@onViewpointBeginMove"!==e.eventType&&"@onViewpointEndMove"!==e.eventType||M.refreshPreview()}function j(e){var t=P.get2DMode()?D.freehandManipulationModeLabel2D:D.freehandManipulationModeLabel;w.sendNotify("info",e.checked?t:D.freehandCreationLabel);var n=P.currentViewpoint.getControl();P.get2DMode()||(n.setRotationActive(e.checked),n.setTouchRotationActive(e.checked)),n.setPanActive(e.checked),n.setZoomActive(e.checked),g&&g.setTouchPanActive(e.checked),M.refreshPreview()}this._parentBeginExecute=this.beginExecute,this.beginExecute=function(){var e=n.getReviewContext({viewer:w.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)?(P.currentViewpoint.setDefaultController(!1,"FLY_WALK"),g||(g=m.getManager({name:"DMU2DSheetManager",context:this.getFrameWindow()})),U=g?g.getPointedElem():P.canvas,g&&g.setTextSelectionFlag(!1),w.emptyHSO(),w.emptyCSO(),w.sendNotify("info",D.freehandCreationLabel),P.manipulatorManager.setActivate(!1),P.setDefaultPicking(!1),a.addEvent(U,"onPrimaryPointerDownUnique",B),a.addEvent(U,"onPrimaryPointerUpUnique",R),a.addEvent(U,"onDrag",L),(f=new c({frameWindow:this.getFrameWindow()})).addButton({label:D.exitFreehandAnnotationsLabel,id:"DMUFreehandExit",icon:I+"32/I_MarkerFreehandExit.png",isOneShot:!0,isSelected:!1,onClickCB:O}),f.addSeparator(),f.addButton({label:D.annotateModeLabel,id:"DMUFreehandAnnotate",icon:I+"32/I_MarkerFreehand.png",isSelected:"DMUFreehandAnnotate"===k,onClickCB:O}),f.addButton({label:D.highlightModeLabel,id:"DMUFreehandHighlight",icon:I+"32/I_MarkerFreehandHighlight.png",isSelected:"DMUFreehandHighlight"===k,onClickCB:O}),f.createColorPalette([{id:"DMUFreehandColorGreen",color:new o.Color(5748807),isSelected:"DMUFreehandAnnotate"===k?"DMUFreehandColorGreen"===x:"DMUFreehandColorGreen"===E,onClickCB:H},{id:"DMUFreehandColorYellow",color:new o.Color(16703488),isSelected:"DMUFreehandAnnotate"===k?"DMUFreehandColorYellow"===x:"DMUFreehandColorYellow"===E,onClickCB:H},{id:"DMUFreehandColorOrange",color:new o.Color(16747054),isSelected:"DMUFreehandAnnotate"===k?"DMUFreehandColorOrange"===x:"DMUFreehandColorOrange"===E,onClickCB:H},{id:"DMUFreehandColorRed",color:new o.Color(13371695),isSelected:"DMUFreehandAnnotate"===k?"DMUFreehandColorRed"===x:"DMUFreehandColorRed"===E,onClickCB:H}]),M||(M=new r({frameWindow:w.getFrameWindow(),graphicProperties:A})),M.startPreview(),O({id:k}),v=i.subscribe({event:"/VISU/"},N),P.get2DMode()?g&&g.setTouchPanActive(!1):P.currentViewpoint.getControl().setTouchRotationActive(!1),u.getTouchMode()&&(P.currentViewpoint.getControl().setPanActive(!1),P.currentViewpoint.getControl().setZoomActive(!1),P.get2DMode()||P.currentViewpoint.getControl().setRotationActive(!1),f.createCornerButton({id:"DMUFreehandTouchButton",enabledIcon:I+"../textures/DMUFreehandRotationOn.png",disabledIcon:I+"../textures/DMUFreehandRotationOff.png",onClickCB:j})),this._parentBeginExecute()):w.end()},this._parentPauseExecute=this.pauseExecute,this.pauseExecute=function(){this._parentPauseExecute(),f&&f.setVisibleFlag(!1)},this._parentResumeExecute=this.resumeExecute,this.resumeExecute=function(){this._parentResumeExecute(),f&&f.setVisibleFlag(!0);let e=t.giveDMUCursorsController({context:w.getFrameWindow()});e&&e.resetCursors()},this._parentEndExecute=this.endExecute,this.endExecute=function(){v&&i.unsubscribe(v),P.get2DMode()?g&&g.setTouchPanActive(!0):P.currentViewpoint.getControl().setTouchRotationActive(!0),u.getTouchMode()&&(P.get2DMode()||P.currentViewpoint.getControl().setRotationActive(!0),P.currentViewpoint.getControl().setPanActive(!0),P.currentViewpoint.getControl().setZoomActive(!0)),w.cleanNotify(),P.manipulatorManager.setActivate(!0),P.setDefaultPicking(!0);var e=t.giveDMUCursorsController({context:w.getFrameWindow()});e&&e.restoreCursors(),a.removeEvent(U,"onPrimaryPointerUpUnique",R),a.removeEvent(U,"onDrag",L),a.removeEvent(U,"onPrimaryPointerDownUnique",B),a.removeEvent(U,"onMouseMove",V),g&&g.setTextSelectionFlag(!0),f&&(f.destroy(),f=null),M&&(M.destroy(),M=null),P.currentViewpoint.setDefaultController(!0,"FLY_WALK"),y=!1,b=!1,p=F=null,this._parentEndExecute(),S&&(S.forEach(function(e){w.addInCSO(e,!0)}),S=null)},this.buildGraph=function(){var e=w.createInitialState("initialState"),t=w.createState("clickState"),n=w.getFinalState(),r={iSender:w,iEvent:"click",iInitialState:e,iFinalState:t,iCondition:function(){return!y&&!b},iAction:W};w.addTransition(r);var i={iSender:w,iEvent:"click",iInitialState:t,iFinalState:t,iCondition:null,iAction:W};w.addTransition(i);var a={iSender:w,iEvent:"dragEnd",iInitialState:e,iFinalState:t,iCondition:null};w.addTransition(a);var o={iSender:w,iEvent:"dragEnd",iInitialState:t,iFinalState:t,iCondition:null};w.addTransition(o);var s={iSender:w,iEvent:"lastClick",iInitialState:e,iFinalState:n,iCondition:null};w.addTransition(s);var l={iSender:w,iEvent:"lastClick",iInitialState:t,iFinalState:n,iCondition:null};w.addTransition(l)}}})}),define("DS/DMUMarker/DMUMarkerPictureContextualBar",["DS/DMUMarker/DMUMarkerContextualBar"],function(e){"use strict";return e.extend({getContextualCommandList:function(e){var t=this._parent(e);return e&&!e.isReadOnly()&&e.isInEdition()&&e.isEditable()&&(t||(t=[]),t.unshift({name:"DMUMarkerShortDisplayStr",line:1,hdr_list:["DMUMarkerShortDisplayHdr"]})),t},getSharedHeaderTypes:function(){return{leaderProperties:!0,hideShowLeaderProperties:!0}}})}),define("DS/DMUMarker/DMUMarkerLineContextualBar",["DS/DMUMarker/DMUMarkerContextualBar","DS/DMUBaseExperience/EXPManagerSet"],function(e,t){"use strict";return e.extend({getContextualCommandList:function(){var e=[];if(!this.isReadOnly()&&this.isInEdition()&&this.isEditable()){var n=t.getManager({name:"DMU2DSheetManager",context:this._frmWindow});n&&n.isADocumentDisplayed()&&("Document"===n.getDocumentType()||"Requirement"===n.getDocumentType())&&(e=[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"]}]),e=e.concat([{name:"DMUGraphicPropertiesPanelHdr",line:1,hdr_list:["DMUGraphicPropertiesPanelHdr"]}])}return e}})}),define("DS/DMUMarker/DMUMarkerTextContextualBar",["DS/DMUMarker/DMUMarkerContextualBar","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return e.extend({getContextualCommandList:function(e){var n=this._parent(e);if(e&&!e.isReadOnly()&&e.isInEdition()&&e.isEditable()&&(n||(n=[]),n.unshift({name:"Marker_DMUIncreaseFontSizeStr",line:1,hdr_list:["Marker_DMUIncreaseFontSizeHdr"]},{name:"Marker_DMUDecreaseFontSizeStr",line:1,hdr_list:["Marker_DMUDecreaseFontSizeHdr"]}),"Marker3DStamp"!==e.getAttribute("sType"))){var r="Marker_DMUDefaultStyleHdr";e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#000000")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new t.Color("#ffffff")},{name:"bIsFilled",value:!1},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#3d3d3d")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#3d3d3d")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Marker_DMULightStyleHdr":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new t.Color("#368ec4")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#3d3d3d")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#3d3d3d")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Marker_DMUMeasureStyleHdr":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#000000")},{name:"sFontStyle",value:"italic"},{name:"cFillStyleColor",value:new t.Color("#fee000")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#ff8a2e")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#ff8a2e")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Marker_DMUPostitStyleHdr":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new t.Color("#57b847")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#477738")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#477738")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Marker_DMUValidateStyleHdr":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new t.Color("#ff8a2e")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#8f4c00")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#8f4c00")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Marker_DMUWarningStyleHdr":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#ffffff")},{name:"sFontStyle",value:"bold"},{name:"cFillStyleColor",value:new t.Color("#cc092f")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#6d2828")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#6d2828")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))&&(r="Marker_DMUCautionStyleHdr"),n.unshift({name:"Marker_DMUStylesStr",line:1,hdr_list:["Marker_DMUDefaultStyleHdr","Marker_DMULightStyleHdr","Marker_DMUMeasureStyleHdr","Marker_DMUPostitStyleHdr","Marker_DMUValidateStyleHdr","Marker_DMUWarningStyleHdr","Marker_DMUCautionStyleHdr"],selectedHdr:r})}return n},getSharedHeaderTypes:function(){return{leaderProperties:!0,fontProperties:!0,hideShowLeaderProperties:!0}}})});