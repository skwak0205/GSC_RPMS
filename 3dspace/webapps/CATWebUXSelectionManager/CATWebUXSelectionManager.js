/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATWebUXSelectionManager/CATWebUXSelectionManager",["UWA/Class","DS/CoreEvents/ModelEvents","DS/Selection/CSOManager","DS/Selection/PSOManager"],function(e,t,n,i){"use strict";var r=e.extend({init:function(e){var r=e||{};this._parent(r);var c,a,o,s=r.context,u=require("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"),l=this,f=!0,g=new t,h=!0;function P(e,t){g&&g.publish({event:e,data:t})}function v(e){if(!u||!e||!e.event||!e.pathElement||!e.pathElement.externalPath.length||!u.isAModelPath(e.pathElement)||0===c&&e.pathElement.internalPath.length)return;if(e.pathElement.getLastElement(!0).getAnnotationClassType)return;let t=e.pathElement.clone();t.internalPath.length=0;let n=t.getLastElement(!0);if(!s.getViewer().get2DMode()){for(;t&&!u.isReference(n)&&!u.isRepReference(n);)(t=t.getParentPath())&&(n=t.getLastElement(!0));if(f&&n&&u.isRepReference(n))for(;t&&!u.isReference(n);)(t=t.getParentPath())&&(n=t.getLastElement(!0))}if(t)e.pathElement=t;else{for((t=e.pathElement.clone()).internalPath.length=0;t&&!u.is3DLeaf(t.getLastElement(!0));)t=t.getParentPath();t&&(e.pathElement=t)}}function S(e){Array.isArray(e)?e.forEach(function(e){v(e)}):v(e)}this.setActiveState=function(e){(h=e)?(a||(a=i.onPreAdd(S),o=n.onPreAdd(S)),0!==c&&1!==c||(s.getViewer().setPicking({primitive:0===c?1:0}),s.getViewer().setPrePicking({primitive:0===c?1:0}))):(a&&i.unsubscribe(a),o&&n.unsubscribe(o),a=o=null),P("onSelectionManagerActiveStateModified",{state:h})},this.setPicking=function(e){e===c||0!==e&&1!==e||(c=e,h&&(s.getViewer().setPicking({primitive:0===c?1:0}),s.getViewer().setPrePicking({primitive:0===c?1:0}),P("onPickingModified",{state:c})))},this.selectParentReference=function(e){f=e},this.clearSelectionManager=function(){l.setActiveState(!1),g=s=null},this.subscribe=function(e,t){if(e&&t&&g)return g.subscribe({event:e},t)},this.unsubscribe=function(e){g&&e&&g.unsubscribe(e)},this.getTruncatedPath=function(e){var t={event:"fakeEvent",pathElement:e};return v(t),t.pathElement},this.getActiveState=function(){return h},this.getPicking=function(){return c}}}),c=[];return e.singleton({init:function(){},giveSelectionManager:function(e){var t;return e&&e.context&&c.some(function(n){if(n.context===e.context)return t=n.selectionMng,!0}),t},getSelectionManager:function(e){var t,n,i;return e&&e.context&&c.some(function(n){if(n.context===e.context)return t=n,!0}),!t&&e&&e.context?(i=new r(e),n=Object.freeze({setActiveState:function(e){i&&i.setActiveState(e)},getActiveState:function(){return i?i.getActiveState():null},subscribe:function(e,t){i&&i.subscribe(e,t)},unsubscribe:function(e){i&&i.unsubscribe(e)},setPicking:function(e){i&&i.setPicking(e)},getPicking:function(){return i?i.getPicking():null},selectParentReference:e=>{i&&i.selectParentReference(e)},getTruncatedPath:function(e){return i?i.getTruncatedPath(e):e}}),c.push({context:e.context,clear:function(){i&&i.clearSelectionManager(),i=null},selectionMng:n,manager:i,counter:1})):t&&(t.counter++,n=t.selectionMng,i=t.manager),n},unreferenceSelectionManager:function(e){e&&e.context&&c.some(function(t,n){if(t.context===e.context)return c[n].counter--,c[n].counter<=0&&(c[n].clear(),c.splice(n,1)),!0})}})});