define("DS/VCXWebExperienceLoader/VCXExperienceSaverBase",["UWA/Class","DS/VCXWebProperties/VCXPropertyValueMap","DS/VCXWebProperties/VCXPropertyValueList","DS/WebRBTree/WebRBIterator"],function(e,r,t,a){"use strict";return e.extend({init:function(){},_reformatObjectIDForPathOfId:function(e,r){var t,a=r.ComponentsMap.GetComponentFromID(e);a?r.getManager("VCXContextManager").getCat3DXIntegration()&&a.QueryInterface("CATI3DExperienceObject")?(t={}).pathOfIds=a.GetID().split(","):t=a.GetID():t="";return t},_MetaPropertiesDefToJson:function(e){var r=[],t=e.getManager("VCXMetaPropertyManager")._MetaPropertyDef;for(var a in t)if(t.hasOwnProperty(a)){var o=t[a],n=o.GetPropertyInfo(),i={name:a,type:o.GetType(),behavior:n.GetBehaviorType(),defaultLabel:o.GetDefaultLabel()};n.IsBounded()&&(i.bounds=n.GetBounds()),r.push(i)}return r},_PropertiesLinksToJson:function(e){var r=[];for(var t in e._links)if(e._links.hasOwnProperty(t)){var a=e._links[t];if(a)for(var o in a){var n=a[o];if(n)for(var i in n)if(n.hasOwnProperty(i)){var s=n[i];for(var l in s)if(s.hasOwnProperty(l)){var p={inID:t,inProp:o,outID:i,outProp:l};r.push(p)}}}}return r},_ComponentsMapToJson:function(e){var r=[],t=e.ComponentsMap.GetComponentTable();for(var a in t)if(t.hasOwnProperty(a)){var o=t[a];if(0!==o.GetPersistency())continue;var n=o.GetType(),i={};i.objectID=a,i.objectType=n;var s=null;o.BuildLoadData&&(s=o.BuildLoadData()),s&&(i.objectData=s),r.push(i)}return r},_W3AISGNodeHolderToJson:function(e){var r=[],t=e.ComponentsMap.GetComponentTable();for(var a in t)if(t.hasOwnProperty(a)){var o=t[a];if(2===o.GetPersistency())continue;var n={};n.objectID=a;var i=o.QueryInterface("W3AISGNodeHolder");if(i&&!i.isSelfManagedPathElement()){var s=o.QueryInterface("VCXIModelNavigable");if(s){var l=s.getAssetNavigable();if(l){var p=i.getRelativePathElement(l),u=this._BuildArrayIDsFromPathElement(p);n.PathElement=u,r.push(n)}}}}return r},_VCXIModelNavigableToJson:function(e){var r=[],t=e.ComponentsMap.GetComponentTable();for(var a in t)if(t.hasOwnProperty(a)){var o=t[a];if(2===o.GetPersistency())continue;var n={};n.objectID=a;var i=o.QueryInterface("VCXIModelNavigable");if(i)if(i.isSelfOrganized()){var s=i.getWorkingRoot();s&&(n.WorkingRoot=s.GetObject().GetID(),r.push(n))}else{var l=i.getParent();l&&(n.NavigableParent=l.GetObject().GetID(),r.push(n))}}return r},_BuildArrayIDsFromPathElement:function(e){if(e){var r=[],t=e.externalPath;if(t)for(var a=0;a<t.length;a++){var o=t[a],n=o.persistentId,i=o.id;if(n)r.push(n.toString());else if(i)r.push(i.toString());else{var s=o.name;r.push(s)}}return r}},_NeutralsToJson:function(e,r){var t=[],a=e.getManager("VCXScenarioManager")._keyframer._Neutrals;for(var o in a._map)if(a._map.hasOwnProperty(o)){var n=e.getManager("VCXScenarioManager").ModifiableServer.GetModifiableFromHashing(o);if(!n){console.log("WARNING this hashmodifiable does not exist : "+o);continue}var i=n.GetObject();if(2===i.GetPersistency())continue;var s=a.GetPropertySet(o),l=null,p=i.QueryInterface("CATI3DExpVCXObjectConvertor");if(s&&p&&r){var u=s.Clone();p.UpdateVariablesFromNeutrals(u,r),l=this._PropSetToJson(u,e)}l||(l=this._PropSetToJson(s,e));var f={objectID:this._reformatObjectIDForPathOfId(i.GetID(),e),properties:l};t.push(f)}return t},_PropSetToJson:function(e,r){var t=[];for(var a in e._map)if(e._map.hasOwnProperty(a)){var o=e.GetProperty(a).GetPropertyValue(),n=o.GetType(),i=this._PropertyToJson(o,r);t.push({name:a,type:n,value:i})}return t},_PropMapToJson:function(e,r){var t={};for(var a in r._map)if(r._map.hasOwnProperty(a)){var o=r.GetPropertySet(a),n=e.getManager("VCXScenarioManager").ModifiableServer.GetModifiableFromHashing(a);if(!n){console.log("WARNING this hashmodifiable does not exist : "+a);continue}if(n){var i=n.GetObject().GetID(),s=this._PropSetToJson(o,e);t[i]=s}}return t},_PropertyToJson:function(e,a){var o=null,n=e.GetType();if("VCXPropertyValueColor"===n)o=e.GetValue().GetRGBA();else if(e instanceof r){o=[];for(var i=0;i<e._value.length;i++){if(l=e._value[i]){var s=this._PropertyToJson(l,a);o.push({type:l.GetType(),index:i,value:s})}}}else if(e instanceof t){o=[];for(i=0;i<e._value.length;i++){var l=e._value[i];s=this._PropertyToJson(l,a);o.push({type:l.GetType(),value:s})}}else if("VCXPropertyValueFrame"===n){o=[];var p=e.GetValue().elements;for(var u in p)p.hasOwnProperty(u)&&"3"!==u&&"7"!==u&&"11"!==u&&"15"!==u&&o.push(p[u])}else if("VCXPropertyValueBoolean"===n)o=e.GetValue();else if("VCXPropertyValueDate"===n)o=e.GetTime()/6e4;else if("VCXPropertyValuePoint2D"===n){var f=e.GetValue();(o=[]).push(f.x),o.push(f.y)}else if("VCXPropertyValuePoint"===n){var V=e.GetValue();(o=[]).push(V.x),o.push(V.y),o.push(V.z)}else if("VCXPropertyValueVector"===n){var C=e.GetValue();o=[];for(i=0;i<C.length;i++)o.push(C[i])}else{if("VCXPropertyValueLink"===n){var c=e.ToString();return this._reformatObjectIDForPathOfId(c,a)}var h=e.GetValue();o="number"==typeof h?h:e.ToString()}return void 0!==o||(o="undefined"),o},_ScenarioToJson:function(e,r){var t=[];r.GetListModifiables(t);for(var a=[],o=0;o<t.length;o++){var n=t[o],i=e.getManager("VCXScenarioManager").ModifiableServer.GetModifiableFromHashing(n);if(i){if(2!==i.GetObject().GetPersistency()){var s=r.GetObjectAnimation(n),l=this._TracksToJson(s,i,e);a.push(l)}}else console.log("WARNING this hashmodifiable does not exist : "+n)}return{name:r.GetName(),ID:r.GetID(),listMods:a}},_VisibilityToJson:function(e,r){for(var t=[],a=[],o=[],n=e.GetVisibles(),i=0;i<n.length;i++){var s=this._reformatObjectIDForPathOfId(n[i],r);t.push({objectID:s})}var l=e.GetInvisibles();for(i=0;i<l.length;i++){var p=this._reformatObjectIDForPathOfId(l[i],r);a.push({objectID:p})}var u=e.GetVisibleCollabs();for(i=0;i<u.length;i++){var f=this._reformatObjectIDForPathOfId(u[i],r);o.push({objectID:f})}return{listVisible:t,listInvisible:a,listVisibleCollabs:o}},_TracksToJson:function(e,r,t){var a=[];if(e){var o=[];e.GetListTrackNames(o);for(var n=0;n<o.length;n++){var i=o[n],s=e.GetTrack(i),l=this._KeysToJson(s,i,t);a.push(l)}}var p=r.GetObject();return{objectID:this._reformatObjectIDForPathOfId(p.GetID(),t),listTracks:a}},_KeysToJson:function(e,r,t){for(var o="",n=[],i=e._treekeys,s=new a(i),l=s.next();null!==l;){var p=l.GetFrame(),u=l.GetValue();o||(o=u.GetType());var f=this._PropertyToJson(u,t);"VCXPropertyValueLink"==o&&""==f?console.log("warning VCXPropertyValueLink with no link is not saved"):n.push({time:p,value:f}),l=s.next()}return{name:r,type:o,listKeys:n}}})}),define("DS/VCXWebExperienceLoader/VCXExperienceLoaderBase",["UWA/Class","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS","DS/VCXWebProperties/VCXColor","DS/VCXWebProperties/VCXPropertyValueString","DS/VCXWebProperties/VCXPropertyValueFloat","DS/VCXWebProperties/VCXPropertyValueInt","DS/VCXWebProperties/VCXPropertyValueEnum","DS/VCXWebProperties/VCXPropertyValueBoolean","DS/VCXWebProperties/VCXPropertyValueFrame","DS/VCXWebProperties/VCXPropertyValuePoint2D","DS/VCXWebProperties/VCXPropertyValuePoint","DS/VCXWebProperties/VCXPropertyValueLocation","DS/VCXWebProperties/VCXPropertyValueColor","DS/VCXWebProperties/VCXPropertyValueVector","DS/VCXWebProperties/VCXPropertyValuePath","DS/VCXWebProperties/VCXPropertyValueHyperlinkId","DS/VCXWebProperties/VCXPropertyValueDocId","DS/VCXWebProperties/VCXPropertyValueAnchor","DS/VCXWebProperties/VCXPropertyValueLink","DS/VCXWebProperties/VCXPropertyValueBase64","DS/VCXWebProperties/VCXPropertyValueBin","DS/VCXWebProperties/VCXPropertyValueFont","DS/VCXWebProperties/VCXPropertyValueDate","DS/VCXWebProperties/VCXPropertyValueMap","DS/VCXWebProperties/VCXPropertyValueList","DS/VCXWebProperties/VCXPropertySet","DS/VCXWebProperties/VCXPropertyMap","DS/VCXWebProperties/VCXProperty","DS/VCXWebProperties/VCXPropertyInfo","DS/VCXWebKernelCommands/VCXCmdChangeScenario","DS/VCXWebKernelCommands/VCXCmdChangeKeys","DS/VCXWebKernelCommands/VCXCmdChangeNeutralProperties","DS/VCXWebModifiables/VCXMetaPropertyDef","DS/VCXWebKernelCommands/VCXCmdChangeScenarioSequence","DS/VCXWebKernelCommands/VCXCmdChangeSequence","i18n!DS/VCXWebModifiables/assets/nls/VCXWebModifiables"],function(e,r,t,a,o,n,i,s,l,p,u,f,V,C,c,h,P,d,v,m,y,g,b,X,I,S,D,M,_,G,O,F,B,W,w,L,T){"use strict";return e.extend({InitLoader:function(e){this._experienceBase=e,e?(this._factory=e.Factory,this._scenarioManager=e.getManager("VCXScenarioManager"),this._ComponentsMap=e.ComponentsMap):console.log("VCXExperienceLoaderBase : experience base param missing!")},_reformatObjectIDForPathOfId:function(e){if(void 0===e)return e;if(e.pathOfIds){for(var r="",t=0;t<e.pathOfIds.length;t++)0!=t&&(r+=","),r+=e.pathOfIds[t];return r}return e},BuildVCXPropertyValue:function(e,r){var D=null;if("VCXPropertyValueFrame"===e){D=new p;for(var M=new t.Matrix4,_=0;_<12;_++)"string"==typeof r[_]&&(r[_]=parseFloat(r[_].replace(",",".")));0==r[0]&&0==r[3]&&0==r[6]&&0==r[1]&&0==r[4]&&0==r[7]&&0==r[2]&&0==r[5]&&0==r[8]&&console.log("BAD MATRIX in BuildVCXPropertyValue"),M.set(r[0],r[3],r[6],r[9],r[1],r[4],r[7],r[10],r[2],r[5],r[8],r[11],0,0,0,1),D.SetValue(M)}else if("VCXPropertyValuePoint2D"===e){D=new u;var G=new t.Vector2;for(_=0;_<2;_++)"string"==typeof r[_]&&(r[_]=parseFloat(r[_].replace(",",".")));G.set(r[0],r[1]),D.SetValue(G)}else if("VCXPropertyValuePoint"===e){D=new f;for(G=new t.Vector3,_=0;_<3;_++)"string"==typeof r[_]&&(r[_]=parseFloat(r[_].replace(",",".")));G.set(r[0],r[1],r[2]),D.SetValue(G)}else if("VCXPropertyValueLocation"===e){(D=new V).SetValues(r,this)}else if("VCXPropertyValueColor"===e){D=new C;for(_=0;_<4;_++)"string"==typeof r[_]&&(r[_]=parseFloat(r[_].replace(",",".")));var O=(new a).FromRGBA(r[0],r[1],r[2],r[3]);D.SetValue(O)}else if("VCXPropertyValueFloat"===e)D=new n,"string"==typeof r&&(r=parseFloat(r.replace(",","."))),D.SetValue(r);else if("VCXPropertyValueInt"===e)D=new i,"string"==typeof r&&(r=parseFloat(r.replace(",","."))),D.SetValue(Math.floor(r));else if("VCXPropertyValueEnum"===e)(D=new s).SetValue(parseInt(r));else if("VCXPropertyValueBoolean"===e){var F;D=new l,F="boolean"!=typeof r?1===parseInt(r):r,D.SetValue(F)}else if("VCXPropertyValueString"===e)(D=new o).SetValue(r);else if("VCXPropertyValueVector"===e){D=new c;for(_=0;_<r.length;_++)"string"==typeof r[_]&&(r[_]=parseFloat(r[_].replace(",",".")));D.SetValue(r)}else if("VCXPropertyValueAnchor"===e){(D=new v).SetValues(r,this)}else if("VCXPropertyValuePath"===e)(D=new h).SetValues(r,this);else if("VCXPropertyValueHyperlinkId"===e||"VCXPropertyValueHyperLinkId"===e)(D=new P).SetValue(r);else if("VCXPropertyValueDocId"===e)""!==r&&(D=new d).SetValue(r);else if("VCXPropertyValueLink"===e){D=new m;var B=r;if(B){var W=this._reformatObjectIDForPathOfId(B);D.SetValue(W)}}else if("VCXPropertyValueBase64"===e)D=new y,r&&D.SetValue(r);else if("VCXPropertyValueBin"===e)D=new g,r&&D.SetValue(r);else if("VCXPropertyValueFont"===e)(D=new b).SetValues(r,this);else if("VCXPropertyValueDate"===e){D=new X;var w=parseInt(r);D.SetTime(6e4*w)}else"VCXPropertyValueMap"===e?(D=new I).SetValues(r,this):"VCXPropertyValueList"===e?(D=new S).SetValues(r,this):console.log("type inconnu : "+e);return D},BuildPathElementFromArray:function(e,r,t){function a(e,r){var a=null;if(t){if(a=e.getChildById(r))return a;var o;for(o=0;o<e.children.length;o++){if((a=e.children[o]).getPersistentId&&a.getPersistentId()===r)return a;if(a.id.toString()===r)return a}}return(a=e.getChildByName(r))||null}var o=r.QueryInterface("VCXIModelNavigable");if(o){var n=o.getAssetNavigable();if(n){var i=n.QueryInterface("W3AISGNodeHolder");if(i&&i.getPathElement()){var s,l=i.getPathElement().clone();for(s=0;s<e.length;s++){var p=a(l.getLastElement(),e[s]);p?l.addElement(p):console.error("BuildPathElementFromArray : CHILD NODE NOT FOUND !! ",e[s])}return l}}}return null},LoadScenarioSequences:function(e){for(var r=0;r<e.length;r++){var t=e[r].objectID,a=this._experienceBase.ComponentsMap.GetComponentFromID(t),o=new L(this._experienceBase.getManager("VCXSequenceManager"),this._experienceBase.getManager("VCXCommandManager"),this._experienceBase.ComponentsMap);o._bIsLoading=!0,o.PushSequence(a),this._experienceBase.getManager("VCXCommandManager").Do(o);for(var n=e[r].listScenarioID,i=0;i<n.length;i++){var s=n[i],l=this._experienceBase.ComponentsMap.GetComponentFromID(s),p=new w(this._experienceBase.getManager("VCXSequenceManager"),this._experienceBase.getManager("VCXCommandManager"),this._experienceBase.ComponentsMap);p._bIsLoading=!0,p.PushScenarioInSequence(l,a.GetID()),this._experienceBase.getManager("VCXCommandManager").Do(p)}}},LoadComponents:function(e){if(e)for(var r=0;r<e.length;r++){var t=e[r].objectID,a=e[r].objectType;"VCXComponentVPMReference"===a&&(a="Model_VPMReference_Spec",console.warn("The type VCXComponentVPMReference is deprecated. Please resave the json."));var o=this._factory.BuildComponent(a);if(o){o.SetID(t),this._ComponentsMap.AddComponent(o);var n=e[r].objectData;n&&o.SetLoadData(n)}}},LoadW3AISGNodeHolder:function(e){if(e)for(var r=0;r<e.length;r++){var t=e[r].objectID,a=this._reformatObjectIDForPathOfId(t),o=this._ComponentsMap.GetComponentFromID(a);if(o){var n=o.QueryInterface("W3AISGNodeHolder");if(n){var i=e[r].PathElement;if(i){for(var s=[],l=0;l<i.length;l++)s[l]=i[l];var p=this.BuildPathElementFromArray(s,o,1);p&&n.setPathElement(p)}}}}},LoadVCXIModelNavigable:function(e){if(e)for(var r=0;r<e.length;r++){var t=e[r].objectID,a=this._reformatObjectIDForPathOfId(t),o=this._ComponentsMap.GetComponentFromID(a);if(o){var n=o.QueryInterface("VCXIModelNavigable");if(n){var i=e[r].NavigableParent;if(i){var s=this._ComponentsMap.GetComponentFromID(i);if(s){var l=s.QueryInterface("VCXIModelNavigable");l&&n.setParent(l)}}else{var p=e[r].WorkingRoot;if(p){var u=this._ComponentsMap.GetComponentFromID(p);if(u){var f=u.QueryInterface("VCXIModelNavigable");f&&n.setWorkingRoot(f)}}}}}}},LoadMetaPropertiesDef:function(e){if(e)for(var r=this._experienceBase.getManager("VCXMetaPropertyManager"),t=0;t<e.length;t++){var a=e[t],o=new G(a.name,a.behavior,!0);a.bounds&&("VCXPropertyValueFloat"===a.type?o.SetBounds(parseFloat(a.bounds.valueMin),parseFloat(a.bounds.valueMax),parseFloat(a.bounds.step)):"VCXPropertyValueFloat"===a.type&&o.SetBounds(parseInt(a.bounds.valueMin),parseInt(a.bounds.valueMax),parseInt(a.bounds.step)));var n=new W(o,a.type);o.SetGroupId("Group.UserProperties"),o.Seti18nGroup(T),o.SetMetaPropertyDef(n),n.SetDefaultLabel(a.defaultLabel),r.AddMetaPropertyDef(n)}},LoadPropertiesLinks:function(e){if(e)for(var r=this._experienceBase.getManager("VCXLinkedPropertyManager"),t=0;t<e.length;t++)r.AddLink(e[t].inID,e[t].inProp,e[t].outID,e[t].outProp,null)},LoadNeutrals:function(e){for(var r=new B(this._experienceBase.getManager("VCXScenarioManager")),t=0;t<e.length;t++){var a=e[t],o=this._reformatObjectIDForPathOfId(a.objectID),n=this._ComponentsMap.GetComponentFromID(o);if(n){var i=n.QueryInterface("VCXIModifiable");if(i)for(var s=a.properties,l=0;l<s.length;l++){var p=s[l],u=p.type,f=p.value,V=this.BuildVCXPropertyValue(u,f);V&&r.ChangeProperty(i,p.name,V)}}else console.log("ERROR : component not found : "+o+"\n")}this._experienceBase.getManager("VCXCommandManager").Do(r)},LoadPropSet:function(e){for(var r=new D,t=0;t<e.length;t++){var a=e[t],o=(a.name,a.type,a.value,this.BuildVCXPropertyValue(a.type,a.value)),n=new _(new G(a.name),o);r.AddOrModifyProperty(n)}return r},LoadPropMap:function(e){var r=new M;for(var t in e)if(e.hasOwnProperty(t)){var a=this._ComponentsMap.GetComponentFromID(t);if(a){var o=a.QueryInterface("VCXIModifiable").GetHashing(),n=e[t],i=this.LoadPropSet(n);r.AddOrModifyPropertySet(o,i)}else console.log("ERROR : LoadPropMap: component not found : "+t+"\n")}return r},LoadScenarios:function(e){for(var r=0;r<e.length;r++){var t=e[r],a=this._ComponentsMap.GetComponentFromID(t.ID);if(a){var o=new O(this._experienceBase.getManager("VCXScenarioManager"),this._experienceBase.getManager("VCXCommandManager"),this._experienceBase.ComponentsMap);o.AddScenarios(a),this._experienceBase.getManager("VCXCommandManager").Do(o),a.SetName(t.name);for(var n=new F(this._experienceBase.getManager("VCXScenarioManager")),i=t.listMods,s=0;s<i.length;s++){var l=i[s],p=this._reformatObjectIDForPathOfId(l.objectID);if(D=this._ComponentsMap.GetComponentFromID(p)){var u=D.QueryInterface("VCXIModifiable");if(u)for(var f=l.listTracks,V=0;V<f.length;V++){var C=f[V],c=C.name,h=C.listKeys;if(h)for(var P=0;P<h.length;P++){var d=h[P],v=d.easing,m=d.value,y=this.BuildVCXPropertyValue(C.type,m);y&&n.ChangeKey(a,u,c,parseFloat(d.time),y,v)}}}else console.log("ERROR : LoadScenarios: component not found : "+p+"\n")}this._experienceBase.getManager("VCXCommandManager").Do(n);var g=t.visibility;if(g){var b=g.listVisible;if(b)for(var X=0;X<b.length;X++){l=b[X],p=this._reformatObjectIDForPathOfId(l.objectID);(D=this._ComponentsMap.GetComponentFromID(p))&&a.GetVisibility().AddVisible(D)}var I=g.listInvisible;if(I)for(X=0;X<I.length;X++){l=I[X],p=this._reformatObjectIDForPathOfId(l.objectID);(D=this._ComponentsMap.GetComponentFromID(p))&&a.GetVisibility().AddInvisible(D)}var S=g.listVisibleCollabs;if(S)for(X=0;X<S.length;X++){var D;l=S[X],p=this._reformatObjectIDForPathOfId(l.objectID);(D=this._ComponentsMap.GetComponentFromID(p))&&a.GetVisibility().AddVisibleCollab(D)}}}else console.log("ERROR : LoadScenarios: scenario component not found : "+t.ID+"\n")}}})}),define("DS/VCXWebExperienceLoader/CATE3DXJSONProcessorExpTrackManager_Spec",["UWA/Class","DS/VCXWebExperienceLoader/VCXExperienceLoaderBase","DS/VCXWebKernelCommands/VCXCmdChangeNeutralProperties","DS/VCXWebProperties/VCXPropertyValueString"],function(e,r,t,a){"use strict";return e.extend({init:function(){},Process:function(){var e=new r;e.InitLoader(this._object._experienceBase);var o=this.QueryInterface("CATI3DXAssetHolder")._getCache(),n=this._object._experienceBase.getManager("VCXScenarioManager");n.SetCurrentFrame(0),n.SetDefaultInterpolator("Actor.Hyperlink",0),n.SetDefaultInterpolator("Collab.Image.Doc.ID",0),e.LoadComponents(o.VCXObjects),e.LoadNeutrals(o.neutrals);for(var i=new t(n),s=0;s<o.ScenarioSequences.length;s++){var l=o.ScenarioSequences[s].objectID,p=this._object._experienceBase.ComponentsMap.GetComponentFromID(l).QueryInterface("VCXIModifiable"),u=o.ScenarioSequences[s].name,f=new a;f.SetValue(u),i.ChangeProperty(p,"Actor.Name",f)}var V=this._object._experienceBase.getManager("VCXCommandManager");for(var C in V.Do(i),e.LoadScenarios(o.listScenarios),n.GetScenarios()){if(n.GetScenarios().hasOwnProperty(C))n.GetScenarios()[C].SetEMSDirty(!1)}e.LoadScenarioSequences(o.ScenarioSequences)}})});