define("DS/DMUCompareVisu/DMUBaseCompareServices",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUControls/EXPNotify","DS/Visualization/CompareModelsServices","DS/DMUControls/panels/DMU3DComparePanel","DS/WebappsUtils/WebappsUtils","i18n!DS/DMUCompareVisu/assets/nls/DMUCompareVisu"],function(e,t,l,n,o,i,a,r){"use strict";return e.extend({init:function(e,s){let h,p,c,m,d,f,g,w,E,u,O,N=s||{},C=this,y=[],v=[],D=!0;function V(e,t){if(!(e&&e.length&&t&&t.length))return!1;for(let l=0;l<e.length;l++)if(t.indexOf(e[l])!==l)return!1;return!0}function S(e,t){if(!E)return;if(O&&E.deleteOverrides(O),O=[],"2D"===p)return;if(e){l.getOverrides(E,{idPaths:[[]],propagateUntilRepRefs:!0}).forEach(function(e){e.setVisibility(!1)})}let n=[];if(N&&N.ctxViewer&&N.ctxViewer.getController&&N.ctxViewer.getController()){let e=N.ctxViewer.getController(),o=function(l,i,a){let r=!1;if(l){let s=l.getReferenceId();if(l.isRepRef()){let l=e.getIdPathesLeadingToReference(s);l&&l.length&&(a&&(l.forEach(e=>{if(r=!1,0===e.ids.indexOf(i[0])){r=!0;for(let t=0;t<i.length;t++)if(-1===e.ids.indexOf(i[t])){r=!1;break}if(t&&t.length)for(let l=0;l<t.length;l++)if(V(t[l],e.ids)){r=!1;break}}r&&n.push(e)}),n.length>0&&(r=!0)),r||l.forEach(e=>{if(e.ids&&e.ids.length){r=!0;for(let t=0;t<i.length;t++)if(-1===e.ids.indexOf(i[t])){r=!1;break}if(t&&t.length)for(let l=0;l<t.length;l++)if(V(t[l],e.ids)){r=!1;break}r&&n.push(e)}}))}else l.getChildren().forEach(function(e){o(e.getReferenceIterator(),i,a)})}},i=function(t,n){if(t){let i=t;if((l.isInstance(i.getLastElement(!0))||l.isRepInstance(i.getLastElement(!0)))&&(i=i.getChildrenPathes()[0]),i){let t=l.getNodeID(i.getLastElement(!0));t&&o(e.createReferenceIterator(t),l.getIdPath(i),n)}}};v.forEach(e=>{i(e,!0)}),y.forEach(e=>{i(e,!1)})}else{window.console.warn("DEPRECATED - Please provide the ENOPADViewer as input of the compare service");let e=function(t,n){if(t){let o=t.clone(),i=o.getChildrenPathes();if(l.isLeaf(o.getLastElement(!0),!0)||0===i.length)n.push(o);else for(let t=0;t<i.length;t++)e(i[t],n)}};v.forEach(function(t){let o=[];e(t,o),n=n.concat(o.map(function(e){return l.getIdPath(e)}))}),y.forEach(function(t){let o=[];e(t,o),n=n.concat(o.map(function(e){return l.getIdPath(e)}))})}n.length&&(O=l.getOverrides(E,{idPaths:n,propagateToParents:!0})).forEach(function(e){e.setVisibility(!0)})}function b(t){let l;if(t.Old){if(v=[],t.Old.pathElements&&t.Old.pathElements.length)for(l=0;l<t.Old.pathElements.length;l++)v.push(t.Old.pathElements[l].clone());else t.Old.pathElement&&v.push(t.Old.pathElement.clone());d=t.Old.color?t.Old.color:"#FF0000",f=t.Old.opacity?t.Old.opacity:1,0===t.Old.opacity&&(f=0)}if(t.New){if(y=[],t.New.pathElements&&t.New.pathElements.length)for(l=0;l<t.New.pathElements.length;l++)y.push(t.New.pathElements[l].clone());else t.New.pathElement&&y.push(t.New.pathElement.clone());m=t.New.color?t.New.color:"#00FF00",g=t.New.opacity?t.New.opacity:1,0===t.New.opacity&&(g=0)}t.Common&&t.Common.color&&(c=t.Common.color),h?(h.stopCompare(),e.getViewer().comparisonActive=void 0):h=new o(e.getViewer()),(v&&v.length||y&&y.length)&&(h.startCompare({first:{pathElements:v,color:d,opacity:f},second:{pathElements:y,color:m,opacity:g},common:{color:c,opacity:1},compareMode:p}),e.getViewer().comparisonActive=!0)}function P(){let t;if(v&&v.length)for(t=0;t<v.length;t++)l.removeOverride(E,{pathElement:v[t]});if(v=[],y&&y.length)for(t=0;t<y.length;t++)l.removeOverride(E,{pathElement:y[t]});y=[],h&&(h.stopCompare(),e.getViewer().comparisonActive=void 0),e.getViewer().render()}function U(e,t){w&&("Old"===e?w.updatePanel({secondLabel:t}):"New"===e&&w.updatePanel({firstLabel:t}))}function M(l){if(l){if(!l.noAutomaticReframe){let n=new t.Sphere,o=[];l.Old&&(l.Old.pathElements&&l.Old.pathElements.length&&(o=o.concat(l.Old.pathElements)),l.Old.pathElement&&o.push(l.Old.pathElement)),l.New&&(l.New.pathElements&&l.New.pathElements.length&&(o=o.concat(l.New.pathElements)),l.New.pathElement&&o.push(l.New.pathElement)),o.forEach(t=>{let l=t.getBoundingSphere(e.getViewer(),"visibleSpace");l&&l.radius&&n.mergeWithSphere(l,n)}),n.radius&&e.getViewer().currentViewpoint.reframe(null,0,n)}e.getViewer().render()}}this.compare=function(t){if(t)return N.removeReviewObjects&&e.removeReviewModel&&e.removeReviewModel(),C.clean(),p=t.compareMode,(t.New&&t.New.pathElement||t.New&&t.New.pathElements&&t.New.pathElements.length)&&(t.Old&&t.Old.pathElement||t.Old&&t.Old.pathElements&&t.Old.pathElements.length)?(function(t){let n;if(t.New.pathElements&&t.New.pathElements.length)for(n=0;n<t.New.pathElements.length;n++)y.push(t.New.pathElements[n].clone());else y.push(t.New.pathElement.clone());if(t.Old.pathElements&&t.Old.pathElements.length)for(n=0;n<t.Old.pathElements.length;n++)v.push(t.Old.pathElements[n].clone());else v.push(t.Old.pathElement.clone());E=l.createSceneGraphOverrideSet(e.getViewer()),c=t.Common.color?t.Common.color:"#EEEEEE",m=t.New.color?t.New.color:"#00FF00",d=t.Old.color?t.Old.color:"#FF0000",w&&w.clean(),D&&(w||(w=new i),w.buildPanel({title:t.TitleNls,icon:a.getWebappsAssetUrl("DMUCompareVisu","icons/22/")+"I_DMUCompare.png",immersiveFrame:e.getImmersiveFrame(),newStyleColor:m,newStyleLabel:t.New.name,oldStyleColor:d,oldStyleLabel:t.Old.name,commonStyleColor:c,commonStyleLabel:t.Common.nls,displayType:t.panel,onClickCB:t.onClickCB})),S(t.hideAllOtherGeometries,t.listOfIDPathsToNotOverload),b(t)}(t),M(t),!0):(u=t.New&&t.New.pathElement||t.New&&t.New.pathElements&&t.New.pathElements.length||t.Old&&t.Old.pathElement||t.Old&&t.Old.pathElements&&t.Old.pathElements.length?new n({body:e.getUIFrame(),type:"info",message:r.compareNotify_onemodel,notificationType:"HelpNotification"}):new n({body:e.getUIFrame(),type:"info",message:r.compareNotify_nomodel,notificationType:"HelpNotification"}),!1)},this.updateCompareModel=function(e){P(),e&&(U("Old",e.Old&&e.Old.name?e.Old.name:""),U("New",e.New&&e.New.name?e.New.name:""),b(e),S(e.hideAllOtherGeometries,e.listOfIDPathsToNotOverload),M(e))},this.displayPanel=function(e){return window.console.warn('"displayPanel" method is deprecated. Use "setLegendVisibleFlag" method instead'),C.setLegendVisibleFlag(e)},this.setLegendVisibleFlag=function(e){D=e,w&&w.displaying(D)},this.getLegendVisibleFlag=function(){return D},this.clean=function(){P(),p=void 0,u&&u.destroy(),w&&w.clean(),l.removeSceneGraphOverrideSet(e.getViewer(),E),y=[],v=[],h=null,c=m=d=null,w=E=u=null}}})});