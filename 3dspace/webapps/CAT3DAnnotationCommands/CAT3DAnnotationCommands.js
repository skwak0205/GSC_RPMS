/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationCommands/CAT3DAnnotationOpenFavoriteCtxCmd",["DS/StateCommandEngine/StateCommand","DS/Visualization/PathElement","DS/StateCommandEngine/PathElementAgent","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(e,t,n,i,o,r,a,l){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),this.setRepeatMode(!1);var s,c,u,d=function(e){if(!e||!e.externalPath||!e.externalPath.length||"RootBag"!==e.externalPath[0].name)return!1;for(var n=e.externalPath.length-1;n>=0;--n){var i=e.externalPath[n];if(l.isPLMNode(i))return!!l.is3DLeaf(i)&&new t(e.externalPath.slice(0,n+1))}},g=function(e){setTimeout(function(){if(s&&s.object3D&&1===s.object3D.length){o.empty();var t=a.giveFavoriteContextManager({context:r.get()});u=t.manageFavoriteContext({path:d(s.object3D[0].pathElement),onComplete:function(){u=null,e()}}).cancel}},0)};this.buildGraph=function(){var e=r.get();e.getViewer().setDefaultPicking(!1),c=!0,u=null,s=new n({agentId:"CATFavoriteContextSelAgt",frameWindow:e.getFrameWindow(),engWithPSOHSO:!0,withPSO:!0,withHSO:!0,valuedFromCSO:!0,saveToCSO:!1,pickingMode:"rep",prePickingMode:"rep",pickingFilter:d,prePickingFilter:d});var t=this.createInitialState("InitState"),i=this.getFinalState();this.addTransition({iInitialState:t,iFinalState:i,iEvent:s,iAction:g}),this.addTransition({iInitialState:t,iFinalState:i,iCondition:function(){var t=l.getRoots(e);if(t&&1===t.length&&t[0]&&l.is3DLeaf(t[0])){var n=e.getRootBagPath();return n.addElement(t[0]),s.object3D.push({pathElement:n}),!0}},iAction:g})},this.execute=function(){c&&(i.empty(),o.empty())},this.endExecute=function(){r.get().getViewer().setDefaultPicking(!0),u&&u()}}})}),define("DS/CAT3DAnnotationCommands/CAT3DAnnotationWidgetDefaultCmd",["DS/ApplicationFrame/Command","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/PADUtils/PADContext","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils"],function(e,t,n,i,o,r,a,l){"use strict";return e.extend({init:function(e){var s=e||{};this._parent(s,{mode:"exclusive",isAsynchronous:!0}),this.setRepeatMode(!1);var c=o.get(),u=this,d=t.giveDataLauncherController({context:c}),g=a.getSelectionManager({context:c});g.setActiveState(!0);var f,A=r.getPreferenceManager({context:c.getFrameWindow()}),b={};A.setUnitsPreferencesDisplayFlag(!0),A.setDisplayPreferencesDisplayFlag(!0),A.set3DSelectionPreferencesDisplayFlag(!0),b.CATWebUXPreferences_GravitationalEffects=A.subscribe("CATWebUXPreferences_GravitationalEffects",function(e){c&&c.getViewer()&&c.getViewer().currentViewpoint&&c.getViewer().currentViewpoint.control&&(c.getViewer().currentViewpoint.getControl().setRotationRolling(!e),c.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!e))}),b.CATWebUXPreferences_ProjectionType=A.subscribe("CATWebUXPreferences_ProjectionType",function(e){c&&c.getViewer()&&c.getViewer().currentViewpoint&&c.getViewer().currentViewpoint.setProjectionType(e)}),b.CATWebUXPreferences_Select3DGeometry=A.subscribe("CATWebUXPreferences_Select3DGeometry",function(e){g&&g.setPicking(e?0:1)}),b.CATWebUXPreferences_SelectParentReferenceOr3DShape=A.subscribe("CATWebUXPreferences_SelectParentReferenceOr3DShape",function(e){g&&g.selectParentReference("select3DShape"!==e)});var C=l.getPreference("CATWebUXPreferences_GravitationalEffects","boolean");"boolean"==typeof C&&(c.getViewer().currentViewpoint.getControl().setRotationRolling(!C),c.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!C));var h=l.getPreference("CATWebUXPreferences_ProjectionType","int");0!==h&&1!==h||c.getViewer().currentViewpoint.setProjectionType(h);var S=l.getPreference("CATWebUXPreferences_Select3DGeometry","boolean");g&&g.setPicking(S?0:1);let v=l.getPreference("CATWebUXPreferences_SelectParentReferenceOr3DShape","string");g&&g.selectParentReference("select3DShape"!==v),require([s.annotControllerLib||"DS/CAT3DAnnotationExpController/CAT3DAnnotExpControllerInstance"],function(e){var t=new e({ctxViewer:c});if(t.setActiveState(!0),n.registerAnnotationController({annotController:t,context:c}),A){var o=i.getPreferenceDefinitions({attributePrefs:void 0!==s.annotControllerLib});f=o[0].id,A.addPreferences(o),A.setPreferredPreferenceContainersOrder([f,"MeasurePreferences"])}});var D={activated:c.getViewer().picking.activated,trapSelection:c.getViewer().picking.trapSelection,trapGPU:c.getViewer().picking.trapGPU},p={activated:c.getViewer().pPicking.activated};c.getViewer().setPicking({activated:!0,trapSelection:!0,trapGPU:!0}),c.getViewer().setPrePicking({activated:!0}),this.beginExecute=function(){d&&d.setActiveState(!0)},this.endExecute=function(){d&&d.setActiveState(!1)},this.pauseExecute=function(){d&&d.setActiveState(!1)},this.resumeExecute=function(){d&&d.setActiveState(!0)};var m=this._destroy;this._destroy=function(){if(m.call(u),n.unreferenceAnnotationController({context:c}),A){A.removePreferences([f]);for(var e=Object.keys(b),t=0;t<e.length;t++)A.unsubscribe(b[e[t]]);b={}}a.unreferenceSelectionManager({context:c}),c.getViewer().setPicking(D),c.getViewer().setPrePicking(p),f=A=null,r.unreferencePreferenceManager({context:c.getFrameWindow()}),u=c=d=null}}})}),define("DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController",["UWA/Class","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationPanels/CAT3DAnnotationFilterPanel","DS/CATWebUXComponents/CATWebUXPanel","DS/ApplicationFrame/CommandsManager","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtilsOptions","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController"],function(e,t,n,i,o,r,a,l,s,c){"use strict";var u=e.extend({init:function(e){var u=e||{};this._parent(u);var d,g,f,A,b,C,h=l.getOption("CAT3DANN_FILTER_PANEL_VER1")?1:2,S=!1,v=!1,D=this,p=u.ctxViewer,m=200,P=!1,T=[],F=[],y=[],w={},V={},x={},k={},L=0,E=new t,W=!0,U=!1,M=0,R=0,_=150,O=0,I=!0,X=!1,B=!1,j=!1,N=function(e,t){return E.publish({event:e,data:t,context:this})},G=function(e){!X&&I&&S&&!B&&!j&&d.getActiveState()&&(e&&(U=e),M&&(clearTimeout(M),M=0),M=setTimeout(function(){D._internalRefresh(),_=150,M=0},_))},H=c.subscribe("onPreferenceModified",function(e){var t;if(-1!==e.preference.indexOf("3DAnnotSemAttr_")){var n,i=e.preference.substring(e.preference.indexOf("_")+1,e.preference.length),o=D.getAttributeTypesFiltered();for(t=0;t<F.length;t++)if(F[t].name===i){F[t].filteredByPref=!e.value,n=!0;break}n||F.push({name:i,filteredByPref:!e.value,filtered:!1});var r=D.getAttributeTypesFiltered();G();var a=r.length!==o.length;if(!a)for(t=0;t<r.length;t++)if(-1===o.indexOf(r[t])){a=!0;break}a&&N("onAttributesVisibilityModified",{attributesFiltered:r})}}),z=function(){for(var e=c.getPreference("3DAnnotAttributesOrderedList"),t=e.length-1;t>=0;t--)c.getPreference("3DAnnotSemAttr_"+e[t])&&e.splice(t,1);return e},q=function(e){if(T&&T.length&&T[e[0]]){var t=T[e[0]];if(1===e.length)return t.path;if(t.children&&t.children[e[1]]){var n=t.children[e[1]];if(2===e.length)return n.path;if(n.path){var i=n.path.getChildrenPathes();if(i&&i.length&&i[e[2]]){var o=i[e[2]];if(3===e.length)return o;var r=i[e[2]].getChildrenPathes();if(r&&r.length&&r[e[3]])return r[e[3]]}}}}},J=function(e){S&&(R+=!0===e?1:-1,O&&(clearTimeout(O),O=0),A&&(A.setEnableFlag(R>=0),R<0&&(O=setTimeout(function(){S&&A&&A.setEnableFlag(!0),R=0},2e4))))},K=function(e){M&&(clearTimeout(M),M=0),A&&(m=A.getWidth(),A.clean(),A=null),f&&f.cleanPanel(e)},Q=function(){if(sessionStorage)if("true"===sessionStorage.getItem("CAT3DAnnotFilterExpFlag_"+widget.id))sessionStorage.setItem("CAT3DAnnotFilterExpFlag_"+widget.id,"false"),A.setWidth(200);else{var e=parseFloat(sessionStorage.getItem("CAT3DAnnotFilterWidth_"+widget.id));e&&200!==e&&(sessionStorage.setItem("CAT3DAnnotFilterExpFlag_"+widget.id,"true"),A.setWidth(e))}},Y=function(e){var t=q(e[0].idPath);y.push(r.getNodeID(t.getLastElement(!0))),g.loadFTAModel({path:t,loadChildren:!0}),A&&A.isSmallWidth()&&f&&"AnnotSetAll"===f.getCurrentAnnotationSetSection()&&A.collapsePanel()},Z=function(e){X=!0;for(var t=0;t<e.length;t++){var n=q(e[t].idPath);n&&n.getLastElement(!0).setVisibility(e[t].visuFlag)}A&&A.isSmallWidth()&&f&&"AnnotSetAll"===f.getCurrentAnnotationSetSection()&&A.collapsePanel(),p.getViewer().render(),X=!1},$=function(e){var t,n=!1,i=D.getAttributeTypesFiltered();for(t=0;t<e.length;t++){for(var o=null,r=0;r<F.length;r++)if(F[r].name===e[t].name){o=r;break}null!==o?F[o].filtered=!e[t].visuFlag:F.push({name:e[t].name,filtered:!e[t].visuFlag,filteredByPref:!1})}var a=D.getAttributeTypesFiltered();if(!(n=a.length!==i.length))for(t=0;t<a.length;t++)if(-1===i.indexOf(a[t])){n=!0;break}n&&N("onAttributesVisibilityModified",{attributesFiltered:a})};function ee(){if(f){var e=!1;p.getRootBagPath().getChildrenPathes().some(function(t){return p.getController().isLargeDataStructure(r.getNodeID(t.getLastElement(!0)))&&(e=!0),e}),f.setOptionsAvailableFlag({AnnotSetAll:!e})}}for(var te=function(e){if(f){if(e)for(var t=0;t<T.length;t++)for(var n=0;n<T[t].children.length;n++){var i=T[t].children[n].path.getLastElement(!0).toJSON();Object.assign(T[t].children[n],i)}f.updatePanel({model:T,attrTypesFilteredByPref:z(),attrTypesOrderedList:c.getPreference("3DAnnotAttributesOrderedList")})}},ne=z(),ie=0;ie<ne.length;ie++)F.push({name:ne[ie],filteredByPref:!0,filtered:!1});this._internalRefresh=function(){S&&D&&"function"==typeof b&&(U?(T.splice(0,T.length),A||function(){if(K(),f||(f=new n({style:{version:h,semanticUI:"3DAnnotationInsight"===d.getAnnotationControllerType()}}),(k={}).onFilterPanelResized=f.subscribe("onFilterPanelResized",Q),k.onAnnotationSetsLoadingRequired=f.subscribe("onAnnotationSetsLoadingRequired",Y),k.onAnnotationsVisibilityModified=f.subscribe("onAnnotationsVisibilityModified",Z),k.onAttributesVisibilityModified=f.subscribe("onAttributesVisibilityModified",$)),A)f.buildPanel(T);else{var e;"true"===sessionStorage.getItem("CAT3DAnnotFilterExpFlag_"+widget.id)&&(e=parseFloat(sessionStorage.getItem("CAT3DAnnotFilterWidth_"+widget.id))),e||(e=void 0!==m?m:200),m=e;var t={id:"CAT3DAnnotFilterPanel",className:"CAT3DAnnotFilterSidePanel",showTitleFlag:!1,icon:"fonticon fonticon-annotationFilter CAT3DAnnotFilterIcon",frameWindow:p.getFrameWindow(),immersiveFrame:p.getFrameWindow().getImmersiveFrame(),closeButtonFlag:!1,viewerFrame:p.getFrameWindow().getViewerFrame(),content:f.buildPanel({model:T,attrTypesFilteredByPref:z(),attrTypesOrderedList:c.getPreference("3DAnnotAttributesOrderedList")}),minHeight:330,minWidth:200,width:e,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.RightDockArea,onPanelResizedCB:function(e){e.currentDockArea!==WUXDockAreaEnum.RightDockArea&&e.currentDockArea!==WUXDockAreaEnum.LeftDockArea||(m=e.width,e.widthModifiedInteractively&&(sessionStorage.setItem("CAT3DAnnotFilterExpFlag_"+widget.id,"true"),sessionStorage.setItem("CAT3DAnnotFilterWidth_"+widget.id,e.width)))}};A=new i(t)}ee(),A&&T&&A.setPanelVisibilityFlag(W&&0!==T.length),A.setEnableFlag(R>=0)}(),b(function(e){if(S){for(var t,n=(T=e).length-1;n>=0;n--)t=r.getNodeID(T[n].path.getLastElement(!0)),T[n].hasBeenEntirelyLoaded=-1!==y.indexOf(t),T[n].hasBeenEntirelyLoaded&&0===T[n].children.length&&T.splice(n,1);te(!1),A.setPanelVisibilityFlag(W&&0!==T.length),T.length&&A.setEnableFlag(R>=0)}})):(te(!0),A&&T&&A.setPanelVisibilityFlag(W&&0!==T.length)))},this.setActiveState=function(e){if(S=e,d&&g){var t;if(b||(b=d.onAdditionalInfosRequired({controller:"AnnotFilter"}).getJSONModel),R=0,S){if(!P){var n=function(){I=!0,G(!0)};B=!(d.getActiveState()&&g.getActiveState());var i=function(){d.getActiveState()&&g.getActiveState()?(B=!1,G(!0)):(K(),B=!0)};w.onLoadingComplete=p.subscribe({event:"onLoadingComplete"},n),w.onLoadingFailure=p.subscribe({event:"onLoadingFailure"},n),w.onLoadingCanceled=p.subscribe({event:"onLoadingCanceled"},n),w.onRootAdded=p.subscribe({event:"onRootAdded"},ee),w.onRootRemoved=p.subscribe({event:"onRootRemoved"},function(){I=!0,_=0,G(!0)}),V.onAnnotControllerActiveStateChanged=d.subscribe("onAnnotControllerActiveStateChanged",i),V.onAnnotationsLinkedDataSolved=d.subscribe("onAnnotationsLinkedDataSolved",function(e){!0===e.succeeded&&G()}),x.onAnnotModelLoaderActiveStateChanged=g.subscribe("onAnnotModelLoaderActiveStateChanged",i),x.onAnnotationVisibilityModifiedToken=g.subscribe("onAnnotationVisibilityModified",function(e){G("tpsAnnotationSet"===e.node.getAnnotationClassType())}),x.onAnnotationSetLoadingFailedToken=g.subscribe("onAnnotationSetLoadingFailed",function(){I=!0,J(!0),G(!0)}),x.onAnnotationSetLoadedToken=g.subscribe("onAnnotationSetLoaded",function(){I=!0,J(!0),G(!0)}),x.onAnnotationSetPartiallyLoaded=g.subscribe("onAnnotationSetPartiallyLoaded",function(){I=!0,J(!0),G(!0)}),x.onAnnotationSetRemovedToken=g.subscribe("onAnnotationSetRemoved",function(){I=!0,G(!0)}),x.onAnnotationSetBeginLoadToken=g.subscribe("onAnnotationSetBeginLoad",function(){I=!1,J(!1)}),x.onAnnotationSetLoadingCanceledToken=g.subscribe("onAnnotationSetLoadingCanceled",function(){I=!0,J(!0),G(!0)}),x.onNoAnnotationSetLoadedToken=g.subscribe("onNoAnnotationSetLoaded",function(e){e&&e.loadingAlreadyStarted&&(I=!0,J(!0)),G(!0)}),V.onViewOrCaptureDisplayedToken=d.subscribe("onViewOrCaptureDisplayed",function(){I=!0,G()}),x.onVisuModificationToken=g.subscribe("onAnnotationParentVisibilityModified",function(){G(!0)}),L=p.getViewer().onSwapVisibleSpace?p.getViewer().onSwapVisibleSpace(function(){j=0===p.getViewer().getVisibleSpace(),1===p.getViewer().getVisibleSpace()?G(!0):K()}):null,j=0===p.getViewer().getVisibleSpace(),ne=z();var o=!1;for(t=0;t<ne.length;t++){for(var r=!1,l=0;l<F.length;l++)if(F[l].name===ne[t]){r=!0,F[l].filteredByPref=!0;break}r||F.push({name:ne[t],filteredByPref:!0,filtered:!1})}for(var c=0;c<F.length;c++)F[c].filtered&&(F[c].filtered=!1,o=!0);o&&N("onAttributesVisibilityModified",{attributesFiltered:D.getAttributeTypesFiltered()}),P=!0}var u=I;I=!0,G(!0),I=u}else{var h;if(f){for(h=Object.keys(k),t=0;t<h.length;t++)f.unsubscribe(k[h[t]]);f.cleanPanel(),f=null}if(k={},A&&(A.clean(),A=null),P){for(h=Object.keys(w),t=0;t<h.length;t++)p.unsubscribe(w[h[t]]);for(h=Object.keys(V),t=0;t<h.length;t++)d.unsubscribe(V[h[t]]);for(h=Object.keys(x),t=0;t<h.length;t++)g.unsubscribe(x[h[t]]);L&&p.getViewer()&&p.getViewer().unsubscribe(L),L=0,w={},V={},x={},K(!0),P=!1}M&&(clearTimeout(M),M=0),O&&(clearTimeout(O),O=0),T.splice(0,T.length),I=!0}N("onAnnotationFilterActiveStateModified",{state:S})}else C||(C=setInterval(function(){g=s.giveAnnotationModelLoader({context:p}),(d=a.giveAnnotationController({context:p}))&&g&&(clearInterval(C),C=null,D.setActiveState(S))},100))},this.getActiveState=function(){return S},this.setControllerEnableFlag=function(e){var t=o.getCommandCheckHeader("CAT3DAnnotationFilterHdr",p.getCommandContext());t&&(e?t.enable():t.disable()),v?(D.setActiveState(!0),v=!1):e||S&&(D.setActiveState(!1),v=!0,b=d=g=null)},this.setPanelVisibilityFlag=function(e){W=e,A&&T&&A.setPanelVisibilityFlag(W&&0!==T.length)},this.getPanelVisibilityFlag=function(){return W},this.clearController=function(){D.setActiveState(!1),C&&clearInterval(C),H&&c.unsubscribe(H),H=0,d=g=T=y=null,C=null,b=null,E=p=D=F=null},this.getAttributeTypesFiltered=function(){for(var e=[],t=0;t<F.length;t++)(F[t].filteredByPref||F[t].filtered)&&e.push(F[t].name);return e},this.subscribe=function(e,t){if(e&&t)return E.subscribe({event:e},t)},this.unsubscribe=function(e){E&&e&&E.unsubscribe(e)}}}),d=[];return e.singleton({init:function(){},give3DAnnotFilterController:function(e){if(e&&e.context)for(var t=0;t<d.length;t++)if(d[t].context===e.context)return d[t].filterController},get3DAnnotFilterController:function(e){var t;if(e&&e.context&&!(t=this.give3DAnnotFilterController(e))){var n=new u({ctxViewer:e.context});t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){return n?n.getActiveState():null},clearController:function(){n&&(n.clearController(),n=null)},getAttributeTypesFiltered:function(){return n?n.getAttributeTypesFiltered():null},setControllerEnableFlag:function(e){if(n)return n.setControllerEnableFlag(e)},setPanelVisibilityFlag:function(e){n&&n.setPanelVisibilityFlag(e)},getPanelVisibilityFlag:function(){return n?n.getPanelVisibilityFlag():null},subscribe:function(e,t){return n?n.subscribe(e,t):null},unsubscribe:function(e){n&&n.unsubscribe(e)}}),d.push({context:e.context,filterController:t})}return t},unreference3DAnnotFilterController:function(e){if(e&&e.context)for(var t=0;t<d.length;t++)if(d[t].context===e.context){d[t].filterController.clearController(),d.splice(t,1);break}}})}),define("DS/CAT3DAnnotationCommands/CAT3DAnnotationCommands",[],function(){}),define("DS/CAT3DAnnotationCommands/CAT3DAnnotationFilterCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController"],function(e,t,n){"use strict";return e.extend({init:function(e){this._parent(e,{});var i=this,o=t.get(),r=n.get3DAnnotFilterController({context:o}),a=this.onStateChange(function(){r.setActiveState(i.getState()),localStorage.setItem("CAT3DAnnotationFilterCmd",i.getState()?"true":"false")}),l=this._destroy;this._destroy=function(){o&&n.unreference3DAnnotFilterController({context:o}),i._modelEvents.unsubscribe(a),l.call(i)},this.setState("false"!==localStorage.getItem("CAT3DAnnotationFilterCmd"),!0)},_destroy:function(){this._parent()}})});