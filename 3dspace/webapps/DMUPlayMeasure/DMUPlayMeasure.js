define("DS/DMUPlayMeasure/DMUMeasureImport",["UWA/Class","DS/DMUMeasurable/DMUMeasurable","DS/DMUBaseExperience/EXPUtils"],function(e,t,i){"use strict";return e.extend({init:function(e){this.importData=function(n,r,a){if(n&&r&&e){r.fillObjectAttributes(e,n,a);for(var o=n.measurables.length,s=0;s<o;s++){var l=new t({},!0).importData(n.measurables[s],i.strToType);e.setMeasurable(s+1,l)}r.registerForPostImport(e)}},this.afterImport=function(){e&&e.fireEvent("onDMUObjectInitialized",{dmuObject:e})}}})}),define("DS/DMUPlayMeasure/DMUMeasureMainValueDisplayUtils",["i18n!DS/DMUPlayMeasure/assets/nls/DMUPlayMeasure"],function(e){"use strict";var t=e.yes,i=e.no,n={MeasureTypes:{Coordinates:{name:"Coordinates",defaultMainValueDisplay:i,defaultUnitDisplay:t,isDisplayedInPref:1},Line_Length:{name:"Line_Length",defaultMainValueDisplay:i,defaultUnitDisplay:t,isDisplayedInPref:1},Curve_Length:{name:"Curve_Length",defaultMainValueDisplay:t,defaultUnitDisplay:t,isDisplayedInPref:1},Arc_Length:{name:"Arc_Length",defaultMainValueDisplay:t,defaultUnitDisplay:t,isDisplayedInPref:1},Distance:{name:"Distance",defaultMainValueDisplay:i,defaultUnitDisplay:t,isDisplayedInPref:1},Min_Distance:{name:"Min_Distance",defaultMainValueDisplay:i,defaultUnitDisplay:t,isDisplayedInPref:1},Max_Distance:{name:"Max_Distance",defaultMainValueDisplay:t,defaultUnitDisplay:t,isDisplayedInPref:1},Angle:{name:"Angle",defaultMainValueDisplay:i,defaultUnitDisplay:t,isDisplayedInPref:1},Half_Angle:{name:"Half_Angle",defaultMainValueDisplay:i,defaultUnitDisplay:t,isDisplayedInPref:1},Radius:{name:"Radius",defaultMainValueDisplay:i,defaultUnitDisplay:t,isDisplayedInPref:1},Min_Radius:{name:"Min_Radius",defaultMainValueDisplay:i,defaultUnitDisplay:t,isDisplayedInPref:1},Max_Radius:{name:"Max_Radius",defaultMainValueDisplay:i,defaultUnitDisplay:t,isDisplayedInPref:1},Diameter:{name:"Diameter",defaultMainValueDisplay:i,defaultUnitDisplay:t,isDisplayedInPref:1},Min_Diameter:{name:"Min_Diameter",defaultMainValueDisplay:i,defaultUnitDisplay:t,isDisplayedInPref:1},Max_Diameter:{name:"Max_Diameter",defaultMainValueDisplay:i,defaultUnitDisplay:t,isDisplayedInPref:1},Area:{name:"Area",defaultMainValueDisplay:t,defaultUnitDisplay:t,isDisplayedInPref:1},Volume:{name:"Volume",defaultMainValueDisplay:t,defaultUnitDisplay:t,isDisplayedInPref:1},Thickness:{name:"Thickness",defaultMainValueDisplay:i,defaultUnitDisplay:t,isDisplayedInPref:1}},isPrefEnabled:function(e){return!0===e||e===t},getPrefVal:function(e){var n=t;return this.isPrefEnabled(e)||(n=i),n}};return Object.freeze(n)}),define("DS/DMUPlayMeasure/DMUMeasureNode3D",["UWA/Core","DS/DMUMeasurable/DMUMeasureEnums","DS/DMUBaseUI/DMUManipulableNode3D","DS/DMUBaseUI/DMUToolsLeader","DS/DMUMeasurable/DMUToolsMaths","DS/DMUMeasurable/DMUMathsBoundingGeometry","DS/DMUMeasurable/DMUMathsFiniteGeometry","DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUToolsAvatars","DS/DMUBaseExperience/EXPUnitManagement","DS/DMUBaseExperience/EXPUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Manipulators/PlaneTranslationManipulator","DS/Manipulators/LineTranslationManipulator","DS/Manipulators/RotationManipulator","DS/SceneGraphNodes/ArrowNode","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/DMUMarkerVisu/DMUMarkerVisuMeasureShapeNode","DS/DMUBaseExperience/EXPToolsVisualization","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPToolsMaterial","DS/Mesh/Mesh","DS/DMUMeasurable/DMUMeshMeasure","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUBaseUIServices/DMUObjectsServices","i18n!DS/DMUPlayMeasure/assets/nls/DMUPlayMeasure"],function(e,t,i,n,r,a,o,s,l,u,c,d,p,g,b,y,h,v,P,m,A,D,M,f,w,S,T,R,C,L,E,_,x){"use strict";return i.extend({init:function(i){this._parent(i);var N,V,k,I,F,O,U,B,z,G,J,H,q,X,W,Y,j,Z,Q,K,$,ee,te,ie,ne,re,ae,oe,se,le,ue,ce,de,pe,ge,be,ye,he,ve,Pe,me=this.getViewer(),Ae=i.owner.getAttribute("cLineStyleColor"),De=i.owner.getAttribute("cFillStyleColor"),Me=new p.Color(16753920),fe=10*window.devicePixelRatio,we=!1,Se=!1,Te=i.owner.getAttribute("iExtensionLinesManipulable"),Re=function(){Se=!(!i.owner.getAttribute("bShortDisplay")||i.owner.getAttribute("bDisplayUnit"))};Re();var Ce={};Ce.regularSolidLine=R.retrieveMaterialFromGAS({color:Ae,lineWidth:window.devicePixelRatio,pattern:C.LinePatternEnum.SOLID}),Ce.regularDashedLine=R.retrieveMaterialFromGAS({color:Ae,lineWidth:window.devicePixelRatio,pattern:C.LinePatternEnum.DASHED}),Ce.avatarSolidLine=R.retrieveMaterialFromGAS({color:De,lineWidth:window.devicePixelRatio,pattern:C.LinePatternEnum.SOLID}),Ce.avatarDashedLine=R.retrieveMaterialFromGAS({color:Ae,lineWidth:window.devicePixelRatio,pattern:C.LinePatternEnum.DASHED}),Ce.avatarDottedLine=R.retrieveMaterialFromGAS({color:Ae,lineWidth:window.devicePixelRatio,pattern:C.LinePatternEnum.SMALLDOTTED}),Ce.dotDashedLine=R.retrieveMaterialFromGAS({color:Ae,lineWidth:window.devicePixelRatio+1,pattern:C.LinePatternEnum.DOTDASHED}),Ce.dotLine=R.retrieveMaterialFromGAS({color:Ae,lineWidth:window.devicePixelRatio+1,pattern:C.LinePatternEnum.DOTTED}),Ce.crossPoint=R.retrieveMaterialFromGAS({symbol:1,size:fe,withoutDPR:!0,color:new p.Color(0)});var Le,Ee,_e,xe,Ne,Ve,ke,Ie,Fe,Oe,Ue,Be,ze,Ge=!1,Je=T.getReviewContext({viewer:me}),He=!1,qe=!1,Xe=null,We=null,Ye=null,je=null,Ze=!0,Qe=this,Ke={},$e=.001,et=1,tt=String.fromCharCode(216);function it(e,t,i,n,r,a){return void 0===e&&void 0===t&&void 0===i&&void 0===n&&void 0===r&&void 0===a?0:Math.abs(i*t-e*n+(r*n-i*a)+(e*a-r*t))/2}function nt(){var e,t=w.get()[0];if(!t)return!1;if(t.event){var n=Qe.getLabelDimensions(),r={offsetWidth:M.convertModelToPixels({sizeInMM:n.offsetWidth}),offsetHeight:M.convertModelToPixels({sizeInMM:n.offsetHeight})},a=M.getViewerPositionFromPoint(me,n.position),o=new p.Vector2(Math.round(a.left-r.offsetWidth/2),Math.round(a.top-r.offsetHeight/2)),s=M.get2DSnappedPosition(t.event.getCurrentPosition(me.canvas)),l=o.clone();l.y=l.y+n.height/(Ee+1)*Le;var u=o.clone();u.y=u.y+n.height/(Ee+1)*Ee;var c=o.clone();c.x=c.x+n.width,c.y=c.y+n.height/(Ee+1)*Le;var d=o.clone();d.x=d.x+n.width,d.y=d.y+n.height/(Ee+1)*Ee;var g=i.owner.getAttribute("fBoxRotationAngle");g=-g;var b=i.owner.getAttribute("vLeaderBreakPoint3D");if(g){var y=M.getWindowPositionFromPoint(me,b,i.frmWindow);y=new p.Vector2(y.left,y.top);var h=function(e){var t=e.clone();t.x=e.x-y.x,t.y=e.y-y.y;var i,n=(i=t,new p.Vector2(i.x*Math.cos(g)-i.y*Math.sin(g),i.x*Math.sin(g)+i.y*Math.cos(g)));return t.x=n.x+y.x,t.y=n.y+y.y,t};l=h(l),u=h(u),c=h(c),d=h(d)}var v={x1:u.x,y1:u.y,x2:l.x,y2:l.y,x3:c.x,y3:c.y,x4:d.x,y4:d.y,x:s.x,y:s.y};if(!Ge||i.owner.getAttribute("bShortDisplay")||it((e=v).x1,e.y1,e.x,e.y,e.x2,e.y2)+it(e.x2,e.y2,e.x,e.y,e.x3,e.y3)+it(e.x3,e.y3,e.x,e.y,e.x4,e.y4)+it(e.x4,e.y4,e.x,e.y,e.x1,e.y1)-(it(e.x1,e.y1,e.x3,e.y3,e.x2,e.y2)+it(e.x1,e.y1,e.x3,e.y3,e.x4,e.y4))>$e)return!1}return!0}function rt(e,t){t.setPickParent(!0),t.setVisibilityInTree(!1),e.addChild(t)}function at(){Ze=i.owner.isReadOnly()||!i.owner.isEditable()||function(){var e=d.allowManipulation({object:"Section",viewer:me});if("boolean"==typeof e)return!e;var t=d.checkIfCommandIsRunning(me);if(t){var i=d.getCurrentCommand(me);"measureCmdHdr"!==i&&"measure3CmdHdr"!==i&&"measure2CmdHdr"!==i&&"measure2DCmdHdr"!==i||(t=!1)}return t}()}function ot(e){if(!Ze){var t={pathElement:S.buildPathElement(Qe)};if(e&&e.event&&e.event.from&&e.event.from.length>0){var n=e.event.from[e.event.from.length-1].getCurrentPosition();i.owner.refreshAssistantTool&&i.owner.refreshAssistantTool({mousePosition:n},!0)}e&&e.event.from[0].event.ctrlKey?f.remove(t):f.empty(),f.add(t)}}function st(){var e={fontStyle:{height:Qe.getPixelFontSize("fFontSize"),familyStyle:i.owner.getAttribute("sFontStyle"),familyName:i.owner.getAttribute("sFontName"),color:i.owner.getAttribute("cFontColor"),fontSize:i.owner.getAttribute("fFontSize")},fontStyleComment:{height:Qe.getPixelFontSize("fCommentFontSize"),familyStyle:i.owner.getAttribute("sCommentFontStyle"),familyName:i.owner.getAttribute("sCommentFontName"),color:i.owner.getAttribute("cFontColor")},fillStyle:{color:i.owner.getAttribute("cFillStyleColor"),opacity:i.owner.getAttribute("fOpacity")},lineStyle:{thickness:(_.getLineThickness(i.owner.getAttribute("fLineStyleThicknessIndex"))||i.owner.getAttribute("fLineStyleThickness"))*window.devicePixelRatio,pattern:i.owner.getAttribute("sLineStylePattern"),color:i.owner.getAttribute("cLineStyleColor")}},t=_.getLineThickness(i.owner.getAttribute("fLeaderStyleThicknessIndex"))||i.owner.getAttribute("fLeaderStyleThickness"),n=i.owner.getAttribute("cLeaderStyleColor"),r=i.owner.getAttribute("sLeaderStylePattern");return(void 0!==t||n||r)&&(e.leaderStyle={thickness:void 0!==t?t*window.devicePixelRatio:void 0,pattern:r,color:n}),e}function lt(e){return" "+x.sx+": "+c.convert("Length",e.x,Je,!0,Se)+" "+x.sy+": "+c.convert("Length",e.y,Je,!0,Se)+" "+x.sz+": "+c.convert("Length",e.z,Je,!0,Se)}function ut(e,t,i){var n=r.isZero(e)?0:e,a=c.convert("Length",n,Je,!0,Se);return t?a:i?x.curveLength+" "+a:x.length+" "+a}function ct(e,t,i){var n,a=r.isZero(e)?0:180*e/Math.PI,o=c.convert("Angle",a,Je,!0,Se);return t||(n=x.angle,i&&(n=x.halfAngle)),t?o:n+" "+o}function dt(e,t){var i=r.isZero(e)?0:e,n=c.convert("Area",i,Je,!0,Se);return t?n:x.area+" "+n}function pt(e,t){var i=r.isZero(e)?0:e,n=c.convert("Volume",i,Je,!0,Se);return t?n:x.volume+" "+n}function gt(e,t,i){var n,a=r.isZero(e)?0:e,o=c.convert("Length",a,Je,!0,Se);return n=void 0===i?x.radius:i?x.maxRadius:x.minRadius,t?x.symbolRadius+" "+o:n+" "+o}function bt(e,t,i){var n,a=r.isZero(e)?0:e,o=c.convert("Length",a,Je,!0,Se);return n=void 0===i?x.diameter:i?x.maxDiameter:x.minDiameter,t?tt+" "+o:n+" "+o}function yt(e,t,i){var n=r.isZero(e)?0:e,a=c.convert("Length",n,Je,!0,Se);return i?a:t+" "+a}function ht(e,i){var n,r=!1;switch(null==i&&(r=!0),e){case t.ResultType.POINT:case t.ResultType.CENTER:n=r?x.point:x.point+" "+x.inLabel+" "+i;break;case t.ResultType.LINE:n=r?x.line:x.line+" "+x.inLabel+" "+i;break;case t.ResultType.AXIS:n=x.infiniteline+" "+x.inLabel+" "+i;break;case t.ResultType.CIRCLE:n=r?x.circle:x.circle+" "+x.inLabel+" "+i;break;case t.ResultType.CURVE:n=r?x.curve:x.curve+" "+x.inLabel+" "+i;break;case t.ResultType.PLANE:n=x.plane+" "+x.inLabel+" "+i;break;case t.ResultType.CYLINDER:n=x.cylinder+" "+x.inLabel+" "+i;break;case t.ResultType.CONE:n=x.cone+" "+x.inLabel+" "+i;break;case t.ResultType.SPHERE:n=x.sphere+" "+x.inLabel+" "+i;break;case t.ResultType.SURFACE:n=x.surface+" "+x.inLabel+" "+i;break;case t.ResultType.PRODUCT:n=x.product+" "+i}return n}function vt(e,t,n,r,a,o,s,u){var d=[];u.exact="MeasureThickness"!==Xe&&o.getMode()===l.Mode.EXACT&&s.getMode()===l.Mode.EXACT,u.mode=u.exact?x.exactMode:x.approximateMode;var g=x.minDistance;if("MeasureBetween"===e)switch(t){case"Distance":g=x.distance;break;case"MaximumDistance":g=x.maxDistance;break;case"LocalMinimumDistance":g=x.LocalMinimumDistance;break;case"LocalMaximumDistance":g=x.LocalMaximumDistance}var b,y=ut(a,!0);if(r)d[0]=we?y:"MeasureBetween"===e?g+" "+y:x.thickness+" "+y;else if("MeasureBetween"===e){var h=i.owner.getAttribute("vFirstExtensionPoint3D").clone(),v=i.owner.getAttribute("vSecondExtensionPoint3D").clone(),P=new p.Vector3;P.subVectors(v,h);var m=P.clone().normalize();d[0]=g+" "+y,d[1]=x.firstpoint+" "+lt(h),d[2]=x.secondpoint+" "+lt(v),d[3]=x.components+" "+(b=P," "+x.dx+": "+c.convert("Length",b.x,Je,!0,Se)+" "+x.dy+": "+c.convert("Length",b.y,Je,!0,Se)+" "+x.dz+": "+c.convert("Length",b.z,Je,!0,Se)),d[4]=x.direction+" "+lt(m),_e=ht(i.owner.getAttribute("sResultingType1"),i.owner.getAttribute("oProduct1Name")),xe=ht(i.owner.getAttribute("sResultingType2"),i.owner.getAttribute("oProduct2Name")),"2D"===n?(_e===x.circle&&o._arcAngle&&Math.abs(2*Math.PI-o._arcAngle)>$e&&(_e=x.arc),xe===x.circle&&s._arcAngle&&Math.abs(2*Math.PI-s._arcAngle)>$e&&(xe=x.arc),d[5]=_e+" - "+xe,d[6]=u.mode):(Le=5,Ee=7,d[5]=_e.length>50?_e.substring(0,50)+"...":_e,d[6]=xe.length>50?xe.substring(0,50)+"...":xe,d[7]=u.mode)}else{var A=new p.Vector3;A.subVectors(s.getSelPoint(),o.getSelPoint());var D=A.clone().normalize();_e=x.thickness+" "+x.ofLabel+" "+i.owner.getAttribute("oProduct1Name"),xe=void 0,d[0]=x.thickness+" "+y,d[1]=x.startpoint+" "+lt(o.getSelPoint()),d[2]=x.endpoint+" "+lt(s.getSelPoint()),d[3]=x.direction+" "+lt(D),d[4]=_e.length>50?_e.substring(0,50)+"...":_e,d[5]=u.mode,Le=4,Ee=5}return d}function Pt(e,t,i,n,r){e?(we||n.push(x.coordinates),n[n.length]=x.sx+": "+c.convert("Length",t.x,Je,!0,Se),n[n.length]=x.sy+": "+c.convert("Length",t.y,Je,!0,Se),n[n.length]=x.sz+": "+c.convert("Length",t.z,Je,!0,Se)):(_e=i?x.point+" "+x.inLabel+" "+i:x.point,xe=void 0,n[0]=x.coordinates+" "+lt(t),n[1]=_e.length>50?_e.substring(0,50)+"...":_e,n[2]=r.mode,Le=1,Ee=2)}function mt(e,t,n,a,o){var s=i.owner.getAttribute("fArea");if(e)0!==s&&(a[0]=dt(s,we));else{_e=x.plane+" "+x.inLabel+" "+n,xe=void 0;var l=t.getPlane();a[0]=dt(s),a[1]=x.cog+" "+lt(i.owner.getAttribute("vCog")),a[2]=x.equation+" "+function(e,t){var i="",n=!1;r.isZero(t.x)||(n=!0,i+=c.convert("Length",t.x,Je,!0,!0),i+=x.sx),r.isZero(t.y)||(t.y>0&&!0===n&&(i+="+"),n=!0,i+=c.convert("Length",t.y,Je,!0,!0),i+=x.sy),r.isZero(t.z)||(t.z>0&&!0===n&&(i+="+"),n=!0,i+=c.convert("Length",t.z,Je,!0,!0),i+=x.sz);var a=-(e.x*t.x+e.y*t.y+e.z*t.z);return a>0&&!0===n&&(i+="+"),i+=c.convert("Length",a,Je,!0,!0),i+="=0"}(l.origin,l.normal),a[3]=_e.length>50?_e.substring(0,50)+"...":_e,a[4]=o.mode,Le=3,Ee=4}}function At(e,t,i,n,r,a){if("Volume"===e&&void 0!==t&&t>0||"Area"!==e&&void 0!==t&&t>0)a[0]=pt(t,we);else if("Area"===e&&void 0!==i&&i>0||void 0!==i&&i>0)a[0]=dt(i,we);else if(void 0===t&&void 0===i&&void 0!==length&&length>0)a[0]=ut(length,we);else if(void 0!==t||void 0!==i||void 0!==length||void 0===n&&void 0===r)void 0!==t&&(a[0]=pt(t,we));else{var o=void 0!==n;a[0]=x.sx+": "+c.convert("Length",o?n.x:r.x,Je,!0,Se),a[1]=x.sy+": "+c.convert("Length",o?n.y:r.y,Je,!0,Se),a[2]=x.sz+": "+c.convert("Length",o?n.z:r.z,Je,!0,Se)}}function Dt(e,t,n,r){var a=[],o=i.owner.getAttribute("sSurfaceDisplayType");if(e)switch(o){case"MinimumRadius":var s=i.owner.getAttribute("fRadius");a[0]=gt(s,we,!1);break;case"MinimumDiameter":var l=2*i.owner.getAttribute("fRadius");a[0]=bt(l,we,!1);break;case"MaximumRadius":var u=i.owner.getAttribute("fMaxRadius");a[0]=gt(u,we,!0);break;case"MaximumDiameter":var c=2*i.owner.getAttribute("fMaxRadius");a[0]=bt(c,we,!0);break;case"Length":var d=i.owner.getAttribute("fHeight");a[0]=ut(d,we);break;case"Area":var g=i.owner.getAttribute("fArea");a[0]=dt(g,we);break;case"Angle":0!==t&&(a[0]=ct(2*t,we,!0));break;default:0!==t&&(a[0]=ct(t,we,!0))}else{_e=x.cone+" "+x.inLabel+" "+i.owner.getAttribute("oProduct1Name"),xe=void 0;var b=n.getPoints(),y=new p.Vector3;y.subVectors(b.endPoint,b.beginPoint).normalize(),a[0]=ct(t,!1,!0),a[1]=x.startpoint+" "+lt(b.beginPoint),a[2]=x.endpoint+" "+lt(b.endPoint),a[3]=x.direction+" "+lt(y),a[4]=dt(i.owner.getAttribute("fArea")),a[5]=x.cog+" "+lt(i.owner.getAttribute("vCog")),a[6]=_e.length>50?_e.substring(0,50)+"...":_e,a[7]=r.mode,Le=6,Ee=7}return a}function Mt(e,n,r,a){var o=[];a.exact=n.getMode()===l.Mode.EXACT,a.mode=a.exact?x.exactMode:x.approximateMode;var s=i.owner.getAttribute("oProduct1Name");switch(i.owner.getAttribute("sResultingType1")){case t.ResultType.POINT:Pt(e,i.owner.getAttribute("vPosition"),s,o,a);break;case t.ResultType.CENTER:Pt(e,n.getCenter(),s,o,a);break;case t.ResultType.LINE:!function(e,t,n,r,a){if(e)0!==i.owner.getAttribute("fLength")&&(r[0]=ut(i.owner.getAttribute("fLength"),we));else{_e=we&&void 0===n?x.line:x.line+" "+x.inLabel+" "+n,xe=void 0;var o=new p.Vector3;o.subVectors(t.endPoint,t.beginPoint).normalize(),r[0]=ut(i.owner.getAttribute("fLength")),r[1]=x.startpoint+" "+lt(t.beginPoint),r[2]=x.endpoint+" "+lt(t.endPoint),r[3]=x.direction+" "+lt(o),r[4]=_e.length>50?_e.substring(0,50)+"...":_e,r[5]=a.mode,Le=4,Ee=5}}(e,r,s,o,a);break;case t.ResultType.AXIS:!function(e,t,i,n,r){var a=new p.Vector3;a.subVectors(t.endPoint,t.beginPoint).normalize(),e?n[0]=we?lt(a):x.direction+" "+lt(a):(_e=x.infiniteline+" "+x.inLabel+" "+i,xe=void 0,n[0]=x.direction+" "+lt(a),n[1]=_e.length>50?_e.substring(0,50)+"...":_e,n[2]=r.mode,Le=1,Ee=2)}(e,r,s,o,a);break;case t.ResultType.CIRCLE:!function(e,t,n,r,a,o){var s=i.owner.getAttribute("fRadius"),l=t.getArcAngle();i.owner.getAttribute("bArcLengthDisplay")?e?a[0]=yt(l*s,x.arcLength,we):(_e=x.arc,xe=void 0,a[0]=yt(l*s,x.arcLength),a[1]=x.startpoint+" "+lt(n.beginPoint),a[2]=x.endpoint+" "+lt(n.endPoint),a[3]=_e,a[4]=o.mode,Le=3,Ee=4):e?i.owner.getAttribute("bRadiusDisplay")?a[0]=gt(s,we):a[0]=bt(2*s,we):(i.owner.getAttribute("bRadiusDisplay")?a[0]=gt(s):a[0]=bt(2*s),a[1]=x.center+" "+lt(i.owner.getAttribute("vCenter")),_e=we&&void 0===r?l&&Math.abs(2*Math.PI-l)>$e?x.arc:x.circle:x.circle+" "+x.inLabel+" "+r,xe=void 0,a[2]=yt(l*s,x.arcLength),a[3]=yt(2*Math.PI*s,x.circlePerimeter),a[4]=_e.length>50?_e.substring(0,50)+"...":_e,a[5]=o.mode,Le=4,Ee=5)}(e,n,r,s,o,a);break;case t.ResultType.CURVE:!function(e,t,n,r,a){e?0!==i.owner.getAttribute("fLength")&&(r[0]=ut(i.owner.getAttribute("fLength"),we,!0)):(_e=void 0===n?x.curve:x.curve+" "+x.inLabel+" "+n,xe=void 0,r[0]=ut(i.owner.getAttribute("fLength"),!1,!0),null!==t?(r[1]=x.startpoint+" "+lt(t.beginPoint),r[2]=x.endpoint+" "+lt(t.endPoint),r[3]=_e.length>50?_e.substring(0,50)+"...":_e,r[4]=a.mode,Le=3,Ee=4):(r[1]=_e.length>50?_e.substring(0,50)+"...":_e,r[2]=a.mode))}(e,r,s,o,a);break;case t.ResultType.PLANE:mt(e,n,s,o,a);break;case t.ResultType.CYLINDER:!function(e,t,n,r,a){var o,s=i.owner.getAttribute("fRadius"),l=i.owner.getAttribute("sSurfaceDisplayType");if(e)if("Length"===l){var u=i.owner.getAttribute("fHeight");r[0]=ut(u,we)}else"Area"===l?(o=i.owner.getAttribute("fArea"),r[0]=dt(o,we)):0!==s&&(i.owner.getAttribute("bRadiusDisplay")?r[0]=gt(s,we):r[0]=bt(2*s,we));else{_e=x.cylinder+" "+x.inLabel+" "+n,xe=void 0,o=i.owner.getAttribute("fArea");var c=new p.Vector3;c.subVectors(t.endPoint,t.beginPoint).normalize(),i.owner.getAttribute("bRadiusDisplay")?r[0]=gt(s):r[0]=bt(2*s),r[1]=x.startpoint+" "+lt(t.beginPoint),r[2]=x.endpoint+" "+lt(t.endPoint),r[3]=x.direction+" "+lt(c),r[4]=dt(o),r[5]=x.cog+" "+lt(i.owner.getAttribute("vCog")),r[6]=_e.length>50?_e.substring(0,50)+"...":_e,r[7]=a.mode,Le=6,Ee=7}}(e,r,s,o,a);break;case t.ResultType.SPHERE:!function(e,t,n,r){n[0]=x.sphere;var a=i.owner.getAttribute("fRadius"),o=i.owner.getAttribute("sSurfaceDisplayType"),s=i.owner.getAttribute("fArea");e?"Area"===o?n[0]=dt(s,we):i.owner.getAttribute("bRadiusDisplay")?n[0]=gt(a,we):n[0]=bt(2*a,we):(_e=x.sphere+" "+x.inLabel+" "+t,xe=void 0,i.owner.getAttribute("bRadiusDisplay")?n[0]=gt(a):n[0]=bt(2*a),n[1]=x.center+" "+lt(i.owner.getAttribute("vCenter")),n[2]=dt(s),n[3]=_e.length>50?_e.substring(0,50)+"...":_e,n[4]=r.mode,Le=3,Ee=4)}(e,s,o,a);break;case t.ResultType.SURFACE:!function(e,t,n,r){e?0!==i.owner.getAttribute("fArea")&&(n[0]=dt(i.owner.getAttribute("fArea"),we)):(_e=x.surface+" "+x.inLabel+" "+t,xe=void 0,n[0]=dt(i.owner.getAttribute("fArea")),n[1]=x.cog+" "+lt(i.owner.getAttribute("vCog")),n[2]=_e.length>50?_e.substring(0,50)+"...":_e,n[3]=r.mode,Le=2,Ee=3)}(e,s,o,a);break;case t.ResultType.PRODUCT:!function(e,t,n,r,a,o){var s=i.owner.getAttribute("fVolume"),l=i.owner.getAttribute("fArea"),u=i.owner.getAttribute("fLength"),c=i.owner.getAttribute("vCog"),d=t.getOriginPoint(),p=i.owner.getAttribute("sProductDisplayType");if(e)At(p,s,l,c,d,a);else{_e=r,xe=void 0;var g=0,b=x.product;void 0===s?g++:a[0]=pt(s),void 0===l?g++:a[1-g]=dt(l),void 0!==s||void 0!==l?a[2-g]=x.cog+" "+lt(c):void 0!==u&&u>0?(a[2-g]=ut(u),void 0!==n.beginPoint&&void 0!==n.endPoint&&(b=x.curve+" "+x.inLabel,a[2- --g]=x.startpoint+" "+lt(n.beginPoint),a[2- --g]=x.endpoint+" "+lt(n.endPoint))):void 0!==c?(a[2-g]=lt(c),b=x.point+" "+x.inLabel):void 0!==d?(a[2-g]=lt(d),b=x.origin+" "+x.ofLabel):g++,_e=b+" "+_e,a[3-g]=_e.length>50?_e.substring(0,50)+"...":_e,a[4-g]=o.mode,Le=3-g,Ee=4-g}}(e,n,r,s,o,a);break;case t.ResultType.CONE:o=Dt(e,0,n,a);break;default:o[0]="Unknow"}return o}function ft(e,n,r,a,o){var s=[],u={},c=i.owner.getMeasurable(1),d=i.owner.getMeasurable(2),p=i.owner.getMeasurable(3);return u.exact=c.getMode()===l.Mode.EXACT,u.mode=u.exact?x.exactMode:x.approximateMode,we=!1,i.owner.getAttribute("bDisplayMeasureType")||(we=!0),"MeasureBetween"===n||"Measure3PointsAngle"===n||"MeasureThickness"===n?s=function(e,t,n,r,a,o,s,u,c){var d=[];c.exact=a.getMode()===l.Mode.EXACT&&o.getMode()===l.Mode.EXACT,c.mode=c.exact?x.exactMode:x.approximateMode;var p=ct(n,!0);if(e)d[0]="2D"===u?p:we?p:x.angle+" "+p;else{if(d[0]=x.angle+" "+p,r&&"MeasureBetween"===t||"MeasureThickness"===t)_e=ht(i.owner.getAttribute("sResultingType1"),i.owner.getAttribute("oProduct1Name")),xe=ht(i.owner.getAttribute("sResultingType2"),i.owner.getAttribute("oProduct2Name")),"2D"===u?d[1]=_e+" - "+xe:_e&&(Le=1,Ee=2,d[1]=_e.length>50?_e.substring(0,50)+"...":_e,xe&&(d[2]=xe.length>50?xe.substring(0,50)+"...":xe,Ee=3));else if("Measure3PointsAngle"===t){void 0!==a&&void 0!==o&&void 0!==s&&(c.exact=a.getMode()===l.Mode.EXACT&&o.getMode()===l.Mode.EXACT&&s.getMode()===l.Mode.EXACT);var g=i.owner.getAttribute("fProjectedAngleXY"),b=i.owner.getAttribute("fProjectedAngleYZ"),y=i.owner.getAttribute("fProjectedAngleZX");if(void 0!==g&&void 0!==b&&void 0!==y){var h=ct(g,!0),v=ct(b,!0),P=ct(y,!0);d.push(x.projectedAngle+" "+x.xy+": "+h+" "+x.yz+": "+v+" "+x.zx+": "+P),void 0!==a&&void 0!==o&&void 0!==s&&void 0!==a.getSelPoint()&&void 0!==o.getSelPoint()&&void 0!==s.getSelPoint()&&(d.push(x.firstpoint+" "+lt(a.getSelPoint())),d.push(x.secondpoint+" "+lt(o.getSelPoint())),d.push(x.thirdpoint+" "+lt(s.getSelPoint())))}}d.push(c.mode)}return d}(e,n,r,a,c,d,p,o,u):"MeasureItem"===n&&i.owner.getAttribute("sResultingType1")===t.ResultType.CONE?s=Dt(e,r,c,u):i.owner.isReadOnly()&&"MeasureItem"===n&&i.owner.getAttribute("sResultingType1")===t.ResultType.CIRCLE&&(e?s[0]=ct(r):(s[0]=ct(r),s[1]=x.circle+" "+x.inLabel+" "+i.owner.getAttribute("oProduct1Name"),s[2]=u.mode)),s}function wt(e,t,i,n,a,o){if(t&&i){var s=i.clone(),l=o.leaderStyle&&void 0!==o.leaderStyle.thickness?o.leaderStyle.thickness:o.lineStyle.thickness,u={arrowWidth:l,headLength:Math.max(2*l+4,10),viewpoint:me.currentViewpoint,initialPoint:s.clone(),finalPoint:t.clone(),color:o.leaderStyle&&o.leaderStyle.color?o.leaderStyle.color:o.lineStyle.color,arrowScale:2,head:1},c=M.getDistanceFromPixel(me,t,5),d=n.clone().normalize().multiplyScalar(c);if(s=t.clone().add(d),u.initialPoint=s.clone(),!r.areEqual(u.initialPoint,u.finalPoint,"Vector3")){var p=e.getChildByName("arrow1Node");p?(p.updateInitialPosition(u.initialPoint),p.updateFinalPosition(u.finalPoint),p.updateColor(u.color),p.setArrowWidth(u.arrowWidth),p.setHeadSize(u.headLength),p.setHeadType(u.head)):((p=new P(u)).name="arrow1Node",e.add(p))}var g=a.clone().normalize().multiplyScalar(c);if(s=i.clone().sub(g),u.initialPoint=s,u.finalPoint=i,!r.areEqual(u.initialPoint,u.finalPoint,"Vector3")){var b=e.getChildByName("arrow2Node");b?(b.updateInitialPosition(u.initialPoint),b.updateFinalPosition(u.finalPoint),b.updateColor(u.color),b.setArrowWidth(u.arrowWidth),b.setHeadSize(u.headLength),b.setHeadType(u.head)):((b=new P(u)).name="arrow2Node",e.add(b))}}}function St(e,t,i,n,a,o,s,l,u,c,d){if(t&&i){var p=4,g=!1,b="MeasureThickness"===Xe,y=t.clone().add(i).multiplyScalar(.5),h=o?y.clone():i.clone(),v=s.leaderStyle&&void 0!==s.leaderStyle.thickness?s.leaderStyle.thickness:s.lineStyle.thickness;void 0===l||!0!==l&&!b||(p=Math.max(2*v+4,10),g=!0);var m={arrowWidth:v,headLength:p,viewpoint:me.currentViewpoint,initialPoint:h.clone(),finalPoint:t.clone(),color:s.leaderStyle&&s.leaderStyle.color?s.leaderStyle.color:s.lineStyle.color,head:0};if(!r.areEqual(m.initialPoint,m.finalPoint,"Vector3")){var A=e.getChildByName("lineNode");A?(A.updateInitialPosition(m.initialPoint),A.updateFinalPosition(m.finalPoint),A.updateColor(m.color),A.setArrowWidth(m.arrowWidth),A.setHeadSize(m.headLength),A.setHeadType(m.head)):((A=new P(m)).name="lineNode",e.add(A))}var D,f=t.clone().sub(i),w=f.length(),S=w<p,T=S?1:p/w;if(b)T=-T;else if(!0!==g){if(void 0!==n){var R=n.clone().sub(t),C=i.clone().sub(t),L=n.clone().sub(i),E=t.clone().sub(i);D=!a||R.clone().dot(C.clone())>0&&L.clone().dot(E.clone())>0}!1===u||D&&!S||(T=-T)}if(void 0===c||!0===c){if(m.head=1,f.multiplyScalar(T),b){var _=25*v;_=M.getDistanceFromPixel(me,t.clone(),_),f.normalize().multiplyScalar(_)}if(m.initialPoint=t.clone().sub(f),!r.areEqual(m.initialPoint,m.finalPoint,"Vector3")){var x=e.getChildByName("dimArrow1Node");x?(x.updateInitialPosition(m.initialPoint),x.updateFinalPosition(m.finalPoint),x.updateColor(m.color),x.setArrowWidth(m.arrowWidth),x.setHeadSize(m.headLength),x.setHeadType(m.head)):((x=new P(m)).name="dimArrow1Node",e.add(x))}if(!d&&(m.initialPoint=h.clone().add(f),m.finalPoint=h,!r.areEqual(m.initialPoint,m.finalPoint,"Vector3"))){var N=e.getChildByName("dimArrow2Node");N?(N.updateInitialPosition(m.initialPoint),N.updateFinalPosition(m.finalPoint),N.updateColor(m.color),N.setArrowWidth(m.arrowWidth),N.setHeadSize(m.headLength),N.setHeadType(m.head)):((N=new P(m)).name="dimArrow2Node",e.add(N))}}}}function Tt(e,t,i,n,a,o){var s=new b;if(e&&t&&i&&n){var l=t.clone(),u=n.clone();a&&(l.add(e).multiplyScalar(.5),u.add(i).multiplyScalar(.5));var c={arrowWidth:o.leaderStyle&&void 0!==o.leaderStyle.thickness?o.leaderStyle.thickness:o.lineStyle.thickness,viewpoint:me.currentViewpoint,initialPoint:i.clone(),finalPoint:e.clone(),color:o.leaderStyle&&o.leaderStyle.color?o.leaderStyle.color:o.lineStyle.color,head:0};r.areEqual(c.initialPoint,c.finalPoint,"Vector3")||rt(s,new P(c)),c.initialPoint=u,c.finalPoint=l,r.areEqual(c.initialPoint,c.finalPoint,"Vector3")||rt(s,new P(c))}return s}function Rt(e,t,i){var n=new m({position:e.clone(),name:"anchor1",type:"Spherical"});n.setMatrix((new p.Matrix4).setPosition(e.clone()));var r=g.createCircleNode({radius:4,segments:8,fill:!1,color:t});r.setShadow(!1);var a=new A({name:"myFixedSizeNode",ratio:1});rt(a,r),rt(n,a);var o=g.createCircleNode({radius:4,segments:8,fill:!0,color:i});o.setShadow(!1);var s=new A({name:"myFixedSizeNode",ratio:1});return rt(s,o),rt(n,s),n}function Ct(e,t,i){var n,r=t.getPoints(),a=o.computePointSegmentDistance(i.toArray(),r.beginPoint.toArray(),r.endPoint.toArray());0===a.returnCode&&a.relationship!==l.Relationship.COINCIDENT&&(n=new p.Vector3(a.aPosition[0],a.aPosition[1],a.aPosition[2])),n&&(s.areEqual(n.toArray(),i.toArray())?n=void 0:rt(e,u.createLineNode(n,i,Ce.regularDashedLine)))}function Lt(e,n,r,a,o){if(null!==n&&e.remove(n),r){var s,l,c,d,p,y,h,v,P;switch(a){case t.ResultType.LINE:break;case t.ResultType.AXIS:l=(s=r.getPoints()).beginPoint.clone().sub(s.endPoint),c=30,d=M.getDistanceFromPixel(me,s.beginPoint,c),l.normalize().multiplyScalar(d),v=s.beginPoint.clone().add(l),P=s.endPoint.clone().sub(l),n=u.createLineNode(v,P,o);break;case t.ResultType.CIRCLE:n=new b;var m=r.getRadius();"2D"===i.owner.getAttribute("sMeasureOnGeometryType")&&r.get2DScale&&(m=r.get2DScale()*m),h=r.getCenter();var A=!1;if(!0===i.owner.getAttribute("bArcLengthDisplay"))A=!1;else if(0===i.owner.getAttribute("iRadiusResultDisplayType"))rt(n,u.createCircleNode(m,h,r.getAxis(),o));else{!1===i.owner.getAttribute("bRadiusDisplay")?rt(n,u.createCircleNode(m,h,r.getAxis(),o)):A=!0,Ce.crossPoint.force=!0,rt(n,g.createPointsNode({positions:h.clone().toArray(),material:Ce.crossPoint}))}if(A){s=r.getPoints();var D=r.getArcMidPoint();p=D.clone().sub(s.beginPoint),y=D.clone().sub(s.endPoint);var f=s.beginPoint,w=s.endPoint;y.length()<p.length()&&(f=s.endPoint,w=s.beginPoint);var S=h.clone().sub(f),T=h.clone().sub(w),R=h.clone().sub(D);R.normalize().negate().multiplyScalar(m);var C=u.createArcNode(m,h,S,R,Ce.regularSolidLine),L=u.createArcNode(m,h,R,T,Ce.regularSolidLine);rt(n,C),rt(n,L)}break;case t.ResultType.CYLINDER:n=new b,s=r.getPoints();var E=i.owner.getAttribute("vFirstExtensionPoint3D");void 0===Te&&(E=r.getSelPoint().clone()),p=E.clone().sub(s.beginPoint),y=E.clone().sub(s.endPoint),h=s.beginPoint,y.length()<p.length()&&(h=s.endPoint);var _=s.endPoint.clone().sub(s.beginPoint);rt(n,u.createCircleNode(r.getRadius(),h,_,o)),l=s.beginPoint.clone().sub(s.endPoint),c=30,d=M.getDistanceFromPixel(me,h,c),l.normalize().multiplyScalar(d),v=s.beginPoint.clone().add(l),P=s.endPoint.clone().sub(l),rt(n,u.createLineNode(v,P,Ce.dotDashedLine));break;case t.ResultType.CONE:n=new b;var x,N=(s=r.getPoints()).endPoint,V=r.getApex(),k=r.getSemiAngle(),I=r.getAxis(),F=V.clone(),O=i.owner.getAttribute("sSurfaceDisplayType"),U=r.vSlat.clone(),B=V.clone().sub(N).length()*Math.tan(k),z=u.createCircleNode(B,N,I,o);if(rt(n,z),v=r.vExtensionPoint1,P=r.vExtensionPoint2,v&&P||(l=s.beginPoint.clone().sub(s.endPoint),c=30,d=M.getDistanceFromPixel(me,s.beginPoint,c),l.normalize().multiplyScalar(d),r.vExtensionPoint1=s.beginPoint.clone().add(l),r.vExtensionPoint2=s.endPoint.clone().sub(l),v=r.vExtensionPoint1.clone(),P=r.vExtensionPoint2.clone()),rt(n,u.createLineNode(v,P,Ce.dotDashedLine)),"Angle"===O)rt(n,u.createLineNode(i.owner.getAttribute("vSecondExtensionPoint3D"),F,Ce.regularSolidLine));else if("MinimumRadius"===O||"MinimumDiameter"===O){var G=V.clone().sub(s.beginPoint),J=V.clone().sub(s.endPoint),H=s.beginPoint.clone();G.length()>J.length()&&(H=s.endPoint.clone()),B=V.clone().sub(H).length()*Math.tan(k),rt(n,z=u.createCircleNode(B,H,I,o)),x=r.getMaxRadius()/Math.sin(k),U=U.normalize().multiplyScalar(x),F=V.clone().add(U)}else"MaximumRadius"!==O&&"MaximumDiameter"!==O||(x=r.getMinRadius()/Math.sin(k),U=U.normalize().multiplyScalar(x),F=V.clone().add(U));rt(n,u.createLineNode(i.owner.getAttribute("vFirstExtensionPoint3D"),F,Ce.regularSolidLine));break;case t.ResultType.SPHERE:n=new b,void 0===r.normal&&i.owner._buildConstructionPointsForConeCylSphere(),rt(n,u.createCircleNode(r.getRadius(),r.getCenter(),r.normal,o))}n&&rt(e,n)}}function Et(e,i,n,r,a){var c;if(Lt(e,i,n,r,r===t.ResultType.AXIS||r===t.ResultType.CIRCLE?Ce.avatarDashedLine:Ce.avatarSolidLine),r===t.ResultType.AXIS||r===t.ResultType.LINE){var d=n.getPoints(),g=o.computePointSegmentDistance(a.toArray(),d.beginPoint.toArray(),d.endPoint.toArray());0===g.returnCode&&g.relationship!==l.Relationship.COINCIDENT&&(c=new p.Vector3(g.aPosition[0],g.aPosition[1],g.aPosition[2]))}else c=n.getSelPoint();c&&(s.areEqual(c.toArray(),a.toArray())?c=void 0:rt(e,u.createLineNode(c,a,Ce.regularDashedLine)))}function _t(){var e=!1;if("MeasureBetween"===Xe&&"Angle"!==i.owner.getAttribute("sDistanceType")||"MeasureThickness"===Xe){var n=i.owner.getAttribute("fDistance");e=void 0!==n&&!r.isZero(n)}else if("MeasureItem"===Xe){var a=i.owner.getAttribute("sResultingType1");e="Length"===i.owner.getAttribute("sSurfaceDisplayType")&&(a===t.ResultType.CONE||a===t.ResultType.CYLINDER)||(a===t.ResultType.LINE||a===t.ResultType.CIRCLE)}else"Measure3PointsCircle"===Xe&&(e=!0);return e}function xt(){if(_t()&&(Ue.manipulator&&Ue.manipulator.activate(Ue.token),Be.manipulator&&Be.manipulator.activate(Be.token)),ke){var e=Qe.getRepManipulator();e&&e.activate()}Ie.manipulator&&Ie.manipulator.activate(Ie.token)}function Nt(){if(_t()&&(Ue.manipulator&&Ue.manipulator.deactivate(Ue.token),Be.manipulator&&Be.manipulator.deactivate(Be.token)),ke){var e=Qe.getRepManipulator();e&&e.deactivate()}Ie.manipulator&&Ie.manipulator.deactivate(Ie.token)}function Vt(){_t()&&(Ue.manipulator&&(Ue.manipulator.axis=i.owner.getAttribute("vExtensionDirection3D").clone()),ke.manipulator&&(ke.manipulator.axis=i.owner.getAttribute("vSecondPoint3D").clone().sub(i.owner.getAttribute("vFirstPoint3D"))),Ie.manipulator&&qe&&(Ie.manipulator.axis=i.owner.getAttribute("vAngleVector1").clone().cross(i.owner.getAttribute("vAngleVector2"))))}function kt(e){if(!i.owner.isReadOnly()&&i.owner.isEditable()){var n,r,a=_t();(e||void 0!==Ye&&a!==Ye)&&(Ue.manipulator&&(Ue.manipulator.unlink(Ue.token),Ue.manipulator=null,Ue.token=null),Be.manipulator&&(Be.manipulator.unlink(Be.token),Be.manipulator=null,Be.token=null),Ie.manipulator&&(Ie.manipulator.unlink(Ie.token),Ie.manipulator=null,Ie.token=null),_t()&&(Ue.manipulator=new h({axis:i.owner.getAttribute("vExtensionDirection3D").clone()}),Ue.manipulator.setExclusive(!0),Ue.token=Ue.manipulator.linkToNode(Ue),Ue.manipulator.subscribe("BeginManipulate",function(){at(),Ze||(n=i.owner.getAttribute("vFirstPoint3D").clone(),r=i.owner.getAttribute("vSecondPoint3D").clone())}),Ue.manipulator.subscribe("Manipulate",function(e){if(!Ze){i.owner.setAttribute("vFirstPoint3D",n.clone().add(e.translationVector)),i.owner.setAttribute("vSecondPoint3D",r.clone().add(e.translationVector));var t=i.owner.getAttribute("vLeaderPointingPoint3D").clone().sub(i.owner.getAttribute("vLeaderBreakPoint3D"));i.owner.setAttribute("vLeaderPointingPoint3D",i.owner.getAttribute("vFirstPoint3D").clone().add(i.owner.getAttribute("vSecondPoint3D")).multiplyScalar(.5)),i.owner.setAttribute("vLeaderBreakPoint3D",i.owner.getAttribute("vLeaderPointingPoint3D").clone().sub(t)),Vt(),i.owner.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:i.owner})}}),Ue.manipulator.subscribe("EndManipulate",ot),"2D"!==i.owner.getAttribute("sMeasureOnGeometryType")&&0!==Te&&function(){var e,t,n,r=i.owner.getAttribute("vSecondExtensionPoint3D").clone().sub(i.owner.getAttribute("vFirstExtensionPoint3D"));Be.manipulator=new v({axis:r}),Be.manipulator.setExclusive(!0),Be.manipulator.setCenter(i.owner.getAttribute("vFirstExtensionPoint3D").clone()),Be.token=Be.manipulator.linkToNode(Be),Be.manipulator.subscribe("BeginManipulate",function(){at(),Ze||(e=i.owner.getAttribute("vFirstPoint3D").clone(),t=i.owner.getAttribute("vSecondPoint3D").clone(),n=new p.Matrix4)}),Be.manipulator.subscribe("Manipulate",function(r){if(!Ze){var a=(new p.Matrix4).copy(n),o=(new p.Matrix4).makeRotationAxis(r.axis,r.angle),s=(new p.Matrix4).setPosition(r.center),l=(new p.Matrix4).getInverse(s).multiply(a),u=(new p.Matrix4).copy(o).multiply(l),c=(new p.Matrix4).copy(s).multiply(u);i.owner.setAttribute("vFirstPoint3D",e.clone().applyMatrix4(c)),i.owner.setAttribute("vSecondPoint3D",t.clone().applyMatrix4(c)),i.owner.setAttribute("vExtensionDirection3D",i.owner.getAttribute("vFirstPoint3D").clone().sub(i.owner.getAttribute("vFirstExtensionPoint3D")));var d=i.owner.getAttribute("vLeaderPointingPoint3D").clone().sub(i.owner.getAttribute("vLeaderBreakPoint3D"));i.owner.setAttribute("vLeaderPointingPoint3D",i.owner.getAttribute("vFirstPoint3D").clone().add(i.owner.getAttribute("vSecondPoint3D")).multiplyScalar(.5)),i.owner.setAttribute("vLeaderBreakPoint3D",i.owner.getAttribute("vLeaderPointingPoint3D").clone().sub(d)),Vt(),i.owner.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:i.owner})}}),Be.manipulator.subscribe("EndManipulate",ot)}()),function(){var e,n,r=qe?i.owner.getAttribute("vAngleVector1").clone().cross(i.owner.getAttribute("vAngleVector2")):new p.Vector3;Ie.manipulator=new y({axis:r}),Ie.manipulator.setExclusive(!0),Ie.token=Ie.manipulator.linkToNode(Ie.getBackNode());var a=Ie.manipulator;a.subscribe("BeginManipulate",function(){at(),Ze||(n=i.frmWindow.getViewerFrame().style.cursor,i.frmWindow.getViewerFrame().setStyle("cursor","move"),e=i.owner.getAttribute("vAngleBreakPoint").clone())}),a.subscribe("Manipulate",function(n){if(!Ze){var r=e.clone().add(n.translationVector),a=r.clone().sub(i.owner.getAttribute("vAngleArcCenter")),o=i.owner.getAttribute("vAngleVector1"),s=i.owner.getAttribute("vAngleVector2"),l=o.clone().cross(s),u=0;0>l.clone().cross(o).dot(a)&&(u+=2),0<l.clone().cross(s).dot(a)&&(u+=1);var c="MeasureItem"===Xe&&i.owner.getAttribute("sResultingType1")===t.ResultType.CONE;if(!c||c&&0===u){i.owner.setAttribute("fQuadrant",u),i.owner.setAttribute("vAngleBreakPoint",r),i.owner.setAttribute("vAnglePointingPoint",r);var d=o.clone();1!==u&&3!==u||d.negate();var p=s.clone();2!==u&&3!==u||p.negate(),c||i.owner.setAttribute("fAngle",d.angleTo(p)),Vt()}i.owner.refreshAssistantTool&&i.owner.refreshAssistantTool({mousePosition:null},!1),i.owner.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:i.owner})}}),a.subscribe("EndManipulate",function(e){Ze||i.frmWindow.getViewerFrame().setStyle("cursor",n),ot(e)})}(),Ye=a)}}function It(e,t){var n,r=!1,o=!0;switch(t){case"bool":r=void 0===(n=i.owner.getAttribute("b"+e))||void 0!==Ke[e]&&n===Ke[e];break;case"int":r=void 0===(n=i.owner.getAttribute("i"+e))||void 0!==Ke[e]&&n===Ke[e];break;case"float":r=void 0===(n=i.owner.getAttribute("f"+e))||void 0!==Ke[e]&&n===Ke[e];break;case"string":void 0===(n=i.owner.getAttribute("s"+e))&&Ke[e]&&(n=Ke[e]),r=void 0===n||void 0!==Ke[e]&&n===Ke[e];break;case"Color":r=void 0===(n=i.owner.getAttribute("c"+e))||void 0!==Ke[e]&&n.equals(Ke[e]);break;case"Vector3":null!=(n=i.owner.getAttribute("v"+e))&&(n=n.clone()),r=null==n||void 0!==Ke[e]&&n.equals(Ke[e]);break;case"AABB":r=void 0===(n=i.owner.getAttribute(e))||void 0!==Ke[e]&&a.areEqualAABB(n,Ke[e]);break;default:r=!1,o=!1}return!r&o&&(Ke[e]=n),r}function Ft(e){var t={value:0,scale:1};switch(e){case"None":t.value=0;break;case"Cross":t.value=1;break;case"Plus":t.value=2;break;case"Concentric":t.value=3;break;case"Coincident":t.value=4;break;case"FullCircle":t.value=5;break;case"FullSquare":t.value=6;break;case"Star":t.value=7;break;case"Dot":t.value=8,t.scale=.6;break;case"SmallDot":t.value=9,t.scale=.4}return t}function Ot(){if(ze&&i.owner)if(He||!qe){ze.setVisibility(!0);var e=st(),r=1;let d=i.owner.getMeasurable(1);var a=i.owner.getAttribute("vLeaderPointingPoint3D"),o=i.owner.getAttribute("vLeaderBreakPoint3D"),s=!_t();if("MeasureBetween"===Xe||"MeasureThickness"===Xe)r=0;else if("Measure3PointsCircle"===Xe)r=0,i.owner.getAttribute("iRadiusResultDisplayType")===t.RadiusResultDisplayType.CENTER&&(a=i.owner.getAttribute("vFirstExtensionPoint3D").clone());else if("MeasureItem"===Xe){var l=function(e,n,r){var a={vLeaderPointingPoint:n,headType:r};if(void 0!==a.headType&&void 0!==a.vLeaderPointingPoint){var o=i.owner.getAttribute("sSurfaceDisplayType"),s=!0;switch(i.owner.getAttribute("sResultingType1")){case t.ResultType.CYLINDER:case t.ResultType.SPHERE:if(void 0===Te){var l=i.owner._buildConstructionPointsForConeCylSphere();a.vLeaderPointingPoint=l.oPos1}"Area"===o?a.headType=1:(a.headType=0,s=!1);break;case t.ResultType.LINE:a.headType=0;break;case t.ResultType.CIRCLE:a.headType=0,i.owner.getAttribute("iRadiusResultDisplayType")===t.RadiusResultDisplayType.CENTER&&void 0!==e.getSelPoint()&&(a.vLeaderPointingPoint=e.getSelPoint());break;case t.ResultType.PLANE:case t.ResultType.SURFACE:a.headType=2;break;case t.ResultType.POINT:case t.ResultType.CENTER:a.headType=4;break;case t.ResultType.PRODUCT:a.headType=3;break;case t.ResultType.CONE:s=!1,"Length"===o||"MinimumRadius"===o||"MinimumDiameter"===o||"MaximumRadius"===o||"MaximumDiameter"===o?a.headType=0:"Area"===o&&(a.headType=1,s=!0)}if(s){var u=i.owner.getAttribute("sLeaderEndType");if(void 0!==u){switch(u){case"No end":u=0;break;case"Arrow":u=1;break;case"Bubble":u=2;break;case"Square":u=3;break;case"Cross":u=4}a.headType=u}}return a}}(d,a,r);void 0!==l&&void 0!==l.headType&&void 0!==l.vLeaderPointingPoint&&(r=l.headType,a=l.vLeaderPointingPoint)}if(i.owner.getAttribute("sResultingType1")===t.ResultType.CONE&&ze.removeChildren(),i.owner.getAttribute("sTextGraphicRepresentation")){var u=ke.getDimensions();u.position=o.clone();var c=function(e,t){if(e&&e.position&&e.offsetWidth&&e.offsetHeight){e.position.clone();var i=e,n=M.convertModelToPixels({sizeInMM:i.offsetWidth}),r=M.convertModelToPixels({sizeInMM:i.offsetHeight}),a=M.getViewerPositionFromPoint(me,i.position),o=new p.Vector2(Math.round(a.left-n/2),Math.round(a.top-r/2)),s=new p.Vector2(Math.round(a.left+n/2),Math.round(a.top-r/2)),l=new p.Vector2(Math.round(a.left+n/2),Math.round(a.top+r/2)),u=new p.Vector2(Math.round(a.left-n/2),Math.round(a.top+r/2)),c=M.get3DPositionFromScreenCoordinates({coords:o,viewer:me}),d=M.get3DPositionFromScreenCoordinates({coords:s,viewer:me}),g=M.get3DPositionFromScreenCoordinates({coords:l,viewer:me}),b=M.get3DPositionFromScreenCoordinates({coords:u,viewer:me}),y=t,h=[];h.push(y.clone().toArray()),h.push(e.position.clone().toArray());var v=[];v.push(c.clone().toArray()),v.push(d.clone().toArray());var P=[];P.push(d.clone().toArray()),P.push(g.clone().toArray());var m=[];m.push(g.clone().toArray()),m.push(b.clone().toArray());var A=[];A.push(b.clone().toArray()),A.push(c.clone().toArray());var D=L._computeTwoCurvesSquaredDistance(1,v,1,h),f=Math.sqrt(D.squaredDistance),w=L._computeTwoCurvesSquaredDistance(1,P,1,h),S=Math.sqrt(w.squaredDistance),T=L._computeTwoCurvesSquaredDistance(1,m,1,h),R=L._computeTwoCurvesSquaredDistance(1,A,1,h),C=Math.sqrt(R.squaredDistance),E=Math.sqrt(T.squaredDistance);return f<C?f<S?f<E?new p.Vector3(D.aPosition1[0],D.aPosition1[1],D.aPosition1[2]):new p.Vector3(T.aPosition1[0],T.aPosition1[1],T.aPosition1[2]):S<E?new p.Vector3(w.aPosition1[0],w.aPosition1[1],w.aPosition1[2]):new p.Vector3(T.aPosition1[0],T.aPosition1[1],T.aPosition1[2]):C<S?C<E?new p.Vector3(R.aPosition1[0],R.aPosition1[1],R.aPosition1[2]):new p.Vector3(T.aPosition1[0],T.aPosition1[1],T.aPosition1[2]):S<E?new p.Vector3(w.aPosition1[0],w.aPosition1[1],w.aPosition1[2]):new p.Vector3(T.aPosition1[0],T.aPosition1[1],T.aPosition1[2])}}(u,a.clone());c&&(o=c),"MeasureItem"===Xe&&i.owner.getAttribute("sResultingType1")===t.ResultType.POINT&&(r=1),s=!1}n.modifyLeaderNode(me,ze,s,o,a,void 0,e.leaderStyle&&void 0!==e.leaderStyle.thickness?e.leaderStyle.thickness:e.lineStyle.thickness,e.leaderStyle&&e.leaderStyle.color?e.leaderStyle.color:e.lineStyle.color,null,r,Object.assign(ke.getDimensions(),{rotationAngle:i.owner.getAttribute("fBoxRotationAngle")}),i.frmWindow)}else ze.removeChildren()}function Ut(e,n,a,o){var s,l=i.owner.getAttribute("vAngleArcCenter"),c=i.owner.getAttribute("vAnglePointingPoint"),d=i.owner.getAttribute("vAngleBreakPoint"),g=i.owner.getAttribute("vAngleVector1"),b=i.owner.getAttribute("vAngleVector2");if("MeasureItem"===Xe&&n===t.ResultType.CONE&&null==c&&(i.owner._buildConstructionPointsForConeCylSphere(),l=e.getApex().clone(),c=e.arcCenter.clone(),g=e.vAxis.clone(),b=e.vSlat.clone()),l&&c&&g&&b){var y=g.clone(),h=i.owner.getAttribute("fAngle"),v=!1;if(h)(r.isZero(h)?0:180*h/Math.PI)>180&&(v=!0);var P=i.owner.getAttribute("fQuadrant");"MeasureItem"===Xe&&n===t.ResultType.CONE&&null==P&&(P=0),1!==P&&3!==P||y.negate();var m=b.clone();2!==P&&3!==P||m.negate(),s=c.clone().sub(l).length();var A=l.clone().add(y.clone().normalize().multiplyScalar(s)),D=l.clone().add(m.clone().normalize().multiplyScalar(s)),f=(new p.Vector3).crossVectors(y.clone(),m.clone()),w=(new p.Vector3).crossVectors(f.clone().normalize(),y.clone()),S=(new p.Vector3).crossVectors(f.clone().normalize(),m.clone());v&&(w.negate(),S.negate()),function(e,t,n,r,a,o,s,l,c,d,p,g,b){if(qe){var y=u.createArcNode(r,a,o,s,Ce.regularSolidLine,l);if(rt(Be,y),wt(Ue,c,d,p,g,b),void 0!==t&&void 0!==n&&!n.equals(t)){var h=u.createLineNode(n,t,Ce.regularSolidLine);rt(Be,h)}"2D"===i.owner.getAttribute("sMeasureOnGeometryType")&&"MeasureBetween"===Xe&&(Ct(Be,e,a),Ct(Be,i.owner.getMeasurable(2),a))}}(e,d,c,s,l,y,m,v,A,D,w,S,o),"MeasureItem"===Xe&&n===t.ResultType.CONE?function(e,t,n,r,a){var o,s,l,c,d,g=e.vExtensionPoint1,b=e.vExtensionPoint2;g&&b||(s=(o=e.getPoints()).beginPoint.clone().sub(o.endPoint),l=M.getDistanceFromPixel(me,o.beginPoint,30),s.normalize().multiplyScalar(l),e.vExtensionPoint1=o.beginPoint.clone().add(s),e.vExtensionPoint2=o.endPoint.clone().sub(s),g=e.vExtensionPoint1.clone(),b=e.vExtensionPoint2.clone());var y=[];y.push(g.clone().toArray()),y.push(b.clone().toArray());var h=L._computePointCurveSquaredDistance(n.clone().toArray(),1,y),v=Math.sqrt(h.squaredDistance);c=new p.Vector3(h.aPosition1[0],h.aPosition1[1],h.aPosition1[2]),d=new p.Vector3(h.aPosition2[0],h.aPosition2[1],h.aPosition2[2]),t=v>$e?d:c;var P=i.owner.getAttribute("sSurfaceDisplayType");if(rt(Be,"Angle"===P?u.createLineNode(r,n,Ce.regularSolidLine):u.createLineNode(t,n,Ce.regularSolidLine)),"MinimumRadius"!==P&&"MinimumDiameter"!==P&&"MaximumRadius"!==P&&"MaximumDiameter"!==P){rt(Be,u.createLineNode(r,a,Ce.regularSolidLine));var m=e.getApex();h=L._computePointCurveSquaredDistance(m.clone().toArray(),1,y),(v=Math.sqrt(h.squaredDistance))>$e&&(d=new p.Vector3(h.aPosition2[0],h.aPosition2[1],h.aPosition2[2]),rt(Be,u.createLineNode(m,d,Ce.regularSolidLine)))}}(e,void 0,A,l,D):n===t.ResultType.AXIS||a===t.ResultType.AXIS?function(e,n,r,a,o,s,l){var c,d,g,b,y=[];if(n===t.ResultType.AXIS){void 0!==e.vExtensionPoint1&&void 0!==e.vExtensionPoint2||(d=(c=e.getPoints()).beginPoint.clone().sub(c.endPoint),g=30,b=M.getDistanceFromPixel(me,c.beginPoint,g),d.normalize().multiplyScalar(b),e.vExtensionPoint1=c.beginPoint.clone().add(d),e.vExtensionPoint2=c.endPoint.clone().sub(d)),y.push(e.vExtensionPoint1.clone().toArray()),y.push(e.vExtensionPoint2.clone().toArray());var h=L._computePointCurveSquaredDistance(s.clone().toArray(),1,y);Math.sqrt(h.squaredDistance)>$e?rt(Be,u.createLineNode(s,o,Ce.regularSolidLine)):(0===Te&&(h=L._computePointCurveSquaredDistance(o.clone().toArray(),1,y),a=Math.sqrt(h.squaredDistance)>$e?new p.Vector3(h.aPosition2[0],h.aPosition2[1],h.aPosition2[2]):o),rt(Be,u.createLineNode(a,o,Ce.regularSolidLine)))}else rt(Be,u.createLineNode(s,o,Ce.regularSolidLine));if(r===t.ResultType.AXIS){var v=i.owner.getMeasurable(2);void 0!==v.vExtensionPoint1&&void 0!==v.vExtensionPoint2||(d=(c=v.getPoints()).beginPoint.clone().sub(c.endPoint),g=30,b=M.getDistanceFromPixel(me,c.beginPoint,g),d.normalize().multiplyScalar(b),v.vExtensionPoint1=c.beginPoint.clone().add(d),v.vExtensionPoint2=c.endPoint.clone().sub(d));var P=[];P.push(v.vExtensionPoint1.clone().toArray()),P.push(v.vExtensionPoint2.clone().toArray());var m,A=L._computePointCurveSquaredDistance(s.clone().toArray(),1,P);Math.sqrt(A.squaredDistance)>$e?rt(Be,u.createLineNode(s,l,Ce.regularSolidLine)):(0===Te&&(A=L._computePointCurveSquaredDistance(l.clone().toArray(),1,P),m=Math.sqrt(A.squaredDistance)>$e?new p.Vector3(A.aPosition2[0],A.aPosition2[1],A.aPosition2[2]):l),rt(Be,u.createLineNode(m,l,Ce.regularSolidLine)))}else rt(Be,u.createLineNode(s,l,Ce.regularSolidLine))}(e,n,a,void 0,A,l,D):qe&&(rt(Be,u.createLineNode(l,A,Ce.regularSolidLine)),rt(Be,u.createLineNode(l,D,Ce.regularSolidLine)))}}function Bt(e,t){return e&&t&&(t===l.GeometryType.LINE||t===l.GeometryType.CYLINDER||t===l.GeometryType.CONE)}function zt(e,n,r,a,o){var s=o;if(n===t.ResultType.AXIS&&r===t.ResultType.AXIS&&void 0!==a&&a<$e&&i.owner.getAttribute("fDistance")){var l=i.owner.getAttribute("vExtensionDirection3D"),u=e.getPoints(),c=l.angleTo(u.beginPoint.clone().sub(u.endPoint));(c<$e||Math.abs(c-Math.PI)<$e)&&(s=!0)}return s}function Gt(e,n,a){var o,s,l,c,d,g,y,h,v=i.owner.getMeasurable(2),P=a.getType(),m=v.getType(),A="Distance"===i.owner.getAttribute("sDistanceType"),D=Bt(A,P),f=Bt(A,m),w=i.owner.getAttribute("vFirstPoint3D"),S=i.owner.getAttribute("vSecondPoint3D"),T=i.owner.getAttribute("vFirstExtensionPoint3D"),R=i.owner.getAttribute("vSecondExtensionPoint3D"),C=!1;if(C=zt(a,e,n,i.owner.getAttribute("fAngle"),C),zt(C),e===t.ResultType.AXIS||D){void 0!==a.vExtensionPoint1&&void 0!==a.vExtensionPoint2||(s=a.getPoints(),a.vExtensionPoint1=s.beginPoint.clone(),a.vExtensionPoint2=s.endPoint.clone(),e===t.ResultType.AXIS&&(l=s.beginPoint.clone().sub(s.endPoint),c=30,d=M.getDistanceFromPixel(me,s.beginPoint,c),l.normalize().multiplyScalar(d),a.vExtensionPoint1=s.beginPoint.clone().add(l),a.vExtensionPoint2=s.endPoint.clone().sub(l)));var E=[];E.push(a.vExtensionPoint1.clone().toArray()),E.push(a.vExtensionPoint2.clone().toArray());var _=L._computePointCurveSquaredDistance(T.clone().toArray(),1,E),x=Math.sqrt(_.squaredDistance);g=new p.Vector3(_.aPosition1[0],_.aPosition1[1],_.aPosition1[2]),y=new p.Vector3(_.aPosition2[0],_.aPosition2[1],_.aPosition2[2]),x>$e?e!==t.ResultType.AXIS?(o=u.createLineNode(g.clone(),y.clone(),Ce.regularDashedLine),rt(Be,o)):(C||(o=u.createLineNode(g.clone(),y.clone(),Ce.dotLine),rt(Be,o)),(h=[]).push(T.clone().toArray()),C?h=E:r.areEqual(y,a.vExtensionPoint1,"Vector3")?h.push(a.vExtensionPoint2.clone().toArray()):h.push(a.vExtensionPoint1.clone().toArray()),_=L._computePointCurveSquaredDistance(w.clone().toArray(),1,h),T=Math.sqrt(_.squaredDistance)>$e?new p.Vector3(_.aPosition2[0],_.aPosition2[1],_.aPosition2[2]):w):e===t.ResultType.AXIS&&0===Te&&(_=L._computePointCurveSquaredDistance(w.clone().toArray(),1,E),T=Math.sqrt(_.squaredDistance)>$e?new p.Vector3(_.aPosition2[0],_.aPosition2[1],_.aPosition2[2]):w)}if(n===t.ResultType.AXIS||f){void 0!==v.vExtensionPoint1&&void 0!==v.vExtensionPoint2||(s=v.getPoints(),v.vExtensionPoint1=s.beginPoint.clone(),v.vExtensionPoint2=s.endPoint.clone(),n===t.ResultType.AXIS&&(l=s.beginPoint.clone().sub(s.endPoint),c=30,d=M.getDistanceFromPixel(me,s.beginPoint,c),l.normalize().multiplyScalar(d),v.vExtensionPoint1=s.beginPoint.clone().add(l),v.vExtensionPoint2=s.endPoint.clone().sub(l)));var N=[];N.push(v.vExtensionPoint1.clone().toArray()),N.push(v.vExtensionPoint2.clone().toArray());var V=L._computePointCurveSquaredDistance(R.clone().toArray(),1,N),k=Math.sqrt(V.squaredDistance);g=new p.Vector3(V.aPosition1[0],V.aPosition1[1],V.aPosition1[2]),y=new p.Vector3(V.aPosition2[0],V.aPosition2[1],V.aPosition2[2]),k>$e?n!==t.ResultType.AXIS?(o=u.createLineNode(g.clone(),y.clone(),Ce.regularDashedLine),rt(Be,o)):(C||(o=u.createLineNode(g.clone(),y.clone(),Ce.dotLine),rt(Be,o)),(h=[]).push(R.clone().toArray()),C?h=N:r.areEqual(y,v.vExtensionPoint1,"Vector3")?h.push(v.vExtensionPoint2.clone().toArray()):h.push(v.vExtensionPoint1.clone().toArray()),V=L._computePointCurveSquaredDistance(S.clone().toArray(),1,h),R=Math.sqrt(V.squaredDistance)>$e?new p.Vector3(V.aPosition2[0],V.aPosition2[1],V.aPosition2[2]):S):n===t.ResultType.AXIS&&0===Te&&(V=L._computePointCurveSquaredDistance(S.clone().toArray(),1,N),R=Math.sqrt(V.squaredDistance)>$e?new p.Vector3(V.aPosition2[0],V.aPosition2[1],V.aPosition2[2]):S)}rt(Be,function(e,t,i,n,a,o){var s=new b;if(e&&t&&i&&n){var l=t.clone(),c=n.clone();a&&(l.add(e).multiplyScalar(.5),c.add(i).multiplyScalar(.5));var d=u.createLineNode(i.clone(),e.clone(),o);r.areEqual(i,e,"Vector3")||rt(s,d);var p=u.createLineNode(c.clone(),l.clone(),o);r.areEqual(c,l,"Vector3")||rt(s,p)}return s}(w,S,T,R,!1,Ce.regularSolidLine))}function Jt(e){var t=e.leaderStyle&&void 0!==e.leaderStyle.thickness?e.leaderStyle.thickness:e.lineStyle.thickness;return Math.max(2*t+4,fe)}function Ht(e,n,r,a){var o,s=i.owner.getAttribute("vFirstExtensionPoint3D"),l=i.owner.getAttribute("vSecondExtensionPoint3D");n===t.ResultType.CURVE&&(s=(o=e.getPoints()).beginPoint.clone(),l=o.endPoint.clone());var u={value:5,scale:1};a=Jt(r);var c=i.owner.getAttribute("sExtremityType");void 0!==c&&(u=Ft(c));var d=r.lineStyle.color,b=u.value;8!==b&&9!==b||(b=5);var y=R.retrieveMaterialFromGAS({size:a,withoutDPR:!0,scale:u.scale,symbol:b,color:new p.Color(d)});y.force=!0,rt(Oe,g.createPointsNode({positions:s.toArray(),material:y})),rt(Oe,g.createPointsNode({positions:l.toArray(),material:y}))}function qt(e,n,a,s){var c,d="MeasureItem"===Xe,b="MeasureBetween"===Xe,y="MeasureThickness"===Xe;d&&n!==t.ResultType.LINE&&n!==t.ResultType.CIRCLE&&n!==t.ResultType.CONE&&n!==t.ResultType.CYLINDER||(O&&Z&&se&&Q||Ue.removeChildren(),Be.removeChildren(),Nt(),b&&(Ce.regularSolidLine.lineWidth=s.leaderStyle&&void 0!==s.leaderStyle.thickness?s.leaderStyle.thickness:s.lineStyle.thickness),c=i.owner.isReadOnly()&&qe&&n===t.ResultType.CIRCLE,b||y||d&&(n===t.ResultType.CONE||c)?((b||d&&(n===t.ResultType.CONE&&"Length"!==i.owner.getAttribute("sSurfaceDisplayType")&&"Area"!==i.owner.getAttribute("sSurfaceDisplayType")||c))&&Ut(e,n,a,s),_t()&&!c&&function(e,n,r,a){var o="MeasureBetween"===Xe||"MeasureItem"===Xe&&(e===t.ResultType.CONE||e===t.ResultType.CYLINDER)&&"Length"===i.owner.getAttribute("sSurfaceDisplayType");St(Ue,i.owner.getAttribute("vFirstPoint3D"),i.owner.getAttribute("vSecondPoint3D"),i.owner.getAttribute("vLeaderBreakPoint3D"),!0,!1,a,o),"MeasureBetween"===Xe?Gt(e,n,r):rt(Be,Tt(i.owner.getAttribute("vFirstPoint3D"),i.owner.getAttribute("vSecondPoint3D"),i.owner.getAttribute("vFirstExtensionPoint3D"),i.owner.getAttribute("vSecondExtensionPoint3D"),!1,a))}(n,a,e,s)):d?function(e,n){switch(e){case t.ResultType.LINE:St(Ue,i.owner.getAttribute("vFirstPoint3D"),i.owner.getAttribute("vSecondPoint3D"),i.owner.getAttribute("vLeaderBreakPoint3D"),!0,!1,n,!0),rt(Be,Tt(i.owner.getAttribute("vFirstPoint3D"),i.owner.getAttribute("vSecondPoint3D"),i.owner.getAttribute("vFirstExtensionPoint3D"),i.owner.getAttribute("vSecondExtensionPoint3D"),!1,n));break;case t.ResultType.CIRCLE:if(0!==i.owner.getAttribute("iRadiusResultDisplayType")){var a=i.owner.getAttribute("vArcMidPoint"),o=i.owner.getAttribute("vFirstExtensionPoint3D");r.areEqual(a,o,"Vector3")||i.owner._buildConstructionData(),St(Ue,i.owner.getAttribute("vFirstPoint3D"),i.owner.getAttribute("vSecondPoint3D"),i.owner.getAttribute("vLeaderBreakPoint3D"),!0,i.owner.getAttribute("bRadiusDisplay"),n,!0,!1,!0,i.owner.getAttribute("bRadiusDisplay")),rt(Be,Tt(i.owner.getAttribute("vFirstPoint3D"),i.owner.getAttribute("vSecondPoint3D"),i.owner.getAttribute("vFirstExtensionPoint3D"),i.owner.getAttribute("bRadiusDisplay")?i.owner.getAttribute("vSecondPoint3D"):i.owner.getAttribute("vSecondExtensionPoint3D"),!1,n))}break;case t.ResultType.CYLINDER:"Length"===i.owner.getAttribute("sSurfaceDisplayType")&&(St(Ue,i.owner.getAttribute("vFirstPoint3D"),i.owner.getAttribute("vSecondPoint3D"),i.owner.getAttribute("vLeaderBreakPoint3D"),!0,!1,n,!0),rt(Be,Tt(i.owner.getAttribute("vFirstPoint3D"),i.owner.getAttribute("vSecondPoint3D"),i.owner.getAttribute("vFirstExtensionPoint3D"),i.owner.getAttribute("vSecondExtensionPoint3D"),!1,n)))}}(n,s):"Measure3PointsCircle"===Xe?i.owner.getAttribute("iRadiusResultDisplayType")!==t.RadiusResultDisplayType.CENTER&&(St(Ue,i.owner.getAttribute("vFirstPoint3D"),i.owner.getAttribute("vSecondPoint3D"),i.owner.getAttribute("vLeaderBreakPoint3D"),!0,i.owner.getAttribute("bRadiusDisplay"),s,!0,!1,!0,i.owner.getAttribute("bRadiusDisplay")),rt(Be,Tt(i.owner.getAttribute("vFirstPoint3D"),i.owner.getAttribute("vSecondPoint3D"),i.owner.getAttribute("vFirstExtensionPoint3D"),i.owner.getAttribute("vSecondExtensionPoint3D"),i.owner.getAttribute("bRadiusDisplay"),s))):"Measure3PointsAngle"===Xe&&function(e,t){var n=i.owner.getAttribute("vAngleVector1").clone(),a=i.owner.getAttribute("vAngleVector2").clone(),s=i.owner.getAttribute("fQuadrant"),c=!1;if(void 0!==s){1!==s&&3!==s||n.negate(),2!==s&&3!==s||a.negate();var d=n.angleTo(a);d!==i.owner.getAttribute("fAngle")&&i.owner.setAttribute("fAngle",d)}else{var b=i.owner.getAttribute("fAngle");(r.isZero(b)?0:180*b/Math.PI)>180&&(c=!0)}var y=i.owner.getAttribute("vAnglePointingPoint"),h=i.owner.getAttribute("bHasALeader"),v=i.owner.getAttribute("vAngleBreakPoint"),P=Ce.regularSolidLine;if(void 0!==h&&void 0!==y&&void 0!==v&&!0===h){P=Ce.regularSolidLine;var m=u.createLineNode(i.owner.getAttribute("vAnglePointingPoint"),i.owner.getAttribute("vAngleBreakPoint"),P);rt(Be,m),Ce.crossPoint.force=!0;var A=g.createPointsNode({positions:y.clone().toArray(),material:Ce.crossPoint}),D=g.createPointsNode({positions:v.clone().toArray(),material:Ce.crossPoint});rt(Be,A),rt(Be,D)}var M=i.owner.getAttribute("vAngleArcCenter"),f=i.owner.getAttribute("vAnglePointingPoint").clone().sub(M).length(),w=u.createArcNode(f,M,n,a,P,c);rt(Be,w);var S=i.owner.getMeasurable(2);if(S){var T,R=M.clone().add(n.clone().normalize().multiplyScalar(f)),C=o.computePointSegmentDistance(R.toArray(),e.getSelPoint().toArray(),S.getSelPoint().toArray());0===C.returnCode&&C.relationship!==l.Relationship.COINCIDENT&&(T=new p.Vector3(C.aPosition[0],C.aPosition[1],C.aPosition[2]),rt(Be,u.createLineNode(T,R,Ce.regularSolidLine)));var L=M.clone().add(a.clone().normalize().multiplyScalar(f)),E=(new p.Vector3).crossVectors(n.clone(),a.clone()),_=(new p.Vector3).crossVectors(E.clone().normalize(),n.clone()),x=(new p.Vector3).crossVectors(E.clone().normalize(),a.clone());c&&(_.negate(),x.negate()),wt(Ue,R,L,_,x,t),0===(C=o.computePointSegmentDistance(L.toArray(),i.owner.getMeasurable(3).getSelPoint().toArray(),S.getSelPoint().toArray())).returnCode&&C.relationship!==l.Relationship.COINCIDENT&&(T=new p.Vector3(C.aPosition[0],C.aPosition[1],C.aPosition[2]),rt(Be,u.createLineNode(T,L,Ce.regularSolidLine)))}}(e,s),xt())}function Xt(e,n,a,o,s){var c,d=i.owner.getMeasurable(2);if(d){if("MeasureBetween"===Xe&&function(e,n,a,o){var s,l,c,d,p,b=i.owner.getAttribute("vFirstExtensionPoint3D"),y=i.owner.getAttribute("vSecondExtensionPoint3D");if(!r.areEqual(b,y,"Vector3")){var h,v,P=n,m=a,A=void 0!==i.owner.getAttribute("fAngle")&&r.isZero(i.owner.getAttribute("fAngle"));P===t.ResultType.PLANE&&m===t.ResultType.PLANE&&A?(o.force=!0,h=g.createPointsNode({positions:b.clone().toArray(),material:o}),rt(Oe,h),v=g.createPointsNode({positions:y.clone().toArray(),material:o}),rt(Oe,v)):P===t.ResultType.AXIS&&m===t.ResultType.AXIS&&A||!i.owner.getAttribute("fDistance")||(o.force=!0,h=g.createPointsNode({positions:b.clone().toArray(),material:o}),rt(Oe,h),v=g.createPointsNode({positions:y.clone().toArray(),material:o}),rt(Oe,v))}n===t.ResultType.AXIS&&(c=(l=e.getPoints()).beginPoint.clone().sub(l.endPoint),d=30,p=M.getDistanceFromPixel(me,l.beginPoint,d),c.normalize().multiplyScalar(p),e.vExtensionPoint1=l.beginPoint.clone().add(c),e.vExtensionPoint2=l.endPoint.clone().sub(c),rt(Fe,u.createLineNode(e.vExtensionPoint1,e.vExtensionPoint2,Ce.dotDashedLine))),a===t.ResultType.AXIS&&(c=(l=(s=i.owner.getMeasurable(2)).getPoints()).beginPoint.clone().sub(l.endPoint),d=30,p=M.getDistanceFromPixel(me,l.beginPoint,d),c.normalize().multiplyScalar(p),s.vExtensionPoint1=l.beginPoint.clone().add(c),s.vExtensionPoint2=l.endPoint.clone().sub(c),rt(Fe,u.createLineNode(s.vExtensionPoint1,s.vExtensionPoint2,Ce.dotDashedLine)))}(e,n,a,s),n===t.ResultType.AXIS||n===t.ResultType.PLANE?qe||"MeasureBetween"===Xe||Et(Fe,Ne,e,n,i.owner.getAttribute("vFirstExtensionPoint3D")):n===t.ResultType.CURVE&&e.getType()===l.GeometryType.LINE?"MeasureBetween"!==Xe&&Et(Fe,Ne,e,t.ResultType.LINE,i.owner.getAttribute("vFirstExtensionPoint3D")):n===t.ResultType.LINE&&a===t.ResultType.LINE&&"Distance"===i.owner.getAttribute("sDistanceType")&&Et(Fe,Ve,d,a,i.owner.getAttribute("vSecondExtensionPoint3D")),a===t.ResultType.AXIS||a===t.ResultType.PLANE?qe||"MeasureBetween"===Xe||Et(Fe,Ve,d,a,i.owner.getAttribute("vSecondExtensionPoint3D")):a===t.ResultType.CURVE&&d.getType()===l.GeometryType.LINE&&"MeasureBetween"!==Xe&&Et(Fe,Ve,d,t.ResultType.LINE,i.owner.getAttribute("vSecondExtensionPoint3D")),He&&"MeasureBetween"!==Xe){var y="MeasureThickness"===Xe?Ce.avatarDottedLine:Ce.regularDashedLine,h=(v=i.owner.getAttribute("vFirstExtensionPoint3D"),P=i.owner.getAttribute("vSecondExtensionPoint3D"),m=o.leaderStyle&&o.leaderStyle.color?o.leaderStyle.color:o.lineStyle.color,D=o.fillStyle.color,f=y,S=new b,T=!0,0===i.owner._bCreateMeasureInShowSpace&&(T=!1),v&&(null!==S._nAnchor1SpriteNode&&S.remove(S._nAnchor1SpriteNode),S._nAnchor1SpriteNode=Rt(v,m,D),S._nAnchor1SpriteNode.setVisibility(T),rt(S,S._nAnchor1SpriteNode)),P&&(null!==S._nAnchor2SpriteNode&&S.remove(S._nAnchor2SpriteNode),S._nAnchor2SpriteNode=Rt(P,m,D),S._nAnchor2SpriteNode.setVisibility(T),rt(S,S._nAnchor2SpriteNode)),v&&P&&(void 0===w||!0===w)&&rt(S,u.createLineNode(v,P,f)),S);rt(Oe,h)}else qe||"MeasureBetween"===Xe||((c=Rt(i.owner.getAttribute("vFirstExtensionPoint3D"),o.leaderStyle&&o.leaderStyle.color?o.leaderStyle.color:o.lineStyle.color,o.fillStyle.color)).setVisibility(0!==i.owner._bCreateMeasureInShowSpace),rt(Oe,c));var v,P,m,D,f,w,S,T;if("MeasureThickness"===Xe){var R=o.lineStyle.thickness;R=Math.max(2*R+4,10),R/=8;var C=new b,L=new A({ratio:7}),E=u.createCircleNode(R,new p.Vector3(0,0,0),new p.Vector3(0,0,1),Ce.regularSolidLine),_=new A({ratio:7}),x=u.createCircleNode(R,new p.Vector3(0,0,0),new p.Vector3(0,0,1),Ce.regularSolidLine),N=r.computeTransformationBetweenTwoLines(new p.Vector3,new p.Vector3(0,0,1),e.getSelPoint(),e.getSelNormal());L.setMatrix(N.transformation),L.addChild(E),N=r.computeTransformationBetweenTwoLines(new p.Vector3,new p.Vector3(0,0,1),i.owner.getAttribute("vSecondExtensionPoint3D"),e.getSelNormal()),_.setMatrix(N.transformation),_.addChild(x),C.addChild(L),C.addChild(_),rt(Fe,C)}}}function Wt(e,n,r,a,o){var s,l,u,c,d,y,h;function v(){l&&(a.force=!0,u=g.createPointsNode({positions:l,material:a}),rt(Oe,u))}switch(n){case t.ResultType.POINT:l=e.getSelPoint().toArray(),v();break;case t.ResultType.CENTER:l=e.getCenter().toArray(),v();break;case t.ResultType.AXIS:Lt(Fe,Ne,e,n,Ce.dotDashedLine);break;case t.ResultType.CIRCLE:!function(e,t,n,r){var a,o,s,l,u,c,d,b,y,h=i.owner.getAttribute("iRadiusResultDisplayType");if(Lt(Fe,Ne,e,t,Ce.regularSolidLine),i.owner.getAttribute("bArcLengthDisplay"))c=(y=e.getPoints()).beginPoint.clone(),d=y.endPoint.clone(),a={value:5,scale:1},r=Jt(n),void 0!==(o=i.owner.getAttribute("sExtremityType"))&&(a=Ft(o)),s=n.lineStyle.color,8!==(l=a.value)&&9!==l||(l=5),(u=R.retrieveMaterialFromGAS({size:r,withoutDPR:!0,scale:a.scale,symbol:l,color:new p.Color(s)})).force=!0,rt(Oe,g.createPointsNode({positions:c.toArray(),material:u})),rt(Oe,g.createPointsNode({positions:d.toArray(),material:u}));else if(0===h){var v=e.getSelPoint(),P=i.owner.getAttribute("vCenter").clone();b=P.clone();var m=!0;if(!1===i.owner.getAttribute("bRadiusDisplay")){var A=P.clone().sub(v);b=P.clone().add(A),m=!1}v||(v=i.owner.getAttribute("vLeaderPointingPoint3D")),St(Oe,v.clone(),b.clone(),void 0,!1,!1,n,!0,!1,!0,m)}}(e,n,r,o);break;case t.ResultType.CURVE:case t.ResultType.LINE:Ht(e,n,r,o);break;case t.ResultType.PLANE:Lt(Fe,Ne,e,n,Ce.regularSolidLine);break;case t.ResultType.CYLINDER:"Length"===(h=i.owner.getAttribute("sSurfaceDisplayType"))?Ht(e,n,r,o):"Area"!==h&&(Lt(Fe,Ne,e,n,Ce.regularSolidLine),c=i.owner.getAttribute("vFirstPoint3D"),d=i.owner.getAttribute("vSecondPoint3D"),y=i.owner.getAttribute("vLeaderBreakPoint3D"),void 0===Te&&(c=(s=i.owner._buildConstructionPointsForConeCylSphere()).oPos1,d=s.oPos2,y=c.clone()),h&&"Radius"!==h&&"Diameter"!==h&&"MinimumRadius"!==h&&"MinimumDiameter"!==h&&"MaximumRadius"!==h&&"MaximumDiameter"!==h||St(Oe,c,d,y,!1,i.owner.getAttribute("bRadiusDisplay"),r,!0,!1,!0,i.owner.getAttribute("bRadiusDisplay")));break;case t.ResultType.CONE:"Length"===(h=i.owner.getAttribute("sSurfaceDisplayType"))?Ht(e,n,r,o):"Area"!==h&&(Lt(Fe,Ne,e,n,Ce.regularSolidLine),"MinimumRadius"!==h&&"MinimumDiameter"!==h&&"MaximumRadius"!==h&&"MaximumDiameter"!==h||St(Oe,i.owner.getAttribute("vFirstPoint3D"),i.owner.getAttribute("vSecondPoint3D"),i.owner.getAttribute("vLeaderBreakPoint3D"),!1,i.owner.getAttribute("bRadiusDisplay"),r,!0,!1,!0,i.owner.getAttribute("bRadiusDisplay")));break;case t.ResultType.SPHERE:Lt(Fe,Ne,e,n,Ce.regularSolidLine),c=i.owner.getAttribute("vFirstPoint3D"),d=i.owner.getAttribute("vSecondPoint3D"),y=i.owner.getAttribute("vLeaderBreakPoint3D"),void 0===Te&&(c=(s=i.owner._buildConstructionPointsForConeCylSphere()).oPos1,d=s.oPos2,y=c.clone()),St(Fe,c,d,y,!1,i.owner.getAttribute("bRadiusDisplay"),r,!0,!1,!0,i.owner.getAttribute("bRadiusDisplay"));break;case t.ResultType.SURFACE:Lt(Fe,Ne,e,n,Ce.regularSolidLine);break;case t.ResultType.PRODUCT:Ne=function(e,t,i){for(var n=new b,r=[],a=Number.MAX_VALUE,o=0;o<3;o++)r[o]=e[o+3]-e[o],a=Math.min(a,r[o]);a/=10;var s=[];s[0]=new p.Vector3(a,0,0),s[1]=new p.Vector3(0,a,0),s[2]=new p.Vector3(0,0,a);var l=[],u=[],c=new p.Vector3(e[0],e[1],e[2]);for(l[0]=0;l[0]<2;l[0]++)for(l[1]=0;l[1]<2;l[1]++)for(l[2]=0;l[2]<2;l[2]++){var d=4*l[0]+2*l[1]+l[2];u[d]=[],u[d][0]=new p.Vector3(l[0]*r[0],l[1]*r[1],l[2]*r[2]).add(c);for(var y=0;y<3;y++)u[d][y+1]=s[y].clone().multiplyScalar(1-2*l[y]).add(u[d][0]);var h=[u[d][1],u[d][0],u[d][2],u[d][0],u[d][3]],v=g.createLineNode({points:h,material:t});v.setShadow(!1),rt(n,v)}var P=[u[0][0],u[4][0],u[6][0],u[2][0],u[0][0],u[1][0],u[5][0],u[4][0],u[5][0],u[7][0],u[6][0],u[7][0],u[3][0],u[2][0],u[3][0],u[1][0]],m=g.createLineNode({points:P,material:i});return m.setShadow(!1),rt(n,m),n}(i.owner.getAttribute("aabb"),Ce.avatarSolidLine,Ce.avatarDashedLine),rt(Fe,Ne)}}function Yt(e,n,r,a){Fe.removeChildren(),Oe.removeChildren();var o,s={value:0,scale:1},l=a.lineStyle.color,c=Jt(a),d=i.owner.getAttribute("sPointType");if(void 0!==d&&(s=Ft(d)),0===s.value)o=R.retrieveMaterialFromGAS({color:new p.Color(l)});else{var b=s.value;8!==b&&9!==b||(b=5),o=R.retrieveMaterialFromGAS({size:c,scale:s.scale,withoutDPR:!0,symbol:b,color:new p.Color(l)})}"MeasureBetween"===Xe||"MeasureThickness"===Xe?Xt(e,n,r,a,o):"MeasureItem"===Xe?Wt(e,n,a,o,c):"Measure3PointsCircle"===Xe?function(e,n,r){var a=i.owner.getMeasurable(2),o=i.owner.getMeasurable(3),s=u.createCircleNode(i.owner.getAttribute("fRadius"),i.owner.getAttribute("vCenter"),i.owner.getAttribute("vNormal"),Ce.regularSolidLine);if(rt(Fe,s),n.force=!0,rt(Oe,g.createPointsNode({positions:e.getSelPoint().clone().toArray(),material:n})),rt(Oe,g.createPointsNode({positions:a.getSelPoint().clone().toArray(),material:n})),rt(Oe,g.createPointsNode({positions:o.getSelPoint().clone().toArray(),material:n})),i.owner.getAttribute("iRadiusResultDisplayType")===t.RadiusResultDisplayType.CENTER){var l=i.owner.getAttribute("vCenter").clone();!1===i.owner.getAttribute("bRadiusDisplay")&&(l=i.owner.getAttribute("vSecondExtensionPoint3D").clone()),St(Oe,i.owner.getAttribute("vFirstExtensionPoint3D").clone(),l.clone(),void 0,!1,!1,r,!0,!1,!0,i.owner.getAttribute("bRadiusDisplay"))}}(e,o,a):"Measure3PointsAngle"===Xe&&function(e,t){var n=i.owner.getMeasurable(2),r=i.owner.getMeasurable(3);rt(Fe,u.createLineNode(e.getSelPoint(),n.getSelPoint(),Ce.regularSolidLine)),rt(Fe,u.createLineNode(r.getSelPoint(),n.getSelPoint(),Ce.regularSolidLine)),t.force=!0,rt(Oe,g.createPointsNode({positions:e.getSelPoint().clone().toArray(),material:t})),rt(Oe,g.createPointsNode({positions:n.getSelPoint().clone().toArray(),material:t})),rt(Oe,g.createPointsNode({positions:r.getSelPoint().clone().toArray(),material:t}))}(e,o)}function jt(e,n){var r,a,o,s,u,c,d,p,g,b,y;ke.setVisibility(He),0===i.owner._bCreateMeasureInShowSpace?He?ke.setVisibility(!He):(ke.setVisibility(He),ke.setVisibilityFree(!He)):1===i.owner._bCreateMeasureInShowSpace&&(ke.setVisibility(He),ke.setVisibilityFree(!He)),!He&&qe&&Pe||(Nt(),ke.modify({content:(r=i.owner.getAttribute("bShortDisplay"),a=Xe,o=i.owner.getAttribute("fDistance"),s=i.owner.getAttribute("sMeasureOnGeometryType"),u=i.owner.getAttribute("sDistanceType"),p=[],g={},b=i.owner.getMeasurable(1),y=b.getPoints(),we=!1,!1===i.owner.getAttribute("bDisplayMeasureType")&&(we=!0),"MeasureBetween"===a||"MeasureThickness"===a?p=vt(a,u,s,r,o,b,c=i.owner.getMeasurable(2),g):"MeasureItem"===a?p=Mt(r,b,y,g):"Measure3PointsCircle"===a&&(c=i.owner.getMeasurable(2),g.exact=b.getMode()===l.Mode.EXACT&&c.getMode()===l.Mode.EXACT&&i.owner.getMeasurable(3).getMode()===l.Mode.EXACT,g.mode=g.exact?x.exactMode:x.approximateMode,d=i.owner.getAttribute("fRadius"),r?i.owner.getAttribute("bRadiusDisplay")?p[0]=gt(d,we):p[0]=bt(2*d,we):(p[0]=gt(d)+"  "+bt(2*d),p[1]=x.center+" "+lt(i.owner.getAttribute("vCenter")),p[2]=x.normal+" "+lt(i.owner.getAttribute("vNormal")),p[3]=x.circle,p[4]=g.mode)),p),commentContent:i.owner.getAttribute("sCommentOnMeasure"),position:i.owner.getAttribute("vLeaderBreakPoint3D"),isFilled:i.owner.getAttribute("bIsFilled"),hasBorder:i.owner.getAttribute("bHasBorder"),graphicProperties:n,inEdition:i.owner.isInEdition(),boxRotationAngle:i.owner.getAttribute("fBoxRotationAngle"),tessRep:i.owner.getAttribute("sTextGraphicRepresentation")}),xt()),Ie.setVisibility(qe),0===i.owner._bCreateMeasureInShowSpace?(qe?Ie.setVisibility(!qe):Ie.setVisibility(qe),Ie.setVisibilityFree(!qe)):1===i.owner._bCreateMeasureInShowSpace&&(Ie.setVisibility(qe),Ie.setVisibilityFree(!qe)),qe&&(Nt(),Ie.modify({content:ft(i.owner.getAttribute("bShortDisplay"),Xe,"MeasureItem"===Xe&&e===t.ResultType.CONE?i.owner.getAttribute("fSemiAngle"):i.owner.getAttribute("fAngle"),!He,i.owner.getAttribute("sMeasureOnGeometryType")),position:i.owner.getAttribute("vAngleBreakPoint"),isFilled:i.owner.getAttribute("bIsFilled"),hasBorder:i.owner.getAttribute("bHasBorder"),graphicProperties:n,boxRotationAngle:i.owner.getAttribute("fBoxRotationAngle"),tessRep:i.owner.getAttribute("stextGraphicRepresentationAngle")}),xt())}function Zt(e){var t=!1;switch(e){case"AnchorAndAvatar":t=!(O&&U&&B&&Z&&le&&J&&X&&se&&ae&&oe&&Q);break;case"DimensionGroup":t=!(O&&U&&G&&B&&J&&H&&q&&X&&Q&&W&&Y&&j&&Z&&K&&$&&ee&&te&&ie&&ne&&re&&se);break;case"LableContent":t=!(O&&F&&ue&&J&&K&&U&&B&&z&&ce&&de&&pe&&ge&&be&&he&&ve&&Z&&Pe);break;case"Leader":t=!(O&&z&&Y&&j&&U&&Z&&se)}return t}this.getPixelFontSize=function(e){var t;return i.owner.getAttribute("iFontSize")&&(t=M.convertPixelToModel({sizeInPixels:i.owner.getAttribute("iFontSize")*(4/3),viewer:me})),t||(t=i.owner.getAttribute(e)),M.convertModelToPixels({sizeInMM:t,viewer:me})},this.getTooltip=function(){var t=[];if(!i.owner.getAttribute("sTextGraphicRepresentation")&&_e)return _e.length&&_e.length>50&&(Ge=!0),t.push(_e),xe&&(t.push("\n"+xe),!Ge&&xe.length&&xe.length>50&&(Ge=!0)),function(t){var i;if(nt()){if(t&&t.length){i=e.createElement("div");for(var n=0;n<t.length;n++)e.createElement("p",{styles:{margin:"2px",padding:0}}).inject(i).setText(t[n])}return i}}(t)},this.processPathForTrimedText=function(e){var t=e;if(i.owner.getAttribute("bShortDisplay")||!_e||i.owner.getAttribute("sTextGraphicRepresentation")||i.owner.getAttribute("stextGraphicRepresentationAngle"))return t;if(_e.length&&_e.length>50||xe&&xe.length&&xe.length>50){var n=t.pathElement.hash();n+="000/",t.pathElement._hash=n}return t},this.getBoxPosition=function(){var e=ke.getDimensions();return{top:-e.offsetHeight/2,left:-e.offsetWidth/2}},this.update=function(e,n){if(null!==Ke&&-1!==i.owner.getAttribute("sSelectedType1")){Te=i.owner.getAttribute("iExtensionLinesManipulable"),Re(),Xe=i.owner.getAttribute("sType"),n&&(We=void 0);var a=i.owner.getMeasurable(1);if(a){var o,s,l=st(),u=i.owner.getAttribute("sResultingType1"),c=i.owner.getAttribute("sResultingType2"),d=!!e||!O;je||(je=!1),N=It("UnitLength","string"),V=It("UnitAngle","string"),k=It("UnitArea","string"),I=It("UnitVolume","string"),F=N&&V&&k&&I,(O=void 0!==We&&We===Xe)||(We=Xe),U=It("LineStyleColor","Color"),B=It("FillStyleColor","Color"),z=It("LineStyleThickness","float"),G=It("LeaderStyleThickness","float"),J=It("Distance","float"),H=It("FirstPoint3D","Vector3"),q=It("SecondPoint3D","Vector3"),X=It("FirstExtensionPoint3D","Vector3"),W=It("SecondExtensionPoint3D","Vector3"),Y=It("LeaderBreakPoint3D","Vector3"),j=It("LeaderPointingPoint3D","Vector3"),Z=It("RadiusDisplay","bool"),Q=It("ArcLengthDisplay","bool"),K=It("Angle","float"),$=It("AngleBreakPoint","Vector3"),ee=It("Quadrant","float"),te=It("AngleArcCenter","Vector3"),ie=It("AnglePointingPoint","Vector3"),ne=It("AngleVector1","Vector3"),re=It("AngleVector2","Vector3"),ae=It("PointType","string"),oe=It("ExtremityType","string"),se=!0,("MeasureItem"===Xe&&i.owner.getAttribute("sResultingType1")===t.ResultType.CIRCLE||"Measure3PointsCircle"===Xe)&&(se=It("RadiusResultDisplayType","int")),z&&G||(ae=!1,oe=!1),le=It("aabb","AABB"),ue=It("ShortDisplay","bool"),ce=It("IsFilled","bool"),de=It("HasBorder","bool"),pe=It("HasALeader","bool"),ge=It("FontColor","Color"),be=It("FontName","string"),(void 0!==(ye=Qe.getPixelFontSize("fFontSize"))||void 0!==Ke.FontSize&&ye===Ke.FontSize)&&(Ke.FontSize=ye),he=It("FontSize","float"),ve=It("Opacity","float"),Pe=je===i.owner.isInEdition(),je||(B=!1,U=!1),je=i.owner.isInEdition(),function(e){if(!O){var n,a=i.owner.getAttribute("sSurfaceDisplayType");"MeasureItem"===Xe?e!==t.ResultType.CONE||"Angle"!==a&&"HalfAngle"!==a||(n=i.owner.getAttribute("fSemiAngle")):n=i.owner.getAttribute("fAngle"),qe=void 0!==n&&!r.isZero(n);var o=i.owner.getAttribute("fDistance");He="MeasureItem"===Xe&&e!==t.ResultType.CONE||"MeasureItem"===Xe&&!qe&&e===t.ResultType.CONE||"Measure3PointsCircle"===Xe||"MeasureThickness"===Xe||void 0!==o&&!(r.isZero(o)&&qe),"MeasureBetween"===Xe&&void 0!==i.owner.getAttribute("sDistanceType")&&("Angle"===i.owner.getAttribute("sDistanceType")&&qe?He=!1:(qe=!1,He=!0))}}(u),kt(d),function(e){if(!U||!B){var t=e.lineStyle.color;Ce.regularSolidLine.color=!0===i.owner._bPrevisualized&&"MeasureThickness"===Xe?Me:e.leaderStyle&&e.leaderStyle.color?e.leaderStyle.color:t,Ce.regularDashedLine.color=e.leaderStyle&&e.leaderStyle.color?e.leaderStyle.color:t,Ce.avatarSolidLine.color=e.fillStyle.color,Ce.avatarDashedLine.color=e.fillStyle.color,Ce.avatarDottedLine.color=!0===i.owner._bPrevisualized&&"MeasureThickness"===Xe?Me:t,Ce.dotDashedLine.color=t,Ce.dotLine.color=t,Ce.crossPoint.color=t}}(l),Zt("DimensionGroup")&&qt(a,u,c,l),Zt("AnchorAndAvatar")&&Yt(a,u,c,l),Zt("LableContent")&&(Y=!1,jt(u,l)),O&&Y||!He&&qe||(Nt(),ke.modify({position:i.owner.getAttribute("vLeaderBreakPoint3D")}),xt()),O&&$||qe&&(Nt(),Ie.modify({position:i.owner.getAttribute("vAngleBreakPoint")}),xt()),Zt("Leader")&&Ot(),o=!i.owner.getAttribute("bCollapsedDisplay"),s=1===i.owner._bCreateMeasureInShowSpace?o:!o,Fe.setVisibility(s),Ue.setVisibility(s),Be.setVisibility(s),ze.setVisibility(s),ke&&ke.isVisible()&&!o&&ke.setVisibility(o),Ie&&Ie.isVisible()&&!o&&Ie.setVisibility(o),ke&&1===i.owner._bCreateMeasureInShowSpace&&ke.setVisibilityFree(!ke.isVisible()),Ie&&1===i.owner._bCreateMeasureInShowSpace&&Ie.setVisibilityFree(!Ie.isVisible()),Qe.setName(i.owner.getAttribute("sName")),Qe._updateVisibility()}}},this.updateRepresentation=function(e){if(_t()){var t=e.position.clone(),n=i.owner.getAttribute("vSecondExtensionPoint3D").clone().sub(i.owner.getAttribute("vFirstExtensionPoint3D")),r=n.lengthSq();if(r>1e-6){var a=t;if(0===Te){var o=(new p.Plane).setFromCoplanarPoints(i.owner.getAttribute("vFirstExtensionPoint3D").clone(),i.owner.getAttribute("vFirstPoint3D").clone(),i.owner.getAttribute("vSecondPoint3D").clone()),s=M.getViewpointInfo(me.currentViewpoint),u=E.computeLinePlaneDistance(a.clone().toArray(),s.sight.toArray(),i.owner.getAttribute("vFirstPoint3D").clone().toArray(),o.normal.toArray());a=u&&0===u.returnCode&&u.relationship===l.Relationship.INTERSECTING?new p.Vector3(u.aPosition[0],u.aPosition[1],u.aPosition[2]):o.projectPoint(t)}var c=n.dot(i.owner.getAttribute("vFirstExtensionPoint3D").clone().sub(a))/r,d=n.multiplyScalar(-c).add(i.owner.getAttribute("vFirstExtensionPoint3D")),g=a.clone().sub(d);i.owner.setAttribute("vFirstPoint3D",i.owner.getAttribute("vFirstExtensionPoint3D").clone().add(g)),i.owner.setAttribute("vSecondPoint3D",i.owner.getAttribute("vSecondExtensionPoint3D").clone().add(g)),i.owner.setAttribute("vLeaderBreakPoint3D",a);var b=i.owner.getAttribute("vFirstPoint3D").clone().add(i.owner.getAttribute("vSecondPoint3D")).multiplyScalar(.5);i.owner.setAttribute("vLeaderPointingPoint3D",b)}}else i.owner.setAttribute("vLeaderBreakPoint3D",e.position);i.owner.setAttribute("fBoxRotationAngle",e.rotationAngle),Vt(),i.owner.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:i.owner})},this.getLabelParams=function(){var e={},t=qe&&!He?Ie.getDimensions():ke.getDimensions();return e.position=qe&&!He?i.owner.getAttribute("vAngleBreakPoint"):i.owner.getAttribute("vLeaderBreakPoint3D"),e.rotationAngle=i.owner.getAttribute("fBoxRotationAngle")?i.owner.getAttribute("fBoxRotationAngle"):0,e.width=t.width,e.height=t.height,e},this.hasTessellatedRepresentation=function(){return i.owner.getAttribute("stextGraphicRepresentationAngle")&&i.owner.getAttribute("stextGraphicRepresentationAngle").length||i.owner.getAttribute("sTextGraphicRepresentation")&&i.owner.getAttribute("sTextGraphicRepresentation").length},this.getRepNode=function(){return{avatar:Fe,anchor:Oe,dimensionArrow:Ue,dimensionExtension:Be,leader:ze,box:qe&&!He?Ie.getLabelNode():ke.getLabelNode()}},this.getLabelDimensions=function(){var e=qe&&!He?Ie.getDimensions():ke.getDimensions();return e.position=qe&&!He?i.owner.getAttribute("vAngleBreakPoint"):i.owner.getAttribute("vLeaderBreakPoint3D"),e},this.onViewerEventCB=function(e){"beginExplodeCmd"!==e.eventType&&"endExplodeCmd"!==e.eventType&&"onPreferenceModified"!==e.eventType||Qe.update(null,!0),"MeasureThickness"===Xe&&"@onViewpointChange"===e.eventType&&Ke.LeaderStyleThickness&&(Ke.bSameFirstPoint3D=-1,Qe.update())};var Qt=this.removeDMUNode3DOverload;this.removeDMUNode3DOverload=function(){Qt(),Qe=Ce=Ke=Ne=Ve=ke=Ie=Fe=null,Oe=Ue=Be=ze=me=null},this._updateVisibility=function(e,t){var n=i.owner.isMeasureDisplayed();if(0===i.owner.getAttribute("bCreateMeasureInShowSpace"))n=!!i.owner.getAttribute("bCollapsedDisplay")||!n;else if(n){n=!i.owner.getAttribute("bCollapsedDisplay")}void 0!==e&&(et=e),n=n&&et>0,Qe.setVisibility(n);let r=t&&et<1;Fe&&Fe.setVisibility(!r&&n),Oe&&Oe.setVisibility(!r&&n),Ue&&Ue.setVisibility(!r&&n),Be&&Be.setVisibility(!r&&n),ze&&ze.setVisibility(!r&&n),He&&ke&&ke.setVisibility(n),qe&&Ie&&Ie.setVisibility(n),(0===me.getVisibleSpace()&&!n||1===me.getVisibleSpace()&&n)&&et>0&&Ot(),n&&et>0&&(ke&&ke.setOpacity(et),Ie&&Ie.setOpacity(et)),me.render()},ke=new D({window:i.frmWindow,content:[""],position:i.owner.getAttribute("vLeaderBreakPoint3D"),isFilled:i.owner.getAttribute("bIsFilled"),hasBorder:i.owner.getAttribute("bHasBorder"),graphicProperties:st()}),Qe.linkManipulatorToNode(ke.getBackNode()),rt(this,ke),rt(this,Ie=new D({window:i.frmWindow,content:[""],position:i.owner.getAttribute("vLeaderBreakPoint3D"),isFilled:i.owner.getAttribute("bIsFilled"),hasBorder:i.owner.getAttribute("bHasBorder"),graphicProperties:st()})),rt(this,Fe=new b),rt(this,Oe=new b),rt(this,Ue=new b),rt(this,Be=new b),rt(this,ze=new b),this.update(!0)}})}),define("DS/DMUPlayMeasure/DMUMeasure",["DS/DMUBaseReview/DMUOverloadableObject","DS/DMUMeasurable/DMUMeasureEnums","DS/DMUMeasurable/DMUMeasurable","DS/DMUMeasurable/DMUToolsMeasure","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUMeasurable/DMUToolsMaths","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUBaseExperience/EXPToolsVisualization","DS/CoreEvents/ModelEvents","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/DMUContextManager","DS/DMUMeasurable/DMUToolsInterference","DS/DMUBaseUIControllers/DMUMarkupsController","DS/DMUPlayMeasure/DMUMeasureNode3D","DS/DMUPlayMeasure/DMUMeasureImport","DS/Selection/CSOManager","DS/DMUBaseExperience/EXPUtils","DS/DMUPlayMeasure/DMUMeasureMainValueDisplayUtils"],function(e,t,i,n,r,a,o,s,l,u,c,d,p,g,b,y,h,v){"use strict";var P=[{name:"sType",type:"string",JSONname:"Specifications.Type"},{name:"sSelectedType1",type:"int",JSONname:"Specifications.SelectedType1",defaultValue:-1},{name:"sSelectedType2",type:"int",JSONname:"Specifications.SelectedType2"},{name:"sResultingType1",type:"int",JSONname:"Results.ResultingType1",defaultValue:-1},{name:"sResultingType2",type:"int",JSONname:"Results.ResultingType2"},{name:"oProduct1Name",type:"string",JSONname:"Results.Product1Name"},{name:"oProduct2Name",type:"string",JSONname:"Results.Product2Name"},{name:"fDistance",type:"float",JSONname:"Results.Distance"},{name:"fAngle",type:"float",JSONname:"Results.Angle"},{name:"fProjectedAngleXY",type:"float",JSONname:"Results.ProjectedAngleXY"},{name:"fProjectedAngleYZ",type:"float",JSONname:"Results.ProjectedAngleYZ"},{name:"fProjectedAngleZX",type:"float",JSONname:"Results.ProjectedAngleZX"},{name:"vPosition",type:"Vector3",JSONname:"Results.Position"},{name:"vCenter",type:"Vector3",JSONname:"Results.Center"},{name:"vNormal",type:"Vector3",JSONname:"Results.Normal"},{name:"vCog",type:"Vector3",JSONname:"Results.Cog"},{name:"fLength",type:"float",JSONname:"Results.Length"},{name:"fRadius",type:"float",JSONname:"Results.Radius"},{name:"fArea",type:"float",JSONname:"Results.Area"},{name:"vApex",type:"Vector3",JSONname:"Results.Apex"},{name:"fSemiAngle",type:"float",JSONname:"Results.SemiAngle"},{name:"fVolume",type:"float",JSONname:"Results.Volume"},{name:"bHasALeader",type:"bool",JSONname:"Properties3DText.HasALeader",defaultValue:!0},{name:"vLeaderBreakPoint3D",type:"Vector3",JSONname:"Properties3DText.LeaderBreakPoint3D",defaultValue:new u.Vector3},{name:"vLeaderPointingPoint3D",type:"Vector3",JSONname:"Properties3DText.LeaderPointingPoint3D",defaultValue:new u.Vector3},{name:"fBoxRotationAngle",type:"float",JSONname:"Properties3DText.BoxRotationAngle"},{name:"bShortDisplay",type:"bool",JSONname:"PropertiesMeasure.Shortdisplay",defaultValue:!0},{name:"vFirstPoint3D",type:"Vector3",JSONname:"PropertiesMeasure.FirstPoint3D"},{name:"vSecondPoint3D",type:"Vector3",JSONname:"PropertiesMeasure.SecondPoint3D"},{name:"vFirstExtensionPoint3D",type:"Vector3",JSONname:"PropertiesMeasure.FirstExtensionPoint3D"},{name:"vSecondExtensionPoint3D",type:"Vector3",JSONname:"PropertiesMeasure.SecondExtensionPoint3D"},{name:"vExtensionDirection3D",type:"Vector3",JSONname:"PropertiesMeasure.ExtensionDirection3D"},{name:"bRadiusDisplay",type:"bool",JSONname:"PropertiesMeasure.Radiusdisplay",defaultValue:!1},{name:"bCollapsedDisplay",type:"bool",JSONname:"PropertiesMeasure.Collapseddisplay",defaultValue:!1},{name:"vAngleBreakPoint",type:"Vector3",JSONname:"PropertiesMeasure.AngleBreakPoint"},{name:"fQuadrant",type:"float",JSONname:"PropertiesMeasure.Quadrant"},{name:"vAngleArcCenter",type:"Vector3",JSONname:"PropertiesMeasure.AngleArcCenter"},{name:"vAnglePointingPoint",type:"Vector3",JSONname:"PropertiesMeasure.AnglePointingPoint"},{name:"vAngleVector1",type:"Vector3",JSONname:"PropertiesMeasure.AngleVector1"},{name:"vAngleVector2",type:"Vector3",JSONname:"PropertiesMeasure.AngleVector2"},{name:"aabb",type:"AABB",JSONname:"PropertiesMeasure.aabb"},{name:"bVisible",type:"bool",JSONname:"PropertiesMarkerBase.Visible",defaultValue:!0},{name:"bIsFilled",type:"bool",JSONname:"PropertiesMarkerBase.IsFilled",defaultValue:!0},{name:"bHasBorder",type:"bool",JSONname:"PropertiesMarkerBase.HasBorder",defaultValue:!1},{name:"fFontSize",type:"float",JSONname:"PropertiesMarkerBase.GraphicProperties.FontStyle.fontSize",defaultValue:3.5},{name:"sFontName",type:"string",JSONname:"PropertiesMarkerBase.GraphicProperties.FontStyle.familyName",defaultValue:"sans-serif"},{name:"sFontStyle",type:"string",JSONname:"PropertiesMarkerBase.GraphicProperties.FontStyle.familyStyle",defaultValue:"normal"},{name:"cFontColor",type:"Color",JSONname:"PropertiesMarkerBase.GraphicProperties.FontStyle.color",defaultValue:new u.Color("#ffffff")},{name:"cFillStyleColor",type:"Color",JSONname:"PropertiesMarkerBase.GraphicProperties.FillStyle.color",defaultValue:new u.Color("#368ec4")},{name:"fOpacity",type:"float",JSONname:"PropertiesMarkerBase.GraphicProperties.FillStyle.opacity",defaultValue:1},{name:"fLineStyleThickness",type:"float",JSONname:"PropertiesMarkerBase.GraphicProperties.LineStyle.thickness",defaultValue:1},{name:"fLineStyleThicknessIndex",type:"float",JSONname:"PropertiesMarkerBase.GraphicProperties.LineStyle.thicknessIndex"},{name:"sLineStylePattern",type:"string",JSONname:"PropertiesMarkerBase.GraphicProperties.LineStyle.pattern",defaultValue:"1"},{name:"cLineStyleColor",type:"Color",JSONname:"PropertiesMarkerBase.GraphicProperties.LineStyle.color",defaultValue:new u.Color("#3d3d3d")},{name:"sLeaderStylePattern",type:"string",JSONname:"PropertiesMarkerBase.GraphicProperties.LeaderStyle.pattern"},{name:"fLeaderStyleThicknessIndex",type:"float",JSONname:"PropertiesMarkerBase.GraphicProperties.LeaderStyle.thicknessIndex"},{name:"cLeaderStyleColor",type:"Color",JSONname:"PropertiesMarkerBase.GraphicProperties.LeaderStyle.color"},{name:"cAvatarStyleColor",type:"Color",JSONname:"PropertiesMarkerBase.GraphicProperties.AvatarStylecolor"},{name:"sCommentOnMeasure",type:"string",JSONname:"Comment.TextContents"},{name:"sCommentFontStyle",type:"string",JSONname:"Comment.GraphicProperties.FontStyle.familyStyle"},{name:"sCommentFontName",type:"string",JSONname:"Comment.GraphicProperties.FontStyle.familyName"},{name:"fCommentFontSize",type:"float",JSONname:"Comment.GraphicProperties.FontStyle.fontSize"},{name:"iRadiusResultDisplayType",type:"int",JSONname:"PropertiesMeasure.iRadiusResultDisplayType",defaultValue:0},{name:"vArcMidPoint",type:"Vector3",JSONname:"PropertiesMeasure.vArcMidPoint"},{name:"iExtensionLinesManipulable",type:"int",JSONname:"PropertiesMeasure.iExtensionLinesManipulable"},{name:"sLeaderEndType",type:"string",JSONname:"PropertiesMarkerBase.GraphicProperties.LeaderStyle.sLeaderEndType"},{name:"sPointType",type:"string",JSONname:"PropertiesMarkerBase.GraphicProperties.LeaderStyle.sPointType"},{name:"sExtremityType",type:"string",JSONname:"PropertiesMarkerBase.GraphicProperties.LeaderStyle.sExtremityType"},{name:"sTextGraphicRepresentation",type:"string",JSONname:"Properties3DText.textGraphicRepresentation"},{name:"stextGraphicRepresentationAngle",type:"string",JSONname:"Properties3DText.textGraphicRepresentationAngle"},{name:"sMeasureOnGeometryType",type:"string",JSONname:"Specifications.MeasureOnGeometryType"},{name:"sDistanceType",type:"string",JSONname:"Results.DistanceType"},{name:"bArcLengthDisplay",type:"bool",JSONname:"PropertiesMeasure.ArcLengthDisplay",defaultValue:!1},{name:"bDisplayMeasureType",type:"bool",JSONname:"PropertiesMeasure.DisplayMeasureType",defaultValue:!0},{name:"bDisplayUnit",type:"bool",JSONname:"PropertiesMeasure.DisplayUnit",defaultValue:!0},{name:"sSurfaceDisplayType",type:"string",JSONname:"Results.SurfaceDisplayType"},{name:"sProductDisplayType",type:"string",JSONname:"Results.ProductDisplayType"},{name:"fHeight",type:"float",JSONname:"Results.Height"},{name:"fMaxRadius",type:"float",JSONname:"Results.MaxRadius"},{name:"fLeaderStyleThickness",type:"float",JSONname:"PropertiesMarkerBase.GraphicProperties.LeaderStyle.thickness"},{name:"iFontSize",type:"int",JSONname:"PropertiesMarkerBase.GraphicProperties.FontStyle.height"}];return e.extend({init:function(e,i,n){this._parent(e,i),this.addParameters(P),this._type="DMUMeasure",this._typeApps=n;var r="DS/DMUMeasure/DMUMeasureContextualBar",a=this;this._bCreateMeasureInShowSpace=this._viewer.getVisibleSpace(),this._isInCreationState=!1,this.initAuthoringData=function(){if(-1!==c.getAuthoringFeatureTypes().indexOf("Measure")&&(-1===c.getAuthoringFeatureTypes().indexOf("Measure")||a.getContextualCommandList||require([r],function(e){var t=new e;a.getContextualCommandList=t.getContextualCommandList,a.getSharedContextualCommandList=t.getSharedContextualCommandList,a.getSharedHeaderTypes=t.getSharedHeaderTypes,a.getCmdHdrsFor2DGeometries=t.getCmdHdrsFor2DGeometries,a.getSharedContextualMenuCommandList=t.getSharedContextualMenuCommandList,t.applyStateToContextHdr&&(a.applyStateToContextHdr=t.applyStateToContextHdr),t.getPointTypeHdr&&(a.getPointTypeHdr=t.getPointTypeHdr),t.getExtremityTypeHdr&&(a.getExtremityTypeHdr=t.getExtremityTypeHdr),t.setCheckCmdHdrState&&(a.setCheckCmdHdrState=t.setCheckCmdHdrState),t.register({frmWindow:a._frmWindow});var i=1===y.get().length?y.get()[0].pathElement.clone():null;i&&i.getLastElement(!0).getDMUType&&i.getLastElement(!0)===a.getNode()&&(y.empty(),y.add({pathElement:i}))}),!a.getPropertiesObject&&"ProgressiveVisuLoading"!==n)){require(["DS/DMUMeasure/DMUMeasureProperties"],function(e){var t=new e(a);a.getPropertiesObject=function(){return t}})}},this.removeAuthoringData=function(){-1!==c.getAuthoringFeatureTypes().indexOf("Measure")&&-1!==c.getAuthoringFeatureTypes().indexOf("Measure")&&require([r],function(e){var t=new e;a.getContextualCommandList=null,a.getSharedContextualCommandList=null,a.getSharedHeaderTypes=null,a.getSharedContextualMenuCommandList=null,a.applyStateToContextHdr=null,a.getPointTypeHdr=null,a.getExtremityTypeHdr=null,a.setCheckCmdHdrState=null,t.unregister({frmWindow:a._frmWindow})})};var s=new b(a);this.importData=s.importData,this.afterImport=s.afterImport,this.initAuthoringData();var l=p.getDMUMarkupsController({context:this._viewer,frmWindow:this._frmWindow});l&&l.registerMarker(this),this.getType=function(){return"DMUMeasure"},this.getMeasureType=function(){return this._sType},this.setNode(new g({owner:this,frmWindow:this._frmWindow,getType:this.getType})),this.getPixelFontSize=function(){if(a.getNode())return a.getNode().getPixelFontSize()};var u=this.refreshNode;this.refreshNode=function(e){a._doNotRefresh||!a.getNode()||i.isImporting&&(!i.isImporting||i.isImporting())||(a.getNode().update(!1,e),u())},this.getManipulationData=function(){return this.getNode().getLabelParams()},this.isMeasureDisplayed=function(){return a.isVisible()&&a.getActiveFlag()&&a.isDisplayed()&&a.getAttribute("bVisible")},this.getPrefNameForDistanceType=function(){var e="";if(this._sMeasurable1&&this._sMeasurable2){for(var i="DMUMeasureDistanceType",n=[],r=0;r<2;r++){var s=this.getAttribute("sSelectedType"+(r+1));if(this._objAction||s!==t.ViewedType.POINT&&s!==t.ViewedType.CENTER){var l="_sMeasurable"+(r+1);switch(this[l].getType()){case 0:case 1:n[r]="Point";break;case 2:n[r]="Curve";break;case 3:n[r]="Line";break;case 4:n[r]="Circle",Math.abs(2*Math.PI-this[l].getArcAngle())>.001&&(n[r]="Arc");break;case 5:n[r]="Surface";break;case 6:n[r]="Plane";break;case 7:n[r]="Cylinder";break;case 8:n[r]="Cone";break;case 9:n[r]="Sphere";break;case 10:n[r]="Product"}}else n[r]="Point"}var u="";if(this.getAttribute("sSelectedType1")!==t.ViewedType.POINT&&this.getAttribute("sSelectedType1")!==t.ViewedType.CENTER&&this.getAttribute("sSelectedType2")!==t.ViewedType.POINT&&this.getAttribute("sSelectedType2")!==t.ViewedType.CENTER){var c,d,p=0;a._sMeasurable1._type===o.GeometryType.LINE&&a._sMeasurable2._type===o.GeometryType.LINE?(c=a._sMeasurable1._point2.clone().sub(a._sMeasurable1._point1.clone()),d=a._sMeasurable2._point2.clone().sub(a._sMeasurable2._point1.clone()),0!==(p=c.angleTo(d))&&p!==Math.PI||(u="Parallel")):a._sMeasurable1._type===o.GeometryType.LINE&&a._sMeasurable2._type===o.GeometryType.PLANE||a._sMeasurable1._type===o.GeometryType.PLANE&&a._sMeasurable2._type===o.GeometryType.LINE?(a._sMeasurable1._type===o.GeometryType.LINE?(c=a._sMeasurable1._point2.clone().sub(a._sMeasurable1._point1.clone()),d=a._sMeasurable2._normal):(c=a._sMeasurable1._normal,d=a._sMeasurable2._point2.clone().sub(a._sMeasurable2._point1.clone())),(p=c.angleTo(d))!==.5*Math.PI&&p!==1.5*Math.PI||(u="NormalPerpendicular")):a._sMeasurable1._type===o.GeometryType.LINE&&(a._sMeasurable2._type===o.GeometryType.CYLINDER||a._sMeasurable2._type===o.GeometryType.CONE)||(a._sMeasurable1._type===o.GeometryType.CYLINDER||a._sMeasurable1._type===o.GeometryType.CONE)&&a._sMeasurable2._type===o.GeometryType.LINE?(a._sMeasurable1._type===o.GeometryType.LINE?(c=a._sMeasurable1._point2.clone().sub(a._sMeasurable1._point1.clone()),a._sMeasurable2.getAxis&&(d=a._sMeasurable2.getAxis())):(a._sMeasurable1.getAxis&&(c=a._sMeasurable1.getAxis()),d=a._sMeasurable2._point2.clone().sub(a._sMeasurable2._point1.clone())),0!==(p=c.angleTo(d))&&p!==Math.PI||(u="Parallel")):a._sMeasurable1._type===o.GeometryType.PLANE&&a._sMeasurable2._type===o.GeometryType.PLANE||a._sMeasurable1._type===o.GeometryType.CYLINDER&&a._sMeasurable2._type===o.GeometryType.CYLINDER||a._sMeasurable1._type===o.GeometryType.CYLINDER&&a._sMeasurable2._type===o.GeometryType.CONE||a._sMeasurable1._type===o.GeometryType.CONE&&a._sMeasurable2._type===o.GeometryType.CONE||a._sMeasurable1._type===o.GeometryType.CONE&&a._sMeasurable2._type===o.GeometryType.CYLINDER?(a._sMeasurable1.normal?c=a._sMeasurable1.normal:a._sMeasurable1._normal?c=a._sMeasurable1._normal:a._sMeasurable1.getAxis&&(c=a._sMeasurable1.getAxis()),a._sMeasurable2.normal?d=a._sMeasurable2.normal:a._sMeasurable2._normal?d=a._sMeasurable2._normal:a._sMeasurable2.getAxis&&(d=a._sMeasurable2.getAxis()),0!==(p=c.angleTo(d))&&p!==Math.PI||(u="Parallel")):(a._sMeasurable1._type===o.GeometryType.CYLINDER&&a._sMeasurable2._type===o.GeometryType.PLANE||a._sMeasurable1._type===o.GeometryType.CONE&&a._sMeasurable2._type===o.GeometryType.PLANE||a._sMeasurable1._type===o.GeometryType.PLANE&&a._sMeasurable2._type===o.GeometryType.CYLINDER||a._sMeasurable1._type===o.GeometryType.PLANE&&a._sMeasurable2._type===o.GeometryType.CONE)&&(a._sMeasurable1.normal?c=a._sMeasurable1.normal:a._sMeasurable1._normal?c=a._sMeasurable1._normal:a._sMeasurable1.getAxis&&(c=a._sMeasurable1.getAxis()),a._sMeasurable2.normal?d=a._sMeasurable2.normal:a._sMeasurable2._normal?d=a._sMeasurable2._normal:a._sMeasurable2.getAxis&&(d=a._sMeasurable2.getAxis()),(p=c.angleTo(d))!==.5*Math.PI&&p!==1.5*Math.PI||(u="Parallel"))}e=i+n[0]+n[1]+u+"Preferences",localStorage.getItem(i+n[0]+n[1]+u+"Preferences")||(e=i+n[1]+n[0]+u+"Preferences")}return e},this.setDistanceType=function(){var e=this.getPrefNameForDistanceType();if(""!==e){var t=localStorage.getItem(e);this.setAttribute("sDistanceType",t)}};var d=this.updateRepresentation;this.updateRepresentation=function(e,t){d(e,t),this.refreshAssistantTool(e,t)}},setAttribute:function(e,t){"fFontSize"===e?this.setAttribute("iFontSize",null):"fLineStyleThicknessIndex"===e?this._parent("fLineStyleThickness",null):"fLeaderStyleThicknessIndex"===e&&this._parent("fLeaderStyleThickness",null),this._parent(e,t)},update2DArcDisplay:function(){if(this.getAttribute("sResultingType1")===t.ResultType.CIRCLE){var e=this._sMeasurable1.getArcAngle();this.getAttribute("bArcLengthDisplay")&&e&&Math.abs(2*Math.PI-e)>.001?(this.setAttribute("sLeaderEndType","Arrow"),this.setAttribute("sExtremityType","FullCircle")):(this._sLeaderEndType&&(this._sLeaderEndType=void 0),this._sExtremityType&&(this._sExtremityType=void 0))}},updateGlobalRadiusPreference:function(e){var i;switch(i=!0===e?"DisplayRadius":"DisplayDiameter",this.getAttribute("sResultingType1")){case t.ResultType.CIRCLE:"2D"===this.getAttribute("sMeasureOnGeometryType")&&Math.abs(2*Math.PI-this._sMeasurable1._arcAngle)>.001?localStorage.setItem("DMUMeasureArcRadiusPreferences",i):localStorage.setItem("DMUMeasureCircleRadiusPreferences",i);break;case t.ResultType.CYLINDER:localStorage.setItem("DMUMeasureCylinderRadiusPreferences",i);break;case t.ResultType.SPHERE:localStorage.setItem("DMUMeasureSphereRadiusPreferences",i)}},updateFeatureAndDistanceTypePreference:function(e){if(e){this.setAttribute("sDistanceType",e);var t=this.getPrefNameForDistanceType();""!==t&&localStorage.setItem(t,e)}switch(this._local2DDistancePref){case"DMUMeasBetween2CirclesDistancePref":localStorage.setItem("DMUMeasBetween2CirclesDistancePref",e);break;case"DMUMeasBetweenCircleArcDistancePref":localStorage.setItem("DMUMeasBetweenCircleArcDistancePref",e);break;case"DMUMeasBetweenCircleAnygeomDistancePref":localStorage.setItem("DMUMeasBetweenCircleAnygeomDistancePref",e);break;case"DMUMeasBetween2ArcsDistancePref":localStorage.setItem("DMUMeasBetween2ArcsDistancePref",e);break;case"DMUMeasBetweenArcAnygeomDistancePref":localStorage.setItem("DMUMeasBetweenArcAnygeomDistancePref",e);break;case"DMUMeasBetween2ParallelLinesDistancePref":localStorage.setItem("DMUMeasBetween2ParallelLinesDistancePref",e);break;case"DMUMeasBetween2LinesDistancePref":localStorage.setItem("DMUMeasBetween2LinesDistancePref",e);break;case"DMUMeasBetween2AnyGeomsDistancePref":localStorage.setItem("DMUMeasBetween2AnyGeomsDistancePref",e)}},updateFeatureAndSurfaceDisplayTypePreference:function(e){if(e)switch(this.setAttribute("sSurfaceDisplayType",e),this._sResultingType1){case t.ResultType.CYLINDER:localStorage.setItem("DMUMeasSurfaceDisplayCylinderPref",e);break;case t.ResultType.CONE:localStorage.setItem("DMUMeasSurfaceDisplayConePref",e);break;case t.ResultType.SPHERE:localStorage.setItem("DMUMeasSurfaceDisplaySpherePref",e)}this.updateMainValueDisplayAsPerPref()},updateFeatureAndProductDisplayTypePreference:function(e){e&&(this.setAttribute("sProductDisplayType",e),localStorage.setItem("DMUMeasProductDisplayPref",e)),this.updateMainValueDisplayAsPerPref()},updateGlobalRadiusResultDisplayPreference:function(e){var i,n;"MeasureItem"===this.getAttribute("sType")&&this.getAttribute("sResultingType1")===t.ResultType.CIRCLE?(n="DMUMeasureRadiusResultDisplayPreferences",i="TANGENT",0===e&&(i="CENTER")):"Measure3PointsCircle"===this.getAttribute("sType")&&(n="DMUMeasure3PointsCircleRadiusResultDisplayPreferences",i="TANGENT",0===e&&(i="CENTER")),void 0!==i&&void 0!==n&&localStorage.setItem(n,i)},updateMainValueDisplayAsPerPref:function(){var e,i,n=localStorage.getItem("DMUMeasureMainValueDisplay");n&&n.length&&(n=JSON.parse(n));var r;if("MeasureItem"===this._sType){var a=this.getAttribute("sResultingType1");switch(a){case t.ResultType.POINT:case t.ResultType.PICKINGPT:case t.ResultType.CENTER:i="Coordinates";break;case t.ResultType.CURVE:i="Curve_Length";break;case t.ResultType.LINE:i="Line_Length";break;case t.ResultType.CIRCLE:i=this.getAttribute("bArcLengthDisplay")?"Arc_Length":this.getAttribute("bRadiusDisplay")?"Radius":"Diameter";break;case t.ResultType.CYLINDER:case t.ResultType.SPHERE:var o=this.getAttribute("sSurfaceDisplayType");i=a===t.ResultType.CYLINDER&&"Length"===o?"Line_Length":"Area"===o?"Area":this.getAttribute("bRadiusDisplay")?"Radius":"Diameter";break;case t.ResultType.PLANE:case t.ResultType.SURFACE:i="Area";break;case t.ResultType.CONE:i="Half_Angle";var s=this.getAttribute("sSurfaceDisplayType");"HalfAngle"===s?i="Half_Angle":"Angle"===s?i="Angle":"Length"===s?i="Line_Length":"MaximumRadius"===s?i="Max_Radius":"MaximumDiameter"===s?i="Max_Diameter":"MinimumRadius"===s?i="Min_Radius":"MinimumDiameter"===s?i="Min_Diameter":"Area"===s&&(i="Area");break;case t.ResultType.PRODUCT:i="Volume","Area"===this.getAttribute("sProductDisplayType")&&(i="Area")}}else if("MeasureBetween"===this._sType){switch(this.getAttribute("sDistanceType")){case"Angle":i="Angle";break;case"Distance":i="Distance";break;case"MinimumDistance":case"LocalMinimumDistance":i="Min_Distance";break;case"MaximumDistance":case"LocalMaximumDistance":i="Max_Distance";break;default:"Min_Distance"}}else if("MeasureThickness"===this._sType)i="Thickness";else if("Measure3PointsCircle"===this._sType)i=this.getAttribute("bRadiusDisplay")?"Radius":"Diameter";else if("Measure3PointsAngle"===this._sType){i="Angle","Angle"===this.getAttribute("sDistanceType")||(i=this.getAttribute("bRadiusDisplay")?"Radius":"Diameter")}i&&(this.setAttribute("bDisplayMeasureType",(r=i,e=!0,n&&r&&n[r]&&void 0!==n[r].measureTypes?e=v.isPrefEnabled(n[r].measureTypes):v&&r&&v.MeasureTypes&&v.MeasureTypes[r]&&v.MeasureTypes[r].defaultMainValueDisplay&&(e=v.isPrefEnabled(v.MeasureTypes[r].defaultMainValueDisplay)),e)),this.setAttribute("bDisplayUnit",function(t){return e=!0,n&&t&&n[t]&&void 0!==n[t].unitDisplay?e=v.isPrefEnabled(n[t].unitDisplay):v&&t&&v.MeasureTypes&&v.MeasureTypes[t]&&v.MeasureTypes[t].defaultUnitDisplay&&(e=v.isPrefEnabled(v.MeasureTypes[t].defaultUnitDisplay)),e}(i)))},getMeasurable:function(e){return this["_sMeasurable"+e]},setMeasurable:function(e,t){var i=this;if(this["_sMeasurable"+e])for(var n=this["_sMeasurableNode"+e],a=this["_sMeasurableToken"+e],o=0;o<n.length;o++)n[o].modelEvents.unsubscribe(a[o]);if(this["_sMeasurable"+e]=t,t){var s=[],u=[],c=t.getPathElement(),d=t.getLevel(),p=d?r.truncatePathElement(c,d).externalPath:c.externalPath,g={event:"move"};this.updateAfterEvent=function(){i.update()};for(var b=0;b<p.length;b++){var y=p[b];r.isInstance(y)&&(void 0===y.modelEvents&&(y.modelEvents=new l),s.push(y),u.push(y.modelEvents.subscribe(g,this.updateAfterEvent)))}this["_sMeasurableNode"+e]=s,this["_sMeasurableToken"+e]=u}},remove:function(){var e=p.giveDMUMarkupsController({context:this._viewer});if(e&&e.unregisterMarker(this),p.unreferenceDMUMarkupsController({context:this._viewer}),this._parent(),this._paneltop&&this._paneltop.destroy(),this.setMeasurable(1,void 0),this.setMeasurable(2,void 0),this.setMeasurable(3,void 0),this._lockedNodes){var t=c.getContextViewer({viewer:this._viewer});t.getController&&t.getController().unlockNodes({ids:this._lockedNodes}),this.clearLockedNodes()}},update:function(){this._doNotRefresh=!0;var e,s=[],l=[],p=[],g={},b="NA",y="NA",v="NA",P=!1;if("2D"===this.getAttribute("sMeasureOnGeometryType")&&(P=!0),"MeasureItem"===this._sType){var m=(g=n.measureItem(this._sMeasurable1,this.getAttribute("sSelectedType1"))).position;this._sResultingType1===t.ResultType.CIRCLE&&0===this.getAttribute("iRadiusResultDisplayType")&&(m=g.arcMidPoint.clone()),p.push({attribute:"vLeaderPointingPoint3D",value:m}),p.push({attribute:"vLeaderBreakPoint3D",value:m}),this._oProduct1=g.product,s.push(this._oProduct1),l.push(this._sMeasurable1._pathElement);var A=this.getAttribute("sSurfaceDisplayType");switch(this._sResultingType1){case t.ResultType.POINT:case t.ResultType.PICKINGPT:case t.ResultType.CENTER:b="Cross",y="None",p.push({attribute:"vPosition",value:g.position});break;case t.ResultType.LINE:case t.ResultType.AXIS:case t.ResultType.CURVE:this._sMeasurable1._type===o.GeometryType.CIRCLE?p.push({attribute:"fLength",value:g.arcLength}):p.push({attribute:"fLength",value:g.length}),this._sResultingType1!==t.ResultType.LINE&&this._sResultingType1!==t.ResultType.CURVE||(v="FullCircle"),this._sResultingType1!==t.ResultType.AXIS&&this._sResultingType1!==t.ResultType.CURVE||(b="Arrow");break;case t.ResultType.CIRCLE:p.push({attribute:"fRadius",value:g.radius}),p.push({attribute:"vCenter",value:g.center}),p.push({attribute:"vNormal",value:g.normal}),p.push({attribute:"vArcMidPoint",value:g.arcMidPoint});var D=this._sMeasurable1.getArcAngle();P&&this.getAttribute("bArcLengthDisplay")&&D&&Math.abs(2*Math.PI-D)>.001&&(b="Arrow",v="FullCircle");break;case t.ResultType.PLANE:b="Bubble",p.push({attribute:"vOrigin",value:g.origin}),p.push({attribute:"vNormal",value:g.normal}),p.push({attribute:"fArea",value:g.area}),p.push({attribute:"vCog",value:g.cog});break;case t.ResultType.CYLINDER:p.push({attribute:"fRadius",value:g.radius}),p.push({attribute:"fArea",value:g.area}),p.push({attribute:"vCog",value:g.cog}),p.push({attribute:"fHeight",value:g.height}),this._vPoint1=g.point1,this._vPoint2=g.point2,this._vAxis=g.point2.clone().sub(g.point1);var M=this._vPoint1.clone().add(this._vPoint2).multiplyScalar(.5);p.push({attribute:"vCenter",value:M}),this._sMeasurable1.center=M.clone(),this._sMeasurable1.normal=this._vAxis.clone(),e=["sLeaderEndType","sExtremityType","sPointType"],this._removeAttribute(e),"Length"===A?v="FullCircle":"Area"===A&&(b="Bubble");break;case t.ResultType.CONE:p.push({attribute:"vApex",value:g.apex}),p.push({attribute:"fSemiAngle",value:g.semiAngle}),p.push({attribute:"fArea",value:g.area}),p.push({attribute:"vCog",value:g.cog}),p.push({attribute:"fRadius",value:g.minRadius}),p.push({attribute:"fMaxRadius",value:g.maxRadius}),p.push({attribute:"fHeight",value:g.height}),this._vPoint1=g.point1,this._vPoint2=g.point2,this._vAxis=g.axis,p.push({attribute:"vCenter",value:this._vPoint2.clone()}),e=["sLeaderEndType","sExtremityType","sPointType"],this._removeAttribute(e),"Length"===A?v="FullCircle":"Area"===A&&(b="Bubble");break;case t.ResultType.SPHERE:p.push({attribute:"fRadius",value:g.radius}),p.push({attribute:"vCenter",value:g.center}),p.push({attribute:"fArea",value:g.area}),p.push({attribute:"vCog",value:g.cog});break;case t.ResultType.SURFACE:b="Bubble",p.push({attribute:"fArea",value:g.area}),p.push({attribute:"vCog",value:g.cog});break;case t.ResultType.PRODUCT:b="Square";this._removeAttribute(["fVolume","fArea","vCog","aabb","fLength"]),g.volume&&g.volume>0&&p.push({attribute:"fVolume",value:g.volume}),g.area&&g.area>0&&p.push({attribute:"fArea",value:g.area}),g.cog&&p.push({attribute:"vCog",value:g.cog}),g.aabb&&p.push({attribute:"aabb",value:g.aabb}),g.length&&g.length>0&&p.push({attribute:"fLength",value:g.length})}"NA"!==b&&p.push({attribute:"sLeaderEndType",value:b}),"NA"!==y&&p.push({attribute:"sPointType",value:y}),"NA"!==v&&p.push({attribute:"sExtremityType",value:v}),this.set(p),this._buildConstructionData(g)}else if("MeasureBetween"===this._sType){if(P){var f=this.getAttribute("sSelectedType1"),w=this.getAttribute("sSelectedType2"),S=this.getAttribute("sDistanceType");"Distance"!==S&&(f===t.ViewedType.POINT&&w===t.ViewedType.POINT||this.getAttribute("sResultingType1")===t.ResultType.POINT&&this.getAttribute("sResultingType2")===t.ResultType.POINT)&&(S="Distance",this.setAttribute("sDistanceType",S)),g=n.measureBetween2DGeometries(S,this._sMeasurable1,f,this._sMeasurable2,w)}else g=n.measureBetween(this._sMeasurable1,this.getAttribute("sSelectedType1"),this._sMeasurable2,this.getAttribute("sSelectedType2"),!1,this.getAttribute("sDistanceType"),h.isEnvActivated("measurebetweenCylConeOldAlgo",!0));if(void 0!==g.aPosition1&&void 0!==g.aPosition2){g.product1&&(this._oProduct1=g.product1,this._oProduct1.externalPath&&this._oProduct1.getLength()>0?s.push(this._oProduct1.getLastElement()):s.push(this._oProduct1)),l.push(this._sMeasurable1._pathElement),g.product2&&(this._oProduct2=g.product2,this._oProduct2.externalPath&&this._oProduct2.getLength()>0?s.push(this._oProduct2.getLastElement()):s.push(this._oProduct2)),l.push(this._sMeasurable2._pathElement),this._duration=g.duration,p.push({attribute:"fDistance",value:void 0!==g.distance?g.distance:0});var T=void 0!==g.angle?g.angle:0;p.push({attribute:"fAngle",value:T}),void 0===T||a.isZero(T)||p.push({attribute:"fQuadrant",value:0}),p.push({attribute:"sSelectedType1",value:g.type1}),p.push({attribute:"sSelectedType2",value:g.type2}),a.isZero(T)?this.getAttribute("sResultingType1")===t.ResultType.PLANE&&this.getAttribute("sResultingType2")===t.ResultType.PLANE?y="FullCircle":this.getAttribute("sResultingType1")===t.ResultType.AXIS&&this.getAttribute("sResultingType2")===t.ResultType.AXIS||(y="Cross"):P&&"Angle"!==this.getAttribute("sDistanceType")&&(y="Cross"),e=["sLeaderEndType","sExtremityType","sPointType"],this._removeAttribute(e),"NA"!==y&&p.push({attribute:"sPointType",value:y}),this.set(p),this._buildConstructionData(g)}}else if("MeasureThickness"===this._sType){var R=this._sMeasurable1.getSelPoint(),C=this._sMeasurable1.getSelNormal(),L=C.clone().negate(),E=C.clone().normalize().multiplyScalar(.1).add(R),_=d.computeRayProductInterferences(E.toArray(),L.toArray(),[this._sMeasurable1.getPathElement()]),x=[];0===_.returnCode&&(x=_.aIntersections);var N,V=x&&x.length>0&&x[0].primitive?THREEDS.SubElement.getFromSGNode(x[0].primitive):void 0;N=!!V&&3===V.getBodyDimension()?function(e,t){var n=new u.Matrix4;t&&t.getWorldMatrix?n.getInverse(t.getWorldMatrix()):(n.makeBasis(new u.Vector3(1,0,0),new u.Vector3(0,1,0),new u.Vector3(0,0,1)),n.setPosition(new u.Vector3(0,0,0)));var r=e.point.clone();r.applyMatrix4(n);var a={type:o.GeometryType.POINT,primitive:e.primitive,position:r};return new i({canonic:a,pathElement:t})}(x[1],this._sMeasurable1.getPathElement()):this._sMeasurable1.clone(),this.setMeasurable(2,N),p.push({attribute:"sSelectedType1",value:t.ViewedType.POINT}),p.push({attribute:"sSelectedType2",value:t.ViewedType.POINT}),p.push({attribute:"sResultingType1",value:t.ResultType.POINT}),p.push({attribute:"sResultingType2",value:t.ResultType.POINT}),g=n.measureBetween(this._sMeasurable1,t.ViewedType.POINT,this._sMeasurable2,t.ViewedType.POINT),this._oProduct1=g.product1,s.push(this._oProduct1),l.push(this._sMeasurable1._pathElement),this._oProduct2=g.product2,s.push(this._oProduct2),l.push(this._sMeasurable2._pathElement),p.push({attribute:"fDistance",value:void 0!==g.distance?g.distance:0}),p.push({attribute:"fAngle",value:0}),this.set(p),this._buildConstructionData(g)}else"Measure3PointsCircle"===this._sType?(e=["sLeaderEndType","sExtremityType"],this._removeAttribute(e),y="Cross",p.push({attribute:"sPointType",value:y}),g=n.measureThreepoints(this._sMeasurable1,this._sMeasurable2,this._sMeasurable3),p.push({attribute:"fRadius",value:g.radius}),p.push({attribute:"fAngle",value:g.angle}),p.push({attribute:"vCenter",value:g.center.clone()}),p.push({attribute:"vNormal",value:g.normal.clone()}),this.set(p),g.position=g.center.clone(),this._buildConstructionData(g)):"Measure3PointsAngle"===this._sType&&(e=["sLeaderEndType","sExtremityType"],this._removeAttribute(e),y="Cross",p.push({attribute:"sPointType",value:y}),g=n.measureThreepoints(this._sMeasurable1,this._sMeasurable2,this._sMeasurable3),p.push({attribute:"fRadius",value:g.radius}),p.push({attribute:"fAngle",value:g.angle}),p.push({attribute:"vCenter",value:g.center.clone()}),p.push({attribute:"vNormal",value:g.normal.clone()}),this.set(p),g.position=this._sMeasurable2.getSelPoint(),this._buildConstructionData(g));this._doNotRefresh=!1;var k=this;if(!P&&s.length>0){var I=[0,1];if(s.length>0&&"3dPlay"!==k._typeApps)for(var F=l.length,O=0;O<F;O++)r.getNameWithInstances(l[O],function(e){void 0!==e.name&&(k["_oProduct"+(I[e.forPathNum]+1)+"Name"]=e.name,k.refreshNode(!(k._bPrevisualized&&"MeasureThickness"===k._sType)))},c.getContextViewer({viewer:this._viewer}),O)}this.updateMainValueDisplayAsPerPref(),this.refreshNode(!(this._bPrevisualized&&"MeasureThickness"===this._sType))},addLockedNode:function(e){void 0===this._lockedNodes&&(this._lockedNodes=[]),this._lockedNodes.push(e)},getLockedNodes:function(){return this._lockedNodes},isNodeLocked:function(e){var t=!1;return this._lockedNodes&&-1!==this._lockedNodes.indexOf(e)&&(t=!0),t},clearLockedNodes:function(){this._lockedNodes=[]},_buildConstructionData:function(e){var i,n,r,o,l,c,d,p,g,b,y,h,v,P,m,A,D,M,f,w=30,S=[];if("MeasureItem"===this._sType){var T=this.getAttribute("sSurfaceDisplayType");switch(this._sResultingType1){case t.ResultType.POINT:case t.ResultType.PICKINGPT:this._buildConstructionPointsForLeader(1.4*w,e.position);break;case t.ResultType.CENTER:this._buildConstructionPointsForLeader(1.4*w,e.center);break;case t.ResultType.LINE:this._buildConstructionPointsForDimension(w,e.point1,e.point2);break;case t.ResultType.AXIS:this._buildConstructionPointsForLeader(w,e.point1.clone().add(e.point2).multiplyScalar(.5));break;case t.ResultType.CIRCLE:var R=[];if(n=this.getAttribute("fRadius"),r=this.getAttribute("vNormal"),w=.2*n,l=s.getViewpointInfo(this._viewer.currentViewpoint),o=(new u.Vector3).crossVectors(r,l.sight),i=this.getAttribute("vCenter"),0!==this.getAttribute("iRadiusResultDisplayType"))o=this.getAttribute("vArcMidPoint").clone().sub(i);if(o.length()>.001?o.normalize().multiplyScalar(n):o=l.right.clone().normalize().multiplyScalar(n),b=(new u.Vector3).crossVectors(r,o).normalize(),Math.abs(r.angleTo(l.sight)-Math.PI/2)<Math.PI/10?((b=r.clone().normalize()).dot(l.up)<0&&b.negate(),y=b.clone().multiplyScalar(w)):y=b.clone().multiplyScalar(w+n),0!==this.getAttribute("iRadiusResultDisplayType")&&(y=b.clone().multiplyScalar(w+n)),R.push({attribute:"iExtensionLinesManipulable",value:0}),h=i.clone().add(o),v=i.clone().sub(o),p=h.clone().add(y),g=v.clone().add(y),0===this.getAttribute("iRadiusResultDisplayType")){var C=this._sMeasurable1.getSelPoint().clone().sub(i.clone());C=C.normalize();var L=n+s.getDistanceFromPixel(this._viewer,this._sMeasurable1.getSelPoint().clone(),70);C=C.multiplyScalar(L),P=i.clone().add(C)}else P=p.clone().add(g).multiplyScalar(.5);R.push({attribute:"vLeaderBreakPoint3D",value:P}),R.push({attribute:"vLeaderPointingPoint3D",value:P}),R.push({attribute:"vFirstPoint3D",value:p}),R.push({attribute:"vSecondPoint3D",value:g}),R.push({attribute:"vFirstExtensionPoint3D",value:h}),R.push({attribute:"vSecondExtensionPoint3D",value:v}),R.push({attribute:"vExtensionDirection3D",value:b}),this.set(R);break;case t.ResultType.CURVE:this._buildConstructionPointsForLeader(w,e.position);break;case t.ResultType.PLANE:case t.ResultType.SURFACE:void 0!==this._sMeasurable1.getSelPoint()?this._buildConstructionPointsForLeader(w,e.position):this._buildConstructionPointsForLeader(w,this.getAttribute("vCog"));break;case t.ResultType.CYLINDER:n=this.getAttribute("fRadius"),i=this.getAttribute("vCenter"),l=s.getViewpointInfo(this._viewer.currentViewpoint),(o=(new u.Vector3).crossVectors(this._vAxis,l.sight)).length()>.001?o.normalize().multiplyScalar(n):o=l.right.clone().normalize().multiplyScalar(n),c=i.clone().add(o),d=i.clone().sub(o),"Length"===T?this._buildConstructionPointsForDimension(w,this.getAttribute("vPoint1"),this.getAttribute("vPoint2")):"Area"===T?void 0!==this._sMeasurable1.getSelPoint()?this._buildConstructionPointsForLeader(w,e.position):this._buildConstructionPointsForLeader(w,this.getAttribute("vCog")):this._buildConstructionPointsForLeader(w,c,d);break;case t.ResultType.CONE:var E=this.getAttribute("vApex"),_=this.getAttribute("fSemiAngle");i=this.getAttribute("vCenter"),n=E.clone().sub(this._vPoint2).length()*Math.tan(_),l=s.getViewpointInfo(this._viewer.currentViewpoint),(o=(new u.Vector3).crossVectors(this._vAxis,l.sight)).length()>.001?o.normalize().multiplyScalar(n):o=l.right.clone().normalize().multiplyScalar(n),c=i.clone().add(o),d=i.clone().sub(o),"Length"===T?this._buildConstructionPointsForDimension(w,this.getAttribute("vPoint1"),this.getAttribute("vPoint2")):"Area"===T?void 0!==this._sMeasurable1.getSelPoint()?this._buildConstructionPointsForLeader(w,e.position):this._buildConstructionPointsForLeader(w,this.getAttribute("vCog")):this._buildConstructionPointsForLeader(w,c,d);break;case t.ResultType.SPHERE:n=this.getAttribute("fRadius"),i=this.getAttribute("vCenter"),o=(l=s.getViewpointInfo(this._viewer.currentViewpoint)).right.clone().normalize().multiplyScalar(n),c=i.clone().add(o),d=i.clone().sub(o),this._buildConstructionPointsForLeader(w,c,d);break;case t.ResultType.PRODUCT:this._buildConstructionPointsForLeader(w,this.getAttribute("vLeaderPointingPoint3D"))}}else if("MeasureBetween"===this._sType||"MeasureThickness"===this._sType){if(this._sResultingType1===t.ResultType.PLANE&&this._sResultingType2===t.ResultType.PLANE)if(0===this.getAttribute("fDistance")&&0!==this.getAttribute("fAngle"))p=e.position2.clone(),g=e.position1.clone();else{var x=e.position2.clone().sub(e.position1);g=(p=e.position1.clone()).clone().add(x)}else p=e.position1.clone(),g=e.position2.clone();var N,V,k=this.getAttribute("sDistanceType");if("Distance"!==k&&"MinimumDistance"!==k&&"MaximumDistance"!==k||!e.extensionDirection?"Angle"!==k&&S.push({attribute:"iExtensionLinesManipulable",value:1}):S.push({attribute:"iExtensionLinesManipulable",value:0}),this._buildConstructionPointsForDimension(w,p,g,e.extensionDirection),"MeasureBetween"===this._sType)void 0===(f=this.getAttribute("fAngle"))||a.isZero(f)||(h=this.getAttribute("vFirstExtensionPoint3D"),v=this.getAttribute("vSecondExtensionPoint3D"),this.computeAngleVector=function(e,i,n,r){var o,s,l,u;return e===t.ViewedType.CYCOSP||e===t.ViewedType.AXIS?(s=(o=i.beginPoint.clone().sub(n)).length(),u=(l=i.endPoint.clone().sub(n)).length(),(a.isZero(s)||u<s&&!a.isZero(u))&&(o=l)):(o=r.clone().sub(n),a.isZero(o.length())&&(s=(o=i.beginPoint.clone().sub(n)).length(),u=(l=i.endPoint.clone().sub(n)).length(),(a.isZero(s)||u<s&&!a.isZero(u))&&(o=l))),o},m=this.computeAngleVector(this._sSelectedType1,this._sMeasurable1.getPoints(),h,this._sMeasurable1.getSelPoint()),A=this.computeAngleVector(this._sSelectedType2,this._sMeasurable2.getPoints(),v,this._sMeasurable2.getSelPoint()),f=m.angleTo(A),D=m.clone().add(A),M=Math.min(m.length(),A.length())/2,N=v,V=D.normalize().multiplyScalar(M).add(N)),S.push({attribute:"fAngle",value:f}),S.push({attribute:"vAngleArcCenter",value:N}),S.push({attribute:"vAnglePointingPoint",value:V}),S.push({attribute:"vAngleBreakPoint",value:V}),S.push({attribute:"vAngleVector1",value:m}),S.push({attribute:"vAngleVector2",value:A}),this.set(S)}else if("Measure3PointsCircle"===this._sType)n=this.getAttribute("fRadius"),r=this.getAttribute("vNormal"),i=this.getAttribute("vCenter"),S.push({attribute:"fAngle",value:0}),w=.2*n,l=s.getViewpointInfo(this._viewer.currentViewpoint),(o=(new u.Vector3).crossVectors(r,l.sight)).length()>.001?o.normalize().multiplyScalar(n):o=l.right.clone().normalize().multiplyScalar(n),y=(b=(new u.Vector3).crossVectors(r,o).normalize()).clone().multiplyScalar(w+n),h=i.clone().add(o),v=i.clone().sub(o),p=h.clone().add(y),g=v.clone().add(y),P=0===this.getAttribute("iRadiusResultDisplayType")?h.clone():this.getAttribute("bRadiusDisplay")?g.clone().sub(p).multiplyScalar(.25).add(p):p.clone().add(g).multiplyScalar(.5),S.push({attribute:"vExtensionDirection3D",value:b}),S.push({attribute:"vFirstExtensionPoint3D",value:h}),S.push({attribute:"vSecondExtensionPoint3D",value:v}),S.push({attribute:"vFirstPoint3D",value:p}),S.push({attribute:"vSecondPoint3D",value:g}),S.push({attribute:"vLeaderBreakPoint3D",value:P}),S.push({attribute:"vLeaderPointingPoint3D",value:P.clone()}),this.set(S);else if("Measure3PointsAngle"===this._sType){S.push({attribute:"fDistance",value:0}),m=this._sMeasurable1.getSelPoint().sub(this._sMeasurable2.getSelPoint()),A=this._sMeasurable3.getSelPoint().sub(this._sMeasurable2.getSelPoint()),D=m.clone().add(A),M=Math.min(m.length(),A.length())/2;var I=D.normalize().multiplyScalar(M).add(this._sMeasurable2.getSelPoint());f=m.angleTo(A),S.push({attribute:"fAngle",value:f}),S.push({attribute:"vAngleVector1",value:m}),S.push({attribute:"vAngleVector2",value:A}),S.push({attribute:"vAngleArcCenter",value:this._sMeasurable2.getSelPoint()}),S.push({attribute:"vAnglePointingPoint",value:I.clone()}),S.push({attribute:"vAngleBreakPoint",value:I.clone()}),S.push({attribute:"vLeaderBreakPoint3D",value:I.clone()}),S.push({attribute:"vLeaderPointingPoint3D",value:I.clone()}),S.push({attribute:"vFirstExtensionPoint3D",value:I.clone()}),S.push({attribute:"vSecondExtensionPoint3D",value:I.clone()}),S.push({attribute:"vFirstPoint3D",value:I.clone()}),S.push({attribute:"vSecondPoint3D",value:I.clone()}),this.set(S)}},_buildConstructionPointsForConeCylSphere:function(){var e,i,n,r,a,o,l,c={oPos1:void 0,oPos2:void 0};if(this._sResultingType1===t.ResultType.CONE){var d=this._sMeasurable1.getApex(),p=this._sMeasurable1.getSemiAngle(),g=this.getAttribute("sSurfaceDisplayType");n=this._sMeasurable1.getPoints(),e="MinimumRadius"===g||"MinimumDiameter"===g?n.beginPoint:n.endPoint;var b=d.clone().sub(e).length()*Math.tan(p)/Math.sin(p);void 0===(l=this._sMeasurable1.getSelPoint())&&(e=this.getAttribute("vCenter"),o=d.clone().sub(e).length()*Math.tan(p),a=s.getViewpointInfo(this._viewer.currentViewpoint),(r=(new u.Vector3).crossVectors(this._vAxis,a.sight)).length()>.001?r.normalize().multiplyScalar(o):r=a.right.clone().normalize().multiplyScalar(o),l=e.clone().add(r));var y=l.clone().sub(d);y=y.normalize().multiplyScalar(b),c.oPos1=d.clone().add(y),this._sMeasurable1.vSlat=y,this._sMeasurable1.vAxis=e.clone().sub(d);var h=d.clone().sub(n.beginPoint).length()*Math.tan(p);if(h>.001){var v=h/Math.sin(p);this._sMeasurable1.arcRadius=v+Math.abs(b-v)/2}else this._sMeasurable1.arcRadius=b/2;i=c.oPos1.clone().sub(e),c.oPos2=e.clone().sub(i);var P,m=c.oPos2.clone().sub(d);this._sMeasurable1.vSlat1=m,P="Angle"===g?this._sMeasurable1.vAxis.clone():y.clone().add(this._sMeasurable1.vAxis),this._sMeasurable1.arcCenter=P.normalize().multiplyScalar(this._sMeasurable1.arcRadius).add(d.clone())}else if(this._sResultingType1===t.ResultType.CYLINDER){void 0===(l=this._sMeasurable1.getSelPoint())&&(o=this.getAttribute("fRadius"),a=s.getViewpointInfo(this._viewer.currentViewpoint),(r=(new u.Vector3).crossVectors(this._vAxis,a.sight)).length()>.001?r.normalize().multiplyScalar(o):r=a.right.clone().normalize().multiplyScalar(o),l=r),n=this._sMeasurable1.getPoints();var A=l.clone().sub(n.beginPoint),D=l.clone().sub(n.endPoint);e=n.beginPoint,D.length()<A.length()&&(e=n.endPoint);var M=n.beginPoint.clone().sub(n.endPoint);i=(i=(new u.Plane).setFromNormalAndCoplanarPoint(M.normalize(),e).projectPoint(l).clone().sub(e)).clone().normalize().multiplyScalar(this._sMeasurable1.getRadius()),c.oPos1=e.clone().add(i),c.oPos2=e.clone().sub(i)}else if(this._sResultingType1===t.ResultType.SPHERE){var f=(a=s.getViewpointInfo(this._viewer.currentViewpoint)).up.clone();f=f.negate(),e=this._sMeasurable1.getCenter();var w=this._sMeasurable1.getRadius(),S=this._sMeasurable1.getSelPoint();void 0===S&&(S=e.clone().add(a.right.clone().normalize().multiplyScalar(w))),i=(i=S.clone().sub(e)).normalize().multiplyScalar(w);var T=(new u.Vector3).crossVectors(f,i.clone().normalize());this._sMeasurable1.normal=T,c.oPos1=e.clone().add(i),c.oPos2=e.clone().sub(i)}return c},_buildConstructionPointsForLeader:function(e,i,n){var r=[],o=s.getDistanceFromPixel(this._viewer,i,e,this._frmWindow),l=s.getViewpointInfo(this._viewer.currentViewpoint).up.clone().multiplyScalar(o);if(this._sResultingType1===t.ResultType.CONE||this._sResultingType1===t.ResultType.CYLINDER||this._sResultingType1===t.ResultType.SPHERE){if(this._sResultingType1===t.ResultType.SPHERE||"Area"!==this.getAttribute("sSurfaceDisplayType")){var u=this._buildConstructionPointsForConeCylSphere();i=u.oPos1,n=u.oPos2}if(this._sResultingType1===t.ResultType.CONE&&"Area"!==this.getAttribute("sSurfaceDisplayType")){var c=this.getAttribute("fSemiAngle");if(void 0!==c&&!a.isZero(c)){var d=this._sMeasurable1.vAxis.clone();"Angle"===this.getAttribute("sSurfaceDisplayType")&&(d=this._sMeasurable1.vSlat1.clone()),r.push({attribute:"fQuadrant",value:0}),r.push({attribute:"vAngleArcCenter",value:this._sMeasurable1.getApex().clone()}),r.push({attribute:"vAnglePointingPoint",value:this._sMeasurable1.arcCenter.clone()}),r.push({attribute:"vAngleBreakPoint",value:this._sMeasurable1.arcCenter.clone()}),r.push({attribute:"vAngleVector1",value:d}),r.push({attribute:"vAngleVector2",value:this._sMeasurable1.vSlat.clone()})}}}r.push({attribute:"vFirstExtensionPoint3D",value:i.clone()}),r.push({attribute:"vFirstPoint3D",value:i.clone()});var p=i.clone();void 0!==n?(r.push({attribute:"vSecondExtensionPoint3D",value:n.clone()}),r.push({attribute:"vSecondPoint3D",value:n.clone()})):p=i.clone(),!this._sMeasurable1.arcCenter||this._sResultingType1!==t.ResultType.CONE||"Angle"!==this.getAttribute("sSurfaceDisplayType")&&"HalfAngle"!==this.getAttribute("sSurfaceDisplayType")||(p=this._sMeasurable1.arcCenter.clone()),r.push({attribute:"vLeaderPointingPoint3D",value:p}),r.push({attribute:"vLeaderBreakPoint3D",value:this._sResultingType1===t.ResultType.CONE?p:p.clone().add(l)}),this.set(r)},_buildConstructionPointsForDimension:function(e,t,i,n){var r,o,l,c,d,p,g=[],b=s.getDistanceFromPixel(this._viewer,t,e,this._frmWindow),y=a.areEqual(t,i,"Vector3"),h=s.getViewpointInfo(this._viewer.currentViewpoint);if(n){var v=(r=n.clone().normalize()).angleTo(h.sight.clone().negate());v>Math.PI/2&&(v=Math.abs(v-Math.PI));var P=(c=i,d=r,p=t.clone().sub(c).normalize(),(new u.Vector3).crossVectors(p,d)),m=P.angleTo(h.sight.clone().negate());m>Math.PI/2&&(m=Math.abs(m-Math.PI)),m>v&&(r=P),g.push({attribute:"iExtensionLinesManipulable",value:0})}else r=y?h.up.clone():function(e,t,i){var n=e.clone().sub(t).normalize(),r=(new u.Vector3).crossVectors(n,i);return a.isZero(r.length())&&(r=h.up.clone()),r}(t,i,h.sight);r.normalize();var A,D,M=r.clone().multiplyScalar(b);M.dot(h.up)<0&&M.negate(),y?(o=t.clone(),l=i.clone(),D=(A=o.clone().add(l).multiplyScalar(.5)).clone().add(M)):(o=t.clone().add(M),l=i.clone().add(M),D=(A=o.clone().add(l).multiplyScalar(.5)).clone()),g.push({attribute:"vExtensionDirection3D",value:r}),g.push({attribute:"vFirstExtensionPoint3D",value:t.clone()}),g.push({attribute:"vSecondExtensionPoint3D",value:i.clone()}),g.push({attribute:"vFirstPoint3D",value:o}),g.push({attribute:"vSecondPoint3D",value:l}),g.push({attribute:"vLeaderBreakPoint3D",value:D}),g.push({attribute:"vLeaderPointingPoint3D",value:A}),this.set(g)},onViewerEventCB:function(e){if(this.getNode()&&this.getNode().onViewerEventCB){if("beginExplodeCmd"===e.eventType||"endExplodeCmd"===e.eventType){var t=this._viewer.getVisibleSpace();this._bCreateMeasureInShowSpace===t&&this.setVisibleFlag("endExplodeCmd"===e.eventType)}this.getNode().onViewerEventCB(e)}},isPartialMeasure:function(){return this._partialMeasure},setPartialMeasure:function(e){if(this._partialMeasure!==e){this._partialMeasure=e;var t=[];if(t.push({name:"sFontStyle",value:"normal"}),t.push({name:"bIsFilled",value:!0}),t.push({name:"bHasBorder",value:!1}),t.push({name:"fLineStyleThicknessIndex",value:0}),t.push({name:"sLineStylePattern",value:"1"}),t.push({name:"fLeaderStyleThicknessIndex",value:0}),t.push({name:"sLeaderStylePattern",value:"1"}),this._partialMeasure){var i=1;t.push({name:"cFillStyleColor",value:new u.Color("#ff8a2e")}),t.push({name:"cLineStyleColor",value:new u.Color("#8f4c00")}),t.push({name:"cLeaderStyleColor",value:new u.Color("#8f4c00")}),"partialCmd"===this._partialMeasure?(i=.4,t.push({name:"cFontColor",value:new u.Color("#e5e5e5")})):t.push({name:"cFontColor",value:new u.Color("#ffffff")}),t.push({name:"fOpacity",value:i})}else t.push({name:"cFontColor",value:new u.Color("#ffffff")}),t.push({name:"cFillStyleColor",value:new u.Color("#368ec4")}),t.push({name:"cLineStyleColor",value:new u.Color("#3d3d3d")}),t.push({name:"cLeaderStyleColor",value:new u.Color("#3d3d3d")}),t.push({name:"fOpacity",value:1});this.setAttributes(t),this.refreshNode()}},_removeAttribute:function(e){if(e&&e.length>0)for(var t=0;t<e.length;t++)this.getAttribute(e[t])&&(delete this["_"+e[t]],null)},refreshAssistantTool:function(e,t){var i;this._isInCreationState&&this._assistantTool&&(t?(e.position&&(i=e.position.clone()),e.mousePosition&&(e.mousePosition.y=e.mousePosition.y+45,i=s.getNearPositionFrom2DCoordinates(e.mousePosition,this._viewer)),this._assistantTool.updatePosition(i),this._vAssistantPosition=i,this._assistantTool.setVisibleFlag(!0)):this._assistantTool.setVisibleFlag(!1))},movePosDownByPixels:function(e){if(e&&e.position&&e.pixels){var t=s.getDistanceFromPixel(this._viewer,e.position.clone(),e.pixels),i=this._viewer.currentViewpoint.getUpDirection();return i=(i=i.normalize()).multiplyScalar(-t),(new u.Vector3).addVectors(e.position.clone(),i)}}})});