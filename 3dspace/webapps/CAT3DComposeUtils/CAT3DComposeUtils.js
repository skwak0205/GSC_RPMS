/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeUtils/CATC3DUtils",[],function(){"use strict";var e,t,n;function i(e,t,n,i){var o,r,a=n.length,s=e.getFrameWindow().getViewpoint().reframe,l=!0===require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_lightNodeModel"),c=function(){0===--a&&(e.unsubscribe(o),e.unsubscribe(r),e.getFrameWindow().getViewpoint().reframe=s,l&&e.getController().forceRefresh(),i(n))};o=e.subscribe({event:"onInsertExisting"},c),r=e.subscribe({event:"onInsertExistingFailure"},c),e.getFrameWindow().getViewpoint().reframe=function(){},n.forEach(function(n){n.instID?(e.getController().switchAuthoringMode(!0,!0,"PADSession_disabling_index_authoring"),e.getController().insertExisting({created:[n.instID],inserted:[[t,n.instID,n.childID]],modified:[t],matrix:n.matrix})):c()})}return Object.freeze({insertExisting:function n(o){if("string"==typeof o.parentID&&o.children instanceof Array&&"function"==typeof o.onCompleted&&o.context)if(e){var r=o.parentID,a=[];o.children.forEach(function(n){e.insertExisting({modeler:"product",data:{version:"1.0",hasParent:r,children:[{isInstanceOf:n.id}]},onComplete:function(e){var s="string"==typeof e?JSON.parse(e):null;if(s&&"success"===s.status){var l=s.results[0].instance;!function(e,n,i){if(n){var o={onComplete:function(){i()},onFailure:function(){i(),window.console.log("Unable to store matrix")}};o.instances=[{instance:e,hasPositioningMatrix:[0,1,2,4,5,6,8,9,10,12,13,14].map(function(e){return n.elements[e]})}],t?t.move3D(o):i()}else i()}(l,n.matrix,function(){a.push({instID:l,childID:n.id,matrix:n.matrix}),o.children.length===a.length&&i(o.context,r,a,o.onCompleted)})}else a.push({instID:null,matrix:null,childID:n.id,message:s&&s.message?s.message:void 0}),o.children.length===a.length&&i(o.context,r,a,o.onCompleted)},onFailure:function(e){var t="string"==typeof e?JSON.parse(e):null;a.push({instID:null,matrix:null,childID:n.id,message:t&&t.message?t.message:void 0}),o.children.length===a.length&&i(o.context,r,a,o.onCompleted)}})})}else require(["DS/AuthGenericCommands/AuthGenericCmdWSAccess","DS/UPSCommands/UPSCmdUtils"],function(i,r){e=i,t=r,n(o)})},_sendUsageProbe:function(e,t,i){if(n){var o=n.getPADTracker({eventCategory:"usage",eventAction:e}),r={eventLabel:t};void 0!==i&&(r.eventValue=i),o.setEventData(r),o.trackPageEvent()}else require(["DS/PADServices/utils/PADTrackerManager"],function(e,t,i,o){n=o,this._sendUsageProbe(e,t,i)}.bind(this,e,t,i))}})}),define("DS/CAT3DComposeUtils/CATC3DDropManager",["UWA/Class","DS/PADUtils/PADTypesMgt","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeUI/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/PADUtils/PADUtilsServices","DS/CoreEvents/ModelEvents","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/ApplicationFrame/Command","DS/CAT3DComposeUtils/CATC3DUtils","i18n!DS/PADUtils/assets/nls/PADUtils.json","i18n!DS/CAT3DComposeUtils/assets/nls/CATC3DDropManager.json"],function(e,t,n,i,o,r,a,s,l,c,u,d,f,g,p,h,m){"use strict";var v=i.getOption("authoring3d"),D=["CATProduct","CATPart","VPMReference","3DShape"],y=["CATProduct","VPMReference"],C=e.extend({init:function(e){var i,C,x,E,P=e.context,A=P.getViewer(),M=this,S=new g({ID:"CATC3DDropMngFakeCmdHdr",context:P.getCommandContext?P.getCommandContext():null});function T(e){var t=r.get(),n=!((t.length?t[0].pathElement:null)&&t[0].equivalentGeometry);return e?!n:n}function b(){var e=o.getRoots(P);if(!e.length)return!0;if(!e.some(function(e){return e&&!o.is3DLeaf(e)}))return!0;var t=i?i.getLastElement(!0):null;return!(!t||"RootBag"!==t.name)||!(!t||o.isPLMNode(t)&&-1!==y.indexOf(o.getNodeType(t)))}function I(e){if(!b()){if(C){var t=C.getPosition(),a=C.getSize();if(0===t.x&&0===t.y&&(t.x=A.SCREEN_WIDTH/2-a.width/2,t.y=A.SCREEN_HEIGHT/2-a.height/2),t.x<=e.offsetX&&e.offsetX<=t.x+a.width&&t.y<=e.offsetY&&e.offsetY<=t.y+a.height)C.setOpacity(0);else{var s=Math.max(Math.min(e.offsetX,t.x+a.width),t.x),l=Math.max(Math.min(e.offsetY,t.y+a.height),t.y),c=Math.sqrt((e.offsetX-s)*(e.offsetX-s)+(e.offsetY-l)*(e.offsetY-l));c<200?C.setOpacity(c/200):C.setOpacity(1)}}var u=function(e){if(i)return{pathElement:i.clone()};var t=A.pick(A.getMousePosition(new n.Vector2(e.offsetX,e.offsetY)),"primHybrid",!0);if(t&&t.path&&0!==t.path.length){var r=t.path[0];if(r&&r.externalPath&&!(r.externalPath.length<2)&&o.isAModelPath(r))return o.is3DLeaf(r.externalPath[1])&&r.externalPath.length>2&&(r.externalPath.splice(2),r.internalPath=[]),{pathElement:r,position:t.position}}}(e);if(u)r.unique(u),r.get()[0].position=u.position;else if(r.empty(),!i)return;e.preventDefault(),e.stopPropagation(),P.addWidgetBorder(),document.querySelector(".paddnd_invite_display.insert .paddnd_invite_txt").setText(T(e.shiftKey)?"Insert object in position":"Insert"),P._dropZoneContainer.show("insert")}}function w(e){return r.empty(),a.empty(),s.empty(),C=document.querySelector(".paddnd_invite_container"),I(e)}function G(){C&&C.setOpacity(1)}function W(e){return r.empty(),G()}function N(e){if(!b()){C&&C.setOpacity(1),P._dropZoneContainer.hide(),P.clearWidgetBorder();for(var u=r.get().slice(),g=i?i.clone():u.length?u[0].pathElement:null;g;){var v=g.getLastElement(!0);if(v&&o.isReference(v)&&!o.is3DLeaf(v))break;g=g.getParentPath()}g&&(e.preventDefault(),e.stopPropagation(),function(e,n){try{t.retrieveAuthorizedObjects({displayNotif:!1,dnd_event:e,version:"2.0",callback:function(e){var t={unauthorized:[],add:[],insert:[]};e.unauthorized_objects&&e.unauthorized_objects.length&&(t.unauthorized=e.unauthorized_objects),Object.keys(e.authorizedWithKind).forEach(function(n){"Product"===n?e.authorizedWithKind.Product.forEach(function(e){-1===D.indexOf(e.objectType)?t.add.push(e):t.insert.push(e)}):e.authorizedWithKind[n].forEach(function(e){t.add.push(e)})}),n(t)}})}catch(e){window.console.log("")}}(e,function(t){if(t.unauthorized.length&&t.unauthorized.forEach(function(e){P.displayNotification({msg:h.replace(h.get("unsupported_type"),{type:e.objectType,name:e.displayName}),eventID:"warning"})}),t.insert.length){var i,r=!1,v=c.getPlatformId();for(i=0;i<t.insert.length;i++)v!==t.insert[i].envId&&(t.insert.splice(i,1),r=!0,i--),r&&P.displayNotification({msg:m.Tenant_InsertInfo,eventID:"warning"});if(t.insert.length){var D=o.getNodeID(g.getLastElement(!0)),y=T(e.shiftKey),C=[];x&&x.publish({event:"onBeginInsertDrop3D",data:{type:y?"inPosition":""}}),a.empty(),s.empty(),t.insert.forEach(function(i){var o=y?i.path?i.path.map(function(e){return e.resourceid}):[i.objectId]:null,r=i.objectId;!function(e,t,i,o){function r(e){var t=new n.Matrix4;return e.externalPath.forEach(function(e){t.multiply(e.getMatrix())}),t}if(i){if(1===i.length)return void o();var a=r(t),s=i.filter(function(e,t){return t%2});P.getController().getAttributes({ids:s,attributes:["matrixtxt"],callbacks:{onComplete:function(e){var t=new n.Matrix4,i=new n.Matrix4;s.forEach(function(n){if(e[n]&&e[n].matrixtxt){var o=e[n].matrixtxt.replace(/^\[?|\]?$/g,"").split(",").map(parseFloat);i.set(o[0],o[3],o[6],o[9],o[1],o[4],o[7],o[10],o[2],o[5],o[8],o[11],0,0,0,1),t.multiply(i)}}),o(i.getInverse(a).multiply(t))},onFailure:function(){o()}}})}else{var c,u=r(t),d=u.clone();switch(e.equivalentGeometry?e.equivalentGeometry.getType():null){case l.GeometryType.POINT:c=e.equivalentGeometry.getPoint();break;case l.GeometryType.LINE:case l.GeometryType.CYLINDER:case l.GeometryType.CONE:var f=e.equivalentGeometry.getEndPoints(),g=new n.Line3(f.beginPoint,f.endPoint);if(c=e.position?e.position.clone():null){var p=g.closestPointToPointParameter(c,!0);c=g.at(p>=.5?1:0)}break;case l.GeometryType.CIRCLE:case l.GeometryType.SPHERE:c=e.equivalentGeometry.getCenter();break;case l.GeometryType.AXISSYSTEM:u=r(e.pathElement);break;default:c=e.position?e.position.clone():null}c&&u.setPosition(c),o((new n.Matrix4).getInverse(d).multiply(u))}}(u[0],g,o,function(i){C.push({id:r,matrix:i}),C.length===t.insert.length&&(S.begin(),p.insertExisting({parentID:D,children:C,context:P,onCompleted:function(t){var i=0,o=s.get();t.forEach(function(e){e.instID||(e.message?P.displayNotification({msg:e.message,eventID:"error"}):i++)}),i&&P.displayNotification({msg:"Insertion failed",eventID:"error"});var r=f.giveMoveManager({context:P}),a=d.getMoveReferentManager({context:P});o.forEach(function(e){a.addMoveReferent(e.pathElement)});var c=u.length?u[0].equivalentGeometry:null,g=c?c.getType():null;!o.length||g!==l.GeometryType.LINE&&g!==l.GeometryType.CYLINDER&&g!==l.GeometryType.CONE&&g!==l.GeometryType.PLANE&&g!==l.GeometryType.REFPLANE?(o.length&&require(["DS/CATW3DBoxes/CATW3DBoxController"],function(e){e.getBoxController({context:P}).refreshBoxes()}),x&&x.publish({event:"onEndInsertDrop3D",data:{type:o.length?y?"inPosition":"":"cancelled"}})):require(["DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DGeometry/CATW3DEquivalentGeometry"],function(t,i){E||(E=t.getConstraintsController({context:P})),E.deleteAllCst();var a=i.getEquivalentGeometry({pathElement:o[0].pathElement,axis:E.getProductAxisForConstraint(),viewer:P.getViewer()});E.createCst({movable:{equivalentGeometry:a},fixed:{equivalentGeometry:c}});var s=E.simulateSolveCst()||{},l=s.matrix||new n.Matrix4,u=new n.Matrix4,d=s.rc,f=s.redundancy;0!==d||f||(r.onMoveBegin({objectsMoved:o,from:M,moveMode:"Persistent"}),o.forEach(function(e){r.onMove({objectsMoved:[{path:e.pathElement}],from:M,worldMatrix:u.multiplyMatrices(l,e.pathElement.getWorldMatrix())})}),r.onMoveEnd({from:M,status:"Moved"}),P.getFrameWindow().getContextualUIManager().showContextualBar({x:e.offsetX+45,y:e.offsetY-45,hideWithDistance:!0})),o.length&&require(["DS/CATW3DBoxes/CATW3DBoxController"],function(e){e.getBoxController({context:P}).refreshBoxes()}),x&&x.publish({event:"onEndInsertDrop3D",data:{type:o.length?y?"inPosition":"":"cancelled"}})})}}))})})}}else t.add.length&&P.addRootNodesFromContent({json3DXContent:{data:{items:t.add}},dispatch:!0,inContext:!e.shiftKey})}))}}this.connect=function(){v&&(A.canvas.addEventListener("dragenter",w),A.canvas.addEventListener("dragover",I),A.canvas.addEventListener("dragleave",W),A.canvas.addEventListener("dragend",G),A.canvas.addEventListener("drop",N),i=null)},this.disconnect=function(){v&&(E&&E.unreference(),A.canvas.removeEventListener("dragenter",w),A.canvas.removeEventListener("dragover",I),A.canvas.removeEventListener("dragleave",W),A.canvas.removeEventListener("dragend",G),A.canvas.removeEventListener("drop",N),i=null)},this.setCurrentPath=function(e){i=e?e.clone():null},this.subscribe=function(e,t){return x||(x=new u),x.subscribe(e,t)},this.unsubscribe=function(e){return x?x.unsubscribe(e):this}}}),x=[];return e.singleton({init:function(){},getDropManager:function(e){var t;return e&&e.context&&"ENOPAD3DViewer"===e.context.name&&(x.some(function(n){return n.context===e.context&&(t=n.dropMng,!0)}),t||(t=new C({context:e.context}),x.push({context:e.context,dropMng:t}))),t},unreferenceDropManager:function(e){e&&e.context&&"ENOPAD3DViewer"===e.context.name&&x.some(function(t,n){return t.context===e.context&&(x.splice(n,1),!0)})}})});