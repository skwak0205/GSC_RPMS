/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATW3DConstraints/CATW3DConstraintsView",["UWA/Core","UWA/Class","DS/WebappsUtils/WebappsUtils","DS/CoreEvents/ModelEvents","DS/CATWebUXComponents/CATWebUXThumbnail","DS/CATWebUXComponents/CATWebUXPanel","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/CATW3DAnims/CATW3DAnimation3D","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATW3DBoxes/CATW3DBoxController"],function(e,t,i,n,r,a,o,s,c,l,u,v,d){"use strict";var g={};return require(["i18n!DS/CATW3DConstraints/assets/nls/CATW3DConstraintsView"],function(e){g=e}),t.extend({init:function(t){if(t){this._parent(t);var h=null,C={div:null,thumbs:[]},m=null,p=null,f=t.context,A=e.createElement("canvas"),T=null,y=new n,S=c.getAnimation3DEngine({viewer:f.getViewer()}),D=i.getWebappsAssetUrl("CATW3DConstraints","icons/32/"),b=function(e){var t=e.getLastElement(!0),i=null;if(t){var n=function(e){for(var t,i=e.clone(),n=!1;i&&!n;)(n=(t=i.getLastElement(!0))&&v.is3DLeaf(t))||(i=i.getParentPath());return i}(e);if(n){var r=(t=n.getLastElement(!0)).getChildByName("AxisSystems");r&&((i={}).axisBagNode=r)}}return i},x=function(e){var t=new s({viewer:f.getViewer()});f.getViewer().addViewpoint(t),t.setEyePosition(f.getViewer().currentViewpoint.getEyePosition()),t.setSightDirection(f.getViewer().currentViewpoint.getSightDirection()),t.setUpDirection(f.getViewer().currentViewpoint.getUpDirection()),t.setTargetDistance(f.getViewer().currentViewpoint.getTargetDistance()),t.setProjectionType(f.getViewer().currentViewpoint.getProjectionType());var i=null;return e.objectsToMove.forEach(function(e){i?i.mergeWithSphere(e.path.getBoundingSphere(),i):i=e.path.getBoundingSphere()}),i.mergeWithSphere(e.cstAssociated.fixed.getPathElement().getBoundingSphere(),i),t.reframe(null,0,i),function(e,t,i){var n={data:null,width:f.getViewer().SCREEN_WIDTH,height:f.getViewer().SCREEN_HEIGHT};f.getViewer().renderToTarget(n,e);var r=n.width/n.height;r>t/i?(A.height=i,A.width=A.height*r):(A.width=t,A.height=A.width/r),A.width*=2,A.height*=2;var a=A.getContext("2d");a.clearRect(0,0,A.width,A.height);for(var o=function(e,t,i,n,r){return r&&(t=n-t),i*Math.floor(t)+Math.floor(e)},s=a.getImageData(0,0,A.width,A.height),c=(n.width-1)/(s.width-1),l=(n.height-1)/(s.height-1),u=0;u<s.height;u++)for(var v=0;v<s.width;v++){var d=o(v,u,s.width,s.height,!1),g=o(c*v,l*u,n.width,n.height,!0);s.data[4*d]=n.data[4*g],s.data[4*d+1]=n.data[4*g+1],s.data[4*d+2]=n.data[4*g+2],s.data[4*d+3]=n.data[4*g+3]}return a.putImageData(s,0,0,0,0,A.width,A.height),A.toDataURL("image/png")}(t,240,180)},w=function(e){if(e.color){var t=new o.MeshBasicMaterial({side:o.DoubleSide,color:e.color,transparent:!0,depthWrite:!1,depthTest:!1,opacity:.9,overridable:!1});u.applyMaterialToPath(e.path,t);var i=800;15355703===e.color&&(i=1600),m=setTimeout(function(){clearTimeout(m),m=null,w(p)},i),p={path:e.path}}else u.applyMaterialToPath(e.path,null),p={};f.getViewer().render()},P=function(e){for(var t,i,n=0;n<C.thumbs.length;n++)if(C.thumbs[n].getThumbnailID()==="3DComposeConstraintsThumb_"+e.data.cstType){t=C.thumbs[n];break}t&&T!==t&&!S.isRunning()&&(i={thumbnail:t},T.setDisplayFlag(!1),i.thumbnail.setDisplayFlag(!0),T=i.thumbnail,y.publish({event:"onAlternativeClick",data:e.data}))},M=function(e){for(;C.div.firstChild;)C.div.firstChild.destroy(),C.div.removeChild(C.div.firstChild);for(var t=0;t<C.thumbs.length;t++)C.thumbs[t].clear();C.thumbs.length=0,function(e){var t=new l(f.getRootBagPath().externalPath[0]);f.getViewer().getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(t);var i=f.getRootBagPath(),n=t.createOverride(i),r=f.getViewer().getShadow();f.getViewer().setShadow(!1);var a=f.getViewer().getGrid();f.getViewer().setGrid(!1);var s=f.getViewer().getMirror();f.getViewer().setMirror(!1),f.setRobotVisibility(!1);var c=d.getBoxController({context:f});c&&c.displayBoxes(!1);var v=null;n.setOpacity(0,!0),n.setPickability("IGNORED");var g=!1;e.forEach(function(e){var i=e.objectsToMove,n=(new o.Matrix4).getInverse(i[0].initWorldMatrix).multiply(e.alternativePosition),r=new o.MeshBasicMaterial({side:o.DoubleSide,color:3394815,transparent:!0,depthWrite:!1,depthTest:!1,opacity:.7,overridable:!1});u.applyMaterialToPath(e.cstAssociated.fixed.getPathElement(),r),e.objectsToMove.forEach(function(i){var r=t.createOverride(i.path);if(!g){var a=t.createOverride(e.cstAssociated.fixed.getPathElement());a.setOpacity(1,!0),a.setPickability("PICKABLE"),r.setOpacity(1,!0),r.setPickability("PICKABLE");var s=b(e.cstAssociated.fixed.getPathElement());s&&s.axisBagNode&&s.axisBagNode.isVisible()&&(v=s.axisBagNode)}var c=(new o.Matrix4).copy(i.initWorldMatrix).multiply(n),l=(new o.Matrix4).getInverse(i.path.getParentPath().getWorldMatrix());r.setPosition((new o.Matrix4).copy(l).multiply(c))}),e.preview=x(e),u.applyMaterialToPath(e.cstAssociated.fixed.getPathElement(),null),g=!0}),f.setRobotVisibility(!0),v&&v.setVisibility(!0),f.getViewer().setShadow(r),f.getViewer().setGrid(a),f.getViewer().setMirror(s),f.getViewer().getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(t),c&&c.displayBoxes(!0)}(e.snapAlternatives);var i="cstCoincidence"===localStorage.getItem("cstDefaultType")?"cstCoincidence":"cstContact";e.snapAlternatives.forEach(function(e){var t=new r({id:"3DComposeConstraintsThumb_"+e.cstType,data:{cstType:e.cstType},width:258,height:198,title:g[e.cstType],icon:D+"I_3DCompose"+e.cstType+".png",preview:e.preview,displayFlag:e.cstType===i,clickCB:P});C.thumbs.push(t),C.div.appendChild(t.getContent()),e.cstType===i&&(T=t)})};this.refreshView=function(n){if(C.div||(C.div=e.createElement("div")),!h){var r={id:"CATW3DConstraintsViewPanel",className:"CATW3DConstraintsViewPanel",title:g.sidePanel,showTitleFlag:!1,icon:i.getWebappsAssetUrl("CATW3DConstraints","icons/32/")+"I_3DComposecstContact.png",immersiveFrame:t.window.getImmersiveFrame(),viewerFrame:f.getFrameWindow().getViewerFrame(),content:C.div,minWidth:270,width:270,minHeight:410,height:410,closeButtonFlag:!1,resizableFlag:!1,snappableFlag:!1,position:{at:"top right"},allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea};h=new a(r)}M(n)},this.setUpMeshColor=function(e){m&&(clearTimeout(m),m=null,w(p)),0!==e.result.rc||e.result.redundancy?w({path:e.path,color:15355703}):w({path:e.path,color:3394815})},this.clear=function(){h&&(h.destroy(),h=null)},this.subscribe=function(e,t){if("onAlternativeClick"===e)return y.subscribe({event:e},t)}}}})}),define("DS/CATW3DConstraints/CATW3DConstraintsModel",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CATCDSJS/CATCDS","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/CATW3DMoveManager/CATW3DMoveManager"],function(e,t,i,n,r,a){"use strict";var o=n.GeometryType;return e.extend({init:function(e){var n=e.context,s=[],c=this,l=null,u=null,v=null,d=null,g=!1,h=a.giveMoveManager({context:n});this.createCst=function(e){var t={movable:e.movable,fixed:e.fixed,cstType:e.cstType};return s.push(t),t},this.getLastCst=function(){return s.length>0?s[s.length-1]:null},this.deleteLastCst=function(){s.splice(s.length-1,1)},this.deleteAllCst=function(){s=[]},this.count=function(){return s.length};var C=function(e,t){var n;switch(e.getType()){case o.POINT:var r=e.getPoint();n=i.CATICDSPoint.Create(t,r.x,r.y,r.z);break;case o.CIRCLE:case o.SPHERE:var a=e.getCenter();n=i.CATICDSPoint.Create(t,a.x,a.y,a.z);break;case o.LINE:case o.CYLINDER:case o.CONE:var s=e.getEndPoints(),c=s.endPoint.clone().sub(s.beginPoint).normalize();n=i.CATICDSLine.Create(t,s.beginPoint.x,s.beginPoint.y,s.beginPoint.z,c.x,c.y,c.z);break;case o.PLANE:case o.REFPLANE:var l=e.getPlane();n=i.CATICDSPlane.Create(t,l.origin.x,l.origin.y,l.origin.z,l.normal.x,l.normal.y,l.normal.z);break;case o.AXIS:case o.AXISX:case o.AXISY:case o.AXISZ:var u=e.getAxis();n=i.CATICDSLine.Create(t,u.origin.x,u.origin.y,u.origin.z,u.direction.x,u.direction.y,u.direction.z);break;default:window.console.log("Unknown type of geomtry")}return n},m=function(){g=!1,(l=i.CATICDSAdvanced.Create()).SetTolerances(.001,1e-6),l.SetReplayMode(i.CATCDSReplayMode.rmREPLAY),u=l.GetFactory(),(d=i.CATICDSRigidSet.Create(u)).FixToggle(),v=i.CATICDSRigidSet.Create(u);for(var e=0;e<c.count();++e){var t=C(s[e].movable,u);v.AddGeometry(t);var n=C(s[e].fixed,u);d.AddGeometry(n);var r=s[e].movable.getType(),a=s[e].fixed.getType(),h=r!==o.AXISX&&r!==o.AXISY&&r!==o.AXISZ||a!==o.PLANE&&a!==o.REFPLANE?"CATICDSCoincidence":"CATICDSParallelism",m=i[h].Create(u,t,n);"cstContact"===s[e].cstType||"cstAntiAlign"===s[e].cstType?m.SetAlignment(i.CATCAlignment.caANTIALIGN):"cstCoincidence"!==s[e].cstType&&"cstAlign"!==s[e].cstType||m.SetAlignment(i.CATCAlignment.caALIGN),m.IsRedundant().status===i.CATCDSRedundancyStatus.rsFULLYREDUNDANT&&(g=!0)}},p=function(){var e={},n=l.Run();if(0===n){if(v.HasTransformation()){var r=v.GetTransformation(),a=new t.Matrix4(r.matrix[0][0],r.matrix[0][1],r.matrix[0][2],r.vector[0],r.matrix[1][0],r.matrix[1][1],r.matrix[1][2],r.vector[1],r.matrix[2][0],r.matrix[2][1],r.matrix[2][2],r.vector[2],0,0,0,1);e.matrix=a}}else l.UndoRun();return i.CATICDSAdvanced.Remove(l),l=null,u=null,v=null,d=null,e.rc=n,e.redundancy=g,e};function f(e){var t;switch(e.getType()){case o.LINE:case o.CYLINDER:case o.CONE:var i=e.getEndPoints();t=i.endPoint.clone().sub(i.beginPoint).normalize();break;case o.PLANE:case o.REFPLANE:t=e.getNormal();break;case o.AXIS:case o.AXISX:case o.AXISY:case o.AXISZ:t=e.getDirection();break;default:window.console.log("Unknown type of geomtry")}return t}this.simulateMoveWithCst=function(e){m();var n=[[1,0,0],[0,1,0],[0,0,1]];e.rotation&&(n=e.rotation);var r=new t.Vector3;if(e.translation&&(r=e.translation),e.movableReference){var a=i.CATICDSPoint.Create(u,e.movableReference.x,e.movableReference.y,e.movableReference.z);v.AddGeometry(a)}return v.SetDynamicMove(n,[r.x,r.y,r.z]),p()},this.simulateSolveCst=function(){return m(),p()},this.moveWithCst=function(e){var i=e.alternative.alternativePosition,n=e.objectsToMove;if(i){h.onMoveBegin({objectsMoved:n,from:c,moveMode:"Transient"});var r=(new t.Matrix4).getInverse(n[0].initWorldMatrix).multiply(i);n.forEach(function(e){var i=(new t.Matrix4).copy(e.initWorldMatrix).multiply(r),n=(new t.Matrix4).getInverse(e.path.getParentPath().getWorldMatrix());e.snappedPosition=(new t.Matrix4).copy(n).multiply(i)}),h.onMove({objectsMoved:n,transformation:r,from:c}),e.callBackFct&&e.callBackFct({objectsToMove:n,callBackAfterAnim:function(){h.onMoveEnd({from:c,status:"Moved"})}})}},this.getConstraintForReverseDirection=function(e){var t=1===this.count()?this.getLastCst():null;if(e&&t){var i=t.movable.getType();return i!==o.AXISX&&i!==o.AXISY&&i!==o.AXISZ||!e.isAParentOf(t.movable.getPathElement())?void 0:t}},this.simulateReverseDirection=function(e){var t=this.getConstraintForReverseDirection(e);if(t){if("cstAntiAlign"===t.cstType||"cstAlign"===t.cstType)return t.cstType="cstAntiAlign"===t.cstType?"cstAlign":"cstAntiAlign",this.simulateSolveCst();var i=f(t.movable),n=f(t.fixed);if(i&&n){var r=i.angleTo(n);if(Math.abs(r)<1e-6||Math.abs(Math.PI-r)<1e-6)return t.cstType=Math.abs(r)<1e-6?"cstAntiAlign":"cstAlign",this.simulateSolveCst()}}},this.getAxisTypeIfCstOnProductAxis=function(e){var t=1===this.count()?this.getLastCst():null;if(e&&t){var i=t.movable.getType();return i!==o.AXISX&&i!==o.AXISY&&i!==o.AXISZ||!e.isAParentOf(t.movable.getPathElement())?void 0:i}},this.simulateSwitchAxis=function(e,t){var i=this.getAxisTypeIfCstOnProductAxis(e);if(i&&i!==t&&(t===o.AXISX||t===o.AXISY||t===o.AXISZ)){var n=this.getLastCst();return this.deleteLastCst(),this.createCst({movable:r.getEquivalentGeometry({pathElement:n.movable.getPathElement(),axis:t}),fixed:n.fixed}),this.simulateSolveCst()}}}})}),define("DS/CATW3DConstraints/CATW3DConstraintsController",["UWA/Class","DS/CATW3DAnims/CATW3DAnimation3D","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/Visualization/ThreeJS_DS","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATW3DConstraints/CATW3DConstraintsView"],function(e,t,i,n,r,a,o){"use strict";var s,c=0;s=e.extend({init:function(e){var s,l=null,u=null,v=[],d=[],g=["cstContact","cstCoincidence"],h=e.context;if(h){var C=a.giveMoveManager({context:h}),m=r.getMoveReferentManager({context:h}),p=h.getFrameWindow();if(p){var f,A=p.getViewer(),T=function(){require(["DS/CATW3DConstraints/CATW3DConstraintsModel"],function(e){f=new e({context:h})},function(){++c<6&&window.console.error("Failed to load constaints modeler (CDS)")})},y=new o({window:p,viewer:A,context:h});if(h.getRootBagPath().getChildrenPathes().length)T();else var S=h.subscribe({event:"onRootAdded"},function(){T(),h.unsubscribe(S)});C.subscribe("MoveBegin",function(e){e.objectsMoved.length>0&&(d=[],e.objectsMoved.forEach(function(e){d.push(e)}))}),C.subscribe("MoveEnd",function(e){f&&f.count()>0&&d.length>0&&(d.forEach(function(e){var t=m.getMoveReferent(e.path);e.initWorldMatrix=t.getWorldMatrix(),e.initMatrix=t.getLastElement(!0).getMatrix()}),"Moved"===e.status&&(e.from!==f&&(v=function(){var e=[],t="cstCoincidence"===localStorage.getItem("cstDefaultType")?"cstCoincidence":"cstContact",r=f.getLastCst();e.push({alternativePosition:d[0].initWorldMatrix,objectsToMove:d,cstType:t,cstAssociated:r});var a=r.movable.getType(),o=r.fixed.getType();return a!==i.GeometryType.PLANE&&a!==i.GeometryType.REFPLANE||o!==i.GeometryType.PLANE&&o!==i.GeometryType.REFPLANE||(g.forEach(function(i){if(i!==t){f.deleteLastCst();var a=f.createCst({movable:r.movable,fixed:r.fixed,cstType:i}),o=f.simulateSolveCst().matrix;if(o){var s={alternativePosition:o.multiply((new n.Matrix4).copy(d[0].initWorldMatrix)),objectsToMove:d,cstType:i,cstAssociated:a};"cstCoincidence"===i?e.push(s):e.unshift(s)}}}),f.deleteLastCst(),f.createCst({movable:r.movable,fixed:r.fixed,cstType:r.cstType})),e}()),v.length>1?e.from!==f&&y.refreshView({snapAlternatives:v}):y.clear()))});var D=t.getAnimation3DEngine({viewer:A});y.subscribe("onAlternativeClick",function(e){if(f){localStorage.setItem("cstDefaultType",e.cstType);var t=f.getLastCst();f.deleteLastCst(),f.createCst({movable:t.movable,fixed:t.fixed,cstType:e.cstType});var i=null;v.some(function(t){return t.cstType===e.cstType&&(i=t,!0)}),f.moveWithCst({alternative:i,objectsToMove:d,callBackFct:function(e){D.addAnimation({animationType:"snap",createOverrideSet:!0,objectListToAnimate:e.objectsToMove,callBackFct:function(){e.callBackAfterAnim()}}),D.startAnimation()}})}}),this.isLevelConstrained=function(e){return!(!u||!e)&&u.isEqual(e)},this.createCst=function(e){if(e&&e.movable&&e.fixed&&f){var t=e.movable.equivalentGeometry,n=e.fixed.equivalentGeometry;if(t&&n){var r=e.cstType,a=t.getType(),o=n.getType();a!==i.GeometryType.PLANE&&a!==i.GeometryType.REFPLANE||o!==i.GeometryType.PLANE&&o!==i.GeometryType.REFPLANE||(r="cstCoincidence"===localStorage.getItem("cstDefaultType")?"cstCoincidence":"cstContact");var s=f.createCst({movable:t,fixed:n,cstType:r});return u=m.getMoveReferent(s.movable.getPathElement()),s}}},this.deleteLastCst=function(){f&&(l=f.getLastCst(),f.deleteLastCst())},this.restoreLastDeletedCst=function(){f&&f.createCst({movable:l.movable,fixed:l.fixed,cstType:l.cstType})},this.deleteAllCst=function(){f&&(f.deleteAllCst(),y&&y.clear(),l=null,u=null)},this.count=function(){return f?f.count():(++c<6&&window.console.error("Constraint modeler not available!"),0)},this.simulateMoveWithCst=function(e){if(e&&(e.translation||e.rotation)&&f)return f.simulateMoveWithCst(e)},this.simulateSolveCst=function(){if(f){var e=f.simulateSolveCst(),t=f.getLastCst();if(0!==e.rc&&t){var n,r=t.movable.getType(),a=t.fixed.getType(),o=i.GeometryType;r!==o.PLANE&&r!==o.REFPLANE||a!==o.PLANE&&a!==o.REFPLANE||(f.deleteLastCst(),g.some(function(e){if(e!==t.cstType)return n=e,!0}),f.createCst({movable:t.movable,fixed:t.fixed,cstType:n}),e=f.simulateSolveCst())}return y.setUpMeshColor({result:e,path:t.fixed.getPathElement()}),e}},this.isThereACstSuppportingReverseDirection=function(e){return e&&f&&f.getConstraintForReverseDirection(e)},this.simulateReverseDirection=function(e){return f?f.simulateReverseDirection(e):null},this.getAxisTypeIfCstOnProductAxis=function(e){if(e&&f)return f.getAxisTypeIfCstOnProductAxis(e)},this.simulateSwitchAxis=function(e,t){return f?f.simulateSwitchAxis(e,t):null},this.getProductAxisForConstraint=function(){if(!s){var e=localStorage.getItem("PrdAxisForCst");s="Y"===e?i.GeometryType.AXISY:"Z"===e?i.GeometryType.AXISZ:i.GeometryType.AXISX}return s},this.setProductAxisForConstraint=function(e){e!==i.GeometryType.AXISX&&e!==i.GeometryType.AXISY&&e!==i.GeometryType.AXISZ||(s=e,localStorage.setItem("PrdAxisForCst",e===i.GeometryType.AXISY?"Y":e===i.GeometryType.AXISZ?"Z":"X"))}}else window.console.log("A window must be defined")}else window.console.log("A context must be defined")}});var l=[],u=function(e){var t;return e&&e.context&&(t=null,l.some(function(i){return i.context===e.context&&(t=i)})),t};return e.singleton({init:function(){},giveConstraintsController:function(e){var t=u(e);return t?t.enveloppe:t},getConstraintsController:function(e){var t,i=u(e);return i?(i.count++,t=i.enveloppe):null===i&&(i={count:1,context:e.context,cstCtrl:new s(e),enveloppe:{unreference:function(){i.count--,0===i.count&&(i.cstCtrl=i.context=null,l.splice(l.indexOf(i),1))}}},Object.keys(i.cstCtrl).forEach(function(e){var t=this;"function"==typeof t.cstCtrl[e]&&(t.enveloppe[e]=function(){return t.cstCtrl||window.console.log("Unexpected call"),t.cstCtrl[e].apply(t.cstCtrl,arguments)})},i),t=Object.freeze(i.enveloppe),l.push(i)),t}})});