define("DS/XCityCore/Store",["DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader","DS/XCityTools/Disposer","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools"],function(e,t,i,r,a,s,o){"use strict";var n=function(e,t){void 0!==e.value&&null!==e.value&&(e.oldValue.push(e.value),e.value=void 0),e.value=t,e.value.sourceFile=e.url,e.value.needsUpdate=!0},l=function(t,i){void 0!==t.value&&null!==t.value&&(t.oldValue.push(t.value),t.value=void 0);var r=new Float32Array(i);t.value=new e.DataTexture(r,this._tileInfo.width,this._tileInfo.height,e.LuminanceFormat,e.FloatType),t.value.sourceFile=t.url,t.value.bounds={min:r[this._tileInfo.width*this._tileInfo.height],max:r[this._tileInfo.width*this._tileInfo.height+1]},THREEDS.Core.supportedExtensions&&null===THREEDS.Core.supportedExtensions.textureFloatLinear?(t.value.magFilter=e.NearestFilter,t.value.minFilter=e.NearestFilter):(t.value.magFilter=e.LinearFilter,t.value.minFilter=e.LinearFilter),t.value.wrapS=e.ClampToEdgeWrapping,t.value.wrapT=e.ClampToEdgeWrapping,t.value.needsUpdate=!0},d=function(e,t){s.is(t.withCredentials)&&(e.withCredentials=t.withCredentials),s.is(t.module)&&(e.module=t.module),s.is(t.responseType)&&(e.responseType=t.responseType),s.is(t.type)&&(e.type=t.type),s.is(t.headers)&&(e.headers=t.headers),s.is(t.image)&&(e.image=t.image),s.is(t.builder)&&(e.builder=t.builder)},u=function(e,t){this._name=e,this._data={},this._toClean=[],this._priority=t.priority?Math.max(0,t.priority):0,this._timestamp=0,this._cacheSize=0,this._temporalParam={},this._baseURL,this._dlOptions={},this._worldSize,this._shiftedPosition,this._tileInfo={width:1,height:1},this._streamvisu=t.streamvisu,this._rendering=t.rendering,this._dataDownloader,this._dataBuilder,this._dataCleaner,this._dataUpdater,this._resultEditor,this._temporalParam.hasToBeConsidered=!!t.listenToDateUpdate&&t.listenToDateUpdate,this._temporalParam.up=t.upTime?t.upTime:void 0,this._temporalParam.down=t.downTime?t.downTime:void 0,this._baseURL=t.url?t.url:void 0,this._cacheSize=t.cacheSize?t.cacheSize:0,this._invertY=!!t.invertY&&t.invertY,d(this._dlOptions,t.dlOptions?t.dlOptions:{}),t.dataDownloader?(this._dataDownloader=t.dataDownloader,this._dataDLCanceler=t.dataDLCanceler):(t.tile?(this._dataDownloader=function(e,t,r,s,o){if(void 0!==this._baseURL){var n;if(void 0!==t&&void 0!==t.tile)e.bbox={xmin:0,xmax:0,ymin:0,ymax:0},n=this._worldSize.x/(1<<t.tile.LOD),e.bbox.xmin=t.tile.I*n+this._shiftedPosition.x,e.bbox.xmax=(t.tile.I+1)*n+this._shiftedPosition.x,n=this._worldSize.y/(1<<t.tile.LOD),e.bbox.ymin=t.tile.J*n+this._shiftedPosition.y,e.bbox.ymax=(t.tile.J+1)*n+this._shiftedPosition.y,e.tile=t.tile;else if(void 0===e.tile)return void a.warn("XCityCoreStore '"+this._name+"': No bbox information given... What should we download ?");var l=this._invertY?(1<<e.tile.LOD)-1-e.tile.J:e.tile.J;e.url=this._baseURL.replace("%l",e.tile.LOD).replace("%x",e.tile.I).replace("%y",l);var d=Array.prototype.slice.call(arguments,2);if(d.unshift(e.url,e.dlOptions),this._streamvisu){var u={name:e.url,url:e.url,urlOptions:void 0,_shifted:!0,shader:[{name:"road"},{name:"ocean"}],rendering:this._rendering,terrain:!0},h=xCity._urbanImpl.modelLoader.load(u,d[3]),c=h.getMatrix();c.elements[12]=-xCity._urbanImpl.shiftedPosition.x,c.elements[13]=-xCity._urbanImpl.shiftedPosition.y,h.setMatrix(c),h.name=e.url}else{if(o._setProgress&&o._getProgress){let e=o._getProgress(),t=e&&e.total||0,i=e&&e.loaded||0;o._setProgress({loaded:i,total:t+1})}i.download.apply(i,d)}}else a.warn("XCityCoreStore '"+this._name+"': No URL template was defined... What should we download ?")}.bind(this),this._worldSize=void 0!==t.tile.worldSize?{x:t.tile.worldSize,y:t.tile.worldSize}:{x:0,y:0},this._shiftedPosition=void 0!==t.tile.shiftedPosition?s.clone(t.tile.shiftedPosition):{x:0,y:0}):t.wms?(this._dataDownloader=function(e,t,r,s,o){if(void 0!==this._baseURL){var n;if(void 0!==t&&void 0!==t.tile)e.bbox={xmin:0,xmax:0,ymin:0,ymax:0},n=this._worldSize.x/(1<<t.tile.LOD),e.bbox.xmin=t.tile.I*n+this._shiftedPosition.x,e.bbox.xmax=(t.tile.I+1)*n+this._shiftedPosition.x,n=this._worldSize.y/(1<<t.tile.LOD),e.bbox.ymin=t.tile.J*n+this._shiftedPosition.y,e.bbox.ymax=(t.tile.J+1)*n+this._shiftedPosition.y,e.tile=t.tile;else if(void 0===e.bbox)return void a.warn("XCityCoreStore '"+this._name+"': No wms information given... What should we download ?");e.url=this._baseURL.replace(/\%xmin/g,e.bbox.xmin).replace(/\%xmax/g,e.bbox.xmax).replace(/\%ymin/g,e.bbox.ymin).replace(/\%ymax/g,e.bbox.ymax).replace(/\%currentdate/g,e.tile.T);var l=Array.prototype.slice.call(arguments,2);l.unshift(e.url,e.dlOptions),i.download.apply(i,l)}else a.warn("XCityCoreStore '"+this._name+"': No URL template was defined... What should we download ?")}.bind(this),this._worldSize=void 0!==t.wms.worldSize?{x:t.wms.worldSize,y:t.wms.worldSize}:{x:0,y:0},this._shiftedPosition=void 0!==t.wms.shiftedPosition?s.clone(t.wms.shiftedPosition):{x:0,y:0}):t.bbox?this._dataDownloader=function(e,t,r,s,o){if(void 0!==this._baseURL){if(void 0!==t&&void 0!==t.bbox)e.bbox=t.bbox;else if(void 0===e.bbox)return void a.warn("XCityCoreStore '"+this._name+"': No bbox information given... What should we download ?");e.url=this._baseURL.replace(/\%xmin/g,e.bbox.xmin).replace(/\%xmax/g,e.bbox.xmax).replace(/\%ymin/g,e.bbox.ymin).replace(/\%ymax/g,e.bbox.ymax),t.tile&&t.tile.T&&(e.url=e.url.replace(/\%currentdate/g,t.tile.T));var n=Array.prototype.slice.call(arguments,2);n.unshift(e.url,e.dlOptions),i.download.apply(i,n)}else a.warn("XCityCoreStore '"+this._name+"': No URL template was defined... What should we download ?")}.bind(this):this._dataDownloader=function(e,t,r,s,o){if(void 0!==t&&void 0!==t.url)void 0===this._baseURL?e.url=t.url:e.url=this._baseURL+t.url;else if(void 0===e.url)return void a.warn("XCityCoreStore '"+this._name+"': No URL defined... What should we download ?");var n=Array.prototype.slice.call(arguments,2);n.unshift(e.url,e.dlOptions),i.download.apply(i,n)}.bind(this),this._dataDLCanceler=function(e){void 0!==e.url&&i.cancel(e.url)}.bind(this)),t.dataBuilder?this._dataBuilder=t.dataBuilder:t.texture?(this._dataBuilder=n.bind(this),this._dlOptions.image=!0):t.basisTexture?(this._dataBuilder=n.bind(this),this._dlOptions.image=!0,this._dlOptions.basis=!0):t.floatTexture?(t.floatTexture.width&&t.floatTexture.height?(this._tileInfo.width=t.floatTexture.width,this._tileInfo.height=t.floatTexture.height):t.floatTexture.size?(this._tileInfo.width=t.floatTexture.size,this._tileInfo.height=t.floatTexture.size):a.warn("Store '"+this._name+"': Missing tile size information. Set to 1."),this._dataBuilder=l.bind(this),this._dlOptions.responseType="arraybuffer"):this._dataBuilder=function(e,t){void 0!==e.value&&null!==e.value&&(e.oldValue.push(e.value),e.value=void 0),e.value=t}.bind(this),t.dataCleaner?this._dataCleaner=t.dataCleaner:this._dataCleaner=r.disposeV6.bind(r),t.dataUpdater?this._dataUpdater=t.dataUpdater:this._dataUpdater=function(e){},t.onFinish&&(this._onFinish=t.onFinish),t.resultEditor&&(this._resultEditor=t.resultEditor),t.setProgress&&(this._setProgress=t.setProgress),t.getProgress&&(this._getProgress=t.getProgress)};u.prototype={_updateDataTimeStamp:function(e){e.timestamp=this._timestamp,this._dataUpdater(e)},_getData:function(e){var t=this._data[e];if(void 0!==t)return this._updateDataTimeStamp(t),t},_storeData:function(e,t,i,r,a){var s,o;if(this._getProgress&&this._getProgress){let e=this._getProgress(),t=e&&e.total||0,i=e&&e.loaded||0;this._setProgress({loaded:i+1,total:t})}if(void 0!==(s=this._data[r])&&(void 0===s.value||s.deprecated)&&a==s.requeststamp){if(e&&void 0===i&&(i={status:200}),e&&204!==i.status){if(void 0!==s.dlOptions.builder&&"texture"===s.dlOptions.builder)n.call(this,s,t);else if(void 0!==s.dlOptions.builder&&"textureFloat"===s.dlOptions.builder)l.call(this,s,t);else if(this._resultEditor){var d=this._resultEditor(t,s.tile,s);null!=d&&this._dataBuilder(s,d)}else this._dataBuilder(s,t);void 0!==s.value&&null!==s.value&&(s.value.storeId=this._name,s.value.storeKey=s.key),s.deprecated=!1}else 0===s.locks?(s.value=null,s.deprecated=!1):s.deprecated=!0;o=s.callbacks,s.callbacks=[],o.forEach(function(t){t.opt.unshift(e,s.value),e?t.opt.push(i&&i.status?i.status:200):t.opt.push(!1),t.func.apply(t.bound,t.opt)})}},_storeModelData:function(e,t,i,r,a){var s,o;void 0!==(s=this._data[e])&&(void 0===s.value||s.deprecated)&&(r?(void 0!==s.dlOptions.builder&&"texture"===s.dlOptions.builder?n.call(this,s,i):void 0!==s.dlOptions.builder&&"textureFloat"===s.dlOptions.builder?l.call(this,s,i):(i.setVisibility(!0),this._dataBuilder(s,i)),void 0!==s.value&&null!==s.value&&(s.value.storeId=this._name,s.value.storeKey=s.key),s.deprecated=!1):0===s.locks?(s.value=null,s.deprecated=!1):s.deprecated=!0,o=s.callbacks,s.callbacks=[],o.forEach(function(e){e.opt.unshift(r,s.value),r?e.opt.push(200):e.opt.push(!1),e.func.apply(e.bound,e.opt)}))},clean:function(e){for(var t,i,r=[],s=function(e,t){return null===this._data[e].value||void 0===this._data[e].value?-1:null===this._data[t].value||void 0===this._data[t].value?1:this._data[e].timestamp-this._data[t].timestamp}.bind(this),o=Object.keys(this._data),n=0,l=o.length;n<l;n++)for((e||0===this._data[o[n]].locks&&!1===this._data[o[n]].undeletable&&this._data[o[n]].timestamp<this._timestamp)&&r.push(o[n]);this._data[o[n]].oldValue.length>0;)this._toClean.push(this._data[o[n]].oldValue.pop());if(e||r.length>this._cacheSize)for(e||r.sort(s),u=e?r.length:r.length-this._cacheSize;u--;){if(i=r.shift(),(t=this._data[i]).locks>0&&a.warn("STORE -  "+this._name+": A locked resource is deleted!"),this.cancelDownloadData(i),void 0!==t.value&&null!==t.value&&this._toClean.push(t.value),t.value=void 0,t.callbacks.length>0){var d=t.callbacks;t.callbacks=void 0,d.forEach(function(e){e.opt.unshift(!1,void 0),e.func.apply(e.bound,e.opt)})}t.callbacks=void 0,delete this._data[i]}for(var u=this._toClean.length;u--;){var h=this._toClean.pop();this._dataCleaner(h),h._globePool||(h=null)}},getData:function(e){var t=this._getData(e);if(void 0!==t)return t.deprecated&&(this._streamvisu||(t.requeststamp=this._timestamp,this._dataDownloader(t,{},this._priority,this._storeData,this,e,t.requeststamp)),0===t.locks)?null:t.value},getOrDownloadData:function(e,t,i,r){var a,s;void 0===t&&(t={}),this._onFinish&&(s={func:this._onFinish.func,bound:this._onFinish.bound,opt:Array.prototype.slice.call(arguments,4)}),i&&(a={func:i,bound:r,opt:Array.prototype.slice.call(arguments,4)});var o=this._getData(e);if(void 0!==o){if(o.deprecated);else if(void 0!==o.value&&o.isVisible===t.isVisible)return void 0!==a&&(a.opt.unshift(null!==o.value,o.value),a.func.apply(a.bound,a.opt)),o.value}else o={key:e,value:void 0,oldValue:[],url:void 0,tile:void 0,bbox:void 0,timestamp:this._timestamp,requeststamp:this._timestamp,dlOptions:this._dlOptions,callbacks:[],locks:0,deprecated:!1,isVisible:!0,tmp:!1,undeletable:!1,temporary:!0},t.undeletable&&(o.undeletable=!0),this._streamvisu&&(o.alreadyDL=!1),Object.seal(o),this._data[e]=o,void 0!==s&&o.callbacks.push(s);return d(o.dlOptions,t),o.isVisible=t.isVisible,void 0!==a&&o.callbacks.push(a),o.requeststamp=this._timestamp,this._streamvisu?o.alreadyDL||(this._dataDownloader(o,t,t.priority?this._priority+t.priority:this._priority,this._storeModelData.bind(this,e,o.requeststamp),this,e,o.requeststamp),o.alreadyDL=!0):this._dataDownloader(o,t,t.priority?this._priority+t.priority:this._priority,this._storeData,this,e,o.requeststamp),void 0!==o.value&&null!==o.value&&(o.value.tmp=o.tmp,o.value.temporary=o.temporary),o.value},cancelDownloadData:function(e){if(void 0!==this._dataDLCanceler&&null!==this._dataDLCanceler){var t,i=this._getData(e);void 0!==i&&(this._dataDLCanceler(i),null!==i.value&&void 0!==i.value||(i.deprecated=!0),t=i.callbacks,i.callbacks=[],t.forEach(function(e){e.opt.unshift(!1,void 0),e.func.apply(e.bound,e.opt)}))}},deprecateData:function(e){var t,i,r=function(e){var t=this._data[e];void 0!==t&&(t.deprecated=!0)}.bind(this);if(e instanceof Array)for(t=0,i=e.length;t<i;++t)r(e[t]);else r(e)},updateTimeParam:function(e){e&&(e.up&&(this._temporalParam.up=e.up),e.down&&(this._temporalParam.down=e.down))},isDeprecated:function(e,t){if(!(e instanceof Array)){var i=this._data[e];if(void 0!==i)return i.deprecated}return!1},traverse:function(e,t){for(var i=Object.keys(this._data),r=0,a=i.length;r<a;r++){var s=this._data[i[r]].value;null!=s&&void 0!==s.nbFeatures&&(s=s.node),null!=s&&e(t?s:this._data[i[r]])}},lockData:function(e){var t,i,r=function(e){var t=this._data[e];if(void 0!==t&&(t.locks++,1===t.locks&&void 0!==t.value&&null!==t.value&&(void 0!==t.value.material&&null!==t.value.material||void 0!==t.value.children||void 0!==t.value.mesh3js))){t.value.traverse(function(e){if(void 0!==e.material&&null!==e.material&&o.activateAnimationUniforms(e.material),void 0!==e.mesh3js)for(var t=0;t<e.mesh3js.geometry[0].drawingGroups.length;++t){var i=e.mesh3js.geometry[0].drawingGroups[t].material;null!=i&&o.activateAnimationUniforms(i)}})}}.bind(this);if(e instanceof Array)for(t=0,i=e.length;t<i;++t)r(e[t]);else r(e)},unlockData:function(e){var t,i,r=function(e){var t=this._data[e];if(void 0!==t&&t.locks>0&&(t.locks--,0===t.locks&&void 0!==t.value&&null!==t.value&&(void 0!==t.value.material&&null!==t.value.material||void 0!==t.value.children||void 0!==t.value.mesh3js))){t.value.traverse(function(e){if(void 0!==e.material&&null!==e.material&&o.deactivateAnimationUniforms(e.material),void 0!==e.mesh3js){var t=e.mesh3js.geometry[0].drawingGroups[0].material;null!=t&&o.deactivateAnimationUniforms(t)}})}}.bind(this);if(e instanceof Array)for(t=0,i=e.length;t<i;++t)r(e[t]);else r(e)},isLocked:function(e,t){if(!(e instanceof Array)){var i=this._data[e];if(void 0!==i)return i.locks>0}return!1}};var h={},c=void 0,v=void 0,_=function(){this.createStore("default",{})};_.prototype={_getStoreInformation:function(e){return s.clone(h[e])},getStoreList:function(){return Object.keys(h)},createStore:function(e,t){void 0===h[e]?h[e]=new u(e,void 0!==t?t:{}):a.warn("Store: A store '"+e+"' is already defined. Cannot create a new one with same ID.")},deleteStore:function(e){void 0!==h[e]&&(this.cleanStore(e,!0),delete h[e])},getStore:function(e){if(void 0!==h[e])return h[e]},storeIsTimeDependant:function(e){return void 0!==h[e]&&h[e]._temporalParam.hasToBeConsidered},cleanStore:function(e,t){var i=h[e];void 0!==i&&i.clean(t)},cleanStores:function(e){var t;for(t in h)this.cleanStore(t,e)},unsubscribeCleanTo:function(){void 0!==c&&(t.unsubscribe(c),c=void 0)},subscribeCleanTo:function(e,i){var r=function(){(void 0===i||i())&&this.cleanStores()}.bind(this);this.unsubscribeCleanTo(),c=t.subscribeTo(e,r)},updateTimeStamp:function(e){var t,i=void 0===e?Date.now():e;for(t in h)h[t]._timestamp=i},unsubscribeTimeStampTo:function(){void 0!==v&&(t.unsubscribe(v),v=void 0)},subscribeTimeStampTo:function(e){this.unsubscribeTimeStampTo(),v=t.subscribeTo(e,this.updateTimeStamp.bind(this))},getData:function(e,t){var i=h[e];if(void 0!==i)return i.getData(t)},getOrDownloadData:function(e,t,i,r,a){var s=h[e];if(void 0!==s)return s.getOrDownloadData.apply(s,Array.prototype.slice.call(arguments,1))},cancelDownloadData:function(e,t){var i=h[e];void 0!==i&&i.cancelDownloadData(t)},updateTimestampData:function(e,t){var i=h[e];void 0!==i&&i._getData(t)},deprecate:function(e,t){var i=h[e];void 0!==i&&i.deprecateData(t)},deprecateAll:function(e){var t=h[e];void 0!==t&&t.deprecateData(Object.keys(t._data))},isDeprecated:function(e,t){var i=h[e];if(void 0!==i)return i.isDeprecated(t)},lock:function(e,t){var i=h[e];void 0!==i&&i.lockData(t)},unlock:function(e,t){var i=h[e];void 0!==i&&i.unlockData(t)},isLocked:function(e,t){var i=h[e];if(void 0!==i)return i.isLocked(t)},traverse:function(e,t,i){var r=h[e];if(void 0!==r)return void 0===i&&(i=!0),r.traverse(t,i)}};var f=null;return null===f&&(f=new _,window.XCityCoreStore=f),f}),define("DS/XCityCore/Profile",["UWA/Class/Events","UWA/Class","DS/xCityBasicUtils/Utils"],function(e,t,i){"use strict";var r=t.extend(e,{init:function(e,t){this._name=t,this._urban=e,this._dirty=!1,this._profileNodes=[],this._enabled=!1,this._savable=!0,this._deactivable=!0,this._removable=!0,this._internal=!1,this._temporary=!1},getName:function(){return this._name},add:function(e,t,i){this._profileNodes.push({callback:e,node:t,name:i}),this._dirty=!0},remove:function(e,t){for(var i=0;i<this._profileNodes.length;i++)if(!(e&&e!==this._profileNodes[i].node||t&&t!==this._profileNodes[i].name))return this._profileNodes.splice(i,1),this._dirty=!0,!0;return!1},set:function(e,t,i){var r=0,a=!1;for(r=0;r<this._profileNodes.length&&!a;r++)t===this._profileNodes[r].node&&(a=!0);a&&this._profileNodes.splice(r-1,1),this.add(e,t,i)},setByName:function(e,t,i){var r=0,a=!1,s=this._profileNodes.length;for(r=0;r<s&&!a;r++)i===this._profileNodes[r].name&&(a=!0);a&&this._profileNodes.splice(r-1,1),this.add(e,t,i)},clone:function(e){for(var t=new r(this._urban,e),i=0;i<this._profileNodes.length;i++)t.push({callback:this._profileNodes[i].callback,node:this._profileNodes[i].node});return t},hasNode:function(e){for(var t=0;t<this._profileNodes.length;t++)if(e===this._profileNodes[t].node)return!0;return!1},hasNodeName:function(e){for(var t=0;t<this._profileNodes.length;t++)if(e===this._profileNodes[t].name)return!0;return!1},getNode:function(e){for(var t=0;t<this._profileNodes.length;t++)if(e===this._profileNodes[t].name)return this._profileNodes[t].node},enable:function(e,t){var i;if(this._enabled=!0,t)for(i=0;i<this._profileNodes.length;i++)this._profileNodes[i].node===t&&this._profileNodes[i].callback(this._urban,t,e);else for(i=0;i<this._profileNodes.length;i++)this._profileNodes[i].callback(this._urban,this._profileNodes[i].node,e);this.dispatchEvent("onEnable",[this,t]),this._dirty=!1},disable:function(){this.isDeactivable()&&(this._enabled=!1)},_getInputProfile:function(){return{name:this.getName()}},toString:function(){var e=this._getInputProfile();return JSON.stringify(e)},getManager:function(){return null},duplicate:function(e){i.is(e)||(e=this.getManager()._getNewProfileDefaultName(this.getName()));var t=this._getInputProfile();t.name=e;var r=this.getManager();return i.is(r)?(r.loadProfiles(t),r.getProfile(e)):null},setName:function(e){this._name=e},clean:function(){},isEnabled:function(){return this._enabled},isSavable:function(){return this._savable},isDeactivable:function(){return this._deactivable},isRemovable:function(){return this._removable},isInternal:function(){return this._internal},isTemporary:function(){return this._temporary},setAsInternal:function(e){this._internal=e},setAsSavable:function(e){this._savable=e},setAsDeactivable:function(e){this._deactivable=e},setAsRemovable:function(e){this._removable=e},setAsTemporary:function(e){this._temporary=e}});return r}),define("DS/XCityCore/PlanarQuadtree",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher"],function(e,t,i,r){"use strict";var a=function(e,t,i){this.urban=e,this.levelMin=t,this.leafOnly=i,this.nbQuads=0,this._quadsArea2test=2,this.needRebuild=!0,this.cameraMovedToken=r.subscribeTo(r.eventsList.pointOfView,function(){this.needRebuild=!0}.bind(this)),this._quads=[],this.sizeQuadPool=600,this._quads.length=this.sizeQuadPool;for(var a=0;a<this.sizeQuadPool;++a)this._quads[a]={LOD:0,I:0,J:0,dist:0,leaf:!0,key:void 0,timestamp:0}};return a.prototype={dispose:function(){r.unsubscribe(this.cameraMovedToken),this.cameraMovedToken=void 0,this._quads=void 0},build:function(e,t,i){this.timestamp=Date.now(),this.nbQuads=0,this.maxLevel=e;for(var r,a,s,o,n,l,d,u,h,c=e,v=1,_=-1,f=1,p=-1;c>=this.levelMin;){for(u=(1<<c)-1,o=(o=(s=this.getBaseIJ(c,t,i)).I-this._quadsArea2test)%2!=0?o-1:o,o=Math.max(o,0),n=(n=s.I+this._quadsArea2test)%2==0?n+1:n,n=Math.min(n,u),l=(l=s.J-this._quadsArea2test)%2!=0?l-1:l,l=Math.max(l,0),d=(d=s.J+this._quadsArea2test)%2==0?d+1:d,d=Math.min(d,u),r=o;r<=n;r++)for(a=l;a<=d;a++)r<0||a<0||r>u||a>u||this.leafOnly&&r>=f&&r<=p&&a>=v&&a<=_||(h=!(r>=f&&r<=p&&a>=v&&a<=_),this.addQuad(h,c,r,a,(e-c+1)*(Math.abs(r-s.I)+Math.abs(a-s.J))));1,2,c-=1,f=Math.floor(o/2),v=Math.floor(l/2),p=Math.floor(n/2),_=Math.floor(d/2)}return this.leafOnly&&0===this.nbQuads&&0===this.levelMin&&this.addQuad(!0,0,0,0,0),this.needRebuild=!1,!0},getBaseIJ:function(e,t,i){var r=1<<e;return{I:Math.floor(t*r),J:Math.floor(i*r)}},getXY:function(t,i,r){return new e.Vector2((i+.5)/t,(r+.5)/t)},getXYVector:function(e,t,i,r){r.set((t+.5)/e,(i+.5)/e)},getLength:function(){return this.nbQuads},getQuad:function(e){if(!(e<0||e>this.nbQuads))return t.cloneQuad(this._quads[e])},addQuad:function(e,r,a,s,o){if(this.nbQuads===this.sizeQuadPool){var n=[];n.length=50;for(var l=0;l<50;++l)n[l]={LOD:0,I:0,J:0,dist:0,leaf:e,key:void 0,timestamp:0};this._quads=this._quads.concat(n),this.sizeQuadPool+=50,i.warn("The entire quad pool of PlanarQuadTree is busy, 50 more quads have just been added."),i.warn("New pool size is "+this._quads.length+".")}var d=this.nbQuads;this._quads[d].LOD=r,this._quads[d].I=a,this._quads[d].J=s,this._quads[d].dist=o,this._quads[d].leaf=e,this._quads[d].key=t.getQuadKey(r,a,s),this._quads[d].timestamp=this.timestamp,this.nbQuads++},subdivide:function(){for(var e,i=this.nbQuads,r=0;r<i;++r)e=this._quads[r],this.addQuad(!0,e.LOD+1,2*e.I,2*e.J,e.dist),this.addQuad(!0,e.LOD+1,2*e.I+1,2*e.J,e.dist),this.addQuad(!0,e.LOD+1,2*e.I+1,2*e.J+1,e.dist),e.LOD++,e.I=2*e.I,e.J=2*e.J+1,e.key=t.getQuadKey(e.LOD,e.I,e.J)},_sortByDist:function(e,t){return void 0===e.key?999999:void 0===t.key?-999999:e.dist-t.dist},_sortByLOD:function(t,i,r){if(void 0===i.key||i.timestamp!==this.timestamp)return 1;if(void 0===r.key||r.timestamp!==this.timestamp)return-1;var a=new e.Vector3(this.urban.worldSize/(1<<i.LOD),this.urban.worldSize/(1<<i.LOD),1),s=Math.max(a.x,a.y,a.z)/2,o=new e.Vector3((i.I+.5)*a.x,(i.J+.5)*a.y,0),n=o;this.urban.USR.viewpoint._translateToRelativePosition(n,!0);for(var l=this.urban.USR.viewpoint.frustum.planes,d=!0,u=0;u<6;u++){l[u].distanceToPoint(n)<=-s&&(d=!1)}a=new e.Vector3(this.urban.worldSize/(1<<r.LOD),this.urban.worldSize/(1<<r.LOD),1),s=Math.max(a.x,a.y,a.z)/2,n=o=new e.Vector3((r.I+.5)*a.x,(r.J+.5)*a.y,0),this.urban.USR.viewpoint._translateToRelativePosition(n,!0);for(var h=!0,c=0;c<6;c++){l[c].distanceToPoint(n)<=-s&&(h=!1)}return!0===d&&!0===h?i.LOD>r.LOD?-1:i.LOD<r.LOD?1:i.dist<r.dist?-1:i.dist>r.dist?1:0:!0===d&&!1===h?-1:!1===d&&!0===h?1:i.LOD>r.LOD?-1:i.LOD<r.LOD?1:i.dist<r.dist?-1:i.dist>r.dist?1:0},sortTiles:function(e){this._quads.sort(this._sortByLOD.bind(this,e))},setNbQuadsPerLevelArea:function(e){this._quadsArea2test=e<6?2:Math.floor((e-1)/2)}},a}),define("DS/XCityCore/VisuQuadTreeSirocco",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityCore/PlanarQuadtree","DS/XCityCore/Store","DS/XCityTools/EventDispatcher","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils"],function(e,t,i,r,a,s,o,n){"use strict";var l=function(i,a,s){this._clock=new e.Clock,this._name="VisuQuadTreeSirocco_"+a,this._urban=i,this._lodbias=1,this._qt=new r(this._urban,0,!1),this._qt.name="IdealQuadTreeSirocco_"+a,this._doQtUpdate=function(){return!0}.bind(this),this._qtBias=new r(this._urban,0,!0),this._qtBias.name="IdealQuadTreeSirocco_"+a,this._doQtBiasUpdate=function(){return!0}.bind(this),this._node=new t,this._node.name=this._name,this._vqtKeys=[],this._holeKeys=[],this._target={level:-1,x:0,y:0,canUseParent:!1},this._currentMaxLevel=-1,this._availableVQT={},this._pendingVQT={},this._cropBox=void 0,this._cropIJBoxes={},this._holes={},this._dirty=!1,this._pixelCulling=!1,this.dataInProcess=!1,void 0!==s&&this.setup(s),this._dataSources={},this._activeDataSources={},this._nbActiveDataSources=0,this._activeDataSourcesInTile=[],this._nbActiveDataSourcesInTile=0,this._leavesDataSources={},this._tilePos=new e.Vector3(0,0,0),this._tileBox={mMinX:0,mMaxX:0,mMinY:0,mMaxY:0,mMinZ:0,mMaxZ:0},this._tileBoxXminYminZmin=new e.Vector3(0,0,0),this._tileBoxXmaxYminZmin=new e.Vector3(0,0,0),this._tileBoxXminYmaxZmin=new e.Vector3(0,0,0),this._tileBoxXmaxYmaxZmin=new e.Vector3(0,0,0),this._tileBoxXminYminZmax=new e.Vector3(0,0,0),this._tileBoxXmaxYminZmax=new e.Vector3(0,0,0),this._tileBoxXminYmaxZmax=new e.Vector3(0,0,0),this._tileBoxXmaxYmaxZmax=new e.Vector3(0,0,0)};return l.prototype={setup:function(e){void 0!==e&&(e.qtTest&&"function"==typeof e.qtTest&&(this._doQtUpdate=e.qtTest),e.cropBox!==this._cropBox&&(this._cropBox=e.cropBox,this._cropIJBoxes={},this._cropBox&&(this._cropIJBoxes[0]={},this._cropBox.getIJBox(0,this._cropIJBoxes[0]))))},reset:function(){for(var e in this._currentMaxLevel=-1,this._target.level=-1,this._target.x=0,this._target.y=0,this._availableVQT={},this._pendingVQT={},this._cropBox=void 0,this._cropIJBoxes={},this._holes={},this._dirty=!1,this._pixelCulling=!1,this._vqtKeys=[],this._holeKeys=[],this._dataSources)this.removeDataSource(e);this._activeDataSources={},this._nbActiveDataSources=0,this._dataSources={},this._activeDataSourcesInTile=[],this._nbActiveDataSourcesInTile=0,this._leavesDataSources={}},dispose:function(){o.warn("VQTSirocco - dispose"),this.reset(),this._qt.dispose(),this._qtBias.dispose()},debug:function(){return"<br />Level loaded: "+this._currentMaxLevel+"<br />Patches loaded: "+this._node.getChildren().length},_cullingTest:function(e){if(void 0!==this._cropBox){void 0===this._cropIJBoxes[e.LOD]&&(this._cropIJBoxes[e.LOD]={},this._cropBox.getIJBox(e.LOD,this._cropIJBoxes[e.LOD]));var t=this._cropIJBoxes[e.LOD];if(e.I<t.IMin||e.J<t.JMin||e.I>t.IMax||e.J>t.JMax)return!0;e.I!==t.IMin&&e.J!==t.JMin&&e.I!==t.IMax&&e.J!==t.JMax||(e.intersectCropBox=!0)}return!1},_isTileVisible:function(){for(var e=this._urban.USR.viewpoint.frustum.planes,t=0;t<6;t++){var i=0;if(i+=e[t].distanceToPoint(this._tileBoxXminYminZmin)<0?1:0,i+=e[t].distanceToPoint(this._tileBoxXmaxYminZmin)<0?1:0,i+=e[t].distanceToPoint(this._tileBoxXminYmaxZmin)<0?1:0,i+=e[t].distanceToPoint(this._tileBoxXmaxYmaxZmin)<0?1:0,i+=e[t].distanceToPoint(this._tileBoxXminYminZmax)<0?1:0,i+=e[t].distanceToPoint(this._tileBoxXmaxYminZmax)<0?1:0,i+=e[t].distanceToPoint(this._tileBoxXminYmaxZmax)<0?1:0,8==(i+=e[t].distanceToPoint(this._tileBoxXmaxYmaxZmax)<0?1:0))return!1}return!0},addDataSource:function(e,i){if(void 0===i&&(i=new t),this._dataSources[e.id]=e,e.node=i,e.lodBiasVisu=e.lodBias,i.url=e.url,i.idDataSource=e.id,i.objectId=e.objectId,e.AABBox){for(var r=[],a=this._dataSources[e.id],s=a.levelMin;s<=Math.min(42,Math.max(25,a.levelMax));s++){r.push(e.AABBox.getIJBox(s,{}))}a.filter=r}this._node.addChild(i),this._vqtKeys[e.id]=[],e.visible&&(this._activeDataSources[e.id]=e,this._nbActiveDataSources++,this._activeDataSourcesInTile.length=this._nbActiveDataSources,this._leavesDataSources[e.id]=[])},removeDataSource:function(e){if(void 0!==this._dataSources[e]){for(var t=this._dataSources[e].node,i=t.children.length;i--;){var r=t.children[i];void 0!==r.storeKey&&(t.remove(r),a.unlock(e,r.storeKey))}a.cleanStore(e,!0),this._node.removeChild(t),delete this._dataSources[e],void 0!==this._activeDataSources[e]&&(delete this._activeDataSources[e],delete this._leavesDataSources[e],this._nbActiveDataSources--,this._activeDataSourcesInTile.length=this._nbActiveDataSources)}},setDataSourceAttribute:function(e,t,i){if(this._dataSources[e][t]=i,"visible"===t)i?(this._activeDataSources[this._dataSources[e].id]=this._dataSources[e],this._leavesDataSources[this._dataSources[e].id]=[],this._nbActiveDataSources++):(delete this._activeDataSources[this._dataSources[e].id],delete this._leavesDataSources[this._dataSources[e].id],this._nbActiveDataSources--),this._activeDataSourcesInTile.length=this._nbActiveDataSources;else if(("levelMin"===t||"levelMax"===t)&&this._dataSources[e].AABBox){for(var r=[],a=this._dataSources[e],s=a.levelMin;s<=Math.min(42,Math.max(25,a.levelMax));s++){r.push(this._dataSources[e].AABBox.getIJBox(s,{}))}a.filter=r}},getDataSources:function(e,t){this._nbActiveDataSourcesInTile=0;for(var i=Object.keys(this._activeDataSources),r=0,a=i.length;r<a;r++){var s=this._activeDataSources[i[r]];if(!0!==s.clusteringMode)if(s.previewMode||!0===s.clusteringMode){if(s.visible&&e.leaf&&e.LOD>=s.levelMin&&(!s.filter||e.I>=s.filter[e.LOD-s.levelMin].IMin&&e.I<=s.filter[e.LOD-s.levelMin].IMax&&e.J>=s.filter[e.LOD-s.levelMin].JMin&&e.J<=s.filter[e.LOD-s.levelMin].JMax)){for(var o=Math.floor(e.I/2),l=Math.floor(e.J/2),d=!1,u=e.LOD-1;u>=s.levelMin;--u){var h=n.getQuadKey(u,o,l);-1!==this._leavesDataSources[s.id].indexOf(h)?(d=!0,u=-1):(o=Math.floor(o/2),l=Math.floor(l/2))}d||(this._activeDataSourcesInTile[this._nbActiveDataSourcesInTile]=s,this._nbActiveDataSourcesInTile++)}}else if(s.visible&&e.LOD>=s.levelMin&&(!s.filterLevelMax||e.LOD<=s.levelMax+s.lodBiasVisu)&&(!s.filter||e.I>=s.filter[e.LOD-s.levelMin].IMin&&e.I<=s.filter[e.LOD-s.levelMin].IMax&&e.J>=s.filter[e.LOD-s.levelMin].JMin&&e.J<=s.filter[e.LOD-s.levelMin].JMax)){for(o=Math.floor(e.I/2),l=Math.floor(e.J/2),d=!1,u=e.LOD-1;u>=s.levelMin;--u){h=n.getQuadKey(u,o,l);-1!==this._leavesDataSources[s.id].indexOf(h)?(d=!0,u=-1):(o=Math.floor(o/2),l=Math.floor(l/2))}d||(this._activeDataSourcesInTile[this._nbActiveDataSourcesInTile]=s,this._nbActiveDataSourcesInTile++)}}},getDataSourcesClustered:function(e,t){this._nbActiveDataSourcesInTile=0;for(var i=Object.keys(this._activeDataSources),r=0,a=i.length;r<a;r++){var s=this._activeDataSources[i[r]];if(!0===s.clusteringMode&&(s.visible&&e.leaf&&e.LOD>=s.levelMin&&(!s.filter||e.I>=s.filter[e.LOD-s.levelMin].IMin&&e.I<=s.filter[e.LOD-s.levelMin].IMax&&e.J>=s.filter[e.LOD-s.levelMin].JMin&&e.J<=s.filter[e.LOD-s.levelMin].JMax))){for(var o=Math.floor(e.I/2),l=Math.floor(e.J/2),d=!1,u=e.LOD-1;u>=s.levelMin;--u){var h=n.getQuadKey(u,o,l);-1!==this._leavesDataSources[s.id].indexOf(h)?(d=!0,u=-1):(o=Math.floor(o/2),l=Math.floor(l/2))}d||(this._activeDataSourcesInTile[this._nbActiveDataSourcesInTile]=s,this._nbActiveDataSourcesInTile++)}}},_lookForAvailableParent:function(e,t,i,r,a,s){var o=n.getQuadKey(e,t,i);-1!==this._vqtKeys[s].indexOf(o)?r[s][o]={LOD:e,I:t,J:i,key:o}:e>a&&this._lookForAvailableParent(e-1,t>>1,i>>1,r,a,s)},_lookForAvailableChildren:function(e,t,i,r,a,s){var o=n.getQuadKey(e,t,i);-1!==this._vqtKeys[s].indexOf(o)&&(r[s][o]={LOD:e,I:t,J:i,key:o}),e<a&&(this._lookForAvailableChildren(e+1,t<<1,i<<1,r,a,s),this._lookForAvailableChildren(e+1,t<<1,1+(i<<1),r,a,s),this._lookForAvailableChildren(e+1,1+(t<<1),1+(i<<1),r,a,s),this._lookForAvailableChildren(e+1,1+(t<<1),i<<1,r,a,s))},_shouldBeWaiting:function(e,t,i,r,a){var s=n.getQuadKey(e,t,i);return void 0!==this._temporaryClusterParent[a][s]||e>r&&this._shouldBeWaiting(e-1,t>>1,i>>1,r,a)},_hasAFinalParentNode:function(e,t,i,r,s,o){var l=n.getQuadKey(e,t,i);if(-1!==this._vqtKeys[o].indexOf(l)){var d=a.getData([o],l);return n.is(d)&&n.is(d.node)&&d.nbFeatures<100?{LOD:e,I:t,J:i,key:l}:void 0}return e>s?this._hasAFinalParentNode(e-1,t>>1,i>>1,r,s,o):void 0},_hasAFinalParentNode2:function(e,t,i,r,s,o){var l=n.getQuadKey(e,t,i);if(-1!==this._vqtKeys[o].indexOf(l)){var d=a.getData([o],l);return n.is(d)&&n.is(d.node)&&(0===d.node.clusterType||2===d.node.clusterType||e===this._activeDataSources[o].levelMax)?{LOD:e,I:t,J:i,key:l}:void 0}return e>s?this._hasAFinalParentNode2(e-1,t>>1,i>>1,r,s,o):void 0},update:function(e,t,i,r){var s,o,l,d,u;this.dataInProcess=!1,this._doQtUpdate&&!0===this._doQtUpdate()&&(r||this._qt.needRebuild)&&(this._target.level=e,this._target.x=t,this._target.y=i,this._qt.build(this._target.level,this._target.x,this._target.y));this._availableVQT={},this._temporaryClusterParent={},this._temporaryChildren={};for(var h=Object.keys(this._activeDataSources),c=0,v=h.length;c<v;c++)this._availableVQT[h[c]]={},this._temporaryClusterParent[h[c]]={},this._temporaryChildren[h[c]]={};u=this._qt.nbQuads;for(var _=0;_<u;)if(s={tile:this._qt.getQuad(_)},_++,!this._cullingTest(s.tile)){var f=this._urban.worldSize/(1<<s.tile.LOD);if(this._tilePos.set((s.tile.I+.5)*f,(s.tile.J+.5)*f,0),this._tileBox.mMinX=this._tilePos.x-f/2-this._urban.USR.viewpoint._camShiftedTranslation.x,this._tileBox.mMaxX=this._tilePos.x+f/2-this._urban.USR.viewpoint._camShiftedTranslation.x,this._tileBox.mMinY=this._tilePos.y-f/2-this._urban.USR.viewpoint._camShiftedTranslation.y,this._tileBox.mMaxY=this._tilePos.y+f/2-this._urban.USR.viewpoint._camShiftedTranslation.y,this._tileBox.mMinZ=0,this._tileBox.mMaxZ=4500,this._tileBoxXminYminZmin.set(this._tileBox.mMinX,this._tileBox.mMinY,this._tileBox.mMinZ),this._tileBoxXmaxYminZmin.set(this._tileBox.mMaxX,this._tileBox.mMinY,this._tileBox.mMinZ),this._tileBoxXminYmaxZmin.set(this._tileBox.mMinX,this._tileBox.mMaxY,this._tileBox.mMinZ),this._tileBoxXmaxYmaxZmin.set(this._tileBox.mMaxX,this._tileBox.mMaxY,this._tileBox.mMinZ),this._tileBoxXminYminZmax.set(this._tileBox.mMinX,this._tileBox.mMinY,this._tileBox.mMaxZ),this._tileBoxXmaxYminZmax.set(this._tileBox.mMaxX,this._tileBox.mMinY,this._tileBox.mMaxZ),this._tileBoxXminYmaxZmax.set(this._tileBox.mMinX,this._tileBox.mMaxY,this._tileBox.mMaxZ),this._tileBoxXmaxYmaxZmax.set(this._tileBox.mMaxX,this._tileBox.mMaxY,this._tileBox.mMaxZ),s.isVisible=this._isTileVisible(),!0===s.isVisible){o=s.tile.LOD,l=s.tile.I,d=s.tile.J,s.priority=Math.max(0,s.tile.LOD),this.getDataSources(s.tile);for(c=0;c<this._nbActiveDataSourcesInTile;c++){var p=this._activeDataSourcesInTile[c],m=!1;if(!0===p.clusteringMode){if(!(m=this._hasAFinalParentNode2(o-1,l>>1,d>>1,this._previewNodes,0,p.id))&&o>p.levelMax)continue}else p.previewMode&&(m=this._hasAFinalParentNode(o-1,l>>1,d>>1,this._previewNodes,0,p.id));if(m)this._availableVQT[p.id][m.key]={LOD:m.LOD,I:m.I,J:m.J,key:m.key};else{s.tile.T=encodeURIComponent(this._urban.date._date.getUTCFullYear()+"/"+(this._urban.date._date.getMonth()+1)+"/"+this._urban.date._date.getDate());var x=a.getOrDownloadData(p.id,s.tile.key,s);n.is(x)?(n.is(x.node)?(this._availableVQT[p.id][s.tile.key]={LOD:s.tile.LOD,I:s.tile.I,J:s.tile.J,key:s.tile.key},void 0!==x.node.isCoreReady&&(("function"!=typeof x.node.isCoreReady||x.node.isCoreReady())&&x.node.isCoreReady||(this.dataInProcess=!0))):x.nbFeatures>0&&(this.dataInProcess=!0,(p.previewMode||!0===p.clusteringMode)&&(this._lookForAvailableParent(o-1,l>>1,d>>1,this._temporaryClusterParent,0,p.id),this._lookForAvailableChildren(o+1,l<<1,d<<1,this._temporaryChildren,this._currentMaxLevel,p.id),this._lookForAvailableChildren(o+1,l<<1,1+(d<<1),this._temporaryChildren,this._currentMaxLevel,p.id),this._lookForAvailableChildren(o+1,1+(l<<1),1+(d<<1),this._temporaryChildren,this._currentMaxLevel,p.id),this._lookForAvailableChildren(o+1,1+(l<<1),d<<1,this._temporaryChildren,this._currentMaxLevel,p.id))),0===x.nbFeatures&&s.tile.LOD<p.levelMax&&-1===this._leavesDataSources[p.id].indexOf(s.tile.key)&&this._leavesDataSources[p.id].push(s.tile.key)):(this.dataInProcess=!0,(p.previewMode||!0===p.clusteringMode)&&(this._lookForAvailableParent(o-1,l>>1,d>>1,this._temporaryClusterParent,0,p.id),this._lookForAvailableChildren(o+1,l<<1,d<<1,this._temporaryChildren,this._currentMaxLevel,p.id),this._lookForAvailableChildren(o+1,l<<1,1+(d<<1),this._temporaryChildren,this._currentMaxLevel,p.id),this._lookForAvailableChildren(o+1,1+(l<<1),1+(d<<1),this._temporaryChildren,this._currentMaxLevel,p.id),this._lookForAvailableChildren(o+1,1+(l<<1),d<<1,this._temporaryChildren,this._currentMaxLevel,p.id)))}}0}}this.updateLodBias(e,t,i,r)},updateLodBias:function(e,t,i,r){var s,o,l,d,u;this._doQtBiasUpdate&&!0===this._doQtBiasUpdate()&&(r||this._qtBias.needRebuild)&&(this._target.level=e,this._target.x=t,this._target.y=i,this._qtBias.build(this._target.level+this._lodbias,this._target.x,this._target.y),this._qtBias.subdivide());u=this._qtBias.nbQuads;for(var h=0;h<u;)if(s={tile:this._qtBias.getQuad(h)},h++,!this._cullingTest(s.tile)){var c=this._urban.worldSize/(1<<s.tile.LOD);if(this._tilePos.set((s.tile.I+.5)*c,(s.tile.J+.5)*c,0),this._tileBox.mMinX=this._tilePos.x-c/2-this._urban.USR.viewpoint._camShiftedTranslation.x,this._tileBox.mMaxX=this._tilePos.x+c/2-this._urban.USR.viewpoint._camShiftedTranslation.x,this._tileBox.mMinY=this._tilePos.y-c/2-this._urban.USR.viewpoint._camShiftedTranslation.y,this._tileBox.mMaxY=this._tilePos.y+c/2-this._urban.USR.viewpoint._camShiftedTranslation.y,this._tileBox.mMinZ=0,this._tileBox.mMaxZ=4500,this._tileBoxXminYminZmin.set(this._tileBox.mMinX,this._tileBox.mMinY,this._tileBox.mMinZ),this._tileBoxXmaxYminZmin.set(this._tileBox.mMaxX,this._tileBox.mMinY,this._tileBox.mMinZ),this._tileBoxXminYmaxZmin.set(this._tileBox.mMinX,this._tileBox.mMaxY,this._tileBox.mMinZ),this._tileBoxXmaxYmaxZmin.set(this._tileBox.mMaxX,this._tileBox.mMaxY,this._tileBox.mMinZ),this._tileBoxXminYminZmax.set(this._tileBox.mMinX,this._tileBox.mMinY,this._tileBox.mMaxZ),this._tileBoxXmaxYminZmax.set(this._tileBox.mMaxX,this._tileBox.mMinY,this._tileBox.mMaxZ),this._tileBoxXminYmaxZmax.set(this._tileBox.mMinX,this._tileBox.mMaxY,this._tileBox.mMaxZ),this._tileBoxXmaxYmaxZmax.set(this._tileBox.mMaxX,this._tileBox.mMaxY,this._tileBox.mMaxZ),s.isVisible=this._isTileVisible(),!0===s.isVisible){o=s.tile.LOD,l=s.tile.I,d=s.tile.J,s.priority=Math.max(0,s.tile.LOD),this.getDataSourcesClustered(s.tile);for(var v=0;v<this._nbActiveDataSourcesInTile;v++){var _=this._activeDataSourcesInTile[v],f=!1;if(!0===_.clusteringMode){if(!(f=this._hasAFinalParentNode2(o-1,l>>1,d>>1,this._previewNodes,0,_.id))&&o>_.levelMax)continue}else _.previewMode&&(f=this._hasAFinalParentNode(o-1,l>>1,d>>1,this._previewNodes,0,_.id));if(f)this._availableVQT[_.id][f.key]={LOD:f.LOD,I:f.I,J:f.J,key:f.key};else{var p=a.getOrDownloadData(_.id,s.tile.key,s);n.is(p)?(n.is(p.node)?(this._availableVQT[_.id][s.tile.key]={LOD:s.tile.LOD,I:s.tile.I,J:s.tile.J,key:s.tile.key},void 0!==p.node.isCoreReady&&(("function"!=typeof p.node.isCoreReady||p.node.isCoreReady())&&p.node.isCoreReady||(this.dataInProcess=!0))):p.nbFeatures>0&&(this.dataInProcess=!0,(_.previewMode||!0===_.clusteringMode)&&(this._lookForAvailableParent(o-1,l>>1,d>>1,this._temporaryClusterParent,0,_.id),this._lookForAvailableChildren(o+1,l<<1,d<<1,this._temporaryChildren,this._currentMaxLevel,_.id),this._lookForAvailableChildren(o+1,l<<1,1+(d<<1),this._temporaryChildren,this._currentMaxLevel,_.id),this._lookForAvailableChildren(o+1,1+(l<<1),1+(d<<1),this._temporaryChildren,this._currentMaxLevel,_.id),this._lookForAvailableChildren(o+1,1+(l<<1),d<<1,this._temporaryChildren,this._currentMaxLevel,_.id))),0===p.nbFeatures&&s.tile.LOD<_.levelMax&&-1===this._leavesDataSources[_.id].indexOf(s.tile.key)&&this._leavesDataSources[_.id].push(s.tile.key)):(this.dataInProcess=!0,(_.previewMode||!0===_.clusteringMode)&&(this._lookForAvailableParent(o-1,l>>1,d>>1,this._temporaryClusterParent,0,_.id),this._lookForAvailableChildren(o+1,l<<1,d<<1,this._temporaryChildren,this._currentMaxLevel,_.id),this._lookForAvailableChildren(o+1,l<<1,1+(d<<1),this._temporaryChildren,this._currentMaxLevel,_.id),this._lookForAvailableChildren(o+1,1+(l<<1),1+(d<<1),this._temporaryChildren,this._currentMaxLevel,_.id),this._lookForAvailableChildren(o+1,1+(l<<1),d<<1,this._temporaryChildren,this._currentMaxLevel,_.id)))}}0}}},display:function(e){var t;this._currentMaxLevel=0;for(var i=0;i<this._node.children.length;++i){for(var r=this._node.children[i],s=r.children.length,o=void 0!==this._activeDataSources[r.idDataSource];s--;)void 0!==(t=r.children[s]).storeKey&&"searchRequest"!==t.storeKey&&"cache"!==t.storeKey&&(!this._dirty&&o?this._availableVQT[r.idDataSource][t.storeKey]?this._currentMaxLevel=this._availableVQT[r.idDataSource][t.storeKey].LOD>this._currentMaxLevel?this._availableVQT[r.idDataSource][t.storeKey].LOD:this._currentMaxLevel:this._temporaryClusterParent[r.idDataSource][t.storeKey]?this._currentMaxLevel=this._temporaryClusterParent[r.idDataSource][t.storeKey].LOD>this._currentMaxLevel?this._temporaryClusterParent[r.idDataSource][t.storeKey].LOD:this._currentMaxLevel:this._temporaryChildren[r.idDataSource][t.storeKey]?this._currentMaxLevel=this._temporaryChildren[r.idDataSource][t.storeKey].LOD>this._currentMaxLevel?this._temporaryChildren[r.idDataSource][t.storeKey].LOD:this._currentMaxLevel:(r.remove(t),n.resetLODs(t),n.is(this._vqtKeys[r.idDataSource])&&this._vqtKeys[r.idDataSource].splice(this._vqtKeys[r.idDataSource].indexOf(t.storeKey),1),a.unlock(r.idDataSource,t.storeKey)):(r.remove(t),n.resetLODs(t),n.is(this._vqtKeys[r.idDataSource])&&this._vqtKeys[r.idDataSource].splice(this._vqtKeys[r.idDataSource].indexOf(t.storeKey),1),a.unlock(r.idDataSource,t.storeKey)));var l=this._availableVQT[r.idDataSource];if(void 0!==l)for(var d=Object.keys(l),u=d.length;u--;){var h=Number(d[u]);if(this._dirty||-1===this._vqtKeys[r.idDataSource].indexOf(h)){var c=a.getData([r.idDataSource],h);n.is(c)&&n.is(c.node)&&(r.add(c.node),this._vqtKeys[r.idDataSource].push(h),a.lock([r.idDataSource],h))}else;}}this._dirty=!1}},l}),define("DS/XCityCore/ProfileManager",["UWA/Class/Events","UWA/Class","DS/XCityCore/Profile","DS/xCityBasicUtils/Utils","DS/XCityTools/Downloader"],function(e,t,i,r,a){"use strict";return t.extend(e,{init:function(e,t){this._urban=e,this._type=t,this._profiles={},this._profileCurrent=void 0,this.request=0,this.defaultProfile=void 0,this.defaultNewProfile="currentprofile"},getDefaultProfile:function(){return this.getProfile(this.defaultProfile)},setDefaultProfile:function(){this.setProfile(this.defaultProfile)},_initdefaultProfile:function(e){this._profileCurrent=this.getProfile(e),r.is(this._profileCurrent)||(this._profileCurrent=this.createProfile(e),this.dispatchAddedEvent(e)),this._profileCurrent.enable()},createProfile:function(e){var t=this._profiles[e];return t||(t=this._createProfile(this._urban,e),this._profiles[e]=t),t},getProfile:function(e){return this._profiles[e]},addProfile:function(e,t,i,a){var s=this.getProfile(e);r.is(s)||(s=this.createProfile(e),this.dispatchAddedEvent(e)),s.add(t,i,a),this.getCurrentProfileName()===e&&t(this._urban,i)},removeProfile:function(e,t,i){if(r.is(e)&&e!==this.defaultProfile){var a=this._profiles[e];if(r.is(a))if(t||i)a.remove(t,i);else{if(e===this.getCurrentProfileName()){var s=this.getProfileNames();if(r.is(s)&&s.length>0){var o=s[0];o===e&&(s.length>1?o=s[1]:r.is(this.defaultProfile)&&(o=this.defaultProfile)),this.setProfile(o)}}else this._profiles[e].disable();a.isRemovable()?(delete this._profiles[e],this.dispatchRemovedEvent(e)):(a.clean(),a.resetRender(this.urban,this._profiles[this.defaultProfile]))}}},setProfile:function(e,t){if(r.is(e)&&e!==this.getCurrentProfileName()){var i=this._profiles[e];if(i)return r.is(this._profileCurrent)&&this._profileCurrent.disable(),this._profileCurrent=i,i.enable(this._profileCurrent,t),!0}return!1},enable:function(e,t){var i=this._profiles[e];return!!i&&(i.enable(this._profileCurrent,t),this._profileCurrent=i,!0)},getProfileNames:function(){var e,t,i=[],a=Object.keys(this._profiles),s=a.length;for(t=0;t<s;t++)if((e=a[t])!==this.defaultProfile){var o=this._profiles[e];r.is(o)&&!o.isInternal()&&i.push(e)}return i},loadProfiles:function(e){if(this._parseProfile(e),0===this.request){this._profileToLoad=!1;var t=this.getCurrentProfile();r.is(t)&&!0===t._dirty&&this.setProfile(t.getName()),this.dispatchEvent("onProfilesLoaded",!0)}},_parseProfile:function(e){if(r.is(e))if(r.is(e.name))this._parseOneProfile&&this._parseOneProfile(e);else if(Array.isArray(e))for(var t=0;t<e.length;t++)this._parseProfile(e[t]);else if("object"==typeof e)for(var i in e)e.hasOwnProperty(i)&&this._parseProfile(e[i]);else if("string"==typeof e){var a=e;this._loadJSON(a)}},_loadJSON:function(e){this.request++;a.download(e,{responseType:"json"},999999,function(e,t,i,r){r(t,e,i)},void 0,function(t,i,a){if(i)try{var s=t;r.is(this._parseProfile)&&this._parseProfile(s)}catch(e){this.dispatchEvent("onProfilesLoaded",!1),console.error("Error while loading profiles: "+e.stack)}else this.dispatchEvent("onProfilesLoaded",!1),console.error("Could not parse profile  "+e),r.is(a)&&r.is(a.stack)&&console.error(a.stack);if(this.request--,0===this.request){this._profileToLoad=!1;var o=this.getCurrentProfile();r.is(o)&&!0===o._dirty&&this.setProfile(o.getName()),this.dispatchEvent("onProfilesLoaded",!0)}}.bind(this))},getCurrentProfileName:function(){if(r.is(this._profileCurrent)&&!this._profileCurrent.isInternal())return this._profileCurrent.getName();return""},getCurrentProfile:function(){return this.getProfile(this.getCurrentProfileName())},_getNewProfileDefaultName:function(e){var t=this.defaultNewProfile;r.is(e)&&(t=e);for(var i=1,a=t+"_"+i;r.is(this.getProfile(a));)a=t+"_"+ ++i;return a},renameProfile:function(e,t){if(this.getProfile(t))return!1;var i=this.getProfile(e);return!!r.is(i)&&(this._profiles[t]=this._profiles[e],i.setName(t),this._profiles[e]=void 0,!0)},reset:function(){var e,t,i=this.getProfileNames();for(e=0,t=i.length;e<t;++e)this.removeProfile(i[e])}})}),define("DS/XCityCore/VisuQuadTree",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityCore/PlanarQuadtree","DS/XCityCore/Store","DS/XCityTools/EventDispatcher","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils"],function(e,t,i,r,a,s,o,n){"use strict";var l=function(i,a,s){this._clock=new e.Clock,this._name="VisuQuadTree_"+a,this._urban=i,this._qt=new r(this._urban,0,!0),this._qt.name="IdealQuadTree_"+a,this._doQtUpdate=function(){return!0}.bind(this),this._node=new t,this._node.name=this._name,this._vqtKeys=[],this._holeKeys=[],this._target={level:-1,x:0,y:0,canUseParent:!1},this._currentMaxLevel=-1,this._availableVQT={},this._pendingVQT={},this._cropBox=void 0,this._cropIJBoxes={},this._holes={},this._dirty=!1,this._pixelCulling=!1,this._frameCounter=0,this.terrainInProcess=!1,void 0!==s&&this.setup(s)};return l.prototype={setup:function(e){void 0!==e&&(e.qtTest&&"function"==typeof e.qtTest&&(this._doQtUpdate=e.qtTest),e.cropBox!==this._cropBox&&(this._cropBox=e.cropBox,this._cropIJBoxes={},this._cropBox&&(this._cropIJBoxes[0]={},this._cropBox.getIJBox(0,this._cropIJBoxes[0]))))},reset:function(){this._currentMaxLevel=-1,this._target.level=-1,this._target.x=0,this._target.y=0,this._availableVQT={},this._pendingVQT={},this._cropBox=void 0,this._cropIJBoxes={},this._holes={},this._dirty=!1,this._pixelCulling=!1,this._vqtKeys=[],this._holeKeys=[];for(var e,t=this._node.getChildren(),i=t.length;i--;)e=t[i],a.unlock(e.storeId,e.storeKey),this._node.remove(e);a.cleanStore("terrain",!0)},dispose:function(){o.warn("VQT - dispose"),this.reset(),this._qt.dispose()},debug:function(){return"<br />Level loaded: "+this._currentMaxLevel+"<br />Patches loaded: "+this._node.getChildren().length},addHole:function(e,t,i){var r=n.getQuadKey(e,t,i);if(void 0===this._holes[r]){var a=this._urban.worldSize/(1<<e),s=t*a,o=(t+1)*a,l=i*a,d=(i+1)*a;this._holes[r]={LOD:e,I:t,J:i,key:r,minX:s,minY:l,maxX:o,maxY:d},this._dirty=!0}},removeHole:function(e,t,i){var r=n.getQuadKey(e,t,i);-1!==this._holes[r]&&(delete this._holes[r],this._dirty=!0)},_cullingTest:function(e){if(void 0!==this._cropBox){void 0===this._cropIJBoxes[e.LOD]&&(this._cropIJBoxes[e.LOD]={},this._cropBox.getIJBox(e.LOD,this._cropIJBoxes[e.LOD]));var t=this._cropIJBoxes[e.LOD];if(e.I<t.IMin||e.J<t.JMin||e.I>t.IMax||e.J>t.JMax)return!0;e.I!==t.IMin&&e.J!==t.JMin&&e.I!==t.IMax&&e.J!==t.JMax||(e.intersectCropBox=!0)}return!1},_lookForAvailableChildren:function(e,t,i,r,a){if(this._cullingTest({LOD:e,I:t,J:i}));else{var s=n.getQuadKey(e,t,i);-1!==this._vqtKeys.indexOf(s)?r[s]={LOD:e,I:t,J:i,key:s}:e<a&&(this._lookForAvailableChildren(e+1,t<<1,i<<1,r,a),this._lookForAvailableChildren(e+1,1+(t<<1),i<<1,r,a),this._lookForAvailableChildren(e+1,t<<1,1+(i<<1),r,a),this._lookForAvailableChildren(e+1,1+(t<<1),1+(i<<1),r,a))}},_AreChildrenAvailable:function(e,t,i,r){if(this._cullingTest({LOD:e,I:t,J:i}))return!0;var a=n.getQuadKey(e,t,i);return-1!==this._vqtKeys.indexOf(a)||e<r&&(!1!==this._AreChildrenAvailable(e+1,t<<1,i<<1,r)&&(!1!==this._AreChildrenAvailable(e+1,1+(t<<1),i<<1,r)&&(!1!==this._AreChildrenAvailable(e+1,t<<1,1+(i<<1),r)&&!1!==this._AreChildrenAvailable(e+1,1+(t<<1),1+(i<<1),r))))},_boxInFrustum:function(t){for(var i=this._urban.USR.viewpoint.frustum.planes,r=0;r<6;r++){var a=0;if(a+=i[r].distanceToPoint(new e.Vector3(t.mMinX,t.mMinY,t.mMinZ))<0?1:0,a+=i[r].distanceToPoint(new e.Vector3(t.mMaxX,t.mMinY,t.mMinZ))<0?1:0,a+=i[r].distanceToPoint(new e.Vector3(t.mMinX,t.mMaxY,t.mMinZ))<0?1:0,a+=i[r].distanceToPoint(new e.Vector3(t.mMaxX,t.mMaxY,t.mMinZ))<0?1:0,a+=i[r].distanceToPoint(new e.Vector3(t.mMinX,t.mMinY,t.mMaxZ))<0?1:0,a+=i[r].distanceToPoint(new e.Vector3(t.mMaxX,t.mMinY,t.mMaxZ))<0?1:0,a+=i[r].distanceToPoint(new e.Vector3(t.mMinX,t.mMaxY,t.mMaxZ))<0?1:0,8==(a+=i[r].distanceToPoint(new e.Vector3(t.mMaxX,t.mMaxY,t.mMaxZ))<0?1:0))return!1}return!0},update:function(t,i,r,s){this.terrainInProcess=!1,this._doQtUpdate&&!0===this._doQtUpdate()&&(s||this._qt.needRebuild)&&(this._target.level=t,this._target.x=i,this._target.y=r,this._qt.build(this._target.level,this._target.x,this._target.y),this._qt.sortTiles());var o,l,d,u,h,c,v,_=[];this._node.getChildren();this._availableVQT={},v=this._qt.getLength(),!1!==this._pixelCulling&&(this._urban.USR.viewpoint.camera.pixelCulling=this._pixelCulling,this._pixelCulling=!1);new e.Vector3(0,0,0);for(var f={mMinX:0,mMaxX:0,mMinY:0,mMaxY:0,mMinZ:0,mMaxZ:0},p=0;p<v;){if(O={tile:this._qt.getQuad(p)},0===p){var m={tile:{LOD:0,I:0,J:0,key:n.getQuadKey(0,0,0)},canUseParent:!1,isVisible:!0,priority:999};if(this._cullingTest(m.tile))continue;a.getOrDownloadData("terrain",m.tile.key,m);for(var x=O.tile.LOD-5,g=O.tile.I,y=O.tile.J;x>0;){for(var b=0;b<5;++b)g>>=1,y>>=1;m={tile:{LOD:x,I:g,J:y,key:n.getQuadKey(x,g,y)},canUseParent:!1,isVisible:!0,priority:999},this._cullingTest(m.tile)||(a.getOrDownloadData("terrain",m.tile.key,m),x-=5)}}if(p++,!this._cullingTest(O.tile)){var D=this._urban.worldSize/(1<<O.tile.LOD),S=this._urban.worldSize/(1<<O.tile.LOD),C=new e.Vector3(D,S,1),M=new e.Vector3((O.tile.I+.5)*C.x,(O.tile.J+.5)*C.y,0);if(f.mMinX=M.x-C.x/2-this._urban.USR.viewpoint._camShiftedTranslation.x,f.mMaxX=M.x+C.x/2-this._urban.USR.viewpoint._camShiftedTranslation.x,f.mMinY=M.y-C.y/2-this._urban.USR.viewpoint._camShiftedTranslation.y,f.mMaxY=M.y+C.y/2-this._urban.USR.viewpoint._camShiftedTranslation.y,f.mMinZ=M.z-0-this._urban.USR.viewpoint._camShiftedTranslation.z,f.mMaxZ=M.z+5e3-this._urban.USR.viewpoint._camShiftedTranslation.z,f.mMaxZ*=this._urban.USR.scale,O.isVisible=this._boxInFrustum(f),!0===O.isVisible){if(O.canUseParent=!0,d=O.tile.LOD,u=O.tile.I,h=O.tile.J,-1!==this._vqtKeys.indexOf(O.tile.key));else d++,u<<=1,h<<=1,!0===this._AreChildrenAvailable(d,u,h,this._currentMaxLevel)&&!0===this._AreChildrenAvailable(d,u,h+1,this._currentMaxLevel)&&!0===this._AreChildrenAvailable(d,u+1,h,this._currentMaxLevel)&&!0===this._AreChildrenAvailable(d,u+1,h+1,this._currentMaxLevel)&&(O.canUseParent=!1);if(O.priority=Math.max(0,O.tile.LOD),this._availableVQT[O.tile.key]={LOD:O.tile.LOD,I:O.tile.I,J:O.tile.J,key:O.tile.key},A=a.getOrDownloadData("terrain",O.tile.key,O),n.is(A)){if(A.useGeometricParent)_.push([O.tile.key,O.tile.LOD,O.tile.I,O.tile.J,A.useGeometricParent,A.tileParent,O]);else if(!0===A.tmp&&(A.temporary&&(this.terrainInProcess=!0),d=O.tile.LOD,u=O.tile.I,h=O.tile.J,-1,!1===O.canUseParent)){var w=Object.keys(this._availableVQT).length;d=O.tile.LOD,u=O.tile.I,h=O.tile.J,this._lookForAvailableChildren(d+1,u<<1,h<<1,this._availableVQT,this._currentMaxLevel),this._lookForAvailableChildren(d+1,1+(u<<1),h<<1,this._availableVQT,this._currentMaxLevel),this._lookForAvailableChildren(d+1,u<<1,1+(h<<1),this._availableVQT,this._currentMaxLevel),this._lookForAvailableChildren(d+1,1+(u<<1),1+(h<<1),this._availableVQT,this._currentMaxLevel),Object.keys(this._availableVQT).length>w&&(O.priority=99999,a.deprecate("terrain",O.tile.key),a.getOrDownloadData("terrain",O.tile.key,O),_.push([O.tile.key,O.tile.LOD,O.tile.I,O.tile.J]),!1!==this._urban.USR.viewpoint.camera.pixelCulling&&(this._pixelCulling=this._urban.USR.viewpoint.camera.pixelCulling,this._urban.USR.viewpoint.camera.pixelCulling=!1))}}else console.error("ERROR : NO TILE -> SHOULD NOT HAPPEN")}}}l=this._currentMaxLevel;for(var T=Object.keys(this._availableVQT),L=0,P=T.length;L<P;L++)l=Math.max(l,this._availableVQT[T[L]].LOD);for(o=_.length;o--;)if(c=_.shift(),this._availableVQT[c[0]]){if(c.length>4&&!0===c[4]){var O,A,V=c[5];if(V.key=n.getQuadKey(V.LOD,V.I,V.J),void 0===this._availableVQT[V.key])(O=c[6]).tile=V,(A=a.getOrDownloadData("terrain",O.tile.key,O)).useGeometricParent||(this._availableVQT[V.key]=V),A.temporary&&(this.terrainInProcess=!0)}delete this._availableVQT[c[0]]}else this._cullingTest({LOD:c[1],I:c[2],J:c[3]})||c[1]<l&&(d=c[1]+1,u=c[2]<<1,h=c[3]<<1,_.push([n.getQuadKey(d,u,h),d,u,h]),_.push([n.getQuadKey(d,u+1,h),d,u+1,h]),_.push([n.getQuadKey(d,u,h+1),d,u,h+1]),_.push([n.getQuadKey(d,u+1,h+1),d,u+1,h+1]),o+=4)},display:function(e){var t,i,r;this._currentMaxLevel=0;for(var s=(r=this._node.getChildren()).length;s--;)t=r[s],!this._dirty&&this._availableVQT[t.storeKey]||(this._node.remove(t),this._vqtKeys.splice(this._vqtKeys.indexOf(t.storeKey),1),a.unlock("terrain",t.storeKey));r=this._node.getChildren();var o=Object.keys(this._availableVQT),l=o.length;for(this._holeKeys.length=0;l--;){var d=Number(o[l]),u=this._availableVQT[d];if(this._currentMaxLevel=u.LOD>this._currentMaxLevel?u.LOD:this._currentMaxLevel,this._dirty||-1===this._vqtKeys.indexOf(d)){if(-1===this._holeKeys.indexOf(d)){var h=!1;if(Object.keys(this._holes).length>0){if(this._holes[d]){this._holeKeys.push(d);continue}var c,v=this._urban.worldSize/(1<<u.LOD),_=(u.I+.5)*v,f=(u.J+.5)*v;for(var p in this._holes)(c=this._holes[p]).LOD<u.LOD&&_>c.minX&&_<c.maxX&&f>c.minY&&f<c.maxY&&(h=!0,this._holeKeys.push(d))}h||(i=a.getData("terrain",d),n.is(i)&&!0!==i.useGeometricParent&&(this._node.add(i),this._vqtKeys.push(d),a.lock("terrain",d)))}}else;}for(var m=0;m<this._holeKeys.length;++m)a.getData("terrain",this._holeKeys[m]);this._dirty=!1},getLoadedQuadAt:function(e,t){var i,r,s;if((r=this._node.getChildren()).length>0){var o,l,d=this._currentMaxLevel;o=this._qt.getBaseIJ(this._currentMaxLevel,e,t);var u=function(e,t,o){if(!(e<0))if(l=n.getQuadKey(e,t,o),-1===this._holeKeys.indexOf(l)){if(-1===this._vqtKeys.indexOf(l))u(--e,t>>1,o>>1);else for(s=0;s<r.length;++s)if(r[s].storeKey===l){i=r[s];break}}else null===(i=a.getData("terrain",l))&&(i=void 0)}.bind(this);u(d,o.I,o.J)}return i}},l}),define("DS/XCityCore/Terrain",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/XCityCore/Store","DS/XCityTools/Downloader","DS/XCityTools/Disposer","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/EventDispatcher","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityRendering/RenderingHandlerGround","DS/xCityBasicUtils/Utils","DS/XCityTools/Pooler","DS/XCityTools/RenderingTools"],function(e,t,i,r,a,s,o,n,l,d,u,h,c,v,_,f){"use strict";var p=0,m=new e.Vector2(1,1),x=void 0,g=-50,y=0,b=!1,D=8,S=!1,C=!0,M=!1,w=!1,T=!1,L=!1,P=!0,O={},A=1,V=.1,I=new e.Color("rgb(0,0,255)"),F=new e.Color("rgb(0,0,255)"),k=void 0,B=1,R=void 0,X={name:"terrain_DebugLevelsColor_PDSFX",uniforms:{levelColor:{type:"c",value:new e.Color}},FS_overridableFunctions:{ProcessFinalColor:["ioFinalColor.rgb *= levelColor.rgb;"].join("\n")}},U={name:"terrain_DebugTileInfos_PDSFX",uniforms:{tileTexture:{type:"t2",value:void 0}},varyings:{uvTile:{type:"v2",length:1}},VS_overridableFunctions:{ComputeVaryingValues:["uvTile = vGetAttribTexCoord0().xy;"].join("\n")},FS_overridableFunctions:{ProcessFinalColor:["vec3 invertColor = vec3(1.0) - ioFinalColor.rgb;","vec3 tileInfo = texture2D(tileTexture, uvTile.xy).rgb;","ioFinalColor.rgb = ioFinalColor.rgb*(vec3(1.0)-tileInfo) + invertColor*tileInfo;"].join("\n")}},N={name:"terrain_DebugWireframe_PDSFX",uniforms:{},varyings:{wireColor:{type:"v3",length:1}},VS_overridableFunctions:{ComputeVaryingValues:["wireColor = vGetAttribNormal();"].join("\n")},FS_global_code:["float _edgeFactor(vec3 _color){","vec3 d = fwidth(_color);","vec3 a3 = smoothstep(vec3(0.0), d*1.5, _color);","return min(min(a3.x, a3.y), a3.z);","}"].join("\n"),FS_overridableFunctions:{ProcessFinalColor:["ioFinalColor.rgb *= mix(vec3(0.0),vec3(1.0),_edgeFactor(wireColor.rgb));"].join("\n")}},z={name:"terrain_Crop_PDSFX",uniforms:{dtmCrop:{type:"v4",value:new e.Vector4(-1,-1,1,1)},worldMat:{type:"m4",value:new e.Matrix4}},VS_global_code:["vec3 ComputeObjectPosition_Cropped() {","vec3 position = vGetAttribPosition();","position.x = clamp(position.x, dtmCrop.x, dtmCrop.z);","position.y = clamp(position.y, dtmCrop.y, dtmCrop.w);","return position;","}","vec4 ComputeObjectTexCoord0_Cropped() {","vec4 croppedUV = vGetAttribTexCoord0();","croppedUV.x = clamp(croppedUV.x, dtmCrop.x + 0.5, dtmCrop.z + 0.5);","croppedUV.y = clamp(croppedUV.y, dtmCrop.y + 0.5, dtmCrop.w + 0.5);","return croppedUV;","}","float _altitudeAnalyzer = 0.0;"].join("\n"),FS_global_code:["#define TERRAIN_SHADER","bool computeWaves = false;"].join("\n"),_FS_overridableFunctions:{ComputeAlbedo:["return vec3(1.0,0.2,0.2);"].join("\n")}},J={name:"terrain_Flat_PDSFX",depends:[z],uniforms:{dtmAltitudes:{type:"v4",value:new e.Vector4(0,0,0,0)},dtmOffset:{type:"v4",value:new e.Vector4(0,0,1,1)}},VS_overridableFunctions:{ComputeObjectPosition:["vec3 position = ComputeObjectPosition_Cropped();","position.z = dtmAltitudes.x;","return position;"].join("\n"),ComputeObjectNormal:["vec3 terrainNormal = vec3(0.0,0.0,1.0);","return terrainNormal;"].join("\n"),ProcessViewTangentSpace:["ioWorldViewTS.Normal = normalize(vGetViewMatrix() * vec4(0.0,0.0,1.0,0.0)).xyz;"].join("\n")},FS_overridableFunctions:{_ComputeSpecularReflectance:["vec3 specularRef = vec3(0.0,0.0,0.0);","return specularRef;"].join("\n"),_ProcessFinalColor:["ioFinalColor = vec4(vGetViewNormal(), 1.0);"].join("\n")}},Q={name:"terrain_Raster_PDSFX",depends:[z],nbTexture:1,uniforms:{dtm:{type:"t2",value:void 0},dtmOffset:{type:"v4",value:new e.Vector4(0,0,1,1)},dtmAltitudes:{type:"v4",value:new e.Vector4(0,0,0,0)},dtmProperties:{type:"v4",value:new e.Vector4(0,0,0,0)},terrainDebug:{type:"v4",value:new e.Vector4(0,0,0,0)}},VS_global_code:["vec3 _terrainPosition;","vec3 _terrainNormal;","vec3 _computeNormal(vec2 uv) {","float w = texture2D(dtm, uv + vec2(-dtmProperties.x, 0.0)).r;","float e = texture2D(dtm, uv + vec2( dtmProperties.x, 0.0)).r;","float s = texture2D(dtm, uv + vec2(0.0, -dtmProperties.y)).r;","float n = texture2D(dtm, uv + vec2(0.0,  dtmProperties.y)).r;","mat3 modelMatrix = vGet3x3WorldMatrix();","vec3 va = normalize(vec3(modelMatrix[0][0]*2.0*dtmProperties.x/dtmOffset.z, 0.0, e-w));","vec3 vb = normalize(vec3(0.0, modelMatrix[1][1]*2.0*dtmProperties.y/dtmOffset.z, n-s));","return normalize(cross(va,vb));","}"].join("\n"),VS_overridableFunctions:{ComputeCommonValues:["_terrainPosition = ComputeObjectPosition_Cropped();","float _altitude = dtmAltitudes.x;","_altitudeAnalyzer = dtmAltitudes.x;","vec2 croppedUV = ComputeObjectTexCoord0_Cropped().xy;","vec2 _uvsdtm = (croppedUV * dtmOffset.z + dtmOffset.xy) * (vec2(1.0) - 2.0 * dtmProperties.zw) + dtmProperties.zw;","if (dtmAltitudes.z > 0.0 || _terrainPosition.z > -999.0 ) {","if (terrainDebug.z > 0.5 && terrainDebug.z < 1.5) {","_altitude = dtmAltitudes.x;","_altitudeAnalyzer = _altitude;","_terrainNormal = vec3(0.0, 0.0, 1.0);","}","else {","_terrainNormal = _computeNormal(_uvsdtm);","_altitude = texture2D(dtm, _uvsdtm).r;","_altitudeAnalyzer = _altitude;","}","} else {","_altitudeAnalyzer = texture2D(dtm, _uvsdtm).r;","_altitude = dtmAltitudes.y;","_terrainNormal = vec3(0.0, 0.0, 1.0);","}","_terrainPosition.z = (_altitude - dtmAltitudes.w)/dtmOffset.w;"].join("\n"),ComputeObjectPosition:["return _terrainPosition;"].join("\n"),ComputeObjectNormal:["return _terrainNormal;"].join("\n"),ProcessViewTangentSpace:["ioWorldViewTS.Normal = normalize(vGetViewMatrix() * vec4(_terrainNormal,0.0)).xyz;"].join("\n")},FS_overridableFunctions:{_ProcessFinalColor:["ioFinalColor = vec4(vGetViewNormal(), 1.0);"].join("\n")}},q={name:"terrain_noOverlayRaster_PDSFX",nbTexture:0,FS_overridableFunctions:{_ComputeRoughness:["return 1.0;"].join("\n"),_ComputeAlbedo:["return vec3(0.9);"].join("\n")}},j={0:{name:"terrain_OverlayRaster_PDSFX",nbTexture:0,uniforms:{raster:{type:"t2v",value:[],length:0},rasterOffset:{type:"v4v",value:[],length:0},previewCoefs:{type:"v4v",value:[],length:0},previewRotation:{type:"v4v",value:[],length:0},isVisible:{type:"f",value:1}},varyings:{uvsraster:{type:"v2v",length:0}},VS_overridableFunctions:{ComputeVaryingValues:["for(int i = 0; i < __NBRASTER__; i++) {","uvsraster[i] = ComputeObjectTexCoord0_Cropped().xy * rasterOffset[i].z + rasterOffset[i].xy;","}"].join("\n")},FS_global_code:["#define MULTIPLE_RASTER_TERRAIN __NBRASTER__"].join("\n"),FS_overridableFunctions:{ComputeAlbedo:["if (computeWaves == false) {","vec3 _rasterMixedColor = vec3(225.0/255.0);","if (uvsraster[0] != vec2(-1.0)) {","vec4 _raster;","float _rasterAlpha = 0.0;","for(int i = 0; i < __NBRASTER__; i++) {","if (previewCoefs[i] != vec4(-1.0)) {","vec2 uvs = uvsraster[i];","float angleRad = previewRotation[i].x * 3.14 / 180.0;","float xM = uvs.x - (previewCoefs[i].x + previewCoefs[i].z) / 2.0;","float yM = uvs.y - (previewCoefs[i].y + previewCoefs[i].w) / 2.0;","uvs.x = xM * cos(angleRad) + yM * sin(angleRad) + (previewCoefs[i].x + (previewCoefs[i].z - previewCoefs[i].x)/2.0);","uvs.y = -xM * sin(angleRad) + yM * cos(angleRad) + (previewCoefs[i].y + (previewCoefs[i].w - previewCoefs[i].y)/2.0);","if (uvs.x < previewCoefs[i].x) {","uvs.x = -1.0;","}","else if (uvs.x > previewCoefs[i].z) {","uvs.x = -1.0;","}","if (uvs.y < previewCoefs[i].y) {","uvs.y = -1.0;","}","else if (uvs.y > previewCoefs[i].w) {","uvs.y = -1.0;","}","if (uvs.x != -1.0 && uvs.y != -1.0) {","uvs.x -= previewCoefs[i].x;","uvs.x /= (previewCoefs[i].z - previewCoefs[i].x);","uvs.y -= previewCoefs[i].y;","uvs.y /= (previewCoefs[i].w - previewCoefs[i].y);","_raster = texture2D(raster[i], uvs);","_rasterAlpha = _raster.a;","}","}","else {","_raster = texture2D(raster[i], uvsraster[i]);","_rasterAlpha = _raster.a;","}","float coefDark = 225.0/255.0;","float darkness = (1.0 - _rasterAlpha) * coefDark + (_rasterAlpha * 1.0);","_raster.xyz = _raster.xyz * vec3(darkness);","_rasterMixedColor = _raster.rgb * _raster.a * rasterOffset[i].w + _rasterMixedColor * (1.0 - _raster.a * rasterOffset[i].w);","}","}","#ifdef GAMMA_INPUT","//_rasterMixedColor *= _rasterMixedColor;","#endif","return _rasterMixedColor;","}"].join("\n"),_ComputeRoughness:["return 1.0;"].join("\n")}},1:{name:"terrain_OverlayRaster_PDSFX",nbTexture:1,uniforms:{raster:{type:"t2",value:void 0},rasterOffset:{type:"v4",value:new e.Vector4(0,0,1,1)},previewCoefs:{type:"v4",value:new e.Vector4(-1,-1,-1,-1)},previewRotation:{type:"v4",value:new e.Vector4(0,0,0,0)},isVisible:{type:"f",value:1}},varyings:{uvsraster:{type:"v2",length:1}},VS_overridableFunctions:{ComputeVaryingValues:["uvsraster = ComputeObjectTexCoord0_Cropped().xy * rasterOffset.z + rasterOffset.xy;"].join("\n")},FS_overridableFunctions:{_ComputeRoughness:["return 1.0;"].join("\n"),ComputeAlbedo:["if (computeWaves == false) {","vec3 _rasterMixedColor = vec3(225.0/255.0);","float _rasterAlpha = 0.0;","vec4 _raster = vec4(1.0);","if (uvsraster != vec2(-1.0)) {","if (previewCoefs != vec4(-1.0)) {","vec2 uvs = uvsraster;","float angleRad = previewRotation.x * 3.14 / 180.0;","float xM = uvs.x - previewCoefs.x;","float yM = uvs.y - previewCoefs.y;","uvs.x = xM * cos(angleRad) + yM * sin(angleRad) + previewCoefs.x;","uvs.y = -xM * sin(angleRad) + yM * cos(angleRad) + previewCoefs.y;","if (uvs.x < previewCoefs.x) {","uvs.x = -1.0;","}","else if (uvs.x > previewCoefs.z) {","uvs.x = -1.0;","}","if (uvs.y < previewCoefs.y) {","uvs.y = -1.0;","}","else if (uvs.y > previewCoefs.w) {","uvs.y = -1.0;","}","_rasterAlpha = 0.0;","if (uvs.x != -1.0 && uvs.y != -1.0) {","uvs.x -= previewCoefs.x;","uvs.x /= (previewCoefs.z - previewCoefs.x);","uvs.y -= previewCoefs.y;","uvs.y /= (previewCoefs.w - previewCoefs.y);","_raster = texture2D(raster, uvs);","_rasterAlpha = _raster.a;","}","}","else {","_raster = texture2D(raster, uvsraster);","_rasterAlpha = _raster.a;","}","}","#ifdef GAMMA_INPUT","//_rasterMixedColor.rgb *= _rasterMixedColor.rgb;","#endif","float coefDark = 225.0/255.0;","float darkness = (1.0 - _rasterAlpha) * coefDark + (_rasterAlpha * 1.0);","_raster.rgb = _raster.rgb * vec3(darkness);","_rasterMixedColor = _raster.rgb * _raster.a * rasterOffset.w + _rasterMixedColor * (1.0 - _raster.a * rasterOffset.w);","return _rasterMixedColor;","}"].join("\n")}}},K={0:{name:"terrain_OverlayRaster_PDSFX",nbTexture:0,uniforms:{raster:{type:"t2v",value:[],length:0},rasterOffset:{type:"v4v",value:[],length:0},isVisible:{type:"f",value:1}},varyings:{uvsraster:{type:"v2v",length:0}},VS_overridableFunctions:{ComputeVaryingValues:["for(int i = 0; i < __NBRASTER__; i++) {","uvsraster[i] = ComputeObjectTexCoord0_Cropped().xy * rasterOffset[i].z + rasterOffset[i].xy;","}"].join("\n")},FS_global_code:["#define MULTIPLE_RASTER_TERRAIN __NBRASTER__","vec4 _texelCity = vec4(1.0);","#endif"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["if (computeWaves == false) {","if (uvsraster[0] != vec2(-1.0)) {","vec4 _raster;","for(int i = 0; i < __NBRASTER__; i++) {","vec4 _raster = texture2D(raster[i], uvsraster[i]);","_texelCity.xyz = _raster.rgb * _raster.a * rasterOffset[i].w + _texelCity.xyz * (1.0 - _raster.a * rasterOffset[i].w);","}","}","}",""].join("\n"),_ComputeDiffuseTexel:["return vec4(_texelCity.xyz, 1.0);"].join("\n"),ComputeAlbedo:["cAlbedo = vec3(0.5);"].join("\n"),ComputeSpecularReflectance:["return vec3(0.0,0.0,0.0);"].join("\n")}},1:{name:"terrain_OverlayRaster_PDSFX",nbTexture:1,uniforms:{mapCity:{type:"t2",value:void 0},raster:{type:"t2",value:void 0},rasterOffset:{type:"v4",value:new e.Vector4(0,0,1,1)},isVisible:{type:"f",value:1}},varyings:{uvsraster:{type:"v2",length:1}},VS_overridableFunctions:{ComputeVaryingValues:["uvsraster = ComputeObjectTexCoord0_Cropped().xy * rasterOffset.z + rasterOffset.xy;"].join("\n")},FS_global_code:["vec4 _texelCity = vec4(1.0);","#endif"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["if (!computeWaves) {","if (uvsraster != vec2(-1.0)) {","vec4 _raster = texture2D(raster, uvsraster);","_texelCity.xyz = _raster.rgb * _raster.a * rasterOffset.w + _texelCity.xyz * (1.0 - _raster.a * rasterOffset.w);","}","}",""].join("\n"),_ComputeDiffuseTexel:["return vec4(_texelCity.xyz, 1.0);"].join("\n"),ComputeAlbedo:["cAlbedo = vec3(0.5);"].join("\n"),ComputeSpecularReflectance:["return vec3(0.0,0.0,0.0);"].join("\n")}}},E={name:"terrain_Analyzer_PDSFX",uniforms:{mode:{type:"v3",value:new e.Vector3(0,0,1)},DCOffset:{type:"v3",value:new e.Vector3(0,0,0)},Amplitude:{type:"v3",value:new e.Vector3(0,0,0)},Frequency:{type:"v3",value:new e.Vector3(0,0,0)},Phase:{type:"v3",value:new e.Vector3(0,0,0)}},varyings:{alti:{type:"f",length:1},terrain_normal:{type:"v3",length:1}},VS_overridableFunctions:{ComputeVaryingValues:["alti = _altitudeAnalyzer; //ComputeObjectPosition().z;","terrain_normal = ComputeObjectNormal();"].join("\n")},FS_global_code:["vec3 palette(float vtoc){","return DCOffset + Amplitude * cos( 6.28318 * (Frequency * vtoc + Phase) );","}"].join("\n"),FS_overridableFunctions:{ProcessFinalColor:["if (mode.x < 0.0) {","float altToUse = clamp(alti,mode.y,mode.z);","float colorAlt = (altToUse - mode.y) / (mode.z -mode.y); //max(min( log(max(1.0+alti,1.0))/4.0-1.0, 1.0),0.0);","ioFinalColor.rgb *= palette(colorAlt);","} else if (mode.x > 1.0) { ","ioFinalColor.rgb *= palette(1.0-((terrain_normal.z - mode.y) / (mode.z -mode.y)));","} else {","ioFinalColor.rgb *= abs(terrain_normal.xyz);","}"].join("\n")}},Y={},Z=function(e,t){var i=e.get("res")-2*e.get("border"),r=e.get("res")-2*e.get("border");if(t.LOD>e.get("levelMax")){var a=1<<t.LOD-e.get("levelMax");i=Math.max(1,i/a),r=Math.max(1,r/a)}return function(e,t,i){if(void 0!==Y[[e,t,i]])return Y[[e,t,i]].use();var r=new u({indexed:!0,useNormal:!0,normalBinding:u.Binding.VERTEX,useTexCoord:!0,nbTexCoord:1,texCoordBinding:u.Binding.VERTEX});r.startPrimitive();for(var a=0,s=0,o=0;o<e;o++)for(var n=0;n<t;n++)r.pushVertex([o/e-.5,n/t-.5,0]),r.pushVertex([(o+1)/e-.5,n/t-.5,0]),r.pushVertex([(o+1)/e-.5,(n+1)/t-.5,0]),r.pushVertex([o/e-.5,(n+1)/t-.5,0]),r.pushTexCoord(0,[o/e,n/t]),r.pushTexCoord(0,[(o+1)/e,n/t]),r.pushTexCoord(0,[(o+1)/e,(n+1)/t]),r.pushTexCoord(0,[o/e,(n+1)/t]),r.pushNormal([0,1,0]),r.pushNormal([0,0,1]),r.pushNormal([0,1,2]),r.pushNormal([1,0,3]),r.pushVertexIndices([a,a+1,a+3]),r.pushVertexIndices([a+1,a+2,a+3]),a+=4,i&&(s=a,0===n&&(r.pushVertex([o/e-.5,n/t-.5,-999.9]),r.pushVertex([(o+1)/e-.5,n/t-.5,-999.9]),r.pushTexCoord(0,[o/e,n/t]),r.pushTexCoord(0,[(o+1)/e,n/t]),r.pushNormal([1,0,0]),r.pushNormal([0,1,0]),r.pushVertexIndices([s-4,a,s-3]),r.pushVertexIndices([a,a+1,s-3]),a+=2),n===e-1&&(r.pushVertex([o/e-.5,(n+1)/t-.5,-999.9]),r.pushVertex([(o+1)/e-.5,(n+1)/t-.5,-999.9]),r.pushTexCoord(0,[o/e,(n+1)/t]),r.pushTexCoord(0,[(o+1)/e,(n+1)/t]),r.pushNormal([0,1,0]),r.pushNormal([0,0,1]),r.pushVertexIndices([s-1,s-2,a+1]),r.pushVertexIndices([s-1,a+1,a]),a+=2),0===o&&(r.pushVertex([o/e-.5,n/t-.5,-999.9]),r.pushVertex([o/e-.5,(n+1)/t-.5,-999.9]),r.pushTexCoord(0,[o/e,n/t]),r.pushTexCoord(0,[o/e,(n+1)/t]),r.pushNormal([0,0,1]),r.pushNormal([0,1,0]),r.pushVertexIndices([a,s-4,s-1]),r.pushVertexIndices([a,s-1,a+1]),a+=2),o===t-1&&(r.pushVertex([(o+1)/e-.5,n/t-.5,-999.9]),r.pushVertex([(o+1)/e-.5,(n+1)/t-.5,-999.9]),r.pushTexCoord(0,[(o+1)/e,n/t]),r.pushTexCoord(0,[(o+1)/e,(n+1)/t]),r.pushNormal([0,1,0]),r.pushNormal([1,0,0]),r.pushVertexIndices([s-3,a,a+1]),r.pushVertexIndices([s-3,a+1,s-2]),a+=2));r.endPrimitive("terrainGenericMesh");var l=r.compilePrimitive("terrainGenericMesh",!0),d=h.createMeshNode(l),c=new _(d.clone.bind(d));return Y[[e,t,i]]=c,c.use()}(Math.max(1,i),Math.max(1,r),!e.noSkirts)},G=new e.Vector3,W=new e.Quaternion,H=new e.Vector3,$=function(t,i){if(this.children&&this.children[0]){var r,a=0;this.traverse(function(e){e.mesh3js&&e.mesh3js.matrix&&(r=e.mesh3js.matrix.elements[12],a=e.mesh3js.matrix.elements[13])});var s=new e.Vector3;s.getPositionFromMatrix(this.children[0].getMatrix());var o=new e.Vector3;o.getPositionFromMatrix(this.getMatrix());var n=debugWebGLV6Viewer.castRay(new e.Ray(new e.Vector3(r-o.x+t-s.x,a-o.y+i-s.y,1e3),new e.Vector3(0,0,-1)),this,"prim");return n&&n.length>0?n[0].point.z:this.bSphere.center.z}return 0},ee=function(){this._sourceList={default:{noSkirts:!0,acceptTile:function(){return{valid:!0,complete:!0}},getTile:function(){return{}},downloadTile:function(){return!0},applyDTM:function(){return!0},cancelTile:function(){return!0},updateTile:function(){return!0},isHD:function(){return!1},isGeometric:function(){return!1},getDataModelOrder:function(){return[]},getRendering:function(){},get:function(e){return"url"===e?"":"res"===e?1:"border"===e?0:"levelMin"===e?0:"levelMax"===e?0:"levelMaxVisu"===e?9999:"priority"===e?5:void 0}}},this._activeTerrain={0:["default"]},this._activeLandcover={},this._activeRaster={},this._chunksList=[],this._poolMaterial=[],r.createStore("terrain",{dataBuilder:this.buildTerrainTile.bind(this),dataDownloader:this.downloadTerrainTile.bind(this),dataDLCanceler:this.cancelDownloadTerrainTile.bind(this),dataCleaner:this.cleanTerrainTile.bind(this),dataUpdater:this.updateTerrainTile.bind(this),dlOptions:{},cacheSize:0})};ee.prototype={initialize:function(e){void 0!==e&&e.webglViewer&&(D=e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_TEXTURE_IMAGE_UNITS),S=void 0!==e.webglViewer.getRenderer().supportsStandardDerivatives(),C=e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_VERTEX_UNIFORM_VECTORS)>128&&e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_FRAGMENT_UNIFORM_VECTORS)>128),this.setup(e),this.setupDebug(e),this.setupOcean(e),this.setupSky(e),this.renderingProfileManager=e.renderingProfileManager,this._renderingId="Ground"},reset:function(){m.set(1,1),p=0,x=void 0,g=-100,1e4,y=0,b=!1,M=!1,w=!1,T=!1,L=!1,P=!1,A=1,V=.1,I.set("rgb(0,0,255)"),F.set("rgb(0,0,255)"),k=void 0,B=1,R=void 0,r.deprecateAll("terrain")},setup:function(t){if(void 0!==t){var i=!1;t.slabAltitude&&t.slabAltitude!==p&&(p=t.slabAltitude,g=p-25,p+100,i=!0),t.worldSize&&(t.worldSize instanceof e.Vector2?m.equals(t.worldSize)||(m.copy(t.worldSize),x=void 0,i=!0):m.x===t.worldSize&&m.y===t.worldSize||(m.x=t.worldSize,m.y=t.worldSize,x=void 0,i=!0)),t.cropBox&&t.cropBox!==x&&(x=t.cropBox,i=!0),i&&r.deprecateAll("terrain")}},setupAnalyzer:function(e){return void 0===e||void 0===e.terrainAnalyzer||e.terrainAnalyzer.mode===O.mode||(O=e.terrainAnalyzer,r.deprecateAll("terrain"),!1)},setupOcean:function(t){if(void 0!==t){var i=!1,a=!1;return void 0!==t.oceanAlpha&&A!==t.oceanAlpha&&(A=t.oceanAlpha),void 0!==t.oceanRangeDetection&&V!==t.oceanRangeDetection&&(V=t.oceanRangeDetection),void 0!==t.oceanColorDetection&&I.copy(t.oceanColorDetection),void 0!==t.oceanColor&&F.copy(t.oceanColor),k!==t.oceanTexture&&(k=t.oceanTexture,n.is(k)&&(k.minFilter=e.LinearMipMapLinearFilter,k.magFilter=e.LinearFilter,k.wrapS=k.wrapT=e.RepeatWrapping)),void 0!==t.reflectionCoef&&B!==t.reflectionCoef&&(B=t.reflectionCoef),void 0!==t.showOcean&&P!==t.showOcean&&(P=t.showOcean,a=!0,i=!0),!i||(r.deprecateAll("terrain"),a&&d.publish(d.eventsList.realisticWater,P),!1)}},_enableOcean:function(e){void 0!==e&&P!==e&&(P=e,r.deprecateAll("terrain"),d.publish(d.eventsList.realisticWater,e))},_isOceanEnabled:function(){return P},setupSky:function(e){if(void 0!==e){var t=!1;R!==e.skyCubeMap&&(t=!0,void 0!==(R=e.skyCubeMap)&&(R.shared=0)),t&&r.deprecateAll("terrain")}},setupDebug:function(e){if(void 0!==e){var t=!1;void 0!==e.showtiles&&M!==e.showtiles&&(M=e.showtiles,t=!0),void 0!==e.wireframe&&L!==e.wireframe&&(L=e.wireframe,t=!0),void 0!==e.coloredlevels&&w!==e.coloredlevels&&(w=e.coloredlevels,t=!0),void 0!==e.tileInfos&&T!==e.tileInfos&&(T=e.tileInfos,t=!0),t&&r.deprecateAll("terrain")}},setupUndergroundMode:function(e){if(void 0!==e){b=e;r.traverse("terrain",function(e){if(n.is(e.material)){var t=e.material.getPDSFXUniform("dtmAltitudes");n.is(t)&&t.value.setZ(b?1:0)}})}},_findTerrainSource:function(e){for(var t,i,r,a,s,o,n,l=e.LOD,d={id:"default",complete:!0};l+1;){if(a=this._activeTerrain[l])for(t=0,i=a.length;t<i;++t){if(r=a[i-t-1],(o=this._sourceList[r].acceptTile(e)).valid&&"default"!==r&&(!0===o.complete||void 0===o.complete))this.getLowerDataModelSource(d.id,r)===r&&(!0===o.complete?d={id:r,complete:o.complete}:void 0===o.complete&&(n={id:r}));o.valid&&!1===o.complete&&(s=void 0===s?r:this.getLowerDataModelSource(s,r))}l--}return"default"===d.id&&s?{display:s,download:void 0!==n?n.id:s}:{display:"default"===d.id&&void 0!==n?n.id:d.id,download:void 0!==n?n.id:d.id}},_findLandcoverSource:function(e){var t,i,r,a,s,o,n=e.LOD;if(P)for(;n+1;){if(a=this._activeLandcover[n])for(t=0,i=a.length;t<i;++t)r=a[i-t-1],(o=this._sourceList[r])&&o.acceptTile(e)&&(s=void 0===s?r:this.getLowerDataModelSource(s,r));n--}return s},_findSortedRasterSources:function(e){for(var t,i,r,a,s,o,n,l,d,u,h=e.LOD,c=[];h+1;){if(o=this._activeRaster[h])for(t=0,i=o.length;t<i;++t)if(s=o[i-t-1],this._sourceList[s].acceptTile(e))if(0===c.length)c.push(s);else{for(d=0,u=!1,l=this._sourceList[s].getDataModelOrder();!u&&d<c.length;){for(n=this._sourceList[c[d]].getDataModelOrder(),r=Math.min(n.length,l.length),a=0;a<r;++a)if(l[a]>n[a]){c.splice(d,0,s),u=!0;break}d++}u||c.push(s)}h--}return c},_updateOceanUniforms:function(e){if(P&&n.is(e)){var t=e.getPDSFXUniform("oceanColor");n.is(t)&&(e.updatePDSFXUniform("oceanAlpha",A),e.updatePDSFXUniform("oceanRangeDetection",V),e.updatePDSFXUniform("oceanColorDetection",I),e.updatePDSFXUniform("oceanColor",F));var i=e.getPDSFXUniform("oceanTexture");if(n.is(i)){var r=i.value;n.is(r)&&e.updatePDSFXUniform("oceanTexture",void 0)}e.updatePDSFXUniform("oceanTexture",k)}},_updateDebugUniforms:function(t,i){if(w&&void 0!==t){var r=t.getPDSFXUniform("levelColor");n.is(r)&&(r.value.set(n.toColor(i.LOD/y)),t.updatePDSFXUniform("levelColor",r.value))}if(T&&void 0!==t){var a=t.getPDSFXUniform("tileTexture");if(n.is(a)){var s=document.createElement("canvas");s.width=256,s.height=256;var o=s.getContext("2d");o.font="24pt Arial",o.textAlign="center",o.fillStyle="black",o.fillRect(0,0,256,256),o.fillStyle="white";var l=i.J;!1,o.fillText(i.LOD+"/"+i.I+"/"+l,s.width/2,s.height/2);var d=new e.Texture(s);d.needsUpdate=!0,t.updatePDSFXUniform("tileTexture",d)}}},_updateAltitudeUniforms:function(e){var t=e.getPDSFXUniform("dtmAltitudes");n.is(t)&&(t.value.set(p,g,b?1:0,t.value.w),e.updatePDSFXUniform("dtmAltitudes",t.value))},_updateCropUniforms:function(e,t){if(void 0!==e){var i=e.getPDSFXUniform("dtmCrop");if(n.is(i))if(void 0!==x&&t.intersectCropBox){var r=m.x/(1<<t.LOD),a=m.y/(1<<t.LOD),s=(t.I+.5)*r,o=(t.J+.5)*a;i.value.set((x.getShiftedCenter().x-x.getSize().x/2-s)/r,(x.getShiftedCenter().y-x.getSize().y/2-o)/a,(x.getShiftedCenter().x+x.getSize().x/2-s)/r,(x.getShiftedCenter().y+x.getSize().y/2-o)/a),e.updatePDSFXUniform("dtmCrop",i.value)}else i.value.set(-1,-1,1,1),e.updatePDSFXUniform("dtmCrop",i.value)}},_updateAnalyzerUniforms:function(t){if(this.isTerrainAnalyzerActivated()&&n.is(t)){var i,r=t.getPDSFXUniform("mode");if(n.is(r)){var a=-1;"slope"===O.mode?(a=2,i=new e.Vector3(a,O.slopeMin,O.slopeMax)):"orientation"===O.mode?(a=.5,i=new e.Vector3(a,0,0)):"elevation"===O.mode&&(a=-1,i=new e.Vector3(a,O.elevationMin,O.elevationMax)),t.updatePDSFXUniform("mode",i)}if("orientation"!==O.mode){var s=t.getPDSFXUniform("DCOffset");n.is(s)&&t.updatePDSFXUniform("DCOffset",O.gradient.DCOffset);var o=t.getPDSFXUniform("Amplitude");n.is(o)&&t.updatePDSFXUniform("Amplitude",O.gradient.Amplitude);var l=t.getPDSFXUniform("Frequency");n.is(l)&&t.updatePDSFXUniform("Frequency",O.gradient.Frequency);var d=t.getPDSFXUniform("Phase");n.is(d)&&t.updatePDSFXUniform("Phase",O.gradient.Phase)}}},_updateSkyUniforms:function(e){var t=e.envMap;if(n.is(R)&&R!==t){var i=t;n.is(i)&&(i.shared--,e.envMap=null),R.shared++,e.envMap=R}},_getTerrainMaterial:function(t,i,r,a){var s=0;t.isGeometric()||(s=""!==t.get("url")?2:1);var o=0;void 0!==i&&P&&(o=void 0!==k?2:1);var d=0;w&&(d=1);var u=0;T&&(u=1);var h=0;L&&S&&(t.isGeometric()||(h=1));var c=0;this.isTerrainAnalyzerActivated()&&(c=1);var v="DTM"+s+"_nbRasters"+r+"_landcover"+o+"_landcoverRasterVisible"+a+"_terrainLevels"+d+"_terrainTileInfos"+u+"_terrainWireframe"+h+"_terrainAnalyzer"+c;if(void 0===this._chunksList[v]){var f=[];if(s>0&&(2===s?f.push(Q):f.push(J)),o>0&&(a?f.push(l.chunkLandcover_visibleSource_PDSFX):f.push(l.chunkLandcover_unvisibleSource_PDSFX),f.push(l.chunkOcean_PDSFX)),r>0)if(C){if(void 0===j[r]){(p=n.clone(j[0])).uniforms.raster.length=r,p.uniforms.rasterOffset.length=r,p.uniforms.previewCoefs.length=r,p.uniforms.previewRotation.length=r;for(m=0;m<r;++m)p.uniforms.raster.value.push(void 0),p.uniforms.rasterOffset.value.push(void 0),p.uniforms.previewCoefs.value.push(void 0),p.uniforms.previewRotation.value.push(void 0);p.uniforms.isVisible.value=1,p.VS_overridableFunctions.ComputeVaryingValues=p.VS_overridableFunctions.ComputeVaryingValues.replace(/__NBRASTER__/g,r.toString()),p.FS_global_code=p.FS_global_code.replace(/__NBRASTER__/g,r.toString()),p.FS_overridableFunctions.ComputeAlbedo=p.FS_overridableFunctions.ComputeAlbedo.replace(/__NBRASTER__/g,r.toString()),p.nbTexture=r,p.varyings.uvsraster.length=r,j[r]=p}f.push(j[r])}else{if(void 0===K[r]){var p;(p=n.clone(K[0])).uniforms.raster.length=r,p.uniforms.rasterOffset.length=r,p.uniforms.previewCoefs.length=r,p.uniforms.previewRotation.length=r;for(var m=0;m<r;++m)p.uniforms.raster.value.push(void 0),p.uniforms.rasterOffset.value.push(void 0),p.uniforms.previewCoefs.value.push(void 0),p.uniforms.previewRotation.value.push(void 0);p.uniforms.isVisible.value=1,p.VS_overridableFunctions.ComputeVaryingValues=p.VS_overridableFunctions.ComputeVaryingValues.replace(/__NBRASTER__/g,r.toString()),p.FS_global_code=p.FS_global_code.replace(/__NBRASTER__/g,r.toString()),p.FS_overridableFunctions.ComputeCommonValues=p.FS_overridableFunctions.ComputeCommonValues.replace(/__NBRASTER__/g,r.toString()),p.nbTexture=r,p.varyings.uvsraster.length=r,K[r]=p}f.push(K[r])}else f.push(q);this.isTerrainAnalyzerActivated()&&2===s&&f.push(E),1===d&&f.push(X),1===u&&f.push(U),1===h&&f.push(N),C?this._chunksList[v]=l.getPDSFXMaterial(f,"physical"):(this._chunksList[v]=l.getPDSFXMaterial(f,"phong"),this._chunksList[v].updatePDSFXUniform("specularOcean",new e.Color("rgb(25,25,25)"))),this._chunksList[v].metalness=0,this._chunksList[v].roughness=1,void 0!==this._chunksList[v].cloneWithAnim?this._poolMaterial[v]=new _(this._chunksList[v].cloneWithAnim):this._poolMaterial[v]=new _(this._chunksList[v].clone.bind(this._chunksList[v]))}return this._poolMaterial[v].use()},updateTerrainTile:function(e){if(void 0!==e.tile){var t,i,r=this._findTerrainSource(e.tile).display;if(this._sourceList[r].isHD()||this._sourceList[r].isGeometric()||(t=this._findSortedRasterSources(e.tile),i=this._findLandcoverSource(e.tile)),this._sourceList[r].updateTile(e.tile),void 0!==i&&this._sourceList[i].updateTile(e.tile),void 0!==t)for(;t.length;)r=t.shift(),this._sourceList[r].updateTile(e.tile)}},cancelDownloadTerrainTile:function(e){if(void 0!==e.tile){var t,i,r=this._findTerrainSource(e.tile).download;if(this._sourceList[r].isHD()||this._sourceList[r].isGeometric()||(t=this._findSortedRasterSources(e.tile),i=this._findLandcoverSource(e.tile)),this._sourceList[r].cancelTile(e.tile),void 0!==i&&this._sourceList[i].cancelTile(e.tile),void 0!==t)for(;t.length;)r=t.shift(),this._sourceList[r].cancelTile(e.tile)}},downloadTerrainTile:function(e,t,i,a,s){if(void 0!==t&&void 0!==t.tile)e.tile=t.tile;else if(void 0===e.tile)return void o.warn("XCityCoreTerrain: No tile information given...");var l,d,u,h,c,v=!0,_=function(e,t,i){e&&r.deprecate("terrain",i)};if(e.temporary=!1,e.tmp=!1,d=this._findTerrainSource(e.tile).download,this._sourceList[d].isHD()||this._sourceList[d].isGeometric()||(u=this._findSortedRasterSources(e.tile),h=this._findLandcoverSource(e.tile)),c=this._sourceList[d].downloadTile(e.tile,t,i,_,this,e.key),v&=n.is(c),void 0!==h&&(c=this._sourceList[h].downloadTile(e.tile,t,i,_,this,e.key),v&=n.is(c)),void 0!==u){var f=i;const r=.9;for(;u.length;)d=u.shift(),c=this._sourceList[d].downloadTile(e.tile,t,f,_,this,e.key),v&=n.is(c),this._sourceList[d]._attributes.opacity&&this._sourceList[d]._attributes.opacity<r||this._sourceList[d].isTileContainedInSource(e.tile)&&(f=1)}v||(c=this._sourceList.default.downloadTile(e.tile,t,i,_,this,e.key),v=!0,e.tmp=!0,e.temporary=!0),(l=Array.prototype.slice.call(arguments,5)).unshift(v,void 0,{status:200}),a.apply(s,l)},buildTerrainTile:function(t){var a,s,o,u,h,c,_,f,x,g,y=this._findTerrainSource(t.tile);if(_=y.display,x=(f=this._sourceList[_]).isHD()||f.isGeometric()?[]:this._findSortedRasterSources(t.tile),g=f.isHD()||f.isGeometric()?void 0:this._findLandcoverSource(t.tile),n.is(t.value)&&t.value.source===_){if(a=t.value,y.download!==y.display)if((I=this._sourceList[y.download]).isGeometric()){for(var b=t.tile.LOD,C=t.tile.I,A=t.tile.J;b>I.get("levelMax");)C>>=1,A>>=1,--b;var V={LOD:b,I:C,J:A,key:n.getQuadKey(b,C,A)};a.useGeometricParent=!0,a.tileParent=V}else a.useGeometricParent=!1}else{if(f.isGeometric())if(t.tile.LOD>f.get("levelMax")){for(b=t.tile.LOD,C=t.tile.I,A=t.tile.J;b>f.get("levelMax");)C>>=1,A>>=1,--b;(a={useGeometricParent:!0,tileParent:V={LOD:b,I:C,J:A,key:n.getQuadKey(b,C,A)}}).isGeometric=!0,a.getGroundAltitude=$.bind(a)}else null!=(a=r.getData(f.get("url"),t.tile.key))?(a.isGeometric=!0,a.getGroundAltitude=$.bind(a)):(_="default",f=this._sourceList[_],x=this._findSortedRasterSources(t.tile),g=this._findLandcoverSource(t.tile));var I;if(null==a)if((a=Z(f,t.tile)).name="TerrainPatch_"+t.tile.LOD+"_"+t.tile.I+"_"+t.tile.J,a.mesh3js.name="TerrainPatch_"+t.tile.LOD+"_"+t.tile.I+"_"+t.tile.J,a.boundingSphere=new e.Sphere,a.boundingSphere.radius=Math.sqrt(.75)+0,a.setShadow(!1,!0),a.setPickable(i.PICKABLE),a.getGroundColor=function(e,t){var i=this.getMaterial().getPDSFXUniform("raster");if(n.is(i.value)&&n.is(i.value.image)){this.getMatrix().decompose(G,W,H);var r=.5+(e-G.x)/H.x,a=.5+(t-G.y)/H.y,s=i.value.image;a=1-a;var o=Math.floor(r*s.width),l=Math.floor(a*s.height);return s.width,s.height,function(e,t,i){var r=4*(t+e.width*i),a=e.data;return{r:a[r],g:a[r+1],b:a[r+2],a:a[r+3]}}(function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var i=t.getContext("2d");return i.drawImage(e,0,0),i.getImageData(0,0,e.width,e.height)}(s),o,l)}}.bind(a),(I=this._sourceList[y.download]).isGeometric()){for(b=t.tile.LOD,C=t.tile.I,A=t.tile.J;b>I.get("levelMax");)C>>=1,A>>=1,--b;V={LOD:b,I:C,J:A,key:n.getQuadKey(b,C,A)};a.useGeometricParent=!0,a.tileParent=V}else a.useGeometricParent=!1;a.source=_,a.storeKey=t.key}if(!a.isGeometric){var F=x.indexOf(g)>=0;o=function(e,t,i,r){var a,s=0;return e.isGeometric()||""===e.get("url")||(s+=Q.nbTexture),void 0!==t&&P&&(r||(s+=l.chunkLandcover_unvisibleSource_PDSFX.nbTexture),void 0!==k&&(s+=l.chunkOcean_PDSFX.nbTexture)),a=D-s,Math.min(i,a)}(f,g,x.length,F);var B,R=a.getMaterial();if(!function(e,t,i,r,a){if(null==e)return!0;if(!t.isGeometric()){var s=e.getPDSFXUniform("dtm");if(""!==t.get("url")&&!n.is(s)||""===t.get("url")&&n.is(s))return!0}if(void 0!==e.nbRasterSources&&e.nbRasterSources!==r)return!0;var o=e.getPDSFXUniform("landcover");if(void 0!==i&&!n.is(o)||void 0===i&&n.is(o))return!0;if(e.landcoverRasterVisible!==a)return!0;var l=e.getPDSFXUniform("oceanTexture");if(P&&!n.is(l)||!P&&n.is(l))return!0;var d=e.getPDSFXUniform("levelColor"),u=e.getPDSFXUniform("tileTexture"),h=e.getPDSFXUniform("wireColor");if(w&&!n.is(d)||!w&&n.is(d)||T&&!n.is(u)||!T&&n.is(u)||S&&L&&!n.is(h)||S&&!L&&n.is(h))return!0;var c=e.getPDSFXUniform("mode");return!((void 0===O.mode||"default"===O.mode||n.is(c))&&(void 0!==O.mode&&"default"!==O.mode||!n.is(c)))}(R,f,g,o,F)?(s=R).name="TerrainMaterial_"+t.tile.LOD+"_"+t.tile.I+"_"+t.tile.J:((s=this._getTerrainMaterial(f,g,o,F)).name="TerrainMaterial_"+t.tile.LOD+"_"+t.tile.I+"_"+t.tile.J,s.nbRasterSources=o,s.landcoverRasterVisible=F,s.side=e.FrontSide,s.forceSide=!0,l.updateCommonUniforms(s,!1),n.is(R)&&(l.deactivateAnimationUniforms(R),R._globePool.recycle(R)),a.setMaterial(s),a.mesh3js.material=s,""!==f.get("url")?f.isGeometric()||(a.getGroundAltitude=function(e,t){var i=this.getMaterial(),r=i.getPDSFXUniform("dtm");if(!n.is(r.value)||!n.is(r.value.image))return p;this.getMatrix().decompose(G,W,H);var a=.5+(e-G.x)/H.x,s=.5+(t-G.y)/H.y,o=i.getPDSFXUniform("dtmOffset");if(n.is(o)){var l=o.value;a=a*l.z+l.x,s=s*l.z+l.y}var d=i.getPDSFXUniform("dtmProperties");if(n.is(d)){var u=d.value;a=a*(1-2*u.z)+u.z,s=s*(1-2*u.w)+u.w}var h=r.value.image;s=1-s;var c=Math.floor(a*h.width),v=Math.floor(s*h.height),_=a*h.width-c,f=s*h.height-v,m=h.data[v*h.width+c],x=h.data[v*h.width+(c+1)],g=h.data[(v+1)*h.width+(c+1)];return m*(1-_)*(1-f)+x*_*(1-f)+h.data[(v+1)*h.width+c]*f*(1-_)+g*_*f}.bind(a)):a.getGroundAltitude=function(e,t){return p}.bind(a)),this._updateAltitudeUniforms(s),this._updateDebugUniforms(s,t.tile),this._updateCropUniforms(s,t.tile),this._updateSkyUniforms(s),f.isGeometric()||""===f.get("url")||f.applyDTM(s,t.tile),void 0===g||F||this._sourceList[g].applyLandcover(s,t.tile),this.isTerrainAnalyzerActivated()&&this._updateAnalyzerUniforms(s),o>0)if(1===o)this._sourceList[x[0]].applyOverlay(s,t.tile),g===x[0]&&this._sourceList[g].applyLandcover2(s,t.tile,0);else for(x.sort(function(e,t){var i,r=this._sourceList[e].getDataModelOrder(),a=this._sourceList[t].getDataModelOrder(),s=Math.min(r.length,a.length);for(i=0;i<s;++i){if(r[i]<a[i])return-1;if(r[i]>a[i])return 1}return 0}.bind(this)),h=0,c=x.length-o;h<o;++h,++c)B=x[c],this._sourceList[B].applyOverlay(s,t.tile,h),g===B&&this._sourceList[g].applyLandcover2(s,t.tile,h);var X=1,U=0,N=s.getPDSFXUniform("dtm");n.is(N)&&void 0!==N.value&&(X=Math.max(N.value.bounds.max-N.value.bounds.min,1),U=(N.value.bounds.max+N.value.bounds.min)/2),function(t,i,r,a){var s=t.getMatrix();s.identity();var o=m.x/(1<<i.LOD),n=m.y/(1<<i.LOD),l=a,d=new e.Vector3(o,n,l),u=new e.Vector3((i.I+.5)*d.x,(i.J+.5)*d.y,r);M&&(d.x*=.9,d.y*=.9),s.setPosition(u),s.scale(d),t.setMatrix(s),t.forceUpdate()}(a,t.tile,U,X)}var z=this._sourceList[a.source].getRendering();if(v.is(z)||(z=this.getRendering()),!0!==a.useGeometricParent&&(v.is(s)?(z.applyFeatureRenderingToMaterial(s),k=s.oceanTexture):z.applyRendering(a)),this._updateOceanUniforms(s),d.publish("/xCity/needRender",this),t.value!==a)if(void 0===t.value||null===t.value)t.value=a;else{if(void 0!==t.value.parents&&!0!==a.useGeometricParent)for(c=(u=t.value.getParents()).length;c--;)u[c].removeChild(t.value),u[c].addChild(a);var J=!1;t.locks>0&&(J=!0,r.unlock("terrain",t.key)),t.oldValue.push(t.value),t.value=a,a.isGeometric&&(t.tmp=!1,t.temporary=!1,t.value.tmp=!1,t.value.temporary=!1),!0===J&&r.lock("terrain",t.key)}else{J=!1;t.locks>0&&(J=!0,r.unlock("terrain",t.key)),!0===J&&r.lock("terrain",t.key)}},getLowerDataModelSource:function(e,t){var i=this._sourceList[e].getDataModelOrder(),r=this._sourceList[t].getDataModelOrder(),a=i.length,s=r.length;if(a<=0)return t;if(s<=0)return e;var o,n=Math.min(a,s);for(o=0;o<n;++o){if(i[o]<r[o])return t;if(i[o]>r[o])return e}return n===a?e:t},cleanTerrainTile:function(i){var a,s=function(e,t){var i,a,s=e.getPDSFXUniform(t);if(v.is(s))if("tv"===s.type)for(i=0,a=s.value.length;i<a;++i)void 0!==(o=s.value[i])&&(s.value[i]=void 0,r.unlock(o.storeId,o.storeKey));else if("t"===s.type||"t2"===s.type){var o=s.value;void 0!==o&&(s.value=void 0,r.unlock(o.storeId,o.storeKey))}};i instanceof e.ShaderMaterialDS?a=i:i instanceof t&&(a=i.getMaterial()),void 0!==a?(s(a,"dtm"),s(a,"raster"),s(a,"landcover"),a.updatePDSFXUniform("dtmCrop",new e.Vector4(-1,-1,1,1)),a._globePool.recycle(a),i.setMaterial(null),i.mesh3js.material=null,i._globePool.recycle(i)):o.warn("XCityCoreTerrain:cleanTerrainTile - no material...")},registerTerrainSource:function(e,t){void 0===this._sourceList[e]?(this._sourceList[e]=t,y=Math.max(y,t.get("levelMax")),t.addEvent("onChange:statistics",this.updateStatistics.bind(this,t)),t._itemParent.addEvent("onChange:visible",this.updateStatistics.bind(this,t)),t.addEvent("onDestroy",this.removeStatistics.bind(this,t))):o.warn("XCityCoreTerrain: A terrain source '"+e+"' already exists!")},removeStatistics:function(e){var t=e.get("url");if(v.is(this._altitudeMaxList)){var i,r=this._altitudeMaxList.length;for(i=0;i<r;i++)if(this._altitudeMaxList[i].id===t){this._altitudeMaxList.splice(i,1);break}for(r=this._altitudeMinList.length,!1,i=0;i<r;i++)if(this._altitudeMinList[i].id===t){this._altitudeMinList.splice(i,1);break}this.updateMinMaxAltitude()}},updateStatistics:function(e){var t=e.get("statistics");v.is(t)||(t={}),t.id=e.get("url"),t.visible=e._itemParent.get("visible"),this.mergeStatistics(t)},mergeStatistics:function(e){v.is(this._altitudeMaxList)||(this._altitudeMaxList=[]);var t,i=this._altitudeMaxList.length,r=!1;for(t=0;t<i;t++)if(this._altitudeMaxList[t].id===e.id){this._altitudeMaxList[t]=e,r=!0;break}for(r||(this._altitudeMaxList.push(e),v.sortObjectArraybyAttribute(this._altitudeMaxList,"maximalAltitude")),v.is(this._altitudeMinList)||(this._altitudeMinList=[]),i=this._altitudeMinList.length,r=!1,t=0;t<i;t++)if(this._altitudeMinList[t].id===e.id){this._altitudeMinList[t]=e,r=!0;break}r||(this._altitudeMinList.push(e),v.sortObjectArraybyAttribute(this._altitudeMinList,"minimalAltitude")),this.updateMinMaxAltitude()},updateMinMaxAltitude:function(){var e,t,i=this._altitudeMaxList.length;for(e=i-1;e>=0&&!(t=this._altitudeMaxList[e]).visible;e--);e<0&&(t=null);var r=this.getRendering();for(v.is(t)&&v.is(t.maximalAltitude)?this.maximalAltitude=t.maximalAltitude:this.maximalAltitude=r.defaultElevationMax,i=this._altitudeMinList.length,e=0;e<i&&!(t=this._altitudeMinList[e]).visible;e++);e>=i&&(t=null),v.is(t)&&v.is(t.minimalAltitude)?this.minimalAltitude=t.minimalAltitude:this.minimalAltitude=r.defaultElevationMin,r.updateElevationMin(this.minimalAltitude),r.updateElevationMax(this.maximalAltitude)},unregisterTerrainSource:function(e){void 0!==this._sourceList[e]&&(delete this._sourceList[e],r.deprecateAll("terrain"))},activateTerrainSource:function(e){var t=this._sourceList[e];t&&(void 0===this._activeTerrain[t.get("levelMin")]&&(this._activeTerrain[t.get("levelMin")]=[]),-1===this._activeTerrain[t.get("levelMin")].indexOf(e)&&(this._activeTerrain[t.get("levelMin")].push(e),r.deprecateAll("terrain")))},deactivateTerrainSource:function(e){var t,i=this._sourceList[e];i&&void 0!==this._activeTerrain[i.get("levelMin")]&&-1!==(t=this._activeTerrain[i.get("levelMin")].indexOf(e))&&(this._activeTerrain[i.get("levelMin")].splice(t,1),0===this._activeTerrain[i.get("levelMin")].length&&delete this._activeTerrain[i.get("levelMin")],r.deprecateAll("terrain"))},registerRasterSource:function(e,t){void 0===this._sourceList[e]?(this._sourceList[e]=t,y=Math.max(y,t.get("levelMax")),t.isLandcover()&&(void 0===this._activeLandcover[t.get("levelMin")]&&(this._activeLandcover[t.get("levelMin")]=[]),this._activeLandcover[t.get("levelMin")].push(e),r.deprecateAll("terrain"))):o.warn("XCityCoreTerrain: A overlay source '"+e+"' already exists!")},unregisterRasterSource:function(e){if(void 0!==this._sourceList[e]){if(this._activeLandcover[this._sourceList[e].get("levelMin")]){var t=this._activeLandcover[this._sourceList[e].get("levelMin")].indexOf(e);t>-1&&this._activeLandcover[this._sourceList[e].get("levelMin")].splice(t,1)}delete this._sourceList[e],r.deprecateAll("terrain")}},activateRasterSource:function(e){var t=this._sourceList[e];t&&(void 0===this._activeRaster[t.get("levelMin")]&&(this._activeRaster[t.get("levelMin")]=[]),-1===this._activeRaster[t.get("levelMin")].indexOf(e)&&(this._activeRaster[t.get("levelMin")].push(e),r.deprecateAll("terrain")))},deactivateRasterSource:function(e,t){var i,a=this._sourceList[e];if(a){var s=a.get("levelMin");"number"==typeof t&&(s=t),void 0!==this._activeRaster[s]&&-1!==(i=this._activeRaster[s].indexOf(e))&&(this._activeRaster[s].splice(i,1),0===this._activeRaster[s].length&&delete this._activeRaster[s],r.deprecateAll("terrain"))}},getRendering:function(){return v.is(this._rendering)||(this._rendering=new c(this.renderingProfileManager._urban)),this._rendering},redraw:function(){var e=this.getRendering(),t=e.getCompleteMaterialInfo(),i=!0;if(this.setupOcean(t)||(i=!1),this.setupAnalyzer(t)||(i=!1),i){r.traverse("terrain",function(t){void 0!==t.material&&null!==t.material&&e.applyFeatureRenderingToMaterial(t.material)})}},redrawGeometricTiles:function(e){var t=e.getRendering(),i=(t.getCompleteMaterialInfo(),e.get("id"));r.traverse("terrain",function(e){e.isGeometric&&e.source===i&&t.applyRendering(e)})},get:function(e){var t,i,r=this.getRendering();return v.is(r)&&r.hasAttribute(e)&&(i=this.getMaterial(),v.is(i)&&(t=(i=f.getJSONFromRendering(i))[e])),t},set:function(e,t){var i={},r=this.getRendering();v.is(r)&&r.hasAttribute(e)&&(i[e]=t,this.setMaterial(i))},resetRenderingAttribute:function(e){if(!v.is(this.renderingProfileManager))return null;this.renderingProfileManager.resetAttributeOnly(this._renderingId,e),this.renderingProfileManager.updateGeomRenderings([this]),this.redraw()},setMaterial:function(e){return v.is(this.renderingProfileManager)?(this.renderingProfileManager.addRendering(this._renderingId,e),this):null},getMaterial:function(){var e=this.getRendering();return v.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this._renderingId)},isTerrainAnalyzerActivated:function(){return void 0!==O.mode&&"default"!==O.mode}};var te=null;return null===te&&(te=new ee),te});