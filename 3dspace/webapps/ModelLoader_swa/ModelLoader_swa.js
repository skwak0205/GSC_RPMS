define("DS/ModelLoader_swa/loader",["DS/Mesh/Mesh","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/Utils","DS/Visualization/ThreeJS_DS","DS/GEONavDriveAPI/GEOdriveServices","DS/GEOV1Loader/GEOstrServices","DS/GEOV1Loader/GEOdtmServices","DS/GEOV1Loader/GEOsdmServices","DS/WebInfraUI/Notification","DS/WebSystem/Nls","DS/Core/Events"],function(e,r,a,t,i,n,l,o,s,c,f,d){"use strict";return function(){this.errorCallbackFunc=null,this.load=function(e,r,t,i,c,f){var h=this;h.errorCallbackFunc=void 0!==c?c:null,e.filename;var p=!1,u=!1,g=!1;h.scene=new a,h.scene.name="scene",h.scene.productType="Reference3D";var v=0,S=0;h.doneDTM=function(e){for(var r=e.length,a=0;a<r;a++)e[a].mesh3js.sceneGraph.children[0].solid=1,h.scene.addChild(e[a]);++S==v&&i()},h.doneStr=function(e){for(var r=e.length,a=0;a<r;a++)h.scene.addChild(e[a]);f&&f({hack:!0,updateInfinitePlane:!0}),++S==v&&i()},h.doneSdm=function(e){for(var r=e.length,a=0;a<r;a++)h.scene.addChild(e[a]);f&&f({hack:!0,updateInfinitePlane:!0}),++S==v&&i()},h.errorSwaItemCB=function(r){h._errorLoader("LOAD_SWA_ITEM",e)},h.processSwa=function(a){var n=new o,c=new l,d=new s;if(null==a.files)return!1;for(var v=a.files.length,S=JSON.stringify(e),m=JSON.parse(S),w=e.serverurl?e.serverurl:"",L="",D=-1,O=0,_=!1,P=0;P<v;P++){var C="";if((g||p||u||a.directLocation[P]||a.directPath[P])&&(_=!0),C=a.paths[P].length&&_?a.paths[P]+"/"+a.files[P]:a.files[P],D=a.files[P].lastIndexOf("/"),O=a.files[P].length,L="",-1!=D&&(L=a.files[P].substring(D+1,O)),p?(C=L,m.serverurl="",m.filename=w+"/"+a.files[P]):u?(m.serverurl="",C=L,a.paths[P].length?m.filename=w+"/"+a.paths[P]+"/"+a.files[P]:m.filename=w+"/"+a.files[P]):1==a.directLocation[P]?(C=L,m.serverurl="",m.filename=w+"/"+a.files[P]):1==a.directPath[P]&&(C=L,m.serverurl="",a.paths[P].length?m.filename=w+"/"+a.paths[P]+"/"+a.files[P]:m.filename=w+"/"+a.files[P]),-1!=a.files[P].indexOf(".dtm")){var E={multiLoad:!0,path:C,isRelativePathName:!0,rootPath:"",itemDoneCB:function(e){h.doneDTM(e)}};n.load(m,E,r,t,i,h.errorSwaItemCB,f)}else-1!=a.files[P].indexOf(".str")?(E={multiLoad:!0,path:C,isRelativePathName:!0,rootPath:"",itemDoneCB:function(e){h.doneStr(e)}},c.load(m,E,r,t,i,h.errorSwaItemCB,f)):-1!=a.files[P].indexOf(".sdm")&&(E={multiLoad:!0,path:C,isRelativePathName:!0,rootPath:"",itemDoneCB:function(e){h.doneSdm(e)}},d.load(m,E,r,t,i,h.errorSwaItemCB,f))}return!0},h.parseSwa=function(r){for(var a=function(e){for(var r=e.replace(/(\s+)/gi," ").replace(/(\()(\w+)(\s)/gi,function(e,r,a,t){return'{"'+a+'":['}).replace(/(\))/gi,"]}").split('"'),a="",t=0;t<=r.length;t++)a+=t%2?r[t]:r[t].replace(/(\s)/gi,","),t<=r.length&&(a+='"');var i="["+a.replace(/(\()/gi,"{[").replace(/(\{)(\[)(.*?)(\])(\})/gi,function(e){return e.replace(/(\{)/gi,"").replace(/(\})/gi,"")}).replace(/(\,)(\])/gi,"]").replace(/(\[)(\,)/gi,"[").replace(/([:;,{\[])((?:[a-z][a-z0-9_]*))([:;,}\]])/gi,function(e,r,a,t){return'"'==r&&'"'==t?e:r+'"'+a+'"'+t}).replace(/(\d*\.{0,1}\d+)([^.a-zA-Z0-9_])/gi,function(e,r,a,t,i){return parseFloat(r)+a}).replace(/(\\)/gi,"/").split('["end"]')[0]+'["end"]]',n="";try{n=JSON.parse(i)}catch(e){return console.log("swa2JSON error="+e+"\n"),""}return n}((new o)._ensureString(r)),t=0,n=0,l=0,s=[],c=!0,f=[],m=0;m<a.length;m++){if(a[m].viewport){t++,l=0,n=0;var w={},L=a[m].viewport,D=L.length;if(t>1)return void h._errorLoader("PARSE_ONE_VIEWPORT",e);if(0==L.length)return void h._errorLoader("PARSE_SWA",e);for(var O=0;O<D;O++){if(L[O].datum){if(++l>1){c=!1;break}var _=L[O].datum;if(3!=_.length){c=!1;break}w.datumX=1e3*_[0],w.datumY=1e3*_[1],w.datumZ=1e3*_[2]}if(L[O].camera){if(++n>1){c=!1;break}for(var P=L[O].camera,C=P.length,E=0;E<C;E++){if(P[E].position){var b=P[E].position;if(3!=b.length){c=!1;break}w.positionX=1e3*b[0],w.positionY=1e3*b[1],w.positionZ=1e3*b[2]}if(P[E].target){var y=P[E].target;if(3!=y.length){c=!1;break}w.targetX=1e3*y[0],w.targetY=1e3*y[1],w.targetZ=1e3*y[2]}if(P[E].up){var k=P[E].up;if(3!=k.length){c=!1;break}w.upX=1e3*k[0],w.upY=1e3*k[1],w.upZ=1e3*k[2]}if(P[E].field){var G=P[E].field;if(2!=G.length){c=!1;break}w.fieldWidth=1e3*G[0],w.fieldHeight=1e3*G[1]}P[E].projection&&(w.projection=P[E].projection)}}}s.push(w)}if(a[m].layer){for(var N=a[m].layer,I={},A=(D=N.length,0);A<D;A++)if(N[A].name&&N[A].name[0]&&(I.name=N[A].name[0]),N[A].styles&&N[A].styles[0]&&(I.styles=N[A].styles[0].replace(/(\/)/gi,"\\")),N[A].files){I.files=[],I.paths=[],I.directLocation=[],I.directPath=[];for(var V=0;V<N[A].files.length;V++){var B=N[A].files[V];if(B.fileSpec){for(var W=B.fileSpec,M="",z="",R=!1,F=!1,J=0;J<W.length;J++){if(W[J].location&&W[J].location.length){var T=W[J].location[0].split("surpac2dtm:");(M=T.length?T[T.length-1]:W[J].location[0]).replace(/(\/)/gi,"\\")}W[J].path&&W[J].path.length&&W[J].path[0].length&&(z=W[J].path[0].replace(/(\/)/gi,"\\")),W[J].directPath&&(R=!0),W[J].directLocation&&(F=!0)}M=M.replace(/\\/g,"/"),z=z.replace(/\\/g,"/"),I.files.push(M),I.paths.push(z),I.directLocation.push(F),I.directPath.push(R)}}}f.push(I)}else"directLocation"==a[m]?p=!0:"directPath"==a[m]?u=!0:"activeLocalPath"==a[m]&&(g=!0)}v=f.length;for(var Z=0;Z<v;Z++)h.processSwa(f[Z])||++S==v&&i();c&&s.length&&d.publish({event:"GEOSwaViewpoint",data:{viewport:s[0]}})},h.errorSwaCB=function(r){h._errorLoader("LOAD_SWA",e)},n.load(e,"",h.parseSwa,h.errorSwaCB),r&&r(h.scene)},this._errorLoader=function(e,r){console.log("type message="+e+"\n"),f.nls("ModelLoader_swa/GEOV1SWALoader_errors",e,function(e){console.log(e)}),this.errorCallbackFunc&&this.errorCallbackFunc({type:[e],url:[JSON.stringify(r)],rsc:"ModelLoader_swa/GEOV1SWALoader_errors",level:c.error})}}});