define("DS/XCityGeometry/PatchVectorFactory",["UWA/Core","UWA/Class","DS/XCityTools/Geocoder","DS/Visualization/Node3D","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils"],function(e,t,i,s,r,n){"use strict";return t.extend({init:function(e,t,i){this.hasLabel=!1,this.lifespanstAttribute=void 0!==t.lifespanstAttribute?t.lifespanstAttribute:"LifespanStart",this.lifespanAttribute=void 0!==t.lifespanAttribute?t.lifespanAttribute:"Lifespan",this.lifespanenAttribute=void 0!==t.lifespanenAttribute?t.lifespanenAttribute:"LifespanEnd",this.isFilteredByTime=void 0!==t.isFilteredByTime&&t.isFilteredByTime,this.nameAttribute=void 0!==t.nameAttribute?t.nameAttribute:"NAME",this.shapeType=t.shapeType,this.loadInfo={loaded:1,total:1}},setProgressCallback:function(e){this._progressCallback=e},initLabelOnSelect:function(e,t){this.hasLabel=!0,this.infoNode=new s,this.textNode=[],this.urban=e,this.renderType=t;var i=this.urban.getLayerSelection();i.addEvent("onSelect",this.displayText,this),i.addEvent("onDeselect",this.removeText,this),i.addEvent("onHover",this.displayText,this),i.addEvent("onDehover",this.removeText,this)},destroy:function(){var e=this.urban.getLayerSelection();e.removeEvent("onSelect",this.displayText,this),e.removeEvent("onDeselect",this.removeText,this),e.removeEvent("onHover",this.displayText,this),e.removeEvent("onDehover",this.removeText,this)},displayText:function(e){if(!(this.hasLabel&&this._rendering._getMaterialInfo().label.enable||e&&e.userData&&e.userData.fromWFS&&e.userData.type!==this.type)){var t=e.get("Content");if(t){var i=t.get("dataSourceId");if(!n.is(i))return;var s=t._layer.get("interactionBehaviours");if(!s||!s.onSelect||!s.onSelect.label)return;if(!n.is(this._node.userData))return void r.log(" incomplete node ");var a,o=this._node.userData.get("Content");if(n.is(this.geometrySubsetId)?a=this.geometrySubsetId:n.is(o)&&(a=o.get("id")),a===i&&(e.hasChanged("selected")&&this.nbSelectedNode++,t.userData&&"text"!==this.renderType)){0===this.infoNode.parents.length&&t._root.getNode3D().addChild(this.infoNode);var l=this._generateLabelFromContent(t);if(!n.is(l))return void console.log("textNode didnt create because label has no name");this.infoNode.setVisibility(!0)}}}},_generateLabelFromContent:function(e){var t=e._getStrid(),i=this._rendering.getCompleteMaterialInfo(t,e.userData);if(n.is(e.userData[this.nameAttribute])&&(i.label.name=e.userData[this.nameAttribute]),!n.is(i.label.name)||""===i.label.name)return;var s=this._computeLabelPos(e,i),r=this._computeGeometrySize(e,i);let a=n.generateLabelPriorities(this._node,void 0,e.userData);return this._generateLabel(s,t,i,r,void 0,a,this.infoNode)},_getFeatureDataFromStrid:function(e){var t;return n.is(this._node)&&n.is(this._node.userData)&&n.is(this._node.userData.getContent())&&n.is(this._node.userData.getContent()._data)?t=this._node.userData.getContent()._data:n.is(this._node)&&n.is(this._node.userData)&&n.is(this._node.userData.getContent())&&n.is(this._node.userData.getContent()._poiSet)&&n.is(this._node.userData.getContent()._poiSet._data)&&(t=this._node.userData.getContent()._poiSet._data),n.is(t)?("string"==typeof t&&(t=JSON.parse(t)),t.features.find(t=>t.properties.STRID==e)):n.is(this.geoJSON)&&n.is(this.geoJSON[e])&&n.is(this.geoJSON[e].features)&&n.is(this.geoJSON[e].features[0])?this.geoJSON[e].features[0]:void console.error("didn't find a way to retrieve the feature")},_getPrimInfo:function(e){var t=e._getStrid(),i=this._getPrimInfoFromPreview(t);if(n.is(i))return i;if(n.is(this._node.userData.getContent().primInfos)&&n.is(this._node.userData.getContent().primInfos[t]))return this._node.userData.getContent().primInfos[t];if(n.is(this.patch)&&n.is(this.patch.miDToTile))return this.patch.miDToTile[t];throw new Error("Couldn't find primitive info for strid: "+t)},_getPrimInfoFromPreview:function(e){return null},removeText:function(e){if(!this._rendering._getMaterialInfo().label.enable){var t=e.get("Content");if(t){var i=t.get("dataSourceId");if(!n.is(i))return;if(!n.is(this._node.userData))return void r.log(" incomplete node ");var s,a=this._node.userData.get("Content");if(n.is(this.geometrySubsetId)?s=this.geometrySubsetId:n.is(a)&&(s=a.get("id")),s===i){if("text"!==this.renderType&&n.is(t._getStrid())){let e="textNode_"+t._getStrid();var o=this.infoNode.getChildByName(e);o||(o=this.infoNode.children.find(t=>t.temporaryTextNode.name==e))&&o.temporaryTextNode&&(this.infoNode.removeChild(o),o=o.temporaryTextNode),n.is(o)&&(this.urban.labelManager.unregisterPOI(o),this.infoNode.removeChild(o))}e.hasChanged("selected")&&(this.nbSelectedNode--,this.infoNode.parents.length>0&&0===this.infoNode.children.length&&"text"!==this.renderType&&this.infoNode.parents[0].removeChild(this.infoNode))}}}},addLabelsToNode:function(e,t){var i=new s;if(n.is(e.labelMeshes))for(var r=0;r<e.labelMeshes.length;r++)i.addChild(e.labelMeshes[r]);t.addChild(i)},_patchZPositionProjection:function(e){if("EPSG:3857"===i.getDefaultProjection()||"EPSG:900913"===i.getDefaultProjection()){var t=i.computeMercatorScaleFactor(e.x,e.y,i.getDefaultProjection());e.z=e.z/t}},_shouldCreateLabelFromMaterial:function(e){return e.label&&!0===e.label.enable&&n.is(e.label.name)&&""!==e.label.name}})}),define("DS/XCityGeometry/DescriptionCard",["UWA/Core","UWA/Class","UWA/Class/Model","DS/xCityBasicUtils/Utils","css!DS/XCityGeometry/assets/style/descriptionCard.css"],function(e,t,i,s){"use strict";return i.extend({init:function(t){this.div=e.createElement("div"),this.div.addClassName("descriptionCard"),t&&(t.className&&this.div.addClassName(t.className),xCity._urbanImpl.showPrimBbox&&(this.debugCanvas=s.createDebugCanvas()))},remove:function(){s.is(this.debugCanvas)&&this.debugCanvas.getContext("2d").clearRect(0,0,this.debugCanvas.width,this.debugCanvas.height);this.div.remove()},fadePopup:function(e){let t=this.div;e?(t.hasClassName("descriptionCardfadeOut")&&t.removeClassName("descriptionCardfadeOut"),t.hasClassName("descriptionCardfadeIn")||t.addClassName("descriptionCardfadeIn")):(t.hasClassName("descriptionCardfadeIn")&&t.removeClassName("descriptionCardfadeIn"),t.hasClassName("descriptionCardfadeOut")||t.addClassName("descriptionCardfadeOut"))},slideElementAccordingToBbox:function(e,t,i,r=10,n=10,a=!0){let o,l=this.div,h=l.getSize().width,c=l.getSize().height;i||(i={x:0,y:0,width:0,height:0});let d={};return"absolute"!==l.style.position&&(e+=(o=l.parentElement.getBoundingClientRect()).left,t+=o.top),this.debugCanvas&&(this.debugCanvas.getContext("2d").clearRect(0,0,this.debugCanvas.width,this.debugCanvas.height),s.draw2Drect(this.debugCanvas,e,t,h,c),s.draw2Drect(this.debugCanvas,i.left,i.top,i.width,i.height,"red")),e=s.slideWithinRange(e,h+r,i.x,window.innerWidth,d),e=-s.slideWithinRange(-e,r,-i.x-i.width,0,d),t=s.slideWithinRange(t,c+n,i.y,window.innerHeight,d),(t=-s.slideWithinRange(-t,n,-i.y-i.height,0,d))+c>i.y&&a&&(t=i.y+i.height,t=s.slideWithinRange(t,c+n,i.y,window.innerHeight,d),t=-s.slideWithinRange(-t,n,-i.y-i.height,0,d)),this.debugCanvas&&s.draw2Drect(this.debugCanvas,e,t,h,c,"blue"),d.toHide?this.fadePopup(!1):l.hasClassName("descriptionCardfadeOut")&&this.fadePopup(!0),"absolute"!==l.style.position&&(e-=o.left,t-=o.top),l.style.left=e+"px",l.style.top=t+"px",{left:e,top:t}}})}),define("DS/XCityGeometry/PointOfInterest3DSet",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/Mesh/MeshUtils","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityTools/ShaderTools","DS/XCityTools/TextureTools","DS/Plugins/RenderPass","DS/Mesh/Mesh","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader","DS/XCityTools/Pooler","DS/XCityTools/RenderingTools","DS/XCityTools/TextureManager","DS/WebappsUtils/WebappsUtils"],function(e,t,i,s,r,n,a,o,l,h,c,d,u,p,m,f){"use strict";var g=t.extend({init:function(t,s,r){this.__v0=new e.Vector3,this.__v1=new e.Vector3,this.__center=new e.Vector3,this.__scale=new e.Vector3,this.__instanceMatrix=new e.Matrix4,this.__instanceNormalMatrix=new e.Matrix3,this.__p0=new e.Vector3,this.__p1=new e.Vector3,this.__p2=new e.Vector3,this.__p3=new e.Vector3,this.__p4=new e.Vector3,this.__n0=new e.Vector3,this.__n1=new e.Vector3,this.__n2=new e.Vector3,this.__n3=new e.Vector3,this.__n4=new e.Vector3,this.urban=t,this.posTile=r.posTile,this.tileInfo=r.tile.LOD+"_"+r.tile.I+"_"+r.tile.J,this.tileBbox={};var n=this.urban.worldSize/(1<<r.tile.LOD);this.tileBbox.xmin=r.tile.I*n+this.urban.shiftedPosition.x,this.tileBbox.xmax=(r.tile.I+1)*n+this.urban.shiftedPosition.x,this.tileBbox.ymin=r.tile.J*n+this.urban.shiftedPosition.y,this.tileBbox.ymax=(r.tile.J+1)*n+this.urban.shiftedPosition.y;var a=this.getCurrentDimensions();this.halfScreenResolution=new e.Vector2(a.width/2,a.height/2),i.is(s.rendering)&&(this._rendering=s.rendering),this.geometryMode=void 0!==s.geometryMode?s.geometryMode.toLowerCase():"mesh",this.urban.USR.hwInstancing&&(this.geometryMode="instancing"),this.shapeType=s.shapeType,void 0!==s.modelMesh3d&&(this.modelMesh3d=s.modelMesh3d,this.ownModelReady=!0,this._posSize=s._posSize),this.shadingMode=void 0!==s.shadingMode?s.shadingMode.toLowerCase():"smooth",this.renderType=void 0!==s.renderType?s.renderType.toLowerCase():"icon","text"===this.renderType&&(this.geometryMode="mesh"),this.renderMode=void 0!==s.renderMode?s.renderMode.toLowerCase():"overlay",this.iconTopLeft=null,this.samplingFactor=void 0!==s.samplingFactor?s.samplingFactor:1,this.opacityFactor=void 0!==s.opacityFactor?s.opacityFactor:1,this.size=new e.Vector3(1,1,1),this.switchDistance=void 0!==s.switchDistance?s.switchDistance:0,this.styleClass=void 0,this.primitiveNodes={},this.primitiveAnchorNodes={},this.nbMesh=0,this.nbPoi=0,this.idLayer=0,this.cssProcessed=!1,this.initializeRendering(),this.initializeInstancingParams(),this.minMax={minX:99999999.9,minY:99999999.9,minZ:99999999.9,maxX:-99999999.9,maxY:-99999999.9,maxZ:-99999999.9},this.minMaxOrig={minX:99999999.9,minY:99999999.9,minZ:99999999.9,maxX:-99999999.9,maxY:-99999999.9,maxZ:-99999999.9},this.scaleCulling=g.scaleCulling,this._debugID=0,this.urlTexture=void 0!==s.urlTexture?s.urlTexture:"",this.widthTexture=1,this.heightTexture=1,this.textMaterial=[],this.textNode=[],this.poiName=[],this.nbSelectedNode=0,this.renderAnchor=void 0!==s.renderAnchor&&s.renderAnchor,this.anchorLineWidth=void 0!==s.anchorLineWidth?s.anchorLineWidth:1,this.transparentPrimitive=!1,this.nbVertices=[15,15],this.maxVerticesSphere=17,"number"==typeof s.nbVertices&&s.nbVertices>=3?this.nbVertices=[s.nbVertices,s.nbVertices]:s.nbVertices instanceof Array&&(s.nbVertices[0]>=3&&(this.nbVertices[0]=s.nbVertices[0]),s.nbVertices[1]>=3&&(this.nbVertices[1]=s.nbVertices[1])),this.nbVertices[0]>this.maxVerticesSphere&&(console.log("POI sphere resolution (nbVertices) is bounded to 17."),this.nbVertices[0]=this.maxVerticesSphere),this.nbVertices[1]>this.maxVerticesSphere&&(console.log("POI sphere resolution (nbVertices) is bounded to 17."),this.nbVertices[1]=this.maxVerticesSphere),this._defineRenderPass(),this._setMaterial()},initializeInstancingParams:function(){this.instanceMatrix=[],this.instanceNormalMatrix=[],this.instanceColor=[],this.instanceAnchor=[],this.instanceAnchorColor=[],this.instanceFlags=[],this.instanceFloats=[],this.instancingReady=!1,this.instanceCgmId=[],this.initScale=[]},initializeRendering:function(){if(i.is(this._rendering)){var e=this._rendering.getCompleteMaterialInfo();p._setMaterialFromProfile(this,e)}},destroy:function(){},isReady:function(){return this._ready},dispose:function(){},setRendering:function(){return!1},getCurrentDimensions:function(){var e=this.urban.USR.webGLV6Viewer;return e?{width:e.SCREEN_WIDTH,height:e.SCREEN_HEIGHT}:this.urban._frmViewerContainer.getDimensions()},updateScreenDimension:function(e){var t=this.getCurrentDimensions();1!==t.width&&1!==t.height&&(this.halfScreenResolution.x=t.width/2,this.halfScreenResolution.y=t.height/2,i.is(e)&&(i.is(e.isPDSFX())?e.updatePDSFXUniform("halfScreenResolution",this.halfScreenResolution):e.uniforms.halfScreenResolution.value=this.halfScreenResolution))},_defineRenderPass:function(){var e;"occluded"===this.renderMode?this._poiPostPassID="main":"overlay"===this.renderMode?(this._poiPostPassID="PoiTransparentOverlayPass",void 0===this.urban.getView3D().getRenderPassManager().getPass(this._poiPostPassID)&&((e=new l(null,null,void 0,!0,!1,!1,this._poiPostPassID)).idString=this._poiPostPassID,this.urban.getView3D().getRenderPassManager().addPass(this._poiPostPassID,e,{after:"ClearDepthPass"}))):(this._poiPrePassID="main",this._poiPostPassID="PoiTransparentOverlayPass",void 0===this.urban.getView3D().getRenderPassManager().getPass(this._poiPostPassID)&&((e=new l(null,null,void 0,!0,!1,!1,this._poiPostPassID)).idString=this._poiPostPassID,this.urban.getView3D().getRenderPassManager().addPass(this._poiPostPassID,e,{after:"ClearDepthPass"})))},_setMaterial:function(){var t,i=this._rendering,s=i.getCompleteMaterialInfo(),r=s.color,n=s.opacity;if("icon"===this.renderType){"billboard"===this.shapeType?(this.matPostPass=a.getPDSFXMaterial([g.coloring_PDSFX,g.mapping_PDSFX,g.atlasing_PDSFX,g.poiOnePass2d_instancing_PDSFX],"basic"),i.addAtlasUniforms(this.matPostPass),this.matPostPass.updatePDSFXUniform("halfScreenResolution",this.halfScreenResolution),this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,this.matPostPass))):(this.matPostPass=a.getPDSFXMaterial([g.poiOnePass3d_instancing_PDSFX],"physical"),this.matPostPass.metalness=0,this.matPostPass.roughness=1),this.matPostPass.name=this.shapeType+"material",this.matPostPass.updatePDSFXUniform("switchDistance",this.switchDistance),this.matPostPass.updatePDSFXUniform("scaleCulling",this.scaleCulling),this.matPostPass.alphaTest=.1,this.matPostPass.side=e.FrontSide;var o=!1;n<1?o=!0:"billboard"===this.shapeType&&(o=!0),this.matPostPass.transparent=o,this.transparentPrimitive=o,this.matPostPass.forceSide=!0,this.matPostPass.side=0,this.matPostPass._autoForceSide=!1,this.matPostPass.depthTest=!0,this.matPostPass.depthWrite=!0,"disc"===this.shapeType&&i.defaultRendering.addOver({side:e.DoubleSide,forceSide:!0}),t=1,"dual"===this.renderMode&&("billboard"===this.shapeType&&this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,this.matPrePass)),t=this.opacityFactor),this.matPostPass.color=r,this.matPostPass.opacity=n*t,a.updateCommonUniforms(this.matPostPass)}this.renderAnchor&&(this.matAnchorPostPass=a.getPDSFXMaterial([g.poiOnePass3dAnchorTriangle_instancing_PDSFX],"physical"),this.matAnchorPostPass.updatePDSFXUniform("halfWidth",this.anchorLineWidth/2),this.matAnchorPostPass.updatePDSFXUniform("switchDistance",this.switchDistance),this.matAnchorPostPass.side=e.FrontSide,this.matAnchorPostPass.transparent=!0,this.matAnchorPostPass.depthTest=!0,this.matAnchorPostPass.depthWrite=!0,this.matAnchorPostPass.name="AnchorPostpass",this.matAnchorPostPass.color=r,this.matAnchorPostPass.opacity=n*t,a.updateCommonUniforms(this.matAnchorPostPass),this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,this.matAnchorPostPass)))},getMesh:function(){var s,r,a,o,l=function(t,i,s){var r=!1,n=i.geometry.boundingSphere,a=n.center.x-n.radius,o=n.center.x+n.radius,l=n.center.y-n.radius,h=n.center.y+n.radius,c=n.center.z-n.radius,d=n.center.z+n.radius,u=i.userData.__v0,p=i.userData.__v1;u.set(t[s+12],t[s+13],t[s+14]),p.set(t[s+0],t[s+5],t[s+10]),u.x-p.x<a&&(a=u.x-p.x,r=!0),u.x+p.x>o&&(o=u.x+p.x,r=!0),u.y-p.y<l&&(l=u.y-p.y,r=!0),u.y+p.y>h&&(h=u.y+p.y,r=!0);var m=u.z;if(u.z-p.z<c&&(c=u.z-p.z,r=!0),m+p.z>d&&(d=m+p.z,r=!0),r){var f=new e.Sphere;f.radius=Math.sqrt(Math.pow(o-a,2)+Math.pow(h-l,2)+Math.pow(d-c,2))/2,f.center.x=(a+o)/2,f.center.y=(l+h)/2,f.center.z=(c+d)/2,i.boundingSphere=f}},h=function(e,t){return e.reduce((e,i,s)=>(i===t&&e.push(s),e),[])},c=function(e,t){var s=this.mesh3js.instanceAttribArrays.instanceFlag.array,r=[-1];if(!0===this.isInstanceNode3D){var n=this.mesh3js.userData.instanceIds;if(!i.is(n))return;r=h(n,t)}for(let t=0;t<r.length;t++){const n=r[t];var a=s[n],o=s[n];(a=i.floatPack(a,3,!e))!==o&&(s[n]=a,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0)}},d=function(e,t,s){var r,n=0,a=e.scale,o=i.is(a),c="billboard"===this._shapeType,d=[-1];if(!0===this.isInstanceNode3D){var u=this.mesh3js.userData.instanceIds;if(!i.is(u))return;var p=this.mesh3js.instanceAttribArrays.instanceFlag.array;d=h(u,s)}for(let t=0;t<d.length;t++){const h=d[t];if(!0===this.isInstanceNode3D&&(n=p[h]),o){r||(r=[]);var m,f,g,y=c?1:.5,v=c?1:100;m=a.x*y,f=a.y*y,"sphere"===this._shapeType&&(f=g=m),r[0]=m*v,r[5]=f*v,r[10]=g*v}n=i.floatPack(n,2,o);var b=e.color;i.is(b)&&i.is(b.computeColor)&&(b=b.computeColor());var x,_,C=e.opacity,S=i.is(b),D=i.is(C);if(n=i.floatPack(n,0,S),n=i.floatPack(n,1,D),!0===this.isInstanceNode3D){var P=this.mesh3js.userData.instanceIds.indexOf(s);if(r){x=16*h,_=16*P;var M=this.mesh3js.instanceAttribArrays.instanceMatrix.array,w=this.mesh3js.userData.instanceMatrix;for(var T in r)if(r.hasOwnProperty(T)){var I=x+Number(T);M[I]=r[T],w[I=_+Number(T)]=r[T]}this.mesh3js.instanceAttribArrays.instanceMatrix.isDynamic=!0,l(M,this.mesh3js,x)}if(S||D){var A=this.mesh3js.instanceAttribArrays.instanceColor.array,V=this.mesh3js.userData.instanceColor;x=4*h,_=4*P,S&&(A[x]=b.r,A[x+1]=b.g,A[x+2]=b.b,V[P].x=b.r,V[P].y=b.g,V[P].z=b.b),D&&(A[x+3]=C,V[P].w=C),this.mesh3js.instanceAttribArrays.instanceColor.isDynamic=!0}p=this.mesh3js.instanceAttribArrays.instanceFlag.array;var F=this.mesh3js.userData.instanceFlags;n!==p[h]&&(p[h]=n,F[P]=n,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0)}}},u=function(e,t,s){var r,n=0;!0===this.isInstanceNode3D&&(n=r=(x=this.mesh3js.instanceAttribArrays.instanceFlag.array)[y=this.mesh3js.userData.cgmIds.indexOf(s)]);var a,o=e.scale;if(i.is(o)){a||(a=[]);var l,h,c;l=.5*o.x,h=.5*o.y,c=o.z,"sphere"===this._shapeType&&(h=c=l),a[0]=100*l,a[5]=100*h,a[10]=100*c,n=i.floatPack(n,2,1)}var d=e.color;i.is(d)&&i.is(d.computeColor)&&(d=d.computeColor());var u,p=e.opacity,m=i.is(d),f=i.is(p);if(n=i.floatPack(n,0,m),n=i.floatPack(n,1,f),!0===this.isInstanceNode3D){var g=this.mesh3js.userData.instanceIds.indexOf(s),y=this.mesh3js.userData.cgmIds.indexOf(s);if(m||f){var v=this.mesh3js.instanceAttribArrays.instanceColor.array,b=this.mesh3js.userData.instanceColor;u=4*y,4*g,m&&(v[u]=d.r,v[u+1]=d.g,v[u+2]=d.b,b[g].x=d.r,b[g].y=d.g,b[g].z=d.b),f&&(v[u+3]=p,b[g].w=p),this.mesh3js.instanceAttribArrays.instanceColor.isDynamic=!0}if(n!==r){var x=this.mesh3js.instanceAttribArrays.instanceFlag.array,_=this.mesh3js.userData.instanceFlags;x[y]=n,_[g]=n,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0}}},p=function(t,i){if(void 0!==t){var s=this.mesh3js.userData.cgmIds.indexOf(i),r=t[0],n=t[1],a=t[2];if(void 0!==this.mesh3js.userData.__posTile&&(r-=this.mesh3js.userData.__posTile.x,n-=this.mesh3js.userData.__posTile.y),-1!==s){var o=this.mesh3js.userData.__initScale[s][0],l=this.mesh3js.userData.__initScale[s][1],h=this.mesh3js.userData.__initScale[s][2],c=this.mesh3js.userData.__transModel.x,d=this.mesh3js.userData.__transModel.y,u=this.mesh3js.userData.__transModel.z,p=this.mesh3js.instanceAttribArrays.instanceMatrix.array,m=p[16*s+0]/o,f=p[16*s+1]/o,g=p[16*s+10]/h,y=p[16*s+6]/l,v=r+c*m-f*(d*g-u*y),b=n+(d*g-u*y)*m+c*f,x=a+d*y+u*g;p[16*s+12]=v,p[16*s+13]=b,p[16*s+14]=x,this.mesh3js.instanceAttribArrays.instanceMatrix.isDynamic=!0;var _=!1,C=this.mesh3js.geometry.boundingSphere,S=C.center.x-C.radius,D=C.center.x+C.radius,P=C.center.y-C.radius,M=C.center.y+C.radius,w=C.center.z-C.radius,T=C.center.z+C.radius,I=this.mesh3js.userData.__v0,A=this.mesh3js.userData.__v1;I.set(p[16*s+12],p[16*s+13],p[16*s+14]),A.set(p[16*s+0],p[16*s+5],p[16*s+10]),I.x-A.x<S&&(S=I.x-A.x,_=!0),I.x+A.x>D&&(D=I.x+A.x,_=!0),I.y-A.y<P&&(P=I.y-A.y,_=!0),I.y+A.y>M&&(M=I.y+A.y,_=!0);var V=I.z;if(I.z-A.z<w&&(w=I.z-A.z,_=!0),V+A.z>T&&(T=V+A.z,_=!0),_){var F=new e.Sphere;F.radius=Math.sqrt(Math.pow(D-S,2)+Math.pow(M-P,2)+Math.pow(T-w,2))/2,F.center.x=(S+D)/2,F.center.y=(P+M)/2,F.center.z=(w+T)/2}}}},m=function(e,t){if(void 0!==e){var i,s,r=this.mesh3js.userData.cgmIds.indexOf(t);if("object"==typeof e?(i=e[1],s=e[0]):(i=e,s=0),-1!==r){var n=this.mesh3js.instanceAttribArrays.instanceMatrix.array,a=this.mesh3js.userData.__initScale[r][0],o=this.mesh3js.userData.__initScale[r][1],l=this.mesh3js.userData.__initScale[r][2],h=Math.cos(i),c=Math.sin(i),d=Math.cos(s),u=Math.sin(s);n[16*r+0]=h*a,n[16*r+1]=c*a,n[16*r+2]=0,n[16*r+4]=-c*d*o,n[16*r+5]=d*h*o,n[16*r+6]=u*o,n[16*r+8]=u*c*l,n[16*r+9]=-h*u*l,n[16*r+10]=d*l,this.mesh3js.instanceAttribArrays.instanceMatrix.isDynamic=!0}return this}},f=new t;void 0!==this.modelMesh3d?(this.nbMesh=1,this.renderAnchor&&(this.primitiveAnchorNodes[0]=this.creatorAnchor.compilePrimitive("Poi3D_anchor",!0))):(this.primitiveNodes[0]=this.creator.compilePrimitive("Poi3D",!0),this.nbMesh=1,this.renderAnchor&&(this.primitiveAnchorNodes[0]=this.creatorAnchor.compilePrimitive("Poi3D_anchor",!0)));var g,y=this.matPostPass,v=this.matPrePass,b=1;"dual"===this.renderMode&&(b=this.opacityFactor),!0===this.transparentPrimitive&&(y.transparent=!0,v&&(v.transparent=!0));for(var x=0;x<this.nbMesh;x++){if(void 0!==this.modelMesh3d)g=this.modelMesh3d.clone(!0);else{var _=this.primitiveNodes[x];g=n.createMeshNode(_)}"text"===this.renderType&&"billboard"===this.shapeType&&((y=this.textMaterial[this.poiName[x]].postPass).updatePDSFXUniform("opacityCity",this.opacity*b),this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,y)),"dual"===this.renderMode&&(v=this.textMaterial[this.poiName[x]].prePass,this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,v)))),g.setRendering=d,g.setVisible=c,g._shapeType=this.shapeType,g.setPosition=p,g.setOrientation=m,g.setRenderPasses([this._poiPostPassID]),o="_poi3D_PostPass_"+this.styleClass,g.name=o,g._debugID=this._debugID,g.mesh3js.material=y,g.setMaterial(y);var C={data:this.instanceMatrix,type:"m4",attribName:"instanceMatrix"};if(s={data:this.instanceColor,type:"v4",attribName:"instanceColor"},r={data:this.instanceFlags,type:"f",attribName:"instanceFlag"},a={data:this.instanceFloats,type:"v4",attribName:"instanceFloats"},g.mesh3js.userData.cgmIds=this.instanceCgmId,g.mesh3js.userData.instanceMatrix=this.instanceMatrix,g.mesh3js.userData.instanceColor=this.instanceColor,g.mesh3js.userData.instanceFlags=this.instanceFlags,g.mesh3js.userData.instanceFloats=this.instanceFloats,g.mesh3js.userData.instanceIds=this.instanceCgmId.slice(),g.mesh3js.userData.__v0=new e.Vector3,g.mesh3js.userData.__v1=new e.Vector3,g.mesh3js.userData.__initScale=this.initScale,g.mesh3js.userData.__posTile=this.posTile,void 0!==this.modelMesh3d){var S=this.modelMesh3d.getMatrix();g.mesh3js.userData.__transModel=new e.Vector3(S.elements[12],S.elements[13],S.elements[14])}else g.mesh3js.userData.__transModel=new e.Vector3;g.setInstancingParameters(this.nbPoi,[C,s,r,a],"instance"),"dual"===this.renderMode&&(this.matPrePass=y.clone(),this.matPrePass.forceSide=!0,this.matPrePass.side=0,this.matPrePass._autoForceSide=!1,v=this.matPrePass,this._rendering.addAtlasUniforms(this.matPrePass));for(var D=0;D<g._occurrences.length;D++)g._occurrences[D].renderable.userData.cgmIds=this.instanceCgmId;if(g.forceBoundingSphere({radius:Math.sqrt(Math.pow(this.tileBbox.xmax-this.tileBbox.xmin,2)+Math.pow(this.tileBbox.ymax-this.tileBbox.ymin,2)+Math.pow(this.minMax.maxZ-this.minMax.minZ,2))/2,center:new e.Vector3((this.minMax.minX+this.minMax.maxX)/2,(this.minMax.minY+this.minMax.maxY)/2,(this.minMax.minZ+this.minMax.maxZ)/2)}),g.setShadow(!1,!1),f.addChild(g),this.renderAnchor){var P=this.primitiveAnchorNodes[x],M=n.createMeshNode(P);M.setRendering=u,M.setVisible=c,M.setPosition=p,M.setOrientation=m,M._shapeType="anchor",M.setRenderPasses([this._poiPostPassID]),M.name=o+"_Anchor",M._debugID=this._debugID,M.mesh3js.material=this.matAnchorPostPass,M.setMaterial(this.matAnchorPostPass),s={data:this.instanceAnchorColor,type:"v4",attribName:"instanceColor"};var w={data:this.instanceAnchor,type:"v4",attribName:"instanceAnchor"};r={data:this.instanceFlags,type:"f",attribName:"instanceFlag"},a={data:this.instanceFloats,type:"v4",attribName:"instanceFloats"},M.mesh3js.userData.cgmIds=this.instanceCgmId,M.mesh3js.userData.instanceAnchor=this.instanceAnchor,M.mesh3js.userData.instanceColor=this.instanceAnchorColor,M.mesh3js.userData.instanceFlags=this.instanceFlags,M.mesh3js.userData.instanceFloats=this.instanceFloats,M.mesh3js.userData.instanceIds=this.instanceCgmId.slice(),M.setInstancingParameters(this.nbPoi,[s,w,r,a]);for(D=0;D<g._occurrences.length;D++)M._occurrences[D].renderable.userData.cgmIds=this.instanceCgmId;M.forceBoundingSphere({radius:Math.sqrt(Math.pow(this.tileBbox.xmax-this.tileBbox.xmin,2)+Math.pow(this.tileBbox.ymax-this.tileBbox.ymin,2)+Math.pow(this.minMax.maxZ-this.minMax.minZ,2))/2,center:new e.Vector3((this.minMax.minX+this.minMax.maxX)/2,(this.minMax.minY+this.minMax.maxY)/2,(this.minMax.minZ+this.minMax.maxZ)/2)}),M.setShadow(!1,!1),f.addChild(M),"dual"===this.renderMode&&(this.matAnchorPrePass=this.matAnchorPostPass.clone(),v=this.matPrePass)}if("dual"===this.renderMode){var T=g.clone();if(T.setRenderPasses([this._poiPrePassID]),v.isInstancingMaterial=y.isInstancingMaterial,v.attributes=g.material.attributes,T.isInstanceNode3D=!0,T.mesh3js.material=v,T.setMaterial(v),T.setRendering=d,f.addChild(T),this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,v)),this.renderAnchor){var I=M.clone();I.setRenderPasses([this._poiPrePassID]),I._shapeType="anchor",this.matAnchorPrePass.isInstancingMaterial=this.matAnchorPostPass.isInstancingMaterial,this.matAnchorPrePass.attributes=M.material.attributes,I.mesh3js.material=this.matAnchorPrePass,I.setMaterial(this.matAnchorPrePass),I.setRendering=u,f.addChild(I),this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,this.matAnchorPrePass))}}}return o="_poi3D_PostPass_"+this.styleClass+"_"+this.tileInfo,f.name=o,this._rendering.updateTextureWhenReady(this._indexUpdates,f),this._indexUpdates=null,this._rendering.applyRendering(f),f},_pushInstancesData:function(t,s,r,n,a){this.instanceMatrix[this.nbPoi]=t,this.instanceColor[this.nbPoi]=new e.Vector4(s[0],s[1],s[2],s[3]),this.instanceFlags[this.nbPoi]=r,i.is(a)||(a=[r,0,0,0]),this.instanceFloats[this.nbPoi]=new e.Vector4(a[0],a[1],a[2],a[3]),i.is(n)&&(this.instanceNormalMatrix[this.nbPoi]=n)},_pushPrimitiveBillboard:function(t,s,r,n,a,o,l,h,c){if(!1===this.instancingReady){t.pushVertex([0,-1,0]),t.pushVertex([1,-1,0]),t.pushVertex([1,0,0]),t.pushVertex([0,0,0]),t.pushNormal([0,0,0]),t.pushNormal([0,0,0]),t.pushNormal([0,0,0]),t.pushNormal([0,0,0]);t.pushTexCoord(0,[0,0]),t.pushTexCoord(0,[1,0]),t.pushTexCoord(0,[1,1]),t.pushTexCoord(0,[0,1]),t.pushVertexIndices([a+0,a+1,a+2]),t.pushVertexIndices([a+0,a+2,a+3])}var d=new e.Vector3(r[0]/this.scaleCulling,r[1]/this.scaleCulling,r[2]),u=new e.Vector3(o,l,h),p=new e.Matrix4;p.identity(),p.translate(u),p.scale(d);var m=0,f=0,g=0;i.is(c.indexTexture)&&(m=c.indexTexture,f=c.top,g=c.left);var y=[c.flags,m,g,f];this._pushInstancesData(p,n,c.flags,void 0,y)},_pushPrimitiveDisc:function(t,i,s,r,n,a,o,l,h,c,d,u){if(!1===this.instancingReady){var p,m;t.pushVertex([i[0],i[1],i[2]]),t.pushNormal([0,0,1]);for(var f=0;f<this.nbVertices[0];++f)p=r[0]*Math.sin(2*f*Math.PI/this.nbVertices[0]),m=r[1]*Math.cos(2*f*Math.PI/this.nbVertices[0]),t.pushVertex([i[0]+p,i[1]+m,i[2]]),t.pushNormal([0,0,1]),f+1===this.nbVertices[0]?t.pushVertexIndices([n,n+1,n+f+1]):t.pushVertexIndices([n,n+f+2,n+f+1])}var g=new e.Vector3(a,o,l),y=new e.Vector3(h,c,d),v=new e.Matrix4;v.identity(),v.translate(g),v.scale(y),this._pushInstancesData(v,s,u)},_pushPrimitiveTube:function(t,i,s,r,n,a,o,l,h,c,d,u){var p,m,f;if(!1===this.instancingReady)if("smooth"===this.shadingMode)for(t.pushVertex([i[0],i[1],i[2]+s[2]]),t.pushNormal([0,0,1]),t.pushVertex([i[0],i[1],i[2]]),t.pushNormal([0,0,-1]),f=0;f<this.nbVertices[0];++f)m=Math.cos((2*f*Math.PI-Math.PI*this.nbVertices[0]/4)/this.nbVertices[0]),p=Math.sin((2*f*Math.PI-Math.PI*this.nbVertices[0]/4)/this.nbVertices[0]),t.pushVertex([i[0]+s[0]*p,i[1]+s[1]*m,i[2]+s[2]]),t.pushVertex([i[0]+s[0]*p,i[1]+s[1]*m,i[2]+s[2]]),t.pushVertex([i[0]+s[0]*p,i[1]+s[1]*m,i[2]]),t.pushVertex([i[0]+s[0]*p,i[1]+s[1]*m,i[2]]),t.pushNormal([0,0,1]),t.pushNormal([p,m,0]),t.pushNormal([p,m,0]),t.pushNormal([0,0,-1]),f+1===this.nbVertices[0]?(t.pushVertexIndices([n,n+2,n+4*f+2]),t.pushVertexIndices([n+1,n+4*f+5,n+5]),t.pushVertexIndices([n+4*f+3,n+4,n+4*f+4]),t.pushVertexIndices([n+4*f+3,n+3,n+4])):(t.pushVertexIndices([n,n+4*(f+1)+2,n+4*f+2]),t.pushVertexIndices([n+1,n+4*f+5,n+4*(f+1)+5]),t.pushVertexIndices([n+4*f+3,n+4*(f+1)+4,n+4*f+4]),t.pushVertexIndices([n+4*f+3,n+4*(f+1)+3,n+4*(f+1)+4]));else{t.pushVertex([i[0],i[1],i[2]+s[2]]),t.pushNormal([0,0,1]);var g,y,v=new e.Vector3,b=new e.Vector3,x=new e.Vector3,_=new e.Vector3,C=new e.Vector3,S=new e.Vector3,D=new e.Vector3;for(f=0;f<this.nbVertices[0];++f)m=Math.cos((2*f*Math.PI-Math.PI*this.nbVertices[0]/4)/this.nbVertices[0]),p=Math.sin((2*f*Math.PI-Math.PI*this.nbVertices[0]/4)/this.nbVertices[0]),g=Math.cos((2*(f+1)*Math.PI-Math.PI*this.nbVertices[0]/4)/this.nbVertices[0]),y=Math.sin((2*(f+1)*Math.PI-Math.PI*this.nbVertices[0]/4)/this.nbVertices[0]),v.set(i[0]+s[0]*p,i[1]+s[1]*m,i[2]+s[2]),b.set(i[0]+s[0]*p,i[1]+s[1]*m,i[2]),x.set(i[0]+s[0]*y,i[1]+s[1]*g,i[2]),_.set(i[0]+s[0]*y,i[1]+s[1]*g,i[2]+s[2]),t.pushVertex(v.toArray()),t.pushVertex(b.toArray()),t.pushVertex(x.toArray()),t.pushVertex(_.toArray()),C.subVectors(x,_).normalize(),S.subVectors(x,b).normalize(),D.crossVectors(S,C),t.pushNormal(D.toArray()),t.pushNormal(D.toArray()),t.pushNormal(D.toArray()),t.pushNormal(D.toArray()),t.pushVertexIndices([n+6*f+0+1,n+6*f+2+1,n+6*f+1+1]),t.pushVertexIndices([n+6*f+0+1,n+6*f+3+1,n+6*f+2+1]),t.pushVertex(_.toArray()),t.pushVertex(v.toArray()),t.pushNormal([0,0,1]),t.pushNormal([0,0,1]),t.pushTexCoord(0,[i[0],i[1]]),t.pushTexCoord(0,[i[0],i[1]]),t.pushTexCoord(1,[i[2],u]),t.pushTexCoord(1,[i[2],u]),t.pushColor(r),t.pushColor(r),t.pushVertexIndices([n+0,n+6*f+4+1,n+6*f+5+1])}var P=new e.Vector3(a,o,l),M=new e.Vector3(h,c,d),w=new e.Matrix4;w.identity(),w.translate(P),w.scale(M),this._pushInstancesData(w,r,u)},_pushPrimitiveSphere:function(t,i,s,r,n,a,o,l,h,c){var d,u;if(!1===this.instancingReady){var p=s[0],m=this.nbVertices[0],f=this.nbVertices[1],g=2*Math.PI,y=Math.PI,v=0+y,b=0,x=[],_=new e.Vector3;for(d=0;d<=f;d++){var C=[],S=d/f;for(u=0;u<=m;u++){var D=u/m,P=-p*Math.cos(0+D*g)*Math.sin(0+S*y),M=p*Math.cos(0+S*y),w=p*Math.sin(0+D*g)*Math.sin(0+S*y);_.set(P,M,w).normalize(),t.pushVertex([i[0]+P,i[1]+M,i[2]+w]),t.pushNormal([_.x,_.y,_.z]),t.pushTexCoord(0,[D,S]),C.push(b),b++}x.push(C)}for(d=0;d<f;d++)for(u=0;u<m;u++){var T=x[d][u+1],I=x[d][u],A=x[d+1][u],V=x[d+1][u+1];0!==d&&t.pushVertexIndices([n+T,n+I,n+V]),(d!==f-1||v<Math.PI)&&t.pushVertexIndices([n+I,n+A,n+V])}}var F=this.__center.set(a,o,l),N=this.__scale.set(h,h,h),O=new e.Matrix4;O.identity(),O.translate(F),O.scale(N),this._pushInstancesData(O,r,c)},_pushPrimitivePyramid:function(e,t,i,s,r,n,a,o,l,h,c,d){if(this.__center.set(n,a,o),this.__scale.set(l,h,c),this.__instanceMatrix.identity(),this.__instanceMatrix.translate(this.__center),this.__instanceMatrix.scale(this.__scale),this.__instanceNormalMatrix.getNormalMatrix(this.__instanceMatrix),this.__p0.set(0,0,0),this.__p1.set(1,-1,1),this.__p2.set(-1,-1,1),this.__p3.set(-1,1,1),this.__p4.set(1,1,1),this.__n2.set(0,1,0),this.__n1.set(1,0,0),this.__n0.set(0,-1,0),this.__n3.set(-1,0,0),this.__n4.set(0,0,1),!1===this.instancingReady){var u=this.__p0.toArray(),p=this.__p1.toArray(),m=this.__p2.toArray(),f=this.__p3.toArray(),g=this.__p4.toArray(),y=this.__n0.toArray(),v=this.__n1.toArray(),b=this.__n2.toArray(),x=this.__n3.toArray(),_=this.__n4.toArray();e.pushVertex(u),e.pushVertex(p),e.pushVertex(m),e.pushNormal(y),e.pushNormal(y),e.pushNormal(y),e.pushVertex(u),e.pushVertex(g),e.pushVertex(p),e.pushNormal(v),e.pushNormal(v),e.pushNormal(v),e.pushVertex(u),e.pushVertex(f),e.pushVertex(g),e.pushNormal(b),e.pushNormal(b),e.pushNormal(b),e.pushVertex(u),e.pushVertex(m),e.pushVertex(f),e.pushNormal(x),e.pushNormal(x),e.pushNormal(x),e.pushVertex(m),e.pushVertex(p),e.pushVertex(g),e.pushVertex(f),e.pushNormal(_),e.pushNormal(_),e.pushNormal(_),e.pushNormal(_),e.pushVertexIndices([r,r+1,r+2]),e.pushVertexIndices([r+3,r+1+3,r+2+3]),e.pushVertexIndices([r+6,r+1+6,r+2+6]),e.pushVertexIndices([r+9,r+1+9,r+2+9]),e.pushVertexIndices([r+12,r+1+12,r+2+12]),e.pushVertexIndices([r+12,r+2+12,r+3+12])}this._pushInstancesData(this.__instanceMatrix.clone(),s,d,this.__instanceNormalMatrix.clone())},_pushAnchorPrimitive:function(t,i,s,r,n,a,o,l,h,c){!1===this.instancingReady&&(t.pushVertex([i[0],i[1],i[3]-s]),t.pushVertex([i[0],i[1],i[3]-s]),t.pushVertex([i[0],i[1],i[2]+s]),t.pushVertex([i[0],i[1],i[2]+s]),t.pushNormal([1,0,0]),t.pushNormal([-1,0,0]),t.pushNormal([-1,0,0]),t.pushNormal([1,0,0]),t.pushTexCoord(0,[0,0]),t.pushTexCoord(0,[1,0]),t.pushTexCoord(0,[1,1]),t.pushTexCoord(0,[0,1]),t.pushVertexIndices([n,n+2,n+3]),t.pushVertexIndices([n,n+3,n+1]));var d=new e.Vector4(a,o,(l+h)/2,(h-l)/2),u=new e.Vector4(r[0],r[1],r[2],r[3]);this.instanceAnchor[this.nbPoi]=d,this.instanceAnchorColor[this.nbPoi]=u},_addPoi:function(t,i,s,r,n,a,o,l,h,c,d,u){var p=a+o,m=u.flags,f=u.color,g=.5*h,y=.5*c,v=isNaN(l)?0:l;"pyramid"===this.shapeType?this.pLength=16:"disc"===this.shapeType?this.pLength=this.nbVertices[0]+1:"tube"===this.shapeType?"smooth"===this.shadingMode?this.pLength=3*this.nbVertices[0]+1:this.pLength=6*this.nbVertices[0]+1:"sphere"===this.shapeType&&(this.pLength=(this.nbVertices[0]+1)*(this.nbVertices[1]+1));var b=0,x=0;"primitive"===this.geometryMode&&(b=4*this.nbPoi,x=4*this.nbPoi,b=this.nbPoi*this.pLength),!1===this.instancingReady&&(t.startPrimitive(),this.renderAnchor&&i.startPrimitive());var _=[1,1,1],C=[0,0,0,0],S={x:g,y:y,z:d},D={x:r,y:n,z:p,w:a};if(this.ownModelReady){var P=new e.Vector3(r,n,p),M=new e.Vector3(g,y,d),w=new e.Matrix4;w.identity(),w.translate(P),w.rotateZ(v),w.scale(M);var T=new e.Matrix4;T.identity(),T.multiplyMatrices(this.modelMesh3d.getMatrix(),w),this._pushInstancesData(T,f,m),D={x:r+this._posSize.center.x,y:n+this._posSize.center.y,z:p+this._posSize.center.z,w:a+this._posSize.center.z}}else"billboard"===this.shapeType?(_=[h,c,d],this._pushPrimitiveBillboard(t,C,_,f,b,r,n,p,u)):"disc"===this.shapeType?this._pushPrimitiveDisc(t,C,f,_,b,r,n,p,g,y,d,m):"tube"===this.shapeType?this._pushPrimitiveTube(t,C,_,f,b,r,n,p,g,y,d,m):"sphere"===this.shapeType?this._pushPrimitiveSphere(t,C,_,f,b,r,n,p,g,m):"pyramid"===this.shapeType&&this._pushPrimitivePyramid(t,[0,0],[0,0],f,b,r,n,p,g,y,d,m);this._computeMinMax(this.minMax,D,S),this.instanceCgmId[this.nbPoi]=s,this.initScale[this.nbPoi]=[g,y,d],this.renderAnchor&&this._pushAnchorPrimitive(i,C,1,f,x,r,n,a,p),!1===this.instancingReady&&(t.endPrimitive(s),this.instancingReady=!0,this.renderAnchor&&i.endPrimitive(s))},_computeMinMax:function(e,t,i){t.x-i.x<e.minX&&(e.minX=t.x-i.x),t.x+i.x>e.maxX&&(e.maxX=t.x+i.x),t.y-i.y<e.minY&&(e.minY=t.y-i.y),t.y+i.y>e.maxY&&(e.maxY=t.y+i.y),t.w-i.z<e.minZ&&(e.minZ=t.w-i.z),t.z+i.z>e.maxZ&&(e.maxZ=t.z+i.z)},loadBillboardMap:function(e){void 0!==this.urlTexture&&""!==this.urlTexture&&this._rendering.setCssMap(this.urlTexture,this.iconTopLeft,this.widthTexture,this.heightTexture)},initBillboardMap:function(e){var t=e.mapUrl;i.is(t)&&(this.urlTexture=t,this.iconTopLeft=null)},initBillboardCSSMap:function(){var e,t;e=document.getElementsByTagName("body")[0],(t=document.createElement("div")).setAttribute("style","position:absolute;top:0px; left:0px;"),t.innerHTML="<div class='"+this.styleClass+"'><p class='poiIcon'></p></div>",e.appendChild(t);var s=window.getComputedStyle(t.children[0].children[0]),r=s.getPropertyValue("background-image"),n=s.getPropertyValue("width"),a=s.getPropertyValue("height");e.removeChild(t),(t=document.createElement("div")).setAttribute("style","position:absolute;top:0px; left:0px;width:"+n+";height:"+a+";"),t.innerHTML="<div class='"+this.styleClass+"'><p class='poiIcon'></p></div>",e.appendChild(t);var o=(s=window.getComputedStyle(t.children[0].children[0])).getPropertyValue("top"),l=s.getPropertyValue("left");if(e.removeChild(t),"none"!==r){var h=r.search("http");(h=(r=r.slice(h,-1)).search('"'))>-1&&(r=r.slice(0,h)),this.urlTexture=r}if(i.is(f.getWebappsBaseUrl())&&""!==f.getWebappsBaseUrl())var c=f.getWebappsBaseUrl(),d=this.extractPortURL(c),u=c.replace(d,"");if(i.is(f.getProxifiedWebappsBaseUrl())&&""!==f.getProxifiedWebappsBaseUrl()){var p=f.getProxifiedWebappsBaseUrl(),m=this.extractPortURL(p);p.replace(m,"")}if(i.is(this.urlTexture))var g=this.extractPortURL(this.urlTexture),y=this.urlTexture.replace(g,"");i.is(f.getWebappsBaseUrl())&&y.contains(u)&&i.is(f.getProxifiedWebappsBaseUrl())&&""!==f.getProxifiedWebappsBaseUrl()&&(this.urlTexture=y.replace(u,f.getProxifiedWebappsBaseUrl())),this.widthTexture=parseInt(n),this.heightTexture=parseInt(a),i.is(this.iconTopLeft)||(this.iconTopLeft=[0,0]),this.iconTopLeft[0]=parseFloat(o),this.iconTopLeft[1]=parseFloat(l)},extractPortURL:function(e){var t=e.match(/:([0-9]+)/g);return null!==t?t[0]:""},addPointOfInterest:function(t,s,n){var l,h=s.strid,c=s.attributes,d=this._rendering.getFlagForPrimitive(h,c);if(void 0!==this.styleClass&&""!==this.styleClass||(this.styleClass=s.styleClass),"billboard"===this.shapeType)if("icon"!==this.renderType||this.cssProcessed){if("text"===this.renderType){var u=s.name;this.poiName[this.nbPoi]=u;var p={};if(void 0===this.textMaterial[u]){var m,f=a.getCustomShaderMaterial([a.common,a.map,g.poiOnePass2d_instancing],!1);f.side=e.FrontSide,f.transparent=!0,f.depthTest=!0,f.depthWrite=!0,f.name="textMaterial"+u;var y=function(e){f.map=e,a.updateCommonUniforms(f),f._deferredMaterialsInit=!1,"dual"===this.renderMode&&(m.map=e,a.updateCommonUniforms(m),m._deferredMaterialsInit=!1)}.bind(this),v={styleClass:this.styleClass,pClass:"poiText",samplingFactor:this.samplingFactor};o.generateTextureFromName(u,v,p,y),this.widthTexture=p.width/this.samplingFactor,this.heightTexture=p.height/this.samplingFactor,f.uniforms.scaleCulling.value=this.scaleCulling,f.uniforms.halfScreenResolution.value=this.halfScreenResolution,f.uniforms.width.value=this.widthTexture,f.uniforms.height.value=this.heightTexture,f.uniforms.top.value=p.topText,f.uniforms.left.value=p.leftText,this.textMaterial[u]={prePass:void 0,postPass:f},"dual"===this.renderMode&&(m=f.clone(),this.textMaterial[u].prePass=f),s.localScale[0]*=this.widthTexture,s.localScale[1]*=this.heightTexture}}}else this.cssProcessed=!0,this.initBillboardCSSMap(),i.is(s.mapUrl)&&this.initBillboardMap(s),this.loadBillboardMap();var b={x:s.localScale[0]*this.widthTexture,y:s.localScale[1]*this.heightTexture,z:s.localScale[2]},x={x:t.x,y:t.y,z:s.height,w:s.altitude},_=this._rendering.getCompleteMaterialInfo(h,c);this._computeMinMax(this.minMaxOrig,x,b);var C=[s.localScale[0]*this.scaleCulling,s.localScale[1]*this.scaleCulling,s.localScale[2]*this.scaleCulling];l=[_.color.r,_.color.g,_.color.b,_.opacity],_.opacity<1&&(this.transparentPrimitive=!0),void 0===this.creator&&(this.creator=new r({indexed:!0,normalBinding:r.Binding.VERTEX,useTexCoord:!0,nbTexCoord:1,texCoordBinding:r.Binding.VERTEX,useColor:!1}),this.renderAnchor&&(this.creatorAnchor=new r({indexed:!0,normalBinding:r.Binding.VERTEX,useTexCoord:!0,nbTexCoord:1,texCoordBinding:r.Binding.VERTEX,useColor:!1})));var S={flags:d,color:l};"billboard"===this.shapeType&&(this._rendering.setTextureInfo(S,h,c,this)&&(i.is(this._indexUpdates)||(this._indexUpdates={}),this._indexUpdates[h]=c));if(this._addPoi(this.creator,this.creatorAnchor,s.strid,t.x,t.y,s.altitude,s.height,Number(s.orientation[0]),C[0],C[1],C[2],S),"mesh"===this.geometryMode){var D=this.creator.compilePrimitive("poi3D_primitive_"+this._poi,!0);if(this.primitiveNodes[this.nbPoi]=D,this.nbMesh++,this.renderAnchor){var P=this.creatorAnchor.compilePrimitive("poi3D_primitiveAnchor_"+this._poi,!0);this.primitiveAnchorNodes[this.nbPoi]=P}}return this.nbPoi++,b={x:s.localScale[0]*this.widthTexture,y:s.localScale[1]*this.heightTexture,z:s.localScale[2]}},setAttribute:function(){return!1},updateAttribute:function(){return!1},getMaterials:function(){var e=[];return i.is(this.matPrePass)&&e.push(this.matPrePass),i.is(this.matPostPass)&&e.push(this.matPostPass),i.is(this.matAnchorPostPass)&&e.push(this.matAnchorPostPass),e},getIndexForTextureUrl:function(e){return this._rendering.getIndexForTextureUrl(e)}});return g.poiOnePass2d_instancing={attributes:{},uniforms:{normalDepthTexture:{type:"t",value:null},width:{type:"f",value:1},height:{type:"f",value:1},top:{type:"f",value:0},left:{type:"f",value:0},switchDistance:{type:"f",value:0},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)},scaleCulling:{type:"f",value:1},diffuse:{type:"c",value:new e.Color(16777215)}},vertex_pars:["uniform vec2 halfScreenResolution;","uniform float switchDistance;","//varying float isOpaque;","uniform sampler2D normalDepthTexture;","uniform float width;","uniform float height;","uniform float top;","uniform float left;","varying vec2 posCenter;","varying vec4 colorW;","uniform float scaleCulling;","varying vec2 newUvs;","","// Compute offset to rescale the POI in screen space (fixed size)","float computeScaleOffset(float depthCenterCameraSpace) {","   float scaleOffset = 1.0;","   if (depthCenterCameraSpace > -switchDistance)","   {","      scaleOffset = -switchDistance / depthCenterCameraSpace;","   }","   return scaleOffset;","}",""].join("\n"),vertex:["//-------------- POI Billboard rendering - only post-pass --------------//","//---------------------------------------------------------------------//","//-------------------- 1. COMPUTE VERTEX POSITION ----------------------//","//---------------------------------------------------------------------//","colorW = color;","#ifdef IS_MULTI_INSTANCED","vec3 origin = vec3(0.0,0.0,0.0);","#else","vec3 origin = normal.xyz; // normal attribute contains the position of the billboard origin (top-left corner), in tile space","#endif","vec4 posOriginCameraSpace = viewMatrix * modelMatrix * vec4(origin.xyz, 1.0);","posOriginCameraSpace /= posOriginCameraSpace.w;","float scaleOffset = computeScaleOffset(posOriginCameraSpace.z); // / scaleCulling;","float topOffsetInPixels = top;","float leftOffsetInPixels = left;","float w = width;","float h = height;","#ifdef IS_MULTI_INSTANCED","vec2 offsetTileSpace = position.xy;","w *= instanceMatrix[0][0];","h *= instanceMatrix[1][1];","#else","vec2 offsetTileSpace = position.xy - origin.xy; // position is in tile space","offsetTileSpace.xy /= vec2(w*scaleCulling,h*scaleCulling);","offsetTileSpace.xy += vec2(0.5,-0.5);","#endif","offsetTileSpace.x += leftOffsetInPixels/width;","offsetTileSpace.y -= topOffsetInPixels/height;","vec2 offsetScreenSpace = scaleOffset*offsetTileSpace.xy*vec2(w,h)/halfScreenResolution;","vec4 posOriginScreenSpace = projectionMatrix * posOriginCameraSpace;","posOriginScreenSpace /= posOriginScreenSpace.w;","gl_Position = posOriginScreenSpace + vec4(offsetScreenSpace, 0.0, 0.0);"].join("\n"),fragment_pars:[].join("\n"),fragment:[].join("\n")},g.atlasing_PDSFX={name:"atlasing_PDSFX",attributes:{},uniforms:{atlasOffsetTexture:{type:"t2",value:a.whiteMap}},varyings:{texCoordCity:{type:"v2"}},VS_overridableFunctions:{ComputeVaryingValues:["float index = instanceFloats.y;","vec4 offset = texture2D(atlasOffsetTexture, vec2(0.5, (index+0.5)/800.0));","texCoordCity = vGetAttribTexCoord0().xy * vec2(offset.w, offset.z) + vec2(offset.x, offset.y);"].join("\n")},FS_overridableFunctions:{}},g.mapping_PDSFX={name:"mapping_PDSFX",depends:[],attributes:{},uniforms:{useMapCity:{type:"b",value:!1},mapCityLoaded:{type:"b",value:!0},mapCity:{type:"t2",value:a.whiteMap},alphaTestCity:{type:"f",value:.5}},varyings:{texCoordCity:{type:"v2"}},VS_overridableFunctions:{ComputeVaryingValues:["texCoordCity = vGetAttribTexCoord0().xy;"].join("\n")},FS_global_code:["vec4 _texelCity = vec4(1.0);","float _alphaCity = 1.0;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["if (useMapCity && mapCityLoaded) {","_texelCity = texture2D(mapCity, texCoordCity.xy);","","_alphaCity = _texelCity.w;","#ifdef GAMMA_INPUT","_alphaCity *= _texelCity.w;","#endif","","}"].join("\n"),_ComputeDiffuseTexel:["return vec4(_texelCity.xyz, 1.0);"].join("\n"),ComputeOpacity:["cOpacity *= _alphaCity;"].join("\n"),ComputeDiscard:["if ((_alphaCity < alphaTestCity) || (useMapCity && !mapCityLoaded)) {","return true;","}",""].join("\n")}},g.coloring_PDSFX={name:"coloring_PDSFX",depends:[],attributes:{},uniforms:{diffuseCity:{type:"c",value:new e.Color(16711680)},opacityCity:{type:"f",value:1}},varyings:{colorW:{type:"v4"},l_useColor:{type:"f"},l_useOpacity:{type:"f"},l_invisibility:{type:"f",value:0}},VS_global_code:["float getFlag(float flags, float row){","    float res = mod(flags, row*2.0); ","    if(res >= row){","       return 1.0;","   }","   return 0.0; ","}"].join("\n"),VS_overridableFunctions:{ComputeVaryingValues:["//colorW = vec4(vGetAttribColor(),1.0);","//float flags = vGetAttribTexCoord1().y;","colorW = instanceColor;","float flags = instanceFlag;","l_useColor = getFlag(flags, 1.0);","l_useOpacity = getFlag(flags, 2.0);","l_invisibility = getFlag(flags, 8.0);"].join("\n")},FS_global_code:["vec3 cityDiffuse;","float cityOpacity;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["cityDiffuse = diffuseCity;","cityOpacity = opacityCity;","if(l_useColor > 0.5 ) {","cityDiffuse = colorW.rgb;","}","if( l_useOpacity > 0.5 ) {","cityOpacity = colorW.a;","}"].join("\n"),ComputeAlbedo:["cAlbedo *= cityDiffuse.xyz;"].join("\n"),ComputeOpacity:["cOpacity *= cityOpacity;"].join("\n"),ComputeDiscard:["if (l_invisibility > 0.5) {","return true;","}",""].join("\n")}},g.poiOnePass2d_instancing_PDSFX={name:"poiOnePass2d_instancing_PDSFX",depends:[],attributes:{},uniforms:{width:{type:"f",value:50},height:{type:"f",value:60},top:{type:"f",value:0},left:{type:"f",value:0},switchDistance:{type:"f",value:0},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)}},varyings:{},VS_global_code:["// Compute offset to rescale the POI in screen space (fixed size)","float computeScaleOffset(float depthCenterCameraSpace) {","   float scaleOffset = 1.0;","   if (depthCenterCameraSpace > -switchDistance)","   {","      scaleOffset = -switchDistance / depthCenterCameraSpace;","   }","   return scaleOffset;","}"].join("\n"),VS_overridableFunctions:{ProcessClipSpacePosition:["","vec3 origin = vec3(0.0,0.0,0.0);","vec4 posOriginCameraSpace = vGetWorldViewMatrix() * instanceMatrix * vec4(origin.xyz, 1.0);","posOriginCameraSpace /= posOriginCameraSpace.w;","float scaleOffset = computeScaleOffset(posOriginCameraSpace.z); // / scaleCulling;","float topOffsetInPixels = instanceFloats.w;","float leftOffsetInPixels = instanceFloats.z;","float index = instanceFloats.y;","vec4 offset = texture2D(atlasOffsetTexture, vec2(0.5, (index+0.5)/800.0));","float w = width*offset.w;","float h = height*offset.z;","vec2 offsetTileSpace = vGetAttribPosition().xy;","offsetTileSpace.x += leftOffsetInPixels/w;","offsetTileSpace.y -= topOffsetInPixels/h;","w *= instanceMatrix[0][0];","h *= instanceMatrix[1][1];","vec2 offsetScreenSpace = scaleOffset*offsetTileSpace.xy*vec2(w,h)/halfScreenResolution;","vec4 posOriginScreenSpace = vGetProjectionMatrix() * posOriginCameraSpace;","posOriginScreenSpace /= posOriginScreenSpace.w;","ioPosition = posOriginScreenSpace + vec4(offsetScreenSpace, 0.0, 0.0);"].join("\n")},FS_overridableFunctions:{ComputeAlbedo:["return cAlbedo;"].join("\n"),ComputeOpacity:["return cOpacity;"].join("\n"),ComputeDiscard:["return false;"].join("\n")}},g.poiOnePass3d_instancing_PDSFX={attributes:{},uniforms:{switchDistance:{type:"f",value:0},scaleCulling:{type:"f",value:1},diffuseCity:{type:"c",value:new e.Color(16711680)},ambientCity:{type:"c",value:new e.Color(16711680)},opacityCity:{type:"f",value:1},alphaTestCity:{type:"f",value:.5}},varyings:{colorW:{type:"v4"},l_useColor:{type:"f"},l_useOpacity:{type:"f"},l_invisibility:{type:"f",value:0}},VS_global_code:["// Compute offset to rescale the POI in screen space (fixed size)","float computeScaleOffset(float depthCenterCameraSpace) {","float scaleOffset = -depthCenterCameraSpace/switchDistance;","if (depthCenterCameraSpace > -switchDistance) {","scaleOffset = 1.0;","}","if (switchDistance < 0.001) {","scaleOffset = -depthCenterCameraSpace/1000.0;","}","return scaleOffset;","}","float getFlag(float flags, float row){","    float res = mod(flags, row*2.0); ","    if(res >= row){","       return 1.0;","   }","   return 0.0; ","}"].join("\n"),VS_overridableFunctions:{ComputeVaryingValues:["colorW = instanceColor;","float flags = instanceFlag;","l_useColor = getFlag(flags, 1.0);","l_useOpacity = getFlag(flags, 2.0);","l_invisibility = getFlag(flags, 8.0);"].join("\n"),ProcessClipSpacePosition:["vec3 center = vec3(0.0,0.0,0.0);","vec4 posCenterCameraSpace = vGetWorldViewMatrix() * instanceMatrix * vec4(center, 1.0);","posCenterCameraSpace /= posCenterCameraSpace.w;","vec4 posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;","posCenterScreenSpace /= posCenterScreenSpace.w;","vec4 posVertexCameraSpace = vGetWorldViewMatrix() * instanceMatrix * vec4(vGetAttribPosition().xyz, 1.0);","posVertexCameraSpace /= posVertexCameraSpace.w;","vec4 vectorCameraSpace = posVertexCameraSpace - posCenterCameraSpace;","vec4 screenPos = posCenterCameraSpace + vec4(vectorCameraSpace.xyz*(computeScaleOffset(posCenterCameraSpace.z)/scaleCulling), 0.0);","ioPosition = vGetProjectionMatrix() * screenPos;"].join("\n"),ProcessViewTangentSpace:["ioWorldViewTS.Normal = normalize(vGetWorldViewMatrix() * instanceMatrix * vec4(vGetAttribNormal().xyz,0.0)).xyz;"].join("\n")},FS_global_code:["vec3 cityDiffuse;","float cityOpacity;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["cityDiffuse = diffuseCity;","cityOpacity = opacityCity;","if(l_useColor > 0.5 ) {","cityDiffuse = colorW.rgb;","}","if( l_useOpacity > 0.5 ) {","cityOpacity = colorW.a;","}"].join("\n"),ComputeAlbedo:["cAlbedo *= cityDiffuse;"].join("\n"),ComputeOpacity:["cOpacity *= cityOpacity;"].join("\n"),ComputeDiscard:["if (l_invisibility > 0.5) {","return true;","}","return false;"].join("\n")}},g.poiOnePass3dAnchorTriangle_instancing_PDSFX={attributes:{},uniforms:{switchDistance:{type:"f",value:0},scaleCulling:{type:"f",value:1},diffuseCity:{type:"c",value:new e.Color(16711680)},opacityCity:{type:"f",value:1},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)},halfWidth:{type:"f",value:.5}},varyings:{colorW:{type:"v4"},l_useColor:{type:"f"},l_useOpacity:{type:"f"},l_invisibility:{type:"f",value:0}},VS_global_code:["float getFlag(float flags, float row){","    float res = mod(flags, row*2.0); ","    if(res >= row){","       return 1.0;","   }","   return 0.0; ","}"].join("\n"),VS_overridableFunctions:{ComputeVaryingValues:["colorW = instanceColor;","float flags = instanceFlag;","l_useColor = getFlag(flags, 1.0);","l_useOpacity = getFlag(flags, 2.0);","l_invisibility = getFlag(flags, 8.0);"].join("\n"),ProcessClipSpacePosition:["vec3 center = instanceAnchor.xyz;","vec4 posCenterCameraSpace = vGetWorldViewMatrix() * vec4(center.xyz, 1.0);","posCenterCameraSpace /= posCenterCameraSpace.w;","float scaleOffset = 1.0;","float offsetScreenSpace = vGetAttribNormal().x *scaleOffset*halfWidth/halfScreenResolution.x;","float halfHeight = instanceAnchor.w;","vec4 positionCamSpace = vGetWorldViewMatrix() * vec4(center.xyz + vec3(0.0,0.0,halfHeight*vGetAttribPosition().z), 1.0);","vec4 posOriginScreenSpace = vGetProjectionMatrix() * positionCamSpace;","// we need to divide by the abs of .w to avoid weird values when closed top views","posOriginScreenSpace = posOriginScreenSpace/abs(posOriginScreenSpace.w);","vec4 positionCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;","positionCenterScreenSpace = positionCenterScreenSpace/abs(positionCenterScreenSpace.w);","vec2 vecExtr = (normalize( posOriginScreenSpace.xy - positionCenterScreenSpace.xy));","vec2 crossExtr = vec2(-vecExtr.y, vecExtr.x);","ioPosition = posOriginScreenSpace;","ioPosition.xy += crossExtr.xy*offsetScreenSpace;"].join("\n"),ProcessViewTangentSpace:["ioWorldViewTS.Normal = vec3(0.0, 0.0, 1.0);"].join("\n")},FS_global_code:["vec3 cityDiffuse;","float cityOpacity;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["cityDiffuse = diffuseCity;","cityOpacity = opacityCity;","if(l_useColor > 0.5 ) {","cityDiffuse = colorW.rgb;","}","if( l_useOpacity > 0.5 ) {","cityOpacity = colorW.a;","}"].join("\n"),ComputeAlbedo:["cAlbedo *= cityDiffuse.xyz;"].join("\n"),ComputeOpacity:["cOpacity *= cityOpacity;"].join("\n"),ComputeDiscard:["if (l_invisibility > 0.5) {","return true;","}","return false;"].join("\n")}},g.poiText_PDSFX={attributes:{},uniforms:{mapCity:{type:"t2",value:null},alphaTestCity:{type:"f",value:.5},top:{type:"f",value:0},left:{type:"f",value:0},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)}},varyings:{texCoordCity:{type:"v2"}},VS_overridableFunctions:{ComputeVaryingValues:["texCoordCity = vGetAttribTexCoord0().xy;"].join("\n"),ProcessClipSpacePosition:["vec3 positionLocal = vGetAttribPosition() + vec3(left, -top, 0.0);// - color.xyz; // position is in tile space while color contains center in tile space","vec4 posCenterCameraSpace = vGetWorldViewMatrix() * vec4(0.0, 0.0, 0.0, 1.0);","vec4 posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;","posCenterScreenSpace /= posCenterScreenSpace.w;","vec2 offsetScreenSpace = positionLocal.xy/halfScreenResolution;","ioPosition = posCenterScreenSpace + vec4(offsetScreenSpace, 0.0, 0.0);"].join("\n")},FS_global_code:["vec4 _texelCity = vec4(1.0);","float _alphaCity = 1.0;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["_texelCity = texture2D(mapCity, texCoordCity.xy);","_alphaCity = _texelCity.w;","#ifdef GAMMA_INPUT","_alphaCity *= _texelCity.w;","#endif",""].join("\n"),_ComputeDiffuseTexel:["return vec4(_texelCity.xyz, 1.0);"].join("\n"),ComputeAlbedo:["return vec3(1.0,1.0,1.0);"].join("\n"),ComputeOpacity:["return _alphaCity;"].join("\n"),ComputeDiscard:["if (_alphaCity < alphaTestCity) { ","return true;","}","return false;"].join("\n")}},g.poiTextOpti_PDSFX={attributes:{},uniforms:{top:{type:"f",value:0},left:{type:"f",value:0},width:{type:"f",value:1},height:{type:"f",value:1},samplingFactor:{type:"f",value:1},halfScreenResolution:{type:"v2",value:new e.Vector2(1920,955)},pattern:{type:"fv1",length:7,value:[1,1,1,1,1,1,1]},pixelSize:{type:"v2",value:new e.Vector2(.005,.005)},mapCity:{type:"t2",value:null},alphaTestCity:{type:"f",value:.5}},varyings:{texCoordCity:{type:"v2"}},VS_overridableFunctions:{ComputeVaryingValues:["texCoordCity = vGetAttribTexCoord0().xy;"].join("\n"),ProcessClipSpacePosition:["ioPosition = vGetProjectionMatrix() * vGetWorldViewMatrix() * vec4(0.0, 0.0, 0.0, 1.0);","ioPosition.x += ioPosition.w * (pixelSize.x*(vGetAttribTexCoord0().x * width + left));","ioPosition.y += ioPosition.w * (pixelSize.y*(vGetAttribTexCoord0().y * height - top));"].join("\n")},FS_global_code:["vec4 _texelCity = vec4(1.0);","float _alphaCity = 1.0;","#define NB_DIGIT_INT 1","#define NB_DIGIT_FLOAT 1.0","const float nbDigit = NB_DIGIT_FLOAT;","vec4 texelPattern;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["// texelCity = texture2D(mapCity, texCoordCity.xy);","vec2 uvDigit = texCoordCity.xy;","float newU = mod(uvDigit.x*nbDigit,1.0);","float indexLetter = floor(uvDigit.x*nbDigit);","vec3 indexColor = vec3(0.0,0.0,0.0);","newU *= 0.1;","if (indexLetter < 1.0) {","newU += pattern[0]*0.1;","indexColor = vec3(1.0,0.0,0.0);","}","#if NB_DIGIT_INT > 1","else if (indexLetter < 2.0) {","newU += pattern[1]*0.1;","indexColor = vec3(1.0,1.0,0.0);","}","#endif","#if NB_DIGIT_INT > 2","else if (indexLetter < 3.0) {","newU += pattern[2]*0.1;","indexColor = vec3(1.0,0.0,1.0);","}","#endif","#if NB_DIGIT_INT > 3","else if (indexLetter < 4.0) {","newU += pattern[3]*0.1;","indexColor = vec3(0.0,1.0,0.0);","}","#endif","#if NB_DIGIT_INT > 4","else if (indexLetter < 5.0) {","newU += pattern[4]*0.1;","indexColor = vec3(0.0,1.0,1.0);","}","#endif","#if NB_DIGIT_INT > 5","else if (indexLetter < 6.0) {","newU += pattern[5]*0.1;","indexColor = vec3(0.0,0.0,1.0);","}","#endif","#if NB_DIGIT_INT > 6","else if (indexLetter < 7.0) {","newU += pattern[6]*0.1;","indexColor = vec3(0.5,0.5,0.5);","}","#endif","_texelCity = texture2D(mapCity, vec2(newU, uvDigit.y));","_alphaCity = _texelCity.w;","#ifdef GAMMA_INPUT","_alphaCity *= _texelCity.w;","#endif",""].join("\n"),_ComputeDiffuseTexel:["return vec4(_texelCity.xyz, 1.0);"].join("\n"),ComputeAlbedo:["return vec3(1.0);",""].join("\n"),ComputeOpacity:["return _alphaCity;"].join("\n"),ComputeDiscard:["if (_alphaCity < alphaTestCity) { ","return true;","}","return false;"].join("\n")}},g.generateTextNode=function(e,t,i){var r=a.getPDSFXMaterial([g.poiText_PDSFX],"basic"),h=e._frmViewerContainer.getDimensions(),c={x:h.width/2,y:h.height/2};r.updatePDSFXUniform("halfScreenResolution",c),r.depthTest=!1,r.transparent=!0;r.name="generateTextNodeMaterial",e._frmViewerContainer.addEvent("resize",function(e,t){var i=e._frmViewerContainer.getDimensions(),s={x:i.width/2,y:i.height/2};t.updatePDSFXUniform("halfScreenResolution",s)}.bind(this,e,r));var d={};o.generateTextureFromName(t,i,d,function(e){r.map=e,a.updateCommonUniforms(r),r._deferredMaterialsInit=!1,r.updateDeferredMaterials()});var u=d.width/i.samplingFactor,p=d.height/i.samplingFactor;r.updatePDSFXUniform("top",d.topText),r.updatePDSFXUniform("left",d.leftText);var m=n.createRectangleNode({width:u,height:p,color:new s.Color(1,.5,.5,0),fill:!0,material:r});m.setPickable(s.NOPICKABLE),m.name="text";if(void 0===e.getView3D().getRenderPassManager().getPass("OverlayPostPass")){var f=new l(null,null,void 0,!0,!1,!1,"OverlayPostPass");f.idString="OverlayPostPass";var y="PoiTransparentOverlayPass";void 0===e.getView3D().getRenderPassManager().getPass(y)&&(y="ClearDepthPass"),e.getView3D().getRenderPassManager().addPass("OverlayPostPass",f,{after:y})}return m.setRenderPasses(["OverlayPostPass"]),m},g.createRectangle=function(e){var t,i,r,a,o,l,h,c,d,u,p,m,f,g,y;for(10,(t=new s.PrimitiveGroup).fillAttr=new s.FillAttributes,t.lineAttr=new s.LineAttributes,t.pointAttr=new s.PointAttributes,(i=new s.Buffer).size=12,i.component=s.VertexComponentEnum.POSITION,i.format=s.DataTypeEnum.FLOAT,i.dimension=3,i.data=new Float32Array(i.size),(r=new s.Buffer).size=3,r.component=s.VertexComponentEnum.NORMAL,r.format=s.DataTypeEnum.FLOAT,r.dimension=3,r.data=new Float32Array(r.size),(a=new s.Buffer).size=12,a.component=s.VertexComponentEnum.TEX_COORD_0,a.format=s.DataTypeEnum.FLOAT,a.dimension=3,a.data=new Float32Array(a.size),(o=new s.Buffer).indexBuffer=!0,o.size=4,o.format=s.DataTypeEnum.UINT,o.dimension=1,o.data=new Uint16Array(o.size),(l=new s.Buffer).indexBuffer=!0,l.size=4,l.format=s.DataTypeEnum.UINT,l.dimension=1,l.data=new Uint16Array(l.size),(h=new s.Buffer).indexBuffer=!0,h.size=4,h.format=s.DataTypeEnum.UINT,h.dimension=1,h.data=new Uint16Array(h.size),t.addBuffer(0,i),t.addBuffer(1,r),t.addBuffer(2,o),t.addBuffer(3,l),t.addBuffer(4,a),t.addBuffer(5,h),f=0,(y=o.data)[f++]=0,y[f++]=1,y[f++]=3,y[f++]=2,y=l.data,f=0,g=0;g<1;g++)y[f++]=g,y[f++]=g,y[f++]=g,y[f++]=g;for(f=0,(y=h.data)[f++]=0,y[f++]=1,y[f++]=3,y[f++]=2,y=i.data,f=0,f=0;f<12;f++)y[f]=0;for(f=0,(y=r.data)[f++]=0,y[f++]=0,y[f++]=1,f=0,(y=a.data)[f++]=0,y[f++]=0,y[f++]=0,y[f++]=1,y[f++]=0,y[f++]=0,y[f++]=1,y[f++]=1,y[f++]=0,y[f++]=0,y[f++]=1,y[f++]=0,g=0;g<1;g++)(c=new s.Primitive).nbIndices=4,c.connectivity=s.ConnectivityTypeEnum.TRIANGLE_STRIP,c.attr={fill:new s.FillAttributes(new s.Color(1-g/6,0,g/6,1),1),line:new s.LineAttributes,point:new s.PointAttributes},(d=new s.VertexComponent).component=s.VertexComponentEnum.POSITION,d.nbVertices=4,d.nbValuesPerVertex=3,d.format=s.DataTypeEnum.FLOAT,d.cardinality=0,d.bufferId=0,d.indices=new s.IndexArray,d.indices.format=s.DataTypeEnum.UINT,d.indices.bufferId=2,d.indices.offset=4*g,(u=new s.VertexComponent).component=s.VertexComponentEnum.NORMAL,u.nbVertices=4,u.nbValuesPerVertex=3,u.format=s.DataTypeEnum.FLOAT,u.cardinality=0,u.bufferId=1,u.indices=new s.IndexArray,u.indices.format=s.DataTypeEnum.UINT,u.indices.bufferId=3,u.indices.offset=4*g,(p=new s.VertexComponent).component=s.VertexComponentEnum.TEX_COORD_0,p.nbVertices=4,p.nbValuesPerVertex=3,p.format=s.DataTypeEnum.FLOAT,p.cardinality=0,p.bufferId=4,p.indices=new s.IndexArray,p.indices.format=s.DataTypeEnum.UINT,p.indices.bufferId=5,p.indices.offset=0,c.addVertexComponent(d),c.addVertexComponent(u),c.addVertexComponent(p),t.addPrimitive(c);return(m=n.createMeshNode(t,e)).setShadow(!1),m},g.generateTextNodeOpti=function(t,i,r){var n=i.toString().length.toString();if(void 0===g._poolTextNodeOpti[n]){var o=g.poiTextOpti_PDSFX;o.FS_global_code=o.FS_global_code.replace(/NB_DIGIT_INT \d/g,"NB_DIGIT_INT "+n),o.FS_global_code=o.FS_global_code.replace(/NB_DIGIT_FLOAT \d/g,"NB_DIGIT_FLOAT "+n),(d=a.getPDSFXMaterial([o],"basic")).name="generateTextNodeOpti";var h=t._frmViewerContainer.getChildren()[0].getDimensions(),c={x:h.width,y:h.height};d.updatePDSFXUniform("halfScreenResolution",c),d.depthTest=!1,d.transparent=!0;t._frmViewerContainer.getChildren()[0].addEvent("resize",function(e,t){var i=e._frmViewerContainer.getChildren()[0].getDimensions(),s={x:i.width,y:i.height};t.updatePDSFXUniform("halfScreenResolution",s)}.bind(this,t,d)),d.map=g.textTexture.clusterDigits.map,g._poolTextNodeOpti[n]=new u(d.clone.bind(d)),g._poolTextNodeOpti[n].name="textMaterialPool_"+n}for(var d=g._poolTextNodeOpti[n].use(),p=i,m=0,f=i.toString().length,y=[],v=0;v<f;++v)y.push(Math.floor((p-m)/Math.pow(10,f-1-v))),m+=y[v]*Math.pow(10,f-1-v);d.updatePDSFXUniform("pattern",y);var b=g.textTexture.clusterDigits.params.width,x=g.textTexture.clusterDigits.params.height;d.updatePDSFXUniform("width",Math.floor(b/10)*f),d.updatePDSFXUniform("height",x),d.updatePDSFXUniform("top",g.textTexture.clusterDigits.params.topText),d.updatePDSFXUniform("left",g.textTexture.clusterDigits.params.leftText*f/10),d.updatePDSFXUniform("samplingFactor",g.textTexture.clusterDigits.params.samplingFactor);var _=g.createRectangle(d);_.setPickable(s.NOPICKABLE),_.name="text",d.refreshUniforms=function(t,i){var s;if(!t._smallTargetPicking||t.materialToUse!==e.MaterialToUse.pickingMaterial&&t.materialToUse!==e.MaterialToUse.pickingMaterialInstancing&&t.materialToUse!==e.MaterialToUse.normalMaterial&&t.materialToUse!==e.MaterialToUse.depthMaterial)s=new e.Vector2(2/t.domElement.width,2/t.domElement.height);else{var r=2*t._gpuPickingTolerance+1;s=new e.Vector2(2/r,2/r)}this.updatePDSFXUniform("pixelSize",s)},a.updateCommonUniforms(d,!1);if(void 0===t.getView3D().getRenderPassManager().getPass("OverlayPostPass")){var C=new l(null,null,void 0,!0,!1,!1,"OverlayPostPass");C.idString="OverlayPostPass";var S="PoiTransparentOverlayPass";void 0===t.getView3D().getRenderPassManager().getPass(S)&&(S="ClearDepthPass"),t.getView3D().getRenderPassManager().addPass("OverlayPostPass",C,{after:S})}return _.setRenderPasses(["OverlayPostPass"]),_},g.generateTextTexture=function(e,t){var i={};o.generateTextureFromName(e,t,i,function(t){g.textTexture[e]={map:t,params:i}})},g.textTexture=[],g.scaleCulling=100,g._poolTextNodeOpti={},g}),define("DS/XCityGeometry/PatchVectorFactoryParticle",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/Visualization/ParticlesNode3D","DS/XCityLayer/Vector","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader"],function(e,t,i,s,r,n,a,o,l){"use strict";return UWA.Class.extend({init:function(e,s){this._parent(e,s),this.urban=e,this._node=new i,this._node.name="FactoryParticle",this.altitudeAttribute=void 0!==s.altitudeAttribute?s.altitudeAttribute:"ALTITUDE",this.scaleAttribute=void 0!==s.scaleAttribute?s.scaleAttribute:"SCALE",this.orientationAttribute=void 0!==s.orientationAttribute?s.orientationAttribute:"ORIENT",this.textureIndexAttribute=void 0!==s.textureIndexAttribute?s.textureIndexAttribute:"INDEX",this.typeAttribute=void 0!==s.typeAttribute?s.typeAttribute:"TYPE",this.stridAttribute=void 0!==s.stridAttribute?s.stridAttribute:"STRID",this.pustuleSize=60,this.textSize=100,this.color=s.color||"#ffffff",this.color=s.color||"#ffffff",this.pustule=void 0,this.materialPustule=void 0,l.loadTexture(function(e){this.pustule=e,this.materialPustule=new t.ParticleBasicMaterial({size:this.pustuleSize,sizeAttenuation:!1,map:this.pustule,transparent:!0,depthTest:!1,color:this.color,shading:t.SmoothShading})}.bind(this),"../XCityEnvironment/assets/textures/poi/pustule2.png"),o.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},destroy:function(){this.urban.USR.getScene().remove(this._node)},dispose:function(){a.warn("Dispose: UrbanSiroccoFactoryPOI"),void 0!==this.pustule&&(this.pustule.dispatchEvent({type:"dispose"}),this.pustule=void 0),void 0!==this.materialPustule&&(this.materialPustule.dispose(),this.materialPustule=void 0)},getData:function(e){var i=new r(new t.ParticleSystem(geom.geom,this.materialPustule),"poi");return i.setMatrix((new t.Matrix4).identity().setPosition(new t.Vector3(e.posTile.x,e.posTile.y,0))),i},initMesh:function(e,t,i,s,r){},_getOrCreateGeometry:function(e,i,s){if(!(s in i)){var r={};r.geom=new t.Geometry,i[s]=r}return i[s]},buildOne:function(e,i,s){if(e.getGeometry().type===n.Type.POINT){var r=e.getGeometry().getVertices(),a=void 0;void 0===i.geometry?(i.geometry=this._getOrCreateGeometry(e,ltileGeoms,"Placemark"),a=new t.Vector2(Math.round(r[0]),Math.round(r[1])),i.posTile=a):a=i.posTile,i.geometry.geom.vertices.push(new t.Vector3(r[0]-a.x,r[1]-a.y,100))}},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1}})}),define("DS/XCityGeometry/Polygon",["DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Plugins/RenderPass","DS/Plugins/ClearPass","DS/Visualization/SceneGraphFactory","DS/XCityRendering/RenderingHandlerSpecific","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools"],function(THREE,CATXMLV6,Node3D,RenderPass,ClearPass,SceneGraphFactory,RenderingHandlerSpecific,Utils,ShaderTools,RenderingTools){"use strict";var Polygon=Node3D.extend({init:function(e,t){this.urban=e,void 0!==t.shape&&(this.shape=t.shape,this.holes=t.holes,this.shape[0].x===this.shape[this.shape.length-1].x&&this.shape[0].y===this.shape[this.shape.length-1].y||this.shape.push(this.shape[0]),this.attributes=t.attributes,this._parent(),this.primId=t.primId,this._rendering=t.rendering,Utils.is(this._rendering)||(console.error(" UrbanPolygon instanciated with wrong handler"),this._rendering=new RenderingHandlerSpecific(e,t)),this.matOne=void 0,this.matTwo=void 0,this.oldCamPos={x:0,y:0,z:0},this._applyMaterial(),this._createShape(this.shape),this.forceUpdateDistance=!0,this.dynamicUpdate?(this._updateOnDistance(this.urban),this.isInUpdateSlots=!0):(this.isInUpdateSlots=!1,this._updateOnDistance(this.urban)))},_defineRenderPass:function(){this._polygonOccludedPassID="main",this._polygonOverlayPassID="noz"},_defineStencilPass:function(){var e=this.color.getStyle();if(this._clearStencilPassID="clear_stencil_polygon_"+e,void 0===this.urban.getView3D().getRenderPassManager().getPass(this._clearStencilPassID)){var t=new ClearPass(this._clearStencilPassID);t.defaults.clear=!1,t.defaults.doClearDepth=!1,t.clear=!1,t.clearDepth=!1,t.clearStencil=!0,t.idString=this._clearStencilPassID,this.urban.getView3D().getRenderPassManager().addPass(this._clearStencilPassID,t,{post:!0})}if(this._polygonStencilPassID="stencil_polygon_"+e,void 0===this.urban.getView3D().getRenderPassManager().getPass(this._polygonStencilPassID)){var i=new RenderPass(null,null,void 0,!0,!1,!1,this._polygonStencilPassID);i.idString=this._polygonStencilPassID,i.setEnableStencilTest(!0),i.setDisableColorWrite(!0),i.setDisableDepthWrite(!0),i.setEnableStencilWrite(!0),i.setStencilFunc("ALWAYS"),i.setStencilOpsSeparate("INCR_WRAP","DECR_WRAP","KEEP","KEEP"),i.setDisableBackFaceCulling(!0),i.ignoreNoZ=!0,this.urban.getView3D().getRenderPassManager().addPass(this._polygonStencilPassID,i,{after:this._clearStencilPassID})}if(this._polygonFullscreenPassID="fullscreen_polygon_"+e,void 0===this.urban.getView3D().getRenderPassManager().getPass(this._polygonFullscreenPassID)){var s=new RenderPass(null,null,void 0,!0,!1,!1,this._polygonFullscreenPassID);s.idString=this._polygonFullscreenPassID,s.setDisableBackFaceCulling(!1),s.setDisableDepthWrite(!0),s.setEnableStencilTest(!0),s.setStencilFunc("NOTEQUAL"),s.ignoreNoZ=!0,this.urban.getView3D().getRenderPassManager().addPass(this._polygonFullscreenPassID,s,{after:this._polygonStencilPassID})}},_createGeometryLine:function(e){var t=new Node3D,i=Array.from(e),s=0;for(s=0;s<i.length;s++)i[s].setZ(0);if(t.addChild(SceneGraphFactory.createLineNode({points:i})),this.holes&&this.holes.length>0)for(s=0;s<this.holes.length;s++)t.addChild(SceneGraphFactory.createLineNode({points:this.holes[s]}));return t},_createShape:function(e){var t,i,s,r,n;if(e)if(this.removeAllExistingChildren(),"line"===this.geometricMode||"filled"===this.geometricMode||"extruded"===this.geometricMode){if("line"===this.geometricMode)s=this._createGeometryLine(e);else if("filled"===this.geometricMode)t=new THREE.Shape(e),this._appendHoles(t.holes),r=new THREE.ShapeGeometry(t),i=new THREE.Mesh(r),s=SceneGraphFactory.createNodeFromTHREEMesh(i);else{t=new THREE.Shape(e),this._appendHoles(t.holes);var a=this.extrusionHeight;isNaN(a)&&(a=this.attributes[this.extrusionHeight],isNaN(a)&&(a=this.computeExpr(this.extrusionHeight),isNaN(a)&&(a=100))),n={amount:a,steps:1,material:1,extrudeMaterial:0,bevelEnabled:!1},r=new THREE.ExtrudeGeometry(t,n),i=new THREE.Mesh(r),s=SceneGraphFactory.createNodeFromTHREEMesh(i)}if("occluded"===this.renderMode)"line"===this.geometricMode?(this.matOne=new THREE.LineBasicMaterial,this.matOne.isWideLine=!0):"filled"===this.geometricMode?this.matOne=new THREE.MeshBasicMaterial:this.matOne=new THREE.MeshPhongMaterial,s.setMaterial(this.matOne),s.setRenderPasses([this._polygonOccludedPassID]),this.addChild(s);else if("overlay"===this.renderMode)"line"===this.geometricMode?(this.matOne=new THREE.LineBasicMaterial,this.matOne.isWideLine=!0):"filled"===this.geometricMode?this.matOne=new THREE.MeshBasicMaterial:this.matOne=new THREE.MeshPhongMaterial,this.matOne.depthTest=!1,s.setMaterial(this.matOne),s.setRenderPasses([this._polygonOverlayPassID]),this.addChild(s);else{var o;if("line"===this.geometricMode?(this.matOne=new THREE.LineBasicMaterial,this.matTwo=new THREE.LineBasicMaterial,this.matOne.isWideLine=!0,this.matTwo.isWideLine=!0):"filled"===this.geometricMode?(this.matOne=new THREE.MeshBasicMaterial,this.matTwo=new THREE.MeshBasicMaterial):(this.matOne=new THREE.MeshPhongMaterial,this.matTwo=new THREE.MeshPhongMaterial),s.setMaterial(this.matOne),s.setRenderPasses([this._polygonOccludedPassID]),"line"===this.geometricMode){o=new Node3D;for(var l=0;l<s.getChildren().length;l++)o.addChild(s.getChildren()[l])}else o=s.clone();o.setMaterial(this.matTwo),o.setRenderPasses([this._polygonOverlayPassID]),this.addChild(s),this.addChild(o)}}else{n={amount:300,steps:1,material:1,extrudeMaterial:0,bevelEnabled:!1},t=new THREE.Shape(e),this._appendHoles(t.holes),c=new THREE.ExtrudeGeometry(t,n),i=new THREE.Mesh(c),(s=SceneGraphFactory.createNodeFromTHREEMesh(i)).setShadow(!1,!1),s.setSSAO(!1),s.setMatrix((new THREE.Matrix4).identity().setPosition(new THREE.Vector3(0,0,-150)));var h=new THREE.MeshBasicMaterial;s.setMaterial(h),s.setRenderPasses([this._polygonStencilPassID]),this.addChild(s),this.matOne=new THREE.ShaderMaterialDS({side:THREE.FrontSide,transparent:!0,opacity:.5,uniforms:{pColor:{type:"c",value:this.color},pOpacity:{type:"f",value:this.opacity}},vertexShaderPars:"varying vec3 vColor;uniform vec3 pColor;varying float vOp; uniform float pOpacity;",vertexShaderBody:["vec4 mvPosition = viewMatrix * ( modelMatrix  * vec4(position.xyz, 1));","vec3 mvNormal;","if (use_normal_matrix)","mvNormal = normalMatrix * vec3(0.0,0.0,1.0);","else ","mvNormal = vec3(viewMatrix * (modelMatrix * vec4(0.0,0.0,1.0,0.0) ) );","gl_Position = vec4(position.xy, 0.5,1.0);","vColor = pColor.rgb;","vOp = pOpacity;"].join("\n"),fragmentShaderPars:"varying vec3 vColor;varying float vOp;",fragmentShaderBody:["gl_FragColor.rgb = vColor; gl_FragColor.a = vOp;"].join("\n")}),this.matOne.force=!0,this.matOne.depthTest=!1,this.matOne.depthWrite=!1;var c=new THREE.PlaneGeometry(1e7,1e7),d=new THREE.Mesh(c),u=SceneGraphFactory.createNodeFromTHREEMesh(d);u.setPickable(CATXMLV6.NODRAWHL),u.setShadow(!1,!1),u.setSSAO(!1),u.setMaterial(this.matOne),u.setRenderPasses([this._polygonFullscreenPassID]),this.addChild(u)}},_appendHoles:function(e){if(this.holes&&this.holes.length>0)for(var t=0;t<this.holes.length;t++){var i=new THREE.Path(this.holes[t]);e.push(i)}},addChild:function(e){var t=this;e.setColor=function(e,i){return Utils.is(i[0].originalMaterial)||(i[0].originalMaterial={}),Utils.is(i[0].originalMaterial.color)||(i[0].originalMaterial.color=t.color.clone()),t.setColor(e.clone()),i[0].originalMaterial.color},e.setOpacity=function(e,i){return Utils.is(i[0].originalMaterial)||(i[0].originalMaterial={}),Utils.is(i[0].originalMaterial.opacity)||(i[0].originalMaterial.opacity=t.opacity),t.setOpacity(e),i[0].originalMaterial.opacity},this._parent(e)},removeChild:function(e){this._rendering.removeMesh(e.id),this._parent(e)},_setShape:function(){if("volumetric"===this.geometricMode)2===this.children.length&&(this.children[0].setRenderPasses([this._polygonStencilPassID]),this.children[1].setRenderPasses([this._polygonFullscreenPassID]));else{var e=this.children.length;if(0===e)return;if(1===e)if("occluded"===this.renderMode)this.children[0].setRenderPasses([this._polygonOccludedPassID]);else if("overlay"===this.renderMode)this.children[0].setRenderPasses([this._polygonOverlayPassID]);else{"line"===this.geometricMode?this.matTwo=new THREE.LineBasicMaterial:"filled"===this.geometricMode?this.matTwo=new THREE.MeshBasicMaterial:this.matTwo=new THREE.MeshPhongMaterial;var t=this.children[0].clone();t.setMaterial(this.matTwo),t.setRenderPasses([this._polygonOverlayPassID]),this.addChild(t),this.children[0].setRenderPasses([this._polygonOccludedPassID])}else this.removeChild(this.children[1]),"occluded"===this.renderMode?this.children[0].setRenderPasses([this._polygonOccludedPassID]):"overlay"===this.renderMode&&this.children[0].setRenderPasses([this._polygonOverlayPassID])}},_updateMaterials:function(){var e=this._rendering.getCompleteMaterialInfo(this.primId,this.attributes);this.matOne&&(this.matOne.force=!0,this.matOne.needsUpdate=!0,RenderingTools._setMaterialFromProfileNoAdd(this.matOne,e),"volumetric"===this.geometricMode&&(this.matOne.depthTest=!1,this.matOne.depthWrite=!1),ShaderTools.updateCommonUniforms(this.matOne),this.matOne.update&&this.matOne.update(),this.matOne.updateDeferredMaterials&&(this.matOne._deferredMaterialsInit=!1)),this.matTwo&&(this.matTwo.force=!0,this.matTwo.needsUpdate=!0,RenderingTools._setMaterialFromProfileNoAdd(this.matTwo,e),this.matTwo.opacity=this.matTwo.opacity*e.opacityFactor,ShaderTools.updateCommonUniforms(this.matTwo),this.matTwo.update&&this.matTwo.update(),this.matTwo.updateDeferredMaterials&&(this.matTwo._deferredMaterialsInit=!1))},setColor:function(e){this.color=e,"volumetric"===this.geometricMode&&(this._defineStencilPass(),this._setShape()),this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban)},setOpacity:function(e){this.opacity=e,this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban)},setOpacityFactor:function(e){this.opacityFactor=e,this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban)},setLineWidth:function(e){this.lineWidth=e,this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban)},setRenderMode:function(e){this.renderMode=e,this._setShape(),this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban)},setGeometricMode:function(e){e!==this.geometricMode&&(this.geometricMode=e,"volumetric"===this.geometricMode?this._defineStencilPass():this._defineRenderPass(this.renderMode),this._createShape(this.shape),this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban))},setExtrusionHeight:function(e){e!==this.extrusionHeight&&(this.extrusionHeight=e,this._createShape(this.shape),this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban))},setColorGradient:function(e){if(e!==this.colorGradient){if(this.colorGradient=e,void 0!==this.colorGradient){var t=this.computeExpr(this.colorGradient.value);this.color=Utils.getColorGradient(t,{min:this.colorGradient.gradientMin,max:this.colorGradient.gradientMax,minHue:this.colorGradient.minHue,maxHue:this.colorGradient.maxHue,sat:this.colorGradient.sat})}"volumetric"===this.geometricMode&&(this._defineStencilPass(),this._setShape()),this.forceUpdateDistance=!0,this.dynamicUpdate||this._updateOnDistance(this.urban)}},_updateOnDistance:function(e){if(this.dynamicUpdate||this.forceUpdateDistance){var t,i,s=e.getViewpoint().getPosition();if(this.forceUpdateDistance||s.x!==this.oldCamPos.x||s.y!==this.oldCamPos.y||s.z!==this.oldCamPos.z){if(this.forceUpdateDistance=!1,this.dynamicUpdate){this.oldCamPos.x=s.x,this.oldCamPos.y=s.y,this.oldCamPos.z=s.z;var r=this.bSphere.center.clone().sub(s).length();r<this.minDist&&(r=this.minDist),r>this.maxDist&&(r=this.maxDist);var n=1-Math.min(1,(r-this.minDist)/(this.maxDist-this.minDist));t=Math.ceil(Math.max(this.minWidth,this.lineWidth*n)),i=Math.max(this.minOpacity,this.opacity*n)}else t=this.lineWidth,i=this.opacity;this.matOne&&(this.matOne.color=this.color,"line"===this.geometricMode&&(this.matOne.lineWidth=t),this.matOne.opacity=i,this.matOne.transparent=i<1,"volumetric"===this.geometricMode&&Utils.is(this.matOne.uniforms)&&(this.matOne.uniforms.pColor={type:"c",value:this.color},this.matOne.uniforms.pOpacity={type:"f",value:i})),this.matTwo&&(this.matTwo.color=this.color,"line"===this.geometricMode&&(this.matTwo.lineWidth=t),this.matTwo.opacity=i*this.opacityFactor,this.matTwo.transparent=i*this.opacityFactor<1),this._updateMaterials()}}},getMaterials:function(){var e=[];return Utils.is(this.matOne)&&e.push(this.matOne),Utils.is(this.matTwo)&&e.push(this.matTwo),e},isVolumetric:function(){return"volumetric"===this.geometricMode},_applyMaterial:function(){this.needDynUpdate=!1;var e=!1,t=!1,i=!1,s=this._rendering.getCompleteMaterialInfo(this.primId,this.attributes);Utils.is(s.dynamicUpdate)&&(this.dynamicUpdate=s.dynamicUpdate),Utils.is(s.minDist)&&(this.minDist=s.minDist,this.needDynUpdate=!0),Utils.is(s.maxDist)&&(this.maxDist=s.maxDist,this.needDynUpdate=!0),Utils.is(s.renderMode)&&this.renderMode!==s.renderMode&&(this.renderMode=s.renderMode,e=!0,this.needDynUpdate=!0),Utils.is(s.geometricMode)&&s.geometricMode!==this.geometricMode&&(this.geometricMode=s.geometricMode,this.isVolumetric()?t=!0:i=!0,!0,this.needDynUpdate=!0),Utils.is(s.color)&&(this.color=s.color,this.isVolumetric()&&(t=!0,e=!0),this.needDynUpdate=!0),Utils.is(s.minOpacity)&&(this.minOpacity=s.minOpacity,this.needDynUpdate=!0),Utils.is(s.opacity)&&(this.opacity=s.opacity,this.needDynUpdate=!0),Utils.is(s.lineWidth)&&(this.lineWidth=s.lineWidth,this.needDynUpdate=!0),Utils.is(s.minWidth)&&(this.minWidth=s.minWidth,this.needDynUpdate=!0),Utils.is(s.extrusionHeight)&&s.extrusionHeight!==this.extrusionHeight&&(this.extrusionHeight=s.extrusionHeight,!0,this.needDynUpdate=!0),Utils.is(s.opacityFactor)&&(this.opacityFactor=s.opacityFactor,this.needDynUpdate=!0),t&&this._defineStencilPass(),i&&this._defineRenderPass(this.renderMode),!1===this._rendering.needsRebuild()&&e&&this._setShape(this.shape),this._applyDynamicUpdate(),this._keepLastSeenMaterial()},removeAllExistingChildren:function(){for(var e=this.children.length;e>0;--e)this.removeChild(this.children[e-1])},rebuild:function(){this._createShape(this.shape),this._applyDynamicUpdate(),this._keepLastSeenMaterial()},_applyDynamicUpdate:function(){!0===this.needDynUpdate&&(this.forceUpdateDistance=!0,this._updateOnDistance(this.urban))},_keepLastSeenMaterial:function(){var e=this.getMaterials();Utils.is(e)&&Utils.is(e[0])&&(this._rendering._lastSeenMaterial=e[0])},_updateCommonParams:function(){var e,t=this.getMaterials(),i=this._rendering.currentMaterial;for(e=0;e<t.length;e++)RenderingTools._setMaterialFromProfile(t[e],i),this._rendering._lastSeenMaterial=t[e]},computeExpr:function(expr){for(var list=expr.split(/[()\/*+-]/),attr,i=0;i<list.length;++i)attr=list[i],-1===attr.indexOf("Math.")&&""!==attr&&isNaN(attr)&&(expr=expr.replace(attr,this.attributes[attr]));return eval(expr)}});return Polygon}),define("DS/XCityGeometry/Line",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils","DS/Mesh/MeshUtils","DS/XCityTools/EventDispatcher","DS/XCityLayer/Vector"],function(e,t,i,s,r,n,a){"use strict";var o=e.extend({init:function(e,t){var i,s;if(this.urban=e,this._parent(),void 0!==(i=void 0!==t.geom?t.geom:void 0)){s=t.numLine,this.creators=t.creators,this._rendering=t.rendering,this._coordinates=t.coordinates,this.attributes=t.attributes,this.lineId=void 0!==t.id?t.id:this.id;var r=this._rendering.getCompleteMaterialInfo(this.lineId,this.attributes);this.flags=this._rendering.getFlagForPrimitive(this.lineId,this.attributes),this.dynamicUpdate=r.dynamicUpdate,this.animation=r.animation,this._applyMaterial(),this._createShape(i,s),this.oldCamPos={x:0,y:0,z:0}}},_createShape:function(e,t){var i,s=this.creators.lineMesh;for(i=0;i<e.getNumGeometries();++i){var n=a.getVerticesAsArrayOfLines(e,i);n&&(s.startPrimitive(r.ConnectivityTypeEnum.LINES),this._buildLines({points:n,numLine:t,creators:this.creators}),s.endPrimitive(this.lineId))}},_buildLines:function(e){var i,r,n,a=e.points,o=e.numLine,l=e.creators.lineMesh,h=a.length,c=0,d=0,u=0;l.vertexBindingArray.buffer.size>0&&(c=l.vertexBindingArray.buffer.data[l.vertexBindingArray.buffer.size-1]+1);var p={x:a[0].x,y:a[0].y,z:a[0].z},m={x:a[0].x,y:a[0].y,z:a[0].z};for(i=0;i<h;i+=1)r=a[i],i>0&&(u+=Math.sqrt(Math.pow(n.x-r.x,2)+Math.pow(n.y-r.y,2)+Math.pow(n.z-r.z,2))),r.x<p.x?p.x=r.x:r.x>m.x&&(m.x=r.x),r.y<p.y?p.y=r.y:r.y>m.y&&(m.y=r.y),r.z<p.z?p.z=r.z:r.z>m.z&&(m.z=r.z),n=r;if(this._lineCenter=new t.Vector3((p.x+m.x)/2,(p.y+m.y)/2,(p.z+m.z)/2),h>2){var f=a[parseInt(h/2)];this._lineMiddle=new t.Vector3(f.x,f.y,f.z)}else this._lineMiddle=this._lineCenter;for(i=0;i<h;i+=1)r=a[i],i>0&&(d+=Math.sqrt(Math.pow(n.x-r.x,2)+Math.pow(n.y-r.y,2)+Math.pow(n.z-r.z,2))),l.pushVertex([r.x,r.y,r.z]),l.pushColor([o,u,d,i]),n=r;for(i=0;i<h-1;i+=1)l.pushVertexIndices([c]),l.pushVertexIndices([c+1]),c+=1;s.is(this._lengths)||(this._lengths=[]),this._lengths.push(u)},_updateTextureInfo:function(e,t){var i=this.creators.textureInfo.idMap[this.lineId],s=this.creators.textureInfo.texture.image;s.data[i*s.width+e]=t,this.creators.textureInfo.texture.needsUpdate=!0},_computeLineWidthAndOpacityOnDistance:function(){if(this.dynamicUpdate&&s.is(this.creators.textureInfo.texture)){this.lineWidth,this.opacity;var e,t,i,r=this.urban.getViewpoint().getPosition(),n=this._rendering._material;n[0],n[1],this.creators.textureInfo.idMap[this.lineId];r.x===this.oldCamPos.x&&r.y===this.oldCamPos.y&&r.z===this.oldCamPos.z||(i=s.is(this._coordinates)&&s.is(this._coordinates.getLocalPosition)?this._lineCenter.clone().add(this._coordinates.getLocalPosition()):this._lineCenter,this.oldCamPos.x=r.x,this.oldCamPos.y=r.y,this.oldCamPos.z=r.z,(e=i.clone().sub(r).length())<this.minDist&&(e=this.minDist),e>this.maxDist&&(e=this.maxDist),t=1-Math.min(1,(e-this.minDist)/(this.maxDist-this.minDist)),this.computedLineWidth=Math.ceil(Math.max(this.minWidth,this.lineWidth*t)),this.computedOpacity=Math.max(this.minOpacity,this.opacity*t))}},_updateOnDistance:function(){},_setColor:function(e,t){var i=this.color;return this.color=e,this._updateTextureInfo(o.BUFFER_IMAGE.COLOR_RED,e.r),this._updateTextureInfo(o.BUFFER_IMAGE.COLOR_GREEN,e.g),this._updateTextureInfo(o.BUFFER_IMAGE.COLOR_BLUE,e.b),i},_setOpacity:function(e,t){var i=this.opacity;return void 0!==e&&(this.opacity=e),this._updateTextureInfo(o.BUFFER_IMAGE.OPACITY,this.opacity),i},_setLineWidth:function(e,t){var i=this.lineWidth;return void 0!==e&&(this.lineWidth=e),this._updateTextureInfo(o.BUFFER_IMAGE.LINE_WIDTH,this.lineWidth),i},_setSpeed:function(e,t){var i=this.speed;return this.speed=e,this._updateTextureInfo(o.BUFFER_IMAGE.SPEED,e),i},_setSamplingRate:function(e,t){var i=this.samplingRate;return this.samplingRate=e,this._updateTextureInfo(o.BUFFER_IMAGE.SAMPLING_RATE,e),i},_setOpacityFactor:function(e,t){var i=this.opacityFactor;return this.opacityFactor=e,this._updateTextureInfo(o.BUFFER_IMAGE.OPACITY_FACTOR,e),i},_setMinOpacity:function(e,t){var i=this.minOpacity;return this.minOpacity=e,this._updateTextureInfo(o.BUFFER_IMAGE.MIN_OPACITY,e),i},_setMinWidth:function(e,t){var i=this.minWidth;this.minWidth=e;for(var s=this._rendering._getMaterial(),r=0;r<s.length;++r)s[r].updatePDSFXUniform("minWidth",e);return i},_setMinDist:function(e,t){var i=this.minDist;this.minDist=e;for(var s=this._rendering._getMaterial(),r=0;r<s.length;++r)s[r].updatePDSFXUniform("minDist",e);return i},_setMaxDist:function(e,t){var i=this.maxDist;this.maxDist=e;for(var s=this._rendering._getMaterial(),r=0;r<s.length;++r)s[r].updatePDSFXUniform("maxDist",e);return i},_setNbPoints:function(e,t){var i=this.nbPoints;return this.nbPoints=e,this._updateTextureInfo(o.BUFFER_IMAGE.NB_POINTS,e),i},_setDashSize:function(e,t){var i=this.dashSize;return this.dashSize=e,this._updateTextureInfo(o.BUFFER_IMAGE.DASH_SIZE,e),i},_setGapSize:function(e,t){var i=this.gapSize;return this.gapSize=e,this._updateTextureInfo(o.BUFFER_IMAGE.GAP_SIZE,e),i},_setReverse:function(e,t){var i=this.reverse;return this.reverse=e,this._updateTextureInfo(o.BUFFER_IMAGE.REVERSE,e),i},_setLoop:function(e,t){var i=this.loop;return this.loop=e,this._updateTextureInfo(o.BUFFER_IMAGE.LOOP,e),i},setAttribute:function(e,t,i){return this[o.attributeSetter[e]](t,i)},setFlaggedAttribute:function(e,t,i){return this.updateFlags(e,1),this.setAttribute(e,t,i)},isFlagged:function(e){return!!s.is(o.FLAGS[e])},updateFlags:function(e,t){if(this.isFlagged(e)){var i=o.FLAGS[e],r=s.floatPack(this.flags,i,t);this._setFlags(r)}},getFlagsFromPrimitiveRendering:function(e){var t,i,r=Object.keys(e),n=r.length,a=0;for(t=0;t<n;t++)if(i=r[t],this.isFlagged(i)){var l=o.FLAGS[i];a=s.floatPack(a,l,!0)}return a},_setFlags:function(e,t){var i=this.flags;return this.flags=e,this._updateTextureInfo(o.BUFFER_IMAGE.FLAGS,e),i},_applyMaterial:function(){var e=this,t=this._rendering.getCompleteMaterialInfo(this.lineId,this.attributes);o.getSettableAttributes().forEach(function(i){s.is(t[i])&&(e[i]=t[i])})},_setDashPatternIndex:function(e,t){var i=this.dashIndex,r=1,n=0;return s.is(e)&&(n=this._rendering.getIndexFromPattern(e),s.is(n)||(n=0),r=e[e.length-1]),this.dashIndex=n,this.dashLength=r,this._updateTextureInfo(o.BUFFER_IMAGE.DASH_INDEX,n),this._updateTextureInfo(o.BUFFER_IMAGE.DASH_LENGTH,r),i}});return o.attributeSetter={color:"_setColor",opacity:"_setOpacity",opacityFactor:"_setOpacityFactor",minOpacity:"_setMinOpacity",lineWidth:"_setLineWidth",speed:"_setSpeed",samplingRate:"_setSamplingRate",nbPoint:"_setNbPoints",dashSize:"_setDashSize",gapSize:"_setGapSize",reverse:"_setReverse",loop:"_setLoop",dashPattern:"_setDashPatternIndex",dashPatternLayer:"_setDashPatternIndex"},o.getSettableAttributes=function(){var e,t=[];for(e in o.attributeSetter)o.attributeSetter.hasOwnProperty(e)&&t.push(e);return t},o.BUFFER_IMAGE={COLOR_RED:0,COLOR_GREEN:1,COLOR_BLUE:2,LINE_WIDTH:3,OPACITY:4,OPACITY_FACTOR:5,SPEED:6,NB_POINTS:7,OFFSET:8,REVERSE:9,DASH_SIZE:10,SAMPLING_RATE:11,MIN_OPACITY:12,GAP_SIZE:13,LOOP:14,FLAGS:15,DASH_INDEX:16,DASH_LENGTH:17},o.FLAGS={color:0,opacity:1,lineWidth:2},o}),define("DS/XCityGeometry/Building",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityTools/Debug","DS/Visualization/PolygonTessellator","DS/xCityBasicUtils/Utils"],function(e,t,i,s,r){"use strict";var n=e.singleton({init:function(){},build:function(e){if(void 0!==e.roofCreator&&void 0!==e.shape&&0!==e.shape.length&&void 0!==e.altitude&&void 0!==e.height){var t=e.wallCreator,i=e.roofCreator,s=e.shape,r=void 0!==e.altitude?e.altitude:0,n=void 0!==e.height?e.height:100,a=void 0!==e.roofHeight?e.roofHeight:0,o=void 0!==e.roofAngle?e.roofAngle:0,l=void 0!==e.infoInd?e.infoInd:-1,h=void 0!==e.roofObjects?e.roofObjects:0,c=void 0!==e.roofShape?e.roofShape:0;s=this.getClockWiseRing(s),t&&(t.startPrimitive(),this.buildWalls({creator:t,shape:s,holes:e.holes,altitude:r,height:n,infoInd:l}),t.endPrimitive(e.pIdentifer)),i.startPrimitive(),a<=0||0===o||s.length>20?(this.buildFlatRoof({creator:i,shape:s,holes:e.holes,altitude:r+n,infoInd:l,uvCalc:e.uvCalc}),h&&this.buildRoofObjects({roofCreator:i,wallCreator:t,shape:s,altitude:r,height:n,infoInd:l})):"GABLE"===c&&4===s.length&&a>0?this.buildGableRoof({creator:i,shape:s,altitude:r+n,height:a,infoInd:l}):this.buildRoof({creator:i,shape:s,altitude:r+n,height:a,angle:o,infoInd:l}),i.endPrimitive(e.pIdentifer)}},getClockWiseRing:function(e,t){for(var i=0,s=e.length-1,r=0;r<e.length;s=r++)i+=e[s].x*e[r].y-e[r].x*e[s].y;var n=e.length,a=[];if(!0!==t&&.5*i>=0||!0===t&&.5*i<=0)for(;n--;)a.push(e[n]);else a=a.concat(e);return a},__getBevelVec1:function(e,i,s){var r=Math.atan2(i.y-e.y,i.x-e.x),n=Math.atan2(s.y-e.y,s.x-e.x);r>n&&(n+=2*Math.PI);var a=(r+n)/2,o=-Math.cos(a),l=-Math.sin(a);return new t.Vector2(o,l)},__getBevelVec2:function(e,t,s){var r,a,o,l,h,c=n.__v1,d=n.__v2,u=n.__v3,p=n.__v4,m=n.__v5,f=n.__v6;return c.set(e.x-t.x,e.y-t.y),d.set(e.x-s.x,e.y-s.y),r=c.normalize(),a=d.normalize(),u.set(-r.y,r.x),p.set(a.y,-a.x),m.copy(e).add(u),f.copy(e).add(p),m.equals(f)?p.clone():(m.copy(t).add(u),f.copy(s).add(p),o=r.dot(p),l=f.sub(m).dot(p),0===o&&(i.log("Either infinite or no solutions!"),0===l?i.log("Its finite solutions."):i.log("Too bad, no solutions.")),(h=l/o)<0?this.__getBevelVec1(e,t,s):r.multiplyScalar(h).add(m).sub(e).clone())},_getBevelVec:function(e,t,i){return this.__getBevelVec2(e,t,i)},_scalePt2:function(e,t,s){return t||i.log("die"),t.clone().multiplyScalar(s).add(e)},_isCoherent:function(e,t){var i,s,r,a,o,l,h,c,d,u,p,m,f,g,y,v;for(i=0,o=e.length;i<o;i++){if((s=i+1)===o&&(s=0),n.__v1.set(e[s].x-e[i].x,e[s].y-e[i].y),n.__v1.normalize(),n.__v2.set(t[s].x-t[i].x,t[s].y-t[i].y),n.__v2.normalize(),n.__v1.dot(n.__v2)<.9)return!1;for(r=0;r<o;r++)if((a=r+1)===o&&(a=0),p=e[s].x-e[i].x,m=e[s].y-e[i].y,f=e[i].x-e[r].x,h=(g=e[i].y-e[r].y)*p-g*m,0!==(l=g*(y=e[a].x-e[r].x)-f*(v=e[a].y-e[r].y))&&0!==h&&0!==(c=p*v-m*y)&&(u=h/c,(d=l/c)>.1&&d<.9&&u>.1&&u<.9))return!1}return!0},_positionRandom:function(e){return Math.abs(e.x*e.x*e.y%100)/100},_makeTriFace:function(e,t,i,s,r,n,a,o){e.pushVertex(t),e.pushVertex(i),e.pushVertex(s),e.pushNormal(r),e.pushTexCoord(0,[n,a]),e.pushTexCoord(0,[n,a]),e.pushTexCoord(0,[n,a]),e.pushTexCoord(1,[0,0]),e.pushTexCoord(1,[1,0]),e.pushTexCoord(1,[.5,1]),e.pushVertexIndices([o,o+1,o+2])},_makeQuadFace1:function(e,t,i,s,r,n,a,o,l){e.pushVertex(t),e.pushVertex(i),e.pushVertex(s),e.pushVertex(r),e.pushNormal(n),e.pushNormal(n),e.pushTexCoord(0,[o,0]),e.pushTexCoord(0,[o,a]),e.pushTexCoord(0,[o,0]),e.pushTexCoord(0,[o,a]),e.pushVertexIndices([l,l+2,l+3]),e.pushVertexIndices([l,l+3,l+1])},_makeQuadFace2:function(e,t,i,s,r,n,a,o,l,h,c){e.pushVertex(t),e.pushVertex(i),e.pushVertex(s),e.pushVertex(r),e.pushNormal(n),e.pushNormal(n),e.pushTexCoord(0,[l,h]),e.pushTexCoord(0,[l,h]),e.pushTexCoord(0,[l,h]),e.pushTexCoord(0,[l,h]),a>0&&o>0?(e.pushTexCoord(1,[0,0]),e.pushTexCoord(1,[a,0]),e.pushTexCoord(1,[0,o]),e.pushTexCoord(1,[a,o])):(e.pushTexCoord(1,[a,o]),e.pushTexCoord(1,[a,o]),e.pushTexCoord(1,[a,o]),e.pushTexCoord(1,[a,o])),e.pushVertexIndices([c,c+2,c+3]),e.pushVertexIndices([c,c+3,c+1])},buildWalls:function(e){if(void 0!==e.creator&&void 0!==e.shape&&0!==e.shape.length){var t,i,s,r,a=e.creator,o=a.current.nbVertices,l=void 0!==e.altitude?e.altitude:0,h=void 0!==e.height?e.height:1,c=void 0!==e.infoInd?e.infoInd:-1,d=e.shape,u=[];if(u.push(d),e.holes)for(var p=e.holes.length,m=0;m<p;m++){var f=this.getClockWiseRing(e.holes[m],!0);u.push(f)}for(var g=u.length,y=0;y<g;y++){var v=(d=u[y]).length;for(t=0;t<v;++t)i=t+1<v?t+1:0,r=(s=n.__vec1.set(d[i].x-d[t].x,d[i].y-d[t].y,0)).length(),s.normalize(),this._makeQuadFace1(a,[d[t].x,d[t].y,l],[d[i].x,d[i].y,l],[d[t].x,d[t].y,l+h],[d[i].x,d[i].y,l+h],[-s.y,s.x,0],r,c,o+4*t);o=a.current.nbVertices}}},buildRoofSides:function(e){if(void 0!==e.creator&&void 0!==e.shape&&0!==e.shape.length&&void 0!==e.topShape&&0!==e.topShape.length){var t,s,r,a,o,l,h,c=e.creator,d=c.current.nbVertices,u=e.shape,p=u.length,m=e.topShape,f=void 0!==e.altitude?e.altitude:0,g=void 0!==e.height?e.height:1,y=void 0!==e.infoInd?e.infoInd:-1;for(t=0;t<p;++t)(s=t+1)===p&&(s=0),c.pushVertex([u[t].x,u[t].y,f]),c.pushVertex([u[s].x,u[s].y,f]),h=(r=n.__vec1.set(u[s].x-u[t].x,u[s].y-u[t].y,0)).length(),r.normalize(),c.pushVertex([m[t].x,m[t].y,f+g]),c.pushVertex([m[s].x,m[s].y,f+g]),c.pushTexCoord(0,[y,0]),c.pushTexCoord(0,[y,0]),c.pushTexCoord(0,[y,0]),c.pushTexCoord(0,[y,0]),a=n.__vec2.set(m[t].x-u[t].x,m[t].y-u[t].y,g),(l=n.__vecN.crossVectors(a,r)).normalize(),c.pushNormal([l.x,l.y,l.z]),c.pushNormal([l.x,l.y,l.z]),a.crossVectors(r,l),o=n.__vec3,c.pushTexCoord(1,[0,0]),c.pushTexCoord(1,[h,0]),o.set(m[t].x-u[t].x,m[t].y-u[t].y,g),c.pushTexCoord(1,[r.dot(o),a.dot(o)]),o.set(m[s].x-u[t].x,m[s].y-u[t].y,g),c.pushTexCoord(1,[r.dot(o),a.dot(o)]),c.pushVertexIndices([d+4*t,d+4*t+2,d+4*t+3]),c.pushVertexIndices([d+4*t,d+4*t+3,d+4*t+1])}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},buildFlatRoof:function(e){if(void 0!==e.creator&&void 0!==e.shape&&0!==e.shape.length){var n,a,o,l,h,c,d=e.creator,u=d.current.nbVertices,p=(e.shape.length,void 0!==e.altitude?e.altitude:0),m=void 0!==e.infoInd?e.infoInd:-1,f=[];if(e.holes)for(var g=e.holes.length,y=0;y<g;y++){var v=this.getClockWiseRing(e.holes[y],!0);f.push(v)}var b=new s;for(o=e.shape,n=0;n<o.length;n++)h=o[n].x,c=-o[n].y,b.addPointToCurrentPolygonLoop(h,c);if(b.closeCurrentPolygonLoop(),l=f,r.is(l))for(n=0;n<l.length;n++){for(o=l[n],a=0;a<o.length;a++)h=o[a].x,c=-o[a].y,b.addPointToCurrentPolygonLoop(h,c);b.closeCurrentPolygonLoop()}b.endCurrentPolygon();var x=b.createNode3D(new t.MeshBasicMaterial({force:!0}),p);if(r.is(x)){var _,C=x.children[0].mesh3js.geometry[0].vertexIndexArray,S=x.children[0].mesh3js.geometry[0].vertexPositionArray;!0===e.uvCalc&&((_=x.getBoundingBox()).width=_.max.x-_.min.x,_.height=_.max.y-_.min.y);var D=S.length;for(n=0;n<D;n+=3){d.pushVertex([S[n],S[n+1],S[n+2]]),d.pushTexCoord(0,[m,1]);var P=[-1,-1];if(!0===e.uvCalc){var M=new t.Vector3(S[n],S[n+1],S[n+2]);P=this.calculatePlanarUV(M,_)}d.pushTexCoord(1,P)}var w=C.length,T=[];for(n=0;n<w;n+=3)T[n]=[],T[n].push(C[n]+u),T[n].push(C[n+1]+u),T[n].push(C[n+2]+u),d.pushVertexIndices(T[n]),d.pushNormal([0,0,1])}}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},_appendHoles:function(e,i){if(i&&i.length>0)for(var s=0;s<i.length;s++){var r=i[s],n=new t.Path(r);e.push(n)}},buildRoofObjects:function(e){if(void 0!==e.roofCreator&&void 0!==e.shape&&0!==e.shape.length){var t=e.roofCreator,s=e.wallCreator,r=e.shape,a=r.length,o=void 0!==e.altitude?e.altitude:0,l=void 0!==e.height?e.height:1,h=void 0!==e.infoInd?e.infoInd:-1;if(this.buildRoofAcroterion({creator:t,shape:r,altitude:o+l,infoInd:h,height:.4,width:.4}),!(a>10)){var c,d,u,p,m,f,g,y,v,b,x,_,C,S,D=n.__v1,P=this._positionRandom(r[0]),M=this._positionRandom(r[1]);for(g=a-1,y=a-1,D.subVectors(r[0],r[a-1]),p=f=D.length(),c=1;c<a;c++)D.subVectors(r[c],r[c-1]),(d=D.length())>f&&(f=d,y=c-1),d<p&&(p=d,g=c-1);if(n.__v1.subVectors(r[g+1<a?g+1:0],r[g]),p=(u=n.__vec1.set(n.__v1.x,n.__v1.y,0)).length(),u.normalize(),n.__v1.subVectors(r[g>0?g-1:a-1],r[g]),f=(m=n.__vec2.set(n.__v1.x,n.__v1.y,0)).length(),m.normalize(),n.__vec3.crossVectors(m,u),n.__vec3.z<0&&m.multiplyScalar(-1),n.__vec3.length()>.9&&(C=0,S=4*P,v=[.5,1,2.5,2,1],b=r[g].x+u.x*v[0]+m.x*v[1],x=r[g].y+u.y*v[0]+m.y*v[1],n.__v1.set(u.x*v[2],u.y*v[2]),n.__v2.set(m.x*v[3],m.y*v[3]),f>v[1]+v[3]))for(;p>v[0]+v[2]&&C<S;)this.buildRoofBox({creator:t,altitude:o+l+.01,infoInd:h,xCoord:b,yCoord:x,direction1:n.__v1,direction2:n.__v2,height:v[4],type:4}),b+=u.x*(v[0]+v[2]),x+=u.y*(v[0]+v[2]),p-=v[0]+v[2],C++;if(n.__v1.subVectors(r[y+1<a?y+1:0],r[y]),p=(u=n.__vec1.set(n.__v1.x,n.__v1.y,0)).length(),u.normalize(),f=n.__v1.subVectors(r[y>0?y-1:a-1],r[y]).length(),(m=n.__vec2.crossVectors(u,n.__vecN.set(0,0,1))).normalize(),s&&l>25)if(4===a)if(Math.abs(p-f)<2)for(n.__v1.set(u.x*p*.5,u.y*p*.5),n.__v2.set(m.x*f*.5,m.y*f*.5),b=r[y].x+u.x*p*.25+m.x*f*.25,x=r[y].y+u.y*p*.25+m.y*f*.25,this.buildRoofBox({creator:t,wallCreator:s,altitude:o+l+.01,infoInd:h,xCoord:b,yCoord:x,direction1:n.__v1,direction2:n.__v2,height:2.5+2*P}),o=o+l+2.5+2*P,S=2+5*P,C=0;C<S;++C)_={creator:t,coordX:b+u.x*p*(P/2>.45?.45:P/2)+m.x*f*(M/2>.45?.45:M/2),coordY:x+u.y*p*(P/2>.45?.45:P/2)+m.y*f*(M/2>.45?.45:M/2),altitude:o,height:2.5+5*P,size:P/4,infoInd:h},P=this._positionRandom({x:_.coordX,y:_.coordY}),M=this._positionRandom({x:_.coordY,y:_.coordX}),this.buildRoofPyramid(_);else d=[P/2<.1?.1:P/2>.25?.25:P/2,2*M<.45?.45:2*M>.65?.65:2*M],n.__v1.set(u.x*p*d[1],u.y*p*d[1]),n.__v2.set(m.x*f*.5,m.y*f*.5),b=r[y].x+u.x*p*d[0]+m.x*f*.25,x=r[y].y+u.y*p*d[0]+m.y*f*.25,this.buildRoofBox({creator:t,wallCreator:s,altitude:o+l+.01,infoInd:h,xCoord:b,yCoord:x,direction1:n.__v1,direction2:n.__v2,height:2.5+2*P}),p*(1-d[0]-d[1])>.5*f+10&&(n.__v1.set(u.x*f*.5,u.y*f*.5),n.__v2.set(m.x*f*.5,m.y*f*.5),b=r[y].x+u.x*(p*(d[0]+d[1])+5)+m.x*f*.25,x=r[y].y+u.y*(p*(d[0]+d[1])+5)+m.y*f*.25,this.buildRoofBox({creator:t,altitude:o+l+.1,infoInd:h,xCoord:b,yCoord:x,direction1:n.__v1,direction2:n.__v2,height:4+2*P,type:5}));else f>12&&(d=[P/2<.15?.15:P/2>.45?.45:P/2,2*P<.1?.1:2*P>.45?.45:2*P],n.__v1.set(u.x*p*d[1],u.y*p*d[1]),n.__v2.set(8*m.x,8*m.y),this.buildRoofBox({creator:t,wallCreator:s,altitude:o+l+.01,infoInd:h,xCoord:r[y].x+u.x*p*d[0]+2*m.x,yCoord:r[y].y+u.y*p*d[0]+2*m.y,direction1:n.__v1,direction2:n.__v2,height:2.5+2*P}))}}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},buildRoofAcroterion:function(e){if(void 0!==e.creator&&void 0!==e.shape&&0!==e.shape.length){var t,s,r,a,o,l=e.creator,h=l.current.nbVertices,c=e.shape,d=c.length,u=void 0!==e.altitude?e.altitude:0,p=void 0!==e.infoInd?e.infoInd:-1,m=void 0===e.height?1:e.height,f=void 0===e.width?.5:e.width,g=[],y=[];for(t=0,s=(a=c.length)-1,r=t+1;t<a;t++,s++,r++)s=s===a?0:s,r=r===a?0:r,g.push(this._getBevelVec(c[t],c[s],c[r]));for(t=0,a=c.length;t<a;t++)o=this._scalePt2(c[t],g[t],-f),y.push(o);for(t=0;t<d;++t)s=t+1===d?0:t+1,n.__v1.set(c[s].x-c[t].x,c[s].y-c[t].y),a=n.__v1.length(),n.__v1.normalize(),this._makeQuadFace2(l,[c[t].x,c[t].y,u],[c[s].x,c[s].y,u],[c[t].x,c[t].y,u+m],[c[s].x,c[s].y,u+m],[-n.__v1.y,n.__v1.x,0],a,m,p,2,h),h+=4,n.__v1.set(y[s].x-y[t].x,y[s].y-y[t].y),a=n.__v1.length(),n.__v1.normalize(),this._makeQuadFace2(l,[y[s].x,y[s].y,u],[y[t].x,y[t].y,u],[y[s].x,y[s].y,u+m],[y[t].x,y[t].y,u+m],[n.__v1.y,-n.__v1.x,0],a,m,p,2,h),h+=4,this._makeQuadFace2(l,[c[t].x,c[t].y,u+m],[c[s].x,c[s].y,u+m],[y[t].x,y[t].y,u+m],[y[s].x,y[s].y,u+m],[0,0,1],-1,-1,p,3,h),h+=4}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},buildRoofBox:function(e){if(void 0!==e.creator&&void 0!==e.xCoord&&void 0!==e.yCoord&&void 0!==e.direction1&&void 0!==e.direction2){var t,s,r,a,o=e.creator,l=o.current.nbVertices,h=e.xCoord,c=e.yCoord,d=e.direction1,u=e.direction2,p=void 0!==e.altitude?e.altitude+.01:0,m=void 0!==e.height?e.height:2.5,f=void 0!==e.type?e.type:1,g=void 0!==e.infoInd?e.infoInd:-1;t=n.__v3.set(h,c),s=n.__v4.set(h+d.x,c+d.y),r=n.__v5.set(h+u.x,c+u.y),a=n.__v6.set(h+d.x+u.x,c+d.y+u.y),this._makeQuadFace2(o,[t.x,t.y,p+m],[s.x,s.y,p+m],[r.x,r.y,p+m],[a.x,a.y,p+m],[0,0,1],d.length(),u.length(),g,f,l),e.wallCreator?(l=e.wallCreator.current.nbVertices,this._makeQuadFace1(e.wallCreator,[t.x,t.y,p],[s.x,s.y,p],[t.x,t.y,p+m],[s.x,s.y,p+m],[-u.x,-u.y,0],0,g,l),this._makeQuadFace1(e.wallCreator,[s.x,s.y,p],[a.x,a.y,p],[s.x,s.y,p+m],[a.x,a.y,p+m],[d.x,d.y,0],0,g,l+4),this._makeQuadFace1(e.wallCreator,[a.x,a.y,p],[r.x,r.y,p],[a.x,a.y,p+m],[r.x,r.y,p+m],[u.x,u.y,0],0,g,l+8),this._makeQuadFace1(e.wallCreator,[r.x,r.y,p],[t.x,t.y,p],[r.x,r.y,p+m],[t.x,t.y,p+m],[-d.x,-d.y,0],0,g,l+12)):(this._makeQuadFace2(o,[t.x,t.y,p],[s.x,s.y,p],[t.x,t.y,p+m],[s.x,s.y,p+m],[-u.x,-u.y,0],d.length(),m,g,f,l+4),this._makeQuadFace2(o,[s.x,s.y,p],[a.x,a.y,p],[s.x,s.y,p+m],[a.x,a.y,p+m],[d.x,d.y,0],u.length(),m,g,f,l+8),this._makeQuadFace2(o,[a.x,a.y,p],[r.x,r.y,p],[a.x,a.y,p+m],[r.x,r.y,p+m],[u.x,u.y,0],d.length(),m,g,f,l+12),this._makeQuadFace2(o,[r.x,r.y,p],[t.x,t.y,p],[r.x,r.y,p+m],[t.x,t.y,p+m],[-d.x,-d.y,0],u.length(),m,g,f,l+16))}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},buildRoofPyramid:function(e){if(void 0!==e.creator&&void 0!==e.coordX&&void 0!==e.coordY){var t=e.creator,s=t.current.nbVertices,r={x:e.coordX,y:e.coordY},n=void 0!==e.altitude?e.altitude:0,a=void 0!==e.height?e.height:0,o=void 0!==e.size?e.size:.2,l=void 0!==e.infoInd?e.infoInd:-1;this._makeTriFace(t,[r.x,r.y+o,n],[r.x-o,r.y,n],[r.x,r.y,n+a],[-.5,.5,0],l,6,s),this._makeTriFace(t,[r.x-o,r.y,n],[r.x,r.y-o,n],[r.x,r.y,n+a],[-.5,-.5,0],l,6,s+3),this._makeTriFace(t,[r.x,r.y-o,n],[r.x+o,r.y,n],[r.x,r.y,n+a],[.5,-.5,0],l,6,s+6),this._makeTriFace(t,[r.x+o,r.y,n],[r.x,r.y+o,n],[r.x,r.y,n+a],[.5,.5,0],l,6,s+9)}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},buildRoof:function(e){if(void 0!==e.creator&&void 0!==e.shape&&0!==e.shape.length){var t,s,r,n,a,o=e.creator,l=e.shape,h=void 0!==e.altitude?e.altitude:0,c=void 0!==e.height?e.height:1,d=void 0!==e.angle?e.angle:0,u=void 0!==e.infoInd?e.infoInd:-1,p=c,m=-1*c/Math.tan(d),f=[],g=[];for(t=0,s=(n=l.length)-1,r=t+1;t<n;t++,s++,r++)s===n&&(s=0),r===n&&(r=0),f.push(this._getBevelVec(l[t],l[s],l[r]));for(t=0,n=l.length;t<n;t++)a=this._scalePt2(l[t],f[t],m),g.push(a);if(!this._isCoherent(g,l)){for(p*=.7,m*=.3,g=[],t=0,n=l.length;t<n;t++)a=this._scalePt2(l[t],f[t],m),g.push(a);if(!this._isCoherent(g,l))return this.buildFlatRoof({creator:o,shape:l,altitude:h,infoInd:u})}this.buildRoofSides({creator:o,shape:l,altitude:h,height:p,infoInd:u,topShape:g}),this.buildFlatRoof({creator:o,shape:g,altitude:h+p,infoInd:u})}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},buildGableRoof:function(e){if(void 0!==e.creator&&void 0!==e.shape&&4===e.shape.length){var t,s,r,a,o,l=e.creator,h=l.current.nbVertices,c=e.shape,d=void 0!==e.altitude?e.altitude:0,u=void 0!==e.height?e.height:10,p=void 0!==e.infoInd?e.infoInd:-1,m=void 0===e.edgeSize?0:e.edgeSize;r=n.__vec1,a=n.__vec2,o=n.__vecN,t=[(c[0].x+c[3].x)/2,(c[0].y+c[3].y)/2,d+u],s=[(c[1].x+c[2].x)/2,(c[1].y+c[2].y)/2,d+u],r.set(c[3].x-c[0].x,c[3].y-c[0].y,0),a.set(t[0]-c[0].x,t[1]-c[0].y,u),o.crossVectors(r,a),o.normalize(),l.pushVertex([c[0].x,c[0].y,d]),l.pushVertex([c[3].x,c[3].y,d]),l.pushVertex(t),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(1,[0,0]),l.pushTexCoord(1,[r.length(),0]),l.pushTexCoord(1,[r.length()/2,u]),l.pushNormal([o.x,o.y,o.z]),l.pushVertexIndices([h+0,h+1,h+2]),r.set(c[1].x-c[2].x,c[1].y-c[2].y,0),a.set(s[0]-c[2].x,s[1]-c[2].y,u),o.crossVectors(r,a),o.normalize(),l.pushVertex([c[2].x,c[2].y,d]),l.pushVertex([c[1].x,c[1].y,d]),l.pushVertex(s),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(1,[0,0]),l.pushTexCoord(1,[r.length(),0]),l.pushTexCoord(1,[r.length()/2,u]),l.pushNormal([o.x,o.y,o.z]),l.pushVertexIndices([h+3,h+4,h+5]),r.set(s[0]-t[0],s[1]-t[1],0),r.normalize(),l.pushVertex([t[0]-m*r.x,t[1]-m*r.y,t[2]]),l.pushVertex([s[0]+m*r.x,s[1]+m*r.y,s[2]]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(1,[0,0]),l.pushTexCoord(1,[0,0]),r.set(c[1].x-c[0].x,c[1].y-c[0].y,0),a.set(t[0]-c[0].x,t[1]-c[0].y,u),o.crossVectors(a,r),o.normalize(),l.pushVertex([c[0].x-m*r.x-m*a.x,c[0].y-m*r.y-m*a.y,d-m*a.z]),l.pushVertex([c[1].x+m*r.x-m*a.x,c[1].y+m*r.y-m*a.y,d-m*a.z]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(1,[0,0]),l.pushTexCoord(1,[0,0]),l.pushNormal([o.x,o.y,o.z]),l.pushNormal([o.x,o.y,o.z]),l.pushVertexIndices([h+8,h+6,h+7]),l.pushVertexIndices([h+8,h+7,h+9]),r.set(c[3].x-c[2].x,c[3].y-c[2].y,0),a.set(s[0]-c[2].x,s[1]-c[2].y,u),o.crossVectors(a,r),o.normalize(),l.pushVertex([c[2].x-m*r.x-m*a.x,c[2].y-m*r.y-m*a.y,d-m*a.z]),l.pushVertex([c[3].x+m*r.x-m*a.x,c[3].y+m*r.y-m*a.y,d-m*a.z]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(0,[p,-1]),l.pushTexCoord(1,[0,0]),l.pushTexCoord(1,[0,0]),l.pushNormal([o.x,o.y,o.z]),l.pushNormal([o.x,o.y,o.z]),l.pushVertexIndices([h+10,h+7,h+6]),l.pushVertexIndices([h+10,h+6,h+11])}else i.warn("BuildingCreator: Cannot build roof due to missing arguments")},calculatePlanarUV:function(e,t){var i=e.sub(t.min);return[i.x/t.width,i.y/t.height]}});return n.__vec1=new t.Vector3,n.__vec2=new t.Vector3,n.__vec3=new t.Vector3,n.__vecN=new t.Vector3,n.__v1=new t.Vector2,n.__v2=new t.Vector2,n.__v3=new t.Vector2,n.__v4=new t.Vector2,n.__v5=new t.Vector2,n.__v6=new t.Vector2,n}),define("DS/XCityGeometry/Label",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/EditableMesh3D","DS/Visualization/Mesh3D","DS/xCityBasicUtils/Utils","DS/Mesh/MeshUtils","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityTools/ShaderTools","DS/XCityTools/TextureTools","DS/Plugins/RenderPass","DS/Mesh/Mesh","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader"],function(e,t,i,s,r,n,a,o,l,h,c,d,u,p){"use strict";var m=t.extend({});return m.labelBillboard={attributes:{alphaTest:.1},uniforms:{alphaTest:{type:"f",value:.1},top:{type:"f",value:0},left:{type:"f",value:0},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)},labelSize:{type:"v2",value:new e.Vector2(0,0)},geometrySize:{type:"v2",value:new e.Vector2(0,0)},geometryOffset:{type:"v3",value:new e.Vector3(0,0,0)},_angle:{type:"f",value:0},switchDistance:{type:"f",value:0}},vertex_pars:["uniform float top;","uniform float left;","uniform vec2 halfScreenResolution;","uniform vec2 labelSize;","uniform vec2 geometrySize;","uniform vec3 geometryOffset;","uniform float _angle;","uniform float switchDistance;"].join("\n"),vertex:["// RenderingCrossQuad MAP - Read CrossQuad info","/////////////////////////////////////////////////","mat2 rotationMatrix = mat2(cos(_angle), -sin(_angle), sin(_angle), cos(_angle));","vec3 rotatedPosition = vec3(position);","rotatedPosition.xy -= labelSize;","rotatedPosition.xy = rotatedPosition.xy * rotationMatrix;","rotatedPosition.xy += labelSize;","vec4 posCenterCameraSpace = vGetViewMatrix() * modelMatrix * vec4(0.0, 0.0, 0.0, 1.0);","vec4 posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;","posCenterScreenSpace /= posCenterScreenSpace.w;","vec3 offset = vec3(left, top, 0.0);","if (posCenterCameraSpace.z > -switchDistance)","{","  float scaleOffset = -switchDistance / posCenterCameraSpace.z;","  scaleOffset -= 1.0;","  float scaleLeft = geometrySize.x * geometryOffset.x;","  float scaleTop = geometrySize.y * geometryOffset.y;","  if (posCenterCameraSpace.z > -switchDistance)","  {","    scaleLeft *= scaleOffset;","    scaleTop *= scaleOffset;","  }","  offset += vec3(scaleLeft, scaleTop, 0.0);","}","vec3 positionLocal = rotatedPosition + offset;","vec2 offsetScreenSpace = positionLocal.xy/halfScreenResolution;","gl_Position = posCenterScreenSpace + vec4(offsetScreenSpace, 0.0, 0.0);"].join("\n"),fragment_pars:["varying vec3 colorFlag;"].join("\n"),fragment:[].join("\n")},m.labelBillboard_PDSFX={attributes:{alphaTest:.1},uniforms:{mapCity:{type:"t2",value:void 0},alphaTest:{type:"f",value:.1},top:{type:"f",value:0},left:{type:"f",value:0},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)},labelSize:{type:"v2",value:new e.Vector2(0,0)},geometrySize:{type:"v2",value:new e.Vector2(0,0)},geometryOffset:{type:"v3",value:new e.Vector3(0,0,0)},_angle:{type:"f",value:0},switchDistance:{type:"f",value:0}},varyings:{uvLabel:{type:"v2",length:1}},VS_overridableFunctions:{ProcessClipSpacePosition:["// RenderingCrossQuad MAP - Read CrossQuad info","/////////////////////////////////////////////////","mat2 rotationMatrix = mat2(cos(_angle), -sin(_angle), sin(_angle), cos(_angle));","vec3 rotatedPosition = vec3(position);","rotatedPosition.xy -= labelSize;","rotatedPosition.xy = rotatedPosition.xy * rotationMatrix;","rotatedPosition.xy += labelSize;","vec4 posCenterCameraSpace = vGetViewMatrix() * modelMatrix * vec4(0.0, 0.0, 0.0, 1.0);","vec4 posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;","posCenterScreenSpace /= posCenterScreenSpace.w;","vec3 offset = vec3(left, top, 0.0);","if (posCenterCameraSpace.z > -switchDistance)","{","  float scaleOffset = -switchDistance / posCenterCameraSpace.z;","  scaleOffset -= 1.0;","  float scaleLeft = geometrySize.x * (geometryOffset.x + 0.0) * scaleOffset;","  float scaleTop = geometrySize.y * (geometryOffset.y + 0.5) * scaleOffset;","  offset += vec3(scaleLeft, scaleTop, 0.0);","}","vec3 positionLocal = rotatedPosition + offset;","vec2 offsetScreenSpace = positionLocal.xy/halfScreenResolution;","ioPosition = posCenterScreenSpace + vec4(offsetScreenSpace, 0.0, 0.0);"].join("\n"),ComputeVaryingValues:["uvLabel = vGetAttribTexCoord0().xy;"].join("\n")},FS_overridableFunctions:{__ComputeAlbedo:["vec4 _raster = texture2D(mapCity, uvLabel);","return _raster.rgb;"].join("\n"),_ComputeDiffuseTexel:["return texture2D(mapCity, uvLabel);"].join("\n")}},m.poiText3D={attributes:{alphaTest:.1},uniforms:{alphaTest:{type:"f",value:.1},top:{type:"f",value:0},left:{type:"f",value:0},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)}},vertex_pars:["uniform float top;","uniform float left;","uniform vec2 halfScreenResolution;"].join("\n"),vertex:["// RenderingCrossQuad MAP - Read CrossQuad info","/////////////////////////////////////////////////","#ifdef USE_MAP","vUv = 1.0 - vUv;","#endif"].join("\n"),fragment_pars:[].join("\n"),fragment:[].join("\n")},m.label3D={attributes:{alphaTest:.1},uniforms:{normalDepthTexture:{type:"t",value:null},alphaTest:{type:"f",value:.1},switchDistance:{type:"f",value:0},scaleCulling:{type:"f",value:1},offsetAnchor:{type:"v3",value:e.Vector3()},labelRotationMatrix:{type:"m4",value:e.Matrix4()},enableAutomaticFlip:{type:"b",value:!1}},vertex_pars:["varying float isOpaque;","varying vec3 normalW;","varying vec4 colorW;","uniform sampler2D normalDepthTexture;","uniform float switchDistance;","uniform float scaleCulling;","uniform vec3 offsetAnchor;","uniform mat4 labelRotationMatrix;","uniform bool enableAutomaticFlip;"].join("\n"),vertex:["// RenderingCrossQuad MAP - Read CrossQuad info","/////////////////////////////////////////////////","#ifdef IS_MULTI_INSTANCED","vec3 center = -offsetAnchor;","#else","vec3 center = -offsetAnchor;","#endif","colorW = color;","normalW = normal;","vec4 posCenterCameraSpace = vGetViewMatrix() * modelMatrix * vec4(center, 1.0);","posCenterCameraSpace /= posCenterCameraSpace.w;","vec4 posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;","posCenterScreenSpace /= posCenterScreenSpace.w;","// Compute offset to rescale the POI in screen space (fixed size)","float scaleOffset = -posCenterCameraSpace.z/switchDistance;","if (posCenterCameraSpace.z > -switchDistance)","{","   scaleOffset = 1.0;","}","if (switchDistance < 0.001)","{","   scaleOffset = -posCenterCameraSpace.z/1000.0;","}","vec4 posVertexCameraSpace = vGetViewMatrix() * modelMatrix * vec4(position.xyz, 1.0);","posVertexCameraSpace /= posVertexCameraSpace.w;","vec4 vectorCameraSpace = posVertexCameraSpace - posCenterCameraSpace;","mvPosition = posCenterCameraSpace + vec4(vectorCameraSpace.xyz*(scaleOffset/scaleCulling), 0.0);","gl_Position = vGetProjectionMatrix() * mvPosition; //viewMatrix * modelMatrix * vec4(position, 1.0);","vertex_wPosition = modelMatrix * vec4(position.xyz*(scaleOffset/scaleCulling), 1.0);","vertex_viewdir = vec4(cameraPosition - vertex_wPosition.xyz, 0.0);","#if defined( USE_SHADOWMAP )","    worldPosition = vertex_wPosition;","#endif","vec4 vertex_normal = normalize(vec4(normal, 0.0));","vertex_wNormal = normalize(modelMatrix * vertex_normal);","mvNormal = vec3(vGetViewMatrix() * vertex_wNormal);","if (enableAutomaticFlip) {","vec4 labelUnitVecXWorldSpace = labelRotationMatrix * vec4(1.0, 0.0, 0.0, 1.0);","vec4 labelUnitVecXCameraSpace = vGetViewMatrix() * labelUnitVecXWorldSpace;","vec4 cameraUnitVecZCameraSpace = vec4(0.0, 0.0, 1.0, 1.0);","vec3 crossProduct = cross(cameraUnitVecZCameraSpace.xyz, labelUnitVecXCameraSpace.xyz);","if (crossProduct.x > 0.0) {","#ifdef USE_MAP","vUv = 1.0 - vUv;","#endif","}","}"].join("\n"),fragment_pars:"",fragment:""},m.label3D_PDSFX={attributes:{alphaTest:.1},uniforms:{normalDepthTexture:{type:"t",value:null},mapCity:{type:"t2",value:void 0},alphaTest:{type:"f",value:.1},switchDistance:{type:"f",value:0},scaleCulling:{type:"f",value:1},offsetAnchor:{type:"v3",value:e.Vector3()},labelRotationMatrix:{type:"m4",value:e.Matrix4()},enableAutomaticFlip:{type:"b",value:!1}},varyings:{normalW:{type:"v3"},colorW:{type:"v4"},isOpaque:{type:"f"}},VS_overridableFunctions:{ProcessClipSpacePosition:["// RenderingCrossQuad MAP - Read CrossQuad info","/////////////////////////////////////////////////","#ifdef IS_MULTI_INSTANCED","vec3 center = -offsetAnchor;","#else","vec3 center = -offsetAnchor;","#endif","colorW = color;","normalW = normal;","vec4 posCenterCameraSpace = vGetViewMatrix() * modelMatrix * vec4(center, 1.0);","posCenterCameraSpace /= posCenterCameraSpace.w;","vec4 posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;","posCenterScreenSpace /= posCenterScreenSpace.w;","// Compute offset to rescale the POI in screen space (fixed size)","float scaleOffset = -posCenterCameraSpace.z/switchDistance;","if (posCenterCameraSpace.z > -switchDistance)","{","   scaleOffset = 1.0;","}","if (switchDistance < 0.001)","{","   scaleOffset = -posCenterCameraSpace.z/1000.0;","}","vec4 posVertexCameraSpace = vGetViewMatrix() * modelMatrix * vec4(position.xyz, 1.0);","posVertexCameraSpace /= posVertexCameraSpace.w;","vec4 vectorCameraSpace = posVertexCameraSpace - posCenterCameraSpace;","vec4 mvPosition = posCenterCameraSpace + vec4(vectorCameraSpace.xyz*(scaleOffset/scaleCulling), 0.0);","ioPosition = vGetProjectionMatrix() * mvPosition; //vGetViewMatrix() * modelMatrix * vec4(position, 1.0);","vec4 vertex_wPosition = modelMatrix * vec4(position.xyz*(scaleOffset/scaleCulling), 1.0);","vec4 vertex_viewdir = vec4(cameraPosition - vertex_wPosition.xyz, 0.0);","#if defined( USE_SHADOWMAP )","    worldPosition = vertex_wPosition;","#endif","vec4 vertex_normal = normalize(vec4(normal, 0.0));","vec4 vertex_wNormal = normalize(modelMatrix * vertex_normal);","vec3 mvNormal = vec3(vGetViewMatrix() * vertex_wNormal);","normalW = mvNormal;","if (enableAutomaticFlip) {","vec4 labelUnitVecXWorldSpace = labelRotationMatrix * vec4(1.0, 0.0, 0.0, 1.0);","vec4 labelUnitVecXCameraSpace = vGetViewMatrix() * labelUnitVecXWorldSpace;","vec4 cameraUnitVecZCameraSpace = vec4(0.0, 0.0, 1.0, 1.0);","vec3 crossProduct = cross(cameraUnitVecZCameraSpace.xyz, labelUnitVecXCameraSpace.xyz);","if (crossProduct.x > 0.0) {","#ifdef USE_MAP","#endif","}","}"].join("\n")}},m.coloring_PDSFX={name:"coloring_PDSFX",depends:[],attributes:{},uniforms:{opacityCity:{type:"f",value:1}},FS_overridableFunctions:{ComputeOpacity:["cOpacity = opacityCity;"].join("\n")}},m.getCurrentDimensions=function(e){var t=e.USR.webGLV6Viewer;return{width:t.SCREEN_WIDTH,height:t.SCREEN_HEIGHT}},m._initMaterial=function(e){return r.is(this._matPoiText)||(this._matPoiText="billboard"===e?l.getPDSFXMaterial([m.coloring_PDSFX,m.labelBillboard_PDSFX],"basic"):l.getPDSFXMaterial([m.coloring_PDSFX,m.label3D_PDSFX],"physical")),this._matPoiText.clone()},m.generateTextNode=function(i,s,a,l,d,u,p,f,g=!1,y,v,b){s.label.name.length>50&&(s.label.name=s.label.name.substr(0,47)+"...");let x=this._initMaterial(s.label.position.mode);r.is(u)&&x.updatePDSFXUniform("switchDistance",u);var _=this.getCurrentDimensions(i),C={x:_.width/2,y:_.height/2};x.updatePDSFXUniform("halfScreenResolution",C),x.depthTest=!1,x.transparent=!0;var S=function(){var e={x:i.USR.webGLV6Viewer.SCREEN_WIDTH/2,y:i.USR.webGLV6Viewer.SCREEN_HEIGHT/2};x.updatePDSFXUniform("halfScreenResolution",e),i.USR._needRender=!0};i._frmViewerContainer.addEvent("resize",S),r.addObserver(x,function(){i._frmViewerContainer.removeEvent("resize",S)}),S();let D=h.computeLabelSize(s.label.name,s.label);var P=D.width,M=D.height,w=m.computeAnchorPointOffset(P,M,a,s.label.position.labelOffset);"3D"===s.label.position.mode&&(x.updatePDSFXUniform("offsetAnchor",w),x.updatePDSFXUniform("enableAutomaticFlip",s.label.position.enableAutomaticFlip));let T=new t,I={};I.material=x,I.bBox=new e.Box3(new e.Vector3(0,0,0),new e.Vector3(D.width,D.height,0)),I.setVisibilityOrCreate=function(t){if(!x.isLoading&&t){var a=function(t){if(x.updatePDSFXUniform("mapCity",t),"billboard"===s.label.position.mode){let i=x.getPDSFXUniform("labelSize").value,r=2*i.x,n=2*i.y,a=t.image.width,o=t.image.height,l=x.getPDSFXUniform("top").value,h=x.getPDSFXUniform("left").value;l+=(n-o)/2,h+=(r-a)/2,l-=n*s.label.position.labelOffset.y,l+=o*s.label.position.labelOffset.y,h-=r*s.label.position.labelOffset.x,h+=a*s.label.position.labelOffset.x,x.updatePDSFXUniform("labelSize",new e.Vector2(a/2,o/2)),x.updatePDSFXUniform("top",l),x.updatePDSFXUniform("left",h)}x._deferredMaterialsInit=!1,x.isLoaded=!0,x.needsUpdate=!0,i.USR._needRender=!0,b.removeChild(T);var a=o.createRectangleNode({width:t.image.width,height:t.image.height,color:new n.Color(1,.5,.5,1),fill:!0,material:x});T.observers=null,a.setMaterial(x),a.mesh3js.material=x,a.setShadow(!1,!1),x._deferredMaterialsInit=!1,r.is(this.visibilityToPut)&&(a.setVisibility(this.visibilityToPut),delete this.visibilityToPut),a.setMatrix(I.matrix),a.setFrustumCulled(!1),a.setExcludeFromBounding(!0),a.setPickable(n.PICKABLE),b.addChild(a);a.setRenderPasses(["LabelOverlayPostPass"]),g&&"billboard"===s.label.position.mode&&i.labelManager.replacePoi(I,a),this.setVisibilityOrCreate=function(e){this.visible!=e&&this.setVisibility(e)}.bind(this)}.bind(this);x.isLoading=!0,h.generateLabelTexture(s.label.name,s.label,a,1)}x.isLoaded?this.visible!=t&&this.setVisibility(t):this.visibilityToPut=t};if(void 0===i.getView3D().getRenderPassManager().getPass("LabelOverlayPostPass")){var A=new c(null,null,void 0,!0,!1,!1,"LabelOverlayPostPass");A.idString="LabelOverlayPostPass",i.getView3D().getRenderPassManager().addPass("LabelOverlayPostPass",A),i.getView3D().getRenderPassManager()._mainComposer.insertCustomPassAfterNEW(A,"noz")}if(s.label.position.mode,r.is(u)&&(x.updatePDSFXUniform("geometrySize",new e.Vector2(a.width,a.height)),x.updatePDSFXUniform("geometryOffset",s.label.position.geometryOffset)),"billboard"===s.label.position.mode)if("billboard"===d){var V=(new e.Matrix4).translate(new e.Vector3(l.x,l.y,l.z));if(x.updatePDSFXUniform("labelSize",new e.Vector2(P/2,M/2)),x.updatePDSFXUniform("_angle",r.toRad(s.label.position.rotation.x)),r.is(x.getPDSFXUniform("top").value)){var F=a.height/2-M/2;F+=M*s.label.position.labelOffset.y,F+=s.label.position.geometryOffset.y*a.height,F+=s.label.position.offset.y,x.updatePDSFXUniform("top",F)}if(r.is(x.getPDSFXUniform("left").value)){var N=-P/2;N+=P*s.label.position.labelOffset.x,N+=s.label.position.geometryOffset.x*a.width,N+=s.label.position.offset.x,x.updatePDSFXUniform("left",N)}}else if("polygon"===d){V=(new e.Matrix4).translate(new e.Vector3(l.x+s.label.position.geometryOffset.x*a.width,l.y+s.label.position.geometryOffset.y*a.length,l.z+s.label.position.geometryOffset.z*a.height));if(x.updatePDSFXUniform("labelSize",new e.Vector2(P/2,M/2)),x.updatePDSFXUniform("_angle",r.toRad(s.label.position.rotation.x)),r.is(x.getPDSFXUniform("top").value)){F=-M/2;F+=M*s.label.position.labelOffset.y,F+=s.label.position.offset.y,x.updatePDSFXUniform("top",F)}if(r.is(x.getPDSFXUniform("left").value)){N=-P/2;N+=P*s.label.position.labelOffset.x,N+=s.label.position.offset.x,x.updatePDSFXUniform("left",N)}}else{V=(new e.Matrix4).translate(new e.Vector3(l.x,l.y,l.z));if(x.updatePDSFXUniform("labelSize",new e.Vector2(P/2,M/2)),x.updatePDSFXUniform("_angle",r.toRad(s.label.position.rotation.x)),r.is(x.getPDSFXUniform("top").value)){F=a.height/2-M/2;F+=M*s.label.position.labelOffset.y,F+=s.label.position.geometryOffset.y*a.height,F+=s.label.position.offset.y,x.updatePDSFXUniform("top",F)}if(r.is(x.getPDSFXUniform("left").value)){N=-P/2;N+=P*s.label.position.labelOffset.x,N+=s.label.position.geometryOffset.x*a.width,N+=s.label.position.offset.x,x.updatePDSFXUniform("left",N)}}if("3D"===s.label.position.mode){V=(new e.Matrix4).translate(w);var O=(new e.Matrix4).rotateX(r.toRad(s.label.position.rotation.x)).rotateY(r.toRad(s.label.position.rotation.y)).rotateZ(r.toRad(s.label.position.rotation.z));V.multiplyMatrices(O,V),V.multiplyMatrices((new e.Matrix4).translate(new e.Vector3(l.x+s.label.position.geometryOffset.x*a.width+s.label.position.offset.x,l.y+s.label.position.geometryOffset.y*a.length+s.label.position.offset.y,l.z+a.height/2+s.label.position.geometryOffset.z*a.height+s.label.position.offset.z)),V),x.updatePDSFXUniform("labelRotationMatrix",V)}if(I.matrix=V,g&&"billboard"===s.label.position.mode){var E=l.z;"polygon"===d&&(E=(new e.Vector3).getPositionFromMatrix(V).z);var R=i.labelManager.addGroup(f,!0);!r.is(y)||"billboard"!==d&&"line"!==d&&"pyramid"!==d&&"sphere"!==d&&"tube"!==d&&"disc"!==d?i.labelManager.registerPOI(I,R,s.label.position.mode,E,(new e.Vector3).getPositionFromMatrix(V),p,void 0,v):i.labelManager.registerPOI(I,R,s.label.position.mode,l.z,(new e.Vector3).addVectors((new e.Vector3).getPositionFromMatrix(V),y),p,u,v),r.addObserver(T,function(){i.labelManager.unregisterPOI(T.temporaryTextNode),i._frmViewerContainer.removeEvent("resize",S)}),T.temporaryTextNode=I,b.addChild(T)}else I.setVisibilityOrCreate(!0);return I.name="textNode_"+p,I},m.computeAnchorPointOffset=function(t,i,s,r){var n=new e.Vector3(0,0,0);return n.x=n.x-t/2,n.y=n.y-i/2,n.x=n.x+t*r.x,n.y=n.y+i*r.y,n},m}),define("DS/XCityGeometry/PointOfInterest",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils"],function(e,t,i,s,r,n,a){"use strict";return t.extend({init:function(e,t,i,s,r,n,a,o,l){this._parentContent=t,this._urban=e,this.callback=null,this.visible=!1,this.mayVisible=!1,this.outside=!1,this.isSelected=!1,this.highlighted=!1,o||(o=e.poiManager.defaultStyle);var h=s.split(" "),c=h[0];this.poiData={className:c,text:r,iconClassName:n,style:o,classNames:h,description:l},this.worldPos=i,this.callback=void 0,this.userData=void 0,this.parentDiv=e.poiManager.parentDiv,this.textDiv=null,this.arrowDiv=null,this.divWidth=0,this.divHeight=0,this.arrowWidth=0,this.arrowHeight=0,this.isSelected=!1,this.highlighted=!1,this.create2DPOI(e),this._group=a,e.poiManager.registerPOI(this,a),this.updatePosition(e.USR.viewpoint)},setCallback:function(e){this.callback=e},setUserData:function(e){this.userData=e},display:function(){r.log(this.worldPos.position.z)},appearArrowOnly:function(){null!==this.arrowDiv&&(this.arrowDiv.style.opacity="1")},appear:function(){this.setVisible(!0),this.textDiv.classList.remove("fadeOut"),this.textDiv.classList.add("fadeIn"),this.textDiv.style.pointerEvents="auto",null!==this.arrowDiv&&(this.arrowDiv.style.opacity="1",this.arrowDiv.style.pointerEvents="auto")},disappear:function(e){this.textDiv.classList.remove("fadeIn"),this.textDiv.classList.add("fadeOut"),this.textDiv.style.pointerEvents="none",null!==this.arrowDiv&&(this.arrowDiv.style.opacity=void 0===e?"0.5":"0.0",this.arrowDiv.style.pointerEvents="auto")},appendTo:function(){this.parentDiv.appendChild(this.textDiv),null!==this.arrowDiv&&this.parentDiv.appendChild(this.arrowDiv),this.updateSize()},setVisibility:function(e){this.mayVisible=e,!1===this.mayVisible&&this.setVisible(!1)},setVisible:function(e){this.visible!==e&&(!0===e&&!0===this.mayVisible?(this.appendTo(),this.visible=!0):(this.remove(),this.visible=!1))},isVisible:function(){return this.visible},getVisibility:function(){return this.mayVisible},remove:function(){!0===this.visible&&(this.parentDiv.contains(this.textDiv)&&this.parentDiv.removeChild(this.textDiv),null!==this.arrowDiv&&this.parentDiv.removeChild(this.arrowDiv))},destroy:function(){this._urban.poiManager.unregisterPOI(this,this._group)},setPosition:function(e){this.worldPos=e},updatePosition:function(e){var t=e.getScreenPosition(this.worldPos),i=(this.divWidth,this.divHeight,this.poiData.style),s=t.x,r=t.y;if(this.outside=!1,null!==this.arrowDiv){var n=s-.5*this.arrowWidth,a=r-this.arrowHeight;this.arrowDiv.style.cssText+="; left: "+n+"px; top: "+a+"px;"}if(i){o=s;"center"===i.HPos?o-=.5*this.divWidth:"left"===i.HPos?o-=this.divWidth+.5*this.arrowWidth:"right"===i.HPos&&(o+=.5*this.arrowWidth);l=r;"center"===i.VPos?l-=this.arrowHeight+.5*this.divHeight:"top"===i.VPos?l-=this.divHeight+.8*this.arrowHeight:"bottom"===i.VPos&&(l-=this.divHeight-.8*this.arrowHeight)}else var o=s-.5*this.divWidth,l=r-(this.divHeight+.8*this.arrowHeight);if(this.textDiv.style.cssText+="; left: "+Math.ceil(o)+"px; top: "+Math.ceil(l)+"px;",t.z<-1||t.z>1)return this.disappear(!0),this.textDiv.style.cssText+="; left: -1000px; top: -1000px;",void(this.outside=!0);this.textDiv.cleft=o,this.textDiv.ctop=l,this.textDiv.cbottom=l+this.divHeight,this.textDiv.cright=o+this.divWidth},getParentDiv:function(){return this.parentDiv},updateSize:function(){var e=window.getComputedStyle(this.textDiv),t=isNaN(parseFloat(e.padding))?0:2*parseFloat(e.padding),i=isNaN(parseFloat(e.borderWidth))?0:2*parseFloat(e.borderWidth);if(this.divWidth=(isNaN(parseFloat(e.width))?0:parseFloat(e.width))+i+t,this.divHeight=(isNaN(parseFloat(e.height))?0:parseFloat(e.height))+i+t,null!==this.arrowDiv){var s=window.getComputedStyle(this.arrowDiv);t=isNaN(parseFloat(s.padding))?0:2*parseFloat(s.padding),i=isNaN(parseFloat(s.borderWidth))?0:2*parseFloat(s.borderWidth),this.arrowWidth=(isNaN(parseFloat(s.width))?0:parseFloat(s.width))+i+t,this.arrowHeight=(isNaN(parseFloat(s.height))?0:parseFloat(s.height))+i+t}},setText:function(e){var t;void 0!==this.poiData.iconClassName?(t=document.createElement("span")).className=this.poiData.iconClassName:t=document.createElement("p"),t.className="annotationStyle"===this.poiData.className?"annotationStyleSpan":"PoiSpan";var i=document.createTextNode(e);t.appendChild(i);var s=this.textDiv.getElementsByClassName("PoiSpan");s.length&&this.textDiv.removeChild(s[0]);var r=this.textDiv.getElementsByClassName("annotationStyleSpan");r.length&&this.textDiv.removeChild(r[0]),this.textDiv.appendChild(t),this.poiData.text=i,this.updateSize()},setDescription:function(e){a.is(e)&&(a.is(this.descriptionContainer)?this.descriptionContainer.setHTML(e):this.descriptionContainer=UWA.Element("div",{class:"POIDescription",html:e}).inject(this.textDiv),""===e?this.descriptionContainer.addClassName("empty-description"):this.descriptionContainer.removeClassName("empty-description"))},create2DPOI:function(t){void 0!==this.poiData.iconClassName&&(this.arrowDiv=e.createElement("div",{class:"arrow"}),this.arrowDiv.style.position="absolute",this.arrowDiv.style.visibility="visible");this.poiData.style;this.textDiv="annotationStyle"===this.poiData.className?e.createElement("div"):e.createElement("div",{class:"POIText"});for(var i=0;i<this.poiData.classNames.length;i++)this.textDiv.classList.add(this.poiData.classNames[i]);this.textDiv.style.position="absolute",this.textDiv.style.visibility="visible",this.setText(this.poiData.text),0===t.getView3D().frameId&&n.subscribeTo("/3DEXPERIENCity/onSceneReady",this.updateSize.bind(this),!0);var s=this;null!==this.arrowDiv&&(this.arrowDiv.onmouseover=function(e){s.isSelected||s.highlight(!0)},this.arrowDiv.onmouseout=function(e){s.isSelected||s.highlight(!1)},this.arrowDiv.onmousedown=function(e){e.stopPropagation(),t.poiManager.mouseDown(s,e)},this.arrowDiv.ondblclick=function(e){e.stopPropagation(),t.poiManager.mouseDblClick(s,e)}),this.textDiv.onmouseover=function(e){s._parentContent._itemParent.get("hoverable")&&(s._parentContent._itemParent.set("hovered",!0),s.isSelected||s.highlight(!0))},this.textDiv.onmouseout=function(e){s._parentContent._itemParent.get("hoverable")&&(s._parentContent._itemParent.set("hovered",!1),s.isSelected||s.highlight(!1))},this.textDiv.onclick=function(e){e.stopPropagation(),t.poiManager.mouseDown(s,e)},this.textDiv.ondblclick=function(e){e.stopPropagation(),t.poiManager.mouseDblClick(s,e)}},updateClassName:function(e){this.textDiv.className="annotationStyle"===this.poiData.className?e:"POIText "+e},select:function(e){e!==this.isSelected&&(this.isSelected=e,this.highlight(e))},highlight:function(e){e!==this.highlighted&&(this.highlighted=e,e?(this.textDiv.classList.remove("fadeOut"),this.textDiv.style.zIndex=1,this.textDiv.classList.add("fadeIn"),this.textDiv.classList.add(this.poiData.className+"Over"),null!==this.arrowDiv&&this.arrowDiv.classList.add("arrowOver")):(this.textDiv.style.zIndex="",this.textDiv.classList.remove(this.poiData.className+"Over"),null!==this.arrowDiv&&this.arrowDiv.classList.remove("arrowOver")))}})}),define("DS/XCityGeometry/RenderingHandlerPipe",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/XCityTools/Disposer","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/Debug","DS/XCityRendering/RenderingHandlerSpecific","DS/XCityTools/RenderingTools"],function(e,t,i,s,r,n,a,o){"use strict";var l=a.extend({init:function(e,t){this._parent(e)},getDefaultRendering:function(){return{side:e.DoubleSide}},_initMaterial:function(){if(!s.is(this._material)){this._material=r.getCustomShaderMaterial([r.common,r.clipPlanes,r.alphaTest,l._pipe,r.urbanLights]),this._material.force=!0,this._material.enableClipPlanes=!0;var e=this.defaultRendering.getRenderingData();o._setMaterialFromProfile(this._material,e),r.updateCommonUniforms(this._material)}return this._material},_getMaterial:function(){var e=this._parent(),t=this.getCompleteMaterialInfo();return o._setMaterialFromProfile(e,t),r.updateCommonUniforms(e),e}});return l._pipe={attributes:{vertexColors:!0},uniforms:{},vertex_pars:["// RenderingPipe - Varyings & Uniforms","// **************************************************","uniform float timer;","varying vec4 cq_color;"].join("\n"),vertex:["// RenderingPipe MAP - Read Pipe info","/////////////////////////////////////////////////","#ifdef USE_COLOR","cq_color = color;","#else","cq_color = vec4(1.0);","#endif","mvPosition = viewMatrix * (modelMatrix * vec4(position,1.0));","gl_Position = projectionMatrix * mvPosition;"].join("\n"),fragment_pars:["// RenderingPipe MAP - Varyings","// **************************************************","varying vec4 cq_color;"].join("\n"),fragment:["    gl_FragColor.a *= cq_color.a;","    #ifdef GAMMA_INPUT","       gl_FragColor.rgb *= cq_color.rgb * cq_color.rgb;","    #else","       gl_FragColor.rgb *= cq_color.rgb;","    #endif"].join("\n")},l}),define("DS/XCityGeometry/PatchVectorFactoryPipe",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/WebappsUtils/WebappsUtils","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityGeometry/RenderingHandlerPipe","DS/Mesh/MeshUtils","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/XCityGeometry/PatchVectorFactory"],function(e,t,i,s,r,n,a,o,l,h){"use strict";return h.extend({init:function(e,i){this._parent(e,i),this.urban=e,this.renderer=e.getView3D(),this.supportWorkers=!1,this.altitudeAttribute=i.altitudeAttribute?i.altitudeAttribute:"ALTITUDE",this.radiusAttribute=i.radiusAttribute?i.radiusAttribute:"RADIUS",this.stridAttribute=i.stridAttribute?i.stridAttribute:"STRID",this.colorAttribute=i.colorAttribute?i.colorAttribute:"COLOR",this._node=new t("FactoryPipe"),this._debugID=0,this._editable=!0,this.identifier=0,this._treeid=0,this.nbInfoPixels=1,this.isPickable=void 0===i.isPickable||i.isPickable,this._rendering=new n(e,i),l.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},destroy:function(){this.urban.USR.getScene().remove(this._node)},dispose:function(){o.warn("Dispose: UrbanPipe")},getData:function(t){this._treeid=0;var i=null;i=!0===this._editable?t.creator.compilePrimitive("Tree",!0):t.creator.compilePrimitive("Tree");var s=r.createMeshNode(i);s.setMatrix((new e.Matrix4).identity().setPosition(new e.Vector3(t.posTile.x,t.posTile.y,0))),this.isPickable?s.setPickable(a.PICKABLE):s.setPickable(a.NOPICKABLE);var n=t.tile.LOD+"_"+t.tile.I+"_"+t.tile.J+"_pipe";return s.name=n,s.mesh3js.name=n,s.trees=!0,s._debugID=this._debugID,s.setColor=function(e,t){for(var i=this.getBuffer(a.VertexComponentEnum.DIFFUSE_COLOR),s=t[0].start/12*8,r=0;r<8;r++)i[4*(r+s)]=e.r,i[4*(r+s)+1]=e.g,i[4*(r+s)+2]=e.b;return this.updateBuffer(a.VertexComponentEnum.DIFFUSE_COLOR,0,t[0].group.geometry.vertexPositionArray.length/3),this},s.setOpacity=function(e,t){for(var i=this.getBuffer(a.VertexComponentEnum.DIFFUSE_COLOR),s=t[0].start/12*8,r=0;r<8;r++)i[4*(r+s)+3]=e;return this.updateBuffer(a.VertexComponentEnum.DIFFUSE_COLOR,0,t[0].group.geometry.vertexPositionArray.length/3),this},this._rendering.initMesh(s),s.setRenderPasses(["UNDERGROUND_PREPASS","UNDERGROUND_POSTPASS"]),s},buildOne:function(t,i,r){var n,a,l,h,c,d=function(t,i){var s,r,n;return 0==(s=new e.Vector3(i.x-t.x,i.y-t.y,i.z-t.z)).z?r=new e.Vector3(0,0,1):0!=s.x||0!=s.y?r=s.z<0?new e.Vector3(s.x,s.y,(-s.x*s.x-s.y*s.y)/s.z):new e.Vector3(-s.x,-s.y,(s.x*s.x+s.y*s.y)/s.z):(s=new e.Vector3(0,0,1),r=new e.Vector3(1,0,0)),s.normalize(),r.normalize(),(n=new e.Vector3).crossVectors(s,r),[s,r,n]},u=function(t,i,s,r,n,a){for(var l,h,c,u,p,m,f,g,y,v,b=t.creator,x=t.posTile,_=s.length,C=new e.Vector3,S=new e.Vector3,D=[],P=[],M=0;M<8;++M)D[M]=Math.cos(2*M*Math.PI/8),P[M]=Math.sin(2*M*Math.PI/8);var w=!isNaN(r);b.startPrimitive();for(var T=0;T<_;++T){var I=w?r:s[T].z,A=I;T>0&&(A=w?r:s[T-1].z);var V=I;if(T<_-1&&(V=w?r:s[T+1].z),0===T){g=new e.Vector3(s[0].x-x.x,s[0].y-x.y,I),y=new e.Vector3(s[1].x-x.x,s[1].y-x.y,V),h=(l=d(g,y))[0],c=l[1],u=l[2];for(M=0;M<8;++M)S.addVectors(new e.Vector3(c.x*D[M],c.y*D[M],c.z*D[M]),new e.Vector3(u.x*P[M],u.y*P[M],u.z*P[M])),C.addVectors(g,new e.Vector3(S.x*n,S.y*n,S.z*n)),b.pushVertex([C.x,C.y,C.z]),b.pushNormal([S.x,S.y,S.z])}else if(T==_-1){g=new e.Vector3(s[T-1].x-x.x,s[T-1].y-x.y,A),y=new e.Vector3(s[T].x-x.x,s[T].y-x.y,I),h=(l=d(g,y))[0],c=l[1],u=l[2];for(M=0;M<8;++M)S.addVectors(new e.Vector3(c.x*D[M],c.y*D[M],c.z*D[M]),new e.Vector3(u.x*P[M],u.y*P[M],u.z*P[M])),C.addVectors(y,new e.Vector3(S.x*n,S.y*n,S.z*n)),b.pushVertex([C.x,C.y,C.z]),b.pushNormal([S.x,S.y,S.z])}else{g=new e.Vector3(s[T-1].x-x.x,s[T-1].y-x.y,A),v=new e.Vector3(s[T].x-x.x,s[T].y-x.y,I),y=new e.Vector3(s[T+1].x-x.x,s[T+1].y-x.y,V),h=(l=d(g,v))[0],c=l[1],u=l[2],p=(l=d(v,y))[0],m=l[1],l[2],T==_-2&&o.log("break"),h.add(p).multiplyScalar(.5),c.add(m).multiplyScalar(.5),u.crossVectors(h,c),f=1/Math.abs(h.x*p.x+h.y*p.y+h.z*p.z);for(M=0;M<8;++M)S.addVectors(new e.Vector3(c.x*D[M],c.y*D[M],c.z*D[M]),new e.Vector3(u.x*P[M],u.y*P[M],u.z*P[M])),C.addVectors(v,new e.Vector3(S.x*n*f,S.y*n*f,S.z*n)),b.pushVertex([C.x,C.y,C.z]),b.pushNormal([S.x,S.y,S.z])}}for(T=0;T<_-1;++T)for(var F=0;F<8;++F)b.pushVertexIndices([8*T+F,8*T+(F+1)%8,8*(T+1)+F]),b.pushColor([a.r,a.g,a.b,1]),b.pushVertexIndices([8*T+(F+1)%8,8*(T+1)+(F+1)%8,8*(T+1)+F]),b.pushColor([a.r,a.g,a.b,1]);b.endPrimitive(i)}.bind(this);n=t.getAttribute(this.stridAttribute),a=t.getGeometry().vertexList,l=new e.Color(t.getAttribute(this.colorAttribute)||this.colorAttribute||16777215),((c=t.getAttribute(this.radiusAttribute))<.1||void 0===c)&&(c=.1);var p=Number(this.altitudeAttribute);if(isNaN(p)){var m=Number(t.getAttribute(this.altitudeAttribute));h=isNaN(m)?-10:m}else h=p;void 0===i.posTile&&(i.posTile=new e.Vector2(Math.round(a[0].x),Math.round(a[0].y))),i.posTile,void 0===i.creator&&(i.creator=new s({indexed:!0,normalBinding:s.Binding.VERTEX,useTexCoord:!1,useColor:!0,colorBinding:s.Binding.FACE})),void 0===i.bSphere&&(i.bSphere=new e.Sphere,i.bSphere.center.z=isNaN(h)?0:h),u(i,n,a,h,c,l)}})}),define("DS/XCityGeometry/PatchVectorFactoryPointGeometry",["UWA/Core","DS/XCityGeometry/PatchVectorFactory","DS/XCityGeometry/Label","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t,i,s,r){"use strict";return t.extend({init:function(e,t,i){this._parent(e,t,i)},_computeAltitudeToApply:function(e,t){var i=0;return i=3===t.length&&"geometry"===e.elevationMode?t[2]:"advanced"===e.elevationMode||"geometry"===e.elevationMode?e.elevation:this.urban.USR.getGroundHeight(t[0],t[1]),e.elevationOffset&&(i+=e.elevationOffset),i},_generateLabel:function(e,t,s,r,n,a,o){var l=!1,h=void 0;if(Utils.is(this._node.userData)&&(l=!0,h=this._node.userData._attributes.id),this.labelManagerVisibility||(this.labelManagerVisibility=!0,this._node.userData.addEvent("onChange:visible",this.urban.labelManager.onChangeVisibility,this)),"FactoryPointOfInterest3D"===this._node.name)var c=this.switchDistance,d=this.factoryParam.shapeType;return i.generateTextNode(this.urban,s,r,e,d,c,t,h,l,n,a,o)}})}),define("DS/XCityGeometry/PatchVectorFactoryPointOfInterest",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PatchVectorFactoryPointGeometry","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/XCityModel/Folder","DS/XCityModel/Feature","DS/XCityModel/PointOfInterest","DS/XCityLayer/Vector","DS/XCityTools/EventDispatcher"],function(e,t,i,s,r,n,a,o,l,h,c){"use strict";return i.extend({init:function(e,t,i){this._parent(e,t,i),this.urban=e,this.color=t.color||"#ffffff",this.groupId=i,this.attrName=void 0!==t.attributName?t.attributName:"NAME",this.attrClass=void 0!==t.attributClass?t.attributClass:"STYLECLASS",this.attrAltitude=void 0!==t.attributAltitude?t.attributAltitude:"ALTITUDE",this.attrContent=void 0!==t.attributContent?t.attributContent:"CONTENT",this.stridAttribute=void 0!==t.stridAttribute?t.stridAttribute:"STRID",this.privateFolder=this.urban._dataModelPrivate.findChildById("vector_poi"),void 0===this.privateFolder&&(this.privateFolder=new a({id:"vector_poi",name:"vector_poi",visible:!0,opened:!1}),this.urban._dataModelPrivate.addChild(this.privateFolder)),this._node=new s,this._node.add=this.addToScene.bind(this),this._node.remove=this.removeFromScene.bind(this),this._node.setVisibility=function(){},this._node.name="FactoryPointOfInterrest",c.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},destroy:function(){},dispose:function(){n.warn("Dispose: PatchVectorFactoryPointOfInterest")},addToScene:function(e){var t,i;if(this._node.addChild(e),e&&e.pois)for(t=0,i=e.pois.length;t<i;++t)e.pois[t].setVisible(!0)},removeFromScene:function(e){var t,i;if(this._node.removeChild(e),e&&e.pois)for(t=0,i=e.pois.length;t<i;++t)e.pois[t].setVisible(!1)},initMesh:function(e,t,i,s,r){},getData:function(e){var t=new s;return t.name="FakeNode3DPerPOI2DTile",t.pois=e.pois,t},buildOne:function(e,i,s){void 0===i.pois&&(i.pois=[]);var r=e.getGeometry();if(r.type===h.Type.POINT){var n,a=r.getVertices(),c=e.getAttribute(this.attrName),d=e.getAttribute(this.attrClass),u=(Number(e.getAttribute(this.attrAltitude)),e.getAttribute(this.attrContent)),p=new l({groupId:this.groupId,altitudeMode:"relative",position:new t.Vector3(a[0],a[1],0),classStyle:d});for(n in void 0!==p.userData&&null!==p.userData||(p.userData={content:u}),s.userData)void 0!==p.userData[n]?p.userData[n]=[p.userData[n],s.userData[n]]:p.userData[n]=s.userData[n];var m=new o({id:c,name:c,visible:!1});m.set("Content",p),i.pois.push(m),this.privateFolder.addChild(m)}},select:function(e){var t=this;this.privateFolder&&this.privateFolder.traverse(function(i){i.getContent().get("groupId")===t.groupId&&i.getContent()._select(e)})},hoverable:function(e){var t=this;this.privateFolder&&this.privateFolder.traverse(function(i){i.getContent().get("groupId")===t.groupId&&i.set("hoverable",e.get("hoverable"))})},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1}})}),define("DS/XCityGeometry/LineBuilder",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityGeometry/Line","DS/XCityRendering/RenderingHandlerLine","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityTools/TextureTools","DS/XCityTools/Debug","DS/XCityTools/ShaderTools","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils","DS/XCityLayer/Vector"],function(e,t,i,s,r,n,a,o,l,h,c,d){"use strict";var u=e.extend({init:function(e,t,r){this.urban=e,this.nbLines=0,this.nbInfoPix=Object.keys(i.BUFFER_IMAGE).length,this.creators=this._createElements(),this._rendering=void 0===t?new s(e,r):t;var n=this._rendering.getCompleteMaterialInfo(),a=(n.dynamicUpdate,n.animation);c.is(a)&&!0===a.enable&&(this.clockTime=0,this.tokenUpdateEvent=h.subscribeTo("/3DEXPERIENCity/onUpdate",this._update.bind(this)))},dispose:function(){o.warn("Dispose: LINE BUILDER"),this.tokenUpdateEvent&&h.unsubscribe(this.tokenUpdateEvent)},_update:function(e){if(this.clockTime+=e.clockDelta,void 0!==this._rootNode){h.publish("/xCity/needRender",this);for(var t=0;t<this._rootNode.children.length;++t){var i=this._rootNode.children[t].material;c.is(i)&&i.getPDSFXUniform("clockTime")&&i.updatePDSFXUniform("clockTime",this.clockTime)}}},_updateOnDistance:function(){if(void 0!==this._lineSet){var e,t,i,s=Object.keys(this._lineSet),r=s.length;for(e=0;e<r;e++){t=s[e];var n=this._lineSet[t];for(i=0;i<n.length;i++){n[i]._updateOnDistance()}}}},getData:function(e,t,i,s){if(s){this.creators.textureInfo=s.textureInfoCreator;var n=new r({indexed:!0,useNormal:!1,useColor:!0,useTexCoord:!1});Object.assign(n,s.lineCreator);for(var o=0;o<n.primitiveList.length;o++){var l=n.primitiveList[o];l.attr.fill.isEqual=function(e){return!0},l.attr.line.isEqual=function(e){return!0},l.attr.point.isEqual=function(e){return!0}}this.creators.lineMesh=n}this.creators.textureInfo.texture=a.createTexture(this.creators.textureInfo),this._lineSet=e,this._refMesh=this._compileMesh(this.creators.lineMesh,this.creators.textureInfo,"CBN5_LINE",e);var h=this._rendering.initMeshes(this._refMesh,i);this._rootNode=t;for(o=0;o<h.length;++o)h[o].lineBuilder=this,t.addChild(h[o]);return t.lineBuilder=this,h},setDynamicUpdate:function(e){},_updateUniform(e,t){if(this._rootNode)for(var i,s=0;s<this._rootNode.children.length;++s)(i=this._rootNode.children[s].material)&&i.updatePDSFXUniform(e,t)},setDynamicUpdate:function(e){this._updateUniform("dynamicUpdate",e)},setMinDist:function(e){this._updateUniform("minDist",e)},setMaxDist:function(e){this._updateUniform("maxDist",e)},setMinWidth:function(e){this._updateUniform("minWidth",e)},setRenderMode:function(e){this._rendering._renderMode},setAnimation:function(e,t){var i;if(c.is(e)&&!0===e.enable){if(void 0===this.tokenUpdateEvent){for(i=0;i<t.children.length;++i)this._rendering._refreshMaterial(t.children[i]);this.clockTime=0,this.tokenUpdateEvent=h.subscribeTo("/3DEXPERIENCity/onUpdate",this._update.bind(this))}if(t.children.length>0){var s,r=Object.keys(e),n=r.length;for(i=0;i<n;i++)s=r[i],t.children[0].setAttribute(s,e[s])}}else if(void 0!==this.tokenUpdateEvent){for(i=0;i<t.children.length;++i)this._rendering._refreshMaterial(t.children[i]);h.unsubscribe(this.tokenUpdateEvent),this.tokenUpdateEvent=void 0}},_prepareWebWorkerLine:function(e){this._isWebWorkerLine(e)&&(e._rendering.getIndexFromPatternn||(e._rendering=this._rendering),e.setRendering||Object.setPrototypeOf(e,i.prototype))},_isWebWorkerLine:function(e){return e&&e.isWebWorkerLine},_compileMesh:function(e,t,r,a){var l=e.compilePrimitive(r,!1),h=n.createMeshNode(l);h.name=r,h.mesh3js.name=r,h._rendering=this._rendering,h.textureInfo={texture:t.texture,idMap:t.idMap};var d=this;return h.setAttribute=function(e,t,r){var n,l,h,p;if(i.attributeSetter[e]){var m;if(void 0!==r)for(n=0;n<r.length;++n)if(h=a[r[n].getCgmId()],c.is(h))for(l=0;l<h.length;l++)p=h[l],d._prepareWebWorkerLine(p),m=p.setFlaggedAttribute(e,t,r[n]);else o.warn("lineManipulators[pList["+n+"].getCgmId() is undefined");else{var f,g=Object.keys(a),y=g.length;for(n=0;n<y;n++)for(f=g[n],h=a[f],l=0;l<h.length;l++)p=h[l],d._prepareWebWorkerLine(p),p.setAttribute(e,t,void 0)}return m}return s.attributeSetter[e]?this._rendering.setAttribute(e,t):u.attributeSetter[e]?this.lineBuilder.setAttribute(e,t):void 0},h.get=function(e,t){var i=a[t[0].getCgmId()];if(c.is(i))return i[0][e]},h.resetFlags=function(e,t){var i,s,r,n;if(void 0!==e)for(i=0;i<e.length;++i)if(r=a[t],c.is(r))for(s=0;s<r.length;s++)n=r[s],d._prepareWebWorkerLine(n),n._setFlags(0)},h.setRendering=function(e,t,i){if(this.resetFlags([t],i),c.is(e))for(var s=Object.keys(e),r=s.length,n=[t],a=0;a<r;a++){var o=s[a],l=e[o];c.is(l)&&this.setAttribute(o,l,n)}},h},buildOne:function(e,t,s,r,n){var a;"string"==typeof e?a=e:(a=e.strid,this._initBSphereAndPosSize(e,t)),void 0!==r&&!0===r&&(a=a.concat("_"+this.nbLines));var o=this.nbLines,l=this.creators.textureInfo;c.is(l.idMap[a])&&(o=l.idMap[a]-1);var h=new i(this.urban,{id:a,numLine:o,creators:this.creators,geom:t,rendering:this._rendering,coordinates:s,attributes:n});return this.nbLines+=1,this._updatesInfoTextures(a,n,h),h},_initBSphereAndPosSize:function(e,i){for(var s={minX:99999999,minY:99999999,maxX:-99999999,maxY:-99999999},r=new t.Sphere,n=0;n<i.getNumGeometries();++n){d.getVerticesAsArrayOfLines(i,n).forEach(function(e){s.minX=Math.min(e.x,s.minX),s.minY=Math.min(e.y,s.minY),s.maxX=Math.max(e.x,s.maxX),s.maxY=Math.max(e.y,s.maxY)})}return r.radius=Math.sqrt(Math.pow(s.maxX-s.minX,2)+Math.pow(s.maxY-s.minY,2))/2,r.center.x=(s.minX+s.maxX)/2,r.center.y=(s.minY+s.maxY)/2,r.center.z=0,e.bSphere=r,e.posSize.width=s.maxY-s.minY,e.posSize.length=s.maxX-s.minX,e},_updatesInfoTextures:function(e,t,i){var s=this._rendering.getRenderingValues(e,t),r=this._rendering.getPrimitiveRenderingValues(e,t),n=this.creators.textureInfo,a=n.data,o=0,l=1,h=s.dashPattern;c.is(h)&&(o=this._rendering.getIndexFromPattern(h),l=h[h.length-1]),s.opacity<1&&(i.isTransparent=!0),a[1]=this.nbLines,a.push(s.color.r),a.push(s.color.g),a.push(s.color.b),a.push(s.lineWidth),a.push(s.opacity),a.push(s.opacityFactor),a.push(s.animation&&s.animation.speed||10),a.push(s.animation&&s.animation.nbPoints||1),a.push(s.animation&&s.animation.offest||0),a.push(s.animation&&!0===s.animation.reverse?1:0),a.push(s.animation&&s.animation.dashSize||10),a.push(s.animation&&s.animation.samplingRate||0),a.push(s.animation&&s.animation.minOpacity||.1),a.push(s.animation&&s.animation.gapSize||10),a.push(s.animation&&!1===s.animation.loop?0:1);var d=i.getFlagsFromPrimitiveRendering(r);a.push(d),a.push(o),a.push(l),c.is(n.idMap[e])||(n.idMap[e]=n.ySize),n.ySize+=1},_createElements:function(){var e,i=[];for(i.push(this.nbInfoPix),i.push(0),i.push(1),i.push(0),e=0;e<this.nbInfoPix-4;e+=1)i.push(0);return{lineMesh:new r({indexed:!0,useNormal:!1,useColor:!0,useTexCoord:!1}),textureInfo:{name:"lines_textureInfo",idMap:{},filter:t.NearestFilter,format:t.LuminanceFormat,xSize:this.nbInfoPix,ySize:1,data:i}}},setAttribute:function(e,t){this[u.attributeSetter[e]](t)}});return u.attributeSetter={dynamicUpdate:"setDynamicUpdate",minDist:"setMinDist",maxDist:"setMaxDist",minWidth:"setMinWidth"},u.getSettableAttributes=function(){var e,t=[];for(e in u.attributeSetter)u.attributeSetter.hasOwnProperty(e)&&t.push(e);return t.concat(i.getSettableAttributes().concat(s.getSettableAttributes()))},u}),define("DS/XCityGeometry/PatchVectorFactoryLineStringGeometry",["UWA/Core","DS/XCityGeometry/PatchVectorFactory","DS/XCityGeometry/Label","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t,i,s,r){"use strict";return t.extend({init:function(e,t,i){this._parent(e,t,i)},_computeAltitudeToApply:function(e,t){var i=0;return i=Utils.is(t.z)&&"geometry"===e.elevationMode?t.z:"advanced"===e.elevationMode||"geometry"===e.elevationMode?e.elevation:this.urban.USR.getGroundHeight(t.x,t.y),e.elevationOffset&&(i+=e.elevationOffset),i},_generateLabel:function(e,t,s,r,n,a,o){var l=void 0,h=!1;return Utils.is(this._node.userData)&&(h=!0,l=this._node.userData._attributes.id),this.labelManagerVisibility||(this.labelManagerVisibility=!0,this._node.userData.addEvent("onChange:visible",this.urban.labelManager.onChangeVisibility,this)),i.generateTextNode(this.urban,s,r,e,"line",void 0,t,l,h,n,a,o)}})}),define("DS/XCityGeometry/PointOfInterestManager",["UWA/Core","UWA/Class","UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityGeometry/PointOfInterest","DS/XCityTools/EventDispatcher","css!DS/XCityGeometry/assets/style/annotation.css"],function(e,t,i,s,r,n,a){"use strict";return t.extend(i,{init:function(e){this.urban=e,this.createParentDiv(),this.maxVisible=-1,this.cCollision=!0,this.cDistance=!0,this.groups={},this.currentGroup=null,this.pois=[],this.defaultStyle={HPos:"center",VPos:"top"},a.subscribeTo("/3DEXPERIENCity/onUpdate",this.update.bind(this)),this.urban.USR.viewpoint.addEvent("onCameraStopped",this.check.bind(this))},reset:function(){for(var e in this.maxVisible=-1,this.cCollision=!0,this.cDistance=!0,this.removeAll(),this.groups)this.removeGroup(e)},setup:function(e){void 0!==e&&(void 0!==e.maxVisible&&(this.maxVisible=e.maxVisible),void 0!==e.checkCollision&&(this.cCollision=e.checkCollision),void 0!==e.checkDistance&&(this.cDistance=e.checkDistance))},addGroup:function(e,t){if(void 0===this.groups[e]){var i={name:e,pois:new Array};this.groups[e]=i}return void 0!==t&&!0===t&&this.setCurrentGroup(e),this.groups[e]},setCurrentGroup:function(e){void 0!==this.groups[e]&&(this.currentGroup=this.groups[e])},createParentDiv:function(){this.parentDiv=e.createElement("div",{id:"POI-manager-div",class:"POImanager",styles:{position:"absolute",width:"100%",height:"100%",top:"0px",left:"0px","pointer-events":"none"}}),this.parentDiv.inject(this.urban.viewerContainer)},update:function(e,t){for(var i=Object.keys(this.groups),s=0,r=i.length;s<r;s++)for(var n=0,a=this.groups[i[s]].pois.length;n<a;n++)this.groups[i[s]].pois[n].updatePosition(this.urban.USR.viewpoint)},removeAll:function(){for(this.pois=[];this.parentDiv.hasChildNodes();)this.parentDiv.removeChild(this.parentDiv.lastChild)},removeGroup:function(e){var t=this.currentGroup;void 0!==e&&(t=this.groups[e]);for(var i=0;i<t.pois.length;i++)t.pois[i].remove();t.pois=[],this.groups[e]=void 0,delete this.groups[e],this.check(!1)},display:function(){for(var e=Object.keys(this.groups),t=0,i=e.length;t<i;t++)for(var s=0,r=this.groups[e[t]].pois.length;s<r;s++)this.groups[e[t]].pois[s].display()},check:function(e){for(var t=Object.keys(this.groups),i=0,s=t.length;i<s;i++){this.groups[t[i]].displayed=[];for(var r=0,n=this.groups[t[i]].pois.length;r<n;r++){var a=this.groups[t[i]].pois[r];a.getVisibility()&&this.checkDistance(a)&&(this.maxVisible>0?this.groups[t[i]].displayed.length<this.maxVisible?this.checkCollision(this.groups[t[i]].displayed,a):a.disappear():this.checkCollision(this.groups[t[i]].displayed,a))}}},checkDistance:function(e){if(!this.cDistance)return!0;var t=this.urban.getViewpoint().getPosition(),i=new s.Vector2(t.x,t.y),r=new s.Vector2(e.worldPos.x,e.worldPos.y),n=(new s.Vector2).subVectors(i,r),a=.5+.5*(1-this.urban.getViewpoint().getRotationAngle().y/(.5*Math.PI));return n.length()<10*a*t.z||(e.disappear(),!1)},registerPOI:function(e,t){void 0===t&&void 0!==this.currentGroup?this.currentGroup.pois.push(e):t.pois.push(e)},unregisterPOI:function(e,t){var i;void 0===t&&void 0!==this.currentGroup?(i=this.currentGroup.pois.indexOf(e))>-1&&this.currentGroup.pois.splice(i,1):(i=t.pois.indexOf(e))>-1&&t.pois.splice(i,1)},mouseDown:function(e,t){this.dispatchEvent("onMouseDown",[e,t])},mouseDblClick:function(e,t){this.dispatchEvent("onMouseDblClick",[e,t])},intersect2DBox:function(e,t){return!(t.textDiv.cleft>e.textDiv.cright||t.textDiv.cright<e.textDiv.cleft||t.textDiv.ctop>e.textDiv.cbottom||t.textDiv.cbottom<e.textDiv.ctop)},checkCollision:function(e,t){if(!this.cCollision)return t.appear(),void e.push(t);if(0===e.length)t.appear(),e.push(t);else{for(var i=!1,s=0;s<e.length;s++)if(this.intersect2DBox(e[s],t)&&e[s]!==t){i=!0,t.disappear();break}!1===i&&(t.appear(),e.push(t))}}})}),define("DS/XCityGeometry/LabelManager",["UWA/Core","UWA/Class","UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityGeometry/PointOfInterestManager","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils"],function(e,t,i,s,r,n,a,o){"use strict";class l{constructor(e){if("function"!=typeof e.pointInterfaceGetX)throw new TypeError("Provided point object does not fulfill the contract: no pointInterfaceGetX method.");if("function"!=typeof e.pointInterfaceGetY)throw new TypeError("Provided point object does not fulfill the contract: no pointInterfaceGetY method.");this.pointInterfaceGetX=e.pointInterfaceGetX,this.pointInterfaceGetY=e.pointInterfaceGetY}get x(){let e=this.pointInterfaceGetX();if("number"!=typeof e)throw new TypeError("x value for point is NaN when calling the pointInterfaceGetX method.");return e}get y(){let e=this.pointInterfaceGetY();if("number"!=typeof e)throw new TypeError("y value for point is NaN when calling the pointInterfaceGetY method.");return e}}class h{constructor(e,t,i,s){this.x=e,this.y=t,this.width=i,this.height=s}contains(e){return!(e.x<this.x||e.x>this.x+this.width||e.y<this.y||e.y>this.y+this.height)}overlaps(e){return e.x+e.width>this.x&&this.x+this.width>e.x&&e.y+e.height>this.y&&this.y+this.height>e.y}}class c{constructor(e,t,i,s,r=!1){this.nodeCapacityDefault=32,this.maxDepthDefault=32,this.box=e,this.nodeCapacity=t||this.nodeCapacityDefault,this.maxDepth=i||this.maxDepthDefault,this.northWest=null,this.northEast=null,this.southWest=null,this.southEast=null,this.points=new Array,this.level=s||0,this.sortPointsByPriority=r}removePoint(e,t){if(null===this.northWest){let t=this.points.find(t=>t.poi===e);return t?this.points.splice(this.points.indexOf(t),1):null}return this.northWest.box.contains(t)?this.northWest.removePoint(e,t):this.northEast.box.contains(t)?this.northEast.removePoint(e,t):this.southWest.box.contains(t)?this.southWest.removePoint(e,t):this.southEast.box.contains(t)?this.southEast.removePoint(e,t):null}replacePoint(e,t,i){if(null===this.northWest){let i=this.points.find(t=>t.poi===e);return i?i.poi=t:null}return this.northWest.box.contains(i)?this.northWest.replacePoint(e,t,i):this.northEast.box.contains(i)?this.northEast.replacePoint(e,t,i):this.southWest.box.contains(i)?this.southWest.replacePoint(e,t,i):this.southEast.box.contains(i)?this.southEast.replacePoint(e,t,i):null}insertPoint(e){let t=function(e,i,s,r){if(s>r)return s;let n=Math.floor((s+r)/2);return e[n].priority===i.priority?n:e[n].priority>i.priority?t(e,i,s,n-1):t(e,i,n+1,r)};if(!this.box.contains(e))return!1;if(this.points.length<this.nodeCapacity&&null===this.northWest){if(!this.sortPointsByPriority||0===this.points.length)return this.points.push(e),!0;let i=t(this.points,e,0,this.points.length-1);return this.points.splice(i,0,e),!0}return null===this.northWest&&this.subdivide(),!!(this.northWest.insertPoint(e)||this.northEast.insertPoint(e)||this.southWest.insertPoint(e)||this.southEast.insertPoint(e))}insertPoints(e){for(let t in e)this.insertPoint(e[t])}subdivide(){let e=this.box.width/2,t=this.box.height/2,i=new h(this.box.x,this.box.y,e,t),s=new h(this.box.x+e,this.box.y,e,t),r=new h(this.box.x,this.box.y+t,e,t),n=new h(this.box.x+e,this.box.y+t,e,t);this.northWest=new c(i,this.nodeCapacity,this.maxDepth,this.level+1,this.sortPointsByPriority),this.northEast=new c(s,this.nodeCapacity,this.maxDepth,this.level+1,this.sortPointsByPriority),this.southWest=new c(r,this.nodeCapacity,this.maxDepth,this.level+1,this.sortPointsByPriority),this.southEast=new c(n,this.nodeCapacity,this.maxDepth,this.level+1,this.sortPointsByPriority),this.insertPoints(this.points),this.points=new Array}printDebug(e,t){if(e=e||c.maxDepthDefault,this.level>e)return;let i="";for(let e=0;e<this.level;e++)e+1===this.level?i+="|---":i+="|   ";if(i+="level["+this.level+"]",this.points.length>0){i+=" ["+this.points.length+" node(s)]\n";for(let e=0;e<this.level&&(e+1!==this.level||!t);e++)i+="|   ";i+="\n"}else{i+="\n";for(let e=0;e<=this.level;e++)i+="|   ";i+="\n"}return null!==this.northWest&&(i+=this.northWest.printDebug(e,!1),i+=this.northEast.printDebug(e,!1),i+=this.southWest.printDebug(e,!1),i+=this.southEast.printDebug(e,!0)),i}getLeaves(e){return e=e||[],null===this.northWest?(e.push(this.points),e):(e=this.northWest.getLeaves(e),e=this.northEast.getLeaves(e),e=this.southWest.getLeaves(e),e=this.southEast.getLeaves(e))}getValuesFromBBox(e,t){return t=t||[],this.box.overlaps(e)?null===this.northWest?(t.push(this.points),t):(t=this.northWest.getLeaves(t),t=this.northEast.getLeaves(t),t=this.southWest.getLeaves(t),t=this.southEast.getLeaves(t)):t}getValuesFromFrustum(e,t,i){if(t=t||[],!function(e,t){for(let i=0;i<6;i++){const r=t[i];let n=new s.Vector3;if(n.x=r.normal.x>0?e.max.x:e.min.x,n.y=r.normal.y>0?e.max.y:e.min.y,n.z=r.normal.z>0?e.max.z:e.min.z,r.distanceToPoint(n)<0)return!1}return!0}({max:{x:this.box.x+this.box.width,y:this.box.y+this.box.height,z:1e4},min:{x:this.box.x,y:this.box.y,z:-1e4}},e.planes))return t;if(null===this.northWest){let s=new Array;for(let t=0;t<this.points.length;t++)e.containsPoint(this.points[t].poi.pos3D)&&this.points[t].poi.group.visible&&!this.points[t].poi.isHidden&&s.push(this.points[t]);return s.length>0&&(i?t.splice(Math.floor(314159*s.length%t.length),0,s):t.push(s)),t}return t=this.northWest.getValuesFromFrustum(e,t,i),t=this.northEast.getValuesFromFrustum(e,t,i),t=this.southWest.getValuesFromFrustum(e,t,i),t=this.southEast.getValuesFromFrustum(e,t,i)}}return n.extend({init:function(e){this.urban=e,this.groups=[],a.subscribeTo("/3DEXPERIENCity/onUpdate",this.handleOpacity.bind(this)),a.subscribeTo("/3DEXPERIENCity/onUpdate",this.check.bind(this)),this.fadingTime=.7,this.fadeOutFactor=3,this.startFadeIn=!0,this._debugBbox=!1,this._debugBboxWidth=2,this._labelsToFadeIn=new Map,this._labelsToFadeOut=new Map,this._visibleLabels=new Map,this._lastFrameVisibleLabels=new Map,this._quadTree=null,a.subscribeTo("/3DEXPERIENCity/onReset",this._resetQuadtree.bind(this))},_resetQuadtree:function(){this._quadTree=null},enableDebugBbox:function(e,t=1){this._debugBbox=e,e||this.clearCanvasBbox(),this._debugBboxWidth=t},addGroup:function(e,t){if(void 0===this.groups[e]){var i=this._parent(e,t);i.layer=xCity.findItem({id:e}),i.visible=!0,this.sortGroups()}return this.groups[e]},onChangeVisibility:function(e,t){var i=e.id,s=this.urban.labelManager;o.is(s.groups[i])&&(s.groups[i].visible=t,s._needCheck=!0)},onChangeVisibilityPrimitive:function(e,t){var i=e.getContent()._getStrid(),s=e.getContent()._layer.parentFeatureID,r=this.groups[s];if(o.is(r)){var n=r.pois.find(e=>e.name==="textNode_"+i);o.is(n)&&(n.setVisibilityOrCreate(t),n.isHidden=!t,this._needCheck=!0)}},sortGroups:function(){this.groups=Object.fromEntries(Object.entries(this.groups).sort(([,e],[,t])=>e.layer.get("levelMin")-t.layer.get("levelMin")))},_generateLabelPriority:function(e){if(!e)return-1e5;if(e.streamPriority&&!isNaN(e.streamPriority))return e.streamPriority;let t=0;e.priority&&(t=(Math.min(500,e.priority)-1)/499);let i=-50;return(e.levelMin||0===e.levelMin)&&(i=-e.levelMin),100*i+10*t},registerPOI:function(e,t,i,s,r,n,a,d){var u=t.pois.find(e=>e.name==="textNode_"+n);if(o.is(u)&&u.observers){for(var p=u.observers.length,m=0;m<p;m++)u.observers[m](u);u.observers=null}if(!this._quadTree){let e,t=xCity._urbanImpl;if(!o.is(t.worldSize))return void console.error("No worldSize information for referential: can't compute label positions");{let i=t.shiftedPosition&&t.shiftedPosition.x?t.shiftedPosition.x:0,s=t.shiftedPosition&&t.shiftedPosition.y?t.shiftedPosition.y:0;e={xmin:i,xmax:i+t.worldSize,ymin:s,ymax:s+t.worldSize}}let i=new h(e.xmin,e.ymin,e.xmax-e.xmin,e.ymax-e.ymin),s=32,r=32,n=!0,a=0;this._quadTree=new c(i,s,r,a,n)}let f={x:r.x,y:r.y},g={pointInterfaceGetX:function(){return f.x},pointInterfaceGetY:function(){return f.y}};g=new l(g);let y=this._generateLabelPriority(d);e.labelPriority=y,g.priority=y,g.poi=e,g.poi.group=t,this._quadTree.insertPoint(g),this._parent(e,t),e.layer=xCity.findItem({id:t.name}),e.mode=i,e.pos3D=r.clone(),e.pos3D.z=s,e.switchDistance=a,this._needCheck=!0,e.setVisibilityOrCreate(!1),e.material.updatePDSFXUniform("opacityCity",0),setTimeout(t=>{t._visibleLabels.get(e.group.name+"_"+e.name,e)||(e.setVisibilityOrCreate(!1),e.material.updatePDSFXUniform("opacityCity",0))},0,this)},deleteGroup:function(e){delete this.groups[e],this.currentGroup&&this.currentGroup.name===e&&delete this.currentGroup},unregisterGroup:function(e){let t=this.groups[e]?this.groups[e].pois:void 0;if(!o.is(t))return;let i=t.length;for(let e=0;e<i;e++)this.unregisterPOI(t[0])},unregisterPOI:function(e){let t=this.getPoiFullName(e);this._visibleLabels.delete(t),this._labelsToFadeIn.delete(t),this._labelsToFadeOut.delete(t),this._lastFrameVisibleLabels.delete(t);var i=e.layer.get("id"),s=this.urban.labelManager.groups[i],r=s.pois.findIndex(t=>t===e);if(s.pois.splice(r,1),this._quadTree){let t=new h(e.pos3D.x,e.pos3D.y,0,0);this._quadTree.removePoint(e,t)}this._needCheck=!0,0==s.pois.length&&this.deleteGroup(i)},getPoiFullName:function(e){return e.group.name+"_"+e.name},replacePoi:function(e,t){this._needCheck=!0,t.name=e.name;let i=this.getPoiFullName(e);var s=function(e){this.unregisterPOI(e)}.bind(this);o.is(t.observers)||(t.observers=[]),t.observers.push(s.bind(t)),t.mode=e.mode,t.switchDistance=e.switchDistance,t.group=e.group,t.layer=e.layer,t.pos3D=e.pos3D,t.fade=e.fade,t.labelPriority=e.labelPriority;let r=new h(t.pos3D.x,t.pos3D.y,0,0);this._quadTree.replacePoint(e,t,r);let n=e.group.pois.findIndex(t=>t===e);n>=0&&(e.group.pois[n]=t),this._visibleLabels.has(i)&&this._visibleLabels.set(i,t),this._lastFrameVisibleLabels.has(i)&&this._lastFrameVisibleLabels.set(i,t),this._labelsToFadeOut.has(i)&&this._labelsToFadeOut.set(i,t),this._labelsToFadeIn.has(i)&&this._labelsToFadeIn.set(i,t),t.setVisibilityOrCreate=function(e){this.visible!=e&&this.setVisibility(e)}.bind(t)},handleOpacity:function(e){this._lastFrameVisibleLabels.forEach((e,t)=>{this._visibleLabels.has(t)||this._labelsToFadeOut.has(t)||(this._labelsToFadeOut.set(t,e),e.fade=-this.fadeOutFactor,this._labelsToFadeIn.has(t)&&this._labelsToFadeIn.delete(t))}),this._visibleLabels.forEach((e,t)=>{this._labelsToFadeOut.has(t)&&this._labelsToFadeOut.delete(t),e.setVisibilityOrCreate(!0),this._lastFrameVisibleLabels.has(t)||this._labelsToFadeIn.has(t)||(this.startFadeIn?e.material.updatePDSFXUniform("opacityCity",0):e.material.updatePDSFXUniform("opacityCity",1),this._labelsToFadeIn.set(t,e),e.fade=1)}),(this._labelsToFadeIn.size||this._labelsToFadeOut.size)&&(this.urban.USR._needRender=!0),this._labelsToFadeIn.forEach((t,i)=>{if(o.is(t.material.isLoaded)){let s=t.material.getPDSFXUniform("opacityCity").value;(s+=t.fade*e.clockDelta/this.fadingTime)>=1&&(s=1,this._labelsToFadeIn.delete(i)),t.material.updatePDSFXUniform("opacityCity",s)}}),this._labelsToFadeOut.forEach((t,i)=>{let s=t.material.getPDSFXUniform("opacityCity").value;(s+=t.fade*e.clockDelta/this.fadingTime)<=0&&(s=0,t.setVisibilityOrCreate(!1),this._labelsToFadeOut.delete(i)),t.material.updatePDSFXUniform("opacityCity",s)}),this._lastFrameVisibleLabels=new Map(this._visibleLabels)},concatGroups:function(){for(var e=[],t=Object.keys(this.groups),i=0,s=t.length;i<s;i++){var r=this.groups[t[i]];r.visible&&(e=e.concat(r.pois))}return e},check:function(e){if(this._needCheck||this._needCheckLater||e.camMoved)if(!this._needCheck&&this.lastCollisionUpdate&&Date.now()-this.lastCollisionUpdate<500)this._needCheckLater=!0;else if(this._needCheck=!1,this._needCheckLater=!1,this.lastCollisionUpdate=Date.now(),this._debugBbox&&this.clearCanvasBbox(),this._quadTree){this._visibleLabels.clear();let e,i,r=[],n=this.urban.getViewpoint(),a=n.frustum.clone(),o=new s.Vector3(this.urban.shiftedPosition.x,this.urban.shiftedPosition.y,this.urban.shiftedPosition.z),l=new s.Vector3(n._camShiftedTranslation.x+o.x,n._camShiftedTranslation.y+o.y,n._camShiftedTranslation.z+o.z);a.set(a.planes[0].clone().translate(l),a.planes[1].clone().translate(l),a.planes[2].clone().translate(l),a.planes[3].clone().translate(l),a.planes[4].clone().translate(l),a.planes[5].clone().translate(l));let h=this._quadTree.getValuesFromFrustum(a,new Array,!0),c=[],d=function(){let e=-1/0,t=-1;for(let i=0;i<h.length;i++)c[i]||(c[i]=0),h[i].length>c[i]&&h[i][h[i].length-1-c[i]].poi.labelPriority>e&&(e=h[i][h[i].length-1-c[i]].poi.labelPriority,t=i);if(-1!==t){let e=c[t];return c[t]++,h[t][h[t].length-1-e].poi}return null};const u=5;let p=Date.now();for(;r.length<80&&Date.now()-p<u;){let s=!0;if(!(i=d()))break;e=this.computePlacedBbox(i);for(var t=0;t<r.length;t++)if(this.collision(r[t],e)){s=!1;break}s&&(r.push(e),this._visibleLabels.set(i.group.name+"_"+i.name,i))}}},collision:function(e,t){return e.min.x-6<t.max.x&&e.max.x+6>t.min.x&&e.min.y-8<t.max.y&&e.max.y+8>t.min.y},_getFirstLeaf:function(e){let t;return null===e.northWest?e.points:(t=this._getFirstLeaf(e.northWest))?t:(t=this._getFirstLeaf(e.northEast))?t:(t=this._getFirstLeaf(e.southWest))||this._getFirstLeaf(e.southEast)},placeBbox:function(e,t,i){var s=t.clone();return s.translate(e),s},computePlacedBbox:function(e){var t;e.layer;if("billboard"!==e.mode)throw"Label mode "+e.mode+" is not implemented.";var i=this.pos3DToScreenPos(e.pos3D).clone().clone();i.x+=e.material.getPDSFXUniform("left").value,i.y-=e.material.getPDSFXUniform("top").value;var r=e.switchDistance;if(o.is(r)){let t;if(e.getMatrixWorld)t=e.getMatrixWorld();else{let i=(new s.Vector3).getPositionFromMatrix(e.layer.get("_node").getMatrixWorld()).add(e.pos3D);t=(new s.Matrix4).setPosition(i)}var n=(new s.Matrix4).multiplyMatrices(this.urban.USR.viewpoint.camera.matrixWorldInverse,t),a=-(new s.Vector3).getPositionFromMatrix(n).z;if(0!=r&&a<r){var l=r/a-1;i.y-=(e.material.getPDSFXUniform("geometryOffset").value.y+.5)*e.material.getPDSFXUniform("geometrySize").value.y*l,i.x+=e.material.getPDSFXUniform("geometryOffset").value.x*e.material.getPDSFXUniform("geometrySize").value.x*l}}if(i.y-=e.bBox.max.y-e.bBox.min.y,t=this.placeBbox(i,e.bBox),this._debugBbox){if(!o.is(this.canvasBbox)){var h=document.createElement("CANVAS");this.canvasBbox=h,h.width=xCity._urbanImpl.USR.webGLV6Viewer.SCREEN_WIDTH,h.height=xCity._urbanImpl.USR.webGLV6Viewer.SCREEN_HEIGHT,h.style.position="absolute",this.urban.viewerContainer.appendChild(h),h.style.top=0,h.style.left=0}var c=this.canvasBbox.getContext("2d");let i="grey",s=.2;e.visible&&(i="orange"),e.visible&&e.material.getPDSFXUniform("opacityCity").value>.9&&(i="green"),!e.visible&&e.material.getPDSFXUniform("opacityCity").value<.1&&(i="red"),e.material.isLoading&&(s=1.6),e.material.isLoaded&&(s=4),e.material.map||(i="black"),c.strokeStyle=i,c.lineWidth=this._debugBboxWidth+s,c.strokeRect(t.min.x,t.min.y,t.max.x-t.min.x,t.max.y-t.min.y)}return t},pos3DToScreenPos:function(e){return this.urban.USR.viewpoint.getScreenPosition(e)},isBBoxInScreen:function(e){return e.min.x>0&&e.max.x<this.urban.viewerContainer.clientWidth&&e.min.y>0&&e.max.y<this.urban.viewerContainer.clientHeight},clearCanvasBbox:function(){o.is(this.canvasBbox)&&this.canvasBbox.getContext("2d").clearRect(0,0,this.canvasBbox.width,this.canvasBbox.height)}})}),define("DS/XCityGeometry/PatchVectorFactoryCrossQuad",["DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PatchVectorFactoryPointGeometry","DS/Visualization/Node3D","DS/WebappsUtils/WebappsUtils","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityRendering/RenderingHandlerCrossQuad","DS/XCityWorkers/WorkerPool","DS/Mesh/MeshUtils","DS/XCityLayer/Vector","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader","UWA/Class","DS/xCityBasicUtils/Utils"],function(e,t,i,s,r,n,a,o,l,h,c,d,u,p,m){"use strict";return t.extend({init:function(t,r,n){if(this._parent(t,r),this.urban=t,this.supportWorkers=!0,this.altitudeAttribute=void 0!==r.altitudeAttribute?r.altitudeAttribute:"ALTITUDE",this.scaleAttribute=void 0!==r.scaleAttribute?r.scaleAttribute:"SCALE",this.orientationAttribute=void 0!==r.orientationAttribute?r.orientationAttribute:"ORIENT",this.textureIndexAttribute=void 0!==r.textureIndexAttribute?r.textureIndexAttribute:"INDEX",this.typeAttribute=void 0!==r.typeAttribute?r.typeAttribute:"TYPE",this.stridAttribute=void 0!==r.stridAttribute?r.stridAttribute:"STRID",this._debugID=0,this._editable=!0,this.atlasNum=r.atlasNum,this.instancing=!1,this.urban.USR.hwInstancing&&(this.instancing=!0),this._rendering=new a(t,r),this.instancing&&(this.centerVec=new e.Vector3,this.scaleVec=new e.Vector3),this._node=new i,this._node.name="FactoryCrossQuad",this._node.hwInstancing=this.urban.USR.hwInstancing,this.forceAltitude=r.forceAltitude,this.identifier=0,this._treeid=0,this.nbInfoPixels=1,this.isPickable=void 0===r.isPickable||r.isPickable,this._rendering.addDefaultAltitudeFromAttributes(this.forceAltitude,this.altitudeAttribute),this.urban.USR.workers){c.log("create crosQuad Worker POOL");var l={init:!0,UVBuffer:this.UVBuffer};this._workers=new o(this.urban,s.getWebappsBaseUrl()+"UrbanWorkers/CrossQuadWorker.js",4,l)}var h=u.getUuidFromUrl(n),p=u.getUrlOptions(n);this._isReady=!1;var m=u.getDataSupplierUrl()+h+"/resources/index.json"+p;u.download(m,{responseType:"json"},999999,function(e,t,i,s){s(t,e,i)},void 0,function(e,t,i){if(t){var s=["jpg","png"],r=[];if(e instanceof Array&&e.length>=1)for(var n=0;n<e.length;n++){var a=e[n].substr(e[n].lastIndexOf(".")+1);s.indexOf(a)>-1&&r.push(e[n])}r.length>0&&this._rendering.defaultRendering.set("mapUrl",u.getDataSupplierUrl()+h+"/resources/"+r[0])}this._isReady=!0}.bind(this)),d.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},destroy:function(){this.urban.USR.getScene().remove(this._node)},dispose:function(){c.warn("Dispose: UrbanCrossQuad")},isReady:function(){return this._isReady},getData:function(t){this._treeid=0;var s=null;if(!1===this.urban.USR.workers)s=!0===this._editable?t.creator.compilePrimitive("Tree",!0,!0):t.creator.compilePrimitive("Tree",void 0,!0);else{var r=(s=t.primitiveGroup).primitives[0];r.attr.fill.isEqual=function(e){return!0},r.attr.line.isEqual=function(e){return!0},r.attr.point.isEqual=function(e){return!0},s.getBufferFromId=function(e){var t=this.buffers[e];return void 0!==t?t:null}}var a=n.createMeshNode(s);a.setMatrix((new e.Matrix4).identity().setPosition(new e.Vector3(t.posTile.x,t.posTile.y,0))),this.isPickable?a.setPickable(l.PICKABLE):a.setPickable(l.NOPICKABLE);var o=t.tile.LOD+"_"+t.tile.I+"_"+t.tile.J+"_crossquad";a.name=o,a.mesh3js.name=o,a.trees=!0,a._debugID=this._debugID,a.setVisible=function(e,t){var i=this.mesh3js.instanceAttribArrays.instanceFlag.array,s=this.mesh3js.userData.cgmIds.indexOf(t),r=i[s],n=i[s];(r=m.floatPack(r,2,!e))!==n&&(i[s]=r,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0)},a.setRendering=function(e,t,i){var s=this.mesh3js.instanceAttribArrays.instanceFlag.array[h=this.mesh3js.userData.cgmIds.indexOf(i)],r=e.color;m.is(r)&&m.is(r.computeColor)&&(r=r.computeColor());var n,a=e.opacity,o=m.is(r),l=m.is(a);s=m.floatPack(s,0,o),s=m.floatPack(s,1,l);t.getStart();if(!0===this.isInstanceNode3D){var h=-1;h="number"==typeof t.getCgmId()?this.mesh3js.userData.cgmIds.indexOf(Number(i)):this.mesh3js.userData.cgmIds.indexOf(i);var c=this.mesh3js.instanceAttribArrays.instanceColor.array;n=4*h,o&&(c[n]=r.r,c[n+1]=r.g,c[n+2]=r.b),l&&(c[n+3]=a),this.mesh3js.instanceAttribArrays.instanceColor.isDynamic=!0,this.mesh3js.instanceAttribArrays.instanceFlag.array[h]=s,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0}},this._rendering.initMesh(a),a.material.transparent=t.transparent;var h={data:t.instanceMatrix,type:"m4",attribName:"instanceMatrix"},c={data:t.instanceRotation,type:"f",attribName:"instanceRotation"},d={data:t.instanceColor,type:"v4",attribName:"instanceColor"},u={data:t.instanceIndexTexture,type:"f",attribName:"instanceIndexTexture"},p={data:t.instanceFlag,type:"f",attribName:"instanceFlag"};a.mesh3js.userData.cgmIds=t.instanceCgmId,a.setInstancingParameters(t.nbElement,[h,c,d,u,p]);for(var f=0;f<a._occurrences.length;f++)a._occurrences[f].renderable.userData.cgmIds=t.instanceCgmId;a.forceBoundingSphere({radius:Math.sqrt(Math.pow(t.minMax.maxX-t.minMax.minX,2)+Math.pow(t.minMax.maxY-t.minMax.minY,2)+Math.pow(t.minMax.maxZ-t.minMax.minZ,2))/2,center:new e.Vector3((t.minMax.minX+t.minMax.maxX)/2,(t.minMax.minY+t.minMax.maxY)/2,(t.minMax.minZ+t.minMax.maxZ)/2)});var g=new i;return g.addChild(a),this.addLabelsToNode(t,g),g},initOne:function(e,t,i){var s,r,n,a=e.getGeometry();if(a.type===h.Type.POINT){s=a.getVertices(),r=(r=e.getAttribute(this.scaleAttribute))?r.split(" "):[1,1,1];var o=this._rendering.getCompleteMaterialInfo(strid,e.attributes);n=this._computeAltitudeToApply(o,s),i.posSize.center.set(s[0],s[1],n+r[2]/2),i.posSize.width=r[1],i.posSize.length=r[0],i.posSize.height=r[2],i.posSize.altitude=n}},buildOne:function(t,i,s){var n=function(t,i,s,r,n,a,o,l,h,c,d,u){if(0===t.nbElement){var p=t.creator,m=new e.Vector3(s,r,n);if(!t.bSphere.containsPoint(m)){var f=t.bSphere.distanceToPoint(m);t.bSphere.set(t.bSphere.center,f+o)}p.startPrimitive(),p.pushVertex([-.5,0,0]),p.pushVertex([.5,0,0]),p.pushVertex([.5,0,1]),p.pushVertex([-.5,0,1]),p.pushVertex([0,.5,0]),p.pushVertex([0,-.5,0]),p.pushVertex([0,-.5,1]),p.pushVertex([0,.5,1]),p.pushNormal([0,-1,0]),p.pushNormal([0,-1,0]),p.pushNormal([0,-1,0]),p.pushNormal([0,-1,0]),p.pushNormal([-1,0,0]),p.pushNormal([-1,0,0]),p.pushNormal([-1,0,0]),p.pushNormal([-1,0,0]),p.pushTexCoord(0,[0,0]),p.pushTexCoord(0,[1,0]),p.pushTexCoord(0,[1,1]),p.pushTexCoord(0,[0,1]),p.pushTexCoord(0,[0,0]),p.pushTexCoord(0,[1,0]),p.pushTexCoord(0,[1,1]),p.pushTexCoord(0,[0,1]);var g;g=8*this._treeid,p.pushVertexIndices([g,g+1,g+2]),p.pushVertexIndices([g,g+2,g+3]),p.pushVertexIndices([g+4,g+5,g+6]),p.pushVertexIndices([g+4,g+6,g+7]),p.endPrimitive(i,!0)}var y=new e.Matrix4;y.identity(),y.translate(this.centerVec.set(s,r,n)),y.scale({x:o,y:o,z:l});var v=-a;y.rotateZ(v);var b=new e.Matrix4;b.identity(),b.rotateZ(v);var x=v,_=new e.Vector4(c.r,c.g,c.b,d);t.instanceMatrix[t.nbElement]=y,t.instanceRotation[t.nbElement]=x,t.instanceColor[t.nbElement]=_,t.instanceCgmId[t.nbElement]=i,t.instanceIndexTexture[t.nbElement]=h,t.instanceFlag[t.nbElement]=u;var C=Math.abs(Math.cos(v)),S=Math.abs(Math.sin(v));s-.5*o*C<t.minMax.minX&&(t.minMax.minX=s-.5*o*C),s+.5*o*C>t.minMax.maxX&&(t.minMax.maxX=s+.5*o*C),r-.5*o*S<t.minMax.minY&&(t.minMax.minY=r-.5*o*S),r+.5*o*S>t.minMax.maxY&&(t.minMax.maxY=r+.5*o*S),n<t.minMax.minZ&&(t.minMax.minZ=n),n+l>t.minMax.maxZ&&(t.minMax.maxZ=n+l),t.nbElement++}.bind(this),a=t.getGeometry();if(a.type===h.Type.POINT){var o,l,c,d,u,p,f,g,y,v;o=t.getAttribute(this.stridAttribute),l=a.getVertices(),c=(c=t.getAttribute(this.scaleAttribute))?c.split(" "):[1,1,1],d=(d=t.getAttribute(this.orientationAttribute))?d.split(" "):[0,0,0],u=Number(t.getAttribute(this.textureIndexAttribute)),(p=t.getAttribute("color"))?p instanceof e.Color||(p=new e.Color(p)):p=new e.Color(16777215);var b=t.getAttribute("opacity");b<1?this.transparent=!0:b=1;var x=this._rendering.getCompleteMaterialInfo(o,t.attributes);f=this._computeAltitudeToApply(x,l),void 0!==(y=t.getAttribute(this.typeAttribute))&&5===(g=Number(y))&&(g=3),s.posSize.center.set(l[0],l[1],f+c[2]/2),s.posSize.width=c[1],s.posSize.length=c[0],s.posSize.height=c[2],s.posSize.altitude=f,void 0===i.posTile&&(i.posTile=new e.Vector2(Math.round(l[0]),Math.round(l[1])),this._treeid=0,i.instanceMatrix=[],i.instanceRotation=[],i.instanceCgmId=[],i.instanceColor=[],i.instanceIndexTexture=[],i.instanceFlag=[],i.minMax={minX:99999999.9,minY:99999999.9,minZ:99999999.9,maxX:-99999999.9,maxY:-99999999.9,maxZ:-99999999.9},i.nbElement=0),v=i.posTile,void 0===i.creator&&(i.creator=new r({indexed:!0,normalBinding:r.Binding.VERTEX,useTexCoord:!0,nbTexCoord:1,texCoordBinding:r.Binding.VERTEX,useColor:!1})),void 0===i.bSphere&&(i.bSphere=new e.Sphere,i.bSphere.center.z=Number(f));var _=t.attributes,C=this._rendering.getPrimitiveRenderingValues(o,_);m.is(C)&&(m.is(C.color)&&(p=C.color.computeColor()),m.is(C.opacity)&&(b=C.opacity));var S=!1;b<1&&(S=!0),i.transparent||(i.transparent=S);var D=this._rendering.getFlagForPrimitive(o,t.attributes),P=u;void 0!==g&&(P=Math.floor(4*(4-g)+u/4));var M={x:l[0]-v.x,y:l[1]-v.y,z:Number(f)},w={x:l[0],y:l[1],z:Number(f)};if(n(i,o,M.x,M.y,M.z,Number(d[0]),Number(c[0]),Number(c[2]),P,p,b,D),this._shouldCreateLabelFromMaterial(x)){m.is(i.labelMeshes)||(i.labelMeshes=[]);let e=m.generateLabelPriorities(this._node,t);i.labelMeshes.push(this._generateLabel(w,o,x,s.posSize,void 0,e))}this._treeid++}},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1},attributeSetter:{color:"setColor",opacity:"setOpacity"},getDatas:function(e){var t=[];return t[0]={attributes:e.userData,target:e.geom},t},setGeomAttribute:function(e,t,i){var s;for(s=0;s<e.length;s+=1){var r=THREEDS.SubElement.getFromSGNode(e[s].subElement);e[s].mesh[this.attributeSetter[t]](i,[r.sgNode])}},buildAll:function(e,t,i){this._debugID++;var s=this;if(void 0===e.posTile&&(e.posTile={x:t[0].geometry.coordinates[0],y:t[0].geometry.coordinates[1]}),this._workers){var r=this._workers.postMessage({datasource:t});r.onmessage=function(t){s._workers.available(r),e.primitiveGroup=t.data.result,i()}}}})}),define("DS/XCityGeometry/PatchVectorFactoryPolygonGeometry",["UWA/Core","DS/XCityGeometry/PatchVectorFactory","DS/XCityGeometry/Label","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t,i,s,r){"use strict";return t.extend({init:function(e,t,i){this._parent(e,t,i)},_computeAltitudeToApply:function(e,t){var i=0;return i=Utils.is(t[0].z)&&"geometry"===e.elevationMode?t[0].z:"advanced"===e.elevationMode||"geometry"===e.elevationMode?e.elevation:this.urban.USR.getGroundHeight(t[0].x,t[0].y),e.elevationOffset&&(i+=e.elevationOffset),i},_generateLabel:function(e,t,s,r,n,a,o){var l=void 0,h=!1;return Utils.is(this._node.userData)&&(h=!0,l=this._node.userData._attributes.id),this.labelManagerVisibility||(this.labelManagerVisibility=!0,this._node.userData.addEvent("onChange:visible",this.urban.labelManager.onChangeVisibility,this)),s.name="POLYGON",i.generateTextNode(this.urban,s,r,e,"polygon",void 0,t,l,h,void 0,a,o)}})}),define("DS/XCityGeometry/Marker",["UWA/Core","UWA/Class","UWA/Class/Model","DS/Visualization/ThreeJS_DS","DS/xCityGlobeUtils/GeoitemModel","DS/xCityBasicUtils/Utils","DS/xCityBasicUtils/ColorGradient","DS/TransientWidget/TransientWidget","DS/XCityGeometry/DescriptionCard"],function(e,t,i,s,r,n,a,o,l){"use strict";return i.extend({defaults:{name:"",selected:!1,visible:!0,description:"",position:{},customClass:"",style:"annotationIcon",stroke:{},iconName:"",icon:{},color:"#003c5a",textStyle:"button",textColor:"rgb(226, 228, 227)",descriptionDisplayMode:"click"},setup:function(){var e=this;this.addEvent("onChange:name",function(){e.updateTitle()}),this.addEvent("onChange:selected",function(){e.updateSelection()}),this.addEvent("onChange:visible",function(){e.updateVisibility()}),this.addEvent("onChange:description",function(){e.updateDescription()}),this.addEvent("onChange:position",function(){e.update2DPosition()}),this.addEvent("onChange:style",function(){e.updateStyle()}),this.addEvent("onChange:stroke",function(){e.updateStroke()}),this.addEvent("onChange:iconName",function(){e.updateIconName()}),this.addEvent("onChange:icon",function(){e.updateIcon()}),this.addEvent("onChange:customClass",function(){e.updateCustomClassName()}),this.addEvent("onChange:color",function(){e.updateColor()}),this.addEvent("onChange:textStyle",function(){e.updateTextStyle()}),this.addEvent("onChange:textColor",function(){e.updateTextColor()}),this.addEvent("onChange:descriptionDisplayMode",function(){e.updateDescriptionDisplayMode()})},init:function(e){this._parent(e),this._feature=e.feature,this._urban=e.urban,this._markerManager=e.markerManager,this._quadTreeVisibleFlag=!0,this._collidedFlag=!1,this._iconClickCB=e.iconClickCB,this.buildElements(),this.updateProperties()},buildElements:function(){this.buildMarkerContainer(),"annotationIconAdvanced"===this.get("style")?this.buildPinAndNameContainer():(this.buildNameContainer(),this.buildPinContainer()),this.buildArrowContainer(),"annotationIconAdvanced"===this.get("style")?this.buildDescriptionAdvancedContainer():this.buildDescriptionContainer(),this.initElementsEvents()},updateProperties:function(){"annotationIconAdvanced"===this.get("style")&&this.set("color",""),this.updateTitle(),this.update2DPosition(),this.updateStyle(),this.updateIconName(),this.updateIcon(),this.updateCustomClassName(),this.updateColor(),this.updateTextStyle(),this.updateTextColor(),this.updateDescription(),this.updateDescriptionDisplayMode(),this.updateSelection(),this.updateVisibility(),this.updateStroke()},initElementsEvents:function(){var t=this;"annotationIconAdvanced"===this.get("style")?(this._pinAndNameContainer.addEvent("mouseover",function(){t._markerContainer.addClassName("xcity-marker-container-hover"),t.get("selected")||t.updatePinAndNameContainer(!0)}),this._nameContainer.addEvent("mouseover",function(){t.get("description")&&t.hoverAnnotationIconAdvancedColoring(!0,"name")}),this._pinFront.addEvent("mouseover",function(){t.hoverAnnotationIconAdvancedColoring(!0,"icon")}),this._arrowContainer.addEvent("mouseover",function(){t._markerContainer.addClassName("xcity-marker-container-hover"),t.get("selected")||t.updatePinAndNameContainer(!0)}),this._pinAndNameContainer.addEvent("mouseout",function(){t._markerContainer.removeClassName("xcity-marker-container-hover"),t.updatePinAndNameContainer(!1)}),this._nameContainer.addEvent("mouseout",function(){t.hoverAnnotationIconAdvancedColoring(!1,"name")}),this._pinFront.addEvent("mouseout",function(){t.hoverAnnotationIconAdvancedColoring(!1,"icon")}),this._arrowContainer.addEvent("mouseout",function(){t._markerContainer.removeClassName("xcity-marker-container-hover"),t.updatePinAndNameContainer(!1)}),this._nameContainer.addEvent("click",function(e){var i={event:e};t._urban.getView3D().getPicker().select(t._feature._itemParent,i,e),t.get("description")&&t.toggleAnnotationIconAdvancedName(!0)}),this._pinFront.addEvent("click",function(){t.updatePinAndNameContainer(!1);var i=t.get("feature");if(i){var s=i._itemParent.get("userData");if(e.is(s,"object")&&e.is(s.TransientWidgetOption,"object"))return t.openTransientWidget(s);var r=i.get("objectId");t.openPlatformContent(r)}})):(this._nameContainer.addEvent("mouseover",function(){t._applyHoverColor(),t._markerContainer.addClassName("xcity-marker-container-hover")}),this._pinFront.addEvent("mouseover",function(){t._applyHoverColor(),t._markerContainer.addClassName("xcity-marker-container-hover")}),this._pinBack.addEvent("mouseover",function(){t._applyHoverColor(),t._markerContainer.addClassName("xcity-marker-container-hover")}),this._arrowContainer.addEvent("mouseover",function(){t._applyHoverColor(),t._markerContainer.addClassName("xcity-marker-container-hover")}),this._descriptionContainer.addEvent("mouseover",function(){t._applyHoverColor(),t._markerContainer.addClassName("xcity-marker-container-hover")}),this._nameContainer.addEvent("mouseout",function(){t._setHovered(!1),t.updateColor(),t._markerContainer.removeClassName("xcity-marker-container-hover")}),this._pinFront.addEvent("mouseout",function(){t._setHovered(!1),t.updateColor(),t._markerContainer.removeClassName("xcity-marker-container-hover")}),this._pinBack.addEvent("mouseout",function(){t._setHovered(!1),t.updateColor(),t._markerContainer.removeClassName("xcity-marker-container-hover")}),this._arrowContainer.addEvent("mouseout",function(){t.updateColor(),t._markerContainer.removeClassName("xcity-marker-container-hover")}),this._descriptionContainer.addEvent("mouseout",function(){t.updateColor(),t._markerContainer.removeClassName("xcity-marker-container-hover")}),this._nameContainer.addEvent("click",function(e){t._feature._itemParent.set("selected",!t.get("selected"))}),this._pinFront.addEvent("click",function(){t._feature._itemParent.set("selected",!t.get("selected"))}),this._pinBack.addEvent("click",function(){t._feature._itemParent.set("selected",!t.get("selected"))}),this._arrowContainer.addEvent("click",function(){t._feature._itemParent.set("selected",!t.get("selected"))}),this._descriptionContainer.addEvent("click",function(){t._feature._itemParent.set("selected",!t.get("selected"))}))},update2DPosition:function(){this.position2D={},this.position2D=this._urban.USR.viewpoint.getScreenPosition(this.get("position")),(this.position2D.z<-1||this.position2D.z>1||this.position2D.x<0||this.position2D.x>window.innerWidth||this.position2D.y<0||this.position2D.y>window.innerHeight)&&(this._outOfFrustumFlag=!0,this.updateVisibility()),!0===this._outOfFrustumFlag&&(this._outOfFrustumFlag=!1,this.get("visible")&&this.updateVisibility());var e="custom"===this.get("style")?this.position2D.x:this.position2D.x+"px",t="custom"===this.get("style")?this.position2D.y:this.position2D.y-this._shiftValue+"px";if(this._markerContainer.setStyles({left:e,top:t}),this._markerContainer.hasClassName("xcity-marker-selected")){var i=this._descriptionContainer.getSize(),s=100-i.width/2,r=-(i.height+5),n=this._pinContainer.getBoundingClientRect();this._descriptionCard.slideElementAccordingToBbox(s,r,n)}},destroy:function(){this._markerContainer.destroy()},buildMarkerContainer:function(){this._markerContainer=new e.Element("div",{class:"xcity-marker-container"}).inject(this._markerManager.getMarkersContainer())},buildPinContainer:function(){this._pinContainer=new e.Element("div",{class:"xcity-marker-pin"}).inject(this._markerContainer),this._pinBack=new e.Element("div",{class:"xcity-marker-pin-back"}).inject(this._pinContainer),this._pinFront=new e.Element("div",{class:"xcity-marker-pin-front"}).inject(this._pinContainer),this._pinFrontIcon=new e.Element("i").inject(this._pinFront)},buildPinAndNameContainer:function(){this._pinAndNameContainer=new e.Element("div",{class:"xcity-marker-pin-and-name-container"}).inject(this._markerContainer),this._pinAndNameContainerBG=new e.Element("div",{class:"xcity-marker-pin-and-name-bg"}).inject(this._pinAndNameContainer),this._pinContainer=new e.Element("div",{class:"xcity-marker-pin"}).inject(this._pinAndNameContainer),this._pinBack=new e.Element("div",{class:"xcity-marker-pin-back"}),this._pinFront=new e.Element("div",{class:"xcity-marker-pin-front"}).inject(this._pinContainer),this._pinFrontIcon=new e.Element("i").inject(this._pinFront),this._nameContainer=new e.Element("div",{class:"xcity-marker-name"}).inject(this._pinAndNameContainer)},buildDescriptionAdvancedContainer:function(){this.buildDescriptionContainer(),this._descriptionTitle=new e.Element("div",{class:"xcity-marker-description-title"}).inject(this._descriptionContainer),this._descriptionText=new e.Element("div",{class:"xcity-marker-description-text"}).inject(this._descriptionContainer)},buildNameContainer:function(){this._nameContainer=new e.Element("div",{class:"xcity-marker-name"}).inject(this._markerContainer)},buildArrowContainer:function(){this._arrowContainer=new e.Element("div",{class:"xcity-marker-arrow"}).inject(this._markerContainer)},buildDescriptionContainer:function(){this._descriptionCard=new l("xcity-marker-description"),this._descriptionContainer=this._descriptionCard.div,this._descriptionContainer.inject(this._markerContainer)},updateTitle:function(){this._nameContainer.setHTML(this.get("name")),"annotationIconAdvanced"===this.get("style")&&this._descriptionTitle.setHTML(this.get("name")),this.update2DPosition()},updateSelection:function(){this.get("selected")?this._markerContainer.addClassName("xcity-marker-selected"):(this._markerContainer.removeClassName("xcity-marker-selected"),"annotationIconAdvanced"===this.get("style")&&this.toggleAnnotationIconAdvancedName(!1)),this.updateColor(),this._markerManager.render()},updateVisibility:function(){this.get("visible")&&this._quadTreeVisibleFlag&&!this._outOfFrustumFlag?(this.show(),this.fade(!this._collidedFlag)):this.hide()},show:function(){this._markerContainer.removeClassName("xcity-marker-not-visible"),this._visibleFlag=!0,this._markerManager.hiddenMarkerCollection.remove(this),this._markerManager.markerCollection.add(this)},hide:function(){this._markerContainer.addClassName("xcity-marker-not-visible"),this._visibleFlag=!1,this._collidedFlag||(this._markerManager.markerCollection.remove(this),this._markerManager.hiddenMarkerCollection.add(this))},fade:function(e){let t=this._markerContainer;e?(t.hasClassName("xcity-marker-fadeOut")&&t.removeClassName("xcity-marker-fadeOut"),t.hasClassName("xcity-marker-fadeIn")||t.addClassName("xcity-marker-fadeIn")):(t.hasClassName("xcity-marker-fadeIn")&&t.removeClassName("xcity-marker-fadeIn"),t.hasClassName("xcity-marker-fadeOut")||t.addClassName("xcity-marker-fadeOut"))},updateCustomClassName:function(){n.is(this._markerContainer)&&n.is(this.get("customClass"))&&"string"==typeof this.get("customClass")&&this._markerContainer.addClassName(this.get("customClass"))},updateDescription:function(){"annotationIconAdvanced"===this.get("style")?(this._descriptionText.setHTML(this.get("description")),this.updatePositionAnnotationIconAdvancedDescription()):this._descriptionContainer.setHTML(this.get("description")),""!==this.get("description")?(this._markerContainer.removeClassName("xcity-marker-description-disable"),this._markerContainer.addClassName("xcity-marker-description-enable")):(this._markerContainer.removeClassName("xcity-marker-description-enable"),this._markerContainer.addClassName("xcity-marker-description-disable"))},_updateContainerClassName:function(e){n.is(this._markerContainer)&&n.is(e)&&"string"==typeof e&&(-1!==e.indexOf("style")||""===e?(this._markerContainer.removeClassName("xcity-marker-icon-style"),this._markerContainer.removeClassName("xcity-marker-arrow-style"),this._markerContainer.removeClassName("xcity-marker-point-style"),this._markerContainer.removeClassName("xcity-marker-annotation-style"),this._markerContainer.removeClassName("xcity-marker-annotation-icon-style"),this._markerContainer.removeClassName("xcity-marker-annotation-icon-advanced-style"),this._markerContainer.removeClassName("xcity-marker-placename-style"),this._markerContainer.addClassName(e)):-1!==e.indexOf("text")||""===e?(this._markerContainer.removeClassName("xcity-marker-lite-text"),this._markerContainer.removeClassName("xcity-marker-button-text"),this._markerContainer.addClassName(e)):-1===e.indexOf("description-mode")&&""!==e||(this._markerContainer.removeClassName("xcity-marker-description-mode-hover"),this._markerContainer.removeClassName("xcity-marker-description-mode-always"),this._markerContainer.removeClassName("xcity-marker-description-mode-click"),this._markerContainer.addClassName(e)))},_updateShiftValue:function(){var e=0;switch(this.get("style")){case"icon":e=5;break;case"point":e=-10;break;default:e=0}this._shiftValue=e},updateStyle:function(){switch(this._deactivateCustomStyle(),this.get("style")){case"icon":this._updateContainerClassName("xcity-marker-icon-style");break;case"point":this._updateContainerClassName("xcity-marker-point-style");break;case"placename":this._updateContainerClassName("xcity-marker-placename-style");break;case"annotation":this._updateContainerClassName("xcity-marker-annotation-style");break;case"annotationIcon":this._updateContainerClassName("xcity-marker-annotation-icon-style");break;case"annotationIconAdvanced":this._updateContainerClassName("xcity-marker-annotation-icon-advanced-style");break;case"custom":this._updateContainerClassName(""),this._activateCustomStyle();break;default:this._updateContainerClassName("xcity-marker-arrow-style")}this.updateColor(),this._updateShiftValue(),this.update2DPosition()},_activateCustomStyle:function(){this._markerContainer.removeClassName("xcity-marker-container"),this._nameContainer.removeClassName("xcity-marker-name"),this._pinContainer.removeClassName("xcity-marker-pin"),this._pinBack.removeClassName("xcity-marker-pin-back"),this._pinFront.removeClassName("xcity-marker-pin-front"),this._arrowContainer.removeClassName("xcity-marker-arrow"),this._descriptionContainer.removeClassName("xcity-marker-description"),this._markerContainer.addClassName("xcity-marker-container-custom"),this._nameContainer.addClassName("xcity-marker-name-custom"),this._pinContainer.addClassName("xcity-marker-pin-custom"),this._pinBack.addClassName("xcity-marker-pin-back-custom"),this._pinFront.addClassName("xcity-marker-pin-front-custom"),this._arrowContainer.addClassName("xcity-marker-arrow-custom"),this._descriptionContainer.addClassName("xcity-marker-description-custom"),"annotationIconAdvanced"===this.get("style")&&(this._pinAndNameContainer.removeClassName("xcity-marker-pin-and-name"),this._pinAndNameContainer.addClassName("xcity-marker-pin-and-name-custom")),n.is(this._pinFrontIcon)&&this._pinFrontIcon.hide(),n.is(this._pinFrontImg)&&this._pinFrontImg.hide(),this._nameContainer.removeAttribute("style"),this._pinBack.removeAttribute("style"),this._arrowContainer.removeAttribute("style"),this._descriptionContainer.removeAttribute("style")},_deactivateCustomStyle:function(){this._markerContainer.removeClassName("xcity-marker-container-custom"),this._nameContainer.removeClassName("xcity-marker-name-custom"),this._pinContainer.removeClassName("xcity-marker-pin-custom"),this._pinBack.removeClassName("xcity-marker-pin-back-custom"),this._pinFront.removeClassName("xcity-marker-pin-front-custom"),this._arrowContainer.removeClassName("xcity-marker-arrow-custom"),this._descriptionContainer.removeClassName("xcity-marker-description-custom"),this._markerContainer.addClassName("xcity-marker-container"),this._nameContainer.addClassName("xcity-marker-name"),this._pinContainer.addClassName("xcity-marker-pin"),this._pinBack.addClassName("xcity-marker-pin-back"),this._pinFront.addClassName("xcity-marker-pin-front"),this._arrowContainer.addClassName("xcity-marker-arrow"),this._descriptionContainer.addClassName("xcity-marker-description"),"annotationIconAdvanced"===this.get("style")&&(this._pinAndNameContainer.removeClassName("xcity-marker-pin-and-name-custom"),this._pinAndNameContainer.addClassName("xcity-marker-pin-and-name")),this._pinFrontIcon.show(),this.updateIconName(),this.updateIcon()},updateIconName:function(){n.is(this._pinFrontIcon)&&("custom"!==this.get("style")&&this._pinFrontIcon.show(),n.is(this._pinFrontImg)&&this._pinFrontImg.hide(),this._pinFrontIcon.className="",this._pinFrontIcon.className="xcity-marker-font-icon wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+this.get("iconName"))},updateIcon:function(){n.is(this.get("icon").iconName)&&(n.is(this.get("icon").fontIcon)||this.set("iconName",this.get("icon").iconName)),n.is(this.get("icon").iconPath)&&n.is(this._pinFrontIcon)&&(this._pinFrontIcon.hide(),n.is(this._pinFrontImg)&&this._pinFrontImg.remove(),this._pinFrontImg=new e.Element("img",{class:"xcity-marker-icon-image",src:this.get("icon").iconPath,draggable:!1}).inject(this._pinFront),"custom"===this.get("style")?this._pinFrontImg.hide():this._pinFrontImg.show())},updateColor:function(){if("custom"!==this.get("style")){var e;this.get("color")instanceof a?this._currentColor=new s.Color(this.get("color").getStyle()):this._currentColor=new s.Color(this.get("color")),this.get("selected")&&this._applySelectedColor(),e=this._currentColor.getStyle(),this._applyColor(e)}},_applySelectedColor:function(){if("custom"!==this.get("style")&&this.get("selected")){var e;this._currentColor.setHSL(this._currentColor.getHSL().h,this._currentColor.getHSL().s,this._currentColor.getHSL().l+.2),e=this._currentColor.getStyle(),this._applyColor(e)}},updateTextColor:function(){if("custom"!==this.get("style")){var e;this.get("textColor")instanceof a?this._currentTextColor=new s.Color(this.get("textColor").getStyle()):this._currentTextColor=new s.Color(this.get("textColor")),e=this._currentTextColor.getStyle(),this._applyTextColor(e)}},_applyTextColor:function(e){"custom"!==this.get("style")&&"lite"===this.get("textStyle")&&this._nameContainer.setStyle("color",e)},_applyHoverColor:function(){this._setHovered(!0),"custom"!==this.get("style")&&(this.get("selected")||(this._currentColor||(this._currentColor=new s.Color(this.get("color"))),this._currentColor.setHSL(this._currentColor.getHSL().h,this._currentColor.getHSL().s,this._currentColor.getHSL().l+.1),this._applyColor(this._currentColor.getStyle())))},_setHovered:function(e){this._hovered!==e&&(this._hovered=e,this._markerManager.render())},_applyColor:function(e){if("custom"!==this.get("style")){var t=new s.Color(e);this._arrowContainer.setStyle("border-top-color",e),"annotationIconAdvanced"!==this.get("style")&&this._nameContainer.setStyle("background-color",e),this._pinBack.setStyle("background-color",e),this._descriptionContainer.setStyle("background-color",e),"lite"!==this.get("textStyle")&&(n.isBright(t)?(this._nameContainer.setStyle("color","#212121"),this._pinFrontIcon.setStyle("color","#212121"),this._descriptionContainer.setStyle("color","#212121")):(this._nameContainer.setStyle("color","#E2E4E3"),this._pinFrontIcon.setStyle("color","#E2E4E3"),this._descriptionContainer.setStyle("color","#E2E4E3")))}},updateTextStyle:function(){if("custom"!==this.get("style"))switch(this.get("textStyle")){case"lite":this._updateContainerClassName("xcity-marker-lite-text"),this.updateTextColor();break;default:this._updateContainerClassName("xcity-marker-button-text")}},updateStroke:function(){if(this.get("stroke").color){var e={"border-style":"solid","border-width":"1px","border-color":this.get("stroke").color};switch(this.get("style")){case"point":case"annotationIcon":case"icon":this._pinBack.setStyles(e)}"button"===this.get("textStyle")&&this._nameContainer.setStyles(e)}},updateDescriptionDisplayMode:function(){if("custom"!==this.get("style"))switch(this.get("descriptionDisplayMode")){case"hover":this._updateContainerClassName("xcity-marker-description-mode-hover");break;case"always":this._updateContainerClassName("xcity-marker-description-mode-always");break;default:this._updateContainerClassName("xcity-marker-description-mode-click")}},updatePinAndNameContainer:function(e){var t=this._pinContainer.getSize().width,i=this._nameContainer.getSize().width,s=this._nameContainer.getSize().height;e?(this._pinAndNameContainerBG.setStyle("width",t+i+30-15),this._pinAndNameContainerBG.setStyle("height",s)):(this._pinAndNameContainerBG.setStyle("width",30),this._pinAndNameContainerBG.setStyle("height",30)),this._setHovered(e)},updatePositionAnnotationIconAdvancedDescription:function(){var e=this._descriptionContainer.getSize(),t=e.width,i=e.height;this._descriptionContainer.setStyles({top:-(i+5),left:100-t/2})},hoverAnnotationIconAdvancedColoring:function(e,t){"name"===t?e?this._nameContainer.setStyle("color","rgb(54, 142, 196)"):this._nameContainer.setStyle("color","rgb(0, 0, 0)"):"icon"===t&&(e?this._pinFront.setStyle("color","rgb(54, 142, 196)"):this._pinFront.setStyle("color","rgb(0, 0, 0)"))},toggleAnnotationIconAdvancedName:function(e){e?(this.updatePositionAnnotationIconAdvancedDescription(),this._nameContainer.setStyle("opacity",0),this._nameContainer.hide()):(this._nameContainer.setStyle("opacity",1),this._nameContainer.show())},openTransientWidget:function(e){var t=e.TransientWidgetOption;o.showWidget(t.appId,void 0,t,{mode:t.mode||"panel",height:t.height||800,width:t.width||650})},openPlatformContent:function(t){if(e.is(t,"string")&&""!==t){var i={mode:"panel",height:800,width:650};return new r({uuid:t}).fetchItem().then(function(e){var t=e.model;if(!t)throw new Error("Unable to retrieve geolocated item");if("3DSwym"!==t.get("serviceId"))return Promise.resolve();var s={x3dPlatformId:t.get("envId"),contentId:t.get("objectId"),contentType:t.get("objectType")};return o.showWidget("X3DVIEW_AP",void 0,s,i)})}}})}),define("DS/XCityGeometry/PointOfInterest3DSetLabel",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityGeometry/PointOfInterest3DSet","DS/xCityBasicUtils/Utils","DS/Mesh/MeshUtils","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityTools/ShaderTools","DS/XCityTools/TextureTools","DS/Plugins/RenderPass","DS/Mesh/Mesh","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader","DS/XCityTools/Pooler","DS/XCityTools/RenderingTools","DS/XCityTools/TextureManager","DS/WebappsUtils/WebappsUtils"],function(e,t,i,s,r,n,a,o,l,h,c,d,u,p,m,f,g){"use strict";var y=i.extend({init:function(e,t,i){t.linePoints&&(this._linePoints=t.linePoints),this._parent(e,t,i)},_defineRenderPass:function(){this._poiPostPassID="noz",this._poiPrePassID="noz"},_setMaterial:function(){var t=this._rendering;if("icon"===this.renderType){if("billboard"===this.shapeType){var s=Object.assign({},y.alignedLabel);s.uniforms.points.length=this._linePoints.length,s.VS_global_code+=["// Compute offset to rescale the POI in screen space (fixed size)","vec4 getPositionFromDistance(float linearDistance) {","   int overIndex = -1;","   vec4 interpolatedPoint = vec4(-1.0);","   for(int i = 0;i < "+s.uniforms.points.length+" ;i++){","     vec4 point = points[i];","     if(overIndex < 0){","       if(point.w >= linearDistance){","         overIndex = i;","       }}","   }","   if (overIndex > 0 )","   {","      vec4 beforePoint = points[overIndex-1];","      vec4 afterPoint = points[overIndex];","      float factor = (linearDistance - beforePoint.w) / (afterPoint.w - beforePoint.w);","      interpolatedPoint = mix(beforePoint,afterPoint,factor);","   }","   if(linearDistance == 0.0){","     interpolatedPoint = points[0];","   }","   return interpolatedPoint;","}","float getPixelDistanceFromLineDistance(float linearDistance) {","   int overIndex = -1;","   float perspectiveFactor = -1.0;","   float pixelDistance = -1.0;","   float linePixelDistance = 0.0;","   float segmentPixelDistance = 0.0;","   vec4 interpolatedPoint = vec4(-1.0);","   vec4 projectedPoint = vec4(-1.0);","   vec4 lastProjectedPoint = projectLinePoint(points[0], perspectiveFactor);","   for(int i = 1; i < "+s.uniforms.points.length+" ;i++){","     vec4 point = points[i];","     if(overIndex < 0){","       projectedPoint = projectLinePoint(point, perspectiveFactor);","       vec2 segmentVector = projectedPoint.xy - lastProjectedPoint.xy;","       vec2 segmentVectorInPixel = segmentVector*halfScreenResolution;","       segmentPixelDistance = length(segmentVectorInPixel);","       linePixelDistance += segmentPixelDistance;","       if(point.w >= linearDistance){","         overIndex = i;","       }else {","         lastProjectedPoint = projectedPoint;","       }","     }","   }","   if (overIndex > 0 )","   {","      vec4 beforePoint = points[overIndex-1];","      vec4 afterPoint = points[overIndex];","      float factor = (linearDistance - beforePoint.w) / (afterPoint.w - beforePoint.w);","     float beforePixelDistance = linePixelDistance - segmentPixelDistance;","     pixelDistance = mix(beforePixelDistance,linePixelDistance,factor);","   }","   return pixelDistance;","}","vec4 getPositionFromPixelDistance(float pixelDistance, float perspectiveFactor,float linearDistance) {","   int overIndex = -1;","   float linePixelDistance = 0.0;","   float segmentPixelDistance = 0.0;","   vec4 interpolatedPoint = vec4(-1.0);","   vec4 projectedPoint = vec4(-1.0);","   vec4 lastProjectedPoint = projectLinePoint(points[0], perspectiveFactor);","   float lastFactor = perspectiveFactor;","   for(int i = 1; i < "+s.uniforms.points.length+" ;i++){","     vec4 point = points[i];","     if(overIndex < 0){","       projectedPoint = projectLinePoint(point, perspectiveFactor);","       vec2 segmentVector = projectedPoint.xy - lastProjectedPoint.xy;","       vec2 segmentVectorInPixel = segmentVector*halfScreenResolution;","       segmentPixelDistance = length(segmentVectorInPixel);","       linePixelDistance += segmentPixelDistance;","       if(linePixelDistance >= pixelDistance){","         overIndex = i;","       }else {","         lastProjectedPoint = projectedPoint;","         lastFactor = perspectiveFactor;","       }","     }","   }","   if (overIndex > 0 )","   {","     float beforeDistance = linePixelDistance - segmentPixelDistance;","     float factor = (pixelDistance - beforeDistance) / (linePixelDistance - beforeDistance);","     interpolatedPoint = mix(lastProjectedPoint,projectedPoint,factor);","     perspectiveFactor = mix(lastFactor,perspectiveFactor,factor);","     vec4 beforePoint = points[overIndex-1];","     vec4 afterPoint = points[overIndex];","     linearDistance = mix(beforePoint.w,afterPoint.w,factor);","   }","   if(pixelDistance == 0.0){","     interpolatedPoint = projectLinePoint(points[0],perspectiveFactor);","   }","   return interpolatedPoint;","}","float getLineMaximummDistance() {","   return points["+s.uniforms.points.length+" -1].w;","}","vec4 getScreenSpacePositionFromLineDistance(float linearDistance, float perspectiveFactor) {","   vec4 posCameraSpace = getPositionFromDistance(linearDistance);","   if(posCameraSpace.w < 0.0 ){","     discardVertex = true;","   }","   posCameraSpace = vGetWorldViewMatrix() * vec4(posCameraSpace.xyz, 1.0);","   posCameraSpace /= posCameraSpace.w;","   vec4 posScreenSpace = vGetProjectionMatrix() * posCameraSpace;","   perspectiveFactor = posScreenSpace.w;","   posScreenSpace /= posScreenSpace.w;","   return posScreenSpace;","}"].join("\n"),this.matPostPass=o.getPDSFXMaterial([i.coloring_PDSFX,i.mapping_PDSFX,i.atlasing_PDSFX,s],"basic"),t.addAtlasUniforms(this.matPostPass),this.matPostPass.setPDSFXPolygonOffset("Frontward1"),this.matPostPass.updatePDSFXUniform("halfScreenResolution",this.halfScreenResolution),this.matPostPass.updatePDSFXUniform("points",this._linePoints),this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,this.matPostPass))}else this.matPostPass=o.getPDSFXMaterial([i.poiOnePass3d_instancing_PDSFX],"physical");this.matPostPass.name=this.shapeType+"material",this.matPostPass.updatePDSFXUniform("switchDistance",this.switchDistance),this.matPostPass.updatePDSFXUniform("scaleCulling",this.scaleCulling),this.matPostPass.alphaTest=.1,this.matPostPass.side=e.FrontSide,this.matPostPass.transparent=!0,this.matPostPass.depthTest=!0,this.matPostPass.depthWrite=!0,1,"dual"===this.renderMode&&("billboard"===this.shapeType&&this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,this.matPrePass)),this.opacityFactor),o.updateCommonUniforms(this.matPostPass),void 0!==this.urlTexture&&this.urlTexture}},_pushPrimitiveBillboard:function(t,i,r,n,a,o,l,h,c){if(!1===this.instancingReady){t.pushVertex([0,-1,0]),t.pushVertex([1,-1,0]),t.pushVertex([1,0,0]),t.pushVertex([0,0,0]),t.pushNormal([0,0,0]),t.pushNormal([0,0,0]),t.pushNormal([0,0,0]),t.pushNormal([0,0,0]);t.pushTexCoord(0,[0,0]),t.pushTexCoord(0,[1,0]),t.pushTexCoord(0,[1,1]),t.pushTexCoord(0,[0,1]),t.pushVertexIndices([a+0,a+1,a+2]),t.pushVertexIndices([a+0,a+2,a+3])}var d=new e.Vector3(r[0]/this.scaleCulling,r[1]/this.scaleCulling,r[2]),u=new e.Vector3(o,l,h),p=new e.Matrix4;p.identity(),p.translate(u),p.scale(d);var m=0,f=0,g=0;s.is(c.indexTexture)&&(m=c.indexTexture,f=c.top,g=c.left);var y=[c.anchorMaximumRadius,m,g,f],v=[c.startRatio,c.endRatio,c.labelPixelLength,c.anchorLineLength];this._pushInstancesData(p,n,c.flags,void 0,y,v)},addPointOfInterest:function(e,t,i){var r,a=t.strid,o=t.attributes,l=this._rendering.getFlagForPrimitive(a,o);void 0!==this.styleClass&&""!==this.styleClass||(this.styleClass=t.styleClass),"billboard"===this.shapeType&&("icon"!==this.renderType||this.cssProcessed||(this.cssProcessed=!0,this.initBillboardCSSMap(),s.is(t.mapUrl)&&this.initBillboardMap(t),this.loadBillboardMap()));var h={x:t.localScale[0]*this.widthTexture,y:t.localScale[1]*this.heightTexture,z:t.localScale[2]},c={x:e.x,y:e.y,z:t.height,w:t.altitude},d=t.material;this._computeMinMax(this.minMaxOrig,c,h);var u=[t.localScale[0]*this.scaleCulling,t.localScale[1]*this.scaleCulling,t.localScale[2]*this.scaleCulling];r=[d.color.r,d.color.g,d.color.b,d.opacity],void 0===this.creator&&(this.creator=new n({indexed:!0,normalBinding:n.Binding.VERTEX,useTexCoord:!0,nbTexCoord:1,texCoordBinding:n.Binding.VERTEX,useColor:!1}));var p={flags:l,color:r};"billboard"===this.shapeType&&(this._rendering.setTextureInfo(p,a,o,i)&&(s.is(this._indexUpdates)||(this._indexUpdates={}),s.is(this._indexUpdates[a])||(this._indexUpdates[a]={attributes:o,glyphes:{}}),this._indexUpdates[a].glyphes[this.nbPoi]=i),p.anchorLineLength=t.lineLength,p.anchorMaximumRadius=t.anchorMaximumRadius,p.labelPixelLength=t.labelLength,p.startRatio=i.startRatio,p.endRatio=i.endRatio);return this._addPoi(this.creator,this.creatorAnchor,t.strid,e.x,e.y,t.altitude,t.height,Number(t.orientation[0]),u[0],u[1],u[2],p),this.nbPoi++,h},getMesh:function(){var i,r,n,o,l,h=function(e,t){var i=this.mesh3js.instanceAttribArrays.instanceFlag.array,r=this.mesh3js.userData.cgmIds.indexOf(t),n=i[r],a=i[r];(n=s.floatPack(n,3,!e))!==a&&(i[r]=n,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0)},c=function(t,i,r){var n,a=0,o=t.scale,l=s.is(o),h="billboard"===this._shapeType,c=-1;if(!0===this.isInstanceNode3D){var d=this.mesh3js.userData.cgmIds;if(!s.is(d))return;a=(T=this.mesh3js.instanceAttribArrays.instanceFlag.array)[c=d.indexOf(r)]}if(l&&!h){n||(n=[]);var u,p,m;u=.5*o.x,p=.5*o.y,m=o.z,"sphere"===this._shapeType&&(p=m=u),n[0]=100*u,n[5]=100*p,n[10]=100*m}a=s.floatPack(a,2,l);var f=t.color;s.is(f)&&s.is(f.computeColor)&&(f=f.computeColor());var g,y,v=t.opacity,b=s.is(f),x=s.is(v);if(a=s.floatPack(a,0,b),a=s.floatPack(a,1,x),!0===this.isInstanceNode3D){var _=this.mesh3js.userData.instanceIds.indexOf(r);if(n){g=16*c,y=16*_;var C=this.mesh3js.instanceAttribArrays.instanceMatrix.array,S=this.mesh3js.userData.instanceMatrix;for(var D in n)if(n.hasOwnProperty(D)){var P=g+Number(D);C[P]=n[D],S[P=y+Number(D)]=n[D]}this.mesh3js.instanceAttribArrays.instanceMatrix.isDynamic=!0,function(t,i,s){var r=!1,n=i.geometry.boundingSphere,a=n.center.x-n.radius,o=n.center.x+n.radius,l=n.center.y-n.radius,h=n.center.y+n.radius,c=n.center.z-n.radius,d=n.center.z+n.radius,u=i.userData.__v0,p=i.userData.__v1;u.set(t[s+12],t[s+13],t[s+14]),p.set(t[s+0],t[s+5],t[s+10]),u.x-p.x<a&&(a=u.x-p.x,r=!0),u.x+p.x>o&&(o=u.x+p.x,r=!0),u.y-p.y<l&&(l=u.y-p.y,r=!0),u.y+p.y>h&&(h=u.y+p.y,r=!0);var m=u.z;if(u.z-p.z<c&&(c=u.z-p.z,r=!0),m+p.z>d&&(d=m+p.z,r=!0),r){var f=new e.Sphere;f.radius=Math.sqrt(Math.pow(o-a,2)+Math.pow(h-l,2)+Math.pow(d-c,2))/2,f.center.x=(a+o)/2,f.center.y=(l+h)/2,f.center.z=(c+d)/2,i.boundingSphere=f}}(C,this.mesh3js,g)}if(b||x){var M=this.mesh3js.instanceAttribArrays.instanceColor.array,w=this.mesh3js.userData.instanceColor;g=4*c,y=4*_,b&&(M[g]=f.r,M[g+1]=f.g,M[g+2]=f.b,w[_].x=f.r,w[_].y=f.g,w[_].z=f.b),x&&(M[g+3]=v,w[_].w=v),this.mesh3js.instanceAttribArrays.instanceColor.isDynamic=!0}var T=this.mesh3js.instanceAttribArrays.instanceFlag.array,I=this.mesh3js.userData.instanceFlags;a!==T[c]&&(T[c]=a,I[_]=a,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0)}},d=function(t,i){if(void 0!==t){var s=this.mesh3js.userData.cgmIds.indexOf(i),r=t[0],n=t[1],a=t[2];if(void 0!==this.mesh3js.userData.__posTile&&(r-=this.mesh3js.userData.__posTile.x,n-=this.mesh3js.userData.__posTile.y),-1!==s){var o=this.mesh3js.userData.__initScale[s][0],l=this.mesh3js.userData.__initScale[s][1],h=this.mesh3js.userData.__initScale[s][2],c=this.mesh3js.userData.__transModel.x,d=this.mesh3js.userData.__transModel.y,u=this.mesh3js.userData.__transModel.z,p=this.mesh3js.instanceAttribArrays.instanceMatrix.array,m=p[16*s+0]/o,f=p[16*s+1]/o,g=p[16*s+10]/h,y=p[16*s+6]/l,v=r+c*m-f*(d*g-u*y),b=n+(d*g-u*y)*m+c*f,x=a+d*y+u*g;p[16*s+12]=v,p[16*s+13]=b,p[16*s+14]=x,this.mesh3js.instanceAttribArrays.instanceMatrix.isDynamic=!0;var _=!1,C=this.mesh3js.geometry.boundingSphere,S=C.center.x-C.radius,D=C.center.x+C.radius,P=C.center.y-C.radius,M=C.center.y+C.radius,w=C.center.z-C.radius,T=C.center.z+C.radius,I=this.mesh3js.userData.__v0,A=this.mesh3js.userData.__v1;I.set(p[16*s+12],p[16*s+13],p[16*s+14]),A.set(p[16*s+0],p[16*s+5],p[16*s+10]),I.x-A.x<S&&(S=I.x-A.x,_=!0),I.x+A.x>D&&(D=I.x+A.x,_=!0),I.y-A.y<P&&(P=I.y-A.y,_=!0),I.y+A.y>M&&(M=I.y+A.y,_=!0);var V=I.z;if(I.z-A.z<w&&(w=I.z-A.z,_=!0),V+A.z>T&&(T=V+A.z,_=!0),_){var F=new e.Sphere;F.radius=Math.sqrt(Math.pow(D-S,2)+Math.pow(M-P,2)+Math.pow(T-w,2))/2,F.center.x=(S+D)/2,F.center.y=(P+M)/2,F.center.z=(w+T)/2}}}},u=function(e,t){if(void 0!==e){var i,s,r=this.mesh3js.userData.cgmIds.indexOf(t);if("object"==typeof e?(i=e[1],s=e[0]):(i=e,s=0),-1!==r){var n=this.mesh3js.instanceAttribArrays.instanceMatrix.array,a=this.mesh3js.userData.__initScale[r][0],o=this.mesh3js.userData.__initScale[r][1],l=this.mesh3js.userData.__initScale[r][2],h=Math.cos(i),c=Math.sin(i),d=Math.cos(s),u=Math.sin(s);n[16*r+0]=h*a,n[16*r+1]=c*a,n[16*r+2]=0,n[16*r+4]=-c*d*o,n[16*r+5]=d*h*o,n[16*r+6]=u*o,n[16*r+8]=u*c*l,n[16*r+9]=-h*u*l,n[16*r+10]=d*l,this.mesh3js.instanceAttribArrays.instanceMatrix.isDynamic=!0}return this}},p=new t;this.primitiveNodes[0]=this.creator.compilePrimitive("Poi3D",!0),this.nbMesh=1;var m,f=this.matPostPass,g=this.matPrePass;"dual"===this.renderMode&&this.opacityFactor;for(var y=0;y<this.nbMesh;y++){var v=this.primitiveNodes[y];(m=a.createMeshNode(v)).setRendering=c,m.setVisible=h,m._shapeType=this.shapeType,m.setPosition=d,m.setOrientation=u,m.setRenderPasses([this._poiPostPassID]),l="_poi3D_PostPass_"+this.styleClass,m.name=l,m._debugID=this._debugID,m.mesh3js.material=f,m.setMaterial(f);var b={data:this.instanceMatrix,type:"m4",attribName:"instanceMatrix"};i={data:this.instanceColor,type:"v4",attribName:"instanceColor"},r={data:this.instanceFlags,type:"f",attribName:"instanceFlag"},n={data:this.instanceFloats,type:"v4",attribName:"instanceFloats"},o={data:this.instanceLabels,type:"v4",attribName:"instanceLabels"},m.mesh3js.userData.cgmIds=this.instanceCgmId,m.mesh3js.userData.instanceMatrix=this.instanceMatrix,m.mesh3js.userData.instanceColor=this.instanceColor,m.mesh3js.userData.instanceFlags=this.instanceFlags,m.mesh3js.userData.instanceFloats=this.instanceFloats,m.mesh3js.userData.instanceLabels=this.instanceLabels,m.mesh3js.userData.instanceIds=this.instanceCgmId.slice(),m.mesh3js.userData.__v0=new e.Vector3,m.mesh3js.userData.__v1=new e.Vector3,m.mesh3js.userData.__initScale=this.initScale,m.mesh3js.userData.__posTile=this.posTile,m.mesh3js.userData.__transModel=new e.Vector3,m.setInstancingParameters(this.nbPoi,[b,i,r,n,o],"instance"),"dual"===this.renderMode&&(this.matPrePass=f.clone(),g=this.matPrePass);for(var x=0;x<m._occurrences.length;x++)m._occurrences[x].renderable.userData.cgmIds=this.instanceCgmId;if(m.forceBoundingSphere({radius:Math.sqrt(Math.pow(this.tileBbox.xmax-this.tileBbox.xmin,2)+Math.pow(this.tileBbox.ymax-this.tileBbox.ymin,2)+Math.pow(this.minMax.maxZ-this.minMax.minZ,2))/2,center:new e.Vector3((this.minMax.minX+this.minMax.maxX)/2,(this.minMax.minY+this.minMax.maxY)/2,(this.minMax.minZ+this.minMax.maxZ)/2)}),m.setShadow(!1,!1),p.addChild(m),"dual"===this.renderMode){var _=m.clone();_.setRenderPasses([this._poiPrePassID]),g.isInstancingMaterial=f.isInstancingMaterial,g.attributes=m.material.attributes,_.isInstanceNode3D=!0,_.mesh3js.material=g,_.setMaterial(g),_.setRendering=c,p.addChild(_),this.urban._frmViewerContainer.addEvent("resize",this.updateScreenDimension.bind(this,g))}}return l="_poi3D_PostPass_"+this.styleClass+"_"+this.tileInfo,p.name=l,this._rendering.updateTextureWhenReady(this._indexUpdates,p),this._indexUpdates=null,this._rendering.applyRendering(p),p},_pushInstancesData:function(t,i,r,n,a,o){this.instanceMatrix[this.nbPoi]=t,this.instanceColor[this.nbPoi]=new e.Vector4(i[0],i[1],i[2],i[3]),this.instanceFlags[this.nbPoi]=r,s.is(a)||(a=[r,0,0,0]),this.instanceFloats[this.nbPoi]=new e.Vector4(a[0],a[1],a[2],a[3]),s.is(n)&&(this.instanceNormalMatrix[this.nbPoi]=n),this.instanceLabels[this.nbPoi]=new e.Vector4(o[0],o[1],o[2],o[3])},initializeInstancingParams:function(){this.instanceMatrix=[],this.instanceNormalMatrix=[],this.instanceColor=[],this.instanceAnchor=[],this.instanceAnchorColor=[],this.instanceFlags=[],this.instanceFloats=[],this.instanceLabels=[],this.instancingReady=!1,this.instanceCgmId=[],this.initScale=[]}});return y.alignedLabel={name:"alignedLabel",depends:[],attributes:{},uniforms:{width:{type:"f",value:50},height:{type:"f",value:60},top:{type:"f",value:0},left:{type:"f",value:0},switchDistance:{type:"f",value:0},halfScreenResolution:{type:"v2",value:new e.Vector2(960,477.5)},points:{type:"v4v",value:[]}},varyings:{},VS_global_code:["bool discardVertex = false;","bool discardVertexAngle = false;","vec4 lineDirectionScreenSpace = vec4(0.0);","const float pi = 3.141592653589793238462643383279502884197169;","// Compute offset to rescale the POI in screen space (fixed size)","float computeScaleOffset(float depthCenterCameraSpace) {","   float scaleOffset = 1.0;","   if (depthCenterCameraSpace > -switchDistance)","   {","      scaleOffset = -switchDistance / depthCenterCameraSpace;","   }","   return scaleOffset;","}","vec2 rotateVector2D(vec2 inputvector, float rotationAngle) {","   float cosRot = cos(rotationAngle);","   float sinRot = sin(rotationAngle);","   vec2 rotatedVector = vec2(cosRot*inputvector.x-sinRot*inputvector.y, sinRot*inputvector.x +cosRot*inputvector.y );","   return rotatedVector;","}","float atan2(float y,float x){","   float angle = 0.0;","   if (abs(x) > abs(y)) {","       angle = atan(y,x);","   }else {","     angle = pi/2.0 - atan(x,y);","   }","   return angle;","}","vec4 projectLinePoint(vec4 linePoint, float perspectiveFactor){"," vec4 posCameraSpace = vGetWorldViewMatrix() * vec4(linePoint.xyz, 1.0);"," posCameraSpace /= posCameraSpace.w;"," vec4 posScreenSpace = vGetProjectionMatrix() * posCameraSpace;"," perspectiveFactor = posScreenSpace.w;"," posScreenSpace /= posScreenSpace.w;"," return posScreenSpace;","}","float  getUvToMeterXFactor(vec4 posOriginCameraSpace, float xOffset, float offsetUVWidth, float width){"," vec4 posOriginScreenSpace = vGetProjectionMatrix() * posOriginCameraSpace;"," float perspectiveFactor = posOriginScreenSpace.w;"," posOriginScreenSpace /= posOriginScreenSpace.w;"," vec4 projectedVertexoffsetInX = posOriginScreenSpace + vec4(xOffset/halfScreenResolution.x,0.0, 0.0, 0.0);"," projectedVertexoffsetInX *= perspectiveFactor;"," vec4 vertexPosCameraSpaceX = vGetProjectionInvMatrix() * projectedVertexoffsetInX;"," float offsetWidthinMeters = distance(vertexPosCameraSpaceX.xyz,posOriginCameraSpace.xyz)*width;"," float uvinMeter =  offsetWidthinMeters / offsetUVWidth ;"," return uvinMeter;","}"].join("\n"),VS_overridableFunctions:{ProcessClipSpacePosition:["vec3 origin = vec3(0.0,0.0,0.0);","float niceScaledown = 0.25;","vec4 posOriginCameraSpace = vGetWorldViewMatrix() * instanceMatrix * vec4(origin.xyz, 1.0);","posOriginCameraSpace /= posOriginCameraSpace.w;","float scaleOffset = computeScaleOffset(posOriginCameraSpace.z); // / scaleCulling;"," float topOffsetInPixels = instanceFloats.w;"," float leftOffsetInPixels = instanceFloats.z;"," float index = instanceFloats.y;"," vec4 offset = texture2D(atlasOffsetTexture, vec2(0.5, (index+0.5)/800.0));"," float w = width*offset.w;"," float h = height*offset.z;"," vec2 offsetTileSpace = vGetAttribPosition().xy;"," offsetTileSpace.x += leftOffsetInPixels/w;"," offsetTileSpace.y -= topOffsetInPixels/h;"," w *= instanceMatrix[0][0];"," h *= instanceMatrix[1][1];"," vec2 offsetScreenSpace = scaleOffset*offsetTileSpace.xy*vec2(w,h)/halfScreenResolution*niceScaledown;"," vec4 posOriginScreenSpace = vGetProjectionMatrix() * posOriginCameraSpace;"," float perspectiveFactor = posOriginScreenSpace.w;"," posOriginScreenSpace /= posOriginScreenSpace.w;"," float glypheUvHalfWidth = (instanceLabels.y - instanceLabels.x)*0.5;"," float labelPixelLength = instanceLabels.z/niceScaledown;"," vec4 projectedVertexoffsetInX = posOriginScreenSpace + vec4(scaleOffset*offsetTileSpace.x/halfScreenResolution.x,0.0, 0.0, 0.0);"," projectedVertexoffsetInX *= perspectiveFactor;"," vec4 vertexPosCameraSpaceX = vGetProjectionInvMatrix() * projectedVertexoffsetInX;"," float glypheHalfWidthinMeters = distance(vertexPosCameraSpaceX.xyz,posOriginCameraSpace.xyz)*w*niceScaledown;"," float uvinMeter =  getUvToMeterXFactor(posOriginCameraSpace,scaleOffset*offsetTileSpace.x,glypheUvHalfWidth,w*niceScaledown) ;"," float linearDistancetoLabelCenter = instanceLabels.w;"," float glypheUvCenter = instanceLabels.x + glypheUvHalfWidth; "," float uvDistance = 0.5 - glypheUvCenter; "," float radius = 0.5 * uvinMeter;"," if(radius > instanceFloats.x){","   discardVertex = true;"," }"," vec4 posStartLabelCameraSpace = getPositionFromDistance(linearDistancetoLabelCenter - radius);","if(posStartLabelCameraSpace.w < 0.0){","   discardVertex = true;","}"," posStartLabelCameraSpace = vGetWorldViewMatrix() * vec4(posStartLabelCameraSpace.xyz, 1.0);"," posStartLabelCameraSpace /= posStartLabelCameraSpace.w;"," vec4 posStartLabelScreenSpace = vGetProjectionMatrix() * posStartLabelCameraSpace;"," posStartLabelScreenSpace /= posStartLabelScreenSpace.w;"," vec4 posEndLabelCameraSpace = getPositionFromDistance(linearDistancetoLabelCenter + radius);","if(posEndLabelCameraSpace.w < 0.0){","   discardVertex = true;","}"," posEndLabelCameraSpace = vGetWorldViewMatrix() * vec4(posEndLabelCameraSpace.xyz, 1.0);"," posEndLabelCameraSpace /= posEndLabelCameraSpace.w;"," vec4 posEndLabelScreenSpace = vGetProjectionMatrix() * posEndLabelCameraSpace;"," posEndLabelScreenSpace /= posEndLabelScreenSpace.w;"," float disTancetoanchor = uvDistance * uvinMeter;","vec3 depthDirection = (vec3(0.0,0.0,-1.0));","vec3 readingDirection = (vec3(1.0,0.0,0.0));","vec3 lineDirectionCameraSpace = normalize(posEndLabelCameraSpace.xyz - posOriginCameraSpace.xyz);","lineDirectionScreenSpace.xyz = normalize(posEndLabelScreenSpace.xyz - posOriginScreenSpace.xyz);","float readingAngle = dot(lineDirectionScreenSpace.xyz,readingDirection);","bool shiftReading = false;","if(readingAngle < 0.0){"," shiftReading = true;","disTancetoanchor = -disTancetoanchor;","}","vec3 viewdir = (normalize(lineDirectionCameraSpace.xyz));","vec3 vector = normalize(posStartLabelCameraSpace.xyz);","float otherangle = (abs(dot(vector,vec3(0.0,0.0,1.0) ) ) ) ;","float verticalangle = abs(dot(viewdir,vec3(0.0,0.0,1.0) ) ) ;","if(abs(verticalangle) > 0.51){","float exsecOfAngle = verticalangle;","}","if(abs(verticalangle) > 0.81){"," discardVertexAngle = true;","}"," lineDirectionScreenSpace.xyz = abs(viewdir.xyz);"," float distanceToGlypheCenter = instanceLabels.w - disTancetoanchor;"," vec4 posCenterCameraSpace = getPositionFromDistance(distanceToGlypheCenter);","if(posCenterCameraSpace.w < 0.0 ){","   discardVertex = true;","}"," posCenterCameraSpace = vGetWorldViewMatrix() * vec4(posCenterCameraSpace.xyz, 1.0);"," posCenterCameraSpace /= posCenterCameraSpace.w;"," vec4 posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;"," perspectiveFactor = posCenterScreenSpace.w;"," posCenterScreenSpace /= posCenterScreenSpace.w;"," projectedVertexoffsetInX = posCenterScreenSpace + vec4(offsetScreenSpace.x,0.0, 0.0, 0.0);"," projectedVertexoffsetInX *= perspectiveFactor;"," vertexPosCameraSpaceX = vGetProjectionInvMatrix() * projectedVertexoffsetInX;"," glypheHalfWidthinMeters = distance(vertexPosCameraSpaceX.xyz,posCenterScreenSpace.xyz);"," float uvinMeterY =  glypheHalfWidthinMeters / glypheUvHalfWidth ;"," float distancetoLabelcenter = (posOriginCameraSpace.z);"," float distancetoglypheCenter = (posCenterCameraSpace.z);"," float distancedirect = distance(posOriginCameraSpace.xyz , posCenterCameraSpace.xyz);"," float otherscale =  distancetoglypheCenter/distancedirect;","  float adjustementScale = distancetoglypheCenter/distancetoLabelcenter;","if(verticalangle > 0.01){","}","distanceToGlypheCenter = instanceLabels.w - disTancetoanchor*adjustementScale;"," posCenterCameraSpace = getPositionFromDistance(distanceToGlypheCenter);","if(posCenterCameraSpace.w < 0.0 ){","   discardVertex = true;","}"," posCenterCameraSpace = vGetWorldViewMatrix() * vec4(posCenterCameraSpace.xyz, 1.0);"," posCenterCameraSpace /= posCenterCameraSpace.w;"," posCenterScreenSpace = vGetProjectionMatrix() * posCenterCameraSpace;"," posCenterScreenSpace /= posCenterScreenSpace.w;"," float disTancetostart = (0.5 - instanceLabels.x) * uvinMeter;"," float disTancetoend = (0.5 - instanceLabels.y) * uvinMeter;","if(shiftReading == true){","   disTancetostart = -disTancetostart;","   disTancetoend = -disTancetoend;","}"," float disTancetostartPoint = instanceLabels.w - disTancetostart;"," vec4 posStartCameraSpace = getPositionFromDistance(disTancetostartPoint);","if(posStartCameraSpace.w < 0.0){","   discardVertex = true;","}"," posStartCameraSpace = vGetWorldViewMatrix() * vec4(posStartCameraSpace.xyz, 1.0);"," posStartCameraSpace /= posStartCameraSpace.w;"," vec4 posStartScreenSpace = vGetProjectionMatrix() * posStartCameraSpace;"," posStartScreenSpace /= posStartScreenSpace.w;"," float distanceToEndPoint = instanceLabels.w - disTancetoend;"," vec4 posEndCameraSpace = getPositionFromDistance(distanceToEndPoint);","if(posEndCameraSpace.w < 0.0){","   discardVertex = true;","}"," posEndCameraSpace = vGetWorldViewMatrix() * vec4(posEndCameraSpace.xyz, 1.0);"," posEndCameraSpace /= posEndCameraSpace.w;"," vec4 posEndScreenSpace = vGetProjectionMatrix() * posEndCameraSpace;"," posEndScreenSpace /= posEndScreenSpace.w;","vec2 horizontalOrientation = normalize(normalize(posEndScreenSpace.xy - posStartScreenSpace.xy)*halfScreenResolution);","float rotationAngle = atan2(horizontalOrientation.y,horizontalOrientation.x);"," vec2 offsetOrientedScreenSpace = rotateVector2D(scaleOffset*offsetTileSpace*vec2(w,h),rotationAngle)/halfScreenResolution*niceScaledown;"," ioPosition = posCenterScreenSpace + vec4(offsetOrientedScreenSpace, 0.0, 0.0);"].join("\n"),ComputeVaryingValues:["if(discardVertexAngle){","   l_invisibility = 1.0;","}","if(discardVertex){","   l_invisibility = 1.0;","}"].join("\n")},FS_overridableFunctions:{ComputeOpacity:[].join("\n")}},y}),define("DS/XCityGeometry/MarkerManager",["UWA/Core","UWA/Class","UWA/Class/Collection","DS/XCityGeometry/Marker","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/Visualization/ThreeJS_DS","css!DS/XCityGeometry/assets/style/marker.css"],function(e,t,i,s,r,n,a){"use strict";var o=null,l=t.extend({init:function(e){this._parent(e)},build:function(e){this.urban=e.urban,this._initEvents(),this._buildMarkersContainer(),this.computeCollision=!0,this.markerCollection=new i([],{model:s}),this.hiddenMarkerCollection=new i([],{model:s})},getMarkersContainer:function(){return this.markersContainer},_buildMarkersContainer:function(){this.markersContainer=new e.Element("div",{class:"xcity-markers-container"}).inject(this.urban.viewerContainer)},_initEvents:function(){n.subscribeTo(n.eventsList.pointOfView,this.render.bind(this)),n.subscribeTo("/VISU/onWindowResized",this.render.bind(this))},_updateMarkersPosition:function(){this.markerCollection.forEach(function(e){e._collidedFlag=!1,e.update2DPosition()}),this.hiddenMarkerCollection.forEach(function(e){e.get("visible")&&(e._collidedFlag=!1,e.update2DPosition())})},_updateMarkersVisibility:function(){this.markerCollection.forEach(function(e){e.updateVisibility()}),this.hiddenMarkerCollection.forEach(function(e){e.get("visible")&&e.updateVisibility()})},_computeCollision:function(){var e=this;this.markerCollectionSorted.forEach(function(t){e.markerCollectionSorted.forEach(function(e){if(t!==e&&!1===t._collidedFlag&&!1===e._collidedFlag){let i={width:30,height:30};t.position2D.x+i.width>e.position2D.x&&t.position2D.y+i.height>e.position2D.y&&t.position2D.x-i.width<e.position2D.x&&t.position2D.y-i.height<e.position2D.y&&!e.get("selected")&&!e._hovered&&(e._collidedFlag=!0)}})})},_computeDepth:function(){let e=this.markerCollectionSorted.length+1;var t=this.markerCollectionSorted.length+1;this.markerCollectionSorted.forEach(function(i,s){let r=t;i.get("selected")&&(r+=e),i._hovered&&(r+=e),i._visibleFlag&&i._markerContainer.setStyle("z-index",String(r)),t--})},_sortMarkersByDistance:function(){this.markerCollectionSorted=this.markerCollection.sortBy(function(e){return new a.Vector3(e.get("position").x,e.get("position").y,e.get("position").z).distanceTo(this.urban.getViewpoint().getPosition())}.bind(this))},onMarkerLayerLoaded:function(e){},render:function(){this._updateMarkersPosition(),this._sortMarkersByDistance(),this.computeCollision&&this._computeCollision(),this._computeDepth(),this._updateMarkersVisibility()}});return l.getInstance=function(){return null===o&&(o=new l),o},l.getInstance()}),define("DS/XCityGeometry/PatchVectorFactoryMarker",["UWA/Core","UWA/Class","DS/XCityGeometry/PatchVectorFactoryPointGeometry","DS/XCityModel/Marker","DS/XCityLayer/Vector","DS/XCityModel/Folder","DS/XCityModel/Feature","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityRendering/RenderingHandlerMarker","DS/XCityGeometry/MarkerManager"],function(e,t,i,s,r,n,a,o,l,h,c){"use strict";return i.extend({init:function(e,t,i){var s=this;this._parent(e,t,i),this.urban=e,this._parentId=i,this.nameAttribute=void 0!==t.nameAttribute?t.nameAttribute:"NAME",this.descriptionAttribute=void 0!==t.descriptionAttribute?t.descriptionAttribute:"DESCRIPTION",this.selectedAttribute=void 0!==t.selectedAttribute?t.selectedAttribute:"SELECTED",this.visibleAttribute=void 0!==t.visibleAttribute?t.visibleAttribute:"VISIBLE",this.stridAttribute=void 0!==t.stridAttribute?t.stridAttribute:"STRID",this.privateFolder=this.urban._dataModelPrivate.findChildById("vector_markers"),this._rendering=new h(this.urban),void 0===this.privateFolder&&(this.privateFolder=new n({id:"vector_markers",name:"vector_markers",visible:!0,opened:!1}),this.urban._dataModelPrivate.addChild(this.privateFolder)),this._node=new l,this._node.add=function(e){var t,i;if(s._node.addChild(e),e&&e.features)for(t=0,i=e.features.length;t<i;++t)e.features[t].getContent().geometryMarker._quadTreeVisibleFlag=!0,e.features[t].getContent().geometryMarker.updateVisibility();c.render()},this._node.setVisibility=function(){},this._node.name="FactoryMarker",this._node.remove=function(e){var t,i;if(s._node.removeChild(e),e&&e.features)for(t=0,i=e.features.length;t<i;++t)e.features[t].getContent().geometryMarker._quadTreeVisibleFlag=!1,e.features[t].getContent().geometryMarker.updateVisibility()}},destroy:function(){if(this._node&&this._node.children&&this._node.children[0]&&this._node.children[0].features){var e,t,i=this._node.children[0].features;for(e=0,t=i.length;e<t;++e)i[e].get("Content")&&i[e].get("Content").destroy()}},buildOne:function(e,t,i){void 0===t.markers&&(t.markers=[]);var n=e.getGeometry();if(n.type===r.Type.POINT){var l=n.getVertices(),h=Object.assign({},this._rendering.currentMaterial,{position:new o.Vector3(l[0],l[1],e.getAttribute(this.altitudeAttribute)?e.getAttribute(this.altitudeAttribute):0),_rendering:this._rendering,parentId:this._parentId}),c=new s(h),d=new a({id:e.getAttribute(this.stridAttribute)?e.getAttribute(this.stridAttribute):"",name:e.getAttribute(this.nameAttribute)?e.getAttribute(this.nameAttribute):"",description:e.getAttribute(this.descriptionAttribute)?e.getAttribute(this.descriptionAttribute):"",selected:!!e.getAttribute(this.selectedAttribute)&&e.getAttribute(this.selectedAttribute),visible:!e.getAttribute(this.visibleAttribute)||e.getAttribute(this.visibleAttribute)});d.set("Content",c),t.markers.push(d),this.privateFolder.addChild(d);var u=this._rendering.getRenderingValues(e.getAttribute(this.stridAttribute),e.attributes);c.applyMaterialOnGeometry(u)}},getData:function(e){var t=new l;return t.name="FactoryMarker",t.features=e.markers,t},select:function(e){var t,i;if(this._node&&this._node.children)for(t=0,i=this._node.children.length;t<i;++t)if(this._node.children[t]&&this._node.children[t].features){var s,r,n=this._node.children[t].features;for(s=0,r=n.length;s<r;++s)n[s].set("selected",e.get("selected"))}}})}),define("DS/XCityGeometry/PatchVectorFactoryBuilding",["UWA/Class","DS/XCityGeometry/PatchVectorFactoryPolygonGeometry","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/XCityTools/Geocoder","DS/XCityTools/TextureTools","DS/XCityTools/Debug","DS/XCityGeometry/Building","DS/Visualization/SceneGraphFactory","DS/XCityTools/PrimitiveGeometryCreator","DS/XCityRendering/RenderingHandlerBuilding","DS/XCityLayer/Vector","DS/xCityBasicUtils/Utils","DS/Mesh/MeshUtils","DS/XCityGeometry/LineBuilder","DS/XCityLayer/VectorLoaderJSON","DS/Visualization/EditableMesh3D","DS/Visualization/Mesh3D","DS/Mesh/Mesh"],function(e,t,i,s,r,n,a,o,l,h,c,d,u,p,m,f,g,y,v,b){"use strict";return t.extend({init:function(e,t){this._parent(e,t),this.urban=e,this.supportWorkers=!1,this._node=new r,this._node.name="Buildings",this.altitudeAttribute=void 0!==t.altitudeAttribute?t.altitudeAttribute:"ALTITUDE",this.heightAttribute=void 0!==t.heightAttribute?t.heightAttribute:"HEIGHT",this.roofAttribute=void 0!==t.roofAttribute?t.roofAttribute:"ROOFHGT",this.roofAngleAttribute=void 0!==t.roofAngleAttribute?t.roofAngleAttribute:"ROOFANGLE",this.roofShapeAttribute=void 0!==t.roofShapeAttribute?t.roofShapeAttribute:"roofShape",this.stridAttribute=void 0!==t.stridAttribute?t.stridAttribute:"STRID",this.alternAttribute=void 0!==t.alternAttribute?t.alternAttribute:"ALTERN",this.walltexAttribute=void 0!==t.walltexAttribute?t.walltexAttribute:"WALLTEX",this.tdbAttribute=void 0!==t.tdbAttribute?t.tdbAttribute:"TDB",this.transparent=!1,this.layerColor=[1,1,1],this.forceAltitude=t.forceAltitude,this.isPickable=void 0===t.isPickable||t.isPickable,this.alternBuilding=t.alternBuildingUrl,this.createRoofObjects=e.url.getArgument("roofObjects")?parseFloat(e.url.getArgument("roofObjects").value):t.createRoofObjects,this._rendering=new d(e,t),this._rendering.addDefaultHeightAttribute(this.heightAttribute),this._rendering.addDefaultAltitudeFromAttributes(this.altitudeAttribute,this.forceAltitude),this.initLabelOnSelect(e,t.renderType),this.nbInfoPixels=18,this.nbFeature=0,this.geoJSON={}},getGeoJSON:function(e){return this.geoJSON[e]},destroy:function(){this.urban.USR.getScene().remove(this._node),this._parent()},dispose:function(){o.warn("Dispose: building")},get3DMesh:function(e,t,r,n,a){var o,l;if(l=e.compilePrimitive(t),a&&a.dataFromWebWorkers){for(var c,d=(c=t.contains("roof")?a.dataFromWebWorkers.meshBundle.roofs:a.dataFromWebWorkers.meshBundle.walls).mesh,u=m.DrawingGroup.prototype,f=0;f<d.drawingGroups.length;f++)Object.setPrototypeOf(d.drawingGroups[f],u);var g=m.divideRep(d),b=new m.SGBag;g.sceneGraph=b,c.params.iPrimGroupPatternOffsets&&(g.patternOffsets=iPrimGroup.patternOffsets);var x,_=l.material,C=m.convertTo3jsMesh(g,_,!0,c.params.toShare);x=c.params.toEdit?new y(C):new v(C),!i.disableJHGDev&&_&&x.setMaterial(_),c.params.iPrimGroupNoz&&x.setRenderPasses(["noz"]),o=x}else o=h.createMeshNode(l);o.name=t,o.mesh3js.name=t,o.textureInfo={texture:n.texture,idMap:n.idMap},void 0===o.observers&&(o.observers=[]);var S=this._rendering;return o.observers.push(function(e){S.removeMesh(o.id),delete o.textureInfo,delete o.setRendering,delete o.getColor,delete o.getOpacity}),o.setRendering=function(e,t,i){var s,r=p.is(e.color),n=p.is(e.opacity),a=e.color,o=e.opacity,l=(e.extrusionHeight,t.length,this.textureInfo.texture.image);s=t;let h=this.textureInfo.idMap[s.getCgmId()];for(let e=0;h&&e<h.length;e++){let t=h[e];var c=l.data[4*t*l.width+68];if(r){let e=a.computeColor();l.data[4*t*l.width]=e.r,l.data[4*t*l.width+1]=e.g,l.data[4*t*l.width+2]=e.b,c=p.floatPack(c,0,1),!0}c=p.floatPack(c,0,r),n&&(l.data[4*t*l.width+3]=o,c=p.floatPack(c,1,1),!0),c=p.floatPack(c,1,n),l.data[4*t*l.width+68]=c}this.textureInfo.texture.needsUpdate=!0},o.setMatrix((new i.Matrix4).identity().setPosition(new i.Vector3(r.x,r.y,0))),this.isPickable?o.setPickable(s.PICKABLE):o.setPickable(s.NOPICKABLE),o},_compilMesh:function(e,t,i,s){var r=this.get3DMesh(i,s,e.posTile,t,e);return this._rendering.initMesh(r),this.transparent&&(r.mesh3js.material.transparent=!0,r.textureInfo.texture.needsUpdate=!0),r},getData:function(e){var t,i,s,n,o=new r,l=Object.keys(e.ltileGeoms),h=l.length;for(u=0;u<h;u++)if(t=l[u],i=e.tile.LOD+"_"+e.tile.I+"_"+e.tile.J,void 0!==(s=e.ltileGeoms[t]).node)o.add(s.node);else{if(e.dataFromWebWorkers){s.tdbName="default",s.textureInfo=e.dataFromWebWorkers.textureInfoCreator;var d=new c({indexed:!0,useColor:!0,normalBinding:c.Binding.FACE,useTexCoord:!0,nbTexCoord:2,texCoordBinding:c.Binding.VERTEX});Object.assign(d,e.dataFromWebWorkers.roofCreator);for(var u=0;u<d.primitiveList.length;u++){(g=d.primitiveList[u]).attr.fill.isEqual=function(e){return!0},g.attr.line.isEqual=function(e){return!0},g.attr.point.isEqual=function(e){return!0}}s.roofs=d;var f=new c({indexed:!0,useColor:!0,normalBinding:c.Binding.FACE,useTexCoord:!0,nbTexCoord:1,texCoordBinding:c.Binding.VERTEX});Object.assign(f,e.dataFromWebWorkers.wallCreator);for(u=0;u<f.primitiveList.length;u++){var g;(g=f.primitiveList[u]).attr.fill.isEqual=function(e){return!0},g.attr.line.isEqual=function(e){return!0},g.attr.point.isEqual=function(e){return!0}}s.walls=f}if(s.textureInfo.texture=a.createTexture(s.textureInfo),s.walls.nbPrimitives>0&&(n=this._compilMesh(e,s.textureInfo,s.walls,i+"_"+t),o.add(n),p.is(n.userData)&&p.is(n.userData.CityOtherMesh)&&(p.is(n.userData.CityOtherMesh.parents[0])||n.parents[0].addChild(n.userData.CityOtherMesh))),s.roofs.nbPrimitives>0&&(n=this._compilMesh(e,s.textureInfo,s.roofs,i+"_roof_"+t),o.add(n),p.is(n.userData)&&p.is(n.userData.CityOtherMesh)&&(p.is(n.userData.CityOtherMesh.parents[0])||n.parents[0].addChild(n.userData.CityOtherMesh))),e.dataFromWebWorkers){var y=m.DrawingGroup.prototype;for(u=0;u<n.mesh3js.geometry.length;u++)for(var v=n.mesh3js.geometry[u],b=0;b<v.drawingGroups.length;b++){var x=v.drawingGroups[b];Object.setPrototypeOf(x,y)}}e.builder&&this.addStrokes(e,o)}return e.ltileGeoms=void 0,e.labelsNode&&o.addChild(e.labelsNode),o},addStrokes:function(e,t){var s=new r;s._isStroke=!0,t.add(s);var n=e.posTile;s.setMatrix((new i.Matrix4).identity().setPosition(new i.Vector3(n.x,n.y,0))),e.builder.getData(e.lines,s,e.forceTransparent)},_updatesInfoTextures:function(e,t,i,s,r,n,o,l,h,c,d){p.is(e.idMap[t])||(e.idMap[t]=[]),e.idMap[t].push(e.ySize),i?a.pushPixel(e.data,[i.r,i.g,i.b,e.opacity]):a.pushPixel(e.data,[this.layerColor[0],this.layerColor[1],this.layerColor[2],e.opacity]),a.pushPixel(e.data,a.int2color(s)),a.pushPixel(e.data,a.int2color(r)),a.pushPixel(e.data,a.float2color(r)),a.pushPixel(e.data,a.int2color(n)),a.pushPixel(e.data,a.float2color(n)),a.pushPixel(e.data,a.int2color(o)),a.pushPixel(e.data,a.float2color(o)),a.pushPixel(e.data,[h.x,h.y,0,1]),a.pushPixel(e.data,a.int2color(l.x)),a.pushPixel(e.data,a.float2color(l.x)),a.pushPixel(e.data,a.int2color(l.y)),a.pushPixel(e.data,a.float2color(l.y)),a.pushPixel(e.data,a.int2color(c.x)),a.pushPixel(e.data,a.float2color(c.x)),a.pushPixel(e.data,a.int2color(c.y)),a.pushPixel(e.data,a.float2color(c.y)),a.pushPixel(e.data,[d,d,d,d]),e.ySize++;var u=a.int2color(e.ySize);e.data[4]=u[0],e.data[5]=u[1],e.data[6]=u[2],e.data[7]=u[3]},_createElements:function(e,t,i,s){var r={};r.tdbName=e,r.walls=new c({indexed:!0,useColor:!0,normalBinding:c.Binding.FACE,useTexCoord:!0,nbTexCoord:1,texCoordBinding:c.Binding.VERTEX}),r.roofs=new c({indexed:!0,useColor:!0,normalBinding:c.Binding.FACE,useTexCoord:!0,nbTexCoord:2,texCoordBinding:c.Binding.VERTEX});var n={};n.name="buildings_info_"+t.LOD+"_"+t.I+"_"+t.J,n.idMap={},n.xSize=i,n.ySize=1;var o=[];a.pushPixel(o,a.int2color(i)),a.pushPixel(o,[0,0,0,0]),a.pushPixel(o,a.int2color(s)),a.pushPixel(o,a.float2color(s));for(var l=0;l<4*(i-4);++l)o.push(0);return n.data=o,r.textureInfo=n,r},buildOne:function(e,t,i){var s=e.getAttribute(this.stridAttribute),r=Number(e.getAttribute(this.alternAttribute));if(t.dataFromWebWorkers?this._currentPrimRendering=null:this._currentPrimRendering=this._rendering.getCompleteMaterialInfo(s,e.attributes),p.is(r)||(r=-1),0===s&&o.warn("STRID = 0..."),this.nbFeature++,t&&(t.nbFeature?t.nbFeature++:t.nbFeature=1),1===r&&void 0!==this.alternBuilding&&""!==this.alternBuilding);else{var n=e.getGeometry();if(n.type===u.Type.POLYGON)this.addOneBuilding(t,n,e,s,i);else{if(n.type!==u.Type.MULTIPOLYGON)return;for(var a=n.geometryList.length,l=0;l<a;l++){var h=n.geometryList[l];this.addOneBuilding(t,h,e,s,i)}}}},addOneBuilding:function(e,t,s,a,o){var h,c,d,u,m,f,g,y,v,b,x,_,C,S,D,P;if(t.geometryList.length<1)console.warn("Empty polygon geometryList");else{var M=t.geometryList[0].getVertices();void 0===e.posTile&&(e.posTile=new i.Vector2(Math.round(M[0].x),Math.round(M[0].y)),"EPSG:3857"===this.urban.proj4Projection||"EPSG:900913"===this.urban.proj4Projection?e.scale=n.computeMercatorScaleFactor(e.posTile.x,e.posTile.y):e.scale=1),u=e.posTile;var w=!1,T=!1;if(e.dataFromWebWorkers?(this._shouldCreateLabel(this._rendering.getCompleteMaterialInfo(a,s.attributes))&&(w=!0),this._shouldAddOneStroke(a,I)&&(T=!0),(w||T)&&(this._currentPrimRendering=this._rendering.getCompleteMaterialInfo(a,s.attributes))):w=p.is(this._currentPrimRendering.label)&&this._currentPrimRendering.label.enable,e.dataFromWebWorkers)c=(d=s.getAttribute(this.tdbAttribute))||"default",e.ltileGeoms[c]={},e.ltileGeoms[c].tdbName=d,e.ltileGeoms[c].textureInfo={},e.ltileGeoms[c].textureInfo={},e.ltileGeoms[c].walls={};else{var I=s.attributes,A=this._currentPrimRendering,V=A.extrusionHeight;y=1,v=Number(s.getAttribute(this.roofAttribute)),b=Number(s.getAttribute(this.roofAngleAttribute)),x=Math.max(2,Number(s.getAttribute(this.walltexAttribute))+1),g=this._computeAltitudeToApply(A,M);var F=s.getAttribute(this.roofShapeAttribute);p.is(b)||(b=0),p.is(v)||(v=0),p.is(g)||(g=0),!(_=s.getAttribute("color"))||_ instanceof i.Color||(_=new i.Color(_));var N=s.getAttribute("opacity");p.is(A)&&(p.is(A.color)&&(_=A.color.computeColor()),p.is(A.opacity)&&(N=A.opacity)),y=V,N<1?this.transparent=!0:N=1;var O=this._rendering.getFlagForPrimitive(a,s.attributes);C=this.initShape(M,u,o,g,y,v);var E=this.initHoles(t,u);if(void 0===(d=s.getAttribute(this.tdbAttribute))&&!isNaN(x)&&2!==x){var R=4,L=[];for(h=Math.floor(x-1),L[0]=h%256,L[1]=(h-L[0])/256%256,L[2]=(h-L[0]-256*L[1])/65536%256,L[3]=(h-L[0]-256*L[1]-65536*L[2])/16777216%256;R--;)L[R]/=255;_&&_ instanceof i.Color?_.setRGB(L[0],L[1],L[2]):(_=new i.Color).setRGB(L[0],L[1],L[2])}(h=(S=(new i.Vector2).subVectors(M[1],M[0])).clone().normalize()).set(h.y,-h.x),D=new i.Vector2(2.5*h.x+.5*S.x+M[0].x-u.x,2.5*h.y+.5*S.y+M[0].y-u.y),S=S.normalize(),P=new i.Vector3(M[0].x-u.x,M[0].y-u.y,M[0].z),(c=d||"default")in e.ltileGeoms||(e.ltileGeoms[c]=this._createElements(c,o.tile,this.nbInfoPixels,e.scale)),a=s.getAttribute(this.stridAttribute);var z=A.geometricMode;p.is(z)&&"line"===z||("filled"===z?y=0:m=e.ltileGeoms[c].walls,f=e.ltileGeoms[c].roofs,l.build({wallCreator:m,roofCreator:f,shape:C,holes:E,altitude:g,height:y,roofHeight:v,roofAngle:b*Math.PI/180,roofShape:F,infoInd:e.ltileGeoms[c].textureInfo.ySize,pIdentifer:a,roofObjects:this.createRoofObjects,uvCalc:this.uvCalc}),e.ltileGeoms[c].textureInfo.opacity=N,x=this.getTextureIndex(x),this._updatesInfoTextures(e.ltileGeoms[c].textureInfo,a,_,x,g,V,v,D,S,P,O))}if((!e.dataFromWebWorkers||e.dataFromWebWorkers&&w)&&(A||(A=this._rendering.getCompleteMaterialInfo(a,s.attributes)),this._shouldCreateLabel(A))){var U={width:t.aabbox.size.x,length:t.aabbox.size.y,height:y+v},k=this._getFeatureDataFromStrid(s.get(this.stridAttribute)),X=p.computePolygonCentroidTurf(k),G=new i.Vector3(X[0],X[1],g);p.is(e.labelMeshes)||(e.labelMeshes=[]),e.labelsNode||(e.labelsNode=new r,e.labelsNode.name="labelsMeshes");let n=p.generateLabelPriorities(this._node,s);e.labelMeshes.push(this._generateLabel(G,a,A,U,void 0,n,e.labelsNode))}(!e.dataFromWebWorkers||e.dataFromWebWorkers&&T)&&this.addOneStroke(e,o,t,s)}},_shouldCreateLabel:function(e){return e&&e.label&&e.label.enable&&e.label.name&&""!==e.label.name},_shouldAddOneStroke:function(e,t){return this._shouldAddOneStrokeForMaterial(this._rendering.getPrimitiveRendering(e,t).getRenderingData())||this._shouldAddOneStrokeForMaterial(this._rendering.currentRendering.getRenderingData())||this._shouldAddOneStrokeForMaterial(this._rendering.defaultRendering.getRenderingData())},_shouldAddOneStrokeForMaterial:function(e){var t="line"===e.geometricMode,i=p.is(e.stroke)&&p.is(e.stroke.enable)&&e.stroke.enable;return t||i},getTextureIndex:function(e){return isNaN(e)&&(e=1),e},initHoles:function(e,t){for(var s=[],r=1;r<e.geometryList.length;r++){for(var n=e.geometryList[r].vertexList,a=[],o=n.length,l=0;l<o;l++)a.push(new i.Vector2(n[l].x-t.x,n[l].y-t.y));s.push(a)}return s},initShape:function(e,t,s,r,n,a){var o,l,h=[],c=[],d=[];for(o=0,l=e.length;o<l;o++)h.push(new i.Vector2(e[o].x-t.x,e[o].y-t.y)),s.posSize.center.add(e[o]),(void 0===c||void 0===d||UWA.equals(c,[])||UWA.equals(d,[]))&&(c=[h[o].x,h[o].y],d=[h[o].x,h[o].y]),c[0]=Math.min(c[0],h[o].x),c[1]=Math.min(c[1],h[o].y),d[0]=Math.max(d[0],h[o].x),d[1]=Math.max(d[1],h[o].y);return s.posSize.width=d[1]-c[1],s.posSize.length=d[0]-c[0],this._currentPrimRendering.geometricMode&&"extruded"!==this._currentPrimRendering.geometricMode&&(n=0),s.posSize.height=n+a+1,s.posSize.altitude=r,s.posSize.center.divideScalar(l),s.posSize.center.z=s.posSize.altitude+s.posSize.height/2,h},addOneStroke:function(e,t,i,s){s.getAttribute(this.stridAttribute);var r=this._currentPrimRendering,n="line"===r.geometricMode,a="extruded"!==r.geometricMode&&p.is(r.stroke)&&p.is(r.stroke.enable)&&r.stroke.enable;if(n||a){if(void 0===i.getVertices(0))return;void 0===e.builder&&(e.builder=new f(this.urban,this._rendering.getStrokeHandler())),a&&p.is(this._currentPrimRendering.stroke.elevationOffset)&&(this._currentPrimRendering.elevationOffset+=this._currentPrimRendering.stroke.elevationOffset),this.createOneLine(e,t,i,s.attributes),a&&p.is(this._currentPrimRendering.stroke.elevationOffset)&&(this._currentPrimRendering.elevationOffset-=this._currentPrimRendering.stroke.elevationOffset)}},createOneLine:function(e,t,i,s){var r,n,a,o,l,h,c=i.geometryList.length,d=this._currentPrimRendering,u=e.posTile,m=1,f=0;p.is(s.floorsNumber)&&(m=s.floorsNumber),p.is(s.floorHeight)&&(f=s.floorHeight);var g=f;if(p.is(s.groundFloorHeight)&&(g=s.groundFloorHeight),d&&d.geometricMode&&"extruded"===d.geometricMode)d.extrusionHeight,!0;else for(a=this._computeAltitudeToApply(d,i.geometryList[0].getVertices()),r=0;r<c;r++){for(n=i.geometryList[r],l=0;l<n.getVertices().length;l++)n.getVertices()[l].x=n.getVertices()[l].x-u.x,n.getVertices()[l].y=n.getVertices()[l].y-u.y,n.getVertices()[l].z=a;var y=n.getVertices(0);for(y[0].x===y[y.length-1].x&&y[0].y===y[y.length-1].y||(n.vertexList.push(n.vertexList[0]),1),h=-1;h<m-1;h++){var v=h*f+g;for(h<0&&(v=0),l=0;l<n.getVertices().length;l++)n.getVertices()[l].z=a+v;o=e.builder.buildOne(t,n,void 0,void 0,s),p.is(e.lines)||(e.lines={}),p.is(e.lines[t.strid])||(e.lines[t.strid]=[]),o.isTransparent&&(e.forceTransparent=!0),e.lines[t.strid].push(o)}for(l=0;l<n.getVertices().length;l++)n.getVertices()[l].z=a}},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1},attributeSetter:{color:"setColor",opacity:"setOpacity"},setGeomAttribute:function(e,t,i){if(e)for(var s=0;s<e.length;s++){var r=THREEDS.SubElement.getFromSGNode(e[s].subElement);e[s].mesh[this.attributeSetter[t]](i,[r.sgNode])}return this},getDatas:function(e){var t=[];return t[0]={attributes:e.userData,target:e.geom},t},_computeAltitudeFromFeature:function(e,t){var s=[],r="MultiPolygon"===e.geometry.type?e.geometry.coordinates[0][0][0]:e.geometry.coordinates[0][0];return p.is(r[2])?s[0]=new i.Vector3(r[0],r[1],r[2]):s[0]=new i.Vector2(r[0],r[1]),this._computeAltitudeToApply(t,s)},_computeLabelPos:function(e,t){var s=this._getFeatureDataFromStrid(e._getStrid());if(p.is(s)){var r,n=p.computePolygonCentroidTurf(s);return(r=new i.Vector2(n[0],n[1])).z=this._computeAltitudeFromFeature(s,t),r}console.error("No feature given so can't compute label pos")},_computeGeometrySize:function(e,t){var s=this._getFeatureDataFromStrid(e._getStrid());if(p.is(s))var r=t.geometricMode,n=!r||"filled"!==r&&"line"!==r?this._getPrimInfo(e).posSize.height:0,a=p.getBbox(s),o={width:a[2]-a[0],length:a[3]-a[1],height:n};else o={center:new i.Vector3,altitude:0,height:0,width:0,length:0};return o}})}),define("DS/XCityGeometry/PatchVectorFactoryPolygon",["UWA/Class","DS/XCityGeometry/PatchVectorFactoryBuilding","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/XCityTools/Geocoder","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityLayer/Vector","DS/XCityGeometry/Polygon","DS/XCityTools/Debug","DS/XCityRendering/RenderingHandlerPolygon","DS/xCityBasicUtils/Utils"],function(e,t,i,s,r,n,a,o,l,h,c,d,u){"use strict";return t.extend({init:function(e,t){this._parent(e,t),this._node=new r,this._node.name="FactoryPolygon",this._rendering=new d(e,t),this.type=2,this.uvCalc=!0,this._initialHeightOffset=t.heightOffset,delete t.heightOffset,c.log("PatchVectorFactoryPolygon:init")},getTextureIndex:function(){var e=this._currentPrimRendering.mapUrl,t=-1;return u.is(e)&&(t=this._rendering.getIndexForTextureUrl(e)),t},_getPrimInfoFromPreview:function(e){if(u.is(this._node.userData.getContent()._lineSet)&&u.is(this._node.userData.getContent()._lineSet.primInfos)){let t=this._node.userData.getContent()._polygonSet.primInfos[e];return 0===t.posSize.length&&0===t.posSize.width&&t.posSize.center.x,t}}})}),define("DS/XCityGeometry/PatchVectorFactoryElement",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/XCityGeometry/PatchVectorFactoryPointGeometry","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/XCityTools/PrimitiveGeometryCreator","DS/XCityRendering/RenderingHandlerElement","DS/XCityLayer/Vector","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils","DS/XCityTools/RenderingTools","DS/XCityTools/Downloader","DS/XCityTools/Pooler"],function(e,t,i,s,r,n,a,o,l,h,c,d,u,p,m,f){"use strict";return i.extend({init:function(t,i,r){this._parent(t,i),this.urban=t,this.param=i,this.name=void 0!==i.name?i.name:"Element",this.offset=void 0!==i.offset?Number(i.offset):0,this.altitudeAttribute=void 0!==i.altitudeAttribute?i.altitudeAttribute:"ALTITUDE",this.orientationAttribute=void 0!==i.orientationAttribute?i.orientationAttribute:"ORIENT",this.stridAttribute=void 0!==i.stridAttribute?i.stridAttribute:"STRID",this.colorAttribute=void 0!==i.colorAttribute?i.colorAttribute:"COLOR",this.scaleAttribute=void 0!==i.scaleAttribute?i.scaleAttribute:"SCALE",this.filenameAttribute=void 0!==i.filenameAttribute?i.filenameAttribute:"FILENAME",this.urlOptions="",this._ready=!1,this._editable=!0,this.forceAltitude=i.forceAltitude,this.isPickable=void 0===i.isPickable||i.isPickable,this.instancing=!0,this.centerVec=new e.Vector3,this.scaleVec=new e.Vector3,this._posSize=[],this._parentId=m.getUuidFromUrl(r),this._options=m.getUrlOptions(r),this.nbMesh=0,this.oldLoading=!1,this._rendering=new l(t,i),this._rendering.setInstancing(this.instancing),this._rendering.addDefaultAltitudeFromAttributes(this.forceAltitude,this.altitudeAttribute),this._node=new s,this._node.name="FactoryElement",this._node.hwInstancing=this.urban.USR.hwInstancing,this.tileNodes=[],d.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},loadResources:function(){var e=m.getDataSupplierUrl()+this._parentId+"/resources/index.json"+this._options;m.download(e,{responseType:"json"},999999,function(e,t,i,s){s(t,e,i)},void 0,function(e,t,i){if(t){var s=["3dxc","json"],n=[];if(e instanceof Array&&e.length>=1)for(var a=0;a<e.length;a++){var o=e[a].substr(e[a].lastIndexOf(".")+1);s.indexOf(o)>-1&&(n.push(e[a]),this.nbMesh++)}this._renderingMesh=[],this._renderingMesh.length=this.nbMesh;for(var h=0;h<this.nbMesh;++h)this._renderingMesh[h]=new l(this.urban,this.param,this._rendering),this._rendering.addSubRenderingHandler(this._renderingMesh[h]);this.modelMesh3d=[],this.modelMesh3d.length=this.nbMesh,this.matrixMesh3d=[],this.matrixMesh3d.length=this.nbMesh;var c=0;this.indexMesh={};var p={},g=this._options;for(this._posSize.length=this.nbMesh,0===this.nbMesh&&(this._ready=!0),h=0;h<this.nbMesh;++h)y=m.getDataSupplierUrl()+this._parentId+"/resources/"+n[h],v=n[h],this.indexMesh[v]=h,p[h]=v,this.urban.modelLoader.load({url:y,urlOptions:g,rendering:this._renderingMesh[h]},function(e,t,i){if(!t)return d.publish(d.eventsList.onLoaded+":"+this._parentId,{success:!1}),void console.warn("Model not loaded "+i);var s=e.bSphere;s=e._bsShow,u.is(s)||(s=e.bSphere);var n=e.bBox;n=e._bbShow,u.is(n)||(n=e.bBox);for(var a=-1,o=0;o<this.nbMesh;++o)if(p[o]===e.name&&void 0===this.modelMesh3d[o]){a=o;break}this._posSize[a]={center:s.center.clone(),radius:s.radius,altitude:n.min.z,height:n.max.z-n.min.z,width:n.max.y-n.min.y,length:n.max.x-n.min.x},e.traverse(function(t){t instanceof r&&(t.name=e.name,this.modelMesh3d[a]=new f(t.clone.bind(t,!0)),this.matrixMesh3d[a]=t.getMatrix(),++c===this.nbMesh&&(this._ready=!0))}.bind(this));var l=u.getAllMaterials(e);if(u.is(l)){var h=u.getMainMaterial(l);this._renderingMesh[a].copyMaterial(h),this._renderingMesh[a].addToDefaultMaterial(h)}}.bind(this))}else{this.nbMesh=1,this.oldLoading=!0,this._renderingMesh=[],this._renderingMesh.length=this.nbMesh,this._renderingMesh[0]=new l(this.urban,this.param,this._rendering),this._rendering.addSubRenderingHandler(this._renderingMesh[0]),this.modelMesh3d=[],this.modelMesh3d.length=this.nbMesh,this.matrixMesh3d=[],this.matrixMesh3d.length=this.nbMesh;var y=this.param.url,v="model";c=0,this.indexMesh={},p={},g=this._options,this.indexMesh[v]=0,p[0]=v,this.urban.modelLoader.load({url:y,urlOptions:g,rendering:this._renderingMesh[0]},function(e,t,i){if(!t)return d.publish(d.eventsList.onLoaded+":"+this._parentId,{success:!1}),void console.warn("Model not loaded "+i);var s=e.bSphere;s=e._bsShow,u.is(s)||(s=e.bSphere);var n=e.bBox;n=e._bbShow,u.is(n)||(n=e.bBox),this._posSize.length=1,this._posSize[0]={center:s.center.clone(),radius:s.radius,altitude:n.min.z,height:n.max.z-n.min.z,width:n.max.y-n.min.y,length:n.max.x-n.min.x},e.traverse(function(t){t instanceof r&&(t.name=e.name,this.modelMesh3d[0]=new f(t.clone.bind(t,!0)),this.matrixMesh3d[0]=t.getMatrix(),++c===this.nbMesh&&(this._ready=!0))}.bind(this));var a=u.getAllMaterials(e);if(u.is(a)){var o=u.getMainMaterial(a);this._renderingMesh[0].addToDefaultMaterial(o)}}.bind(this))}}.bind(this))},destroy:function(){this.urban.getView3D().getScene().remove(this._node)},isReady:function(){return this._ready||this._loadingResources||(this.loadResources(),this._loadingResources=!0),this._ready},dispose:function(){c.warn("Dispose: UrbanElement")},_getOptions:function(e){var t=e.split("?");return 2===t.length?"?"+t[1]:""},getData:function(t){var i=new s;if(i.name=t.tile.LOD+"_"+t.tile.I+"_"+t.tile.J+"_"+this.name,t.nbTotal>0){i.setMatrix((new e.Matrix4).identity().setPosition(new e.Vector3(t.posTile.x,t.posTile.y,0))),this.isPickable?i.setPickable(a.PICKABLE):i.setPickable(a.NOPICKABLE);for(var r,n=function(e,t){var i=this.mesh3js.instanceAttribArrays.instanceFlag.array,s=this.mesh3js.userData.cgmIds.indexOf(t),r=i[s],n=i[s];(r=u.floatPack(r,2,!e))!==n&&(i[s]=r,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0)},o=function(e,t,i){var s=this.mesh3js.instanceAttribArrays.instanceFlag.array[h=this.mesh3js.userData.cgmIds.indexOf(i)],r=e.color;u.is(r)&&u.is(r.computeColor)&&(r=r.computeColor());var n,a=e.opacity,o=u.is(r),l=u.is(a);if(s=u.floatPack(s,0,o),s=u.floatPack(s,1,l),!0===this.isInstanceNode3D){var h=this.mesh3js.userData.cgmIds.indexOf(i),c=this.mesh3js.instanceAttribArrays.instanceColor.array;n=4*h,o&&(c[n]=r.r,c[n+1]=r.g,c[n+2]=r.b),l&&(c[n+3]=a),this.mesh3js.instanceAttribArrays.instanceColor.isDynamic=!0,this.mesh3js.instanceAttribArrays.instanceFlag.array[h]=s,this.mesh3js.instanceAttribArrays.instanceFlag.isDynamic=!0}},l=0;l<this.nbMesh;++l)if(t.instanceMesh[l].nbElement>0){(r=this.modelMesh3d[l].use()).mesh3js.name=r.name,r.indexMesh=l,r.setRendering=o,r.setVisible=n,this._renderingMesh[l].initMesh(r),r.material.transparent=t.transparent,i.add(r);var h={data:t.instanceMesh[l].instanceMatrix,type:"m4",attribName:"instanceMatrix"},c={data:t.instanceMesh[l].instanceColor,type:"v4",attribName:"instanceColor"},d={data:t.instanceMesh[l].instanceFlag,type:"f",attribName:"instanceFlag"};r.mesh3js.userData.cgmIds=t.instanceMesh[l].instanceCgmId,r.setInstancingParameters(t.instanceMesh[l].nbElement,[h,c,d]);for(var p=0;p<r._occurrences.length;p++)r._occurrences[p].renderable.userData.cgmIds=t.instanceMesh[l].instanceCgmId;var m=new e.Sphere;m.radius=Math.sqrt(Math.pow(t.minMax.maxX-t.minMax.minX,2)+Math.pow(t.minMax.maxY-t.minMax.minY,2)+Math.pow(t.minMax.maxZ-t.minMax.minZ,2))/2,m.center.x=(t.minMax.minX+t.minMax.maxX)/2,m.center.y=(t.minMax.minY+t.minMax.maxY)/2,m.center.z=(t.minMax.minZ+t.minMax.maxZ)/2,r.forceBoundingSphere(m)}this.addLabelsToNode(t,i)}return i},buildOne:function(t,i,s){var r=function(t,i,s,r,n,a,o,l,h,c,d){Math.cos(a),Math.sin(a);var p=new e.Matrix4;p.identity(),p.translate(this.centerVec.set(s,r,n));var m=a;p.rotateZ(m),u.is(h)&&p.scale(h);var f=new e.Matrix4;f.identity(),f.multiplyMatrices(p,this.matrixMesh3d[d]);var g=new e.Vector4(o.r,o.g,o.b,l);t.instanceMesh[d].instanceMatrix[t.instanceMesh[d].nbElement]=f,t.instanceMesh[d].instanceColor[t.instanceMesh[d].nbElement]=g,t.instanceMesh[d].instanceFlag[t.instanceMesh[d].nbElement]=c,t.instanceMesh[d].instanceCgmId[t.instanceMesh[d].nbElement]=i,s+this._posSize[d].center.x-this._posSize[d].radius<t.minMax.minX&&(t.minMax.minX=s+this._posSize[d].center.x-this._posSize[d].radius),s+this._posSize[d].center.x+this._posSize[d].radius>t.minMax.maxX&&(t.minMax.maxX=s+this._posSize[d].center.x+this._posSize[d].radius),r+this._posSize[d].center.y-this._posSize[d].radius<t.minMax.minY&&(t.minMax.minY=r+this._posSize[d].center.y-this._posSize[d].radius),r+this._posSize[d].center.y+this._posSize[d].radius>t.minMax.maxY&&(t.minMax.maxY=r+this._posSize[d].center.y+this._posSize[d].radius),n+this._posSize[d].center.z-this._posSize[d].radius<t.minMax.minZ&&(t.minMax.minZ=n+this._posSize[d].center.z-this._posSize[d].radius),n+this._posSize[d].center.z+this._posSize[d].radius>t.minMax.maxZ&&(t.minMax.maxZ=n+this._posSize[d].center.z+this._posSize[d].radius),t.instanceMesh[d].nbElement++,t.nbTotal++}.bind(this),n=t.getGeometry();if(n.type===h.Type.POINT){var a,o,l,c,d,m,f,g;a=t.getAttribute(this.stridAttribute),o=n.getVertices(),u.is(this.scaleAttribute)&&u.is(t.getAttribute(this.scaleAttribute))&&(g=p._initVector3(t.getAttribute(this.scaleAttribute))),l=(l=t.getAttribute(this.orientationAttribute))?l.split(" "):[0,0,0],c=new e.Color(t.getAttribute(this.colorAttribute)||16777215),d=1,void 0===i.creator&&(i.creator=[],i.nbElement=0,i.nbTotal=0);var y=-1;if(this.oldLoading)y=0;else{var v=t.getAttribute(this.filenameAttribute);if(v){if(-1===v.indexOf(".")&&(v+=".3dxc"),null==(y=this.indexMesh[v]))return}else{if(!(Object.keys(this.indexMesh).length>0))return;y=0}}s.indexMesh=y;var b=this._renderingMesh[y].getCompleteMaterialInfo(a,t.attributes);if(m=this._computeAltitudeToApply(b,o),void 0===i.posTile){i.posTile=new e.Vector2(Math.round(o[0]),Math.round(o[1])),i.instanceMesh=[],i.instanceMesh.length=this.nbMesh;for(var x=0;x<this.nbMesh;++x)i.instanceMesh[x]={},i.instanceMesh[x].instanceMatrix=[],i.instanceMesh[x].instanceCgmId=[],i.instanceMesh[x].instanceColor=[],i.instanceMesh[x].instanceFlag=[],i.instanceMesh[x].nbElement=0;i.minMax={minX:99999999.9,minY:99999999.9,minZ:99999999.9,maxX:-99999999.9,maxY:-99999999.9,maxZ:-99999999.9}}f=i.posTile,s.posSize.center.set(o[0],o[1],m).add(this._posSize[y].center),s.posSize.width=this._posSize[y].width,s.posSize.length=this._posSize[y].length,s.posSize.height=this._posSize[y].height,s.posSize.altitude=m+this._posSize[y].altitude;var _=t.attributes,C=this._renderingMesh[y].getPrimitiveRenderingValues(a,_);u.is(C)&&(u.is(C.color)&&(c=C.color.computeColor()),u.is(C.opacity)&&(d=C.opacity),u.is(C.scale)&&g.copy(C.scale));var S=!1;(d<1||!0===b.transparent)&&(S=!0),i.transparent||(i.transparent=S);var D=this._renderingMesh[y].getFlagForPrimitive(a,t.attributes);if(r(i,a,o[0]-f.x,o[1]-f.y,Number(m),(Number(l[0])+this.offset)*Math.PI/180,c,d,g,D,y),this._shouldCreateLabelFromMaterial(b)){var P=new e.Vector3(o[0]-f.x,o[1]-f.y,Number(m));u.is(i.labelMeshes)||(i.labelMeshes=[]);let r=u.generateLabelPriorities(this._node,t);i.labelMeshes.push(this._generateLabel(P,a,b,s.posSize,void 0,r))}}},setAttribute:function(){return!1},updateAttribute:function(){return!1},attributeSetter:{color:"setColor",opacity:"setOpacity"},setGeomAttribute:function(e,t,i){if(e)for(var s=0;s<e.length;s++){var r=THREEDS.SubElement.getFromSGNode(e[s].subElement);e[s].mesh[this.attributeSetter[t]](i,[r.sgNode])}return this},getDatas:function(e){var t,i=[];for(t=0;t<e.geom.length;t+=1)i.push({attributes:e.datas,target:[e.geom[t]]});return i}})}),define("DS/XCityGeometry/PatchVectorFactoryTree",["DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PatchVectorFactoryPointGeometry","DS/XCityGeometry/PatchVectorFactoryCrossQuad","DS/XCityGeometry/PatchVectorFactoryElement","DS/Visualization/Node3D","DS/WebappsUtils/WebappsUtils","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityRendering/RenderingHandlerCrossQuad","DS/XCityRendering/RenderingHandlerElement","DS/XCityWorkers/WorkerPool","DS/Mesh/MeshUtils","DS/XCityLayer/Vector","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","UWA/Class","DS/xCityBasicUtils/Utils","DS/XCityRendering/DatavizRendering","DS/XCityTools/Downloader","DS/XCityTools/Pooler"],function(e,t,i,s,r,n,a,o,l,h,c,d,u,p,m,f,g,y,v,b){"use strict";return t.extend({init:function(t,n,a){this._parent(t,n),this.urban=t,this.stridAttribute=void 0!==n.stridAttribute?n.stridAttribute:"STRID",this.filenameAttribute=void 0!==n.filenameAttribute?n.filenameAttribute:"FILENAME",this.atlasNum=n.atlasNum,this.instancing=!1,this.urban.USR.hwInstancing&&(this.instancing=!0),this._isReady=!1,this._rendering=new h(t,n);var o=v.getDataSupplierUrlFromUrl(a);v.download(o,{responseType:"json"},999999,function(e,t,i,s){s(t,e,i)},void 0,function(e,r,o){var l=this._rendering._content;if(r&&e){var h=!1;if(e.sourceList&&e.sourceList[0].attributeMapping.FILENAME?(this._factory=new s(t,n,a),h=!0):e.analytics&&e.analytics.attributeList&&e.analytics.attributeList.find(e=>"FILENAME"===e.name&&e.count>0)?(this._factory=new s(t,n,a),h=!0):this._factory=new i(t,n,a),this._factory._rendering.updateRendering(this._rendering.currentRendering),this._rendering=this._factory._rendering,h){this._rendering.currentRendering&&this._rendering.currentRendering.renderingData&&this._rendering.currentRendering.renderingData.mapUrl&&delete this._rendering.currentRendering.renderingData.mapUrl;var c=this._rendering.updateRendering.bind(this._rendering);this._rendering.updateRendering=function(e){e&&e.renderingData&&e.renderingData.mapUrl&&delete e.renderingData.mapUrl,c(e)}}}else this._factory=new i(t,n),this._factory._rendering.updateRendering(this._rendering.currentRendering),this._rendering=this._factory._rendering;l&&this._rendering.setContent(l),this._isReady=!0}.bind(this)),this.instancing&&(this.centerVec=new e.Vector3,this.scaleVec=new e.Vector3),this._node=new r,this._node.name="FactoryTree",this._node.hwInstancing=this.urban.USR.hwInstancing,this.forceAltitude=n.forceAltitude,this.identifier=0,this._treeid=0,this.nbInfoPixels=1,this.isPickable=void 0===n.isPickable||n.isPickable,m.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},destroy:function(){this.urban.USR.getScene().remove(this._node)},dispose:function(){p.warn("Dispose: UrbanTree")},isReady:function(){if(this._isReady)return this._factory.isReady?this._factory.isReady():this._isReady},getData:function(e){return this._factory.getData(e)},buildOne:function(e,t,i){this._factory.buildOne(e,t,i)},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1},attributeSetter:{color:"setColor",opacity:"setOpacity"},getDatas:function(e){var t=[];return t[0]={attributes:e.userData,target:e.geom},t},setGeomAttribute:function(e,t,i){var s;for(s=0;s<e.length;s+=1){var r=THREEDS.SubElement.getFromSGNode(e[s].subElement);e[s].mesh[this.attributeSetter[t]](i,[r.sgNode])}}})}),define("DS/XCityGeometry/BillboardLabelAligned",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PatchVectorFactoryLineStringGeometry","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/xCityBasicUtils/Utils","DS/XCityGeometry/PointOfInterest3DSetLabel","DS/XCityLayer/Vector","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/XCityRendering/RenderingHandlerPOI3DGeometry","DS/XCityRendering/RenderingHandlerPOI3DBillboardAlignedLabel","DS/XCityTools/Geocoder","DS/XCityTools/RTree","DS/Visualization/SceneGraphFactory","DS/XCityTools/Downloader","DS/XCityTools/Disposer","DS/XCityTools/TextureManager","DS/XCityRendering/FeatureRendering"],function(e,t,i,s,r,n,a,o,l,h,c,d,u,p,m,f,g,y,v,b){"use strict";return i.extend({init:function(e,t){this.urban=e,this.hierarchyScale=3,this._parent(e,t),a.is(t._rendering)&&(this.parentRendering=t._rendering),this._currentGlyphes={}},updateLabelRendering:function(){var e=this.parentRendering.currentRendering.get("label"),t=this.parentRendering.currentRendering.getDatavizImpactingAttribute("label"),i=this.parentRendering.currentRendering.getPrimitiveImpactingAttribute("label"),s=new b({label:e});s.addRenderings(t),s.addRenderings(i),this._rendering.updateRendering(s)},buildOne:function(e,t,i,s,r,n){a.is(this._poiSet)||(this._preparePoints(s.vertexList),this._initPoiSet(t)),this.updateLabelRendering();var o=e.attributes,l={name:name,strid:r,styleClass:"",altitude:0,height:0,localScale:[1,1,1],orientation:[0],attributes:o,material:n},h=n.label;this._rendering.startFontAtlas(n.label);var c=this._separateLabelInGlyphes(h);l.labelLength=this.labelPixelLength;var d=t.lines[r][0]._lengths[0],u=Math.max(1,Math.round(d/this.labelPixelLength*8));!0!==h.position.isRepeated&&(u=1);for(var p=this.getEquidistantPoints(s.vertexList,d,u),m=(t.posTile,0),f=(p.length,this.anotherCalculateRanges(p,d)),g=0;g<p.length;g++){var y=p[g];m=y.length,l.lineLength=m,l.anchorMaximumRadius=f[g],this.addOneRepetition(y.position,l,s.vertexList,c)}},getEquidistantPoints:function(e,t,i){for(var s=e.length,r=t/(i+1),n=0,a=[],o=e[0],l=0,h=0,c=1;c<s;c++){var d=e[c];for(l+=Math.sqrt(Math.pow(o.x-d.x,2)+Math.pow(o.y-d.y,2)+Math.pow(o.z-d.z,2));a.length<i&&l>n+r;){var u=(n+r-h)/(l-h),p=this.interpolate(o,d,u);a.push({position:p,length:n+r}),n+=r}h=l,o=d}return a},interpolate:function(e,i,s){if(!a.is(e))return a.is(i)?i:null;if(!a.is(i))return e;var r=new t.Vector3(e.x,e.y,e.z);return r.lerp(new t.Vector3(i.x,i.y,i.z),s),r},calculateRanges:function(e,t){this.spacingFactor=2;var i,s,r=e.length,n=[],o=.5*e[0].length,l=(e[e.length-1].length,Math.floor(a.logX(2,r)));for(i=0;i<r;i++)n[i]=o/this.spacingFactor;if(l>=1){var h,c,d=[];for(s=1;s<n.length;s+=2)n[s]*=2,d.push(s);for(h=d,i=1;i<l;i++){for(d=[],s=1;s<h.length;s+=2)n[c=h[s]]*=2,d.push(c);h=d}}return n},getRangeFor:function(e,t,i,s,r){if(s!==i&&r!==i){var n=e[s].length,a=e[r].length,o=e[i].length;t[i]=.5*Math.min(a-o,o-n)/this.spacingFactor,this.getRangeFor(e,t,i-Math.round(.5*(i-s)),s,i),this.getRangeFor(e,t,i+Math.round(.5*(r-i)),i,r)}},anotherCalculateRanges:function(e,t){var i=e.length;this.spacingFactor=2;var s=[],r=.5*e[0].length,n=Math.floor(.5*i),a=i-1,o=e[n].length;return s[0]=s[i-1]=r,s[n]=.75*Math.min(t-o,o),this.getRangeFor(e,s,n-Math.round(.5*(n-0)),0,n),this.getRangeFor(e,s,n+Math.round(.5*(a-n)),n,a),s},_determineRange:function(e,t,i,s){var r,n=.5*(i/t*.5),a=1;for(a=t,r=0;r<s;r++)e%a===Math.floor(.5*a)&&(n*=2),a=Math.round(.5*a);return n},_preparePoints:function(e){var i,s,r,n=e,a=0;this._pointsArray=[];var o=e.length;for(i=0;i<o;i+=1)s=n[i],i>0&&(a+=Math.sqrt(Math.pow(r.x-s.x,2)+Math.pow(r.y-s.y,2)+Math.pow(r.z-s.z,2))),this._pointsArray.push(new t.Vector4(s.x,s.y,s.z,a)),r=s},_initPoiSet:function(e){this._rendering=new u(this.urban,null,this.parentRendering);var t={shapeType:"billboard",rendering:this._rendering,switchDistance:"0",linePoints:this._pointsArray};this._poiSet=new o(this.urban,t,e)},_separateLabelInGlyphes:function(e){var t,i,s,r=e.name.toString(),n=[],a=0;for(i=0;i<r.length;i++)if(""!==(t=r[i])){var o=this.initLabelTexture(t,e);i;var l=o.image?o.image.width:o.width;s={value:t,startRatio:a,endRatio:a+l,textureUrl:o.url},n.push(s),a+=l}for(this.labelPixelLength=n[n.length-1].endRatio,i=0;i<n.length;i++)(s=n[i]).startRatio/=this.labelPixelLength,s.endRatio/=this.labelPixelLength;return n},addOneRepetition:function(e,t,i,s){t.material.label.name;for(var r=0;r<s.length;r++){var n=s[r];n.linepoints=i,t.mapUrl=n.textureUrl,this._poiSet.addPointOfInterest(e,t,n)}},initLabelTexture:function(e,t){var i=this._rendering._getUrlFromLabel(t,e);a.is(e)&&(t=Object.assign({},t,{name:e}),this._currentGlyphes[e]=!0);var s=v.getOrCreateGlypheTexure(i,t);return s&&(s.url=i),this._maps||(this._maps={}),this._maps[i]=!0,s},getData:function(e){var t=Object.keys(this._maps);this._currentGlyphes={},this._rendering._createAtlasFromUrlsList(t),1===t.length&&this._rendering.currentRendering.set("mapUrl",t[0]);var i=this._poiSet.getMesh();e.labelMeshes.push(i)},_createOneLabel:function(){}})}),define("DS/XCityGeometry/PatchVectorFactoryLine",["UWA/Class","DS/XCityGeometry/PatchVectorFactoryLineStringGeometry","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/XCityTools/Geocoder","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityLayer/Vector","DS/XCityGeometry/Line","DS/XCityRendering/RenderingHandlerLine","DS/XCityTools/TextureTools","DS/XCityGeometry/LineBuilder","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils","DS/XCityGeometry/BillboardLabelAligned"],function(e,t,i,s,r,n,a,o,l,h,c,d,u,p,m,f){"use strict";return t.extend({init:function(e,t){this._parent(e,t),this.urban=e,this._node=new r,this._node.name="FactoryLine",this.geoJSON={},this.stridAttribute=void 0!==t.stridAttribute?t.stridAttribute:"STRID",this._rendering=new c(e,t),this._labelBillboardMode=!0,this.nbFeature=0,this.type=1,this._initialHeightOffset=t.heightOffset,delete t.heightOffset,this.initLabelOnSelect(e,t.renderType),p.log("PatchVectorFactoryLine:init")},destroy:function(){this.urban.USR.getScene().remove(this._node),this._parent()},dispose:function(){p.warn("Dispose: line")},getGeoJSON:function(e){return this.geoJSON[e]},registerListeners:function(e){u.getSettableAttributes().forEach(function(t){e.addEvent("onChange:"+t,function(){e.setAttribute(t,e.get(t))},e)})},_getDataLabel:function(e){if(this._rendering.nbLabelNode=0,m.is(e.labelBuilders))for(var t in e.labelBuilders)e.labelBuilders.hasOwnProperty(t)&&e.labelBuilders[t].getData(e)},getData:function(e){var t;if(void 0!==e.rootNode){this._rendering.getCompleteMaterialInfo();var s=new i.Vector3(e.posTile.x,e.posTile.y,0),n=(new i.Matrix4).identity().setPosition(s);e.rootNode.setMatrix(n),e.builder.getData(e.lines,e.rootNode,e.forceTransparent,e.creatorsFromWorker),this._getDataLabel(e),this._updatePosSize(e),t=e.rootNode}else t=new r;return e.labelsNode?t.addChild(e.labelsNode):this.addLabelsToNode(e,t),t},_updatePosSize:function(e){var t=Object.keys(e.infos),i=e.rootNode;e.posTile.z=0;for(var s=0;s<t.length;s++){var r=t[s],n=e.infos[r];if(n.bSphere){var a=n.posSize;a.center.getPositionFromMatrix(i.getMatrix()).add(n.bSphere.center),a.altitude+=i.bBox.min.z,a.height=i.bBox.max.z-i.bBox.min.z,a.diameter=2*n.bSphere.radius}}},labelBuildersInit:function(e,t,i){i.label.position&&i.label.position.isAligned?(m.is(e.labelBuilders)||(e.labelBuilders={}),e.labelBuilders[t]=new f(this.urban,this)):m.is(e.labelBuilders)&&(e.labelBuilders=null)},computeLabelLinePoints:function(e,t){return e},buildBillboardsAlignedLabel:function(e,t,i,s,r,n){if(3===s.type)for(var a=0;a<s.geometryList.length;a++){var o=s.geometryList[a];t.labelBuilders[r].buildOne(e,t,i,o,r,n)}else t.labelBuilders[r].buildOne(e,t,i,s,r,n)},buildOneLabel:function(e,t,i,s,n,a){if(m.is(e)&&this._shouldCreateLabel(this._rendering.getCompleteMaterialInfo(a,s.attributes)))if(m.is(n.labelMeshes)||(n.labelMeshes=[]),e.label.position&&e.label.position.isAligned){var o=this.computeLabelLinePoints(t,1050);this.buildBillboardsAlignedLabel(s,n,i,o,a,e)}else for(var l=0;l<n.lines[i.strid].length;l++){var h=n.lines[i.strid][l];let t=m.generateLabelPriorities(this._node,s);n.labelsNode||(n.labelsNode=new r,n.labelsNode.name="labelsMeshes"),n.labelMeshes.push(this._generateLabel(h._lineMiddle,a,e,i.posSize,n.posTile,t,n.labelsNode))}},buildOne:function(e,t,s){p.log("PatchVectorFactoryLine:buildOne");var n=e.getGeometry();if(n.type===l.Type.LINESTRING||n.type===l.Type.MULTILINESTRING){var a=n.getVertices();if(void 0!==a){var o=e.attributes,h=e.getAttribute(this.stridAttribute),c=this._rendering.getCompleteMaterialInfo(h,o),d=!1;if(this._shouldCreateLabel(this._rendering.getCompleteMaterialInfo(h,e.attributes))&&(d=!0),t.creatorsFromWorker&&!d){var f={};this._setElevationAttributesFromMaterials(f,this._rendering.getPrimitiveRendering(h,o).getRenderingData(),this._rendering.currentRendering.getRenderingData(),this._rendering.defaultRendering.getRenderingData()),c=f}if(void 0===t.posTile&&(n.type===l.Type.MULTILINESTRING?t.posTile=new i.Vector2(Math.round(a[0][0].x),Math.round(a[0][0].y)):t.posTile=new i.Vector2(Math.round(a[0].x),Math.round(a[0].y)),t.rootNode=new r,t.builder=new u(this.urban,this._rendering)),d&&this.labelBuildersInit(t,h,c),!t.creatorsFromWorker)if(n.type===l.Type.MULTILINESTRING)for(var g=0;g<a.length;g++){var y=a[g];this._applyAltitude(y,t.posTile,c)}else this._applyAltitude(a,t.posTile,c);if(this.nbFeature++,t.creatorsFromWorker)t.builder.nbLines++;else{var v=t.builder.buildOne(s,n,void 0,void 0,e.attributes,t.creatorsFromWorker);m.is(t.lines)||(t.lines={}),m.is(t.lines[s.strid])||(t.lines[s.strid]=[]),t.lines[s.strid].push(v),v.isTransparent&&(t.forceTransparent=!0)}d&&this.buildOneLabel(c,n,s,e,t,h)}}},_shouldCreateLabel:function(e){return e&&e.label&&e.label.enable&&e.label.name&&""!==e.label.name},getRendering:function(){return this._rendering},setAttribute:function(e,t){return-1!==u.getSettableAttributes().indexOf(e)&&(this[e]=t,!0)},updateAttribute:function(e,t){if("renderMode"===e){var i=t.lineBuilder.setRenderMode(this.renderMode);t.removeChildren();for(var s=0;s<i.length;++s)t.addChild(i[s])}else"animation"===e?t.lineBuilder.setAnimation(this.animation,t):"dynamicUpdate"===e?t.lineBuilder.setDynamicUpdate(this.dynamicUpdate):this._setGeometryProperty(t,e,this[e])},_applyAltitude:function(e,t,i){for(var s=0;s<e.length;s++)e[s].z=this._computeAltitudeToApply(i,e[s]),e[s].x=e[s].x-t.x,e[s].y=e[s].y-t.y},_setElevationAttributesFromMaterials:function(e,...t){var i,s,r=["elevationMode","elevation","elevationOffset"],n={},a=1,o=0,l=1;for(var h in r)n[r[h]]=a,o|=a,a<<=1;for(var c in t)for(var h in r)if(i=h=r[h],s=t[c],i in s&&void 0!==s[i]&&null!==s[i]&&(e[h]=t[c][h],o===(l|=n[h])))return},_setGeometryProperty:function(e,t,i){void 0!==e&&e.children[0].setAttribute(t,i)},getDatas:function(e){return[{attributes:e.userData,target:e.geom}]},_computeLabelPos:function(e){var t,s=e._subMeshes[0].mesh.lineBuilder._lineSet[e._getStrid()][0]._lineMiddle,r=(t=m.is(this.patch)?this.patch.miDToTile[e._getStrid()]:m.is(this._node.userData.get("Content").primInfos)?this._node.userData.get("Content").primInfos[e._getStrid()]:this._node.userData.get("Content")._lineSet.primInfos[e._getStrid()]).bSphere?t.bSphere.center.x:0,n=t.bSphere?t.bSphere.center.y:0,a=new i.Vector3(t.posSize.center.x-r,t.posSize.center.y-n,0);return(new i.Vector3).addVectors(s,a)},_computeGeometrySize:function(e){return{center:new i.Vector3,altitude:0,height:0,width:0,length:0}},_getPrimInfoFromPreview:function(e){if(m.is(this._node.userData.getContent()._lineSet)&&m.is(this._node.userData.getContent()._lineSet.primInfos))return this._node.userData.getContent()._lineSet.primInfos[e]}})}),define("DS/XCityGeometry/PatchVectorFactoryModel",["DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PatchVectorFactoryPointGeometry","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/XCityLoaders/ModelLoader","UWA/Class","DS/XCityRendering/RenderingHandlerModel","DS/XCityTools/ShaderTools","DS/XCityTools/EventDispatcher","DS/XCityRendering/RenderingHandlerLabel","DS/xCityBasicUtils/LoadingProgressList","DS/XCityTools/Downloader","DS/XCityTools/Geocoder","DS/XCityTools/RenderingTools"],function(e,t,i,s,r,n,a,o,l,h,c,d,u,p){"use strict";return t.extend({init:function(e,t,r){this._parent(e,t,r),this.urban=e,this.fileNameAttribute=void 0!==t.fileNameAttribute?t.fileNameAttribute:"FILENAME",this.stridAttribute=void 0!==t.stridAttribute?t.stridAttribute:"STRID",this.attrAltitude=void 0!==t.attributAltitude?t.attributAltitude:"ALTITUDE",this.scaleAttribute=void 0!==t.scaleAttribute?t.scaleAttribute:"SCALE",this.path=t.path,s.is(this.path)&&(this.path=d.getResourcesUrlFromUrl(this.path),t.path=this.path),this.shader=t.Shader,"3DXM"===r?this._rendering=new h(e,t):(this._rendering=new a(e,t),this._rendering.addDefaultScaleFromAttributes(this.scaleAttribute),this._rendering.addDefaultAltitudeFromAttributes(this.attrAltitude)),this._node=new i,this._node.name="FactoryModel",this.urlOptions="",l.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},destroy:function(){this.urban.USR.getScene().remove(this._node)},dispose:function(){},getData:function(e){var t=new i;for(var s in e.ltileGeoms){var r=e.ltileGeoms[s];t.add(r)}this.addLabelsToNode(e,t);return this._isCoreReady=!1,t.isCoreReady=function(){if(this._isCoreReady)return!0;for(var e=!0,t=0;t<this.children.length;++t)if(!1===this.children[t].isCoreReady){e=!1;break}return this._isCoreReady=e,e},t},initMesh:function(e,t,i,s,r){},buildOne:function(t,i,r){var n,a=t.getAttribute(this.stridAttribute),o=t.getAttribute(this.fileNameAttribute),l=t.getGeometry(),h=l.getVertices(),c=this._rendering.getCompleteMaterialInfo(a,t.attributes);n=this._computeAltitudeToApply(c,h);var m=c.scale,f=new e.Vector3(0,0,0);if(m.equals(f)){if(o&&(o.includes(".3dxml")||o.includes(".cgr")))var g=p._initVector3(.001)}else g=m;this._rendering.currentRendering.renderingData.scale=g||p._initVector3(1);var y=(new e.Matrix4).identity().setPosition(new e.Vector3(l.x,l.y,n));r.posSize.center.set(l.x,l.y,n),r.posSize.altitude=n;var v=this.path.indexOf("?");""===this.urlOptions&&-1!==v&&(this.urlOptions=this.path.substring(v),this.path=this.path.substring(0,v));var b={name:a,url:this.path+o,urlOptions:this.urlOptions,shifted:!0,matrix:y,rendering:this._rendering,color:t.color,opacity:t.opacity,patch:this.patch};if(o.includes(".3dxml")){var x=this.path.replace("%globe%",d._aliases.globe);b={name:a,spec:{filename:o+this.urlOptions,serverurl:x,withCredentials:!0,provider:"FILE",proxyurl:"none",requiredAuth:null},shifted:!0,matrix:y,rendering:this._rendering,color:t.color,opacity:t.opacity,patch:this.patch}}this.shader&&(b.shader=this.shader);var _=this;this.primitiveProgress(a,{loaded:0,total:1});var C=i.indexPrimitive,S=this.urban.modelLoader.load(b,function(e,t,i,r,n){if(g&&_.setScale(e,g),"EPSG:3857"===_.urban.baseProjection||"EPSG:900913"===_.urban.baseProjection){var a=u.computeMercatorScaleFactor(l.x,l.y,u.getDefaultProjection());_.appliedMercatorScale=p._initVector3(a),_.applyScale(e,_.appliedMercatorScale)}s.is(C)&&C(e,t,i,r,n),_._loadingProgressList.modelLoaded(i)},this.primitiveProgress.bind(this,a));if(i.ltileGeoms[a]=S,this._shouldCreateLabelFromMaterial(c)){var D=new e.Vector3(l.x,l.y,n);s.is(i.labelMeshes)||(i.labelMeshes=[]);let o=s.generateLabelPriorities(this._node,t);i.labelMeshes.push(this._generateLabel(D,a,c,r.posSize,void 0,o))}},primitiveProgress:function(e,t){s.is(this._loadingProgressList)||(this._loadingProgressList=new c(this.layerProgress.bind(this),this.layerLoaded.bind(this))),this._loadingProgressList.updateLoading(e,t)},layerProgress:function(e){s.is(this._progressCallback)&&this._progressCallback(e)},layerLoaded:function(){},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1},attributeSetter:{color:"setColor",opacity:"setOpacity"},setGeomAttribute:function(e,t,i){return e[this.attributeSetter[t]](i),this},setScale:function(t,i){if(t._matrix){var s=i.x/t._matrix.elements[0],r=i.y/t._matrix.elements[5],n=i.z/t._matrix.elements[10],a=new e.Vector3(s,r,n);t.setMatrix(t.getMatrix().scale(a))}else t.setMatrix((new e.Matrix4).makeScale(i.x,i.y,i.z))},applyScale:function(t,i){t._matrix?t.setMatrix(t.getMatrix().scale(i)):t.setMatrix((new e.Matrix4).makeScale(i.x,i.y,i.z))},getDatas:function(e){var t,i=[];if(e.geom)for(t=0;t<e.geom.length;t+=1)e.geom[t].subElement.group.geometry.drawingGroups[t]&&i.push({attributes:{id:e.geom[t].subElement.group.geometry.drawingGroups[t].gas.id},target:e.geom[t].subElement});return i}})}),define("DS/XCityGeometry/PatchVectorFactoryPointOfInterest3D",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PatchVectorFactoryPointGeometry","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/xCityBasicUtils/Utils","DS/XCityGeometry/PointOfInterest3DSet","DS/XCityLayer/Vector","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/XCityRendering/RenderingHandlerPOI3DGeometry","DS/XCityRendering/RenderingHandlerPOI3DBillboard","DS/XCityTools/Geocoder","DS/XCityTools/RTree","DS/Visualization/SceneGraphFactory","DS/XCityTools/Downloader","DS/XCityTools/Disposer"],function(e,t,i,s,r,n,a,o,l,h,c,d,u,p,m,f,g,y){"use strict";return i.extend({init:function(e,i){this._parent(e,i),this.urban=e,this._billboardCSSMaploaded=!1,this.instancing=!0,this.geoJSON={},this._node=new s,this._node.name="FactoryPointOfInterest3D",this._node.hwInstancing=this.urban.USR.hwInstancing,this._webglEvent=c.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this)),this._node.setMatrix(new t.Matrix4);var n=this.urban.USR.viewpoint,l=new t.Matrix4;if(l.scale(new t.Vector3(1,1,1/n.urban.USR.scale)),this._node.setMatrix(l),this._disableMercatorScaleFactor=function(e){var i=new t.Matrix4;i.scale(new t.Vector3(1,1,1/e.urban.USR.scale)),this._node.setMatrix(i)},n.addEvent("onCameraShift",this._disableMercatorScaleFactor,this),this._geometrySet=i.geometrySet,i.geometrySet=void 0,this.factoryParam=UWA.clone(i),this.styleClass=void 0,this.samplingFactor=void 0!==i.samplingFactor?i.samplingFactor:1,this.nameAttribute=void 0!==i.nameAttribute?i.nameAttribute:"NAME",this.stridAttribute=void 0!==i.stridAttribute?i.stridAttribute:"STRID",this.styleClassAttribute=void 0!==i.styleClassAttribute?i.styleClassAttribute:"STYLECLASS",this.altitudeAttribute=void 0!==i.altitudeAttribute?i.altitudeAttribute:"ALTITUDE",this.heightAttribute=void 0!==i.heightAttribute?i.heightAttribute:"HEIGHT",this.anchorLineWidth=void 0!==i.anchorLineWidth?i.anchorLineWidth:1,this.orientationAttribute=void 0!==i.orientationAttribute?i.orientationAttribute:"ORIENTATION",this.switchDistance=void 0!==i.switchDistance?i.switchDistance:0,this.shapeType="pyramid",this._isReady=!1,this.rdblink=!0,this.type=0,void 0!==i.shapeType){var d=i.shapeType.toLowerCase();"billboard"===d||"disc"===d||"sphere"===d||"tube"===d||"pyramid"===d?(this.factoryParam.shapeType=d,this._isReady=!0):e.USR.hwInstancing?(this.shapeType=i.shapeType,this.factoryParam._posSize={},e.modelLoader.load({url:this.shapeType},function(e,t,i){this.factoryParam._posSize.center=e.bSphere.center.clone(),this.factoryParam._posSize.radius=e.bSphere.radius,this.factoryParam._posSize.altitude=e.bBox.min.z,this.factoryParam._posSize.height=e.bBox.max.z-e.bBox.min.z,this.factoryParam._posSize.width=e.bBox.max.y-e.bBox.min.y,this.factoryParam._posSize.length=e.bBox.max.x-e.bBox.min.x,e.traverse(function(e){e instanceof r&&(this.factoryParam.modelMesh3d=e,this._isReady=!0)}.bind(this))}.bind(this))):h.warn("Unable to load the model or hw instancing is not activated...")}if(this.alwaysDisplayText=!!i.alwaysDisplayText&&i.alwaysDisplayText,i.alwaysDisplayText=!1,a.is(i.rendering)||(this._rendering=this.createNewRenderingHandler(this.factoryParam.shapeType,e,i),this.factoryParam.rendering=this._rendering),this.displayClusterHits=!0,this.nbSelectedNode=0,this.initLabelOnSelect(e,i.renderType),this.eventOnVisibilityParent=!1,this.minMaxTmp={minX:0,maxX:0,minY:0,maxY:0,minZ:0,maxZ:0},this._frame=0,this._refreshFrame=10,this._minimumHits=10,this._densityFactor=1,this._nbSteps=6,this._nHitsTotal=1e5,this._clusterScale=5,this._magnitude=null,this.rtreeMin=5,this.rtreeMax=10,this.rtreeCoverageFactor=1.5,this._digitTextureReady=!0,this.nbFeature=0,void 0===o.textTexture.clusterDigits){this._digitTextureReady=!1;g.loadTexture(function(e){e.minFilter=t.NearestFilter,e.magFilter=t.NearestFilter,o.textTexture.clusterDigits={map:e,params:{width:e.image.width,height:e.image.height,topText:e.image.height/2,leftText:-e.image.width/2,samplingFactor:1}},this._digitTextureReady=!0}.bind(this),"XCityGeometry/assets/img/cluster_digit.png")}this._rendering.addDefaultAltitudeFromAttributes(this.heightAttribute,this.altitudeAttribute)},isBillboard:function(){return this.factoryParam&&"billboard"===this.factoryParam.shapeType},createNewRenderingHandler:function(e,t,i,s){return"billboard"===e?new u(t,i,s):new d(t,i,s)},destroy:function(){this.urban.USR.getScene().remove(this._node),void 0!==this._webglEvent&&c.unsubscribe(this._webglEvent),void 0!==this.updateToken&&c.unsubscribe(this.updateToken),this.urban.USR.viewpoint.removeEvent("onCameraShift",this._disableMercatorScaleFactor,this),void 0!==this.rtreeNodes&&(this.rtreeNodes=[],this.rtrees=[]),this._parent()},isReady:function(){return this._isReady&&this._digitTextureReady},dispose:function(){},setRendering:function(e){return!1},_computeMinMax:function(e){var t={minX:0,maxX:0,minY:0,maxY:0,minZ:0,maxZ:0};return this.minMaxTmp.minX=t.minX=Math.min(this.minMaxTmp.minX,e.minX),this.minMaxTmp.maxX=t.maxX=Math.max(this.minMaxTmp.maxX,e.maxX),this.minMaxTmp.minY=t.minY=Math.min(this.minMaxTmp.minY,e.minY),this.minMaxTmp.maxY=t.maxY=Math.max(this.minMaxTmp.maxY,e.maxY),this.minMaxTmp.minZ=t.minZ=Math.min(this.minMaxTmp.minZ,e.minZ),this.minMaxTmp.maxZ=t.maxZ=Math.max(this.minMaxTmp.maxZ,e.maxZ),t},getData:function(e){var i=new s;if(void 0!==e.rtree){void 0===this.updateToken&&(this.updateToken=c.subscribeTo("/3DEXPERIENCity/onUpdate",this._update.bind(this))),void 0===this.rtreeNodes&&(this.rtreeNodes=[],this.rtrees=[]);var r=e.clusterSet.getMesh();r.name="rtreeMeshCluster_"+e.tile.LOD+"_"+e.tile.I+"_"+e.tile.J,this.rdblink&&(r.setPickable(n.NOPICKABLE),r.children[0].setPickable(n.NOPICKABLE),2===r.children.length&&r.children[1].setPickable(n.NOPICKABLE));for(var o=0;o<r.children.length;++o)r.children[0].clusterInfo={LOD:e.tile.LOD,I:e.tile.I,J:e.tile.J,rtree:e.rtree};var l=e.leafSet.getMesh();l.name="leafMeshCluster_"+e.tile.LOD+"_"+e.tile.I+"_"+e.tile.J,l.children[0].clusterInfo={LOD:e.tile.LOD,I:e.tile.I,J:e.tile.J,isLeaf:!0},2===l.children.length&&(l.children[1].clusterInfo={LOD:e.tile.LOD,I:e.tile.I,J:e.tile.J,isLeaf:!0}),e.tileNode.addChild(r),e.tileNode.addChild(l),e.tileNode.addChild(new s);var h=(new t.Matrix4).identity().setPosition(new t.Vector3(e.posTile.x,e.posTile.y,0));e.tileNode.setMatrix(h);for(var d=-1,u=0;u<this.rtrees.length;++u)this.rtrees[u].clusterSTRID===e.rtree.clusterSTRID&&(d=u);if(e.rtree.shift=[e.posTile.x,e.posTile.y],e.rtree.billboardSize=[e.leafSet.scaleCulling,e.leafSet.scaleCulling],d>-1?(this.rtreeNodes[d]=e.tileNode,this.rtrees[d]=e.rtree):(this.rtreeNodes.push(e.tileNode),this.rtrees.push(e.rtree),e.rtree.tile={LOD:e.tile.LOD,I:e.tile.I,J:e.tile.J}),e.rtree.computeHits(),e.rtree.firstUpdate=!0,e.tileNode.name="tileNodePoi3dCluster_"+e.tile.LOD+"_"+e.tile.I+"_"+e.tile.J,i=e.tileNode,a.is(e.labelsNode)&&e.tileNode.addChild(e.labelsNode),e.namingMeshes){(f=new s).name="namingMeshes";for(o=0;o<e.namingMeshes.length;++o)f.addChild(e.namingMeshes[o]);i.addChild(f)}i.clusterType=2}else if(void 0!==e.poiSet){var p=e.poiSet.getMesh();this.maxMinMax=this._computeMinMax(e.poiSet.minMaxOrig);h=(new t.Matrix4).identity().setPosition(new t.Vector3(e.posTile.x,e.posTile.y,0));if(p.setMatrix(h),e.tileNode.clusterType=0,!0===e.qtCluster){p.setPickable(n.NOPICKABLE),p.name="qtcluster_"+e.tile.LOD+"_"+e.tile.I+"_"+e.tile.J;for(var m=0;m<p.children.length;++m)p.children[m].clusterInfo={LOD:e.tile.LOD,I:e.tile.I,J:e.tile.J,qtClusterBbox:e.qtClusterBbox};e.tileNode.clusterType=1}e.tileNode.addChild(p),i=e.tileNode;let r=e.labelsNode;if(r&&(r.name="labelsMeshes",r.setMatrix(h),i.addChild(r)),e.namingMeshes){var f;(f=new s).name="namingMeshes",f.setMatrix(h);for(o=0;o<e.namingMeshes.length;++o)f.addChild(e.namingMeshes[o]);i.addChild(f)}}return i=this.geometryToReturn(i)},geometryToReturn:function(e){var i=this._rendering.getCompleteMaterialInfo();if(e&&i&&i.noGeometry){var r=e.getBoundingSphere().center,n=new t.Matrix4;n.setPosition(r);var a=new s;return a.setMatrix(n),a.name=e.name,a.clusterType=e.clusterType,a}return e},disposeRtree:function(e){if(void 0!==this.rtreeNodes&&a.is(e)){for(var t=-1,i=0;i<this.rtreeNodes.length;++i)if(this.rtreeNodes[i].name===e.name){t=i;break}t>-1&&(this.rtreeNodes.splice(t,1),this.rtrees.splice(t,1))}},_update:function(e){if(void 0!==this.rtrees){let e=!1;var i=this.urban.getViewpoint(),s=i.frustum.clone(),r=new t.Vector3(-i._camShiftedTranslation.x+this.urban.shiftedPosition.x,-i._camShiftedTranslation.y+this.urban.shiftedPosition.y,-i._camShiftedTranslation.z+this.urban.shiftedPosition.z),n=new t.Vector3(i._camOldPosition.x+r.x,i._camOldPosition.y+r.y,i._camOldPosition.z+r.z);n=i.getPosition();var a=new t.Vector3(i._camShiftedTranslation.x+r.x,i._camShiftedTranslation.y+r.y,i._camShiftedTranslation.z+r.z);s.set(s.planes[0].clone().translate(a),s.planes[1].clone().translate(a),s.planes[2].clone().translate(a),s.planes[3].clone().translate(a),s.planes[4].clone().translate(a),s.planes[5].clone().translate(a));var o=new t.Matrix4,l=new t.Vector4,h=new t.Vector4,d=0,u=this._rendering.getCompleteMaterialInfo();if(u.noGeometry)return;for(var p=0;p<this.rtrees.length;++p){var m=this.rtrees[p],f=new t.Vector3(m.shift[0],m.shift[1],0);if(this._frame%this._refreshFrame==0||!0===m.firstUpdate){if(m.firstUpdate=!1,this.rdblink)g=m.getVisibleNodes(n,s,f,this._minimumHits);else var g=m.getVisibleNodesTest(n,s,f,1,this.rtreeCoverageFactor);if(e=e||g.changed,g.changed&&this.rtreeNodes[p].children.length>0){for(var v=0,b=0,x=0;x<g.visibleNodes.length;++x)g.visibleNodes[x].nHits>0&&(1===g.visibleNodes[x].mag?b++:v++);if(u.label&&u.label.enable&&this.rtreeNodes[p].children[3])for(var _=0;_<this.rtreeNodes[p].children[3].children.length;++_)this.rtreeNodes[p].children[3].children[_].setVisibility(!1);if(this.rtreeNodes[p].children[4])for(_=0;_<this.rtreeNodes[p].children[4].children.length;++_)this.rtreeNodes[p].children[4].children[_].setVisibility(!1);for(_=0;_<this.rtreeNodes[p].children[0].children.length;++_){if((O=this.rtreeNodes[p].children[0].children[_]).mesh3js._instancingInfos.instanceAttribArrays.instanceMatrix){O.nbInstances=v,O.mesh3js.nbInstances=v,O.mesh3js._instancingInfos.nbInstances=v;for(var C=0;C<O._occurrences.length;C++){O._occurrences[C].renderable.nbInstances=v,O._occurrences[C].renderable.highlight&&(O._occurrences[C].renderable.highlight.nbInstances=v)}}else{O.nbInstances=0,O.mesh3js.nbInstances=0,O.mesh3js._instancingInfos.nbInstances=0;for(C=0;C<O._occurrences.length;C++){O._occurrences[C].renderable.nbInstances=0,O._occurrences[C].renderable.highlight&&(O._occurrences[C].renderable.highlight.nbInstances=0)}}}for(_=0;_<this.rtreeNodes[p].children[1].children.length;++_){this.rtreeNodes[p].children[1].children[_].nbInstances=b,this.rtreeNodes[p].children[1].children[_].mesh3js.nbInstances=b,this.rtreeNodes[p].children[1].children[_].mesh3js._instancingInfos.nbInstances=b;for(C=0;C<this.rtreeNodes[p].children[1].children[_]._occurrences.length;C++){this.rtreeNodes[p].children[1].children[_]._occurrences[C].renderable.nbInstances=b,this.rtreeNodes[p].children[1].children[_]._occurrences[C].renderable.highlight&&(this.rtreeNodes[p].children[1].children[_]._occurrences[C].renderable.highlight.nbInstances=b)}}y.traverseV6(this.rtreeNodes[p].children[2]);var S=0,D=0;for(x=0;x<g.visibleNodes.length;++x){for(var P=g.visibleNodes[x];1===P.nHits&&1===P.children.length;)P=P.children[0];if(P.nHits>0){"billboard"===this.factoryParam.shapeType?(o.elements[0]=2*this.rtreeNodes[p].children[1].children[0].mesh3js.userData.__initScale[0][0]/m.billboardSize[0],o.elements[5]=2*this.rtreeNodes[p].children[1].children[0].mesh3js.userData.__initScale[0][1]/m.billboardSize[1],o.elements[10]=this.rtreeNodes[p].children[1].children[0].mesh3js.userData.__initScale[0][2]):(o.elements[0]=this.rtreeNodes[p].children[1].children[0].mesh3js.userData.__initScale[0][0],o.elements[5]=this.rtreeNodes[p].children[1].children[0].mesh3js.userData.__initScale[0][1],o.elements[10]=this.rtreeNodes[p].children[1].children[0].mesh3js.userData.__initScale[0][2]/2);for(var M=[67,60,53,46,39,32,25,18],w=0,T=!1,I=0,A=this._clusterSteps.length-1;A>=0;--A)P.mag>=this._clusterSteps[A]&&!T&&P.mag>1&&(T=!0,w=M[I]),I++;if(T&&(o.elements[0]=100*w/2,o.elements[5]=100*w/2,o.elements[10]=100*w/2),o.elements[12]=P.center.x-f.x,o.elements[13]=P.center.y-f.y,o.elements[14]=(P.boundingBox.max.z+P.boundingBox.min.z)/2,1===P.mag){o.elements[14]=P.infos.altitude+P.infos.height,l.x=P.center.x-f.x,l.y=P.center.y-f.y,l.w=P.infos.height/2,l.z=P.infos.altitude+l.w;for(_=0;_<this.rtreeNodes[p].children[1].children.length;++_){if((O=this.rtreeNodes[p].children[1].children[_]).mesh3js.userData.instanceIds){var V=O.mesh3js.userData.instanceIds.indexOf(P.infos.strid);h=O.mesh3js.userData.instanceColor[V],d=O.mesh3js.userData.instanceFlags[V],O.mesh3js._instancingInfos.instanceAttribArrays.instanceMatrix?(O.updateInstanceAttribValue({instanceId:5*D+5,attribName:"instanceMatrix",value:o}),O.updateInstanceAttribValue({instanceId:5*D+5,attribName:"instanceColor",value:h}),O.updateInstanceAttribValue({instanceId:5*D+5,attribName:"instanceFlag",value:d})):(O.updateInstanceAttribValue({instanceId:5*D+5,attribName:"instanceAnchor",value:l}),O.updateInstanceAttribValue({instanceId:5*D+5,attribName:"instanceColor",value:h}),O.updateInstanceAttribValue({instanceId:5*D+5,attribName:"instanceFlag",value:d})),O._occurrences[0].renderable.userData.cgmIds&&(O._occurrences[0].renderable.userData.cgmIds[D]=P.infos.strid)}}if(u.label&&u.label.enable&&this.rtreeNodes[p].children[3]){var F;for(_=0;_<this.rtreeNodes[p].children[3].children.length;++_)(F=this.rtreeNodes[p].children[3].children[_]).name==="textNode_"+P.infos.strid&&F.setVisibility(!0)}if(this.rtreeNodes[p].children[4]){var N;for(_=0;_<this.rtreeNodes[p].children[4].children.length;++_)(N=this.rtreeNodes[p].children[4].children[_]).name==="textNode_"+P.infos.strid&&N.setVisibility(!0)}D++}else{P.tmpIndexCluster=S;for(_=0;_<this.rtreeNodes[p].children[0].children.length;++_){var O;(O=this.rtreeNodes[p].children[0].children[_]).mesh3js._instancingInfos.instanceAttribArrays.instanceMatrix&&O.updateInstanceAttribValue({instanceId:5*S+5,attribName:"instanceMatrix",value:o}),O._occurrences[0].renderable.userData.cgmIds&&(O._occurrences[0].renderable.userData.cgmIds[S]=P.clusterId)}S++}if(P.mag>1&&this.displayClusterHits){var E=new t.Vector3(P.center.x-f.x,P.center.y-f.y,o.elements[14]),R=this._generateTextOpti(E,P.mag?P.mag:P.nHits,void 0,!0);R.setFrustumCulled(!1),this.rtreeNodes[p].children[2].addChild(R)}}}c.publish("/3DEXPERIENCity/onClusterUpdate",this.rtreeNodes[p].children[1].children[0])}}}this._frame++,e&&this._node.userData._attributes.selected&&(xCity._urbanImpl.USR._modelHightlighter._unhighlightElement(!0,this._node.userData._attributes.Content._node),xCity._urbanImpl.USR._modelHightlighter._highlightElement(!0,this._node.userData._attributes.Content._node))}},updateShapeType:function(e){var t=this.factoryParam.shapeType,i=e.shapeType;this.factoryParam.shapeType=e.shapeType,"billboard"!==t&&"billboard"!==i||(this._rendering=this.createNewRenderingHandler(i,this.urban,this.factoryParam,this._rendering),this._rendering.addDefaultAltitudeFromAttributes(this.heightAttribute,this.altitudeAttribute),this._leafSetRendering&&(this._leafSetRendering=null),this._qtClusterSetRendering&&this._rendering.setQtClusterSetRendering(this._qtClusterSetRendering),this._clusterSetRendering&&this._rendering.setClusterSetRendering(this._clusterSetRendering)),this.factoryParam.rendering._proxyHandler&&(this._rendering._proxyHandler=this.factoryParam.rendering._proxyHandler,this._rendering._proxyHandler._subRenderingHandler[0]=this._rendering),this.factoryParam.rendering=this._rendering,this._geometrySet&&(this._geometrySet._poiSet._rendering=this._rendering,this._geometrySet.getRendering()._subRenderingHandler[0]=this._rendering)},buildOne:function(e,i,r,n){var h,c,d,u,p,f;this.eventOnVisibilityParent||(this.eventOnVisibilityParent=!0,this._node.userData&&this._node.userData.addEvent("onChange:visible",this.removeAllInfoNodes,this));var g=e.getAttribute(this.orientationAttribute);void 0===g?g=[0]:"number"==typeof g?g=[g]:"string"==typeof g&&(g=g.split(" "));var y=e.getGeometry();if(y.type===l.Type.POINT||y.type===l.Type.MULTIPOINT){h=e.getAttribute(this.stridAttribute),c=e.getAttribute(this.nameAttribute),d=y.getVertices();var v=this,b=function(l){var d=e.attributes,y=v._rendering.getCompleteMaterialInfo();if(v.factoryParam.nbVertices=y.nbVertices,v.switchDistance=y.switchDistance,v.factoryParam.switchDistance=y.switchDistance,v.factoryParam.shapeType!==y.shapeType&&v.updateShapeType(y),y=v._rendering.getCompleteMaterialInfo(h,d),void 0===i.posTile&&(i.posTile=new t.Vector2(Math.round(l[0]),Math.round(l[1])),i.nbPoi=0,i.textMaterial=[],i.widthText={},i.heightText={},i.textTexture={},i.tileNode=new s,i.nbPoi=0),1===n){if(void 0===i.rtree){i.rtree=new m(v.rtreeMin,v.rtreeMax,v.urban,Math.max(xCity.distanceToTarget/2,1e3));var b=h.toString(),x=b.lastIndexOf("-");if(b=(b=b.slice(0,x))+"-Cluster_"+r.tile.LOD+"_"+r.tile.I+"_"+r.tile.J,i.rtree.clusterSTRID=b,!v._leafSetRendering){var _=Object.assign({},v.factoryParam,v._rendering.getCompleteMaterialInfo());v._leafSetRendering=v.createNewRenderingHandler(_.shapeType,v.urban,_),v._rendering.setLeafSetRendering(v._leafSetRendering)}var C=Object.assign({},v.factoryParam,{rendering:v._leafSetRendering});if(i.leafSet=new o(v.urban,C,i),!v._clusterSetRendering){var S=Object.assign({},v._rendering.getCompleteMaterialInfo(),{shapeType:"sphere",nbVertices:15,switchDistance:0});v._clusterSetRendering=v.createNewRenderingHandler("sphere",v.urban,S),v._rendering.setClusterSetRendering(v._clusterSetRendering)}var D=Object.assign({},v.factoryParam,{rendering:v._clusterSetRendering,shapeType:"sphere",nbVertices:15,switchDistance:0});i.clusterSet=new o(v.urban,D,i)}}else 0===n&&(i.qtCluster=!0);if(1!==n&&void 0===i.poiSet){var P=v.factoryParam;if(0===n){if(!v._qtClusterSetRendering){var M=Object.assign({},v.factoryParam,v._rendering.getCompleteMaterialInfo(),{mapUrl:null,shapeType:"sphere",nbVertices:15,switchDistance:0});v._qtClusterSetRendering=v.createNewRenderingHandler("sphere",v.urban,M),v._rendering.setQtClusterSetRendering(v._qtClusterSetRendering)}P=Object.assign({},v.factoryParam,{rendering:v._qtClusterSetRendering,shapeType:"sphere",nbVertices:15,switchDistance:0})}i.poiSet=new o(v.urban,P,i)}f=i.posTile,u=[1,1,1],a.is(y.scale)&&(u[0]=y.scale.x,u[1]=y.scale.y,u[2]=y.scale.z),new t.Color(16777215),1;var w=v._rendering.getPrimitiveRenderingValues(h,d);if(a.is(w)&&(a.is(w.color)&&w.color.computeColor(),a.is(w.opacity)&&w.opacity,a.is(w.scale)&&(u[0]=w.scale.x,u[1]=w.scale.y,u[2]=w.scale.z)),0===n||1===n)for(var T=[67,60,53,46,39,32,25,18],I=!1,A=0,V=v._clusterSteps.length-1;V>=0;--V)d.nhits>=v._clusterSteps[V]&&!I&&(I=!0,u[0]=T[A],u[1]=T[A],u[2]=T[A]),A++;p=v._computeAltitudeToApply(y,l,e);var F=""!==y.styleClass?y.styleClass:e.getAttribute(v.styleClassAttribute),N=new t.Vector3(u[0],u[1],u[2]);n&&void 0===v._rtreeFeatureScale&&(v._rtreeFeatureScale=N),r.posSize.center.set(l[0],l[1],p),0===n?(r.posSize.width=2*e.getAttribute("radius"),r.posSize.length=r.posSize.width,r.posSize.height=N.z,r.posSize.altitude=p,i.qtClusterBbox=e.getAttribute("bbox")):(r.posSize.width=N.y,r.posSize.length=N.x,r.posSize.height=N.z,r.posSize.altitude=p);var O=Number(v.heightAttribute);isNaN(O)&&(O=Number(e.getAttribute(v.heightAttribute))),isNaN(O)&&(O=0),1===n&&i.rtree.insert({x:l[0],y:l[1],z:p+O,w:1,h:1,mag:v._magnitude?parseInt(e.getAttribute(v._magnitude)):1,infos:{strid:h,altitude:p,height:O}});var E,R={name:c,strid:h,styleClass:F,altitude:p,height:O,localScale:[N.x,N.y,N.z],orientation:g,attributes:d,material:y},L={name:c,strid:h,styleClass:F,altitude:p,height:O,localScale:[N.x,N.y,N.z],orientation:g,attributes:d,material:y};if(void 0!==v.styleClass&&v.styleClass===R.styleClass||(v.styleClass=R.styleClass),1===n){if(R.localScale=[N.x,N.y,N.z],E=i.clusterSet.addPointOfInterest(new t.Vector3(l[0]-f.x,l[1]-f.y,0),L),R.localScale=[N.x,N.y,N.z],E=i.leafSet.addPointOfInterest(new t.Vector3(l[0]-f.x,l[1]-f.y,0),R),!v._billboardCSSMaploaded&&v.isBillboard()){v._billboardCSSMaploaded=!0;let e=new o(v.urban,v.factoryParam,i);e.initBillboardCSSMap(),a.is(R.mapUrl)&&e.initBillboardMap(R),e.loadBillboardMap()}}else E=i.poiSet.addPointOfInterest(new t.Vector3(l[0]-f.x,l[1]-f.y,0),R);v.nbFeature++,i.nbPoi++;var z=new t.Vector3(l[0]-f.x,l[1]-f.y,p+O);if(0===n&&v.displayClusterHits){var U=v._generateTextOpti(z,e.getAttribute("nhits"),R.strid,!0);U.setFrustumCulled(!1),a.is(i.namingMeshes)||(i.namingMeshes=[]),i.namingMeshes.push(U)}if(v._shouldCreateLabelFromMaterial(y)&&0!==n){var k={};k=a.is(E)?"billboard"===v.factoryParam.shapeType?{width:E.x,length:E.z,height:E.y}:{width:E.y,length:E.x,height:E.z}:{width:0,length:0,height:0},a.is(i.labelMeshes)||(i.labelMeshes=[]);let t=a.generateLabelPriorities(v._node,e);i.labelsNode||(i.labelsNode=new s,i.labelsNode.name="labelsMeshes"),i.labelMeshes.push(v._generateLabel(z,R.strid,y,k,i.posTile,t,i.labelsNode))}};if(y.type===l.Type.MULTIPOINT)for(let e=0;e<d.length;e++)b(d[e]);else b(d)}},_generateTextUsingLabel:function(e,t,i,s,r){var n=this._rendering.getCompleteMaterialInfo(i);n.label.name=t;var a=this._generateLabel(e,i,n,s);if(a.setFrustumCulled(!1),!0===r)return a;this.infoNode.setVisibility(!0),this.infoNode.addChild(a)},_generateTextOpti:function(e,i,s,r){var n={styleClass:this.styleClass,pClass:"poiText",samplingFactor:this.samplingFactor},a=o.generateTextNodeOpti(this.urban,i,n);if(a.name="textNode_"+s,a.setMatrix((new t.Matrix4).translate(new t.Vector3(e.x,e.y,e.z))),!0===r)return a;this.infoNode.setVisibility(!0),this.infoNode.addChild(a)},_generateTextMesh:function(e,i,s,r){r.name="textNode_"+s,r.setMatrix((new t.Matrix4).translate(new t.Vector3(e.x,e.y,e.z)));var n=new t.TextGeometry(i,{font:"arial nova"}),a=new t.Mesh(n),o=f.createNodeFromTHREEMesh(a);r.add(o)},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1},removeAllInfoNodes:function(e,t){t||(this.infoNode.removeChildren(),this.nbSelectedNode=0,this.infoNode.setVisibility(!1))},attributeSetter:{color:"setColor",opacity:"setOpacity"},setGeomAttribute:function(e,t,i){if(e)for(var s=0;s<e.length;s++){var r=THREEDS.SubElement.getFromSGNode(e[s].subElement);e[s].mesh[this.attributeSetter[t]](i,[r.sgNode,e[s].strid])}},getDatas:function(e){var t=[];t[0]={attributes:e.userData,target:e.geom};for(var i=0;i<t[0].target.length;++i)t[0].target[i].strid=e.strid;return t},getGeoJSON:function(e){return this.geoJSON[e]},_computeLabelPos:function(e,t){t||(t=this._rendering.getCompleteMaterialInfo(e._getStrid(),e.userData));var i=a.cloneRecKeepingClasses(e.getLocalPosition()),s=this._computeAltitudeToApply(t,i.toArray()),r=Number(this.heightAttribute);return isNaN(r)&&(r=Number(e.userData[this.heightAttribute])),isNaN(r)&&(r=0),i.z=s+r,this._patchZPositionProjection(i),i},_computeGeometrySize:function(e,t){var i=this._getPrimInfo(e).posSize,s={width:i.width,length:i.length,height:i.height};if("billboard"===this.factoryParam.shapeType){t||(t=this._rendering.getCompleteMaterialInfo(e._getStrid(),e.userData));var r=this._rendering,n=r.getTextureInfo(t.mapUrl);a.is(n)||(t=(r=this._leafSetRendering).getCompleteMaterialInfo(e._getStrid(),e.getUserData()),n=r.getTextureInfo(t.mapUrl));var o=n.width;a.is(n.atlasWidth)&&(o*=n.atlasWidth);var l=n.height;a.is(n.atlasHeight)&&(l*=n.atlasHeight),s.width*=o,s.height*=l}return s},_getPrimInfoFromPreview:function(e){if(a.is(this._node.userData.getContent()._poiSet)&&a.is(this._node.userData.getContent()._poiSet.primInfos))return this._node.userData.getContent()._poiSet.primInfos[e]}})}),define("DS/XCityGeometry/PatchVectorFactoryGeometry",["UWA/Class","DS/XCityGeometry/PatchVectorFactoryPolygon","DS/XCityGeometry/PatchVectorFactoryLine","DS/XCityGeometry/PatchVectorFactoryPointOfInterest3D","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/XCityTools/Geocoder","DS/XCityTools/PrimitiveGeometryCreator","DS/Visualization/SceneGraphFactory","DS/XCityLayer/Vector","DS/XCityGeometry/Polygon","DS/XCityTools/Debug","DS/XCityRendering/RenderingHandlerProxy","DS/xCityBasicUtils/Utils","DS/XCityGeometry/PatchVectorFactory"],function(e,t,i,s,r,n,a,o,l,h,c,d,u,p,m,f){"use strict";var g=f.extend({init:function(e,r){this._parent(e,r),this.urban=e,this._node=new a,this._node.name="FactoryGeometry",this._node.hwInstancing=!0;this._factoryPoint=new s(e,{shapeType:"sphere",nameAttribute:"name",heightAttribute:10,renderAnchor:!0,switchDistance:500}),this._factoryLine=new i(e,r),this._factoryPolygon=new t(e,r),this._rendering=new p(e,r),this._rendering.addSubRenderingHandler(this._factoryPoint._rendering),this._factoryPoint._rendering._proxyHandler=this._rendering,this._rendering.addSubRenderingHandler(this._factoryLine._rendering),this._rendering.addSubRenderingHandler(this._factoryPolygon._rendering),this._isReady=!0,u.log("PatchVectorFactoryGeometry:init")},isReady:function(){return this._isReady},destroy:function(){this.urban.getView3D().getScene().remove(this._node),this._factoryPoint.destroy(),this._factoryLine.destroy(),this._factoryPolygon.destroy()},dispose:function(){},getData:function(e){var t=new a,i=this._factoryPoint.getData(e.sessionPoint);i.indexMesh=0,t.addChild(i);var s=this._factoryLine.getData(e.sessionLine);s.indexMesh=1,t.addChild(s);var r=this._factoryPolygon.getData(e.sessionPolygon);return r.indexMesh=2,t.addChild(r),t},buildOne:function(e,t,i,s){t.sessionPoint||t.sessionLine||t.sessionPolygon||(t.sessionPoint={tile:t.tile,infos:t.infos},t.sessionLine={tile:t.tile,infos:t.infos},t.sessionPolygon={tile:t.tile,infos:t.infos,ltileGeoms:{}}),this._factoryPoint.patch||(this._factoryPoint.patch=this.patch,this._factoryLine.patch=this.patch,this._factoryPolygon.patch=this.patch);var r=e.getGeometry();r.type===c.Type.POINT||r.type===c.Type.MULTIPOINT?this._factoryPoint.buildOne(e,t.sessionPoint,i,s):r.type===c.Type.LINESTRING||r.type===c.Type.MULTILINESTRING?this._factoryLine.buildOne(e,t.sessionLine,i):r.type!==c.Type.POLYGON&&r.type!==c.Type.MULTIPOLYGON||this._factoryPolygon.buildOne(e,t.sessionPolygon,i)},_getPrimInfoFromPreview:function(e){}});return Object.defineProperty(g.prototype,"_clusterSteps",{get:function(){return this._factoryPoint._clusterSteps},set:function(e){this._factoryPoint._clusterSteps=e}}),Object.defineProperty(g.prototype,"_minimumHits",{get:function(){return this._factoryPoint._minimumHits},set:function(e){this._factoryPoint._minimumHits=e}}),g}),define("DS/XCityGeometry/PatchVectorFactoryFile",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/xCityBasicUtils/Utils","DS/XCityLoaders/ModelLoader","DS/XCityGeometry/PatchVectorFactory","DS/XCityRendering/RenderingHandlerFile","DS/XCityTools/EventDispatcher"],function(e,t,i,s,r,n,a){"use strict";return r.extend({init:function(e,i){this._parent(e,i),this.urban=e,this.fileNameAttribute=void 0!==i.fileNameAttribute?i.fileNameAttribute:"FILENAME",this.stridAttribute=void 0!==i.stridAttribute?i.stridAttribute:"STRID",this.pathBuilding=i.path,this.suffix=i.suffix,this.shader=i.shader||"building",this.Shader=i.Shader||{name:this.shader},this.shadow=void 0===i.shadow||i.shadow,this._rendering=new n(e,i),this._node=new t,this._node.name="FactoryFile",this.urlOptions="",a.subscribeTo("/3DEXPERIENCity/webGLContextLost",this.dispose.bind(this))},destroy:function(){this.urban.USR.getScene().remove(this._node)},dispose:function(){},getData:function(e){var i=new t;for(var s in e.ltileGeoms){var r=e.ltileGeoms[s];i.add(r)}return i},initMesh:function(e,t,i,s,r){},buildOne:function(e,t,s){var r=e.getAttribute(this.stridAttribute),n=e.getAttribute(this.fileNameAttribute);if(i.is(n)){this.suffix&&(-1!==n.lastIndexOf(".")?n=n.substring(0,n.lastIndexOf(".")+1):n+=".",n+=this.suffix);var a=this.pathBuilding.indexOf("?");""===this.urlOptions&&-1!==a&&(this.urlOptions=this.pathBuilding.substring(a),this.pathBuilding=this.pathBuilding.substring(0,a));var o={name:r,url:this.pathBuilding+n,urlOptions:this.urlOptions,shader:this.Shader,shifted:!0,shadow:this.shadow,rendering:this._rendering,color:e.getAttribute("color"),opacity:e.getAttribute("opacity")},l=this.urban.modelLoader.load(o,t.indexPrimitive);t.ltileGeoms[r]=l}},setAttribute:function(e,t){return!1},updateAttribute:function(e,t){return!1},attributeSetter:{color:"setColor",opacity:"setOpacity"},setGeomAttribute:function(e,t,i){return e[this.attributeSetter[t]](i),this},getDatas:function(e){var t=[],i=this.stridAttribute||"STRID",s={};return e.geom&&(s[i]=e.strid,t[0]={attributes:s,target:e.geom[0].subElement}),t}})}),define("DS/XCityGeometry/PatchVector",["UWA/Core","UWA/Class","UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Mesh3D","DS/Visualization/Node3D","DS/XCityLayer/Vector","DS/xCityBasicUtils/DataFormatTools","DS/xCityBasicUtils/Utils","DS/XCityGeometry/PatchVectorFactoryModel","DS/XCityGeometry/PatchVectorFactoryFile","DS/XCityGeometry/PatchVectorFactoryPolygon","DS/XCityGeometry/PatchVectorFactoryLine","DS/XCityTools/Disposer","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher","DS/XCityTools/Downloader"],function(e,t,i,s,r,n,a,o,l,h,c,d,u,p,m,f,g,y){"use strict";return t.extend(i,{init:function(e,t,i){this.urban=e,this.name="SiroccoFactory",this.factory=t,this.previewMode="enovia"===i.type||"wfs"===i.type,this.clusteringMode=i.clusteringMode;void 0!==this.urban.baseURL&&this.urban.baseURL,this.numGeomTotal=0,this.numBuild=0,this.timeBuild=0,this._modelAlternLoadCount=0,this.miDToTile={},this._uidListeners={},this.nbFeaturesMax=i.nbFeaturesMax||-1,this._synchrone=window.DEBUG_SYNCHRO_MODE||!1,this.invertY=i.invertY||!1,this.alternDict={},this.alternUrl=i.alternUrl||"";for(var s,r=i.alternDict||[],n=function(e,t,i){var s,r,n;if(!1!==t){try{n=JSON.parse(e)}catch(t){n=e}for(s in n)void 0!==(r=n[s]).url&&""!==r.url&&"http"!==r.url.substring(0,4)&&(r.url=this.alternUrl+r.url),this.alternDict[s]=r}},a=0;a<r.length;++a)""!==(s=r[a])&&"http"!==s.substring(0,4)&&(s=this.alternUrl+s),y.download(s,{responseType:"json"},1,function(e,t,i,s){s(t,e,i)},void 0,n.bind(this));f.addCallback("SiroccoBuild",function(){return this.numBuild}.bind(this)),f.addCallback("SiroccoBuildGeom",function(){return this.numGeomTotal}.bind(this)),this.stridAttribute=void 0!==this.factory.stridAttribute?this.factory.stridAttribute:"STRID",this._uidAttributName=this.stridAttribute,this._uidListeners=this.miDToTile,this.buildTimeOut=void 0,this.filters=[],this.eachs=[]},dispose:function(){for(var e in f.warn("Dispose: Sirocco"),clearTimeout(this.buildTimeOut),this.mgeomToTile)this.geometryRemoved(this.mgeomToTile[e]);this.factory.dispose(),this.factory=void 0},getGeometry:function(e){var t=this.miDToTile[e];if(t)return t.geometry},cleanInfo:function(e,t,i){if(e){var s=!0;if(e.geom){for(var r=e.geom.length-1;r>=0;--r)e.geom[r].mesh.parents&&0!==e.geom[r].mesh.parents.length?e.geom[r].mesh.parents[0].storeKey===i&&e.geom.splice(r,1):e.geom.splice(r,1);0===e.geom.length?e.geom=void 0:s=!1}else e.geom=void 0;if(s){if(e._observers){for(r=0;r<e._observers.length;r++)e._observers[r](e);e._observers=void 0}if(e.listeners){for(r=0;r<e.listeners.length;r++)e.listeners[r](void 0);this.miDToTile[t]={strid:t,listeners:e.listeners}}else delete this.miDToTile[t]}else if(e.listeners)for(r=0;r<e.listeners.length;r++)e.listeners[r](e,!0)}else delete this.miDToTile[t]},geometryRemoved:function(e){if(e.userData&&e.userData.records){for(var t=e.userData.records,i=t.length;i--;){var s=t[i].strid,r=this.miDToTile[s];this.cleanInfo(r,s,e.storeKey)}e.userData=void 0}},addObserver:function(e){void 0===e.observers&&(e.observers=[]),e.observers.push(this.geometryRemoved.bind(this))},rebuild:function(e,t){if(h.is(e)&&h.is(e.value))if(h.is(e.value.node)&&h.is(e.value.node.userData)){var i=e.value.node.userData.source;this.buildDataSourceV2(this.urban,i,e)}else if(h.is(e.value.userData)){i=e.value.userData.source;this.buildDataSourceV2(this.urban,i,e)}else{if(h.is(t)){if(t>2)return}else t=1;t++,g.subscribeTo("/3DEXPERIENCity/onPostUpdate",this.rebuild.bind(this,e,t),!0)}},reset:function(e){if(e)this.rebuild(e);else{for(;this.eachs.length;)this.eachs.pop();for(;this.filters.length;)this.filters.pop()}},each:function(e,t){t?this.rebuild(t):this.eachs.push(e)},filter:function(e,t){t?this.rebuild(t):this.filters.push(e)},register:function(e,t){var i=this._uidListeners[e];i?(i.listeners?i.listeners.push(t):i.listeners=[t],i.tile&&t(i)):this._uidListeners[e]={strid:e,listeners:[t]}},unregister:function(e,t){var i=this._uidListeners[e];if(i&&i.listeners){for(var s=-1,r=0;r<i.listeners.length;++r)if(i.listeners[r].name===t.name){s=r;break}s>-1&&(i.listeners.splice(s,1),0===i.listeners.length&&this._uidListeners!==this.miDToTile&&delete this._uidListeners[e])}},buildV2:function(e,t,i,s,r){if("string"==typeof r)var n=e.loadDataSource(r);else if(void 0!==r.cluster&&null!==t)n=t.loadDataSourceFromObject(r);else n=e.loadDataSourceFromObject(r);this.buildDataSourceV2(i,n,s)},_intersectCropBBox:function(e,t,i){return void 0!==this.urban.cropBox&&this.urban.cropBox.intersectIJ(e,t,i)},buildDataSourceV2:function(t,i,r){var a=i.count;if(h.is(r.value)&&h.is(r.value.node)?(r.value={node:r.value.node,nbFeatures:a},this.geometryRemoved(r.value.node)):r.value={node:null,nbFeatures:a},0!==a){var m=r.tile.LOD,y=r.tile.I,v=r.tile.J;i.index=0;(new Date).getTime();var b=0,x=this._uidAttributName!==this.stridAttribute,_=0,C=[],S=!1;i.tile={LOD:m,I:y,J:this.invertY?(1<<m)-1-v:v,key:r.tile.key,factory:this},i.idDataSource=this.factory._node.idDataSource;var D=this._intersectCropBBox(i.tile.LOD,i.tile.I,i.tile.J),P=this,M={ltileGeoms:{},infos:{}};M.tile=i.tile;var w=[],T=[],I=function(e){listeners.infos.splice(listeners.infos.indexOf(e),1)},A=function(e,t){if(e.storeKey=r.key,e instanceof n&&!0===e.pickable){e.show();var i,s,a,o,l=e.getPrimitives();if(e.isInstanceNode3D){var c=e.mesh3js.userData.cgmIds;if(a=l[0].sgNode,void 0!==c){for(var d=c.length-1;d>=0;--d)if(o=t[c[d]]){if(o.geom?o.geom.push({subElement:a,mesh:e}):o.geom=[{subElement:a,mesh:e}],!h.is(o.listeners)){var u=this._uidListeners[c[d]];h.is(u.listeners)&&(o.listeners=[],o.listeners.push(u.listeners))}if(o.listeners&&o.listeners.length>0)for(i=0;i<o.listeners.length;++i)void 0!==(s=o.listeners[i])&&s(o)}var p=function(){for(var i=c.length-1;i>=0;--i)if((o=t[c[i]])&&o.geom){for(var s=[],r=0;r<o.geom.length;r++){o.geom[r].mesh.id!==e.id&&s.push(o.geom[r])}o.geom=s}};e.observers&&e.observers.push(p)}}else{for(d=0;d<l.length;d++)if(a=l[d].sgNode,t&&t.strid&&(a.cgmIdOld=a.getCgmId(),a._setCgmId(t.strid)),o=t[a.getCgmId()]){if(o.geom?o.geom.push({subElement:a,mesh:e}):o.geom=[{subElement:a,mesh:e}],!h.is(o.listeners)){u=this._uidListeners[a.getCgmId()];h.is(u&&u.listeners)&&(o.listeners=[],o.listeners.push(u.listeners))}if(o.listeners&&o.listeners.length>0)for(i=0;i<o.listeners.length;++i)void 0!==(s=o.listeners[i])&&s(o)}p=function(){for(d=0;d<l.length;d++)if(a=l[d].sgNode,t&&t.strid&&(a.cgmIdOld=a.getCgmId(),a.cgmId=t.strid),(o=t[a.getCgmId()])&&o.geom){for(var i=[],s=0;s<o.geom.length;s++){var r=o.geom[s].mesh;r&&r.id!==e.id&&i.push(o.geom[s])}o.geom=i}};e.observers&&e.observers.push(p)}}},V=function(e,t,i,s){if(i){t.posTile?e.posSize.center.getPositionFromMatrix(t.getMatrix()).add(t.bSphere.center).add(t.posTile):e.posSize.center.getPositionFromMatrix(t.getMatrix()).add(t.bSphere.center),t.children&&t.children.length>0&&(t=t.children[0]),e.posSize.altitude+=t.bBox.min.z,e.posSize.height=t.bBox.max.z-t.bBox.min.z,e.posSize.width=t.bBox.max.y-t.bBox.min.y,e.posSize.length=t.bBox.max.x-t.bBox.min.x;var r={};r[e.strid]=e,r.strid=e.strid,t.traverse(A.bind(this),r)}},F=function(e,t,i,s){if(null==i){if(null!=t&&null!=e){if(t!=e)return Date.parse(e)>Date.parse(s)&&Date.parse(t)<=Date.parse(s);var r=new Date(Date.parse(e));return r.setDate(r.getDate()+1),r>Date.parse(s)&&Date.parse(t)<=Date.parse(s)}return null!=t?Date.parse(t)<Date.parse(s):null==e||Date.parse(e)>Date.parse(s)}return Date.parse(s)==Date.parse(i)},N=function(){if(!P.factory.isReady||P.factory.isReady()){var n=Date.now(),m=0;if(P.numBuild++,P.intervalFuncCall++,_<a){var y=new o.Feature,v=2e3;P.urban.USR.viewpoint.camMoved&&(v=1e3);for(var O=_,E=0;_<a&&v>m+E&&null!==(y=i.getNextFeature(y));){_++;for(var R=!1,L=0;L<P.filters.length&&!R;L++)R=P.filters[L](y);if(!R){for(var z=0;z<P.eachs.length;z++)y=P.eachs[z](y);if(y.getGeometry())if(!P.urban._timefilter||1!=P.factory.isFilteredByTime||F(y.getAttribute(P.factory.lifespanenAttribute),y.getAttribute(P.factory.lifespanstAttribute),y.getAttribute(P.factory.lifespanAttribute),t.date._date)){P.numGeomTotal++;var U=y.getAttribute(P.stridAttribute),k=P.miDToTile[U];if(P.previewMode||P.clusteringMode||"searchRequest"===r.key){if(y.getGeometry().type!==o.Type.POINT&&y.getGeometry().type!==o.Type.MULTIPOINT){var X=y.getGeometry().aabbox.center;if(X.x<r.bbox.xmin||X.x>r.bbox.xmax||X.y<r.bbox.ymin||X.y>r.bbox.ymax)continue}}else if(void 0!==k&&k.tile&&(k.tile.LOD!==i.tile.LOD||k.tile.I!==i.tile.I||k.tile.J!==i.tile.J))continue;if(!1===D||!0===y.getGeometry().isInAABBOX(P.urban.cropBox)){var G,B;for(b++,i.list[_-1].cropped=!1,k?(k.tile=i.tile,k.bbox=r.bbox):k={strid:U,tile:i.tile,bbox:r.bbox,listeners:null},h.is(P.factory.geoJSON)&&(P.factory.geoJSON[U]=ee([i.list[i.index-1]])),k.posSize={center:new s.Vector3,altitude:0,height:0,width:0,length:0},k.userData={},B=(G=y.getAttributeKeys()).length;B--;)k.userData[G[B]]=y.getAttribute(G[B]);if(P.miDToTile[U]=k,C.push(k),U in P.alternDict){var j=P.alternDict[U];j.color=y.getAttribute("color"),k.userData={};for(var W=Object.keys(j),H=0,Y=W.length;H<Y;H++)k.userData[W[H]]=j[W[H]];if(k.strid=U,1===j.altern){var J=e.clone(j);J.rendering=P.factory._rendering;var q=P.urban.modelLoader.load(J,V.bind(P,k));T.push(q)}}else if(M.infos[U]=k,(P.factory instanceof c||P.factory instanceof d||P.factory instanceof u||P.factory instanceof p)&&(M.indexPrimitive=V.bind(P,k)),!1===P.urban.USR.workers||void 0===P.factory.supportWorkers||!1===P.factory.supportWorkers?P.factory.buildOne(y,M,k,P.clusteringMode?i.isCluster?0:1:void 0):void 0!==P.factory.initOne&&P.factory.initOne(y,M,k),k.listeners)w.push(k);else if(x){var Z=P._uidListeners[y.getAttribute(P._uidAttributName)];Z?w.push(k):Z={infos:[],listeners:null},Z.infos.push(k),k._observers.push(I)}}else i.list[_-1].cropped=!0;E=(m=Date.now()-n)/(_-O)}else S||(S=!0)}}y||(a=_),!0===P._synchrone?N():g.subscribeTo("/3DEXPERIENCity/onPostUpdate",N,!0)}else{if(P.time=(new Date).getTime()-n,P.timeTotal+=P.time,0===b){if(h.is(r.value)&&h.is(r.value.node)){var Q=r.value.node.getParents(),K=Q.length;if(!S)for(;K--;)Q[K].removeChild(r.value.node);r.value.node.observers=void 0,r.oldValue.push(r.value.node)}return void(r.value={node:null,userData:{records:C,source:i},nbFeatures:0})}var $=function(){var e=P.factory.getData(M);if(M.nbFeature?M.nbFeature:M.nbElement?M.nbElement:M.infos?Object.keys(M.infos).length:(0,f.warn("PatchVector did not build any feature.")),e.idDataSource=P.factory._node.idDataSource,e.storeKey=h.getQuadKey(M.tile.LOD,M.tile.I,M.tile.J),h.is(e)){e.traverse(A.bind(P),M.infos);for(var t=0;t<T.length;t++)f.log("add altern "),e.add(T[t]);P.addObserver(e),e.userData={records:C,source:i};for(var s=0;s<w.length;s++)for(var o=0;o<w[s].listeners.length;o++)w[s].listeners[o](w[s]);if(P.time=(new Date).getTime()-n,P+=P.time,e.storeKey=r.key,h.is(r.value)&&h.is(r.value.node)){for(var l=r.value.node.getParents(),c=l.length;c--;)l[c].removeChild(r.value.node),l[c].addChild(e);r.value.node.observers=void 0,r.oldValue.push(r.value.node)}}r.value={node:e,nbFeatures:a},this.urban._timefilter&&(r.value.userData={records:C,source:i})}.bind(P);!0===P.urban.USR.workers&&!0===P.factory.supportWorkers?P.factory.buildAll(M,i.list,$):$()}}else g.subscribeTo("/3DEXPERIENCity/onPostUpdate",N,!0);function ee(e){var t;t=P.factory instanceof u?"Polygon":P.factory instanceof p?"LineString":"Point";var i=0;if(e[0].metas){for(;i<e[0].metas.length&&"geometry"!==e[0].metas[i].name&&"gdal_default_geo"!==e[0].metas[i].name;)i++;var s=e[0].metas[i].value,r=l.fromWKTToArray(s);return s.contains("MULTI")||(r=[r]),l.fromArrayToJSON(r,t)}return{type:"FeatureCollection",features:e}}};!0===P._synchrone?N():g.subscribeTo("/3DEXPERIENCity/onPostUpdate",N,!0)}},load:function(e,t,i,s,r,n){this.featureLayer.load(i,t)},getUidListeners:function(){return this._uidListeners},_debug:function(e){return"time  : "+this.time+"<br />time/(1000 crossquad)  : "+Math.ceil(1e3*this.timeTotal/this.numGeomTotal)}})}),define("DS/XCityGeometry/PatchVectorCityFormat",["UWA/Class","DS/XCityGeometry/PatchVector","DS/XCityLoaders/CityLoader"],function(e,t,i){"use strict";return e.extend(t,{init:function(e,t,i){this._parent(e,t,i)},buildV2:function(e,t,i,s,r){var n;e?(n=e.loadDataSource(r),this.buildDataSourceV2(t,n,s)):this.buildCity(t,s,r,i)},buildCity:function(e,t,s,r){t.tile;var n=new i(e);n.model.url=t.url,n.model.patch=this,n.model.geolocalized=r,n.model.rendering=this.factory._rendering;var a=n._initRenderingCallback();n.model.callback=Utils.is(a)?a:n.model.callback,n.processBin(!0,s),this._triggerListeners(),t.value={node:n.model.node},n.model.node.storeKey=t.key},_triggerListeners:function(){for(var e in this._uidListeners)if(this._uidListeners[e].listeners&&this._uidListeners[e].listeners.length>0)for(var t=0;t<this._uidListeners[e].listeners.length;++t)this._uidListeners[e].listeners[t](this._uidListeners[e])}})}),define("DS/XCityGeometry/PatchVector3DXMFormat",["UWA/Class","DS/XCityGeometry/PatchVector","DS/XCityLoaders/ThreetyDXLoader","DS/Visualization/Mesh3D"],function(e,t,i,s){"use strict";return e.extend(t,{init:function(e,t,i){this._parent(e,t,i),this.cityLoader={}},build:function(e,t,s,r,n){var a=r.tile;this.cityLoader[a.key]=new i(e,void 0,s),this.cityLoader[a.key].model.url=r.url,this.cityLoader[a.key].model.patch=this,this.cityLoader[a.key].model.geolocalized=t,this.cityLoader[a.key].model.rendering=this.factory._rendering,this.cityLoader[a.key].model.tile=a,this.cityLoader[a.key]._oldDoneCallback=this.cityLoader[a.key]._doneCallback,this.cityLoader[a.key]._doneCallback=this._triggerListener.bind(this,a.key),n.byteLength>0&&(this.cityLoader[a.key].load(),this.cityLoader[a.key].processBin(!0,n)),r.value={node:this.cityLoader[a.key].model.node},this.cityLoader[a.key].model.node.storeKey=r.key},_triggerListeners:function(){for(var e in this._uidListeners)if(this._uidListeners[e].listeners&&this._uidListeners[e].listeners.length>0)for(var t=0;t<this._uidListeners[e].listeners.length;++t)this._uidListeners[e].listeners[t](this._uidListeners[e])},remove:function(e){for(var t in this.cityLoader[e].model.uidToPrim){var i=this.miDToTile[t];this.cleanInfo(i,t)}delete this.cityLoader[e].loader,delete this.cityLoader[e].threeDXLoader,delete this.cityLoader[e]},_triggerListener:function(e){for(var t in Utils.is(this.cityLoader[e].model.node.observers)||(this.cityLoader[e].model.node.observers=[]),this.cityLoader[e].model.node.observers.push(this.remove.bind(this,e)),this.cityLoader[e]._oldDoneCallback(),this.cityLoader[e].model.uidToPrim){var i=this._uidListeners[t].listeners;if(i)for(var s=0;s<i.length;++s)i[s](this._uidListeners[t])}}})});