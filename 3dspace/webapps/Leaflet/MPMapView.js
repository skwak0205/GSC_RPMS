define("DS/Leaflet/MPMapView",["UWA/Controls/Abstract","UWA/Core","WebappsUtils/WebappsUtils","DS/Leaflet/MPGeolocationManager","css!DS/Leaflet/MPMapView.css","DS/Leaflet/LeafletLoader","css!DS/Leaflet/Leaflet.css","DS/Leaflet/MarkerClusterLoader","css!DS/Leaflet/assets/plugin/MarkerCluster/MarkerCluster.Default.css","css!DS/Leaflet/assets/plugin/MarkerCluster/MarkerCluster.css"],function(t,e,i,o,a,n,s,r,l,c){"use strict";var h=[48.866667,2.333333],u=[[90,-180],[-90,180]];return t.extend({init:function(t){t=t||{},this._parent(t),this._imagePath="string"==typeof t.imagePath?t.imagePath:i.getWebappsBaseUrl()+"Leaflet/assets/images",this._tileUrl="string"==typeof t.imagePath?t.titleUrl:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",this._defaultPosition=e.is(t.defaultPosition,"array")&&"number"==typeof t.defaultPosition[0]&&"number"==typeof t.defaultPosition[1]?t.defaultPosition:h,this._defaultZoom="number"==typeof t.defaultZoom?t.defaultZoom:12,this._maxZoom="number"==typeof t.maxZoom?t.maxZoom:18,this._minZoom="number"==typeof t.minZoom?t.minZoom:1,this._scrollWheelZoom="boolean"!=typeof t.scrollWheelZoom||t.scrollWheelZoom,this._onCenterChangedCB="function"==typeof t.onCenterChangedCB?t.onCenterChangedCB:null,this._onMapLoadedCB="function"==typeof t.onMapLoadedCB?t.onMapLoadedCB:null,this._geolocation="boolean"!=typeof t.geolocation||t.geolocation,this._geolocationOnStart="boolean"==typeof t.geolocationOnStart?t.geolocationOnStart:this._true,this._displayPosition="boolean"!=typeof t.displayPosition||t.displayPosition,this._displayAccuracy="boolean"!=typeof t.displayAccuracy||t.displayAccuracy,this._locationIsDisplay="boolean"==typeof t._locationIsDisplay&&t._locationIsDisplay,this._map=null,this._delegate=null,this._geoManager=null,this._userMarker=null,this.centerHasChanged=this.centerHasChanged.bind(this),this.onMapLoaded=this.onMapLoaded.bind(this),this._updateCurrentLocation=this._updateCurrentLocation.bind(this),this._buildSkeleton()},_buildSkeleton:function(){this.elements.container=e.createElement("div",{class:"mp-map"})},loadMap:function(){L.Icon.Default.imagePath=this._imagePath;var t=e.createElement("div",{class:"map-container",styles:{height:this.elements.container.style.height}}).inject(this.elements.container);this._map=new L.Map(t,{center:this._defaultPosition,zoom:this._defaultZoom,scrollWheelZoom:this._scrollWheelZoom,maxZoom:this._maxZoom,minZoom:this._minZoom,maxBounds:u}).on("moveend",this.centerHasChanged).whenReady(this.onMapLoaded),this._tileLayer=L.tileLayer(this._tileUrl,{attribution:"3DS",maxZoom:this._maxZoom}).addTo(this._map),this._geolocation&&this._initGeolocationManager();var i=t.querySelector(".leaflet-control-attribution a");i&&e.extendElement(i).setAttributes({target:"_blank"})},onShow:function(){this._map&&this._map._onResize()},centerHasChanged:function(t){this._onCenterChangedCB&&this._onCenterChangedCB(t)},onMapLoaded:function(t){this._onMapLoadedCB&&this._onMapLoadedCB(t)},setMapPosition:function(t,e){t&&(e||(e=this._defaultZoom),this._map&&this._map.setView(t,e))},setTileUrl:function(t){this._tileUrl=t,this._tileLayer.setUrl(t)},zoomOnPositions:function(t){t=t||{},this._map&&t.length&&this._map.fitBounds(t,{padding:[25,25]})},addMarker:function(t,e){var i=null;return t&&this._map&&(i=L.marker(t,e)).addTo(this._map),i},removeMarker:function(t){t&&this._map.removeLayer(t)},addPolygon:function(t,i){return e.is(t,"array")&&this._map?L.polygon(t,i).addTo(this._map):null},removePolygon:function(t){this._map&&this._map.removeLayer(t)},getBounds:function(){return this._map?this._map.getBounds():null},getCenter:function(){return this._map?this._map.getCenter():null},getSize:function(){return this._map?this._map.getSize():null},locationHasChanged:function(t){this._updateCurrentLocation(t)},_initGeolocationManager:function(){this._geoManager=new o,this._geoManager.setDelegate(this);var t=this._buildGeolocationControl();this._map.addControl(new t),this._geolocationOnStart&&this._geoManager.getCurrentLocation(this._updateCurrentLocation)},_buildGeolocationControl:function(){var t=function(){if(this._geoManager){var t=!0;if(this._userMarker){var e=this._userMarker.getLatLng();t=this._map.getBounds().contains(e)}this._locationIsDisplay&&t?this._removeLocationMarker():this._geoManager.getCurrentLocation(this._updateCurrentLocation)}}.bind(this);return L.Control.extend({options:{position:"topleft",callback:t},onAdd:function(t){var e=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");return this._link=L.DomUtil.create("a","leaflet-bar-part leaflet-bar-part-single",e),this._link.href="#",this._icon=L.DomUtil.create("span","fonticon fonticon-location locate-icon",this._link),L.DomEvent.on(this._link,"click",this.options.callback,this).on(this._link,"click",L.DomEvent.stopPropagation).on(this._link,"click",L.DomEvent.preventDefault).on(this._link,"dblclick",L.DomEvent.stopPropagation),e}})},_updateCurrentLocation:function(t){if(t){var e=t.coords;this._displayPosition&&this._addLocationMarker(e),this.setMapPosition([e.latitude,e.longitude],10)}},_addLocationMarker:function(t){var e=t||{},i=new L.LatLng(e.latitude,e.longitude);if(this._userMarker)this._userMarker.setLatLng(i);else{var o=L.icon({iconUrl:this._imagePath+"/picto_geo.png",iconSize:[24,24]});this._userMarker=L.marker(i,{icon:o}),this._userMarker.addTo(this._map)}if(this._displayAccuracy){var a=void 0===e.accuracy?0:e.accuracy;this._accuracyCircle?(this._accuracyCircle.setLatLng(i),this._accuracyCircle.setRadius(a)):this._accuracyCircle=L.circle(i,a,{color:"#036CC7",weight:1,fillColor:"#7ACADC",fillOpacity:.2}).addTo(this._map)}this._locationIsDisplay=!0},_removeLocationMarker:function(){this._userMarker&&(this._map.removeLayer(this._userMarker),this._userMarker=null),this._accuracyCircle&&(this._map.removeLayer(this._accuracyCircle),this._accuracyCircle=null),this._locationIsDisplay=!1}})});