define("DS/DMUValWebAppController/DMUValWebAppController",["UWA/Class","DS/DMUBaseExperience/DMUContextManager","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Visualization/PathElement","DS/CATWebUXComponents/CATWebUXNotification","DS/DMUReviewPersistence/DMUAuthReviewPersistenceServices","DS/DMUControls/DMUInfoModalDiv","DS/DMUReviewCommonWebApp/DMUCommonWebAppController","i18n!DS/DMUValWebAppController/assets/nls/DMUValWebAppController"],function(e,t,n,i,o,r,a,s,d){"use strict";var c=s.extend({init:function(e){this._parent(e,"R3V");var s,c,l=(e||{}).ctxViewer,u={};function p(e){var t=[];return e&&e.externalPath.forEach(function(e){if("RootBag"!==e.name&&(n.isInstance(e)||n.isRepInstance(e))){var i=n.getNodeID(e);i&&n.isPLMNode(e)&&t.push(i)}}),t}function v(e){c||(c=new a),c.display({frmWindow:l.getFrameWindow(),type:"save"});var n=t.getEventsController({viewer:l.getViewer()});r.setCheckRequirement({checkId:e.checkId,requirementId:e.requirementId,removeReq:e.removeReq,onSetCheckRequirementComplete:function(t){c&&c.destroy(),t.removeReq?n.fireEvent("onRequirementRemoved",t):n.fireEvent("onRequirementAdded",{checkId:t.checkId,requirementId:t.requirementId,requirementTitle:e.requirementTitle})},onSaveFailed:function(){c&&(c.destroy(),c.display({frmWindow:l.getFrameWindow(),type:"error"}))}})}function m(e){"ValidationRequirement"===e.type&&v({checkId:e.checkId,removeReq:"true",requirementId:e.objectId})}function f(e){r.removeImpactedCheck({check:e.check,highlight:e.highlight,iCtxViewer:l,onRemoveImpactedCheckComplete:function(){},onRemoveImpactedCheckFailed:function(){var e;e={type:"error",msg:d.remImpactedCheckError},(new o).build({type:e.type,autoHide:!0,message:e.msg,body:l.getFrameWindow().getUIFrame()})}})}function h(e){var n=t.giveEventsController({viewer:l.getViewer()}),o=e.validationId,a=[],s=[e.contextId];a.push(s);var d=function(e){for(var n=[],o=t.getContextViewer({viewer:l.getViewer()}).getController(),r=0;r<e.length;r++){for(var a=[],s=0;s<e[r].length;s++){var d=o.getNode({id:e[r][s]});a.push(d)}var c=new i(a);n.push(p(c))}return n}(a);r.updateValidatedObjectsList({validatedObjects:d,validatedId:o,onSaveCompleted:function(){n.fireEvent("onValidatedSaved")},onSaveFailed:function(){}})}function g(e){c||(c=new a),c.display({frmWindow:l.getFrameWindow(),type:"save"});var n=[],i=[];if(void 0!==e.status){n.push({iCheckState:e.status});for(let t=0;t<e.objectIds.length;t++)i.push({attributesList:n,objectId:e.objectIds[t]})}else e.name&&n.push({sName:e.name}),e.description&&n.push({sDescription:e.description}),i.push({attributesList:n,objectId:e.objectId});r.updateAttributes({objectsToModify:i,ctxViewer:l,onAttributesSaveCompleted:function(e){var n=t.getReviewContext({viewer:l.getViewer()}),i=t.getEventsController({viewer:l.getViewer()}),o=n.getValidation().getChecks();for(let t=0;t<o.length;t++){var r=e.modifiedObjects;for(let e=0;e<r.length;e++)o[t].getPlmID()===r[e].pId&&(r[e].sName&&o[t].setName(r[e].sName),r[e].sDescription&&o[t].setDescription(r[e].sDescription),void 0!==r[e].iCheckState&&o[t].setStatus(r[e].iCheckState),i.fireEvent("onAttributeSaved",{type:"Check",id:r[e].pId,name:r[e].sName?r[e].sName:void 0,status:r[e].iCheckState?parseInt(r[e].iCheckState):void 0,description:r[e].sDescription?r[e].sDescription:void 0,object:o[t]}))}c&&c.destroy()},onSaveFailed:function(){c&&(c.destroy(),c.display({frmWindow:l.getFrameWindow(),type:"error"}))}})}function C(e){c||(c=new a),c.display({frmWindow:l.getFrameWindow(),type:"save"});var n=[],i=[];if(void 0!==e.rating){n.push({iPresentationRating:e.rating});for(let t=0;t<e.objectIds.length;t++)i.push({attributesList:n,objectId:e.objectIds[t]})}else e.name&&n.push({sName:e.name}),e.description&&n.push({sDescription:e.description}),e.slideId&&n.push({sPresentationSlideID:e.slideId}),i.push({attributesList:n,objectId:e.objectId});r.updateAttributes({objectsToModify:i,ctxViewer:l,onAttributesSaveCompleted:function(e){var n=t.getReviewContext({viewer:l.getViewer()}),i=t.getEventsController({viewer:l.getViewer()}),o=n.getValidation().getHighlights();for(let t=0;t<o.length;t++){var r=e.modifiedObjects;for(let e=0;e<r.length;e++)o[t].getPlmID()===r[e].pId&&(r[e].sName&&o[t].setName(r[e].sName),r[e].sDescription&&o[t].setDescription(r[e].sDescription),r[e].iPresentationRating&&o[t].setRating(parseInt(r[e].iPresentationRating)),r[e].sPresentationSlideID&&o[t].setPresentationSlideId(r[e].sPresentationSlideID),i.fireEvent("onAttributeSaved",{type:"Highlight",id:r[e].pId,name:r[e].sName?r[e].sName:void 0,rating:r[e].iPresentationRating?parseInt(r[e].iPresentationRating):void 0,description:r[e].sDescription?r[e].sDescription:void 0}))}c&&c.destroy()},onSaveFailed:function(){c&&(c.destroy(),c.display({frmWindow:l.getFrameWindow(),type:"error"}))}})}this.setActiveState=async function(e){var n=e;s=t.getEventsController({viewer:l.getViewer()}),n?(u.onCheckAttributeChanged=s.addEvent("onCheckAttributeChanged",g),u.onHighlightAttributeChanged=s.addEvent("onHighlightAttributeChanged",C),u.onRequirementAdded=s.addEvent("requirementAddRequested",v),u.onRequirementRemoveRequested=s.addEvent("onRequirementRemoveRequested",m),u.onRemoveImpactedCheckRequested=s.addEvent("onRemoveImpactedCheckRequested",f),u.onAddContextAsValidated=s.addEvent("addContextAsValidated",h),await this.setControllerActiveState(e)):(u={},this.setControllerActiveState(e))}}}),l=[];return e.singleton({init:function(){},giveController:function(e){if(e&&e.context)for(var t=0;t<l.length;t++)if(l[t].context===e.context)return l[t].controller},getController:function(e){var t;if(e&&e.context&&!(t=this.giveController(e))){var n=new c({ctxViewer:e.context});t=Object.freeze({setActiveState:async function(e){n&&await n.setActiveState(e)},getActiveState:function(){if(n)return n.getActiveState()},subscribe:function(e,t){if(n)return n.subscribe(e,t)},unsubscribe:function(e){n&&n.unsubscribe(e)},clearController:function(){n&&(n.clearController(),n=null)},appInitFromTransition:function(e){return n?n.appInitFromTransition(e):Promise.resolve()},loadValidation:function(e){n&&n.loadValidation(e)},refreshContext:function(){n&&n.refreshContext()},loadReviewAfterRefresh:function(e){n&&n.loadReviewAfterRefresh(e)},disableDMUContextualBar:function(){n&&n.disableDMUContextualBar()},enableDMUContextualBar:function(){n&&n.enableDMUContextualBar()},publish:function(e,t){n&&n.publish(e,t)},setappTransition:function(e){n&&n.setappTransition(e)}}),l.push({context:e.context,controller:t})}return t},unreferenceController:function(e){if(e&&e.context)for(var t=0;t<l.length;t++)if(l[t].context===e.context){e.options&&e.options.appInfo&&"X3DPLAW_AP"===e.options.appInfo&&l[t].controller.setappTransition(!0),l[t].controller.clearController(),l.splice(t,1);break}}})});