/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/3DPlayUtils/IdentifyPLMType",["UWA/Class","DS/3DPlaySupport/SupportList"],function(e,t){"use strict";return e.extend({init:function(){this._parent()},isKindOfDrawing:function(e,n){t["3DSPACE"].resolveParenting(e,function(e){"drawing"===e.toLowerCase()?n(e):n(!1)})}})}),define("DS/3DPlayUtils/ContextualBar",["DS/WebInfraUI/ContextualBar"],function(e){"use strict";return console.log("WARNING!!! ContextualBar class has been migrated to new module. Please use 'DS/WebInfraUI/ContextualBar' to access it."),e}),define("DS/3DPlayUtils/NavigationArrows",["DS/WebInfraUI/NavigationArrows"],function(e){"use strict";return console.log("WARNING!!! NavigationArrows class has been migrated to new module. Please use 'DS/WebInfraUI/NavigationArrows' to access it."),e}),define("DS/3DPlayUtils/PublishToSwym",["DS/3DPlay/3DPlay","UWA/Class","DS/WebSystem/Environment","DS/WebSystem/Nls","i18n!DS/3DPlay/assets/nls/3DPlay"],function(e,t,n,i,r){"use strict";return t.extend({init:function(t){var i,o;require(["DS/UIKIT/Modal","DS/SwymPublishForm/script/publish-form-view","css!DS/3DPlayUtils/PublishToSwym"],function(s,a){var l=e.getExperience(t.ctx);l&&l.getScreenShot({onSuccess:function(e){if(n.isSet("ODT_3DPlay_PanelManager"))require(["DS/CoreEvents/Events"],function(e){e.publish({event:n.get("ODT_3DPlay_PanelManager")})});else{var t=l.args.input.tenantID||l.args.input.asset.tenant;if(t)i=t;else try{for(var c=window;!c.ds&&c.parent&&c!==c.parent;)c=c.parent;(i=c.ds.swymTenant)&&(o=!0)}catch(e){}h={title:"title",description:"description",mode:"base64",base64image:e,onCancel:p=function(){d&&d.destroy(),u&&u.destroy()},onContentCreated:p},i&&(h.platformId=i),o&&(h.forcePlatform=!0),d=new a(h),(u=new s({closable:!0,header:r.ShareSwymTitle,body:d.render("publish_to_sywm_wrapper_id"),className:"publishSwymPanel_3DPlay"})).inject(document.body),u.show()}var u,d,p,h},onFail:function(){e.sendEvent(t.ctx,eventType.notif,notification.error,{msg:r.UnableToCreateScreenshot})}})},function(n){if("scripterror"===n.requireType){var i=n.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",i)}else console.error(n);e.sendEvent(t.ctx,eventType.notif,notification.error,{msg:r.ScripNotFoundError})})}})}),define("DS/3DPlayUtils/ContextualBarManager",["DS/WebInfraUI/ContextualBarManager"],function(e){"use strict";return console.log("WARNING!!! ContextualBarManager class has been migrated to new module. Please use 'DS/WebInfraUI/ContextualBarManager' to access it."),e}),define("DS/3DPlayUtils/EventDisposer",["DS/WebUtils/EventDisposer"],function(e){"use strict";return console.error("DS/3DPlayUtils/EventDisposer has been moved to DS/WebUtils/EventDisposer of FW WebInfra"),console.error("DS/3DPlayUtils/EventDisposer has been moved to DS/WebUtils/EventDisposer of FW WebInfra"),e}),define("DS/3DPlayUtils/ConvertService",["UWA/Class"],function(e){"use strict";return e.extend({init:function(){this.supportedFormats={};var e=0;this.getConversionFormat=function(e){return this.supportedFormats[e]||null},this.clearQueue=function(){e++},this.convert=function(t,n,i,r,o){var s=n.ConversionFeedBack.progress,a=s.registerSubProgress(),l=n.ConversionFeedBack.notifTimeoutID,c=t;!1===Array.isArray(c)&&(c=[c]);for(var u=0,d=0,p=function(t){t.queueIdx===e&&(clearTimeout(l),s.advanceToMax(a),u++,delete t.queueIdx,u+d===c.length?r(t):o?o(t):r(t))},h=function(e,t){clearTimeout(l),s.advanceToMax(a),d++,i(e,t)},v=0;v<c.length;v++)c[v].queueIdx=e,this._convert({asset:c[v],onConvertSuccess:p,onConvertError:h,ConversionOpts:n.ConversionOpts||{}})},this._convert=function(){console.error("PlayWeb - Something is wrong, _convert is not defined.")}}})}),define("DS/3DPlayUtils/FullScreen",["UWA/Class","DS/CoreEvents/Events"],function(e,t){"use strict";return e.extend({init:function(e,n,i,r){this._parent();var o,s,a="none";try{window.getSwymContainer&&(e=window.getSwymContainer())}catch(e){}if(n&&"HTML5"===n.mode){for(var l=!0,c=window,u=document,d=c.parent;c!==d&&l;){var p,h,v=d.document,f=v.getElementsByTagName("iframe");for(p=0;p<f.length;p++)if((h=v.getElementsByTagName("iframe")[p])&&h.contentWindow.document===u){h.getAttribute("allowfullscreen")||(l=!1);break}u=v,d=(c=d).parent}if(l=(l=l&&(e.requestFullscreen||e.mozRequestFullScreen||e.webkitRequestFullscreen||e.msRequestFullscreen))&&(document.cancelFullScreen||document.mozCancelFullScreen||document.webkitCancelFullScreen||document.msCancelFullScreen||document.msFullscreenEnabled)){a="html5",s=function(){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()},o=function(){document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msCancelFullScreen&&document.msCancelFullScreen()};var m=function(t){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement||!i.classList.contains("active")&&!e.classList.contains("PlayWeb-FullScreen")?(i.addClassName("active"),e.classList.add("PlayWeb-FullScreen")):(i.removeClassName("active"),e.classList.remove("PlayWeb-FullScreen"))};document.onfullscreenchange=m,document.onmozfullscreenchange=m,document.onwebkitfullscreenchange=m,document.onmsfullscreenchange=m}}else if(n&&"CUSTOM"===n.mode&&n.onActivate&&n.onDeactivate&&r&&r.getView){a="custom",s=function(){setTimeout(function(){t.publish({event:"3DPLAY/3DPLAYPREVIEW/ENABLE",data:{}})},500)},o=function(){t.publish({event:"3DPLAY/3DPLAYPREVIEW/DISABLE",data:{}})};var g=function(e){r.fullscreen&&t.publish({event:"3DPLAY/PLAYFROMCOMPASS/DISABLE",data:{}})},S=function(e){r.fullscreen&&setTimeout(function(){t.publish({event:"3DPLAY/PLAYFROMCOMPASS/ENABLE",data:{}})},500)};r.addEvent("onHide",g),r.addEvent("onShow",S),r.onViewChange=function(e){"maximized"===e.type||"fullscreen"===e.type?t.publish({event:"3DPLAY/FULLSCREEN/ENABLE",data:{}}):"windowed"!==e.type&&"minimized"!==e.type||t.publish({event:"3DPLAY/FULLSCREEN/DISABLE",data:{}})},n.onViewChange&&n.onViewChange(function(t){!0===t?(i.addClassName("active"),e.classList.add("PlayWeb-FullScreen")):(i.removeClassName("active"),e.classList.remove("PlayWeb-FullScreen"))})}else if(n&&"PLATFORM"===n.mode&&r&&r.getView&&r.requestView){a="platform";var y="none";s=function(){"fullscreen"!==(y=r.getView().type)&&r.requestView({type:"fullscreen"})},o=function(){"fullscreen"!==y&&r.requestView({type:y})};g=function(e){r.fullscreen&&t.publish({event:"3DPLAY/PLAYFROMCOMPASS/DISABLE",data:{}})},S=function(e){r.fullscreen&&setTimeout(function(){t.publish({event:"3DPLAY/PLAYFROMCOMPASS/ENABLE",data:{}})},500)};r.addEvent("onHide",g),r.addEvent("onShow",S),r.onViewChange=function(o){"maximized"===o.type||"fullscreen"===o.type?t.publish({event:"3DPLAY/FULLSCREEN/ENABLE",data:{}}):"windowed"!==o.type&&"minimized"!==o.type||t.publish({event:"3DPLAY/FULLSCREEN/DISABLE",data:{}}),"fullscreen"!==o.type&&i.classList.contains("active")&&(e.classList.remove("PlayWeb-FullScreen"),i.removeClassName("active"),"fullscreen"!==y&&r.requestView({type:y}),n.onDeactivate&&n.onDeactivate())}}t.subscribe({event:"3DPLAY/2D/TEXT_SEARCH/BEGIN"},function(){i.getParent().setStyle("top",i.getParent().offsetTop+50+"px")}),t.subscribe({event:"3DPLAY/2D/TEXT_SEARCH/END"},function(){i.getParent().setStyle("top",i.getParent().offsetTop-50+"px")}),this.getMode=function(){return a},this.toggle=function(){e.classList.contains("PlayWeb-FullScreen")?(o(),i.removeClassName("active"),n&&n.onDeactivate&&n.onDeactivate(),e.classList.remove("PlayWeb-FullScreen")):(s(),e.classList.add("PlayWeb-FullScreen"),n&&n.onActivate&&n.onActivate(),i.addClassName("active"))}}})}),define("DS/3DPlayUtils/UIManager",["UWA/Class","DS/WebUtils/EventDisposer"],function(e,t){"use strict";return e.extend({init:function(e){this.ActionBarEventArray=new Array,this.ResizeEventArray=new Array,this.PanelEventArray=new Array,this.registerEvents(e)},registerEvents:function(e){var n=e.frameWindow,i=e.ctx,r=this,o=n.getActionBar();o&&(o.onActionBarClose(function(e){if(r&&r.ActionBarEventArray)for(var t=0,n=r.ActionBarEventArray.length;t<n;t++){r.ActionBarEventArray[t].addClassName("wux-ui-state-close")}}),o.onActionBarOpen(function(e){if(r&&r.ActionBarEventArray)for(var t=0,n=r.ActionBarEventArray.length;t<n;t++){var i=r.ActionBarEventArray[t];i.removeClassName("wux-ui-state-close"),"none"===i.style.display&&(i.style.display="block")}}));var s=function(e,t){if(r&&r.PanelEventArray)for(var n=0,i=r.PanelEventArray.length;n<i;n++){var o=r.PanelEventArray[n];if("object"==typeof o&&o.customCB){var s=UWA.extend({},e);s.visible=t,o.customCB(s)}else o.style.display=1==t?"none":""}};this.EventDisposer=new t,n&&n.experience?(this.EventDisposer.add(n.experience.subscribe("3DPLAY/RIGHTPANEL/OPEN",function(e){s(e,!0)})),this.EventDisposer.add(n.experience.subscribe("3DPLAY/RIGHTPANEL/CLOSE",function(e){s(e,!0)})),this.EventDisposer.add(n.experience.subscribe("3DPLAY/RIGHTPANEL/SHOW",function(e){s(e,!0)})),this.EventDisposer.add(n.experience.subscribe("3DPLAY/RIGHTPANEL/HIDE",function(e){s(e,!1)}))):(this.EventDisposer.add(WUX.Events.subscribe({event:"/"+i+"3DPLAY/RIGHTPANEL/OPEN"},function(e){s(e,!0)}),WUX.Events),this.EventDisposer.add(WUX.Events.subscribe({event:"/"+i+"3DPLAY/RIGHTPANEL/CLOSE"},function(e){s(e,!0)}),WUX.Events),this.EventDisposer.add(WUX.Events.subscribe({event:"/"+i+"3DPLAY/RIGHTPANEL/SHOW"},function(e){s(e,!0)}),WUX.Events),this.EventDisposer.add(WUX.Events.subscribe({event:"/"+i+"3DPLAY/RIGHTPANEL/HIDE"},function(e){s(e,!1)}),WUX.Events))},dispose:function(){this.ActionBarEventArray=null,this.ResizeEventArray=null,this.PanelEventArray=null,this.EventDisposer.dispose(),this.EventDisposer=null},addToActionBarEvent:function(e){e.addClassName("wux-afr-actionbar"),this.ActionBarEventArray.push(e)},addToResizeEvent:function(e){this.ResizeEventArray.push(e)},addToPanelEvent:function(e,t){var n=void 0!==t?{div:e,customCB:t}:e;this.PanelEventArray.push(n)}})}),define("DS/3DPlayUtils/VisibilityUtils",["DS/WebSystem/Settings","DS/CoreEvents/Events"],function(e,t){"use strict";return{applyVisibilityToAll:function(e,t,n){if(t)for(var i=0;i<t.length;i++)this.applyVisibilityToPath(e,t[i],n)},reallyApplyVisibilityToAll:function(e,t,n){if(t){Array.isArray(t)||(t=[t]);for(var i=0;i<t.length;i++){var r=t[i].getChildrenPathes();0!=r.length?this.reallyApplyVisibilityToAll(e,r,n):this.applyVisibilityToPath(e,t[0],n)}}},applyVisibilityToPath:function(e,t,n,i){null==i&&(i=!0),e.setVisibility(t,n,i)},getTransparencyPercentage:function(){var t=Math.round(e.get("VisibilitySettings.TransparencySetting",11));return(t<0||t>100)&&(t=11),t},setTransparencyPercentage:function(t){t>=0&&t<=100?e.set("VisibilitySettings.TransparencySetting",t):console.error("Error: Visibility Utilities - Transparency settings value out of range")},updateTransparencyofObjects:function(e,t,n){if(1==n)this.removeTransparencyFromObjects(e,t);else{var i=function(t){t.length>0&&t.forEach(function(t){var r=e.getOpacity(t);if(null!=r&&r<1)e.setOpacity(t,n);else{var o=t.getChildrenOccurrencePathes();null!=o&&null!=o&&i(o)}})};i(t)}},removeTransparencyFromObjects:function(e,t){for(var n=0;n<t.length;n++){var i=t[n];e.setOpacity(i,1,!0),e.setPickability(i,"PICKABLE",!0)}},applyTransparencyToObjects:function(e,t,n,i,r){if(1==n)this.removeTransparencyFromObjects(e,t);else{null==r&&(r=!0);for(var o=0;o<t.length;o++)e.setOpacity(t[o],n,r),1!=i&&e.setPickability(t[o],"IGNORED",r)}},getCurrentSceneGraphState:function(e,t,n){return e.sgState||(e.sgState=this.createNewSceneGraphStateHelper(e,t,"VisibilitySG")),e.sgState},createNewSceneGraphStateHelper:function(e,t,n){return e.createSceneGraph(n)},resetCurrentSceneGraphState:function(e){e.sgState=null},setCurrentSceneGraphState:function(e,t){e.sgState=t,e.setCurrentSceneGraphState(e.sgState)},setVisibilityOfAnnotations:function(e,t,n){(n||e.getRootNode()).children.forEach(function(e){"annotGroupNode"==e.name&&e.setVisibility(t)})},setVisibilityOfSectionsAndMeasures:function(e,n,i){i||e.getRootNode();n?t.publish({event:"3DPLAY/EXPLODE/END"}):t.publish({event:"3DPLAY/EXPLODE/START"})}}}),define("DS/3DPlayUtils/LeftPanel",["UWA/Core","UWA/Class","DS/Panels/SidePanel","css!DS/3DPlayUtils/LeftPanel"],function(e,t,n,i){return t.extend({init:function(t){this.leftPanel=new n({side:"left"}).inject(t.container);for(var i=new e.Element("div",{id:"MAIN_CONTAINER",styles:{height:this.leftPanel.elements.panel.clientHeight+"px","overflow-y":"scroll"}}).inject(this.leftPanel),r=new e.Element("div",{id:"SHEET_LIST_CONTAINER"}).inject(i),o=[],s=function(e){for(var t=0;t<o.length;t++){var n=o[t];n.className.indexOf("selected")>0&&n.removeClassName("selected")}(e.target?e.target:e.srcElement).addClassName("selected")},a=0;a<t.items.length;a++){var l=t.items[a],c="Sheet_"+(a+1),u=new e.Element("div",{id:c,class:"leftpanel-item",events:{click:l.onClickCB}}).inject(r);u.addEvent("click",s),u.appendText(c),o.push(u)}},dispose:function(){}})}),define("DS/3DPlayUtils/SpreadGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,n){"use strict";var i=n.extend({init:function(){return this._parent("Spread"),this.touches=[],this.fingersVector0_1=new e.Vector2,this.fingersVector1_2=new e.Vector2,this.fingersVector2_0=new e.Vector2,this.latencyTime=30,this.initTime=0,this.distance=null,this.lastDistance=0,this.initDistance=0,this.distanceMin=0,this},detect:function(e){switch(this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE],this.view),3===this.touches.length&&(this.fingersVector0_1.subVectors(this.touches[1].currentPosition,this.touches[0].currentPosition),this.fingersVector1_2.subVectors(this.touches[2].currentPosition,this.touches[1].currentPosition),this.fingersVector2_0.subVectors(this.touches[0].currentPosition,this.touches[2].currentPosition),null===this.distance&&(this.distance=this.fingersVector0_1.length()+this.fingersVector1_2.length()+this.fingersVector2_0.length()),this.lastDistance=this.distance,this.distance=this.fingersVector0_1.length()+this.fingersVector1_2.length()+this.fingersVector2_0.length()),this.state){case n.State.INIT:this.distance=null,3===this.touches.length&&(this.preventDefault(this.touches),this.initTime=(new Date).getTime(),this.initDistance=this.distance,this.changeState(n.State.BEGIN));break;case n.State.BEGIN:case n.State.CHANGE:3===this.touches.length?(this.events=this.touches,this.preventDefault(this.events),this.changeState(n.State.CHANGE)):this.changeState(n.State.KO);break;case n.State.KO:case n.State.OK:case n.State.CANCEL:this.changeState(n.State.INIT),this.touches=[],this.distance=null}},preventDefault:function(e){for(var t=0;t<e.length;t++){var n=e[t].getJSEvent();n.preventDefault&&n.preventDefault()}}});return UWA.namespace("3DPlayModelViewer/SpreadGesture",i)}),define("DS/3DPlayUtils/BrowserSupportList",[],function(){"use strict";return{winphone:{8.1:{ie:{isSupported:function(e){return BrowserSupport.ok}}}},win:{default:{version:{isSupported:function(e){try{var t=parseFloat(e);return 7===t||8===t||t>=10}catch(e){return!1}}},chrome:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}},firefox:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}},opera:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}},ie:{isSupported:function(e){return BrowserSupport.ok}}}},android:{default:{version:{isSupported:function(e){return parseFloat(e)>=5}},chrome:{isSupported:function(e){return BrowserSupport.ok}},firefox:{isSupported:function(e){return BrowserSupport.ok}}},4:{chrome:{isSupported:function(e){return e<25?BrowserSupport.partial:BrowserSupport.ok}},firefox:{isSupported:function(e){return e<25?BrowserSupport.partial:BrowserSupport.ok}}}},macosx:{default:{version:{isSupported:function(e){try{return parseFloat(e)>=10.1}catch(e){return!1}}},safari:{isSupported:function(e){return BrowserSupport.ok}},chrome:{isSupported:function(e){return BrowserSupport.ok}},firefox:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}}},10.9:{safari:{isSupported:function(e){return e<600?BrowserSupport.partial:BrowserSupport.ok}}}},ios:{default:{version:{isSupported:function(e){return e<8?BrowserSupport.partial:BrowserSupport.ok}},safari:{isSupported:function(e){return e<600?BrowserSupport.partial:BrowserSupport.ok}},netscape:{isSupported:function(e){return BrowserSupport.ok}}}}}}),define("DS/3DPlayUtils/ServiceURL",["UWA/Core","DS/WebUtils/WebServices"],function(e,t){"use strict";return console.error("DS/3DPlayUtils/ServiceURL has been moved to (DS/WebUtils/WebServices).getServiceURL"),t.getServiceUrl}),define("DS/3DPlayUtils/TestBrowser",["DS/3DPlayUtils/BrowserSupportList","DS/WebSystem/DetectBrowser"],function(e,t){"use strict";return function(){var n,i=!1,r=document.createElement("canvas");try{(n=r.getContext("webgl"))&&(i=!0)}catch(e){}if(!n)try{(n=r.getContext("experimental-webgl"))&&(console.warn("experimental-webgl"),i=!0)}catch(e){}if(0==i)return BrowserSupport.none;if("undefined"==typeof Worker)return BrowserSupport.none;var o=t(),s=e[o.os.name];if(void 0!==s){var a=s[o.os.version];if(void 0===a&&(void 0===(a=s.default)||void 0!==a.version&&void 0!==a.version.isSupported&&!1!==a.version.isSupported(o.os.version)||(a=void 0)),void 0!==a){var l=a[o.browser.name];if(void 0!==l&&void 0!==l.isSupported)return l.isSupported(o.browser.version)}}return BrowserSupport.partial}}),define("DS/3DPlayUtils/XCADSpatialSupport",["DS/3DPlaySupport/XCADSpatialSupportedFormats","UWA/Core","DS/3DPlayUtils/ConvertService","DS/WebSystem/Environment","DS/WebInfraUI/Notification","DS/WebUtils/Logger","DS/WebUtils/WebServices","DS/WebUtils/Network","DS/WebUtils/ProbesManager","DS/WebSystem/Nls","DS/WebSystem/App","DS/WAFData/WAFData","i18n!DS/3DPlay/assets/nls/3DPlay"],function(e,t,n,i,r,o,s,a,l,c,u,d,p){"use strict";var h,v,f,m={},g={};return n.extend({officeTypes:["DOC","DOCX","DOCM","DOT","DOTM","DOTX","RTF","PPT","PPTX","POT","POTM","POTX","PPS","PPSM","PPSX","PPTM","XLS","XLSX","XLSM","XLSB","XLT","XLTM","XLTX","CSV","MSG"],init:function(n){this._parent(),this.logger=o("3DPlay.XCADSpatialSupport","3DPlay.Log.Convert"),this._exp=n,this.connector3DSpace=null,this._counter=0,this.supportedFormats=e,n.extendedXCADSupport&&t.extend(this.supportedFormats,n.extendedXCADSupport,!0),this._convert=function(e){this._computeInfos(e),u.isOnCloud()?this._isOffice(e)?this._isSource3DDrive(e)||this._isSource3DSpace(e)?this._convertDFA(e):this._displayFatal(e):this._isSource3DDrive(e)?"EXTERNAL"!==e.computedInfos.provider.toUpperCase()&&(e.asset.user&&"guest"==e.asset.user?this._convertCO(e):this._convertDFA(e)):this._isSource3DSpace(e)&&this._isAssembly(e)?this._displayFatal(e):this._convertCO(e):this._displayFatal(e)},this._computeInfos=function(e){e.computedInfos=e.asset,e.asset&&e.asset.originalAsset?e.computedInfos=e.asset.originalAsset:this._isSource3DDrive(e)&&(e.computedInfos={type:e.asset.format,provider:e.asset._3DPlayDatas&&!0===e.asset._3DPlayDatas.externalDrive?"EXTERNAL":"3DDRIVE",physicalid:e.asset.physicalid}),("ODT_Tenant"===e.asset.tenant||e.asset.filename&&e.asset.filename.includes("3DPlayExperiencesTest"))&&(window.isCloud=!0,e.computedInfos.provider||(e.asset._3DPlayDatas&&e.asset._3DPlayDatas.externalDrive&&"prt"==e.asset.type&&(this.connector3DSpace={open:function(e,t){t({url:"test_url"})}}),e.computedInfos.provider="EV6"))},this._isAssembly=function(e){return"asm"===e.asset.dataFormat},this._isSource3DDrive=function(e){return u.is3DDrive()||e&&e.computedInfos&&e.computedInfos.provider&&"3DDRIVE"===e.computedInfos.provider.toUpperCase()},this._isSource3DSpace=function(e){return"EV6"===e.computedInfos.provider.toUpperCase()||"3DSPACE"===e.computedInfos.provider.toUpperCase()},this._isOffice=function(e){return this.officeTypes.indexOf(e.asset.type.toUpperCase())>=0},this._displayFatal=function(e){this.logger.error("Conversion error"),this.logger.error(arguments),e.onConvertError({nls:"Convert_ERROR",level:r.fatal},e.asset)},this._convertDFA=function(e){var t=this,n=e.asset;s.getServiceUrl({serviceName:"derivedformataccess",logger:t.logger,platformId:n.tenant,onSuccess:function(i){g[n.tenant]||(g[n.tenant]=i.url),i.platformId!==n.tenant&&t.logger.warn("DerivedFileAccess desired Tenant:",n.tenant,"got ",i.platformId),t.logger.log("DerivedFileAccess : URL found > ",g[n.tenant]),t.profilerLocateOpen=l.createProbe("XCAD_Preprocess"),t.profilerLocateOpen.begin(),t._startLocate(e,!0),t=null},onError:function(n){t.logger.error("Ooops, missing Service : ",n.serviceName,"Reason : ",n.error),t._convertCO(e),t=null}})},this._convertCO=function(e){if(u.isOnCloud()&&this._isOffice(e))return this.logger.error("Conversion error"),this.logger.error(arguments),void e.onConvertError({nls:"LoadingError_FORMAT",level:"fatal"},t);if(h){var t=e.asset;if(!m[t.tenant]){if(!i.isSet("3DPlay.ProtoConvertSpatial")||"true"===i.get("3DPlay.ProtoConvertSpatial")){var n=this;return void s.getServiceUrl({serviceName:"SPAContentOptimizer",logger:n.logger,platformId:t.tenant,onSuccess:function(i){m[t.tenant]||(m[t.tenant]=c(i.url)),i.platformId!==t.tenant&&n.logger.warn("XCADSpatialSupport desired Tenant:",t.tenant,"got ",i.platformId),n.logger.log("XCADSpatialSupport : URL found > ",m[t.tenant]),n._startConvert(e),n=null},onError:function(i){n.logger.error("Ooops, missing Service : ",i.serviceName,"Reason : ",i.error);var o={nls:"Convert_SERVICE_NOT_FOUND",level:r.warning,abort:!0};e.onConvertError(o,t),n=null}})}m[t.tenant]=i.get("3DPlay.ProtoConvertSpatial"),this.logger.log("XCADSpatialSupport (using envar value) : URL found > ",m[t.tenant])}this._startConvert(e)}else{var o=this;require(["DS/CSICommandBinder/CSICommandBinder","DS/SPAContentOptimizer/COptConvertOption","DS/SPAContentOptimizer/coptConvertV1"],function(t,n,i){h=t,v=n,f=i,o._convert(e),o=null})}};var c=function(e){var n=t.Utils.parseUrl(e);return n.authority+n.directoryPath};this._startLocate=function(e,n){var r=this,o=e.asset;this.located=!1,this.logger.log("XCADSpatialSupport._startLocate");var s=e.computedInfos.contextid?e.computedInfos.contextid:e.computedInfos.contextId?e.computedInfos.contextId:"preferred";i.get("PreferredCredentials")&&(s=i.get("PreferredCredentials"));var a="/api/v2/modeler/dsdo/DerivedOutputs/locate?withSyncStatus=yes";"EV6"!==e.computedInfos.provider.toUpperCase()&&"3DSPACE"!==e.computedInfos.provider.toUpperCase()||(a+="&SecurityContext="+encodeURIComponent(s)),"asm"===o.dataFormat&&(o.dataFormat="3dxml");var c=g[o.tenant]+a,u={specificationFilter:[{format:o.dataFormat,filterConversionParams:[{key:"streamId",value:"visualization"}]}],referencedObject:[{source:"EV6"===e.computedInfos.provider.toUpperCase()?"3DSpace":e.computedInfos.provider,id:e.computedInfos.physicalid,type:e.computedInfos.type}]};!0===n&&(u.specificationFilter[0].notifyIfMissing=!0),0==r._counter&&l.begin("XCAD_Convert"),d.authenticatedRequest(c,{method:"POST",headers:{"Content-Type":"application/json",SecurityContext:s},type:"json",data:JSON.stringify(u),onComplete:function(n){if(console.log("onComplete locate"),n.derivedOutputs&&n.derivedOutputs[0]&&n.derivedOutputs[0].derivedOutputFormats&&n.derivedOutputs[0].derivedOutputFormats[0]&&n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult&&!0===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.isSync&&"OK"===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.status){r._counter=0;var s=g[o.tenant]+"/api/v2/modeler/dsdo/DerivedOutputs/"+n.derivedOutputs[0].id+"/DerivedOutputFiles/"+n.derivedOutputs[0].derivedOutputFormats[0].id+"/DownloadTicket";l.end("XCAD_Convert");var a=n;d.authenticatedRequest(s,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(n){console.log("onComplete download ticket");var l=n.data[0].dataelements,c=l.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(l.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true",u=t.clone(o);e.onConvertSuccess(t.extend(u,{provider:"FILE",filename:c,proxyurl:"none",requiredAuth:null,serverurl:"",originalType:o.type,mimetype:o.dataFormat||o.mimetype,format:o.dataFormat||o.mimetype,type:o.dataFormat||o.mimetype})),console.log("Loading from DFA : "+c),r.profilerLocateOpen.end(),i.isSet("3DPlay.downloadConvertResult")&&d.authenticatedRequest(s,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(e){console.log("onComplete second download ticket for debug");var t=e.data[0].dataelements,n=t.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(t.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true",i=document.createElement("a");i.download="DFA_Download_File."+o.dataFormat||o.mimetype,i.innerHTML="Download File",i.href=n,i.onclick=function(e){document.body.removeChild(e.target)},i.style.display="none",document.body.appendChild(i),i.click()}}),r._handleCR(a,o)},onFailure:function(e){console.log("onFailure download ticket"),r.profilerLocateOpen.end()}})}else if(n.derivedOutputs&&n.derivedOutputs[0]&&n.derivedOutputs[0].derivedOutputFormats&&n.derivedOutputs[0].derivedOutputFormats[0]&&n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult&&!0===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.isSync&&"KO"===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.status)r._handleCR(n,o),!1===n._doFallback||r._isOffice(e)||r._convertCO(e);else if(!r._stop){var c=r._counter++<10?1e3:3e3;console.log(" restart locate in "+c+" ms"),setTimeout(r._startLocate.bind(r,e,!1),c)}},onFailure:function(t){console.log("onFailure locate"),r._counter=0,r._convertCO(e),r.profilerLocateOpen.end(),r.profilerLocateOpen=null}})},this._handleCR=function(e,t){var n=g[t.tenant]+"/api/v2/modeler/dsdo/DerivedOutputs/"+e.derivedOutputs[0].id+"/DerivedOutputFiles/"+e.derivedOutputs[0].derivedOutputFormats[0].id+"/ConversionReport/"+e.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.id+"/DownloadTicket";d.authenticatedRequest(n,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(e){console.log("onComplete report download ticket");var t=e.data[0].dataelements,n=t.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(t.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true";d.authenticatedRequest(n,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(e){if(console.log("onComplete report download"),1==e.reportFileVersion)e.warnings&&e.warnings.length>0&&(e.warnings[0].includes("Error : The input file is saved in Civil3D. Output might be incomplete.")?SHARE.Core.sendEvent(that._exp.args.ctx,eventType.notif,notification.warning,{msg:p.Convert_Civil3D_Warning}):e.warnings[0].includes("Alert ! Text layout could look different as some fonts are not present on the system !")&&SHARE.Core.sendEvent(that._exp.args.ctx,eventType.notif,notification.info,{msg:p.Convert_MissingFonts_Warning}));else if(2==e.reportFileVersion){for(var t=0;t<e.warnings.length;t++)"PartialResult"==e.warnings[t].category&&("IncompleteResultFromCivil3D"==e.warnings[t].id?SHARE.Core.sendEvent(that._exp.args.ctx,eventType.notif,notification.warning,{msg:p.Convert_Civil3D_Warning}):"ConversionWithMissingFonts"==e.warnings[t].id&&SHARE.Core.sendEvent(that._exp.args.ctx,eventType.notif,notification.info,{msg:p.Convert_MissingFonts_Warning}));for(t=0;t<e.errors.length;t++)"UnsupportedInput"==e.errors[t].category&&("UnsupportedFileVersion"!=e.errors[t].id&&"UnsupportedParasolidBareBinary"!=e.errors[t].id||(e._doFallback=!1))}},onFailure:function(e){console.log("onFailure report download")}})},onFailure:function(e){console.log("onFailure report download ticket")}})};var S="Not initialized";this._startConvert=function(e){var t=this;this.connected=!1,this.logger.log("XCADSpatialSupport._startConvert");var n={onHypervisorDisconnect:function(){t.logger.log("XCADSpatialSupport._startConvert: CSIServer Hypervisor Disconnected"),t.connected?t.connected=!1:(t.logger.error("Unable to connect"),e.onConvertError({nls:"Convert_FILE_NOT_LOADED"},e.asset))},onHypervisorConnect:function(){t.connected=!0,t.logger.log("CSIServer Connected")},onDisconnect:function(){t.logger.log("CSIServer Node Disconnected")},authentication:function(e,n,i){t.logger.log("CSIServer authentication");var r=encodeURIComponent(S).replace(/'/g,"%27").replace(/"/g,"%22");a.authenticatedRequest(e.passportURL+"/login?service="+r,{method:"GET",headers:{Accept:"application/json"},onComplete:function(e){try{t.logger.log("CSIServer authentication onComplete");var r=JSON.parse(e).access_token;n(S,r)}catch(n){i("Failed to parse ticket"),t.logger.error("Failed to parse ticket : "+e)}},onFailure:function(e,n){i("Failed to retrieve ticket"),t.logger.log("CSIServer authentication onFailure"),t.logger.error("Failed to retrieve ticket: "+n)}},"XCAD_Authentication")}},i=m[e.asset.tenant];""===i||void 0===i?(n.hypervisorIp=void 0,n.webSocketPort=void 0,this.logger.log("Trying to Connect via IP> "+void 0),S="https://"+n.hypervisorIp+":"+n.hypervisorPort):(n.hypervisorUrl=i,n.ssl=!0,this.logger.log("Trying to Connect via hypervisorUrl : "+i),S="https://"+n.hypervisorUrl);var r=h.getPool("application.webWidget").createNode(n);"prt"===e.asset.type?this._execOpenCmd(e,r):this._execConvertCmd(e,r)}},_execOpenCmd:function(e,t,n){n=t.select("ContentOptimizer"),this.logger.log("_execOpenCmd");var i,r=this,o=!1,s=e.asset,a=function(){e.onConvertError({nls:"Convert_FILE_NOT_LOADED"},s)},c=new h.Response;c.onAnswerDomain("OpenResult",function(){r.logger.log("answerOpenResultCB._execOpenCmd"),i.end(),i=null,setTimeout(function(){if(o&&"prt"===s.type)a();else if(e.asset&&e.computedInfos&&e.computedInfos.provider&&("EV6"===e.computedInfos.provider.toUpperCase()||"3DSPACE"===e.computedInfos.provider)){var i=l.createProbe("3DSpaceDocumentConnector");i.begin();var c=function(o){i&&(i.end(),i=null),e.asset.url=o.url,r._execConvertCmd(e,t,n)};r.connector3DSpace?r.connector3DSpace.open(e.computedInfos,c,a):(r.connector3DSpace="DS/3DSpaceDocumentConnector/3DSpaceDocumentConnector",require([r.connector3DSpace],function(t){r.connector3DSpace=new t,r.connector3DSpace.open(e.computedInfos,c,a)},a))}else r._execConvertCmd(e,t,n)},1)}),c.onAnswerDomain("Info",function(e){var t=e.readUint8("DocumentType");o=2===t||3===t});var u=t.createRequest({destinationNodeId:n,command:"Open",version:1,onComplete:c}),d=new h.Parameters;d.writeString("InputFileName",s.filename||"DummyName."+(s.format||s.mimetype)),d.writeString("InputFileUrl",s.url),(i=l.createProbe("XCAD_Preprocess")).begin(),u.send(null,d,null)},_execConvertCmd:function(e,n,o){this.logger.log("_execConvertCmd");var s=e.asset,c=function(o){var a,c=new f(n);c.onResultFile=function(n,r){if(this.logger.log("launchConvert.onResultFile",n),l.end("Download"),l.end("_execConvertCmd"),!0!==n||(this._exp.loadingAsset.size=r.byteLength,!r))return this.onErrorsVisited||(this.logger.error("Conversion error"),this.logger.error(arguments),e.onConvertError({nls:"Convert_ERROR",level:"fatal"},s)),this.cleanNode(c),!0;var o=new Blob([r]);i.isSet("3DPlay.downloadConvertResult")&&require(["DS/WebSystem/Downloader"],function(e){e("XCAD-Converted-File."+s.dataFormat,o)});var a=t.clone(s);e.onConvertSuccess(t.extend(a,{provider:"FILE",filename:window.URL.createObjectURL(o),proxyurl:"none",requiredAuth:null,serverurl:"",originalType:s.type,mimetype:s.dataFormat||s.mimetype,format:s.dataFormat||s.mimetype,type:s.dataFormat||s.mimetype}))}.bind(this),c.onErrors=function(t){var n;this.logger.error("Conversion error",t);try{n=JSON.parse(t)}catch(e){n=void 0}if(n&&n.errorCode>=500)return this.onErrorsVisited=!0,void("The connection with the server node has been closed before any success or error answer"===n.error&&e.onConvertError({nls:"Convert_ERROR",level:"fatal"},s));if(t&&t[0]&&t[0].split("\n")){var i=t[0].split("\n");"Please check the documentation for supported file versions and resave the file in one of supported versions if possible"===i[2]?(e.onConvertError({nls:"Convert_NOTSUPPORTED_SOLIDWORKS",level:r.fatal},s),this.onErrorsVisited=!0):"InterOp Diagnostic: The input Parasolid file is Bare binary file which is an unsupported format."===i[1]?(e.onConvertError({nls:"Convert_NOTSUPPORTED_BIN",level:r.fatal},s),this.onErrorsVisited=!0):"Translation failed for unknown error."===i[0]?(e.onConvertError({nls:"Convert_ERROR",level:r.fatal},s),this.onErrorsVisited=!0):"Error : The input file is saved in Civil3D. Output might be incomplete."===i[0]?SHARE.Core.sendEvent(this._exp.args.ctx,eventType.notif,notification.warning,{msg:p.Convert_Civil3D_Warning}):(e.onConvertError({nls:"Convert_ERROR",level:r.fatal},s),t[1]&&console.log("Error : "+t[1]),this.onErrorsVisited=!0)}}.bind(this),c.onMissingFiles=function(t){if(this.logger.error("Missing Files domain"),t&&("sldasm"!==s.type||"sldasm"!==s.format||"sldasm"!==s.mimetype)){this.logger.error(t);for(var n=0;n<t.length;n++){var i=t[n],o=Math.max(i.lastIndexOf("/"),i.lastIndexOf("\\"));-1!==o&&(i=i.substring(o+1,o.length));var a={nls:"Convert_MISSING_FILES",level:r.error,text:" "+i};this._exp&&this._exp.onModelLoadingError&&this._exp.onModelLoadingError(a)}e.onConvertError&&e.onConvertError({nls:"Convert_MISSING_FILES"})}return this._exp.getPhaseProgress().setAbsoluteProgress(this.subProgressID,100),this.cleanNode(c),!0}.bind(this),c.onProgress=function(e){this.logger.log("launchConvert.onProgress",e),e<.01?(l.end("XCAD_Transfer"),l.begin("XCAD_Convert")):e>.99&&(l.end("XCAD_Convert"),l.begin("Download")),this._exp&&this._exp.getPhaseProgress()&&this.subProgressID&&e&&this._exp.getPhaseProgress().setAbsoluteProgress(this.subProgressID,e/1*100)}.bind(this),e.ConversionOpts&&(a=new v,Object.keys(e.ConversionOpts).forEach(function(t){void 0!==e.ConversionOpts[t]&&a["Set"+t](e.ConversionOpts[t])})),l.begin("_execConvertCmd"),l.begin("XCAD_Transfer");var u=s.url,d=s.filename;(!u||e.asset._3DPlayDatas&&e.asset._3DPlayDatas.externalDrive&&!0===e.asset._3DPlayDatas.externalDrive)&&(u=d,d="");var h=d||"DummyName."+(s.format||s.mimetype);"asm"===s.dataFormat&&(s.dataFormat="3dxml"),o?(this.logger.log("_execConvertCmd.convert",h,o,s.dataFormat,a),c.convert(h,o,s.dataFormat,a)):(this.logger.log("_execConvertCmd.convertUrl",h,u,s.dataFormat,a),c.convertUrl(h,u,s.dataFormat,a))};if(s._3DPlayDatas&&s._3DPlayDatas.externalDrive){if("asm"===s.dataFormat)return void e.onConvertError({nls:"Convert_FILE_NOT_LOADED"},s);var u=s.requestsOptions||{};u.type="arraybuffer",u.timeout=5e4,l.begin("XCAD_DownloadExternalDrive");var d=this;u.onComplete=function(e){l.end("XCAD_DownloadExternalDrive");var t=new Uint8Array(e);c.apply(d,[t]),d=null},u.onFailure=u.onTimeout=function(t){l.end("XCAD_DownloadExternalDrive"),e.onConvertError({nls:"Convert_FILE_NOT_LOADED"},s),d=null},a.handleRequest(s.filename,u)}else c.apply(this)},cleanNode:function(e){setTimeout(function(){e._node.stop(),e=null},1e3)},dispose:function(){this._exp=null,this._stop=!0,this._counter=0}})});var t=["DS/TagNavigatorProxy/TagNavigatorProxy"];define("DS/3DPlayUtils/PanelManager",["DS/3DPlay/3DPlay","UWA/Core","UWA/Class","UWA/Controls/TabView","DS/TopBarProxy/TopBarProxy","DS/WebSystem/Environment","DS/3DPlayUtils/UIManager","DS/UIKIT/Spinner","DS/WebSystem/DataUrlTools","DS/WebSystem/DetectBrowser","DS/3DPlayUtils/PublishToSwym","DS/WebSystem/Nls","DS/3DPlayUtils/FullScreen","DS/WebUtils/ContextedSingleton","DS/WebSystem/Settings","DS/Utilities/Css","DS/WebSystem/App","DS/WebUtils/Tracker","i18n!DS/3DPlay/assets/nls/3DPlay","DS/WebSystem/SessionManager"].concat(t),function(e,t,n,i,r,o,s,a,l,c,u,d,p,h,v,f,m,g,S,y,D){"use strict";return n.extend({init:function(e){this.showVersion=!0,this.UIManager=new s(e);var t=new Date;this.lastClickTime=t.getTime(),this.panelContent={},this.panelContent.wait=this._generateWaitingUI(),this.experience=e.frameWindow.experience},setTopBarId:function(e){if(void 0===this.generated){if(this.generated=!0,e.topBarId&&(e.topBar={id:e.topBarId},console.error("API Migration : please don t use options.topBarId"),console.error("API Migration : use instead options.topBar.id")),!o.isSet("3DPlay.DisableTagger")&&m.is3DPlay()){var n=window.widget&&window.widget.id;n&&(this.tagger={proxyOptions:{filteringMode:"FilteringOnServer",events:{addFilterChangeListener:function(){this&&this.experience&&this.experience.getInformationsOnAsset()&&g.trackPageEvent("interactions","6wTags",this.experience.getInformationsOnAsset().type),this.tagger.tagger.setTags({"3DPlayAsset":this.currentTag||[]})}.bind(this)},widgetId:n},TagNavigatorProxy:D,experience:this.experience,dispose:function(){this.tagger&&this.tagger.die(),this.tagger=null,this.token&&this.experience.unsubscribe(this.token),this.token=null},activate:function(e){this.tagger&&(void 0===e||!0===e?this.tagger.activate():this.tagger.deactivate())},proxyTag:function(){this.tagger||(this.tagger=this.TagNavigatorProxy.createProxy(this.proxyOptions)),this.token||(this.token=this.experience.addOnLoadingStartedCB(function(e){if(this.experience.args&&this.experience.args.input){var n=this.experience.args.input.asset;if(n&&"FILE"===(this.experience.currentProvider||n.provider)){if(this.currentTag=[],n.swymAttr&&n.swymAttr.tags6w_implicit&&n.swymAttr.tags6w_implicit.length>0){var i=this.currentTag;n.swymAttr.tags6w_implicit.forEach(function(e){i.push({object:e.type,sixw:e.predicate,dispValue:e.tag})})}else n.driveAttr?(n.driveAttr.fullnameowner&&this.currentTag.push({object:n.driveAttr.fullnameowner,sixw:"ds6w:who/ds6w:responsible",dispValue:n.driveAttr.fullnameowner}),n.driveAttr.originator&&this.currentTag.push({object:n.driveAttr.originator,sixw:"ds6w:who/ds6w:responsible/ds6w:originator",dispValue:n.driveAttr.originator}),n.driveAttr.modified&&this.currentTag.push({object:t.Date.strftime(new Date(1e3*n.driveAttr.modified),"%Y/%m/%d"),sixw:"ds6w:when/ds6w:modified",type:"date"}),n.driveAttr.created&&this.currentTag.push({object:t.Date.strftime(new Date(1e3*n.driveAttr.created),"%Y/%m/%d"),sixw:"ds6w:when/ds6w:created",type:"date"}),n.driveAttr.type&&this.currentTag.push({object:n.driveAttr.type,sixw:"ds6w:what/ds6w:type",dispValue:n.driveAttr.type}),n.driveAttr.fileExtension&&this.currentTag.push({object:n.driveAttr.fileExtension,sixw:"ds6w:what/ds6w:docExtension",dispValue:fileExtension}),n.driveAttr.dataSource&&this.currentTag.push({object:n.driveAttr.dataSource,sixw:"ds6w:where/ds6w:source/ds6w:dataSource",dispValue:dataSource})):console.error("not supposed to be here");this.tagger.setTags({"3DPlayAsset":this.currentTag})}}else console.log((new Error).stack)}.bind(this),!1))}})}if(r){var i={};if(e.topBar&&e.topBar.id?i=e.topBar:window.widget&&window.widget.id&&(i.id=window.widget.id),i.id){for(var s=window;!s._swymData43DPlay&&s.parent&&s!==s.parent;)s=s.parent;if(s._swymData43DPlay)try{i.options={rightParentWindow:s.parent}}catch(e){}this.topBarProxy=new r(i),!1!==e.activeState&&"false"!==e.activeState||this.topBarProxy.deactivate()}}}},setVisibility:function(e){this.isTopBarAvailable()?this.topBarProxy&&(!1===e?this.topBarProxy.deactivate():this.topBarProxy.activate()):this.topMenuContainer&&(this.topMenuContainer.style.display=e?"":"none")},dispose:function(){this.UIManager&&(this.UIManager.dispose(),this.UIManager=null),this.panel=null,this.currentPanel=null,this.panelContainer=null,this.topMenuContainer=null,this.experience=null,this.panelClose=null,this.isTopBarAvailable()&&(this.topBarProxy.die(),this.topBarProxy=null),this.tagger&&(this.tagger.dispose(),this.tagger.experience=null,this.tagger=null)},isTopBarAvailable:function(){return void 0!==this.topBarProxy},createTopMenu:function(e){var n=e.container,i=this;if(this.experience=e.experience,this.ctx=e.ctx,this.panel=new t.Element("div",{attributes:{id:"PlayWeb-Panel",class:"SHAREPluginless_noSelect"}}),this.panelClose=new t.Element("span",{class:"CloseBtn"}).addEvent("click",function(){i.panelContainer.style.display="none"}).addEvent("touchstart",function(){i.panelContainer.style.display="none"}),new t.Element("span",{class:"fonticon fonticon-cancel"}).inject(i.panelClose),new t.Element("span",{class:"fonticon fonticon-cancel-circled"}).inject(i.panelClose),this.panel.appendChild(i.panelClose),this.panelContainer=f.verticalAlign(this.panel),this.panelContainer.id="PlayWeb-Panel-CSSV",this.panelContainer.setStyles({position:"absolute","text-align":"center","pointer-events":"none",display:"none","z-index":"10",top:"0px"}),this.panelContainer.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.panelContainer.inject(n),this.isTopBarAvailable()){var r,s=[],a=!1,l=!1;require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(e){e.getPlatformServices({onComplete:function(e){for(var t=0;t<e.length&&(e[t]["3DSwym"]&&""!==e[t]["3DSwym"]&&(l=!0),!0!==l);t++);a=!0},onFailure:function(){console.error(S.PlatformNotFound),a=!0}})},function(e){if("scripterror"===e.requireType){var t=e.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",t)}else console.error(e);console.error(S.ScripNotFoundError),a=!0});var c=0,u=setInterval(function(){11!==++c&&!0!==a||(clearInterval(u),u=void 0,a=!1,(!0===l||o.isSet("ODT_3DPlay_PanelManager"))&&(l=!1,s.push({label:S.Publish_Swym,onExecute:function(){i._publishToSwYm()}})),s.push({label:S.Publish_Print,onExecute:function(){setTimeout(function(){i._printScreenshot()},100)}}),e.skipSave||s.push({label:S.Publish_Save,onExecute:function(){setTimeout(function(){i._saveScreenshot()},100)}}),r={share:[{label:S.Publish_ShareAs,submenu:s}]},e.allowUploadServices&&r.share.push(e.allowUploadServices),o.isSet("3DPlay.Statistics")&&r.share.push({label:"Dump PCS",submenu:[{label:"All times",onExecute:function(){require("DS/WebUtils/ProbesManager").dump("Full")}},{label:"3DPlay Times",onExecute:function(){require("DS/WebUtils/ProbesManager").dump("3DPlay",!0)}}]}),i.topBarProxy&&i.topBarProxy.setContent(r))},100)}else if(!0===e.showBubbleMenu||o.isSet("3DPlay.ShowBubbleMenu")){this.topMenuContainer=new t.Element("div",{id:"PlayWeb-TopMenu",class:"SHAREPluginless_noSelect"}).inject(e.container);var d=new t.Element("span",{id:"PlayWeb-Save-Annotations",class:"PlayWeb-button",events:{click:function(){if(v.get("3DPlay.PersistedAnnotationsEnabled")){var e=h.get(i.ctx,"ANNOTATION_MANAGER");if(e){var t=e.saveAnnotationsToJSON();v.set("3DPlay.AnnotJson",t),alert("Annotations saved !!!")}}}}}).inject(this.topMenuContainer),m=new t.Element("span",{id:"PlayWeb-Create-Saved-Annotations",class:"PlayWeb-button"}).inject(this.topMenuContainer),g=v.get("3DPlay.AnnotJson");g?m.addEvent("click",function(){if(v.get("3DPlay.PersistedAnnotationsEnabled")){var e=[];v.get("3DPlay.UseExplodeCompatibleAnnotationManager")?e.push("DS/3DPlayAnnotation3D/AnnotationExplodeManager"):e.push("DS/3DPlayAnnotation3D/AnnotationManager"),require(e,function(e){var t=h.get(i.ctx,"ANNOTATION_MANAGER");t||(t=new e({frameWindow:i.experience.frmWindow,context:i.ctx}),h.add(i.ctx,"ANNOTATION_MANAGER",t)),t.drawAnnotationsFromJSON(g)})}}):m.style.display="none",this.panelContent.publish=this._generatePublishUI();var y=new t.Element("span",{id:"PlayWeb-Publish",class:"PlayWeb-button"}).inject(this.topMenuContainer);y.addEvent("click",function(){i._togglePanel(i.panelContent.publish)}),y.addEvent("touchend",function(){i._togglePanel(i.panelContent.publish)}),this.helpBtn=new t.Element("span",{id:"PlayWeb-Help",class:"PlayWeb-button"}).inject(this.topMenuContainer),y.setAttribute("title",S.Publish_Title),i.helpBtn.setAttribute("title",S.Help_Title),d.setAttribute("title",S.SaveAnnotation_Title),m.setAttribute("title",S.CreateSavedAnnotation_Title),this.openHelpPanel=function(e){void 0!==e&&i.Tab.selectTab(e),i._togglePanel(i.panelContent.help)},this.UIManager&&this.UIManager.addToPanelEvent(this.topMenuContainer,function(e){this.topMenuContainer&&(e.visible?this.topMenuContainer.style.right="35px":this.topMenuContainer.style.right="0px")})}var D=this.experience&&this.experience.args?this.experience.args:{};if(D.commandFullscreen||D.options.fullscreen){var C=new t.Element("span",{id:"PlayWeb-Fullscreen",class:"PlayWeb-button"}),w=new p(D.container,D.options.fullscreen,C,D.widget||window.widget);"none"!==w.getMode()&&(this.topMenuContainer||(this.topMenuContainer=new t.Element("div",{id:"PlayWeb-TopMenu",class:"SHAREPluginless_noSelect"}).inject(e.container),this.UIManager&&this.UIManager.addToPanelEvent(this.topMenuContainer,function(e){this.topMenuContainer&&(e.visible?this.topMenuContainer.style.right="35px":this.topMenuContainer.style.right="0px")})),C.inject(this.topMenuContainer),C.addEvent("click",function(){w.toggle(C)}),D.options&&D.options.fullscreen&&D.options.fullscreen.activateOnStart&&C.click())}},_togglePanel:function(e){e!==this.currentPanel?(this.currentPanel&&this.panel.removeChild(this.currentPanel),this.panel.appendChild(e),this.currentPanel=e,this.panelContainer.style.display="table",this.currentPanel===this.panelContent.wait?this.panelClose.style.display="none":this.panelClose.style.display=""):"none"===this.panelContainer.style.display?this.panelContainer.style.display="table":this.panelContainer.style.display="none"},_generatePublishUI:function(){var e=new t.Element("ul",{class:"PlayWeb-Menu"}),n=this,i=function(){setTimeout(function(){n._printScreenshot()},100)};new t.Element("li",{id:"Print_Menu_Item",html:S.Publish_Print,class:"PlayWeb-MenuItem"}).inject(e).addEvent("click",i).addEvent("touchstart",i);var r=function(){setTimeout(function(){n._saveScreenshot()},100)};return new t.Element("li",{id:"Save_Menu_Item",html:S.Publish_Save,class:"PlayWeb-MenuItem"}).inject(e).addEvent("click",r).addEvent("touchstart",r),e},_generateWaitingUI:function(){var e=new t.Element("ul",{class:"PlayWeb-Menu"});return new a({className:"large",visible:"true"}).inject(e),e.appendChild(document.createElement("br")),new t.Element("span",{html:S.GeneratingScreenshot}).inject(e),e},createDefaultHelp:function(){var e=[];if(!0===this.experience.args.touch){e.push({id:"Menu_Touch",event:"touchend",array:[["icTouchPan","HelpTouchPan"],["icTouchZoom","HelpTouchZoom"],["icTouchRotate","HelpTouchRotate"],["icTouchReframe","HelpTouchReframe"]]})}e.push({id:"Menu_Mouse",event:"click",array:[["icMouseLeft","HelpRotateBtn"],["icMouseMiddle","HelpZoomBtn"],["icMouseRight","HelpZoomAltBtn"],["icMouseMiddle","HelpDragBtn"]]}),this.setHelpContent(e)},setHelpContent:function(e){this.panelContent.help=this._generateHelphUI(e)},_generateHelphUI:function(e){var n=this,r=[],o=[],s=[];this.maxHeight=0;for(var a=e,l=0;l<a.length;l++)s[l]=a[l].id;this.showVersion&&s.push("Menu_About");for(var c=new t.Element("div"),u=function(e){return function(){var t=new Date;n.currentClickTime=t.getTime(),n.currentClickTime-n.lastClickTime>500&&(n.openHelpPanel(e),n.lastClickTime=n.currentClickTime)}},d=!1,p=!1,h=0;h<s.length;h++)if(h<a.length){var v=a[h].event;if(void 0!==v){"click"===v?d=!0:"touchend"===v&&(p=!0);var f=s[h];n.helpBtn&&n.helpBtn.addEvent(v,u(f))}r.push(new i.Tab({id:s[h],text:S[s[h]]})),o.push(document.createElement("table")),n._fillPanel(c,o[h],a[h].array)}else"Menu_About"===s[h]&&(n.helpBtn&&(!1===d?n.helpBtn.addEvent("click",u("Menu_About")):!1===p&&n.helpBtn.addEvent("touchend",u("Menu_About"))),r.push(new i.Tab({id:s[h],text:S[s[h]]})),o.push(document.createElement("table")),n._fillVersionPanel(o[h]));n.Tab=new i({className:"help",tabs:r,events:{onSelectTab:function(){}}}).inject(c);for(var m=0;m<r.length;m++)r[m].setContent(o[m]);return c},_fillPanel:function(e,t,n){this.maxHeight<n.length&&(this.maxHeight=n.length),e.setStyles({height:66*this.maxHeight+60+"px"});for(var i=[],r=0;r<n.length;r++)i[r]=n[r][1];for(var o=0;o<n.length;o++){var s=document.createElement("tr"),a=document.createElement("td");a.setAttribute("class","ic "+n[o][0]);var l=document.createElement("td");l.appendChild(document.createTextNode(S[i[o]])),l.setAttribute("class","desc"),s.appendChild(a),s.appendChild(l),t.appendChild(s)}},_fillVersionPanel:function(e){var n=document.createElement("tr"),i=document.createElement("td");i.setAttribute("class","logoDS");var r=document.createElement("td");r.appendChild(document.createTextNode(S.Menu_AppName)),r.appendChild(document.createElement("br")),r.appendChild(document.createElement("br"));var o=new t.Element("div",{styles:{"pointer-events":"all"}}).inject(r);new t.Element("a",{html:S.Menu_Documentation,href:"http://www.3ds.com/support/3dplay-app/",target:"_blank",styles:{"pointer-events":"all",color:"#456077"}}).inject(o),r.setAttribute("style","font-size: initial;vertical-align: middle;"),n.appendChild(i),n.appendChild(r),e.appendChild(n),this.maxHeight>0&&(e.style.minHeight=66*this.maxHeight+"px")},_publishToSwYm:function(){this._pictureFlash();var e={ctx:this.ctx};setTimeout(function(){new u(e)},1e3)},_printScreenshotAfterFlash:function(){var e=this,n=new t.Element("iframe",{styles:{position:"fixed",top:"0",left:"100%",width:"100%",height:"100%"}}).inject(document.body);c&&"firefox"===c().browser.name?n.onload=function(){e._printScreenshotAfterFrameLoaded(n)}:e._printScreenshotAfterFrameLoaded(n)},_printScreenshotAfterFrameLoaded:function(n){var i,r=this;if(c&&"ie"===c().browser.name&&void 0!==r.experience.frmWindow._3dViewer&&null!==r.experience.frmWindow._3dViewer&&void 0!==r.experience.frmWindow._3dViewer.getCurrentSheet&&null!==r.experience.frmWindow.getCurrentSheet&&(i=r.experience.frmWindow._3dViewer.getCurrentSheet()),i&&void 0!==i.svg&&null!==i.svg){if(void 0!==i.getSVGCloneNode&&null!==i.getSVGCloneNode){var s=i.getSVGCloneNode();n.contentWindow.document.body.appendChild(s);try{!1===n.contentWindow.document.execCommand("print",!1,null)&&n.contentWindow.print()}catch(e){n.contentWindow.print()}s=null,setTimeout(function(){document.body.removeChild(n),n=null},6e4)}}else r.experience.getScreenShot({onSuccess:function(e){var i,r=new t.Element("img",{src:e,styles:{"max-width":"100%","max-height":"100%"}}).inject(n.contentWindow.document.body);i=setInterval(function(){if(r.offsetHeight||r.height){if(clearInterval(i),o.isSet("ODT_3DPlay_PanelManager"))require(["DS/CoreEvents/Events"],function(e){e.publish({event:o.get("ODT_3DPlay_PanelManager")})});else try{!1===n.contentWindow.document.execCommand("print",!1,null)&&n.contentWindow.print()}catch(e){n.contentWindow.print()}setTimeout(function(){document.body.removeChild(n),n=null},6e4)}},100)},onFail:function(){e.sendEvent(r.ctx,eventType.notif,notification.error,{msg:S.UnableToCreateScreenshot})}});i=null},_printScreenshot:function(){var e=this;this._pictureFlash(function(){e._printScreenshotAfterFlash(),e=void 0})},_saveScreenshotAfterFlash:function(){var n=this;this.experience.getScreenShot({onSuccess:function(e){if(void 0!==window.Windows&&void 0!==window.Windows.Security&&void 0!==window.Windows.Storage){var n=e.replace("data:image/png;base64,",""),i=Windows.Security.Cryptography.CryptographicBuffer.decodeFromBase64String(n),r=new Windows.Storage.Pickers.FileSavePicker;r.suggestedStartLocation=Windows.Storage.Pickers.PickerLocationId.documentsLibrary,r.fileTypeChoices.insert("Picture",[".png"]),r.suggestedFileName="myScreenshot",r.pickSaveFileAsync().then(function(e){if(e)return Windows.Storage.FileIO.writeBufferAsync(e,i)})}else if("download"in document.createElement("a")){var s,a;v.get("3DPlay.PersistedAnnotationsEnabled")?(s=e,a="3DPlay_Screenshot.svg"):(s=l.toBlob(e),a="3DPlay_Screenshot.png");var c=new t.Element("a",{href:s,download:a,styles:{visibility:"hidden"}}).inject(document.body);o.isSet("ODT_3DPlay_PanelManager")?require(["DS/CoreEvents/Events"],function(e){e.publish({event:o.get("ODT_3DPlay_PanelManager")})}):c.click(),document.body.removeChild(c)}else{window.open("about:blank","3DPlay web","width=1024,height=860").document.body.innerHTML='<img style="max-width:100%;max-height:100%" src="'+e+'" />'}},onFail:function(){e.sendEvent(n.ctx,eventType.notif,notification.error,{msg:S.UnableToCreateScreenshot})}})},_saveScreenshot:function(){var e=this;this._pictureFlash(function(){e._saveScreenshotAfterFlash(),e=void 0})},_pictureFlash:function(e){this.panelContainer.style.display="none";var n=this.experience.frmWindow.getViewerFrame(),i=this.experience.frmWindow.getUIFrame(),r=new t.Element("div",{id:"_3DPlay-Flash",styles:{position:"absolute",top:0,left:0,width:n.clientWidth+"px",height:n.clientHeight+"px","background-color":"white"}}).inject(i),o=1,s=function(){o-=.02,r.setStyle("opacity",o),o<0?(i.removeChild(r),"function"==typeof e&&e()):requestAnimationFrame(s)};s()},_shareTo3DComment:function(){var e=this.experience;this._pictureFlash(function(){var t=h.get(e.ctx,"ANNOTATION_MANAGER");if(e&&t){var n=e.frmWindow.getViewer(),i=n&&n.getCurrentState?n.getCurrentState():void 0,r=i?t.saveAnnotationsToJSON(i):JSON.stringify(y.getSession()),o=new Blob([r],{type:"application/json"});e.getScreenShot({width:240,height:180,type:"jpeg",onSuccess:function(t){var n={screenshot:t,annotation:o};e.onAnnotationShared?(console.log("Social: onAnnotationShared found"),e.onAnnotationShared(n)):(console.log("3DPlay: Launching 3DPlay's social panel"),e.publish("3DPLAY/EXP/3DPLAY3DCOMMENT",{data:n})),e=null}})}})},_downloadSourceDocument:function(){!!(this.experience&&this.experience.args&&this.experience.args.input&&this.experience.args.input.asset&&"FILE"===this.experience.args.input.asset.provider&&"pdf"===this.experience.args.input.asset.type)&&window.open(this.experience.args.input.asset.filename,"_blank")}})});