/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/Web3DUXAssistantTools/Web3DUXAssistantTools",["UWA/Core","UWA/Controls/Abstract","DS/Core/PointerEvents","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","css!DS/Web3DUXAssistantTools/Web3DUXAssistantTools.css"],function(e,t,o,i,s){"use strict";return t.extend({defaultOptions:{body:null,viewer:null,frmWindow:null,heightElem:"32px",widthElem:"32px",offset:null,mode:"vertical",dir:"right",lJsonElement:[]},init:function(t){this._parent(t);var n,l,r=this,a=this.options,d=null,c=null,f=[],p=null,u=a.position&&a.position.clone?a.position.clone():new s.Vector3,h=a.offset&&!isNaN(a.offset.x)?a.offset.x:0,m=a.offset&&!isNaN(a.offset.y)?a.offset.y:0,v=a.lJsonElement,b=a.viewer,g=a.frmWindow;function y(t,i,s,n){var l=e.createElement("div",{class:"Web3DUXAssToolsBtn",id:t.id,title:t.nls,styles:{top:s,left:n,height:a.heightElem,width:a.widthElem}}).inject(i);t.bstateActif&&l.addClassName("Web3DUXAssToolsActiveState"),new e.Controls.Img({url:t.url}).inject(l).elements.container.setStyles({width:"calc(100% - 6px)",height:"calc(100% - 6px)",margin:"3px 0px 0px 3px"}),f.push(l),t.callback&&l.addEvent(o.POINTERUP,function(e){"boolean"==typeof t.bstateActif&&(this.hasClassName("Web3DUXAssToolsActiveState")?this.removeClassName("Web3DUXAssToolsActiveState"):this.addClassName("Web3DUXAssToolsActiveState")),t.callback&&t.callback.call(e)})}function E(e){var t={top:e.top,left:e.left},o=(parseInt(a.widthElem,10)+n)*f.length/2;return"horizontal"===a.mode||"curve"===a.mode&&"bottom"===a.dir||"curve"===a.mode&&"top"===a.dir?("curve"===a.mode&&"top"===a.dir&&v.length>=3?t.top=parseInt(t.top,10)-2*n-parseInt(a.widthElem,10):"curve"===a.mode&&"bottom"===a.dir&&v.length>=3&&(t.top=parseInt(t.top,10)+n),t.left=t.left-o):("vertical"===a.mode||"curve"===a.mode&&"right"===a.dir||"curve"===a.mode&&"left"===a.dir)&&(t.top=parseInt(t.top,10)-parseInt(o,10),"curve"===a.mode&&"left"===a.dir&&v.length>=3?t.left=t.left-l:"curve"===a.mode&&"right"===a.dir&&v.length>=3&&(t.left=t.left+l)),h&&(t.left+=h),m&&(t.top+=m),t}this.updatePosition=function(e){if(e&&p){u!==e&&(u=e);var t,o=b.canvas.offsetHeight,i=b.canvas.offsetWidth,s=0,r=0;if(g){var d=g.getImmersiveFrame().getFreeZone().getBoundingClientRect();o=d.height,i=d.width;var c="number"==typeof d.x&&"number"==typeof d.y?{x:d.x,y:d.y}:g.getImmersiveFrame().getFreeZone().getPosition();s=d.left-c.x,r=d.top-c.y}if(isNaN(u.x)||isNaN(u.y)||isNaN(u.z))t=E(u);else{var f=b.currentViewpoint.project(u);t=E({left:f.x,top:f.y})}var h=Math.abs(n)+parseInt(a.heightElem,10),m=Math.abs(l)+parseInt(a.widthElem,10);t.top<r+5?t.top=r+5:t.top+h+5>r+o&&(t.top=r+o-h-5),t.left<s+5?t.left=s+5:t.left+m+5>s+i&&(t.left=s+i-m-5),p.style.top=Math.round(t.top)+"px",p.style.left=Math.round(t.left)+"px"}},this.build=function(){r.clear();var t,o,s=(v=a.lJsonElement).length,f=12,h=[];for(o=0;o<a.lJsonElement.length;o++)"separator"!==a.lJsonElement[o].type&&h.push(a.lJsonElement[o].id);var m=function(e){for(var t=e.length,o=[],i={},s=0;s<t;s++)i[e[s]]=i[e[s]]>=1?i[e[s]]+1:1;for(var n in i)i[n]>1&&o.push(n);return o}(h);if((!m||0===m.length)&&s&&b&&g&&a.body){for((p=e.createElement("div",{class:"Web3DUXAssToolsMainDiv"}).inject(a.body)).addEvent("dragstart",function(e){e.preventDefault()}),l=0,n=0,o=0;o<s;o++)"vertical"===a.mode?(l=0,n=-2*(s/2-1)+2*o+(parseInt(a.heightElem,10)+8)*o):"horizontal"===a.mode?(l=-2*(s/2-1)+2*o+(parseInt(a.widthElem,10)+8)*o,n=0):"curve"===a.mode&&"right"===a.dir||"curve"===a.mode&&"left"===a.dir?(n=(parseInt(a.heightElem,10)+8)*o,0===o&&3!==s?t=-((s/2+o)*f+(s/2+o)*(f/4)):o===s-1&&3!==s&&(t=-(f*(o-(s/2-1))+f/4*(o-(s/2-1)))),t=0===o&&3===s?-f:o===s-1&&3===s?-f:o>s/2?-(f*(o-s/2)+.5*f*(o-s/2-1)):-((s/2-1-o)*f+.5*(s/2-1-o-1)*f),"left"===a.dir&&(t=-t),l=s<3?0:s%2==0?o===s/2||o===s/2-1?0:t:o===s/2-.5?0:t):("curve"===a.mode&&"bottom"===a.dir||"curve"===a.mode&&"top"===a.dir)&&(f=8,l=-2*(s/2-1)+2*o+(parseInt(a.widthElem,10)+8)*o,0===o&&3!==s?t=-((s/2+o)*f+(s/2+o)*(f/4)):o===s-1&&3!==s&&(t=-(f*(o-(s/2-1))+f/4*(o-(s/2-1)))),t=0===o&&3===s?-f:o===s-1&&3===s?-f:o>s/2?-(f*(o-s/2)+.5*f*(o-s/2-1)):-((s/2-1-o)*f+.5*(s/2-1-o-1)*f),"top"===a.dir&&(t=-t),n=s<3?0:s%2==0?o===s/2||o===s/2-1?0:t:o===s/2-.5?0:t),y(v[o],p,n+"px",l+"px");r.updatePosition(u),r.setVisibleFlag(!0),d||(d=i.subscribe({event:"/VISU/onWindowResized"},function(e){"@onWindowResized"===e.eventType&&r.updatePosition(u)})),c||(c=i.subscribe({event:"/VISU/"},function(e){"@onViewpointChange"===e.eventType&&r.updatePosition(u)}))}},this.addButton=function(e){e.id&&v.push(e)},this.removeButtons=function(e){if(Array.isArray(e)){var t=e.slice();t.sort(function(e,t){return e-t});for(var o=t.length-1;o>=0;o--)t[o]>=0&&t[o]<v.length&&v.splice(t[o],1)}},this.setOffset=function(e){!e||isNaN(e.x)||isNaN(e.y)||(h=e.x,m=e.y,r.updatePosition(u))},this.setVisibleFlag=function(e){p&&(p.style.display=e?"block":"none")},this.getVisibleFlag=function(){return!!p&&"block"===p.style.display},this.clear=function(){f=[],p&&(a.body&&a.body.removeChild(p),p.destroy()),d&&i.unsubscribe(d),c&&i.unsubscribe(c),d=c=p=null}}})});