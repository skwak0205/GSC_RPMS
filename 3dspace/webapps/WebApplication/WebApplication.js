define("DS/WebApplication/WebApplication",["DS/WebUtils/FunctionDisposer","DS/WebSystem/Scripting","DS/WebSystem/Environment","DS/WebRunloop/Runloop","DS/WebUtils/Profiler","DS/WebApplicationBase/W3AManagerSet","DS/WebSystem/Context","DS/VCXWebExperienceBase/VCXExperienceBase","DS/WebUtils/Statistics","DS/Visualization/ModelLoader","DS/Visualization/Node3D","UWA/Promise"],function(e,i,t,n,s,o,r,a,p,d,l,h){"use strict";return i.extend({init:function(i){this._parent(),this.context=r.createContext(),this.options=UWA.extend({},i,!0),this._guidedTourMode=void 0!==i.guidedTour&&i.guidedTour,this.options.container?"string"==typeof this.options.container&&(this.options.container=document.getElementById(this.options.container)):this.options.options.frmWindow&&(this.options.container=this.options.options.frmWindow.getUIFrame()),this.disposeFunctions=new e;var n=e=>{this.app=new e(this.options),this.options.__ODT_onAppInitialize&&this.options.__ODT_onAppInitialize(this);var i=e=>(e.createDom(),t.isSet("3DPlay.Statistics")&&(e.stats=new p),e.stats&&e.stats.set({container:e.options.container}),e.viewer=e.frmWindow.getViewer?e.frmWindow.getViewer():null,e.requestNewExperienceBaseAsync());void 0!==this.app.onPreCreate?this.app.onPreCreate(this,e=>{0===e&&i(this)}):i(this)},s=e=>{if("scripterror"==e.requireType){var i=e.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",i)}else console.error(e)};this.disposeFunctions.add(()=>{n=null,s=null}),void 0===this.options.application&&(this.options.application="DS/3DPlayApplication/3DPlayApplication"),window.extensionDictionaryApp||(window.extensionDictionaryApp={}),window.interfaceDictionaryApp||(window.interfaceDictionaryApp={}),window.componentDictionaryApp||(window.componentDictionaryApp={}),require([this.options.application],n,s)},requestNewExperienceBaseAsync:function(){var e=UWA.Promise.resolve().then(()=>(this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null),this.experienceBase&&this.app.disposeExperienceBase&&this.app.disposeExperienceBase())).then(()=>this.experienceBase&&this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.unInitialize(!0)).then(()=>(this.experienceBase&&(this.experienceBase.Clean(),this.experienceBase.webApplication=null,this.experienceBase=null),this.experienceBase=new a(null),this.experienceBase.requestPromise=e,this.experienceBase.initialize&&this.experienceBase.initialize(this.app))).then(()=>(this.experienceBase.webApplication=this,this.viewer&&(this.experienceBase.modelLoader=this.getModelLoader()),this.app.onPostCreate(this.experienceBase))).then(e=>this.experienceBase._ManagerSet.initialize(!0)).then(()=>{var e=this.experienceBase.getManager("VCXContextManager");return e&&this.viewer&&(this._guidedTourMode&&e.setExperienceInGuidedTour(),e.setFrameWindow(this.frmWindow)),this.frmWindow._experienceBase=this.experienceBase,this.experienceBase._ManagerSet.postInitialize(!0)}).then(()=>this.app.onFinished&&this.app.onFinished(this.experienceBase)).then(()=>(this.profileFrame=s.start("webApplication::frame"),this.runloop=new n({data:this,func:this.runloopFunc}),this.runloop.start(),this.experienceBase));return e},getModelLoader:function(){if(this.app&&this.app.getModelLoader)return this.app.getModelLoader();var e=this.frmWindow.getViewer(),i=new l("RootBag");return e.addNode(i),new d({node:i,viewer:e})},getContext:function(){return this.context},activateGuidedTourMode:function(){this._guidedTourMode=!0},deactivateGuidedTourMode:function(){this._guidedTourMode=!1},createDom:function(e){if(!this.frmWindow){if(e&&e.frmWindow)this.frmWindow=e.frmWindow;else if(this.options.frmWindow)this.frmWindow=this.options.frmWindow;else{var i;if(void 0===e?i=this.options.FrameWindow:(i=e.frameWindowCtor,t=e.options),void 0===t){(t={}).uiOptions=this.options.ui||{displayTree:!1};var t={context:this.getContext()};if(this.app.getOptions&&(t=UWA.extend(t,this.app.getOptions(),!0)),this.app.getWorkBench){var n=this.app.getWorkBench();Array.isArray(n)&&(n=n[0]),t.workbenchModule=n.module,t.workbench=n.name+".xml",void 0!==n.defaultCommand&&(t.defaultCommand=n.defaultCommand)}}t.viewerOptions||(t.viewerOptions={}),t.viewerOptions.defaultAnimationLoop=!1,this.frmWindow=new i(t).inject(this.options.container)}this.frmWindow.getActionBar()&&(this.callbackActionBar=this.frmWindow.getActionBar().onActionBarReady(()=>{this.app.onActionBarReady&&this.app.onActionBarReady()}))}return this.frmWindow},runloopFunc:function(e){this.useCallback=void 0===this.useCallback||this.useCallback,this.profileFrame.start();var i=this.experienceBase.getManager("VCXContextManager"),t=UWA.extend(this.viewer?{viewer:i.getMainViewer()}:{viewer:null},e,!0);t.profiler=this.profileFrame.addProfile("managerSet::update"),this.experienceBase._ManagerSet.update(t),this.skipFrame?this.skipFrame=!1:i.applyToViewers(e=>{e._modelEvent&&!e.registredCBs&&(e.registredCBs={preToken:e._modelEvent.subscribe({event:"PreRender"},e=>{e.profiler=this.profile_animate.addProfile("preRender"),this.experienceBase._ManagerSet.preRender(e),this.profile_render=this.profile_animate.addProfile("render")}),postToken:e._modelEvent.subscribe({event:"PostRender"},e=>{e.renderingTime=this.profile_render.stop(),e.profiler=this.profile_animate.addProfile("postRender"),this.experienceBase._ManagerSet.postRender(e)})},e.defaultAnimationLoop=!1,this.disposeFunctions.add(()=>{})),this.profile_animate=this.profileFrame.addProfile("viewer["+e.id+"]::animate"),e.animate(),this.profile_animate.stop()}),t.viewer=this.viewer?i.getMainViewer():null,t.profiler=this.profileFrame.addProfile("managerSet::postUpdate"),this.experienceBase._ManagerSet.postUpdate(t),this.profileFrame.stop(),this.stats&&this.stats.postProcess()},dispose:function(e){this.experienceBase.getManager("VCXContextManager").applyToViewers(e=>{e.registredCBs&&(e.defaultAnimationLoop=!0,e.disposed||(e._modelEvent.unsubscribe(e.registredCBs.preToken),e._modelEvent.unsubscribe(e.registredCBs.postToken)),delete e.registredCBs,e.animate())});var i=this.frmWindow.getActionBar();i&&i.removeCallback(this.callbackActionBar),this.experienceBase.modelLoader=null,this.frmWindow._experienceBase=null,this.experienceBase.frmWindow=null,this.experienceBase.webApplication=null;var t=this.options&&this.options.Async||window.useAsyncExperienceBase,n=this.experienceBase&&this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.unInitialize(t);n||(n=new h(e=>{e()}));var s=this;return this._parent(),n.then(()=>{s.experienceBase.Clean(),s.experienceBase=null,s.disposeFunctions.dispose(),s.disposeFunctions=null,s.runloop.stop(),s.runloop.dispose(),s.runloop=null,s.options=null,s.viewer=null,s.app.dispose(),s.app=null,void 0!==!e.disposeFrameWindow&&!0!==e.disposeFrameWindow||s.frmWindow.dispose(),s.frmWindow=null,s.stats&&(s.stats.dispose(),s.stats=null),s=null})}})});