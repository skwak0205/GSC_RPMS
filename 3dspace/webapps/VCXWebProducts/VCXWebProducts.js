define("DS/VCXWebProducts/VCXCameraPlayModeCmd",["DS/ApplicationFrame/CommandCheckHeader"],function(e){"use strict";return e.extend({init:function(e){this._parent(e,{});var t=this;this.onStateChange(function(){var e=t.getFrameWindow()._experienceBase;if(e){var n=e.getManager("VCXVisuManager");n&&(t.getState()?n.setUpdateViewport(!0):n.setUpdateViewport(!1))}}),this.setState(!0)}})}),define("DS/VCXWebProducts/VCXConsoleCtrl",["UWA/Class","UWA/Element","DS/CoreEvents/Events"],function(e,t,n){"use strict";return e.singleton({addDiv:function(){if(!0!==this.bInitialized){this.bInitialized=!0;var e=document.body;this._mainPanel=new UWA.Element("div",{html:"",class:"VCXConsoleCtrl",id:"VCXConsoleCtrlID",styles:{zIndex:99999,margin:"",height:"200px",width:"600px",top:"50px",left:"100px",position:"absolute",border:"1px solid grey",resize:"both",overflow:"auto",backgroundColor:"rgba(200,200,200,.9)"}}).inject(e),this._panelBody=new UWA.Element("div",{html:"",class:"VCXConsoleCtrlBody",id:"VCXConsoleCtrlIDBody",styles:{userSelect:"none",textAlign:"left",color:"black",fontSize:"x-small",position:"absolute",margin:"",height:"calc( 100% - 20px )",width:"100%",top:"20px",left:"0px",border:"none",backgroundColor:"rgba(200,200,200,.9)"}}).inject(this._mainPanel),this._panelHeader=new UWA.Element("div",{html:"CONSOLE",class:"VCXConsoleCtrlheader",id:"VCXConsoleCtrlIDheader",styles:{userSelect:"none",color:"black",position:"sticky",margin:"",height:"20px",width:"100%",top:"0px",left:"0px",border:"none",backgroundColor:"rgba(150,150,150,1)"}}).inject(this._mainPanel);!function(e){var t=0,n=0,i=0,o=0;document.getElementById(e.id+"header")?(document.getElementById(e.id+"header").onmousedown=a,document.getElementById(e.id+"header").ontouchstart=a):e.onmousedown=a;var r=0;function a(e){(e=e||window.event).preventDefault();var t=(new Date).getTime()-r;if(t<300&&t>0){var n=document.getElementById("VCXConsoleCtrlID");"20px"==n.style.height?n.style.height="200px":n.style.height="20px"}else{var a=e.clientX,u=e.clientY;a||(a=e.touches[0].clientX),u||(u=e.touches[0].clientY),i=a,o=u,document.onmouseup=c,document.ontouchend=c,document.onmousemove=s,document.ontouchmove=s}r=(new Date).getTime()}function s(r){(r=r||window.event).preventDefault();var a=r.clientX,s=r.clientY;a||(a=r.touches[0].clientX),s||(s=r.touches[0].clientY),t=i-a,n=o-s,i=a,o=s;var c=e.offsetTop-n;c>0&&(e.style.top=c+"px"),e.style.left=e.offsetLeft-t+"px"}function c(){document.onmouseup=null,document.onmousemove=null,document.ontouchmove=null,document.ontouchend=null}}(document.getElementById("VCXConsoleCtrlID")),function(){console.log,console.log;var e=document.getElementById("VCXConsoleCtrlIDBody"),t=(document.getElementById("VCXConsoleCtrlID"),""),n=null,i=function(i,o){for(var r=new Date,a=0;a<i.length;a++)t="object"==typeof i[a]?r.toLocaleTimeString()+o+(JSON&&JSON.stringify?JSON.stringify(i[a],void 0,2):i[a])+"<br />"+t:r.toLocaleTimeString()+o+i[a]+"<br />"+t;n&&(window.clearTimeout(n),n=null),n=window.setTimeout(function(){window.clearTimeout(n),n=null,e.innerHTML=t},1e3)};console.log=function(){i(arguments," [LOG] ")},console.error=function(){i(arguments," [ERROR] ")},console.warn=function(){i(arguments," [WARN] ")},console.info=function(){i(arguments," [INFO] ")}}()}}})}),define("DS/VCXWebProducts/VCXShowAllCmd",["DS/ApplicationFrame/Command","DS/VCXWebKernelCommands/VCXCmdChangeVisibility","DS/VCXWebVisibility/VCXIVisibility"],function(e,t,n){"use strict";return e.extend({init:function(e){this._parent(e,{})},beginExecute:function(){},execute:function(){for(var e=this.getFrameWindow()._experienceBase,i=e.ComponentsMap.GetComponentFromType("VCXWebComponentOccurrence"),o=e.ComponentsMap.GetComponentFromType("VCXWebComponentOccurrence",!0),r=[],a=0;a<i.length;++a){(s=i[a].QueryInterface("VCXIVisibility"))&&(s.GetVisibility()!==n.EVisState.Hidden||r.push(i[a]))}for(a=0;a<o.length;++a){var s;(s=o[a].QueryInterface("VCXIVisibility"))&&(s.GetVisibility()!==n.EVisState.Hidden||r.push(o[a]))}if(0!==r.length){var c=new t(e.getManager("VCXScenarioManager"),e.ComponentsMap,e.getManager("VCXCommandManager"));c.ChangeVisibility(r,n.EVisState.Visible),e.getManager("VCXCommandManager").Push(c)}},endExecute:function(){}})}),define("DS/VCXWebProducts/VCXHideSelectionCmd",["DS/ApplicationFrame/Command","DS/VCXWebKernelCommands/VCXCmdChangeVisibility","DS/VCXWebVisibility/VCXIVisibility"],function(e,t,n){"use strict";return e.extend({init:function(e){this._parent(e,{})},beginExecute:function(){},execute:function(){this._hideSelection()},endExecute:function(){this._experienceBase=null},_hideSelection:function(){var e=this.getFrameWindow();this._experienceBase=e._experienceBase;var t=this._experienceBase.getManager("VCXSelectionManager").GetComponentsFromCurrentSelection();this._hideElementsFromArray(t)},_hideElementsFromArray:function(e){if(Array.isArray(e)){for(var i,o=[],r=0;r<e.length;++r){var a=e[r].QueryInterface("VCXIVisibility");a&&((i=a.GetVisibility())!==n.EVisState.Visible&&void 0!==i||o.push(e[r]))}if(0!==o.length){var s=new t(this._experienceBase.getManager("VCXScenarioManager"),this._experienceBase.ComponentsMap,this._experienceBase.getManager("VCXCommandManager"));s.ChangeVisibility(o,n.EVisState.Hidden),this._experienceBase.getManager("VCXCommandManager").Push(s)}}}})}),define("DS/VCXWebProducts/VCXPreviewPlayCmd",["UWA/Core","DS/ApplicationFrame/CommandsManager","DS/ApplicationFrame/Command"],function(e,t,n){"use strict";return n.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0})},beginExecute:function(){},execute:function(){this.onResume(function(){}),this.onPause(function(){})},endExecute:function(){}})}),define("DS/VCXWebProducts/VCXPlayGuidedTourUI",["UWA/Class","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/RuntimeView/NLSManager","css!DS/VCXWebProducts/VCXWebProducts.css"],function(e,t,n,i,o){"use strict";return e.extend({init:function(e){this._modelEvent=new n;var t="VCXWebProducts/VCXWebProducts";this.buttonsTooltipsStr={terminate:""};var o=this;i.onResourceLoaded({resourceFile:t},function(){o.buttonsTooltipsStr.terminate=this.getTitle({key:"GuidedTourTerminateButton"})}),i.loadResource({resourceFile:t})},destroy:function(){this.terminateUI(),this.buttonsTooltipsStr=null,this._modelEvent=null},setplayGuidedTourUI:function(e){var n=e._experienceBase,i=n.getManager("VCXGUIManager").getGUIServices();this.preHidingConfig=i.hideDockingElements(e),e.getActionBar().hide(),n.getManager("VCXGUIManager").SetDisplayScenarioImmersiveUI(!0),this._setImmersiveUICustomization(!0),this.frmWindow=e;var o=this.frmWindow.getUIFrame();this._container=UWA.createElement("div",{html:"",class:"guidedTourGUI pauseOnClickCurtain atCmdLaunch paused"}),this._playPauseButton=UWA.createElement("div",{html:"",class:"guidedTourGUI__playPauseButton playIcon"}),this._playPauseButton.inject(this._container),this._terminateButton=UWA.createElement("div",{html:"",class:"guidedTourGUI__terminateButton",title:this.buttonsTooltipsStr.terminate}),this._terminateButton.inject(this._container);var r=document.getElementById("PlayWeb-TopMenu");r&&r.classList.add("shifted"),this._waitingContainer=UWA.createElement("div",{html:"",class:"pauseWaitingContainer"});for(var a=0;a<4;++a){UWA.createElement("div",{html:"",class:"pauseWaitingBar"}).inject(this._waitingContainer)}this.terminateUICB=this._publishEvent.bind(this,"terminate"),this.togglePlayPauseCB=this._togglePlayPauseUI.bind(this),this._terminateButton.addEventListener("click",this.terminateUICB),this._playPauseButton.addEventListener("click",this.togglePlayPauseCB),this._container.addEventListener("click",this.togglePlayPauseCB);var s=this;this.tokenSubscribeEnd=t.subscribe({event:"VCX_PLAY_GUIDED_TOUR_END"},function(e){s._setPauseWaitingAnimation(!1),s._container.classList.contains("playing")&&s.displayUI(),s._deactivateCustoImmersiveUIArrow()}),this.tokenSubscribeGoToScen=t.subscribe({event:"VCX_PLAY_GUIDED_TOUR_GOTOSCENARIO"},function(e){s._activateCustoImmersiveUIArrow(e.currentScenarioIdx<e.nextScenarioIdx)}),this.tokenSubscribeGoToScen=t.subscribe({event:"VCX_PLAY_GUIDED_TOUR_GOTOSCENARIO_END"},function(e){s._deactivateCustoImmersiveUIArrow()}),this._container.inject(o)},terminateUI:function(e){if(e&&e.stopPropagation(),this.frmWindow){var n=this.frmWindow._experienceBase.getManager("VCXGUIManager").getGUIServices();if(this.preHidingConfig=n.restoreDockingElements(this.frmWindow,this.preHidingConfig),this.frmWindow.getActionBar().show(),this._container){this.tokenSubscribeEnd&&t.unsubscribe(this.tokenSubscribeEnd),this.tokenSubscribeEnd=null,this._terminateButton.removeEventListener("click",this.terminateUICB),this._playPauseButton.removeEventListener("click",this.togglePlayPauseCB),this._container.removeEventListener("click",this.togglePlayPauseCB),this.terminateUICB=null,this.togglePlayPauseCB=null,this.togglePlayPauseCB=null;for(var i=this._waitingContainer.getChildren(),o=0;o<i.length;++o){var r=i[o];r&&r.destroy()}this._waitingContainer.destroy(),this._terminateButton.destroy();var a=document.getElementById("PlayWeb-TopMenu");a&&a.classList.contains("shifted")&&a.classList.remove("shifted"),this._playPauseButton.destroy(),this._container.destroy()}this.frmWindow=null}else console.log("No Framewindow available anymore..")},displayUI:function(){this._playPauseButton.classList.contains("pauseIcon")&&(this._userInteraction?(this._setPauseWaitingAnimation(!0),this._userInteraction=!1):(this._playPauseButton.classList.remove("pauseIcon"),this._playPauseButton.classList.add("playIcon"))),this._container.classList.contains("pauseOnClickCurtain")&&this._container.classList.remove("pauseOnClickCurtain"),this._container.classList.contains("playing")&&this._container.classList.replace("playing","paused"),this._setImmersiveUICustomization(!1)},hideUI:function(){this._container.classList.contains("atCmdLaunch")&&this._container.classList.remove("atCmdLaunch"),this._playPauseButton.classList.contains("playIcon")&&this._playPauseButton.classList.replace("playIcon","pauseIcon"),this._container.classList.contains("pauseOnClickCurtain")||this._container.classList.add("pauseOnClickCurtain"),this._container.classList.contains("paused")&&this._container.classList.replace("paused","playing"),this._setImmersiveUICustomization(!0),this._userInteraction=!1},subscribe:function(e,t){if(this._modelEvent)return this._modelEvent.subscribe({event:e},t)},unsubscribe:function(e){this._modelEvent&&this._modelEvent.unsubscribe(e)},togglePlayPauseUIODT:function(e){"replay"===e.odt&&(this._playPauseButton.classList.contains("playIcon")||this._playPauseButton.classList.contains("pauseIcon"))&&(this._userInteraction=!0,this._publishEvent("togglePlayPause"))},_activateCustoImmersiveUIArrow:function(e){this._toggleActivationCustoImmersiveUIArrow(!0,{ibNextArrow:e})},_deactivateCustoImmersiveUIArrow:function(){this._toggleActivationCustoImmersiveUIArrow(!1)},_toggleActivationCustoImmersiveUIArrow:function(e,t){for(var n=document.getElementsByClassName("VCXScenarioUI_loading"),i=0;i<n.length;++i){var o=n[i],r=o.closest(".forPlayGuidedTourCmd");if(r)if(e){var a=t.ibNextArrow;if(a&&r.hasClassName("VCXRightArrow")||!a&&r.hasClassName("VCXLeftArrow")){o.removeClassName("hide"),r.addClassName("inTransition");break}}else o.addClassName("hide"),r.removeClassName("inTransition")}},_togglePlayPauseUI:function(e){e&&e.currentTarget===this._playPauseButton&&e.stopPropagation(),(this._playPauseButton.classList.contains("playIcon")||this._playPauseButton.classList.contains("pauseIcon"))&&(this._userInteraction=!0,this._publishEvent("togglePlayPause"))},_setPauseWaitingAnimation:function(e){!this._waitingContainer&&this._playPauseButton||(e?(this._waitingContainer&&this._waitingContainer.inject(this._playPauseButton),this._playPauseButton.classList.replace("pauseIcon","pauseInWait")):(this._waitingContainer&&this._waitingContainer.remove(),this._playPauseButton.classList.remove("pauseInWait"),this._playPauseButton.classList.add("playIcon")))},_setImmersiveUICustomization:function(e){var t=document.getElementsByClassName("VCXScenariosUIArrow"),n=0;for(n=0;n<t.length;++n){var i=t[n];e?i.addClassName("forPlayGuidedTourCmd"):i.removeClassName("forPlayGuidedTourCmd")}var o=document.getElementsByClassName("VCXScenariosUIDots_container");for(n=0;n<o.length;++n){var r=o[n];e?r.addClassName("forPlayGuidedTourCmd"):r.removeClassName("forPlayGuidedTourCmd")}},_publishEvent:function(e){this._modelEvent.publish({event:e,data:{eventChannel:e}})}})}),define("DS/VCXWebProducts/VCXCloseExperienceCmd",["DS/ApplicationFrame/Command"],function(e){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0})},beginExecute:function(){},execute:function(){var e=this;this.doClose().then(function(){e.end()}).catch(function(t){console.log(new Error(t)),e.end()})},doClose:function(){var e=this,t=this.getFrameWindow()._experienceBase;t.getManager("VCXGUIManager").getGettingStartedUI();return t.getManager("VCXGUIManager").displaySceneNeedsUpdateModal("close").then(()=>{console.log("scene update: "+t.getManager("VCXGUIManager")._sceneNeedsUpdate);var n=t.getManager("VCXContextManager"),i=n.getPlayerMode(),o=n.getCat3DXIntegration();return i||!o?t&&t.webApplication?t.webApplication.requestNewExperienceBaseAsync().then(function(){e.end()}):void 0:t.getManager("VCXPlatformServicesManager").DisplaySaveBeforeCloseModal()})},endExecute:function(){}})}),define("DS/VCXWebProducts/VCXRedoCmd",["UWA/Core","UWA/Element","DS/ApplicationFrame/Command"],function(e,t,n){"use strict";return n.extend({init:function(t){this._parent(t,{});var n=this;e.Element.addEvent.call(document,"keydown",function(t){"ctrl+y"===e.Event.whichKey(t)&&n.begin()})},beginExecute:function(){},execute:function(){var e=this.getFrameWindow()._experienceBase,t=function(){e.getManager("VCXCommandManager").Redo()};e.getManager("VCXExperience")._bPreviewMode&&e.getManager("VCXPulseManager")?e.getManager("VCXPulseManager").StopPulse(t):t()},endExecute:function(){}})}),define("DS/VCXWebProducts/VCXUndoCmd",["UWA/Core","UWA/Element","DS/ApplicationFrame/Command"],function(e,t,n){"use strict";return n.extend({init:function(t){this._parent(t,{});var n=this;e.Element.addEvent.call(document,"keydown",function(t){"ctrl+z"===e.Event.whichKey(t)&&n.begin()})},beginExecute:function(){},execute:function(){var e=this.getFrameWindow()._experienceBase,t=function(){e.getManager("VCXCommandManager").Undo()};e.getManager("VCXExperience")._bPreviewMode&&e.getManager("VCXPulseManager")?e.getManager("VCXPulseManager").StopPulse(t):t()},endExecute:function(){}})}),define("DS/VCXWebProducts/VCXShowSelectionCmd",["DS/ApplicationFrame/Command","DS/VCXWebKernelCommands/VCXCmdChangeVisibility","DS/VCXWebVisibility/VCXIVisibility"],function(e,t,n){"use strict";return e.extend({init:function(e){this._parent(e,{})},beginExecute:function(){},execute:function(){for(var e=this.getFrameWindow()._experienceBase,i=e.getManager("VCXSelectionManager").GetComponentsFromCurrentSelection(),o=[],r=0;r<i.length;++r){var a=i[r].QueryInterface("VCXIVisibility");a&&(a.GetVisibility()!==n.EVisState.Hidden||o.push(i[r]))}if(0!==o.length){var s=new t(e.getManager("VCXScenarioManager"),e.ComponentsMap,e.getManager("VCXCommandManager"));s.ChangeVisibility(o,n.EVisState.Visible),e.getManager("VCXCommandManager").Push(s)}},endExecute:function(){}})}),define("DS/VCXWebProducts/VCXSaveToJSONCmd",["DS/ApplicationFrame/Command","DS/VCXWebComposer/VCXExperienceSaver","DS/VCXWebKernelCommands/VCXCmdChangeNeutralProperties"],function(e,t,n){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0})},beginExecute:function(){},execute:function(){var e=this,i=this.getFrameWindow()._experienceBase;!function(o){var r=i.getManager("VCXDocManager").actorDocManager;if(r){var a=r.QueryInterface("VCXIModifiable"),s=new n(i.getManager("VCXScenarioManager"));s.CaptureNeutralProperties(a),s.Do()}(new t).Save(i),e.end()}()},endExecute:function(){}})}),define("DS/VCXWebProducts/VCXInvertSelectionCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/VCXWebKernel/VCXCmdChangeSelection","DS/VCXWebVisibility/VCXIVisibility"],function(e,t,n,i){"use strict";return t.extend({init:function(t){this._parent(t,{});var n=this;e.Element.addEvent.call(document,"keydown",function(t){"ctrl+i"===e.Event.whichKey(t)&&n.begin()})},beginExecute:function(){var e=this.getFrameWindow();this._experienceBase=e._experienceBase},execute:function(){for(var e=this._experienceBase.getManager("VCXSelectionManager"),t=[],i=this._experienceBase.ComponentsMap.GetComponentsFromFilterMethod(this._isComponentVisibleInTheScene),o=(t=[],0);o<i.length;++o){var r=i[o];e.isIn(r)||t.push(r)}var a=new n(e);a.SetComponentsSelection(t),this._experienceBase.getManager("VCXCommandManager").Do(a)},endExecute:function(){this._experienceBase=null},_isComponentVisibleInTheScene:function(e){var t=e.QueryInterface("VCXIVisibility");if(!t||t.GetVisibility()!==i.EVisState.Visible)return!1;if(e.IsDressup){return!e.IsKindOf(["VCXBOM_Spec","CXPCameraActor_Spec","VCXCompass_Spec","VCXDigger_Spec","VCXComponentGround","VCXViewport_Spec"])}return!(!e.IsKindOf("VCXComponentOccurrenceExt")||!e.IsRenderable())}})}),define("DS/VCXWebProducts/VCXTransformFreeDragCmd",["DS/ApplicationFrame/Command","DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/VCXWebModifiablesServices/VCXModifiablesAccess","DS/VCXWebModifiablesServices/VCXModifiablesServices","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS"],function(e,t,n,i,o,r,a){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),this._tokens=null},beginExecute:function(){this._experienceBase=this.getFrameWindow()._experienceBase;this._experienceBase.getManager("VCXContextManager");this._viewer=this._experienceBase.getManager("VCXContextManager").getMainViewer(),this._tokens||(this._tokens={}),this._tokens.pointerDownToken=r.addEvent(this._viewer.canvas,"onPrimaryPointerDownUnique",this._onPointerDownCB()),this._tokens.pointerMovePlainToken=t.subscribe({event:"/VISU/onPrimaryPointerMove"},this._onPointerMoveCB())},_onPointerDownCB:function(){var e=this,n=this._experienceBase.getManager("VCXGUIManager");return function(s){if(!e._tokens.pointerUpToken){var c,u=e._viewer.getMousePosition(s.from[0].getCurrentPosition(e._viewer.canvas)),l=e._viewer.pick(u,"mesh",!0);l&&l.path&&l.path.length>0&&(c=l.path[0].clone());var d=c&&i.GetModifiableFromPathElement(c,e._experienceBase);if(d){var g=e._experienceBase.getManager("VCXSelectionManager").GetComponentsFromCurrentSelection("VCXComponentOccurrenceExt");if(!d.GetObject().IsKindOf("VCXComponentOccurrenceExt"))return;var h=[];if(d.GetObject().IsKindOf("VCXComponentOccurrenceExt"))h=g.map(function(e){return e.QueryInterface("VCXIModifiable")}),0!==(h=o.filterChildrenOfModsFromArray(h)).length&&e.checkPickedComponentHasAncestorInArray(d,h)||d.GetObject().IsKindOf("VCXComponentOccurrenceExt")&&(h=[d]);e._viewer.currentViewpoint.setControlActive({viewpoint:!1}),e._viewer.setPrePicking({activated:!1});var C=l.position.clone(),m=(new a.Vector3).subVectors(e._viewer.currentViewpoint.target,e._viewer.currentViewpoint.position).normalize(),p=new a.Plane(m,0).setFromNormalAndCoplanarPoint(m,C);e._initInfos={data:s,pickInfo:l,modifiablesArray:h,plane3D:p,mousePos:u},e._isDragging=!1,e._lastPosition=C,n.SetCursor("grabbing"),e._experienceBase.getManager("VCXCommandManager").StartTransaction(),e._tokens.pointerMoveDragToken||(e._tokens.pointerMoveDragToken=t.subscribe({event:"/VISU/onPrimaryPointerMove"},e._translate())),e._tokens.pointerUpToken||(e._tokens.pointerUpToken=r.addEvent(e._viewer.canvas,"onPrimaryPointerUpUnique",e._disposeEvents()))}}}},_onPointerMoveCB:function(){var e=this,t=this._experienceBase.getManager("VCXGUIManager");return function(n){if(!e._initInfos){var o,r=e._viewer.getMousePosition(n.from[0].getCurrentPosition(e._viewer.canvas)),a=e._viewer.pick(r,"mesh",!0);a&&a.path&&a.path.length>0&&(o=a.path[0].clone());var s=o&&i.GetModifiableFromPathElement(o,e._experienceBase);s&&s.GetObject().IsKindOf("VCXComponentOccurrenceExt")?t.SetCursor("grab"):t.SetCursor("default")}}},_translate:function(){var e=this;return function(t){if(e._initInfos&&e._lastPosition){var n=e._viewer.getMousePosition(t.from[0].getCurrentPosition(e._viewer.canvas));if(!e._isDragging){var i=e._initInfos.mousePos;if(Math.max(Math.abs(n.xPix-i.xPix),Math.abs(n.yPix-i.yPix))<3)return;e._isDragging=!0}var o=e._viewer.pick(n,"mesh",!1).ray.intersectPlane(e._initInfos.plane3D),r=e._initInfos.modifiablesArray;e._translateFromOriginToTarget(e._lastPosition,o,r),e._lastPosition=o.clone()}}},_translateFromOriginToTarget:function(e,t,i){for(var r=(new a.Vector3).subVectors(t,e),s=new n(this._experienceBase.getManager("VCXScenarioManager"),this._experienceBase.getManager("VCXCommandManager")),c=0;c<i.length;++c){var u=i[c];if(u){var l=o.buildPropertyLocationWithTranslationInWCS(u,r);s.ChangeProperty(i[c],l)}}this._experienceBase.getManager("VCXCommandManager").Push(s)},_disposeEvents:function(){var e=this,n=this._experienceBase.getManager("VCXGUIManager");return function(i){if(t.unsubscribe(e._tokens.pointerMoveDragToken),e._tokens.pointerMoveDragToken=null,r.removeEventFromToken(e._tokens.pointerUpToken),e._tokens.pointerUpToken=null,e._experienceBase.getManager("VCXCommandManager").EndTransaction("Free Drag"),n.SetCursor("grab"),e._viewer.currentViewpoint.setControlActive({viewpoint:!0}),e._viewer.setPrePicking({activated:!0}),"record"===e._experienceBase.odt&&e._isDragging){var o={commandName:"VCXTransformFreeDragCmd",componentsIDs:e._initInfos.modifiablesArray.map(function(e){return e.GetObject().GetID()}),origin:e._initInfos.pickInfo.position.createJSON(),target:e._lastPosition.createJSON()};e._experienceBase.getManager("VCXODTManager").LogAPI("VCXExecuteFreeDrag",o)}e._initInfos=null,e._translateCB=null,e._disposeCB=null,e._isDragging=!1}},endExecute:function(){this._tokens&&(this._tokens.pointerDownToken&&r.removeEventFromToken(this._tokens.pointerDownToken),this._tokens.pointerMovePlainToken&&t.unsubscribe(this._tokens.pointerMovePlainToken)),this._tokens={},this._lastPosition=null,this._viewer=null,this._experienceBase=null},checkPickedComponentHasAncestorInArray:function(e,t){if(t.includes(e))return!0;for(var n=e.QueryInterface("VCXIModelNavigable"),i=0;i<t.length;++i){if(t[i].QueryInterface("VCXIModelNavigable").isAncestorOf(n))return!0}return!1},executeFreeDragODT:function(e){var t=e.origin,n=e.target,i=this._experienceBase.ComponentsMap.GetComponentsFromIDs(e.componentsIDs).map(function(e){return e.QueryInterface("VCXIModifiable")});this._translateFromOriginToTarget(t,n,i)}})}),define("DS/VCXWebProducts/VCXTransformCmd",["DS/ApplicationFrame/Command","DS/ApplicationFrame/CommandsManager","DS/Visualization/ThreeJS_DS","DS/Robot/Robot","DS/CoreEvents/Events"],function(e,t,n,i,o){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0});var t=this;this._bChangePositionAtCmdBeginning=!0,this._tokenSelectionAdd=null,this._tokenSelectionRemove=null,this._tokenSelectionEmpty=null,o.subscribe({event:"VCX_DONT_CHNG_ROBOT_POS_AT_TRANSFORM_BEGIN"},function(){t._bChangePositionAtCmdBeginning=!1})},beginExecute:function(){this._experienceBase=this.getFrameWindow()._experienceBase,this._viewer=this._experienceBase.getManager("VCXContextManager").getMainViewer();var e=this;this._tokenSelectionAdd=o.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_ADD"},function(){e.isRunning()&&e._displayPivot()}),this._tokenSelectionRemove=o.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_REMOVE"},function(){e.isRunning()&&e._displayPivot()}),this._tokenSelectionEmpty=o.subscribe({event:"VCX_SELECTED_ACTORS_EMPTY"},function(){e.isRunning()&&e._displayPivot()}),this._bChangePositionAtCmdBeginning?this._displayPivot():this.changeRobotPosAtCmdBeginning(!0)},endExecute:function(){if(this._experienceBase){null!==this._tokenSelectionAdd&&(o.unsubscribe(this._tokenSelectionAdd),this._tokenSelectionAdd=null),null!==this._tokenSelectionRemove&&(o.unsubscribe(this._tokenSelectionRemove),this._tokenSelectionRemove=null),null!==this._tokenSelectionEmpty&&(o.unsubscribe(this._tokenSelectionEmpty),this._tokenSelectionEmpty=null);var e=this._viewer.getRobot();if(!(e instanceof i))return;e.target=null,e.setConnectionState(!1),e.CallBackEventHandlerViewPoint();var n=this._experienceBase.getManager("VCXContextManager").getContext();t.getCommand("VCXMoveRobotOnBBoxCenterCmd",n).disable(),this._experienceBase.getManager("VCXRobotAdapter").displayRobot(!1,!0),this._viewer.render()}this._viewer=null,this._experienceBase=null},cancelExecute:function(){this.changeRobotPosAtCmdBeginning(!0)},_displayPivot:function(){var e=this._experienceBase.getManager("VCXSelectionManager"),n=this._viewer.getRobot();if(!(n instanceof i))return console.error("No robot found.."),void this.end();for(var o=e.GetComponentsFromSelection("CSO"),r=[],a=0;a<o.length;++a)if(o[a].IsKindOf("VCXWebComponentOccurrence")&&!o[a].IsDressup){var s=o[a].QueryInterface("VCXIModifiable");s&&r.push(s)}var c=this._experienceBase.getManager("VCXContextManager").getContext(),u=t.getCommand("VCXMoveRobotOnBBoxCenterCmd",c);if(Array.isArray(r)&&r.length>0){n.setConnectionState(!0),n.fixedSizeNode3D.setRatio(7),n.target=r[0].QueryInterface("W3AISGNodeHolder").getPathElement();var l=this._getNewRobotFrame(r);l&&(n.setRobotMatrix(l),n.setVisibility(!0),u.isEnabled()||u.enable())}else u.isEnabled()&&u.disable(),n.setVisibility(!1),n.target=null,n.setConnectionState(!1),n.CallBackEventHandlerViewPoint();this._viewer.render()},_getNewRobotFrame:function(e){if(0!==e.length){if(1===e.length&&"VCX_Root"!==e[0].GetObject()._ID){var t=e[0].GetProperty("Actor.Position").GetPropertyValue().GetPivot().GetValue(),i=e[0].QueryInterface("W3AISGNodeHolder").getPathElement().getParentPath().getWorldMatrix(this._viewer);return a=(new n.Matrix4).copy(i).multiply(t)}var o,r=null;for(o=0;o<e.length;++o)if("VCX_Root"!==e[o].GetObject()._ID){t=e[o].GetProperty("Actor.Position").GetPropertyValue().GetPivot().GetValue(),i=e[o].QueryInterface("W3AISGNodeHolder").getPathElement().getParentPath().getWorldMatrix(this._viewer);var a=(new n.Matrix4).copy(i).multiply(t);if(null!==r){if(!this._equalMatrices(a,r))break}else r=a.clone()}return o===e.length?r:(new n.Matrix4).setPosition(this._getBBoxInWCS(e).center())}console.error("No modifiable specified in the array parameter")},changeRobotPosAtCmdBeginning:function(e){"boolean"==typeof e?this._bChangePositionAtCmdBeginning=e:console.error("A boolean is needed as parameter")},_equalMatrices:function(e,t){if(e instanceof n.Matrix4&&t instanceof n.Matrix4){var i;for(i=0;i<16&&!(Math.abs(e.elements[i]-t.elements[i])>.001);++i);return 16===i}console.error("2 THREE.Matrix4 objects are needed as parameters")},_getBBoxInWCS:function(e){for(var t=new n.Box3,i=0;i<e.length;i++){var o=e[i].QueryInterface("W3AISGNodeHolder"),r=o.getPathElement().getBoundingBox(null,this._viewer);r.applyMatrix4(o.getWorldMatrix(this._viewer)),t.union(r)}return t}})}),define("DS/VCXWebProducts/VCXShowAllGeometriesCmd",["DS/ApplicationFrame/Command","DS/VCXWebKernelCommands/VCXCmdChangeVisibility","DS/VCXWebVisibility/VCXIVisibility"],function(e,t,n){"use strict";return e.extend({init:function(e){this._parent(e,{})},beginExecute:function(){},execute:function(){for(var e=this.getFrameWindow()._experienceBase,i=e.ComponentsMap.GetComponentFromType("VCXComponentOccurrenceExt"),o=[],r=0;r<i.length;++r){var a=i[r];if(!a.IsKindOf("VCXComponentCompositePmi")){var s=a.QueryInterface("VCXIVisibility");s&&(s.GetVisibility()!==n.EVisState.Hidden||o.push(i[r]))}}if(0!==o.length){var c=new t(e.getManager("VCXScenarioManager"),e.ComponentsMap,e.getManager("VCXCommandManager"));c.ChangeVisibility(o,n.EVisState.Visible),e.getManager("VCXCommandManager").Push(c)}},endExecute:function(){}})}),define("DS/VCXWebProducts/VCXMoveRobotOnBBoxCenterCmd",["DS/ApplicationFrame/Command","DS/Visualization/ThreeJS_DS","DS/VCXWebModifiablesServices/VCXModifiablesServices","DS/Robot/Robot"],function(e,t,n,i){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0}),this._vcxExperience=null,this.disable()},execute:function(){this._vcxExperience=this.getFrameWindow()._experienceBase,this._displayBBoxCenter()},pauseExecute:function(){},resumeExecute:function(){this.isRunning()||this.end()},endExecute:function(){this._vcxExperience=null},_displayBBoxCenter:function(){var e=this._vcxExperience.getManager("VCXContextManager").getMainViewer(),o=this._vcxExperience.getManager("VCXSelectionManager").GetComponentsFromSelection("CSO");if(o.filter(function(e){return e.IsKindOf("VCXWebComponentOccurrence")&&!e.IsDressup}),o.length>0){var r=e.getRobot();if(!(r instanceof i))return console.error("No robot found.."),void this.end();r.connect(),r.fixedSizeNode3D.setRatio(7);var a=n.getBBoxInWorldFromComponents(o).center(),s=(new t.Matrix4).setPosition(a);r.setRobotMatrix(s),e.render()}this.end()}})}),define("DS/VCXWebProducts/VCXPlayGuidedTourModel",["UWA/Class","DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCmdGoToScenarioWithInterpolation","DS/VCXWebKernelCommands/VCXCmdPlayScenario"],function(e,t,n,i){"use strict";return e.extend({init:function(){this._pauseRequested=!1,this.setGuidedTourOccurring(!1),this._listAllScenario=null,this._nbSecsForWaiting=5;var e=this;this.tokenSubscribeEnd=t.subscribe({event:"VCX_PLAY_GUIDED_TOUR_END"},function(t){e._listAllScenario=null,e._pauseRequested=!1,e.setGuidedTourOccurring(!1)})},destroy:function(){this._listAllScenario=null,this._pauseRequested=null,this._guidedTourOccurring=null,t.unsubscribe(this.tokenSubscribeEnd)},setSecondsForWaiting:function(e){this._nbSecsForWaiting=e},setPauseRequested:function(e){this._pauseRequested=!0;for(var t=e.getManager("VCXScenarioManager"),n=Object.keys(t._scenariosToPlay).length-1;n>=0;--n){var i=t._scenariosToPlay[n];t.StopPlayingScenario(i)}},getPauseRequested:function(){return this._pauseRequested},setGuidedTourOccurring:function(e){this._guidedTourOccurring=e},getGuidedTourOccurring:function(){return this._guidedTourOccurring},checkScenarioPresence:function(e){var t=e.getManager("VCXSequenceManager");if(!t)return!1;for(var n=t.GetListSequencesFromType(0),i=0;i<n.length;i++){var o=n[i];o.QueryInterface("VCXIModifiable");if(o.GetListScenariosId().length>0)return!0}return!1},getListAllScenarios:function(e){if(!this._listAllScenario){var t=e.getManager("VCXSequenceManager"),n=e.getManager("VCXScenarioManager"),i=t.GetListSequencesFromType(0);n.GetCurrentScenario();this._listAllScenario=[];for(var o=0;o<i.length;o++)for(var r=i[o],a=(r.QueryInterface("VCXIModifiable"),r.GetListScenariosId()),s=0;s<a.length;s++){var c=a[s],u=n.GetScenarios()[c];u&&this._listAllScenario.push(u)}}return this._listAllScenario},getIdxNextScenToPlay:function(e){var t=e.getManager("VCXScenarioManager").GetCurrentScenario();if(""===t)return 0;for(var n=e.getManager("VCXSequenceManager").GetListSequencesFromType(0),i=0,o=0;o<n.length;++o){var r=n[o],a=r.GetListScenariosId().length,s=r.GetIndexOfScenario(t);if(-1!==s){if(o===n.length-1&&s===a-1)return 0;i+=s+1;break}i+=a}return i},runGuidedTour:function(e){var t=this.getIdxNextScenToPlay(e),o=e.getManager("VCXScenarioManager"),r=(e.getManager("VCXSequenceManager"),e.getManager("VCXCommandManager")),a=this.getListAllScenarios(e),s=this,c=function(t){if(s._publishGuidedTourEvent("goToScenario_End",{currentScenarioIdx:0===t?a.length-1:t-1,nextScenarioIdx:t}),t>=a.length||s._pauseRequested)s._publishGuidedTourEvent("end");else{var n=new i(o,e.ComponentsMap,r);n.PlayScenario(a[t]),n.SetCallback(u,t),r.Do(n)}},u=function(t){if(s._pauseRequested)s._publishGuidedTourEvent("end");else{var n=t+1;n>=a.length&&(n=0),s.idxOfScenToPlayFirst=n;var c=e.Factory.BuildComponent("VCXScenario");c.SetPersistency(2),c.SetApplyNeutralAtGoToScenario(!1),c.SetMaxFrame(o.GetFPS()*s._nbSecsForWaiting),c._bWait=!0;var u=new i(o,e.ComponentsMap,r);u.PlayScenario(c),u.SetCallback(l,n),r.Do(u)}},l=function(t){if(s._pauseRequested)s._publishGuidedTourEvent("end");else{s._publishGuidedTourEvent("goToScenario",{currentScenarioIdx:0===t?a.length-1:t-1,nextScenarioIdx:t});var i=c,u=t;if(t>=a.length&&(i=s._publishGuidedTourEvent.bind(s),u="end"),s.customGoToScenario)s.customGoToScenario(a[t],i,u);else{var l=new n(o,e.ComponentsMap,r);l.BuildTransitionTo(a[t]),l.SetCallback(i,u),r.Do(l)}}};this._publishGuidedTourEvent("begin"),this.setGuidedTourOccurring(!0),l(t)},_publishGuidedTourEvent:function(e,n){t.publish({event:"VCX_PLAY_GUIDED_TOUR_"+e.toUpperCase(),data:n})}})}),define("DS/VCXWebProducts/VCXRestoreActiveViewVisibilityCmd",["DS/ApplicationFrame/Command"],function(e){"use strict";return e.extend({init:function(e){this._parent(e,{})},beginExecute:function(){},execute:function(){var e=this.getFrameWindow()._experienceBase,t=e.getManager("VCXScenarioManager").GetCurrentScenario(),n=e.ComponentsMap.GetComponentFromID(t);e.getManager("VCXScenarioManager").ApplyVisibility(n)},endExecute:function(){}})}),define("DS/VCXWebProducts/VCXHideDressupsCmd",["DS/VCXWebProducts/VCXHideSelectionCmd"],function(e){"use strict";return e.extend({init:function(e){this._parent(e,{})},execute:function(){this._hideAllDressups()},_hideAllDressups:function(){var e=this.getFrameWindow();this._experienceBase=e._experienceBase;var t=this._experienceBase.ComponentsMap.GetComponentFromType("VCXDressup_Spec");this._hideElementsFromArray(t)}})}),define("DS/VCXWebProducts/VCXPlayGuidedTourCmd",["DS/ApplicationFrame/Command","DS/CoreEvents/Events","DS/VCXWebProducts/VCXPlayGuidedTourModel","DS/VCXWebProducts/VCXPlayGuidedTourUI"],function(e,t,n,i){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),this.tokenUISubs=null,this.playGuidedTourUI=null,this.playGuidedTourModel=new n},destroy:function(){this.isRunning()&&this.end(),this.playGuidedTourModel&&(this.playGuidedTourModel.destroy(),this.playGuidedTourModel=null),this.playGuidedTourUI&&(this.playGuidedTourUI.destroy(),this.playGuidedTourUI=null),this._parent()},beginExecute:function(){var e=this.getFrameWindow();if(this._experienceBase=e._experienceBase,!this.playGuidedTourModel.checkScenarioPresence(this._experienceBase))return console.log("No scenario available to create a tour... Ending command PlayGuidedTour."),this._experienceBase=null,void this.end();this.playGuidedTourUI=new i(this.getFrameWindow()),this.playGuidedTourUI&&(this.playGuidedTourUI.setplayGuidedTourUI(e),this.tokenUISubs=[this.playGuidedTourUI.subscribe("togglePlayPause",this._togglePlayPause.bind(this)),this.playGuidedTourUI.subscribe("terminate",this.end.bind(this))])},execute:function(){},endExecute:function(){if(this.playGuidedTourUI&&(this.playGuidedTourUI.terminateUI(),this.tokenUISubs))for(var e=0;e<this.tokenUISubs.length;++e)this.playGuidedTourUI.unsubscribe(this.tokenUISubs[e]);this.playGuidedTourModel.getGuidedTourOccurring()&&this.playGuidedTourModel.setPauseRequested(this._experienceBase),this.playGuidedTourModel._publishGuidedTourEvent("end"),this.playGuidedTourUI=null,this._experienceBase=null},_togglePlayPause:function(){this.playGuidedTourModel.getGuidedTourOccurring()?this.pause():this.play()},pause:function(){this.playGuidedTourUI.displayUI(),this.playGuidedTourModel.setPauseRequested(this._experienceBase)},play:function(){this.playGuidedTourUI.hideUI(),this.playGuidedTourModel.runGuidedTour(this._experienceBase)},executeGuidedTourODT:function(){if("replay"===this._experienceBase.odt){var e=this;return[function(t,n){e.playGuidedTourUI.togglePlayPauseUIODT(e._experienceBase),setTimeout(function(){t(!0)},2e3)},function(t,n){e.playGuidedTourUI.togglePlayPauseUIODT(e._experienceBase),t(!0)},function(e,t){setTimeout(function(){e(!0)},6e3)},function(t,n){e.playGuidedTourUI.togglePlayPauseUIODT(e._experienceBase),setTimeout(function(){t(!0)},2e3)}]}}})});