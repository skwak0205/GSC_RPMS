define("DS/MPFShippingOfferPricesComponent/ShippingPricesTableLine",["UWA/Core","UWA/Class/View","DS/MPFUtils/MPFUtils","DS/UIKIT/Input/Text","DS/MPFOfferModel/ShippingOfferModel","DS/MPFServices/ObjectService","DS/MPFFiniteStateMachine/FiniteStateMachine","i18n!DS/MPFShippingOfferPricesComponent/assets/nls/ShippingOfferPricesComponent","css!DS/MPFShippingOfferPricesComponent/MPFShippingOfferPricesComponent"],function(e,t,i,n,r,s,a,o){"use strict";var l={EDITION:"edition",NO_EDITION:"no_edition",DISABLED:"disabled"},c=["weight",r.Areas.HOME,r.Areas.EUROPE,r.Areas.AFRICA,r.Areas.ASIA,r.Areas.MIDDLE_EAST,r.Areas.NORTH_AMERICA,r.Areas.SOUTH_AMERICA],h=t.extend({tagName:"tr",setup:function(e){s.requiredOfPrototype(e.shippingOffer,r,"options.shippingOffer must be a ShippingOfferModel"),this._parent(e),this.shippingOffer=e.shippingOffer,this.deliveryOffer=e.deliveryOffer,this.rowIndex=e.rowIndex,this.locale=e.locale||"fr-FR",this.priceElements=this._createPriceElements(),this.kgWeightElement=this._createKgWeightElement()},render:function(){this.cells=[this.kgWeightElement];var e=i.objectValues(this.priceElements);return e.sort(function(e,t){return e.columnIndex>t.columnIndex}),this.cells=this.cells.concat(e),this.container.setContent(this.cells),this},_createKgWeightElement:function(){var t=e.createElement("td",{class:"mpf-shipping-cell weight",text:this.shippingOffer.getWeightKG()});return t.columnIndex=c.indexOf("weight"),t},updateWeightElementUnitToKG:function(){this.kgWeightElement.setContent(this.shippingOffer.getWeightKG())},updateWeightElementUnitToLBS:function(){var e,t;e=2.20468*this.shippingOffer.getWeightKG(),t=Math.round(2*e)/2,this.kgWeightElement.setContent(t)},_createPriceElements:function(){for(var e=Object.keys(r.Areas),t={},i=0;i<e.length;i++){var n=r.Areas[e[i]],s=c.indexOf(n);s>-1&&(t[n]=this._createPriceElement(n,s))}return t},_createPriceElement:function(t,i){var s=this.shippingOffer.getPrice(t),a=r.Fields.PRICES[t],o=a.replace("_","-")+"-price",l=e.createElement("td",{class:"mpf-shipping-cell "+o,html:[e.createElement("span",{class:"fonticon fonticon-pencil"}),s<0?"":s.toFixed(2)]});if(l.columnIndex=i,l.addEvent("click",this._setEditionMode.bind(this,l)),l.stateMachine=this._createStateMachine(),l.editionInput=new n({events:{onKeyDown:this._onKeyDownHandler.bind(this,l)}}),l.editionInput.elements.input.onblur=this._onBlurHandler.bind(this,l,this.shippingOffer.getPrice.bind(this.shippingOffer,t),this.shippingOffer.setPrice.bind(this.shippingOffer,t)),l.editionInput.elements.input.onkeyup=this._onKeyUp.bind(this,l),this.deliveryOffer&&this.deliveryOffer.get("deliveryOfferDesactivatedArea")){var c=this.deliveryOffer.get("deliveryOfferDesactivatedArea");Array.isArray(c)&&c.indexOf(a)>-1&&this.disableElement(l)}return l},_saveCell:function(){var e=this,t=this.shippingOffer.changedAttributes();!1!==t&&this.shippingOffer.savePromise(t,{patch:"true"}).catch(function(){e.dispatchEvent("priceNotSaved")})},enableElement:function(e){e&&(e.removeClassName("disabled"),e.stateMachine.changeState(l.NO_EDITION))},disableElement:function(e){e&&(e.addClassName("disabled"),e.stateMachine.changeState(l.DISABLED))},_createStateMachine:function(){return new a({state:l.NO_EDITION,states:[l.EDITION,l.NO_EDITION,l.DISABLED],transitions:[{from:l.EDITION,to:l.NO_EDITION},{from:l.NO_EDITION,to:l.EDITION},{from:l.DISABLED,to:l.NO_EDITION},{from:l.NO_EDITION,to:l.DISABLED}]})},_setEditionMode:function(e){var t;e.stateMachine.getState()===l.NO_EDITION&&(e.stateMachine.changeState(l.EDITION),e.addClassName("edition"),t=e.getText(),this._isNumber(t)?e.editionInput.setValue(t):e.editionInput.setValue(""),e.setContent(e.editionInput),e.editionInput.setFocus())},_onBlurHandler:function(t,i,n){var r;t.stateMachine.getState()===l.EDITION&&(t.stateMachine.changeState(l.NO_EDITION),t.removeClassName("edition"),""!==(r=t.editionInput.getValue())&&this._isNumber(r)?(r=this._restrictInputValue(r),t.setContent([e.createElement("span",{class:"fonticon fonticon-pencil"}),r.toFixed(2)]),n.call(this.shippingOffer,r)):(n.call(this.shippingOffer,-42),t.setContent([e.createElement("span",{class:"fonticon fonticon-pencil"}),""])),this._saveCell())},_onKeyDownHandler:function(e,t){var i={};"Enter"===t.key||"ArrowDown"===t.key?(e.editionInput.setFocus(!1),i.rowIndex=this.rowIndex+1,i.columnIndex=e.columnIndex,this.dispatchEvent("changeCell",i)):"Tab"===t.key||"ArrowRight"===t.key?(t.preventDefault(),e.editionInput.setFocus(!1),e.columnIndex+1===c.length?(i.columnIndex=1,i.rowIndex=this.rowIndex+1):(i.rowIndex=this.rowIndex,i.columnIndex=e.columnIndex+1),this.dispatchEvent("changeCell",i)):"ArrowLeft"===t.key?(e.editionInput.setFocus(!1),e.columnIndex-1==0?(i.columnIndex=c.length-1,i.rowIndex=this.rowIndex-1):(i.rowIndex=this.rowIndex,i.columnIndex=e.columnIndex-1),i.direction="left",this.dispatchEvent("changeCell",i)):"ArrowUp"===t.key&&(e.editionInput.setFocus(!1),i.rowIndex=this.rowIndex-1,i.columnIndex=e.columnIndex,this.dispatchEvent("changeCell",i))},_onKeyUp:function(e){var t,i;t=e.editionInput.getValue(),i=e.editionInput.elements.input,this._isNumber(t)||i.hasClassName("error-validation")?this._isNumber(t)&&i.hasClassName("error-validation")&&i.removeClassName("error-validation"):i.addClassName("error-validation")},focusCell:function(e,t){var i;e>0&&e<c.length&&((i=this.cells[e]).stateMachine.getState()===l.NO_EDITION?this._setEditionMode(i):i.stateMachine.getState()===l.DISABLED&&("left"===t?e-1>0?this.focusCell(e-1,"left"):this.dispatchEvent("changeCell",{columnIndex:c.length-1,rowIndex:this.rowIndex-1}):e+1<c.length?this.focusCell(e+1):this.dispatchEvent("changeCell",{columnIndex:1,rowIndex:this.rowIndex+1})))},_isNumber:function(e){return!isNaN(e)},_restrictInputValue:function(e){var t;return(t=Number(e))<0?0:t>999.99?999.99:Number(t.toFixed(2))}});return h.ElementStates=Object.freeze(l),h.Columns=Object.freeze(c),h.ColumnOrder=Object.freeze(c),h}),define("DS/MPFShippingOfferPricesComponent/ShippingPricesTable",["UWA/Core","UWA/Class/View","DS/UIKIT/Alert","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Button","DS/MPFError/BadArgumentError","DS/MPFOfferModel/ShippingOfferModel","DS/MPFOfferModel/ShippingOfferCollection","DS/MPFServices/ObjectService","DS/MPFShippingOfferPricesComponent/ShippingPricesTableLine","i18n!DS/MPFShippingOfferPricesComponent/assets/nls/ShippingOfferPricesComponent","css!DS/MPFShippingOfferPricesComponent/MPFShippingOfferPricesComponent"],function(e,t,i,n,r,s,a,o,l,c,h){"use strict";var f=t.extend({className:"mpf-shipping-prices-table table",tagName:"table",setup:function(e){if(l.requiredOfPrototype(e.shippingOffers,o,"options.shippingOffers must be a ShippingOfferCollection"),0===e.shippingOffers.size())throw new s("Shipping offer collection must contain at least one model!");this._parent(e),this.shippingOffers=e.shippingOffers,this.deliveryOffer=e.deliveryOffer,this.locale=e.locale||"fr-FR",this.kgOptionButton=this._createKgOptionButton(),this.lbsOptionButton=this._createLbsOptionButton(),this.header=this._createHeader(),this.table=this._createTable()},render:function(){return this.container.setContent([this.header,this.table]),this},_createKgOptionButton:function(){var e=this;return new r({value:h.get("kg"),active:!0,events:{onClick:function(){this.isActive()||(this.setActive(),this.setFocus(!1),e.lbsOptionButton.setActive(!1),e._changeWeightUnit("kg"))}}})},_createLbsOptionButton:function(){var e=this;return new r({value:h.get("lbs"),events:{onClick:function(){this.isActive()||(this.setActive(),this.setFocus(!1),e.kgOptionButton.setActive(!1),e._changeWeightUnit("lbs"))}}})},_changeWeightUnit:function(e){"kg"===e&&this.tableLines.forEach(function(e){e.updateWeightElementUnitToKG()}),"lbs"===e&&this.tableLines.forEach(function(e){e.updateWeightElementUnitToLBS()})},_enableAreaPricing:function(e){var t=a.Fields.PRICES[e],i=this.deliveryOffer.get("deliveryOfferDesactivatedArea");i.splice(i.indexOf(t),1),this.deliveryOffer.savePromise(this.deliveryOffer.pick("deliveryOfferDesactivatedArea"),{patch:!0}).then(this._enableAreaCells.bind(this,e))},_disableAreaPricing:function(e){var t=a.Fields.PRICES[e],i=this.deliveryOffer.get("deliveryOfferDesactivatedArea");Array.isArray(i)&&-1===i.indexOf(t)?i.push(t):i=[t],this.deliveryOffer.set("deliveryOfferDesactivatedArea",i),this.deliveryOffer.savePromise(this.deliveryOffer.pick("deliveryOfferDesactivatedArea"),{patch:!0}).then(this._disableAreaCells.bind(this,e))},_enableAreaCells:function(e){this.tableLines.forEach(function(t){t.enableElement(t.priceElements[e])})},_disableAreaCells:function(e){this.tableLines.forEach(function(t){t.disableElement(t.priceElements[e])})},_createTable:function(){var t=this;return this.tableLines=this.shippingOffers.map(function(e,i){var n;return n=new c({locale:this.locale,shippingOffer:e,deliveryOffer:t.deliveryOffer,rowIndex:i}),this.listenTo(n,"changeCell",this._focusNewCell.bind(this)),this.listenTo(n,"priceNotSaved",this._displayErrorAlert.bind(this)),n.render()},this),e.createElement("tbody",{html:this.tableLines})},_focusNewCell:function(e){e.rowIndex<this.tableLines.length&&e.rowIndex>=0&&this.tableLines[e.rowIndex].focusCell(e.columnIndex,e.direction)},_displayErrorAlert:function(e){new i({visible:!0,messages:[{className:"error",message:h.get("errorOccured")}]}).inject(this.container.getParent(),"top")},_createHeader:function(){for(var t=[this._createWeightTile()],i=c.ColumnOrder,n=1;n<i.length;n++){var r=i[n],s=a.Fields.PRICES[r].replace("_","-");t.push(this._createTile(s,r))}return e.createElement("thead",{html:e.createElement("tr",{html:t})})},_createTile:function(t,i){var n=[this._createLabel(i)];return this.deliveryOffer&&n.push(this._createSwitchInput(i)),e.createElement("th",{class:t+" title",html:e.createElement("div",{class:"th-container",html:n})})},_createWeightTile:function(){return e.createElement("th",{class:"weight title",html:[h.get("upTo"),e.createElement("div",{html:[this.kgOptionButton,this.lbsOptionButton]})]})},_createSwitchInput:function(e){var t=this,i=a.Fields.PRICES[e],r=this.deliveryOffer.get("deliveryOfferDesactivatedArea"),s=-1===(r=Array.isArray(r)?r:[]).indexOf(i);return new n({type:"switch",value:"",checked:s,events:{onChange:function(){this.isChecked()?t._enableAreaPricing(e):t._disableAreaPricing(e)}}})},_createLabel:function(t){return e.createElement("div",{class:"mpf-toggle-label",html:[h.get(t),"<br>",e.createElement("span",{text:"("+this.shippingOffers.first().getCurrency()+")"})]})},destroy:function(){this.shippingOffers=null,this.locale=null,this.kgOptionButton=null,this.lbsOptionButton=null,this.header=null,this.table=null,this.tableLines=null,this._parent(),this.container=null}});return f.Areas=Object.freeze(a.Areas),f}),define("DS/MPFShippingOfferPricesComponent/ShippingPricesTabsComponent",["UWA/Core","UWA/Class/View","DS/MPFOfferModel/ShippingOfferCollection","DS/MPFServices/ObjectService","DS/MPFShippingOfferPricesComponent/ShippingPricesTable","i18n!DS/MPFShippingOfferPricesComponent/assets/nls/ShippingOfferPricesComponent","css!DS/MPFShippingOfferPricesComponent/MPFShippingOfferPricesComponent"],function(e,t,i,n,r,s){"use strict";return t.extend({className:"mpf-shipping-prices-tabs table-responsive",setup:function(e){n.requiredOfPrototype(e.standardShippingOffers,i,"options.standardShippingOffers must be a ShippingOfferCollection"),this._parent(e),this.locale=e.locale||"fr-FR",this.standardShippingOffers=e.standardShippingOffers,this.shippingMatrix=this._createShippingMatrix()},render:function(){return this.container.setContent(this.shippingMatrix.render()),this},_createShippingMatrix:function(){return new r({locale:this.locale,shippingOffers:this.standardShippingOffers})}})}),define("DS/MPFShippingOfferPricesComponent/ShippingPricesTableFactory",["UWA/Core","UWA/Class","UWA/Promise","DS/MPFConnector/MarketplaceConnector","DS/MPFServices/MarketplaceServices","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFShopModel/ShopFactory","DS/MPFShopModel/ShopServiceFactory","DS/MPFShippingOfferPricesComponent/ShippingPricesTable"],function(e,t,i,n,r,s,a,o,l){"use strict";var c=t.extend();return c.fromShopId=function(t,c){var h,f,p,d=(c=c||{}).service||r.MAKE;return n.fetchPromise({service:d}).then(function(e){var t=s.getInstance(e);return i.all([t.getFactory(s.Types.SHOP),t.getFactory(s.Types.SHOP_SERVICE),t.getFactory(s.Types.SHIPPING_OFFER)])}).then(function(e){var i=e[0].createModel(a.Types.SHOP,{id:t});return h=e[1],f=e[2],i.fetchPromise({expand:["offers"],uc2:!0})}).then(function(e){(p=h.createModel(o.Types.SHOP_SHOP_SERVICE)).setParentResourceId(e.get("id")),p.set(e.getService(d));var t=f.createCollection(null);return t.shopServiceId=p.get("id"),t.fetchPromise()}).then(function(t){for(var i,n=p.get("products"),r=0;r<n.length;r++){var s=n[r];"MP_DeliveryService"===s.type&&"Shipping"===s.deliveryServiceName&&(i=f.createModel(s.offers[0],{parentResourceId:p.get("id")}))}return c=e.extend({shippingOffers:t,deliveryOffer:i},c),new l(c)})},c});