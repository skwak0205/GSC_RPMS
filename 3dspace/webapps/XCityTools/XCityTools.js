define("DS/XCityTools/DebugLineChart",["UWA/Class"],function(e){"use strict";var t=function(e,t){this.isActive=!1,this.states=[],this.width=e,this.statDiv=document.getElementById("Stats"),this.debug=t,null!==this.statDiv&&(this.statDiv.style.cssText="display:none;width:"+e+"px;opacity:0.6;cursor:pointer",this.frameDrop=50,this.initStates())};return t.prototype={addCallback:function(e,t){this.callbacks[e]=t},initStates:function(){this.addStates("Fps",void 0,60,60,"#ffff00"),this.addStates("Render",void 0,60,60,"#ff0000"),this.addStates("DrawCalls",void 0,100,60,"#00ffff"),this.addStates("Textures",void 0,200,60,"#ff00ff"),this.addStates("DLRequested",void 0,100,60,"#00ff00"),this.addStates("DLInProcess",void 0,10,60,"#5555ff")},addStates:function(e,t,i,r,n){void 0===i&&(i=60),void 0===r&&(r=60),void 0===n&&(n="#0ff"),void 0===t&&(t=this.debug.callbacks[e]);var o={name:e,callback:t,min:Number.MAX_VALUE,max:-Number.MAX_VALUE,maxChart:i};for(o.text=document.createElement("div"),o.text.id="fpsText",o.text.style.cssText="color:"+n+";font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px;background-color:#000000;opacity:1.0",o.text.innerHTML="name",this.statDiv.appendChild(o.text),o.graph=document.createElement("div"),o.graph.id="fpsGraph",o.graph.style.cssText="position:relative;width:"+this.width+"px;height:"+r+"px;background-color:"+n,this.statDiv.appendChild(o.graph);o.graph.children.length<this.width;){var s=document.createElement("span");s.style.cssText="width:1px;height:"+r+"px;float:left;background-color:#113",o.graph.appendChild(s)}this.statDiv.style.display="block",o.height=r,o.color=n,o.numMax=0,o.numMin=0,this.states.push(o)},update:function(e){if(this.frameDrop)this.frameDrop--;else if(this.isActive)for(var t=0;t<this.states.length;t++){var i=this.states[t];if(i.callback){var r=i.callback(e);i.min=Math.min(i.min,r),i.max=Math.max(i.max,r);var n=i.graph.appendChild(i.graph.firstChild);if(r>i.maxChart){if(i.numMax++,30===i.numMax){i.numMax=15,i.maxChart=Math.ceil(i.max/i.maxChart)*i.maxChart;for(var o=0;o<i.graph.children.length-1;o++)i.graph.children[o].style.height=Math.max(1,i.height-i.graph.children[o].value*i.height/i.maxChart)+"px"}}else if(r<.2*i.maxChart){if(r>0&&(i.numMin++,120===i.numMin)){i.numMin=60,i.maxChart=Math.round(.5*i.maxChart);for(o=0;o<i.graph.children.length-1;o++)i.graph.children[o].style.height=Math.max(1,i.height-i.graph.children[o].value*i.height/i.maxChart)+"px"}}else i.numMin=0,i.numMax=0;i.text.textContent=i.name+": "+r+" /"+i.maxChart+" ("+i.min+"-"+i.max+")",n.value=r,n.style.height=Math.max(1,i.height-r*i.height/i.maxChart)+"px"}}}},t}),define("DS/XCityTools/Expression",["UWA/Class","DS/xCityBasicUtils/Utils"],function(e,t){"use strict";var i=e.extend({init:function(e){if(e instanceof i)this._set(e._get());else{var t=typeof e;if("number"===t||"string"===t)this.setAsLiteral(e);else{if(Array.isArray(e)){var r,n,o=[],s=e.length;for(r=0;r<s;r++)(n=e[r])instanceof i&&(n=n._get()),o.push(n);e=o}this._set(e),this.usedAttributes=null,this.usedVariables=null,this.stringForm=null}}},clone:function(){return new i(JSON.parse(JSON.stringify(this.toJSON())))},_set:function(e){this.expr=e},setAsPropertyName:function(e){t.is(this.expr)&&t.is(this.expr.PropertyName)?(Array.isArray(this.expr.PropertyName)?this.expr.PropertyName.push(e):this.expr.PropertyName=[this.expr.PropertyName,e],this._set(this.expr)):this._set({PropertyName:e})},propertyName:function(e){return"string"==typeof e?this.setAsPropertyName(e):console.error("property needs a string name"),this},setAsLiteral:function(e){this._set({Literal:e})},literal:function(e){return"object"==typeof e?console.error(" literal should be a basic type number or string"):this.setAsLiteral(e),this},setAsFunction:function(e,t){var i={Function:{}};i.Function[e]=t,this._set(i)},_get:function(){return this.expr},getOperator:function(){var e=null,i=this._getFunction(this.expr);if(t.is(i)){e={};var r=this._internalGetName(i),n=this._internalGetValue(i,r),o=Object.keys(n).length;e[r]=o}return e},_internalGetValue:function(e,i){if(t.is(e)){if(t.is(e.value)){var r=Object.keys(e.value);if(1===r.length){var n=e.value[r[0]];return 1===n.length&&(n=n[0]),n}return e.value}return e[i]}return null},_internalGetName:function(e){return t.is(e)?t.is(e.name)&&t.is(e.name.localPart)?e.name.localPart:Object.keys(e)[0]:null},FunctionList:["Function","ogc:Function","comparisonOps"],_getFunction:function(e){if(t.is(e)){var i,r,n,o=Object.keys(this.FunctionList),s=o.length,a=!1;for(i=0;i<s;i++)if(r=o[i],n=e[this.FunctionList[r]],t.is(n)){a=!0;break}if(a)return n}return null},getOperands:function(){var e=[],i=this._getFunction(this.expr);if(t.is(i))for(var r=this._internalGetName(i),n=this._internalGetValue(i,r),o=Object.keys(n),s=o.length,a=0;a<s;a++){var l=o[a];e.push(this._toJSON(n[l]))}else e.push(this._toJSON(this.expr));return e},_toJSON:function(e){var r=this._internalGetName(e),n=this._internalGetValue(e,r);if("expression"===r)return this._toJSON(n);var o=this._getFunction(e);if(t.is(o))return new i(e);var s={};return s[r]=n,s},toNumber:function(){return this.setAsFunction("toNumber",this._get()),this},add:function(e){var t=new i(e);return this.setAsFunction("Add",[this._get(),t._get()]),this},mul:function(e){var t=new i(e);return this.setAsFunction("Mul",[this._get(),t._get()]),this},sub:function(e){var t=new i(e);return this.setAsFunction("Sub",[this._get(),t._get()]),this},div:function(e){var t=new i(e);return this.setAsFunction("Div",[this._get(),t._get()]),this},toJSON:function(){return this.expr},colorGradient:function(e,r){if(t.is(e)&&t.is(e.keyframes)){var n,o=e.keyframes.length;for(n=0;n<o;n++){var s=e.keyframes[n],a=t.initColor(s.color);s.color="#"+a.getHexString()}}var l=new i(e),u=[this._get(),l._get()];return r&&u.push(r),this.setAsFunction("ColorGradient",u),this},floatGradient:function(e,r){if(t.is(e)&&t.is(e.keyframes)){var n,o=e.keyframes.length;for(n=0;n<o;n++){var s=e.keyframes[n],a=Number(s.float);s.float=a}}var l=new i(e),u=[this._get(),l._get()];return r&&u.push(r),this.setAsFunction("FloatGradient",u),this}});return i}),define("DS/XCityTools/LayerList",["UWA/Class","DS/xCityBasicUtils/Utils"],function(e,t){"use strict";return e.extend({init:function(){this._LayerList=null},setEmptyCallbacks:function(e,t){this.emptyCallback=e,this.notEmptyCallback=t},whenEmpty:function(){t.is(this.emptyCallback)&&this.emptyCallback()},whenNotEmpty:function(){t.is(this.notEmptyCallback)&&this.notEmptyCallback()},hideLayerInList:function(e){t.is(e)&&t.is(this._LayerList[e.id])&&!0===this._LayerList[e.id].visible&&(this._LayerList[e.id].visible=!1,this._LayerList.visibleLength<=0&&this.whenEmpty())},unhideLayerInList:function(e){t.is(e)&&t.is(this._LayerList[e.id])&&!1===this._LayerList[e.id].visible&&(this._LayerList[e.id].visible=!0,1===this._LayerList.visibleLength&&this.whenNotEmpty())},updateList:function(e,t,i,r){i?this.unhideLayerInList(e,t):this.hideLayerInList(e,t)},destroyLayerFromList:function(e){this.removeLayerFromList(e)},addlayerToList:function(e){var i;t.is(e)&&(t.is(this._LayerList)||(this._LayerList={},Object.defineProperties(this._LayerList,{visibleLength:{get(){let e=0;for(let t in this)this.hasOwnProperty(t)&&!0===this[t].visible&&e++;return e++}}}),!0),!t.is(this._LayerList[e.id])&&t.is(e._itemParent)&&(i=e._itemParent.get("visible"),this._LayerList[e.id]={visible:i},e._itemParent.addEvent("onChange:visible",this.updateList.bind(this,e)),e.addEvent("onDestroy",this.destroyLayerFromList.bind(this,e)),i&&1===this._LayerList.visibleLength&&this.whenNotEmpty()))},removeLayerFromList:function(e){t.is(this._LayerList)&&t.is(e)&&t.is(this._LayerList[e.id])&&(delete this._LayerList[e.id],this._LayerList.visibleLength<=0&&this.whenEmpty())}})}),define("DS/XCityTools/shapefile",[],function(){"use strict";function e(e){return new t(e instanceof Uint8Array?e:new Uint8Array(e))}function t(e){this._array=e}t.prototype.read=function(){var e=this._array;return this._array=null,Promise.resolve(e?{done:!1,value:e}:{done:!0,value:void 0})},t.prototype.cancel=function(){return this._array=null,Promise.resolve()};var i=function(t){return fetch(t).then(function(t){return t.body&&t.body.getReader?t.body.getReader():t.arrayBuffer().then(e)})},r=function(t){return new Promise(function(i,r){var n=new XMLHttpRequest;n.responseType="arraybuffer",n.onload=function(){i(e(n.response))},n.onerror=r,n.ontimeout=r,n.open("GET",t,!0),n.send()})};function n(e){return("function"==typeof fetch?i:r)(e)}function o(e){return"function"==typeof e.read?e:e.getReader()}var s=new Uint8Array(0);function a(e){return"function"==typeof e.slice?e:new l("function"==typeof e.read?e:e.getReader())}function l(e){this._source=e,this._array=s,this._index=0}l.prototype.read=function(){var e=this,t=e._array.subarray(e._index);return e._source.read().then(function(i){return e._array=s,e._index=0,i.done?t.length>0?{done:!1,value:t}:{done:!0,value:void 0}:{done:!1,value:function(e,t){if(!e.length)return t;if(!t.length)return e;var i=new Uint8Array(e.length+t.length);return i.set(e),i.set(t,e.length),i}(t,i.value)}})},l.prototype.slice=function(e){if((e|=0)<0)throw new Error("invalid length");var t=this,i=this._array.length-this._index;if(this._index+e<=this._array.length)return Promise.resolve(this._array.subarray(this._index,this._index+=e));var r=new Uint8Array(e);return r.set(this._array.subarray(this._index)),function n(){return t._source.read().then(function(o){return o.done?(t._array=s,t._index=0,i>0?r.subarray(0,i):null):i+o.value.length>=e?(t._array=o.value,t._index=e-i,r.set(o.value.subarray(0,e-i),i),r):(r.set(o.value,i),i+=o.value.length,n())})}()},l.prototype.cancel=function(){return this._source.cancel()};var u=function(e){return!(e=e.trim())||isNaN(e=+e)?null:e},c={B:u,C:function(e){return e.trim()||null},D:function(e){return new Date(+e.substring(0,4),e.substring(4,6)-1,+e.substring(6,8))},F:u,L:function(e){return!/^[nf]$/i.test(e)&&(!!/^[yt]$/i.test(e)||null)},M:u,N:u},d=function(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)},h=function(e,t){return(e=a(e)).slice(32).then(function(i){var r=d(i);return e.slice(r.getUint16(8,!0)-32).then(function(i){return new f(e,t,r,d(i))})})};function f(e,t,i,r){this._source=e,this._decode=t.decode.bind(t),this._recordLength=i.getUint16(10,!0),this._fields=[];for(var n=0;13!==r.getUint8(n);n+=32){for(var o=0;o<11&&0!==r.getUint8(n+o);++o);this._fields.push({name:this._decode(new Uint8Array(r.buffer,r.byteOffset+n,o)),type:String.fromCharCode(r.getUint8(n+11)),length:r.getUint8(n+16)})}}var p=f.prototype;p.read=function(){var e=this,t=1;return e._source.slice(e._recordLength).then(function(i){return i&&26!==i[0]?{done:!1,value:e._fields.reduce(function(r,n){return r[n.name]=c[n.type](e._decode(i.subarray(t,t+=n.length))),r},{})}:{done:!0,value:void 0}})},p.cancel=function(){return this._source.cancel()};var m=function(e){var t,i=40,r=e.getInt32(36,!0),n=new Array(r);for(t=0;t<r;++t,i+=16)n[t]=[e.getFloat64(i,!0),e.getFloat64(i+8,!0)];return{type:"MultiPoint",coordinates:n}},v=function(e){return{type:"Point",coordinates:[e.getFloat64(4,!0),e.getFloat64(12,!0)]}},g=function(e){var t,i=44,r=e.getInt32(36,!0),n=e.getInt32(40,!0),o=new Array(r),s=new Array(n),a=[],l=[];for(t=0;t<r;++t,i+=4)o[t]=e.getInt32(i,!0);for(t=0;t<n;++t,i+=16)s[t]=[e.getFloat64(i,!0),e.getFloat64(i+8,!0)];return o.forEach(function(e,t){var i=s.slice(e,o[t+1]);!function(e){if((t=e.length)<4)return!1;var t,i=0,r=e[t-1][1]*e[0][0]-e[t-1][0]*e[0][1];for(;++i<t;)r+=e[i-1][1]*e[i][0]-e[i-1][0]*e[i][1];return r>=0}(i)?l.push(i):a.push([i])}),l.forEach(function(e){a.some(function(t){if(function(e,t){var i,r=-1,n=t.length;for(;++r<n;)if(i=_(e,t[r]))return i>0;return!1}(t[0],e))return t.push(e),!0})||a.push([e])}),1===a.length?{type:"Polygon",coordinates:a[0]}:{type:"MultiPolygon",coordinates:a}};function _(e,t){for(var i=t[0],r=t[1],n=-1,o=0,s=e.length,a=s-1;o<s;a=o++){var l=e[o],u=l[0],c=l[1],d=e[a],h=d[0],f=d[1];if(x(l,d,t))return 0;c>r!=f>r&&i<(h-u)*(r-c)/(f-c)+u&&(n=-n)}return n}function x(e,t,i){var r=i[0]-e[0],n=i[1]-e[1];if(0===r&&0===n)return!0;var o=t[0]-e[0],s=t[1]-e[1];if(0===o&&0===s)return!1;var a=(r*o+n*s)/(o*o+s*s);return!(a<0||a>1)&&(0===a||1===a||a*o===r&&a*s===n)}var b=function(e){var t,i=44,r=e.getInt32(36,!0),n=e.getInt32(40,!0),o=new Array(r),s=new Array(n);for(t=0;t<r;++t,i+=4)o[t]=e.getInt32(i,!0);for(t=0;t<n;++t,i+=16)s[t]=[e.getFloat64(i,!0),e.getFloat64(i+8,!0)];return 1===r?{type:"LineString",coordinates:s}:{type:"MultiLineString",coordinates:o.map(function(e,t){return s.slice(e,o[t+1])})}},y=function(e,t){var i=new Uint8Array(e.length+t.length);return i.set(e,0),i.set(t,e.length),i},w={0:function(){return null},1:v,3:b,5:g,8:m,11:v,13:b,15:g,18:m,21:v,23:b,25:g,28:m},C=function(e){return(e=a(e)).slice(100).then(function(t){return new S(e,d(t))})};function S(e,t){var i=t.getInt32(32,!0);if(!(i in w))throw new Error("unsupported shape type: "+i);this._source=e,this._type=i,this._index=0,this._parse=w[i],this.bbox=[t.getFloat64(36,!0),t.getFloat64(44,!0),t.getFloat64(52,!0),t.getFloat64(60,!0)]}var P=S.prototype;function D(){}P.read=function(){var e=this;return++e._index,e._source.slice(12).then(function(t){if(null==t)return{done:!0,value:void 0};var i=d(t);function r(){var n=2*i.getInt32(4,!1)-4,o=i.getInt32(8,!0);return n<0||o&&o!==e._type?function n(){return e._source.slice(4).then(function(o){return null==o?{done:!0,value:void 0}:(i=d(t=y(t.slice(4),o))).getInt32(0,!1)!==e._index?n():r()})}():e._source.slice(n).then(function(i){return{done:!1,value:o?e._parse(d(y(t.slice(8),i))):null}})}return r()})},P.cancel=function(){return this._source.cancel()};var T=function(e,t,i){return Promise.all([C(e),t&&h(t,i)]).then(function(e){return new M(e[0],e[1])})};function M(e,t){this._shp=e,this._dbf=t,this.bbox=e.bbox}var A=M.prototype;function F(t,i,r){return"string"==typeof i?(/\.dbf$/.test(i)||(i+=".dbf"),i=n(i)):i instanceof ArrayBuffer||i instanceof Uint8Array?i=e(i):null!=i&&(i=o(i)),"string"==typeof t?(/\.shp$/.test(t)||(t+=".shp"),void 0===i&&(i=n(t.substring(0,t.length-4)+".dbf").catch(function(){})),t=n(t)):t=t instanceof ArrayBuffer||t instanceof Uint8Array?e(t):o(t),Promise.all([t,i]).then(function(e){var t=e[0],i=e[1],n="windows-1252";return r&&null!=r.encoding&&(n=r.encoding),T(t,i,i&&new TextDecoder(n))})}return A.read=function(){return Promise.all([this._dbf?this._dbf.read():{value:{}},this._shp.read()]).then(function(e){var t=e[0],i=e[1];return i.done?i:{done:!1,value:{type:"Feature",properties:t.value,geometry:i.value}}})},A.cancel=function(){return Promise.all([this._dbf&&this._dbf.cancel(),this._shp.cancel()]).then(D)},{open:F,openShp:function(t,i){return"string"==typeof t?(/\.shp$/.test(t)||(t+=".shp"),t=n(t)):t=t instanceof ArrayBuffer||t instanceof Uint8Array?e(t):o(t),Promise.resolve(t).then(C)},openDbf:function(t,i){var r="windows-1252";return i&&null!=i.encoding&&(r=i.encoding),r=new TextDecoder(r),"string"==typeof t?(/\.dbf$/.test(t)||(t+=".dbf"),t=n(t)):t=t instanceof ArrayBuffer||t instanceof Uint8Array?e(t):o(t),Promise.resolve(t).then(function(e){return h(e,r)})},read:function(e,t,i){return F(e,t,i).then(function(e){var t=[],i={type:"FeatureCollection",features:t,bbox:e.bbox};return e.read().then(function r(n){return n.done?i:(t.push(n.value),e.read().then(r))})})}}}),define("DS/XCityTools/AtlasBlock",["UWA/Class","DS/xCityBasicUtils/Utils"],function(e,t){"use strict";return e.extend({getIndex:function(){return null===this._fit?-1:this._fit.Index},getX:function(){return null==this._fit?-1:this._fit.x},getY:function(){return null===this._fit?-1:this._fit.y},getPacked:function(){return null!==this._fit},getWidth:function(){return this.texture.getWidth()},getHeight:function(){return this.texture.getHeight()},isCompatibleWith:function(e){return!0},compareTo:function(e){var t=Math.max(this.texture.getWidth(),this.texture.getHeight());return Math.max(e.texture.getWidth(),e.texture.getHeight())-t},init:function(e){this.rootNode=null,this.texture=null,this._fit=null,this.texture=e}})}),define("DS/XCityTools/RTree",["DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils"],function(e,t){"use strict";var i=function(e,t,i,r){this.urban=i,this.nb_points=0,this.m=e,this.M=t,this._root=null,this.animation_time=1,this.animation=0,this.oldNodesIndexVisible=[],this.distance=r,this.distanceFactor=1.5},r=function(t,i,r,n,o,s,a,l){this.infos=l,this.instance=a,this.mag=s,this.children=[],this.parent=null,this.urban=this.instance.urban;var u=(n+o)/2;this.boundingBox=new e.Box3(new e.Vector3(t,i,r),new e.Vector3(t+n,i+o,r+u)),this.radius=0,this._computeRadius(),this.center=new e.Vector2((this.boundingBox.max.x+this.boundingBox.min.x)/2,(this.boundingBox.max.y+this.boundingBox.min.y)/2),this.z=r,this.nHits=0};return r.prototype.insert=function(e){var t=new r(e.x,e.y,e.z,e.w,e.h,e.mag,this.instance,e.infos);t.nHits=1;var i,n=this._choosePath2(t),o=n[Math.max(0,n.length-2)];return o._addChild(t),o.children.length>this.instance.M&&(i=o._splitNode(t))._computeMagnitude(),o._computeMagnitude(),null!=(i=this._adjustTree(n,n.length-3,i))?i:this},r.prototype._choosePath=function(e){for(var t=[this],i=this;0!=i.children.length;){for(var n=i.children[0],o=r._computeEnlargement(n,e),s=1;s<i.children.length;s++){var a=r._computeEnlargement(i.children[s],e),l=i.children[s];(a<o||a==o&&r._computeBoundingBoxArea(l.boundingBox)<r._computeBoundingBoxArea(n.boundingBox))&&(n=l,o=a)}t.push(n),i=n}return t},r.prototype._choosePath2=function(e){for(var t=[this],i=this;0!=i.children.length;){for(var n=i.children[0],o=r._computeEnlargement(n,e),s=1;s<i.children.length;s++){var a=r._computeEnlargement(i.children[s],e),l=i.children[s];(a<o||a==o&&r._computeBoundingBoxArea(l.boundingBox)<r._computeBoundingBoxArea(n.boundingBox))&&(n=l,o=a)}t.push(n),i=n}return t},r._computeEnlargement=function(e,t){for(var i=0,r=["x","y","z"],n=0;n<3;n++){var o=r[n],s=e.boundingBox,a=t.boundingBox;i+=Math.max(0,s.min[o]-a.min[o])+Math.max(0,a.max[o]-s.max[o])}return i},r._computeBoundingBoxArea=function(e){var t=Math.abs(e.max.x-e.min.x),i=Math.abs(e.max.y-e.min.y);return t*Math.abs(e.max.z-e.min.z)*i},r.prototype._adjustTree=function(e,t,i){for(var n,o=t,s=i;o>=0;)(n=e[o])._recomputeBoundingBox(),null!=s&&n._addChild(s),n.children.length>this.instance.M?(s=n._splitNode(s),n._computeMagnitude(),s._computeMagnitude()):(n._computeMagnitude(),s=null),o-=1;var a=null;return null!=s&&((a=new r(s.boundingBox.min.x,s.boundingBox.min.y,s.boundingBox.min.z,0,0,0,this.instance,null))._addChild(e[0]),a._addChild(s),a._recomputeBoundingBox(),a._computeMagnitude()),a},r.prototype._splitNode=function(){return this._RPlusTreeSplit()},r.prototype._partition=function(e){var t=this.boundingBox.min.x,i=this.boundingBox.min.y,n=this.children.length/2,o=this._sweep("x",t,n),s=o.cost,a=this._sweep("y",i,n),l=s<=a.cost?o.nodes:a.nodes;this.children=l[0];for(var u=0;u<l[0].length;u++)l[0][u].parent=this;this._recomputeBoundingBox();var c=new r(0,0,0,0,0,0,this.instance);c.children=l[1];for(u=0;u<l[1].length;u++)l[1][u].parent=c;return c._recomputeBoundingBox(),c},r.prototype._sweep=function(e,t,i){this.children.sort(function(t,i){return t.center[e]<i.center[e]?-1:t.center[e]>i.center[e]?1:0});for(var r=[[],[]],n=this.children[0].center[e],o=this.children[this.children.length-1].center[e],s=0,a=0,l=0;l<5;l++){r=[[],[]];for(var u=0;u<this.children.length;u++){var c=this.children[u];r[Math.abs(c.center[e]-n)<Math.abs(c.center[e]-o)?0:1].push(c)}n=0,o=0;for(u=0;u<r[0].length;u++)n+=r[0][u].center[e];n/=r[0].length;for(u=0;u<r[1].length;u++)o+=r[1][u].center[e];if(o/=r[1].length,r[0].length==s&&r[1].length==a)break;s=r[0].length,a=r[1].length}return{cost:-Math.abs(n-o),nodes:r}},r.prototype._RPlusTreeSplit=function(e){return this._partition(e)},r.prototype._addChild=function(t){null==this.boundingBox.min.x?this.boundingBox=new e.Box3(t.boundingBox.min.clone(),t.boundingBox.max.clone()):this._adjustBoundingBox(t),t.parent=this,this.children.push(t),this._computeRadius()},r.prototype._recomputeBoundingBox=function(){if(0!=this.children.length){this.boundingBox=new e.Box3(this.children[0].boundingBox.min.clone(),this.children[0].boundingBox.max.clone());for(var t=1;t<this.children.length;t++)this._adjustBoundingBox(this.children[t]);this._computeCenter(),this._computeRadius()}},r.prototype._computeCenter=function(){if(0!=this.children.length){this.center=new e.Vector2(0,0);for(var t=0;t<this.children.length;t++)this.center.add(this.children[t].center);this.center=new e.Vector2(this.center.x/this.children.length,this.center.y/this.children.length)}},r.prototype._computeRadius=function(){var e=this.boundingBox;this.radius=Math.sqrt(Math.pow(e.max.x-e.min.x,2)+Math.pow(e.max.y-e.min.y,2))/2},r.prototype._adjustBoundingBox=function(e){this.boundingBox.min.x=Math.min(this.boundingBox.min.x,e.boundingBox.min.x),this.boundingBox.min.y=Math.min(this.boundingBox.min.y,e.boundingBox.min.y),this.boundingBox.min.z=Math.min(this.boundingBox.min.z,e.boundingBox.min.z),this.boundingBox.max.x=Math.max(this.boundingBox.max.x,e.boundingBox.max.x),this.boundingBox.max.y=Math.max(this.boundingBox.max.y,e.boundingBox.max.y),this.boundingBox.max.z=Math.max(this.boundingBox.max.z,e.boundingBox.max.z),this._computeCenter(),this._computeRadius()},r.prototype._getBiggestEnclosedNodesPerLevel=function(t,i,r,n,o){var s=[];if(n<o&&this.children.length>0){for(var a=0;a<this.children.length;a++){var l=this.children[a]._getBiggestEnclosedNodesPerLevel(t,i,r,n+1,o);s=s.concat(l)}return s}return this._inViewGeometry(new e.Vector3(this.center.x,this.center.y,0),i,r,n,t)&&s.push(this),this.splitted=!1,s},r.prototype._getNodesInDistance=function(e,t,i,r,n,o,s){var a=[],l=!1;if(this.nHits>1&&this.nHits<s)l=!0;else for(var u=0;u<this.children.length;++u){if(Math.sqrt(Math.pow(e.x-this.children[u].center.x,2)+Math.pow(e.y-this.children[u].center.y,2)+Math.pow(e.z-(this.children[u].boundingBox.max.z+this.children[u].boundingBox.min.z)/2,2))-this.children[u].radius<n){l=!0;break}}if(l){this.instance.nodesIndexVisible.push(1);for(u=0;u<this.children.length;++u){var c=this.children[u]._getNodesInDistance(e,t,i,r+1,n/2,o/2,s);a=a.concat(c)}}else a.push(this),this.instance.nodesIndexVisible.push(0);return a},r.prototype._getNodesInDistanceTest=function(e,t,i,r,n,o,s){var a=[],l=!1;if(Math.sqrt(Math.pow(e.x-this.center.x,2)+Math.pow(e.y-this.center.y,2)+Math.pow(e.z-(this.boundingBox.max.z+this.boundingBox.min.z)/2,2))<this.openDistance*this.instance.distanceFactor&&(l=!0),l){this.instance.nodesIndexVisible.push(1);for(var u=0;u<this.children.length;++u){var c=this.children[u]._getNodesInDistanceTest(e,t,i,r+1,n/2,o/2,s);a=a.concat(c)}}else a.push(this),this.instance.nodesIndexVisible.push(0);return a},r.prototype._getNodeByInstanceId=function(e){if(1!==this.instance.nodesIndexVisible[this.instance.indexInList])return this.instance.indexInList++,this.nHits>1?e===this.instance.indexNode?this:void this.instance.indexNode++:void 0;this.instance.indexInList++;for(var t=0;t<this.children.length;++t){var i=this.children[t]._getNodeByInstanceId(e);if(void 0!==i)return i}},r.prototype._computeNodePoint=function(){return new e.Vector4(this.center.x,this.center.y,this.radius,this.mag)},r.prototype._computeMagnitude=function(){if(0!=this.children.length){this.mag=0;for(var e=0;e<this.children.length;e++){var t=this.children[e];this.mag+=t.mag}}},r.prototype.computeBoxHeight=function(e){return Math.max((this.boundingBox.max.x-this.boundingBox.min.x+this.boundingBox.max.y-this.boundingBox.min.y)/2,4e4/Math.pow(2,e))},r.prototype._inViewGeometry=function(t,i,r,n,o){var s=r.z,a=this.computeBoxHeight(n);this.boundingBox.min.z=s,this.boundingBox.max.z=s+10*a;new e.Vector3(t.x,t.y,s);return this.__frustumIntersectsBox(i,this.boundingBox)},r.prototype.__frustumIntersectsBox=function(t,i){for(var r=t.planes,n=i.min,o=new e.Vector3(i.min.x,i.min.y,i.max.z),s=new e.Vector3(i.min.x,i.max.y,i.min.z),a=new e.Vector3(i.min.x,i.max.y,i.max.z),l=new e.Vector3(i.max.x,i.min.y,i.min.z),u=new e.Vector3(i.max.x,i.min.y,i.max.z),c=new e.Vector3(i.max.x,i.max.y,i.min.z),d=i.min,h=0;h<6;h++){var f=0;if(f+=r[h].distanceToPoint(n)<0?1:0,f+=r[h].distanceToPoint(l)<0?1:0,f+=r[h].distanceToPoint(s)<0?1:0,f+=r[h].distanceToPoint(c)<0?1:0,f+=r[h].distanceToPoint(o)<0?1:0,f+=r[h].distanceToPoint(u)<0?1:0,f+=r[h].distanceToPoint(a)<0?1:0,8==(f+=r[h].distanceToPoint(d)<0?1:0))return!1}return!0},r.prototype.__zoomLevel=function(e,t,i){var r=i.z,n=this.computeBoxHeight(t);return this.boundingBox.min.z=r,this.boundingBox.max.z=r+n,this.boundingBox.max.z>=e.z},r.prototype._toBeSplitted=function(e,t,i){return Math.pow((this.instance.M+this.instance.m)/2,t)<100||this.__zoomLevel(e,t,i)},r.prototype.getAllLeaves=function(){for(var e=[],t=0;t<this.children.length;++t)e=e.concat(this.children[t].getAllLeaves());return 1===this.nHits&&0===this.children.length&&e.push(this),e},i.prototype.insert=function(e){this.nb_points++,null==this._root?(this._root=new r(e.x,e.y,e.z,e.w,e.h,e.mag,this,null),this._root._addChild(new r(e.x,e.y,e.z,e.w,e.h,e.mag,this,e.infos)),this._root.children[0].nHits=1,this._root._computeMagnitude()):this._root=this._root.insert(e)},i.prototype.interpolatePointsOpening=function(t,i){for(var r=this._nodesToVec4(t),n=0;n<t.length;n++){var o=r[n],s=t[n].parent,a=new e.Vector2(o.x,o.y),l=new e.Vector2(s.center.x,s.center.y);a.subVectors(l,a),a.multiplyScalar(1-i),o.set(o.x+a.x,o.y+a.y,s.radius-(s.radius-o.z)*i,o.w)}return r},i.prototype.interpolatePointsClosing=function(t,i){for(var r=this._nodesToVec4(t),n=0;n<t.length;n++){var o=r[n],s=t[n].parent,a=new e.Vector2(o.x,o.y),l=new e.Vector2(s.center.x,s.center.y);a.subVectors(l,a),a.multiplyScalar(i),o.set(o.x+a.x,o.y+a.y,o.z+(s.radius-o.z)*i,o.w)}return r},i.prototype._nodesToVec4=function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i]._computeNodePoint());return t},i.prototype.newgetVisiblePoints=function(e,t,i){if(void 0===this.last_level_displayed&&(this.last_level_displayed=2),2!=this.last_level_displayed){if(!(this.animation>=this.animation_time)){var r=this.urban.USR.timeDelta;this.animation+=r,this.animation>this.animation_time&&(this.animation=this.animation_time);var n=this.animation/this.animation_time,o=null;return 2>this.last_level_displayed?(o=this._root._getBiggestEnclosedNodesPerLevel(e,t,i,0,2),o=this.interpolatePointsOpening(o,n)):(o=this._root._getBiggestEnclosedNodesPerLevel(e,t,i,0,this.last_level_displayed),o=this.interpolatePointsClosing(o,n)),{visiblePoints:o}}this.animation=0}var s=this._root._getBiggestEnclosedNodesPerLevel(e,t,i,0,2);return this.last_level_displayed=2,{visiblePoints:this._nodesToVec4(s)}},i.prototype.getVisiblePoints=function(e,t,i){for(var r=0;Math.pow((this.M+this.m)/2,r)<100||e.z<this.thresholds[r];)r+=1;if(void 0===this.last_level_displayed&&(this.last_level_displayed=r),this.last_level_displayed!=r){if(!(this.animation>=this.animation_time)){var n=this.urban.USR.timeDelta;this.animation+=n,this.animation>this.animation_time&&(this.animation=this.animation_time);var o=this.animation/this.animation_time,s=null;return r>this.last_level_displayed?(s=this._root._getBiggestEnclosedNodesPerLevel(e,t,i,0,r),s=this.interpolatePointsOpening(s,o)):(s=this._root._getBiggestEnclosedNodesPerLevel(e,t,i,0,this.last_level_displayed),s=this.interpolatePointsClosing(s,o)),{visiblePoints:s,scale:scale}}this.animation=0}var a=this._root._getBiggestEnclosedNodesPerLevel(e,t,i,0,r);return this.last_level_displayed=r,{visiblePoints:this._nodesToVec4(a)}},i.prototype.getVisibleNodes=function(e,t,i,r){void 0===this.last_level_displayed&&(this.last_level_displayed=2),this.nodesIndexVisible=[];var n=this._root._getNodesInDistance(e,t,i,0,this.distance,200,r),o=!1;if(this.oldNodesIndexVisible.length!==this.nodesIndexVisible.length)o=!0;else for(var s=0;s<this.nodesIndexVisible;++s)this.oldNodesIndexVisible[s]!==this.nodesIndexVisible[s]&&(o=!0);return this.oldNodesIndexVisible=this.nodesIndexVisible,this.last_level_displayed=2,{visibleNodes:n,changed:o}},i.prototype.computeHits=function(){this._root.computeHits()},r.prototype.computeHits=function(){for(var e=0;e<this.children.length;++e)this.nHits+=this.children[e].computeHits();return this.nHits},i.prototype.computeClusterIds=function(){this._clusterIndex=0,this._root.computeClusterIds()},r.prototype.computeClusterIds=function(){this.clusterId=this.instance.clusterSTRID+"_"+this.instance._clusterIndex,this.instance._clusterIndex++;for(var e=0;e<this.children.length;++e)this.children[e].computeClusterIds()},i.prototype.computeDistances=function(e,t){this._root.computeDistances(Math.max(e,t),Math.max(e,t))},r.prototype.computeDistances=function(e,t){var i=(this.boundingBox.max.x-this.boundingBox.min.x)/2,r=(this.boundingBox.max.y-this.boundingBox.min.y)/2,n=Math.abs(i*e),o=Math.abs(r*t);this.openDistance=Math.max(n,o);for(var s=0;s<this.children.length;++s)this.children[s].computeDistances(e,t)},i.prototype.getVisibleNodesTest=function(e,t,i,r,n){this.distanceFactor=n;void 0===this.last_level_displayed&&(this.last_level_displayed=2),this.nodesIndexVisible=[];var o=this._root._getNodesInDistanceTest(e,t,i,0,this.distance,200,r),s=!1;if(this.oldNodesIndexVisible.length!==this.nodesIndexVisible.length)s=!0;else for(var a=0;a<this.nodesIndexVisible;++a)this.oldNodesIndexVisible[a]!==this.nodesIndexVisible[a]&&(s=!0);return this.oldNodesIndexVisible=this.nodesIndexVisible,this.last_level_displayed=2,{visibleNodes:o,changed:s}},i.prototype.getNodeByInstanceId=function(e){return this.indexInList=0,this.indexNode=0,this._root._getNodeByInstanceId(e)},i}),define("DS/XCityTools/OGCFilterPrimitive",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e){this.filter=e},apply:function(e){return"PropertyIsBetween"===this.filter["ogc:Filter"].comparisonOps.name.localPart?this.isBetWeenOp(e):this.genericOp(e)},genericOp:function(e){for(var t,i,r=this.filter["ogc:Filter"].comparisonOps,n=0;n<r.value.expression.length;n++)"PropertyName"===r.value.expression[n].name.localPart?t=r.value.expression[n].value.content[0]:"Literal"===r.value.expression[n].name.localPart&&(i=r.value.expression[n].value.content[0]);var o=r.name.localPart;switch(o){case"PropertyIsEqualTo":return e[t]===i;case"PropertyIsNotEqualTo":return e[t]!==i;case"PropertyIsLessThan":return e[t]<i;case"PropertyIsLessThanOrEqualTo":return e[t]<=i;case"PropertyIsGreaterThan":return e[t]>i;case"PropertyIsGreaterThanOrEqualTo":return e[t]>=i;default:return console.error("FILTER comparison operator : "+o+" not yet implemented"),!1}},isBetWeenOp:function(e){var t=this.filter["ogc:Filter"].comparisonOps,i=t.value.expression.value.content[0],r=t.value.lowerBoundary.expression.value.content[0],n=t.value.upperBoundary.expression.value.content[0];return e[i]>=r&&e[i]<=n}})}),define("DS/XCityTools/AtlasNode",["UWA/Class","DS/xCityBasicUtils/Utils"],function(e,t){"use strict";return e.extend({init:function(e,t,i,r){this.x=0,this.y=0,this.width=0,this.height=0,this.used=!1,this.Index=0,this.block=null,this.right=null,this.down=null,this.x=e,this.y=t,this.width=i,this.height=r}})}),define("DS/XCityTools/TextureTools",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return e.singleton({init:function(){this._htmlCanvas=document.createElement("canvas")},createTexture:function(e){if(void 0!==e&&void 0!==e.data&&void 0!==e.xSize&&void 0!==e.ySize){var i=e.data;i instanceof Float32Array||(i=new Float32Array(i));var r=e.xSize,n=e.ySize,o=void 0!==e.name?e.name:"",s=void 0!==e.format?e.format:t.RGBAFormat,a=void 0!==e.filter?e.filter:t.LinearFilter,l=void 0!==e.flipY&&e.flipY,u=void 0!==e.generateMipmaps&&e.generateMipmaps,c=new t.DataTexture(i,r,n,s,t.FloatType);return c.name=o,c.minFilter=a,c.magFilter=a,c.flipY=l,c.generateMipmaps=u,c.needsUpdate=!0,c}},pushPixel:function(e,i){var r;if(i instanceof Array)for(r=0;r<i.length;r++)e.push(i[r]);else i instanceof t.Color?(e.push(i.r),e.push(i.g),e.push(i.b)):e.push(i)},int2color:function(e){var t=4,i=[],r=Math.floor(e);for(i[0]=r%256,i[1]=(r-i[0])/255%256,i[2]=(r-i[0]-255*i[1])/65025%256,i[3]=(r-i[0]-255*i[1]-65025*i[2])/16581375%256;t--;)i[t]/=255;return i},float2color:function(e){var t=[],i=e-Math.floor(e);return t[0]=i,t[1]=255*i,t[2]=65025*i,t[3]=16581375*i,t[0]=t[0]-Math.floor(t[0]),t[1]=t[1]-Math.floor(t[1]),t[2]=t[2]-Math.floor(t[2]),t[3]=t[3]-Math.floor(t[3]),t[0]-=t[1]/255,t[1]-=t[2]/255,t[2]-=t[3]/255,t},generateTextureFromName:function(e,i,r,n){var o,s;o=document.getElementsByTagName("body")[0],(s=document.createElement("div")).setAttribute("style","position:absolute;top:0px; left:0px;"),s.innerHTML="<div class='"+i.styleClass+"'><div class='"+i.pClass+"' style='zoom:"+i.samplingFactor+";'>"+e+"</div></div>",o.appendChild(s);var a=["background-color","background-origin","background-image","background-position-x","background-position-y","background-repeat","background-size","background-clip","border-top-color","border-top-style","border-top-width","border-top-left-radius","border-top-right-radius","border-bottom-color","border-bottom-style","border-bottom-width","border-bottom-left-radius","border-bottom-right-radius","border-right-color","border-right-style","border-right-width","border-left-color","border-left-style","border-left-width","border-image-outset","border-image-repeat","border-image-slice","border-image-source","border-image-width","box-sizing","padding-top","padding-bottom","padding-right","padding-left","vertical-align","text-align","word-spacing","letter-spacing","line-height","margin-bottom","margin-top","margin-left","margin-right","color","font-family","font-stretch","font-style","font-variant","font-weight","font-size","width","height","text-shadow"],l=window.getComputedStyle(s.children[0]),u=[],c=window.getComputedStyle(s.children[0].children[0]),d=[],h=c.getPropertyValue("top"),f=c.getPropertyValue("left");r.topText=parseFloat(h),r.leftText=parseFloat(f);for(var p=0;p<a.length;p++)if(9===p)u.push("0px"),d.push("0px");else{var m=a[p];u.push(l.getPropertyValue(m)),d.push(c.getPropertyValue(m))}var v=s.offsetWidth+0,g=s.offsetHeight;r.width=v,r.height=g,r.samplingFactor=i.samplingFactor,h.indexOf("%")>-1&&(r.topText=r.topText*r.height/(100*i.samplingFactor)),f.indexOf("%")>-1&&(r.leftText=r.leftText*r.width/(100*i.samplingFactor)),isNaN(r.topText)&&(r.topText=0),isNaN(r.leftText)&&(r.leftText=0),o.removeChild(s);var _="style='display:block; ",x="style='display:block; zoom:"+i.samplingFactor+";white-space: nowrap; ";for(p=0;p<a.length;p++)_=_.concat(a[p]+": "+u[p]+"; "),x=x.concat(a[p]+": "+d[p]+"; ");var b="<div xmlns='http://www.w3.org/1999/xhtml' style='position:absolute; top:0px; left:0px;'><div xmlns='http://www.w3.org/1999/xhtml' "+(_=_.concat("'"))+" ><div xmlns='http://www.w3.org/1999/xhtml' "+(x=x.concat("'"))+">"+e+"</div></div></div>",y=r.width,w=r.height;this._htmlCanvas.width=1*y,this._htmlCanvas.height=1*w;var C=this._htmlCanvas.getContext("2d"),S="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='"+this._htmlCanvas.width+"' height='"+this._htmlCanvas.height+"'><foreignObject width='100%' height='100%'>"+b+"</foreignObject></svg>",P=new Image;P.onload=function(){this._htmlCanvas.width=1*y,this._htmlCanvas.height=1*w,C.clearRect(0,0,this._htmlCanvas.width,this._htmlCanvas.height),C.drawImage(P,0,0);for(var e=C.getImageData(0,0,y,w),i=new ArrayBuffer(e.data.length),r=new Uint8Array(i),o=0;o<y*w;++o)r[4*o]=e.data[4*o],r[4*o+1]=e.data[4*o+1],r[4*o+2]=e.data[4*o+2],r[4*o+3]=e.data[4*o+3];var s=new t.DataTexture(r,y,w,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearMipMapLinearFilter);s.needsUpdate=!0,C.clearRect(0,0,this._htmlCanvas.width,this._htmlCanvas.height),this._htmlCanvas.height=0,n(s)}.bind(this),P.src=S},computeLabelSize:function(e,t,i=1){if(!Utils.is(e)||""==e)return{width:0,height:0};let r=this._htmlCanvas.getContext("2d"),n=t.style;r.font=n["font-weight"]+" "+n["font-size"]+" "+n["font-family"],r.letterSpacing=n["letter-spacing"];let o=r.measureText(e),s=this.getPaddingSize(n),a={};return a.width=o.width+2*s.horizontal_padding+1+o.actualBoundingBoxLeft,a.height=Math.ceil(o.fontBoundingBoxDescent+o.fontBoundingBoxAscent+o.actualBoundingBoxAscent+o.actualBoundingBoxDescent),a},generateLabelTexture:function(e,i,r,n=1){if(!Utils.is(e)||""==e)return{width:0,height:0};var o={},s="style='display:inline-block; ";for(var a in e=this.removeXMLSpecialChar(e.toString()),i.style){a.includes("color")&&(i.style[a]=i.style[a].hexToRgb()?i.style[a].hexToRgb():i.style[a]);var l=i.style[a];if("font-size"===a){var u=l.match(/\d/g).join(""),c=l.split(/[0-9]+/)[1];l=""+u*n+c}else if("padding"===a){let e=this.getPaddingSize(i.style),t=l.split(/[0-9]+/).pop();l=""+e.vertical_padding+t+" "+e.horizontal_padding+t}s=s.concat(a+": "+l+"; ")}var d="<div xmlns='http://www.w3.org/1999/xhtml' style='position:absolute;white-space: nowrap;'><div xmlns='http://www.w3.org/1999/xhtml' "+(s=(s=s.concat("margin : 1px;")).concat("'"))+">"+e+"</div></div>",h=this.createElementFromHTML(d);document.body.appendChild(h),o.width=h.offsetWidth,o.height=h.offsetHeight,document.body.removeChild(h);var f=o.width,p=o.height;if(f>0&&p>0){this._htmlCanvas.width=f,this._htmlCanvas.height=p;var m=this._htmlCanvas.getContext("2d"),v="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><foreignObject width='100%' height='100%'>"+d+"</foreignObject></svg>",g=new Image;g.onload=function(){this._htmlCanvas.width=f,this._htmlCanvas.height=p,m.clearRect(0,0,this._htmlCanvas.width,this._htmlCanvas.height),m.drawImage(g,0,0);for(var e=m.getImageData(0,0,f,p),i=new ArrayBuffer(e.data.length),n=new Uint8Array(i),o=0;o<f*p;++o)n[4*o]=e.data[4*o],n[4*o+1]=e.data[4*o+1],n[4*o+2]=e.data[4*o+2],n[4*o+3]=e.data[4*o+3];var s=new t.DataTexture(n,f,p,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping,t.ClampWrapping,t.ClampWrapping,t.NearestFilter,t.NearestMipMapLinearFilter);s.needsUpdate=!0,r(s)}.bind(this),g.src=v}return o.width/=n,o.height/=n,o},generateGlypheTexture:function(e,i,r){if(!Utils.is(e)||""==e)return{width:0,height:0};var n={},o="style='display:block; ";for(var s in e=this.removeXMLSpecialChar(e.toString()),i.style)s.includes("color")&&(i.style[s]=i.style[s].hexToRgb()?i.style[s].hexToRgb():i.style[s]),o=o.concat(s+": "+i.style[s]+"; ");var a="<div xmlns='http://www.w3.org/1999/xhtml' style='position:absolute;white-space: pre;transform: translate(150%,150%) scale(4);'><div xmlns='http://www.w3.org/1999/xhtml' "+(o=o.concat("'"))+">"+e+"</div></div>",l=this.createElementFromHTML(a);document.body.appendChild(l),n.width=4*l.offsetWidth,n.height=4*l.offsetHeight,document.body.removeChild(l);var u=n.width,c=n.height;if(u>0&&c>0){this._htmlCanvas.width=u,this._htmlCanvas.height=c;var d=this._htmlCanvas.getContext("2d"),h="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><foreignObject width='100%' height='100%'>"+a+"</foreignObject></svg>",f=new Image;f.onload=function(){this._htmlCanvas.width=u,this._htmlCanvas.height=c,d.clearRect(0,0,this._htmlCanvas.width,this._htmlCanvas.height),d.drawImage(f,0,0);for(var e=d.getImageData(0,0,u,c),i=new ArrayBuffer(e.data.length),n=new Uint8Array(i),o=0;o<u*c;++o)n[4*o]=e.data[4*o],n[4*o+1]=e.data[4*o+1],n[4*o+2]=e.data[4*o+2],n[4*o+3]=e.data[4*o+3];var s=new t.DataTexture(n,u,c,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping,t.ClampWrapping,t.ClampWrapping,t.LinearFilter,t.LinearMipMapLinearFilter);s.anisotropy=1,s.needsUpdate=!0,r(s)}.bind(this),f.onerror=function(t,i,r){console.log("glypheloadingerror",t,e,u,c)},f.src=h}return n},removeXMLSpecialChar:function(e){return e.replace("<"," ").replace("&"," ")},createElementFromHTML:function(e){var t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild},getImageDataFromTexture:function(e){var i=e.image;if(e instanceof t.DataTexture)return i;var r=document.createElement("canvas");r.width=i.width,r.height=i.height;var n=r.getContext("2d");return n.drawImage(i,0,0),n.getImageData(0,0,i.width,i.height)},generateAtlasFromBlocks:function(e,i,r){this.testMode=!1;var n,o,s,a=new ArrayBuffer(i*r*4),l=new Uint8Array(a),u=e.length;for(s=0;s<u;s++){var c=e[s],d=c.getX(),h=c.getY(),f=c.getWidth(),p=c.getHeight(),m=this.getImageDataFromTexture(c.texture.texture),v=d+h*i;for(o=0;o<p;++o)for(n=0;n<f;++n){var g=n+o*f,_=v+n+o*i;!0===this.testMode?(l[4*_]=0===s?255:0,l[4*_+1]=0===s?0:255,l[4*_+2]=0,l[4*_+3]=255):(l[4*_]=m.data[4*g],l[4*_+1]=m.data[4*g+1],l[4*_+2]=m.data[4*g+2],l[4*_+3]=m.data[4*g+3])}}var x=new t.DataTexture(l,i,r,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping,t.ClampWrapping,t.ClampWrapping,t.NearestFilter,t.NearestMipMapLinearFilter);return x.anisotropy=1,x.needsUpdate=!0,x},getShadowSize:function(e){if(""==e)return[0,0];var t=e.replace(/ *\([^)]*\) */g,"").split(","),i=0,r=0,n=0;for(let e=0;e<t.length;e++){var o=t[e].split(" ").filter(e=>e);1===o.length&&o.push(o[0]),i=Math.max(i,o[0].match(/\d/g).join("")),r=Math.max(r,o[1].match(/\d/g).join("")),o.length>3&&(n=Math.max(n,parseInt(o[2].match(/\d/g).join(""))))}return[i+n,r+n]},getPaddingSize:function(e){let t=this.getShadowSize(e.padding),i=this.getShadowSize(e["text-shadow"]);return{vertical_padding:Math.max(t[0],i[0]),horizontal_padding:Math.max(t[1],i[1])}}})}),define("DS/XCityTools/OGCFilter",["UWA/Class","DS/XCityTools/Expression"],function(e,t){"use strict";var i=t.extend({init:function(e){e?e instanceof i?this._set(e._get()):this._parent(e):this._set({TYPE_NAME:"Filter_1_1_0.FilterType"})},clone:function(){return new i(this.toJSON())},isLike:function(e){return this["ogc:Filter"].comparisonOps={"ogc:PropertyIsLike":{TYPE_NAME:"Filter_1_1_0.PropertyIsLikeType",escapeChar:"",singleChar:"_",wildCard:"%",literal:{TYPE_NAME:"Filter_1_1_0.LiteralType",content:[e]},propertyName:{TYPE_NAME:"Filter_1_1_0.PropertyNameType",content:this.tmp.PropertyName}}},delete this.tmp,this},isNull:function(e){new t(e);return this.setAsBinaryComparisonOpType("PropertyIsNull",[this._get()]),this},isNotNull:function(e){new t(e);return this.setAsBinaryComparisonOpType("PropertyIsNotNull",[this._get()]),this},isBetween:function(e,i){this.setAsBinaryComparisonOpType("PropertyIsBetween",[this._get()]);var r=this.expr.comparisonOps.value;return r.LowerBoundary=new t(e)._get(),r.UpperBoundary=new t(i)._get(),this},setAsBinaryLogicOpType:function(e,t){var i={logicOps:{name:{localPart:e},value:{expression:t}}};this._set(i)},setAsBinaryComparisonOpType:function(e,t){var i={comparisonOps:{name:{localPart:e},value:{expression:t}}};this._set(i)},isEqualTo:function(e){var i=new t(e);return this.setAsBinaryComparisonOpType("PropertyIsEqualTo",[this._get(),i._get()]),this},isLessThanOrEqualTo:function(e){var i=new t(e);return this.setAsBinaryComparisonOpType("PropertyIsLessThanOrEqualTo",[this._get(),i._get()]),this},isGreaterThan:function(e){var i=new t(e);return this.setAsBinaryComparisonOpType("PropertyIsGreaterThan",[this._get(),i._get()]),this},isLessThan:function(e){var i=new t(e);return this.setAsBinaryComparisonOpType("PropertyIsLessThan",[this._get(),i._get()]),this},isGreaterThanOrEqualTo:function(e){var i=new t(e);return this.setAsBinaryComparisonOpType("PropertyIsGreaterThanOrEqualTo",[this._get(),i._get()]),this},isNotEqualTo:function(e){var i=new t(e);return this.setAsBinaryComparisonOpType("PropertyIsNotEqualTo",[this._get(),i._get()]),this},and:function(e){var i=new t(e);return this.setAsBinaryLogicOpType("And",[this._get(),i._get()]),this},or:function(e){var i=new t(e);return this.setAsBinaryLogicOpType("Or",[this._get(),i._get()]),this},not:function(e){var i=new t(e);return this.setAsBinaryLogicOpType("Not",[this._get(),i._get()]),this},getPreviousOperator:function(e){var t;if(void 0!==e["ogc:Filter"].comparisonOps)t=e["ogc:Filter"].comparisonOps;else if(void 0!==e["ogc:Filter"].spatialOps)t=e["ogc:Filter"].spatialOps;else{if(void 0===e["ogc:Filter"].logicOps)throw console.error(e),"Not Implemented yet, another operators";t=e["ogc:Filter"].logicOps}return t},BBOX:function(e,t,i,r,n){return this["ogc:Filter"].spatialOps={"ogc:BBOX":{TYPE_NAME:"Filter_1_1_0.BBOXType",envelope:{"gml:Envelope":{TYPE_NAME:"GML_3_1_1.EnvelopeType",lowerCorner:{TYPE_NAME:"GML_3_1_1.DirectPositionType",value:[e,t]},upperCorner:{TYPE_NAME:"GML_3_1_1.DirectPositionType",value:[i,r]},srsName:n}},propertyName:{TYPE_NAME:"Filter_1_1_0.PropertyNameType",content:"ows:BoundingBox"}}},this}});return i}),define("DS/XCityTools/ExpressionEvaluator",["UWA/Class","DS/xCityBasicUtils/Utils","DS/XCityTools/Expression","DS/xCityBasicUtils/ColorGradient","DS/xCityBasicUtils/FloatGradient"],function(Class,Utils,Expression,ColorGradient,FloatGradient){"use strict";var FunctionNameToCode={And:"and","ogc:And":"and",Or:"or","ogc:Or":"or",Not:"not","ogc:Not":"not",Add:"add","ogc:Add":"add",Sub:"sub","ogc:sub":"sub",Mul:"mul","ogc:Mul":"mul",Div:"div","ogc:Div":"div",toNumber:"toNumber",PropertyIsEqualTo:"isEqualTo",IsEqualTo:"isEqualTo","ogc:PropertyIsEqualTo":"isEqualTo",PropertyIsNotEqualTo:"isNotEqualTo",IsNotEqualTo:"isNotEqualTo","ogc:PropertyIsNotEqualTo":"isNotEqualTo",PropertyIsLessThan:"isLessThan",IsLessThan:"isLessThan","ogc:PropertyIsLessThan":"isLessThan",PropertyIsLessThanOrEqualTo:"isLessThanOrEqualTo",IsLessThanOrEqualTo:"isLessThanOrEqualTo","ogc:PropertyIsLessThanOrEqualTo":"isLessThanOrEqualTo",PropertyIsGreaterThan:"isGreaterThan",IsGreaterThan:"isGreaterThan","ogc:PropertyIsGreaterThan":"isGreaterThan",PropertyIsGreaterThanOrEqualTo:"isGreaterThanOrEqualTo",IsGreaterThanOrEqualTo:"isGreaterThanOrEqualTo","ogc:PropertyIsGreaterThanOrEqualTo":"isGreaterThanOrEqualTo",PropertyIsBetween:"isBetween",IsBetween:"isBetween","ogc:PropertyIsBetween":"isBetween",PropertyIsNull:"isNull",IsNull:"isNull","ogc:PropertyIsNull":"isNull",PropertyIsNotNull:"isNotNull",IsNotNull:"isNotNull","ogc:PropertyIsNotNull":"isNotNull",PropertyName:"getProperty","ogc:PropertyName":"getProperty",ValueReference:"getProperty","ogc:ValueReference":"getProperty",Literal:"getLiteral","ogc:Literal":"getLiteral",Function:"applyFunction","ogc:Function":"applyFunction",comparisonOps:"applyFunction",logicOps:"applyFunction",expression:"evaluateArrayOrObject",ColorGradient:"colorGradient",FloatGradient:"floatGradient"},ExpressionEvaluator=Class.extend({init:function(e){Utils.is(e)&&e instanceof Expression&&this.setExpression(e)},setExpression:function(e){this.expr=e._get(),this._exprObject=e,this.currentString=e.stringForm,this.usedAttributes=e.usedAttributes,this.usedVariables=e.usedVariables},unsetExpression:function(){this.expr=null,this._exprObject=null,this.currentString=null,this.usedAttributes=null,this.usedVariables=null},setContext:function(e){this.currentAttributes=e},unsetContext:function(){this.currentAttributes=null},apply:function(e){if(Utils.is(e)||(e=this.currentAttributes),this.expr)return this.currentAttributes=e,this.currentString=null,this.evaluate(this.expr)},applytoString:function(e){if(Utils.is(e)||(e=this.currentAttributes),this.expr){this.currentAttributes=e,this.currentString=" ";var t=this.evaluate(this.expr);return this.currentString+=";",t}},evalString:function(attributes){var value,evaluated=!1;if(this.currentString||(value=this.applytoString(attributes),this._exprObject.stringForm=this.currentString,this._exprObject.usedVariables=this.usedVariables,evaluated=!0),this.usedAttributes){this._exprObject.usedAttributes=this.usedAttributes;for(var keys=Object.keys(this.usedAttributes),i=0;i<keys.length;i++){var key=keys[i],attrvalue=this.currentAttributes[key];if(void 0===attrvalue)return}}if(!0===evaluated)return value;var XCITYcurrentVariables=this.usedVariables,XCITYcurrentContent=this.currentAttributes;return eval(this.currentString)},evaluate:function(e){var t,i;if(Array.isArray(e)){var r,n=e.length;for(t=[],this.currentString&&(this.currentString+="["),r=0;r<n;r++)i=e[r],t[r]=this.evaluate(i),r<n-1&&this.currentString&&(this.currentString+=",");this.currentString&&(this.currentString+="]")}else{var o=this.getName(e);i=this.getValue(e,o);var s=FunctionNameToCode[o];Utils.is(s)?t=this[s](i,e):(console.error(" Unknown Expression Type : "+o),t=null)}return t},evaluateArrayOrObject:function(e){var t;return t=Array.isArray(e)?e[0]:e,this.evaluate(t)},getName:function(e){return Utils.is(e)?Utils.is(e.name)&&Utils.is(e.name.localPart)?e.name.localPart:Object.keys(e)[0]:null},getValue:function(e,t){if(Utils.is(e)){if(Utils.is(e.value)){var i=Object.keys(e.value);return 1===i.length?e.value[i[0]]:e.value}return e[t]}return null},applyFunction:function(e){var t=this.getName(e),i=this.getValue(e,t),r=null,n=FunctionNameToCode[t];return Utils.is(n)?r=this[n](i,e):(console.error(" Unknown Expression Type : "+t),r=null),r},oldgetProperty:function(e){return Array.isArray(e)&&1===e.length&&(e=e[0]),this.currentString&&(this.usedAttributes||(this.usedAttributes={}),this.usedAttributes[e]?this.usedAttributes[e]++:this.usedAttributes[e]=0,this.currentString+='XCITYcurrentContent["'+e+'"]'),this.currentAttributes[e]},getProperty:function(e,t){var i,r=0,n=e.length,o=0;if("string"==typeof e){if(this.currentMapping&&this.currentMapping[e])e=this.currentMapping[e],t[Object.keys(t)[0]]=e;this.currentString&&(this.usedAttributes||(this.usedAttributes={}),this.usedAttributes[e]?this.usedAttributes[e]++:this.usedAttributes[e]=0,this.currentString+='XCITYcurrentContent["'+e+'"]'),o=this.currentAttributes[e]}else if(Utils.is(this.currentMapping))for(r=0;r<e.length;r++)i=e[r],this.currentMapping[i]&&(i=this.currentMapping[i]),e[r]=i;else{var s=this.currentAttributes;for(i=e[0],this.currentString&&(this.usedAttributes||(this.usedAttributes={}),this.usedAttributes[i]?this.usedAttributes[i]++:this.usedAttributes[i]=0,this.currentString+='XCITYcurrentContent["'+i+'"]'),o=this.currentAttributes[i],r=1;r<n;r++)this.currentAttributes=o,i=e[r],o=this.currentAttributes[i],this.currentString&&(this.currentString+='["'+i+'"]');this.currentAttributes=s}return o},getLiteral:function(e){return Array.isArray(e)&&1===e.length&&(e=e[0]),this.currentString&&(this.currentString+=e),e},add:function(e){var t,i=0,r=e.length,n=0;for(n=this.evaluate(e[0]),i=1;i<r;i++)this.currentString&&(this.currentString+=" + "),t=e[i],n+=this.evaluate(t);return n},sub:function(e){var t,i=0,r=e.length,n=0;for(n=this.evaluate(e[0]),i=1;i<r;i++)this.currentString&&(this.currentString+=" + "),t=e[i],n-=this.evaluate(t);return n},mul:function(e){var t,i=0,r=e.length,n=1;for(n=this.evaluate(e[0]),i=1;i<r;i++)this.currentString&&(this.currentString+=" * "),t=e[i],n*=this.evaluate(t);return n},div:function(e){var t,i=0,r=e.length,n=1;for(n=this.evaluate(e[0]),i=1;i<r;i++)this.currentString&&(this.currentString+=" / "),t=e[i],n/=this.evaluate(t);return n},and:function(e){var t,i=0,r=e.length,n=1;for(n=this.evaluate(e[0]),i=1;i<r;i++)this.currentString&&(this.currentString+=" && "),t=this.evaluate(e[i]),n=n&&t;return n},or:function(e){var t,i=0,r=e.length,n=1;for(n=this.evaluate(e[0]),i=1;i<r;i++)this.currentString&&(this.currentString+=" || "),t=this.evaluate(e[i]),n=n||t;return n},not:function(e){var t;e.length;return this.currentString&&(this.currentString+=" ( !"),t=!this.evaluate(e[0]),this.currentString&&(this.currentString+=" )"),t},toNumber:function(e){this.currentString&&(this.currentString+=" Number( ");var t=Number(this.evaluate(e));return t=isNaN(t)?0:t,this.currentString&&(this.currentString+=" ) "),t},isNull:function(e){this.currentString&&(this.currentString+=" (!Utils.is( ");var t=this.evaluate(e);return t=!Utils.is(t),this.currentString&&(this.currentString+=" )) "),t},isNotNull:function(e){this.currentString&&(this.currentString+=" (Utils.is( ");var t=this.evaluate(e[0]);return t=Utils.is(t),this.currentString&&(this.currentString+=" )) "),t},isEqualTo:function(e){var t=0,i=e.length,r=1;for(r=this.evaluate(e[0]),2!==i&&console.error(" Comparison needs exactly two operands ! "),t=1;t<i;t++)this.currentString&&(this.currentString+=" == "),r=r==this.evaluate(e[t]);return r},isNotEqualTo:function(e){var t=0,i=e.length,r=1;for(r=this.evaluate(e[0]),2!==i&&console.error(" Comparison needs exactly two operands ! "),t=1;t<i;t++)this.currentString&&(this.currentString+=" != "),r=r!=this.evaluate(e[t]);return r},isLessThan:function(e){var t,i=0,r=e.length,n=1;for(n=this.evaluate(e[0]),2!==r&&console.error(" Comparison needs exactly two operands ! "),i=1;i<r;i++){this.currentString&&(this.currentString+=" < "),t=this.evaluate(e[i]);var o=Number(t),s=Number(n);isNaN(s)&&(s=n),isNaN(o)&&(o=t),n=s<o}return n},isLessThanOrEqualTo:function(e){var t,i=0,r=e.length,n=1;for(n=this.evaluate(e[0]),2!==r&&console.error(" Comparison needs exactly two operands ! "),i=1;i<r;i++){this.currentString&&(this.currentString+=" <= "),t=this.evaluate(e[i]);var o=Number(t),s=Number(n);isNaN(s)&&(s=n),isNaN(o)&&(o=t),n=s<=o}return n},isGreaterThan:function(e){var t,i=0,r=e.length,n=1;for(n=this.evaluate(e[0]),2!==r&&console.error(" Comparison needs exactly two operands ! "),i=1;i<r;i++){this.currentString&&(this.currentString+=" > "),t=this.evaluate(e[i]);var o=Number(t),s=Number(n);isNaN(s)&&(s=n),isNaN(o)&&(o=t),n=s>o}return n},isGreaterThanOrEqualTo:function(e){var t,i=0,r=e.length,n=1;for(n=this.evaluate(e[0]),2!==r&&console.error(" Comparison needs exactly two operands ! "),i=1;i<r;i++){this.currentString&&(this.currentString+=" >= "),t=this.evaluate(e[i]);var o=Number(t),s=Number(n);isNaN(s)&&(s=n),isNaN(o)&&(o=t),n=s>=o}return n},isBetween:function(e){var t,i,r,n=null;if(Utils.is(e)){if(Array.isArray(e)){var o=e.length;for(r=0;r<o;r++){var s=e[r],a=this.getName(s),l=this.getValue(s,a);"LowerBoundary"===a||"lowerBoundary"===a?t=this.evaluate(l):"UpperBoundary"===a||"upperBoundary"===a?i=this.evaluate(l):n=this.evaluate(s)}}else n=this.evaluate(e),Utils.is(e.LowerBoundary)&&(t=this.evaluate(e.LowerBoundary)),Utils.is(e.lowerBoundary)&&(t=this.evaluate(e.lowerBoundary)),Utils.is(e.upperBoundary)&&(i=this.evaluate(e.upperBoundary)),Utils.is(e.UpperBoundary)&&(i=this.evaluate(e.UpperBoundary));Utils.is(t)||(t=n),Utils.is(i)||(i=n);var u=Number(t),c=Number(i),d=Number(n);isNaN(d)&&(d=n),isNaN(u)&&(u=t),isNaN(c)&&(c=i),n=u<=d&&d<=c,this.currentString&&console.error("isBetween not optimised")}return n},colorGradient:function(e){if(!Utils.is(e)||2!=e.length&&3!=e.length)return null;var t,i=e[1];if(Utils.is(i.xCityid)&&Utils.is(this.usedVariables)){var r=this.usedVariables[i.xCityid];Utils.is(r)&&(i=r)}i instanceof ColorGradient||(i=new ColorGradient(i,e[2]),e[1].xCityid=i.xCityid,this.currentString&&(t=i.xCityid,Utils.is(this.usedVariables)||(this.usedVariables={}),this.usedVariables[t]=i)),this.currentString&&(t=i.xCityid,this.currentString+=' XCITYcurrentVariables["'+t+'"].computeColor(');var n=this.evaluate(e[0]),o=null;return Utils.is(n)&&(i.setLastValue(n),o=i.computeColor()),this.currentString&&(this.currentString+=" )"),o},floatGradient:function(e){if(!Utils.is(e)||2!=e.length&&3!=e.length)return null;var t,i=e[1];if(Utils.is(i.xCityid)&&Utils.is(this.usedVariables)){var r=this.usedVariables[i.xCityid];Utils.is(r)&&(i=r)}i instanceof FloatGradient||(i=new FloatGradient(i,e[2]),e[1].xCityid=i.xCityid,this.currentString&&(t=i.xCityid,Utils.is(this.usedVariables)||(this.usedVariables={}),this.usedVariables[t]=i)),this.currentString&&(t=i.xCityid,this.currentString+=' XCITYcurrentVariables["'+t+'"].computeFloat(');var n=this.evaluate(e[0]),o=null;return Utils.is(n)&&(i.setLastValue(n),o=i.computeFloat()),this.currentString&&(this.currentString+=" )"),o},mapExpression:function(e){if(this.expr){this.currentAttributes;this.currentMapping=e,this.currentAttributes={},this.currentString=null,this.evaluate(this.expr),this.currentMapping=null,this.currentAttributes=null,this.currentString=null}}});return ExpressionEvaluator}),define("DS/XCityTools/Debug",["UWA/Class","DS/XCityTools/DebugLineChart"],function(e,t){"use strict";var i=function(){this.isActive=!1,this.states=[],this.callbacks={},this.values={},this.logs=[],this.logSize=10,this.logValues=[],this.logCallbacks=[],this.charts=void 0,this.nbLog={},this.maxLog=10,this._privateLog("Debug")};i.prototype={createCharts:function(){this.charts||(this.charts=new t(200,this),window.performance.memory&&this.addCharts("JSmem",function(){return window.performance.memory.usedJSHeapSize/1e6},"#ffffff",window.performance.memory.totalJSHeapSize/1e6))},initialize:function(e,t){if(e){var i=this;this.log=function(){void 0===i.nbLog[arguments]&&(i.nbLog[arguments]=0),i.nbLog[arguments]<i.maxLog&&(i.nbLog[arguments]++,console.log.apply(console,arguments))},this.warn=function(){void 0===i.nbLog[arguments]&&(i.nbLog[arguments]=0),i.nbLog[arguments]<i.maxLog&&(i.nbLog[arguments]++,console.warn.apply(console,arguments))}}t&&this.createCharts()},_privateLog:function(e){this.logs.push(e),this.logs.length>this.logSize&&this.logs.shift()},log:function(){},warn:function(){},error:function(){void 0===this.nbLog[arguments]&&(this.nbLog[arguments]=0),this.nbLog[arguments]<this.maxLog&&(this.nbLog[arguments]++,console.error.apply(console,arguments))},activeCharts:function(e){this.createCharts();var t=document.getElementById("Stats");!0===e?(this.charts.isActive=!0,t.style.display="block"):(this.charts.isActive=!0,t.style.display="none")},addCallback:function(e,t){this.callbacks[e]=t},addCharts:function(e,t,i,r){this.charts.addStates(e,t,r||100,60,i)},getOrCreateLineCharts:function(){return void 0===this.charts&&(this.charts=new UDC.DebugLineChart),this.charts},setValue:function(e,t){this.values[e]=t},logCallback:function(e){this.logCallbacks.push(e)},addStates:function(e,t){void 0!==t?this.states.push({name:e,callback:t}):this.states.push({name:e,callback:this.callbacks[e]})},update:function(e){if(void 0!==this.charts&&this.charts.update(e),this.isActive){var t=document.getElementById("Infos");if(null!==t){for(var i="",r=0;r<this.states.length;r++)if(i+="<br />-------- "+this.states[r].name+" --------","Downloader"===this.states[r].name){let t=this.states[r].callback(e);i+="<br />",i+='<table><tr>\n                            <th style="font-weight: bold; padding-right: 8px">Name</th>\n                            <th style="font-weight: bold; padding-right: 8px">OK</th>\n                            <th style="font-weight: bold; padding-right: 8px">KO</th>\n                            <th style="font-weight: bold; padding-right: 8px">Pending</th>\n                            <th style="font-weight: bold; padding-right: 8px">AvgTime</th>\n                            <th style="font-weight: bold; padding-right: 8px">AvgTTFB</th>\n                            <th style="font-weight: bold; padding-right: 8px">TTFB>500ms</th>\n                            <th style="font-weight: bold; padding-right: 8px">SlowRaster</th>\n                            <th style="font-weight: bold; padding-right: 8px">BlackListed</th>\n                            </tr>',Array.from(t,([e,t])=>{let r="Unknown";if(xCity.widgetData&&xCity.widgetData.datasetCollection){let t=xCity.widgetData.datasetCollection.get(e);r=(r=t&&t.get("name")?t.get("name"):e).substring(0,20)}i+="<tr>",i+='<td style="padding-right: 8px">'+r+"</td>",i+='<td style="padding-right: 8px">'+t.success+"</td>",i+='<td style="padding-right: 8px">'+t.failure+"</td>",i+='<td style="padding-right: 8px">'+Object.keys(t.times).length+"</td>",t.averageTime>500?i+='<td style="color:red; padding-right: 8px">'+t.averageTime.toFixed(0)+"</td>":t.averageTime>250?i+='<td style="color:orange; padding-right: 8px">'+t.averageTime.toFixed(0)+"</td>":i+='<td style="color:green; padding-right: 8px">'+t.averageTime.toFixed(0)+"</td>";let n=Number.isFinite(t.avgTTFB)?t.avgTTFB.toFixed(0):"";t.avgTTFB&&t.avgTTFB>500?i+='<td style="color:red; padding-right: 8px">'+n+"</td>":t.avgTTFB&&t.avgTTFB>200?i+='<td style="color:orange; padding-right: 8px">'+n+"</td>":i+='<td style="color:green; padding-right: 8px">'+n+"</td>",i+='<td padding-right: 8px">'+(Number.isFinite(t.percentTTFBOver500ms)?100*t.percentTTFBOver500ms.toFixed(2)+"%":"")+"</td>",i+='<td style="color:red; font-weight:bold">'+(t.isSlowRasterSlot?"True":"")+"</td>",i+='<td style="color:red; font-weight:bold">'+(t.isBlackListed?"True":"")+"</td>",i+="</tr>"}),i+="</table>"}else i+="<br />"+this.states[r].callback(e);var n=0;for(var o in this.values)this.values.hasOwnProperty(o)&&(0===n&&(i+="<br />--------  Customs Values --------"),i+="<br />"+o+": "+this.values[o],n++);if(this.logCallbacks.length){i+="<br />--------  Customs Callbacks --------";for(r=0;r<this.logCallbacks.length;r++)i+="<br />"+this.logCallbacks[r]+": "+this.callbacks[this.logCallbacks[r]](e)}i+="<br /><br />-------- Console --------";for(r=Math.max(0,this.logs.length-this.logSize);r<this.logs.length;r++)i+="<br />"+this.logs[r];null!==t&&(t.innerHTML=i)}}}};var r=null;return null===r&&(r=new i),r}),define("DS/XCityTools/PrimitiveGeometryCreator",["DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/XCityTools/Debug"],function(e,t,i){"use strict";var r=UWA.Class.extend({init:function(e){this.processPrimitive=!1,this.verticesPerFace=3,this.nbBuffers=0,this.nbPrimitives=0,this.primitiveList=[],this.current=void 0,this.normal=void 0,this.color=void 0,this.texcoord=void 0,this.usercomp=void 0,this.vertexBindingArray=void 0,this.faceBindingArray=void 0,this.primitiveBindingArray=void 0,this.userBindingArray=void 0;var i=function(e,i,r){var n=this.nbBuffers++,o=new t.Buffer;return null!=e?o.component=e:o.indexBuffer=!0,o.format=i,o.dimension=r,o.data=[],o.size=0,{id:n,buffer:o}}.bind(this);this.normalBinding=void 0,this.colorBinding=void 0,this.texCoordBinding=void 0,this.userCompBinding=void 0;var n,o=function(e){switch(e){case r.Binding.FACE:return void 0===this.faceBindingArray&&(this.faceBindingArray=i(void 0,t.DataTypeEnum.UINT,1)),e;case r.Binding.PRIMITIVE:return void 0===this.primitiveBindingArray&&(this.primitiveBindingArray=i(void 0,t.DataTypeEnum.UINT,1)),e;case r.Binding.CUSTOM:return void 0===this.userBindingArray&&(this.userBindingArray=i(void 0,t.DataTypeEnum.UINT,1)),e;case r.Binding.VERTEX:default:return r.Binding.VERTEX}}.bind(this);if(this.position=i(t.VertexComponentEnum.POSITION,t.DataTypeEnum.FLOAT,3),this.indexed=!!e.indexed&&e.indexed,this.vertexBindingArray=i(void 0,t.DataTypeEnum.UINT,1),void 0!==e.useNormal?!0===e.useNormal&&(this.normal=i(t.VertexComponentEnum.NORMAL,t.DataTypeEnum.FLOAT,3),this.normalBinding=o(e.normalBinding)):(this.normal=i(t.VertexComponentEnum.NORMAL,t.DataTypeEnum.FLOAT,3),this.normalBinding=o(e.normalBinding)),e.useColor&&(this.color=i(t.VertexComponentEnum.DIFFUSE_COLOR,t.DataTypeEnum.FLOAT,4),this.colorBinding=o(e.colorBinding)),e.useTexCoord){this.texcoord=[],this.texCoordBinding=[];var s=e.nbTexCoord?e.nbTexCoord:1;for((0===s||s>8)&&(s=1),n=0;n<s;++n)this.texcoord.push(i(t.VertexComponentEnum.TEX_COORD_0+n,t.DataTypeEnum.FLOAT,3)),e.texCoordBinding&&e.texCoordBinding.length?this.texCoordBinding.push(o(e.texCoordBinding[n])):this.texCoordBinding.push(o(e.texCoordBinding))}if(e.useUserComp){this.usercomp=[],this.userCompBinding=[];var a=e.nbUserComp?e.nbUserComp:1;for((0===a||a>8)&&(a=1),n=0;n<a;++n)this.usercomp.push(i(t.VertexComponentEnum.USER_COMPONENT_0+n,t.DataTypeEnum.FLOAT,3)),e.userCompBinding&&e.userCompBinding.length?this.userCompBinding.push(o(e.userCompBinding[n])):this.userCompBinding.push(o(e.userCompBinding))}},_concat:function(e,t){var i;for(i=t.length;i;i--)e.push(t[t.length-i])},pushVertexIndices:function(e){if(this.processPrimitive&&e instanceof Array){var t,i,r,n,o,s;if(this._concat(this.current.vertexBindingArray,e),this.faceBindingArray)for(t=0,i=e.length;t<i;++t)if((r=this.current.nbVertexIndices+t)%this.verticesPerFace==0){for(n=Math.floor(r/this.verticesPerFace),o=[],s=this.verticesPerFace;s--;)o.push(n);this._concat(this.current.faceBindingArray,o)}this.current.nbVertexIndices+=e.length}},pushVertex:function(e){this.processPrimitive&&e instanceof Array&&3===e.length&&(this.indexed||this.pushVertexIndices([this.current.nbVertices]),this.current.position.push(e[0]),this.current.position.push(e[1]),this.current.position.push(e[2]),this.current.nbVertices++)},pushNormal:function(e){this.processPrimitive&&e instanceof Array&&3===e.length&&(this.current.normal.push(e[0]),this.current.normal.push(e[1]),this.current.normal.push(e[2]),this.current.nbNormals++)},pushColor:function(e){this.processPrimitive&&void 0!==this.color&&e instanceof Array&&4===e.length&&(this.current.color.push(e[0]),this.current.color.push(e[1]),this.current.color.push(e[2]),this.current.color.push(e[3]),this.current.nbColors++)},pushTexCoord:function(e,t){this.processPrimitive&&void 0!==this.texcoord&&void 0!==this.texcoord[e]&&t instanceof Array&&(this.current.texcoord[e].push(t[0]),this.current.texcoord[e].push(t[1]),3===t.length?this.current.texcoord[e].push(t[2]):this.current.texcoord[e].push(0))},pushUserComp:function(e,t){this.processPrimitive&&void 0!==this.usercomp&&void 0!==this.usercomp[e]&&t instanceof Array&&(this.current.usercomp[e].push(t[0]),this.current.usercomp[e].push(t[1]),this.current.usercomp[e].push(t[2]))},startPrimitive:function(e){if(!this.processPrimitive){var i,r;if(this.processPrimitive=!0,this.current={},this.current.connectivity=void 0!==e?e:t.ConnectivityTypeEnum.TRIANGLES,this.current.nbVertexIndices=0,this.current.vertexBindingArray=[],this.faceBindingArray&&(this.current.faceBindingArray=[]),this.primitiveBindingArray&&(this.current.primitiveBindingArray=[]),this.userBindingArray&&(this.current.userBindingArray=[]),this.current.nbVertices=0,this.current.position=[],this.current.nbNormals=0,this.current.normal=[],this.color&&(this.current.color=[],this.current.nbColors=0),this.texcoord)for(this.current.texcoord=[],this.current.nbTexcoord=[],i=0,r=this.texcoord.length;i<r;++i)this.current.texcoord.push([]),this.current.nbTexcoord.push(0);if(this.usercomp)for(this.current.usercomp=[],this.current.nbUserComp=[],i=0,r=this.usercomp.length;i<r;++i)this.current.usercomp.push([]),this.current.nbUserComp.push(0)}},endPrimitive:function(e,n){if(this.processPrimitive)if(0!==this.current.nbVertexIndices){var o=function(e,i,n,o){var s=new t.VertexComponent;switch(s.nbValuesPerVertex=i.buffer.dimension,s.component=i.buffer.component,s.format=i.buffer.format,s.nbVertices=n,s.bufferId=i.id,s.offset=i.buffer.size/s.nbValuesPerVertex,o){case r.Binding.FACE:s.indices=new t.IndexArray,s.indices.format=this.faceBindingArray.buffer.format,s.indices.bufferId=this.faceBindingArray.id,s.indices.offset=this.faceBindingArray.buffer.size;break;case r.Binding.PRIMITIVE:s.indices=new t.IndexArray,s.indices.format=this.primitiveBindingArray.buffer.format,s.indices.bufferId=this.primitiveBindingArray.id,s.indices.offset=this.primitiveBindingArray.buffer.size;break;case r.Binding.CUSTOM:s.indices=new t.IndexArray,s.indices.format=this.userBindingArray.buffer.format,s.indices.bufferId=this.userBindingArray.id,s.indices.offset=this.userBindingArray.buffer.size;break;case r.Binding.VERTEX:default:s.indices=new t.IndexArray,s.indices.format=this.vertexBindingArray.buffer.format,s.indices.bufferId=this.vertexBindingArray.id,s.indices.offset=this.vertexBindingArray.buffer.size}e.addVertexComponent(s)}.bind(this),s=1;n&&(s=0);var a,l,u=new t.Primitive;if(u.identifier=void 0===e||""===e?this.nbPrimitives:e,u.nbIndices=this.current.nbVertexIndices,u.connectivity=this.current.connectivity,u.attr={fill:new t.FillAttributes(null,s),line:new t.LineAttributes,point:new t.PointAttributes(new t.Color(1,0,0,1),50)},o(u,this.position,this.current.nbVertices),this.normal&&o(u,this.normal,this.current.nbNormals,this.normalBinding),this.color&&o(u,this.color,this.current.nbColors,this.colorBinding),this.texcoord)for(a=0,l=this.texcoord.length;a<l;++a)o(u,this.texcoord[a],this.current.nbTexcoord[a],this.texCoordBinding[a]);if(this.usercomp)for(this.current.usercomp=[],a=0,l=this.usercomp.length;a<l;++a)o(u,this.usercomp[a],this.current.nbUserComp[a],this.userCompBinding[a]);if(this._concat(this.position.buffer.data,this.current.position),this.position.buffer.size+=this.current.position.length,this.normal&&(this._concat(this.normal.buffer.data,this.current.normal),this.normal.buffer.size+=this.current.normal.length),this.color&&(this._concat(this.color.buffer.data,this.current.color),this.color.buffer.size+=this.current.color.length),this.texcoord)for(a=0,l=this.texcoord.length;a<l;++a)this._concat(this.texcoord[a].buffer.data,this.current.texcoord[a]),this.texcoord[a].buffer.size+=this.current.texcoord[a].length;if(this.usercomp)for(a=0,l=this.usercomp.length;a<l;++a)this._concat(this.usercomp[a].buffer.data,this.current.usercomp[a]),this.usercomp[a].buffer.size+=this.current.usercomp[a].length;if(this._concat(this.vertexBindingArray.buffer.data,this.current.vertexBindingArray),this.vertexBindingArray.buffer.size+=this.current.vertexBindingArray.length,this.faceBindingArray&&(this._concat(this.faceBindingArray.buffer.data,this.current.faceBindingArray),this.faceBindingArray.buffer.size+=this.current.faceBindingArray.length),this.primitiveBindingArray){for(var c=[],d=this.current.nbVertexIndices;d--;)c.push(0);this._concat(this.primitiveBindingArray.buffer.data,c),this.primitiveBindingArray.buffer.size+=this.current.nbVertexIndices}this.userBindingArray&&(this._concat(this.userBindingArray.buffer.data,this.current.userBindingArray),this.userBindingArray.buffer.size+=this.current.userBindingArray.length),this.primitiveList.push(u),this.nbPrimitives++,this.current=void 0,this.processPrimitive=!1}else i.warn("PrimitiveGeometryCreator: Vertex indices is empty.")},compilePrimitive:function(i,r,n){var o=new t.PrimitiveGroup;void 0!==r&&(o.editable=!0),o.name=i;var s,a,l=1;if(n&&(l=0),o.fillAttr=new t.FillAttributes(null,l),o.lineAttr=new t.LineAttributes,o.pointAttr=new t.PointAttributes,this.position.buffer.data=new Float32Array(this.position.buffer.data),this.normal&&(this.normal.buffer.data=new Float32Array(this.normal.buffer.data)),this.color&&(this.color.buffer.data=new Float32Array(this.color.buffer.data)),this.texcoord)for(s=0,a=this.texcoord.length;s<a;++s)this.texcoord[s].buffer.data=new Float32Array(this.texcoord[s].buffer.data);if(this.usercomp)for(s=0,a=this.usercomp.length;s<a;++s)this.usercomp[s].buffer.data=new Float32Array(this.usercomp[s].buffer.data);if(e.supportedExtensions&&e.supportedExtensions.elementIndexUint?(this.vertexBindingArray.buffer.data=new Uint32Array(this.vertexBindingArray.buffer.data),this.faceBindingArray&&(this.faceBindingArray.buffer.data=new Uint32Array(this.faceBindingArray.buffer.data)),this.primitiveBindingArray&&(this.primitiveBindingArray.buffer.data=new Uint32Array(this.primitiveBindingArray.buffer.data)),this.userBindingArray&&(this.userBindingArray.buffer.data=new Uint32Array(this.userBindingArray.buffer.data))):(this.vertexBindingArray.buffer.data=new Uint16Array(this.vertexBindingArray.buffer.data),this.faceBindingArray&&(this.faceBindingArray.buffer.data=new Uint16Array(this.faceBindingArray.buffer.data)),this.primitiveBindingArray&&(this.primitiveBindingArray.buffer.data=new Uint16Array(this.primitiveBindingArray.buffer.data)),this.userBindingArray&&(this.userBindingArray.buffer.data=new Uint16Array(this.userBindingArray.buffer.data))),o.addBuffer(this.position.id,this.position.buffer),this.normal&&o.addBuffer(this.normal.id,this.normal.buffer),this.color&&o.addBuffer(this.color.id,this.color.buffer),this.texcoord)for(s=0,a=this.texcoord.length;s<a;++s)o.addBuffer(this.texcoord[s].id,this.texcoord[s].buffer);if(this.usercomp)for(s=0,a=this.usercomp.length;s<a;++s)o.addBuffer(this.usercomp[s].id,this.usercomp[s].buffer);for(o.addBuffer(this.vertexBindingArray.id,this.vertexBindingArray.buffer),this.faceBindingArray&&o.addBuffer(this.faceBindingArray.id,this.faceBindingArray.buffer),this.primitiveBindingArray&&o.addBuffer(this.primitiveBindingArray.id,this.primitiveBindingArray.buffer),this.userBindingArray&&o.addBuffer(this.userBindingArray.id,this.userBindingArray.buffer),s=this.nbPrimitives;s;s--)o.addPrimitive(this.primitiveList[this.nbPrimitives-s]);return o}});return r.Binding={VERTEX:0,FACE:1,PRIMITIVE:2,CUSTOM:3},r}),define("DS/XCityTools/Pooler",["DS/Visualization/ThreeJS_DS","DS/XCityTools/Debug"],function(e,t){"use strict";var i=function(e){this._objFactory=e,this._objPool=[],this._nextFreeSlot=null};return i.prototype={use:function(){null!=this._nextFreeSlot&&this._nextFreeSlot!=this._objPool.length||this.grow(this._objPool.length||100);var e=this._objPool[this._nextFreeSlot++];return e._globePoolUsed=!0,e},recycle:function(e){e._globePoolUsed&&(null==this._nextFreeSlot||-1==this._nextFreeSlot?(e._globePoolUsed=!1,this._objPool[this._objPool.length]=e):(e._globePoolUsed=!1,this._objPool[--this._nextFreeSlot]=e))},grow:function(e){if(e>0&&null==this._nextFreeSlot&&(this._nextFreeSlot=0),e>0){var t=this._objPool.length;this._objPool.length+=Number(e);for(var i=t;i<this._objPool.length;i++)this._objPool[i]=this._objFactory(),this._objPool[i]._globePool=this}return this._objPool.length},size:function(){return this._objPool.length}},i}),define("DS/XCityTools/EventDispatcher",["DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/Gestures/MouseDownGesture","DS/Gestures/MouseMoveGesture","DS/Gestures/MouseUpGesture","DS/Gestures/MouseOutGesture","DS/Gestures/MouseWheelGesture","DS/Gestures/ClickGesture","DS/Gestures/DoubleClickGesture","DS/Gestures/KeyDownGesture","DS/Gestures/KeyUpGesture","DS/Gestures/TouchGesture","DS/Gestures/ReleaseGesture","DS/Gestures/TapGesture","DS/Gestures/DoubleTapGesture","DS/Gestures/SwipeGesture","DS/Gestures/PinchGesture","DS/Gestures/PanGesture","DS/Gestures/RotateGesture","DS/Gestures/PinchPanRotateGesture","DS/Gestures/HoldGesture","DS/Gestures/LongHoldGesture","DS/Gestures/PinchTapGesture","DS/Gestures/DoublePinchTapGesture","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils"],function(e,t,i,r,n,o,s,a,l,u,c,d,h,f,p,m,v,g,_,x,b,y,w,C,S,P,D){"use strict";var T=function(){this.domElements=[]},M="/3DEXPERIENCity/",A=M+"onDataModelChange:",F=M+"disable.",L="effect";T.prototype={eventsList:{config:M+"onConfig",onStopAnimation:M+"onStopAnimation",onUpdate:M+"onUpdate",onSelect:M+"onSelect",onDeselect:M+"onDeselect",onLoaded:M+"onLoaded",cameraPosition:A+"cameraPosition",date:A+"date",borderChange:A+"borderChange",focusManager:A+"focusManager",manipulatorProfile:A+"manipulatorProfile",performanceProfile:A+"performanceProfile",performanceProfileAdded:A+"performanceProfileAdded",performanceProfileRemoved:A+"performanceProfileRemoved",realisticWater:A+"realisticWater",renderingProfile:A+"renderingProfile",renderingProfileAdded:A+"renderingProfileAdded",renderingProfileRemoved:A+"renderingProfileRemoved",pointOfView:A+"pointOfView",effect:A+L,"effect.sun":A+L+".sun","effect.sun.ambientFactor":A+L+".sun.ambientFactor","effect.sun.diffuseFactor":A+L+".sun.diffuseFactor","effect.dof":A+L+".dof","effect.sslr":A+L+".sslr","effect.ao":A+L+".ao","effect.ao.enable":A+L+".ao.enable","effect.ao.strength":A+L+".ao.strength","effect.ao.angle":A+L+".ao.angle","effect.bloom":A+L+".bloom","effect.bloom.enable":A+L+".bloom.enable","effect.bloom.factor":A+L+".bloom.factor","effect.tone":A+L+".tone","effect.tone.enable":A+L+".tone.enable","effect.tone.gamma":A+L+".tone.gamma","effect.tone.type":A+L+".tone.type","effect.infinitePlane":A+L+".infinitePlane","effect.slab":A+L+".slab","effect.slab.color":A+L+".slab.color","effect.aa":A+L+".aa","effect.normalMap":A+L+".normalMap","effect.specularMap":A+L+".specularMap","effect.roofMode":A+L+".roofMode","effect.shadow":A+L+".shadow","effect.shadow.enable":A+L+".shadow.enable","effect.shadow.visible":A+L+".shadow.visible","effect.shadow.bias":A+L+".shadow.bias","effect.shadow.darkness":A+L+".shadow.darkness","effect.shadow.nbShadowMaps":A+L+".shadow.nbShadowMaps","effect.shadow.resolution":A+L+".shadow.resolution","effect.shadow.boxSize":A+L+".shadow.boxSize","effect.shadow.altitudeOff":A+L+".shadow.altitudeOff","effect.shadow.altitudeOn":A+L+".shadow.altitudeOn","disable.effect.aa":F+L+".aa","disable.effect.ao":F+L+".ao","disable.effect.shadow":F+L+".shadow","disable.effect.bloom":F+L+".bloom","disable.effect.dof":F+L+".dof","disable.effect.sslr":F+L+".sslr","disable.effect.tone":F+L+".tone","disable.effect":F+L,"terrain.terrainAnalyzer":"/3DEXPERIENCity/terrain.terrainAnalyzer","heatmapTool.onChange:numberOfPoint":"/3DEXPERIENCity/heatmapTool.onChange:numberOfPoint"},Initialize:function(e,P){if(-1===this.domElements.indexOf(e)){this.domElements.push(e),t.addGestureRecognizer(new n,document),t.addGestureRecognizer(new a,e),t.addGestureRecognizer(new s,e),t.addGestureRecognizer(new r(i.MouseButton.LEFT),e),t.addGestureRecognizer(new r(i.MouseButton.RIGHT),e),t.addGestureRecognizer(new r(i.MouseButton.WHEEL),e),t.addGestureRecognizer(new r(i.MouseButton.MIDDLE),e),t.addGestureRecognizer(new o(i.MouseButton.LEFT),document),t.addGestureRecognizer(new o(i.MouseButton.RIGHT),document),t.addGestureRecognizer(new o(i.MouseButton.MIDDLE),document);var D=new l(i.MouseButton.LEFT),T=new l(i.MouseButton.MIDDLE),M=new l(i.MouseButton.RIGHT),A=new u(i.MouseButton.LEFT);A.requireGesture(D);var F=new u(i.MouseButton.MIDDLE);F.requireGesture(T);var L=new u(i.MouseButton.RIGHT);L.requireGesture(M),D.maxTime=450,T.maxTime=450,M.maxTime=450,F.maxTime=450,A.maxTime=450,L.maxTime=450,t.addGestureRecognizer(D,e),t.addGestureRecognizer(T,e),t.addGestureRecognizer(M,e),t.addGestureRecognizer(A,e),t.addGestureRecognizer(F,e),t.addGestureRecognizer(L,e),t.addGestureRecognizer(new f,e),t.addGestureRecognizer(new h,e),t.addGestureRecognizer(new v,e),t.addGestureRecognizer(new g,e),t.addGestureRecognizer(new x,e),t.addGestureRecognizer(new y,e),t.addGestureRecognizer(new w,e);var U=new g,I=new _,B=new x;U.maskGesture(I),U.maskGesture(B),I.maskGesture(U),I.maskGesture(B),B.maskGesture(U),B.maskGesture(I),t.addGestureRecognizer(U,e),t.addGestureRecognizer(I,e),t.addGestureRecognizer(B,e),t.addGestureRecognizer(new b,e);var V=new p,N=new m;N.requireGesture(V);var O=new C,E=new S;E.requireGesture(O),t.addGestureRecognizer(V,e),t.addGestureRecognizer(N,e),t.addGestureRecognizer(O,e),t.addGestureRecognizer(E,e),t.addGestureRecognizer(new c),t.addGestureRecognizer(new d),P&&this._debugEvents()}},_debugEvents:function(){this.subscribeTo("/VISU/onKeyDown",function(){P.warn("/VISU/onKeyDown")}),this.subscribeTo("/VISU/onKeyUp",function(){P.warn("/VISU/onKeyUp")}),this.subscribeTo("/VISU/onEdit",function(){P.warn("/VISU/onEdit")}),this.subscribeTo("/VISU/onMouseDown",function(){P.warn("/VISU/onMouseDown")}),this.subscribeTo("/VISU/onMouseOut",function(){P.warn("/VISU/onMouseOut")}),this.subscribeTo("/VISU/onMouseWheel",function(){P.warn("/VISU/onMouseWheel")}),this.subscribeTo("/VISU/onLeftMouseDown",function(){P.warn("/VISU/onLeftMouseDown")}),this.subscribeTo("/VISU/onRightMouseDown",function(){P.warn("/VISU/onRightMouseDown")}),this.subscribeTo("/VISU/onMiddleMouseDown",function(){P.warn("/VISU/onMiddleMouseDown")}),this.subscribeTo("/VISU/onLeftMouseUp",function(){P.warn("/VISU/onLeftMouseUp")}),this.subscribeTo("/VISU/onRightMouseUp",function(){P.warn("/VISU/onRightMouseUp")}),this.subscribeTo("/VISU/onMiddleMouseUp",function(){P.warn("/VISU/onMiddleMouseUp")}),this.subscribeTo("/VISU/onLeftClick",function(){P.warn("/VISU/onLeftClick")}),this.subscribeTo("/VISU/onRightClick",function(){P.warn("/VISU/onRightClick")}),this.subscribeTo("/VISU/onMiddleClick",function(){P.warn("/VISU/onMiddleClick")}),this.subscribeTo("/VISU/onLeftDoubleClick",function(){P.warn("/VISU/onLeftDoubleClick")}),this.subscribeTo("/VISU/onRightDoubleClick",function(){P.warn("/VISU/onRightDoubleClick")}),this.subscribeTo("/VISU/onMiddleDoubleClick",function(){P.warn("/VISU/onMiddleDoubleClick")}),this.subscribeTo("/VISU/onTouch",function(){P.warn("/VISU/onTouch")}),this.subscribeTo("/VISU/onRelease",function(){P.warn("/VISU/onRelease")}),this.subscribeTo("/VISU/onSwipe",function(){P.warn("/VISU/onSwipe")}),this.subscribeTo("/VISU/onTap",function(){P.warn("/VISU/onTap")}),this.subscribeTo("/VISU/onDoubleTap",function(){P.warn("/VISU/onDoubleTap")}),this.subscribeTo("/VISU/onDoublePinchTap",function(){P.warn("/VISU/onDoublePinchTap")}),this.subscribeTo("/VISU/onHold",function(){P.warn("/VISU/onHold")}),this.subscribeTo("/VISU/onLongHold",function(){P.warn("/VISU/onLongHold")}),this.subscribeTo("/VISU/onPan",function(){P.warn("/VISU/onPan")}),this.subscribeTo("/VISU/onPinch",function(){P.warn("/VISU/onPinch")}),this.subscribeTo("/VISU/onRotate",function(){P.warn("/VISU/onRotate")}),this.subscribeTo("/VISU/onPinchPanRotate",function(){P.warn("/VISU/onPinchPanRotate")})},publish:function(t,i,r){e.publish({event:t,data:i,context:r})},unsubscribe:function(t){e.unsubscribe(t)},subscribeTo:function(t,i,r){if(D.is(t))return r?e.subscribeOnce({event:t},i):e.subscribe({event:t},i)},subscribeToBasicEvent:function(e){return this.subscribeTo("/VISU/onBasicEvent",e)},subscribeToMouseWheel:function(e){return this.subscribeTo("/VISU/onMouseDown",e)},subscribeToLeftMouseDown:function(e){return this.subscribeTo("/VISU/onLeftMouseDown",e)},subscribeToRightMouseDown:function(e){return this.subscribeTo("/VISU/onRightMouseDown",e)},subscribeToMiddleMouseDown:function(e){return this.subscribeTo("/VISU/onMiddleMouseDown",e)},subscribeToLeftMouseUp:function(e){return this.subscribeTo("/VISU/onLeftMouseUp",e)},subscribeToRightMouseUp:function(e){return this.subscribeTo("/VISU/onRightMouseUp",e)},subscribeToMiddleMouseUp:function(e){return this.subscribeTo("/VISU/onMiddleMouseUp",e)},subscribeToMouseMove:function(e){return this.subscribeTo("/VISU/onMouseMove",e)},subscribeToMouseOut:function(e){return this.subscribeTo("/VISU/onMouseOut",e)},subscribeToRelease:function(e){t.addEvent(document,"onRelease",e)}};var U=null;return null===U&&(U=new T),U}),define("DS/XCityTools/RenderPassManager",["DS/XCityTools/EventDispatcher","DS/XCityTools/Debug"],function(e,t){"use strict";var i=function(e){this._passes={},this._passesID=[],this._mainComposer=e};return i.prototype={addPass:function(i,r,n,o){if(void 0!==r)if(void 0===this._passes[i]){var s;if(void 0!==n)if(void 0!==n.before){if(void 0===(s=this.getPass(n.before))||void 0!==o&&o!==n.before)return void e.subscribeTo("/RenderPassManager/onNewPassAdded",this.addPass.bind(this,i,r,n),!0);this._mainComposer.insertCustomPassBefore(r,s)}else if(void 0!==n.after){if(void 0===(s=this.getPass(n.after))||void 0!==o&&o!==n.after)return void e.subscribeTo("/RenderPassManager/onNewPassAdded",this.addPass.bind(this,i,r,n),!0);this._mainComposer.insertCustomPassAfterPass(r,s)}else n.pre?this._mainComposer.insertCustomPassBefore(r):this._mainComposer.insertCustomPassAfterPass(r);else this._mainComposer.insertCustomPassAfterPass(r);this._mainComposer.updateComposerContexts(),this._passesID.push(i),this._passes[i]=r,e.publish("/RenderPassManager/onNewPassAdded",i)}else t.warn("A pass with ID '"+i+"' is already defined");else t.warn("Undefined pass: '"+i+"'")},enablePass:function(e){var t=this.getPass(e);if(void 0!==t){var i,r=this._mainComposer.contexts.length;for(i=0;i<r;++i)this._mainComposer.contexts[i].enablePass(t,!0)}},disablePass:function(e){var t=this.getPass(e);if(void 0!==t){var i,r=this._mainComposer.contexts.length;for(i=0;i<r;++i)this._mainComposer.contexts[i].enablePass(t,!1)}},getPass:function(e){return this._passes[e]},getPassList:function(){return this._passesID}},i}),define("DS/XCityTools/ShaderTools",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/ColorGradient","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils","DS/XCityTools/Expression","DS/Shaders/DeferredShaders"],function(e,t,i,r,n,o,s){"use strict";var a=e.singleton({init:function(){r.subscribeTo("/3DEXPERIENCity/onUpdate",this._updateAnimationUniforms.bind(this)),this.animationMaterials={},this.sslrHacked=!1},initialize:function(e){void 0!==e&&e.webglViewer&&(this._GLMaxTextureUnits=e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_TEXTURE_IMAGE_UNITS),this._GLStandardDerivatives=void 0!==e.webglViewer.getRenderer().supportsStandardDerivatives(),this._usePhysical=e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_VERTEX_UNIFORM_VECTORS)>128&&e.webglViewer.getWebGLContext().getParameter(e.webglViewer.getWebGLContext().MAX_FRAGMENT_UNIFORM_VECTORS)>128)},registerAnimationUniforms:function(e,t,i){void 0!==e&&void 0===this.animationMaterials[e.id]&&(this.animationMaterials[e.id]={material:e,uniform:t,callback:i,activated:!1})},unregisterAnimationUniforms:function(e){void 0!==e&&void 0!==this.animationMaterials[e.id]&&delete this.animationMaterials[e.id]},activateAnimationUniforms:function(e){void 0!==e&&void 0!==this.animationMaterials[e.id]&&(this.animationMaterials[e.id].activated=!0)},deactivateAnimationUniforms:function(e){void 0!==e&&void 0!==this.animationMaterials[e.id]&&(this.animationMaterials[e.id].activated=!1)},_updateAnimationUniforms:function(e){if(!this._noAnimation){var t,i,n=Object.keys(this.animationMaterials),o=n.length;for(i=0;i<o;i++){t=n[i];var s=this.animationMaterials[t];s.activated&&(r.publish("/xCity/needRender",this),this.animationMaterials[t].material.isPDSFX()?this.animationMaterials[t].material.updatePDSFXUniform(s.uniform,s.callback(e)):this.animationMaterials[t].material.uniforms[s.uniform].value=s.callback(e))}}},enableAnimations:function(e){this._noAnimation=!e},disableAnimations:function(){this.enableAnimations(!1)},updateSingleUniform:function(e,t,i){e.isPDSFX()?e.updatePDSFXUniform(t,i):e.uniforms&&e.uniforms[t]&&(e.uniforms[t].value=i)},updateCommonUniforms:function(e,t){var r,n={combine:"combine",envMap:"envMap",lightMap:"lightMap",map:"map",normalMap:"normalMap",specularMap:"specularMap",oceanTexture:"oceanTexture"},o=e.uniforms||{};if(e._PDSFXData&&e._PDSFXData.PDSFX&&(o=e._PDSFXData.pdsfxUniforms),null!=o){for(c in n)void 0!==e[c]&&void 0!==o[n[c]]&&e[c]!==o[n[c].value]&&(null!==o[n[c]].value&&void 0!==o[n[c]].value||(t=!0),o[n[c]].value=e[c]);var s,l=a.commonParams;for(r=0;r<l.length;r++)void 0!==e[c=l[r]]&&void 0!==o[c]&&e[c]!==o[c].value&&(o[c].value=e[c]);for(l=a.ColorParams,r=0;r<l.length;r++)void 0!==(s=e[c=l[r]])&&void 0!==o[c]&&(s instanceof i&&(s=s.computeColor()),s!==o[c]&&(o[c].value=s));for(l=a.PdsfxParams,r=0;r<l.length;r++){var u=l[r],c=u[0],d=u[1];void 0!==e[c]&&void 0!==o[d]&&e[c]!==o[d].value&&(o[d].value=e[c])}e.isPDSFX&&e.isPDSFX()&&o.mapCity&&("Custom"!==e.getType()&&(e.map=void 0),o.useMapCity&&o.mapCity.value&&(o.useMapCity.value=!0)),!0===t&&(e.needsUpdate=!0),e.force=!0}},getBaseShaderMaterial:function(e){return this.getCustomShaderMaterial([a.common,a.vertexInformation,a.clipPlanes,a.urbanLights,a.shadowMapCustom],e)},getMapShaderMaterial:function(e){return this.getCustomShaderMaterial([a.common,a.vertexInformation,a.clipPlanes,a.map,a.urbanLights,a.shadowMapCustom],e)},getExistingShaderMaterial:function(e){var i,r=e.toLowerCase();return"ocean"===r||"swim"===r?((i=this.getPDSFXMaterial([a.chunkOcean_PDSFX],this._usePhysical?"physical":"phong")).name=r+"ShaderMaterial",this._usePhysical||i.updatePDSFXUniform("specularOcean",new t.Color("rgb(25,25,25)")),i):"road"===r?((i=this.getPDSFXMaterial([a.atlas_RoadMarking_PDSFX,a.atlas_RoadArea_PDSFX,a.atlas_LawnArea_PDSFX,a.atlas_FootPaths_PDSFX,a.atlas_SideWalkEdges_PDSFX],"physical")).name=r+"ShaderMaterial",i):void 0},getCustomShaderMaterial:function(e,i,r){if(void 0!==e&&e instanceof Array){var o,s,a,l,u,c;for(o=0;o<e.length;++o){if(c=e[o],e.lastIndexOf(c)!==o){e.splice(e.lastIndexOf(c),1),o-=1;break}if(c&&c.depends)for(s=0;s<c.depends.length;++s)if(-1===e.indexOf(c.depends[s])){e.splice(o,0,c.depends[s]),o-=2;break}}var d=[],h=[],f=[],p=[],m=[];for(o=0;o<e.length;++o)d.push(e[o].uniforms),h.push(e[o].vertex_pars),f.push(e[o].vertex),p.push(e[o].fragment_pars),m.push(e[o].fragment);if(i){for(h[0]=h[0]+"\n attribute mat4 instanceMatrix;\n attribute vec4 instanceColor;\n attribute float instanceFlag;\n attribute float instanceIndex;",o=0;o<h.length;++o)h[o]=h[o].replace(/color/g,"instanceColor");for(o=0;o<f.length;++o)f[o]=f[o].replace(/modelMatrix/g,"modelMatrix * instanceMatrix"),f[o]=f[o].replace(/normalMatrix/g,"normalMatrix * mat3(instanceMatrix)"),f[o]=f[o].replace(/color/g,"instanceColor"),f[o]=f[o].replace(/uv2.y/g,"instanceFlag");for(o=0;o<p.length;++o)p[o]=p[o].replace(/color/g,"instanceColor");for(o=0;o<m.length;++o)m[o]=m[o].replace(/modelMatrix/g,"modelMatrix * instanceMatrix"),m[o]=m[o].replace(/normalMatrix/g,"normalMatrix * mat3(instanceMatrix)"),m[o]=m[o].replace(/color/g,"instanceColor")}m.push(t.ShaderChunk.linear_to_gamma_fragment);var v,g,_=Object.assign({},{name:"custom_shader_material",uniforms:t.UniformsUtils.merge(d),vertexShaderPars:h.join("\n"),vertexShaderBody:f.join("\n"),fragmentShaderPars:p.join("\n"),fragmentShaderBody:m.join("\n")},r),x=new t.ShaderMaterialDS(_),b=[];if(n.is(x.uniforms))for(u=(l=Object.keys(x.uniforms)).length,o=0;o<u;o++)v=l[o],void 0!==x.uniforms[v].animation&&b.push({uniform:v,animation:x.uniforms[v].animation});if(b.length>0){for(x.dynamicUpdate=!0,o=0;o<b.length;++o){var y=b[o];this.registerAnimationUniforms(x,y.uniform,y.animation)}x.cloneWithAnim=function(e){var t=e.clone();t.dynamicUpdate=!0;for(var i=0;i<b.length;++i){var r=b[i];this.registerAnimationUniforms(t,r.uniform,r.animation)}return t}.bind(this,x)}for(o=0;o<e.length;++o)if(e[o]){if(n.is(e[o].attributes))for(u=(l=Object.keys(e[o].attributes)).length,g=0;g<u;g++)a=l[g],x[a]=e[o].attributes[a];if(n.is(e[o].vertex_attributes))for(u=(l=Object.keys(e[o].vertex_attributes)).length,g=0;g<u;g++)a=l[g],void 0!==x.attributes&&null!==x.attributes||(x.attributes={}),x.attributes[a]=e[o].vertex_attributes[a]}return x.force=!0,x.enableClipPlanes=!0,x.clone=function(){return this.__proto__.clone.bind(x)()},x}},parsePDSFXShader:function(e,i){if(e instanceof Array)for(var r=0;r<e.length;++r)this.parsePDSFXShader(e[r],i);if(e.depends){var n,o=e.depends.length;for(r=0;r<o;++r)n=e.depends[r],this.parsePDSFXShader(n,i)}if(-1===i.shaderList.indexOf(e.name)||void 0===e.name){for(var s in i.shaderList.push(e.name),e.attributes)i.attributes[s]=e.attributes[s];var a=t.UniformsUtils.clone(e.uniforms);for(var s in a)i.uniforms[s]=a[s];for(var s in e.varyings)i.varyings[s]=e.varyings[s];for(var s in e.VS_global_code&&i.VS_global_code.push(e.VS_global_code),e.FS_global_code&&i.FS_global_code.push(e.FS_global_code),e.VS_overridableFunctions)i.VS_overridableFunctions[s]?i.VS_overridableFunctions[s]+="\n"+e.VS_overridableFunctions[s]:i.VS_overridableFunctions[s]=e.VS_overridableFunctions[s];for(var s in e.FS_overridableFunctions)i.FS_overridableFunctions[s]?i.FS_overridableFunctions[s]+="\n"+e.FS_overridableFunctions[s]:i.FS_overridableFunctions[s]=e.FS_overridableFunctions[s]}},getPDSFXMaterial:function(e,i,r){var o;(o="physical"===i?new t.PhysicalMaterial({force:!0}):"specGloss"===i?new t.PhysicalMaterial({force:!0,specGloss:!0}):"line"===i?new t.LineBasicMaterial({force:!0,lineWidth:10}):"phong"===i?new t.MeshPhongMaterial({force:!0}):"basic"===i?new t.MeshBasicMaterial({force:!0}):new t.PhysicalMaterial({force:!0})).metalness=0,o.roughness=1,o.textureBlending=t.TextureBlendOperations.MODULATE,o.activatePDSFX();var s={ComputeCommonValues:"void ComputeCommonValues() {",ComputeObjectPosition:"vec3 ComputeObjectPosition() {",ComputeObjectFollowingPosition:"vec3 ComputeObjectFollowingPosition() {",ComputeObjectPreviousPosition:"vec3 ComputeObjectPreviousPosition() {",ComputeObjectNormal:"vec3 ComputeObjectNormal() {",ComputeObjectTexCoord0:"vec4 ComputeObjectTexCoord0() {",ComputeObjectTexCoord1:"vec4 ComputeObjectTexCoord1() {",ComputeObjectTexCoord2:"vec4 ComputeObjectTexCoord2() {",ComputeObjectTangent:"vec3 ComputeObjectTangent() {",ComputeObjectBinormal:"vec3 ComputeObjectBinormal() {",ProcessViewTangentSpace:"void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {",ProcessClipSpacePosition:"void ProcessClipSpacePosition(inout vec4 ioPosition) {",ComputePointSize:"float ComputePointSize()",ComputeVaryingValues:"void ComputeVaryingValues() {",ComputeHalfWidth:"float ComputeHalfWidth() {",ProcessLineDistance:"void ProcessLineDistance(inout vec2 lineDistance) {"},a={ComputeCommonValues:"}",ComputeObjectPosition:"}",ComputeObjectFollowingPosition:"}",ComputeObjectPreviousPosition:"}",ComputeObjectNormal:"}",ComputeObjectTexCoord0:"}",ComputeObjectTexCoord1:"}",ComputeObjectTexCoord2:"}",ComputeObjectTangent:"}",ComputeObjectBinormal:"}",ProcessViewTangentSpace:"}",ProcessClipSpacePosition:"}",ComputePointSize:"}",ComputeVaryingValues:"}",ComputeHalfWidth:"}"},l={ComputeCommonValues:"void ComputeCommonValues() {",ComputeDiscard:"bool ComputeDiscard() {",ComputeAlbedo:"vec3 ComputeAlbedo() {",_ComputeDiffuseTexel:"vec4 _ComputeDiffuseTexel() {",ComputeViewPosition:"vec3 ComputeViewPosition() {",ComputeViewNormal:"vec3 ComputeViewNormal() {",ComputeSpecularReflectance:"vec3 ComputeSpecularReflectance() {",ComputeRoughness:"float ComputeRoughness() {",ComputeTransparency:"float ComputeTransparency() {",ComputeEmissive:"vec3 ComputeEmissive() {",ComputeOpacity:"float ComputeOpacity() {",ComputeHalfWidth:"float ComputeHalfWidth() {",ProcessLinePattern:"void ProcessLinePattern(inout float patternValue, in float currentPixelDistance) {",ProcessFinalColor:"void ProcessFinalColor(inout vec4 ioFinalColor) {"},u={ComputeCommonValues:"}",ComputeDiscard:"}",ComputeAlbedo:"return cAlbedo;}",_ComputeDiffuseTexel:"}",ComputeViewPosition:"}",ComputeViewNormal:"}",ComputeSpecularReflectance:"}",ComputeRoughness:"}",ComputeTransparency:"}",ComputeEmissive:"}",ComputeOpacity:"return cOpacity;}",ComputeHalfWidth:"}",ProcessLinePattern:"}",ProcessFinalColor:"}"},c={attributes:{},uniforms:{},varyings:{},VS_global_code:[],FS_global_code:["vec3 cAlbedo = vec3(1.0);","float cOpacity = 1.0;"],VS_overridableFunctions:{},FS_overridableFunctions:{},shaderList:[]};for(var d in this.parsePDSFXShader(e,c),c.VS_global_code=c.VS_global_code.join("\n"),c.FS_global_code=c.FS_global_code.join("\n"),c.VS_overridableFunctions)c.VS_overridableFunctions[d]=s[d]+c.VS_overridableFunctions[d]+a[d];for(var d in c.FS_overridableFunctions)c.FS_overridableFunctions[d]=l[d]+c.FS_overridableFunctions[d]+u[d];for(var d in c.uniforms&&o.setPDSFXUniforms(c.uniforms),c.varyings&&o.setPDSFXVaryings(c.varyings),(c.VS_global_code||c.FS_global_code)&&o.setPDSFXGlobalShaderCode(c.VS_global_code,c.FS_global_code),(c.VS_overridableFunctions||c.FS_overridableFunctions)&&o.setPDSFXOverridableFunctions(c.VS_overridableFunctions,c.FS_overridableFunctions),c.attributes)o[d]=c.attributes[d];var h=[];if(n.is(o._PDSFXData.pdsfxUniforms))for(var f,p=Object.keys(o._PDSFXData.pdsfxUniforms),m=p.length,v=0;v<m;v++)f=p[v],void 0!==o._PDSFXData.pdsfxUniforms[f].animation&&h.push({uniform:f,animation:o._PDSFXData.pdsfxUniforms[f].animation});if(h.length>0){for(v=0;v<h.length;++v){var g=h[v];this.registerAnimationUniforms(o,g.uniform,g.animation)}o.cloneWithAnim=function(e){for(var t=o.clone(),i=0;i<h.length;++i){var r=h[i];this.registerAnimationUniforms(t,r.uniform,r.animation)}return t}.bind(this,o)}return o.clone=function(){return this.__proto__.clone.bind(o)()},o},setPDSFXMaterial:function(e,i,r,o){if(!n.is(e))return null;e.activatePDSFX();var s={ComputeCommonValues:"void ComputeCommonValues() {",ComputeObjectPosition:"vec3 ComputeObjectPosition() {",ComputeObjectFollowingPosition:"vec3 ComputeObjectFollowingPosition() {",ComputeObjectPreviousPosition:"vec3 ComputeObjectPreviousPosition() {",ComputeObjectNormal:"vec3 ComputeObjectNormal() {",ComputeObjectTexCoord0:"vec4 ComputeObjectTexCoord0() {",ComputeObjectTexCoord1:"vec4 ComputeObjectTexCoord1() {",ComputeObjectTexCoord2:"vec4 ComputeObjectTexCoord2() {",ComputeObjectTangent:"vec3 ComputeObjectTangent() {",ComputeObjectBinormal:"vec3 ComputeObjectBinormal() {",ProcessViewTangentSpace:"void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {",ProcessClipSpacePosition:"void ProcessClipSpacePosition(inout vec4 ioPosition) {",ComputePointSize:"float ComputePointSize()",ComputeVaryingValues:"void ComputeVaryingValues() {",ComputeHalfWidth:"float ComputeHalfWidth() {",ProcessLineDistance:"void ProcessLineDistance(inout vec2 lineDistance) {"},a={ComputeCommonValues:"}",ComputeObjectPosition:"}",ComputeObjectFollowingPosition:"}",ComputeObjectPreviousPosition:"}",ComputeObjectNormal:"}",ComputeObjectTexCoord0:"}",ComputeObjectTexCoord1:"}",ComputeObjectTexCoord2:"}",ComputeObjectTangent:"}",ComputeObjectBinormal:"}",ProcessViewTangentSpace:"}",ProcessClipSpacePosition:"}",ComputePointSize:"}",ComputeVaryingValues:"}",ComputeHalfWidth:"}"},l={ComputeCommonValues:"void ComputeCommonValues() {",ComputeDiscard:"bool ComputeDiscard() {",ComputeAlbedo:"vec3 ComputeAlbedo() {",_ComputeDiffuseTexel:"vec4 _ComputeDiffuseTexel() {",ComputeViewPosition:"vec3 ComputeViewPosition() {",ComputeViewNormal:"vec3 ComputeViewNormal() {",ComputeSpecularReflectance:"vec3 ComputeSpecularReflectance() {",ComputeRoughness:"float ComputeRoughness() {",ComputeTransparency:"float ComputeTransparency() {",ComputeEmissive:"vec3 ComputeEmissive() {",ComputeOpacity:"float ComputeOpacity() {",ComputeHalfWidth:"float ComputeHalfWidth() {",ProcessLinePattern:"void ProcessLinePattern(inout float patternValue, in float currentPixelDistance) {",ProcessFinalColor:"void ProcessFinalColor(inout vec4 ioFinalColor) {"},u={ComputeCommonValues:"}",ComputeDiscard:"}",ComputeAlbedo:"return cAlbedo;}",_ComputeDiffuseTexel:"}",ComputeViewPosition:"}",ComputeViewNormal:"}",ComputeSpecularReflectance:"}",ComputeRoughness:"}",ComputeTransparency:"}",ComputeEmissive:"}",ComputeOpacity:"return cOpacity;}",ComputeHalfWidth:"}",ProcessLinePattern:"}",ProcessFinalColor:"}"},c={attributes:{},uniforms:{},varyings:{},VS_global_code:[],FS_global_code:["vec3 cAlbedo = vec3(1.0);","float cOpacity = 1.0;"],VS_overridableFunctions:{},FS_overridableFunctions:{},shaderList:[]};for(var d in this.parsePDSFXShader(i,c),c.VS_global_code=c.VS_global_code.join("\n"),c.FS_global_code=c.FS_global_code.join("\n"),c.VS_overridableFunctions)c.VS_overridableFunctions[d]=s[d]+c.VS_overridableFunctions[d]+a[d];for(var d in c.FS_overridableFunctions)c.FS_overridableFunctions[d]=l[d]+c.FS_overridableFunctions[d]+u[d];for(var d in c.uniforms&&e.setPDSFXUniforms(c.uniforms),c.varyings&&e.setPDSFXVaryings(c.varyings),(c.VS_global_code||c.FS_global_code)&&e.setPDSFXGlobalShaderCode(c.VS_global_code,c.FS_global_code),(c.VS_overridableFunctions||c.FS_overridableFunctions)&&e.setPDSFXOverridableFunctions(c.VS_overridableFunctions,c.FS_overridableFunctions),c.attributes)e[d]=c.attributes[d];e.metalness=0,e.roughness=1,e.textureBlending=t.TextureBlendOperations.MODULATE;var h=[];if(n.is(e._PDSFXData.pdsfxUniforms))for(var f,p=Object.keys(e._PDSFXData.pdsfxUniforms),m=p.length,v=0;v<m;v++)f=p[v],void 0!==e._PDSFXData.pdsfxUniforms[f].animation&&h.push({uniform:f,animation:e._PDSFXData.pdsfxUniforms[f].animation});if(h.length>0){for(v=0;v<h.length;++v){var g=h[v];this.registerAnimationUniforms(e,g.uniform,g.animation)}e.cloneWithAnim=function(t){var i=e.clone();i.reflectionCoef=t.reflectionCoef;for(var r=0;r<h.length;++r){var n=h[r];this.registerAnimationUniforms(i,n.uniform,n.animation)}return i}.bind(this,e)}return e.clone=function(){return this.__proto__.clone.bind(e)()},e}});a.ColorParams=["color","specular","ambient","oceanColor","oceanColorDetection","diffuse"],a.BoolParams=["forceSide","transparent","wireframe","depthTest","depthWrite","enableClipPlanes","generateMipmaps","dynamicUpdate","showOcean"],a.FloatParams=["opacity","alphaTest","reflectivity","refractionRatio","reflectionCoef","opacityFactor","minOpacity","oceanAlpha","oceanRangeDetection"],a.IntParams=["shininess","wireframeLinewidth","r_mode","minWidth","minDist","maxDist","lineWidth"],a.TexParams=["map","wallTextures","roofTextures","envMap","lightMap","normalMap","specularMap","oceanTexture"],a.StringParams=["extrusionHeight"],a.WrapParams=["wrapS","wrapT"],a.FilterParams=["minFilter","magFilter"],a.PdsfxParams=[["map","mapCity"],["diffuse","diffuseCity"],["ambient","ambientCity"],["specular","specularCity"],["opacity","opacityCity"],["alphaTestCity","alphaTestCity"],["dashPattern","dashPatternCity"]],a.commonParams=a.BoolParams.concat(a.FloatParams,a.IntParams,a.FilterParams,a.WrapParams,"blending","side"),a.whiteMap=new t.DataTexture(new Float32Array([1,1,1,1]),1,1,t.RGBAFormat,t.FloatType),a.whiteMap.name="DefaultWhiteTexture",a.whiteMap.flipY=!1,a.whiteMap.minFilter=t.NearestFilter,a.whiteMap.magFilter=t.NearestFilter,a.whiteMap.generateMipmaps=!1,a.whiteMap.needsUpdate=!0,a.whiteMap.shared=1,a.whiteMap.loadEndStatus="complete",a.common={attributes:{},uniforms:t.UniformsLib.common,vertex_pars:"",vertex:[t.ShaderChunk.default_vertex,t.ShaderChunk.worldpos_vertex,t.ShaderChunk.defaultnormal_vertex,"vec3 mvNormal;","if (use_normal_matrix)","mvNormal = normalMatrix * objectNormal;","else ","mvNormal = vec3(viewMatrix * (modelMatrix * vec4(objectNormal, 0.0)));"].join("\n"),fragment_pars:["uniform float opacity;"].join("\n"),fragment:["gl_FragColor = vec4( vec3(1.0), opacity );","#ifdef GAMMA_INPUT","gl_FragColor.rgb *= gl_FragColor.rgb;","#endif"].join("\n")},a.commonWithoutOpacity={attributes:{},uniforms:t.UniformsLib.common,vertex_pars:"",vertex:[t.ShaderChunk.default_vertex,t.ShaderChunk.worldpos_vertex,t.ShaderChunk.defaultnormal_vertex,"vec3 mvNormal;","if (use_normal_matrix)","mvNormal = normalMatrix * objectNormal;","else ","mvNormal = vec3(viewMatrix * (modelMatrix * vec4(objectNormal, 0.0)));"].join("\n"),fragment_pars:["uniform float opacity;"].join("\n"),fragment:["gl_FragColor = vec4( vec3(1.0), 1.0 );","#ifdef GAMMA_INPUT","gl_FragColor.rgb *= gl_FragColor.rgb;","#endif"].join("\n")},a.commonNoNormal={attributes:{},uniforms:t.UniformsLib.common,vertex_pars:"",vertex:[t.ShaderChunk.default_vertex,t.ShaderChunk.worldpos_vertex,"vec3 mvNormal = vec3(0.0,0.0,1.0);"].join("\n"),fragment_pars:["uniform float opacity;"].join("\n"),fragment:["gl_FragColor = vec4( vec3(1.0), opacity );","#ifdef GAMMA_INPUT","gl_FragColor.rgb *= gl_FragColor.rgb;","#endif"].join("\n")};var l={};return l.lines_vertex=["#ifdef USE_DASHEDLINE","   float worldToPixel = abs(projectionMatrix[0][0]/gl_Position.w)*0.5/pixelSize.x;","   vLineDistance = scale * modelMatrix[0][0] * lineDistance * worldToPixel;","#endif","#ifdef USE_WIDELINE","   mvPosition = viewMatrix * (modelMatrix * vec4(position.xyz, 1.0));","   vec4 mvPositionPrec = viewMatrix * (modelMatrix * vec4(previousPos.xyz, 1.0));","   vec4 mvPositionSuiv = viewMatrix * (modelMatrix * vec4(followingPos.xyz, 1.0));","   vec4 pmvPosition = projectionMatrix * mvPosition;","   vec4 pmvPositionPrec = projectionMatrix * mvPositionPrec;","   vec4 pmvPositionSuiv = projectionMatrix * mvPositionSuiv;","","   vec3 eps = vec3(0.0000001);","   bool bPrecCurr = !all(lessThan(abs(pmvPosition.xyz - pmvPositionPrec.xyz), eps));","   bool bCurrNext = !all(lessThan(abs(pmvPositionSuiv.xyz - pmvPosition.xyz), eps));","","   vec3 testClip = vec3(sign(pmvPositionPrec.w + pmvPositionPrec.z), sign(pmvPosition.w + pmvPosition.z), sign(pmvPositionSuiv.w + pmvPositionSuiv.z));","   if (bPrecCurr && testClip.x * testClip.y < 0.0 ){","       float a = (pmvPositionPrec.w + pmvPositionPrec.z)/((pmvPositionPrec.w + pmvPositionPrec.z) - (pmvPosition.w + pmvPosition.z));","       if (testClip.x < 0.0) {","           pmvPositionPrec = (1.0 - a) * pmvPositionPrec + a * pmvPosition;","       } else if (mod(sideExtrusion,2.0) == 1.0) {","           pmvPosition = (1.0 - a) * pmvPositionPrec + a * pmvPosition;","           pmvPositionSuiv = pmvPosition;","           bCurrNext = false;","       }","   }","   if (bCurrNext && testClip.y * testClip.z < 0.0 ){","       float a = (pmvPosition.w + pmvPosition.z)/((pmvPosition.w + pmvPosition.z) - (pmvPositionSuiv.w + pmvPositionSuiv.z));","       if (testClip.z < 0.0) {","           pmvPositionSuiv = (1.0 - a) * pmvPosition + a * pmvPositionSuiv;","       } else if (mod(sideExtrusion,2.0) == 0.0){","           pmvPosition = (1.0 - a) * pmvPosition + a * pmvPositionSuiv;","           pmvPositionPrec = pmvPosition;","           bPrecCurr = false;","       }","   }","","   pmvPosition.y *= pixelSize.x/pixelSize.y;","   pmvPositionPrec.y *= pixelSize.x/pixelSize.y;","   pmvPositionSuiv.y *= pixelSize.x/pixelSize.y;","   pmvPosition /= abs(pmvPosition.w);","   pmvPositionPrec /= abs(pmvPositionPrec.w);","   pmvPositionSuiv /= abs(pmvPositionSuiv.w);","","   float offset = l_fHalfWidth  * pixelSize.x;","   vec2 pos, posPrecCurr, posCurrNext;","   vec2 dirPrecCurr, dirCurrNext;","","   if (bPrecCurr){","       dirPrecCurr = pmvPosition.xy - pmvPositionPrec.xy;","       dirPrecCurr = normalize(dirPrecCurr);","       posPrecCurr = pmvPosition.xy + offset * sign(sideExtrusion) * vec2(-dirPrecCurr.y, dirPrecCurr.x);","   } else if (bCurrNext) {","       dirPrecCurr = pmvPosition.xy - pmvPositionSuiv.xy;","       dirPrecCurr = normalize(dirPrecCurr);","       posPrecCurr = pmvPosition.xy + offset * dirPrecCurr.xy;","   }","","   if (bCurrNext){ //avoid null vector problems","       dirCurrNext = pmvPositionSuiv.xy - pmvPosition.xy;","       dirCurrNext = normalize(dirCurrNext);","       posCurrNext = pmvPosition.xy + offset * sign(sideExtrusion) * vec2(-dirCurrNext.y, dirCurrNext.x);","   } else if (bPrecCurr) {","       dirCurrNext = pmvPosition.xy - pmvPositionPrec.xy;","       dirCurrNext = normalize(dirCurrNext);","       posCurrNext = pmvPosition.xy + offset * dirCurrNext.xy;","   }","","   vec2 dir = normalize(dirCurrNext.xy - dirPrecCurr.xy);","   if ( bPrecCurr && bCurrNext){","       if (abs(dirCurrNext.x - dirPrecCurr.x) < 0.01 && abs(dirCurrNext.y - dirPrecCurr.y) < 0.01){","           dir = vec2(-dirCurrNext.y, dirCurrNext.x);","       }","       float sinAlpha = dir.y * dirPrecCurr.x - dir.x * dirPrecCurr.y;","       if (sign(sinAlpha) == -sign(sideExtrusion) && asin(abs(sinAlpha)) < radians(45.0)) {","           if (mod(sideExtrusion,2.0) == 0.0){","               pos = posCurrNext - offset * dirCurrNext;","           } else {","               pos = posPrecCurr + offset * dirPrecCurr;","           }","       } else {","           float distPoints = min(distance(pmvPosition.xy, pmvPositionPrec.xy), distance(pmvPosition.xy, pmvPositionSuiv.xy)) + offset;","           float dist = offset/ sinAlpha;","           if (max(distPoints, offset) < abs(dist)){","               dist = max(distPoints - offset, offset)*sign(sinAlpha);","               if (sign(sinAlpha) == sign(sideExtrusion)&& asin(abs(sinAlpha)) < radians(45.0/2.0)){","                   if (mod(sideExtrusion,2.0) == 0.0){","                       pos = posCurrNext + dist * dirCurrNext*sign(sideExtrusion);","                   } else {","                       pos = posPrecCurr - dist * dirPrecCurr *sign(sideExtrusion);","                   }","               } else {","                   pos = pmvPosition.xy + dir * max(distPoints, offset) *sign(sinAlpha) *sign(sideExtrusion);","               }","           } else {","               pos = pmvPosition.xy + dir * dist *sign(sideExtrusion);","           }","       }","   } else if(bPrecCurr || bCurrNext) {","       pos = (posCurrNext - pmvPosition.xy)  + posPrecCurr;","   } else {","       pos = pmvPosition.xy + offset;","   }","   #ifdef USE_DASHEDLINE","       vPointAlt = pmvPosition.xy /pixelSize;","       if (sideExtrusion == -2.0){","           vVertexId = vec4(1.0, 1.0, 1.0, 0.0);","       } else if (sideExtrusion == 2.0){","           vVertexId = vec4(0.0, 1.0, 1.0, 1.0);","       } else if (sideExtrusion == -1.0){","           vVertexId = vec4(1.0, 0.0, 1.0, 1.0);","       } else if (sideExtrusion == 1.0){","           vVertexId = vec4(1.0, 1.0, 0.0, 1.0);","       }","       vec4 mvpPositionPrec = projectionMatrix * mvPositionPrec; ","       vec4 mvpPosition = projectionMatrix * mvPosition;","       vec4 mvpPositionSuiv = projectionMatrix * mvPositionSuiv;","       worldToPixel =  modelMatrix[0][0] * abs(projectionMatrix[0][0]/mvpPosition.w)*0.5/pixelSize.x;","       float worldToPixelPrec = modelMatrix[0][0] * abs(projectionMatrix[0][0]/mvpPositionPrec.w)*0.5/pixelSize.x;","       float worldToPixelSuiv = modelMatrix[0][0] * abs(projectionMatrix[0][0]/mvpPositionSuiv.w)*0.5/pixelSize.x;","       if (abs(sideExtrusion) == 1.0 && bPrecCurr){","           vLineDistanceAlt = vLineDistance.y;","           vPointPrec = (mvpPositionPrec.xy / mvpPositionPrec.w + 1.0) / pixelSize;","           vPointCurr = (mvpPosition.xy / mvpPosition.w + 1.0) / pixelSize;","           vLineDistance.x = scale * lineDistance.x * worldToPixelPrec;","           vLineDistance.y = scale * lineDistance.y * worldToPixel;","       } else if (abs(sideExtrusion) == 2.0 && bCurrNext) {","           vLineDistanceAlt = vLineDistance.x;","           vPointPrec = (mvpPosition.xy / mvpPosition.w  + 1.0)/ pixelSize;","           vPointCurr = (mvpPositionSuiv.xy / mvpPositionSuiv.w + 1.0)/ pixelSize;","           vLineDistance.x = scale * lineDistance.x * worldToPixel;","           vLineDistance.y = scale * lineDistance.y * worldToPixelSuiv;","       }","   #endif","","   gl_Position = vec4(pos.x, pos.y* pixelSize.y/pixelSize.x, pmvPosition.zw);","#endif"].join("\n"),a.line={attributes:{blending:t.NormalBlending,transparent:!0},uniforms:t.UniformsUtils.merge([t.UniformsLib.lines,{l_uInfoTexture:{type:"t",value:void 0},l_uUseOpacityFactor:{type:"f",value:0}}]),vertex_pars:[t.ShaderChunk.lines_pars_vertex,"uniform sampler2D l_uInfoTexture;","uniform float l_uUseOpacityFactor;","varying vec4 l_vColor;","varying float l_fHalfWidth;","varying float l_vOpacity;","varying float l_vOpacityFactor;","varying float v_index;","varying float v_nbLine;","varying float l_vPercent;","vec4 getColor(sampler2D texture, float nbColumn, float nbLines, float indice){","vec4 color = vec4(0,0,0,1);","color.r = texture2D( texture, vec2( 0.5/nbColumn, indice/nbLines ) ).x;","color.g = texture2D( texture, vec2( 1.5/nbColumn, indice/nbLines ) ).x;","color.b = texture2D( texture, vec2( 2.5/nbColumn, indice/nbLines ) ).x;","return color;","}"].join("\n"),vertex:[" float l_fpixPerRow = texture2D( l_uInfoTexture, vec2( 0.0, 0.0 ) ).x;"," float l_fnbLines = texture2D( l_uInfoTexture, vec2( 1.5/l_fpixPerRow, 0.0 ) ).x + 1.0;"," float l_fscale = texture2D( l_uInfoTexture, vec2( 2.5/l_fpixPerRow, 0.0 ) ).x;"," float l_findice = (color.r + 1.5);","v_index = l_findice;","v_nbLine = l_fnbLines;"," l_vColor = getColor(l_uInfoTexture, l_fpixPerRow, l_fnbLines, l_findice);"," l_fHalfWidth = texture2D( l_uInfoTexture, vec2( 3.5/l_fpixPerRow, l_findice/l_fnbLines) ).x / 2.0;"," l_vOpacity = texture2D( l_uInfoTexture, vec2( 4.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;"," l_vOpacityFactor = texture2D( l_uInfoTexture, vec2( 5.5/l_fpixPerRow, l_findice/l_fnbLines ) ).x;"," float minDist = texture2D( l_uInfoTexture, vec2( 15.5/l_fpixPerRow, l_findice/l_fnbLines) ).x;"," float maxDist = texture2D( l_uInfoTexture, vec2( 16.5/l_fpixPerRow, l_findice/l_fnbLines) ).x;"," float lineWidth = texture2D( l_uInfoTexture, vec2( 3.5/l_fpixPerRow, l_findice/l_fnbLines) ).x;"," float minWidth = texture2D( l_uInfoTexture, vec2( 17.5/l_fpixPerRow, l_findice/l_fnbLines) ).x;"," mvPosition = viewMatrix * (modelMatrix * vec4(position.xyz, 1.0));"," float dist = length(mvPosition);"," if ( dist < minDist ) { dist = minDist; }"," else if ( dist > maxDist ) { dist = maxDist; }"," float altitudeFactor = (1.0 - min(1.0, (dist - minDist) / (maxDist - minDist)));"," //l_fHalfWidth = floor(lineWidth * altitudeFactor + minWidth * (1.0-altitudeFactor)) / 2.0;",l.lines_vertex," l_vPercent = color.w;"].join("\n"),fragment_pars:[" uniform vec3 diffuse;"," uniform float l_uUseOpacityFactor;"," varying vec4 l_vColor;"," varying float l_vOpacity;"," varying float l_vOpacityFactor;","varying float v_index;","varying float v_nbLine;"," varying float l_vPercent;"].join("\n"),fragment:[t.ShaderChunk.lines_fragment," float l_fmatImgOpacity;"," if(l_uUseOpacityFactor > 0.5){","l_fmatImgOpacity = opacity * l_vOpacity * l_vOpacityFactor;"," }else{","l_fmatImgOpacity = opacity * l_vOpacity;"," }"," gl_FragColor.a = l_fmatImgOpacity;"," #ifdef GAMMA_INPUT","   gl_FragColor.rgb *= l_vColor.rgb * l_vColor.rgb;"," #else","   gl_FragColor.rgb = l_vColor.rgb;"," #endif"].join("\n")},a.clipPlanes={attributes:{},uniforms:t.UniformsLib.clipPlanes,vertex_pars:t.ShaderChunk.clip_pars_vertex,vertex:t.ShaderChunk.clip_vertex,fragment_pars:t.ShaderChunk.clip_pars_fragment,fragment:t.ShaderChunk.clip_fragment},a.alphaTest={attributes:{alphaTest:.5,transparent:!0},uniforms:{alphaTest:{type:"f",value:.5}},vertex_pars:"",vertex:"",fragment_pars:"",fragment:[t.ShaderChunk.alphatest_fragment,"gl_FragColor.a = (opacity);"].join("\n")},a.vertexInformation={uniforms:{},vertex_pars:["varying vec4 vertex_position;","varying vec4 vertex_wPosition;","varying vec4 vertex_vPosition;","varying vec4 vertex_normal;","varying vec4 vertex_wNormal;","varying vec4 vertex_vNormal;","varying vec4 vertex_viewdir;","varying vec4 vertex_vViewdir;","varying float vertex_camDist;"].join("\n"),vertex:["vertex_position = vec4(position, 1.0);","vertex_wPosition = modelMatrix * vertex_position;","vertex_vPosition = viewMatrix * vertex_wPosition;","vertex_normal = normalize(vec4(objectNormal, 0.0));","vertex_wNormal = normalize(modelMatrix * vertex_normal);","if (use_normal_matrix) {","vertex_vNormal = vec4(normalize(normalMatrix * vertex_normal.xyz), 0.0);","} else {","vertex_vNormal = normalize(viewMatrix * vertex_wNormal);","}","vertex_viewdir = vec4(cameraPosition - vertex_wPosition.xyz, 0.0);","vertex_vViewdir = -vertex_vPosition;","vertex_camDist = length(vertex_viewdir);"].join("\n"),fragment_pars:["varying vec4 vertex_position;","varying vec4 vertex_wPosition;","varying vec4 vertex_vPosition;","varying vec4 vertex_normal;","varying vec4 vertex_wNormal;","varying vec4 vertex_vNormal;","varying vec4 vertex_viewdir;","varying vec4 vertex_vViewdir;","varying float vertex_camDist;"].join("\n"),fragment:""},a.vertexColor={attributes:{vertexColors:!0},uniforms:{},vertex_pars:t.ShaderChunk.color_pars_vertex,vertex:t.ShaderChunk.color_vertex,fragment_pars:t.ShaderChunk.color_pars_fragment,fragment:t.ShaderChunk.color_fragment},a.map={attributes:{},uniforms:{map:{type:"t",value:a.whiteMap}},vertex_pars:t.ShaderChunk.map_pars_vertex,vertex:t.ShaderChunk.map_vertex,fragment_pars:t.ShaderChunk.map_pars_fragment,fragment:[t.ShaderChunk.uvmapping_fragment,t.ShaderChunk.map_fragment,"#define USE_UV_MAPS","vec2 maps_UVcoord = vec2(0.0);","#ifdef USE_MAP","maps_UVcoord = vUv;","#endif"].join("\n")},a.mapDebug={depends:[a.map],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = texelColor;","return;"].join("\n")},a.normalMap={attributes:{normalMap:a.whiteMap},uniforms:{normalMap:{type:"t",value:void 0},use_normalMap:{type:"i",value:0}},vertex_pars:"",vertex:"",fragment_pars:["uniform sampler2D normalMap;","uniform int use_normalMap;","vec3 value_normalMap;"].join("\n"),fragment:["#ifdef USE_UV_MAPS","#define USE_NORMAL_MAP","if( use_normalMap > 0 ) {","value_normalMap = normalize( texture2D( normalMap, maps_UVcoord ).rgb * 2.0 - 1.0 );","} else {","value_normalMap = vec3(0.0,0.0,0.0);","}","#endif"].join("\n")},a.normalMapDebug={depends:[a.normalMap],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4(value_normalMap, 1.0);","return;"].join("\n")},a.specularMap={attributes:{specularMap:a.whiteMap},uniforms:{specularMap:{type:"t",value:void 0},use_specularMap:{type:"i",value:0}},vertex_pars:"",vertex:"",fragment_pars:["uniform sampler2D specularMap;","uniform int use_specularMap;","vec3 value_specularMap;"].join("\n"),fragment:["#ifdef USE_UV_MAPS","#define USE_SPECULAR_MAP","if( use_specularMap > 0 ) {","value_specularMap = texture2D( specularMap, maps_UVcoord ).rgb;","} else {","value_specularMap = specular;","}","#endif"].join("\n")},a.specularMapDebug={depends:[a.specularMap],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4(value_specularMap, 1.0);","return;"].join("\n")},a.urbanLights={depends:[a.vertexInformation],attributes:{lights:!0},uniforms:t.UniformsUtils.merge([t.UniformsLib.lights,{shininess:{type:"f",value:2},specular:{type:"c",value:new t.Color(16777215)},ambient:{type:"c",value:new t.Color(16777215)}}]),vertex_pars:"",vertex:"",fragment_pars:[t.ShaderChunk.lights_lambert_pars_vertex,"uniform float shininess;","uniform vec3 specular;","vec3 diffuse_value = diffuse;","vec3 ambient_value = ambient;","float opacity_value = opacity;"].join("\n"),fragment:["vec3 tmp = vec3(0.0);","vec3 light_t = vec3(0.0);","vec3 light_b = vec3(0.0);","vec3 light_dir = vec3(0.0);","vec3 light_viewdir = vec3(0.0);","vec3 light_diffuse = vec3(0.0);","vec3 light_specular = vec3(0.0);","float light_shininess = shininess == 0.0 ? 1.0 : shininess;","vec3 light_normal_value = vertex_wNormal.xyz;","#ifdef USE_NORMAL_MAP","if( value_normalMap != vec3(0.0) ) {","light_normal_value = value_normalMap;","vec3 light_c1 = cross(vertex_wNormal.xyz, vec3(0.0, 0.0, 1.0));","vec3 light_c2 = cross(vertex_wNormal.xyz, vec3(0.0, 1.0, 0.0));","if( length(light_c1)>length(light_c2) )","light_t = normalize( light_c1 );","else","light_t = normalize( light_c2 );","light_b = normalize( cross(vertex_wNormal.xyz, light_t) );","}","#endif","vec3 light_specular_value = specular;","#ifdef USE_SPECULAR_MAP","light_specular_value = value_specularMap;","#endif","light_viewdir = normalize(vertex_viewdir.xyz);","#ifdef USE_NORMAL_MAP","if( value_normalMap != vec3(0.0) ) {","tmp.x = dot( vertex_viewdir.xyz, light_t );","tmp.y = dot( vertex_viewdir.xyz, light_b );","tmp.z = dot( vertex_viewdir.xyz, vertex_wNormal.xyz );","light_viewdir = normalize( tmp );","}","#endif","#if MAX_DIR_LIGHTS > 0","light_dir = normalize( directionalLightDirection[0] );","#ifdef USE_NORMAL_MAP","if( value_normalMap != vec3(0.0) ) {","tmp.x = dot( light_dir, light_t );","tmp.y = dot( light_dir, light_b );","tmp.z = dot( light_dir, vertex_wNormal.xyz );","light_dir = normalize( tmp );","}","#endif","light_diffuse += directionalLightColor[0] * diffuse_value * max( dot( light_dir, light_normal_value ), 0.0);","light_specular += directionalLightColor[0] * light_specular_value * pow( max( 0.0, dot( reflect(-light_dir, light_normal_value ), light_viewdir ) ), light_shininess );","vec3 totalDiffuse = vec3( dot( light_dir, light_normal_value ),0.0,0.0) ;","#endif","#if MAX_POINT_LIGHTS > 0","light_dir = normalize( pointLightPosition[ 0 ] - vertex_wPosition.xyz );","#ifdef USE_NORMAL_MAP","if( value_normalMap != vec3(0.0) ) {","tmp.x = dot( light_dir, light_t );","tmp.y = dot( light_dir, light_b );","tmp.z = dot( light_dir, vertex_wNormal.xyz );","light_dir = normalize( tmp );","}","#endif","light_diffuse += pointLightColor[0] * diffuse_value * max( dot( light_dir, light_normal_value ), 0.0);","light_specular += pointLightColor[0] * light_specular_value * pow( max(0.0, dot( reflect(-light_dir, light_normal_value ), light_viewdir ) ), light_shininess );","#endif","gl_FragColor.rgb = light_specular + gl_FragColor.rgb * clamp(ambientLightColor*ambient_value+light_diffuse, 0.0, 2.0);","gl_FragColor.a = opacity_value;"].join("\n")},a.urbanLightsDebugDiffuse={depends:[a.urbanLights],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4(light_diffuse, 1.0);","return;"].join("\n")},a.urbanLightsDebugSpecular={depends:[a.urbanLights],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4(light_specular, 1.0);","return;"].join("\n")},a.xCityLights={depends:[a.vertexInformation],attributes:{lights:!0},uniforms:t.UniformsUtils.merge([t.UniformsLib.lights,{shininess:{type:"f",value:30},specular:{type:"c",value:new t.Color(16777215)},emissive:{type:"c",value:new t.Color(0)},ambient:{type:"c",value:new t.Color(16777215)}}]),vertex_pars:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;",t.ShaderChunk.lights_phong_pars_vertex].join("\n"),vertex:["vNormal = vertex_vNormal.xyz;","vViewPosition = vertex_vViewdir.xyz;","worldPosition = vertex_wPosition;",t.ShaderChunk.lights_phong_vertex].join("\n"),fragment_pars:["uniform vec3 diffuse;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","float specularStrength = 1.0;",t.ShaderChunk.lights_phong_pars_fragment].join("\n"),fragment:["float shininessValue = shininess;",t.ShaderChunk.lights_phong_fragment].join("\n")},a.xCityEnvMap={depends:[a.xCityLights],attributes:{envMap:!0},uniforms:{},vertex_pars:t.ShaderChunk.envmap_pars_vertex,vertex:[t.ShaderChunk.envmap_vertex,"#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP ) && ! defined( PHYSICALDS )","#ifdef DOUBLE_SIDED","vReflect = vertex_wPosition.xyz;","#endif","#endif"].join("\n"),fragment_pars:t.ShaderChunk.envmap_pars_fragment,fragment:["vec3 vWorldPosition = vertex_wPosition.xyz;","#ifdef USE_ENVMAP","vec3 reflectVec;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","vec3 worldNormal = normalize( vec3( vec4( normal, 0.0 ) * viewMatrix ) );","if ( useRefract ) {","#if defined( USE_REFRACTIONRATIOMAP )","reflectVec = refract( cameraToVertex, worldNormal, texture2D(refractionRatioMap, uvToUse).r );","#else","reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );","#endif","} else { ","reflectVec = reflect( cameraToVertex, worldNormal );","}","#else","reflectVec = vReflect;","#endif","reflectVec = vec3(-reflectVec.x, reflectVec.zy);","vec3 flipReflectVec;","#ifdef DOUBLE_SIDED","float flipNormal = 1.0;","flipReflectVec = flipNormal * reflectVec;","#else","flipReflectVec = reflectVec;","#endif","#if defined( USE_LIGHTPROBEMAP ) || defined( USE_LATLONGMAP )","#ifdef USE_LIGHTPROBEMAP","flipReflectVec = vec3(flipReflectVec.y, flipReflectVec.z, flipReflectVec.x);","float probeR = INV_PI * acos( flipReflectVec.z ) / length(flipReflectVec.xy);","#ifdef USE_ENVMAP_HDR","vec2 texelSizeEnvMap = vec2(1.0 / envMapHDRSize);","vec4 cubeColor = texture2DBilinearFromRGBE( envMap, 0.5 * (probeR * flipReflectVec.xy + 1.0), envMapHDRSize, texelSizeEnvMap );","#else","vec4 cubeColor = texture2D( envMap, 0.5 * (probeR * flipReflectVec.xy + 1.0) );","#endif","#else","float phi = atan(flipReflectVec.y, flipReflectVec.x) + offsetPhi;","float theta = acos(flipReflectVec.z);","#ifdef USE_ENVMAP_HDR","vec2 texelSizeEnvMap = vec2(1.0 / envMapHDRSize);","vec4 cubeColor = envMapExposure * texture2DBilinearFromRGBE( envMap, vec2(0.5 + 0.5 * INV_PI * phi, 1.0 - INV_PI * theta), envMapHDRSize, texelSizeEnvMap );","#else","vec4 cubeColor = envMapExposure * texture2D( envMap, vec2(0.5 + 0.5 * INV_PI * phi, 1.0 - INV_PI * theta) );","#endif","#endif","#else","vec4 cubeColor = textureCube( envMap, flipReflectVec );","#endif","if ( combine == 1 ) {","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );","} else if ( combine == 2 ) {","gl_FragColor.xyz += cubeColor.xyz * specularStrength * reflectivity;","} else {","gl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );","}","#endif"].join("\n")},a.shadowMapCustom={depends:[],attributes:{},uniforms:t.UniformsLib.shadowmap,vertex_pars:t.ShaderChunk.shadowmap_pars_vertex,vertex:["#ifdef USE_SHADOWMAP","#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined( PHYSICALDS ) || defined ( USE_SHADOWMAP )","#ifdef USE_SKINNING","vec4 oldPosition = skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 oldPosition = vec4( morphed, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 oldPosition = vec4( position, 1.0 );","#endif","#endif","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[i]*oldPosition;// + 5.5*vec4(normal,1.0));","}","#endif"].join("\n"),fragment_pars:t.ShaderChunk.shadowmap_pars_fragment,fragment:["#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_DEBUG","vec3 frustumColors[3];","frustumColors[0] = vec3( 1.0, 0.5, 0.0 );","frustumColors[1] = vec3( 0.0, 1.0, 0.8 );","frustumColors[2] = vec3( 0.0, 0.5, 1.0 );","#endif","#ifdef SHADOWMAP_CASCADE","int inFrustumCount = 0;","#endif","float fDepth;","vec3 shadowColor = vec3( 1.0 );","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","#ifdef SHADOWMAP_CASCADE","bvec2 inFrustumAndZVec = bvec2(inFrustum, shadowCoord.z <= 1.0);","bool inFrustumAndZ = all(inFrustumAndZVec);","inFrustumCount += int( inFrustumAndZ );","bvec2 frustumTestVec = bvec2( inFrustumAndZ, inFrustumCount == 1 );","#else","bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","#endif","bool frustumTest = all( frustumTestVec );","if ( frustumTest ) {","shadowCoord.z += shadowBias[ i ];","float dv = 1.0;","#if MAX_DIR_LIGHTS > 0","#ifdef PHONG","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ 0 ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","dv =  abs(dot(  dirVector, normal ));","#else","dv = abs(totalDiffuse.x);","#endif","#endif","#if defined( SHADOWMAP_TYPE_PCF )","float shadow = 0.0;","const float shadowDelta = 1.0 / 9.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.25 * xPixelOffset;","float dy0 = -1.25 * yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float shadow = 0.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.0 * xPixelOffset;","float dy0 = -1.0 * yPixelOffset;","float dx1 = 1.0 * xPixelOffset;","float dy1 = 1.0 * yPixelOffset;","mat3 shadowKernel;","mat3 depthKernel;","depthKernel[0][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","if ( depthKernel[0][0] < shadowCoord.z ) shadowKernel[0][0] = 0.25;","else shadowKernel[0][0] = 0.0;","depthKernel[0][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","if ( depthKernel[0][1] < shadowCoord.z ) shadowKernel[0][1] = 0.25;","else shadowKernel[0][1] = 0.0;","depthKernel[0][2] = unpackDepth( texture2D( shadowMap[ i], shadowCoord.xy + vec2( dx0, dy1 ) ) );","if ( depthKernel[0][2] < shadowCoord.z ) shadowKernel[0][2] = 0.25;","else shadowKernel[0][2] = 0.0;","depthKernel[1][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","if ( depthKernel[1][0] < shadowCoord.z ) shadowKernel[1][0] = 0.25;","else shadowKernel[1][0] = 0.0;","depthKernel[1][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","if ( depthKernel[1][1] < shadowCoord.z ) shadowKernel[1][1] = 0.25;","else shadowKernel[1][1] = 0.0;","depthKernel[1][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","if ( depthKernel[1][2] < shadowCoord.z ) shadowKernel[1][2] = 0.25;","else shadowKernel[1][2] = 0.0;","depthKernel[2][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","if ( depthKernel[2][0] < shadowCoord.z ) shadowKernel[2][0] = 0.25;","else shadowKernel[2][0] = 0.0;","depthKernel[2][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","if ( depthKernel[2][1] < shadowCoord.z ) shadowKernel[2][1] = 0.25;","else shadowKernel[2][1] = 0.0;","depthKernel[2][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","if ( depthKernel[2][2] < shadowCoord.z ) shadowKernel[2][2] = 0.25;","else shadowKernel[2][2] = 0.0;","vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowMapSize[i].xy );","shadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );","shadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );","vec4 shadowValues;","shadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );","shadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );","shadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );","shadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );","shadow = dot( shadowValues, vec4( 1.0 ) );","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#else","vec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );","float fDepth = unpackDepth( rgbaDepth );","if (  directionalLightDirection[ 0 ].z < 0.0 || dv < 0.1 || fDepth < shadowCoord.z )","   shadowColor =  vec3( 1.0 -  shadowDarkness[ i ]);","#endif","}","#ifdef SHADOWMAP_DEBUG","#ifdef SHADOWMAP_CASCADE","if ( frustumTest ) gl_FragColor.xyz *= frustumColors[ i ];","#else","if ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];","#endif","#endif","}","#ifdef GAMMA_OUTPUT","shadowColor = sqrt( shadowColor );","#endif","#if !defined(IGNORE_SHADOW_COEFF)","gl_FragColor.xyz = gl_FragColor.xyz * shadowColor;","#endif","#endif"].join("\n")},a.shadowMap={attributes:{},uniforms:t.UniformsLib.shadowmap,vertex_pars:t.ShaderChunk.shadowmap_pars_vertex,vertex:t.ShaderChunk.shadowmap_vertex,fragment_pars:t.ShaderChunk.shadowmap_pars_fragment,fragment:t.ShaderChunk.shadowmap_fragment},a.shadowMapDebug={depends:[a.shadowMapCustom],attributes:{},uniforms:{},vertex_pars:"",vertex:"",fragment_pars:"",fragment:["gl_FragColor.rgba = vec4( shadowColor, 1.0 );","return;"].join("\n")},a.tileMapping={depends:[a.vertexInformation,a.map],attributes:{},uniforms:{bbox_min:{type:"v2",value:new t.Vector2(0,0)},bbox_max:{type:"v2",value:new t.Vector2(0,0)}},vertex_pars:["uniform vec2 bbox_min;","uniform vec2 bbox_max;"].join("\n"),vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ROUGHNESSMAP )","   float u = clamp((vertex_wPosition.x - bbox_min.x)/(bbox_max.x - bbox_min.x),0.0,1.0);","   float v = clamp((vertex_wPosition.y - bbox_min.y)/(bbox_max.y - bbox_min.y),0.0,1.0);","   vUv = vec2(u, v);","#endif"].join("\n"),fragment_pars:"",fragment:""},a.atlas_PDSFX={name:"atlas_PDSFX",attributes:{},uniforms:{mapCity:{type:"t2",value:a.whiteMap}},varyings:{vertexPos_world:{type:"v2"},vertexColorR:{type:"f"},vertexColorG:{type:"f"},vertexColorB:{type:"f"}},VS_overridableFunctions:{ComputeObjectTexCoord0:["return vGetAttribTexCoord0();"].join("\n"),_ComputeObjectTexCoord1:["vec4 tCoord1 = vec4(vertexPos_world.x, vertexPos_world.y, 0.0, 0.0);","return tCoord1;"].join("\n"),ComputeVaryingValues:["vertexPos_world = vec3(modelMatrix * vec4(ComputeObjectPosition(), 1.0)).xy;","vertexColorR = vGetAttribColor().r;","vertexColorG = vGetAttribColor().g;","vertexColorB = vGetAttribColor().b;"].join("\n")},FS_global_code:["vec4 _texelCity;","#define CITY_HACK_VERTEXCOLOR 1","float atlas_size = 2048.0;","float atlas_borderSize = 5.0;","vec2 atlas_getStartOffset(float posX, float posY) {","return vec2(posX + (atlas_borderSize / atlas_size), posY + (atlas_borderSize / atlas_size));","}","float atlas_getSizeInAtlas(float size) {","return (size - (2.0 * (atlas_borderSize / atlas_size)));","}"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["vec3 vertexColor = vec3(vertexColorR, vertexColorG, vertexColorB);","vec3 hdRoad_color = vec3(0.0);","#if defined (ATLAS_ROAD)","hdRoad_color = atlas_road(hdRoad_color, vertexColor);","#endif","#if defined (ATLAS_ROAD_MARKING)","hdRoad_color = atlas_road_marking(hdRoad_color, vertexColor);","#endif","#if defined (ATLAS_LAWN)","hdRoad_color = atlas_lawn(hdRoad_color, vertexColor);","#endif","#if defined (ATLAS_FOOTPATH)","hdRoad_color = atlas_footpath(hdRoad_color, vertexColor);","#endif","#if defined (ATLAS_SIDEWALKEDGES)","hdRoad_color = atlas_sidewalkedges(hdRoad_color, vertexColor);","#endif","_texelCity = vec4(hdRoad_color, 1.0);",""].join("\n"),ComputeAlbedo:["return sqrt(_texelCity.xyz);","return _DSalbedo_ / vec3(vertexColorR, vertexColorG, vertexColorB);"].join("\n"),__ComputeRoughness:["return 1.0;"].join("\n"),__ProcessFinalColor:["ioFinalColor.xyz = ComputeAlbedo();"].join("\n")}},a.atlas_RoadArea_PDSFX={name:"atlas_RoadArea_PDSFX",depends:[a.atlas_PDSFX],FS_global_code:["#define ATLAS_ROAD","vec3 atlas_road(vec3 color, vec3 vertexColor) {","float ra_colorDiff = length(vertexColor.rgb - vec3(0.0, 0.0, 1.0));","vec3 ra_color = color;","if (abs(ra_colorDiff) < 0.1) {","vec2 ra_startOffset = atlas_getStartOffset(0.5, 0.5);","float ra_texSize = atlas_getSizeInAtlas(0.5);","vec4 ra_noiseColor = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 0.05, ra_texSize) + ra_startOffset);","float ra_noise = clamp((mix(-40.0, 40.0, ra_noiseColor.r) + length(vGetViewPosition()) - 20.0) / 40.0, 0.0, 1.0);","ra_startOffset = atlas_getStartOffset(0.0, 0.25);","ra_texSize = atlas_getSizeInAtlas(0.25);","vec4 ra_mixteColor005 = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 0.05, ra_texSize) + ra_startOffset);","vec4 ra_mixteColor025 = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 0.25, ra_texSize) + ra_startOffset);","vec4 ra_mixteColor050 = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 0.50, ra_texSize) + ra_startOffset);","vec4 ra_mixteColor200 = texture2D(mapCity, mod(vertexPos_world.xy * ra_texSize * 2.00, ra_texSize) + ra_startOffset);","float ra_mul = pow(pow(ra_mixteColor025.r * ra_mixteColor050.r, 0.5) * ra_mixteColor005.g, 0.5);","vec3 ra_mix1 = mix(vec3(0.07), vec3(0.4), ra_mul);","vec3 ra_mix2 = mix(vec3(0.07), vec3(0.4), ra_mul * ra_mixteColor200.b);","ra_color = mix(ra_mix2, ra_mix1, ra_noise);","//ra_color = vec3(0.0,0.0,1.0);","}","return ra_color;","}"].join("\n")},a.atlas_RoadMarking_PDSFX={name:"atlas_RoadMarking_PDSFX",depends:[a.atlas_PDSFX],FS_global_code:["#define ATLAS_ROAD_MARKING","vec3 atlas_road_marking(vec3 color, vec3 vertexColor) {","float rm_colorDiff1 = length(vertexColor.rgb - vec3(1.0, 0.0, 0.0));","float rm_colorDiff2 = length(vertexColor.rgb - vec3(0.0, 1.0, 0.0));","vec3 rm_color = color;","if ((abs(rm_colorDiff1) < 0.1) || (abs(rm_colorDiff2) < 0.1)) {","if (abs(rm_colorDiff1) < 0.1) {","rm_color = vec3(0.9);","} else if (abs(rm_colorDiff2) < 0.1) {","rm_color = vec3(0.985, 0.673, 0.136);","}","vec2 rm_startOffset = atlas_getStartOffset(0.25, 0.25);","float rm_texSize = atlas_getSizeInAtlas(0.25);","rm_color *= texture2D(mapCity, mod(vertexPos_world.xy * rm_texSize * 0.50, rm_texSize) + rm_startOffset).rgb;","rm_color *= texture2D(mapCity, mod(vertexPos_world.xy * rm_texSize * 0.25, rm_texSize) + rm_startOffset).rgb;","//rm_color = vec3(1.0,0.0,0.0);","}","return rm_color;","}"].join("\n")},a.atlas_LawnArea_PDSFX={name:"atlas_LawnArea_PDSFX",depends:[a.atlas_PDSFX],FS_global_code:["#define ATLAS_LAWN","vec3 atlas_lawn(vec3 color, vec3 vertexColor) {","vec3 lawn_color = color;","float la_colorDiff = length(vertexColor.rgb - vec3(1.0, 1.0, 0.0));","if (abs(la_colorDiff) < 0.1) {","vec2 la_startOffset = atlas_getStartOffset(0.5, 0.5);","float la_texSize = atlas_getSizeInAtlas(0.5);","vec4 la_noiseColor = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.05, la_texSize) + la_startOffset);","float la_noise = clamp((mix(-40.0, 40.0, la_noiseColor.r) + length(vGetViewPosition()) - 20.0) / 40.0, 0.0, 1.0);","la_startOffset = atlas_getStartOffset(0.0, 0.0);","la_texSize = atlas_getSizeInAtlas(0.25);","vec4 la_herb_Color_g = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.25, la_texSize) + la_startOffset);","vec4 la_herb_Color = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.05, la_texSize) + la_startOffset);","#ifdef GAMMA_INPUT","la_herb_Color_g *= la_herb_Color_g;","la_herb_Color *= la_herb_Color;","#endif","la_startOffset = atlas_getStartOffset(0.0, 0.5);","la_texSize = atlas_getSizeInAtlas(0.5);","float la_varColor1 = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.003, la_texSize) + la_startOffset).r;","float la_varColor2 = texture2D(mapCity, mod(vertexPos_world.xy * la_texSize * 0.0025, la_texSize) + la_startOffset).r;","#ifdef GAMMA_INPUT","la_varColor1 *= la_varColor1;","la_varColor2 *= la_varColor2;","#endif","vec4 la_mul_Dead = vec4(0.9, 0.7, 0.3, 1) * la_herb_Color_g.g;","vec4 la_mul_Base = vec4(0.4, 0.45, 0.25, 3) * la_herb_Color_g;","vec4 la_mixColor = mix(la_herb_Color, vec4(0.02, 0.04, 0.01,1), 0.7);","vec4 la_mix1 = mix(la_mul_Dead, la_mul_Base, clamp(mix(0.25, 2.0, la_varColor1), 0.0, 1.0));","vec4 la_mix2 = mix(la_mix1, la_mixColor, la_varColor2);","lawn_color = mix(la_mix1, la_mix2, la_noise).xyz;","//lawn_color = vec3(0.0,1.0,0.0);","}","return lawn_color;","}"].join("\n")},a.atlas_FootPaths_PDSFX={name:"atlas_FootPaths_PDSFX",depends:[a.atlas_PDSFX],FS_global_code:["#define ATLAS_FOOTPATH","vec3 atlas_footpath(vec3 color, vec3 vertexColor) {","float fp_colorDiff = length(vertexColor.rgb - vec3(1.0, 0.0, 1.0));","vec3 fp_color = color;","if (abs(fp_colorDiff) < 0.1) {","float marge = 66.0/2048.0;","vec2 fp_startOffset = atlas_getStartOffset(0.5+marge, 0.0+marge);","float fp_texSize = atlas_getSizeInAtlas(0.25-(marge*2.0));","vec3 fp_texColor1 = texture2D(mapCity, mod(vertexPos_world.xy * fp_texSize, fp_texSize) + fp_startOffset).rgb;","vec3 fp_texColor2 = texture2D(mapCity, mod(vertexPos_world.xy * fp_texSize * 0.5, fp_texSize) + fp_startOffset).rgb;","#ifdef GAMMA_INPUT","fp_texColor1 *= fp_texColor1;","fp_texColor2 *= fp_texColor2;","#endif","float fp_varColor1 = texture2D(mapCity, mod(vertexPos_world.xy * fp_texSize * 0.8, fp_texSize)+ fp_startOffset).w;","fp_startOffset = atlas_getStartOffset(0.0, 0.5);","fp_texSize = atlas_getSizeInAtlas(0.5);","float fp_varColor2 = texture2D(mapCity, mod(vertexPos_world.xy * fp_texSize * 0.015, fp_texSize) + fp_startOffset).r;","fp_color = mix(4.0, 4.0, fp_varColor1) * mix(0.9, 1.3, fp_varColor2) * fp_texColor1 * fp_texColor2;","//fp_color = vec3(1.0,0.0,1.0);","}","return fp_color;","}"].join("\n")},a.atlas_SideWalkEdges_PDSFX={name:"atlas_SideWalkEdges_PDSFX",depends:[a.atlas_PDSFX],FS_global_code:["#define ATLAS_SIDEWALKEDGES","vec3 atlas_sidewalkedges(vec3 color, vec3 vertexColor) {","float swe_colorDiff = length(vertexColor.rgb - vec3(1.0, 1.0, 1.0));","vec3 swe_color = color;","if (abs(swe_colorDiff) < 0.1) {","vec2 swe_startOffset = atlas_getStartOffset(0.5, 0.375);","vec2 swe_texSize = vec2(atlas_getSizeInAtlas(0.5), atlas_getSizeInAtlas(0.125));","swe_color = texture2D(mapCity, mod((vGetTexCoord0().xy * swe_texSize) / vec2(2.0, 1.0), swe_texSize) + swe_startOffset).rgb;","#ifdef GAMMA_INPUT","swe_color *= swe_color;","#endif","}","return swe_color;","}"].join("\n")},a.chunkOcean_PDSFX={name:"chunkOcean_PDSFX",nbTexture:1,uniforms:{mapCity:{type:"t2",value:a.whiteMap},oceanTexture:{type:"t2",value:a.whiteMap},oceanColor:{type:"c",value:new t.Color("rgb(47,64,140)")},landcoverTimer:{type:"f",value:0,animation:function(e){return e.animatedTime}},showOcean:{type:"b",value:!0},specularOcean:{type:"c",value:new t.Color("rgb(255,255,255)")}},varyings:{vertexPos_world:{type:"v3",length:1}},FS_global_code:["#ifndef TERRAIN_SHADER","#define TERRAIN_SHADER","bool computeWaves = true && showOcean;","#endif","// generate a layer of waves","float OceanPI = 3.14;","vec3 generateWavesFromNoises(sampler2D wt, vec2 texCoords, float time, float s, float bs)","{","float sinAngle, cosAngle;","const int nbDirections = 5;","float spread = OceanPI*2.0*s;","vec3 currentLayer = vec3(0.0,0.0,0.0);","float uNormalize = 0.50;","float uBumpStrength = bs; ","for (int i=0; i<nbDirections; i++)","{","float angle = spread * float(i)/float(nbDirections);","cosAngle = cos(angle); ","sinAngle = sin(angle);","vec2 diri =  vec2( cosAngle, sinAngle ); ","vec2 UV = texCoords + time * diri ;","vec3 normal = texture2D(wt, UV).rgb;","vec3 clt = 2.0*(normal - vec3(uNormalize, uNormalize, 0.0));","clt.xy *= uBumpStrength;","currentLayer += normalize(clt); ","}","currentLayer /= float(nbDirections);","return currentLayer.xyz;","}","// combine wave layers","vec3 combineWaves(vec3 worldPos)","{","vec2 uvWater =  5.0*0.001*worldPos.xy;","float waterSpeed = 0.01*landcoverTimer;","vec3 pwave1  =  generateWavesFromNoises(oceanTexture, 0.4*uvWater,  0.5*waterSpeed, 0.6, 1.0);","vec3 cameraToVertex = normalize( worldPos - cameraPosition );","vec3 rwave1 = reflect( cameraToVertex, pwave1 );","if (rwave1.z < 0.0) { pwave1 = vec3(0.0,0.0,1.0); };","vec3 pwave2  = generateWavesFromNoises(oceanTexture, 3.0*uvWater, 0.6*waterSpeed, 0.7, 1.5);","vec3 rwave2 = reflect( cameraToVertex, pwave2 );","if (rwave2.z < 0.0) { pwave2 = vec3(0.0,0.0,1.0); };","vec3 pwave3  = generateWavesFromNoises(oceanTexture, 10.0*uvWater, 0.7*waterSpeed, 1.0, 3.0);","vec3 rwave3 = reflect( cameraToVertex, pwave3 );","if (rwave3.z < 0.0) { pwave3 = vec3(0.0,0.0,1.0); };","vec3 pwave =  normalize((pwave1 + pwave2 + pwave3));","vec3 ppwave =  normalize((pwave1));","return pwave;","}"].join("\n"),VS_overridableFunctions:{ComputeVaryingValues:["vec3 vertexPos_worldXYZ = vec3(modelMatrix * vec4(ComputeObjectPosition(), 1.0));","vertexPos_world = vertexPos_worldXYZ.xyz;"].join("\n"),ComputeObjectNormal:["return vec3(0.0,0.0,1.0);"].join("\n")},FS_overridableFunctions:{ComputeCommonValues:["if (computeWaves) {","}",""].join("\n"),ComputeAlbedo:["if (computeWaves) {","return oceanColor;","}","cAlbedo = oceanColor;",""].join("\n"),ComputeViewNormal:["if (computeWaves) {","float coefDist = clamp(length(vGetViewPosition())/50000.0,0.0,1.0);","vec3 combiwaves = combineWaves(vertexPos_world);","vec3 waveNormal = coefDist * vec3(0.0,0.0,1.0) + (1.0-coefDist) * combiwaves; ","vec3 vNormal = vec3(vGetViewMatrix() * vec4(normalize(waveNormal), 0.0));","return vNormal;","}","else {","return vGetViewNormal();","}"].join("\n"),ComputeSpecularReflectance:["if (computeWaves) {","return specularOcean*0.02777777;","}","else {","return vec3(0.02777777,0.02777777,0.02777777);","}"].join("\n"),ComputeRoughness:["if (computeWaves) {","return 0.1;","}","else {","return 1.0;","}"].join("\n"),_ProcessFinalColor:["ioFinalColor.rgb = ComputeViewNormal().xyz;"].join("\n")}},a.chunkLandcover_unvisibleSource_PDSFX={name:"chunkLandcover_unvisibleSource_PDSFX",nbTexture:1,depends:[],attributes:{},vertex_attributes:{},uniforms:{landcover:{type:"t2",value:void 0},landcoverOffset:{type:"v4",value:new t.Vector4(0,0,1,1)},oceanRangeDetection:{type:"f",value:.1},oceanColorDetection:{type:"c",value:new t.Color("rgb(0,0,255)")}},varyings:{uvslandcover:{type:"v2",length:1}},VS_overridableFunctions:{ComputeCommonValues:["if (uv != vec2(-1.0) ) {","uvslandcover = ComputeObjectTexCoord0_Cropped().xy * landcoverOffset.z + landcoverOffset.xy;","} else {","uvslandcover = vec2(-1.0);","}"].join("\n")},FS_overridableFunctions:{ComputeCommonValues:["vec4 _landcover;","if (uvslandcover != vec2(-1.0)) {","_landcover = texture2D(landcover, uvslandcover);","} else {","_landcover = vec4(0.0);","}","computeWaves = (length(_landcover.rgb - oceanColorDetection) < oceanRangeDetection);"].join("\n")}},a.chunkLandcover_visibleSource_PDSFX={name:"chunkLandcover_visibleSource_PDSFX",nbTexture:0,depends:[],attributes:{},vertex_attributes:{},uniforms:{landcoverIndex:{type:"f",value:-1},oceanRangeDetection:{type:"f",value:.1},oceanColorDetection:{type:"c",value:new t.Color("rgb(0,0,255)")}},varyings:{},VS_overridableFunctions:{ComputeCommonValues:[].join("\n")},FS_global_code:["vec4 _landcover;"].join("\n"),FS_overridableFunctions:{ComputeCommonValues:["","#ifdef MULTIPLE_RASTER_TERRAIN","#if MULTIPLE_RASTER_TERRAIN >= 2","if (landcoverIndex > -0.5 && landcoverIndex < 0.5) {","_landcover = texture2D(raster[0], uvsraster[0]);","}","else if (landcoverIndex > 0.5 && landcoverIndex < 1.5) {","_landcover = texture2D(raster[1], uvsraster[1]);","}","#endif","#if MULTIPLE_RASTER_TERRAIN >= 3","else if (landcoverIndex > 1.5 && landcoverIndex < 2.5) {","_landcover = texture2D(raster[2], uvsraster[2]);","}","#endif","#if MULTIPLE_RASTER_TERRAIN >= 4","else if (landcoverIndex > 2.5 && landcoverIndex < 3.5) {","_landcover = texture2D(raster[3], uvsraster[3]);","}","#endif","#else","_landcover = texture2D(raster, uvsraster);","#endif","computeWaves = (length(_landcover.rgb - oceanColorDetection) < oceanRangeDetection);","//computeWaves = true;"].join("\n"),_ProcessFinalColor:["ioFinalColor = _landcover;"].join("\n")}},a}),define("DS/XCityTools/Disposer",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityTools/Debug","DS/XCityTools/ShaderTools"],function(e,t,i,r,n){"use strict";return{traverseV6:function(e,i){if(this.dispose(e,i)){if(r.log("dispose : "+e.name),e instanceof t){for(var n=0,o=e.children.length;n<o;n++)this.traverseV6(e.children[n],i);e.removeChildren()}e.node instanceof t&&this.traverseV6(e.node,i)}},dispose:function(i,r,o){if(!i)return!1;if(!i._globePool||(i._globePool.recycle(i),r)){if(!0!==r&&void 0!==i.shared&&0!==i.shared&&1!==i.shared){if(i.shared>1)return i.shared--,!1;if(i.shared<0)return!1}if(i instanceof Array)for(var s=0;s<i.length;s++)this.dispose(i[s],r,o);if(i.lineBuilder&&i.lineBuilder.dispose(),i.observers){var a=i.observers.length;for(s=0;s<a;s++)i.observers[s](i);i.observers=null}if(i.userData=null,null!==i.material&&this.dispose(i.material,r),i instanceof e.Material){if(i._PDSFXData&&i._PDSFXData.pdsfxUniforms.raster)if(i._PDSFXData.pdsfxUniforms.raster.value instanceof e.Texture)this.dispose(i._PDSFXData.pdsfxUniforms.raster.value,r);else if(i._PDSFXData.pdsfxUniforms.raster.value instanceof Array)for(var l=0;l<i._PDSFXData.pdsfxUniforms.raster.value.length;l++)this.dispose(i._PDSFXData.pdsfxUniforms.raster.value[l],r);if(void 0!==i.map&&null!==i.map&&(this.dispose(i.map,r),i.image=null,i.map.textures&&i.map.textures.length>0)){i.map.usedTexture;i.map.usedTexture=-1}var u,c,d=i.uniforms;if(d)for(c in n.unregisterAnimationUniforms(i),d)if("t"===(u=d[c]).type&&u.value&&u.value instanceof e.Texture)this.dispose(u.value,r,o),u.value.onLoadCallbacks=null,u.value.onUpdate=null;else if("tv"===u.type&&u.value)for(var h=0;h<u.value.length;h++)u.value[h]&&u.value[h]instanceof e.Texture&&(u.value[h].onUpdate=void 0,u.value[h].onLoadCallbacks=void 0,this.dispose(u.value[h],r,o),u.value[h]=void 0);if(i._PDSFXData)if(d=i._PDSFXData.pdsfxUniforms)for(c in n.unregisterAnimationUniforms(i),d)if("t"!==(u=d[c]).type&&"t2"!==u.type||!u.value){if("tv"===u.type&&u.value)for(h=0;h<u.value.length;h++)u.value[h]&&(u.value[h].onUpdate=void 0,u.value[h].onLoadCallbacks=void 0,this.dispose(u.value[h],r,o),u.value[h]=void 0)}else this.dispose(u.value,r,o),u.value.onLoadCallbacks=null,u.value.onUpdate=null}if((i instanceof e.Texture||i instanceof e.DataTexture)&&i.__webglInit&&i.dispatchEvent({type:"dispose"}),i.mesh3js){var f=i.mesh3js;if(void 0!==f.material&&this.dispose(f.material,r),f.geometry&&f.geometry.length>0)for(s=0;s<f.geometry.length;s++){var p=f.geometry[s];this.dispose(p,r,o)}}if(i.drawingGroups&&i.drawingGroups.length>0)for(s=0;s<i.drawingGroups.length;s++)this.dispose(i.drawingGroups[s],r,o);return i instanceof t&&null!==i.material&&this.dispose(i.material,r),i.dispose?(i.dispose(),void 0!==i.needsUpdate&&(i.needsUpdate=!0)):i.dispatchEvent&&i.dispatchEvent({type:"dispose"}),i=null,!0}},disposeV6:function(e,t){this.traverseV6(e,t)}}}),define("DS/XCityTools/AtlasPacker",["UWA/Class","DS/xCityBasicUtils/Utils","DS/XCityTools/AtlasNode","DS/XCityTools/AtlasBlock"],function(e,t,i,r){"use strict";return e.extend({init:function(e,t,i){this.BlockList=[],this._roots=[],this._atlasMaxWidth=null,this._atlasMaxHeight=null,this._powerOfTwo=null,this._atlasMaxWidth=e,this._atlasMaxHeight=t,this._powerOfTwo=i},makeBlock:function(e){var t=new r(e);return this.BlockList.push(t),t},getBlock:function(e){return this.BlockList[e]},getBlockCount:function(){return this.BlockList.length},clearBlocks:function(){this.BlockList=[],this._roots=[]},getAtlasCount:function(){return this._roots.length},getAtlasWidth:function(e){return this._roots[e].width},getAtlasHeight:function(e){return this._roots[e].height},getBlocksInAtlasByIndex:function(e){var i,r,n=this.BlockList.length;for(i=0;i<n;i++){var o=this.BlockList[i];o.getPacked()&&o._fit.Index===e&&(t.is(r)||(r=[]),r.push(o))}return r},sortBlockList:function(){this.BlockList.sort(function(e,t){return e.getWidth()>t.getWidth()?-1:e.getWidth()<t.getWidth()?1:e.getHeight()>t.getHeight()?-1:e.getHeight()<t.getHeight()?1:0})},Build:function(){if(this._roots.push(new i(0,0,0,0)),this._roots[0].Index=0,0!==this.BlockList.length){this.sortBlockList(),this._roots[0].width=this.BlockList[0].getWidth(),this._roots[0].height=this.BlockList[0].getHeight();var e,t,r,n,o=this.BlockList.length,s=this._roots.length;for(e=0;e<o;e++){var a=this.BlockList[e];if(a.getWidth()>this._atlasMaxWidth||a.getHeight()>this._atlasMaxHeight);else{for(t=0;t<s;t++){var l=!0,u=(r=this._roots[t]).block;if(null!==u&&(l=u.isCompatibleWith(a)),l){if(null!==(n=this.findNode(r,a.getWidth(),a.getHeight()))){a._fit=this.splitNode(n,a.getWidth(),a.getHeight()),a._fit.block=a,a.rootNode=r;break}if(a._fit=this._powerOfTwo?this.growNodeP2(r,a.getWidth(),a.getHeight()):this.growNode(r,a.getWidth(),a.getHeight()),null!=a._fit){a._fit.block=a,a.rootNode=r;break}}}null===a._fit&&((r=new i(0,0,a.getWidth(),a.getHeight())).Index=this._roots.length,this._roots.push(r),null!==(n=this.findNode(r,a.getWidth(),a.getHeight()))&&(a._fit=this.splitNode(n,a.getWidth(),a.getHeight()),a._fit.block=a,a.rootNode=r))}}}},nextPowerOf2:function(e){var t=Math.log(e)/Math.log(2),i=Math.floor(Math.ceil(t));return Math.floor(Math.pow(2,i))},findNode:function(e,t,i){if(e.used){var r=this.findNode(e.right,t,i);return null===r&&(r=this.findNode(e.down,t,i)),r}return t<=e.width&&i<=e.height?e:null},splitNode:function(e,t,r){return e.used=!0,e.width-t>e.height-r?(e.down=new i(e.x,e.y+r,e.width,e.height-r),e.right=new i(e.x+t,e.y,e.width-t,r)):(e.down=new i(e.x,e.y+r,t,e.height-r),e.right=new i(e.x+t,e.y,e.width-t,e.height)),e.down.Index=e.Index,e.right.Index=e.Index,e},growNodeP2:function(e,t,i){var r=this.nextPowerOf2(e.height+i),n=this.nextPowerOf2(e.width+t),o=t<=e.width&&r<=this._atlasMaxHeight,s=i<=e.height&&n<=this._atlasMaxWidth,a=s&&e.height>=n,l=o&&e.width>=r;return a?this.growRight(e,n-e.width,i):l?this.growDown(e,t,r-e.height):s?this.growRight(e,n-e.width,i):o?this.growDown(e,t,r-e.height):null},growNode:function(e,t,i){var r=t<=e.width&&e.height+i<=this._atlasMaxHeight,n=i<=e.height&&e.width+t<=this._atlasMaxWidth,o=n&&e.height>=e.width+t,s=r&&e.width>=e.height+i;return o?this.growRight(e,t,i):s?this.growDown(e,t,i):n?this.growRight(e,t,i):r?this.growDown(e,t,i):null},growRight:function(e,t,r){var n=new i(e.x,e.y,e.width,e.height);n.used=e.used,n.Index=e.Index,n.down=e.down,n.right=e.right,e.width=e.width+t,e.down=n,e.right=new i(n.width,0,t,n.height),e.right.Index=e.Index;var o;return null!==(o=this.findNode(e,t,r))?this.splitNode(o,t,r):null},growDown:function(e,t,r){var n=new i(e.x,e.y,e.width,e.height);n.used=e.used,n.Index=e.Index,n.down=e.down,n.right=e.right,e.height=e.height+r,e.down=new i(0,n.height,n.width,r),e.down.Index=e.Index,e.right=n;var o;return null!==(o=this.findNode(e,t,r))?this.splitNode(o,t,r):null}})}),define("DS/XCityTools/Geocoder",["DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","DS/XCityTools/Debug","VENProj4js-2.7.2/js/proj4"],function(e,t,i,r){"use strict";var n=null;function o(){if(null!==n)throw new Error("Cannot instantiate more than one MySingleton, use MySingleton.getInstance()");this.initialize()}return window.Proj4js||(window.Proj4js=r),o.getInstance=function(){return null===n&&(n=new o),n},o.projList={},o.prototype={initialize:function(){this.baseURL="",this.earthRadius=6378137,this.defaultProjection="EPSG:900913",this.projections={}},setBaseUrl:function(e,t){this.baseURL=e;var i=!0,r=2,n=function(e){i&=e,0===--r&&void 0!==t&&t(i)};this.loadProjection("WGS84",n.bind(this)),this.loadProjection("EPSG:900913",n.bind(this))},setDefaultProjection:function(e,t){this.defaultProjection=e,this.loadProjection(this.defaultProjection,t)},getDefaultProjection:function(){return this.defaultProjection},getProjectProjection:function(){return this.defaultProjection},projectionReady:function(e){var t=o.getInstance().projections[e];return void 0!==t&&1===t.ready},loadProjection:function(e,r,n){var s,a,l,u,c=function(t){var r,s;if(s=o.getInstance().projections[e],t&&void 0===s.proj4js){var a=e;!0!==n&&(a=Proj4js.defs[e],Proj4js.defs(e,a)),s.proj4js=new Proj4js.Proj(a,function(e,t){null===e&&(s.proj4js=t,c(!0))})}for(t?i.log("GEOCODER:loadProjection -> Projection "+e+" LOADED"):i.error("GEOCODER:loadProjection -> FAILLED to load projection "+e),s.ready=t?1:-1,r=0;r<s.cb.length;++r)void 0!==s.cb[r]&&s.cb[r](t);s.cb=[]};if(void 0===this.projections[e])if(this.projections[e]={ready:0,cb:[r]},u=c.bind(this),function(t){var i=o.getInstance().projections[e];i.proj4js=new Proj4js.Proj(e,function(e,t){null===e&&(i.proj4js=t,c(!0))})}.bind(this),n)u(!0);else try{for(l in(a={}).type="text/javascript",a.src=t.getWebappsBaseUrl()+"VENProj4js/defs/"+e.replace(/:/gi,"")+".js",s=document.createElement("script"),a)s[l]=a[l];return s.onerror=function(){u(!1)},s.onload=function(){u(!0)},s.onreadystatechange=function(){"complete"!==s.readyState&&"loaded"!==s.readyState||u(!0)},document.getElementsByTagName("head")[0].appendChild(s),!0}catch(e){return u(!1),!1}else switch(this.projections[e].ready){case 0:this.projections[e].cb.push(r);break;case 1:void 0!==r&&r(!0);break;default:void 0!==r&&r(!1)}},projForWebWorker:function(t,i,r,n,o,s){var a;return void 0!==t.x&&void 0!==t.y?a=new e.Vector3(t.x,t.y):void 0!==t.lat&&void 0!==t.lon?a=new e.Vector3(t.lon,t.lat):t instanceof Array&&t.length>=2&&(a=new e.Vector3(t[0],t[1])),i&&""!==i||(i=this.defaultProjection),n&&""!==n||(n=this.defaultProjection),i!==n&&(!s||"WGS84"!==i&&"EPSG:4326"!==i&&"EPSG:4329"!==i||(a.x=Utils.toDeg(a.x),a.y=Utils.toDeg(a.y)),a=Proj4js.transform(r,o,a),!s||"WGS84"!==n&&"EPSG:4326"!==n&&"EPSG:4329"!==n||(a.x=Utils.toRad(a.x),a.y=Utils.toRad(a.y))),a},proj:function(t,i,r,n){var o;if(void 0!==t.x&&void 0!==t.y?o=new e.Vector3(t.x,t.y):void 0!==t.lat&&void 0!==t.lon?o=new e.Vector3(t.lon,t.lat):t instanceof Array&&t.length>=2&&(o=new e.Vector3(t[0],t[1])),i&&""!==i||(i=this.defaultProjection),this.loadProjection(i),r&&""!==r||(r=this.defaultProjection),this.loadProjection(r),i!==r){if(!n||"WGS84"!==i&&"EPSG:4326"!==i&&"EPSG:4329"!==i||(o.x=Utils.toDeg(o.x),o.y=Utils.toDeg(o.y)),this.projections[i].ready>0&&this.projections[r].ready>0){var s=this.projections[i].proj4js,a=this.projections[r].proj4js;o=Proj4js.transform(s,a,o)}!n||"WGS84"!==r&&"EPSG:4326"!==r&&"EPSG:4329"!==r||(o.x=Utils.toRad(o.x),o.y=Utils.toRad(o.y))}return o},latlonToMercator:function(e,t,i){return this.proj([t,e],"WGS84","EPSG:900913",i)},mercatorToLatlon:function(e,t,i){return this.proj([e,t],"EPSG:900913","WGS84",i)},proj2worldMatrix:function(t,i,r){var n=this.earthRadius+(void 0!==t.z?t.z:0),o=this.toGeographic(this.proj(t,i,"EPSG:900913",r),!0),s=n*Math.cos(o.y),a=s*Math.cos(o.x),l=s*Math.sin(o.x),u=n*Math.sin(o.y),c=(new e.Matrix4).makeRotationY(.5*Math.PI-o.y);return(new e.Matrix4).makeRotationZ(o.x).multiply(c).multiply((new e.Matrix4).makeRotationZ(.5*Math.PI)).setPosition(new e.Vector3(a,l,u))},proj2world:function(t,i,r){var n=new e.Vector3;return n.getPositionFromMatrix(this.proj2worldMatrix(t,i,r)),n},world2proj:function(e,t,i){var r=Math.atan2(e.z,Math.sqrt(e.y*e.y+e.x*e.x)),n=Math.atan2(e.y,e.x);return i||(r=Utils.toDeg(r),n=Utils.toDeg(n)),this.proj([n,r],"WGS84",t,i)},computeMercatorScaleFactor:function(e,t,i,r){if(!this.projectionReady(i))return 1;var n=this.proj([e,t],i,"WGS84",r);return r?Math.min(100,Math.max(1,1/Math.cos(n.y))):Math.min(100,Math.max(1,1/Math.cos(Utils.toRad(n.y))))},reverseGeocodingAt:function(e,t,i){i||(i=this.defaultProjection);var r=this.proj2D([e,t],"WGS84",i),n="http://nominatim.openstreetmap.org/reverse?format=json&lat="+r.y+"&lon="+r.x+"&zoom=18&addressdetails=1";return UWA.Ajax.request(n,{async:!1,cors:!0,onComplete:function(e){return JSON.parse(e).display_name}}),"nowhere"},toGeographic:function(e,t){var i=57.29577951308232*(e.x/6378137),r=i-360*Math.floor((i+180)/360),n=57.29577951308232*(1.5707963267948966-2*Math.atan(Math.exp(-1*e.y/6378137)));return n>85?n=90:n<-85&&(n=-90),t?{y:Utils.toRad(n),x:Utils.toRad(r)}:{y:n,x:r}},getLandPositionFromName:function(t,r,n,o){var s="http://nominatim.openstreetmap.org/search?q="+t+"&format=json";UWA.Ajax.request(s,{cors:!0,onComplete:function(t){if(void 0===JSON.parse(t)[0])return i.error("Error: Destination request failed!"),void n(void 0);r||(r=this.defaultProjection);var s=void 0;s=o?new e.Vector2(p.x,p.y):new e.Vector2(p.x,p.y,0),n(s)},onFailure:function(){n(void 0)}})}},o.getInstance()}),define("DS/XCityTools/Downloader",["DS/WAFData/WAFData","DS/WebappsUtils/WebappsUtils","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","DS/XCityTools/Debug","DS/XCityTools/Geocoder","DS/xCityPlatformUtils/xCityDocumentManagement","DS/XCityTools/shapefile"],function(e,t,i,r,n,o,s,a,l){"use strict";var u=function(){this._downloadStatsRefreshDelay=6e4,this._maxSimultaneousDownloads=10,this._platformID=void 0,this._platformServicesList=[],this._credentials={default:!1},this._downloadList={},this._waitingList=[],this._rejectedDatasetList=[],this._datasetToCheckList=0,this._aliases={},this._datasetLogs=new Map,this._scheduledDataseLogsReset=new Map,this._perfBufferSize=1e3,performance.clearResourceTimings(),performance.setResourceTimingBufferSize(this._perfBufferSize)};u.prototype={setWidget:function(e){if(void 0!==e){this._platformID=e.getValue("x3dPlatformId"),this._platformServicesList.push(t.getWebappsBaseUrl()),i.getServiceUrl({serviceName:"globe",platformId:this._platformID,onComplete:this._setGlobeService.bind(this),onFailure:this._failedServiceUrl.bind(this)});var r=this;i.getPlatformServices({onComplete:function(e){e.forEach(function(e){if(r._platformID===e.platformId){for(var t in e)r._aliases[t]=e[t];r._globeServiceLogin()}})},onFailure:this._failedPlatformServices.bind(this)}),window.xCityFakePlatform&&!Utils.is(this._platformID)&&(this._platformID="xCityFakePlatform")}},setCredentials:function(e,t){this._credentials[e]=t},resetCredentials:function(e,t){this._credentials={default:!1}},reset:function(){this.resetCredentials(),this.resetRejectedDatasetList(),this._datasetLogs=new Map,this._scheduledDataseLogsReset.forEach((e,t)=>{clearTimeout(e.timeoutId)}),this._scheduledDataseLogsReset=new Map},addRejectedDataset:function(e,t,i,r,n){this._rejectedDatasetList.push({name:e,url:t,response:i,errorMessage:r,errorCode:n})},getRejectedDatasetList:function(){return this._rejectedDatasetList},resetRejectedDatasetList:function(){return this._rejectedDatasetList=[]},setUrlParams:function(e){if(e)for(var t in this._aliases={},e)e.hasOwnProperty(t)&&(this._aliases[t]&&console.warn(" Url Alias "+t+" is already used, reusing it will cause problems !!"),"string"==typeof e[t]&&(this._aliases[t]=e[t]))},resetUrlParams:function(){this._aliases={}},resolveUrlWithTimeStamp:function(e,t){return this._appendTimeStampParam(this.resolveUrl(e,t))},resolveUrl:function(e,i){var r,n,o,s,a=e;if(this._aliases){for(var l in o=a.split("data:"),a=o[0],this._aliases)if(this._aliases.hasOwnProperty(l)&&(s="%"+l+"%",a.indexOf(s)>=0))for(r=a.split(s),a="",n=0;n<r.length;n++)a+=r[n],n<r.length-1&&(a+=this._aliases[l]);for(n=1;n<o.length;n++)a+="data:",a+=o[n]}return"http"!==a.substring(0,4)&&"/"!==a[0]&&"data:"!==a.substring(0,5)&&"file:"!==a.substring(0,5)&&(a=i&&i.module?t.getWebappsAssetUrl(i.module,"")+a:t.getWebappsBaseUrl()+a),a},_parseShapeFile:async function(e,t,i,r){return new Promise((n,o)=>{const u=function(t,i){return new Promise((r,n)=>{a.retrieveDocumentUrl(t,i,e).then(function(e){return a.downloadBinaryDocument(e)}).then(function(e){e?r(e):n()})})};let c=t,d=i.shp.id,h=t,f=i.dbf.id,p=t,m=i.prj.id;return"3DDrive"===e&&(c=d=i.shp,h=f=i.dbf,p=m=i.prj),u(c,d).then(function(e){var t,i=e;u(h,f).then(function(e){var o,a;(o=i,a=t=e,new Promise((e,t)=>{l.read(o,a).then(t=>e(t))})).then(function(e){e=e;u(p,m).then(function(o){var a,l=(a=o,String.fromCharCode.apply(null,new Uint8Array(a)));l.endsWith("\n")&&(l=l.slice(0,l.length-1)),s.loadProjection(l,void 0,!0),e.crs={properties:{name:l}},r&&(e.dbfContent=t,e.shpContent=i),n(e)})})})})})},downloadFrom3DDrive:async function(e,t){const i=this;return new Promise((r,n)=>a.retrieveDocumentTypes(e,"3DDrive").then(function(o){for(var s={shp:null,prj:null,dbf:null,geojson:null,other:null},l=0;l<o.types.length;l++){var u=o.types[l].toUpperCase();"GEOJSON"===u?s.geojson=o.filesId[l]:"SHP"===u?s.shp=o.filesId[l]:"KML"!==u&&"GML"!==u&&"ZGDB"!==u&&"CSV"!==u||(s.other=o.filesId[l])}if(null!==s.geojson)a.retrieveDocumentUrl(e,s.geojson,"3DDrive").then(function(e){return t?a.downloadBinaryDocument(e):a.downloadDocument(e)}).then(function(e){r(e)});else if(null!==s.shp){var c=o.title.indexOf("."),d=o.title.slice(0,c);a.retrieveDocumentsInFolder(o.folderId,"3DDrive").then(function(e){for(var t,i=0;i<e.length;++i)"DriveFile"===(t=e[i]).type&&(t.title===d+".dbf"?s.dbf=t.id:t.title===d+".prj"&&(s.prj=t.id))}).then(async function(){const n=await i._parseShapeFile("3DDrive",e,s,t);r(n)})}else null!==s.other?r({needServiceSidePreview:!0}):n()}))},downloadFrom3DSpace:async function(e,t){const i=this;return new Promise((r,n)=>a.retrieveDocumentTypes(e).then(async function(o){for(var s={shp:null,prj:null,dbf:null,geojson:null,other:null},l=function(e,t){return null===e?t:null===t?e:1===e.name.localeCompare(t.name)?t:e},u=0;u<o.types.length;u++){var c=o.types[u].toUpperCase();"GEOJSON"===c?s.geojson=l(s.geojson,{name:o.filesName[u],id:o.filesId[u]}):"SHP"===c?s.shp=l(s.shp,{name:o.filesName[u],id:o.filesId[u]}):"PRJ"===c?s.prj=l(s.prj,{name:o.filesName[u],id:o.filesId[u]}):"DBF"===c?s.dbf=l(s.dbf,{name:o.filesName[u],id:o.filesId[u]}):"KML"!==c&&"GML"!==c&&"ZGDB"!==c&&"CSV"!==c||(s.other=l(s.other,{name:o.filesName[u],id:o.filesId[u]}))}if(null!==s.geojson)a.retrieveDocumentUrl(e,s.geojson.id).then(function(e){return t?a.downloadBinaryDocument(e):a.downloadDocument(e)}).then(function(e){r(e)});else if(null!==s.shp){const n=await i._parseShapeFile("3DSpace",e,s,t);r(n)}else null!==s.other?r({needServiceSidePreview:!0}):n()}))},_appendTimeStampParam:function(e){const t=this.getUuidFromUrl(e);if(t&&"undefined"!=typeof xCity&&xCity.widgetData&&xCity.widgetData.datasetCollection){const i=xCity.widgetData.datasetCollection.get({id:t}),r=i?i.get("lastModificationDate"):null;if(r){let t=new Date(r).getTime();Number.isFinite(t)&&(e+="&ts="+t)}}return e},download:function(e,t,i,n,s){var a,l=this,u=function(e,t){return l.resolveUrl(e,t)};if(!e)return o.warn("Downloader: No url given."),void n.call(s,!1);if(e instanceof Array)for(var c=e.length;c--;)e[c]=u(e[c],t);else e=u(e,t),e=this._appendTimeStampParam(e);n&&(a={func:n,bound:s,opt:Array.prototype.slice.call(arguments,5)});var d=this._downloadList[e];if(void 0!==d)void 0!==a&&d.callbacks.push(a);else{var h=this._waitingList.findIndex(this._sameURLRequest.bind(this,e));if(-1!==h)d=this._removeFromWaitingList(h),i&&10*i>d.priority?d.priority=10*i:d.priority=d.priority+1,void 0!==a&&d.callbacks.push(a);else{var f;for(f in d={url:e,priority:i?10*i:0,callbacks:[],options:{},downloadUUID:UWA.Utils.getUUID()},t)t.hasOwnProperty(f)&&(d.options[f]=t[f]);if(void 0!==a&&d.callbacks.push(a),!d.options.withCredentials){var p=this._credentials.default;for(f in this._credentials)if("default"!==f&&-1!==e.indexOf(f)){p=this._credentials[f];break}d.options.withCredentials=p,p||(d.options.headers={"X-Requested-With":""})}d.options.method="GET",d.options.onComplete=this._onComplete.bind(this,d.url),d.options.onFailure=this._onFailure.bind(this,d.url)}if(void 0!==d.options.textureLOD){var m=document.createElement("canvas"),v=new r.Texture(m,void 0);v.wrapS=d.options.wrapS,v.wrapT=d.options.wrapT,v.loadEndStatus="loading",d.textureLOD=v}this._addToWaitingList(d)}return this._startDownload(),void 0!==d.options.textureLOD?d.textureLOD:void 0},_getDownloadRequest:function(){var e=0;return this._shouldRequestDownload(this._waitingList[e])||(e=this._findBestRequestIndex()),this._waitingList.splice(e,1)[0]},_shouldRequestDownload:function(e){var t=this._datasetLogs.get(this._getDatasetIDFromUrl(e.url)),i=e.options.image,r=!!t&&t.averageTime>500;return i&&r&&!this._slowRasterSlotPendingUrl?(this._slowRasterSlotPendingUrl=e.url,!0):!(i&&r&&this._slowRasterSlotPendingUrl)},_findBestRequestIndex:function(){for(let e=0;e<this._waitingList.length;e++)if(this._shouldRequestDownload(this._waitingList[e]))return e;return 0},_addToWaitingList:function(e){if(e)if(!this._isBlackListed(e)&&this._isReady(e))if(0===this._waitingList.length)this._waitingList.push(e);else{var t=this._waitingList.findIndex(this._firstWithLowerPriority.bind(this,e.priority));this._waitingList.splice(-1===t?this._waitingList.length:t,0,e)}else if(e.callbacks){var i=e.callbacks;e.callbacks=[],i.forEach(function(e){e.opt.unshift(!1,void 0,void 0),e.func.apply(e.bound,e.opt)})}},_addDatasetLogEntry:function(e){performance.getEntriesByType("resource").length===this._perfBufferSize&&performance.clearResourceTimings();var t=this._getDatasetIDFromUrl(e.url);if(t){var i=this._datasetLogs.get(t);i||(i=this._initDatasetLogEntry(t,[])),i.times[e.downloadUUID]=Date.now()}},getDownloadLog:function(e){let t=void 0;if(e&&this._datasetLogs){let i=this._datasetLogs.get(this._getDatasetIDFromUrl(e));i&&((t=Object.assign({},i)).pending=t.times?Object.keys(t.times).map(e=>t.times[e]):[],delete t.times,t.isBlackListed=this._isBlackListed({url:e}),t.isSlowRaster=this._isSlowRaster(e))}return t},_getDownloadLogs:function(){for(const[e,t]of this._datasetLogs.entries()){let i=this._isSlowRaster(e);t.isSlowRasterSlot=i}return this._datasetLogs},_isSlowRaster:function(e){return!!(e&&this._slowRasterSlotPendingUrl&&this._slowRasterSlotPendingUrl.includes(e))},_updateDatasetLogEntry:function(e,t){e.url===this._slowRasterSlotPendingUrl&&(this._slowRasterSlotPendingUrl=null);var i=this._getDatasetIDFromUrl(e.url);if(i&&this._datasetLogs.has(i)){var r=this._datasetLogs.get(i);t?r.success++:r.failure++;var n=r.times[e.downloadUUID]||Date.now();delete r.times[e.downloadUUID];var o=Date.now()-n,s=r.success+r.failure,a=r.averageTime*((s-1)/s),l=o*(1/s);r.averageTime=a+l;let u=performance.getEntriesByType("resource").filter(e=>e.name.includes(i)),c=u.length?u.map(e=>e.responseStart-e.requestStart).reduce((e,t)=>e+t,0)/u.length:null,d=u.length?u.map(e=>e.responseStart-e.requestStart).filter(e=>e>500).length/u.length:null;r.avgTTFB=c,r.percentTTFBOver500ms=d,this._datasetLogs.set(i,r)}},_initDatasetLogEntry:function(e,t){var i={success:0,failure:0,times:t,averageTime:0,avgTTFB:0,percentTTFBOver500ms:0};this._datasetLogs.set(e,i);var r=setTimeout(this._resetLogForDataset.bind(this),this._downloadStatsRefreshDelay,e);return this._scheduledDataseLogsReset.set(e,{timeoutId:r,startTime:Date.now()}),i},getDownloadStatsRefreshDelay:function(){return this._downloadStatsRefreshDelay},setDownloadStatsRefreshDelay:function(e){this._downloadStatsRefreshDelay=e,this._updateDatasetLogResetSchedule()},_updateDatasetLogResetSchedule:function(){let e=new Map;this._scheduledDataseLogsReset.forEach((t,i)=>{const r=setTimeout(this._resetLogForDataset.bind(this),this._downloadStatsRefreshDelay,i);e.set(i,{timeoutId:r,startTime:Date.now()}),clearInterval(t.timeoutId)}),this._scheduledDataseLogsReset=e},_isBlackListed:function(e){var t=this._getDatasetIDFromUrl(e.url),i=this._datasetLogs.get(t);if(e.url&&e.url.contains("/resources/"))return!1;if(i){var r=i.failure+i.success,n=i.failure/Math.max(1,r);if(r>=10&&n>.8){return o.warn("Layer downloads deactivated because of too many errors."),!0}}return!1},_isReady(e){const t=this.getUuidFromUrl(e.url),i="undefined"!=typeof xCity&&xCity.widgetData&&xCity.widgetData.datasetCollection&&xCity.widgetData.datasetCollection.get({id:t});return!i||"Ready"===i.get("state")},_removeFromWaitingList:function(e){return this._waitingList.splice(e,1)[0]},cancel:function(e){var t,i,r=this.resolveUrl(e),n=this.resolveUrlWithTimeStamp(e),o=this._downloadList[r]||this._downloadList[n];void 0!==o?(t=o.callbacks,o.callbacks=[],t.forEach(function(e){e.opt.unshift(!1,void 0,void 0),e.func.apply(e.bound,e.opt)})):(-1===(i=this._waitingList.findIndex(this._sameURLRequest.bind(this,r)))&&(i=this._waitingList.findIndex(this._sameURLRequest.bind(this,n))),-1!==i&&(t=(o=this._waitingList.splice(i,1)[0]).callbacks,o.callbacks=[],t.forEach(function(e){e.opt.unshift(!1,void 0,void 0),e.func.apply(e.bound,e.opt)})))},updatePnORequests:function(e){for(let t=0;t<e.length;t++)e[t]&&this._updatePnoRequest(e[t])},_updatePnoRequest:function(e){let t,i,r=!1,n=!1,o=this.getDataSupplierUrl()+e.uuid+"/%l/%x/%y?tenant="+this._platformID;if(o=this.getDataSupplierUrlFromUrl(o),o=this.resolveUrlWithTimeStamp(o),(i=this._downloadList[o])?r=!0:-1!==(t=this._waitingList.findIndex(this._sameURLRequest.bind(this,o)))&&(i=this._waitingList[t],n=!0),i){n&&(this._downloadList[i.url]=this._waitingList.splice(t,1)[0]);var s="json"===i.options.responseType?e:JSON.stringify(e);this._addDatasetLogEntry(i),this._onComplete(i.url,s,null,200)}},_firstWithLowerPriority:function(e,t,i,r){if(t.priority<e)return!0},_sameURLRequest:function(e,t,i,r){if(t.url===e)return!0},_setGlobeService:function(e){e&&this._platformServicesList.push(e)},_onComplete:function(e,t,i,r){var n=this._downloadList[e];if(delete this._downloadList[e],n&&n.callbacks){var o,s,a,l=r;for(o=0,s=n.callbacks.length;o<s;++o)(a=n.callbacks[o]).opt.unshift(!0,t,l),a.func.apply(a.bound,a.opt)}n&&this._updateDatasetLogEntry(n,!0),this._startDownload()},_onFailure:function(e,t,i,r){var n,o,s,a=this._downloadList[e];if(delete this._downloadList[e],a&&a.callbacks)for(n=0,o=a.callbacks.length;n<o;++n)(s=a.callbacks[n]).opt.unshift(!1,i,t),s.func.apply(s.bound,s.opt);a&&this._updateDatasetLogEntry(a,!1),this._startDownload()},_resetLogForDataset:function(e){this._datasetLogs.has(e)&&(this._scheduledDataseLogsReset.delete(e),this._datasetLogs.delete(e),this._slowRasterSlotPendingUrl=null)},isAPlatformService:function(e){var t=!1;if(void 0!==this._platformID){e instanceof Array&&(e=e[0]);for(var i=this.resolveUrl(e),r=0,n=this._platformServicesList.length;r<n;r++)if(i.startsWith(this._platformServicesList[r])){t=!0;break}}return t},_globeServiceLogin:function(){if(void 0!==this._aliases.globe){var t=this;window.setInterval(function(){var i=t._aliases.globe+"/datasupplier/login?tenant="+t._aliases.platformId,r={method:"GET",type:"json",onComplete:function(e,t,i){console.log("Logged to 3DGlobe service")},onFailure:function(e,t,i){console.error("Unable to log on 3DGlobe service")}};e.authenticatedRequest(i,r)},3e5)}},_loadTextureLOD:function(e,t,i,n,o,s,a){function l(e){var t=Math.log(e)/Math.LN2;return Math.floor(t)===t}function u(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(t))}var c=new Image;null!==s&&(c.crossOrigin=s?"use-credentials":"anonymous");var d=new r.ImageLoader;return d.addEventListener("load",function(t){var i,o,s;for(r.ImageUtils.nbTexturesBeingLoaded--,e.needsUpdate=!0,e.loadEndStatus="complete",!a||l(c.width)&&l(c.height)?e.image=c:(i=u(c.width),o=u(c.height),e.image.width=i,e.image.height=o,e.image.getContext("2d").drawImage(c,0,0,i,o)),n&&n(e),s=0;s<e.onLoadCallbacks.length;s++)e.onLoadCallbacks[s](e)}),d.addEventListener("error",function(t){r.ImageUtils.nbTexturesBeingLoaded--,o&&o(t.message),e.loadEndStatus="error"}),c.crossOrigin&&(d.crossOrigin=c.crossOrigin),d.load(t,c),r.ImageUtils.nbTexturesBeingLoaded++,e.sourceFile=t,e},_startDownload:function(){var t=Object.keys(this._downloadList).length;if(0!==this._waitingList.length)if(t>=this._maxSimultaneousDownloads)n.publish("/XCityTools/Downloader/isBusy");else{var i=this._getDownloadRequest(0);this._downloadList[i.url]=i,this._addDatasetLogEntry(i);var o=i.options.withCredentials||this.isAPlatformService(i.url);if(i.options.image){var s=r.ImageUtils;void 0!==i.textureLOD?this._loadTextureLOD(i.textureLOD,i.url,void 0,i.options.onComplete,i.options.onFailure,o):(s.crossOrigin=o?"use-credentials":"anonymous",i.url.indexOf(".dds")===i.url.length-4?s.loadCompressedTexture(i.url,void 0,i.options.onComplete,i.options.onFailure,o):i.url.indexOf(".basis")===i.url.length-6||i.options.basis?s.loadBasisTexture(i.url,void 0,i.options.onComplete,i.options.onFailure,o,r.BasisUsage.RGBA):i.url instanceof Array?s.loadTextureCube(i.url,void 0,i.options.onComplete,i.options.onFailure,o):s.loadTexture(i.url,void 0,i.options.onComplete,i.options.onFailure,o))}else{let t;t=o&&"xCityFakePlatform"!==this._platformID?e.authenticatedRequest(i.url,i.options).cancel:e.request(i.url,i.options).cancel,this._downloadList[i.url].cancelDownload=t}}else 0===t&&n.publish("/XCityTools/Downloader/isFree")},loadTexture:function(e,t,i){if(!(t instanceof Array)&&this.wasAPlatformService(t)){var r=t.split("resources/");if(2===r.length){var n=r[1].split("?")[0],o=this.getUuidFromUrl(t);t=this.getDataSupplierUrl()+o+"/resources/"+n+"?tenant="+this._platformID}}this.download(t,{image:!0},void 0!==i?i:999999,function(e,t,i,r){r(t,e,i)},void 0,e)},loadJSON:function(e,t,i){this.download(t,{},void 0!==i?i:99999,function(e,t,i,r){r(t,e,i)},void 0,e)},authenticatedRequest:function(t,i){e.authenticatedRequest(t,i)},getUrlOptions:function(e){if(e){var t=e.split("?")[1],i="";return Utils.is(t)&&(i+="?"+t),i}return null},_getDatasetIDFromUrl(e){const t=function(e){return-1!==e.search("http://")?e.substring("http://".length,e.length):-1!==e.search("https://")?e.substring("https://".length,e.length):null},i=this.getUuidFromUrl(e);if(i)return i;if(-1!==e.search("/[0-9]+/[0-9]+/[0-9]+")){return t(e.substring(0,e.search("/[0-9]+/[0-9]+/[0-9]+")))}if(-1!==e.search("&x=[0-9]+&y=[0-9]+&z=[0-9]+")){return t(e.substring(0,e.search("&x=[0-9]+&y=[0-9]+&z=[0-9]+")))}return null},getUuidFromUrl:function(e){if(!e||!e.split)return null;var t,i=e.split("/datasupplier/dataset/");if(2===i.length){if((t=i[1].split("/")).length>0)return t[0]}else if(2===(i=e.split("/datasupplier/")).length&&(t=i[1].split("/")).length>0)return t[0];return null},getDataSupplierUrl:function(e){return e?"%globe%/datasupplier/":"%globe%/datasupplier/dataset/"},getDataSupplierUrlFromUrl:function(e){if(this.wasAPlatformService(e)){var t=this.getUrlOptions(e),i=this.getUuidFromUrl(e),r=this.getDataSupplierUrl();return Utils.is(i)&&(r+=i+"/"),!0===window.URBANODT&&(r+=".response"),Utils.is(t)&&(r+=t),r}return e},_failedServiceUrl:function(e){console.warning("failedGetServiceUrl",e)},_failedPlatformServices:function(e){console.warning("failedGetPklatformservices",e)},getResourcesUrlFromUrl:function(e){if(this.isAPlatformService(e)){var t=this.getUrlOptions(e),i=this.getUuidFromUrl(e),r=this.getDataSupplierUrl();return Utils.is(i)?(r+=i+"/",r+="resources/",Utils.is(t)&&(r+=t),r):e}return e},wasAPlatformService:function(e){if(Utils.is(e)){var t=this.isAPlatformService(e);if(!t)2===e.split("datasupplier/").length&&(t=!0);return t}return!1}};var c=null;return null===c&&(c=new u),c}),define("DS/XCityTools/TextureManager",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/Utils","DS/XCityTools/AtlasPacker","DS/XCityTools/TextureTools","DS/XCityTools/Downloader"],function(e,t,i,r,n,o){"use strict";var s=e.singleton({init:function(){this._textures={},this._atlases={},this._waitingList={},this._waiting=!1},ATLASSIZE:800,COMPLETESTATUS:"complete",FAILURESTATUS:"failed",LOADINGSTATUS:"loading",addTexture:function(e,t){i.is(this._textures[e])&&(this._textures[e].shared--,this._textures[e]=null),this._textures[e]=t,i.is(t.shared)?t.shared++:t.shared=1},getTexture:function(e){var t;return i.is(e)&&(i.is(this._atlases)&&i.is(this._atlases[e])&&(t=this._atlases[e].atlas),!i.is(t)&&i.is(this._textures)&&(t=this._textures[e])),t},getTexturesToLoad:function(e){var t,r,n,o,a,l,u=[],c=Object.keys(e),d=c.length;for(t=0;t<d;t++){var h=(r=c[t]).indexOf("Url");if(h>-1&&h===r.length-3){a=(l=(n=r.slice(0,h))+"Atlas")+"Id",o=e[r],u.push({url:o,paramUrl:r,param:n,atlas:l,atlasId:a});var f=s.getTexture(o);i.is(f)&&(e[n]=f),f=s.getTexture(e[a]),i.is(f)&&(e[l]=f)}}return u},getOrDownloadTexture:function(e,t){var r=this.getTexture(e);return i.is(r)?i.is(t)&&t(r,!0,e):this.downloadTexture(e,t),r},textureDownloaded:function(e,t,r){if(i.is(this._waitingList[e])){r||(Utils.is(this._failureList)||(this._failureList={}),this._failureList[e]={});for(var n=this._waitingList[e].callbacks,o=0;o<n.length;o++)Utils.is(n[o])&&n[o](t,r,e);delete this._waitingList[e]}Object.keys(this._waitingList).length<=0&&this.allTexturesLoaded()},allTexturesLoaded:function(){if(i.is(this._doneCallbacks)){var e,t,r=this._doneCallbacks.length;for(e=0;e<r;e++)t=this._doneCallbacks[e],i.is(t)&&t()}this._doneCallbacks=null,this._waiting=!1},callWhenDoneOnce:function(e){this._waiting?(i.is(this._doneCallbacks)||(this._doneCallbacks=[]),this._doneCallbacks.push(e)):e()},isAnAtlas:function(e){return i.is(this._atlases[e])},addCallbackToAtlas:function(e,t){var r=this._atlases[e];i.is(r)&&i.is(t)&&(this.isComplete(e)?t(this._atlases[e]):(i.is(r.callbacks)||(r.callbacks=[]),r.callbacks.push(t)))},downloadTexture:function(e,t){if(this.isAnAtlas(e))this.addCallbackToAtlas(e,t);else if(i.is(this._waitingList[e]))i.is(t)&&this._waitingList[e].callbacks.push(t);else{this._waitingList[e]={status:this.LOADINGSTATUS,callbacks:[]},this._waiting=!0;var r=this;o.loadTexture(function(i,n,o){t(i,n,e),r.textureDownloaded(e,i,n)},e,999999)}},getorDownloadAlltextures:function(e,t){var i=0,r=e.length;for(i=0;i<r;i++){var n=e[i];this.getOrDownloadTexture(n,t)}},shouldLoadMap:function(e,t){if(i.is(e)){if(!i.is(t))return!0;if(t.name&&"DefaultWhiteTexture"===t.name)return!0}return!1},makeAtlasFromUrls:function(e,t){var r;if(i.is(e))if(r=this.getAtlasFromUrls(e),i.is(r))this.getOrDownloadTexture(r,t);else{r=this.addAtlas(e);var n=e.length,o=this,s={};this.getorDownloadAlltextures(e,function(e,i,a){if(i){if(n--,s[a]=e,n<=0){var l=o.makeAtlasFromTextures(r,s);t&&t(l)}}else console.error("texture could not be loaded",a),console.error("atlas could not be created")})}return r},getAtlasFromUrls:function(e){var t,i,r,n,o=Object.keys(this._atlases),s=o.length;for(t=0;t<s;t++){i=o[t],r=this._atlases[i];var a=e.indexOf(i);if(n=a>=0?(n=e.slice(0,a)).concat(e.slice(a+1,e.length)):e.slice(),!this.doesAtlasHaveAllMaps(r,n))break}return t<s?i:null},doesAtlasHaveMap:function(e,t){return i.is(e.urls[t])},doesAtlasHaveAllMaps:function(e,t){var i,r,n=t.length;for(i=0;i<n&&(r=t[i],this.doesAtlasHaveMap(e,r));i++);return i<n},findnewatlasId:function(){for(var e=0,t="atlas."+e;i.is(this._atlases[t]);)e++,t=t.split(".")[0]+"."+e;return t},addAtlas:function(e){var t=this.findnewatlasId();i.is(this._atlases[t])&&(t=this.findnewatlasId()),this._atlases[t]={_status:this.LOADINGSTATUS,urls:{}};var r,n,o=e.length;for(r=0;r<o;r++)n=e[r],this._atlases[t].urls[n]=!0;return t},prepareTexture:function(e,t){var i={texture:e,url:t,getWidth:function(){return this.texture.image.width},getHeight:function(){return this.texture.image.height},getUrl:function(){return this.url}};return i},makeAtlasFromTextures:function(e,t){var i,n,o=new r(1/0,1/0,!1),s=0,a=Object.keys(t),l=a.length;for(s=0;s<l;s++){n=a[s];var u=this.prepareTexture(t[n],n);o.makeBlock(u)}return o.Build(),o.getAtlasCount()>1?(console.error("atlas too big no complete rendering is possible"),i=null):(this.completeAtlas(e,o),i=this.getAtlas(e)),i},getAtlas:function(e){return this._atlases[e]},completeAtlas:function(e,t){this._atlases[e].blockList=t.getBlocksInAtlasByIndex(0),this._atlases[e].width=t.getAtlasWidth(0),this._atlases[e].height=t.getAtlasHeight(0);var r=n.generateAtlasFromBlocks(this._atlases[e].blockList,this._atlases[e].width,this._atlases[e].height);this._atlases[e].atlas=r,this._atlases[e]._status=this.COMPLETESTATUS,this._atlases[e].X=[],this._atlases[e].Y=[],this._atlases[e].W=[],this._atlases[e].H=[];var o,s,a,l,u,c=this._atlases[e].blockList,d=c.length,h=this._atlases[e].width,f=this._atlases[e].height;for(o=0;o<d;o++){var p=c[o],m=p.texture.url;this._atlases[e].urls[m]=o,s=p.getX()/h,a=(f-(p.getY()+p.getHeight()))/f,l=p.getWidth()/h,u=p.getHeight()/f,this._atlases[e].X.push(s),this._atlases[e].Y.push(a),this._atlases[e].W.push(l),this._atlases[e].H.push(u)}if(i.is(this._atlases[e].callbacks)){for(d=this._atlases[e].callbacks.length,o=0;o<d;o++)this._atlases[e].callbacks[o](r);this._atlases[e].callbacks=null}},getTextureInfoByIndex:function(e,t){var r=null;if(i.is(e)&&i.is(this._atlases[e])&&i.is(this._atlases[e].blockList)){this._atlases[e].blockList[t];var n=this._atlases[e].width,o=this._atlases[e].height;r={index:t,x:this._atlases[e].X[t],y:this._atlases[e].Y[t],width:this._atlases[e].W[t],height:this._atlases[e].H[t],atlasWidth:n,atlasHeight:o}}return r},getTextureInfoByUrl:function(e,t){var r=null;if(i.is(t)){var n=this.getAtlas(t);if(this.doesAtlasHaveMap(n,e)){var o=this.getTextureIndex(t,e);r=this.getTextureInfoByIndex(t,o)}}else if(i.is(this._textures[e])){var s=this._textures[e];r={index:0,width:s.image.width,height:s.image.height}}else if(i.is(this._waitingList[e])&&i.is(this._waitingList[e].output)){var a=this._waitingList[e].output;r={index:0,width:a.width,height:a.height,texturenotloaded:!0}}return r},getTextureIndex:function(e,t){var r=0;if(i.is(e)&&i.is(this._atlases[e])&&(this.isComplete(e)||(r=null),i.is(this._atlases[e].urls)&&i.is(this._atlases[e].urls[t]))){var n=this._atlases[e].urls[t];!0!==n&&(r=n)}return r},isComplete:function(e){var t=!1;return i.is(this._atlases[e])&&this._atlases[e]._status===this.COMPLETESTATUS&&(t=!0),t},getAtlasDescription:function(e){return i.is(this._atlases[e])?this.isComplete(e)?{x:this._atlases[e].X,y:this._atlases[e].Y,width:this._atlases[e].W,height:this._atlases[e].H}:null:{x:[0],y:[0],width:[1],height:[1]}},getAtlasSize:function(e){return i.is(this._atlases[e])&&this.isComplete(e)?{width:this._atlases[e].width,height:this._atlases[e].height}:null},isWaitingForTextures:function(){return this._waiting},waitForTexture:function(e,t){i.is(t)&&(i.is(this._waitingList[e])?this._waitingList[e].status===this.LOADINGSTATUS?this._waitingList[e].callbacks.push(t):Utils.is(this._failureList[e])?t(null,!1,e):this._waitingList[e].status===this.COMPLETESTATUS&&t(this.getTexture(e),!0,e):(this._waitingList[e]={status:this.LOADINGSTATUS,callbacks:[t]},this._waiting=!0))},getOrCreateGlypheTexure:function(e,t,i){var r=this.getTexture(e);if(Utils.is(r))return r;if(Utils.is(this._waitingList[e]))return this.waitForTexture(e,i),this._waitingList[e].output;var o=this,s=n.generateGlypheTexture(t.name,t,function(t){o.textureDownloaded(e,t,!0),o.addTexture(e,t)});return this._waitingList[e]={status:this.LOADINGSTATUS,callbacks:[i],output:s},s},removeTexture:function(e){var t=this.getTexture(e);if(i.is(t))i.is(t.shared)&&t.shared--,delete this._textures[e];else if(i.is(this._waitingList[e])){var r=this;this.waitForTexture(e,function(t,i,n){setTimeout(r.removeTexture.bind(r,e),1e3)})}else i.is(this._failureList)&&i.is(this._failureList[e])&&console.warn("texture could not be loaded, you cannot remove it ...")}});return s}),define("DS/XCityTools/RenderingTools",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/ColorGradient","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils","DS/XCityTools/Expression","DS/XCityTools/ShaderTools","DS/XCityTools/TextureManager"],function(e,t,i,r,n,o,s,a){"use strict";var l=e.singleton({init:function(){},getJSONFromRendering:function(e){return l._RenderingToJSON(e)},_CollectionToRendering:function(e,t){var i=e;if(n.is(e)){var r,o,s,a,u=Object.keys(e),c=u.length;if(n.is(t.init))i=t.init(e);else if(n.is(t.collectionType)){var d=l._types[t.collectionType];if(n.is(d))for(r=0;r<c;r++)s=e[o=u[r]],n.is(s)&&(a=l._initAttributeValue(s,d)),n.is(i)||(i=Array.isArray(e)?[]:{}),i[o]=a}}return i},_boundAttributeValue:function(e,t){var i=e;if(Array.isArray(e)){for(var r=0;r<e.length;r++)e[r]=l._boundAttributeValue(e[r],t);return e}return"number"==typeof i&&(n.is(t.min)&&(i=Math.max(i,t.min)),n.is(t.max)&&(i=Math.min(i,t.max))),n.is(t.valuesIn)&&(i=t.valuesIn[i],n.is(i)||(i=void 0)),i},_initSimpleAttributeValue:function(e,t){var i;return i=n.is(t.init)?t.init(e):l._types.none.init(e),i=l._boundAttributeValue(i,t)},_initAttributeValue:function(e,t){var i;return n.is(t)&&(i=n.is(t.children)?l._JSONToRendering(e,t.children):n.is(t.collectionType)?l._CollectionToRendering(e,t):l._initSimpleAttributeValue(e,t)),i},_JSONToRendering:function(e,t){if(!n.is(e))return null;n.is(t)||(t=l._renderingParams);var i,r,o=Object.keys(e),s=o.length,a={};for(i=0;i<s;i++){"_alphaTest"===(r=o[i])&&(r="alphaTest"),"_transparent"===r&&(r="transparent"),"_opacity"===r&&(r="opacity"),"_visible"===r&&(r="visible"),"_side"===r&&(r="side");var u=t[r];if(n.is(u)){var c,d=e[r],h=l._types[u];c=l._initAttributeValue(d,h),a[r]=c}}return a},_RenderingToRendering:function(e,t,i){if(n.is(e)&&n.is(t)){n.is(i)||(i=l._renderingParams);var r,o,s=Object.keys(t),a=s.length;for(o=0;o<a;o++){"_alphaTest"===(r=s[o])&&(r="alphaTest"),"_transparent"===r&&(r="transparent"),"_opacity"===r&&(r="opacity"),"_visible"===r&&(r="visible"),"_side"===r&&(r="side");var u=i[r];if(n.is(u)){var c,d=l._types[u];n.is(d.children)?(c=n.is(e[r])?e[r]:{},l._RenderingToRendering(c,t[r],d.children),e[r]=c):n.is(d.copy)?d.copy(e,t,r):l._types.none.copy(e,t,r)}}}},_RemoveRendering:function(e,t,i){if(n.is(e)&&n.is(t)){n.is(i)||(i=l._renderingParams);var r,o,s=Object.keys(t),a=s.length;for(o=0;o<a;o++){"_alphaTest"===(r=s[o])&&(r="alphaTest"),"_transparent"===r&&(r="transparent"),"_opacity"===r&&(r="opacity"),"_visible"===r&&(r="visible"),"_side"===r&&(r="side");var u=i[r];if(n.is(u)){var c=l._types[u];n.is(c.remove)?c.remove(e,t,r):l._types.none.remove(e,t,r)}}}},_RenderingToRenderingNoAdd:function(e,t,i){var r;if(n.is(e)&&n.is(t))for(r in n.is(i)||(i=l._renderingParams),t)if(t.hasOwnProperty(r)&&("_alphaTest"===r&&(r="alphaTest"),"_transparent"===r&&(r="transparent"),"_opacity"===r&&(r="opacity"),"_visible"===r&&(r="visible"),"_side"===r&&(r="side"),void 0!==e[r])){var o,s=i[r];if(!n.is(s))continue;var a=l._types[s];n.is(a.children)?(o={},l._RenderingToRendering(o,t[r],a.children),e[r]=o):n.is(a.copy)?a.copy(e,t,r):l._types.none.copy(e,t,r)}},_RenderingToJSON:function(e,t){if(!n.is(e))return null;n.is(t)||(t=l._renderingParams);var i,r={};for(i in e)if(e.hasOwnProperty(i)){"_alphaTest"===i&&(i="alphaTest"),"_transparent"===i&&(i="transparent"),"_opacity"===i&&(i="opacity"),"_visible"===i&&(i="visible"),"_side"===i&&(i="side");var o=t[i];if(!n.is(o))continue;var s,a=e[i],u=l._types[o];n.is(u.children)?s=l._RenderingToJSON(a,u.children):(s=n.is(u.save)?u.save(a):l._types.none.save(a),n.is(u.valuesOut)&&(s=u.valuesOut[s])),r[i]=s}return r},_RenderingToJSONExpression:function(e,t){if(!n.is(e))return null;n.is(t)||(t=l._renderingParams);var i,r={};for(i in e)if(e.hasOwnProperty(i)){"_alphaTest"===i&&(i="alphaTest"),"_transparent"===i&&(i="transparent"),"_opacity"===i&&(i="opacity"),"_visible"===i&&(i="visible"),"_side"===i&&(i="side");var o=t[i];if(!n.is(o))continue;var s,a=e[i],u=l._types[o];n.is(u.children)?s=l._RenderingToJSONExpression(a,u.children):(s=n.is(u.addexpression)?u.addexpression(a):l._types.none.addexpression(a),n.is(u.valuesOut)&&(s=u.valuesOut[s])),r[i]=s}return r},_ExpressionToEval:function(e,t,i){if(!n.is(e))return null;n.is(i)||(i=l._renderingParams);var r,o={};for(r in e)if(e.hasOwnProperty(r)){"_alphaTest"===r&&(r="alphaTest"),"_transparent"===r&&(r="transparent"),"_opacity"===r&&(r="opacity"),"_visible"===r&&(r="visible"),"_side"===r&&(r="side");var s=i[r];if(!n.is(s))continue;var a,u=e[r],c=l._types[s];n.is(c.children)?a=l._ExpressionToEval(u,t,c.children):(a=n.is(c.evaluateexpression)?c.evaluateexpression(u,t):l._types.none.evaluateexpression(u,t),n.is(c.valuesOut)&&(a=c.valuesOut[a])),o[r]=a}return o},_setMaterialFromProfile:function(e,t){l._RenderingToRendering(e,t)},_setMaterialFromProfileNoAdd:function(e,t){l._RenderingToRenderingNoAdd(e,t)},_setColor:function(e,i,r){n.is(i[r])&&("string"==typeof i[r]?l._setValue(e,i,r):(n.is(e[r])&&e[r]instanceof t.Vector3||(e[r]=new t.Color),e[r].copy(i[r])))},_setVector2:function(e,i,r){n.is(i[r])&&("string"==typeof i[r]?l._setValue(e,i,r):(n.is(e[r])&&e[r]instanceof t.Vector2||(e[r]=new t.Vector2),e[r].copy(i[r])))},_setVector3:function(e,i,r){n.is(i[r])&&("string"==typeof i[r]?l._setValue(e,i,r):(n.is(e[r])&&e[r]instanceof t.Vector3||(e[r]=new t.Vector3),e[r].copy(i[r])))},_setValue:function(e,t,i){n.is(t[i])&&(e[i]=t[i])},_setArrayOrNull:function(e,t,i){n.is(t[i])&&n.is(t[i].slice)?e[i]=t[i].slice():l._setEvenIfNull(e,t,i)},_setMapUrl:function(e,t,i){var r=i;void 0!==t[r]&&(e[r]=t[r])},_setEvenIfNull:function(e,t,i){void 0!==t[i]&&(e[i]=t[i])},_setMap:function(e,i,r){void 0!==i[r]&&(e[r]=i[r],e instanceof t.Material&&e.isPDSFX()&&"map"===r&&(null===i[r]||n.is(i[r+"Params"])&&!1===i[r+"Params"].enable)&&(e[r]=s.whiteMap))},_setDiffuseAndAmbient:function(e,t,i){if(n.is(t[i])){var r="ambient";n.is(t.diffuse)||(t.diffuse=t[i]),l._setColorGradient(e,t,"diffuse"),n.is(t[r])||(t[r]=t[i]),l._setColorGradient(e,t,r),l._setColorGradient(e,t,i)}},_setColorGradient:function(e,t,r){n.is(t[r])&&("string"==typeof t[r]?l._setValue(e,t,r):n.is(e[r])&&e[r]instanceof i?e[r].copy(t[r]):e[r]=new i(t[r]))},_setAlphaTest:function(e,i,r){n.is(i[r])&&(e instanceof t.Material?n.is(e[r])&&(n.is(e.defines)&&n.is(e.defines.ALPHATEST)?(e.defines.ALPHATEST=i[r],e.alphaTest=0):e.isPDSFX()?(e[r+"City"]=i[r],n.is(e.alphaTest)&&(e.alphaTest=0)):e[r]=i[r]):e[r]=i[r])},_setPlusUpdateMaterial:function(e,i,r){n.is(i[r])&&(e instanceof t.Material?n.is(e[r])&&n.is(e.needsUpdate)&&e[r]!==i[r]&&(e.needsUpdate=!0,e[r]=i[r]):e[r]=i[r])},_initDashPattern:function(e){var i;if(n.is(e)){var r=e;e instanceof t.Vector2&&(r=[e.x,e.y]),e instanceof t.Vector3&&(r=[e.x,e.y,e.z]);var o,s=r.length;if(n.is(s)&&s>0){var a=s;for(a%2&&(a*=2),i=new Float32Array(a),o=0;o<a;o++)i[o]=r[o%s],o>0&&(i[o]+=i[o-1])}}return i},_initValue:function(e){return e},_initColor:function(e){"object"==typeof e&&(e="rgb("+Math.floor(255*e.r)+","+Math.floor(255*e.g)+","+Math.floor(255*e.b)+")");return new t.Color(e)},_initColorGradient:function(e){if(n.is(e)){var r;if(e instanceof t.Color)r=e;else{if("object"==typeof e){if(!(n.is(e.r)&&n.is(e.g)&&n.is(e.b))){if(n.is(e.start)&&n.is(e.start.color)&&(e.start.color=l._initColor(e.start.color)),n.is(e.mid)&&n.is(e.mid.color)&&(e.mid.color=l._initColor(e.mid.color)),n.is(e.end)&&n.is(e.end.color)&&(e.end.color=l._initColor(e.end.color)),n.is(e.keyframes)){var o,s=e.keyframes.length;for(o=0;o<s;o++){var a=e.keyframes[o];n.is(a)&&n.is(a.color)&&(a.color=l._initColor(e.keyframes[o].color))}}return new i(e)}e="rgb("+Math.floor(255*e.r)+","+Math.floor(255*e.g)+","+Math.floor(255*e.b)+")"}r=new t.Color(e)}return new i(r)}},_initUrl:function(e){var t=null;return"string"==typeof e&&(t="null"===e?null:e),t},_initBool:function(e){return"string"==typeof e?"false"!==e&&("true"===e||e):"boolean"==typeof e&&e},_initInt:function(e){var t=l._initFloat(e);return n.is(t)&&"string"!=typeof e&&(t=Math.round(t)),t},_initFloat:function(e){var t;return"string"==typeof e?(t=Number(e),n.is(t)||(t=e)):"number"==typeof e&&(t=e),t},_initNbVertices:function(e,t){var i;if(Array.isArray(e))i=[l._initFloat(e[0]),l._initInt(e[1])];else if("object"==typeof e)n.is(e[0])?i=[l._initFloat(e[0]),l._initInt(e[1])]:n.is(e.x)&&(i=[l._initInt(e.x),l._initInt(e.y)]);else if("number"==typeof(i=l._initInt(e)))i=[e,e];else if("string"==typeof e){var r=(e=(e=e.replace("[","")).replace("]","")).split(/,|;|\s/);if(2===r.length){var o=Number(r[0]),s=Number(r[1]);i=isNaN(o)||isNaN(s)?e:[l._initInt(o),l._initInt(s)]}else i=e}return i},_initVector2:function(e){var i;if("object"==typeof e)n.is(e[0])?i=new t.Vector2(l._initFloat(e[0]),l._initFloat(e[1])):n.is(e.x)&&(i=new t.Vector2(l._initFloat(e.x),l._initFloat(e.y)));else if("number"==typeof(i=l._initFloat(e)))i=new t.Vector2(e,e);else if("string"==typeof e){var r=(e=(e=e.replace("[","")).replace("]","")).split(/,|;|\s/);if(2===r.length){var o=Number(r[0]),s=Number(r[1]);i=isNaN(o)||isNaN(s)?e:new t.Vector2(o,s)}else i=e}return i},_initVector3:function(e){var i;if("object"==typeof e)n.is(e[0])?i=new t.Vector3(l._initFloat(e[0]),l._initFloat(e[1]),l._initFloat(e[2])):n.is(e.x)&&(i=new t.Vector3(l._initFloat(e.x),l._initFloat(e.y),l._initFloat(e.z)));else if("number"==typeof(i=l._initFloat(e)))i=new t.Vector3(e,e,e);else if("string"==typeof e){var r=(e=(e=e.replace("[","")).replace("]","")).split(/,|;|\s/);if(3===r.length){var o=Number(r[0]),s=Number(r[1]),a=Number(r[2]);i=isNaN(o)||isNaN(s)||isNaN(a)?e:new t.Vector3(o,s,a)}else i=e}return i},_initMap:function(e){if(null===e)return null;if(n.is(e))if("object"!=typeof e);else;},_saveDashPattern:function(e){var t=e;if(n.is(e)&&e.length){var i=e.length,r=i;t=[];let n=!1,s=100;do{t=e;for(var o=r-1;o>0;o--)t[o]-e[o-1]<=0&&(n=!0);for(o=r-1;o>=0&&!n;o--)t[o]=e[o],o>0&&(t[o]-=e[o-1]);4===i?t[2]===t[3]&&(n=!0):2===i?(t[0]===t[1]&&(n=!0),t[0]/3==t[1]/2&&(n=!0)):n=!0}while(!n&&--s)}return t instanceof Float32Array?Array.from(t):t},_saveValue:function(e){return e},_saveColor:function(e){var i;return n.is(e)&&n.is(e instanceof t.Color)&&(i="#"+e.getHexString()),i},_saveMap:function(e){return null===e?null:"object"==typeof e?l._RenderingToJSON(e,l._types.map.children):void 0},_saveVector2:function(e){return n.is(e)?[e.x,e.y]:null},_saveVector3:function(e){return n.is(e)?[e.x,e.y,e.z]:null},_saveColorGradient:function(e){if(n.is(e))return"#"+e.getHexString()},_removeValue:function(e,t,i){void 0!==e[i]&&delete e[i]},_addExpression:function(e){return new o(e)},_evaluateExpression:function(e,t){return t.setExpression(e),t.apply()},_removeDiffuseAndAmbient:function(e,t,i){var r=e[i];if(n.is(r)){var o=e.diffuse;n.is(o)&&o.getHexString()===r.getHexString()&&l._removeValue(e,t,"diffuse");var s=e.ambient;n.is(s)&&s.getHexString()===r.getHexString()&&l._removeValue(e,t,"ambient"),l._removeValue(e,t,i)}},_addParamsToTexture:function(e,t){n.is(t)&&(n.is(t.wrapS)&&(e.wrapS=t.wrapS),n.is(t.wrapT)&&(e.wrapT=t.wrapT),n.is(t.minFilter)&&(e.minFilter=t.minFilter),n.is(t.magFilter)&&(e.magFilter=t.magFilter),n.is(t.anisotropy)&&(e.anisotropy=t.anisotropy),n.is(t.generateMipmaps)&&(!0===t.generateMipmaps?e.generateMipmaps=!0:e.generateMipmaps=!1))},_setMaterialMapFromProfile:function(e,t,i){if(n.is(e)&&n.is(t))for(var r=this,o=function(o,l){if(n.is(l)){a.addTexture(o.url,l),r._addParamsToTexture(l,t);var u=t[o.param+"Params"];n.is(u)||(u={}),t[o.param+"Params"]=u,r._addParamsToTexture(l,t[o.param+"Params"]),t[o.param]=l,n.is(l.shared)?l.shared++:l.shared=1,t[o.param+"Params"]&&!1===t[o.param+"Params"].enable?e[o.param]=s.whiteMap:e[o.param]=t[o.param],n.is(i)&&i.onTextureApplied(e[o.param],e,t,o),s.updateCommonUniforms(e),e.updateDeferredMaterials&&(e._deferredMaterialsInit=!1)}else console.warn("Could not load texture : "+t[o.paramUrl])},l=a.getTexturesToLoad(t),u=0;u<l.length;++u){if(void 0===t[l[u].param]&&void 0===t[l[u].paramUrl])return;a.shouldLoadMap(t[l[u].paramUrl],t[l[u].param])&&(n.is(i)&&i.onTextureDownloadStart(e,t,l[u]),a.downloadTexture(t[l[u].paramUrl],o.bind(void 0,l[u]))),t[l[u].param+"Params"]&&!1===t[l[u].param+"Params"].enable?(e[l[u].param]=s.whiteMap,n.is(i)&&i.onTextureApplied(e[l[u].param],e,t,l[u])):e[l[u].param]!==t[l[u].param]&&(e[l[u].param]=t[l[u].param],n.is(i)&&i.onTextureApplied(e[l[u].param],e,t,l[u]))}}});return l._types={bool:{init:l._initBool},boolWithUpdate:{init:l._initBool,copy:l._setPlusUpdateMaterial},string:{},ratio:{init:l._initFloat,min:0,max:1},alphaTest:{init:l._initFloat,copy:l._setAlphaTest,min:0,max:1},positiveInt:{init:l._initInt,min:0},width:{init:l._initFloat,min:1},positiveFloat:{init:l._initFloat,min:0},float:{init:l._initFloat},int:{init:l._initInt},nbVertices:{init:l._initNbVertices,min:3,max:17},none:{init:l._initValue,copy:l._setValue,save:l._saveValue,remove:l._removeValue,addexpression:l._addExpression,evaluateexpression:l._evaluateExpression},basicColor:{init:l._initColor,copy:l._setColor,save:l._saveColor},map:{init:l._initMap,copy:l._setMap,save:l._saveMap},url:{init:l._initUrl,copy:l._setMapUrl},wrap:{init:l._initValue,valuesIn:{repeat:t.RepeatWrapping,clamp:t.ClampToEdgeWrapping,mirroredrepeat:t.MirroredRepeatWrapping,1000:t.RepeatWrapping,1001:t.ClampToEdgeWrapping,1002:t.MirroredRepeatWrapping},valuesOut:{1000:"repeat",1001:"clamp",1002:"mirroredrepeat"}},filter:{init:l._initValue,valuesIn:{nearest:t.NearestFilter,nearestmipmapnearest:t.NearestMipMapNearestFilter,nearestmipmaplinear:t.NearestMipMapLinearFilter,linear:t.LinearFilter,linearmipmapnearest:t.LinearMipMapNearestFilter,linearmipmaplinear:t.LinearMipMapLinearFilter,1003:t.NearestFilter,1004:t.NearestMipMapNearestFilter,1005:t.NearestMipMapLinearFilter,1006:t.LinearFilter,1007:t.LinearMipMapNearestFilter,1008:t.LinearMipMapLinearFilter},valuesOut:{1003:"nearest",1004:"nearestmipmapnearest",1005:"nearestmipmaplinear",1006:"linear",1007:"linearmipmapnearest",1008:"linearmipmaplinear"}},mapParams:{children:{enable:"bool",wrapS:"wrap",wrapT:"wrap",minFilter:"filter",magFilter:"filter",anisotropy:"positiveFloat",generateMipmaps:"bool",width:"width",height:"width"}},texturingMode:{valuesIn:{simple:"simple",cameraStop:"cameraStop",continuous:"continuous",screenSpace:"screenSpace"}},geometricMode:{init:l._initValue,valuesIn:{filled:"filled",line:"line",volumetric:"volumetric",extruded:"extruded"}},renderMode:{init:l._initValue,valuesIn:{occluded:"occluded",overlay:"overlay",dual:"dual"}},diffuseandambient:{init:l._initColorGradient,copy:l._setDiffuseAndAmbient,save:l._saveColorGradient,remove:l._removeDiffuseAndAmbient},color:{init:l._initColorGradient,copy:l._setColorGradient,save:l._saveColorGradient},gradientKeyframe:{children:{value:"none",color:"basicColor"}},side:{init:l._initInt,valuesIn:{0:t.FrontSide,1:t.BackSide,2:t.DoubleSide},copy:l._setPlusUpdateMaterial},roofMode:{init:l._initInt,valuesIn:{"-1":-1,0:0,1:1,2:2}},vector2:{init:l._initVector2,copy:l._setVector2,save:l._saveVector2},vector3:{init:l._initVector3,copy:l._setVector3,save:l._saveVector3},lineAnimation:{children:{enable:"bool",speed:"float",dashSize:"float",minOpacity:"ratio",gapSize:"float",samplingRate:"float",nbPoints:"positiveInt",loop:"bool",reverse:"bool"}},stroke:{children:{enable:"bool",opacity:"ratio",renderMode:"renderMode",opacityFactor:"ratio",minOpacity:"ratio",minDist:"positiveFloat",maxDist:"positiveFloat",lineWidth:"width",minWidth:"positiveFloat",dynamicUpdate:"bool",animation:"lineAnimation",color:"diffuseandambient",diffuse:"basicColor",ambient:"basicColor",specular:"basicColor",wireframe:"bool",alphaTest:"alphaTest",side:"side",shininess:"positiveInt",depthTest:"boolWithUpdate",depthWrite:"boolWithUpdate",dashPattern:"dashPattern",elevationOffset:"float"}},label:{children:{enable:"bool",onSelect:"bool",position:"labelPositioning",style:"labelStyling",styleName:"string",name:"string"}},labelPositioning:{children:{mode:"string",rotation:"vector3",geometryOffset:"vector3",labelOffset:"vector2",offset:"vector3",enableAutomaticFlip:"bool",isAligned:"bool",isRepeated:"bool"}},labelStyling:{children:{"background-color":"string",border:"string","border-bottom":"string","border-left":"string","border-radius":"string","border-right":"string","border-top":"string",color:"string","font-family":"string","font-size":"string","font-style":"string","font-weight":"string","letter-spacing":"string","line-height":"string",opacity:"string",padding:"string","text-align":"string","text-decoration":"string","text-shadow":"string","word-spacing":"string","-webkit-text-stroke":"string"}},linecap:{valuesIn:{round:"round",square:"square"}},taMode:{valuesIn:{elevation:"elevation",slope:"slope",orientation:"orientation",default:"default"}},cosineGradient:{children:{DCOffset:"vector3",Amplitude:"vector3",Frequency:"vector3",Phase:"vector3"}},terrainAnalyzer:{children:{mode:"taMode",min:"float",max:"float",gradient:"cosineGradient",elevationMin:"float",elevationMax:"float",slopeMin:"float",slopeMax:"float"}},blending:{valuesIn:{none:t.NoBlending,normal:t.NormalBlending,additive:t.AdditiveBlending,subtractive:t.SubtractiveBlending,multiply:t.MultiplyBlending,custom:t.CustomBlending,normaldepth:t.NormalDepthBlending,0:t.NoBlending,1:t.NormalBlending,2:t.AdditiveBlending,3:t.SubtractiveBlending,4:t.MultiplyBlending,5:t.CustomBlending,6:t.NormalDepthBlending},valuesOut:{0:"none",1:"normal",2:"additive",3:"subtractive",4:"multiply",5:"custom",6:"normaldepth"}},style:{valuesIn:{arrow:"arrow",point:"point",icon:"icon",placename:"placename",annotation:"annotation",annotationIcon:"annotationIcon",annotationIconAdvanced:"annotationIconAdvanced",custom:"custom"}},textStyle:{valuesIn:{button:"button",lite:"lite"}},textColor:{init:l._initColorGradient,copy:l._setColorGradient,save:l._saveColorGradient},descriptionDisplayMode:{valuesIn:{hover:"hover",click:"click",always:"always"}},elevationMode:{valuesIn:{geometry:"geometry",advanced:"advanced",ground:"ground"}},cubeMapUrl:{init:l._initCubeMapUrl,copy:l._setCubeMapUrl,save:l._saveCubeMapUrl},dashPattern:{init:l._initDashPattern,save:l._saveDashPattern,copy:l._setArrayOrNull,collectionType:"positiveFloat"},offset2d:{children:{x:"float",y:"float"}},offset3d:{children:{x:"float",y:"float",z:"float"}},offsetFunction:{children:{ratio:"vector3",pixel:"vector3",bbox:"offset3d"}},float02:{init:l._initFloat,min:0,max:2},highlightSet:{children:{color:"basicColor",intensity:"ratio",colorEnabled:"bool",outlineColor:"basicColor",outlineAlpha:"ratio",outlineEnabled:"bool",outlineThickness:"positiveInt",haloColor:"basicColor",haloIntensity:"float02",haloEnabled:"bool"}},shapeType:{valuesIn:{billboard:"billboard",disc:"disc",sphere:"sphere",pyramid:"pyramid",tube:"tube"}}},l._renderingParams={alphaTest:"alphaTest",altitude:"float",ambient:"color",animation:"lineAnimation",appearance:"positiveFloat",blending:"blending",classStyle:"string",color:"diffuseandambient",customClass:"string",depthTest:"boolWithUpdate",depthWrite:"boolWithUpdate",descriptionDisplayMode:"descriptionDisplayMode",diffuse:"color",dynamicUpdate:"bool",enableClipPlanes:"bool",enable:"bool",envMap:"map",envMapUrl:"url",extrusionHeight:"positiveFloat",forceSide:"bool",generateMipmaps:"bool",geometricMode:"geometricMode",gradient:"cosineGradient",height:"float",influenceRadius:"width",icon:"string",iconName:"string",label:"label",lightMap:"map",lightMapUrl:"url",lineWidth:"width",magFilter:"filter",map:"map",mapUrl:"url",mapAtlas:"map",mapAtlasId:"string",mapParams:"mapParams",maxDist:"positiveInt",minDist:"positiveInt",minFilter:"filter",minOpacity:"ratio",minWidth:"positiveInt",noGeometry:"bool",normalMap:"map",normalMapUrl:"url",renderingDescription:"string",styleClass:"string",elevationOffset:"float",elevation:"float",elevationMode:"elevationMode",terrainAnalyzer:"terrainAnalyzer",oceanAlpha:"ratio",oceanColor:"color",oceanColorDetection:"color",oceanRangeDetection:"float",oceanTexture:"map",oceanTextureUrl:"url",oceanTextureParams:"mapParams",opacity:"ratio",opacityFactor:"ratio",orientation:"float",r_mode:"roofMode",reflectivity:"ratio",refractionRatio:"ratio",reflectionCoef:"ratio",renderMode:"renderMode",roofTextures:"map",roofTexturesUrl:"url",scale:"vector3",shininess:"positiveInt",showOcean:"bool",side:"side",specular:"color",specularMap:"map",specularMapUrl:"url",style:"style",stroke:"stroke",textStyle:"textStyle",textColor:"textColor",transparent:"bool",wallTextures:"map",wallTexturesUrl:"url",weight:"float",wireframe:"bool",wireframeLinewidth:"positiveInt",wrapS:"wrap",wrapT:"wrap",slabColor:"color",cubeMapUrl:"url",cubeMapExt:"string",domeSize:"positiveFloat",cubeMap:"map",boundMin:"positiveInt",boundMax:"positiveInt",kernel:"positiveInt",dashPattern:"dashPattern",offsetUv:"vector2",repeatUv:"vector2",offsetFunction:"offsetFunction",highlightSet:"highlightSet",linecap:"linecap",texturingMode:"texturingMode",shapeType:"shapeType",nbVertices:"nbVertices",switchDistance:"positiveFloat",polyExtruOptim:"bool"},l});