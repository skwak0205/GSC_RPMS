define("DS/ENOMadeFromUX/service/MBMFServiceProvider",["UWA/Core","UWA/Class","UWA/Promise","DS/XSRCommonComponents/utils/RequestUtil","DS/XSRCommonComponents/utils/ItemServiceProvider","DS/XSRCommonComponents/utils/ResponseParser","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/Utils","DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"],function(e,t,r,n,s,o,i,a,u){"use strict";return t.extend({init:function(e){this.platFormId=n.getPlatformId(),this.CSRFToken=n.get3DSpaceCSRFToken(),this.SC=n.getSecurityContext(),e&&(this.SC=e)},getHeaders:function(e){var t={"Content-type":"application/json"};this.isChangeControlled&&Object.assign(t,n.getWorkUnderHeaders());const r=u.get();return r&&r.AuthoringContextHeader&&Object.assign(t,r.AuthoringContextHeader),e&&Object.keys(e).forEach(function(r){t[r]=e[r]}),t},getUOMTypes:function(e){var t=this;return new r(function(r,s){n.send3DSpaceRequest("resources/RawMaterial/v1/Raw_Material/getUOMsAvailableOnRM?objectPID="+e,"GET",{type:"json",headers:t.getHeaders({ENO_CSRF_TOKEN:t.CSRFToken,SecurityContext:t.SC})},r,s)})},connectMBMFItem:function(t,s,o){var i=this,a=i.SC?i.SC:o;return new r(function(r,o){n.send3DSpaceRequest("resources/v1/modeler/dsspec/dsspec:PhysicalProduct/"+s+"?$mask:dsspec:idMask","GET",{headers:i.getHeaders({ENO_CSRF_TOKEN:i.CSRFToken,SecurityContext:a})},function(u){var c=JSON.parse(u).member[0].cestamp;n.send3DSpaceRequest("resources/MadeFrom/v1/Physical_Prod/"+s+"/Made_From?cestamp="+c,"POST",{type:"json",headers:i.getHeaders({ENO_CSRF_TOKEN:i.CSRFToken,SecurityContext:a}),data:e.Json.encode(t)},r,o)},o)})},disconnectMBMFItem:function(e,t){var s=this;return new r(function(r,o){n.send3DSpaceRequest("resources/MadeFrom/v1/Physical_Prod/"+e+"/Made_From/"+t,"DELETE",{type:"json",headers:s.getHeaders({ENO_CSRF_TOKEN:s.CSRFToken,SecurityContext:s.SC})},r,o)})},getMBMFInfo:function(e){var t=this;return new r(function(r,s){n.send3DSpaceRequest("resources/MadeFrom/v1/Physical_Prod/"+e,"GET",{type:"json",headers:t.getHeaders({ENO_CSRF_TOKEN:t.CSRFToken,SecurityContext:t.SC})},r,s)})},updateMBMFInfo:function(t,s,o){var i=this;return new r(function(r,a){n.send3DSpaceRequest("resources/MadeFrom/v1/Physical_Prod/"+s+"/Made_From/"+o,"PUT",{type:"json",headers:i.getHeaders({ENO_CSRF_TOKEN:i.CSRFToken,SecurityContext:i.SC}),data:e.Json.encode(t)},r,a)})},updateAndSyncAttributes:function(e,t,n,o){var u={itemid:e,request:t,isRelorBus:o,relId:null};return new r(function(e,t){new s({isChangeControlled:!0}).updateAttributes(u).then(function(r){if(r.results&&r.results.length>0)for(var s=r.results,o=0;o<s.length;o++){if(200===s[o].status){var u=s[o].body;if(u.errors&&u.errors.length>0)t(u.errors);else{for(var c in u){var d=Array.isArray(u[c].value)?u[c].value[0]:u[c].value;i.ITEM_DESCRIPTION_SELECTABLE===c&&(n.options.grid["ds6w:description"]=d),"modified"===c&&(n.options.grid["ds6w:modified"]=a.getformatedDate(d)),i.ITEM_V_NAME_SELECTABLE===c&&n.setTitle(d)}n.updateOtherDetails(),e(n)}}else t()}}).catch(function(e){console.log(e)})})},fetchItemInfo:function(e){var t=this;return new r(function(r,n){(new s).fetchItemData(e,null).then(function(e){var s={serverResponse:e,withconfig:!0,createNode:!1};if(e.infos&&0===e.infos.nhits)return r([]);t._indexFormatFetchManager(s,r,n)}).catch(function(e){return n(e)})})},_indexFormatFetchManager:function(e,t,r){if(!e||!e.serverResponse||!Array.isArray(e.serverResponse.results))return r?r("invalid input : missing serverResponse"):null;var n=void 0!==e.createNode&&e.createNode;this.getEngItemsListFromServerFetch(e.serverResponse,e.uwaModel,e.withconfig,n).then(function(e){return t(e)}).catch(function(e){r(e)})},getEngItemsListFromServerFetch:function(e,t,n,s){var i=this;return new r(function(t,r){if(!Array.isArray(e.results))return r(e);var n=o.parseFetchResult(e,["ds6w:type","ds6w:status"]);i.resolveMissingNls(n.nlsTracker).then(function(e){return t(s?i.createListNodes(n.results,i.genericEngItemOptionsMapper.bind(i,e[0])):i._optionsRetrievor(n.results,i.genericEngItemOptionsMapper.bind(i,e[0])))}).catch(function(e){console.log(e)})})},resolveMissingNls:function(e){if(!Array.isArray(e.classes)||!e.properties)throw new Error("Ouups ! invalid input");var t=[];return t.push(a.getNlsOfPropertiesValues(e.properties)),r.all(t)},genericEngItemOptionsMapper:function(e,t){var r=[];return t.forEach(function(t){t["ds6w:created"]=a.getformatedDate(t["ds6w:created"]),t["ds6w:modified"]=a.getformatedDate(t["ds6w:modified"]),t["ds6w:type"]=e["ds6w:type"][t["ds6w:type_value"]],t["ds6w:status"]=e["ds6w:status"][t["ds6w:status_value"]],r.push(t)}),r},createListNodes:function(t,r){var n=[],s=this;return t.forEach(function(t){var o=s.createListNode(t,r);e.is(o)&&n.push(o)}),n},createListNode:function(e,t){var r=this._optionsRetrievor(e,t);return this.createGridModel(r)},_optionsRetrievor:function(t,r){return r&&"function"===e.typeOf(r)?r(t):t}})});