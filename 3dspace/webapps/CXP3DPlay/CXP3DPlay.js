define("DS/CXP3DPlay/expCoreLink/MediaDSXMStreamSolver",["UWA/Core","DS/ZipJS/zip"],function(e,r){"use strict";return{mediaBlobReaderMap:[],getStreamFromMedia:function(t,n){var i,o=this.mediaBlobReaderMap.map(e=>e.media).indexOf(n);return o>=0?(i=this.mediaBlobReaderMap[o]).useCount++:(i={media:n,blobReader:new r.BlobReader(n),useCount:1},this.mediaBlobReaderMap.push(i)),this._getEntries(i).then(r=>{for(var n=0;n<r.length;n++)if(r[n].filename===t)return this._getStreamFromEntry(r[n]);return e.Promise.reject(new Error("Cant retrieve file "+t+" in stream"))}).then(r=>(this._decreaseMediaBlobObjectUseCount(i),e.Promise.resolve(r))).catch(r=>(this._decreaseMediaBlobObjectUseCount(i),e.Promise.reject(r)))},_decreaseMediaBlobObjectUseCount:function(e){if(e.useCount--,0===e.useCount){e.zipReader&&e.zipReader.close();var r=this.mediaBlobReaderMap.map(e=>e.media).indexOf(e.media);this.mediaBlobReaderMap.splice(r,1)}},_getEntries:function(t){if(t.entries)return e.Promise.resolve(t.entries);if(t.entriesPromise)return e.Promise.resolve(t.entriesPromise);var n=e.Promise.deferred();return r.createReader(t.blobReader,function(e){t.zipReader=e,e.getEntries(function(e){t.entries=e,delete t.entriesPromise,n.resolve(e)})}),t.entriesPromise=n.promise,n.promise},_getStreamFromEntry:function(t){var n=e.Promise.deferred();return t.getData(new r.BlobWriter,function(e){e.name=t.filename,n.resolve(e)}),n.promise}}}),define("DS/CXP3DPlay/CXP3DPlayApp",["UWA/Core","UWA/Class"],function(e){"use strict";return e.Class.extend({init:function(e,r){e.onModelLoadingProgression&&e.onModelLoadingProgression({loaded:70,total:100});var t=this;return this._readMedia(e,r).then(function(e){t._xctEWSPlayMedia=e}).catch(function(e){console.error(e)})},_readMedia:function(){return e.Promise.reject(new Error("CXP3DPlayApp._initializeXCTEWSPlayMedia: Must be implemented by derived class"))},disposeExperienceBase:function(){if(this._xctEWSPlayMedia){var r=this;return this._xctEWSPlayMedia.dispose().then(function(){delete r._xctEWSPlayMedia})}return e.Promise.resolve()}})}),define("DS/CXP3DPlay/expCoreLink/ExpCoreLinkContextMediaStream",["UWA/Core","DS/CAT3DExpModel/expCoreLink/ExpCoreLinkContextStream"],function(e,r){"use strict";return r.extend({_getParentLinkContext:function(){return null},_getParentService:function(){return this._createExpCoreLinkService("ExpCoreLinkServiceMediaStream")}})}),define("DS/CXP3DPlay/interfaces/XCTEWSIPlayerOptionsMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],function(e,r){"use strict";return r.singleton({interfaceName:"XCTEWSIPlayerOptionsMgr",required:{setPlayerOptions:function(){},getPlayerOptions:function(){}},optional:{}})}),define("DS/CXP3DPlay/expCoreLink/ExpCoreLinkContextMedia",["UWA/Core","DS/CAT3DExpModel/expCoreLink/ExpCoreLinkContext"],function(e,r){"use strict";return r.extend({init:function(e,r){this._media=e,this._parent(e,r)},_getContent:function(){return this._media},_getService:function(e){if("Streams"===e)return this._createExpCoreLinkService("ExpCoreLinkServiceMediaStream")},_getParentLinkContext:function(){return null},_getParentService:function(){return null}})}),define("DS/CXP3DPlay/expCoreLink/MediaPlatformStreamSolver",["UWA/Core","DS/WAFData/WAFData"],function(e,r){"use strict";return{getStreamFromMedia:function(e,r){var t=this;return this._retrieveStreamInfo(e,r).then(function(e){return t._retrieveStream(e)})},_retrieveStreamInfo:function(t,n){var i=e.Promise.deferred(),o=n.serverurl+"/resources/experience/medias/"+n.physicalid+"/streams/"+t;return r.authenticatedRequest(o,{cache:-1,method:"GET",type:"json",headers:{"Content-Type":"application/json",SecurityContext:n.contextid},onComplete:function(e){e&&e.results&&e.results[0]&&i.resolve(e.results[0]),i.reject("Cant retrieve stream "+t)},onFailure:function(e){i.reject(new Error(e))}}),i.promise},_retrieveStream:function(e){return e.filename.endsWith(".json")?this._retrieveJSONStream(e):this._retrieveDefaultStream(e)},_retrieveJSONStream:function(t){var n=e.Promise.deferred();return r.authenticatedRequest(t.fcsurl,{timeout:1e5,method:"POST",data:"__fcs__jobTicket="+encodeURIComponent(t.ticket),type:"text",proxy:"passport",headers:{"Content-type":"application/x-www-form-urlencoded",Accept:"text/plain"},onComplete:function(e){n.resolve(e)},onFailure:function(e){n.reject(new Error(e))}}),n.promise.then(function(e){var r=new Blob([e],{type:"text/xml"});return r.name=t.filename,r})},_retrieveDefaultStream:function(t){var n=e.Promise.deferred();return r.authenticatedRequest(t.fcsurl,{timeout:1e5,method:"POST",data:"__fcs__jobTicket="+encodeURIComponent(t.ticket),type:"arraybuffer",proxy:"passport",headers:{Accept:"text/plain"},onComplete:function(e){n.resolve(e)},onFailure:function(e){n.reject(new Error(e))}}),n.promise.then(function(e){var r=new Blob([e],{type:"application/octet-binary"});return r.name=t.filename,r})}}}),define("DS/CXP3DPlay/XCTEWSPlayMedia",["UWA/Core","UWA/Class","DS/CAT3DExpModel/XCTEWSObjectModeler","DS/XCTWebExperienceAppPlay/CAT3DXModelFactoryPlay","DS/CAT3DExpModel/CAT3DXModel","DS/CXP3DPlay/expCoreLink/ExpCoreLinkContextMedia","DS/CXP3DPlay/expCoreLink/ExpCoreLinkContextMediaStream"],function(e,r,t,n,i,o,a){"use strict";let s;return localStorage.setItem("EWS_AuthoringV2","true"),e.Class.extend({readMedia:function(r,o,a){var d;return this._experienceBase=o,this._retrieveContentJSON(r).then(r=>{var t=e.Promise.deferred(),n=new FileReader;return n.onloadend=(e=>{t.resolve(JSON.parse(e.target.result))}),n.readAsText(r),t.promise}).then(r=>{var t=r.Runtime;d=r.Experience;const n=r.PlayerOptions?r.PlayerOptions:{};return a=e.extend(n,a),this._require(["text!"+t.Prototypes,"text!"+t.Interfaces,"text!"+t.Components,"text!"+t.Managers])}).then(e=>{var r=e[0],i=e[1],a=e[2];let d=e[3],c=JSON.parse(d);s=Object.keys(c);var l=new n({expObjectsFilter:["CXPNaturalLanguageInfo_Spec"],prototypes:JSON.parse(r)});return this._ews=new t,this._ews.initialize({experienceBase:o,factory:l,interfacesTable:JSON.parse(i),componentsTable:JSON.parse(a),managersTable:c})}).then(()=>{this._addExpCoreLinkMedia(r);for(let e=0;e<s.length;e++){let r=o.getManager(s[e]).QueryInterface("XCTEWSIPlayerOptionsMgr");r&&r.setPlayerOptions(a)}return i.LoadExperience(d)}).then(r=>{this._experience=r;let t=[];for(let e=0;e<s.length;e++){let n=o.getManager(s[e]).QueryInterface("XCTEWSIExperienceMgr");n&&t.push(n.onExperienceReady(r))}return e.Promise.allSettled(t)}).then(r=>{for(let e=0;e<r.length;e++)"rejected"===r[e].state&&console.error(r[e].reason);return e.Promise.resolve(this._experience)}).catch(r=>(console.error(r),e.Promise.reject(r)))},_addExpCoreLinkMedia:function(e){var r=i._getExpCoreLinkManager();r._addExpCoreLinkContext("ExpCoreLinkContextMedia",o),r._addExpCoreLinkContext("ExpCoreLinkContextMediaStream",a),r._addExpCoreLinkContextShortcut("localMedia","ExpCoreLinkContextMedia",e)},_require:function(r){var t=e.Promise.deferred();return require(r,function(){t.resolve(arguments)},function(e){t.reject(e)}),t.promise},dispose:function(){var r=i._getExpCoreLinkManager();r._removeExpCoreLinkContext("ExpCoreLinkContextMedia"),r._removeExpCoreLinkContext("ExpCoreLinkContextMediaStream"),r._removeExpCoreLinkContextShortcut("localMedia");let t=[];for(let e=0;e<s.length;e++){let r=this._experienceBase.getManager(s[e]).QueryInterface("XCTEWSIExperienceMgr");r&&t.push(r.onPreDisposeExperience(this._experience))}return e.Promise.allSettled(t).then(e=>{for(let r=0;r<e.length;r++)"rejected"===e[r].state&&console.error(e[r].reason);return i.CloseExperience()}).then(()=>this._ews.dispose()).then(()=>{s=[],delete this._experienceBase,delete this._experience}).catch(r=>(console.error(r),e.Promise.reject(r)))}})}),define("DS/CXP3DPlay/expCoreLink/ExpCoreLinkServiceMediaPlatformStream",["UWA/Core","UWA/Class","DS/CAT3DExpModel/expCoreLink/ExpCoreLinkService","DS/CXP3DPlay/expCoreLink/MediaPlatformStreamSolver"],function(e,r,t,n){"use strict";return t.extend({_getChildLinkContextFromIdentifier:function(e,r){var t=this;return n.getStreamFromMedia(r,e._getContent()).then(function(e){return t._createExpCoreLinkContext("ExpCoreLinkContextMediaStream",e)})}})}),define("DS/CXP3DPlay/expCoreLink/ExpCoreLinkServiceMediaDSXMStream",["UWA/Core","UWA/Class","DS/CAT3DExpModel/expCoreLink/ExpCoreLinkService","DS/CXP3DPlay/expCoreLink/MediaDSXMStreamSolver"],function(e,r,t,n){"use strict";return t.extend({_getChildLinkContextFromIdentifier:function(e,r){var t=this;return n.getStreamFromMedia(r,e._getContent()).then(function(e){return t._createExpCoreLinkContext("ExpCoreLinkContextMediaStream",e)})}})}),define("DS/CXP3DPlay/XCTEWSPlayMediaPlatform",["UWA/Core","DS/CXP3DPlay/XCTEWSPlayMedia","DS/CAT3DExpModel/CAT3DXModel","DS/CXP3DPlay/expCoreLink/MediaPlatformStreamSolver","DS/CXP3DPlay/expCoreLink/ExpCoreLinkServiceMediaPlatformStream"],function(e,r,t,n,i){"use strict";return r.extend({_retrieveContentJSON:function(e){return n.getStreamFromMedia("content.json",e)},_addExpCoreLinkMedia:function(e){this._parent(e),t._getExpCoreLinkManager()._addExpCoreLinkService("ExpCoreLinkServiceMediaStream",i)},dispose:function(){return t._getExpCoreLinkManager()._removeExpCoreLinkService("ExpCoreLinkServiceMediaStream"),this._parent()}})}),define("DS/CXP3DPlay/CXP3DPlayAppStream",["UWA/Core","DS/CXP3DPlay/CXP3DPlayApp","DS/CXP3DPlay/XCTEWSPlayMediaPlatform"],function(e,r,t){"use strict";return r.extend({_readMedia:function(e,r){var n=new t;return n.readMedia(r.asset,e._experienceBase,{playExperience:e,input:r}).then(function(){return n})}})}),define("DS/CXP3DPlay/XCTEWSPlayMediaDSXM",["UWA/Core","DS/CXP3DPlay/XCTEWSPlayMedia","DS/CAT3DExpModel/CAT3DXModel","DS/CXP3DPlay/expCoreLink/MediaDSXMStreamSolver","DS/CXP3DPlay/expCoreLink/ExpCoreLinkServiceMediaDSXMStream"],function(e,r,t,n,i){"use strict";return r.extend({_retrieveContentJSON:function(e){return n.getStreamFromMedia("content.json",e)},_addExpCoreLinkMedia:function(e){this._parent(e),t._getExpCoreLinkManager()._addExpCoreLinkService("ExpCoreLinkServiceMediaStream",i)},dispose:function(){return t._getExpCoreLinkManager()._removeExpCoreLinkService("ExpCoreLinkServiceMediaStream"),this._parent()}})}),define("DS/CXP3DPlay/CXP3DPlayAppFile",["UWA/Core","DS/CXP3DPlay/CXP3DPlayApp","DS/CXP3DPlay/XCTEWSPlayMediaDSXM"],function(e,r,t){"use strict";return r.extend({_readMedia:function(e,r){var n=new t;return n.readMedia(r.blob,e._experienceBase,{playExperience:e,input:r}).then(function(e){var r=window.document.createEvent("CustomEvent");return r.initCustomEvent("ExperienceReady",!0,!1,{experienceLoaded:e,type:"3D"}),window.document.dispatchEvent(r),n})}})});