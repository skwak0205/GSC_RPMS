define("DS/StateCommandEngine/Xml2Json",["UWA/Core","UWA/Controls/Abstract","DS/WebappsUtils/WebappsUtils","DS/Core/ModelEvents","DS/Utilities/Xml"],function(t,e,n,i,o){"use strict";return e.extend({defaultOptions:{xml:null,module:null,directory:"assets/afr/",fileExtension:".xml",onFailure:null,onLoaded:null},init:function(e){this._parent(e),this.options=t.extend(this.defaultOptions,e);this._initialize(e)},_initialize:function(t){this._modelEvents=new i;var e=window.location.href.split("/");this._currentModule=e[e.length-2],this._host=n.getWebappsBaseUrl();var o=this,a=n.getWebappsBaseUrl()+(this.options.module||this._currentModule)+"/"+this.options.directory+this.options.xml;this._loadXML(a,function(t){o._model=t,o.options.onLoaded(t)})},getModel:function(){return this._model},_loadXML:function(e,i){var o=this,a="Ajax";if("../"!==n.getWebappsBaseUrl()&&(a="Data"),"string"==typeof this.options.xml)t[a].request(e,{isAsync:!0,onComplete:function(e){e.replace(/<!--[\s\S]*?-->/g,"");var n=t.Utils.loadXml(e),a=o._convertXml2Json(n);i.call(o,a)},onFailure:function(t){console.error("[!]\tError loading file:"+e),o.options.onFailure&&o.options.onFailure.call(o,t)}});else{var s=o._convertXml2Json(this.options.xml);i.call(o,s)}},_convertXml2Json:function(t){var e=o.toJson(t);return console.log("XML model",t),console.log("JSON model",e),e}})}),define("DS/StateCommandEngine/StateCommandGraph",["DS/egraph/core","DS/egraph/views","DS/egraph/iact","DS/egraph/utils","UWA/Class","DS/CoreEvents/Events"],function(t,e,n,i,o,a){"use strict";return o.extend({init:function(o){o.setHTML('<div id="graph_canvas" class="canvas"></div>');var s,r,d=document.createElement("link");function c(){e.HTMLNodeView.call(this)}function u(e,n,i){var o;(o=new t.Node).views.main=new c,o.data={stateName:i.stateName},o.data.outputsName=[],i.outputsName&&i.outputsName.forEach(function(t){o.data.outputsName.push(t)});var a=o.data.outputsName.length;o.multiset("left",e,"top",n,"width",150,"height",60+30*Math.max(1,a)),o.data.inputs=[];for(var s=0;s<1;s++)o.data.inputs[s]=h(t.BorderCstr.LEFT,s),o.appendConnector(o.data.inputs[s]);o.data.outputs=[];for(var r=0;r<a;r++)o.data.outputs[r]=h(t.BorderCstr.RIGHT,r),o.appendConnector(o.data.outputs[r]);return o}function h(n,i){var o,a;return a=56.5+30*i,(o=new t.Connector).views.main=new e.SVGConnView,o.multiset(["cstr","attach"],n,["cstr","offset"],a),o}d.type="text/css",d.rel="stylesheet",d.href="../StateCommandEngine/StateCommandGraph.css",document.getElementsByTagName("head")[0].appendChild(d),(d=document.createElement("link")).type="text/css",d.rel="stylesheet",d.href="../egraph/views.css",document.getElementsByTagName("head")[0].appendChild(d),(d=document.createElement("link")).type="text/css",d.rel="stylesheet",d.href="../egraph/views_default.css",document.getElementsByTagName("head")[0].appendChild(d),i.inherit(c,e.HTMLNodeView),c.prototype.buildNodeElement=function(t){var e=document.createElement("div");e.className="my-node",e.style.width="147px",e.style.height="120px";var n=document.createElement("div");n.className="my-node-header",n.appendChild(document.createTextNode(t.data.stateName)),e.appendChild(n);var i=document.createElement("div");i.className="my-node-container",e.appendChild(i);var o=document.createElement("div");o.className="my-node-col left",o.innerHTML='<div class="my-node-text" style="top:0px;"></div>',i.appendChild(o);var a=document.createElement("div");a.className="my-node-col right";for(var s="",r=0;r<t.data.outputsName.length;r++)s+='<div class="my-node-text" style="top:'+30*r+'px;">'+t.data.outputsName[r]+"</div>";return a.innerHTML=s,i.appendChild(a),e},(s=new t.EGraph).addView("main",new e.HTMLGraphView(document.querySelector("#graph_canvas"))),(r=new n.StateMachine(s,null,null,s.views.main)).rootState.newDragForElement=function(){},r.pick.pick=function(t,e,n){var i,o,a,s,r;for(i=n;i.parentNode;i=i.parentNode);for(i.elementFromPoint&&(o=i.elementFromPoint(t,e)),a=o;a&&a!==n;a=a.parentNode)!s&&a.grElt&&(s=a.grElt,a.subElt);return(r=a===n)||(s=null),{inside:r,grElt:null,subElt:null}};var l=this;a.subscribe({event:"/WUX/AFR/CMD/BEGIN/"},function(n){if(n.buildGraph){var a=function(t){l.nodes[l.currentNode].views.main.elts.node.children[0].className="my-node-header",l.nodes[t].views.main.elts.node.children[0].className+=" my-node-header-activ",l.currentNode=t};l.currentToken=n.subscribe({event:"changeState"},function(r){if(console.log("onBeginOfStateCommandFunction : ",r),r===n._getInitialStateId()){for(var d={},c=[],h=0;h<n._transition[r].length;h++)n._transition[r][h].triggerEvent?c.push(n._transition[r][h].triggerEvent):c.push(h);d[r]={stateName:r,outputsName:c,rankForNode:0,lineInGraph:0};var m=[];for(var v in m[0]={lineInGraph:0},n._transition)if(v!==r){var g=[];for(h=0;h<n._transition[v].length;h++)n._transition[v][h].triggerEvent?g.push(n._transition[v][h].triggerEvent):g.push(h);d[v]={stateName:v,outputsName:g}}d[n.FINAL_STATE_ID]={stateName:n.FINAL_STATE_ID};var p=function(t){var e=t.finalState.stateId;d[e].rankForNode||(d[e].rankForNode=d[t.initState.stateId].rankForNode+1,m[d[e].rankForNode]?(d[e].lineInGraph=m[d[e].rankForNode].lineInGraph+1,m[d[e].rankForNode].lineInGraph++):(m[d[e].rankForNode]={lineInGraph:0,nbLineMax:0},d[e].lineInGraph=0),n._transition[e]&&n._transition[e].forEach(p))};for(var _ in n._transition[r].forEach(p),l.nodes={},d)if(_===r)l.nodes[_]=u(15,30,d[_]);else{var f=0;if(d[_].lineInGraph>0)for(var S in d)d.hasOwnProperty(S)&&d[S].rankForNode===d[_].rankForNode&&d[S].lineInGraph<d[_].lineInGraph&&(d[S].outputsName?f+=d[S].outputsName.length>0?d[S].outputsName.length:1:f++);var b=30+90*d[_].lineInGraph+30*f,E=15+200*d[_].rankForNode;l.nodes[_]=u(E,b,d[_])}var C=[];s.updateLock();try{for(var k in l.nodes)s.addNode(l.nodes[k]);for(var v in n._states){var w=n._getTransitionsTabForState(v);w&&(h=0,w.forEach(function(n){var i,o,a;n.initState===n.finalState?C.push(l.nodes[n.initState.stateId].data.outputs[h]):l.nodes[n.initState.stateId].data.outputs[h]&&l.nodes[n.finalState.stateId].data.inputs[0]&&(i=l.nodes[n.initState.stateId].data.outputs[h],o=l.nodes[n.finalState.stateId].data.inputs[0],(a=new t.Edge).views.main=new e.SVGEdgeView,s.addEdge(i,o,a)),h++}))}}finally{s.updateUnlock(),C.forEach(function(t){i.classListAdd(t.views.main.elts.elt,"transitive")})}var R=200*m.length;o.style.width=String(R)+"px",l.currentNode=r,l.nodes[r].views.main.elts.node.children[0].className+=" my-node-header-activ",n.unsubscribe(l.currentToken),l.currentToken=n.subscribe({event:"changeState"},a)}})}});a.subscribe({event:"/WUX/AFR/CMD/END/"},function(t){if(t.buildGraph){t.unsubscribe(l.currentToken),s.updateLock();try{for(var e in l.nodes)l.nodes.hasOwnProperty(e)&&s.removeNode(l.nodes[e])}finally{s.updateUnlock()}l.currentToken=null,l.nodes={},l.currentNode=null}})}})}),define("DS/StateCommandEngine/UndoRedoManager",["UWA/Core","DS/Core/ActionsStack","DS/Core/ModelEvents"],function(t,e,n){"use strict";return e.singleton({init:function(){this._parent(),this._isInit=!0,this._commandRank=0,this._commandNumber=0,this._commandLimit=6,this._modelEvents=new n;var e=this;t.Element.addEvent.call(document,"keydown",function(n){var i=t.Event.whichKey(n);"ctrl+y"===i?-1===e._index?(e.relativeGlobalUndoRedo(1),e._modelEvents.publish({event:"UndoRedoManagerNewCommandRank",data:{commandRank:e._commandRank,commandNumber:e._commandNumber}})):"endCommand"===e._stack[e._index].step?(e.relativeGlobalUndoRedo(1),e._modelEvents.publish({event:"UndoRedoManagerNewCommandRank",data:{commandRank:e._commandRank,commandNumber:e._commandNumber}})):(e.relativeLocalUndoRedo(1),e._modelEvents.publish({event:"UndoRedoManagerNewIndex",data:{commandRank:e._commandRank,commandNumber:e._commandNumber}})):"ctrl+z"===i&&e._index>0&&("endCommand"===e._stack[e._index].step?(e.relativeGlobalUndoRedo(-1),e._modelEvents.publish({event:"UndoRedoManagerNewCommandRank",data:{commandRank:e._commandRank,commandNumber:e._commandNumber}})):"endCommand"===e._stack[e._index-1].step&&e._commandRank===e._commandNumber?(e.cleanInterruptedEnd(),e.relativeGlobalUndoRedo(-1),e._modelEvents.publish({event:"UndoRedoManagerNewCommandRank",data:{commandRank:e._commandRank,commandNumber:e._commandNumber}})):(e.relativeLocalUndoRedo(-1),e._modelEvents.publish({event:"UndoRedoManagerNewIndex",data:{commandRank:e._commandRank,commandNumber:e._commandNumber}})))})},pushAction:function(t){if(!this._isRunning){var e;for(e=this._index+1;e<this._stack.length;e++){var n=this._stack[e];n.undoRedoObjectStack._stack.splice(n.undoRedoObjectStack._index+1,n.undoRedoObjectStack._stack.length-n.undoRedoObjectStack._index)}if(this._parent(t,null),this._stack[this._index].undoRedoObjectStack=t.undoObj,this._stack[this._index].step=t.step,"endCommand"===this._stack[this._index].step&&(this._commandRank++,this._commandNumber!==this._commandLimit&&this._commandNumber++,this._commandRank>this._commandLimit)){for(;"endCommand"!==this._stack[0].step;)this._stack[0].undoRedoObjectStack._stack.splice(0,1),this._stack[0].undoRedoObjectStack._index--,this._stack.splice(0,1),this._index--;this._stack[0].undoRedoObjectStack._stack.splice(0,1),this._stack[0].undoRedoObjectStack._index--,this._stack.splice(0,1),this._index--,this._commandRank--}this._modelEvents.publish({event:"UndoRedoManagerNewItem",data:[]})}},undo:function(){this._parent(),-1===this._index?this._commandRank--:"endCommand"===this._stack[this._index].step&&this._commandRank--},redo:function(){this._parent(),"endCommand"===this._stack[this._index].step&&this._commandRank++},absoluteLocalUndoRedo:function(t){if(t===parseInt(t)&&t>=0)if(t>this._stack.length-this._index-1)for(var e=0;e<t-(this._stack.length-this._index-1);e++)this.undo();else if(t<this._stack.length-this._index-1)for(var n=0;n<this._stack.length-this._index-1-t;n++)this.redo()},absoluteGlobalUndoRedo:function(t){for(;t!==this._commandRank;)t-this._commandRank>0?this.redo():t-this._commandRank<0&&this.undo()},relativeLocalUndoRedo:function(t){if(t===parseInt(t))if(t>0)for(var e=0;e<t;e++)this.redo();else if(t<0)for(var n=0;n>t;n--)this.undo()},relativeGlobalUndoRedo:function(t){for(var e=this._commandRank;e+t!==this._commandRank;)if(t>0){if(this._commandRank===this._commandNumber)break;this.redo()}else if(t<0){if(-1===this._index)break;this.undo()}},cleanInterruptedEnd:function(){if(-1!==this._index){for(;"endCommand"!==this._stack[this._index].step&&(this.undo(),this._stack[this._index+1].undoRedoObjectStack._stack.splice(this._stack[this._index+1].undoRedoObjectStack._index+1,this._stack[this._index+1].undoRedoObjectStack._stack.length-this._stack[this._index+1].undoRedoObjectStack._index),this._stack.splice(this._index+1,this._stack.length-this._index),-1!==this._index););this._isRunning||this._modelEvents.publish({event:"UndoRedoManagerNewItem",data:[]})}}})}),define("DS/StateCommandEngine/XmlModelsTools",["UWA/Core"],function(t){"use strict";var e={arrayUnique:function(t){for(var e=t.concat(),n=0;n<e.length;++n)for(var i=n+1;i<e.length;++i)e[n]===e[i]&&e.splice(i--,1);return e},isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},getTag:function(t){return t["@tag"]},getChildren:function(t){return t["@children"]},getAttribute:function(t,e){if(t&&t["@attributes"])return t["@attributes"][e]},getAttributes:function(t){return t?t["@attributes"]:{}},printDepth:function(t,e,n,i){for(var o=0;o<t;o++)"    "},searchTag:function(t,e){var n,i=t["@children"],o=this;return i.some(function(t,i,a){return o.getTag(t)===e&&(n=t,!0)}),n}};return t.namespace("StateCommandEngine/XmlModelsTools",e)}),define("DS/StateCommandEngine/DialogAgent",["UWA/Core","UWA/Class","DS/Core/ModelEvents"],function(t,e,n){"use strict";return e.extend({init:function(e){this.options=t.extend({agentId:null},e),this._parent(this.options),this._agentId=this.options.agentId,this._activated=!1,this._modelEvents=new n},activate:function(t){this._activated||(this._activated=!0,this.activateAgentControl&&!t&&this.activateAgentControl())},deactivate:function(){this._activated&&(this._activated=!1,this.deactivateAgentControl&&this.deactivateAgentControl())}})}),define("DS/StateCommandEngine/DE2NamingMap",["UWA/Core"],function(t){"use strict";return t.namespace("StateCommandEngine/DE2NamingMap",{behaviorCorrespondence:{CATDE2EngWithPSOHSO:"engWithPSOHSO",CATDE2WithPSO:"withPSO",CATDE2WithHSO:"withHSO",CATDE2ValuedFromCSO:"valuedFromCSO",CATDE2MultiAcquisition:"multiAcquisition",CATDE2MultiAcquisitionCtrl:"multiAcquisitionCtrl",CATDE2WithUndoStep:"withUndoStep",CATDE2WithPrevaluation:"withPrevaluation",CATDE2WithContext:"withContext"},behaviorValues:{CATDE2EngWithPSOHSO:!0,CATDE2WithPSO:!0,CATDE2WithHSO:!0,CATDE2ValuedFromCSO:!0,CATDE2MultiAcquisition:!0,CATDE2MultiAcquisitionCtrl:!0,CATDE2WithUndoStep:!1,CATDE2WithPrevaluation:!0,CATDE2WithContext:!0}})}),define("DS/StateCommandEngine/AcquisitionAgent",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/StateCommandEngine/DialogAgent","DS/Selection/CSOManager","DS/Selection/HSOManager"],function(t,e,n,i,o){"use strict";var a=0,s=[],r=[],d=[];return n.extend({init:function(e){this._parent(e);this.options=t.extend({frameWindow:null,withPrevaluation:!1,withContext:!1},this.options),this._viewers=[],this.options.frameWindow?(this._frameWindow=this.options.frameWindow,this._viewer=this._frameWindow.getViewer(),this._viewers=this._frameWindow.getViewers()):this.options.viewer&&(this._viewer=this.options.viewer,this._viewers.push(this.options.viewer))},activate:function(t){if(!this._activated){if(this._parent(t),0===a)for(var e=this._computePickingOptions(this.options.pickingMode,this.options.withHSO),n=this._computePickingOptions(this.options.prePickingMode,this.options.withPSO),i=0;i<this._viewers.length;i++){var o=this._viewers[i],c=o.picking;for(var u in s[i]={},c)c.hasOwnProperty(u)&&(s[i][u]=c[u]);d[i]={};var h=o.pPicking;for(var u in h)h.hasOwnProperty(u)&&(d[i][u]=h[u]);r[i]=o.getDefaultPicking(),o.setFillXSOMode(!1),o.setPicking(e),o.setPrePicking(n)}a++}},deactivate:function(){if(this._activated&&(this._parent(),0===--a)){for(var t=0;t<this._viewers.length;t++){var e=this._viewers[t];e.setFillXSOMode(!0),e.setPicking(s[t],r[t]),e.setPrePicking(d[t],r[t]);var n=o,c=i,u=!n.isEmpty();if(s[t].displayHL&&u){var h=c.get();n.empty(),h.length>0&&n.add(h),e.render()}}s=[],d=[],r=[]}},getEventViewer:function(t){if(t){for(var e=0;e<this._viewers.length&&(!this._viewers[e]||this._viewers[e]!==t);e++);return t}},_computePickingOptions:function(t,e){var n={activated:!0,trapSelection:!1,displayHL:!0,computeNormalDepth:!0};switch(t){case"primHybrid":n.primitive=1,n.gpu=!0;break;case"prim":n.primitive=1,n.gpu=!1;break;case"rep":n.primitive=2,n.gpu=!1;break;default:n.primitive=!1}return n}})}),define("DS/StateCommandEngine/UndoRedoObjectStack",["UWA/Core","DS/Core/ActionsStack","DS/StateCommandEngine/UndoRedoManager"],function(t,e,n){"use strict";return e.extend({init:function(t){this._parent(),n._isInit||n.init(),this._undoRedoManager=n,this._notifyUndoRedoManager=!0,t&&(t.notifyUndoRedoManager||(this._notifyUndoRedoManager=!1))},pushAction:function(e){var n=this;if(this._notifyUndoRedoManager){e=t.extend({undoObj:null,undoFunc:null,undoParamsList:[],undoTitle:"Undo",actionObj:null,actionFunc:null,actionParamsList:[],actionTitle:"run",redoObj:null,redoFunc:null,redoParamsList:[],redoTitle:"Redo",step:"normal"},e);this._parent(e,function(){var t={undoObj:n,undoFunc:n.undo,undoParamsList:[],undoTitle:e.undoTitle,actionObj:e.actionObj,actionFunc:e.actionFunc,actionParamsList:e.actionParamsList,actionTitle:e.actionTitle,redoObj:n,redoFunc:n.redo,redoParamsList:[],redoTitle:e.redoTitle,step:e.step};n._undoRedoManager.pushAction(t)})}else this._parent(e)}})}),define("DS/StateCommandEngine/EventTimeLine",["UWA/Core","DS/Controls/Gauge","DS/StateCommandEngine/UndoRedoManager"],function(t,e,n){"use strict";return e.extend({className:"wux-timeline",init:function(t){t.graduations=[],this._eventsList=[],t.eventsList.forEach(function(e){var n;n=e.value-t.minValue;var i={label:e.label,value:n,onEvent:e.onEvent,state:0};t.graduations.push(i)}),this._parent(t)},setValue:function(t,e){void 0===e&&(e=!0);var n=this;this._setValue(t,e),n.options.graduations.forEach(function(t){var i=t.value+n.options.minValue;if(n._value[1]===i&&0===t.state){t.state=1,t.onEvent&&e&&t.onEvent.call(n,n._value[1]);for(var o=0;o<n.options.graduations.length;o++)n.options.graduations[o].value!==t.value&&(n.options.graduations[o].state=0)}n._value[1]!==i&&t.state>0&&(t.state=0)})},getValue:function(){return this._value[1]}})}),define("DS/StateCommandEngine/UndoRedoWidget",["UWA/Core","UWA/Event","DS/Core/Core","UWA/Class","DS/StateCommandEngine/UndoRedoManager","DS/StateCommandEngine/EventTimeLine","DS/Core/PointerEvents","DS/ApplicationFrame/CommandsManager"],function(t,e,n,i,o,a,s,r){"use strict";return i.extend({init:function(e){o._isInit?this._undoRedoManager=o:(o.init(),this._undoRedoManager=o);var n=document.createElement("link");if(n.type="text/css",n.rel="stylesheet",n.href="../StateCommandEngine/UndoRedoWidget.css",document.getElementsByTagName("head")[0].appendChild(n),(e=t.extend({uiFrame:null},e)).uiFrame){this.myUndoButton=new t.Element("div",{class:"WUXUndoRedoButton-state-disabled"}),this.myUndoButton._active=!1,this.myUndoButton._disabled=!0,this.myUndoButton.inject(e.uiFrame),this.myIcon=new t.Element("div",{class:"WUXUndoRedoIcon"}),this.myIcon.inject(this.myUndoButton),this.undoRedoBox=new t.Element("div",{class:"WUXUndoRedoBox-inactive WUXUndoRedoBox"}),this._eventTimeline=new a({minValue:0,maxValue:2,value:2,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!0,eventsList:[{label:"",value:0,onEvent:function(){alert("Event on 100 has been triggered")}},{label:"",value:1},{label:"",value:2}],activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(this.undoRedoBox),this.undoRedoBox.inject(e.uiFrame);var i=this;this.myUndoButton.addEventListener(s.POINTERUP,function(t){i.myUndoButton._disabled||(i.myUndoButton._active?(i.myUndoButton.removeClassName("wux-undo-redo-state-active"),i.myUndoButton._active=!1,i.myUndoButton.addClassName("WUXUndoRedoButton-animationUp"),i.myUndoButton.removeClassName("WUXUndoRedoButton-animationDown"),i.undoRedoBox.addClassName("WUXUndoRedoBox-animationHide"),i.undoRedoBox.removeClassName("WUXUndoRedoBox-animationShow")):(i.myUndoButton.addClassName("wux-undo-redo-state-active"),i.myUndoButton.removeClassName("WUXUndoRedoButton-animationUp"),i.myUndoButton.addClassName("WUXUndoRedoButton-animationDown"),i.myUndoButton._active=!0,i.undoRedoBox.removeClassName("WUXUndoRedoBox-inactive"),i.undoRedoBox.removeClassName("WUXUndoRedoBox-animationHide"),i.undoRedoBox.addClassName("WUXUndoRedoBox-animationShow")))}),this._undoRedoManager._modelEvents.subscribe({event:"UndoRedoManagerNewItem"},function(){i.myUndoButton._active&&(i.myUndoButton.removeClassName("wux-undo-redo-state-active"),i.myUndoButton._active=!1,i.myUndoButton.addClassName("WUXUndoRedoButton-animationUp"),i.myUndoButton.removeClassName("WUXUndoRedoButton-animationDown"),i.undoRedoBox.addClassName("WUXUndoRedoBox-animationHide"),i.undoRedoBox.removeClassName("WUXUndoRedoBox-animationShow"));var n=!1;if(0===i._undoRedoManager._stack.length?n=!0:"beginCommand"===i._undoRedoManager._stack[i._undoRedoManager._index].step&&(n=!0),n)i.myUndoButton.addClassName("WUXUndoRedoButton-state-disabled"),i.myUndoButton.removeClassName("WUXUndoRedoButton"),i.myUndoButton._disabled=!0;else{if("normal"===i._undoRedoManager._stack[i._undoRedoManager._stack.length-1].step){i.undoRedoBox.destroy();for(var o=0,s=!1;!s;)o++,"beginCommand"===i._undoRedoManager._stack[i._undoRedoManager._stack.length-o-1].step&&(s=!0);for(var r=function(t){i._undoRedoManager.absoluteLocalUndoRedo(o-t)},d=[],c=0;c<=o;c++)d.push({label:i._undoRedoManager._stack[i._undoRedoManager._stack.length-o-1+c].actionTitle,value:c,onEvent:r});i.undoRedoBox=new t.Element("div",{class:"WUXUndoRedoBox-inactive WUXUndoRedoBox"}).inject(e.uiFrame),i._eventTimeline=new a({minValue:0,maxValue:o,value:o,eventsList:d,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!0,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(i.undoRedoBox)}else if("endCommand"===i._undoRedoManager._stack[i._undoRedoManager._index].step){i.undoRedoBox.destroy();for(var u=0,h=0;h<i._undoRedoManager._stack.length;h++)"endCommand"===i._undoRedoManager._stack[i._undoRedoManager._stack.length-h-1].step&&u++;for(var l=function(t){i._undoRedoManager.absoluteGlobalUndoRedo(t)},m=[],v=0,g=0;g<=u;g++){for(var p=!1;!p&&0!==g;)v++,"endCommand"===i._undoRedoManager._stack[v-1].step&&(p=!0);0!==v?m.push({label:i._undoRedoManager._stack[v-1].actionTitle,value:g,onEvent:l}):m.push({label:"Oldest Action",value:g,onEvent:l})}i.undoRedoBox=new t.Element("div",{class:"WUXUndoRedoBox-inactive WUXUndoRedoBox"}).inject(e.uiFrame),i._eventTimeline=new a({minValue:0,maxValue:u,value:u,eventsList:m,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!0,activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(i.undoRedoBox)}i.myUndoButton._disabled&&(i.myUndoButton.removeClassName("WUXUndoRedoButton-state-disabled"),i.myUndoButton.addClassName("WUXUndoRedoButton"),i.myUndoButton._disabled=!1)}}),this._undoRedoManager._modelEvents.subscribe({event:"UndoRedoManagerNewIndex"},function(t){if(t.commandRank===t.commandNumber){for(var e=0,n=!1;!n;)"beginCommand"===i._undoRedoManager._stack[i._undoRedoManager._index-e].step?n=!0:e++;i._eventTimeline.setValue(e,!1)}}),this._undoRedoManager._modelEvents.subscribe({event:"UndoRedoManagerNewCommandRank"},function(t){i._eventTimeline.setValue(t.commandRank,!1)})}}})}),define("DS/StateCommandEngine/IndicationAgent",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/StateCommandEngine/AcquisitionAgent","DS/VisuEvents/EventsManager"],function(t,e,n){"use strict";return n.extend({init:function(t){this._parent(t),(this.options.frameWindow||this.options.viewer)&&this.setPlane()},agentTreatment:function(t){if(t){t.viewer||(t.viewer=this._viewer);var e;t.position?(e={}).position=t.position:0===t.pickingResult.path.length&&t.pickingResult.position&&(e=t.viewer?this._projectPoint3D(t):this._projectPoint2D(t)),e&&e.position&&this._modelEvents.publish({event:this._agentId,data:e})}},_projectPoint3D:function(t){var e;return t.viewer&&t.pickingResult.ray&&((e={}).eventDatas=t,e.position=t.pickingResult.ray.intersectPlane(this._plane)),e},_projectPoint2D:function(t){var n;return t.viewer&&t.pickingResult.position&&((n={}).eventDatas=t,n.position=e.Vector2(t.pickingResult.position.x-t.viewer.div.getBoundingClientRect().left,t.pickingResult.position.y-t.viewer.div.getBoundingClientRect().top)),n},setPlane:function(t){if(t)this._plane=t;else for(var n=0;n<this._viewers.length;n++){var i=this._viewers[n];if(i){var o=new e.Vector3;o.subVectors(i.currentViewpoint.target,i.currentViewpoint.camera.position),o.normalize(),this._plane=new e.Plane(o,.1)}}},getViewerCurrentPlane:function(t){var n;if(t){var i=new e.Vector3;i.subVectors(t.currentViewpoint.target,t.currentViewpoint.camera.position),i.normalize(),n=new e.Plane(i,.1)}return n},activateAgentControl:function(){var t;if(this._tokens&&0!==this._tokens.length)throw new Error("IndicationAgent.activateAgentControl, try to activate an agent which is already listening to events");for(this._tokens=[],t=0;t<this._viewers.length;t++)this._tokens[t]=[];for(t=0;t<this._viewers.length;t++){var e=this._viewers[t];this.options.withPrevaluation?(e.setPrePicking({activated:!0}),this._tokens[t].push(e.onPreactivate(this.agentTreatment.bind(this)))):(this._tokens[t].push(e.onActivate(this.agentTreatment.bind(this))),this.options.withContext&&e.setPicking({contextPick:!0}))}},deactivateAgentControl:function(){for(var t=0;t<this._viewers.length;t++){for(var e=this._viewers[t],n=0;n<this._tokens[t].length;n++)e.unsubscribe(this._tokens[t][n]);this._tokens[t]=void 0,this.options.withContext&&e.setPicking({contextPick:!1})}this._tokens=[]}})}),define("DS/StateCommandEngine/StateCommand",["UWA/Core","DS/ApplicationFrame/Command","DS/CoreEvents/ModelEvents","DS/StateCommandEngine/UndoRedoObjectStack","DS/ApplicationFrame/CommandsManager","DS/CoreEvents/Events"],function(t,e,n,i,o,a){"use strict";return e.extend({defaultOptions:{withUndoRedo:!1,isAsynchronous:!0},init:function(e,o){return this.options=t.extend(t.clone(this.defaultOptions),e),!0!==this.options.isAsynchronous&&console.warn("StateCommand with Id: "+this.options._id+" is not asynchronous. This state command will not work."),this._modelEvents=new n,this._withUndoRedo=!1,this.options.withUndoRedo&&(this._withUndoRedo=!0,this._undoRedoObjectStack=new i),this._parent(e,o)},_createGraph:function(){this.FINAL_STATE_ID="finalState",this._initialStateId=null,this._transition={},this._states={},this._stateId=null,this._subscribedEvents=[]},_initGraph:function(){this._getInitialStateId()&&this._changeState(this._getInitialStateId())},_clearGraph:function(){this._unsubscribeFromAllEvents(this._stateId),this._initialStateId=null,this._transition=null,this._states=null,this._stateId=null,this._subscribedEvents=null},createState:function(t){var e=t.toString();if(!this._getStateFromId(e)){var n={stateId:e,_eventsToListen:[],_enterStateAction:null,_exitStateAction:null};this._states[e]=n}return this._states[e]},setEnterStateAction:function(t,e){t&&e&&(t._enterStateAction=e)},setLeaveStateAction:function(t,e){t&&e&&(t._exitStateAction=e)},setExitStateAction:function(t,e){this.setLeaveStateAction(t,e)},createInitialState:function(t){return this._initialStateId=t,this.createState(t)},getFinalState:function(){return this.createState(this.FINAL_STATE_ID)},_getInitialStateId:function(){return this._initialStateId},_getStateFromId:function(t){return this._states[t]},_getCurrentStateId:function(){return this._stateId},_SuscribeToStateEvent:function(t){var e,n=this._getStateFromId(t)._eventsToListen,i=null;for(e=0;e<n.length;e++)if(i=n[e]){var o=Object.create(null);if(i.sender){var s=i.sender._modelEvents;void 0===s&&void 0!==i.sender._modelEvent&&(s=i.sender._modelEvent),void 0!==s&&(o.sender=s,o.token=s.subscribe({event:i.eventName},this._searchForTransition({eventName:i.eventName,sender:i.sender})))}else o.sender=void 0,o.token=a.subscribe({event:i.eventName},this._searchForTransition({eventName:i.eventName,sender:void 0}));void 0!==o&&this._subscribedEvents.push(o)}for(i=null,e=0;e<n.length;e++)(i=n[e]).isAgent&&i.sender.activate()},_unsubscribeFromAllEvents:function(t){if(t&&this._subscribedEvents){for(var e=this._getStateFromId(t)._eventsToListen,n=null,i=0;i<e.length;i++)(n=e[i]).isAgent&&n.sender.deactivate();for(var o=0;o<this._subscribedEvents.length;o++){var s=this._subscribedEvents[o];s&&(this._subscribedEvents[o].sender?this._subscribedEvents[o].sender.unsubscribe(s.token):a.unsubscribe(s.token))}this._subscribedEvents.length=[]}else this._subscribedEvents=[]},defaultParameters:{iEvent:null,iInitialState:null,iFinalState:null,iCondition:null,iAction:null,iUndo:null,iRedo:null},addTransition:function(e){var n;t.extend(this.defaultParameters,e),e.iEvent,e.iCondition||(e.iCondition=function(){return!0}),e.iAction||(e.iAction=function(t,e){t()});var i={initState:e.iInitialState,finalState:e.iFinalState,condition:e.iCondition,action:e.iAction,undo:e.iUndo,redo:e.iRedo};"string"==typeof e.iEvent||"object"==typeof e.iEvent&&e.iEvent.constructor===String?(i.triggerEvent=e.iEvent,i.sender=e.iSender):e.iEvent?(i.triggerEvent=e.iEvent._agentId,i.sender=e.iEvent):(i.triggerEvent=null,i.sender=null);var o=e.iInitialState.stateId.toString();this._transition[o]||(this._transition[o]=[]),this._transition[o]&&this._transition[o].push(i),e.iEvent&&(e.iEvent.hasOwnProperty("_agentId")?(n=!1,e.iInitialState._eventsToListen.forEach(function(t){t.sender===e.iEvent&&(n=!0)}),n||e.iInitialState._eventsToListen.push({eventName:e.iEvent._agentId,sender:e.iEvent,isAgent:!0})):e.iSender?(n=!1,e.iInitialState._eventsToListen.forEach(function(t){t.sender===e.iSender&&t.eventName===e.iEvent&&(n=!0)}),n||e.iInitialState._eventsToListen.push({eventName:e.iEvent,sender:e.iSender})):(n=!1,e.iInitialState._eventsToListen.forEach(function(t){t.eventName===e.iEvent&&(n=!0)}),n||e.iInitialState._eventsToListen.push({eventName:e.iEvent,sender:null})))},_getTransitionsTabForState:function(t){return this._transition[t]},notCondition:function(t){var e=this;return function(){return!t.call(e)}},andCondition:function(t){var e=this;return function(n){var i=0,o=t.length,a=!0;for(i=0;i<o;i++)a=a&&t[i].call(e,n);return a}},orCondition:function(t){var e=this;return function(n){var i=0,o=t.length,a=!1;for(i=0;i<o;i++)a=a||t[i].call(e,n);return a}},_changeState:function(t,e){if(this.isNewInfraActivated()||this.isRunning()&&!this.isEnding()){var n=this._stateId===t;if(n||(this._stateId&&(this._unsubscribeFromAllEvents(this._stateId),this._getStateFromId(this._stateId)._exitStateAction&&this._getStateFromId(this._stateId)._exitStateAction.call(this)),this.publish({event:"changeState",data:t})),this._stateId=t,t===this.FINAL_STATE_ID)this.done(e),!this.isNewInfraActivated()||e&&!0===e.cancel||this.endExecute(),this.isNewInfraActivated()||this.end();else{if(!n){var i=this._getStateFromId(t);i._enterStateAction&&i._enterStateAction.call(this)}this._evaluateAutomaticTransitions(),this._getCurrentStateId()===t&&(n||this._SuscribeToStateEvent(t))}}},_evaluateAutomaticTransitions:function(){this._searchForTransition(null)(null)},_searchForTransition:function(e){var n=this;return function(i){if(n._stateId){var a=n._getTransitionsTabForState(n._stateId);if(a){var s;i instanceof Array?(s=[],i.forEach(function(t){s.push(t)})):s=i;var r=null,d=0,c=a.length;for(d=0;!r&&d<c;d++){var u,h,l=a[d];e?(u=e.eventName,h=e.sender):(u=null,h=null),l.condition&&u===l.triggerEvent&&l.sender===h&&l.condition.call(n,i)&&(r=l)}if(r){var m=function(e){var i=!0;if(e&&e.error&&(i=!1),i){if(r.undo&&r.redo&&n._withUndoRedo){var a={undoObj:n,undoParamsList:[function(t){var e=!0;t&&t.error&&(e=!1),e&&n._changeState(r.initState.stateId)},s],undoTitle:"Undo",actionObj:n,actionFunc:r.action,actionParamsList:[m,s],actionTitle:"Run",redoObj:n,redoTitle:"Redo",redoFunc:r.redo,redoParamsList:[function(t){var e=!0;t&&t.error&&(e=!1),e&&n._changeState(r.finalState.stateId)},s]};e&&(e.undoTitle&&(a.undoTitle=e.undoTitle),e.redoTitle&&(a.redoTitle=e.redoTitle),e.actionTitle&&(a.actionTitle=e.actionTitle),e.undoParamsList&&a.undoParamsList.push(e.undoParamsList),e.redoParamsList&&a.redoParamsList.push(e.redoParamsList)),r.finalState.stateId===n.FINAL_STATE_ID?(a.undoFunc=function(t,e,i){o.getCommand(o._getCurrent()).end(),n.begin(),r.undo.call(n,t,e,i)},a.step="endCommand"):a.undoFunc=r.undo,n._undoRedoObjectStack.pushAction(a)}r.finalState.stateId===n.FINAL_STATE_ID&&e&&e.cancel?n.done({cancel:e.cancel,undoOnEnd:e.undoOnEnd}):n._changeState(r.finalState.stateId)}else t.log("completionHandler: ERROR")};r.action.call(n,m,i)}}else console.error("stateCmd "+n.getId()+" tries to launch a transition but transitionsTab is "+a)}}},beginExecute:function(){if(this._parent(),this._createGraph(),this.buildGraph(),this._withUndoRedo){var t={undoObj:this,undoFunc:this.end,undoParamsList:[!1],undoTitle:"Undo Begin Command",actionObj:this,actionFunc:this.begin,actionParamsList:[],actionTitle:"Begin Command",redoObj:this,redoFunc:this.begin,redoParamsList:[],redoTitle:"Redo Begin Command",step:"beginCommand"};this._undoRedoObjectStack.pushAction(t)}this._initGraph()},pauseExecute:function(t){this._unsubscribeFromAllEvents(this._getCurrentStateId()),this._parent(),t&&!1===t.pauseSynchronous||this.done()},resumeExecute:function(){this._SuscribeToStateEvent(this._getCurrentStateId()),this._parent()},cancelExecute:function(t){if(this.isNewInfraActivated()){var e=this.done;t&&!1===t.cancelSynchronous&&(this.done=function(){}),this._changeState(this.FINAL_STATE_ID,t),t&&!1===t.cancelSynchronous&&(this.done=e)}},endExecute:function(){this._withUndoRedo&&(this._undoRedoObjectStack._undoRedoManager._isRunning||this._undoRedoObjectStack._undoRedoManager.cleanInterruptedEnd()),this.isNewInfraActivated()||this._clearGraph(),this._parent()},destroy:function(){this._getCurrentStateId(),this.FINAL_STATE_ID,this.isNewInfraActivated()&&this._clearGraph(),this._parent()},buildGraph:function(){},publish:function(t){this._modelEvents.publish(t)},subscribe:function(t,e){return this._modelEvents.subscribe(t,e)},subscribeOnce:function(t,e){this._modelEvents.subscribeOnce(t,e)},unsubscribe:function(t){this._modelEvents.unsubscribe(t)},isWithUndoRedo:function(){return this._withUndoRedo}})}),define("DS/StateCommandEngine/PathElementAgent",["UWA/Core","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/StateCommandEngine/AcquisitionAgent","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Utilities/Object","DS/StateCommandEngine/UndoRedoObjectStack"],function(t,e,n,i,o,a,s,r,d){"use strict";return i.extend({init:function(e){this._parent(e);this.options=t.extend({engWithPSOHSO:!1,withPSO:!1,withHSO:!1,valuedFromCSO:!1,saveToCSO:!0,multiAcquisition:!1,multiAcquisitionCtrl:!1,pickingMode:"",prePickingMode:"",withUndoStep:!1,pickingFilter:function(){return!0},prePickingFilter:function(){return!0}},this.options),this.options.engWithPSOHSO&&(this.options.withHSO=!0,this.options.withPSO=!0),this.pso=WUX.Selection.PSOManager,this.hso=WUX.Selection.HSOManager,this.cso=WUX.Selection.CSOManager,this.currentPSO=[],this.object3D=[],"prim"!==this.options.pickingMode&&"rep"!==this.options.pickingMode&&"primHybrid"!==this.options.pickingMode&&(this.options.pickingMode="mesh"),"prim"!==this.options.prePickingMode&&"rep"!==this.options.prePickingMode&&"primHybrid"!==this.options.prePickingMode&&(this.options.prePickingMode="mesh");var n={notifyUndoRedoManager:this.options.withUndoStep};this._undoRedoObjectStack=new d(n)},activate:function(){if(!this._activated){var t=!1;if(this.options.valuedFromCSO){var e=this.cso.get();if(e.length>0){var n=!1,i=[];this.object3D.forEach(function(t){i.push(t)}),this.object3D=[];for(var o=0;o<e.length;o++)this.options.pickingFilter(e[o].pathElement)&&(n||(n=!0),this.object3D.push(e[o]));this.object3D.length>0&&!this._undoRedoObjectStack._undoRedoManager._isRunning&&(t=!0)}}if(this._parent(t),t){var a=this;setTimeout(function(){a._modelEvents.publish({event:a._agentId,data:a.object3D})},0)}}},deactivate:function(){this._activated&&(this.object3D.length=0,this.pso.empty(),this._parent())},agentTreatment:function(t){var e,n,i,o,a,s;if(t){var d;t.viewer||(t.viewer=this._viewer),d=t.hasOwnProperty("selected")?{path:[t.selected]}:t.pickingResult;var c=[],u=!1;if(d.path.length>0)if(t.trapSelection)for(var h=d.path.length-1;h>=0;h--)this.options.pickingFilter(d.path[h])?u=!0:d.path.splice(h,1);else this.options.pickingFilter(d.path[0])&&(u=!0);if(u){var l=t.ctrl&&this.options.multiAcquisitionCtrl,m=[];if(t.trapSelection)for(n=0;n<d.path.length;n++)m.push({pathElement:d.path[n]});else m.push({pathElement:d.path[0],normal:d.normal,position:d.position,ray:d.ray,tangent:d.tangent,uv:d.uv,eventDatas:t});for(l&&this.object3D.forEach(function(t){c.push(t)}),n=0;n<m.length;n++){var v=!1;for(e=0;!v&&e<c.length;e++)r.areEquals(c[e],m[n])&&(this.options.withPrevaluation||c.splice(e,1),v=!0);v||c.push(m[n])}var g=[];this.object3D.forEach(function(t){g.push(t)});var p=!1;this.object3D=[];for(var _=0;_<c.length;_++)this.options.pickingFilter(c[_].pathElement)&&(p||(p=!0),this.object3D.push(c[_]));if(p){this.options.withPSO&&this.pso.empty(),this.options.withHSO&&(this.hso.empty(),this.hso.add(this.object3D),t.viewer.render()),this.cso.empty(),this.options.saveToCSO&&this.cso.add(this.object3D);var f=this,S=function(e){f.object3D=[],e.forEach(function(t){f.object3D.push(t)}),f.options.withHSO&&(f.hso.empty(),f.hso.add(f.object3D),t.viewer.render()),f.cso.empty(),f.options.saveToCSO&&f.cso.add(f.object3D)},b=[];this.object3D.forEach(function(t){b.push(t)});var E={undoObj:this,undoFunc:S,undoParamsList:[g],undoTitle:"Undo agent treatment",actionObj:this,actionFunc:this.agentTreatment,actionParamsList:[t],actionTitle:"agent treatment",redoObj:this,redoFunc:S,redoParamsList:[b],redoTitle:"Redo agent treatment"};this._undoRedoObjectStack.pushAction(E),this._modelEvents.publish({event:this._agentId,data:this.object3D})}else{for(o=this.hso.get(),a=!0,i=0;a&&i<o.length;i++)this.options.pickingFilter(o[i].pathElement)||(a=!1);for(s=this.cso.get(),i=0;a&&i<s.length;i++)this.options.pickingFilter(s[i].pathElement)||(a=!1);a&&(this.hso.empty(),this.cso.empty())}}else if((!t.ctrl||!this.options.multiAcquisitionCtrl)&&this.object3D){for(o=this.hso.get(),a=!0,i=0;a&&i<o.length;i++)this.options.pickingFilter(o[i].pathElement)||(a=!1);for(s=this.cso.get(),i=0;a&&i<s.length;i++)this.options.pickingFilter(s[i].pathElement)||(a=!1);a&&(this.hso.empty(),this.cso.empty()),this.object3D=[]}}},agentActionOnTheScene:function(t){if(t){var e=t.viewer;if(e&&this.options.withPSO)if(t.pickingResult){var n=t.pickingResult;if(n.path.length>0){!t.trapSelection&&n.path.length>1&&n.path.splice(1,n.path.length-1);for(var i=this.currentPSO.length-1;i>=0;i--){for(var o=!1,a=n.path.length-1;a>=0;a--)this.currentPSO[i].pathElement.isEqual(n.path[a])&&(o=!0,n.path.splice(a,1));o||(this.pso.remove(this.currentPSO[i]),this.currentPSO.splice(i,1))}for(var s=0;s<n.path.length;s++)if(this.options.prePickingFilter(n.path[s])){var r={pathElement:n.path[s]};this.currentPSO.push(r),this.pso.add(r)}e.render()}else this.currentPSO&&(this.pso.empty(),this.currentPSO.length=0)}else this.currentPSO&&(this.pso.empty(),this.currentPSO.length=0)}},activateAgentControl:function(){var t,e;if(this._tokens&&0!==this._tokens.length)throw new Error("pathElementAgent.activateAgentControl, try to activate an agent which is already listening to events");for(this._tokens=[],t=0;t<this._viewers.length;t++)this._tokens[t]=[];for(t=0;t<this._viewers.length;t++)e=this._viewers[t],this.options.withPrevaluation?(e.setPrePicking({activated:!0}),this._tokens[t].push(e.onPreactivate(this.agentTreatment.bind(this)))):(this._tokens[t].push(e.onActivate(this.agentTreatment.bind(this))),this.options.withContext&&e.setPicking({contextPick:!0})),this.options.multiAcquisition&&e.setPicking({trapSelection:!0});if(this._frameWindow&&this._frameWindow.getTree()){var n=this;this._frameWindow.getTree()._modelEvents.unsubscribe(this._frameWindow.getTree()._onNodeClickToken),this._treeToken=this._frameWindow.getTree().onNodeClick(function(t){var e={};e.pickingResult=Object.create(null),e.pickingResult.path=[],e.pickingResult.path.push(t.getPathElement()),e.viewer=n._frameWindow.getViewer(),n.agentTreatment(e)})}if(this.options.withPSO&&!this.options.withPrevaluation)for(t=0;t<this._viewers.length;t++)(e=this._viewers[t]).setPrePicking({activated:!0}),this._tokens[t].push(e.onPreactivate(this.agentActionOnTheScene.bind(this)))},deactivateAgentControl:function(){for(var t=0;t<this._viewers.length;t++){var e=this._viewers[t];if(this._tokens&&this._tokens.length>0){for(var n=0;n<this._tokens[t].length;n++)e.unsubscribe(this._tokens[t][n]);this._tokens[t]=void 0}this._frameWindow&&this._frameWindow.getTree()&&(this._frameWindow.getTree()._modelEvents.unsubscribe(this._treeToken),this._frameWindow.getTree()._onNodeClickToken=this._frameWindow.getTree().onNodeClick(this._frameWindow.getTree()._onNodeClickCB)),this.options.withContext&&e.setPicking({contextPick:!1}),this.options.multiAcquisition&&e.setPicking({trapSelection:!1})}this._tokens=[]}})}),define("DS/StateCommandEngine/StateCommandDeclarative",["DS/StateCommandEngine/StateCommand","DS/StateCommandEngine/Xml2Json","DS/StateCommandEngine/XmlModelsTools","DS/StateCommandEngine/IndicationAgent","DS/StateCommandEngine/PathElementAgent","DS/StateCommandEngine/DE2NamingMap"],function(t,e,n,i,o,a){"use strict";return t.extend({init:function(t,e){return UWA.log("StateCommandDeclarative: init"),this._parent(t,e)},buildGraph:function(){UWA.log("StateCommand: buildGraph"),this.agents={};var t=this,s=function(e){for(var s=e;"StateCommand"!==n.getTag(s);)s=n.getChildren(s)[0];var r=[];n.getChildren(s).forEach(function(t){"State"===n.getTag(t)&&r.push(t)}),t.createInitialState(n.getAttribute(r[0],"Id"));for(var d=1;d<r.length;d++)t.createState(n.getAttribute(r[d],"Id"));r.forEach(function(e){n.getChildren(e).forEach(function(i){"EnterStateAction"===n.getTag(i)&&t.setEnterStateAction(t._getStateFromId(n.getAttribute(e,"Id")),t[n.getAttribute(declarativeParam,"Do")]),"LeaveStateAction"===n.getTag(i)&&t.setLeaveStateAction(t._getStateFromId(n.getAttribute(e,"Id")),t[n.getAttribute(declarativeParam,"Do")])})}),r.forEach(function(e){n.getChildren(e).forEach(function(e){if("IndicationAgent"===n.getTag(e)||"PathElementAgent"===n.getTag(e)){var s={agentId:n.getAttribute(e,"Id"),frameWindow:t.getFrameWindow()};if(n.getAttribute(e,"Behavior"))for(var r=n.getAttribute(e,"Behavior").split("|"),d=0;d<r.length;d++)a.behaviorCorrespondence[r[d]]&&(s[a.behaviorCorrespondence[r[d]]]=a.behaviorValues[r[d]]);"IndicationAgent"===n.getTag(e)&&(t.agents[n.getAttribute(e,"Id")]=new i(s)),"PathElementAgent"===n.getTag(e)&&(t.agents[n.getAttribute(e,"Id")]=new o(s))}})}),r.forEach(function(e){n.getChildren(e).forEach(function(i){if("Transition"===n.getTag(i)||"FinalTransition"===n.getTag(i)||"SelfTransition"===n.getTag(i)){var o={iInitialState:t._getStateFromId(n.getAttribute(e,"Id"))};"Transition"===n.getTag(i)?o.iFinalState=t._getStateFromId(n.getAttribute(i,"Target")):"FinalTransition"===n.getTag(i)?o.iFinalState=t.getFinalState():o.iFinalState=t._getStateFromId(n.getAttribute(e,"Id")),n.getChildren(i).forEach(function(e){if("IsOutputSetCondition"===n.getTag(e)&&(o.iEvent=t.agents[n.getAttribute(e,"Agent")]),"ReceivedEventCondition"===n.getTag(e)&&(o.iEvent=n.getAttribute(e,"Event")),"AndCondition"===n.getTag(e)||"OrCondition"===n.getTag(e)){var i=[];n.getChildren(e).forEach(function(a){"IsOutputSetCondition"===n.getTag(a)&&(o.iEvent=t.agents[n.getAttribute(e,"Agent")]),"ReceivedEventCondition"===n.getTag(e)&&(o.iEvent=n.getAttribute(e,"Event")),"Condition"===n.getTag(a)&&i.push(t[n.getAttribute(a,"Condition")])}),1===i.length?o.iCondition=i[0]:"AndCondition"===n.getTag(e)?o.iCondition=t.andCondition(i):o.iCondition=t.orCondition(i)}"Condition"===n.getTag(e)&&(o.iCondition=t[n.getAttribute(e,"Condition")]),"Action"===n.getTag(e)&&(o.iAction=t[n.getAttribute(e,"Do")],o.iUndo=t[n.getAttribute(e,"BeforeUndo")],o.iRedo=t[n.getAttribute(e,"BeforeRedo")])}),t.addTransition(o)}})})};if(this.isDeclarativeXmlCharged)s(this.jsonInformation.getModel()),t.declarativeDelayedBeginExecute&&t.declarativeDelayedBeginExecute();else{var r=null!==this.module||void 0!==this.module?this.module:null,d={xml:this.declarativeXml,module:r,directory:"assets/de2/",fileExtension:".xml",onFailure:this.end,onLoaded:function(e){t.isDeclarativeXmlCharged=!0,s(e),t._getCurrentStateId()||t._initGraph(),t.declarativeDelayedBeginExecute&&t.declarativeDelayedBeginExecute()}};this.jsonInformation=new e(d)}},endExecute:function(){this.agents=void 0,this._parent()},getAgentById:function(t){return this.agents[t]}})});