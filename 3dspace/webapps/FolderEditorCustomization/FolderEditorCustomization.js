define("DS/FolderEditorCustomization/Utils/FolderEditorCustomizationUtils",["UWA/Core"],function(e){"use strict";return{splitExtension:function(e){var t=e.split("."),o="";return t.length>1&&(o=t.pop()),{filename:t.join("."),extension:o}},editFileName:function(e,t){var o,i=e.split("."),n="";return i.length>1&&(n="."+i.pop()),o=t<1e3?("00"+t).slice(-3):""+t,i.join(".")+"_"+o+n},checkFolderEditorInvalidCharsWithSlash:function(e){for(var t=['"',"#","$","@","%","*",",","?","\\","<",">","[","]","|",":","/"],o={hasInvalidChar:!1,badChars:""},i=0;i<t.length;i++)if(e.indexOf(t[i])>=0){o.hasInvalidChar=!0,o.badChars=t.join("");break}return o},isExistsInArray:function(e,t){for(var o=0;o<t.length;o++)if(t[o]===e)return!0;return!1},isExistsInArrayUpperCase:function(e,t){for(var o=0;o<t.length;o++)if(t[o].toUpperCase()===e.toUpperCase())return!0;return!1},formatBytes:function(e,t){if(0===e)return"0 Byte";var o=t+1||3,i=Math.floor(Math.log(e)/Math.log(1e3));return(e/Math.pow(1e3,i)).toPrecision(o)+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][i]},getStringByte4UTF8:function(e){for(var t=[0,1,1,1,2,3,2,3,4,3],o=0,i=0;i<e.length;i++)o+=t[encodeURIComponent(e.charAt(i)).length];return o},Sanitize:{encode:function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}},notAllowedChars:['"',"#","$","@","%","*",",","?","\\\\","<",">","\\[","\\]","|",":"],notAllowedCharsForOwner:['"',"#","$","%","*",",","?","\\\\","<",">","\\[","\\]","|",":"],removeControllCode:function(e){return e.replace(/[\t\r\n]/g,"")},escapeControllCode:function(e){return e.replace(/\t/g,"\\t").replace(/\r/g,"\\r").replace(/\n/g,"\\n")}}}),define("DS/FolderEditorCustomization/ActiveFolder/ActionBar_ActiveFolderCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/FolderEditor/Folder_CSO","DS/FolderEditor/utils/FolderEditorcontrol","i18n!DS/FolderEditor/assets/nls/FolderEditor"],function(e,t,o,i,n){"use strict";return t.extend({labelTopBar:n.Dialog_Title,isInsert:!0,datas:{},init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!1})},beginExecute:function(){},execute:function(){require(["DS/FolderEditorCustomization/ActiveFolder/ActiveFolder"],function(e){if(!1!==e._isInitialized){var t=o.getCurrentFolder();e.activeFolderCommand(t)}else e.activeFolder()})},endExecute:function(){}})}),define("DS/FolderEditorCustomization/BulkDownload/ActionBar_BulkDownloadCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/FolderEditor/Folder_CSO","DS/FolderEditor/utils/FolderEditorcontrol","i18n!DS/FolderEditor/assets/nls/FolderEditor"],function(e,t,o,i,n){"use strict";return t.extend({labelTopBar:n.Dialog_Title,isInsert:!0,datas:{},init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!1})},beginExecute:function(){},execute:function(){require(["DS/FolderEditorCustomization/BulkDownload/BulkDownload"],function(e){function t(e,t,o){for(var i=[],n=0;n<e.length-o;n++)"FolderSection_AllFolders"!==e[n].type&&i.push(e[n].label);return i.join(t)}var i,r,l=o.getSelectedNodes(),s=function(e){for(var t=[],o=[],i=0;i<e.length;i++)o.push(e[i].getID());function n(e,t){for(var o=0;o<t.length;o++)if(t[o]===e)return!0;return!1}for(i=0;i<e.length;i++){for(var r=e[i],l=r.getParents(),s=!1,a=0;a<l.length;a++)if(n(l[a].getID(),o)){s=!0;break}s||t.push(r.getID())}return t}(l),a=o.getCurrentFolder(),d=o.getCurrentFolderPath();1!==l.length||"Folder"!==l[0].plmType&&"RootFolder"!==l[0].plmType?r=n.name_Section_AllFolders+" > "+t(d," > ",0):l[0].getID()===a.getID()?(r=n.name_Section_AllFolders+" > "+t(d," > ",0),i=t(d,"/",1)):(r=n.name_Section_AllFolders+" > "+t(d," > ",0))===n.name_Section_AllFolders+" > "?r+=l[0].getLabel():r+=" > "+l[0].getLabel(),void 0===i&&(i=t(d,"/",0)),new e({ui:!0,renderTo:widget.body,destination:"",parent:r,folderpath:i}).review(s).then(function(e){})})},endExecute:function(){}})}),define("DS/FolderEditorCustomization/Utils/FolderEditorCustomizationServices",["UWA/Core","DS/WAFData/WAFData","DS/PADUtils/PADUtilsServices","DS/DocumentManagement/DocumentManagement","DS/FolderEditor/service/FolderEditorWebService","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADWSAccess","DS/PlatformAPI/PlatformAPI"],function(e,t,o,i,n,r,l,s){"use strict";return{getDocument:function(e){i.getDocuments([e.id],e)},getFolder:function(i){if(!e.is(i,"object"))throw new Error("Invalid inputs for BulkDownload.getFolder");var n=o.get3DSpaceUrl()+"/resources/v1/FolderManagement/Folder/"+i.id+"/content?Content=All&FilterChildren=Yes",r={method:"GET",headers:{Accept:"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},timeout:12e4};r.onComplete=i.onComplete,r.onFailure=i.onFailure,t.authenticatedRequest(n,r)},getChildren:function(i){if(!e.is(i,"object"))throw new Error("Invalid inputs for BulkDownload.getChildren");var n=o.get3DSpaceUrl()+"/resources/enopad/api/expand",r={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},timeout:12e4};r.onComplete=i.onComplete,r.onFailure=i.onFailure,r.data=JSON.stringify({rootids:i.id,level:-1,with_iterations:!0}),t.authenticatedRequest(n,r)},getFileStatus:function(i){if(!e.is(i,"object"))throw new Error("Invalid inputs for BulkDownload.getFileStatus");var n=o.get3DSpaceUrl()+"/resources/enodec/api/getfilestatus",r={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},timeout:12e4};r.onComplete=i.onComplete,r.onFailure=i.onFailure,r.data="{inputids: [{id:"+i.id.join("},{id:")+"}]}",t.authenticatedRequest(n,r)},getURLs:function(e){var t={};t.onComplete=e.onComplete,t.onFailure=e.onFailure,i.downloadDocuments(e.id,t)},getUserPreferences:function(e){n.getUserPreferences(e)},setUserPreferences:function(e){n.setUserPreferences(e)},fetch:function(t){var o={intent:"explore_2D",debug:r.getSetting("enopad_webapis_debug")};l.fetch({enopad_webapis:r.getSetting("enopad_webapis"),data:o,pids:t.pids,onComplete:function(o){var i=e.is(o,"string")?JSON.parse(o):o;t.onComplete(i)},onFailure:function(e){t.onFailure(e)},timeout:12e4})},listFolders:function(e){var i=o.get3DSpaceUrl()+"/resources/v1/FolderManagement/Folder/"+e.pfolderid+"/folders",n={method:"GET",type:"json",headers:{"Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},proxy:"passport",timeout:12e4};n.onComplete=e.onComplete,n.onFailure=e.onFailure,t.authenticatedRequest(i,n)},roots:function(e){var i=o.get3DSpaceUrl()+"/resources/v1/FolderManagement/Folder/roots",n={method:"GET",type:"json",headers:{"Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},proxy:"passport",timeout:12e4};n.onComplete=e.onComplete,n.onFailure=e.onFailure,t.authenticatedRequest(i,n)},getProperties:function(e){var i=o.get3DSpaceUrl()+"/resources/v1/FolderManagement/Folder/"+e.folderid+"/properties",n={method:"GET",type:"json",headers:{"Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},proxy:"passport",timeout:12e4};n.onComplete=e.onComplete,n.onFailure=e.onFailure,t.authenticatedRequest(i,n)},newFolder:function(e,i){var n={SecurityContext:"ctx::"+e.securityContext,type:"folder"},r=o.get3DSpaceUrl()+"/resources/v1/collabServices/authoring/op/createContent?select=type&select=physicalid&select=cestamp";""!==e.folderid&&(r+="&folderID="+e.folderid);var l={method:"POST",type:"json",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+e.securityContext},data:JSON.stringify(n),timeout:12e4};l.onComplete=i.onComplete,l.onFailure=i.onFailure,t.authenticatedRequest(r,l)},updateFolderAttrib:function(e,i){var n=[{op:"replace",path:"description",value:e.description.replace(/\n/g,"\\n")},{op:"replace",path:"name",value:e.name}];if(e.owner&&s.getUser().login!==e.owner){n.push({op:"replace",path:"owner",value:e.owner});var r=e.securityContext.split(".");n.push({op:"replace",path:"organization",value:r[1]}),n.push({op:"replace",path:"project",value:r[2]})}var l={requests:[{queryParams:{select:["physicalid"]},body:n,path:"model/bus/"+i.folderid,method:"PATCH"}]},a=o.get3DSpaceUrl()+"/resources/v1/collabServices/attributes/op/update",d={method:"PUT",type:"json",proxy:"passport",headers:{"Content-Type":"application/json",SecurityContext:"ctx::"+e.securityContext},data:JSON.stringify(l),timeout:12e4};d.onComplete=i.onComplete,d.onFailure=i.onFailure,t.authenticatedRequest(a,d)},personSearch:function(e){var i=o.get3DSpaceUrl()+"/resources/v2/e6w/service/PersonSearch?searchStr="+e.name,n={method:"GET",type:"json",proxy:"passport",timeout:12e4};n.onComplete=e.onComplete,n.onFailure=e.onFailure,t.authenticatedRequest(i,n)},deleteFolder:function(e,i){var n=o.get3DSpaceUrl()+"/resources/lifecycle/Delete/structure",r={method:"POST",type:"json",proxy:"passport",headers:{"Content-Type":"application/json",SecurityContext:e.securityContext},timeout:12e4},l="?";l+="SecurityContext="+e.securityContext;var s={data:[{physicalid:e.folderid}]};r.data=JSON.stringify(s);var a=function(){};r.onComplete=i.onComplete||a,r.onFailure=i.onFailure||a,t.authenticatedRequest(n+l,r)}}}),define("DS/FolderEditorCustomization/ImportCSV/ActionBar_ImportCSVCmd",["UWA/Core","DS/ApplicationFrame/Command"],function(e,t){"use strict";return t.extend({labelTopBar:e.i18n("Import Folder Structure"),isInsert:!0,datas:{},init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!1}),require(["DS/FolderEditor/Folder_CSO","DS/FolderEditor/utils/FolderEditorcontrol"],function(e,t){})},beginExecute:function(){},execute:function(){var t=require("DS/FolderEditor/Folder_CSO"),o=require("DS/FolderEditor/utils/FolderEditorcontrol");require(["DS/FolderEditorCustomization/ImportCSV/ImportCSV"],function(i){e.Element.getElement.call(widget.body,".drop-csv")||new i({parent:o._TreeCont._folders_TreeDocument.getSelectedNodes()[0],renderTo:widget.body,currentFolder:t.getCurrentFolder()})})},endExecute:function(){}})}),define("DS/FolderEditorCustomization/ActiveFolder/ActiveFolder",["UWA/Core","UWA/Class","UWA/Class/Options","DS/Logger/Logger","UWA/Class/Promise","DS/UIKIT/Mask","DS/FolderEditor/utils/FolderAlert","DS/FolderEditor/utils/FolderCommunication","DS/PADUtils/PADUtilsServices","DS/UIKIT/Tooltip","DS/WebappsUtils/WebappsUtils","DS/FolderEditor/utils/FolderEditorcontrol","DS/PADUtils/PADProbes","DS/PADUtils/PADContext","DS/PADUtils/PADSettingsMgt","DS/FolderEditorCustomization/Utils/FolderEditorCustomizationServices","DS/PlatformAPI/PlatformAPI","DS/FolderEditorOpenness/FolderEditorOpenness","DS/UIKIT/Alert","i18n!DS/FolderEditorCustomization/assets/nls/ActiveFolder","css!DS/FolderEditorCustomization/FolderEditorCustomization.css"],function(e,t,o,i,n,r,l,s,a,d,c,u,p,g,f,_,h,v,m,F,C){"use strict";var E=t.singleton({name:"ActiveFolder",ACTIVE_FOLDER_PREFERENCE:"ActiveFolder_FolderID",DEFAULT_VALUE:"!",ICON_ACTIVE:c.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_active.png"),ICON_ACTIVE_DISABLED:c.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_active_disabled.png"),_logger:null,_isInitialized:!1,defaultOptions:{},_activeFolder:{id:null,label:"",node:null,sc:""},_disabledActiveFolder:{id:null,label:"",node:null,sc:""},init:function(e){return this._logger=i.getLogger(E),this._logger.log("init"),this._parent(e),this.activeFolderCallBack(),this},activeFolder:function(){var e=this;null===e._activeFolder.id?e.getActiveFolderFromPreference().then(function(t){e._displayActiveFolder()}):e._displayActiveFolder(),e._isInitialized=!0},getActiveFolderFromPreference:function(){var e=this;return e._getUserPreference().then(function(t){return t===e.DEFAULT_VALUE&&t.length===e.DEFAULT_VALUE.length?n.reject():(t.indexOf(e.DEFAULT_VALUE)>=0&&(t=t.slice(1,t.length),e._disabledActiveFolder={id:t,label:"",node:null,sc:""}),e._checkFolderStatus(t))}).then(function(t){return null!==e._disabledActiveFolder.id?(e._disabledActiveFolder.label=t.label,u.setActiveFolder(e.DEFAULT_VALUE,e._disabledActiveFolder.label,"",e._disabledActiveFolder.id),e._updateUI(e._disabledActiveFolder.id,""),n.resolve(t)):(e._activeFolder=t,e._setCustomSecurityContext(),u.setActiveFolder(e._activeFolder.id,e._activeFolder.label,e._activeFolder.sc,e._disabledActiveFolder.id),s.publish("FolderEditor.ActiveFolder",Object.assign({},t,{node:""})),n.resolve(t))},function(t){e._unsetAfterError()})},activeFolderCommand:function(e){var t=this,o=u.getContent().getContent();r.mask(o);var i=t._activeFolder.id;t.unsetActiveFolder(t._activeFolder).then(function(){var n={id:e.getID(),label:e.getLabel(),node:e};if(i===n.id)return r.unmask(o),l.displayNotification({message:F.replace(F.InfoMsg_Inactive_Successfully,{folderLabel:n.label}),className:"success"}),!1;t.setActiveFolder(n).then(function(e){r.unmask(o),l.displayNotification({message:F.replace(F.InfoMsg_Active_Successfully,{folderLabel:t._activeFolder.label}),className:"success"})})})},setActiveFolder:function(e){var t=this;return t.services.setUserPreferences(t.ACTIVE_FOLDER_PREFERENCE,e.id).then(function(o){t._activeFolder=e,u.setActiveFolder(t.DEFAULT_VALUE,"","","");var i=t._disabledActiveFolder.id;t._disabledActiveFolder={id:null,label:"",node:null,sc:""},t._updateUI(i,""),u.setActiveFolder(t._activeFolder.id,t._activeFolder.label,t._activeFolder.sc,t._disabledActiveFolder.id);u.getTreeCont();return t._updateUI(t._activeFolder.id,t.ICON_ACTIVE),t.enableCenterActiveFolder(),t._setCustomSecurityContext(),h.publish("FolderEditor.ActiveFolder",{id:t._activeFolder.id!==t.DEFAULT_VALUE?t._activeFolder.id:null,label:t._activeFolder.label,sc:t._activeFolder.sc}),o})},unsetActiveFolder:function(e){var t=this;return t.services.setUserPreferences(t.ACTIVE_FOLDER_PREFERENCE,t.DEFAULT_VALUE).then(function(e){u.setActiveFolder(t.DEFAULT_VALUE,"","",t._disabledActiveFolder.id);u.getTreeCont();return t._updateUI(t._activeFolder.id,""),t._activeFolder.id=t.DEFAULT_VALUE,t.disableCenterActiveFolder(),h.publish("FolderEditor.ActiveFolder",{id:null,label:"",sc:""}),e})},_getUserPreference:function(){var e=this;return e.services.getUserPreferences(e.ACTIVE_FOLDER_PREFERENCE).then(function(t){return t.value===e.DEFAULT_VALUE?e.DEFAULT_VALUE:t.value}).catch(function(t){return l.displayNotification({message:F.ErrorMsg_Rest_Error,className:"error"}),e.DEFAULT_VALUE})},_checkFolderStatus:function(e){var t=this;return new n(function(o,i){null!==e&&""!==e&&e!==t.DEFAULT_VALUE?_.getProperties({folderid:e,onComplete:function(e){void 0===e.id?(l.displayNotification({message:F.ErrorMsg_Rest_GetActiveFolder,className:"warning"}),i()):o({id:e.id,label:e.label})},onFailure:function(e){l.displayNotification({message:F.ErrorMsg_Rest_GetActiveFolder,className:"warning"}),i()}}):i()})},_unsetAfterError:function(){this._activeFolder={id:this.DEFAULT_VALUE,label:"",node:null,sc:""},this._disabledActiveFolder={id:null,label:"",node:null,sc:""},this.services.setUserPreferences(this.ACTIVE_FOLDER_PREFERENCE,this.DEFAULT_VALUE),h.publish("FolderEditor.ActiveFolder",{id:null,label:"",sc:""}),u.setActiveFolder(this.DEFAULT_VALUE,"","",""),this._displayActiveFolder();var e=F.Label_NoDefaultLocation;this._centerActiveFolderButton.setStyle("color","#d1d4d4"),this._centerActiveFolderTooltip.setBody(e),this._disableActiveFolderButton.setStyle("color","#d1d4d4"),this._disableActiveFolderTooltip.setBody(e)},_displayActiveFolder:function(){var t=this,o=u.getTreeCont()._folders_SortElmt;if(void 0!==o._activeElmt)return!0;var i="",n="",s="",a="";t._activeFolder.id===t.DEFAULT_VALUE&&null===t._disabledActiveFolder.id?(i=n="#d1d4d4",s=a=F.Label_NoDefaultLocation):t._activeFolder.id!==t.DEFAULT_VALUE&&null===t._disabledActiveFolder.id?(i=n="#378ec3",s=F.replace(F.Label_DefaultLocation,{folderLabel:t._activeFolder.label}),a=F.replace(F.Label_DisableDefaultLocation,{folderLabel:t._activeFolder.label}),t._updateUI(t._activeFolder.id,t.ICON_ACTIVE)):null===t._activeFolder.id&&null!==t._disabledActiveFolder.id&&(i="#378ec3",n="#d1d4d4",s=F.replace(F.Label_DefaultLocation,{folderLabel:""===t._activeFolder.label?t._disabledActiveFolder.label:t._activeFolder.label}),a=F.replace(F.Label_EnableLocation,{folderLabel:""===t._activeFolder.label?t._disabledActiveFolder.label:t._activeFolder.label}),t._activeFolder.id=t.DEFAULT_VALUE),t._centerActiveFolderButton=o._activeElmt=e.createElement("i",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-target sprite",styles:{color:i},events:{click:function(){if(t._activeFolder.id===t.DEFAULT_VALUE&&null===t._disabledActiveFolder.id)return!1;t.centerTreeToActiveFolder(t._activeFolder.id!==t.DEFAULT_VALUE?t._activeFolder.id:t._disabledActiveFolder.id)}}}).inject(o.elements.container,"top"),t._centerActiveFolderTooltip=new d({position:"bottom",target:o._activeElmt,body:s}),t._disableActiveFolderButton=o._activeElmtButton=e.createElement("i",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-flash sprite",styles:{color:n},events:{click:function(){if(t._activeFolder.id===t.DEFAULT_VALUE&&null===t._disabledActiveFolder.id)return!1;var e=u.getContent().getContent();return r.mask(e),t._activeFolder.id===t.DEFAULT_VALUE&&null!==t._disabledActiveFolder.id?(t._centerActiveFolderButton.setStyle("color","#378ec3"),t._centerActiveFolderTooltip.setBody(F.replace(F.Label_DefaultLocation,{folderLabel:t._disabledActiveFolder.label})),t._checkFolderStatus(t._disabledActiveFolder.id).then(function(){return t.setActiveFolder(t._disabledActiveFolder)}).then(function(){r.unmask(e),t._disabledActiveFolder={id:null,label:"",node:null,sc:""},l.displayNotification({message:F.replace(F.InfoMsg_Disable_Successfully,{folderLabel:t._activeFolder.label}),className:"info"})},function(o){t._unsetAfterError(),r.unmask(e)}),!1):t._activeFolder.id!==t.DEFAULT_VALUE&&null===t._disabledActiveFolder.id?(t._disabledActiveFolder={id:t._activeFolder.id,label:t._activeFolder.label,node:t._activeFolder.node,sc:t._activeFolder.sc},t._disableActiveFolderButton.setStyle("color","#d1d4d4"),t._disableActiveFolderTooltip.setBody(F.replace(F.Label_EnableLocation,{folderLabel:t._activeFolder.label})),t._checkFolderStatus(t._activeFolder.id).then(function(){return t.unsetActiveFolder(t._activeFolder)}).then(function(){return t.services.setUserPreferences(t.ACTIVE_FOLDER_PREFERENCE,t.DEFAULT_VALUE+t._disabledActiveFolder.id)}).then(function(){r.unmask(e),l.displayNotification({message:F.replace(F.InfoMsg_Enable_Successfully,{folderLabel:t._activeFolder.label}),className:"info"})},function(o){t._unsetAfterError(),r.unmask(e)}),!1):void r.unmask(e)}}}).inject(o.elements.container,"top"),t._disableActiveFolderTooltip=new d({position:"bottom",target:o._activeElmtButton,body:a})},activeFolderCallBack:function(e){var t=this;h.subscribe("FolderEditor.ActiveFolderCallBack",function(e){null!==e?l.displayNotification({message:F.replace(F.InfoMsg_DefaultLocation,{folderLabel:e.label}),className:"info"}):h.publish("FolderEditor.ActiveFolder",{id:t._activeFolder.id!==t.DEFAULT_VALUE?t._activeFolder.id:null,label:t._activeFolder.label,sc:t._activeFolder.sc})}),h.subscribe("FolderEditor.ActiveFolderCheck",function(e){t._checkFolderStatus(t._activeFolder.id).then(function(){},function(e){null!==t._disabledActiveFolder.id?t._checkFolderStatus(t._disabledActiveFolder.id).then(function(){},function(e){t._unsetAfterError()}):t._unsetAfterError()})})},enableCenterActiveFolder:function(){this._centerActiveFolderButton.setStyle("color","#378ec3"),this._centerActiveFolderTooltip.setBody(F.replace(F.Label_DefaultLocation,{folderLabel:this._activeFolder.label})),this._disableActiveFolderButton.setStyle("color","#378ec3"),this._disableActiveFolderTooltip.setBody(F.replace(F.Label_DisableDefaultLocation,{folderLabel:this._activeFolder.label}))},disableCenterActiveFolder:function(){this._disableActiveFolderButton.setStyle("color","#d1d4d4"),this._activeFolder.id===this.DEFAULT_VALUE&&null===this._disabledActiveFolder.id&&(this._disableActiveFolderTooltip.setBody(F.Label_NoDefaultLocation),this._centerActiveFolderButton.setStyle("color","#d1d4d4"),this._centerActiveFolderTooltip.setBody(F.Label_NoDefaultLocation))},centerTreeToActiveFolder:function(e){var t=this;t._isExpanding||(t._isExpanding=!0,u.getTreeCont().expandTreeAndSelectFolder({folderToFindAndSelect:{ids:[e]},onComplete:function(o){!function o(){return u.getTreeCont()._getVisibleNodeById(e,null)?(u.getTreeCont().expandTreeAndSelectFolder({folderToFindAndSelect:{ids:[e]}}),t._isExpanding=!1,!0):(setTimeout(function(){o()},200),!1)}()},onGiveUp:function(e){t._isExpanding=!1,l.displayNotification({message:F.ErrorMsg_Rest_GetActiveFolder,className:"warning"}),t._unsetAfterError()},onFailure:function(e){t._isExpanding=!1,l.displayNotification({message:F.ErrorMsg_Rest_GetActiveFolder,className:"warning"}),t._unsetAfterError()}}))},_updateUI:function(e,t){var o=u.getTreeCont();null!==this._disabledActiveFolder.id&&(t=this.ICON_ACTIVE_DISABLED);var i=o._getVisibleNodeById(e,o._rootNodeFolders);null!==i&&i.setBadges({bottomLeft:t});for(var n=u.getContent().getPADTreeDocument().getRoots(),r=0;r<n.length;r++)n[r].id===e&&n[r].setBadges({bottomLeft:t})},_setCustomSecurityContext:function(){if(v.useComputedSecurityContext()){var e=[],t=widget.getPreference("pad_security_ctx");if(t){var o=t.options;Array.isArray(o)?o.forEach(function(t){t.value&&e.push(t.value)}):this._logger.warn("The widget has no options for pad_security_ctx preference")}else this._logger.warn("The widget has no pad_security_ctx preference");var i="";if(e.length>0)try{i=v.computeSecurityContext(this._activeFolder.id,e)}catch(e){this._logger.warn("FolderEditorOpenness throws exception",e)}this._activeFolder.sc=i}else this._activeFolder.sc=""},services:{getUserPreferences:function(e){return new n(function(t,o){_.getUserPreferences({name:e,onComplete:function(o){t({keyname:e,value:o,message:null})},onFailure:function(t){o({keyname:e,value:null,message:F.ErrorMsg_Rest_Error})}})})},setUserPreferences:function(e,t){return new n(function(o,i){_.setUserPreferences({name:e,value:t,onComplete:function(i){o({keyname:e,value:t,message:null})},onFailure:function(o){i({keyname:e,value:t,message:F.ErrorMsg_Rest_Error})}})})}}});return E}),define("DS/FolderEditorCustomization/ImportCSV/ImportCSV",["UWA/Core","UWA/Controls/Abstract","UWA/Class/Events","UWA/Class/Options","DS/Logger/Logger","UWA/Class/Promise","DS/FolderEditor/utils/FolderAlert","DS/UIKIT/Modal","DS/UIKIT/SuperModal","DS/UIKIT/Scroller","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/UIKIT/Tooltip","DS/UIKIT/Popover","DS/Tree/Tree","DS/Tree/TreeNodeModel","DS/WebappsUtils/WebappsUtils","DS/Foundation/CsvParser","i18n!DS/FolderEditorCustomization/assets/nls/ImportStructureCSV","DS/FolderEditor/utils/FolderEditorcontrol","DS/Controls/ProgressBar","DS/UIKIT/Input/Text","DS/ENOFloatingPanel/ENOFloatingPanel","DS/PADUtils/PADProbes","DS/PlatformAPI/PlatformAPI","DS/FolderEditorCustomization/Utils/FolderEditorCustomizationServices","DS/FolderEditorCustomization/Utils/FolderEditorCustomizationUtils","DS/Encoding/Encoding","css!DS/FolderEditorCustomization/FolderEditorCustomization.css"],function(e,t,o,i,n,r,l,s,a,d,c,u,p,g,f,_,h,v,m,F,C,E,y,b,w,D,S,A,L){"use strict";var T=1e3,x=t.extend(i,o,{name:"ImportCSV",_logger:null,defaultOptions:{parent:null,renderTo:null,data:{level:0,name:1,description:2,aclOwner:3,aclSecurityContext:4,toModel:function(e){return{level:e[0].trim(),label:e[1].trim(),description:e[2].trim(),acl:{owner:""===e[3].trim()?"@BLANK@":e[3].trim(),securityContext:""===e[4].trim()?"@BLANK@":e[4].trim()}}}}},_droppableType:{"application/vnd.ms-excel":"csv","text/csv":"csv"},_isClosing:!0,_checkErrorRef:[],_currentFolderType:"",_currentFolder:null,_cancel:!1,_lv1SecCtxEmpty:!1,_browserLanguage:"",_mapSecurityContext:null,_errorTips:[],_errorReasons:null,init:function(t){var o=this;e.merge(t||{},o.defaultOptions);return o._browserLanguage=o.utils.getBrowserLanguage(),o._mapSecurityContext=o.mapSecurityContext(),new r(function(e,i){o._logger=n.getLogger(x),o._logger.log("init"),o._parent(t),o._currentFolder=t.currentFolder,o._currentFolderType=t.parent.getType(),o.inject(),e(o)})},closeDialog:function(){this.dialog&&this.dialog.destroy()},clickCancelButton:function(){this._isClosing&&(this._cancel=!0,this._errorTips.forEach(function(e){e.destroy()}),this.closeDialog())},inject:function(){var t=this;t._logger.log("inject");var o=b.createProbe("ImportCSV_inject"),i=t.createDownloadLinkDynamic(),n=new p({position:"bottom",target:i,body:m.Help_Csv_File}),r=new y({closable:!0,resizable:!0,autocenter:!0,overlay:!0,header:null,className:"importCSVDialog",limitParent:!0,body:'<div class="drop-csv"><input class="drop-csv-input" type="file" /><span class="drop-csv-label"><span class="fonticon fonticon-publish fonticon fonticon-2x"></span><p class="drop-csv-label-p"><span class="icon-label">'+m.Drop_Csv_File+'</span></p></span></div><div class="preview-csv"><div class="prev-csv-read"></div><div class="preview-csv-tree"><div class="preview-csv-tree-msg"></div></div></div>',footer:'<div class="csvstatus"></div>',events:{onHide:function(){t._isClosing&&(d.destroy(),n.destroy()),t.clickCancelButton.call(t)}}}).inject(t.options.renderTo),l=e.Element.getElement.call(r.getHeader(),".floatingPanel_title span");window.top.dbg=r.getHeader(),l.setHTML("<span class='csv-title'>"+m.Dialog_Title+t.options.parent.getLabel()+"</span><span class='csv-title-icon'></span>");var s=e.Element.getElements.call(l,"span")[0],a=e.Element.getElements.call(l,"span")[1];i.inject(a);var d=new p({position:"bottom",target:s,body:t.options.parent.getParents().map(function(e){return e.options.label}).reverse().join(" > ")+" > "+t.options.parent.getLabel()});r.getContent().setStyle("min-width","450px"),r.getContent().setStyle("width","450px"),r.getContent().setStyle("min-height","215px"),r.getContent().setStyle("height","215px"),t.csvStatusArea=e.Element.getElement.call(r.getFooter(),".csvstatus"),t.notifyArea=new E({className:"detailmsg",value:"",disabled:!0}).inject(r.getFooter());var c=new u({value:m.Label_Import,className:"primary",disabled:!0}).inject(r.getFooter());c.addEvent("onClick",function(){this.disable(),t.execImportCSV()});var g=new u({value:m.Cancel,className:"default",title:m.Cancel_Tooltip}).inject(r.getFooter());return g.addEvent("onClick",function(){t.clickCancelButton.call(t)}),r.show(),t.dialog=r,t.importButton=c,t.cancelButton=g,t.dropZone=e.Element.getElement.call(t.dialog.getBody(),".drop-csv"),t.dropInput=e.Element.getElement.call(t.dialog.getBody(),".drop-csv-input"),t.dropLabel=e.Element.getElement.call(t.dialog.getBody(),".drop-csv-label"),t.dropLabelPara=e.Element.getElement.call(t.dialog.getBody(),".drop-csv-label-p"),t.dialog.getBody().addClassName("dialog-csv"),t.dialog.getBody().setStyle("height","100px"),t.droppable(t.dropZone),o.end(),t},reset:function(){this._logger.log("reset"),this.tree&&this.tree.destroy(),this.filePreview&&this.filePreview.destroy(),this.tree=void 0,this.filePreview=void 0},_initProgress:function(e){this.progress&&this.progress.destroy(),this.csvStatusArea.empty(),this.progress=new C({shape:"circular",statusFlag:!1,emphasize:e,dislpayFlag:!1,displayStyle:"lite"}),this.progress.inject(this.csvStatusArea),this.progress.value=0},droppable:function(e){var t=this,o=0;function i(t){c.unmask(e),l.displayNotification({message:t,className:"error"}),e.addClassName("error"),setTimeout(function(){e.removeClassName("error")},T)}function n(o){var n=o.dataTransfer?o.dataTransfer.files:o.target.files;if(0===n.length)return!0;if(n.length>1)i(m.ErrorMsg_Drop_Multiple_File);else{var r=n[0].name.split(".");if(r.length<=1||"csv"!==r[r.length-1].toLowerCase())return console.warn("drop file:"+r[r.length-1].toLowerCase()),void i(m.ErrorMsg_Drop_File_Not_CSV);if(0===n[0].size)return i(m.ErrorMsg_Drop_File_Empty),!0;if(n[0].size>25600){var l=m.ConfirmMsg_Drop_File_Size_Large+" ("+S.formatBytes(n[0].size,2)+")";new a({renderTo:t.options.renderTo,events:{onShow:function(){t._isClosing=!1,t.dialog.hide()},onHide:function(){t._isClosing=!0,t.dialog.show()}}}).confirm(l,m.Label_Confirm_Title,function(o){o&&t._loadCsv(e,n[0])})}else t._loadCsv(e,n[0])}}t.dropInput.addEventListener("click",function(e){this.value=null},!1),t.dropInput.addEventListener("change",n,!1),t.listeners={},t.listeners.clickable=function(e){this.setStyle("border","1px solid #368ec4"),this.setStyle("background-color","#f9f9f9"),t.dropInput.click()},e.addEventListener("click",t.listeners.clickable),t.listeners.dragenter=function(e){this.setStyle("border","1px solid #368ec4"),this.setStyle("background-color","#f9f9f9"),o++},e.addEventListener("dragenter",t.listeners.dragenter),t.listeners.dragleave=function(e){0===--o&&(this.setStyle("border","1px solid #f4f5f6"),this.setStyle("background-color","initial"))},e.addEventListener("dragleave",t.listeners.dragleave),t.listeners.dragover=function(e){e.preventDefault()},document.addEventListener("dragover",t.listeners.dragover),t.listeners.drop=function(e){if(e.preventDefault(),e.dataTransfer.types){(e.dataTransfer.types.indexOf?-1!=e.dataTransfer.types.indexOf("Files"):e.dataTransfer.types.contains("Files"))&&n(e)}},e.addEventListener("drop",t.listeners.drop)},_loadCsv:function(t,o){var i=this;c.mask(t);var n=function(e){c.unmask(t),i.updateDroppedFile({name:o.name,size:o.size})};i._errorTips=[],i._errorReasons=[],i.importButton.setValue(m.Label_Import),i.importButton.disable(),i.reset(),t.setStyle("border","1px solid #f4f5f6").setStyle("background-color","initial");var l=e.Element.getElement.call(i.dialog.getBody(),".preview-csv-tree");l.setStyle("height","0px").setStyle("border","solid 0px"),l.empty(),e.createElement("div",{class:"tree-content"}).inject(l),r.all([i._readFile(o)]).then(function(e){try{i._initProgress("info"),i.csvStatusArea.addClassName("active");var t=v.parse(e[0]+"\r\n");r.all([i.checkLines(t),i.checkRemoteStatus(t)]).then(function(e){var o=e[0].concat(e[1]).sort(function(e,t){return Math.abs(e.linePos)!==Math.abs(t.linePos)?Math.abs(e.linePos)<Math.abs(t.linePos)?-1:1:Math.abs(e.pos)<Math.abs(t.pos)?-1:1}).filter(function(e){return""!==e.reason});i._errorReasons=o,i._prepareImportData(t,o,n)})}catch(e){handleError(e.message)}})},_prepareImportData:function(t,o,i){var n,s=this,a=0===o.length;n=a?t:[];var c=s._createTreeView(),u=s._createTreeModel(n);c.getDocument().addRoot(u),s.tree=c,s.root=u,r.all([s.resolveSecurityContextOfSelectedFolder(s.root),s._showPreview(c),s._getStructure(u.options.id,u.options.label,0,u)]).then(function(e){var o=e[0];e[1],e[2];u.options.appData.acl.securityContext=o;var i=s.root.getAllDescendants().filter(function(e){return e.options.appData.hasId});if(a){var n=t.length-i.length;if(0===n)return s.notifyMessage("info",m.InfoMsg_Create_Target_Size_Zero),s.cancelButton.setValue(m.Close),s.importButton.setValue(m.Label_Import+"(0)"),void s.importButton.disable();if(null===o&&s._lv1SecCtxEmpty)return l.displayNotification({message:m.WarnMsg_SecurityContext_MissMatch,className:"warning"}),s.cancelButton.setValue(m.Close),s.importButton.setValue(m.Label_Import+"(0)"),void s.importButton.disable();s.importButton.enable(),s.importButton.setValue(m.Label_Import+"("+n+")")}}).catch(function(e){l.displayNotification({message:m.ErrorMsg_Rest_Error+" "+e.message,className:"error"})}),i(c);var g=o.map(function(e){return Math.abs(e.linePos)}).filter(function(e,t,o){return o.indexOf(e)===t}).length,f=t.length-g,_=e.Element.getElement.call(s.dialog.getBody(),".tree-content");if(a)s.notifyMessage("info","["+f+"/"+t.length+"] "+m.InfoMsg_Load_Csv_Success),s.csvStatusArea.removeClassName("active");else{s.notifyMessage("error","["+f+"/"+t.length+"]"+m.InfoMsg_Load_Csv_Error),s.progress.emphasize="high-attention",_.addClassName("csverror");var h=[m.Label_Column_Level,m.Label_Column_Name,m.Label_Column_Description,m.Label_Column_Owner,m.Label_Column_SecurityContext];o.forEach(function(o){var i=Math.abs(o.linePos),n=(s.options.data,e.createElement("div",{text:" ("+m.Label_LineNumber+":"+(i+1)+") "+o.reason,class:"errorline icon"+o.pos}));if(_.appendChild(n),o.pos){var r;r=h[o.pos]+" : "+t[i][o.pos];var l=new p({position:"bottom",target:n,body:S.Sanitize.encode(r)});s._errorTips.push(l)}})}new d({element:_}),_.addClassName("csvshow")},undroppable:function(e){this.listeners&&(e.removeEventListener("click",this.listeners.clickable),e.removeEventListener("dragenter",this.listeners.dragenter),e.removeEventListener("dragleave",this.listeners.dragleave),e.removeEventListener("dragover",this.listeners.dragover),e.removeEventListener("drop",this.listeners.drop),this.listeners=null),e.setStyle("cursor","default"),this.dropLabel.setStyle("cursor","default"),e.addClassName("drop-disabled")},updateDroppedFile:function(t){var o=this;o.dialog.getContent().setStyle("min-width","570px"),o.dialog.getContent().setStyle("min-height","435px"),o.dialog.getContent().setStyle("width","570px"),o.dialog.getContent().setStyle("height","435px");var i=e.createElement("span",{class:"csv-file",html:'<span class="csv-file-image"></span><span class="csv-file-name">'+t.name+" ("+S.formatBytes(t.size,2)+")</span>"});o.filePreview=i,o.dropLabel.setStyle("font-size","10px").setStyle("top","-5px").setStyle("float","right").setStyle("text-align","center"),o.dropZone.setStyle("height","40px").setStyle("border","initial").setStyle("cursor","pointer");var n=e.Element.getElement.call(o.dropLabelPara,".icon-label");n.textContent=m.Change_Csv_File;var r=e.Element.getElement.call(o.dialog.getBody(),".preview-csv-tree");r.setStyle("height","calc(100% - (56px + 66px + 66px) )"),r.setStyle("border","1px solid #e2e4e3").setStyle("top","100px"),e.Element.getElement.call(o.dialog.getBody(),".tree-content")||e.createElement("div",{class:"tree-content"}).inject(e.Element.getElement.call(o.dialog.getBody(),".preview-csv-tree-msg")),setTimeout(function(){if(i.inject(o.dropLabel,"before"),o.undroppable(o.dropZone),!o.iconZone){o.iconZone=e.Element.getElement.call(o.dropZone,".fonticon"),o.iconZone.setStyle("cursor","pointer");var t=function(e){o.dropInput.click()};o.iconZone.addEventListener("click",t,!1);var r=n;r.setStyle("cursor","pointer"),r.addEventListener("click",t,!1)}},T/3)},_readFile:function(e){var t=this,o=new FileReader;return new r(function(i,n){o.onload=function(e){i(e.target.result)},"ja"===t._browserLanguage?o.readAsText(e,"Shift-JIS"):o.readAsText(e,"WINDOWS-1252")})},checkLines:function(e){for(var t=this,o=0;o<e.length;o++){var i=e[o];if(i.length>=2&&i.length<5)for(var n=i.length;n<5;n++)i.push("")}return new r(function(o,i){var n=b.createProbe("ImportCSV_checklines"),r=t.options.data,l=0,s="",a=[{}],d={},c=[],u=new RegExp("^-*[0-9]+$");t._checkErrorRef=c;for(var p=0;p<e.length;p++){var g={reason:"",data:[],linePos:-1,pos:-1},f=e[p];if(f.length<5)g.reason=m.ErrorMsg_Column_Count,g.linePos=p,g.pos=null,c.push(g);else{if(l>=0){g.pos=r.level;var _=f[r.level];if(!u.test(_)){g.reason=m.ErrorMsg_Level_Is_Not_Number,g.linePos=-1*p,c.push(g),l=g.linePos;continue}if((_=parseInt(_))<=0){g.reason=m.ErrorMsg_Level_Origin,g.linePos=-1*p,c.push(g),l=g.linePos;continue}if(!(l>=_||l+1===_)){g.pos=r.level,g.reason=m.ErrorMsg_Level_Is_Not_Sequencial,g.linePos=-1*p,c.push(g),l=g.linePos;continue}if(l>=_)for(var h=l-_,v=0;v<h;v++)a.pop();if(s=f[r.name],a.length+1===_&&a.push({}),(d=a[_-1])[s]){g.pos=r.name,g.reason=m.ErrorMsg_Name_Duplicate,g.linePos=p,l=_,c.push(g);continue}d[s]=!0,l=_}if(g.pos=r.name,""!==(s=f[r.name]).trim())if(S.getStringByte4UTF8(s)>=127)g.reason=m.ErrorMsg_Name_Max_Over,g.linePos=p,c.push(g);else{var F=S.notAllowedChars.join(""),C=new RegExp("["+F+"]"),E=C.exec(s);if(E)g.reason=m.ErrorMsg_Avoid_Char+"("+E.map(function(e){return e}).join("&nbsp;")+")",g.linePos=p,c.push(g);else{s=S.removeControllCode(s),f[r.name]=s,g.pos=r.description;var y=f[r.description];y.length>1024?(g.reason=m.ErrorMsg_Desc_Max_Over,g.linePos=p,c.push(g)):(E=C.exec(y))?(g.reason=m.ErrorMsg_Avoid_Char+"("+E.map(function(e){return e}).join("&nbsp;")+")",g.linePos=p,c.push(g)):(y=S.escapeControllCode(y),f[r.description]=y)}}else g.reason=m.ErrorMsg_Name_Required,g.linePos=p,c.push(g)}}n.end(),o(c)})},checkRemoteStatus:function(e){var t=this;return new r(function(o,i){var n=b.createProbe("ImportCSV_checkRemoteStatus"),l=t.options.data,s={listeners:{}},a=[];t.csvStatusArea.addClassName("active"),t._lv1SecCtxEmpty=!1;var d=S.notAllowedChars.join(""),c=S.notAllowedCharsForOwner.join(""),u=new RegExp("["+d+"]"),p=new RegExp("["+c+"]"),g=0,f=0,_=t.listSecurityContext(),h=-1;function v(){return result={reason:"",data:[],linePos:-1,pos:-1}}e.forEach(function(i,d){if(i.length<5)for(var c=i.length;c<5;c++)i.push("");var F=v();f++;var C=i[l.aclOwner];C=C.trim();var E=[],y=null;if(y=r.resolve(!0),0!==C.length){var b=p.exec(C);switch(!0){case S.getStringByte4UTF8(C)!==C.length:F.pos=l.aclOwner,F.reason=m.ErrorMsg_Owner_Is_Not_Ascii,F.linePos=d,a.push(F),y=r.resolve("NOCHECK");break;case null!==b:F.pos=l.aclOwner,F.reason=m.ErrorMsg_Avoid_Char+"("+b.map(function(e){return e}).join("&nbsp;")+")",F.linePos=d,a.push(F),y=r.resolve("NOCHECK");break;default:F.pos=l.aclOwner,y=t._checkOwner(d,C,s)}}E.push(y),F=v();var w=i[l.aclSecurityContext].trim();if(y=r.resolve(!0),0!==w.length)switch(b=u.exec(w),!0){case 3!==w.split(".").length:F.pos=l.aclSecurityContext,F.reason=m.ErrorMsg_SecCtx_Is_Invalid,F.linePos=d,a.push(F),y=r.resolve("NOCHECK");break;case null!==b:F.pos=l.aclSecurityContext,F.reason=m.ErrorMsg_Avoid_Char+"("+b.map(function(e){return e}).join("&nbsp;")+")",F.linePos=d,a.push(F),y=r.resolve("NOCHECK");break;default:F.pos=l.aclSecurityContext,y=t._checkSecurityContext(d,w,_)}else"1"===i[l.level].trim()&&(t._lv1SecCtxEmpty=!0);E.push(y);var D=d+"";r.all(E).then(function(o){if(!0===o[0]&&!0===o[1]&&0===t._checkErrorRef.filter(function(e){return Math.abs(e.linePos)===parseInt(D)}).length){var i=++g/e.length*100;h!==i&&(t.progress.value=i,h=i)}return o}).then(function(e){var t=null,r=null;!1===e[0]&&(t=m.ErrorMsg_Owner_Does_Not_Exist),null===e[0]&&(t=m.ErrorMsg_Rest_Error),t&&(r={reason:t,data:i,linePos:d,pos:l.aclOwner},a.push(r)),t=null,!1===e[1]&&(t=m.ErrorMsg_SecCtx_Does_Not_Exist),t&&(r={reason:t,data:i,linePos:d,pos:l.aclSecurityContext},a.push(r)),0===--f&&(n.end(),o(a))})})})},_createTreeModel:function(e){var t=this.options.data,o=[],i=b.createProbe("ImportCSV_createTreeModel"),n=new _({id:this.options.parent.id,label:this.options.parent.getLabel(),level:0,appData:{acl:{}},icons:[h.getWebappsAssetUrl("FolderEditor","icons/foldersectionall.png")]});return o.push(n),e.forEach(function(e){var i=t.toModel(e);i.hasId=!1;var n=new _({level:i.level,label:i.label,appData:i,icons:[h.getWebappsAssetUrl("FolderEditor","icons/folder.png")]}),r=i.level;o.length===r?o.push(n):o[r]=n,o[r-1].addChild(n)}),i.end(),n},_createTreeView:function(){var t={apiVersion:2,height:"auto",position:"relative",width:"auto",isEditable:!1,isSortable:!1,selection:{toggle:!1,canMultiSelect:!1,unselectAllOnEmptyArea:!1,nodes:!1,rowHeaders:!1}};return this.dialog.getBody().setStyle("height","323px"),new f(t).inject(e.Element.getElement.call(this.dialog.getContent(),".preview-csv-tree"))},notifyMessage:function(e,t){this.notifyArea.setValue(t),this.notifyArea.setClassName("detailmsg show "+e)},_showPreview:function(t){var o=this;return new r(function(i,n){!function n(){null!==e.Element.getElement.call(o.dialog.getBody(),".wux-scroller")?(setTimeout(function(){t.getDocument().expandAll(),c.unmask(e.Element.getElement.call(o.dialog.getContent(),".preview-csv-tree"))},T/10),i(t)):setTimeout(function(){n()},T/10)}()})},_getStructure:function(e,t,o,i){var n=this;return new r(function(t,l){var s=b.createProbe("ImportCSV_getStructure"),a={onComplete:function(e){for(var l={},a=[],d=e.folders,c=i.getChildren()||[],u=c.map(function(e){return e.getLabel()}),p=0;p<d.length;p++){var g=d[p],f=o+1,_={id:g.id,label:g.name,level:o+1};l[g.name]=_;var v=u.indexOf(g.name);if(-1!=v){var m=c[v];m.options.id=g.id,m.options.icons=[h.getWebappsAssetUrl("FolderEditor","icons/foldersectionall.png")],m.options.appData.hasId=!0,m.options.appData.modified=new Date(Date.parse(g.modified)),m.options.appData.acl.securityContext=n.resolveCurrentSecurityContextBy(g.organizationResponsible,g.project),m.updateOptions("icons"),a.push(n._getStructure(g.id,g.name,f,m))}}r.all(a).then(function(e){t(l),s.end()})},onFailure:function(e){var t;(t=i).options.icons=[h.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")],t.updateOptions("icons"),l(i.options.label),s.end()}};0===o&&"FolderSection_AllFolders"===n._currentFolderType?D.roots(a):(a.pfolderid=e,D.listFolders(a))})},resolveSecurityContextOfSelectedFolder:function(e){var t=this;return new r(function(o,i){var n=b.createProbe("ImportCSV_resolveSecurityContextOfSelectedFolder");""!==e.options.id?D.getProperties({folderid:e.options.id,onComplete:function(i){e.options.appData.acl.securityContext=t.resolveCurrentSecurityContextBy(i.organizationResponsible,i.project),o(e.options.appData.acl.securityContext),n.end()},onFailure:function(t){e.options.icons=[h.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")],e.updateOptions("icons"),i({type:"check",message:"("+e.options.label+")",raw:t}),n.end()}}):(e.options.appData.acl.securityContext=t.utils.getCurrentSecurityContext(),o(e.options.appData.acl.securityContext),n.end())})},resolveCurrentSecurityContextBy:function(e,t){var o=this.utils.getCurrentSecurityContext(),i=o.split("."),n=i[1],r=i[2];return n===e&&r===t?o:(this._logger.warn("can't resolve securityContext : "+e+"."+t),null)},execImportCSV:function(){var e=this,t=b.createProbe("ImportCSV_execImportCSV");e._cancel=!1,e._initProgress("success"),e.csvStatusArea.addClassName("active");for(var o=e.root.getAllDescendants(),i=[],n=0,s=0;s<o.length;s++){var a,d=o[s];d.options.appData.hasId?(a=e.getFolder(d),n++):a=e.createFolder(d),i.push(a)}var c=0,u=null,p=i.length-n;i.reduce(function(t,o){return t.then(function(t){e.progress.value=c/p*100,e.notifyMessage("info","["+c+"/"+p+"] "+m.InfoMsg_Folder_Creating),"create"===t.type&&c++}).then(o)},r.resolve({type:"dummy"})).catch(function(e){u=e.message||e}).then(function(o){e.cancelButton.setValue(m.Close),F.getContent().loadContentAndSelect(e._currentFolder),F.getTreeCont().updateTreeWithNewFolder(e._currentFolder),null===u?(e.progress.value=100,e.notifyMessage("info","["+p+"/"+p+"] "+m.InfoMsg_Folder_Create_Success),e.csvStatusArea.removeClassName("active"),l.displayNotification({message:m.InfoMsg_Folder_Create_Success,className:"info"})):(e.notifyMessage("error","["+c+"/"+p+"] "+m.ErrorMsg_Folder_Create_Stoped),e.progress.emphasize="high-attention",l.displayNotification({message:u,className:"error"})),t.end()})},createDownloadLinkDynamic:function(){var t=this.createDownloadCSV();if("ja"===this._browserLanguage){var o=function(e){for(var t=[],o=0;o<e.length;o++){var i=e.charCodeAt(o);i<128?t.push(i):i<2048?t.push(192|i>>6,128|63&i):i<55296||i>=57344?t.push(224|i>>12,128|i>>6&63,128|63&i):(o++,i=65536+((1023&i)<<10|1023&e.charCodeAt(o)),t.push(240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i))}return t}(t),i=A.convert(o,{to:"SJIS",from:"UTF8"});t=new Int8Array(i)}var n=new Blob([t],{type:"octet/stream"}),r=window.URL.createObjectURL(n),l=e.createElement("a",{class:"fonticon fonticon-help-circled csv-file-help",download:"template.csv",href:r});return l.addEventListener("click",function(e){e.stopPropagation(),window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveOrOpenBlob(n,"template.csv")}),l},createDownloadCSV:function(){var e=[];return Object.keys(this._mapSecurityContext).forEach(function(t,o){var i=[""+(o+1),"Folder"+(o+1),"comment",w.getUser().login,t];e.push(i.join(","))}),e.join("\r\n")},createFolder:function(e){var t=this;return function(){return new r(function(o,i){return t._cancel?(t._logger.log("Import operation canceled"),void i({type:"create",message:m.ErrorMsg_Folder_Create_Stoped,raw:""})):(null!==(n="@BLANK@"!==e.options.appData.acl.securityContext?e.options.appData.acl.securityContext:e.getParent().options.appData.acl.securityContext)&&(t._mapSecurityContext[n]&&(n=t._mapSecurityContext[n]),e.options.appData.acl.securityContext=n),null===n?(e.options.icons=[h.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")],e.updateOptions("icons"),void i({type:"create",message:m.WarnMsg_SecurityContext_MissMatch,raw:""})):void D.newFolder({folderid:e.getParent().options.id,securityContext:n},{onComplete:function(r){var l,s=[h.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ok.png")];if(null===r||"SUCCESS"!==r.result)return e.options.icons=[h.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")],e.updateOptions("icons"),l=r&&r.message||m.ErrorMsg_Folder_Create_Stoped,void i({type:"create",message:l,raw:r});var a={name:e.options.appData.label,description:e.options.appData.description,securityContext:n};"@BLANK@"!==e.options.appData.acl.owner&&(a.owner=e.options.appData.acl.owner);var d=r.id;D.updateFolderAttrib(a,{folderid:d,onComplete:function(n){if(200===n.results[0].status)e.options.id=d,e.options.icons=s,e.updateOptions("icons"),o({type:"create",message:null,raw:n});else{var r=function(){e.options.icons=[h.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")],e.updateOptions("icons"),i({type:"create",message:t.utils.updateFolderAttribMessageResolver(n.results[0]),raw:n})};D.deleteFolder({securityContext:widget.getPreference("pad_security_ctx").value,folderid:d},{onComplete:r,onFailure:r})}},onFailure:function(o){t._logger.log("updateFolderAttrib failure"),t._logger.log(o),e.options.icons=[h.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")],e.updateOptions("icons"),i({type:"create",message:m.ErrorMsg_Folder_Create_Stoped,raw:o})}})},onFailure:function(t){e.options.icons=[h.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")],e.updateOptions("icons"),i({type:"create",message:m.ErrorMsg_Rest_Error+"("+e.options.label+")",raw:t})}}));var n})}},getFolder:function(e){return function(){return new r(function(t,o){D.getProperties({folderid:e.options.id,onComplete:function(i){new Date(Date.parse(i.modified)).getTime()!==e.options.appData.modified.getTime()?(e.options.icons=[h.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")],e.updateOptions("icons"),o({type:"check",message:m.ErrorMsg_Exist_Folder_Modified+"("+e.options.label+")",raw:i})):t({type:"check",message:null,raw:i})},onFailure:function(t){e.options.icons=[h.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")],e.updateOptions("icons"),o({type:"check",message:m.ErrorMsg_Rest_Error+"("+e.options.label+")",raw:t})}})})}},_checkOwner:function(e,t,o){var i=this;return new r(function(e,n){if(""!==t)if(o[t])e(o[t]);else{var r=void 0!==o.listeners[t],l=o.listeners[t]||[];l.push(e),o.listeners[t]=l,r||D.personSearch({name:t,onComplete:function(e){if(1===e.data.length){var i=e.data[0].dataelements.name;t===i?(l.forEach(function(e){e(!0)}),o[t]=!0):(l.forEach(function(e){e(!1)}),o[t]=!1)}else l.forEach(function(e){e(!1)}),o[t]=!1},onFailure:function(e){!0,i._logger.log("response error personSearch "),l.forEach(function(e){e(null)})}})}else e(!0)})},listSecurityContext:function(){var e=[],t=widget.getPreference("pad_security_ctx");if(t){var o=t.options;Array.isArray(o)&&o.forEach(function(t){t.value&&e.push(t.value.split("::")[1])})}return e},mapSecurityContext:function(){var e={},t=widget.getPreference("pad_security_ctx");if(t){var o=t.options;Array.isArray(o)&&o.forEach(function(t){t.value&&(e[t.label]=t.value.split("::")[1])})}return e},_checkSecurityContext:function(e,t,o){var i=this;return new r(function(e,n){if(""!==t)return i._mapSecurityContext[t]?void e(!0):void e(-1!==o.indexOf(t));e(!0)})},utils:{getCurrentSecurityContext:function(){var e=widget.getPreference("pad_security_ctx").value;return e.contains("ctx::")?e.split("::")[1]:e},getBrowserLanguage:function(){try{return widget.lang}catch(e){return}},updateFolderAttribMessageResolver:function(e){return e.body&&e.body.errors&&0!==e.body.errors.length?e.body.errors[e.body.errors.length-1].message:m.ErrorMsg_Folder_Create_Stoped}}});return x}),define("DS/FolderEditorCustomization/BulkDownload/BulkDownload",["UWA/Core","UWA/Controls/Abstract","UWA/Class/Events","UWA/Class/Options","DS/Logger/Logger","UWA/Class/Promise","DS/i3DXCompassServices/i3DXCompassPubSub","DS/FolderEditor/utils/FolderAlert","DS/ENOFloatingPanel/ENOFloatingPanel","DS/UIKIT/Scroller","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/UIKIT/Tooltip","DS/UIKIT/Form","DS/Controls/LineEditor","DS/Controls/ProgressBar","DS/UIKIT/Spinner","i18n!DS/FolderEditorCustomization/assets/nls/BulkDownload.json","DS/PADUtils/PADProbes","DS/FolderEditorCustomization/Utils/FolderEditorCustomizationServices","DS/FolderEditorCustomization/Utils/FolderEditorCustomizationUtils","css!DS/FolderEditorCustomization/FolderEditorCustomization.css"],function(e,t,o,i,n,r,l,s,a,d,c,u,p,g,f,_,h,v,m,F,C){"use strict";var E={dialogBody:'<div class="flip-container"><div class="flipper"><div class="front"><div class="review-files"></div></div><div class="back"><div class="form-settings"></div></div></div></div>'},y=t.extend(i,o,{name:"BulkDownload",_logger:null,defaultOptions:{ui:!0,renderTo:null,id:[],destination:"",folder:"Workspace Vault",rootFolder:"Personal Workspace",document:"Document",product:"CATProduct",part:"CATPart",process:"CATProcess",analysis:"CATAnalysis",analysisResult:"CATAnalysisResults",drawing:"CATDrawing",design:"CATIA Design Table",cgr:"CATIA CGR",analysisComputations:"CATAnalysisComputations",shape:"CATShape"},URLATTR_NOURL:"NOURL",URLATTR_URL:"URL",FILENAMEATTR_EO:"EO-",_id:null,_settingChanged:!1,_loadingReady:!1,_getFileStatusAPIisReady:!1,_warningDisplayisReady:!1,_userCanceled:!1,_downloadFailed:!1,_downloadStarted:!1,_cannotDownload:!1,_folders:{},_foldersForDownload:null,_folderpathForFlatDownload:null,_folderRelation:{_map:{},pushFoldername:function(e,t){void 0===this._map[e.toUpperCase()]&&(this._map[e.toUpperCase()]=[]),null!==t&&this._map[e.toUpperCase()].push(t)},hasParentFoldername:function(e){var t=!1;return e.toUpperCase()in Object.keys(this._map)&&(t=!0),t},getFoldernames:function(e){var t=this._map[e.toUpperCase()];return void 0===t&&(t=[]),t},clearMap:function(){this._map={}}},_files:{},_syncFiles:{_syncFileList:[],_syncFileMap:{},addFile:function(e){var t=!1;return void 0===this._syncFileMap[e]&&(this._syncFileMap[e]=1,this._syncFileList.push(e),t=!0),t},concatFiles:function(e){for(var t=0;t<e.length;t++){var o=e[t];this.addFile(o)}},getList:function(){return this._syncFileList},getLength:function(){return this._syncFileList.length},getItem:function(e){return this._syncFileList[e]},clearList:function(){this._syncFileList=[],this._syncFileMap={}}},_issues:[],_errors:{ERRORID_NOTSYNC:"notUpToDate",ERRORID_INVALID:"IEF035520650",ERRORID_NOTEXIST:"IEF035520649",ERRORID_OTHER:"UNKNOWN",ERRORID_EMBEDED_COMPONENT:"#4000043",_syncErrorMap:{},_errorMap:{},_logger:null,pushError:function(e,t,o){var i=this;i._logger.log("Error happens. fileid=["+e+"], errorId=["+t+"], errorMessage=["+o+"]");var n=function(e){return e===i.ERRORID_NOTSYNC?v.displayMessage_notSync:e===i.ERRORID_INVALID?v.displayMessage_invalid:e===i.ERRORID_NOTEXIST?v.displayMessage_notExist:v.displayMessage_unknown},r=i._errorMap[e];void 0===r?(r={fileid:e,errorid:t,errorMessage:o,displayError:n(t)},i._errorMap[r.fileid]=r,t===i.ERRORID_NOTSYNC&&(i._syncErrorMap[r.fileid]=r)):r.errorid===i.ERRORID_OTHER&&(r.errorid=t,r.displayError=n(t))},getSyncErrorLength:function(){return Object.keys(this._syncErrorMap).length},getFileIdList:function(){return Object.keys(this._errorMap)},getError:function(e){return this._errorMap[e]},init:function(e){this._logger=e,this.clearList()},getErrorIdFromErrorMessage:function(e){var t=this.ERRORID_OTHER;return e.indexOf(this.ERRORID_EMBEDED_COMPONENT)>=0&&(t=this.ERRORID_EMBEDED_COMPONENT),t},clearList:function(){this._errorMap={},this._syncErrorMap={}}},_stats:{folders:0,files:0,size:0,error:0,warning:0,conflictCount:0},_settings:{DOWNLOAD_FLAT_PREFERENCE:{keyname:"BulkDownload_downloadFlat",defaultvalue:"false"},DOWNLOAD_WITH_CSV_PREFERENCE:{keyname:"BulkDownload_downloadWithCSV",defaultvalue:"false"},downloadFlat:!1,downloadWithCSV:!1},_tooltips:{_map:{},_sequence:0,pushTooltip:function(e){return this._sequence++,this._map[this._sequence]=e,this._sequence},clearList:function(){for(var e=Object.keys(this._map),t=0;t<e.length;t++)this.deleteTooltip(e[t]);this._map={},this._sequence=0},deleteTooltip:function(e){this._map[e].destroy(),delete this._map[e]}},_progress:{_progressbar:null,_injectTo:null,_maxValue:0,_currentValue:0,initProgress:function(e,t,o){this._progressbar&&this._progressbar.destroy(),this._progressbar=new _({shape:"circular",statusFlag:!1,emphasize:e,dislpayFlag:!1,displayStyle:"lite"}),this._maxValue=null,this._progressbar.inject(t),this._progressbar.value=0,this._maxValue=void 0!==o?o:4,this._currentValue=0,this._injectTo=t},addCurrentValue:function(){this._currentValue++;var e=this._currentValue/this._maxValue*100;this._progressbar.value=e,this._maxValue===this._currentValue&&this._injectTo.removeClassName("active")},startProgress:function(){this._injectTo.addClassName("active")},setErrorProgress:function(){this._progressbar.emphasize="high-attention"}},init:function(e){var t=m.createProbe("BulkDownload_init");return this._logger=n.getLogger(y),this._logger.log("init"),this._parent(e),this.options.container=this.options.folder+","+this.options.rootFolder,this.options.expandable=this.options.product+","+this.options.part+","+this.options.analysis+","+this.options.process+","+this.options.drawing+","+this.options.shape,this.options.leaf=this.options.document+","+this.options.analysisComputations+","+this.options.cgr+","+this.options.analysisResult+","+this.options.design,this._getFileStatusAPIisReady=!1,this._warningDisplayisReady=!1,this._userCanceled=!1,this._downloadFailed=!1,this._downloadStarted=!1,this._cannotDownload=!1,t.end(),this},closeDialog:function(){this._tooltips.clearList(),this.dialog&&this.dialog.destroy()},displayDialog:function(){var t=m.createProbe("BulkDownload_displayDialog"),o=this;o._logger.log(">>> start displayDialog"),o._logger.log("injecting the modal dialog in widget body");var i=new a({closable:!0,resizable:!0,autocenter:!0,overlay:!0,header:null,className:"bulkDownloadDialog",title:v.dialogTitle,body:E.dialogBody,footer:"",visible:!0,limitParent:!0,events:{onHide:function(){},onClose:function(){o.clickCancelButton()}}}).inject(o.options.renderTo),n=i.getHeader().getElementsByClassName("floatingPanel_title")[2],r=n.getChildren()[0];if(void 0!==o.options.parent){var l=new p({position:"bottom",target:r,body:o.options.parent});o._tooltips.pushTooltip(l)}i.getContent().setStyle("min-width","650px"),i.getContent().setStyle("min-height","300px"),i.getContent().setStyle("height","350px");var s=e.createElement("div",{class:"progressbar-area"}).inject(i.getFooter());o.progressbarArea=s;var g=e.createElement("span",{class:"stats-area-displayCurrentProcess"}).inject(i.getFooter());o.statsArea=g;var f=new u({value:v.download,className:"primary"}).inject(i.getFooter());f.disable(),f.addEvent("onClick",function(){o.clickDownloadButton.call(o)}),new u({value:v.cancel,className:"default"}).inject(i.getFooter()).addEvent("onClick",function(){o.clickCancelButton.call(o)}),i.show();var _=e.createElement("span",{class:"bulk-settings fonticon fonticon-cog"}).inject(n),h=new p({position:"bottom",target:_,body:v.bulkSettings});o._tooltips.pushTooltip(h),_.addEvent("click",function(t){e.Element.getElement.call(i.getBody(),".flip-container").className.indexOf("flipped")>=0?(e.Element.getElement.call(i.getBody(),".flip-container").removeClassName("flipped"),o._settingChanged?(o._settingChanged=!1,o._loadingReady&&!o._downloadFailed&&o.reloadDisplay()):!o._loadingReady||o._downloadStarted||o._cannotDownload||o._downloadFailed||o.downloadButton.enable()):(e.Element.getElement.call(i.getBody(),".flip-container").addClassName("flipped"),o.downloadButton.disable()),void 0!==t.callback&&t.callback(o)});var F=new d({element:e.Element.getElement.call(i.getContent(),".review-files")}).inject(e.Element.getElement.call(i.getBody(),".front")),C=e.createElement("div",{class:"errorfiles-review"}).inject(F.elements.content);return o.dialog=i,o.scroller=F,o.downloadButton=f,o.errorFilesDiv=C,o.displayDialogSettings(),c.mask(e.Element.getElement.call(i.getContent(),".review-files")),o._progress.initProgress("success",o.progressbarArea),o._logger.log("<<< end displayDialog"),t.end(),o},clickDownloadButton:function(){var t=this,o=Object.keys(t._files);function i(t){var o={};return t.attributes.forEach(function(t){if("type"===t.name)t.name="ds6w:type";else if("owner"===t.name)t.name="ds6w:responsible";else{var i=t.name.split("/");t.name=i[i.length-1]}if(e.is(t.value)&&e.is(t.value.replace,"function")&&(t.value=t.value.replace(/\\n/g," ")),"ds6w:created"===t.name||"ds6w:modified"===t.name){var n=Date.parse(t.value);isNaN(n)||(t.value=new Date(n).toLocaleString())}"ds6w:type"===t.name&&(o.type=t.value),"resourceid"===t.name||"physicalid"===t.name?o.resourceid=t.value:"did"===t.name?o.did=t.value:"type_icon_url"===t.name?(o.icons||(o.icons=[]),o.icons.push(t.value)):"preview_url"===t.name||"thumbnail_2d"===t.name?(o.thumbnail=t.value,o.grid||(o.grid={}),o.grid.thumbnail="url("+t.value+")"):"relcount"===t.name?o.relcount=parseInt(t.value):"ds6w:label"===t.name?o.label=t.value:(o.grid||(o.grid={}),o.grid[t.name]=t.value)}),o}if(t._settings.downloadWithCSV){c.mask(e.Element.getElement.call(t.dialog.getContent(),".review-files")),t.downloadButton.disable();var n=[];n.push(new r(function(e,i){t._logger.log("Fetch count = "+o.length),F.fetch({pids:o,onComplete:function(t){void 0!==t.results&&t.results.length===o.length?e({response:t}):i({response:t,errormessage:v.error_index})},onFailure:function(e,t){i({response:e,error:t})}})})),r.all(n).then(function(e){var o,n,r=e[0];if(t._logger.log("Fetch result count = "+r.response.results.length),t._userCanceled)return t;for(var l=0;l<r.response.results.length;l++){var s=i(r.response.results[l]),a=t._files[s.resourceid];n=s,(o=a).attributes={},o.attributes.label=n.label,o.attributes.type=n.type,o.attributes.relcount=n.relcount,o.attributes.resourceid=n.resourceid,o.attributes.created=n.grid["ds6w:created"],o.attributes.modified=n.grid["ds6w:modified"],o.attributes.organizationResponsible=n.grid["ds6w:organizationResponsible"],o.attributes.policy=n.grid["ds6w:policy"],o.attributes.project=n.grid["ds6w:project"],o.attributes.reserved=n.grid["ds6w:reserved"],o.attributes.responsible=n.grid["ds6w:responsible"],o.attributes.revision=n.grid["ds6wg:revision"],o.attributes.description=n.grid["ds6w:description"],o.attributes.isDuplicated=n.grid.isDuplicated,o.attributes.isLastMinorRevision=n.grid.isLastMinorRevision,a=o}t.startDownload(),t.closeDialog()},function(e){e[0];if(t._userCanceled)return t;e.response&&e.response.message&&e.response.message.indexOf("timedout")>-1?t.utils.errorHandling.call(t,"error",v.message_timeout_error):t.utils.errorHandling.call(t,"error",e.errormessage)})}else t.startDownload(),t.closeDialog()},clickCancelButton:function(){this._userCanceled=!0,this.closeDialog()},removeReviews:function(e){function t(e,t){for(var o=0;o<t.length;o++)e.removeChild(t[o])}var o=this.scroller.elements.content,i=o.getElementsByClassName("only-message-div"),n=o.getElementsByClassName("conflictfiles-review");if(null!==n&&t(o,n),null!==i&&t(o,i),this.statsArea.className="stats-area-displayCurrentProcess",t(this.statsArea,this.statsArea.getElementsByClassName("display-conflict-info")),t(this.statsArea,this.statsArea.getElementsByClassName("display-update")),!0===e){var r=o.getElementsByClassName("errorfiles-review");null!==r&&t(o,r);var l=o.getElementsByClassName("errorfiles-review-warning");null!==l&&t(o,l)}},reloadDisplay:function(){var t=m.createProbe("BulkDownload_reloadDisplay");this._logger.log(">>> start reloadDisplay"),this.removeReviews(),c.mask(e.Element.getElement.call(this.dialog.getContent(),".review-files"));for(var o=Object.keys(this._files),i=0;i<o.length;i++){this._files[o[i]].newFileName={}}this.checkAndDisplay(),this._logger.log("<<< end reloadDisplay"),t.end()},checkAndDisplay:function(){var t=m.createProbe("BulkDownload_checkAndDisplay");this._logger.log(">>> start checkAndDisplay");var o=this._folders,i=this._folderRelation;if(this._settings.downloadFlat){(o={})[""]=[];var n=[];i={_map:{"":[]},getFoldernames:function(e){return[]}};for(var r=Object.keys(this._folders),l=0;l<r.length;l++)for(var s=this._folders[r[l]],a=0;a<s.length;a++)o[""].push(s[a]),n.push(r[l]);this._folderpathForFlatDownload=n}if(this._userCanceled)return this;this._foldersForDownload=o;var d=this._checkConflict(o,this._files,i);this._displayReview(o,this._files,d,this._errors,i),this._displayStats(o,this._files,d,this._errors,i),c.unmask(e.Element.getElement.call(this.dialog.getContent(),".review-files")),this._logger.log("<<< end checkAndDisplay"),t.end()},displayDialogSettings:function(){var t=m.createProbe("BulkDownload_displayDialogSettings"),o=this;o._logger.log(">>> start displayDialogSettings");var i="",n="";var l=[];l.push(o._settings.DOWNLOAD_FLAT_PREFERENCE),l.push(o._settings.DOWNLOAD_WITH_CSV_PREFERENCE);for(var s=[],a=0;a<l.length;a++)s.push(new r(function(e,t){var o=l[a];F.getUserPreferences({name:o.keyname,onComplete:function(t){var i=t;""===i&&(F.setUserPreferences({name:o.keyname,value:o.defaultvalue,onComplete:function(e){},onFailure:function(e){}}),i=o.defaultvalue),e({keyname:o.keyname,value:i})},onFailure:function(t){e({keyname:o.keyname,value:o.defaultvalue})}})}));r.all(s).then(function(t){for(var r=0;r<t.length;r++){var l=t[r];l.keyname===o._settings.DOWNLOAD_FLAT_PREFERENCE.keyname?i=l.value:l.keyname===o._settings.DOWNLOAD_WITH_CSV_PREFERENCE.keyname&&(n=l.value)}var s,a;s=i,a=n,new g({fields:[{type:"checkbox",value:v.settingFlat,className:"primary",label:v.settingFlat,checked:"true"===s,events:{onChange:function(e){F.setUserPreferences({name:"BulkDownload_downloadFlat",value:this.isChecked().toString(),onComplete:function(e){},onFailure:function(e){}}),o._settings.downloadFlat=this.isChecked(),o._settingChanged=!0}}},{type:"checkbox",value:v.settingWithCSV,className:"primary",label:v.settingWithCSV,checked:"true"===a,events:{onChange:function(e){F.setUserPreferences({name:"BulkDownload_downloadWithCSV",value:this.isChecked().toString(),onComplete:function(e){},onFailure:function(e){}}),o._settings.downloadWithCSV=this.isChecked()}}}]}).inject(e.Element.getElement.call(o.dialog.getBody(),".form-settings")),o._settings.downloadFlat="true"===s,o._settings.downloadWithCSV="true"===a,o._logger.log("<<< end displayDialogSettings")}),t.end()},review:function(e){var t=m.createProbe("BulkDownload_review"),o=this;if(o._logger.log(">>> start review"),o._id=e,o.utils.reset.call(o),o._logger.log("starts the download review"),"[object Array]"!==Object.prototype.toString.call(e))return o.utils.displayNotification(v.noId,"info"),r.resolve(null);o._logger.log(e.length+" objects selected to be downloaded"),o.displayDialog(),o._progress.startProgress();var i=new r(function(t,i){o.getInfo(e).then(function(e){if(o._progress.addCurrentValue(),!o._userCanceled)return o._getData(e,!0)}).then(function(e){if(o._logger.log(">>> start collect folders and files "),o._progress.addCurrentValue(),!o._userCanceled){o._displayUpdate("");var t={},i=o._files;t[""]=[];var n=function(e){for(var o="",r="",l="",s=0;s<e.length;s++)if(Array.isArray(e[s]))n(e[s]);else if(!0===e[s].resolved){r=e[s].path+e[s].name,l=e[s].originalpath+e[s].originalname;var a=Object.keys(t);o=r;for(var d=0;d<a.length;d++)r.toUpperCase()===a[d].toUpperCase()&&(o=a[d]);void 0===t[o]&&(t[o]=[])}else void 0===i[e[s]]&&(i[e[s]]={}),t[o].push({fileid:e[s],folderpath:r,originalFolderpath:l})};n(e),o._folders=t,o._files=i,o._stats.folders=Object.keys(t).length-1,o._stats.files=Object.keys(i).length,o._logger.log("<<< end collect folders and files ");var l=!1;return o._logger.log(">>> start getURLs API "),new r(function(e,t){var i=m.createProbe("BulkDownload_ForGetURLs");if(o._stats.files>0){for(var n=[],r=Object.keys(o._folders),s=0;s<r.length;s++)for(var a=0;a<o._folders[r[s]].length;a++)n.push(o._folders[r[s]][a].fileid);F.getURLs({id:n,onFailure:function(e,n){i.end(),l?o._logger.log("<<< end getURLs API / got urls but got error"):(n&&n.error.indexOf("timeout error")>-1?o.utils.errorHandling.call(o,e,v.message_timeout_error):o.utils.errorHandling.call(o,e),o._logger.log("<<< end getURLs API / got error"),t(e))},onComplete:function(t){l=!0,o._logger.log("<<< end getURLs API / got urls "),e(t)}})}else o._logger.log("<<< end getURLs API / no file case "),i.end(),e([])})}}).then(function(e){var i=m.createProbe("BulkDownload_ForDisplayReview");if(o._logger.log(">>> start  check download files"),o._progress.addCurrentValue(),o._userCanceled)return o;var n=e;o._displayUpdate();for(var r=0;r<n.length;r++)if(o._files[n[r].id].fileName=n[r].fileName,o._files[n[r].id].newFileName={},void 0===o._files[n[r].id].downloadUrl&&(o._files[n[r].id].downloadUrl=[]),o._files[n[r].id].downloadUrl.push(n[r].downloadUrl),o._files[n[r].id].isDownloadedCurrentStatus={},void 0!==n[r].errorMessage){o._files[n[r].id].isDownloaded=!1,o._files[n[r].id].hasError=!0;var l=o._errors.getErrorIdFromErrorMessage(n[r].errorMessage);l===o._errors.ERRORID_EMBEDED_COMPONENT&&(o._files[n[r].id].isEmbeddedComponent=!0),o._errors.pushError(n[r].id,l,n[r].errorMessage)}else o._files[n[r].id].isUptodate=!0,o._files[n[r].id].isDownloaded=!0,void 0===o._files[n[r].id].fileName&&(o._files[n[r].id].fileName="DocumentsZIPFile.ZIP");o._logger.log("<<< end  check download files"),o._loadingReady=!0,o._getFileStatusAsAsyncronous(),o.checkAndDisplay(),i.end(),t(o)})});return i.catch=function(e){o.utils.errorHandling.call(o,e)},o._logger.log("<<< end review"),t.end(),i},getInfo:function(e){var t=this,o=m.createProbe("BulkDownload_getInfo");t._logger.log("Getting information about the "+e.length+" objects selected");for(var i=[],n=0;n<e.length;n++)i.push(new r(function(i,r){F.getDocument({id:e[n],onComplete:function(e){o.end(),i(e)},onFailure:function(e){o.end(),t.utils.errorHandling.call(t,e),r(e)}})})),i[n].catch=function(e){t.utils.errorHandling.call(t,e)};return r.all(i)},_getData:function(e,t){var o=this,i=m.createProbe("BulkDownload__getData");if(o._logger.log(">>> start _getData"),!o._userCanceled){o._displayUpdate(e);for(var n=[],l=[],s=[],a=null,d=0;d<e.length;d++){var c=e[d],u=c.id=c.id||o.utils.getID(c),p=c.type=c.type||o.utils.getType(c),g=c.name||o.utils.getName(c);c.name=g.replace("/","");switch(c.originalname=g,!0){case o.options.container.indexOf(p)>=0&&!0!==c.resolved:n.push(c);break;case o.options.expandable.indexOf(p)>=0:l.push(u);break;case o.options.leaf.indexOf(p)>=0:s.push(u);break;case o.options.container.indexOf(p)>=0&&!0===c.resolved:a=c}}var f=[];for(d=0;d<n.length;d++)f.push(new r(function(e,t){var i=n[d],r=m.createProbe("BulkDownload__ForGetFolder");o._logger.log(">>> start getFolder API"),F.getFolder({id:i.id,onComplete:function(t){var n=JSON.parse(t).content,l={id:i.id,type:i.type,name:i.name,path:null!==a?a.path+a.name+"/":"",originalname:i.originalname,originalpath:null!==a?a.originalpath+a.originalname+"/":"",resolved:!0};n.unshift(l),o._folderRelation.pushFoldername(null!==a?a.path+a.name:"",i.name),o._logger.log("<<< end getFolder API / got children of oid=["+i.id+"]"),r.end(),e(o._getData(n,!0))},onFailure:function(e){o._logger.log("<<< end getFolder API / fails to get children of oid=["+i.id+"]"),r.end(),o.utils.errorHandling.call(o,e),t(e)}})})),f[d].catch=function(e){o.utils.errorHandling.call(o,e)};if(!0===t&&l.length>0){var _=new r(function(e,t){o._logger.log(">>> start getChildren API");var i=m.createProbe("BulkDownload__ForGetChildren");F.getChildren({id:l,onComplete:function(t){for(var n=JSON.parse(t),r=[],s=o._files,d=null!==a?a.path+a.name:"",c={},u=0;u<n.paths.length;u++)for(var p,g,f=0;f<n.paths[u].length;f+=2){var _=s[n.paths[u][f]];void 0===_&&(_={}),0===f&&(p=n.paths[u][f],g=n.paths[u][f],void 0===_.isTop&&(_.isTop={}),_.isTop[d]=!0);var h=!1;if(0===f)c[f]===n.paths[u][f]||((c={})[f]=n.paths[u][f],h=!0);else if(f>0&&(void 0===c[f]||n.paths[u][f-1]!==c[f])){c[f]=n.paths[u][f-1];for(var v=Object.keys(c),m=0;m<v.length;m++){var F=v[m];F>f&&(c[F]=void 0)}h=!0}h&&(void 0===_.topFileid&&(_.topFileid={}),void 0===_.parentFileid&&(_.parentFileid={}),void 0===_.topFileid[d]&&(_.topFileid[d]=[]),void 0===_.parentFileid[d]&&(_.parentFileid[d]=[]),_.topFileid[d].push(p),_.parentFileid[d].push(g),void 0===_.folderpaths&&(_.folderpaths=[]),C.isExistsInArrayUpperCase(d,_.folderpaths)||_.folderpaths.push(d),s[n.paths[u][f]]=_,r.push(n.paths[u][f])),g=n.paths[u][f]}o._files=s,o._syncFiles.concatFiles(r),null!==a&&r.unshift(a),o._logger.log("<<< end getChildren API / got children of top product oid=["+l.join(",")+"]"),i.end(),e(r)},onFailure:function(e){o._logger.log("<<< end getChildren API / fails to get children of top product oid=["+l.join(",")+"]"),i.end(),o.utils.errorHandling.call(o,e),t(e)}})});f.push(_),_.catch=function(e){o.utils.errorHandling.call(o,e)}}return!0!==t&&l.length>0&&(o._syncFiles.concatFiles(l),s=s.concat(l)),s.length>0&&f.push(new r(function(e,t){null!==a&&s.unshift(a),e(s)})),o._logger.log("<<< end _getData"),i.end(),r.all(f)}},_getFileStatusAsAsyncronous:function(){var t=this,o=m.createProbe("BulkDownload_ForGetFileStatus");t._logger.log(">>> start getFileStatus API"),t._userCanceled||new r(function(e,i){t._syncFiles.getLength()>0?F.getFileStatus({id:t._syncFiles.getList(),onComplete:function(i){o.end(),t._logger.log("<<< end getFileStatus API / got status"),e({syncFiles:JSON.parse(i).results})},onFailure:function(e){o.end(),t._logger.log("<<< end getFileStatus API / got error"),e&&e.message.indexOf("timedout")>-1?t.utils.errorHandling.call(t,e,v.message_timeout_error):t.utils.errorHandling.call(t,e),i(e)}}):(t._logger.log("<<< end getFileStatus API / no file to be checked"),o.end(),e({syncFiles:[]}))}).then(function(o){if(!t._downloadStarted&&!t._userCanceled){for(var i=o.syncFiles,n=0;n<i.length;n++){var r=t._files[i[n].id];void 0!==r&&"false"===i[n].isUptodate&&(t._errors.pushError(i[n].id,t._errors.ERRORID_NOTSYNC,i[n].message),void 0!==r.isEmbeddedComponent&&r.isEmbeddedComponent||(r.isUptodate=!1,r.isDownloaded=!0))}t._getFileStatusAPIisReady=!0;var l=e.Element.getElement.call(t.scroller.elements.content,".errorfiles-review"),s=t.scroller.elements.content.getElementsByClassName("now-loading-file-status-message");l.removeChild(s[0]),0===i.length?l.className="errorfiles-review-nothing":t._errors.getSyncErrorLength()>0?(t._displayErrorFilesInReview(t._errors,t._files),l.className="errorfiles-review-warning"):l.className="errorfiles-review-nothing";var a=e.Element.getElement.call(t.dialog.getFooter(),".display-conflict-info"),d=e.Element.getElement.call(a,".display-stats"),c=d.textContent.replace("...","");c+=t._stats.warning,d.textContent=c,d.title=c,t._progress.addCurrentValue()}})},_displayReview:function(t,o,i,n,r){var l=m.createProbe("BulkDownload__displayReview");this._logger.log(">>> start _displayReview");this._cannotDownload=!1;var s=e.Element.getElement.call(this.dialog.getBody(),".flip-container"),a=Object.keys(i);if(a.sort(),!this._getFileStatusAPIisReady&&!this._warningDisplayisReady){var d=e.createElement("div",{class:"now-loading-file-status-message",html:'<span title="'+v.message_now_loading_file_status+'">'+v.message_now_loading_file_status+'</span><span class="now-loading-icon"></span><div title="'+v.message_now_loading_file_status_warning_message+'" style="margin-top:10px;">'+v.message_now_loading_file_status_warning_message+"</div>"}).inject(this.errorFilesDiv),u=e.Element.getElement.call(d,".now-loading-icon");c.mask(u,""),u.getElementsByClassName("spinner spinning")[0].setStyle("width","50px"),this._warningDisplayisReady=!0}e.Element.getElement.call(this.dialog.getBody(),".review-files").setStyle("height","100%"),e.Element.getElement.call(this.dialog.getBody(),".flip-container").setStyle("height","100%");for(var p=Object.keys(o),g=!0,_=0;_<p.length;_++){if(o[p[_]].isDownloaded){g=!1;break}}if(g)return this._displayNothingToDownload("only-message-div"),this._cannotDownload=!0,this.downloadButton.disable(),this;if(!this._checkFilePathLength(t,o)&&0===a.length)return(T=e.createElement("p",{class:"only-message-div",html:"<span>"+v.message_okToDownload+"</span>"})).inject(this.scroller.elements.content),s.className.indexOf("flipped")<0&&this.downloadButton.enable(),this;var h=0;if(a.length>0)for(var F=v.message_conflict_files_are,E=(d=e.createElement("div",{class:"conflictfiles-review",html:'<div title="'+F+'">'+F+"</div>"}).inject(this.scroller.elements.content),0);E<a.length;E++){if(this._userCanceled)return this;var y=v.currentFolder,b='<span class="fonticon fonticon-folder"></span>';if(this._settings.downloadFlat){y=v.conflictmessage_flatdownload;var w=v.noFolderStructure;b+='<div class="conflict-filename-folder" title="'+y+w+'">'+y+'<span class="conflict-filename-folder-comment">'+w+"</span></div>"}else{var D=""===a[E]?y:a[E];b+='<div class="conflict-filename-folder" title="'+D+'">'+D+"</div>"}(T=e.createElement("span",{class:"folder-review",html:b})).inject(d);for(var S=i[a[E]],A=Object.keys(S),L=0;L<A.length;L++){var T,x=A[L]+" ("+S[A[L]].length+" files)";(T=e.createElement("div",{class:"file-review",html:'<span class="fonticon fonticon-cancel file-review-fonticon-cancel"></span><div class="conflict-filename-review" title="'+x+'">'+x+'</div><div class="file-review-editor"></div>'})).inject(d),h++;for(var U=this._isConflictBetweenFolderAndFile(A[L],a[E],r),I=1;I-U<S[A[L]].length;I++){var N=S[A[L]][I-U],P=a[E],k=o[N].fileName,R=this._renameFileWithCheckConflict(P,k,I,N,t,r,o),O=C.splitExtension(R),B=new f({value:O.filename,sizeInCharNumber:20});if(B.inject(e.Element.getElement.call(T,".file-review-editor")),B.elements.container.className+=" file-review-editor-lineeditor",B._myInput.setStyle("width","calc(100% - 25px)"),1===I){var M="fonticon fonticon-down-open expander-arrow",j=M;S[A[L]].length<=2-U&&(j=M+" disabled");var V=e.createElement("span",{class:j});V.inject(B.getContent()),S[A[L]].length>2-U&&V.addEventListener("click",function(){var e=this.parentElement.parentElement.parentElement;e.className.indexOf("expanded")>=0?(this.className=M,e.removeClassName("expanded")):(this.className="fonticon fonticon-up-open expander-arrow",e.addClassName("expanded"))})}B.options.targetFileid=N,B.options.callListenerFunction=!0,B.options.parentFolder=P,B.options.extension=O.extension,this._addEventListenerToLineEditor(B,t,r,o)}}}this._stats.conflictCount=h,s.className.indexOf("flipped")<0&&this.downloadButton.enable(),this._logger.log("<<< end _displayReview"),l.end()},_displayNothingToDownload:function(t){e.createElement("p",{class:t,html:"<span>"+v.message_nothingToDownload+"</span>"}).inject(this.scroller.elements.content)},_displayErrorFilesInReview:function(t,o){this._logger.log(">>> start _displayErrorFilesInReview");var i=e.Element.getElement.call(this.scroller.elements.content,".errorfiles-review");e.createElement("span",{html:'<span title="'+v.message_files_are_warning_objects+'">'+v.message_files_are_warning_objects+"</span>"}).inject(i);for(var n=t.getFileIdList(),r=0,l=0;l<n.length;l++){var s=t.getError(n[l]);if(s.errorid===this._errors.ERRORID_NOTSYNC){var a=o[s.fileid].fileName+" ( "+s.displayError+" )",d=v.folderpaths;if(void 0!==o[s.fileid].folderpaths){var c=o[s.fileid].folderpaths.concat();c.sort();for(var u=0;u<c.length;u++){var p=c[u];""===p&&(p=v.currentFolder),d+="\n - "+p}}else d+="\n - "+v.currentFolder;e.createElement("div",{class:"file-review",html:'<div title="'+d+'" class="attention-icon fonticon fonticon-attention"></div><span class="error-filename-review" title="'+a+'">'+a+'</span><div class="file-review-editor"></div>'}).inject(i),r++}}this._stats.warning=r,this._logger.log("<<< end _displayErrorFilesInReview")},_isConflictBetweenFolderAndFile:function(e,t,o){for(var i=o.getFoldernames(t),n=0;n<i.length;n++)if(i[n].toUpperCase()===e.toUpperCase())return 1;return 0},_checkConflictInThesameFolder:function(e,t,o,i,n){for(var r=o[e],l=i.getFoldernames(e),s=0;s<r.length;s++){var a=n[r[s].fileid];if(a.isDownloaded){var d=a.fileName;if(void 0!==a.newFileName[e]&&(d=a.newFileName[e]),d.toUpperCase()===t.toUpperCase())return!0}}for(s=0;s<l.length;s++)if(l[s].toUpperCase()===t.toUpperCase())return!0;return!1},_renameFileWithCheckConflict:function(e,t,o,i,n,r,l){var s=C.editFileName(t,o);this._checkConflictInThesameFolder(e,s,n,r,l)?s=this._renameFileWithCheckConflict(e,t,o+1,i,n,r,l):l[i].newFileName[e]=s;return s},_addEventListenerToLineEditor:function(e,t,o,i){var n=this;e.addEventListener("change",function(e){var r=m.createProbe("BulkDownload_lineEditorChange"),l=e.dsModel;if(l.options.callListenerFunction){var s=l.value,a=l.options.targetFileid,d=i[a],c=l.options.extension,u=l.options.parentFolder,g=s;""!==c&&(g+="."+c);var f=C.checkFolderEditorInvalidCharsWithSlash.call(n,s),_=f.hasInvalidChar,h="";if(_&&(h=v.replace(v.message_error_name_badchars,{name:s,badChars:f.badChars})),!_)_=(""===u?s:u+"/"+s).length>256,h=v.replace(v.message_toolong_in_manual_rename,{name:s,chars:256});if(_||(_=""===s.trim(),h=v.message_onlySpaceCharacter_in_manual_rename),_||(_=n._checkConflictInThesameFolder(u,g,t,o,i),h=v.replace(v.message_conflict_in_manual_rename,{name:s})),_){l.options.callListenerFunction=!1;var F=d.fileName;if(void 0!==d.newFileName[u]&&(F=d.newFileName[u]),l.value=C.splitExtension(F).filename,l.options.tooltip)l.options.tooltip.elements.body.textContent=h;else{var E=new p({target:l.getContent(),body:h,position:"right",events:{onPreInject:function(e){this.options.target.getBoundingClientRect().right>parseInt(widget.body.getStyle("width").replace("px",""))-200?(this.options.position="bottom",this.getContent().className="tooltip tooltip-root bottom fade"):(this.options.position="right",this.getContent().className="tooltip tooltip-root right fade")}}});l.options.tooltip=E;var y=n._tooltips.pushTooltip(E);l.options.tooltipid=y}l.options.tooltip.show()}else d.newFileName[u]=g,l.options.tooltip&&(l.options.tooltip.elements.body.remove(),n._tooltips.deleteTooltip(l.options.tooltipid),l.options.tooltip=void 0,l.options.tooltipid=void 0);void 0!==l.options.callback&&l.options.callback(l),r.end()}else l.options.callListenerFunction=!0})},_displayStats:function(t,o,i,n){var r=m.createProbe("BulkDownload__displayStats");this._logger.log(">>> start _displayStats");for(var l=0,s=Object.keys(t),a={},d=0;d<s.length;d++)for(var c=t[s[d]],u={},p=0;p<c.length;p++){var g,f=o[c[p].fileid],_=s[d];if(this._settings.downloadFlat&&(_=this._folderpathForFlatDownload[p]),void 0!==f.topFileid){var h=f.topFileid[_];if(void 0!==h&&0!==h.length)if(void 0===a[c[p].fileid]&&(a[c[p].fileid]={}),void 0===a[c[p].fileid][_]&&(a[c[p].fileid][_]=h.concat()),a[c[p].fileid][_].length>0){var F=a[c[p].fileid][_].shift(),C=this._files[F],E=C.fileName;void 0!==C.newFileName[s[d]]&&(E=C.newFileName[s[d]]),g=E}else g="";else g=""}else g="";var y=f.isDownloadedCurrentStatus;!0===f.isDownloaded&&void 0!==y&&!1!==y[s[d]]&&void 0===u[g+"_"+c[p].fileid]&&(l++,u[g+"_"+c[p].fileid]=1)}this._stats.files=l;var b='<span class="display-issues" style="color:#57B847; float: left;">'+v.noConflict+"</span>";this._cannotDownload?b='<span class="display-issues"></span>':this._stats.conflictCount>0&&(b='<span class="display-issues" style="color:#ff0000; float: left; text-decoration: underline;">'+this._stats.conflictCount+" "+v.conflict+"</span>");var w=v.files+" "+this._stats.files+", "+v.folders+" "+this._stats.folders+", "+v.warningfiles;this._getFileStatusAPIisReady?w+=" "+this._stats.warning:w+=" ...";var D=b+"<br>",S='<span class="display-stats" style="float: left; text-align: left; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;" title="'+w+'">'+w+"</span>";e.createElement("div",{styles:{float:"left",height:""},html:D+S,class:"display-conflict-info"}).inject(this.statsArea);this._logger.log("<<< end _displayStats"),r.end()},_displayUpdate:function(t){try{e.Element.getElement.call(this.dialog.getFooter(),".display-update").remove()}catch(e){}if(void 0===t)return this;if("string"==typeof t)return e.createElement("div",{styles:{float:"left",height:""},html:v.displayFooterMessage_retrievingFileInfo,class:"display-update"}).inject(this.statsArea),this;var o=v.currentFolder,i=!0===t[0].resolved?t[0].name:o;e.createElement("div",{html:v.displayFooterMessage_browsingFolder+i,class:"display-update"}).inject(this.statsArea)},_checkConflict:function(e,t,o){var i={},n=m.createProbe("BulkDownload__checkConflict");function r(e,t,o,i,n){for(var r=Object.create(null),l={},s=0;s<o.length;++s)for(var a=Object.keys(r),d=0;d<a.length;d++)o[s].toUpperCase()!==r[a[d]].toUpperCase()&&(r[o[s]]=null);for(s=0;s<e.length;++s){var c=e[s],u=Object.keys(r),p=c;for(d=0;d<u.length;d++)if(u[d].toUpperCase()===c.toUpperCase()){void 0===l[p=u[d]]&&(l[p]=[],null!==r[p]&&l[p].push(r[p])),l[p].push(t[s]);break}r[p]=t[s]}return l}this._logger.log(">>> start _checkConflict");for(var l=Object.keys(e),s=0;s<l.length;s++){for(var a=e[l[s]].concat(),d=[],c=[],u=0;u<a.length;u++){var p=t[a[u].fileid];if(p.isDownloaded&&!C.isExistsInArray(a[u].fileid,c)){p.isDownloadedCurrentStatus={};var g=t[a[u].fileid].fileName;void 0!==t[a[u].fileid].newFileName[l[s]]&&(g=t[a[u].fileid].newFileName[l[s]]),d.push(g),c.push(a[u].fileid)}else a.splice(u,1),u--}var f=r(d,c,o.getFoldernames(l[s]),0,l[s]);Object.keys(f).length>0&&(i[l[s]]=f)}return this._logger.log("<<< end _checkConflict"),n.end(),i},_checkFilePathLength:function(t,o){var i=[],n=m.createProbe("BulkDownload__checkFilePathLength");this._logger.log(">>> start _checkFilePathLength");for(var r=Object.keys(t),l=0;l<r.length;l++){for(var s=t[r[l]],a=[],d=0;d<s.length;d++){var c=o[s[d].fileid];if(c.isDownloaded&&void 0!==c.isDownloadedCurrentStatus&&!1!==c.isDownloadedCurrentStatus[r[l]]){var u=c.fileName;void 0!==c.newFileName[r[l]]&&(u=c.newFileName[r[l]]),(r[l]+"/"+u).length>256&&a.push(u)}}a.length>0&&i.push({folderpath:r[l],filenames:a})}var p=i.length>0;if(p){var g=v.replace(v.message_there_is_toolong_filepath,{chars:256}),f=e.createElement("div",{class:"only-message-div",html:'<div class="toolong-filepath-willnotbeDownloaded" title="'+v.message_there_is_toolong_filepath_willnot_be_downloaded+'">'+v.message_there_is_toolong_filepath_willnot_be_downloaded+'</div></div><div class="toolong-filepath-mainmessage" title="'+g+'">'+g+"</div>"});f.inject(this.scroller.elements.content,"top");for(var _=0;_<i.length;_++){e.createElement("div",{class:"toolong-filepaths",html:'<span class="fonticon fonticon-folder"></span><div class="toolong-filepath-path" title="'+i[_].folderpath+'">'+i[_].folderpath+"</div>"}).inject(f);for(var h=0;h<i[_].filenames.length;h++){e.createElement("div",{class:"toolong-filepath-filename",title:i[_].filenames[h],html:i[_].filenames[h]}).inject(f)}}}return this._logger.log("<<< end _checkFilePathLength"),n.end(),p},startDownload:function(){var e=0,t=0,o=0,i=0,n=this._getFileStatusAPIisReady;this._downloadStarted=!0;var r=m.createProbe("BulkDownload_startDownload");this._logger.log(">>> start startDownload");for(var l=this._foldersForDownload,s=Object.keys(l),a=[],d=0;d<s.length;d++)for(var c=l[s[d]],u={},p=0;p<c.length;p++){var g=this._files[c[p].fileid],f=s[d];this._settings.downloadFlat&&(f=this._folderpathForFlatDownload[p]);var _=this._getTopFilename(c[p].fileid,f,s[d]),h=this._getParentFilename(c[p].fileid,f,s[d]),F="";if(this._settings.downloadWithCSV){var C="";!1===n?C=v.do_not_get_filestatus:!1===g.isUptodate&&(C=v.displayMessage_notSync);var E="";void 0!==g.attributes.description&&(E=g.attributes.description),F+=' "'+g.attributes.label+'" "'+g.attributes.type+'" "'+g.attributes.revision+'" "'+g.attributes.responsible+'" "'+g.attributes.created+'" "'+g.attributes.modified+'" "'+C+'" "'+encodeURI(E)+'"'}var y="",b="",w=this.URLATTR_NOURL;!0===g.isDownloaded?(y=g.fileName,b=g.fileName,void 0!==g.newFileName[s[d]]&&(b=g.newFileName[s[d]]),void 0!==g.isDownloadedCurrentStatus&&!1!==g.isDownloadedCurrentStatus[s[d]]&&void 0!==g.downloadUrl&&0!==g.downloadUrl.length&&1!==u[_+"_"+c[p].fileid]&&(w=g.downloadUrl.shift(),u[_+"_"+c[p].fileid]=1)):g.isEmbeddedComponent&&(y=this.FILENAMEATTR_EO+c[p].fileid,b=this.FILENAMEATTR_EO+c[p].fileid);var D=c[p].originalFolderpath;""===D||void 0===D?D="":""!==this.options.folderpath&&void 0!==this.options.folderpath&&(D="/"+D),w!==this.URLATTR_NOURL&&(w=this.URLATTR_URL),a.push({downloadUrl:w,path:s[d],fullpath:this.options.folderpath+D,fileName:b,orgFileName:y,topFilename:_,parentFilename:h,fileid:c[p].fileid,attributes:F}),w!==this.URLATTR_NOURL&&(""===_&&""===h?(e++,y!==b&&t++):(o++,y!==b&&i++))}this._logger.log("<<< end startDownload"),this._sendDownloadRequest(a,{documentFileCount:e,documentRenamedFileCount:t,catiaFileCount:o,catiaRenamedFileCount:i}),r.end()},_getTopFilename:function(e,t,o){var i,n=this._files[e];if(void 0!==n.topFileid){var r=n.topFileid[t];if(void 0!==r&&0!==r.length){var l=r.shift(),s=this._files[l],a=s.fileName;void 0!==s.newFileName[o]&&(a=s.newFileName[o]),i=a}else i=""}else i="";return i},_getParentFilename:function(e,t,o){var i,n=this._files[e];if(void 0!==n.parentFileid){var r=n.parentFileid[t];if(void 0!==r&&0!==r.length){var l=r.shift(),s=this._files[l];if(!0===s.isEmbeddedComponent)a=this.FILENAMEATTR_EO+l;else{var a=s.fileName;void 0!==s.newFileName[o]&&(a=s.newFileName[o])}i=a}else i="";void 0===i&&(i="")}else i="";return i},_sendDownloadRequest:function(e,t){var o,i=this,n=t.documentFileCount,r=t.documentRenamedFileCount,s=t.catiaFileCount,a=t.catiaRenamedFileCount;o='{"lang":"'+widget.lang+'", "objects":"'+i._stats.files+'", "documentFileCount":"'+n+'", "documentRenamedFileCount":"'+r+'", "catiaFileCount":"'+s+'", "catiaRenamedFileCount":"'+a+'"}\n';var d=m.createProbe("BulkDownload__sendDownloadRequest");i._logger.log(">>> start _sendDownloadRequest");for(var c=0;c<e.length;c++){var u=e[c].path;""!==u&&(u+="/"),o+=e[c].downloadUrl+' "'+e[c].fileid+'" "'+u+'" "'+e[c].orgFileName+'" "'+e[c].fileName+'" "'+e[c].topFilename+'" "'+e[c].parentFilename+'" "'+e[c].fullpath+'"'+e[c].attributes+"\n"}var p={widgetId:widget.id,appId:"ENOFOLB_AP",fileName:"-d",fileContent:o};if(i._userCanceled)return i;l.subscribe("launchAppCallback",function(e){e&&e.widgetId===widget.id&&("COMPLETE"===e.response?i.utils.displayNotification(v.launched,"success"):i.utils.displayNotification(v.failed,"error"),l.unsubscribe("launchAppCallback"),i._logger.log("<<< end _sendDownloadRequest"))}),l.publish("launchApp",p),i.utils.displayNotification(v.starting,"info"),d.end()},utils:{getID:function(e){return e.data[0].id},getType:function(e){return e.data[0].type},getName:function(e){var t="";try{t=""===(t=e.data[0].dataelements.title)?e.data[0].dataelements.name:t}catch(e){}return t},displayNotification:function(e,t){s.displayNotification({message:e,className:t})},reset:function(){this._folders={},this._folderRelation.clearMap(),this._files={},this._issues=[],this._errors.init(this._logger),this._syncFiles.clearList(),this._stats={folders:0,files:0,error:0,size:0,warning:0,conflictCount:0},this._tooltips.clearList(),this._foldersForDownload=null,this._folderpathForFlatDownload=null},errorHandling:function(t,o){if(this._logger.log(t),!this._downloadFailed){this.removeReviews(!0);var i=v.failed;void 0!==o&&(i=o),c.unmask(e.Element.getElement.call(this.dialog.getContent(),".review-files")),this.downloadButton.disable(),e.createElement("p",{class:"download_failed_message",html:"<span>"+i+"</span>"}).inject(this.scroller.elements.content),this._progress.setErrorProgress(),this._downloadFailed=!0}}}});return y});