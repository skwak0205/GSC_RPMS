define("DS/MaturityCompactView/MaturityCompactView",["UWA/Controls/Abstract","DS/UIKIT/Tooltip","UWA/Class/Promise","DS/WAFData/WAFData","DS/UIKIT/Iconbar","DS/UIKIT/Spinner","DS/UIKIT/Mask"],function(t,e,i,s,o,r,n){"use strict";return t.extend({context:null,init:function(t,e,i,s,o){this.widget=t,this.widget.MaturityCompactView=this,this.parentWidget=e;var n=this;void 0!==i.serviceurl&&i.serviceurl?this.serviceurl=i.serviceurl:this.serviceurl=null,void 0!==i.SecurityContext&&i.SecurityContext?this.securityContext=i.SecurityContext:this.securityContext=null,this.pid=s,this.onDone=o,this._parent(i),this.addEvent("onError",function(t){this.displayError(t)},this),this.container=UWA.createElement("div",{class:"container"}),this.elements={},this.elements.container=this.container,this.wrapper=UWA.createElement("div",{class:"wrapper"}),this.wrapper.inject(this.container),this.spinner=(new r).inject(this.wrapper).show(),this.tenant=t.getValue("x3dPlatformId")?t.getValue("x3dPlatformId"):"OnPremise";require(["DS/LifecycleServices/LifecycleServicesSettings","DS/LifecycleServices/LifecycleServices","DS/LifecycleCmd/MaturityCmd","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","DS/LifecycleServices/LifecycleAlert","DS/LifecycleCmd/MessageMediator"],function(t,e,i,s,o,r){n.LifecycleServicesSettings=t,n.LifecycleServices=e,n.MaturityCmd=i,n.lifecycleWidgetNls=s,n.LifecycleAlert=o,n.MessageMediator=r,t.app_initialization(function(){n.addEvent("onStateChanged",function(t){var e={created:[],deleted:[],modified:[]};e.context=n,t.data.forEach(function(t){var i={physicalid:t.physicalid,operation:"Promote",state:t.tostate,policy:n.policy};e.modified.push(i)}),r.dispatchEvent("onModification",e)}),null==n.securityContext?e.getSecurityContextPromise(n.tenant).then(function(e){n.securityContext=e,n.header=t.getHeaders(encodeURIComponent(n.securityContext)),n.executeCmd()}):(n.header=t.getHeaders(encodeURIComponent(n.securityContext)),n.executeCmd())})},function(){console.log("Error in loading required modules")})},executeCmd:function(){var t={data:[{physicalid:this.pid}]};this._getMaturityState(t,null,null,this.securityContext,!1)},setStateUI:function(t){this.objects={};var i=this;if(0==t.data.policies.length){console.log("ERROR: No policies in json");var s={errorMsg:"Error: No policies in json",type:"error"};i.dispatchEvent("onError",s)}else{this.policies=t.data.policies;for(var a=!1,c=0;c<t.data.objects.length;c++){var h=t.data.objects[c].physicalid;this.phyid=t.data.objects[c].physicalid;var l=t.data.objects[c];if(this.policy=l.policy,this.objects[h]=l,this.objects[h].signatures={},this.objects[h].routes={},this.objects[h].applyTransition=!0,this.currentState=this.objects[h].currentStateUserName,this.current=this.objects[h].current,void 0!==this.objects[h].isSingleIRPCAssembly&&null!==this.objects[h].isSingleIRPCAssembly&&this.objects[h].hasOwnProperty("isSingleIRPCAssembly")&&(a=a||this.objects[h].isSingleIRPCAssembly),this.objects[h].hasOwnProperty("imageUrl")&&void 0!==this.objects[h].imageUrl&&null!==this.objects[h].imageUrl){var u=this.objects[h].imageUrl;u.startsWith("/")&&(this.objects[h].imageUrl=i.LifecycleServicesSettings.get3DSpaceBaseUrl(window.widget.getValue("x3dPlatformId"))+u)}this.objects[h].excludeFromPromote=null!=l.isAggregateRep&&l.isAggregateRep,this.objects[h].excludeFromPromote||null!=l.usage&&"3DPart"==l.usage&&null!=l.isOnceInstantiable&&l.isOnceInstantiable&&(this.objects[h].excludeFromPromote=!0);var p=0;for(p=0;p<this.policies.length&&this.policies[p].name!==l.policy;p++);var d=this.policies[p].maturityGraph.transitions,m=this.policies[p].maturityGraph.states;this.correctstates={},this.pos={},this.items=[],this.previousstates=[],this.targetstates=[],this.actions={},this.currentsysstatename="",this.activecolor={},this.inactivecolor={},this.tooltipstate={};for(var y=0;y<m.length;y++)!0===m[y].isCurrent&&(this.setAttribute(h,"current",m[y].stateSysName),this.currentsysstatename=m[y].stateSysName),this.activecolor[m[y].stateSysName]={},this.activecolor[m[y].stateSysName]=m[y].activeColor,this.inactivecolor[m[y].stateSysName]={},this.inactivecolor[m[y].stateSysName]=m[y].inactiveColor,this.tooltipstate[m[y].stateSysName]={},this.tooltipstate[m[y].stateSysName]=m[y].tooltip,this.correctstates[m[y].stateSysName]=m[y].stateUserName,this.pos[m[y].stateSysName]=m[y].visuorder,this.pos[m[y].visuorder]=m[y].stateSysName,this.objects[h].signatures[m[y].stateSysName]={},this.objects[h].routes[m[y].stateSysName]={},this.actions[m[y].stateSysName]={};for(var v=0;v<d.length;v++){var g=d[v].sourceState,f=d[v].targetState,x=d[v].signatures;this.objects[h].routes[g][f]=d[v].hasRoute;var b={};if(0===x.length||x[0].username.includes("emxFramework")&&void 0===x[0].name){var S=i.lifecycleWidgetNls.setTo+' "'+this.correctstates[f]+'"';this.actions[g][f]=S,this.actions[g][S]=f;var C=i.lifecycleWidgetNls.setTo+' "'+this.correctstates[g]+'"';this.actions[f][g]=C,this.actions[f][C]=g}else for(var w=0;w<x.length;w++)b[x[w].name]=x[w],x[w].username.includes("emxFramework")||void 0===x[w].username?(this.actions[g][f]=x[w].name,this.actions[g][x[w].name]=f):(this.actions[g][f]=x[w].username,this.actions[g][x[w].username]=f);this.objects[h].signatures[g][f]=b,g===this.current&&(this.pos[this.current]<this.pos[f]?this.targetstates.push(f):this.previousstates.push(f))}if(0===this.previousstates.length&0!=this.pos[this.current]){var E=this.pos[this.current]-1;this.previousstates.push(this.pos[E]),i.demote=!0}this.nextaction=void 0;for(w=0;w<this.targetstates.length;w++){void 0!==(A=this.actions[this.current][this.targetstates[w]])&&(this.setFontIconColor(this.targetstates[w]),this.fonticon="double-chevron-right"+this.fonticon,this.items.push({fonticon:this.fonticon,text:A,selectable:!0}),void 0===this.nextaction?(this.target=this.targetstates[w],this.nextaction=A):this.pos[this.actions[this.current][A]]<this.pos[this.actions[this.current][this.nextaction]]&&(this.target=this.targetstates[w],this.nextaction=A))}for(w=0;w<this.previousstates.length;w++){var A;void 0!==(A=this.actions[this.current][this.previousstates[w]])&&(this.setFontIconColor(this.previousstates[w]),this.fonticon="double-chevron-left"+this.fonticon,this.items.push({fonticon:this.fonticon,text:A,selectable:!0}))}this.items.push({fonticon:"collaborative-lifecycle-management",text:i.lifecycleWidgetNls.maturity,selectable:!0}),i.setColor(),this.activecolor[this.current].includes("emxFramework")?this.color="#757575":this.color=this.activecolor[this.current],this.content=UWA.createElement("div",{class:"lcm-change-maturity-content"}),this.content.inject(this.wrapper),this.s=UWA.createElement("div",{class:"lcm-state-base1 lcm-state-current1 lcm-state-m1",styles:{backgroundColor:this.color}}),this.text=UWA.createElement("span",{class:"lcm-state-text",html:this.currentState}),"#FFFFFF"==this.color&&(this.s.style.border="1px solid #B4B6BA",this.text.style.color="black"),this.text.inject(this.s),this.s.inject(this.content),this.tooltipstate[this.current].includes("emxFramework")?this.tooltiptext=this.currentState:this.tooltiptext=this.tooltipstate[this.current],this.tooltip=new e({position:"bottom right",target:this.s,body:this.tooltiptext}),void 0!==this.nextaction&&(this.next=UWA.createElement("div",{class:"button next-state-button"}),this.text2=UWA.createElement("span",{class:"lcm-state-text",html:this.nextaction}),this.text2.inject(this.next),this.next.inject(this.content),this.tooltip=new e({position:"bottom right",target:this.next,body:this.nextaction})),this.iconDropDown=new o({items:[{fonticon:"down-open",text:i.lifecycleWidgetNls.moreOptions,content:{type:"dropdownmenu",options:{items:this.items,events:{onClick:function(t,e){console.log(e),console.log(e.text);document.getElementsByClassName("lcm-state-text");if(e.text===i.lifecycleWidgetNls.maturity){n.mask(i.wrapper);i.securityContext,i.securityContext,i.tenant;var s=new i.MaturityCmd,o=[{physicalid:i.pid,serviceurl:i.serviceurl}];s.executeAsync(o).then(function(){var t=(new r).inject(i.wrapper).show();i.wrapper.getElement(" > .lcm-change-maturity-content").destroy(),i.executeCmd(),t.destroy(),console.log("Maturity  updated"),n.unmask(i.wrapper)})}else{var a=i.actions[i.current][e.text];if(!0===i.demote&&i.pos[a]<i.pos[i.current])var c="demote";else c="promote";n.mask(i.wrapper),console.log(a);var h=i.current;o={data:[{physicalid:i.pid,tostate:a,fromstate:h}]};i._changeMaturity(c,o,i.securityContext)}}}}}}]}),this.iconbarContainer=UWA.createElement("div",{class:"button next-state-button1"}),this.iconDropDown.inject(this.iconbarContainer),this.iconbarContainer.inject(this.content),null!=this.spinner.elements&&this.spinner.destroy(),this.next.addEventListener("click",function(){n.mask(i.wrapper);var t={data:[{physicalid:i.pid,tostate:i.target,fromstate:i.current}]};i._changeMaturity("promote",t,i.securityContext)});l.policy}this.isSingleIRPCAssembly=a,this.content.offsetWidth>document.body.clientWidth?this.next.hidden=!0:this.next.hidden=!1,window.addEventListener("resize",function(){i.content.offsetWidth>document.body.clientWidth?i.next.hidden=!0:i.next.hidden=!1})}},_changeMaturity:function(t,e,i){var o,r=this,n="null";if(void 0!==this.serviceurl&&this.serviceurl){var a=this.serviceurl+t;o=a+(a.indexOf("?")<0?"?":"&")+"tenant="+r.tenant}else o=r.LifecycleServicesSettings.get3DSpaceWSUrl(r.tenant,"/resources/lifecycle/maturity/"+t,null);var c=this.header;return c["X-Requested-With"]="XMLHttpRequest",console.log(t+":"),console.log(e),s.authenticatedRequest(o,{method:"POST",type:"json",headers:c,timeout:36e5,data:JSON.stringify(e),onComplete:function(e){console.log(t+": COMPLETED"),console.log(e),n=e;for(var i=e.results,s={data:[]},o=0;o<i.length;o++){var a=r.getAttribute(i[o].physicalid,"current");void 0===a&&(a=i[o].current);var c=i[o].current;r.current=i[o].current,r.updateUI(c),r.setAttribute(i[o].physicalid,"current",i[o].current);var h={physicalid:i[o].physicalid,tostate:c,fromstate:a};s.data.push(h),r._showNotification("success",r.lifecycleWidgetNls.maturitySuccess)}var l={};if("failure"===e.status){var u=e.report,p=u.length,d=[];console.log(u);for(o=0;o<p&&o<10;o++)r.objects[u[o].physicalids]&&r.objects[u[o].physicalids].displayName&&!u[o].error.contains(r.objects[u[o].physicalids].displayName)?d.push(r.objects[u[o].physicalids].displayName+": "+u[o].error):d.push(u[o].error);p>10&&d.push(r.lifecycleWidgetNls.replace(r.lifecycleWidgetNls.maturityAdditionalErrorMessage,{maxErrors:10..toString(),lineBreak:"\n",numErrors:(p-10).toString()})),d+="\n"+r.lifecycleWidgetNls.maturityFailure,l.errorMsg=d,l.type="error",r.dispatchEvent("onError",l),s.data.length>0&&r.dispatchEvent("onStateChanged",s)}else s.data.length>0&&r.dispatchEvent("onStateChanged",s);r.dispatchEvent("onComplete")},onFailure:function(e,i){console.log(t+":Failure..."+e);var s={};s.errorMsg=r.LifecycleServices.parseWebServiceError(e,i),s.type="error",r.dispatchEvent("onError",s),r.dispatchEvent("onComplete")},onTimeout:function(){console.log(t+": A connection timeout occured.");var e={errorMsg:"connection timeout",type:"warning"};r.dispatchEvent("onError",e),r.dispatchEvent("onComplete")}}),n},getAttribute:function(t,e){return void 0!==this.objects[t]?this.objects[t][e]:void 0},setColor:function(){this.color={},"Draft"===this.currentState||"Prepare"===this.currentState||"PRIVATE"===this.current||"Prepare"===this.current||"Create"===this.current?(this.color="#9B2C98",this.tooltiptext="Being prepared by the owner. It is not visible to anyone else"):"In Work"===this.currentState||"IN_WORK"===this.current||"In Work"===this.current||"Assign"===this.current?(this.color="#007DA3",this.tooltiptext="Actively worked on by the assignee"):"In Approval"===this.currentState||"FROZEN"===this.current||"In Approval"===this.current||"Active"===this.current?(this.color="#018308",this.tooltiptext="Being reviewed by the owner"):"Completed"===this.currentState||"RELEASED"===this.current||"Complete"===this.current||"Closed"===this.current?(this.color="#757575",this.tooltiptext="Work is considered finished"):"Approved"===this.current||"Review"===this.current?(this.color="#E03400",this.tooltiptext="Work is approved by the owner"):(this.color="#E03400",this.tooltiptext="Help unavailable")},setFontIconColor:function(t){this.fonticon={},this.fonticon="Draft"===t||"Prepare"===t||"PRIVATE"===t||"Prepare"===t||"Create"===t?" private":"In Work"===t||"IN_WORK"===t||"In Work"===t||"Active"===t?" inwork":"In Approval"===t||"FROZEN"===t||"In Approval"===t||"Review"===t?" frozen":"Completed"===t||"RELEASED"===t||"OBSOLETE"===t||"Complete"===t||"Closed"===t?" released":"Approved"===t||"Review"===t||"Assign"===t?" approved":""},displayError:function(t,e){var i=t;t.hasOwnProperty("errorMsg")&&(i=null!==t.errorMsg?t.errorMsg:t),void 0===e&&t.hasOwnProperty("type")?e=t.type:void 0===e&&(e="warning"),this._showNotification(e,i),n.unmask(this.wrapper)},updateUI:function(t){var i=this;this.targetstates=[],this.previousstates=[];i.getAttributes(i.phyid);var s=0;for(s=0;s<i.policies.length&&i.policies[s].name!==i.objects[i.phyid].policy;s++);var r=i.policies[s].maturityGraph.transitions;this.policies[s].maturityGraph.states;i.currentState=i.correctstates[t];for(var a=0;a<r.length;a++){var c=r[a].sourceState,h=r[a].targetState;c===t&&(this.pos[t]<this.pos[h]?this.targetstates.push(h):this.previousstates.push(h))}if(0===this.previousstates.length&0!=this.pos[t]){var l=this.pos[t]-1;this.previousstates.push(this.pos[l]),this.demote=!0}this.nextaction=void 0,this.items=[];for(var u=0;u<this.targetstates.length;u++){void 0!==(p=this.actions[this.current][this.targetstates[u]])&&(this.setFontIconColor(this.targetstates[u]),this.fonticon="double-chevron-right"+this.fonticon,this.items.push({fonticon:this.fonticon,text:p,selectable:!0}),void 0===this.nextaction?(this.target=this.targetstates[u],this.nextaction=p):this.pos[this.actions[this.current][p]]<this.pos[this.actions[this.current][this.nextaction]]&&(this.target=this.targetstates[u],this.nextaction=p))}for(u=0;u<this.previousstates.length;u++){var p;void 0!==(p=this.actions[this.current][this.previousstates[u]])&&(this.setFontIconColor(this.previousstates[u]),this.fonticon="double-chevron-left"+this.fonticon,this.items.push({fonticon:this.fonticon,text:p,selectable:!0}))}this.items.push({fonticon:"collaborative-lifecycle-management",text:i.lifecycleWidgetNls.maturity,selectable:!0}),i.setColor(),this.activecolor[t].includes("emxFramework")?this.color="#757575":this.color=this.activecolor[t];var d=document.getElementsByClassName("lcm-state-text");this.s.setStyle("backgroundColor",this.color),"#FFFFFF"==this.color?(this.s.style.border="1px solid #B4B6BA",this.text.style.color="black"):(this.s.style.border="",this.text.style.color="white"),d[0].innerHTML=i.currentState,void 0!==this.nextaction?(d[1].hidden=!1,d[1].innerHTML=i.nextaction):d[1].hidden=!0,this.iconDropDown.destroy(),this.iconbarContainer.destroy(),this.tooltip.destroy(),this.tooltipstate[t].includes("emxFramework")?this.tooltiptext=t:this.tooltiptext=this.tooltipstate[t],this.tooltip=new e({position:"bottom right",target:this.s,body:this.tooltiptext}),this.iconDropDown=new o({items:[{fonticon:"down-open",text:"more options",content:{type:"dropdownmenu",options:{items:this.items,events:{onClick:function(t,e){console.log(e),console.log(e.text);document.getElementsByClassName("lcm-state-text");if(e.text===i.lifecycleWidgetNls.maturity){n.mask(i.wrapper);i.securityContext,i.securityContext,i.tenant;var s=new i.MaturityCmd,o=[{physicalid:i.pid,serviceurl:i.serviceurl}];s.executeAsync(o).then(function(){i.wrapper.getElement(" > .lcm-change-maturity-content").destroy(),i.executeCmd(),console.log("Maturity  updated"),n.unmask(i.wrapper)})}else{var r=i.actions[i.current][e.text];if(!0===i.demote&&i.pos[r]<i.pos[i.current])var a="demote";else a="promote";n.mask(i.wrapper),console.log(r);var c=i.current;o={data:[{physicalid:i.pid,tostate:r,fromstate:c}]};i._changeMaturity(a,o,i.securityContext)}}}}}}]}),this.iconbarContainer=UWA.createElement("div",{class:"button next-state-button1"}),this.iconDropDown.inject(this.iconbarContainer),this.iconbarContainer.inject(this.content),n.unmask(this.wrapper)},getAttributes:function(t){return this.objects[t]},_showNotification:function(t,e){var i=this;Array.isArray(e)||"string"!=typeof e||(e=[e]),Array.isArray(e)&&e.length&&e.forEach(function(e){var s={eventID:t,msg:e.split?e.split("\n").join("<br>"):e};null!=i.context&&"function"==typeof i.context.displayNotification?i.context.displayNotification(s):i.LifecycleAlert.displayNotification(s)})},setAttributes:function(t,e){this.objects[t]=e},setAttribute:function(t,e,i){void 0!==this.objects[t]&&(this.objects[t][e]=i)},_getMaturityState:function(t,e,i,o,r){var n,a=this,c=this.header;if(c["X-Requested-With"]="XMLHttpRequest",void 0!==this.serviceurl&&this.serviceurl){var h=this.serviceurl+"getStateGraph";n=h+(h.indexOf("?")<0?"?":"&")+"tenant="+a.tenant}else n=a.LifecycleServicesSettings.get3DSpaceWSUrl(a.tenant,"/resources/lifecycle/maturity/getStateGraph",null);s.authenticatedRequest(n,{method:"POST",type:"json",headers:c,timeout:36e5,data:JSON.stringify(t),onComplete:function(t){console.log("MaturityInfos: COMPLETED"),console.log(t);var e=t.status,i=e.code;e.hasOwnProperty("errorMsg")&&(null!==e.errorMsg?errCb(e.errorMsg):0===i&&(console.log(t),a.setStateUI(t)))},onFailure:function(t,e){console.log("attributes:Failure..."+t)},onTimeout:function(){var t={errorMsg:"timeout",type:"warning"};console.log(t)}})}})});