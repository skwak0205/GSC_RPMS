define("DS/ReserveWidget/ReserveWidget",["UWA/Core","UWA/Controls/Abstract","DS/LifecycleControls/CommandDialog","DS/LifecycleServices/LifecycleServices","DS/WidgetServices/WidgetServices","DS/WidgetServices/securityContextServices/SecurityContextServices","DS/WAFData/WAFData","DS/Controls/Toggle","UWA/Utils/Cookie","css!DS/ReserveWidget/ReserveWidget","i18n!DS/ReserveWidget/assets/nls/ReserveWidgetNls","DS/LifecycleServices/LifecycleServicesSettings","DS/Controls/ProgressBar"],function(e,t,s,r,o,n,i,l,a,c,h,u,g){"use strict";return t.extend({TYPE_ROOT_FOLDER_1:"Workspace",TYPE_ROOT_FOLDER_2:"RootFolder",TYPE_FOLDER_1:"Workspace Vault",TYPE_FOLDER_2:"Folder",TYPE_FOLDER_3:"Workspace Folder",TYPE_PERSONAL_FOLDER_1:"Personal Workspace",instToggleCookieName:"ReserveWidget.Instance.Toggled",refToggleCookieName:"ReserveWidget.Reference.Toggled",CAD_ORIGIN_ATTR_NAME:"attribute[XCADExtension.V_CADOrigin]",defaultOptions:{serverName:"",serverUri:"",operation:"",currentUser:"",localContext:""},init:function(e){this._parent(e),this.SelectedItems=[],this.FailureInfo=[],this.SuccessIds=[],this.V5DataIndex=[],this.SuccessInfo=[],this.listOfModified=[];this.refreshDatas={created:[],deleted:[],modified:[]},this.labelWaitingOperation="",this.localContext=this.options.localContext;var t={context:this.localContext};n.getInstance(t).getSecurityContext()},isRootFolder:function(e){return e===this.TYPE_ROOT_FOLDER_1||e===this.TYPE_ROOT_FOLDER_2},isFolder:function(e){return e===this.TYPE_FOLDER_1||e===this.TYPE_FOLDER_2||e===this.TYPE_FOLDER_3},isPersonalFolder:function(e){return e===this.TYPE_PERSONAL_FOLDER_1},inFamilyFolder:function(e){return this.isRootFolder(e)||this.isFolder(e)||this.isPersonalFolder(e)},setObjects:function(e){if(console.log("reserveWidget::SetObjects"),console.log(e),0===e.length)throw h.noObject;var t=this;o.removeDuplicate(e,function(e){return console.log("removing duplicates"),e.physicalId}),e.forEach(function(e){e.hasOwnProperty("physicalId")&&""!=e.physicalId?(console.log("adding an element in SelectedItems"),t.SelectedItems.push(e)):console.log("the element has no physicalid")})},updateDlg:function(){var e=this.instToggle.checkFlag,t=this.refToggle.checkFlag;e||t?this.cmdDlg._okButton.setDisabled(!1):this.cmdDlg._okButton.setDisabled(!0)},getDefaultToggles:function(){return["false"!==a.get(this.instToggleCookieName),"false"!==a.get(this.refToggleCookieName)]},saveDefaultToggles:function(){a.set(this.instToggleCookieName,this.instToggle.checkFlag),a.set(this.refToggleCookieName,this.refToggle.checkFlag)},onToggle:function(){this.updateDlg(),this.saveDefaultToggles()},renderDlgContent:function(){var e=document.createElement("div"),t=this.getDefaultToggles();this.instToggle=new l({type:"checkbox",label:h.instance,checkFlag:t[0]}),this.refToggle=new l({type:"checkbox",label:h.reference,checkFlag:t[1]});var s=this;return this.instToggle.addEventListener("buttonclick",function(e){s.onToggle()}),this.refToggle.addEventListener("buttonclick",function(e){s.onToggle()}),this.instToggle.inject(e),this.refToggle.inject(e),e},requestCADOrigins:function(e,t,s){var n=o.getTenantID(),i=["physicalid",this.CAD_ORIGIN_ATTR_NAME,"baseType"];r.listAttributes(n,e,i,t,s)},requestInstanceNames:function(e,t,s){var n=o.getTenantID(),i=e.toString();r.post(n,"/resources/v1/collabServices/reservation/op/getInstanceNames",i,t,s)},checkIfAllRoots:function(){for(var e=0,t=this.SelectedItems.length,s=0;s<t;s++){""==this.SelectedItems[s].relID&&e++}var r=!1;return e==t&&(r=!0),r},checkIfAnyV6Instance:function(){for(var e=this.SelectedItems.length,t=0;t<e;t++)if(this.SelectedItems[t].isV6Rel)return!0;return!1},loadInstanceCADOrig:function(e,t){for(var s=this,r=[],o=this.SelectedItems.length,n=0;n<o;n++){var i=this.SelectedItems[n].parentID;""!=i&&r.push(i)}0==r.length?e():s.requestCADOrigins(r,function(t){for(var r=t.results,n=r.length,i=0;i<n;i++){var l=r[i],a=l.physicalid,c=l.baseType,h=!0;"PLMEntity"==c&&l[s.CAD_ORIGIN_ATTR_NAME]&&(h=!1);for(var u=0;u<o;u++){var g=s.SelectedItems[u];g.baseType=c,g.parentID==a&&"PLMEntity"==c?g.isV6Rel=h:"PLMEntity"!=c&&(g.isV6Rel=!1)}}e()},t)},checkInputs:function(e,t){var s=this;this.loadInstanceCADOrig(function(){s.checkIfAllRoots()?e(!1):!s.checkIfAnyV6Instance()||1==s.SelectedItems.length&&"Drawing"===s.SelectedItems[0].type?e(!1):e(!0)},t)},launchCmd:function(){var e=this;e.checkInputs(function(t){if(t){var r=e.renderDlgContent(),o="reserve"==e.options.operation?h.reserveTitle:h.unreserveTitle;e.cmdDlg=new s;var n=e.cmdDlg.create(r,{title:o,closeButton:!0,onOk:function(){e.execute(),e.cmdDlg.destroy()}});n.inject(widget.body),n.setNewSize({}),e.updateDlg()}else e.execute()},function(e){console.log(e)})},reportV5Instances:function(e){if(e.length>0){var t=this;t.requestInstanceNames(e,function(e){for(var s=h.v5InstancesExcluded+"<br>",r=0;r<e.length;r++)s+=e[r].name+"<br>";t.showError(s)},function(e){t.showError(e)})}},startProgress:function(t,s){if(this.chunkSize=s,this.labelWaitingOperation="reserve"==t?UWA.i18n(h.reserving):UWA.i18n(h.unreserving),this.localContext){(void 0===this.localContext.elements||null===this.localContext.elements||this.localContext.elements.hasOwnProperty("container"))&&void 0!==this.localContext.elements&&null!==this.localContext.elements&&this.localContext.elements.hasOwnProperty("container")||(this.localContext.elements.container=widget.body),this.localContext.elements.container.addClassName("masked");var r=e.createElement("div",{class:"mask"}),o=e.createElement("div",{class:"PBwrapper"}),n=e.createElement("div",{class:"PBcontent"});e.createElement("span",{class:"text",text:this.labelWaitingOperation}).inject(n),new UWA.Element("div",{class:"wux-control-inline-container",style:{"vertical-align":"top"}}).inject(n),n.inject(o),o.inject(r),r.inject(this.localContext.elements.container),this.options.renderTo=n,this.chunkSize>0?this.progressbar=new g({value:0}).inject(n):(this.progressbar=void 0,r.style.cursor="wait")}if(null!=this.modifiedElement){this.modifiedElement.forEach(function(e){e.hasClassName("wux-ui-state-disabled")&&e.removeClassName("wux-ui-state-disabled")})}this.modifiedElement=[];var i=[],l=document.querySelectorAll(".wux-afr-cmdstarter");"function"==typeof l.forEach&&l.forEach(function(e){e.hasClassName("wux-ui-state-disabled")||(e.addClassName("wux-ui-state-disabled"),i.push(e))}),this.modifiedElement=i},stopProgress:function(){if(this.localContext){var e=this.localContext.elements.container.getElement(" > .mask");e&&e.destroy(),this.localContext.elements.container.removeClassName("masked")}this.modifiedElement.forEach(function(e){e.hasClassName("wux-ui-state-disabled")&&e.removeClassName("wux-ui-state-disabled")}),this.options.renderTo=this.localContext.elements.container},updateProgress:function(e){if(null!=this.progressbar){var t=this.progressbar,s=t.value+100/(e.length/this.chunkSize)/1;s=Math.min(s,100),console.log(s),t.value=s,console.log(t.value)}},getUrls:function(e,t,s){var r=[],o=[],n=0;n=null==t?(t=0)+e.length-1:t+this.chunkSize-1;for(var i=t;i<=n&&i<e.length;i++){var l=e[i];if(!(l in r)){r[l]="";var a="";if((d=l.split("/")).length>0&&(a=d.length>1&&d[d.length-2].startsWith("cid")?d[d.length-2]+"/"+d[d.length-1]:d[d.length-1]),a in this.SuccessIds||o.push(l),null!=s&&s.length>0){var c=this.V5DataIndex[a];if(c>=0&&c<s.length)for(var h=s[c].rel.split(","),u=0;u<h.length;u++)if(h[u]&&h[u].length>0){var g="model/rel/"+h[u];r[g]="";var d;a="";(d=g.split("/")).length>0&&(a=d.length>1&&d[d.length-2].startsWith("cid")?d[d.length-2]+"/"+d[d.length-1]:d[d.length-1]),a in this.SuccessIds||o.push(g)}}}}return JSON.stringify({urls:o,branchorcontent:"type"})},ReserveUnreserveServiceRequest:function(e,t,s,r,o,i){var l=this,a=[];t&&t.forEach(function(e){if(!(e.physicalid in l.V5DataIndex)){var t=a.push(e);l.V5DataIndex[e.physicalid]=t-1}}),n.getInstance().getSecurityContext({onSuccess:function(t){"reserve"==s?l.ReserveServiceRequest(e,a,r,t,o,i):"unreserve"==s&&l.UnReserveServiceRequest(e,a,r,t,o,i)},onFailure:function(e){console.log("securityContext is null"),l.stopProgress()}})},execute:function(){var e=null!=this.instToggle&&this.instToggle.checkFlag,t=null==this.instToggle||this.refToggle.checkFlag,s=this.options.operation;console.log("reserveWidget::launchCmd "+s);var r=this,n=!1,l=[],a=[],c=0,h=[];this.SelectedItems.forEach(function(s){if(t&&(l.push("model/bus/"+s.getPhysicalId()),"3DEXPERIENCE"!=s.cadMaster&&h.push(s.physicalId),c++),e&&"PLMEntity"==s.baseType){var r=s.relID;""!=r&&(s.isV6Rel?(l.push("model/rel/"+s.relID),c++):a.push(r))}});var u=[],g=[];l.forEach(function(e){e in g||(u.push(e),g[e]="")});var d=[],f=[];a.forEach(function(e){e in f||(d.push(e),f[e]="")});var v=-1;this.SelectedItems.length>5&&((v=Math.ceil(u.length/20))>50?v=50:v<5&&(v=5)),this.startProgress(s,v),c>1&&(n=!0);var p=JSON.stringify(this.SelectedItems);console.log("jsonSelectedItems = "+p);var m=void 0;if(r.chunkSize>0&&(m=0),h.length>0){var S=h.join();o.get3DSpaceUrlAsync({onComplete:function(e){var t="?",l=o.getTenantID();l&&(t+="tenant="+l);var a=e+"/resources/v1/collabServices/reservation/op/getV5Instances"+t;i.authenticatedRequest(a,{method:"POST",type:"json",timeout:108e5,data:S,headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:function(e){r.ReserveUnreserveServiceRequest(d,e,s,u,n,m)}})}})}else{r.ReserveUnreserveServiceRequest(d,void 0,s,u,n,m)}},onRefresh:function(){console.log("onRefresh->")},showNotification:function(e){var t={eventID:"primary",msg:e};this.dispatchEvent("onNotification",t)},showError:function(e){console.log("showError "+e);var t={eventID:"error",msg:e};this.dispatchEvent("onNotification",t)},refreshView:function(e){console.log("******* refreshing PADCommandProxy *************");var t={authored:{modified:this.listOfModified}},s=e.create();s.authored({authored:!0}),s.refresh(t),void 0!==this.localContext.refreshView?(console.log("$$$ calling refreshView - Product Editor case $$$"),this.localContext.refreshView(this.refreshDatas)):this.refreshDatas.modified.length>0&&(console.log("$$$ Folder Editor - RefreshView $$$"),void 0!==this.localContext.RefreshView&&this.localContext.RefreshView(this.refreshDatas)),s.destroy()},showSuccessMessage:function(e,t){if(0!=this.SuccessInfo.length){var s=1==t?UWA.i18n("reservationSucceeded"):UWA.i18n("unreservationSucceeded");if(1==e){var r=UWA.i18n("instance"),o=UWA.i18n("reference"),n=[];this.SuccessInfo.forEach(function(e){var t=e.url.includes("model/rel/")?r:o;t+=" "+e.title,-1==n.indexOf(t)&&(n.push(t),s+="<br>"+t)})}this.showNotification(s),console.log("RESERVE SUCCESS")}},ReserveServiceRequest:function(e,t,s,r,n,l){var a=this;console.log("RESERVE:");var c=a.getUrls(s,l,t);console.log(c);this.localContext;a.fakeItemInProcess=l;var h,g=function(o){console.log("reserve: COMPLETED"),a.updateProgress(s);var i=[];o.results&&(i=o.results),console.log(o.results);i.length;i.forEach(function(e){if(e.errors){var t=e.errors.length;if(t<=0)a.FailureInfo[e.errors[t-1].physicalid]={physicalid:e.errors[t-1].physicalid,message:""};else{var s=e.errors[t-1].message;a.FailureInfo[e.errors[t-1].physicalid]={physicalid:e.errors[t-1].physicalid,message:s}}}else{a.listOfModified.push(e.physicalid);var r="";void 0!==e.reservedby&&(r=e.reservedby),void 0!==e.locker&&(r=e.locker),console.log("&&&& locker ="+r),a.refreshDatas.modified.push({physicalid:e.physicalid,attributes:[{name:"ds6w:reserved",value:"TRUE"},{name:"ds6w:reservedBy",value:e.lockerName},{name:"ds6w:displayName",value:e.lockerName}]}),a.SuccessInfo.push(e),a.SuccessIds[e.physicalid]=""}}),null!=l&&l+a.chunkSize<s.length?a.ReserveServiceRequest(e,t,s,r,n,l+a.chunkSize):require(["DS/PADUtils/PADCommandProxy"],function(t){var s=!1;for(var r in a.FailureInfo){s=!0;break}for(var o in a.chunkSize>0&&1==s&&a.SuccessInfo.forEach(function(e){e.physicalid in a.FailureInfo&&delete a.FailureInfo[e.physicalid]}),s=!1,a.FailureInfo){s=!0;var n=a.FailureInfo[o].message;a.showError(n),console.log("RESERVE ERROR "+n)}a.reportV5Instances(e),a.showSuccessMessage(s,!0),a.refreshView(t),a.stopProgress()})},d=function(e){console.log("Failed to reserve data"),e.hasOwnProperty("error")?a.showError(e.error):e.hasOwnProperty("message")&&a.showError(e.message),a.showSuccessMessage(!0,!0),require(["DS/PADUtils/PADCommandProxy"],function(e){a.refreshView(e)}),a.stopProgress()},f=function(e){console.log("Timeout error"),e.hasOwnProperty("error")?a.showError(e.error):e.hasOwnProperty("message")&&a.showError(e.message),a.showSuccessMessage(!0,!0),require(["DS/PADUtils/PADCommandProxy"],function(e){a.refreshView(e)}),a.stopProgress()};if(null==r||""==r||!r.hasOwnProperty("SecurityContext")){var v={message:UWA.i18n("ErrorSecurityContextEmpty"),code:"ERROR"};return this.showError(v),void console.log("***** Empty security context *****")}var p="";0!=r.SecurityContext.indexOf("ctx::")&&(p="ctx::"),h=p+r.SecurityContext,console.log("SecurityContext="),console.log(h);this.options.serverName,this.options.serverUri;o.get3DSpaceUrlAsync({onComplete:function(e){a.options.currentUser;var t="?",s=o.getTenantID();s&&(t+="tenant="+s+"&"),t+=n?"isMultiSel=1&":"isMultiSel=0&";["physicalid"].forEach(function(e){t+="select="+e+"&"});var r=e+"/resources/v1/collabServices/reservation/op/reserve"+t;console.log("url="+r);var l=u.getHeaders(encodeURIComponent(h));i.authenticatedRequest(r,{method:"POST",type:"json",timeout:108e5,headers:l,cache:-1,proxy:"passport",onComplete:g,data:c,onFailure:d,onTimeout:f})}})},UnReserveServiceRequest:function(e,t,s,r,n,l){var a=this;console.log("UNRESERVE:");var c=a.getUrls(s,l,t);console.log(c);var h,g=function(o){console.log("unreserve: COMPLETED"),a.updateProgress(s);var i=[];o.results&&(i=o.results),console.log(o.results),i.forEach(function(e){if(e.errors){var t=e.errors.length;if(t<=0)a.FailureInfo[e.errors[t-1].physicalid]={physicalid:e.errors[t-1].physicalid,message:""};else{var s=e.errors[t-1].message;a.FailureInfo[e.errors[t-1].physicalid]={physicalid:e.errors[t-1].physicalid,message:s}}}else a.listOfModified.push(e.physicalid),a.refreshDatas.modified.push({physicalid:e.physicalid,operation:"update",attributes:[{name:"ds6w:reserved",value:"FALSE"},{name:"ds6w:reservedBy",value:""}]}),a.SuccessInfo.push(e),a.SuccessIds[e.physicalid]=""}),null!=l&&l+a.chunkSize<s.length?a.UnReserveServiceRequest(e,t,s,r,n,l+a.chunkSize):require(["DS/PADUtils/PADCommandProxy"],function(t){var s=!1;for(var r in a.FailureInfo){s=!0;break}for(var o in a.chunkSize>0&&1==s&&a.SuccessInfo.forEach(function(e){e.physicalid in a.FailureInfo&&delete a.FailureInfo[e.physicalid]}),s=!1,a.FailureInfo){s=!0;var n=a.FailureInfo[o].message;a.showError(n),console.log("RESERVE ERROR "+n)}a.reportV5Instances(e),a.showSuccessMessage(s,!1),a.refreshView(t),a.stopProgress()})},d=function(e){console.log("myOnFailure"),e.hasOwnProperty("error")?a.showError(e.error):e.hasOwnProperty("message")&&a.showError(e.message),a.showSuccessMessage(!0,!1),require(["DS/PADUtils/PADCommandProxy"],function(e){a.refreshView(e)}),a.stopProgress()},f=function(e){console.log("Timeout error"),e.hasOwnProperty("error")?a.showError(e.error):e.hasOwnProperty("message")&&a.showError(e.message),a.showSuccessMessage(!0,!1),require(["DS/PADUtils/PADCommandProxy"],function(e){a.refreshView(e)}),a.stopProgress()};if(null==r||""==r||!r.hasOwnProperty("SecurityContext")){var v={message:UWA.i18n("ErrorSecurityContextEmpty"),code:"ERROR"};return this.showError(v),void console.log("***** Empty security context *****")}var p="";0!=r.SecurityContext.indexOf("ctx::")&&(p="ctx::"),h=p+r.SecurityContext,console.log("SecurityContext="),console.log(h);this.options.serverName,this.options.serverUri;o.get3DSpaceUrlAsync({onComplete:function(e){var t="?",s=o.getTenantID();s&&(t+="tenant="+s+"&"),t+=n?"isMultiSel=1&":"isMultiSel=0&";["physicalid"].forEach(function(e){t+="select="+e+"&"});var r=e+"/resources/v1/collabServices/reservation/op/unreserve"+t;console.log("url="+r);var l=u.getHeaders(encodeURIComponent(h));i.authenticatedRequest(r,{method:"POST",type:"json",timeout:108e5,headers:l,cache:-1,proxy:"passport",onComplete:g,data:c,onFailure:d,onTimeout:f})}})}})});