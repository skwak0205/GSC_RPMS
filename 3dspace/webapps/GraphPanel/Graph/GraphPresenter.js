define("DS/GraphPanel/Graph/GraphPresenter",["DS/CoreEvents/ModelEvents","DS/Core/Core","DS/GraphPanel/Graph/GraphSettings","DS/3DXHighcharts/3DXHighcharts","css!DS/GraphPanel/Graph/GraphPresenter.css"],function(e,t,i,s){"use strict";var r=function(e){this._init(e)};return r.prototype._init=function(t){this._modelEventExt=t&&t.modelEvents?t.modelEvents:new e,this._modelEvents=new e,this._applicationChannel=t&&t.applicationChannel?t.applicationChannel:new e,this._modelC3={selectedItems:[],current:{id:t.modelC0.current?t.modelC0.current:null},series:[]},this._colors=[],this._kpiAttributes=[],this._initDom(t)},r.prototype._initDom=function(e){for(var t in this._content=document.createElement("div"),this._content.classList.add("graph-panel-content"),this._settingsContent=document.createElement("div"),this._settingsContent.classList.add("settings-content"),this._graphContent=document.createElement("div"),this._graphContent.classList.add("graph-content"),e.modelC0.dicoFormat)"kpi"===e.modelC0.dicoFormat[t].type&&this._kpiAttributes.push(t);this._settingsPanel=new i({modelEvents:this._modelEvents,listKPI:e.listKPI,modelC3:this._modelC3}),this._settingsPanel.inject(this._settingsContent),this._content.appendChild(this._settingsContent),this._content.appendChild(this._graphContent);var r=this;this._chart=new s.Chart({chart:{renderTo:this._graphContent,polar:!0,type:"area",width:"230",marginTop:50},title:{text:"KPI values chart"},xAxis:{categories:this._modelC3.selectedItems,tickmarkPlacement:"on",lineWidth:0},yAxis:{gridLineInterpolation:"polygon",min:0},legend:{symbolHeight:12,symbolWidth:12,symbolRadius:6,itemStyle:{color:"#000000",fontWeight:"italic"},useHTML:!0},plotOptions:{series:{events:{legendItemClick:function(){return e.modelC0.current=this.options.id,r._modelC3.current.id=this.options.id,r._setCurrentItemsIndex(e),r._modelEventExt.publish({event:"pc-graph-change-current-for-optim",data:e.modelC0.current}),!1},click:function(){e.modelC0.current=this.options.id,r._modelC3.current.id=this.options.id,r._setCurrentItemsIndex(e),r._modelEventExt.publish({event:"pc-graph-change-current-for-optim",data:e.modelC0.current})}},states:{hover:{halo:{size:0}}}}},colors:["#009DDB","#005686","#9B2C98","#00AA86","#F564A3","#8DDEE4","#CC092F","#E2D5CC","#6FBC4B","#70036b","#002596","#FEE000","#7F7F7F","#4EA8B7","#007A4C","#ADADAD","#127277","#6D2815","#000000","#4D62BA"]}),this._initseries(e),this._subscribeEvents(e),this._setCurrentItemsIndex(e)},r.prototype.debounce=function(e,t,i){var s;return function(){var r=this,o=arguments,n=i&&!s;clearTimeout(s),s=setTimeout(function(){s=null,i||e.apply(r,o)},t||200),n&&e.apply(r,o)}},r.prototype._subscribeEvents=function(e){this._listSubscription=[],this._listSubscription2=[],this._listSubscription3=[];var t={},i=this;i._listSubscription2.push(i._modelEventExt.subscribe({event:"pc-graph-config-created"},function(t){i._newConf(e,t.id,t.min,t.max),i._setCurrentItemsIndex(e),i._modelEventExt.publish({event:"pc-graph-config-color",data:{id:t.id.id,color:i._getConfigColor(t.id.id)}})})),i._listSubscription.push(i._modelEvents.subscribe({event:"change-view"},function(e){i._nbseries=i._modelC3.series.length;for(var s=0;s<i._nbseries;s++)for(var r=0;r<e.length;r++)for(var o in i._modelC3.series[s].data)!0===o.includes(e[r])&&(t[s]?t[s].push(i._modelC3.series[s].data[o]):(t[s]=[],t[s].push(i._modelC3.series[s].data[o])));for(var n in t)i._chart.series[n].update({data:t[n]}),i._chart.xAxis[0].update({categories:e}),t[n]=null;i._setBold()})),i._listSubscription2.push(i._modelEventExt.subscribe({event:"pc-graph-change-name"},function(e){for(var t=0;t<i._chart.series.length;t++)e.id===i._chart.series[t].options.id&&(i._modelC3.series[t].name=e.name,i._chart.series[t].update({name:e.name}));i._setBold()})),i._listSubscription2.push(i._modelEventExt.subscribe({event:"pc-graph-change-current"},function(){i._setCurrentItemsIndex(e)})),i._listSubscription2.push(i._modelEventExt.subscribe({event:"pc-graph-delete-config"},function(e){for(var t=0;t<i._chart.series.length;t++)i._chart.series[t].options.id===e&&(i._modelC3.series.splice(t,1),i._chart.series[t].remove())})),i._listSubscription2.push(i._modelEventExt.subscribe({event:"pc-graph-delete-tab"},function(e){for(var t=0;t<e.length;t++)for(var s=0;s<i._chart.series.length;s++)i._chart.series[s].options.id===e[t].id&&(i._modelC3.series.splice(s,1),i._chart.series[s].remove())})),i._listSubscription3.push(i._applicationChannel.subscribe({event:"triptych-resized"},function(e){if("right"===e.side){var t=e.width;i.debounce(i._chart.setSize(t,t),100,!0)}}))},r.prototype._initseries=function(e){this._values=[];var t={};if(this._nbseries=this._modelC3.series.length,Object.keys(e.modelC0.defConfig).length>1)for(var i in e.modelC0.defConfig)"prodConf"!==i&&this._previousConf(e,e.modelC0.defConfig[i]);else{for(var i in this._modelC3.series[0]={id:e.modelC0.defConfig.prodConf.id,name:e.modelC0.defConfig.prodConf.name,data:{}},e.modelC0.defConfig.prodConf.definition)for(var s in e.modelC0.dicoFormat)if(i===s)for(var r=0;r<this._kpiAttributes.length;r++)"kpi"===e.modelC0.dicoFormat[this._kpiAttributes[r]].type&&e.modelC0.dicoFormat[s][this._kpiAttributes[r]]&&(t[this._kpiAttributes[r]]?t[this._kpiAttributes[r]]=t[this._kpiAttributes[r]]+e.modelC0.dicoFormat[s][this._kpiAttributes[r]].value:t[this._kpiAttributes[r]]=e.modelC0.dicoFormat[s][this._kpiAttributes[r]].value);for(r=0;r<this._modelC3.selectedItems.length;r++)for(var o in t)!0===o.includes(this._modelC3.selectedItems[r])&&(this._modelC3.series[0].data[o]=t[o],this._values.push(t[o]));this._chart.addSeries({id:this._modelC3.series[0].id,name:this._modelC3.series[0].name,fullName:this._modelC3.series[0].name,data:this._values,animation:!1})}},r.prototype._previousConf=function(e,t){this._values=[];var i={};this._nbseries=this._modelC3.series.length;for(var s=0;s<this._nbseries;s++)this._modelC3.series[s]&&this._modelC3.series[s].id===e.modelC0.defConfig.prodConf.id&&(this._chart.series[s].remove(),this._modelC3.series.splice(s,1),this._nbseries=this._modelC3.series.length);var r=this._nbseries;for(var s in this._modelC3.series[r]={id:t.id,name:t.name,data:{}},e.modelC0.defConfig)if(t.name===e.modelC0.defConfig[s].name)for(var o in e.modelC0.defConfig[s].definition)for(var n in e.modelC0.dicoFormat)if(o===n)for(var h=0;h<this._kpiAttributes.length;h++)"kpi"===e.modelC0.dicoFormat[this._kpiAttributes[h]].type&&e.modelC0.dicoFormat[n][this._kpiAttributes[h]]&&(i[this._kpiAttributes[h]]?i[this._kpiAttributes[h]]=i[this._kpiAttributes[h]]+e.modelC0.dicoFormat[n][this._kpiAttributes[h]].value:i[this._kpiAttributes[h]]=e.modelC0.dicoFormat[n][this._kpiAttributes[h]].value);for(var n in e.listKPI)for(var h in i)!0===h.includes(e.listKPI[n])&&(this._modelC3.series[r].data[h]=i[h],this._values.push(i[h]));this._chart.addSeries({id:t.id,name:t.name,data:this._values,animation:!1})},r.prototype._newConf=function(e,t,i,s){this._values=[];var r={};this._nbseries=this._modelC3.series.length;for(var o=0;o<this._nbseries;o++)this._modelC3.series[o]&&this._modelC3.series[o].id===e.modelC0.defConfig.prodConf.id&&(this._chart.series[o].remove(),this._modelC3.series.splice(o,1),this._nbseries=this._modelC3.series.length);console.log(s,i);var n=this._nbseries;for(var o in this._modelC3.series[n]={id:t.id,name:t.name,data:{}},e.modelC0.defConfig)if(t.name===e.modelC0.defConfig[o].name)for(var h=0;h<e.modelC0.defConfig[o].definition.length;h++)for(var d in e.modelC0.dicoFormat)if(e.modelC0.defConfig[o].definition[h].Id===d)for(var a=0;a<this._kpiAttributes.length;a++)if("kpi"===e.modelC0.dicoFormat[this._kpiAttributes[a]].type&&e.modelC0.dicoFormat[d][this._kpiAttributes[a]]){var l=0;l>0?(r[this._kpiAttributes[a]].value=r[this._kpiAttributes[a]]+e.modelC0.dicoFormat[d][this._kpiAttributes[a]].value,l++,r[this._kpiAttributes[a]].number=l):(r[this._kpiAttributes[a]].value=e.modelC0.dicoFormat[d][this._kpiAttributes[a]].value,l++,r[this._kpiAttributes[a]].number=l)}for(d=0;d<e.listKPI.length;d++)for(var a in r)!0===a.includes(e.listKPI[d])&&("kpi_cost"===a?(this._modelC3.series[n].data[a]=100-r[a].value,this._values.push(100-r[a].value)):(this._modelC3.series[n].data[a]=r[a].value,this._values.push(r[a].value)));e.modelC0.current=t.id,this._chart.addSeries({id:t.id,name:t.name,data:this._values,animation:!1})},r.prototype._setBold=function(){this._item=[],this._item=this._graphContent.querySelectorAll("div.highcharts-legend-item"),this._series=this._graphContent.querySelectorAll(".highcharts-series-group .highcharts-series");for(var e=0;e<this._chart.series.length;e++)this._chart.series[e].options.id===this._modelC3.current.id?this._item[e].firstChild.style.fontWeight="900":this._item[e].firstChild.style.fontWeight="400"},r.prototype._setCurrentItemsIndex=function(e){this._modelC3.current.id=e.modelC0.current;for(;0<this._chart.series.length;0)this._chart.series[0].remove();this._chart.colorCounter=0,this._chart.symbolCounter=0;for(var t=0;t<this._modelC3.series.length;t++){this._data=[];for(var i=0;i<this._modelC3.selectedItems.length;i++)for(var s in this._modelC3.series[t].data)!0===s.includes(this._modelC3.selectedItems[i])&&this._data.push(this._modelC3.series[t].data[s]);this._modelC3.series[t].id===e.modelC0.current?this._chart.addSeries({id:this._modelC3.series[t].id,name:this._modelC3.series[t].name,data:this._data,zIndex:10,animation:!1}):this._chart.addSeries({id:this._modelC3.series[t].id,name:this._modelC3.series[t].name,data:this._data,animation:!1}),this._modelEventExt.publish({event:"pc-graph-config-color",data:{id:this._modelC3.series[t].id,color:this._getConfigColor(this._modelC3.series[t].id)}})}this._setBold()},r.prototype._getConfigColor=function(e){for(var t=0;t<this._chart.series.length;t++)if(this._chart.series[t].options.id===e)return this._chart.series[t].color},r.prototype.inject=function(e){e.appendChild(this._content)},r.prototype.destroy=function(){this._content=null;for(var e=this._listSubscription.length,t=0;t<e;t++)this._modelEvents.unsubscribe(this._listSubscription[t]);for(var i=this._listSubscription2.length,s=0;s<i;s++)this._modelEventExt.unsubscribe(this._listSubscription2[s])},r});