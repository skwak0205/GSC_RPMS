"undefined"==typeof define&&(define=function(t,e,n){EK=n(BinaryHelpers),define=void 0}),define("DS/ExperienceKernel/ExperienceKernel",["DS/ExperienceKernel/EKBinaryHelpers"],function(t){"use strict";return"undefined"!=typeof EK?EK:function(){var e={};e.window="undefined"!=typeof window?window:void 0;e.defaultsOptions=Object.freeze({hypervisorIp:"127.0.0.1",hypervisorUrl:void 0,webSocketPort:2097,pool:"browser",ssl:!1,canDisconnectFromHypervisor:!0,onText:function(){return!0},onBinary:function(){return!0},onHypervisorConnect:function(){},onHypervisorDisconnect:function(){},onDisconnect:function(){},onError:function(t){e.window.console.error(t)},authentication:function(t,n,i){e.defaultAuthentication(t,n,i)}}),e.defaultsMultiplexerOptions=Object.freeze({onText:function(){return!0},onBinary:function(){return!0},join:function(){return!0}}),e.defaultsStoreOptions=Object.freeze({hypervisorIp:"127.0.0.1",hypervisorUrl:void 0,webSocketPort:2097,ssl:!1,canDisconnectFromHypervisor:!0,distant:!1,onHypervisorConnect:function(){},onHypervisorDisconnect:function(){},onError:function(t){e.window.console.error(t)},authentication:function(t,n,i){e.defaultAuthentication(t,n,i)}}),e.Status=Object.freeze({pending:0,connected:1,disconnected:2}),e.WebSocket=function(t){this.ws=null,this.monitor=null,this.callback=function(){return!0},this.onopen=[],this.onclose=[],this.inputs=[],this.outputs=[],this.waitingOutputs=[],this.connected=!1,this.waitRelease=!0===t};var n=Object.freeze({version:1}),i=Object.freeze({hypervisor:-2}),s=Object.freeze({noConstraint:0,onlyMyHypervisor:1,notMyHypervisor:2,preferMyHypervisor:3,identifier:5}),o=Object.freeze({none:0,channelRename:2,resultsSend:3,resultsAnswer:4,resultsAnswerEnd:5,resultsInterrupt:7,onDisconnect:8,subscribe:9,unsubscribe:10}),r=Object.freeze({GetFromWeb:9,SnapshotFromWeb:11,PutFromWeb:15,CommitFromWeb:17,LastSnapshotFromWeb:28,CreateObserverFromWeb:33,ReadKeysFromWeb:34,CreateKeysFromWeb:35,GetLocalMasterIdentifierFromWeb:38,DeleteObserverFromWeb:39,NotifyObserverFromWeb:40,StoreNodeDisconnectFromWeb:41});function a(t){for(var e=Object(t),n=1;n<arguments.length;++n){var i=arguments[n];if(void 0!==i)for(var s in i)i.hasOwnProperty(s)&&(e[s]=i[s])}return e}function h(t){if(t.hasOwnProperty("onHypervisorConnect")||t.hasOwnProperty("onHypervisorDisconnect")){if(!0===t.canDisconnectFromHypervisor)throw new Error("Invalid options combination. Do not set canDisconnectFromHypervisor to true with onHypervisorConnect and/or onHypervisorDisconnect");void 0===t.canDisconnectFromHypervisor&&e.window.console.warn("Disabling canDisconnectFromHypervisor because of onHypervisorConnect/onHypervisorDisconnect callbacks"),t.canDisconnectFromHypervisor=!1}}var u,c,p={index:0,uniqueId:0,getTimestamp:function(t){var e=new Date,n=Math.floor(e.getTime()/1e3),i=Math.floor(1e3*e.getMilliseconds());return function(t){return t!==o.channelRename&&t!==o.resultsAnswerEnd&&t!==o.resultsInterrupt}(t)?{sec:n,usec:i,index:this.index++}:{sec:n,usec:i}},getUniqueId:function(){return++this.uniqueId}};function l(t,e,n,i,s,o,r,a,h){var u=e;u.type=o,u.headerType=r,u.isBinary=s,u.uniqueId=n,u.hypervisorId=a.hypervisorId,u.id=a.id,u.eventId=h,u.pool=a.pool,t.sendText(JSON.stringify(u)),t.sendBinary(i)}function d(t,e,n,i,s){var o=p.getTimestamp(n);o.type=n,o.uniqueId=e,o.hypervisorId=i.hypervisorId,o.id=i.id,o.hresult=s,t.sendText(JSON.stringify(o))}function f(t,e){return t===o.none||t===o.channelRename||t===o.onDisconnect||t===o.subscribe||t===o.unsubscribe?e?8:1:t===o.resultsSend||t===o.resultsAnswer||t===o.resultsAnswerEnd||t===o.resultsInterrupt?e?8:4:-1}function y(t,e,n){var i=void 0!==n,s=f(t,i),o=new Uint8Array(s),r=new DataView(o.buffer);return s>=4&&void 0!==e&&r.setInt32(0,16777215&e),o[0]=t,i&&(o[0]|=64,r.setInt32(4,n)),o}function w(t,n,i){if(!t.ws||2!==t.ws.readyState&&3!==t.ws.readyState||(t.ws=null),!t.ws)return!1;"string"!=typeof i&&(n[0]|=128);var s=[n];return void 0!==i&&s.push(i),t.ws.send(new e.window.Blob(s)),!0}function v(t,e,n,i,s,r){n=n||o.none;var a=function(){var o=y(n,i,s);return w(t,o,e)};if(t.waitRelease&&!r)t.waitingOutputs.unshift(a);else{if(t.connected)return a();t.outputs.unshift(a)}return!0}function m(t,e,n){return function(){return t(e+" occurred during request to 3DPassport\n"+n)}}function g(t,e,n){return!!(e&&t&&t.waitingCredentials)&&(e({forWho:t.from,passportURL:t.passportURL},n,function(t){throw new Error(t)}),!0)}function b(t,e){return t&&t.sendMessage(JSON.stringify(e))}function M(t,e){return v(t,JSON.stringify(e),void 0,void 0,void 0,!0)}function S(t,e){for(var n in t)t.hasOwnProperty(n)&&e(n,t[n])}e.WebSocket.prototype.flushMessages=function(){for(;this.outputs.length;){this.outputs.pop()()}},e.WebSocket.prototype.connect=function(t,n){var i;this.connected=!1,this.name=n;try{i=new e.window.WebSocket(t)}catch(n){i={close:function(){},readyState:0,url:t},e.window.setTimeout(function(){this.ws.readyState=3,this.ws.onclose()}.bind(this),1)}this.ws=i,this.ws.binaryType="arraybuffer",this.ws.onopen=function(){this.connected=!0,this.flushMessages(),this.onopen.forEach(function(t){t()}),null===this.ws&&i.close()}.bind(this),this.ws.onclose=function(){var t=this.connected;t&&this.flushMessages(),this.ws=null,this.onclose.forEach(function(e){e(t)})}.bind(this),this.ws.onmessage=function(t){0!==t.data.byteLength&&(this.inputs.push(t.data),1===this.inputs.length&&a())}.bind(this);var s=function(t,e,n,i){var s=e===o.resultsSend;this.monitor&&d(this.monitor,i,2,this.name);var r=this.callback(t,n,s);s&&v(this,void 0,o.resultsAnswerEnd,n),this.monitor&&d(this.monitor,i,3,this.name,Number(r)),this.inputs.shift(),a()}.bind(this),r=function(t){this.callbackResultsEnd(t),this.inputs.shift(),a()}.bind(this),a=function(){var t=this.inputs[0];if(t){var n=new Uint8Array(t),i=63&n[0],a=64==(64&n[0]),h=f(i,a),u=-1,c=new DataView(t);if(i===o.resultsAnswerEnd)return u=16777215&c.getInt32(0),void r(u);i!==o.resultsSend&&i!==o.resultsAnswer||(u=16777215&c.getInt32(0));var d=a?c.getInt32(4):0,y=t.slice(h),w=128==(128&n[0]);if(this.monitor){var v=p.getTimestamp(i);l(this.monitor,v,d,y,w,1,i,this.name)}var m=new e.window.FileReader;m.onload=function(t){s(t.target.result,i,u,d)},w&&e.window.FileReader.prototype.hasOwnProperty("readAsArrayBuffer")?m.readAsArrayBuffer(new e.window.Blob([y])):w?m.onload({target:{result:y}}):m.readAsText(new e.window.Blob([y]))}}.bind(this)},e.WebSocket.prototype.close=function(){this.monitor=null,this.ws&&0!==this.ws.readyState&&this.ws.close(),this.ws=null},e.WebSocket.prototype.release=function(){for(this.waitRelease=!1;this.waitingOutputs.length;)this.outputs.unshift(this.waitingOutputs.pop());this.connected&&this.flushMessages()},e.WebSocket.prototype.sendMessage=function(t,e,n,i){return v(this,t,e,n,i)},e.defaultServiceURL="EXECFWK",e.defaultAuthentication=function(t,n,i){var s=t.passportURL+"/login?service="+e.defaultServiceURL+"&xrequestedwith=xmlhttprequest",o=new XMLHttpRequest;o.open("GET",s,!0),o.setRequestHeader("Accept","application/json"),o.withCredentials=!0,o.onloadend=function(s){if(s.currentTarget&&s.currentTarget.responseText)try{var o=JSON.parse(s.currentTarget.responseText).access_token;if(o)return n(e.defaultServiceURL,o)}catch(t){}return i("Invalid response from 3DPassport (click on this URL to check it)\n"+t.passportURL+"\nThe response:\n"+s)},o.ontimeout=m(i,"A timeout",t.passportURL),o.onabort=m(i,"An abort",t.passportURL),o.onerror=m(i,"An error",t.passportURL),o.send(null)},e.WebSocket.prototype.channelRename=function(t,e,n){var i=function(){var i=y(o.channelRename);t._="setPool",g(n,e,function(t,e){this.key.subMessage={_:"proxyValidate",serviceURL:t,serviceTicket:e},w(this.ws,this.header,JSON.stringify(this.key)),this.ws.release()}.bind({ws:this,header:i,key:t}))||(w(this,i,JSON.stringify(t)),this.release())}.bind(this);this.outputs.push(i)},e.WebSocket.prototype.onMessage=function(t){this.callback=t},e.WebSocket.prototype.onMessageResultsEnd=function(t){this.callbackResultsEnd=t},e.WebSocket.prototype.onOpen=function(t){this.ws&&1===this.ws.readyState?t():this.onopen.push(t)},e.WebSocket.prototype.onClose=function(t){this.ws&&3===this.ws.readyState?t(this.connected):this.onclose.push(t)};var k=function(t,e){this.index=0,this.nodes=[],this.timeout=0,this.url=t,this.checkSentMessages=e};k.prototype.init=function(t){this.buffer=t.response,200===t.status&&(this.dataView=new DataView(this.buffer),this.version=this.dataView.getUint8(0),this.offset=1)},k.prototype.reset=function(){e.window.clearTimeout(this.timeout),this.timeout=0},k.prototype.addNode=function(t){return void 0===this.buffer?u("Missing EK.replayIsReady call"):void 0===this.version?u("Record file not found: "+this.url):this.version!==n.version?u("Version mismatch: please update your record file"):(t.replayer=new I(this.index),this.index++,this.nodes.push(t),void this.processMessages())},k.prototype.getMessage=function(){var t,e=this.dataView.getInt8(this.offset),n=this.dataView.getInt8(this.offset+1),i=this.dataView.getInt8(this.offset+2),s=this.dataView.getInt32(this.offset+3,!0);if(this.offset+=7,n)t=this.buffer.slice(this.offset,this.offset+s);else{t="";for(var o=0;o<s;++o)t+=String.fromCharCode(this.dataView.getUint8(this.offset+o));try{t=decodeURIComponent(window.escape(t))}catch(t){}}return this.offset+=s,{index:e,isSent:i,message:t}},k.prototype.processMessages=function(){0===this.timeout&&(this.offset>=this.dataView.byteLength?c=void 0:this.dataView.getInt8(this.offset+2)||(this.timeout=e.window.setTimeout(function(){for(;this.offset<this.dataView.byteLength&&!this.dataView.getInt8(this.offset+2);){var t=this.getMessage();this.nodes[t.index].replayer.callback(t.message,-1)}this.timeout=0,this.processMessages()}.bind(this),1)))},e.setReplayUrl=function(t,e){if(void 0===(e=e||{}).checkSentMessages&&(e.checkSentMessages=!0),void 0===e.onerror&&(e.onerror=function(t){jasmine.addMatchers({toFail:function(){return{compare:function(t){return{pass:!1,message:t}}}}}),expect(t).toFail()}),u=function(t){c instanceof k&&c.reset(),c=void 0,e.onerror(t)},"boolean"==typeof c)return u("EK.Node created before calling EK.setReplayUrl");var n=new k(t+=".ekr",e.checkSentMessages),i=new XMLHttpRequest;i.onreadystatechange=function(){4===i.readyState&&n.init(i)},i.open("GET",t,!0),i.responseType="arraybuffer",i.send(null),c=n},e.replayIsReady=function(){return c instanceof k?void 0!==c.buffer:u("Missing EK.setReplayUrl call")},e.replayHasFinished=function(){return void 0===c};var I=function(t){this.index=t};function U(t){return t instanceof Uint8Array?t:t.buffer instanceof ArrayBuffer?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):new Uint8Array(t)}function O(t){if("string"==typeof t)return t;for(var e=U(t),n="",i=0;i<e.length;++i){var s=e[i].toString(16);1===s.length&&(s="0"+s),n+=s+" "}return n}I.prototype.sendMessage=function(t){if(void 0===c)return u("Unexpected send "+O(t));var n=c.getMessage();if(n.index!==this.index)return u("Send "+O(t)+" with the wrong node");if(!n.isSent)return u("Send "+O(t)+" but expect to receive "+O(n.message));if(!function(t,e){if("string"==typeof t||"string"==typeof e)return t===e;var n=U(t),i=U(e);if(n.length!==i.length)return!1;for(var s=0;s!==n.length;++s)if(n[s]!==i[s])return!1;return!0}(n.message,t)){var i="Send "+O(t)+" but expect to send "+O(n.message);if(c.checkSentMessages)return u(i);e.window.console.warn("Ignoring because checkSentMessages is false: "+i)}return c.processMessages(),!0},I.prototype.onMessage=function(t){this.callback=t},I.prototype.onMessageResultsEnd=function(t){this.callbackResultsEnd=t},I.prototype.onOpen=function(){},I.prototype.onClose=function(){};var H=function(t,e){this.pool=e,this.clients={},this.uniqueId=0,this.index=-1,this.handlers=[],this.authentication=t.authentication,this.onError=t.onError,this.onPoolSelectable=[],c instanceof k?c.addNode(this):(c=!1,this.pools={},this.inputs={},this.onHypervisorConnect=t.onHypervisorConnect,this.onHypervisorDisconnect=t.onHypervisorDisconnect,this.onDisconnect=t.onDisconnect,this.onText=t.onText,this.onBinary=t.onBinary,this.canDisconnect=t.canDisconnectFromHypervisor,this.wsHypervisor=null,void 0===t.hypervisorUrl&&(t.hypervisorUrl=t.hypervisorIp+":"+t.webSocketPort),"string"==typeof t.hypervisorUrl&&(t.hypervisorUrl=[t.hypervisorUrl]),this.hypervisorUrl=t.hypervisorUrl.map(function(e){return function(t,e){return/^\s*wss?:/.test(t)?t:(e?"wss://":"ws://")+t}(e,t.ssl)}),this.canDisconnect||this.connectToHypervisor())};function C(t,e){for(var n=0;n<t.length;++n){var i=t[n];if(i&&i.multiplexer===e)return}e.canJoin=!0,e.join()}H.prototype.connectToHypervisor=function(){var t=0;this.index++;var n=function(t){var e=this.hypervisorUrl[t],n={hypervisorId:0,id:i.hypervisor};this.wsHypervisor.connect(e,n)}.bind(this),s=function(){this.onHypervisorConnect()}.bind(this),o=function(e){e?this.onHypervisorDisconnect(e):t<this.hypervisorUrl.length?n(t++):(this.onError("Can't connect to the Hypervisor on "+this.hypervisorUrl),this.onHypervisorDisconnect(e))}.bind(this);this.wsHypervisor=new e.WebSocket(!0),this.wsHypervisor.onOpen(s),this.wsHypervisor.onClose(o),this.wsHypervisor.onMessage(this.privateOnText.bind(this)),n(t++),M(this.wsHypervisor,{_:"createNode",pool:this.pool,web:!0,version:2})},H.prototype.uniqueKey=function(t){return this.index+"_"+t.hypervisorId+"_"+t.id},H.prototype.setNodeId=function(t){var n;if(void 0!==t.status?((n=new e.WebSocket).name={},n.ws={readyState:3}):n=this.clients[this.uniqueKey(t)],void 0===n){var i=t.pool;this.inputs[i]=this.inputs[i]||[],this.inputs[i].push(t)}else{var s=t.uniqueId,o=this.pools[s];delete this.pools[s],o.setId(n,t.pool,this.onDisconnect)}},H.prototype.connect=function(t){var n={hypervisorId:t.hypervisorId,id:t.id},i=t.url,s=new e.WebSocket(!0);t.name.pool=this.pool,this.canDisconnect&&(t.name.canDisconnect=!0),s.channelRename(t.name,this.authentication,t.credentials),s.connect(i,n),this.clients[this.uniqueKey(t)]=s;var o=this.inputs[t.pool];if(void 0!==o)for(this.inputs[t.pool]=[];o.length;)this.setNodeId(o.shift());else{var r=new W(this);r.ws=s;var a=new E(r);s.onMessage(this.onMessage(a)),s.onMessageResultsEnd(this.onMessageResultsEnd(a))}s.pool=t.pool,this.monitor&&"ek.local.monitor"!==t.pool&&(s.monitor=this.monitor)},H.prototype.deleteHandler=function(t){for(var e=0;e<this.handlers.length;++e){var n=this.handlers[e];n&&n.nodeId.impl.ws===t&&(delete this.handlers[e],C(this.handlers,n.multiplexer))}},H.prototype.closeIfNeeded=function(){if(this.canDisconnect&&null!==this.wsHypervisor&&!(this.onPoolSelectable.length>0)){for(var t in this.pools)if(this.pools.hasOwnProperty(t))return;for(var e in this.clients)if(void 0===this.clients[e].canClose)return;this.wsHypervisor.close(),this.wsHypervisor=null}},H.prototype.privateOnText=function(t){try{t=JSON.parse(t)}catch(t){return!1}var n=t._;if("setId"===n)t.monitor&&(this.monitor=this.askConnect("ek.local.monitor",e.Criterion.onlyMyHypervisor()),this.monitor.onMessage(this.privateOnText.bind(this))),this.ip=t.ip,this.port=t.port,!g(t.credentials,this.authentication,function(t,e){M(this.wsHypervisor,{_:"proxyValidate",serviceURL:t,serviceTicket:e}),this.wsHypervisor&&this.wsHypervisor.release()}.bind(this))&&this.wsHypervisor&&this.wsHypervisor.release();else if("connect!"===n)void 0===this.clients[this.uniqueKey(t)]&&4!==t.type&&this.connect(t);else if("id!"===n)this.setNodeId(t),void 0!==t.status&&this.closeIfNeeded();else if("isPoolSelectable!"===n){var i=this.onPoolSelectable.shift();void 0!==i&&i(t.pool,!!t.answer),this.closeIfNeeded()}else if("clientRemoved"===n){var s=this.uniqueKey(t),o=this.clients[s];void 0!==o&&(delete this.clients[s],"ek.local.monitor"===o.pool&&(S(this.clients,function(t,e){e.monitor=null}),this.monitor=void 0),o.close())}else if("monitorMessages"===n)"ek."!==this.pool.substr(0,3)&&(this.monitor||(this.monitor=this.askConnect("ek.local.monitor",e.Criterion.onlyMyHypervisor()),this.monitor.onMessage(this.privateOnText.bind(this))),S(this.clients,function(t,e){e.monitor=this.monitor}.bind(this)));else if("webAdded"===n){var r=this.clients[this.uniqueKey(t)];void 0!==r&&(r.canClose=!0),this.closeIfNeeded()}else{if("stop"!==n){var a="A web node from pool "+this.pool+" received an unknown message: "+JSON.stringify(t);return b(this.wsHypervisor,{_:"publishError",message:a}),this.onError(a),!1}this.stop()}return!0};var x=function(t,e){this.policy=t,this.name=e};x.prototype.withTimeout=function(t){return this.timeout=t>0?t:0,this},x.prototype.withoutQueuing=function(){return this.noQueuing=!0,this},x.prototype.withoutProcessCreation=function(){return this.noProcess=!0,this},x.prototype.withCmdLine=function(t){return this.cmdLine=t,this},e.Criterion={none:function(){return new x(s.noConstraint)},onlyMyHypervisor:function(){return new x(s.onlyMyHypervisor)},notMyHypervisor:function(){return new x(s.notMyHypervisor)},preferMyHypervisor:function(){return new x(s.preferMyHypervisor)},identifier:function(t){return new x(s.identifier,t)},timeout:function(t){return new x(s.noConstraint).withTimeout(t)},noQueuing:function(){return new x(s.noConstraint).withoutQueuing()},noProcessCreation:function(){return new x(s.noConstraint).withoutProcessCreation()}},H.prototype.sendMessageWithInterrupt=function(t,n,i,s){var o={onText:this.onText,onBinary:this.onBinary},r=new e.Multiplexer(s,o);r.impl.sendMessageWithInterrupt(t,n,i),r.close()},H.prototype.askConnect=function(t,e){var n=new W(this);if(c instanceof k)n.setId(this.replayer);else{e=e||{policy:s.noConstraint};var i=p.getUniqueId(),o={_:"id?",pool:t,uniqueId:i,policy:e.policy,name:e.name,cmdLine:e.cmdLine,timeout:void 0!==e.timeout?e.timeout:-1,noQueuing:e.noQueuing,noProcess:e.noProcess};this.pools[i]=n,null===this.wsHypervisor&&this.connectToHypervisor(),b(this.wsHypervisor,o)}return n},H.prototype.unserializeNodeId=function(t,e,n,i,o,r){var a=new W(this),h=p.getUniqueId(),u={_:"unserializeId",ip:e,port:n,pool:i,hypervisorId:o,id:r,uniqueId:h,policy:s.noConstraint};this.pools[h]=a,null===this.wsHypervisor&&this.connectToHypervisor(),b(this.wsHypervisor,u);var c=new R(t,i);return new D(c,void 0,a)},H.prototype.stop=function(){var t=this.onDisconnect;S(this.pools,function(n,i){var s=new e.WebSocket;s.name={},s.ws={readyState:3},i.setId(s,i.nodePool.pool,t)}),S(this.clients,function(t,e){e.close()}),this.wsHypervisor&&this.wsHypervisor.close(),this.wsHypervisor=null};var W=function(t){this.nodeImpl=t,this.outputs=[],this.onStatusChange=[],this.reduced=!1};W.prototype.setId=function(t,e,n){var i=null===this.ws;this.ws=t,i&&this.ws.onOpen(function(){this.close(this.reduced)}.bind(this));var s=t.ws&&t.ws.url;this.ws.onClose(function(t){s&&!t&&(b(this.nodeImpl.wsHypervisor,{_:"clientRejected",hypervisorId:this.ws.name.hypervisorId,id:this.ws.name.id}),this.nodeImpl.onError("Can't connect to the Node from pool '"+e+"' on "+s));this.ws&&this.nodeImpl.deleteHandler(this.ws)}.bind(this));var o=function(){if(this.ws){var t=new D;t.impl=this,this.onStatusChange.forEach(function(n){n(t,e)})}}.bind(this);if(this.ws.onOpen(o),this.ws.onClose(o),"function"==typeof n&&"ek."!==e.substr(0,3)){var r=function(){if(this.ws){var t=new D;t.impl=this,n(t,e)}}.bind(this);this.ws.onClose(r)}for(;this.outputs.length;){this.outputs.shift()()}},W.prototype.close=function(t){var e={_:"closeId",reduced:t};if(this.reduced=t,this.ws&&!0===this.ws.canClose)this.ws.sendMessage(JSON.stringify(e),o.channelRename);else{var n=this.nodeImpl.wsHypervisor;this.ws?(e.hypervisorId=this.ws.name.hypervisorId,e.id=this.ws.name.id):(this.ws=null,e.pool=this.nodePool.pool,e.uniqueId=function(t,e){for(var n in e)if(e.hasOwnProperty(n)&&e[n]===t)return Number(n);return-1}(this,this.nodeImpl.pools)),b(n,e)}},W.prototype.push=function(t){if(this.ws){if(!t()&&"boolean"==typeof c)throw new Error("ExperienceKernel was unable to send a message since the distant node is unreachable")}else this.outputs.push(t)},W.prototype.sendText=function(t){this.push(function(){return this.ws.sendMessage(t)}.bind(this))},W.prototype.sendBinary=function(t){this.push(function(){return"string"==typeof t&&(t=new String(t)),this.ws.sendMessage(t)}.bind(this))},W.prototype.sendMessage=function(t,e,n){var i=p.getTimestamp(e),s=this.nodeImpl,o=++s.uniqueId;this.push(function(){if(s.monitor){var r=void 0===this.ws?{pool:this.nodePool.pool}:this.ws.name;l(s.monitor,i,o,t,"string"!=typeof t,0,e,r,n)}else o=void 0;return this.ws.sendMessage(t,e,n,o)}.bind(this))},W.prototype.onMessage=function(t){this.push(function(){return this.ws.onMessage(t),!0}.bind(this))},W.prototype.onMessageResultsEnd=function(t){this.push(function(){return this.ws.onMessageResultsEnd(t),!0}.bind(this))},W.prototype.getStatus=function(){if(void 0===this.ws)return e.Status.pending;if(null===this.ws||null===this.ws.ws)return e.Status.disconnected;var t=this.ws.ws;return 0===t.readyState?e.Status.pending:1===t.readyState?e.Status.connected:e.Status.disconnected},e.Node=function(t){for(var n in t=t||{})if(t.hasOwnProperty(n)&&!e.defaultsOptions.hasOwnProperty(n))throw new Error("Unknown EK.Node option named '"+n+"'. Valid options are: "+JSON.stringify(Object.keys(e.defaultsOptions)));if(t.hasOwnProperty("hypervisorUrl")&&(t.hasOwnProperty("hypervisorIp")||t.hasOwnProperty("webSocketPort")))throw new Error("Invalid options combination. Do not use hypervisorUrl with hypervisorIp and/or webSocketPort");h(t);var i=a({},e.defaultsOptions,t);this.onMessage=function(t){return function(e,n,s){if(t.id=n,t.resultsAnswer=s,s||-1===n)return("string"==typeof e?i.onText:i.onBinary)(e,t);if(void 0!==this.impl.handlers[n]){var o=this.impl.handlers[n].multiplexer.results;return("string"==typeof e?o.onText:o.onBinary)(e,t)}}.bind(this)},this.onMessageResultsEnd=function(){return function(t){var e=this.impl.handlers[t];e&&0==--e.cnt&&(delete this.impl.handlers[t],C(this.impl.handlers,e.multiplexer))}.bind(this)},this.impl=new H(i,i.pool),this.impl.onMessage=this.onMessage.bind(this),this.impl.onMessageResultsEnd=this.onMessageResultsEnd.bind(this)};var B=function(t,e){this.cnt=1,this.multiplexer=t,this.nodeId=e},E=function(t){this.impl=t,this.id=-1,this.resultsAnswer=!1};E.prototype.answerText=function(t){return this.answerMessage(t+"")},E.prototype.answerBinary=function(t){return this.answerMessage(t)},E.prototype.answerMessage=function(t){if(-1===this.id)this.impl.sendMessage(t);else if(this.resultsAnswer)this.impl.sendMessage(t,o.resultsAnswer,this.id);else{var e=this.impl.nodeImpl.handlers[this.id];e&&(++e.cnt,this.impl.sendMessage(t,o.resultsSend,this.id))}return this};var R=function(t,e){this.node=t,this.pool=e};R.prototype.select=function(t){return new D(this,t)};var D=function(t,e,n){if(void 0!==t){var i=t.node;this.impl=void 0!==n?n:i.impl.askConnect(t.pool,e),this.impl.nodePool=t;var s=new E(this.impl);this.impl.onMessage(i.onMessage(s)),this.impl.onMessageResultsEnd(i.onMessageResultsEnd(s))}};function T(t,e){if(t.impl.nodePool.node!==e)throw new Error("The NodeId doesn't belong to the right node")}D.prototype.equals=function(t){var e=this.impl.ws,n=t.impl.ws;return void 0!==e&&void 0!==n&&(e.name.id===n.name.id&&e.name.hypervisorId===n.name.hypervisorId)},D.prototype.close=function(){return this.impl.close(!1),this},D.prototype.closeWithReducedTimeout=function(){return this.impl.close(!0),this},D.prototype.getStatus=function(){return this.impl.getStatus()},D.prototype.isConnected=function(){return this.impl.getStatus()===e.Status.connected},D.prototype.onStatusChange=function(t){"function"==typeof t&&this.impl.onStatusChange.push(t)},D.prototype.unregisterStatusChange=function(t){"function"==typeof t&&(this.impl.onStatusChange=this.impl.onStatusChange.filter(function(e){return e!==t}))},e.Node.prototype.connect=function(t){return new R(this,t)},e.Node.prototype.isPoolSelectable=function(t,e){"function"==typeof e&&(this.impl.onPoolSelectable.push(e),null===this.impl.wsHypervisor&&this.impl.connectToHypervisor(),b(this.impl.wsHypervisor,{_:"isPoolSelectable",pool:t}))},e.Node.prototype.sendText=function(t,e){return T(t,this),e=e||"",t.impl.sendMessage(e+""),this},e.Node.prototype.sendBinary=function(t,e){return T(t,this),t.impl.sendMessage(e),this},e.Node.prototype.sendBinaryWithInterrupt=function(t,e,n){return T(t,this),this.impl.sendMessageWithInterrupt(t,e,n,this),this},e.Node.prototype.sendTextWithInterrupt=function(t,e,n){return T(t,this),this.impl.sendMessageWithInterrupt(t,e+"",n,this),this},e.Node.prototype.sendTextOnDisconnection=function(t,e){return T(t,this),e=e||"",t.impl.sendMessage(e+"",o.onDisconnect),this},e.Node.prototype.sendBinaryOnDisconnection=function(t,e){return T(t,this),t.impl.sendMessage(e,o.onDisconnect),this},e.Node.prototype.subscribe=function(t,e){return T(t,this),e=e||"",t.impl.sendMessage(e+"",o.subscribe),this},e.Node.prototype.unsubscribe=function(t,e){return T(t,this),e=e||"",t.impl.sendMessage(e+"",o.unsubscribe),this},e.Node.prototype.stop=function(){this.stop=function(){},this.impl.stop();var t=function(){throw new Error("EK.Node is closed")};for(var e in this.constructor.prototype)"function"==typeof this[e]&&(this[e]=t)},e.Interruption=function(){this.id=-1,this.interrupted=!1},e.Interruption.prototype.interrupt=function(){return!this.interrupted&&-1!==this.id&&(this.to.impl.sendMessage(void 0,o.resultsInterrupt,this.id),this.interrupted=!0,!0)},e.Multiplexer=function(t,n){for(var i in n=n||{})if(n.hasOwnProperty(i)&&!e.defaultsMultiplexerOptions.hasOwnProperty(i))throw new Error("Unknown EK.Multiplexer option named '"+i+"'. Valid options are: "+JSON.stringify(Object.keys(e.defaultsMultiplexerOptions)));var s=a({},e.defaultsMultiplexerOptions,n);this.impl=new A(t,s)},e.Multiplexer.prototype.sendBinary=function(t,e){this.impl.sendMessage(t,e)},e.Multiplexer.prototype.sendText=function(t,e){this.impl.sendMessage(t,e+"")},e.Multiplexer.prototype.sendBinaryWithInterrupt=function(t,e,n){this.impl.sendMessageWithInterrupt(t,e,n)},e.Multiplexer.prototype.sendTextWithInterrupt=function(t,e,n){this.impl.sendMessageWithInterrupt(t,e+"",n)},e.Multiplexer.prototype.close=function(){this.impl.join(),this.impl.isClosed=!0};var A=function(t,e){this.node=t,this.results=e,this.isClosed=!1,this.canJoin=!1};function P(t){return"number"==typeof t?t={low:t,high:0}:void 0!==t&&t.hasOwnProperty("low")||(t={low:0,high:0}),t}A.prototype.sendMessage=function(t,e,n){if(!this.isClosed){T(t,this.node);var i=this.node.impl.handlers.push(new B(this,t))-1;void 0!==n&&(n.id=i,n.to=t),t.impl.sendMessage(e,o.resultsSend,i)}},A.prototype.sendMessageWithInterrupt=function(t,e,n){-1===n.id&&this.sendMessage(t,e,n)},A.prototype.join=function(){this.canJoin&&(this.results.join(),this.canJoin=!1)},e.Store=function(t,n){for(var i in n=n||{})if(n.hasOwnProperty(i)&&!e.defaultsStoreOptions.hasOwnProperty(i))throw new Error("Unknown EK.Store option named '"+i+"'. Valid options are: "+JSON.stringify(Object.keys(e.defaultsStoreOptions)));h(n);var s=a({},e.defaultsStoreOptions,n);s.onBinary=function(t){var n=new e.BinaryReader(t),i=n.getSize();if(i&&n.readUint8()===r.NotifyObserverFromWeb)!function(t,e){var n=[],i=e.readUint32();if(void 0!==t.observedSnapshots[i]){for(t.observedSnapshots[i].snapshot.timeStamp=e.readUint64();e.tell()<e.getSize();){var s=n[n.length]={low:e.readUint32(),high:e.readUint32()},o=e.readInt64();t.observedSnapshots[i].snapshot.keys[s.high][s.low]=e.readArrayBuffer(o)}t.observedSnapshots[i].callback(t.observedSnapshots[i].snapshot,n)}}(this,n);else{var s=t.slice(i?1:0);this.callbacks.pop()(s)}}.bind(this),this.onMessage=function(t){return function(e){return("string"==typeof e?s.onText:s.onBinary)(e,t)}},this.onMessageResultsEnd=function(){return function(){}},this.observedSnapshots={},this.observedCounter=0,this.callbacks=[],this.impl=new H(s,(n.distant?"ek.distant.store.":"ek.local.store.")+t),this.impl.onMessage=this.onMessage.bind(this),this.impl.onMessageResultsEnd=this.onMessageResultsEnd.bind(this);var u=new R(this,"ek.store."+t);this.master=u.select(e.Criterion.preferMyHypervisor());var c=new e.BinaryWriter(1);c.writeUint8(r.StoreNodeDisconnectFromWeb),this.master.impl.sendMessage(c.createArrayBuffer(),o.onDisconnect);var p=new e.BinaryWriter(1);p.writeUint8(r.GetLocalMasterIdentifierFromWeb),this.master.impl.sendMessage(p.createArrayBuffer()),this.callbacks.unshift(function(t){var n=new e.BinaryReader(t);return this.port=n.readUint32(),this.hostname=n.readString(),!0}.bind(this))},e.Store.prototype.get=function(t,n){var i=new e.BinaryWriter(9);i.writeUint8(r.GetFromWeb);var s=P(t);return i.writeUint32(s.low),i.writeUint32(s.high),this.master.impl.sendMessage(i.createArrayBuffer()),this.callbacks.unshift(n),this},e.Store.prototype.put=function(t,n){var i=P(t);n=U(n);var s=new e.BinaryWriter(17+n.byteLength);return s.writeUint8(r.PutFromWeb),s.writeUint32(i.low),s.writeUint32(i.high),s.writeUint64(n.byteLength),s.writeUint8Array(n),this.master.impl.sendMessage(s.createArrayBuffer()),this},e.Store.prototype.del=function(t){var n=P(t),i=new e.BinaryWriter(17);return i.writeUint8(r.PutFromWeb),i.writeUint32(n.low),i.writeUint32(n.high),i.writeInt64(-1),this.master.impl.sendMessage(i.createArrayBuffer()),this};var N=function(t){for(var n=[],i=new e.BinaryReader(t),s=i.readUint64(),o=0;o<s;++o)n[o]={low:i.readUint32(),high:i.readUint32()};return n};e.Store.prototype.createKeys=function(t,n,i){var s=[];"string"==typeof i&&s.push(i);var o=new e.BinaryWriter(9);return o.writeUint8(r.CreateKeysFromWeb),o.writeUint64(t),o.writeUint64(s.length),o.writeStrings(s),this.master.impl.sendMessage(o.createArrayBuffer()),this.callbacks.unshift(function(t){var e=N(t);return n(e)}),this},e.Store.prototype.readKeys=function(t,n){var i=new e.BinaryWriter(1);i.writeUint8(r.ReadKeysFromWeb);var s=U(t);return i.writeUint8Array(s),this.master.impl.sendMessage(i.createArrayBuffer()),this.callbacks.unshift(function(t){var e=N(t);return n(e)}),this};var F,L=function(t,n,i){var s=new e.BinaryReader(i);this.store=t,this.keys={};for(var o=0;o<n.length;++o)void 0===this.keys[n[o].high]&&(this.keys[n[o].high]={}),this.keys[n[o].high][n[o].low]=void 0;for(this.fullSnapshot=s.readBool(),this.timeStamp=s.readUint64();s.tell()<i.byteLength;){var r={low:s.readUint32(),high:s.readUint32()},a=s.readInt64();void 0===this.keys[r.high]&&(this.keys[r.high]={}),this.keys[r.high][r.low]=s.readArrayBuffer(a)}};function q(t){var e={_:"graph"};t.options.cpu&&(e.cpu=!0),t.options.cpuLoad&&(e.cpuLoad=!0),t.options.ram&&(e.ram=!0),t.options.network&&(e.network=!0),t.lastRequest=Date.now(),t.timeout=void 0,t.ws.sendMessage(JSON.stringify(e))}return L.prototype.get=function(t){var e=P(t);return this.keys[e.high][e.low]?this.keys[e.high][e.low]:new ArrayBuffer(0)},e.Store.prototype.createSnapshot=function(t,n){var i,s=9+8*(n=n||[]).length,o=new e.BinaryWriter(s);o.writeUint8(r.SnapshotFromWeb),o.writeUint64(n.length);for(var a=0;a<n.length;++a)i=P(n[a]),o.writeUint32(i.low),o.writeUint32(i.high);this.master.impl.sendMessage(o.createArrayBuffer());var h=this;return this.callbacks.unshift(function(e){return t(new L(h,n,e))}),this},L.prototype.last=function(t){var n,i,s=0;for(n in this.keys){if(this.keys.hasOwnProperty(n))s+=Object.keys(this.keys[n]).length}var o=17+8*s,a=new e.BinaryWriter(o);for(n in a.writeUint8(r.LastSnapshotFromWeb),a.writeUint64(this.timeStamp),a.writeUint64(s),this.keys)if(this.keys.hasOwnProperty(n))for(i in this.keys[n])this.keys[n].hasOwnProperty(i)&&(a.writeUint32(i),a.writeUint32(n));this.store.master.impl.sendMessage(a.createArrayBuffer());var h=this;return this.store.callbacks.unshift(function(n){var i=function(t,n){var i=[],s=new e.BinaryReader(n);for(t.timeStamp=s.readUint64();s.tell()<n.byteLength;){var o=i[i.length]={low:s.readUint32(),high:s.readUint32()},r=s.readInt64();t.keys[o.high][o.low]=s.readArrayBuffer(r)}return i}(h,n);return t(h,i)}),this},L.prototype.createObserver=function(t,n){var i,s,o=0;for(i in this.keys){if(this.keys.hasOwnProperty(i))o+=Object.keys(this.keys[i]).length}var a=17+8*o,h=new e.BinaryWriter(a);for(i in h.writeUint8(r.CreateObserverFromWeb),h.writeBool(this.fullSnapshot),h.writeUint32(this.store.observedCounter),h.writeUint64(this.timeStamp),h.writeDouble(n),h.writeUint64(o),this.keys)if(this.keys.hasOwnProperty(i))for(s in this.keys[i])this.keys[i].hasOwnProperty(s)&&(h.writeUint32(s),h.writeUint32(i));return this.store.observedSnapshots[this.store.observedCounter]={snapshot:this,callback:t},this.store.observedCounter++,this.store.master.impl.sendMessage(h.createArrayBuffer()),this},L.prototype.deleteObserver=function(){var t=new e.BinaryWriter(5);t.writeUint8(r.DeleteObserverFromWeb);for(var n=0;n<this.store.observedCounter;++n)if(void 0!==this.store.observedSnapshots[n]&&this.store.observedSnapshots[n].snapshot===this){t.writeUint32(n),this.store.observedSnapshots[n]=void 0,this.store.master.impl.sendMessage(t.createArrayBuffer());break}return this},e.Batch=function(t){this.commands={},this.store=t},e.Batch.prototype.put=function(t,e){var n=P(t);return e=U(e),void 0===this.commands[n.high]&&(this.commands[n.high]={}),this.commands[n.high][n.low]={size:e.byteLength,binary:e},this},e.Batch.prototype.del=function(t){var e=P(t);return void 0===this.commands[e.high]&&(this.commands[e.high]={}),this.commands[e.high][e.low]={size:-1},this},e.Batch.prototype.commit=function(){var t,n,i,s=5,o=0;for(n in this.commands)if(this.commands.hasOwnProperty(n))for(i in this.commands[n])this.commands[n].hasOwnProperty(i)&&(o++,s+=16,-1!==(t=this.commands[n][i]).size&&(s+=t.size));var a=new e.BinaryWriter(s);for(n in a.writeUint8(r.CommitFromWeb),a.writeUint32(o),this.commands)if(this.commands.hasOwnProperty(n))for(i in this.commands[n])if(this.commands[n].hasOwnProperty(i)){t=this.commands[n][i];var h=new e.BinaryWriter(16);h.writeUint32(i),h.writeUint32(n),h.writeInt64(t.size),a.writeUint8Array(new Uint8Array(h.arrayBuffer)),-1!==t.size&&a.writeUint8Array(t.binary)}return this.store.master.impl.sendMessage(a.createArrayBuffer()),this},e.defaultsMonitorCallbacks=Object.freeze({onConnect:function(){},onDisconnect:function(){},onHypervisorAdd:function(){},onHypervisorUpdate:function(){},onHypervisorUnresponsive:function(){},onHypervisorDelete:function(){}}),e.defaultsMonitorOptions=Object.freeze({cpu:!1,cpuLoad:!1,ram:!1,network:!1,probes:!1,refreshIntervalInMilliseconds:1e3}),e.Monitor=function(t,n,s){void 0===F&&(F=new WeakMap);var o={};F.set(this,o),o.callbacks=a({},e.defaultsMonitorCallbacks,n),o.options=a({},e.defaultsMonitorOptions,s),o.ws=new e.WebSocket,o.ws.onOpen(o.callbacks.onConnect),o.ws.onClose(o.callbacks.onDisconnect),o.ws.onMessage(function(t){var n={revision:(t=JSON.parse(t)).revision};this.options.cpu&&(n.cpu=t.cpu),this.options.cpuLoad&&(n.cpuLoad=t.cpuLoad),this.options.ram&&(n.currentMemory=t.currentMemory,n.estimatedMemory=t.totalMemory-t.availableMemory,n.totalMemory=t.totalMemory,n.ram=100*n.currentMemory/n.totalMemory),this.options.probes&&(n.probes=t.probes),this.options.network&&(n.network=t.network);var i=!this.hypervisors.has(t.id);if(this.hypervisors.add(t.id),this.current.add(t.id),0===t.id&&(t.links=t.links||[],t.links.forEach(function(t){this.hypervisors.has(t.id)||(this.callbacks.onHypervisorAdd(t.id,t.hostname+":"+t.port),this.hypervisors.add(t.id))},this),this.current.forEach(function(t){this.hypervisors.delete(t)},this),this.hypervisors.forEach(function(e){0!==t.links.filter(function(t){return t.id===e}).length?(this.callbacks.onHypervisorUnresponsive(e),this.current.add(e)):this.callbacks.onHypervisorDelete(e)},this),this.hypervisors=this.current,this.current=new Set),i&&this.callbacks.onHypervisorAdd(t.id,t.hostname+":"+t.port),this.callbacks.onHypervisorUpdate(t.id,n),0===t.id&&this.running){var s=Math.max(this.lastRequest+this.options.refreshIntervalInMilliseconds-Date.now(),0);this.timeout=e.window.setTimeout(q,s,this)}}.bind(o)),o.ws.connect(t,{hypervisorId:0,id:i.hypervisor}),o.hypervisors=new Set,o.current=new Set,o.running=!0,o.lastRequest=0,o.timeout=void 0,q(o)},e.Monitor.prototype.pause=function(){var t=F.get(this);clearTimeout(t.timeout),t.running=!1,t.timeout=void 0},e.Monitor.prototype.resume=function(){var t=F.get(this),e=!t.running;t.running=!0,e&&void 0===t.timeout&&q(t)},e.Monitor.prototype.updateOptions=function(t){var n=F.get(this);if(n.options=a(n.options,t),n.running&&void 0!==n.timeout){clearTimeout(n.timeout);var i=Math.max(n.lastRequest+n.options.refreshIntervalInMilliseconds-Date.now(),0);n.timeout=e.window.setTimeout(q,i,n)}},e.Monitor.prototype.disconnect=function(){F.get(this).ws.close()},Object.keys(t).forEach(function(n){e[n]=t[n]}),e}()});