if(define("DS/AfrCS/Private_AfrCS",["DS/Core/Core","DS/CSICommandBinder/CSICommandBinder","DS/CoreUtilities/ErrorManagement"],function(e,r,t){"use strict";var n,i,o,s,a,d,c=[],u=[],l=function(){t.getDebugMode()?(e.enableWUXConsole(),n=WUX.getWUXConsole()?WUX.getWUXConsole():console):n=console,n.log("Client has lost connection with server");var r=0;for(r=0;r<c.length;r++){var i=c[r].serverLostCallback,o=c[r].callbackObject;i.call(o)}},S=-1,C=0,f=1,_=2,E=3,v=4,p=5,g=6,m=7,h=8,O=11,A=[t.generateReturnValue("REQUEST_PUT_IN_QUEUE",!0),t.generateReturnValue("SERVER_LOCKED_BY_ANOTHER_CMD",!1),t.generateReturnValue("SERVER_NOT_LOCKED_FOR_CMD",!1),t.generateReturnValue("CMD_DID_NOT_DECLARE_SERVER_CALLS",!1),t.generateReturnValue("NO_CMD_TO_CANCEL",!1),t.generateReturnValue("NO_OPERATION_TO_CANCEL",!1),t.generateReturnValue("REQUEST_COULD_NOT_BE_SENT",!1),t.generateReturnValue("NO_CMD_LOCKING_SERVER_TO_END_OR_CANCEL",!1),t.generateReturnValue("CANNOT_CALL_OPERATION_FROM_APPLICATIVE_CB",!1),t.generateReturnValue("INVALID_MSG",!1),t.generateReturnValue("CONNECTION_FAILED",!1),t.generateReturnValue("UNTYPED_ERROR",!1)],N=function(e){var r=e.readStringArray("domainNames");i&&r instanceof Array&&(e.writeStringArray("domainNames",r.reverse()),i.callDomains(e))},R={INTERNAL_AFR_CALL:S,START_COMMAND:C,STOP_COMMAND:f,CANCEL_COMMAND:_,CANCEL_OPERATION:E,EXECUTE_OPERATION:v,EXECUTE_FUNCTION:O,BEGIN_OPERATION:p,DO_OPERATION:g,END_OPERATION:m,EXECUTE_READ_ONLY_OPERATION:h,csErrorManager:t.getErrorManager(A,{merge:!0}),returnSpecificValue:function(e,r){return e?t.createReturnObject(e,{description:r}):t.createReturnObject(this.csErrorManager.MISSING_PARAMETERS,{description:"Need a value to return. Parameters are value, description"})},setClientNode:function(e){return void 0!==o?R.returnSpecificValue(R.csErrorManager.FAILED,"Client node has already been set ( it will be allowed to modified it in futur development ) : "+e):void 0!==e?(o=e,R.returnSpecificValue(R.csErrorManager.SUCCEEDED,"Client node has been successfully set to : "+e)):R.returnSpecificValue(R.csErrorManager.WRONG_PARAMETERS,"Input parameter iNode is undefined or has the wrong type")},setServerNodeId:function(e){return void 0!==s?R.returnSpecificValue(R.csErrorManager.FAILED,"Client node Id has already been set ( it will be allowed to modified it in futur development ) : "+e):void 0!==e?(s=e,R.returnSpecificValue(R.csErrorManager.SUCCEEDED,"Client node Id has been successfully set to : "+e)):R.returnSpecificValue(R.csErrorManager.WRONG_PARAMETERS,"Input parameter iNodeId is undefined or has the wrong type")},isServerConnected:function(){return!(!o||!s)},registerAnswerCallback:function(e){return e?e.callback?e.domain?((i=r.getDefaultResponse()).onAnswerDomain(e.domain,e.callback),this.returnSpecificValue(this.csErrorManager.SUCCEEDED,"")):this.returnSpecificValue(this.csErrorManager.MISSING_PARAMETERS,"No domain specified"):this.returnSpecificValue(this.csErrorManager.MISSING_PARAMETERS,"No callback specified"):this.returnSpecificValue(this.csErrorManager.MISSING_PARAMETERS,"No parameters specified")},callReadOnlyCB:function(e){var r=u.shift();r&&r.call(void 0,e)},_sendReadOnlyRequest:function(e){return u.push(e.callback),this._sendRequest(e)},_sendRequest:function(e){var n,i=this.returnSpecificValue(this.csErrorManager.SUCCEEDED,"Message was successfully sent.");if(void 0===o)return i=this.returnSpecificValue(this.csErrorManager.CONNECTION_FAILED,"No browser node to send the request with."),t.logResult(i),{result:i,request:n};if(void 0===e.currentRequest&&(e.msg===this.DO_OPERATION||e.msg===this.END_OPERATION||e.msg===this.CANCEL_OPERATION||e.msg===this.STOP_OPERATION))return console.error("Private_AfrCS._sendRequest No current iterative request but asked to send a specific iterative message"),console.trace(),{result:i=this.returnSpecificValue(this.csErrorManager.REQUEST_COULD_NOT_BE_SENT,"No current iterative request but asked to send a specific iterative message : "+e.msg),request:n};if(e.currentRequest)n=e.currentRequest;else if(void 0===e.destinationPool&&(e.destinationPool=d),s||(s=o.select(e.destinationPool)),e.msg!==this.EXECUTE_FUNCTION){var a={destinationNodeId:s,command:e.operation,version:e.version,onComplete:N};n=e.msg===this.BEGIN_OPERATION||e.msg===this.START_COMMAND?o.createIterativeRequest(a):o.createRequest(a)}if(!n&&e.msg!==this.EXECUTE_FUNCTION)throw new Error("Private_AfrCS request undefined in _sendRequest");var c=new r.Parameters;e.msg===this.CANCEL_OPERATION&&((c=new r.Parameters).writeBool("isCanceled",!0),c.declareAsObject("AfrParameters"));if(e.msg>=3&&(void 0===e.inputs&&(e.inputs=new r.Parameters),e.inputs.writeInt32("msg",e.msg)),e.msg===this.EXECUTE_FUNCTION){var u={destinationNodeId:s,name:e.operation,version:e.version,onSuccess:N,onProgress:e.onProgress,onError:e.onError,parameters:e.inputs};o.call(u)}else e.msg===this.BEGIN_OPERATION||e.msg===this.START_COMMAND?n.begin(e.inputs):e.msg===this.DO_OPERATION?n.send(e.inputs):e.msg===this.END_OPERATION||e.msg===this.CANCEL_OPERATION||e.msg===this.STOP_COMMAND?n.end(e.inputs):n.send(null,e.inputs,null);return e.killRequestAfterSend&&(n=void 0),{result:i,request:n}},_reset:function(){o=void 0,s=void 0,i=void 0},getNode:function(){return o},setDefaultClientNodeId:function(e){return void 0!==o?R.returnSpecificValue(R.csErrorManager.FAILED,"Default client node id has already been set ( it will be allowed to modified it in futur development ) : "+e):void 0!==e?(o=e,R.returnSpecificValue(R.csErrorManager.SUCCEEDED,"Default client node id has been successfully set to : "+e)):R.returnSpecificValue(R.csErrorManager.WRONG_PARAMETERS,"NodeId is undefined or has the wrong type")},setDefaultServerPoolId:function(e){return void 0!==d?R.returnSpecificValue(R.csErrorManager.FAILED,"Default server pool id has already been set ( it will be allowed to modified it in futur development ) : "+e):void 0!==e&&"string"==typeof e?(d=e,R.returnSpecificValue(R.csErrorManager.SUCCEEDED,"Default server pool id has been successfully set to : "+e)):R.returnSpecificValue(R.csErrorManager.WRONG_PARAMETERS,"Default server pool id is undefined or has the wrong type")},initConnection:function(e){if(!e)return this.returnSpecificValue(this.csErrorManager.MISSING_PARAMETERS,"No parameters specified. Connection to 3DCSServer couldn't be established ");if(void 0!==o)return this.returnSpecificValue(this.csErrorManager.UNTYPED_ERROR,"Connection already established.");if(void 0!==d)return this.returnSpecificValue(this.csErrorManager.UNTYPED_ERROR,"Connection already established.");var t;t=e.hypervisorUrl?{hypervisorUrl:e.hypervisorUrl,onHypervisorDisconnect:l}:{hypervisorIp:e.hypervisorIp,webSocketPort:e.webSocketPort,onHypervisorDisconnect:l},void 0!==e.ssl&&(t.ssl=e.ssl),d=e.destinationPool,a="application.webWidget";var n=r.getPool(a);if(void 0===n)return this.returnSpecificValue(this.csErrorManager.CONNECTION_FAILED,"Couldn't create or retrieve the pool "+a+".");if(void 0===(o=n.createNode(t)))return this.returnSpecificValue(this.csErrorManager.CONNECTION_FAILED,"Node creation on pool "+a+" failed.");for(var i=0;e.closingCallbacks.length>0&&i<e.closingCallbacks.length;){var s={serverLostCallback:e.closingCallbacks[i],callbackObject:e.closingCallbacksObj[i]};-1===c.indexOf(s)&&c.push(s),i++}return this.returnSpecificValue(this.csErrorManager.SUCCEEDED,"")}};return R}),define("DS/AfrCS/Private_AfrCSController",["DS/Core/Core","DS/AfrCS/Private_AfrCS","DS/CSICommandBinder/CSICommandBinder","DS/CoreUtilities/ErrorManagement"],function(e,r,t,n){"use strict";return{INTERNAL_AFR_CALL:r.INTERNAL_AFR_CALL,START_COMMAND:r.START_COMMAND,STOP_COMMAND:r.STOP_COMMAND,CANCEL_COMMAND:r.CANCEL_COMMAND,CANCEL_OPERATION:r.CANCEL_OPERATION,EXECUTE_OPERATION:r.EXECUTE_OPERATION,EXECUTE_FUNCTION:r.EXECUTE_FUNCTION,BEGIN_OPERATION:r.BEGIN_OPERATION,DO_OPERATION:r.DO_OPERATION,END_OPERATION:r.END_OPERATION,_appCallback:void 0,_callbackObj:void 0,_callbackArgs:void 0,_waitingMessages:[],_request:void 0,_requestOperation:void 0,_startStopCmdRequest:void 0,_cmdLockingServer:void 0,_stackedMessagesBeingTreated:!1,_waitingForServerAnwser:!1,_sendOnlyLastIteration:!1,_cancellingCmd:!1,_cmdToCancel:[],_requestUnstackingPaused:!0,_reset:function(){this._appCallback=void 0,this._callbackObj=void 0,this._callbackArgs=void 0,this._waitingMessages=[],this._request=void 0,this._requestOperation=void 0,this._startStopCmdRequest=void 0,this._cmdLockingServer=void 0,this._stackedMessagesBeingTreated=!1,this._waitingForServerAnwser=!1,this._sendOnlyLastIteration=!1,this._cancellingCmd=!1,this._cmdToCancel=[],this._requestUnstackingPaused=!0},isServerConnected:function(){return r.isServerConnected()},getAppCallback:function(){return this._appCallback},getCallbackObj:function(){return this._callbackObj},getCallbackArgs:function(){return this._callbackArgs},resetCallback:function(){this._appCallback=void 0,this._callbackObj=void 0,this._callbackArgs=void 0},returnValueRequestPutQueue:function(e){var t="The request [operation: "+e.operation+", msg : "+e.msg;return e.from&&(t+=", from : "+e.from.getId()),t+="] has been put in queue",r.returnSpecificValue(r.csErrorManager.REQUEST_PUT_IN_QUEUE,t)},isServiceRunning:function(){return void 0!==this._request},getCurrentRequestService:function(){return this._requestOperation},_isCommandUsingServer:function(){return void 0!==this._cmdLockingServer},_getCommandLockingServer:function(){return this._cmdLockingServer},_lockServer:function(e){if(void 0!==this._cmdLockingServer)return r.returnSpecificValue(r.csErrorManager.SERVER_LOCKED_BY_ANOTHER_CMD,"Cannot lock the server for command "+e.getCSIdentifier()+". Another command is already locking the server");this._cmdLockingServer=e},_unlockServer:function(){if(void 0===this._cmdLockingServer)return r.returnSpecificValue(r.csErrorManager.NO_CMD_LOCKING_SERVER_TO_END_OR_CANCEL,"No command lock to remove on the server juste after sending a stop message.");this._cmdLockingServer=void 0},_addCmdToCancel:function(e){this._cmdToCancel.push(e)},_removeCmdToCancel:function(e){var r=this._cmdToCancel.indexOf(e);r>-1&&this._cmdToCancel.splice(r,1)},isCancellingCmd:function(){return this._cancellingCmd},_setCancellingCmd:function(){this._cancellingCmd=!0},_unsetCancellingCmd:function(){this._cancellingCmd=!1},isServerWorking:function(){return!!this._waitingForServerAnwser},_unsetServerWorking:function(){this._waitingForServerAnwser=!1},_setServerWorking:function(){this._waitingForServerAnwser=!0},_isCurrentServiceToCancel:function(){var e=this.getCurrentRequestService();return!!(e&&this._waitingMessages[0].msg>this.CANCEL_OPERATION&&e!==this._waitingMessages[0].operation)},_keepOnlyCurrentServiceLastDoRequest:function(){var e=this.getCurrentRequestService();if(e){for(var r=0;r<this._waitingMessages.length&&(!this._waitingMessages[r]||this._waitingMessages[r].msg===this.DO_OPERATION&&this._waitingMessages[r].operation===e);)r++;this._waitingMessages.splice(0,r-1)}},addMessageInStack:function(e){return e.atBeginning&&!0===e.atBeginning?this._waitingMessages.unshift(e.request):this._waitingMessages.push(e.request),!0===this._requestUnstackingPaused?this._sendNextMessages():this.returnValueRequestPutQueue(e.request)},_sendNextMessages:function(){var e=null,i=null;for((this.isServerWorking()||0===this._waitingMessages.length)&&(this._requestUnstackingPaused=!0);!this.isServerWorking()&&this._waitingMessages.length>0;){if(this._requestUnstackingPaused=!1,!0===this.isCancellingCmd()){if(this._waitingMessages[0].msg!==this.CANCEL_OPERATION&&this._waitingMessages[0].msg!==this.STOP_COMMAND){this._requestUnstackingPaused=!0;break}}else this._waitingMessages[0].msg!==this.CANCEL_OPERATION&&this._waitingMessages[0].msg!==this.STOP_COMMAND||0!==this._cmdToCancel.indexOf(this._waitingMessages[0].from.getCSIdentifier())||this._setCancellingCmd();if(this._isCurrentServiceToCancel()&&(i=this._cancelCurrentService(this._waitingMessages[0].from),n.hasSucceeded(i)||n.logResult(i)),!0===this._sendOnlyLastIteration&&this._waitingMessages[0].msg===this.DO_OPERATION&&this._keepOnlyCurrentServiceLastDoRequest(),e=this._waitingMessages.shift(),i=this._checksBeforeSendRequest(e),n.hasSucceeded(i)){var o=void 0;this._request&&e.msg===this.INTERNAL_AFR_CALL&&(o=this._request,this._request=void 0),this._setServerWorking(),e.msg===this.STOP_COMMAND&&(this._request=this._startStopCmdRequest,this._startStopCmdRequest=void 0),this._request&&(e.currentRequest=this._request);var s=r._sendRequest(e);if(i=s.result,!n.hasSucceeded(i))return this._unlockServer(),this._unsetServerWorking(),0===this._waitingMessages.length&&(this._requestUnstackingPaused=!0),i;var a=s.request;if(this._request=a,e.msg===this.START_COMMAND?(this._startStopCmdRequest=this._request,this._request=void 0):void 0!==o?(this._request,this._request=o):void 0===this._request?this._requestOperation=void 0:this._requestOperation=e.operation,e.msg===this.STOP_COMMAND){this._unsetServerWorking();var d=this._getCommandLockingServer();this._unlockServer(),this.isCancellingCmd()&&(this._removeCmdToCancel(d.getCSIdentifier()),this._unsetCancellingCmd()),d.onCmdEnded(),0===this._waitingMessages.length&&(this._requestUnstackingPaused=!0)}else{if(e.msg!==this.START_COMMAND)break;this._unsetServerWorking(),0===this._waitingMessages.length&&(this._requestUnstackingPaused=!0)}}else{if(this.getAppCallback()){var c=new t.Parameters;c.writeInt32("AfrErrCode",2),this.getAppCallback().call(this.getCallbackObj(),c),this.resetCallback()}i=r.returnSpecificValue(r.csErrorManager.REQUEST_COULD_NOT_BE_SENT,"PrivateAfrCS._sendRequest couldn't send message ")}}return i},_checksBeforeSendRequest:function(e){return e.msg===this.START_COMMAND&&this._lockServer(e.from),e.msg===this.BEGIN_OPERATION&&(!0===e.sendOnlyLastIteration?this._sendOnlyLastIteration=!0:this._sendOnlyLastIteration=!1),e.callback?(this._appCallback=e.callback,this._callbackObj=e.from,this._callbackArgs=e.callbackArgs):this.resetCallback(),this._request||e.msg!==this.DO_OPERATION&&e.msg!==this.END_OPERATION&&e.msg!==this.CANCEL_OPERATION?r.returnSpecificValue(r.csErrorManager.SUCCEEDED,"Request ready to be sent"):r.returnSpecificValue(r.csErrorManager.REQUEST_COULD_NOT_BE_SENT,"Trying to send a DO, END or CANCEL message on a operation which doesn't exist or has been killed ")},callInternalService:function(e){return e&&e.operation?(e.version||(e.version=1),e.msg=-1,e.killRequestAfterSend=!0,this.addMessageInStack({request:e,atBeginning:!0})):r.returnSpecificValue(r.csErrorManager.MISSING_PARAMETERS,"PrivateAfrController.callInternalService expect an literal object as input parameters with a defined parameters.operation")},callReadOnlyOperation:function(e){return e.msg=r.EXECUTE_READ_ONLY_OPERATION,e.killRequestAfterSend=!0,void 0===e.version&&(e.version=1),r._sendReadOnlyRequest(e)},_cancelCurrentService:function(){if(!this.isServiceRunning())return r.returnSpecificValue(r.csErrorManager.NO_OPERATION_TO_CANCEL,"There is no current operation to cancel.");var e={};return e.from=this._getCommandLockingServer(),e.msg=this.CANCEL_OPERATION,e.killRequestAfterSend=!0,this.addMessageInStack({request:e,atBeginning:!0})},interruptCurrentOperation:function(){void 0!==this._request&&void 0!==typeof this._request.interrupt&&(this._waitingMessages=[],this._request.interrupt())}}}),this.WAfrStandardComponentKey){var undoRedoManager="DS/WAfrUndoRedoUI/Private_UndoRedoManager";define("DS/AfrCS/Private_UndoRedoCSServices",["DS/Core/Core","DS/Core/Events",undoRedoManager,"DS/AfrCS/Private_AfrCSController","DS/CSICommandBinder/CSICommandBinder","DS/CoreUtilities/ErrorManagement"],function(e,r,t,n,i,o){"use strict";var s,a=function(){o.getDebugMode()?(e.enableWUXConsole(),s=WUX.getWUXConsole()?WUX.getWUXConsole():console):s=console},d=t.getUndoRedoErrorManager(),c=function(e){var t=e.readInt32("serverUndoStepId");r.publish({event:"UNDO_SERVER_"+t+"/EXECUTED",data:void 0})},u=function(e){var t=e.readInt32("serverUndoStepId");r.publish({event:"REDO_SERVER_"+t+"/EXECUTED",data:void 0})},l=function(e,r){if(void 0===e)throw new Error("PrivateUndoRedoCSServices.isUndoStepServerId : Expects the server undo step server as input parameter.");if(!(e instanceof t.privateUndoStep))throw new Error("PrivateUndoRedoCSServices.isUndoStepServerId: Expects the server undo step server as input parameter.");return e.getServerUndoStepId()===r},S=function(e,r){if(void 0===e)throw new Error("PrivateUndoRedoCSServices.isOlderUndoStepServerThan : Expects the server undo step server as input parameter.");if(!(e instanceof t.privateUndoStep))throw new Error("PrivateUndoRedoCSServices.isOlderUndoStepServerThan: Expects the server undo step server as input parameter.");return e.getServerUndoStepId()<r},C={registerServerAction:function(e){var r=!1;e&&e.exclusiveUndo&&(r=!0);var n=new t.privateUndoStep({exclusivity:r,serverExclusivity:e.serverExclusivity,undoTitle:e.undoTitle,serverUndoStepId:e.serverUndoStepId,undoAction:function(e){var r=this.getRedoEnabled();e&&!r||C.sendUndoRequest({undoStep:this,redoEnabled:r})},undoData:e.serverExclusivity,doAction:function(){C.sendRedoRequest()}});return t.registerAction(n)},removeUndoWithServerId:function(e){var r=C.findUndoStepIdFromServerId(e);if(r>=0)return t._private._undoStack.removeStepWithId(r),o.createReturnObject(d.SUCCEEDED,{description:"PrivateUndoRedoCSServices.removeUndoWithServerId: server undo step with server Id : "+e+", was successfully removed."})},findUndoStepIdFromServerId:function(e){var r;if(void 0===e)throw new Error("PrivateUndoRedoCSServices.findUndoStepIdFromServerId: method expects the server undo step server Id as input parameter.");if("number"!=typeof e)throw new Error("PrivateUndoRedoCSServices.findUndoStepIdFromServerId: method expects the server undo step server Id of type nummber as input parameter.");return(r=t._private._undoStack.findStepIdFromPropertyValue({propertyGetter:l,propertyValue:e}))<0&&o.createReturnObject(d.MISSING_UNDO_STEP,{description:"PrivateUndoRedoCSServices.findUndoStepIdFromServerId: server undo step with server Id:"+e+", not found."}),r},findFirstUndoStepServerOlderThan:function(e){var r;if(void 0===e)throw new Error("PrivateUndoRedoCSServices.findFirstUndoStepServerOlderThan: method expects the server undo step server Id as input parameter.");if("number"!=typeof e)throw new Error("PrivateUndoRedoCSServices.findFirstUndoStepServerOlderThan: method expects the server undo step server Id of type nummber as input parameter.");return(r=t._private._undoStack.findStepIdFromPropertyValue({propertyGetter:S,propertyValue:e}))<0&&o.createReturnObject(d.MISSING_UNDO_STEP,{description:"PrivateUndoRedoCSServices.findFirstUndoStepServerOlderThan: server undo step with server Id:"+e+", not found."}),r},sendUndoRequest:function(e){var r={operation:"AfrUndoOperation"};void 0!==e&&void 0!==e.redoEnabled&&(void 0===r.inputs&&(r.inputs=new i.Parameters),r.inputs.writeBool("keepRedo",e.redoEnabled)),r.callbackArgs=e,n.callInternalService(r),o.getDebugMode()&&(a(),s.log("Undo operation call on server"))},sendRedoRequest:function(){n.callInternalService({operation:"AfrRedoOperation"}),o.getDebugMode()&&(a(),s.log("Redo operation call on server"))},getUndoServerCallback:function(){return c},getRedoServerCallback:function(){return u},flushUndoRedoStacks:function(){n.callInternalService({operation:"AfrFlushUndoRedoStacksOperation"}),t.flushStacks()},flushStacks:function(){t.flushStacks()},removeStepsFromServerId:function(e){t._private._undoStack.removeStepsFromId(e)},groupServerSteps:function(e,r){t._private._undoStack.groupSteps(e,r,t._private._executionContext)},setServerUndoRedoStacksCapacity:function(e){if(n.isServerConnected()){if(void 0===e||"number"!=typeof e||e<0)throw new Error("PrivateUndoRedoCSServices.setUndoRedoStackCapacity: method expects the stacks capacity (a number >= 0) to set as input parameter.");var r=new i.Parameters;r.writeInt32("stacksSize",e);var t={operation:"AfrChangeUndoRedoStacksSizeOperation",inputs:r};n.callInternalService(t)}},updateAvailability:function(){var e,r=t._private._undoStack.getSize(),n=t._private._redoStack.getSize();(e=t._private._executionContext.getComponent("AFR_AvailabilityModesComponent"))&&(0==r&&0==n?e.publish({mode:"WAFR_UNDO_REDO",value:"NO_UNDO_REDO"}):r>0&&0==n?e.publish({mode:"WAFR_UNDO_REDO",value:"UNDO_ONLY"}):n>0&&0==r?e.publish({mode:"WAFR_UNDO_REDO",value:"REDO_ONLY"}):e.publish({mode:"WAFR_UNDO_REDO",value:"UNDO_REDO"}))}};return r.subscribe({event:"WAfr_URCChanged"},C.setServerUndoRedoStacksCapacity),C})}else{var undoRedoManagerOld="DS/AfrUndoRedoUI/Private_UndoRedoCSServices";define("DS/AfrCS/Private_UndoRedoCSServices",[undoRedoManagerOld],function(e){"use strict";return e})}define("DS/AfrCS/FlushUndoRedoStacksCmd",["UWA/Core","UWA/Class","DS/AfrCS/Private_UndoRedoCSServices"],function(e,r,t){"use strict";return r.extend({init:function(){this._parent({ID:"FlushUndoRedoStacksCmd",mode:"undefined"})},beginExecute:function(){t.flushUndoRedoStacks()}})}),define("DS/AfrCS/Private_AfrCSInternalServices",["UWA/Core","DS/AfrCS/Private_AfrCS","DS/AfrCS/Private_AfrCSController","DS/AfrCS/Private_UndoRedoCSServices","DS/CoreUtilities/ErrorManagement","DS/CSICommandBinder/CSICommandBinder","DS/Core/Events"],function(e,r,t,n,i,o,s){"use strict";var a={_allowedCmds:[],EXECUTE_OPERATION:t.EXECUTE_OPERATION,EXECUTE_FUNCTION:t.EXECUTE_FUNCTION,BEGIN_OPERATION:t.BEGIN_OPERATION,DO_OPERATION:t.DO_OPERATION,END_OPERATION:t.END_OPERATION,setClientNode:function(e){var t=r.setClientNode(e);return i.hasSucceeded(t)&&(r.registerAnswerCallback({domain:"AfrUndo",callback:n.getUndoServerCallback()}),r.registerAnswerCallback({domain:"AfrRedo",callback:n.getRedoServerCallback()}),r.registerAnswerCallback({domain:"Afr",callback:this._afrCallback}),r.registerAnswerCallback({domain:"ReadOnlyOperation",callback:r.callReadOnlyCB})),t},_isCmdAllowedToCallServer:function(e,n){if(!e||void 0===e.getCSIdentifier())return r.returnSpecificValue(r.csErrorManager.MISSING_PARAMETERS,"No sending command (1st argument) specified for this request");if(!e.hasDecalredCS())return r.returnSpecificValue(r.csErrorManager.REQUEST_COULD_NOT_BE_SENT,"Command DID NOT specified it want to send request. Send forbiden.");if(void 0===n)return r.returnSpecificValue(r.csErrorManager.MISSING_PARAMETERS,"No message (2nd argument) specified for this request");if(n===t.START_COMMAND){if(void 0===t._getCommandLockingServer())return this._allowedCmds.push(e.getCSIdentifier()),r.returnSpecificValue(r.csErrorManager.SUCCEEDED,"Your command with instance number : '"+this._getCommandId(e.getCSIdentifier())+"' is allowed to call 3DCS server");var i=t._getCommandLockingServer();return this._allowedCmds.length<=1&&(i.isEnding()||i.isCanceled())?(this._allowedCmds.push(e.getCSIdentifier()),r.returnSpecificValue(r.csErrorManager.SUCCEEDED,"Your command with instance number : '"+this._getCommandId(e.getCSIdentifier())+"' is allowed to call 3DCS server")):r.returnSpecificValue(r.csErrorManager.SERVER_LOCKED_BY_ANOTHER_CMD,"Command with instance number"+t._getCommandLockingServer()._id+" is locking the server. \nYour command (with instance number : '"+this._getCommandId(e.getCSIdentifier())+"') cannot be executed for the moment.")}var o=this._allowedCmds.indexOf(e.getCSIdentifier());if(o>-1){if(n===t.STOP_COMMAND){this._allowedCmds.splice(o,1);e.getCSIdentifier()}return r.returnSpecificValue(r.csErrorManager.SUCCEEDED,"Your command with instance number : '"+this._getCommandId(e.getCSIdentifier())+"' is allowed to call 3DCS server")}return t._getCommandLockingServer()?t._getCommandLockingServer().getCSIdentifier()===e.getCSIdentifier()&&n===t.STOP_COMMAND?r.returnSpecificValue(r.csErrorManager.SUCCEEDED,"Your command with instance number : '"+this._getCommandId(e.getCSIdentifier())+"' is allowed to call 3DCS server"):r.returnSpecificValue(r.csErrorManager.SERVER_LOCKED_BY_ANOTHER_CMD,"Command with instance number"+t._getCommandLockingServer()._id+" is locking the server. \n Your command (with instance number"+this._getCommandId(e.getCSIdentifier())+") cannot be executed for the moment."):r.returnSpecificValue(r.csErrorManager.SERVER_NOT_LOCKED_FOR_CMD,"Command with instance number"+this._getCommandId(e.getCSIdentifier())+" has declared using compute server but startcommand has not locked the server for this command or the command is already ended.")},_checkCmdCallParameters:function(e){return e?e.from?void 0===e.from.getCSIdentifier()?r.returnSpecificValue(r.csErrorManager.WRONG_PARAMETERS,"Sender (paramters.from) has no CSIdentifier defined."):e.operation?void 0===e.msg?r.returnSpecificValue(r.csErrorManager.MISSING_PARAMETERS,"No message (paramters.msg) specified."):(void 0===e.version&&(e.version=1),r.returnSpecificValue(r.csErrorManager.SUCCEEDED,"")):r.returnSpecificValue(r.csErrorManager.MISSING_PARAMETERS,"No operation (paramters.operation) specified."):r.returnSpecificValue(r.csErrorManager.MISSING_PARAMETERS,"No sender (paramters.from) specified."):r.returnSpecificValue(r.csErrorManager.MISSING_PARAMETERS,"No parameters defined. Expect at lest object {from: sender, \noperation : server operation to call\nmsg: message to send to the server operation\ndestinationPool: server pool where the server operation is defined")},callOperation:function(e){e.operation||(console.warn("DEPRECATED","service input parameter in AfrCore.callOperation has been deprecated",'Use of an input parameter called "service" is deprecated. Specify the server operation to call in "operation".\n See afrCore.callOperation documentation'),e.operation=e.service);var r={from:e.from,inputs:e.inputs,operation:e.operation,version:e.version,msg:e.msg,sendOnlyLastIteration:e.sendOnlyLastIteration,destinationPool:e.destinationPool,callback:e.callback?e.callback:e.onSuccess,onProgress:e.onProgress,onError:e.onError},n=this._checkCmdCallParameters(r);if(!i.hasSucceeded(n))return n;var o=r.from,s=this._isCmdAllowedToCallServer(o,r.msg);return i.hasSucceeded(s)?(r.msg===a.EXECUTE_OPERATION||r.msg===a.END_OPERATION?r.killRequestAfterSend=!0:r.killRequestAfterSend=!1,t.addMessageInStack({request:r})):s},sendStartCommand:function(e){var n=t._getCommandLockingServer();if(void 0!==n&&n.getCSIdentifier()===e.from.getCSIdentifier())return r.returnSpecificValue(r.csErrorManager.REQUEST_COULD_NOT_BE_SENT,"Start command message already sent for the command with instance ID: "+e.from.getCSIdentifier());var s=e.from,a=this._isCmdAllowedToCallServer(s,t.START_COMMAND);return i.hasSucceeded(a)?(e.operation="AfrStartStopCommandOperation",e.version=1,e.msg=t.START_COMMAND,e.inputs=new o.Parameters,e.inputs.writeString("cmdId",e.from.getId()),t.addMessageInStack({request:e})):a},sendStopCommand:function(e){var r=this._isCmdAllowedToCallServer(e.from,t.STOP_COMMAND);return i.hasSucceeded(r)?(e.operation="AfrStartStopCommandOperation",e.version=1,e.msg=t.STOP_COMMAND,e.inputs=new o.Parameters,e.inputs.writeString("cmdId",e.from.getId()),e.killRequestAfterSend=!0,t.addMessageInStack({request:e})):r},cancelCommandService:function(e){if(void 0===e.from||void 0===e.from.getCSIdentifier())return r.returnSpecificValue(r.csErrorManager.NO_CMD_TO_CANCEL,"Command instance to canceled is undefined");var n=e.from.getCSIdentifier(),i=!1;t._getCommandLockingServer()&&t._getCommandLockingServer().getCSIdentifier()===n&&(i=!0,t._addCmdToCancel(n));for(var o=!0,s=0,a=0,d=t._waitingMessages.length;a<d&&o;)-1!==t._waitingMessages[s].msg&&t._waitingMessages[s].from.getCSIdentifier()===n?(t._waitingMessages[s].msg===t.STOP_COMMAND&&(o=!1),t._waitingMessages.splice(s,1)):s++,a++;return i?t._cancelCurrentService(e):r.returnSpecificValue(r.csErrorManager.NO_CMD_TO_CANCEL,"Command canceled is not using and locking the server")},_afrCallback:function(e){var r=e.readBool("stopCommand"),n=e.readBool("startCommand");if(!0!==r&&!0!==n){if(1===e.readInt32("AfrErrCode")){var o=e.readString("AfrErrMsg");if(!0===i.getDebugMode())throw new Error(o);console.error(o)}return a._synchronizeClientUndoStack(e),a.removeAfrServerParameters(e),t.getAppCallback()&&(t.getAppCallback().call(t.getCallbackObj(),e,t.getCallbackArgs()),t.resetCallback()),t._unsetServerWorking(),t._sendNextMessages()}},_synchronizeClientUndoStack:function(e){var r,t=e.readInt32("oldestServerUndoStep");t&&t>=1&&((r=n.findFirstUndoStepServerOlderThan(t))>0&&n.removeStepsFromServerId(r));t=void 0;var i=e.readInt32Array("undoStepsMerged");if(i&&i.length>0)for(var o=0;o<i.length;o++){var s=n.findUndoStepIdFromServerId(i[o]);s>-1&&((!t||t>s)&&(t=s),n.removeUndoWithServerId(i[o]))}var a=e.readInt32("undoStepCreated");if(void 0!==a&&a>-1){var d=e.readBool("isExclusiveServerUndo"),c=e.readString("undoTitle");if(n.registerServerAction({serverUndoStepId:a,undoTitle:c,serverExclusivity:d}),void 0!==t&&t>-1){var u=n.findUndoStepIdFromServerId(a);u>-1&&u>t&&n.groupServerSteps(u,t)}}},removeAfrServerParameters:function(e){e.removeProperty("oldestServerUndoStep"),e.removeProperty("undoStepCreated"),e.removeProperty("isExclusiveServerUndo"),e.removeProperty("undoStepsMerged"),e.removeProperty("undoTitle"),e.removeProperty("stopCommand")},onConnectionLost:function(e){this._reset(),t._reset(),r._reset(),s.publish({event:"COMMAND_MANAGER/Ending_Commands",data:e}),t._reset(),n.flushStacks()},_reset:function(){this._allowedCmds=[]},getNode:function(){return r.getNode()},setDefaultClientNodeId:function(e){var t=r.setDefaultClientNodeId(e);return i.hasSucceeded(t)&&(r.registerAnswerCallback({domain:"Afr",callback:this._afrCallback}),r.registerAnswerCallback({domain:"AfrUndo",callback:n.getUndoServerCallback()}),r.registerAnswerCallback({domain:"AfrRedo",callback:n.getRedoServerCallback()})),t},initConnection:function(e){var t=r.initConnection(e);return i.hasSucceeded(t)&&(r.registerAnswerCallback({domain:"Afr",callback:this._afrCallback}),r.registerAnswerCallback({domain:"AfrUndo",callback:n.getUndoServerCallback()}),r.registerAnswerCallback({domain:"AfrRedo",callback:n.getRedoServerCallback()})),t},_getCommandId:function(e){return"object"!=typeof e||null===e?e:"function"==typeof e.getId?e.getId():void 0}};return a}),define("DS/AfrCS/WAfrCSComponent",["DS/AfrCS/Private_AfrCSInternalServices","DS/AfrCS/Private_AfrCSController","DS/AfrCS/Private_UndoRedoCSServices"],function(e,r,t){"use strict";var n=function(){};return n.prototype.initialize=function(){return Promise.resolve()},n.prototype.clean=function(){return Promise.resolve()},n.prototype.setClientNode=function(r){if(!r)throw new Error("AfrCore.setClientNode takes the following input parameter: iNode (Object)");return e.setClientNode(r)},n.prototype.setServerNodeId=function(e){if(!e)throw new Error("AfrCore.setServerNodeId takes the following input parameter: iNodeId (Object)");return PrivateAfrCS.setServerNodeId(e)},n.prototype.callOperation=function(r){return e.callOperation(r)},n.prototype.callReadOnlyOperation=function(e){return r.callReadOnlyOperation(e)},n.prototype.interruptCurrentOperation=function(){return r.interruptCurrentOperation()},n.prototype.destroy=function(){return Promise.resolve()},n.prototype.sendStartCommand=function(r){return e.sendStartCommand(r)},n.prototype.sendStopCommand=function(r){return e.sendStopCommand(r)},n.prototype.cancelCommandService=function(r){return e.cancelCommandService(r)},n.prototype.flushUndoRedoStacks=function(){t.flushUndoRedoStacks()},n.prototype.ConcatenateUndoRedoStacks=function(e){if(void 0===e)throw new Error("WAfrConnectToComputeServer.prototype.ConcatenateUndoRedoStacks: method expects the server undo step server Id as input parameter.");var t=new CSICommandBinder.Parameters;t.writeString("operationId","ServerConcatenation"),t.writeInt32("FirstTransaction",e);var n={operation:"AfrConcatenateUROperation",version:1,killRequestAfterSend:!0,inputs:t};return r.addMessageInStack({request:n})},n.prototype.getExposedComponentCtor=function(){function r(){this.EXECUTE_OPERATION=e.EXECUTE_OPERATION,this.BEGIN_OPERATION=e.BEGIN_OPERATION,this.DO_OPERATION=e.DO_OPERATION,this.END_OPERATION=e.END_OPERATION,this.EXECUTE_FUNCTION=e.EXECUTE_FUNCTION}return r.prototype.flushUndoRedoStacks=this.flushUndoRedoStacks.bind(this),r.prototype.setClientNode=this.setClientNode.bind(this),r.prototype.setServerNodeId=this.setServerNodeId.bind(this),r.prototype.callOperation=this.callOperation.bind(this),r.prototype.callReadOnlyOperation=this.callReadOnlyOperation.bind(this),r.prototype.interruptCurrentOperation=this.interruptCurrentOperation.bind(this),r},n}),define("DS/AfrCS/Private_AfrCore",["DS/AfrCS/Private_AfrCSInternalServices"],function(e){"use strict";return{sendStartCommand:function(r){return e.sendStartCommand(r)},sendStopCommand:function(r){return e.sendStopCommand(r)},cancelCommandService:function(r){return e.cancelCommandService(r)}}}),define("DS/AfrCS/AfrCore",["DS/AfrCS/Private_AfrCSInternalServices","DS/AfrCS/Private_AfrCSController","DS/AfrCS/Private_AfrCS","DS/AfrCS/Private_AfrCore"],function(e,r,t,n){"use strict";if(window.__karma__){require(["DS/ApplicationFrame/CommandsManager"],function(e){e.privateAfrCore=n})}return{setClientNode:function(r){if(!r)throw new Error("AfrCore.setClientNode takes the following input parameter: iNode (Object)");return e.setClientNode(r)},setServerNodeId:function(e){if(!e)throw new Error("AfrCore.setServerNodeId takes the following input parameter: iNodeId (Object)");return t.setServerNodeId(e)},callOperation:function(r){return e.callOperation(r)},EXECUTE_OPERATION:e.EXECUTE_OPERATION,BEGIN_OPERATION:e.BEGIN_OPERATION,DO_OPERATION:e.DO_OPERATION,END_OPERATION:e.END_OPERATION,EXECUTE_FUNCTION:e.EXECUTE_FUNCTION,callReadOnlyOperation:function(e){return r.callReadOnlyOperation(e)},interruptCurrentOperation:function(){return r.interruptCurrentOperation()},onConnectionLost:function(r){return e.onConnectionLost(r)},isWaitingForServerAnswer:function(){return r.isServerWorking()},isOperationRunning:function(){return r.isServiceRunning()},allRequestsSent:function(){return 0===r._waitingMessages.length},getNode:function(){return e.getNode()},callService:function(r){return console.warn("AfrCore.callService is deprecated. Please use AfrCore.callOperation instead."),e.callOperation(r)},setDefaultClientNodeId:function(r){return console.warn("Deprecated","AfrCore.setDefaultClientNodeId has been deprecated","Please use AfrCore.setClientNode AND AfrCore.setServerNodeId to set up the necessary parameters to communicate with the compute server"),e.setDefaultClientNodeId(r)},setClientNodeId:function(e){if(console.warn("AfrCore.setClientNodeId best to use AfrCore.setServerNodeId "),!e)throw new Error("AfrCore.setClientNodeId takes the following input parameter: iNodeId (Object)");return t.setServerNodeId(e)},setDefaultServerPoolId:function(e){return console.warn("Deprecated","AfrCore.setDefaultServerPoolId has been deprecated","Please use AfrCore.setClientNode AND AfrCore.setServerNodeId to set up the necessary parameters to communicate with the compute server"),t.setDefaultServerPoolId(e)},returnValue:e.returnValue,EXECUTE_SERVICE:e.EXECUTE_OPERATION,BEGIN_SERVICE:e.BEGIN_OPERATION,DO_SERVICE:e.DO_OPERATION,END_SERVICE:e.END_OPERATION,initConnection:function(r){return r.closingCallbacks=[],r.closingCallbacksObj=[],r.closingCallbacks.push("flushStacks"),r.closingCallbacksObj.push(void 0),r.serverLostCallback&&(r.closingCallbacks.push(r.serverLostCallback),r.closingCallbacksObj.push(r.callbackObject)),console.warn("Deprecated","AfrCore.initConnection has been deprecated","Please use AfrCore.setDefaultClientNodeId or AfrCore.setDefaultServerPoolId to set up the necessary parameters to communicate"),e.initConnection(r)}}});