define("DS/XCityLoaders/ReloadSceneCommand",["DS/ApplicationFrame/Command","DS/AfrCS/AfrCore","DS/CSICommandBinder/CSICommandBinder","DS/CoreUtilities/ErrorManagement"],function(e,t,i,a){"use strict";return e.extend({init:function(){this._parent({mode:"exclusive",isAsynchronous:!1,doServerCall:!0}),this._frameWindow=this.getFrameWindow(),this._frameWindow&&this._frameWindow.getCSIManager&&this._frameWindow.getCSIManager()&&this._frameWindow.getCSIManager()._impl&&this._frameWindow.getCSIManager()._impl.getModel&&(this._clientModel=this._frameWindow.getCSIManager()._impl.getModel()),this.onModeleRemoveFromServer=function(){}},beginExecute:function(){if(this._clientModel){this._clientModel.clear();var e={from:this,operation:"CSISceneTest_CommandAfr_Clear",version:1,msg:t.EXECUTE_OPERATION,callback:this._commandCB.bind(this)},i=t.callOperation(e);return a.hasSucceeded(i)||(a.logResult(i),console.log("CSISceneTest_CommandAfr_Reload callOperation call EXECUTE_OPERATION FAILED with code : "+i)),this._parent()}},setCallbackOnfinish:function(e){this.onModeleRemoveFromServer=e},_commandCB:function(e){!0===e.readBool("commandHasSucceeded")?(console.log("CSISceneTest_CommandAfr_Reload well executed"),this.onModeleRemoveFromServer()):console.log("CSISceneTest_CommandAfr_Reload failed !")}})}),define("DS/XCityLoaders/BaseLoader",["DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/XCityTools/Geocoder","DS/XCityTools/ShaderTools","DS/xCityBasicUtils/Utils"],function(e,t,i,a,r){"use strict";return UWA.Class.extend({init:function(e,t){if(this.urban=e,r.is(t)){this.model=t,this.baseURL=this.model.url.substring(0,this.model.url.length-5)}else this.model={};this.model.gasSharing=!1,this._initRootNode(),this._initModelMatrix(),this.model.url?this.model.node.name=this.model.url.slice(this.model.url.lastIndexOf("/")+1):this.model.spec&&this.model.spec.filename&&(this.model.node.name=this.model.spec.filename.slice(0,this.model.spec.filename.indexOf("?")))},_initRootNode:function(){this.model.node=new e,r.is(this.model.destinationNode)&&this.model.destinationNode.addChild(this.model.node)},_initModelMatrix:function(){this._applyModelMatrixToModelNode(),this._applyProjection()},_applyModelMatrixToModelNode:function(){var e=this.model.matrix;r.is(e)||(e=this._computeModelMatrix()),this.model.node.setMatrix(e)},_computeModelMatrix:function(){var e=new t.Matrix4;return void 0!==this.model.rotation&&(e.rotateX(r.toRad(this.model.rotation[0])),e.rotateY(r.toRad(this.model.rotation[1])),e.rotateZ(r.toRad(this.model.rotation[2]))),void 0!==this.model.position&&e.setPosition({x:this.model.position[0],y:this.model.position[1],z:this.model.position[2]}),e},_applyProjection:function(){r.is(this.model.projection)&&i.loadProjection(this.model.projection,this._onProjectionLoaded.bind(this))},_onProjectionLoaded:function(){var e=this.model.node.getMatrix();this._shiftMatrix(1,e),this._translateAndScale(e),this._shiftMatrix(-1,e),this.model.node.setMatrix(e)},_shiftMatrix:function(e,t){this.model.shifted||(t.elements[12]=t.elements[12]*e+this.urban.shiftedPosition.x,t.elements[13]=t.elements[13]*e+this.urban.shiftedPosition.y)},_translateAndScale:function(e){var a=i.proj([e.elements[12],e.elements[13]],this.model.projection),r=1;"EPSG:3857"!==i.getDefaultProjection()&&"EPSG:900913"!==i.getDefaultProjection()||(r=i.computeMercatorScaleFactor(e.elements[12],e.elements[13],this.model.projection)),e.scale(new t.Vector3(r,r,1)),e.elements[12]=a.x,e.elements[13]=a.y},load:function(e,t){var i,a=this._initRenderingCallback(e);this.model.callback=r.is(a)?a:this.model.callback,this.model.progressCallback=t,i=r.is(this.model.progressCallback)?this.model.progressCallback:function(){},this.loader&&this.loader.setOnProgressCallback&&this.loader.setOnProgressCallback(i)},_initRenderingCallback:function(e){var t=function(t,i,a){this.model.rendering._addSpecificGeometry(this.model.node),r.is(e)&&e(t,i,a)}.bind(this);return r.is(this.model.rendering)?t:e},_getModelMaterial:function(e,i,o){if(r.is(i)&&r.is(o)){var s,n={visible:i.visible,force:i.force,side:i.side,enableClipPlanes:i.enableClipPlanes,transparent:i.transparent,opacity:i.opacity,depthTest:i.depthTest,depthWrite:i.depthWrite};return r.is(i.diffuseMap)&&r.is(o.data)&&r.is(o.data.textures)&&(n.map=o.data.textures[i.diffuseMap]),r.is(i.normalMap)&&r.is(o.data)&&r.is(o.data.textures)&&(n.normalMap=o.data.textures[i.normalMap]),r.is(i.specularMap)&&r.is(o.data)&&r.is(o.data.textures)&&(n.specularMap=o.data.textures[i.specularMap]),r.is(e)?e instanceof Array?s="Mat_water"===i.name?a.getExistingShaderMaterial(e[1].name):a.getExistingShaderMaterial(e[0].name):(void 0!==e.name&&(s=a.getExistingShaderMaterial(e.name)),void 0===s&&r.is(e.chunk)&&((s=this._createCityMaterial(e.chunk)).name="model_material")):s=i.clone(),s.setValues(n),r.is(n.map)&&(s.map=n.map),r.is(n.normalMap)&&(s.normalMap=n.normalMap,r.is(s.uniforms)&&r.is(s.uniforms.use_normalMap)&&(s.uniforms.use_normalMap.value=1,i.normalMapScale&&(s.uniforms.normalScale.value=i.normalMapScale))),r.is(n.specularMap)&&(s.specularMap=n.specularMap,r.is(s.uniforms)&&r.is(s.uniforms.use_specularMap)&&(s.uniforms.use_specularMap.value=1)),r.is(i.color)&&(s.color=(new t.Color).setRGB(i.color.r,i.color.g,i.color.b)),r.is(i.ambient)&&(s.ambient=(new t.Color).setRGB(i.ambient.r,i.ambient.g,i.ambient.b)),r.is(i.emissive)&&(s.emissive=(new t.Color).setRGB(i.emissive.r,i.emissive.g,i.emissive.b)),r.is(i.specular)&&(s.specular=(new t.Color).setRGB(i.specular.r,i.specular.g,i.specular.b)),r.is(i.shininess)&&(s.shininess=i.shininess),r.is(i.opacity)&&(s.opacity=i.opacity),r.is(i.transparent)&&(s.transparent=i.transparent),r.is(i.alphaTest)&&(s.alphaTest=i.alphaTest),a.updateCommonUniforms(s),s}},_createCityMaterial:function(e){for(var t=[a.common],i=0;i<e.length;++i)t.push(a[e[i]]);return a.getCustomShaderMaterial(t)},_needCustomShaders:function(){return r.is(this.model.shader)&&(this.model.shader instanceof Array||r.is(this.model.shader.chunk)||r.is(this.model.shader.name)&&r.is(a.getExistingShaderMaterial(this.model.shader.name)))},_isTextured:function(){var e=this.loader.modelsToLoad;if(!e)return!1;for(var t in e){var i=e[t];if(i.json&&i.json.images&&i.json.images.length>0)return!0}return!1}})}),define("DS/XCityLoaders/ModelLoader",["UWA/Core","DS/XCityTools/Downloader","DS/xCityBasicUtils/Utils"],function(e,t,i){"use strict";var a=UWA.Class.singleton({init:function(e){this.urban=e},load:function(e,t,a){e&&(e.gasSharing=!1),this._initModelUrl(e);var r=this._initModelExtension(e),o=new this.formatLoaders[r](this.urban,e);e.uuid=UWA.Utils.getUUID();var s=function(e){i.is(a)&&a(e)};return s({loaded:0,total:1}),o.load(function(e,a,r,o,s){i.is(t)&&t(e,a,r,o,s)},s)},_initModelUrl:function(e){return i.is(e.url)?e.url=t.resolveUrl(e.url):e.url="",e.url},_initModelExtension:function(e){return e.extension=e.extension||i.extractExtension(e.url),i.is(this.formatLoaders[e.extension])?e.extension:"defaultLoader"}});return a.formatLoaders={},a}),define("DS/XCityLoaders/CmdOpenPointCloud",["UWA/Core","DS/StateCommandEngine/StateCommand","DS/AfrCS/AfrCore","DS/Windows/Dialog","DS/CSICommandBinder/CSICommandBinder","DS/CoreUtilities/ErrorManagement"],function(e,t,i,a,r,o){"use strict";return t.extend({OK_COMMAND_EVENT:"okOpenTestAdvancedCommand",init:function(e){e.doServerCall=!0,e.isAsynchronous=!0,e.mode="exclusive",this._parent(e,{}),this.data=null},buildGraph:function(){var e={iSender:this,iEvent:this.OK_COMMAND_EVENT,iInitialState:this.createInitialState("waitBeginState"),iFinalState:this.getFinalState(),iCondition:null,iAction:this._actionExecuteService};this.addTransition(e)},_actionExecuteService:function(e,t){var a=new r.Parameters;a.writeString("inputObjectPath",t.fileURL);var s={from:this,inputs:a,operation:"CSISceneTest_CommandAfr_Import",version:1,msg:i.EXECUTE_OPERATION,callback:this._commandCB.bind(this,t.loadedCB)},n=i.callOperation(s);o.hasSucceeded(n)||(o.logResult(n),console.log("CSISceneTest_CommandAfr_Import callOperation call EXECUTE_OPERATION FAILED with code : "+n)),e()},_commandCB:function(e,t){!0===t.readBool("commandHasSucceeded")?(console.log("CSISceneTest_CommandAfr_Import well executed"),e()):console.log("CSISceneTest_CommandAfr_Import failed !")}})}),define("DS/XCityLoaders/ColladaParser",["DS/Mesh/MeshUtils","DS/Visualization/Mesh3D","DS/Visualization/SceneGraphConverter","DS/Visualization/ThreeJS_DS","DS/XCityTools/Disposer","DS/XCityTools/Downloader","DS/XCityTools/EventDispatcher","DS/XCityTools/ShaderTools","DS/xCityBasicUtils/Utils"],function(e,t,i,a,r,o,s,n,l){"use strict";return UWA.Class.extend({init:function(e,t,i){this.urban=e,this.collada=t,this.model=i,this.whitetexture=new a.DataTexture(new Float32Array([1,1,1,1]),1,1,a.RGBAFormat,a.FloatType),this.whitetexture.name="DefaultWhiteTexture",this.whitetexture.flipY=!1,this.whitetexture.minFilter=a.LinearFilter,this.whitetexture.magFilter=a.LinearFilter,this.whitetexture.generateMipmaps=!1,this.whitetexture.needsUpdate=!0,this.whitetexture.shared=-1,this.whitetexture.image.complete=!0},parse:function(){return this._daeLoadCallback(this.collada)},_daeLoadCallback:function(e){var t=e.scene;if(void 0!==t){var i=this._selectChildsMaterialsStructure(t),a=this._computeBboxScene(t);this.model.bbox=a,this._applyShaderOnMaterials(i);var r=this._createSceneGraphConverterNode(t);return this._applyShadows(r),this._applyMeshSetter(r),e.scene=void 0,e.dae=void 0,r}},_createSceneGraphConverterNode:function(e){return new i(this.urban.USR.webGLV6Viewer.getWebGLContext(),e,this.urban.USR.webGLV6Viewer.getRootNode()).getRootNode()},_applyMeshSetter:function(i){var a=function(e,t){var i=this.mesh3js.material.color.clone();return this.mesh3js.material.color.copy(e),this.mesh3js.material.ambient.copy(e),i},r=function(e,t){var i=this.mesh3js.material.opacity;return this.mesh3js.material.transparent=1!==e,this.mesh3js.material.opacity=e,i};i.traverse(function(i){i instanceof t&&(i.setPickable(e.PICKABLE),i.setColor=a,i.setOpacity=r,this.model.color&&i.setColor(this.model.color))}.bind(this))},_applyShadows:function(e){void 0!==this.model.shadow&&e.traverse(function(e){this._setShadow(e,this.model.shadow)}.bind(this))},_applyShaderOnMaterials:function(e){for(var t in e)e.hasOwnProperty(t)&&this._changeShader(e[t],this.model)},_computeBboxScene:function(e){var t={min:new a.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),max:new a.Vector2(Number.MIN_VALUE,Number.MIN_VALUE)};return e.traverse(function(e){var i=e.boundingBox;null!=i&&(t.min.x=Math.min(t.min.x,i.min.x),t.min.y=Math.min(t.min.y,i.min.y),t.max.x=Math.max(t.max.x,i.max.x),t.max.y=Math.max(t.max.y,i.max.y))}.bind(this)),t},_selectChildsMaterialsStructure:function(e){var t={};return e.traverse(function(e){this._isTransparent(e),e instanceof a.Mesh&&e.material&&(void 0===t[e.material.id]&&(t[e.material.id]=[]),t[e.material.id].push(e),e.geometry.dynamic=!1)}.bind(this)),t},_isTransparent:function(e){return e instanceof a.Mesh&&void 0!==e.material&&{t:e.material.transparent,b:e.material.blending}},_changeShader:function(e,t){var i,d,h,m,u,c,p=e[0].material,f=p.map,g=this,b=function(e,t){null!=t&&(t.image.complete?p.map=t:(p.map=g.whitetexture,t.onLoadCallbacks.push(function(){p.map=t,n.updateCommonUniforms(p)})),n.updateCommonUniforms(p))},C=function(e,i,r,o){o&&(r.minFilter=a[i.minFilter]||a.LinearMipMapLinearFilter,r.magFilter=a[i.magFilter]||a.LinearMipMapLinearFilter,r.wrapS=r.wrapT=a[i.wrapMode]||a.ClampToEdgeWrapping),this.urban.getView3D().getProfileRendering().removeProfile(e,this.whitetexture),this.urban.getView3D().getProfileRendering().addProfile(e,b,r,t.name)};if(t.shader&&"default"!==t.shader.name){var _,y=[n.common];if("building"===t.shader.name)y.push(n.vertexInformation),y.push(n.clipPlanes),y.push(n.map),y.push(n.alphaTest),void 0!==t.shader.uniforms&&(t.shader.uniforms.normalMap&&y.push(n.normalMap),t.shader.uniforms.specularMap&&y.push(n.specularMap)),y.push(n.urbanLights),y.push(n.shadowMapCustom);else if(t.shader.chunk)for(_=0;_<t.shader.chunk.length;++_)y.push(n[t.shader.chunk[_]]);var S=n.getCustomShaderMaterial(y);for(S.name="model_"+t.shader.name+"_material",S.side=p.side,t.shader.color?S.color=new a.Color(t.shader.color):S.color=new a.Color("#FFFFFF"),S.opacity=p.opacity,S.ambient=p.ambient,S.emissive=p.emissive,S.shininess=p.shininess,S.transparent=p.transparent,n.updateCommonUniforms(S),_=0;_<e.length;_++)e[_].material.dispose&&e[_].material.dispose(),e[_].material=S;S.map=f,p=S}if(p.shared=e.length,l.is(p.uniforms)&&(void 0!==p.uniforms.bbox_min&&(p.uniforms.bbox_min.value=t.bbox.min),void 0!==p.uniforms.bbox_max&&(p.uniforms.bbox_max.value=t.bbox.max)),t.shader&&t.shader.maps)for(c in t.shader.maps)t.shader.maps.hasOwnProperty(c)&&(void 0!==(i=t.shader.maps[c]).url&&""!==i.url?d=i.url:void 0!==i.tile&&void 0!==i.layerName&&""!==i.layerName&&(h=i.tile,m=i.layerName,this.urban.getLayerRoot().findChildByName(m)?u=this.urban.getLayerRoot().findChildByName(m).get("Content"):this.urban._dataModelPrivate.findChildByName(m)&&(u=this.urban._dataModelPrivate.findChildByName(m).get("Content")),u?(d=u.get("url"),u.get("invertY")):d=m,d=(d=o.resolveUrl(d)).replace("%l",h.lvl).replace("%x",h.x).replace("%y",h.y)),o.loadTexture(C.bind(this,c,i.options||{}),d));if(void 0===p.observers&&(p.observers=[]),p.observers.push(function(e){e.map&&"DefaultWhiteTexture"===e.map.name&&r.disposeV6(f)}),p.normalMap||p.specularMap){var v=function(e,t){var i=f.sourceFile.replace("_df","_"+t).replace("_op","_"+t).replace(".png",".jpg");o.loadTexture(function(t,i){i&&(t.minFilter=a.LinearMipMapLinearFilter,t.magFilter=a.LinearFilter,t.wrapS=t.wrapT=a.RepeatWrapping,p[e]=t,n.updateCommonUniforms(p))},i)};p.normalMap&&(v("normalMap","nm"),s.subscribeTo("/3DEXPERIENCity/onUpdate",function(e){void 0!==e.normalMap&&"DefaultWhiteTexture"!==e.normalMap.name&&(this.useNormalMap?e.uniforms.use_normalMap.value=1:e.uniforms.use_normalMap.value=0,e.needsUpdate=!0)}.bind(this.urban,p))),p.specularMap&&(v("specularMap","sp"),s.subscribeTo("/3DEXPERIENCity/onUpdate",function(e){void 0!==e.specularMap&&"DefaultWhiteTexture"!==e.specularMap.name&&(this.useSpecularMap?e.uniforms.use_specularMap.value=1:e.uniforms.use_specularMap.value=0,e.needsUpdate=!0)}.bind(this.urban,p)))}},_setShadow:function(e,i){e instanceof t&&e.setShadow(i,i)}})}),define("DS/XCityLoaders/ThreetyDXLoader",["DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/ThreeDXLoader","DS/Visualization/ThreeJS_DS","DS/XCityLoaders/BaseLoader","DS/XCityLoaders/ModelLoader","DS/XCityTools/Downloader","DS/xCityBasicUtils/Utils"],function(e,t,i,a,r,o,s,n){"use strict";return r.extend({init:function(e,t,i){this._parent(e,t),this.priority=i,void 0===this.priority&&(this.priority=1),this.initThreeDXLoader(),this.cityData=null},initThreeDXLoader:function(){this.loader=this.threeDXLoader=new i,this.threeDXLoader.setMode("concat"),this.threeDXLoader.globalOldFlipTexture=!0;var e=this;this.threeDXLoader.switchLODTextureCB=function(t){if(t.camera!==debugWebGLV6Viewer.currentViewpoint.camera)return this.lastUsedTexture;var i=e.urban.getPerformanceProfileManager(),r=i.getValue("maxtextureLOD"),o=i.getValue("textureLODOffset"),s=i.getValue("textureLODDistanceFactor");if(debugWebGLV6Viewer.mobile){if(10===r)return-1;r=Math.min(r,2)}var n=t.matrix,l=t.bSphere,d=l.radius*n.getMaxScaleOnAxis(),h=new a.Vector3;l?h.copy(l.center):h.set(0,0,0),h.applyMatrix4(n);var m=t.camera.matrixWorldInverse.elements,u=Math.abs(m[2]*h.x+m[6]*h.y+m[10]*h.z+m[14])-d;u*=s;var c,p,f=a.glStates.currentHeight/Math.tan(.5*t.camera.fov*Math.PI/180)*d/Math.abs(u);if(f<Math.min(t.texture.image.width,t.texture.image.height))return-1;for(c=0;c<t.lods.length&&(p=t.lods[c],!(f<Math.min(p.imageData.width,p.imageData.height)));c++);var g=c===t.lods.length?c-1:c;return g=Math.max(-1,g+o),Math.min(g,r)}},processBin:function(e,t){if(e){var i=this._parse(t);this.cityData=i.json.userData.cityData,this._applyMatrix();var a=this._generateObjectToLoad(t);this.threeDXLoader.modelsToLoad[0]=a,a.gasSharing=!0;var r=a.doneCallback,o=this;a.doneCallback=function(e,t,i){o._bindPrimitives(),r(e,t,i)},this._resolveTexturePath(a),this.threeDXLoader.processJSON(a)}},_resolveTexturePath:function(e){for(var t=e.json.binaries,i=0,a=t.length;i<a;++i){var r=t[i];if(!1===r.concatenated){var o,n,l=r.uri.split("/"),d=l[l.length-1],h=s.resolveUrl(this.model.url);if(h.indexOf("resources")>-1)o=-1==(o=h.lastIndexOf("/"))?h.length:o+1,h=h.substring(0,o),(n=this.model.url.split("?")).length>1?t[i].uri=h+d+"?"+n[n.length-1]:t[i].uri=h+d;else o=-1==(o=h.lastIndexOf("?"))?h.length:o+0,h=h.substring(0,o),(n=this.model.url.split("?")).length>1?t[i].uri=h+"/resources/"+d+"?"+n[n.length-1]:t[i].uri=h+"/"+d}}},_applyMatrix:function(){var e=this.cityData.matrix;if(e){var t=new a.Matrix4;t.set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]),t.transpose(),this.model.matrix=t,this._applyModelMatrixToModelNode()}},_parse:function(e){for(var t=new Uint8Array(e),i=new Uint32Array(e,0,1)[0],a=new Uint16Array(t.buffer,4,i/2),r=[],o=0;65535*o<a.length;o++)r.push(String.fromCharCode.apply(null,a.subarray(65535*o,65535*(o+1))));return{json:JSON.parse(r.join("")),dataAsByte:t,jsonSize:i}},_generateObjectToLoad:function(e){var t=this._parse(e);return this.model.node.isCoreReady=!1,{concat:!0,doneCallback:this._doneCallback.bind(this),nodeCallback:this._nodeCallback.bind(this),destinationNode:this.model.node,oldFlipTexture:!0,unstreamPrimitives:!0,onTexturesLoadedCB:function(){this.model.node.setVisibility(!0),this.model.node.isCoreReady=!0}.bind(this),data:{nbImagesToLoad:0,chunks:[],header:{},nodes:[],buffers:[],geometries:[],images:[],textures:[],materials:[],reps:{},modelsToLoad:[]},json:t.json,concatBinaries:{data:t.dataAsByte,offset:t.dataAsByte.byteLength}}},_bindPrimitives:function(){var e=this.cityData.objects,t=this;if(Array.isArray(e)){var i=[];this._extractMesh(this.model.node,i);var a=this._bindUidToPrim(e,i);this.model.uidToPrim=a,this.model.patch&&(Object.keys(this.model.uidToPrim).forEach(function(e){if(n.is(t.model.patch._uidListeners[e]))for(var i in t.model.uidToPrim[e])t.model.patch._uidListeners[e][i]=t.model.uidToPrim[e][i];else t.model.patch._uidListeners[e]=t.model.uidToPrim[e]}),this.model.patch.miDToTile!==this.model.patch._uidListeners&&(this.model.patch.miDToTile=this.model.patch._uidListeners))}},_extractMesh:function(e,t){if(e.mesh3js)return t.push(e);e.children.forEach(function(e){this._extractMesh(e,t)}.bind(this))},_bindUidToPrim:function(e,t){var i={},a=this.model.tile;return t.forEach(function(t){for(var r,o=t.getPrimitives(),s=[],l=0;l<o.length;l++)for(var d=0;d<e.length;d++)if(r=n.is(o[l].sgNode.cgmIdOld)&&"number"!=typeof o[l].sgNode.cgmId?o[l].sgNode.cgmIdOld:o[l].sgNode.cgmId,e[d].tags.indexOf(r)>-1){var h,m=e[d].STRID,u=e[d].uuid;if(void 0===u&&(u=e[d].uid),h=void 0!==m?m:u,o[l].sgNode.cgmId=h,!i[h]){var c={};for(var p in e[d])"tags"!==p&&""!==e[d][p]&&(c[p]=e[d][p]);i[h]={geom:[],strid:h,userData:c,tile:a}}i[h].geom.push({mesh:t,subElement:o[l].sgNode}),s.push(i[h])}t.userData={records:s}}),i},_doneCallback:function(){this.model.node&&(this._isTextured()&&!0!==this.model.node.isCoreReady?this.model.node.setVisibility(!1):this.model.node.isCoreReady=!0,this.model.callback&&this.model.callback(this.model.node,!0,this.model.name))},_nodeCallback:function(e,t,i){i.getGroupMaterial=function(e){return e.group.material||e.group.gas},i.setRendering=function(e,t,i){var a,r,o,s=!1,l=!1,d=this.getPrimitive(i,!0);n.is(d)||(l=!0),(a=(r=this.getGroupMaterial(t)).clone()).textureBlending=r.textureBlending,n.is(e.color)&&(o=e.color,a.color.copy(o),a.ambient&&a.ambient.copy(o),s=!0),n.is(e.opacity)&&(o=e.opacity,a.opacity=o,s=!0),s?(this.setMaterial([t],a),l&&this.hide([t])):this.setMaterial([t],r)}}})}),define("DS/XCityLoaders/StreamVisuLoader",["DS/Visualization/StreamVisuLoader","DS/Visualization/ThreeJS_DS","DS/XCityLoaders/BaseLoader","DS/XCityLoaders/ModelLoader","DS/xCityBasicUtils/Utils"],function(e,t,i,a,r){"use strict";return i.extend({load:function(e,t){this._parent(e,t);var i=this._generateObjectToLoad();return i.gasSharing=!1,this.loader.load(i),this.model.node},_nodeCallback:function(e,t,i){i.setRendering=function(e,t,i){var a=this.material;!r.is(a)&&r.is(this.mesh3js)&&(a=this.mesh3js.material);var o=e.color;if(r.is(o)){if(t.setColor)t.setColor(o);else if(t.container&&t.container.material){var s=t.container&&t.container.material;s.ambient&&s.ambient.setRGB(o.r,o.g,o.b),s.diffuse&&s.diffuse.setRGB(o.r,o.g,o.b),s.color&&s.color.setRGB(o.r,o.g,o.b)}r.is(a)&&(a.color.copy(o),a.ambient.copy(o))}var n=e.opacity;r.is(n)&&(t.setOpacity?n=t.setOpacity(n):t.container&&t.container.material&&t.container.material.setOpacity&&t.container.material.setOpacity(n),r.is(a)&&(a.opacity=n))},i.setColor=function(e,t){var i,a;for(a=0;a<t.length;a+=1)if(t[a].setColor)i=t[a].setColor(e);else if(t[a].container&&t[a].container.material){var o=t[a].container&&t[a].container.material;o.ambient&&o.ambient.setRGB(e.r,e.g,e.b),o.diffuse&&o.diffuse.setRGB(e.r,e.g,e.b),o.color&&o.color.setRGB(e.r,e.g,e.b)}var s=this.material;return!r.is(s)&&r.is(this.mesh3js)&&(s=this.mesh3js.material),r.is(s)&&(i=s.color.clone(),s.color.copy(e),s.ambient.copy(e)),i},i.setOpacity=function(e,t){var i,a;for(a=0;a<t.length;a+=1)t[a].setOpacity?i=t[a].setOpacity(e):t[a].container&&t[a].container.material&&t[a].container.material.setOpacity&&t[a].container.material.setOpacity(e);var o=this.material;return!r.is(o)&&r.is(this.mesh3js)&&(o=this.mesh3js.material),r.is(o)&&(i=o.opacity,o.opacity=e),i};var a=t.data.geometries;a.length;Array.isArray(a)||Object.keys(a).length},_doneCallback:function(){if(void 0!==this.model.callback){var e=!1;this.model.node.children.length>0&&(e=!0),this.model.callback(this.model.node,e,this.model.name)}},_addCustomShaders:function(e){this._needCustomShaders()&&(e.materialCallback=this._getModelMaterial.bind(this,this.model.shader))}})}),define("DS/XCityLoaders/PointCloudLoader",["DS/XCityLoaders/BaseLoader","DS/XCityLoaders/ModelLoader","DS/XCityLoaders/CmdOpenPointCloud","DS/XCityLoaders/ReloadSceneCommand"],function(e,t,i,a){"use strict";var r=e.extend({init:function(e,t){this._parent(e,t),(new a).begin()},load:function(e,t){var a=new i({});return a.begin(),a.publish({event:a.OK_COMMAND_EVENT,data:{fileURL:this.model.url,loadedCB:this._movePointCloud.bind(this,e)}}),this.urban.frmWindow&&this.urban.frmWindow._3dViewer&&this.urban.frmWindow._3dViewer.viewpoints&&this.urban.frmWindow._3dViewer.viewpoints[0]&&(this.urban.frmWindow._3dViewer.viewpoints[0].fixed=!0),this.model.node},_movePointCloud:function(e){if(this.urban.frmWindow._sceneGraphTree){var t=this.urban.frmWindow._sceneGraphTree,i=t._sg.children[1];i.name="pointCloud",this.model.node.addChild(i),t._sg.removeChild(i)}e()}});return t.formatLoaders.oocpc=r,r}),define("DS/XCityLoaders/DefaultLoader",["DS/Visualization/ModelLoader","DS/Visualization/ThreeJS_DS","DS/XCityLoaders/BaseLoader","DS/XCityLoaders/ModelLoader","DS/xCityBasicUtils/Utils"],function(e,t,i,a,r){"use strict";var o=i.extend({init:function(t,i){this._parent(t,i),this.loader=new e(this.urban.USR.webGLV6Viewer.getWebGLContext(),!1),this.loader.setSceneGraph(this.model.node)},load:function(e,t){return this._parent(e,t),this._loadWithDefaultLoader()},_loadWithDefaultLoader:function(){var e=this.model.callback;if(void 0!==e){this.loader,this.model;this.loader.setOnLoadedCallback(this._onModelLoadedCb.bind(this,e,!0)),this.loader.setOnErrorCallback(e.bind(this,this.model.node,!1,this.model.name))}var t=this.model.url+(this.model.urlOptions?this.model.urlOptions:"");this.loader.loadModel(this.model.spec||t,this.model.node);this.model.scale;return this.model.node},_onModelLoadedCb:function(e,t){if(this._needCustomShaders()){var i=this._applyChunks(this.model);this._applyMaterial(this.model.node,i)}e(this.model.node,t,this.model.name)},_applyChunks:function(e){var t=e.shader,i=this._getMainMaterial(e.node);return this._getModelMaterial(t,i,e)},_getMainMaterial:function(e){if(r.is(e))return r.is(e.children[0])?r.is(e.children[0].material)?e.children[0].material:this._getMainMaterial(e.children[0]):e.material||e.mesh3js.material},_applyMaterial:function(e,t){r.is(e)&&r.is(t)&&r.is(e.children)&&(0!==e.children.length?(e.material=this._assignMaterial(e.material,t),this._recurseOnChildrenNodes(e.children,t)):r.is(e.mesh3js)&&(e.mesh3js.material=this._assignMaterial(e.mesh3js.material,t),this._assignMaterialOnDrawingGroups(e.mesh3js,t)))},_assignMaterial:function(e,t){return r.is(e)&&(e=t),e},_recurseOnChildrenNodes:function(e,t){for(var i=0;i<e.length;i++)this._applyMaterial(e[i],t)},_assignMaterialOnDrawingGroups:function(e,t){if(this._hasDrawingGroups(e))for(var i=e.geometry[0].drawingGroups,a=0;a<i.length;a++)this._replaceDrawingGroup(i[a],t)},_replaceDrawingGroup:function(e,t){e.gas=t,e.material&&e.material&&(e.material=t)},_hasDrawingGroups:function(e){return r.is(e.geometry)&&r.is(e.geometry[0])&&r.is(e.geometry[0].drawingGroups)}});return a.formatLoaders.defaultLoader=o,o}),define("DS/XCityLoaders/CityLoader",["DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/ThreeDXLoader","DS/Visualization/ThreeJS_DS","DS/XCityLoaders/BaseLoader","DS/XCityLoaders/ModelLoader","DS/XCityTools/Downloader"],function(e,t,i,a,r,o,s){"use strict";var n=r.extend({init:function(e,t){this._parent(e,t),this.initThreeDXLoader()},initThreeDXLoader:function(){this.loader=this.threeDXLoader=new i,this.threeDXLoader.setMode("concat"),this.threeDXLoader.globalOldFlipTexture=!0;var e=this;this.threeDXLoader.switchLODTextureCB=function(t){if(t.camera!==debugWebGLV6Viewer.currentViewpoint.camera)return this.lastUsedTexture;var i=e.urban.getPerformanceProfileManager().getValue("maxtextureLOD");if(debugWebGLV6Viewer.mobile){if(10===i)return-1;i=Math.min(i,2)}var r=t.matrix,o=t.bSphere,s=o.radius*r.getMaxScaleOnAxis(),n=new a.Vector3;o?n.copy(o.center):n.set(0,0,0),n.applyMatrix4(r);var l,d,h=t.camera.matrixWorldInverse.elements,m=Math.abs(h[2]*n.x+h[6]*n.y+h[10]*n.z+h[14])-s,u=a.glStates.currentHeight/Math.tan(.5*t.camera.fov*Math.PI/180)*s/Math.abs(m);if(u<Math.min(t.texture.image.width,t.texture.image.height))return-1;for(l=0;l<t.lods.length&&(d=t.lods[l],!(u<Math.min(d.imageData.width,d.imageData.height)));l++);var c=l===t.lods.length?l-1:l;return Math.min(c,i)}},load:function(e,t){this._parent(e,t),this.model.node.isCoreReady=!1,this._setArrayBufferSliceBehaviour();var i=this.model.url+(this.model.urlOptions?this.model.urlOptions:"");return s.download(i,{async:!0,cors:!0,withCredentials:!0,responseType:"arraybuffer"},void 0,this.processBin.bind(this)),this.model.node},_setArrayBufferSliceBehaviour:function(){ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=function(e,t){var i=new Uint8Array(this);void 0===t&&(t=i.length);for(var a=new ArrayBuffer(t-e),r=new Uint8Array(a),o=0;o<r.length;o++)r[o]=i[o+e];return a})},processBin:function(e,t){if(e){var i=this._parse(t);this._applyMatrix(i);var a=(4-i.jsonSize%4)%4,r=t.slice(i.jsonSize+a+4+4),o=this._generateObjectToLoad(r);this.threeDXLoader.modelsToLoad[0]=o,o.gasSharing=!1,this._resolveTexturePath(o),this.threeDXLoader.processJSON(o),this._bindPrimitives(i.json)}},_resolveTexturePath:function(e){for(var t=e.json.binaries,i=0,a=t.length;i<a;++i){var r=t[i];if(!1===r.concatenated){var o=r.uri.split("/"),s=o[o.length-1],n=this.model.url,l=n.lastIndexOf("/");l=-1==l?url.length:l+1,n=n.substring(0,l);var d=this.model.urlOptions?this.model.urlOptions:"";t[i].uri="../"+n+s+d}}},_applyMatrix:function(e){if(this.model.geolocalized){var t=e.json.model.matrix,i=new a.Matrix4;i.set(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]),i.transpose(),this.model.matrix=i,this._applyModelMatrixToModelNode()}},_parse:function(e){for(var t=new Uint8Array(e),i=new Uint32Array(e,0,1)[0],a=new Uint16Array(t.buffer,4,i/2),r=[],o=0;65535*o<a.length;o++)r.push(String.fromCharCode.apply(null,a.subarray(65535*o,65535*(o+1))));return{json:JSON.parse(r.join("")),dataAsByte:t,jsonSize:i}},_generateObjectToLoad:function(e){var t=this._parse(e);return{concat:!0,doneCallback:this._doneCallback.bind(this),nodeCallback:this._nodeCallback.bind(this),destinationNode:this.model.node,oldFlipTexture:!0,onTexturesLoadedCB:function(){this.model.node.setVisibility(!0),this.model.node.isCoreReady=!0}.bind(this),data:{nbImagesToLoad:0,chunks:[],header:{},nodes:[],buffers:[],geometries:[],images:[],textures:[],materials:[],reps:{},modelsToLoad:[]},json:t.json,concatBinaries:{data:t.dataAsByte,offset:t.dataAsByte.byteLength}}},_bindPrimitives:function(e){var t=this._extractJSONPrimitives(e),i=this;if(Array.isArray(t)){var a=[];this._extractMesh(this.model.node,a);var r=this._bindUidToPrim(t,a);this.model.uidToPrim=r,this.model.patch&&(Object.keys(this.model.uidToPrim).forEach(function(e){if(Utils.is(i.model.patch._uidListeners[e]))for(var t in i.model.uidToPrim[e])i.model.patch._uidListeners[e][t]=i.model.uidToPrim[e][t];else i.model.patch._uidListeners[e]=i.model.uidToPrim[e]}),this.model.patch.miDToTile!==this.model.patch._uidListeners&&(this.model.patch.miDToTile=this.model.patch._uidListeners))}},_extractJSONPrimitives:function(e){if(e&&e.model&&e.model.objects&&Array.isArray(e.model.objects)&&e.model.objects.length>0)return e.model.objects},_extractMesh:function(e,t){if(e.mesh3js)return t.push(e);e.children.forEach(function(e){this._extractMesh(e,t)}.bind(this))},_bindUidToPrim:function(e,t){var i={};return t.forEach(function(t){for(var a,r=t.getPrimitives(),o=0;o<r.length;o++)for(var s=0;s<e.length;s++)a=Utils.is(r[o].sgNode.cgmIdOld)&&"number"!=typeof r[o].sgNode.getCgmId()?r[o].sgNode.cgmIdOld:r[o].sgNode.getCgmId(),e[s].tags.indexOf(a)>-1&&(r[o].sgNode._setCgmId(e[s].uid),i[e[s].uid]||(i[e[s].uid]={geom:[],strid:e[s].uid,userData:{}}),i[e[s].uid].geom.push({mesh:t,subElement:r[o].sgNode}))}),i},_doneCallback:function(){this.model.node&&(this._isTextured()?this.model.node.setVisibility(!1):this.model.node.isCoreReady=!0,this.model.callback&&this.model.callback(this.model.node,!0,this.model.name))},_nodeCallback:function(e,t,i){i.setColor=function(e,t){var i,a,r,o;for(o=0;o<t.length;o++)i=(r=0===(r=this._getMaterials([t[o]])).length?t[o].group.material||t[o].group.gas:r[0]).color.clone(),(a=r.clone()).textureBlending=r.textureBlending,a.color.copy(e),a.ambient&&a.ambient.copy(e),this.setMaterial([t[o]],a);return i},i.setOpacity=function(e,t){var i,a,r,o;for(o=0;o<t.length;o++)i=(r=0===(r=this._getMaterials([t[o]])).length?t[o].group.material||t[o].group.gas:r[0]).opacity,(a=r.clone()).textureBlending=r.textureBlending,a.opacity=e,this.setMaterial([t[o]],a);return i}}});return o.formatLoaders.cty=n,o.formatLoaders.city=n,n}),define("DS/XCityLoaders/StreamVisuV1Loader",["DS/Visualization/StreamVisuLoader","DS/Visualization/ThreeJS_DS","DS/XCityLoaders/ModelLoader","DS/XCityLoaders/StreamVisuLoader","DS/xCityBasicUtils/Utils"],function(e,t,i,a,r){"use strict";var o=a.extend({init:function(t,i){this._parent(t,i),this.loader=new e},_generateObjectToLoad:function(){this.model.node.isCoreReady=!1;var e={url:this.baseURL,urlOptions:this.model.urlOptions,destinationNode:this.model.node,nodeCallback:this._nodeCallback,doneCallback:function(e){this.model.node.isCoreReady=!0,this._doneCallback()}.bind(this),imageCallback:this._loadTexture.bind(this)};return this._addCustomShaders(e),e},_loadTexture:function(e,i){var a=this.baseURL.substring(0,this.baseURL.lastIndexOf("/"))+"/";a+=e.path,i.urlOptions&&(a+=i.urlOptions);var r=t.ImageUtils.loadTexture(a,null,null,null,!0);return r.wrapS=e.wrapS||1e3,r.wrapT=e.wrapT||1e3,r.anisotropy=e.anisotropy||8,r.minFilter=e.minFilter||1008,r.magFilter=e.magFilter||1006,r.repeat=e.repeat||{x:1,y:1},r.sRGB="jpg"===e.format||"jpeg"===e.format,r}});return i.formatLoaders.json=o,o}),define("DS/XCityLoaders/StreamVisuV2Loader",["DS/Visualization/ThreeJS_DS","DS/Visualization/ThreeDXLoader","DS/XCityLoaders/StreamVisuLoader","DS/XCityLoaders/ModelLoader"],function(e,t,i,a){"use strict";var r=i.extend({init:function(e,i){this._parent(e,i),this.loader=new t,this.loader.setMode("3dxc"===i.extension?"concat":"zipped")},_generateObjectToLoad:function(){this.model.node.isCoreReady=!1;var t={oldFlipTexture:!0,url:this.model.url+(this.model.urlOptions?this.model.urlOptions:""),urlOptions:this.model.urlOptions,destinationNode:this.model.node,nodeCallback:this._nodeCallback,doneCallback:function(t){if(this.model.node){var i=this.loader.modelsToLoad[0].json;if(i&&i.materials&&i.materials[0]&&this.loader.modelsToLoad[0].data&&this.loader.modelsToLoad[0].data.materials[0]&&(this.loader.modelsToLoad[0].data.materials[0]._transparent=i.materials[0].transparent),i&&i.userData&&i.userData.cityData&&i.userData.cityData.matrix&&!0===this.model.terrain){var a=new e.Matrix4,r=i.userData.cityData.matrix;a.set(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9],r[10],r[11],r[12],r[13],r[14],r[15]),a.transpose(),a=this.model.node.getMatrix().multiply(a),this.model.node.setMatrix(a)}this._isTextured()?this.model.node.setVisibility(!1):this.model.node.isCoreReady=!0,this._doneCallback()}}.bind(this),onTexturesLoadedCallback:function(){this.model.node.setVisibility(!0),this.model.node.isCoreReady=!0}.bind(this)};return this._addCustomShaders(t),t}});return a.formatLoaders["3dxc"]=r,a.formatLoaders["3dx"]=r,r}),define("DS/XCityLoaders/ColladaLoader",["DS/Visualization/ColladaLoader","DS/XCityLoaders/BaseLoader","DS/XCityLoaders/ColladaParser","DS/XCityLoaders/ModelLoader"],function(e,t,i,a){"use strict";var r=t.extend({init:function(t,i){this._parent(t,i),this.loader=new e.ColladaLoader,this.loader.options.convertUpAxis=!1},load:function(e,t){this._parent(e,t);var i=this.model.url+(this.model.urlOptions?this.model.urlOptions:"");return this.loader.load(i,this._ready.bind(this)),this.model.node},_ready:function(e){var t,a=new i(this.urban,e,this.model).parse(),r=!1;a&&(this.model.node.add(a),t=this.model.node,r=!0),this.model.callback&&this.model.callback(t,r,this.model.name)}});return a.formatLoaders.dae=r,a.formatLoaders.zae=r,r}),define("DS/XCityLoaders/XCityLoader",["DS/XCityLoaders/ModelLoader","DS/XCityLoaders/CityLoader","DS/XCityLoaders/ColladaLoader","DS/XCityLoaders/DefaultLoader","DS/XCityLoaders/PointCloudLoader","DS/XCityLoaders/StreamVisuV1Loader","DS/XCityLoaders/StreamVisuV2Loader"],function(e,t,i,a,r,o){return e});