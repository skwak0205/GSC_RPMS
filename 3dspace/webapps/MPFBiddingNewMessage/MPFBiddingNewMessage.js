define("DS/MPFBiddingNewMessage/BiddingAddress",["UWA/Core","UWA/String","UWA/Class/View","DS/UIKIT/Input/Button","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartFactory","DS/MPFCartModel/CartItemFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyModel/CompanyModel","DS/MPFPersonModel/PersonModel","DS/MPFAddressModel/AddressCollection","DS/MPFBuyerAddressComponent/BuyerAddressBook","DS/MPFFiniteStateMachine/FiniteStateMachine","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,d,h,u,l,p,m,P,S){"use strict";var g={PICK_UP:"pickUp",SHIPPING_NO_ADDRESS:"shippingNoAddress",SHIPPING_ADDRESS_SELECTED:"shippingAddressSelected"};return s.extend({className:"mpf-bidding-address",setup:function(e){e||(e={}),this._checkPrototypes(e),this.buyerType=e.buyerType,this.addresses=e.addresses,this.addressFactory=e.addressFactory,this.companyFactory=e.companyFactory,this.cartFactory=e.cartFactory,this.cartItemFactory=e.cartItemFactory,this.me=e.me,this.company=e.company,this.cart=e.cart,this.countries=e.countries,this.buyerAddressBook=this._initBuyerAddressBook(),this.addAddressButton=this._createButton(S.get("addAddress")),this.changeAddressButton=this._createButton(S.get("changeAddress")),this.stateMachine=this._createStateMachine(),this.listenTo(this.buyerAddressBook,"onSelected",this._addressSelected.bind(this))},render:function(){var e=this.stateMachine.getState();return e===g.SHIPPING_NO_ADDRESS?this.container.setContent([this.addAddressButton,this.buyerAddressBook.render()]):e===g.SHIPPING_ADDRESS_SELECTED?this._displayAddressLabel():this.container.setContent(""),this},manageAddressChoices:function(t){t?e.is(this.getSelectedAddress())?this.stateMachine.changeState(g.SHIPPING_ADDRESS_SELECTED):this.stateMachine.changeState(g.SHIPPING_NO_ADDRESS):this.stateMachine.changeState(g.PICK_UP),this.render()},getSelectedAddress:function(){return this.buyerAddressBook.getSelectedAddress()||this.cart.getShippingAddress()},_initBuyerAddressBook:function(){return new m({model:this.addresses,me:this.me,buyer:this.buyerType===n.COMPANY?this.company:this.me,addressFactory:this.addressFactory,companyFactory:this.companyFactory,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,countries:this.countries})},_createButton:function(e){var t=this;return new i({className:"link",value:e,events:{onClick:function(){t.buyerAddressBook.show()}}})},_addressSelected:function(e){e.ok&&(this.stateMachine.changeState(g.SHIPPING_ADDRESS_SELECTED),this.render())},_displayAddressLabel:function(){var t;t=e.createElement("div",{class:"mpf-bidding-address-selected",html:[e.createElement("span",{text:S.get("shipTo")}),this._getAddressTitle(this.getSelectedAddress()),this.cart.getState()===r.States.DRAFT&&this.changeAddressButton]}),this.container.setContent([t,this.buyerAddressBook.render()])},_getAddressTitle:function(e){var s="";return["addressLine1","addressLine2","addressLine3","addressLine4","city","county","state","postalCode","country"].map(function(t){return e.get(t)}).filter(function(e){return e&&e.length>0}).map(function(e){return s=s+" "+e+","}),t.truncate(s,s.length-1,"")},_createStateMachine:function(){return new P({state:this.getSelectedAddress()?g.SHIPPING_ADDRESS_SELECTED:g.SHIPPING_NO_ADDRESS,states:[g.PICK_UP,g.SHIPPING_NO_ADDRESS,g.SHIPPING_ADDRESS_SELECTED],transitions:[{from:g.PICK_UP,to:g.SHIPPING_NO_ADDRESS},{from:g.PICK_UP,to:g.SHIPPING_ADDRESS_SELECTED},{from:g.SHIPPING_NO_ADDRESS,to:g.PICK_UP},{from:g.SHIPPING_NO_ADDRESS,to:g.SHIPPING_ADDRESS_SELECTED},{from:g.SHIPPING_ADDRESS_SELECTED,to:g.PICK_UP}]})},_checkPrototypes:function(e){a.requiredOfPrototype(e.me,l,"options.me must be a PersonModel"),a.requiredOfPrototype(e.cart,r,"options.cart must be a CartModel"),a.requiredOfPrototype(e.companyFactory,d,"options.companyFactory must be a CompanyFactory"),a.requiredOfPrototype(e.addressFactory,h,"options.addressFactory must be an AddressFactory"),a.requiredOfPrototype(e.cartItemFactory,c,"options.cartItemFactory must be a CartItemFactory"),a.requiredOfPrototype(e.cartFactory,o,"options.cartFactory must be a CartFactory"),a.requiredOfPrototype(e.addresses,p,"options.addresses must be an AddressCollection"),this.buyerType===n.COMPANY&&a.requiredOfPrototype(e.company,u,"options.company must be a CompanyModel")}})}),define("DS/MPFBiddingNewMessage/CancelConfirmationModal",["UWA/Class/View","DS/UIKIT/Modal","DS/UIKIT/Input/Button","DS/UIKIT/Mask","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a){"use strict";const n=Object.freeze({CONFIRMED:"confirmed"}),r=e.extend({className:"mpf-cancel-modal",setup:function(){this.confirmButton=this._createConfirmButton(),this.cancelButton=this._createCancelButton(),this.modal=this._createModal()},render:function({isPhaseCancel:e,phase:t}={}){return this.modal.setHeader(this._getModalHeader({isPhaseCancel:e,phase:t})),this.modal.setBody(this._getModalBody({isPhaseCancel:e})),this.container.setContent(this.modal),this},show:function(){this.setLoading(!1),this.modal.show()},hide:function(){this.modal.hide()},setLoading:function(e){(e=!1!==e)?(i.mask(this.modal.getBody()),this.confirmButton.load()):(i.unmask(this.modal.getBody()),this.confirmButton.load(!1))},_cancelCart:function(){this.setLoading(),this.dispatchEvent(n.CONFIRMED)},_createModal:function(){return new t({footer:[this.confirmButton,this.cancelButton]})},_getModalBody:function({isPhaseCancel:e}){return[{tag:"div",class:"fonticon fonticon-3x fonticon-trash"},{tag:"div",class:"mpf-first-line",text:e?a.get("cancelThisPhase"):a.get("cancelThisRequest")},{tag:"div",class:"mpf-second-line",text:a.get("actionIrreversible")}]},_getModalHeader:function({isPhaseCancel:e,phase:t}){return{tag:"h4",text:e?a.get("cancelPhase",{number:t.getNumber()}):a.get("cancelRequest")}},_createConfirmButton:function(){return new s({className:"primary",value:a.get("confirm"),events:{onClick:this._cancelCart.bind(this)}})},_createCancelButton:function(){return new s({value:a.get("close"),events:{onClick:this.hide.bind(this)}})},destroy:function(){this.modal=null,this._parent(),this.container=null}});return r.Events=n,r}),define("DS/MPFBiddingNewMessage/BiddingCartHelper",["DS/MPFCartModel/CartPatchOperation","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel"],function(e,t,s){"use strict";return{getSubmittedStateCartOperation:function(s,i,a){var n={currentState:t.States.SUBMITTED,ShopID:s};return i&&(n.ShipTo=a),new e(e.Operations.modify,"/",n)},getDeliveryRequestItemOperation:function(t,i,a){return new e(e.Operations.add,"/cart-items/",{"@type":"MP_DeliveryServiceRequest",CartID:t,currentState:s.STATUS.submitted,Quantity:1,ShopID:a,DeliveryServiceName:i?"Shipping":"Pickup"})},getModifyCartItemAttributesOperation:function(t){return new e(e.Operations.modify,"/cart-items/"+t.get("id"),t.getPendingChanges())},getSubmittedStateCartItemOperation:function(t){var i;return t.hasPendingChanges()?((i=t.getPendingChanges()).currentState=s.STATUS.submitted,new e(e.Operations.modify,"/cart-items/"+t.get("id"),i)):new e(e.Operations.modify,"/cart-items/"+t.get("id"),{currentState:s.STATUS.submitted})},getDeliveredStateCartItemOperation:function(t){var i;return t.hasPendingChanges()?((i=t.getPendingChanges()).currentState=s.STATUS.delivered,new e(e.Operations.modify,"/cart-items/"+t.get("id"),i)):new e(e.Operations.modify,"/cart-items/"+t.get("id"),{currentState:s.STATUS.delivered})},getReadyStateCartItemOperation:function(t){var i;return t.hasPendingChanges()?((i=t.getPendingChanges()).currentState=s.STATUS.ready,new e(e.Operations.modify,"/cart-items/"+t.get("id"),i)):new e(e.Operations.modify,"/cart-items/"+t.get("id"),{currentState:s.STATUS.ready})},getShippedStateCartItemOperation:function(t){var i;return t.hasPendingChanges()?((i=t.getPendingChanges()).currentState=s.STATUS.shipped,new e(e.Operations.modify,"/cart-items/"+t.get("id"),i)):new e(e.Operations.modify,"/cart-items/"+t.get("id"),{currentState:s.STATUS.shipped})},getProcessingStateCartItemOperation:function(t){var i;return t.hasPendingChanges()?((i=t.getPendingChanges()).currentState=s.STATUS.processing,new e(e.Operations.modify,"/cart-items/"+t.get("id"),i)):new e(e.Operations.modify,"/cart-items/"+t.get("id"),{currentState:s.STATUS.processing})},getAcceptedStateCartItemOperation:function(t){var i;return t.hasPendingChanges()?((i=t.getPendingChanges()).currentState=s.STATUS.accepted,new e(e.Operations.modify,"/cart-items/"+t.get("id"),i)):new e(e.Operations.modify,"/cart-items/"+t.get("id"),{currentState:s.STATUS.accepted})},getAddContractOperation:function(t,s,i){return new e(e.Operations.add,"/contracts",{ContractID:t,CartItemID:s,documentType:i})},getCancelRequestOperation:function(){return new e(e.Operations.modify,"/",{currentState:t.States.CANCELLED})},getAddBiddingDocOperation:function(t,s){return new e(e.Operations.add,"/bidding-documents",{CartItemID:t,DocumentID:s})},getAddMessageOperation:function(t,s,i,a){return new e(e.Operations.add,"/message",{author:t?"mdpeoplecompany/people/"+a.getOwnerId():"/mdshop/shops/"+a.getShopID(),documentIDs:s,message:i})}}}),define("DS/MPFBiddingNewMessage/BiddingActions",[],function(){"use strict";return Object.freeze({SEND_MESSAGE:"message",ACCEPT:"accept",CANCEL:"cancel",PAY:"pay",NOTIFY_WORK_STARTED:"workStarted",NOTIFY_READY:"ready",NOTIFY_SHIPPING:"shipping",CONFIRM_DELIVERY:"confirmDelivery",ACCEPT_PHASE:"acceptPhase",NOTIFY_PHASE_WORK_STARTED:"phaseWorkStarted",ACCEPT_PHASE_DELIVERY:"acceptPhaseDelivery",REJECT_PHASE_DELIVERY:"rejectPhaseDelivery",NOTIFY_PHASE_DELIVERY:"notifyPhaseDelivery",CANCEL_PHASE:"cancelPhase",UPDATE:"update",UPDATE_AND_ACCEPT:"updateAndAccept"})}),define("DS/MPFBiddingNewMessage/BiddingDeliveryMethod",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Toggle","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n){"use strict";var r={DELIVERY_METHOD_CHANGED:"deliveryMethodChanged"},o=t.extend({className:"mpf-bidding-delivery-method",setup:function(e){e||(e={}),i.requiredOfPrototype(e.cart,a,"options.cart must be a CartModel"),this.cart=e.cart,this.shippingRadio=this._createShippingRadio(),this.pickUpRadio=this._createPickUpRadio()},render:function(){return this.cart.getState()===a.States.DRAFT?this.container.setContent([n.get("delivery"),this.pickUpRadio,this.shippingRadio]):this.container.setContent(""),this},isShippingSelected:function(){return this.shippingRadio.isChecked()},_createShippingRadio:function(){var e=this;return new s({checked:!0,type:"radio",value:n.get("shipping"),className:"primary",events:{onChange:function(){this.isChecked()&&(e.pickUpRadio.setCheck(!1),e.dispatchEvent(r.DELIVERY_METHOD_CHANGED,e.shippingRadio.isChecked()))}}})},_createPickUpRadio:function(){var e=this;return new s({type:"radio",value:n.get("pickUp"),className:"primary",events:{onChange:function(){this.isChecked()&&(e.shippingRadio.setCheck(!1),e.dispatchEvent(r.DELIVERY_METHOD_CHANGED,e.shippingRadio.isChecked()))}}})}});return o.Events=Object.freeze(r),o}),define("DS/MPFBiddingNewMessage/BiddingUploadFileComponent",["UWA/Core","UWA/Class/View","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/UIKIT/Input/Select","DS/UIKIT/Input/File","DS/UIKIT/Input/Text","DS/MPFUtils/FormatUtils","DS/MPFServices/ObjectService","DS/MPFView/GuidanceHelper","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFTCContractModel/TCContractModel","DS/MPFTcDocumentModel/TcDocumentModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,d,h,u,l,p,m,P){"use strict";var S,g={},y={};return g.DOCUMENT_SAVED="docSaved",g.DOCUMENT_NOT_SAVED="docNotSaved",y.NDA="NDA",y.SALES_CONDITIONS="salesConditions",y.OTHER="other",(S=t.extend({tagName:"div",className:"mpf-bidding-upload-files",setup:function(e){e||(e={}),this._checkPrototypes(e),this.buyerView=!0===e.buyerView,this.tcDocumentFactory=e.tcDocumentFactory,this.cart=e.cart,this.cartItem=e.cartItem,this.maxFileSize=e.maxFileSize,this.maxSpecificFileSize=e.maxSpecificFileSize,this.nda=e.nda,this.alwaysAllowDocUpload=!0===e.alwaysAllowDocUpload,this.addNdaButton=this._createAddNdaButton(),this.addNdaTooltip=this._createNdaTooltip(),this.addSalesDocumentButton=this._createAddSalesDocumentButton(),this.addSalesDocumentTooltip=this._createSalesDocumentTooltip(),this.addDocumentButton=this._createAddDocumentButton(),this.addDocumentTooltip=this._createDocumentTooltip()},render:function(){var e=[];return this.buyerView&&this._isBuyerAllowedToUploadNDA()&&!this.alwaysAllowDocUpload||e.push(this._getAddDocumentButtonContainer()),this.buyerView&&this._isBuyerAllowedToUploadNDA()&&e.push(this._getAddNdaContainer()),!this.buyerView&&this._isSellerAllowedToUploadSalesConditions()&&e.push(this._getAddSalesDocumentContainer()),this.container.setContent(e),this},_getAddSalesDocumentContainer:function(){return e.createElement("div",{class:"mpf-sales-doc",html:[this.addSalesDocumentButton,this.addSalesDocumentTooltip]})},_getAddNdaContainer:function(){return e.createElement("div",{class:"mpf-nda-doc",html:[this.addNdaButton,this.addNdaTooltip]})},_getAddDocumentButtonContainer:function(){return e.createElement("div",{class:"mpf-add-doc",html:[this.addDocumentButton,this.addDocumentTooltip]})},_clearDoc:function(e){switch(e){case y.NDA:this.addNdaButton.clear();break;case y.SALES_CONDITIONS:this.addSalesDocumentButton.clear();break;case y.OTHER:this.addDocumentButton.clear()}},_createSalesDocumentTooltip:function(){var t;return t=[e.createElement("p",{text:P.get("addSalesCond")})],this.maxSpecificFileSize&&t.push(e.createElement("p",{text:P.get("maximumFileSize",{size:o.getReadableFileSize(this.maxSpecificFileSize)})})),t.push(e.createElement("p",{text:P.get("supportedFileFormatsSalesConditions")})),new d({position:"left",content:t})},_createNdaTooltip:function(){var t;return t=[e.createElement("p",{text:P.get("addNdaDoc")})],this.maxSpecificFileSize&&t.push(e.createElement("p",{text:P.get("maximumFileSize",{size:o.getReadableFileSize(this.maxSpecificFileSize)})})),t.push(e.createElement("p",{text:P.get("supportedFileFormatsNda")})),new d({position:"left",content:t})},_createDocumentTooltip:function(){var t;return t=[e.createElement("p",{text:P.get("addDocSeller")})],this.maxFileSize&&t.push(e.createElement("p",{text:P.get("maximumFileSize",{size:o.getReadableFileSize(this.maxFileSize)})})),t.push(e.createElement("p",{text:P.get("supportedFileFormats")})),new d({position:"left",content:t})},_createAddDocumentButton:function(){var e=new n({icon:"attach",buttonText:P.get("addDocument"),input:!1,name:y.OTHER,events:{onChange:this._uploadFile.bind(this,y.OTHER)}});return this._addIcon("attach",e),e},_createAddSalesDocumentButton:function(){var e=new n({buttonText:P.get("addSalesConditions"),input:!1,name:y.SALES_CONDITIONS,events:{onChange:this._uploadFile.bind(this,y.SALES_CONDITIONS)}});return this._addIcon("doc-log",e),e},_createAddNdaButton:function(){var e=new n({buttonText:P.get("addNda"),input:!1,name:y.NDA,events:{onChange:this._uploadFile.bind(this,y.NDA)}});return this._addIcon("doc-log",e),e},_addIcon:function(t,s){e.createElement("span",{class:"fonticon fonticon-"+t}).inject(s.elements.button,"top")},_uploadFile:function(t,i){var a,n,r=this,c={};if(n=i.target.files[0],e.is(n))if(this._isFileSizeNotExceedingLimit(t,n.size))t===y.NDA?(a=this.tcDocumentFactory.createModel(h.Types.NEW_NDA),c.type=l.DocumentTypes.NDA):t===y.SALES_CONDITIONS?(a=this.tcDocumentFactory.createModel(h.Types.NEW_CUSTOM_TC_SELLERS),c.type=l.DocumentTypes.SPECIFIC_SALES_CONDITIONS):t===y.OTHER&&(a=this.tcDocumentFactory.createModel(h.Types.CART_BIDDING)),s.mask(this.container),a.saveDocument({file:n},c).then(function(e){s.unmask(r.container),r.dispatchEvent(g.DOCUMENT_SAVED,{docName:n.name,docID:a.getDocID()||Object.keys(a.get("documentIDs"))[0],docType:t})}).catch(function(){var e,i;i=(e=n.type.indexOf("image")>-1)&&t===y.NDA?P.get("imageCantBeUploadedNDA"):e&&t===y.SALES_CONDITIONS?P.get("imageCantBeUploadedSalesConditions"):P.get("uploadError"),s.unmask(r.container),r.dispatchEvent(g.DOCUMENT_NOT_SAVED,i)}).finally(this._clearDoc.bind(this,t));else{var d=t===y.NDA||t===y.SALES_CONDITIONS?this.maxSpecificFileSize:this.maxFileSize;this.dispatchEvent(g.DOCUMENT_NOT_SAVED,P.get("fileExceedsMaxSize",{size:o.getReadableFileSize(d)}))}},_isFileSizeNotExceedingLimit:function(e,t){return e===y.NDA||e===y.SALES_CONDITIONS?!this.maxSpecificFileSize||t<=this.maxSpecificFileSize:e===y.OTHER?!this.maxFileSize||t<=this.maxFileSize:void 0},_isSellerAllowedToUploadSalesConditions:function(){var e,t;return e=this.cart.getState()===p.States.SUBMITTED,t=this.cartItem.getState()===m.STATUS.submitted||this.cartItem.getState()===m.STATUS.accepted,e&&t},_isBuyerAllowedToUploadNDA:function(){var t,s;return t=this.cart.getState()===p.States.DRAFT||this.cart.getState()===p.States.SUBMITTED,s=this.cartItem.getState()===m.STATUS.draft||this.cartItem.getState()===m.STATUS.submitted,e.is(this.nda)?t&&s&&this.nda.getCurrentState()!==u.STATUS.inEffect:t&&s},_checkPrototypes:function(e){c.requiredOfPrototype(e.tcDocumentFactory,h,"options.tcDocumentFactory must be a TCDocumentFactory"),c.requiredOfPrototype(e.cart,p,"options.cart must be a CartModel"),c.requiredOfPrototype(e.cartItem,m,"options.cartItem must be a CartItemModel"),this.buyerView&&this.cart.getState()===p.States.SUBMITTED&&c.requiredOfPrototype(e.nda,u,"options.nda must be a TcContractModel")}})).Events=Object.freeze(g),S.DocTypes=Object.freeze(y),S.isBuyerAllowedToUploadNDA=function(e,t){var s,i;return s=e.getState()===p.States.DRAFT||e.getState()===p.States.SUBMITTED,i=t.getState()===m.STATUS.draft||t.getState()===m.STATUS.submitted,s&&i},S}),define("DS/MPFBiddingNewMessage/EngineeringBiddingOptions",["DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFBiddingNewMessage/BiddingActions","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i){"use strict";var a={},n={};return a[e.States.SUBMITTED]={},a[e.States.PENDING_PAYMENT]={},a[e.States.PAYMENT_COMPLETE]={},a[e.States.PAYMENT_ACCEPTED]={},a[e.States.PROCESSING]={},a[e.States.DELIVERED]={},a[e.States.CANCELLED]={},a[e.States.SUBMITTED][t.STATUS.submitted]=[{value:s.ACCEPT,text:i.get("proposeSchedule"),icon:"check"},{value:s.SEND_MESSAGE,text:i.get("askForInformation"),icon:"question-circle"},{value:s.CANCEL,text:i.get("rejectRequest"),icon:"close"}],a[e.States.SUBMITTED][t.STATUS.accepted]=[{value:s.SEND_MESSAGE,text:i.get("askForInformation"),icon:"question-circle"},{value:s.CANCEL,text:i.get("rejectRequest"),icon:"close"}],a[e.States.PAYMENT_ACCEPTED][t.STATUS.pendingProcessing]=[{value:s.NOTIFY_WORK_STARTED,text:i.get("workStarted"),icon:"play"},{value:s.SEND_MESSAGE,text:i.get("askForInformation"),icon:"question-circle"}],a[e.States.PROCESSING][t.STATUS.processing]=[{value:s.NOTIFY_READY,text:i.get("notifyReadiness"),icon:"check"},{value:s.SEND_MESSAGE,text:i.get("askForInformation"),icon:"question-circle"}],n[e.States.DRAFT]={},n[e.States.SUBMITTED]={},n[e.States.PENDING_PAYMENT]={},n[e.States.PAYMENT_COMPLETE]={},n[e.States.PAYMENT_ACCEPTED]={},n[e.States.PROCESSING]={},n[e.States.DELIVERED]={},n[e.States.CANCELLED]={},n[e.States.SUBMITTED][t.STATUS.submitted]=[{value:s.SEND_MESSAGE,text:i.get("askForInformation"),icon:"question-circle"},{value:s.CANCEL,text:i.get("cancelRequest"),icon:"close"}],n[e.States.SUBMITTED][t.STATUS.accepted]=[{value:s.PAY,text:i.get("confirmAndPay"),icon:"credit-card"},{value:s.SEND_MESSAGE,text:i.get("askForInformation"),icon:"question-circle"},{value:s.CANCEL,text:i.get("cancelRequest"),icon:"close"}],{buyerOptionsCart:n,sellerOptionsCart:a}}),define("DS/MPFBiddingNewMessage/SellerPhaseBiddingOptions",["UWA/Class","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFBiddingNewMessage/BiddingActions","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a){"use strict";return e.extend({init:function(e){this.cart=e.cart,this.cartPhases=e.cartPhases},getBiddingOptions:function(){return(this.cart.getState()===t.States.CANCEL?[]:this.cartPhases.isEmpty()?this._getPhaseCreationBiddingOptions():this._getPhaseBiddingOptions())||[]},_getPhaseBiddingOptions:function(){var e,t;if(t=this.cartPhases.getActivePhase())switch(t.getState()){case s.States.SUBMITTED:e=t.isNew()?this._getPhaseCreationBiddingOptions():this._getPhaseSubmittedBiddingOptions(t);break;case s.States.ACCEPTED:e=this._getPhaseAcceptedBiddingOptions(t);break;case s.States.PENDING_PROCESSING:e=this._getPhasePendingProcessingBiddingOptions(t);break;case s.States.PROCESSING:e=this._getPhaseProcessingBiddingOptions(t)}return e},_getPhaseCreationBiddingOptions:function(){return[{value:i.ACCEPT,text:a.get("proposeSchedule"),icon:"check"},{value:i.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"},{value:i.CANCEL,text:a.get("rejectRequest"),icon:"close"}]},_getPhaseSubmittedBiddingOptions:function(e){return[{value:i.ACCEPT_PHASE,text:a.get("acceptPhase",{number:e.getNumber()}),icon:"check"},{value:i.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"},{value:i.CANCEL_PHASE,text:a.get("cancelPhase",{number:e.getNumber()}),icon:"close"}]},_getPhaseAcceptedBiddingOptions:function(e){return[{value:i.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"},{value:i.CANCEL_PHASE,text:a.get("cancelPhase",{number:e.getNumber()}),icon:"close"}]},_getPhasePendingProcessingBiddingOptions:function(e){return[{value:i.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"},{value:i.NOTIFY_PHASE_WORK_STARTED,text:a.get("notifyPhaseWorkStarted",{number:e.getNumber()}),icon:"play"}]},_getPhaseProcessingBiddingOptions:function(e){return[{value:i.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"},{value:i.NOTIFY_PHASE_DELIVERY,text:a.get("notifyPhaseDelivery",{number:e.getNumber()}),icon:"truck-delivery",disabled:!e.hasDocuments()}]}})}),define("DS/MPFBiddingNewMessage/BiddingMessageContent",["UWA/Core","UWA/Promise","UWA/String","UWA/Class/View","DS/UIKIT/Input/Text","DS/UIKIT/Badge","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFShopModel/ShopModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFCartModel/CartItemCollection","DS/MPFCartModel/CartPatchOperation","DS/MPFCartModel/CartFactory","DS/MPFCartModel/CartItemFactory","DS/MPFCartPhaseModel/CartPhaseFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyModel/CompanyModel","DS/MPFTCContractModel/TCContractModel","DS/MPFAddressModel/AddressCollection","DS/MPFCountryModel/CountryCollection","DS/MPFBiddingNewMessage/BiddingUploadFileComponent","DS/MPFAmdLazyLoader/AmdLazyLoader","DS/MPFCompanyModel/CompanyHelper","DS/MPFBiddingNewMessage/BiddingCartHelper","DS/MPFBiddingNewMessage/BiddingAddress","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFString/MPFString","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,d,h,u,l,p,m,P,S,g,y,C,D,M,E,F,f,T,A,_,I,v,N,O,b){"use strict";var B={PAYMENT_DONE:"paymentDone"},w=i.extend({className:"mpf-bidding-message-content",setup:function(e){e||(e={}),this._checkPrototypes(e),this.service=e.service||o.ENGINEERING,this.buyerView=!0===e.buyerView,this.isDeliveryActive=!0===e.isDeliveryActive,this.buyerType=e.buyerType,this.me=e.me,this.company=e.company,this.shop=e.shop,this.cart=e.cart,this.cartItems=e.cartItems,this.cartPhases=e.cartPhases,this.cartFactory=e.cartFactory,this.cartItemFactory=e.cartItemFactory,this.tcContractFactory=e.tcContractFactory,this.addressFactory=e.addressFactory,this.companyFactory=e.companyFactory,this.addresses=e.addresses,this.linkToBankTransferFAQ=e.linkToBankTransferFAQ,this.annotations3dView=e.annotations3dView,this.hasPaymentPerPhase=e.hasPaymentPerPhase,this.countries=e.countries,this.uploadedFiles=e.uploadedFiles||[],this.request=this.cartItems.find(function(e){return e.getType()===l.Types.MAKE_REQUEST||e.getType()===l.Types.ENGINEERING_REQUEST}),this.textInput=this._createTextInput(e.message),this.fileListContainer=this._createFileListContainer(),this.buyerView&&this.isDeliveryActive&&(this.isShipping=!0,this.biddingAddressComponent=new v({buyerView:this.buyerView,buyerType:this.buyerType,me:this.me,company:this.company,addresses:this.addresses,cart:this.cart,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,companyFactory:this.companyFactory,addressFactory:this.addressFactory,countries:this.countries}))},render:function(){var t=[];return e.is(this.biddingAddressComponent)&&this.cart.getState()===u.States.DRAFT&&t.push(this.biddingAddressComponent.render()),Array.prototype.push.apply(t,[this.textInput,this.fileListContainer,this.annotations3dView.render()]),this.container.setContent(t),this},validate:function(e){var t,s,i,a,n;return s=""!==this.textInput.getValue().trim(),i=this.cart.getState()===u.States.DRAFT&&s,t=""!==e&&e!==N.SEND_MESSAGE&&e!==N.CANCEL&&e!==N.CANCEL_PHASE,n=i||t||s,e!==N.REJECT_PHASE_DELIVERY&&e!==N.NOTIFY_PHASE_DELIVERY||(n=n&&s),a=!this.hasPaymentPerPhase||e===N.SEND_MESSAGE||e===N.CANCEL||this.hasPaymentPerPhase&&this.cartPhases.size()>0&&this.cartPhases.validate().isValid(),this.container.toggleClassName("mpf-invalid",!n),n&&a},exportContent:function(){return{message:this.textInput.getValue(),uploadedFiles:this.uploadedFiles}},getSpecificDocuments:function(){return this.buyerView?this.uploadedFiles.filter(function(e){return e.docType===T.DocTypes.NDA}):this.uploadedFiles.filter(function(e){return e.docType===T.DocTypes.SALES_CONDITIONS})},getCartPatchOperations:function(s){var i,a,n=this,r=[];switch(i=this.getSpecificDocuments(),""===s&&this.cart.getState()===u.States.DRAFT&&(r.push(I.getSubmittedStateCartOperation(this.cart.getShopID(),this.isDeliveryActive,this.isShipping?this.biddingAddressComponent.getSelectedAddress().get("id"):"")),this.isDeliveryActive&&r.push(I.getDeliveryRequestItemOperation(this.cart.get("id"),this.isShipping,this.cart.getShopID())),r.push(I.getSubmittedStateCartItemOperation(this.request))),a=t.resolve(),s){case N.ACCEPT:r.push(I.getAcceptedStateCartItemOperation(this.request));break;case N.CANCEL:r.push(I.getCancelRequestOperation());break;case N.NOTIFY_WORK_STARTED:this.cartItems.forEach(function(e){r.push(I.getProcessingStateCartItemOperation(e))});break;case N.NOTIFY_SHIPPING:this.cartItems.forEach(e=>{r.push(I.getShippedStateCartItemOperation(e))});break;case N.NOTIFY_READY:this.cartItems.forEach(function(e){r.push(I.getReadyStateCartItemOperation(e))});break;case N.CONFIRM_DELIVERY:this.cartItems.forEach(e=>{r.push(I.getDeliveredStateCartItemOperation(e))});break;case N.PAY:a=this._launchCheckout()}return this.getDocAndAnnotationTimelineOperation(s,r,i),a.then(this._saveContract.bind(this,i)).then(function(t){var s;return e.is(t)&&(s=I.getAddContractOperation(t.get("id"),n.request.get("id"),t.getDocumentType()===E.DOCUMENT_TYPES.NDA?"nda":"custom-tc-seller"),r.push(s)),r})},_launchCheckout:function(){var e=this;return this.cartPhases.fetchPromise().then(function(){return e.cartPhases.isEmpty()?e._launchCheckoutV1():e._launchCheckoutV2()})},_launchCheckoutV1:function(){return A.getInstance().get(["DS/MPFModalConfiguratorComponent/CheckoutLauncherFactory"]).then(e=>{var t,s=e[0];return(t=new s({serviceRequest:this.service,idCart:this.cart.id,linkToBankTransferFAQ:this.linkToBankTransferFAQ})).whenReady().then(()=>{this.listenTo(t,s.Events.PAYMENT_COMPLETED,this._dispatchPaymentEvent.bind(this)),this.listenTo(t,s.Events.PURCHASE_ORDER_UPLOADED,this._dispatchPaymentEvent.bind(this)),this.listenTo(t,s.Events.PAYMENT_DECLINED,this._dispatchPaymentEvent.bind(this)),t.show()})})},_launchCheckoutV2:function(){var e,t,s=this;return e=this.cart.id,A.getInstance().get(["DS/MPFCheckout/CheckoutV2Factory","DS/MPFCheckout/CheckoutV2"]).then(function(s){var i=s[0];return t=s[1],i.from({service:o.ENGINEERING,cartId:e})}).then(function(e){s.listenTo(e,t.Events.PAYMENT_DONE,s._dispatchPaymentEvent.bind(s)),e.inject(document.body).render().show()})},getDocAndAnnotationTimelineOperation:function(t,s,i){var a,n,r,o=this,c=[];return this.uploadedFiles.filter(function(e){return e.docType===T.DocTypes.OTHER}).forEach(function(e){c.push(e.docID),s.push(I.getAddBiddingDocOperation(o.request.get("id"),e.docID))}),e.is(this.annotations3dView.getCartPatchOperations,"function")&&(n=(a=this.annotations3dView.getCartPatchOperations()).filter(function(e){return e.getOperation()===m.Operations.ADD&&"/bidding-documents"===e.getPath()}).map(function(e){return e.getValue().DocumentID}),Array.prototype.push.apply(c,n),Array.prototype.push.apply(s,a)),(r=this._getTimelineMessageOperation(t,c,i))&&s.push(r),s},_getTimelineMessageOperation:function(e,t,s){var i=this.textInput.getValue(),a=e===N.PAY,n=""===i.trim(),r=0===t.length;if(!(a&&n&&r))return i=this._deleteUnauthorizedCharacters(i),s.length>0&&(this.buyerView?i+="\n\n"+b.get("ndaAdded"):i+="\n\n"+b.get("specificSalesConditionAdded")),I.getAddMessageOperation(this.buyerView,t,i,this.cart)},_deleteUnauthorizedCharacters:function(e){var t=new O(e).hideEmailAddresses().escapeHTML();return t.wasEmailReplaced()?t.toString()+"\n\n"+b.get("inappropriateContent"):t.toString()},_dispatchPaymentEvent:function(e){this.dispatchEvent(B.PAYMENT_DONE,e)},_saveContract:function(s){var i,a;return e.is(s)&&s.length>0?((i=s[0]).docType===T.DocTypes.NDA&&(a={consumerID:this.shop.getOwner(),documentID:i.docID,supplierID:this.buyerType===c.COMPANY?this.company.get("id"):this.me.get("id")}),i.docType===T.DocTypes.SALES_CONDITIONS&&(a={consumerID:this.cart.getOwnerId(),documentID:i.docID,supplierID:this.me.getCompanyId()}),this.tcContractFactory.createModel(y.Types.EXISTING_DOCUMENT,a).savePromise()):t.resolve()},displayAddressChoices:function(e,t){this.isShipping=e,this.biddingAddressComponent.manageAddressChoices(e)},addDocument:function(e){e.docType!==T.DocTypes.NDA&&e.docType!==T.DocTypes.SALES_CONDITIONS||this._deleteDocOfSameType(e),this.uploadedFiles.push(e),this.fileListContainer.setContent(this.uploadedFiles.map(this.createBadge.bind(this)))},createBadge:function(e){var t=this;return new n({closable:!0,content:e.docName,icon:"doc",events:{onClose:function(){t._deleteFileWithName(e.docName),this.destroy()}}})},_deleteDocOfSameType:function(e){for(var t=this.uploadedFiles.length-1;t>=0;t--)this.uploadedFiles[t].docType===e.docType&&this.uploadedFiles.splice(t,1)},_deleteFileWithName:function(e){this.uploadedFiles=this.uploadedFiles.filter(function(t){return t.docName!==e})},_createFileListContainer:function(){var t=this;return e.createElement("div",{class:"mpf-file-list",html:this.uploadedFiles.map(function(e){return t.createBadge(e)})})},_createTextInput:function(e){var t;return t=this.cart.getState()===u.States.DRAFT?b.get("typeMessage")+"*":b.get("typeMessage"),new a({placeholder:t,rows:4,multiline:!0,value:e||"",events:{onKeyDown:this.validate.bind(this)}})},setMessage:function(e){this.textInput.setValue(e)},_checkPrototypes:function(e){r.requiredOfPrototype(e.me,d,"options.me must be a PersonModel"),r.requiredOfPrototype(e.cart,u,"options.cart must be a CartModel"),r.requiredOfPrototype(e.cartItems,p,"options.cartItems must be a CartItemCollection"),r.requiredOfPrototype(e.tcContractFactory,y,"options.tcContractFactory must be a TCContractFactory"),r.requiredOfPrototype(e.cartItemFactory,S,"options.cartItemFactory must be a CartItemFactory"),r.requiredOfPrototype(e.cartFactory,P,"options.cartFactory must be a CartFactory"),this.buyerView&&this.isDeliveryActive&&(r.requiredOfPrototype(e.companyFactory,C,"options.companyFactory must be a CompanyFactory"),r.requiredOfPrototype(e.addressFactory,D,"options.addressFactory must be an AddressFactory"),r.requiredOfPrototype(e.addresses,F,"options.addresses must be an AddressCollection"),r.requiredOfPrototype(e.countries,f,"options.countries must be a CountryCollection")),this.buyerView&&this.buyerType===c.COMPANY&&r.requiredOfPrototype(e.company,M,"options.company must be a CompanyModel"),this.buyerView&&T.isBuyerAllowedToUploadNDA(this.cart,this.request)&&r.requiredOfPrototype(e.shop,h,"options.shop must be a ShopModel")}});return w.Events=Object.freeze(B),w}),define("DS/MPFBiddingNewMessage/SendMessageHandler",["UWA/Class/Listener","DS/PlatformAPI/PlatformAPI","DS/MPFUtils/MPFUtils","DS/MPFAmdLazyLoader/AmdLazyLoader","DS/MPFString/MPFString","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFCartModel/CartItemCollection","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","DS/MPFTCContractModel/TCContractFactory","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFBiddingNewMessage/BiddingUploadFileComponent","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,d,h,u,l,p,m,P,S,g){"use strict";const y=new Map;y.set(P.CANCEL,c.States.CANCELLED),y.set(P.NOTIFY_WORK_STARTED,c.States.PROCESSING),y.set(P.NOTIFY_READY,c.States.PROCESSED),y.set(P.CONFIRM_DELIVERY,c.States.DELIVERED);const C=new Map;C.set(P.ACCEPT,d.States.ACCEPTED),C.set(P.UPDATE_AND_ACCEPT,d.States.ACCEPTED),C.set(P.NOTIFY_WORK_STARTED,d.States.PROCESSING),C.set(P.NOTIFY_READY,d.States.READY),C.set(P.NOTIFY_SHIPPING,d.States.SHIPPED),C.set(P.CONFIRM_DELIVERY,d.States.DELIVERED);const D=new Map;D.set(P.ACCEPT_PHASE,u.States.ACCEPTED),D.set(P.NOTIFY_PHASE_WORK_STARTED,u.States.PROCESSING),D.set(P.NOTIFY_PHASE_DELIVERY,u.States.READY),D.set(P.ACCEPT_PHASE_DELIVERY,u.States.DELIVERED),D.set(P.CANCEL_PHASE,u.States.DELETED);return class{constructor(t){n.requiredOfPrototype(t.me,o,"options.me must be a PersonModel"),n.requiredOfPrototype(t.cart,c,"options.cart must be a CartModel"),n.requiredOfPrototype(t.cartItems,h,"options.cartItems must be a CartItemCollection"),n.requiredOfPrototype(t.tcContractFactory,m,"options.tcContractFactory must be a TCContractFactory"),n.requiredOfType(t.onPaymentDone,"function","options.onPaymentDone must be a function"),this.me=t.me,this.cart=t.cart,this.cartItems=t.cartItems,this.cartPhases=t.cartPhases,this.shop=t.shop,this.company=t.company,this.tcContractFactory=t.tcContractFactory,this.activePhasePayment=t.activePhasePayment,this.isBuyerView=t.isBuyerView,this.validateSend=t.validateSend||s.alwaysTrue,this.cartPatchOpFactory=t.cartPatchOpFactory,this.service=t.service,this.onPaymentDone=t.onPaymentDone,this.listener=new e}validate({text:e,files:t,option:s}){return Promise.all([this._validateMessage({text:e,option:s}),this.validateSend({action:s.value,cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases})]).then(([e,t])=>({isMessageValid:e,isValid:e&&t}))}async sendMessage({text:e,files:t,option:s}){const{nda:i,salesConditions:a,otherFiles:n}=this._sortFiles(t);let r;i&&this.isBuyerView?r=await this._saveNda(i):a&&!this.isBuyerView&&(r=await this._saveSalesConditions(a)),await this._patchCart({text:e,nda:i,salesConditions:a,contract:r,otherFiles:n,option:s}),this._hasCartPhases()&&await this._refreshPhasesAndPayment(),s.value===P.PAY&&await this._launchCheckout(),this._publishUpdateEvents()}async _saveNda(e){return this.tcContractFactory.createModel(m.Types.EXISTING_DOCUMENT,{consumerID:this.shop.getOwner(),documentID:e.docID,supplierID:this.buyerType===r.COMPANY?this.company.get("id"):this.me.get("id")}).savePromise()}async _saveSalesConditions(e){return this.tcContractFactory.createModel(m.Types.EXISTING_DOCUMENT,{consumerID:this.cart.getOwnerId(),documentID:e.docID,supplierID:this.me.getCompanyId()}).savePromise()}async _patchCart({text:e,nda:t,salesConditions:s,contract:i,otherFiles:a=[],option:n}){const r=new l;if(e=this._deleteUnauthorizedCharacters(e),i){let a;t&&this.isBuyerView?(e+="\n\n"+g.get("ndaAdded"),a="nda"):s&&!this.isBuyerView&&(e+="\n\n"+g.get("specificSalesConditionAdded"),a="custom-tc-seller"),r.add(new p(p.Operations.add,"/contracts",{ContractID:i.get("id"),CartItemID:this._getRequestFromCartItems().get("id"),documentType:a}))}const o=[],c=this._getRequestFromCartItems().get("id");return a.forEach(e=>{o.push(e.docID),r.add(new p(p.Operations.add,"/bidding-documents",{CartItemID:c,DocumentID:e.docID}))}),(n.value!==P.PAY||e||a)&&r.add(new p(p.Operations.add,"/message",{author:this.isBuyerView?"mdpeoplecompany/people/"+this.cart.getOwnerId():"/mdshop/shops/"+this.cart.getShopID(),documentIDs:o,message:e})),"function"==typeof this.cartPatchOpFactory&&r.addAll(this.cartPatchOpFactory({action:n.value,cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases})),this._hasCartPhases()?r.add(this._getCartPhaseOperation({option:n})):(r.add(this._getCartOperations({option:n})),r.addAll(this._getCartItemOperations({option:n}))),this.cart.megaPatch(r)}async _launchCheckout(){return this.cartPhases&&this.cartPhases.size()>=0?this._launchCheckoutV2():this._launchCheckoutV1()}async _launchCheckoutV1(){const[e]=await i.getInstance().get(["DS/MPFModalConfiguratorComponent/CheckoutLauncherFactory"]),t=new e({serviceRequest:this.service,idCart:this.cart.get("id"),linkToBankTransferFAQ:this.linkToBankTransferFAQ});await t.whenReady(),this.listener.listenTo(t,{[e.Events.PAYMENT_COMPLETED]:this._onPaymentDone.bind(this),[e.Events.PURCHASE_ORDER_UPLOADED]:this._onPaymentDone.bind(this),[e.Events.PAYMENT_DECLINED]:this._onPaymentDone.bind(this)}),t.show()}async _launchCheckoutV2(){const[e,t]=await i.getInstance().get(["DS/MPFCheckout/CheckoutV2Factory","DS/MPFCheckout/CheckoutV2"]),s=await e.from({service:this.service,cartId:this.cart.get("id")});this.listener.listenTo(s,t.Events.PAYMENT_DONE,this._onPaymentDone.bind(this)),s.inject(document.body).render().show()}_onPaymentDone(){this.onPaymentDone()}_getCartPhaseOperation({option:e}){const t=D.get(e.value);if(t)return new p(p.Operations.MODIFY,"/phases/"+this.cartPhases.getActivePhase().get("id"),{[u.Fields.STATE]:t})}_getCartOperations({option:e}){const t=y.get(e.value);if(t||this.cart.hasPendingChanges())return new p(p.Operations.modify,"/",{[c.Fields.STATE]:t,...this.cart.getPendingChanges()})}_getCartItemOperations({option:e}){const t=[],s=C.get(e.value);return this.cartItems.forEach(e=>{(s||e.hasPendingChanges())&&t.push(new p(p.Operations.modify,"/cart-items/"+e.get("id"),{[u.Fields.STATE]:s,...e.getPendingChanges()}))}),t}async _refreshPhasesAndPayment(){await this.cartPhases.fetchPromise(),this.activePhasePayment.clear({silent:!0});const e=this.cartPhases.getActivePhase();if(e)return this.activePhasePayment.setParentResourceId(e.get("id")),this.activePhasePayment.fetchPromise()}_publishUpdateEvents(){t.publish("MPCartTimeline",{event:"refresh",cartId:this.cart.id}),t.publish("MPFDeferredPaymentNotices",{event:"update"})}_sortFiles(e){let t,s;const i=[];for(let a=0;a<e.length;a++){const n=e[a];n.docType===S.DocTypes.NDA?t=n:n.docType===S.DocTypes.SALES_CONDITIONS?s=n:i.push(n)}return{nda:t,salesConditions:s,otherFiles:i}}_deleteUnauthorizedCharacters(e){var t=new a(e).hideEmailAddresses().escapeHTML();return t.wasEmailReplaced()?t.toString()+"\n\n"+g.get("inappropriateContent"):t.toString()}_validateMessage({text:e,option:t}){const s=""!==e,i=this.cart.getState()===c.States.DRAFT&&s,a=t.value,n=""!==a&&a!==P.SEND_MESSAGE&&a!==P.CANCEL&&a!==P.CANCEL_PHASE;let r=i||n||s;return a!==P.REJECT_PHASE_DELIVERY&&a!==P.NOTIFY_PHASE_DELIVERY||(r=r&&s),r}_hasCartPhases(){return this.cartPhases&&this.cartPhases.size()>0}_getRequestFromCartItems(){return this.cartItems.find(function(e){return e.getType()===d.Types.MAKE_REQUEST||e.getType()===d.Types.ENGINEERING_REQUEST})}}}),define("DS/MPFBiddingNewMessage/BuyerPhaseBiddingOptions",["UWA/Class","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFBiddingNewMessage/BiddingActions","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n){"use strict";return e.extend({init:function(e){this.cart=e.cart,this.cartPhases=e.cartPhases,this.activePhasePayment=e.activePhasePayment},getBiddingOptions:function(){return(this.cart.getState()===t.States.CANCELLED?[]:this.cartPhases.isEmpty()?this.cart.getState()===t.States.DRAFT?[]:[{value:a.SEND_MESSAGE,text:n.get("askForInformation"),icon:"question-circle"},{value:a.CANCEL,text:n.get("cancelRequest"),icon:"close"}]:this._getBuyerBiddingOptionsForPhases())||[]},_getBuyerBiddingOptionsForPhases:function(){var e,t;if(t=this.cartPhases.getActivePhase())switch(t.getState()){case s.States.SUBMITTED:e=this._getBuyerBiddingOptionsForPhaseSubmitted(t);break;case s.States.ACCEPTED:e=this._getBuyerBiddingOptionsForPhaseAccepted(t);break;case s.States.READY:e=this._getBuyerBiddingOptionsForPhaseReady(t)}return e},_getBuyerBiddingOptionsForPhaseSubmitted:function(e){return[{value:a.SEND_MESSAGE,text:n.get("askForInformation"),icon:"question-circle"},{value:a.CANCEL_PHASE,text:n.get("cancelPhase",{number:e.getNumber()}),icon:"close"}]},_getBuyerBiddingOptionsForPhaseAccepted:function(e){var t,s,r,o;return t=[{value:a.SEND_MESSAGE,text:n.get("askForInformation"),icon:"question-circle"},{value:a.CANCEL_PHASE,text:n.get("cancelPhase",{number:e.getNumber()}),icon:"close"}],this.activePhasePayment.isNew()||(s=this.activePhasePayment.getState(),r=this.activePhasePayment.getPaymentMethod()===i.PaymentMethods.BANK_CARD&&(s===i.States.PENDING_PAYMENT||s===i.States.PAYMENT_INITIATED),o=this.activePhasePayment.getPaymentMethod()===i.PaymentMethods.BANK_CARD&&s===i.States.PAYMENT_REFUSED,this.cart.isBlocked()||s!==i.States.DRAFT&&!r&&!o||t.unshift({value:a.PAY,text:n.get("confirmAndPayPhase",{number:e.getNumber()}),icon:"credit-card"})),t},_getBuyerBiddingOptionsForPhaseReady:function(e){var t;return t=[{value:a.SEND_MESSAGE,text:n.get("askForInformation"),icon:"question-circle"}],(this.activePhasePayment.getPaymentMethod()===i.PaymentMethods.BANK_CARD||this.activePhasePayment.getBuyerInvoiceNumber())&&(t.unshift({value:a.ACCEPT_PHASE_DELIVERY,text:n.get("acceptPhaseDelivery",{number:e.getNumber()}),icon:"check"}),t.push({value:a.REJECT_PHASE_DELIVERY,text:n.get("rejectPhaseDelivery",{number:e.getNumber()}),icon:"close"})),t}})}),define("DS/MPFBiddingNewMessage/MakeBiddingOptions",["DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFBiddingNewMessage/BiddingActions","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i){"use strict";return class{static getOptions({isBuyerView:t,cart:s,cartItem:i}){const a=i.getState(),n=s.isDirectPurchase(),r=s.hasPendingChanges()||i.hasPendingChanges(),o=!s.get(e.Fields.SHIP_TO),c={cart:s,isDirectPurchase:n,hasCartOrItemChanged:r,cartItemState:a,isOrderPickedUp:o};return(t?this._getBuyerOptions(c):this._getSellerOptions(c))||[]}static _getBuyerOptions({cart:a,isDirectPurchase:n,hasCartOrItemChanged:r,cartItemState:o,isOrderPickedUp:c}){switch(a.getState()){case e.States.SUBMITTED:switch(o){case t.States.SUBMITTED:return[{value:r?s.UPDATE:s.SEND_MESSAGE,text:r?i.get("update"):i.get("askForInformation"),icon:r?"doc-update":"question-circle"},{value:s.CANCEL,text:i.get("cancelRequest"),icon:"close"}];case t.States.ACCEPTED:return[{value:s.PAY,text:i.get("confirmAndPay"),icon:"credit-card"},{value:s.SEND_MESSAGE,text:i.get("askForInformation"),icon:"question-circle"},{value:s.CANCEL,text:i.get("cancelRequest"),icon:"close"}]}break;case e.States.PAYMENT_COMPLETE:switch(o){case t.States.SUBMITTED:return[{value:s.SEND_MESSAGE,text:i.get("askForInformation"),icon:"question-circle"},{value:s.CANCEL,text:i.get("cancelRequest"),icon:"close"}]}break;case e.States.PROCESSING:switch(o){case t.States.SHIPPED:return[{value:s.CONFIRM_DELIVERY,text:i.get("confirmDelivery"),icon:"check"},{value:s.SEND_MESSAGE,text:i.get("askForInformation"),icon:"question-circle"}]}}}static _getSellerOptions({cart:a,isDirectPurchase:n,hasCartOrItemChanged:r,cartItemState:o,isOrderPickedUp:c}){switch(a.getState()){case e.States.SUBMITTED:switch(o){case t.States.SUBMITTED:{const e=[{value:r?s.UPDATE:s.SEND_MESSAGE,text:r?i.get("update"):i.get("askForInformation"),icon:"question-circle"},{value:s.CANCEL,text:i.get("rejectRequest"),icon:"close"}];return this._canAcceptRequest(a)&&e.unshift({value:r?s.UPDATE_AND_ACCEPT:s.ACCEPT,text:r?i.get("updateAndAccept"):i.get("acceptRequest"),icon:"check"}),e}case t.States.ACCEPTED:return[{value:r?s.UPDATE:s.SEND_MESSAGE,text:r?i.get("update"):i.get("askForInformation"),icon:"question-circle"},{value:s.CANCEL,text:i.get("rejectRequest"),icon:"close"}]}break;case e.States.PAYMENT_ACCEPTED:switch(o){case t.States.PENDING_PROCESSING:return[{value:s.NOTIFY_WORK_STARTED,text:i.get("workStarted"),icon:"play"},{value:s.SEND_MESSAGE,text:i.get("askForInformation"),icon:"question-circle"}]}break;case e.States.PAYMENT_COMPLETE:switch(o){case t.States.SUBMITTED:{const e=[{value:s.SEND_MESSAGE,text:i.get("askForInformation"),icon:"question-circle"},{value:s.CANCEL,text:i.get("rejectRequest"),icon:"close"}];return this._canAcceptRequest(a)&&e.unshift({value:s.ACCEPT,text:i.get("acceptRequest"),icon:"check"}),e}}break;case e.States.PROCESSING:switch(o){case t.States.PROCESSING:return[{value:c?s.NOTIFY_READY:s.NOTIFY_SHIPPING,text:c?i.get("notifyReadiness"):i.get("notifyShipping"),icon:c?"parcel-ok":"trolley"},{value:s.SEND_MESSAGE,text:i.get("askForInformation"),icon:"question-circle"}]}}}static _canAcceptRequest(e){const t=e.getGrossAmountTotal();return t&&t>=0}}}),define("DS/MPFBiddingNewMessage/PhaseBiddingOptions",["UWA/Class","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFBiddingNewMessage/BuyerPhaseBiddingOptions","DS/MPFBiddingNewMessage/SellerPhaseBiddingOptions","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n,r,o){"use strict";return e.extend({init:function(e){this.cart=e.cart,this.cartPhases=e.cartPhases,this.activePhasePayment=e.activePhasePayment,this.buyerBiddingOptions=null,this.sellerBiddingOptions=null},getBuyerBiddingOptions:function(){return this.buyerBiddingOptions||(this.buyerBiddingOptions=new n({cart:this.cart,cartPhases:this.cartPhases,activePhasePayment:this.activePhasePayment})),this.buyerBiddingOptions.getBiddingOptions()},getSellerBiddingOptions:function(){return this.sellerBiddingOptions||(this.sellerBiddingOptions=new r({cart:this.cart,cartPhases:this.cartPhases})),this.sellerBiddingOptions.getBiddingOptions()}})}),define("DS/MPFBiddingNewMessage/ButtonsOptions",["UWA/Class/View","DS/UIKIT/Input/Button","DS/MPFServices/ObjectService","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFBiddingNewMessage/PhaseBiddingOptions","DS/MPFBiddingNewMessage/MakeBiddingOptions","DS/MPFServices/MarketplaceServices","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,d){"use strict";const h=Object.freeze({OPTION_SELECTED:"optionSelected"}),u=e.extend({className:"mpf-bidding-options-container",setup:function(e={}){s.requiredOfPrototype(e.cart,o,"options.cart must be a CartModel"),s.requiredOfPrototype(e.cartItem,c,"options.cartItem must be a CartItemModel"),this.cart=e.cart,this.cartItem=e.cartItem,this.cartPhases=e.cartPhases,this.activePhasePayment=e.activePhasePayment,this.buyerView=!0===e.buyerView,this.service=e.service||r.INNOVATE},render:function(){const e=(this.service===r.MAKE?this._getMakeBiddingOptions():this._getEngineeringBiddingOptions()).map(e=>this._renderButton(e));return this.container.setContent(e),this},update({item:e,phases:t}){e&&this.cartItem!==e&&(this.cartItem=e),t&&this.cartPhases!==t&&(this.cartPhases=t)},hasButtons(){return this.container.getElements("button").length>0},getDefaultOption:()=>({value:i.SEND_MESSAGE,text:d.get("askForInformation"),icon:"question-circle"}),_renderButton({icon:e,text:s,value:i}){return new t({icon:e,value:s,name:i,events:{onClick:this.dispatchEvent.bind(this,h.OPTION_SELECTED,{icon:e,text:s,value:i})}})},_getMakeBiddingOptions(){return n.getOptions({cart:this.cart,cartItem:this.cartItem,isBuyerView:this.buyerView})},_getEngineeringBiddingOptions(){const e=new a({cart:this.cart,cartPhases:this.cartPhases,activePhasePayment:this.activePhasePayment});return this.buyerView?e.getBuyerBiddingOptions():e.getSellerBiddingOptions()}});return u.Events=Object.freeze(h),u}),define("DS/MPFBiddingNewMessage/BiddingMessageContentV2",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Text","DS/UIKIT/Badge","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFBiddingNewMessage/BiddingUploadFileComponent","DS/MPFString/MPFString","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n,r,o,c){"use strict";return t.extend({className:"mpf-bidding-message-content-v2",setup(e={}){this.service=e.service||n.ENGINEERING,this.isBuyerView=!0===e.isBuyerView,this.uploadedFiles=e.files||[],this.textInput=this._createTextInput(e.message)},render(){return this.container.setContent([this.textInput,{tag:"div",class:"mpf-file-list",html:this.uploadedFiles.map(e=>this._createBadge(e))}]),this.showValidity(!0),this},setMessage(e){this.textInput.setValue(e)},getMessage(){return this.textInput.getValue().trim()},clear(){this.setMessage(""),this.uploadedFiles=[]},getUploadedFiles(){return this.uploadedFiles},showValidity(e){this.container.toggleClassName("mpf-invalid",!e)},addDocument(e){e.docType!==r.DocTypes.NDA&&e.docType!==r.DocTypes.SALES_CONDITIONS||this._deleteDocOfSameType(e),this.uploadedFiles.push(e),this.render()},getSpecificDocuments(){return this.isBuyerView?this.uploadedFiles.filter(function(e){return e.docType===r.DocTypes.NDA}):this.uploadedFiles.filter(function(e){return e.docType===r.DocTypes.SALES_CONDITIONS})},_deleteUnauthorizedCharacters(e){const t=new o(e).hideEmailAddresses().escapeHTML();return t.wasEmailReplaced()?t.toString()+"\n\n"+c.get("inappropriateContent"):t.toString()},_createBadge(e){const t=this;return new i({closable:!0,content:e.docName,icon:"doc",events:{onClose:function(){t._deleteFileWithName(e.docName),this.destroy()}}})},_deleteDocOfSameType(e){for(let t=this.uploadedFiles.length-1;t>=0;t--)this.uploadedFiles[t].docType===e.docType&&this.uploadedFiles.splice(t,1)},_deleteFileWithName(e){this.uploadedFiles=this.uploadedFiles.filter(function(t){return t.docName!==e})},_createTextInput:e=>new s({placeholder:c.get("typeMessage"),rows:4,multiline:!0,value:e||""})})}),define("DS/MPFBiddingNewMessage/BiddingNewMessageV2",["UWA/Class/View","DS/PlatformAPI/PlatformAPI","DS/UIKIT/Input/Button","DS/UIKIT/Alert","DS/UIKIT/Mask","DS/MPFUtils/MPFUtils","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","DS/MPFShopModel/ShopModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFCartModel/CartItemCollection","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFTCContractModel/TCContractModel","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFBiddingNewMessage/ButtonsOptions","DS/MPFBiddingNewMessage/BiddingUploadFileComponent","DS/MPFBiddingNewMessage/BiddingMessageContentV2","DS/MPFBiddingNewMessage/CancelConfirmationModal","DS/MPFBiddingNewMessage/SendMessageHandler","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage","css!DS/MPFBiddingNewMessage/MPFBiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,d,h,u,l,p,m,P,S,g,y,C,D,M,E,F,f){"use strict";const T=Object.freeze({PAYMENT_DONE:"paymentDone",ACTION_PERFORMED:"actionPerformed",SAVING_ERROR:"savingError",OPTION_SELECTED:"optionSelected"}),A=e.extend({tagName:"div",className:"mpf-bidding-new-message-v2",setup(e={}){r.requiredOfPrototype(e.me,d,"options.me must be a PersonModel"),r.requiredOfPrototype(e.cart,l,"options.cart must be a CartModel"),r.requiredOfPrototype(e.cartItems,m,"options.cartItems must be a CartItemCollection"),r.requiredOfPrototype(e.tcContractFactory,S,"options.tcContractFactory must be a TCContractFactory"),r.requiredOfPrototype(e.tcDocumentFactory,P,"options.tcDocumentFactory must be a TCDocumentFactory"),e.isBuyerView&&(e.buyerType===c.COMPANY&&r.requiredOfPrototype(e.company,h,"options.company must be a CompanyModel"),e.cart.getState()===l.States.SUBMITTED&&(r.requiredOfPrototype(e.shop,u,"options.shop must be a ShopModel"),r.requiredOfPrototype(e.nda,g,"options.nda must be a TcContractModel"))),this.me=e.me,this.cart=e.cart,this.cartItems=e.cartItems,this.company=e.company,this.shop=e.shop,this.cartPhases=e.cartPhases,this.activePhasePayment=e.activePhasePayment,this.nda=e.nda,this.tcContractFactory=e.tcContractFactory,this.tcDocumentFactory=e.tcDocumentFactory,this.isBuyerView=!0===e.isBuyerView,this.buyerType=e.buyerType,this.service=e.service||o.INNOVATE,this.maxFileSize=e.maxFileSize,this.maxSpecificFileSize=e.maxSpecificFileSize,this.selectedOption=e.selectedOption,this.validateSend=e.validateSend||n.alwaysTrue,this.customButtons=e.customButtons,this.cartPatchOpFactory=e.cartPatchOpFactory,this.alert=this._createAlert(),this.optionsButtons=this._createOptionsButtons(),this.messageInput=this._createMessageInput({files:e.files,message:e.message}),this.uploadFileComponent=this._createUploadFileComponent(),this.cancelModal=this._createCancelModal(),this.sendMessageHandler=this._createSendMessageHandler(),t.subscribe("MPPurchaseOrderUploaded",this.render.bind(this))},render(){let e=[this.cancelModal,this.optionsButtons.render()];return this.optionsButtons.hasButtons()||(this.selectedOption=this.optionsButtons.getDefaultOption()),this.selectedOption&&(e=e.concat([{tag:"div",class:"mpf-message-label",text:f.get("message")},this.messageInput.render(),{tag:"div",class:"mpf-bidding-buttons",html:[this.uploadFileComponent.render(),this.customButtons,this._renderSendButton()]}])),this.container.setContent(e),this},async validate(){const{isMessageValid:e,isValid:t,errorMessage:s}=await this.sendMessageHandler.validate({text:this.messageInput.getMessage(),files:this.messageInput.getUploadedFiles(),option:this.selectedOption});return this.messageInput.showValidity(e),s&&this.alert.add({className:"error",message:s}).show(),t},destroy(){this.stopListening(),this.optionsButtons.destroy(),this.messageInput.destroy(),this.uploadFileComponent.destroy(),this.cancelModal.destroy(),this.sendMessageHandler=null,this.me=null,this.cart=null,this.cartItems=null,this.cartPhases=null,this.company=null,this.shop=null,this.activePhasePayment=null,this.nda=null,this.tcDocumentFactory=null,this._parent(),this.container=null},_reset(){this.messageInput.clear(),this.selectedOption=null;const e=this.cart.getItems();return Array.isArray(e)&&e.length>0&&this.cartItems.reset(this.cart.getItems()),this.optionsButtons.update({item:this._findFirstRequestCartItem()}),this},_findFirstRequestCartItem(){return this.cartItems.find(e=>e.getType()===p.Types.MAKE_REQUEST||e.getType()===p.Types.ENGINEERING_REQUEST)},async _prepareMessage(){let e=!1;try{e=await this.validate()}catch(e){console.error(e)}if(e){const e=this.selectedOption.value;if(e!==y.CANCEL_PHASE&&e!==y.CANCEL)return this._sendMessage();this.cancelModal.render({isPhaseCancel:e===y.CANCEL_PHASE,phase:this.cartPhases&&this.cartPhases.getActivePhase()}).show()}},async _sendMessage(){a.mask(this.container);try{const e=this.selectedOption;await this.sendMessageHandler.sendMessage({text:this.messageInput.getMessage(),files:this.messageInput.getUploadedFiles(),option:e}),a.unmask(this.container),this._reset().render(),this.dispatchEvent(T.ACTION_PERFORMED,e)}catch(e){a.unmask(this.container),console.error(e),this.dispatchEvent(T.SAVING_ERROR)}},_createAlert:()=>new i({visible:!1}),_createCancelModal(){const e=new E;return this.listenTo(e,E.Events.CONFIRMED,()=>{this._sendMessage().then(()=>{e.hide(),e.setLoading(!1)})}),e},_createMessageInput({files:e}){return new M({service:this.service,isBuyerView:this.isBuyerView,files:e})},_renderSendButton(){return new s({className:"primary mpf-send-button",value:this.selectedOption.text,events:{onClick:()=>{this._prepareMessage()}}})},_createOptionsButtons(){const e=new C({buyerView:this.isBuyerView,cart:this.cart,cartItem:this._findFirstRequestCartItem(),cartPhases:this.cartPhases,activePhasePayment:this.activePhasePayment,service:this.service});return this.listenTo(e,C.Events.OPTION_SELECTED,e=>{this.selectedOption&&this.selectedOption.value===e.value?this.selectedOption=null:this.selectedOption=e,this.render(),this.dispatchEvent(T.OPTION_SELECTED,this.selectedOption)}),e},_createUploadFileComponent(){const e=new D({buyerView:this.isBuyerView,tcDocumentFactory:this.tcDocumentFactory,cart:this.cart,cartItem:this._findFirstRequestCartItem(),maxFileSize:this.maxFileSize,maxSpecificFileSize:this.maxSpecificFileSize,nda:this.nda,alwaysAllowDocUpload:!0});return this.listenTo(e,D.Events.DOCUMENT_SAVED,e=>{this.messageInput.addDocument(e)}),e},_createSendMessageHandler(){return new F({me:this.me,cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases,activePhasePayment:this.activePhasePayment,shop:this.shop,company:this.company,tcContractFactory:this.tcContractFactory,cartPatchOpFactory:this.cartPatchOpFactory,isBuyerView:this.isBuyerView,validateSend:this.validateSend,service:this.service,onPaymentDone:async()=>{a.mask(this.container),await this.cart.fetchPromise({expand:[l.Expands.CART_ITEMS]}),this._reset().render(),a.unmask(this.container),this.dispatchEvent(T.PAYMENT_DONE,this.cart)}})}});return A.Events=T,A}),define("DS/MPFBiddingNewMessage/BiddingNewMessage",["UWA/Core","UWA/Promise","UWA/Class/View","DS/PlatformAPI/PlatformAPI","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFShopModel/ShopModel","DS/MPFCompanyModel/CompanyModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFCartModel/CartItemCollection","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartPhaseModel/CartPhaseCollection","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","DS/MPFCartModel/CartFactory","DS/MPFCartModel/CartItemFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFAddressModel/AddressFactory","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFAddressModel/AddressCollection","DS/MPFCountryModel/CountryCollection","DS/MPFTCContractModel/TCContractModel","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFBiddingNewMessage/ButtonsOptions","DS/MPFBiddingNewMessage/BiddingDeliveryMethod","DS/MPFBiddingNewMessage/BiddingUploadFileComponent","DS/MPFBiddingNewMessage/BiddingMessageContent","DS/MPFBiddingNewMessage/CancelConfirmationModal","DS/MPFCartPhaseComponent/CartPhaseCreator","DS/MPFCartPhaseComponent/CartPhaseHelper","DS/MPFUtils/MPFUtils","DS/MPFView/EmptyView","DS/MPFCartModel/CartDuplicateOperation","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage","css!DS/MPFBiddingNewMessage/MPFBiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,d,h,u,l,p,m,P,S,g,y,C,D,M,E,F,f,T,A,_,I,v,N,O,b,B,w,R,U,k,x,L){"use strict";var V={PAYMENT_DONE:"paymentDone",ACTION_PERFORMED:"actionPerformed",OPTION_SELECTED:"optionSelected",PHASE_CANCELLED:"phaseCancelled",CART_DUPLICATED:"cartDuplicated"},q=s.extend({tagName:"div",className:"mpf-bidding-new-message",setup:function(e){e||(e={}),this._checkPrototypes(e),this.isDeliveryActive=!0===e.isDeliveryActive,this.buyerView=!0===e.buyerView,this.buyerType=e.buyerType,this.cartFactory=e.cartFactory,this.cartItemFactory=e.cartItemFactory,this.addressFactory=e.addressFactory,this.companyFactory=e.companyFactory,this.tcDocumentFactory=e.tcDocumentFactory,this.tcContractFactory=e.tcContractFactory,this.cartPhaseFactory=e.cartPhaseFactory,this.cart=e.cart,this.cartItems=e.cartItems,this.cartPhases=e.cartPhases,this.activePhasePayment=e.activePhasePayment,this.me=e.me,this.company=e.company,this.shop=e.shop,this.multibiddingShopIds=e.multibiddingShopIds||[],this.cartDuplicateOperationDataProxy=e.cartDuplicateOperationDataProxy,this.addresses=e.addresses,this.countries=e.countries,this.service=e.service||o.INNOVATE,this.onMenuRefresh=e.onMenuRefresh||U.doNothing,this.validateSend=e.validateSend||U.alwaysTrue,this.buyerTermsOfUseComponent=e.buyerTermsOfUseComponent,this.linkToBankTransferFAQ=e.linkToBankTransferFAQ,this.annotations3dView=e.annotations3dView||k.getInstance(),this.hasPaymentPerPhase=!0===e.hasPaymentPerPhase||!0===e.hasPayementPerPhase,this.maxFileSize=e.maxFileSize,this.maxSpecificFileSize=e.maxSpecificFileSize,this.getPhaseAttributesUpdateForAction=e.getPhaseAttributesUpdateForAction||U.doNothing,this.message=e.message,this.uploadedFiles=e.uploadedFiles,this.selectedOption=e.selectedOption,this.nda=e.nda,this.request=this.cartItems.find(function(e){return e.getType()===p.Types.MAKE_REQUEST||e.getType()===p.Types.ENGINEERING_REQUEST}),this.request.changeTracker.reset(),this.sendButton=this._createSendButton(),this.messageLabelContainer=this._createMessageLabelContainer(),this.biddingDeliveryMethodComponent=this._createBiddingDeliveryMethodComponent(),this.messageContentComponent=this._createBiddingMessageComponent(),this.uploadFileComponent=this._createUploadFileComponent(),this.optionsMenu=this._createOptionsMenuComponent(),this.phaseCreator=this._createPhaseCreator(),this._initListeners(),i.subscribe("MPPurchaseOrderUploaded",this._onPaymentDone.bind(this))},render:function(){var t,s,i;return this.cart.getState()===l.States.CANCELLED?(this.container.setContent(),this):(t=[this.optionsMenu.render()],this.isDeliveryActive&&t.push(this.biddingDeliveryMethodComponent.render()),Array.prototype.push.apply(t,[this.messageLabelContainer,this.messageContentComponent.render(),this.phaseCreator.render()]),e.is(this.buyerTermsOfUseComponent)&&t.push(this.buyerTermsOfUseComponent.render()),s=e.createElement("div",{class:"mpf-bidding-buttons",html:[this.sendButton,this.uploadFileComponent.render()]}),t.push(s),(i=this.getElement(".mask"))&&t.push(i),this.container.setContent(t),this.optionsMenu.hasButtons()&&!this.selectedOption&&(this.messageLabelContainer.hide(),this.messageContentComponent.hide(),this.uploadFileComponent.hide(),this.sendButton.hide()),this.selectedOption&&"accept"===this.selectedOption.value&&this.cartPhases.size()>0||this.phaseCreator.hide(),this)},getCartItems:function(){return this.cartItems},exportContent:function(){return Object.assign({selectedOption:this.selectedOption},this.messageContentComponent.exportContent())},destroy:function(){this.stopListening(),i.unsubscribe("MPPurchaseOrderUploaded"),this.biddingDeliveryMethodComponent&&this.biddingDeliveryMethodComponent.destroy(),this.uploadFileComponent.destroy(),this.messageContentComponent.destroy(),this.optionsMenu.destroy(),this.phaseCreator.destroy(),this._parent(),this.container=null},_performSendMessageAction:function(e){var s,i=this;switch(e){case I.SEND_MESSAGE:s=this._patchCart(e).then(function(){i.dispatchEvent(V.ACTION_PERFORMED,{action:e})});break;case I.CANCEL:s=t.cast(this._displayCancelConfirmationModal({isPhaseCancel:!1}));break;case I.CANCEL_PHASE:s=t.cast(this._displayCancelConfirmationModal({isPhaseCancel:!0,phase:this.cartPhases.getActivePhase()}));break;case I.ACCEPT:s=this._accept(e);break;case I.ACCEPT_PHASE:s=this._updatePhasePatchAndRefresh(P.States.ACCEPTED,e);break;case I.NOTIFY_PHASE_WORK_STARTED:s=this._updatePhasePatchAndRefresh(P.States.PROCESSING,e);break;case I.NOTIFY_PHASE_DELIVERY:s=this._updatePhasePatchAndRefresh(P.States.READY,e,!0);break;case I.ACCEPT_PHASE_DELIVERY:s=this._updatePhasePatchAndRefresh(P.States.DELIVERED,e,!0);break;case I.REJECT_PHASE_DELIVERY:s=this._updatePhasePatchAndRefresh(P.States.PROCESSING,e);break;default:var a=this._getPatchOperationFromExternalAttributeUpdate(e);s=this._patchCart(e,a).then(function(){i.dispatchEvent(V.ACTION_PERFORMED,{action:e})})}return s},_sendMessage:function(){var s=this,i=e.is(this.selectedOption)?this.selectedOption.value:"";return n.mask(this.container),this.deleteErrorMessage(),t.all([this.messageContentComponent.validate(i),this.validateSend({action:i,cart:this.cart,cartItems:this.cartItems})]).then(function(e){if(e[0]&&("boolean"!=typeof e[1]||!1!==e[1]))return s._performSendMessageAction(i);s.hasPaymentPerPhase&&s.phaseCreator.validate()}).catch(function(e){console.error(e),s._displayErrorMsg(e,i)}).finally(function(){n.unmask(s.container)})},_accept:function(){var e=this;let t;if(this.hasPaymentPerPhase){if(null===(t=this.phaseCreator.getCartPatchOperations()))return}else t=new g;const s=this._getPatchOperationFromExternalAttributeUpdate(I.ACCEPT);return t.add(s),this.messageContentComponent.getCartPatchOperations(I.ACCEPT).then(function(s){if(t.addAll(s),t.length()>0)return e.cart.megaPatch(t)}).then(()=>this.hasPaymentPerPhase&&this._refreshPhasesAndPayment()).then(function(){e._refresh(),e._refreshTimeline(),e.dispatchEvent(V.ACTION_PERFORMED,{action:I.ACCEPT})})},_updatePhasePatchAndRefresh:function(e,t,s){var i=this.cartPhases.getActivePhase(),a=new g;a.add(R.getPhaseStateUpdateOperation(i,e)),a.addAll(this._getDocAndAnnotationTimelineOperation(t)),a.add(this._getPatchOperationFromExternalAttributeUpdate(t));var n=this;return this.cart.megaPatch(a).then(this.cartPhases.fetchPromise.bind(this.cartPhases)).then(function(){s&&n._refreshNotices(),n._refreshTimeline(),n._refresh(),n.dispatchEvent(V.ACTION_PERFORMED,{action:t})})},_getDocAndAnnotationTimelineOperation:function(e){return this.messageContentComponent.getDocAndAnnotationTimelineOperation(e,[],this.messageContentComponent.getSpecificDocuments())},_megaPatchOnCart:function(e){var t=new g;return t.addAll(e),this.cart.megaPatch(t)},_patchCart:function(e,t){var s=this;t=t||new g;var i=this.cart.getState()===l.States.DRAFT;return this._saveBuyerTCs().then(this.messageContentComponent.getCartPatchOperations.bind(this.messageContentComponent,e)).then(function(e){if(t.addAll(e),t.length()>0)return s.cart.megaPatch(t)}).then(this._duplicateCarts.bind(this,i)).then(this._refresh.bind(this)).then(this._patchToDeliveryStateIfReady.bind(this)).then(this._refreshTimeline.bind(this)).catch(this._displayErrorMsg.bind(this))},_getPatchOperationFromExternalAttributeUpdate:function(e){if(this.hasPaymentPerPhase){var t=this.getPhaseAttributesUpdateForAction({action:e});if(t){var s=this.cartPhases.getActivePhase();return R.getModifyPhaseOperation(s,t)}}},_duplicateCarts:function(e){var s,i,a=this;return e&&this.multibiddingShopIds.length>0?(i=new x({cartId:this.cart.id,dataProxy:this.cartDuplicateOperationDataProxy}),this.multibiddingShopIds.forEach(function(e){e!==this.cart.shopId&&i.addShop({shopId:e})},this),s=i.execute().then(function(){a.dispatchEvent(V.CART_DUPLICATED)})):s=t.resolve(),s},_displayCancelConfirmationModal:function({isPhaseCancel:e,phase:t}){const s=new B;return this.container.addContent(s.render({isPhaseCancel:e,phase:t})),s.show(),this.listenTo(s,B.Events.CONFIRMED,()=>{e?this._onPhaseCancellationConfirmation(t,s):this._cancelCart(s)}),s},_cancelCart:function(e){return n.mask.bind(n,this.container),this._patchCart(I.CANCEL).then(function(){e.hide(),e.destroy()}).finally(n.unmask.bind(n,this.container))},_onPhaseCancellationConfirmation:function(e,t){var s=this;n.mask(this.container),e.updateState(P.States.DELETED).then(this._patchCart.bind(this)).then(function(){t.hide(),t.destroy(),n.unmask(s.container)}).then(this.dispatchEvent.bind(this,V.PHASE_CANCELLED)).catch(function(){t.setLoading(!1),n.unmask(s.container)})},_displayErrorMsg:function(t,s){var i,a=this.container.getElement(".mpf-error");t&&console.error(t),i=e.is(t,"string")&&t.length>0?t:this.cart.getState()===l.States.DRAFT?L.get("requestCannotBeSend"):e.is(s)&&s===I.NOTIFY_PHASE_DELIVERY&&!this.cartPhases.getActivePhase().hasDocuments()?L.get("noDeliverables"):L.get("messageCannotBeSend"),e.is(a)?a.setContent(i):(a=e.createElement("div",{class:"mpf-error",text:i}),this.container.addContent(a))},deleteErrorMessage:function(){var e=this.container.getElement(".mpf-error");e&&e.setContent("")},_refreshTimeline:function(){i.publish("MPCartTimeline",{event:"refresh",cartId:this.cart.id})},_refreshNotices:function(){i.publish("MPFDeferredPaymentNotices",{event:"update"})},_saveBuyerTCs:function(){return e.is(this.buyerTermsOfUseComponent)?this.buyerTermsOfUseComponent.isChecked()?this.buyerTermsOfUseComponent.createContract():t.reject("TCs must be signed"):t.resolve()},_patchToDeliveryStateIfReady:function(){var e=new g;return this.cart.getState()===l.States.PROCESSING&&this.request.getState()===p.States.ready?(e.add(new y(y.Operations.modify,"/cart-items/"+this.request.get("id"),{currentState:p.STATUS.delivered})),this.cart.megaPatch(e).then(this._refresh.bind(this))):t.resolve()},_refresh:function(){this.cartItems=this.cartItemFactory.createCollection("",this.cart.getItems()),this.cartItems.setParentResourceId(this.cart.get("id")),this.request=this.cartItems.find(function(e){return"MP3DP_PrintRequest"===e.getType()||"MPENG_EngineeringItem"===e.getType()}),this.request.changeTracker.reset(),this.message="",this.selectedOption=null,this.uploadedFiles=[],this.sendButton=this._createSendButton(),this.messageLabelContainer=this._createMessageLabelContainer(),this.biddingDeliveryMethodComponent=this._createBiddingDeliveryMethodComponent(),this.messageContentComponent=this._createBiddingMessageComponent(),this.uploadFileComponent=this._createUploadFileComponent(),this.optionsMenu=this._createOptionsMenuComponent(),e.is(this.buyerTermsOfUseComponent)&&(this.buyerTermsOfUseComponent.destroy(),this.buyerTermsOfUseComponent=null),this._initListeners(),this.render()},_refreshPhases:function(){if(this.hasPaymentPerPhase)return this.cartPhases.fetchPromise()},_refreshPhasesAndPayment:function(){var e=this;return this.hasPaymentPerPhase?this.cartPhases.fetchPromise({expand:[S.Expands.DOCUMENTS]}).then(function(){var s,i;return i=e.cartPhases.getActivePhase(),e.activePhasePayment.clear({silent:!0}),i?(e.activePhasePayment.setParentResourceId(i.id),s=e.activePhasePayment.fetchPromise()):(e.activePhasePayment.setParentResourceId(null),s=t.resolve()),s}):t.resolve()},_onNewOptionSelected:function(e){this.selectedOption=e,this.sendButton.setValue("message"===e.value?L.get("send"):e.text),this.messageLabelContainer.show(),this.messageContentComponent.show(),this.uploadFileComponent.show(),this.sendButton.show(),this.phaseCreator.hide(),this.hasPaymentPerPhase&&e.value===I.ACCEPT&&(this.phaseCreator.resetAlert(),this.phaseCreator.show()),this.messageContentComponent.container.removeClassName("mpf-invalid"),this.dispatchEvent(V.OPTION_SELECTED,e.value)},_onNewDocument:function(t){var s;this.messageContentComponent.addDocument(t),s=this.container.getElement(".mpf-error"),e.is(s)&&s.destroy()},_createMessageLabelContainer:function(){return e.createElement("div",{class:"mpf-label-message",text:L.get("message")})},_createSendButton:function(){var t;return t=this.selectedOption?"message"===this.selectedOption.value?L.get("send"):this.selectedOption.text:this.cart.getState()===l.States.DRAFT?L.get("sendForQuote"):L.get("send"),new a({className:"primary mpf-send-button",disabled:e.is(this.buyerTermsOfUseComponent),value:t,events:{onClick:this._sendMessage.bind(this)}})},_initListeners:function(){var t=this;this.isDeliveryActive&&this.listenTo(this.biddingDeliveryMethodComponent,N.Events.DELIVERY_METHOD_CHANGED,this.messageContentComponent.displayAddressChoices.bind(this.messageContentComponent)),this.listenTo(this.uploadFileComponent,O.Events.DOCUMENT_SAVED,this._onNewDocument.bind(this)),this.listenTo(this.uploadFileComponent,O.Events.DOCUMENT_NOT_SAVED,this._displayErrorMsg.bind(this)),this.listenTo(this.optionsMenu,v.Events.OPTION_SELECTED,this._onNewOptionSelected.bind(this)),this.listenTo(this.messageContentComponent,b.Events.PAYMENT_DONE,this._onPaymentDone.bind(this)),e.is(this.buyerTermsOfUseComponent)&&this.listenTo(this.buyerTermsOfUseComponent.checkbox,"valueChanged",function(){t.sendButton.setDisabled(!t.buyerTermsOfUseComponent.isChecked())})},_onPaymentDone:function(e){var t=this;this.selectedOption=null,n.mask(this.container),this.cart.fetchPromise({expand:[l.Expands.CART_ITEMS]}).then(this._refreshPhasesAndPayment.bind(this)).catch(this._displayErrorMsg.bind(this)).finally(function(){t._refresh(),t._refreshTimeline(),t._refreshNotices(),n.unmask(t.container),t.dispatchEvent(V.PAYMENT_DONE)})},_createOptionsMenuComponent:function(){var e;return e=new v({buyerView:this.buyerView,cart:this.cart,cartItem:this.request,cartPhases:this.cartPhases,activePhasePayment:this.activePhasePayment,hasPaymentPerPhase:this.hasPaymentPerPhase,service:this.service}),this.onMenuRefresh(e),e},_createUploadFileComponent:function(){return new O({buyerView:this.buyerView,tcDocumentFactory:this.tcDocumentFactory,cart:this.cart,cartItem:this.request,maxFileSize:this.maxFileSize,maxSpecificFileSize:this.maxSpecificFileSize,nda:this.nda})},_createBiddingMessageComponent:function(){return new b({service:this.service,buyerView:this.buyerView,buyerType:this.buyerType,isDeliveryActive:this.isDeliveryActive,me:this.me,company:this.company,shop:this.shop,cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,tcContractFactory:this.tcContractFactory,addressFactory:this.addressFactory,companyFactory:this.companyFactory,addresses:this.addresses,countries:this.countries,linkToBankTransferFAQ:this.linkToBankTransferFAQ,annotations3dView:this.annotations3dView,hasPaymentPerPhase:this.hasPaymentPerPhase,message:this.message,uploadedFiles:this.uploadedFiles})},setMessage:function(e){this.messageContentComponent.setMessage(e)},_createBiddingDeliveryMethodComponent:function(){if(this.isDeliveryActive)return new N({cart:this.cart})},_createPhaseCreator:function(){return this.hasPaymentPerPhase?new w({cart:this.cart,cartPhases:this.cartPhases,cartPhaseFactory:this.cartPhaseFactory}):k.getInstance()},_checkPrototypes:function(e){r.requiredOfPrototype(e.cart,l,"options.cart must be a CartModel"),r.requiredOfPrototype(e.cartItems,m,"options.cartItems must be a CartItemCollection"),r.requiredOfPrototype(e.me,d,"options.me must be a PersonModel"),r.requiredOfPrototype(e.tcContractFactory,f,"options.tcContractFactory must be a TCContractFactory"),r.requiredOfPrototype(e.tcDocumentFactory,F,"options.tcDocumentFactory must be a TCDocumentFactory"),r.requiredOfPrototype(e.cartItemFactory,D,"options.cartItemFactory must be a CartItemFactory"),r.requiredOfPrototype(e.cartFactory,C,"options.cartFactory must be a CartFactory"),this.buyerView&&(this.isDeliveryActive&&(r.requiredOfPrototype(e.companyFactory,M,"options.companyFactory must be a CompanyFactory"),r.requiredOfPrototype(e.addressFactory,E,"options.addressFactory must be an AddressFactory"),r.requiredOfPrototype(e.addresses,T,"options.addresses must be an AddressCollection"),r.requiredOfPrototype(e.countries,A,"options.countries must be a CountryCollection")),this.buyerType===c.COMPANY&&r.requiredOfPrototype(e.company,u,"options.company must be a CompanyModel"),O.isBuyerAllowedToUploadNDA(this.cart,this.request)&&r.requiredOfPrototype(e.shop,h,"options.shop must be a ShopModel"),this.cart.getState()===l.States.SUBMITTED&&r.requiredOfPrototype(e.nda,_,"options.nda must be a TcContractModel"))}});return q.Events=Object.freeze(V),q}),define("DS/MPFBiddingNewMessage/BiddingNewMessageFactory",["UWA/Core","UWA/Class","UWA/Promise","DS/MPFConnector/Connector","DS/MPFConnector/MarketplaceConnector","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFTcContractComponent/TermsOfUseOrderFactory","DS/MPFPersonModel/PersonFactory","DS/MPFShopModel/ShopFactory","DS/MPFCartModel/CartFactory","DS/MPFCartPhaseModel/CartPhaseFactory","DS/MPFCartPaymentModel/CartPaymentFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFBuyer/BuyerType","DS/MPFCompanyModel/CompanyHelper","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseCollection","DS/MPFCartPaymentModel/CartPaymentCollection","DS/MPFBiddingNewMessage/BiddingNewMessage","DS/MPFCartModel/CartDuplicateOperationDataProxy","DS/MPFBiddingNewMessage/BiddingUploadFileComponent"],function(e,t,s,i,a,n,r,o,c,d,h,u,l,p,m,P,S,g,y,C,D){"use strict";var M=t.extend({init:function(e){e||(e={}),this._storeProperties(e)},getBiddingNewMessageComponent:function(){return this._getConnector().then(this._initFactories.bind(this)).then(this._fetchMeCart.bind(this)).then(this._initCartItems.bind(this)).then(this._fetchCartPhases.bind(this)).then(this._fetchActivePhasePayment.bind(this)).then(this._fetchShop.bind(this)).then(this._fetchCompany.bind(this)).then(this._fetchAddressesAndCountries.bind(this)).then(this._getTCsForBuyer.bind(this)).then(this._getNda.bind(this)).then(this._createAnnotations3dView.bind(this)).then(this._buildBiddingNewMessageComponent.bind(this))},exportState:function(e){return Object.assign({service:this.service,connector:this.connector,buyerView:this.buyerView,isDeliveryActive:this.isDeliveryActive,cartID:this.cartID,shopID:this.shopID,onMenuRefresh:this.onMenuRefresh,validateSend:this.validateSend,linkToBankTransferFAQ:this.linkToBankTransferFAQ,annotations3dViewFactory:this.annotations3dViewFactory,maxFileSize:this.maxFileSize,hasPaymentPerPhase:this.hasPaymentPerPhase,getPhaseAttributesUpdateForAction:this.getPhaseAttributesUpdateForAction,unsavedPhases:this.cartPhases.filter(function(e){return e.isNew()})},e.exportContent())},fromExportedState:function(e){return this._storeProperties(e),this.getBiddingNewMessageComponent()},_storeProperties:function(e){this.service=e.service,this.connector=e.connector,this.buyerView=!0===e.buyerView,this.isDeliveryActive=!0===e.isDeliveryActive,this.cartID=e.cartID,this.shopID=e.shopID,this.multibiddingShopIds=e.multibiddingShopIds,this.onMenuRefresh=e.onMenuRefresh,this.validateSend=e.validateSend,this.linkToBankTransferFAQ=e.linkToBankTransferFAQ,this.annotations3dViewFactory=e.annotations3dViewFactory,this.maxFileSize=e.maxFileSize,this.maxSpecificFileSize=e.maxSpecificFileSize,this.hasPaymentPerPhase=!0===e.hasPaymentPerPhase||!0===e.hasPayementPerPhase,this.getPhaseAttributesUpdateForAction=e.getPhaseAttributesUpdateForAction,this.message=e.message,this.uploadedFiles=e.uploadedFiles,this.selectedOption=e.selectedOption,this.unsavedPhases=e.unsavedPhases},_getConnector:function(){var e=this;return Object.prototype.isPrototypeOf.call(i.prototype,this.connector)?s.resolve(this.connector):a.fetchPromise(this.options).then(function(t){e.connector=t})},_initFactories:function(){var e,t=this;return this.factorySupplier=n.getInstance(this.connector),e=[this.factorySupplier.getFactory(n.Types.PERSON),this.factorySupplier.getFactory(n.Types.SHOP),this.factorySupplier.getFactory(n.Types.CART),this.factorySupplier.getFactory(n.Types.CART_ITEM),this.factorySupplier.getFactory(n.Types.TC_DOCUMENT),this.factorySupplier.getFactory(n.Types.TC_CONTRACT),this.factorySupplier.getFactory(n.Types.CART_PHASE),this.factorySupplier.getFactory(n.Types.CART_PAYMENT)],this.isDeliveryActive&&(e.push(this.factorySupplier.getFactory(n.Types.ADDRESS)),e.push(this.factorySupplier.getFactory(n.Types.COUNTRY))),s.all(e).then(function(e){if(t.personFactory=e[0],t.shopFactory=e[1],t.cartFactory=e[2],t.cartItemFactory=e[3],t.tcDocumentFactory=e[4],t.tcContractFactory=e[5],t.cartPhaseFactory=e[6],t.cartPaymentFactory=e[7],t.isDeliveryActive)return t.addressFactory=e[8],t.countryFactory=e[9],t.addressFactory.whenReady()})},_fetchMeCart:function(){return this.me=this.personFactory.createModel(o.Types.ME),this.cart=this.cartFactory.createModel(d.Types.CART,{id:this.cartID}),s.all([this.me.fetchPromise(),this.cart.fetchPromise({expand:["cart-items"]})])},_fetchShop:function(){var e=this.cartItems.find(function(e){return"MP3DP_PrintRequest"===e.getType()||"MPENG_EngineeringItem"===e.getType()});return this.buyerView&&D.isBuyerAllowedToUploadNDA(this.cart,e)?(this.shop=this.shopFactory.createModel(c.Types.SHOP,{id:this.shopID}),this.shop.fetchPromise({expand:[]})):s.resolve()},_fetchCompany:function(){var t=this,s=this.cartItems.find(function(e){return"MP3DP_PrintRequest"===e.getType()||"MPENG_EngineeringItem"===e.getType()});if(this.buyerView&&(this.isDeliveryActive||D.isBuyerAllowedToUploadNDA(this.cart,s)))return this.factorySupplier.getFactory(n.Types.COMPANY).then(function(e){return t.companyFactory=e,t.companyFactory.addressFactory=t.addressFactory,t.companyFactory.whenReady()}).then(function(){if(t.company=m.getCompanyFromPerson(t.me,t.companyFactory),e.is(t.company))return t.buyerType=p.COMPANY,t.company.fetchPromise()})},_fetchAddressesAndCountries:function(){if(this.buyerView&&this.isDeliveryActive)return this.countries=this.countryFactory.createCollection(),this.buyerType===p.COMPANY?(this.addresses=this.company.addresses,this.countries.fetchPromise()):(this.addresses=this.addressFactory.createCollection("me"),this.me.addresses=this.addresses,s.all([this.addresses.fetchPromise(),this.countries.fetchPromise()]))},_initCartItems:function(){return this.cartItems=this.cartItemFactory.createCollection("",this.cart.getItems()),this.cartItems.setParentResourceId(this.cartID),this.cartItems.forEach(e=>e.clearPendingChanges()),this.cartItems},_fetchCartPhases:function(){var e=this;return this.cartPhases=this.cartPhaseFactory.createCollection(h.Types.CART_CART_PHASE),this.cartPhases.setParentResourceId(this.cart.id),this.cartPhases.fetchPromise({expand:[S.Expands.DOCUMENTS]}).then(function(){if(Array.isArray(e.unsavedPhases))for(var t=0;t<e.unsavedPhases.length;t++){var s=e.unsavedPhases[t];s.getNumber()>e.cartPhases.size()&&e.cartPhases.push(s)}})},_fetchActivePhasePayment:function(){var e,t;return t=this.cartPhases.getActivePhase(),this.activePhasePayment=this.cartPaymentFactory.createModel(u.Types.CART_PHASE_CART_PAYMENT),t&&!t.isNew()?(this.activePhasePayment.setParentResourceId(t.id),e=this.activePhasePayment.fetchPromise()):e=s.resolve(),e},_getTCsForBuyer:function(){var e=this;return this.buyerView&&this.cart.getState()===P.States.DRAFT?new r({connector:this.connector,buyer:this.me,callback:function(){this.dispatchEvent("valueChanged")}}).displayTermsOfUse().then(function(t){e.buyerTermsOfUseComponent=t}):s.resolve()},_getNda:function(){if(this.buyerView&&this.cart.getState()===P.States.SUBMITTED)return this.nda=this.tcContractFactory.createModel(l.Types.NDA),this.nda.setParentResourceId(this.cartID),this.nda.fetchPromise()},_createAnnotations3dView:function(){e.is(this.annotations3dViewFactory,"function")&&(this.annotations3dView=this.annotations3dViewFactory({cart:this.cart,cartItems:this.cartItems}))},_buildBiddingNewMessageComponent:function(){return new y({service:this.service,isDeliveryActive:this.isDeliveryActive,buyerView:this.buyerView,buyerType:this.buyerType,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,addressFactory:this.addressFactory,companyFactory:this.companyFactory,tcDocumentFactory:this.tcDocumentFactory,tcContractFactory:this.tcContractFactory,cartPhaseFactory:this.cartPhaseFactory,me:this.me,company:this.company,shop:this.shop,addresses:this.addresses,countries:this.countries,cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases,activePhasePayment:this.activePhasePayment,onMenuRefresh:this.onMenuRefresh,validateSend:this.validateSend,buyerTermsOfUseComponent:this.buyerTermsOfUseComponent,linkToBankTransferFAQ:this.linkToBankTransferFAQ,annotations3dView:this.annotations3dView,multibiddingShops:this.multibiddingShops,cartDuplicateOperationDataProxy:new C(this.connector),hasPaymentPerPhase:this.hasPaymentPerPhase,maxFileSize:this.maxFileSize,maxSpecificFileSize:this.maxSpecificFileSize,getPhaseAttributesUpdateForAction:this.getPhaseAttributesUpdateForAction,message:this.message,uploadedFiles:this.uploadedFiles,selectedOption:this.selectedOption,nda:this.nda})}});return M.from=function(e){return new M(e).getBiddingNewMessageComponent()},M});