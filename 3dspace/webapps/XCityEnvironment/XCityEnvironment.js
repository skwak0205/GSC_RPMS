define("DS/XCityEnvironment/Slab",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/XCityTools/ShaderTools","DS/XCityTools/EventDispatcher"],function(t,e,i,s,a,n,o,r){"use strict";var h={uniforms:{skyColor:{type:"c",value:new e.Color},slabSize:{type:"v3",value:new e.Vector3(1,1,0)},slabPosition:{type:"v3",value:new e.Vector3(0,0,0)}},varyings:{vertexPosition:{type:"v3",length:1}},VS_overridableFunctions:{ComputeVaryingValues:["vertexPosition = vGetAttribPosition().xyz;"].join("\n"),ComputeObjectNormal:["return vec3(0.0, 1.0, 0.0);"].join("\n")},FS_overridableFunctions:{ProcessFinalColor:["float _fog = 1.0 - clamp(length(vertexPosition.xy) / length(slabSize.xy), 0.0, 1.0);","vec3 planeColor = _fog * vec3(1.0) + (1.0 - _fog) * skyColor;","if (slabSize.z > 0.0) {","float xShade = abs(vertexPosition.x) - 0.5 * slabSize.x;","float yShade = abs(vertexPosition.y) - 0.5 * slabSize.y;","float _shadowMask = 1.0 - smoothstep(-0.1*slabSize.z, 0.1*slabSize.z, xShade) * smoothstep(-0.1*slabSize.z, 0.1*slabSize.z, yShade);","float _shadowEffect = (1.0 - smoothstep(0.0, 0.5*slabSize.z, xShade)) * (1.0 - smoothstep(0.0, 0.5*slabSize.z, yShade));","float _shadow = 0.8 + 0.2 * log(2.0 - _shadowEffect * _shadowMask) / log(2.0);","planeColor.rgb *= _shadow;","}","ioFinalColor.rgb *= planeColor.rgb;"].join("\n")}},l={varyings:{slabShadow:{type:"v3",length:1}},VS_overridableFunctions:{ComputeVaryingValues:["slabShadow.rgb = vec3(1.0 + 0.5 * vGetAttribPosition().z);"].join("\n"),ComputeObjectNormal:["return vec3(0.0, 1.0, 0.0);"].join("\n")},FS_overridableFunctions:{ProcessFinalColor:["ioFinalColor.rgb *= slabShadow.rgb;"].join("\n")}},u=function(t,a){this._slabNode=new s,this._slabNode.exludeFromBounding(!0),t.USR._rootProjScaled.add(this._slabNode),this._viewpoint=t.getViewpoint();var n=new e.PlaneGeometry(1,1,4,4),u=new e.Mesh(n);u.name="XCityInfinitePlane",this._infPlaneMesh3D=i.createNodeFromTHREEMesh(u),this._infPlaneMesh3D.name="XCityInfinitePlane",this._infPlaneMesh3D.mesh3js.name="XCityInfinitePlane",this._infPlaneMesh3D.setSSAO(!1),this._infPlaneMesh3D.setShadow(!1,!1),this._infPlaneMaterial=o.getPDSFXMaterial([h]),this._infPlaneMaterial.name="XCityInfinitePlane",this._infPlaneMaterial.metalness=0,this._infPlaneMaterial.roughness=1,this._infPlaneMaterial.getPDSFXUniform("skyColor").value.setRGB(.596078431,.768627451,.91372549),this._infPlaneMesh3D.setMaterial(this._infPlaneMaterial),this._infPlanePosition=new e.Vector3(.5,.5,0),this._infPlaneSize=new e.Vector3(100,100,1),this._infPlaneMatrix=new e.Matrix4;var c=new e.CubeGeometry(1,1,1);c.faces.splice(4,2);var f=new e.Mesh(c);f.name="XCitySlabCube",this._slabCubeMesh3D=i.createNodeFromTHREEMesh(f),this._slabCubeMesh3D.name="XCitySlabCube",this._slabCubeMesh3D.mesh3js.name="XCitySlabCube",this._slabCubeMesh3D.setSSAO(!1),this._slabCubeMesh3D.setShadow(!1,!1),this._slabCubeMesh3D.setRenderPasses(["GenericOverlayPass"]),this._slabCubeMaterial=o.getPDSFXMaterial([l]),this._slabCubeMaterial.name="XCitySlabCube",this._slabCubeMaterial.forceSide=!0,this._slabCubeMaterial.side=e.FrontSide,this._slabCubeMaterial.metalness=0,this._slabCubeMaterial.roughness=1,this._slabCubeMesh3D.setMaterial(this._slabCubeMaterial),this._slabPosition=new e.Vector3(.5,.5,0),this._slabSize=new e.Vector3(1,1,0),this._slabCubeMatrix=new e.Matrix4;var d=function(t){void 0!==t.cropBox?(this._slabSize.x=t.cropBox.getSize().x,this._slabSize.y=t.cropBox.getSize().y,this._slabSize.z=.1*Math.max(this._slabSize.x,this._slabSize.y),this._slabPosition.x=t.cropBox.getShiftedCenter().x,this._slabPosition.y=t.cropBox.getShiftedCenter().y,this._slabPosition.z=-this._slabSize.z/2):(this._slabSize.x=t.worldSize,this._slabSize.y=t.worldSize,this._slabSize.z=.1*t.worldSize,this._slabPosition.x=.5*t.worldSize,this._slabPosition.y=.5*t.worldSize,this._slabPosition.z=-this._slabSize.z/2),void 0!==t.slabAltitude&&(this._slabPosition.z+=t.slabAltitude);var e=1e3*this._slabSize.z;this._infPlaneSize.set(e,e,1),this._infPlanePosition.copy(this._slabPosition),this._infPlanePosition.z=-.5*this._slabSize.z,0===this._slabCubeMesh3D.getParents().length&&this._slabNode.add(this._slabCubeMesh3D),m()}.bind(this),b=function(t){this._slabSize.x=1,this._slabSize.y=1,this._slabSize.z=1,this._slabPosition.x=.5,this._slabPosition.y=.5,this._slabPosition.z=0,this._infPlaneSize.x=100,this._infPlaneSize.y=100,this._infPlaneSize.z=1,this._infPlanePosition.x=.5,this._infPlanePosition.y=.5,this._infPlanePosition.z=0,this._slabCubeMesh3D.getParents().length>0&&this._slabNode.remove(this._slabCubeMesh3D),m()}.bind(this),m=function(){this._slabCubeMatrix.identity(),this._slabCubeMatrix.scale(this._slabSize),this._slabCubeMatrix.setPosition(this._slabPosition),this._slabCubeMesh3D.setMatrix(this._slabCubeMatrix),this._infPlaneMatrix.identity(),this._infPlaneMatrix.scale(this._infPlaneSize),this._infPlaneMatrix.setPosition(this._infPlanePosition),this._infPlaneMesh3D.setMatrix(this._infPlaneMatrix);var t=this._infPlaneMaterial.getPDSFXUniform("slabSize");t.value.copy(this._slabSize),t.value.divide(this._infPlaneSize)}.bind(this);r.subscribeTo("/3DEXPERIENCity/onConfig",d),r.subscribeTo("/3DEXPERIENCity/onReset",b)};return u.prototype={setSkyColor:function(t){this._infPlaneMaterial.getPDSFXUniform("skyColor").value.copy(t)},enableInfinitePlane:function(t){t?0===this._infPlaneMesh3D.getParents().length&&this._slabNode.add(this._infPlaneMesh3D):this._infPlaneMesh3D.getParents().length>0&&this._slabNode.remove(this._infPlaneMesh3D)}},u}),define("DS/XCityEnvironment/VisualEffect",["UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Visualization/Node3D","UWA/Class"],function(t,e,i,s,a){"use strict";return a.extend(t,{init:function(t,e,i,s,a,n){var o=a;for(var r in void 0!==s[e]&&(o=void 0!==s[e].enable?s[e].enable:s[e]),this.enabled=a,this._enabledSilent=o,this._name=e,this._enableCB=i,this._options={},s[e])this._options[r]=s[e][r];void 0!==n&&(this.update=n),this.enable(o,!0);var h=t.url.getArgument(this._name);h&&this.enable("1"===h.value),t.url.updateSlots.push(this.updateUrl.bind(this))},getOption:function(t){return void 0!==this._options[t]?this._options[t]:0},updateUrl:function(t){t.setArgument(this._name,!0===this.enabled?"1":"0")},enable:function(t,e){if(void 0===t&&(t=!0),this.enabled===t&&!0!==e||(this._enableCB(t),this.enabled=t,this._enabledSilent=t,this.dispatchEvent("onChange",this,t)),this.update)for(var i=Object.keys(this._options),s=i.length;s--;)this.update(i[s],this._options[i[s]])},disable:function(){this.enable(!1)},enableSilent:function(t){this._enabledSilent!==t&&!0===this.enabled&&(this._enableCB(t),this._enabledSilent=t)},disableSilent:function(){this.enableSilent(!1)}})}),define("DS/XCityEnvironment/CubeMap",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/EventDispatcher","DS/XCityRendering/RenderingHandlerSky","DS/XCityCore/Terrain"],function(t,e,i,s,a,n,o,r,h,l){"use strict";var u={uniforms:{skyColor:{type:"c",value:new t.Color},envMapSky:{type:"tc",value:o.whiteMap},useEnvMapSky:{type:"b",value:!1}},varyings:{pos3d:{type:"v3v",length:0}},VS_overridableFunctions:{ComputeVaryingValues:["pos3d = vGetAttribPosition();"].join("\n")},FS_overridableFunctions:{ProcessFinalColor:["ioFinalColor.rgb = skyColor.rgb;","if (useEnvMapSky) { ioFinalColor.rgb *= textureCube( envMapSky, vec3(-pos3d.x, pos3d.zy) ).xyz; }"].join("\n")}},c=function(s,n){this._urban=s,this._skyNode=new i,this._skyNode.exludeFromBounding(!0),this._viewpoint=s.getViewpoint(),this._viewer=s.USR.webGLV6Viewer;var l=new t.CubeGeometry(1,1,1),c=new t.Mesh(l);c.name="XCitySkyBox",c.frustumCulled=!1,c.geometry.dynamic=!0,c.renderDepth=-Number.MAX_VALUE,c.depthWrite=!1,this._skyBoxMesh3D=e.createNodeFromTHREEMesh(c),this._skyBoxMesh3D.name="XCitySkyBox",this._skyBoxMesh3D.setPickable(a.NODRAWHL),this._skyBoxMesh3D.setShadow(!1,!1),this._skyBoxMesh3D.setSSAO(!1),this._skyNode.add(this._skyBoxMesh3D),this._skyboxMaterial=o.getPDSFXMaterial([u]),this._skyboxMaterial.name="XCitySkyBox",this._skyboxMaterial.side=t.BackSide,this._skyboxMaterial.forceSide=!0,this._skyBoxMesh3D.setMaterial(this._skyboxMaterial),this._skyboxMatrix=new t.Matrix4;var f=function(){var e,i;e=this._viewpoint.getCamera().far,i=this._viewpoint._getPositionRelative(),this._skyboxMatrix.identity(),this._skyboxMatrix.scale(new t.Vector3(e,e,e)),this._skyboxMatrix.setPosition(i),this._skyBoxMesh3D.setMatrix(this._skyboxMatrix)}.bind(this);r.subscribeTo("/3DEXPERIENCity/onPostUpdate",f),this._skyColor=new t.Color,this.setSkyColor((new t.Color).setRGB(.596078431,.768627451,.91372549)),this._rendering=new h(s),this._iblReady=!1};return c.prototype={initDefaultSky:function(){this._urban.getRenderingProfileManager().addRendering("Sky",this._rendering.getDefaultRendering())},setSkyColor:function(t){this._skyColor.copy(t),this._skyboxMaterial.getPDSFXUniform("skyColor").value.copy(this._skyColor)},getSkyColor:function(){return this._skyColor.clone()},getCubeMap:function(){return this._skyboxMaterial.getPDSFXUniform("envMapSky").value},setCubeMap:function(e){n.is(e)?(this._viewer.ambience.setBackGroundMap({texture:e,mapping:new t.LatLongEnvMapping,pngHdr:!0}),this._viewer.ambience.setIblMap({texture:e,mapping:new t.LatLongReflectionMapping,pngHdr:!0}),this._viewer.ambience.setRoughnessMap({texture:e._rmips,mapping:new t.LatLongReflectionMapping,pngHdr:!0}),this._iblReady=!0):(this._viewer.ambience.setBackGroundMap({texture:o.whiteMap,mapping:new t.LatLongEnvMapping,pngHdr:!1}),this._viewer.ambience.setIblMap({texture:o.whiteMap,mapping:new t.LatLongReflectionMapping,pngHdr:!0}),this._viewer.ambience.setRoughnessMap({texture:null,mapping:new t.LatLongReflectionMapping,pngHdr:!0}))},getRendering:function(){return this._rendering},redraw:function(){var t=this.getRendering(),e=t.getFeatureRendering().getRenderingData();t.applySkyMaterial(e)}},c}),define("DS/XCityEnvironment/LensFlare",["DS/WebappsUtils/WebappsUtils","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/LensFlareNode3D","DS/xCityBasicUtils/Utils","DS/XCityTools/Downloader"],function(t,e,i,s,a,n,o){"use strict";return e.extend({init:function(t){this.urban=t},initLensFlare:function(){var t="XCityEnvironment/assets/textures/lensFlare/",e=[],n=0;this.node1s=new s("lensFlare");var r=function(t){if(e.push(t),!(++n<16)){for(var s=new i.Color(16777215),o=[0,.2,.3,.37,.47,.6,.7,.77,.97,1.17,1.27,1.35,1.5,1.75,1.82,2.2],r=[0,.035,.04,.05,.07,.05,.08,.06,.095,.08,.11,.07,.08,.06,.08,.55],h=[.55,.1,.13,.11,.17,.15,.11,.19,.15,.15,.15,.16,.14,.09,.13,.15],l=new i.LensFlare(e[0],180,0,i.AdditiveBlending,s,1),u=1;u<16;u++)s.setHSL(.5,.01,2*h[u]),l.add(e[u],1080*r[u],.45*o[u],i.AdditiveBlending,s,.65);this.lensFlare=new a(l,"SunFlare"),this.node1s.add(this.lensFlare)}},h=function(t,e,i,s){o.download(i,{image:!0},void 0!==s?s:1,function(t,e,i,s){s(e,t,i)},void 0,e)};h(this.urban,r.bind(this),t+"LensFlare_01.png"),h(this.urban,r.bind(this),t+"LensFlare_02.png"),h(this.urban,r.bind(this),t+"LensFlare_03.png"),h(this.urban,r.bind(this),t+"LensFlare_04.png"),h(this.urban,r.bind(this),t+"LensFlare_05.png"),h(this.urban,r.bind(this),t+"LensFlare_06.png"),h(this.urban,r.bind(this),t+"LensFlare_02.png"),h(this.urban,r.bind(this),t+"LensFlare_03.png"),h(this.urban,r.bind(this),t+"LensFlare_09.png"),h(this.urban,r.bind(this),t+"LensFlare_03.png"),h(this.urban,r.bind(this),t+"LensFlare_09.png"),h(this.urban,r.bind(this),t+"LensFlare_03.png"),h(this.urban,r.bind(this),t+"LensFlare_09.png"),h(this.urban,r.bind(this),t+"LensFlare_14.png"),h(this.urban,r.bind(this),t+"LensFlare_03.png"),h(this.urban,r.bind(this),t+"LensFlare_16.png"),this.urban.USR._root.add(this.node1s)},lensFlareUpdateCallback:function(t){var e,i,s=t.lensFlares.length,a=2*-t.positionScreen.x,n=2*-t.positionScreen.y;for(e=0;e<s;e++)(i=t.lensFlares[e]).x=t.positionScreen.x+a*i.distance,i.y=t.positionScreen.y+n*i.distance,i.rotation=0}})}),define("DS/XCityEnvironment/SunCalculator",["UWA/Class"],function(){"use strict";return UWA.Class.extend({init:function(t){this.urban=t,this.dayMs=864e5,this.J1970=2440588,this.J2000=2451545,this.rad=Math.PI/180,this.e=23.4397*this.rad,this.J0=9e-4,this.times=[[-.83,"sunrise","sunset"],[-.3,"sunriseEnd","sunsetStart"],[-6,"dawn","dusk"],[-12,"nauticalDawn","nauticalDusk"],[-18,"nightEnd","night"],[6,"goldenHourEnd","goldenHour"]]},toJulian:function(t){return t.valueOf()/this.dayMs-.5+this.J1970},fromJulian:function(t){return new Date((t+.5-this.J1970)*this.dayMs)},toDays:function(t){return this.toJulian(t)-this.J2000},getRightAscension:function(t,e){return Math.atan2(Math.sin(t)*Math.cos(this.e)-Math.tan(e)*Math.sin(this.e),Math.cos(t))},getDeclination:function(t,e){return Math.asin(Math.sin(e)*Math.cos(this.e)+Math.cos(e)*Math.sin(this.e)*Math.sin(t))},getAzimuth:function(t,e,i){return Math.PI+Math.atan2(Math.sin(t),Math.cos(t)*Math.sin(e)-Math.tan(i)*Math.cos(e))},getAltitude:function(t,e,i){return Math.asin(Math.sin(e)*Math.sin(i)+Math.cos(e)*Math.cos(i)*Math.cos(t))},getSiderealTime:function(t,e){return this.rad*(280.16+360.9856235*t)-e},getSolarMeanAnomaly:function(t){return this.rad*(357.5291+.98560028*t)},getEquationOfCenter:function(t){return this.rad*(1.9148*Math.sin(t)+.02*Math.sin(2*t)+3e-4*Math.sin(3*t))},getEclipticLongitude:function(t,e){return t+e+102.9372*this.rad+Math.PI},getSunCoords:function(t){var e=this.getSolarMeanAnomaly(t),i=this.getEquationOfCenter(e),s=this.getEclipticLongitude(e,i);return{dec:this.getDeclination(s,0),ra:this.getRightAscension(s,0)}},getPosition:function(t,e,i){var s=this.rad*-i,a=this.rad*e,n=this.toDays(t),o=this.getSunCoords(n),r=this.getSiderealTime(n,s)-o.ra;return{azimuth:this.getAzimuth(r,a,o.dec),altitude:this.getAltitude(r,a,o.dec)}},computeSunWorldPos:function(t,e){},getJulianCycle:function(t,e){return Math.round(t-this.J0-e/(2*Math.PI))},getApproxTransit:function(t,e,i){return this.J0+(t+e)/(2*Math.PI)+i},getSolarTransitJ:function(t,e,i){return this.J2000+t+.0053*Math.sin(e)-.0069*Math.sin(2*i)},getHourAngle:function(t,e,i){return Math.acos((Math.sin(t)-Math.sin(e)*Math.sin(i))/(Math.cos(e)*Math.cos(i)))},getTimes:function(t,e,i){var s,a,n,o,r,h=this.rad*-i,l=this.rad*e,u=this.toDays(t),c=this.getJulianCycle(u,h),f=this.getApproxTransit(0,h,c),d=this.getSolarMeanAnomaly(f),b=this.getEquationOfCenter(d),m=this.getEclipticLongitude(d,b),g=this.getDeclination(m,0),p=this.getSolarTransitJ(f,d,m),v={solarNoon:this.fromJulian(p),nadir:this.fromJulian(p-.5)};for(s=0,a=this.times.length;s<a;s+=1){n=this.times[s];var y=this.getHourAngle(n[0]*this.rad,l,g),S=this.getApproxTransit(y,h,c);r=p-((o=this.getSolarTransitJ(S,d,m))-p),v[n[1]]=this.fromJulian(r),v[n[2]]=this.fromJulian(o)}return v}})}),define("DS/XCityEnvironment/Sky",["DS/WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/XCityEnvironment/LensFlare","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/EventDispatcher","DS/XCityRendering/RenderingHandlerSky"],function(t,e,i,s,a,n,o,r,h,l,u,c,f){"use strict";var d=t.getWebappsAssetUrl("XCityEnvironment",""),b=l.loadTexture(d+"textures/skybox/cloudNoise.jpg"),m=10,g=2,p=.005,v=.8,y={coverage:.5,thickness:80,height:100,aspect:.035,shape:.01,on:!1,windDirection:new e.Vector3(1,0,0),windSpeed:.2},S={uniforms:{turbidity:{type:"f",value:m},reileigh:{type:"f",value:g},mieCoefficient:{type:"f",value:p},mieDirectionalG:{type:"f",value:v},sunPos:{type:"v3",value:new e.Vector3(0,0,0)},cloudNoise:{type:"t2",value:b},timer:{type:"f",value:0,animation:function(t){return t.animatedTime}},coverage:{type:"f",value:y.coverage},thickness:{type:"f",value:y.thickness},height:{type:"f",value:y.height},aspect:{type:"f",value:y.aspect},shape:{type:"f",value:y.shape},on:{type:"b",value:y.on},windDirection:{type:"v3",value:y.windDirection},windSpeed:{type:"f",value:y.windSpeed}},varyings:{myWorldPosition:{type:"v3"}},VS_overridableFunctions:{ComputeVaryingValues:["myWorldPosition = vGetAttribPosition().xyz;"].join("\n")},FS_global_code:["vec3 cameraPos = vec3(0., 0., 0.);","const float UN_SUR_QUATREPI = 0.07957747154594767;","#define wind windDirection * (windSpeed * timer)","#define sunDir normalize(sunPos)","float noise(vec3 x){","vec3 p = floor(x);","vec3 f = fract(x);","f = f*f*(3.0 - 2.0*f);","vec2 uv = (p.xy+vec2(37.0,17.0)*p.z) + f.xy;","vec2 rg = texture2D(cloudNoise,(uv+0.5)/256.0,0.).yx;","return mix( rg.x, rg.y, f.z );","}","float fbm(vec3 p,float lacunarity){","float t  = 0.50000 * noise(p); p *= lacunarity;","t += 0.25000 * noise(p); p *= lacunarity;","t += 0.12500 * noise(p); p *= lacunarity;","t += 0.06250 * noise(p); p *= lacunarity;","t += 0.03125 * noise(p);","return t;","}","float hgPhase(float cosTheta, float g)","{","float g2 = g * g;","return UN_SUR_QUATREPI * (pow(1.0 - g, 2.0) / pow(1.0 - 2.0*g*cosTheta + g2, 1.5));","}","vec3 render(vec3 cloudPos, vec3 skyColor)","{","if(coverage >= 0.9 || on == false) return skyColor;","int steps = int(max(thickness*2.0,55.0));","float valueStep = (thickness / float(steps));","float light = clamp(-dot(sunDir, cloudPos),0., 1.0);","vec3 projection = cloudPos / cloudPos.y;","vec3 iter = projection * valueStep;","float cHeight = 0.;","float alpha = 0.;","float T = 1.0;","float sunAngle = clamp(dot(sunDir,cloudPos),0.0,1.0);","vec3 origin = projection * height;","vec3 pos = origin;","vec3 C = vec3(0.);","float invThickness = 1.0 / thickness;","for (int i = 0; i < 600; i++) {","if (i >= steps) break;","if (alpha > 0.95 || T < 0.05) break;","cHeight = (pos.y - origin.y) * invThickness;","float dens = fbm(pos * shape + wind, 2.76434);","if (dens != 0.0){","dens *= smoothstep (coverage, coverage + aspect, dens)*valueStep;","float T_i = exp(-dens);","T *= T_i;","C += T * exp(cHeight) * 0.5128 * dens;","alpha += (1. - T_i) * (1. - alpha);","}","pos += iter;","}","if (sunPos.z < 0.0)","{","C *= 3.5*skyColor;","return mix(skyColor, C, alpha* smoothstep(0.,0.2,cloudPos.y));","}","else {","C *= mix(vec3(1.0,0.3,0.1), C, pow(sunDir.z, 0.5));","alpha *= smoothstep(0.,sunDir.z*0.1,cloudPos.y);","return mix(skyColor, pow(C,max(vec3(2.0*smoothstep(0.0,200.0,thickness)),1.0)), alpha);","}","}","// constants for atmospheric scattering","const float e = 2.71828182845904523536028747135266249775724709369995957;","const float pi = 3.141592653589793238462643383279502884197169;","// optical length at zenith for molecules","const float rayleighZenithLength = 8.4E3;","const float mieZenithLength = 1.25E3;","const vec3 up = vec3(0.0, 0.0, 1.0);","const float EE = 800.0;","const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;","// 66 arc seconds -> degrees, and the cosine of that","// earth shadow hack","const float cutoffAngle = 1.6110731556870734;","float steepness = 1.5;","const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );","const float TROIS_SUR_SEIZEPI = 0.05968310365946075;","float rayleighPhase(float cosTheta)","{","return TROIS_SUR_SEIZEPI * (1.0 + pow(cosTheta, 2.0));","}","const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );","vec3 totalMie(float T)","{","float c = (0.2 * T ) * 10E-18;","return 0.434 * c * MieConst;","}","float sunIntensity(float zenithAngleCos)","{","return EE * max(0.0, 1.0 - pow(e, -((cutoffAngle - acos(zenithAngleCos))/(steepness))));","}","// Filmic ToneMapping","float A = 0.15;","float B = 0.50;","float C = 0.10;","float D = 0.20;","float E = 0.02;","float F = 0.30;","const float whiteScale = 1.0748724675633854;","vec3 Uncharted2Tonemap(vec3 x)","{","return ((x*(A*x+0.05)+0.004)/(x*(A*x+B)+0.06))-0.0666666667;","}"].join("\n"),FS_overridableFunctions:{ProcessFinalColor:["float sunUpAngle = dot(sunDir, up);","float sunE = sunIntensity(sunUpAngle);","// extinction (absorbtion + out scattering) ","// rayleigh coefficients","vec3 betaR = totalRayleigh * reileigh;","// mie coefficients","vec3 betaM = totalMie(turbidity) * mieCoefficient;","// optical length","// cutoff angle at 90 to avoid singularity in next formula.","float zenithAngle = acos(max(0.0, dot(up, normalize(myWorldPosition - cameraPos))));","float sR = rayleighZenithLength / (cos(zenithAngle) + 0.15 * pow(93.885 - ((zenithAngle * 180.0) / pi), -1.253));","float sM = mieZenithLength / (cos(zenithAngle) + 0.15 * pow(93.885 - ((zenithAngle * 180.0) / pi), -1.253));","// combined extinction factor\t","vec3 Fex = exp(-(betaR * sR + betaM * sM));","// in scattering","float cosTheta = dot(normalize(myWorldPosition - cameraPos), sunDir);","float rPhase = rayleighPhase(cosTheta);","vec3 betaRTheta = betaR * rPhase;","float mPhase = hgPhase(cosTheta, mieDirectionalG);","vec3 betaMTheta = betaM * mPhase;","float coeffMie = smoothstep(0.005,0.1, mieCoefficient);","float coeffTurbid = smoothstep(1.0,20.0, turbidity);","vec3 thetaONbeta = ((betaRTheta + betaMTheta) / (betaR + betaM));","vec3 Lin = pow((sunE * max(0.6,min(0.7,1.0-coeffMie))) * thetaONbeta * (1.0 - Fex), vec3(1.5));","Lin *= mix(vec3(1.0),pow((sunE * max(0.6,min(0.7,1.0-coeffMie))) * thetaONbeta * Fex,vec3(0.5)),clamp(pow(1.0-sunUpAngle,5.0),0.0,1.0));","//nightsky","vec3 L0 = vec3(0.1) * pow(Fex, vec3(1.0-min(coeffTurbid,0.8)));","// composition + solar disc","float sundisk;","if(coverage <= 0.5 && sunDir.z >= 0.0){sundisk = 0.;}","else{sundisk = smoothstep(sunAngularDiameterCos,sunAngularDiameterCos+0.00002,cosTheta);}","L0 += (sunE * 19000.0 * Fex)*sundisk;","vec3 texColor = (Lin+L0);","texColor *= 0.04 ;","texColor += vec3(0.0,0.001,0.0025)*0.3;","vec3 curr = clamp(Uncharted2Tonemap((log2(1.366))*texColor),vec3(0.0), vec3(1.0));","vec3 color = curr*whiteScale;","vec2 uv = vGetTexCoord0().xy;","float phi = pi * (2.0 * uv.x - 1.0);","float theta = pi * uv.y;","vec3 posPixel = vec3( sin(theta)*cos(phi),  cos(theta), sin(theta)*sin(phi));","color = pow(render(posPixel, color),vec3(0.4545));","ioFinalColor.rgb = color;","ioFinalColor.a = 1.0;"].join("\n")}},_={uniforms:{turbidity:{type:"f",value:m},reileigh:{type:"f",value:g},mieCoefficient:{type:"f",value:p},mieDirectionalG:{type:"f",value:v},sunPos:{type:"v3",value:new e.Vector3(0,0,0)}},vertexShader:["varying vec2 vUv;","varying vec3 myWorldPosition;","void main() {","vUv = uv;","myWorldPosition = position;","gl_Position = projectionMatrix * ( viewMatrix * (modelMatrix * vec4( position, 1.0 )));","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform vec3 sunPos;","varying vec3 myWorldPosition;","uniform float turbidity;","uniform float reileigh;","uniform float mieCoefficient;","uniform float mieDirectionalG;","// constants for atmospheric scattering","const float e = 2.71828182845904523536028747135266249775724709369995957;","const float pi = 3.141592653589793238462643383279502884197169;","// optical length at zenith for molecules","const float rayleighZenithLength = 8.4E3;","const float mieZenithLength = 1.25E3;","const vec3 up = vec3(0.0, 0.0, 1.0);","const float EE = 800.0;","const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;","// 66 arc seconds -> degrees, and the cosine of that","// earth shadow hack","const float cutoffAngle = 1.6110731556870734;","const float steepness = 1.5;","const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );","const float TROIS_SUR_SEIZEPI = 0.05968310365946075;","const float UN_SUR_QUATREPI = 0.07957747154594767;","float rayleighPhase(float cosTheta)","{","return TROIS_SUR_SEIZEPI * (1.0 + pow(cosTheta, 2.0));","}","const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );","vec3 totalMie(float T)","{","float c = (0.2 * T ) * 10E-18;","return 0.434 * c * MieConst;","}","float hgPhase(float cosTheta, float g)","{","return UN_SUR_QUATREPI * ((1.0 - pow(g, 2.0)) / pow(1.0 - 2.0*g*cosTheta + pow(g, 2.0), 1.5));","}","float sunIntensity(float zenithAngleCos)","{","return EE * max(0.0, 1.0 - pow(e, -((cutoffAngle - acos(zenithAngleCos))/steepness)));","}","// Filmic ToneMapping","float A = 0.15;","float B = 0.50;","float C = 0.10;","float D = 0.20;","float E = 0.02;","float F = 0.30;","const float whiteScale = 1.0748724675633854;","vec3 Uncharted2Tonemap(vec3 x)","{","return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;","}","void main() {","float phi = pi * (2.0 * vUv.x - 1.0);","float theta = pi * vUv.y;","vec3 posPixel = vec3( sin(theta)*cos(phi),  sin(theta)*sin(phi), cos(theta) );","float sunfade = 1.0-clamp(1.0-exp(posPixel.z),0.0,1.0);","vec3 sunDirection = normalize(sunPos);","float sunUpAngle = dot(sunDirection, up);","float sunE = sunIntensity(sunUpAngle);","// extinction (absorbtion + out scattering) ","// rayleigh coefficients","vec3 betaR = totalRayleigh * reileigh;","// mie coefficients","vec3 betaM = totalMie(turbidity) * mieCoefficient;","// optical length","// cutoff angle at 90 to avoid singularity in next formula.","float zenithAngle = acos(max(0.0, dot(up, normalize(posPixel))));","float sR = rayleighZenithLength / (cos(zenithAngle) + 0.15 * pow(93.885 - ((zenithAngle * 180.0) / pi), -1.253));","float sM = mieZenithLength / (cos(zenithAngle) + 0.15 * pow(93.885 - ((zenithAngle * 180.0) / pi), -1.253));","// combined extinction factor\t","vec3 Fex = exp(-(betaR * sR + betaM * sM));","// in scattering","float cosTheta = dot(normalize(posPixel), sunDirection);","float rPhase = rayleighPhase(cosTheta*0.5+0.4);","vec3 betaRTheta = betaR * rPhase;","float mPhase = hgPhase(cosTheta, mieDirectionalG);","vec3 betaMTheta = betaM * mPhase;","float coeffMie = smoothstep(0.005,0.1, mieCoefficient);","float coeffTurbid = smoothstep(1.0,20.0, turbidity);","vec3 thetaONbeta = ((betaRTheta + betaMTheta) / (betaR + betaM));","vec3 Lin = pow((sunE * max(0.6,min(0.7,1.0-coeffMie))) * thetaONbeta * (1.0 - Fex), vec3(1.5));","Lin *= mix(vec3(1.0),pow((sunE * max(0.6,min(0.7,1.0-coeffMie))) * thetaONbeta * Fex,vec3(0.5)),clamp(pow(1.0-sunUpAngle,5.0),0.0,1.0));","//nightsky","vec3 L0 = vec3(0.1) * pow(Fex, vec3(1.0-min(coeffTurbid,0.8)));","// composition + solar disc","float sundisk = smoothstep(sunAngularDiameterCos,sunAngularDiameterCos+0.00002,cosTheta);","L0 += (sunE * 19000.0 * Fex)*sundisk;","vec3 texColor = (Lin+L0);   ","texColor *= 0.04 ;","texColor += vec3(0.0,0.001,0.0025)*0.3;","vec3 curr = Uncharted2Tonemap((log2(2.0/pow(1.1,4.0)))*texColor);","vec3 color = curr*whiteScale;","vec3 retColor = pow(color,vec3(1.0/(2.2)));","gl_FragColor.rgb = retColor;","gl_FragColor.a = 1.0;","} // main"].join("\n")},w=function(t){var s=u.getPDSFXMaterial(S);s.side=e.DoubleSide,s.forceSide=!0;var a=i.createSphereNode({radius:.5});a.setMaterial(s),s.needsUpdate=!0,s.force=!0,this.mesh=a,this.mesh.setPickable(n.NODRAWHL),this.mesh.setShadow(!1,!1),this.mesh.setSSAO(!1)},M=function(t){this.urban=t,this.shoot=0,this._vse=this.urban.getView3D(),b.flipY=!1,b.wrapS=e.RepeatWrapping,b.wrapT=e.RepeatWrapping,b.generateMipmaps=!0,this.sky=new w(t);this.urban.date;this.sky.mesh.material.updatePDSFXUniform("turbidity",this.urban.environment.skyParams.turbidity),this.sky.mesh.material.updatePDSFXUniform("reileigh",this.urban.environment.skyParams.reileigh),this.sky.mesh.material.updatePDSFXUniform("mieCoefficient",this.urban.environment.skyParams.mieCoefficient),this.sky.mesh.material.updatePDSFXUniform("mieDirectionalG",-this.urban.environment.skyParams.mieDirectionalG),this.sky.mesh.material.updatePDSFXUniform("coverage",1-this.urban.environment.cloudsParams.coverage),this.sky.mesh.material.updatePDSFXUniform("height",this.urban.environment.cloudsParams.height),this.sky.mesh.material.updatePDSFXUniform("thickness",this.urban.environment.cloudsParams.thickness),this.sky.mesh.material.updatePDSFXUniform("aspect",this.urban.environment.cloudsParams.aspect),this.sky.mesh.material.updatePDSFXUniform("shape",this.urban.environment.cloudsParams.shape),this.sky.mesh.material.updatePDSFXUniform("on",this.urban.environment.cloudsParams.on),this.sky.mesh.material.updatePDSFXUniform("windDirection",this.urban.environment.cloudsParams.windDirection),this.sky.mesh.material.updatePDSFXUniform("windSpeed",this.urban.environment.cloudsParams.windSpeed),this._skyboxMatrix=new e.Matrix4,this.lensFlare=new h(this.urban),this.lensFlare.initLensFlare();var i=function(){var t,i;t=this.urban.getViewpoint().getCamera().far,i=this.urban.getViewpoint()._getPositionRelative(),this.sky.mesh.material.updatePDSFXUniform("turbidity",this.urban.environment.skyParams.turbidity),this.sky.mesh.material.updatePDSFXUniform("reileigh",this.urban.environment.skyParams.reileigh),this.sky.mesh.material.updatePDSFXUniform("mieCoefficient",this.urban.environment.skyParams.mieCoefficient),this.sky.mesh.material.updatePDSFXUniform("mieDirectionalG",-this.urban.environment.skyParams.mieDirectionalG),this.sky.mesh.material.updatePDSFXUniform("coverage",1-this.urban.environment.cloudsParams.coverage),this.sky.mesh.material.updatePDSFXUniform("height",this.urban.environment.cloudsParams.height),this.sky.mesh.material.updatePDSFXUniform("thickness",this.urban.environment.cloudsParams.thickness),this.sky.mesh.material.updatePDSFXUniform("aspect",this.urban.environment.cloudsParams.aspect),this.sky.mesh.material.updatePDSFXUniform("shape",this.urban.environment.cloudsParams.shape),this.sky.mesh.material.updatePDSFXUniform("on",this.urban.environment.cloudsParams.on),this.sky.mesh.material.updatePDSFXUniform("windDirection",this.urban.environment.cloudsParams.windDirection),this.sky.mesh.material.updatePDSFXUniform("windSpeed",this.urban.environment.cloudsParams.windSpeed),this._skyboxMatrix.identity(),this._skyboxMatrix.scale(new e.Vector3(t,t,t)),this._skyboxMatrix.setPosition(i),this.sky.mesh.setMatrix(this._skyboxMatrix)}.bind(this);c.subscribeTo("/3DEXPERIENCity/onPostUpdate",i),this.composer=null,this._rendering=new f(t)};return M.prototype={updateSun:function(t){null===this.composer&&this.initSkyPass(),this.sky.mesh.material.updatePDSFXUniform("sunPos",this.urban.environment.sun.sunPos),this.passSky&&(this.passSky.uniforms.sunPos.value=this.urban.environment.sun.sunPos),this.computePass(),this.shoot++},setSkyColor:function(t){},getSunInfo:function(t,e){var i=Math.floor(this.width*(.5+t/Math.PI*.5)),s=4*(Math.floor(this.height*(.5+e/(.5*Math.PI)*.5))*this.width+i),a={r:Math.pow(this.buffer[s]/255,.5),g:Math.pow(this.buffer[s+1]/255,.5),b:Math.pow(this.buffer[s+2]/255,.5)},n=4*(this.height/2*this.width+this.width/2);return{d:a,a:{r:Math.pow(this.buffer[n]/255,.5),g:Math.pow(this.buffer[n+1]/255,.5),b:Math.pow(this.buffer[n+2]/255,.5)}}},initSkyPass:function(){this.width=1024,this.height=512,this.renderTarget=new e.WebGLRenderTargetProperties(this.width,this.height,"uint"),this.composer=new o(this.urban.USR.webGLV6Viewer.renderer.renderer,this.renderTarget,this.urban.USR.webGLV6Viewer.renderer.renderTargetPool),this.composer.composerContext.keepResult=!0,this.composer.name="depthCurrentEffectComposer",this.passSky=new r(_),this.passSky.renderToScreen=!1,this.composer.addPass(this.passSky)},computePass:function(){this.composer.render(),this.buffer=new Uint8Array(this.width*this.height*4),this.gl=this.urban.USR.webGLV6Viewer.renderer.renderer.context,this.gl.readPixels(0,0,this.width,this.height,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.buffer)},setCubeMap:function(t){},getRendering:function(){return this._rendering},redraw:function(){var t=this.getRendering(),e=t.getCompleteMaterialInfo().getRenderingData();t.applySkyMaterial(e)}},M}),define("DS/XCityEnvironment/Sun",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D","DS/XCityEnvironment/SunCalculator","DS/XCityTools/Geocoder","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher"],function(t,e,i,s,a,n,o){"use strict";return t.extend({init:function(t,a){this._urban=t,this.toUpdate=!0,this.lockUpdateLightFlag=!1;if(o.subscribeTo(o.eventsList.date,function(){this.toupdateLight,this._urban.USR._forceRender()}.bind(this)),this.changeEventName="effect.sun",this.sunCalculator=new s(t),this.ambientFactor=1,this.diffuseFactor=1,this.solarConstant=1367,this.altFactor=1,this.sunLight=new e.DirectionalLight(16777215,0),void 0===a.color)this.sunLight.color.setRGB(1.02,.98,.94),this._urban._debugVisualOdt&&this.sunLight.color.setHex(16777215);else if(void 0!==a.color.r&&void 0!==a.color.g&&void 0!==a.color.b)this.sunLight.color.setRGB(a.color.r,a.color.g,a.color.b);else{var n=new e.Color;n.setHex(parseInt(a.color,16)),this.sunLight.color=n}this.sunLight.intensity=.5,this.sunLight.intensity*=Math.PI,this.sunPos=new e.Vector3,void 0===a.position?(this.sunPos.x=.5*this._urban.worldSize,this.sunPos.y=.5*this._urban.worldSize,this.sunPos.z=.5*this._urban.worldSize):(this.sunPos.x=a.position.x,this.sunPos.y=a.position.y,this.sunPos.z=a.position.z),this.lightNode=new i(this.sunLight,null,null,!0),this.light=this.lightNode._occurrences[0].renderable;var r=(new e.Matrix4).translate(this.sunPos);this.lightNode.setMatrix(r),this._urban.USR._root.add(this.lightNode),void 0!==a.ambientFactor&&(this.ambientFactor=a.ambientFactor),void 0!==a.diffuseFactor&&(this.diffuseFactor=a.diffuseFactor),this.ambientLight=new e.AmbientLight,this.ambientLightNode=new i(this.ambientLight),this.updateLight(this._urban.date)},toupdateLight:function(){!0!==this.lockUpdateLightFlag&&(this.toUpdate=!0)},shadowState:function(t,e){n.log("ShadowState : ",t),this.shadow=e,this.setShadowCascade(t),t&&o.subscribeTo("/3DEXPERIENCity/onUpdate",this.updateShadowParameters.bind(this))},setShadowCascade:function(t){this._urban.USR.webGLV6Viewer.setShadow(t),this.light.castShadow=t,this.light.updateShadowMap=t,this.light.shadowDarkness=this.shadow.darkness,this._urban.USR.webGLV6Viewer.debugShadowLight=this.shadow.visible,this.sunLight.shadowCameraVisible=this.shadow.visible;var e=this.shadow.resolution?this.shadow.resolution:4096,i=!1,s=0;if(this.shadow.bias=[-.001,-.001,-.001],null!==this.light){this._urban.USR.webGLV6Viewer.getRenderer()&&(this._urban.USR.webGLV6Viewer.getRenderer().shadowMapCascade=t),this._urban.USR.webGLV6Viewer.shadowMapWidth=e,this._urban.USR.webGLV6Viewer.shadowMapHeight=e,this.shadowMapWidth===e&&this.shadowMapHeight===e||(i=!0,this.shadowMapWidth=e,this.shadowMapHeight=e,t||(this.light.shadowMap=null,this.light.shadowMapWidth=e,this.light.shadowMapHeight=e)),this.light.shadowCascade=t,this.light.LiSPSM=!1,this.light.shadowCascadeCount=this.shadow.nbShadowMaps?this.shadow.nbShadowMaps:3,this.light.shadowCascadeWidth=[],this.light.shadowCascadeHeight=[],this.light.shadowCascadeBias=[],this.light.shadowCascadeNearZ=[],this.light.shadowCascadeFarZ=[],this.light.shadowCascadeSubNear=[],this.light.shadowCascadeSubFar=[];var a=this._urban.USR.viewpoint._dist2ngp,n=[a-30,Math.max(2*a,10),Math.max(3.5*a,50)],o=[Math.max(2*a,10),Math.max(3.5*a,50),Math.max(5*a,300)];for(s=0;s<this.light.shadowCascadeCount;s++)this.light.shadowCascadeSubNear[s]=-n[s],this.light.shadowCascadeSubFar[s]=-o[s],this.light.shadowCascadeWidth[s]=e,this.light.shadowCascadeHeight[s]=e,this.light.shadowCascadeBias[s]=this.computeBias(s+1,this.shadow.bias),this.light.shadowCameraHelperToUpdate=this.shadow.visible;if(this.light.shadowCascadeOffset.set(0,0,-10),i&&this.light.shadowCascadeArray)for(s=0;s<this.light.shadowCascadeArray.length;s++){var r=this.light.shadowCascadeArray[s];r.shadowMap=null,r.LiSPSM=!1,r.shadowMapWidth=e,r.shadowMapHeight=e,r.shadowBias=this.computeBias(s+1,this.shadow.bias),r.shadowCameraHelperToUpdate=this.shadow.visible}}},computeBias:function(t,e){return void 0===e?1===t?-1e-4:2===t?-5e-4:-.001:e instanceof Array?e[t-1]:e},updateShadowParameters:function(){if(null!==this.light&&this.light.castShadow)for(var t=this._urban.USR.viewpoint._dist2ngp,e=[t-30,Math.max(2*t,10),Math.max(3.5*t,50)],i=[Math.max(2*t,10),Math.max(3.5*t,50),Math.max(5*t,300)],s=0;s<this.light.shadowCascadeCount;s++)this.light.shadowCascadeSubNear[s]=-e[s],this.light.shadowCascadeSubFar[s]=-i[s]},lockUpdateLight:function(){this.lockUpdateLightFlag=!0},unlockUpdateLight:function(){this.lockUpdateLightFlag=!1},updateLight:function(t){this.toUpdate=!1;var i=this.ambientLightNode._occurrences[0].renderable,s=this._urban.getViewpoint().getTarget();this._urban.baseReferential&&this._urban.baseReferential.bbox&&(s.x<this._urban.baseReferential.bbox.xmin&&(s.x=this._urban.baseReferential.bbox.xmin),s.x>this._urban.baseReferential.bbox.xmax&&(s.x=this._urban.baseReferential.bbox.xmax),s.y<this._urban.baseReferential.bbox.ymin&&(s.y=this._urban.baseReferential.bbox.ymin),s.y>this._urban.baseReferential.bbox.ymax&&(s.y=this._urban.baseReferential.bbox.ymax));var n=a.proj(s,a.getDefaultProjection(),"WGS84");this._urban._debugVisualOdt&&(n.x=0,n.y=0);var o=t._date.toString(),r=Math.round(n.x/15);r=r>0&&r<10?"+0"+r+"00":r>=10?"+"+r+"00":r<0&&r>-10?"-0"+Math.abs(r)+"00":r<=-10?"-"+Math.abs(r)+"00":"",o=o.split("GMT")[0]+"GMT"+r;var h=new Date(o);r=n.x/15*60,o=o.split("GMT")[0]+"GMT",(h=new Date(o)).setTime(h.getTime()-60*r*1e3);var l=this.sunCalculator.getPosition(h,n.y,n.x);this.sunDist=1e4;var u=1;this._urban.USR.viewpoint.getDistanceCameraToNearGroundPoint()>1e7?(l.altitude=Math.PI/2,l.azimuth=0,this.altFactor=1,this.altFactorBack=1,this.altFactorIBL=1,u=0):this._urban.USR.viewpoint.getDistanceCameraToNearGroundPoint()>2e6&&(u=1.25*(2e6/this._urban.USR.viewpoint.getDistanceCameraToNearGroundPoint()-.2),l.altitude=(1-u)*(Math.PI/2)+u*l.altitude,l.azimuth=0*(1-u)+u*l.azimuth),this._urban._debugVisualOdt&&(h=t._date,l=this.sunCalculator.getPosition(h,n.y,n.x),u=1);var c=Math.sin(l.altitude),f=Math.cos(l.altitude);this.sunPos.x=this.sunDist*Math.sin(l.azimuth)*f,this.sunPos.y=this.sunDist*Math.cos(l.azimuth)*f,this.sunPos.z=this.sunDist*c;var d=this._urban.USR.viewpoint.target;this.light.target.position.set(d.x,d.y,d.z);var b=new e.Vector3(this.sunPos.x+d.x,this.sunPos.y+d.y,this.sunPos.z+d.z),m=(new e.Matrix4).translate(b);this.lightNode.setMatrix(m);var g=this.sunCalculator.getTimes(h,n.y,n.x),p=g.sunrise.getTime(),v=g.sunset.getTime(),y=g.dawn.getTime(),S=g.dusk.getTime(),_=g.solarNoon.getHours()+.0166667*g.solarNoon.getMinutes(),w=h.getHours(),M=w+.0166667*h.getMinutes();if(this._urban._debugVisualOdt){var P=this.getDayAltitudes(t,n);P=this.normAltitude(P,0,1,!0);var C=this.getDayAltitudes(t,n);C=this.normAltitude(C,.2,1);var x=this.getDayAltitudes(t,n);x=this.normAltitude(x,.1,1),this.altFactor=isNaN(P[w])?1:P[w],this.altFactorBack=isNaN(C[w])?1:C[w],this.altFactorIBL=isNaN(x[w])?1:x[w],this.ambientValue=Math.max(5.3*this.ambientFactor,.07),this.diffuseValue=this.diffuseFactor*P[w]*5.3}else{var D=(S-y)/36e5,E=D/2,F=_/E,k=(-1+F)*E,L=(1+F)*E;k<0&&M>k+24?(F=(_+24)/E,this.altFactorBack=1-Math.pow(M/E-F,16)):L>24&&M<L-24?(F=(_-24)/E,this.altFactorBack=1-Math.pow(M/E-F,16)):isNaN(D)||(this.altFactorBack=1-Math.pow(M/E-F,16)),isNaN(D)&&(this.altFactorBack=1),this.altFactorIBL=this.altFactorBack,this.altFactorBack<0&&(this.altFactorBack=0),this.altFactorIBL<.1&&(this.altFactorIBL=.1);var T=(v-p)/36e5,z=T/2,N=_/z,R=(-1+N)*z,A=(1+N)*z;R<0&&M>R+24?(N=(_+24)/z,this.altFactor=1-Math.pow(M/z-N,16)):A>24&&M<A-24?(N=(_-24)/z,this.altFactor=1-Math.pow(M/z-N,16)):isNaN(T)||(this.altFactor=1-Math.pow(M/z-N,16)),isNaN(T)&&(this.altFactor=1),this.altFactor<0&&(this.altFactor=0),this.altFactor=u*this.altFactor+1*(1-u),this.altFactorIBL=u*this.altFactorIBL+1*(1-u),this.altFactorBack=u*this.altFactorBack+1*(1-u)}if(this._urban.environment&&this._urban.environment.sky&&this._urban.environment.sky.updateSun){if(this._urban.environment.sky.lensFlare){var U=new e.Vector3(10*this._urban.worldSize*this.sunPos.x+d.x,10*this._urban.worldSize*this.sunPos.y+d.y,10*this._urban.worldSize*this.sunPos.z+d.z),V=(new e.Matrix4).translate(U);this._urban.environment.sky.lensFlare.node1s.setMatrix(V)}this._urban.environment.sky.updateSun();var X=this._urban.environment.sky.getSunInfo(l.azimuth,l.altitude);this.light.color.setRGB(1.2*X.d.r,1.2*X.d.g,1.2*X.d.b),i.color.setRGB(.8*X.a.r,.8*X.a.g,.8*X.a.b),this._urban.environment.slab._infPlaneMaterial.getPDSFXUniform("skyColor").value.setRGB(X.a.r,X.a.g,X.a.b),this.AmbientIntensity=this.ambientFactor,this.light.intensity=this.diffuseFactor*this.diffuseFactor,this.light.intensity*=Math.PI,i.intensity=this.ambientFactor}else this.diffuseValue=this.diffuseFactor*this.altFactor*5.3*.5,this.light.intensity=this.diffuseValue,debugWebGLV6Viewer.ambience.getBackground().setIntensity(this.altFactorBack*this.ambientFactor*5.3*.25),debugWebGLV6Viewer.ambience.getEnvironmentLight().setIntensity(this.altFactorIBL*this.ambientFactor*5.3*.25)},getDayAltitudes:function(t,e){for(var i=t.getDate().getHours(),s=[],a=t.valueOf(),n=0;n<24;n++){a.getDate().setHours(n);var o=this.sunCalculator.getPosition(a.getDate(),e.y,e.x);s[n]=o.altitude}return this._urban.date.getDate().setHours(i),s},verbose:function(){n.log("Sun pos is   ",this.sunLight.position),n.log("Sun color is ",this.sunLight.color)},getPos:function(){return this.sunLight.position},setPos:function(t){this.sunLight.position=t},setAltitude:function(t){this.sunLight.position.z=t},getColor:function(){return this.sunLight.color},setColor:function(t){this.sunLight.color.setHex(t)},normAltitude:function(t,e,i,s){var a=0,n=0;if(void 0===e&&(e=0),void 0===i&&(i=1),s)for(var o=0;o<t.length;o++)t[o]<0&&(t[o]=0);for(o=0;o<t.length;o++)(t[o]<n||0==n)&&(n=t[o]);for(o=0;o<t.length;o++)t[o]+=Math.abs(n);n+=Math.abs(n);for(o=0;o<t.length;o++)(t[o]>a||0==a)&&(a=t[o]);for(o=0;o<t.length;o++)t[o]=(t[o]-n)/(a-n);if(0!==e||1!==i)for(o=0;o<t.length;o++)t[o]=e+t[o]*(i-e);return t},setDiffuseFactor:function(t){this.diffuseFactor=t,this.toupdateLight(),o.publish(o.eventsList[this.changeEventName+".diffuseFactor"],t)},setAmbientFactor:function(t){this.ambientFactor=t,debugWebGLV6Viewer.ambience.getEnvironmentLight().setIntensity(this.altFactor*this.ambientFactor),o.publish(o.eventsList[this.changeEventName+".ambientFactor"],t)}})}),define("DS/XCityEnvironment/Environment",["UWA/Class","UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityEnvironment/VisualEffect","DS/XCityEnvironment/Sun","DS/XCityEnvironment/LensFlare","DS/XCityEnvironment/Slab","DS/XCityEnvironment/CubeMap","DS/XCityEnvironment/Sky","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher"],function(t,e,i,s,a,n,o,r,h,l,u,c,f,d){"use strict";var b=t.extend(e,{init:function(t){this._urban=t,this.changeEventName="effect",this._loadListeners(),this.initialized=!1,this._param=new m,this.shadowConfig(this._param.shadow),this.effects={},this.defaults={},this.disabledEffects={},this.defaultslabcolor=(new i.Color).setRGB(.596078431,.768627451,.91372549);var e=this._urban.getRenderingProfileManager(),s=this._urban.getPerformanceProfileManager();this.addRenderProfile(e.defaultProfile,this._param);var a=this;e.addProfile(e.defaultProfile,function(t,e){a.setRendering(e),a.setSlabColor(a.defaultslabcolor)},e.defaultProfile,"EffectsParams"),e._initEnvironment(this),s._initEnvironment(this),this.sun=new o(this._urban,this._param.sun||{}),this.sky=new l(this._urban,this._param.sky||this._param),this.presetList=[{turbidity:2.6,reileigh:1,mieCoefficient:.013,mieDirectionalG:-.8,density:1},{turbidity:14,reileigh:4,mieCoefficient:.05,mieDirectionalG:-.75,density:.4},{turbidity:20,reileigh:1,mieCoefficient:.1,mieDirectionalG:-.7,density:.3},{turbidity:20,reileigh:1,mieCoefficient:.1,mieDirectionalG:-.9,density:1}],this.cloudsParams={coverage:.5,thickness:80,height:100,aspect:.035,shape:.01,on:!1,windDirection:new i.Vector3(1,0,0),windSpeed:.2},this.skyParams=this.presetList[0],this.showroom=0,this.betasky=null,this.slab=new h(this._urban,this._param),this.initEffects(),this.setRendering(this._urban.USR.renderingCurrent),this.initialized=!0,this.showAtmosphere=!1},_loadListeners:function(){var t=this,e={evtEnvironment:function(e){d.publish("/xCity/needRender",this),d.publish(d.eventsList[t.changeEventName],e)},evtAO:function(i){d.publish(d.eventsList[t.changeEventName+".ao"],i),e.evtEnvironment(i)},evtBloom:function(i){d.publish(d.eventsList[t.changeEventName+".bloom"],i),e.evtEnvironment(i)},evtTone:function(i){d.publish(d.eventsList[t.changeEventName+".tone"],i),e.evtEnvironment(i)},evtSun:function(i){d.publish(d.eventsList[t.changeEventName+".sun"],i),e.evtEnvironment(i)},evtSlab:function(i){d.publish(d.eventsList[t.changeEventName+".slab"],i),e.evtEnvironment(i)},evtShadow:function(i){d.publish(d.eventsList[t.changeEventName+".shadow"],i),e.evtEnvironment(i)}};d.subscribeTo(d.eventsList[this.changeEventName+".dof"],e.evtEnvironment),d.subscribeTo(d.eventsList[this.changeEventName+".sslr"],e.evtEnvironment),d.subscribeTo(d.eventsList[this.changeEventName+".ao.enable"],e.evtAO),d.subscribeTo(d.eventsList[this.changeEventName+".ao.strength"],e.evtAO),d.subscribeTo(d.eventsList[this.changeEventName+".ao.angle"],e.evtAO),d.subscribeTo(d.eventsList[this.changeEventName+".bloom.enable"],e.evtBloom),d.subscribeTo(d.eventsList[this.changeEventName+".bloom.factor"],e.evtBloom),d.subscribeTo(d.eventsList[this.changeEventName+".tone.enable"],e.evtTone),d.subscribeTo(d.eventsList[this.changeEventName+".tone.gamma"],e.evtTone),d.subscribeTo(d.eventsList[this.changeEventName+".tone.type"],e.evtTone),d.subscribeTo(d.eventsList[this.changeEventName+".infinitePlane"],e.evtEnvironment),d.subscribeTo(d.eventsList[this.changeEventName+".sun.diffuseFactor"],e.evtSun),d.subscribeTo(d.eventsList[this.changeEventName+".sun.ambientFactor"],e.evtSun),d.subscribeTo(d.eventsList[this.changeEventName+".slab.color"],e.evtSlab),d.subscribeTo(d.eventsList[this.changeEventName+".aa"],e.evtEnvironment),d.subscribeTo(d.eventsList[this.changeEventName+".normalMap"],e.evtEnvironment),d.subscribeTo(d.eventsList[this.changeEventName+".specularMap"],e.evtEnvironment),d.subscribeTo(d.eventsList[this.changeEventName+".roofMode"],e.evtEnvironment),d.subscribeTo(d.eventsList[this.changeEventName+".shadow.enable"],e.evtShadow),d.subscribeTo(d.eventsList[this.changeEventName+".shadow.visible"],e.evtShadow),d.subscribeTo(d.eventsList[this.changeEventName+".shadow.bias"],e.evtShadow),d.subscribeTo(d.eventsList[this.changeEventName+".shadow.darkness"],e.evtShadow),d.subscribeTo(d.eventsList[this.changeEventName+".shadow.nbShadowMaps"],e.evtShadow),d.subscribeTo(d.eventsList[this.changeEventName+".shadow.resolution"],e.evtShadow),d.subscribeTo(d.eventsList[this.changeEventName+".shadow.boxSize"],e.evtShadow),d.subscribeTo(d.eventsList[this.changeEventName+".shadow.altitudeOff"],e.evtShadow),d.subscribeTo(d.eventsList[this.changeEventName+".shadow.altitudeOn"],e.evtShadow)},setup:function(t,e){this.sky.initDefaultSky()},reset:function(t,e){},addRenderProfile:function(t,e){c.is(this.defaults[t])||(this.defaults[t]={}),c.is(this.defaults[t])&&this._mergeeffects(this.defaults[t],e);var i=this._urban.getRenderingProfileManager().sessionProfileName;this.type!==t&&t!==i||this.setRendering(this.type)},removeRenderProfile:function(t){c.is(this.defaults[t])&&(this.defaults[t]={})},disableEffects:function(t){if(c.is(t)){var e,i,s=["aa","ao","bloom","dof","shadow","tone","sslr"];for(e=0;e<s.length;e++){i=s[e];var a=t.indexOf(i);c.is(this.disabledEffects[i])?a>=0||(this.disabledEffects[i]=void 0,d.publish(d.eventsList["disable."+this.changeEventName+"."+i],!1),d.publish(d.eventsList["disable."+this.changeEventName],i)):a>=0?(this._enableEffect(i,!1),this.disabledEffects[i]=!0,d.publish(d.eventsList["disable."+this.changeEventName+"."+i],!0),d.publish(d.eventsList["disable."+this.changeEventName],i)):(d.publish(d.eventsList["disable."+this.changeEventName+"."+i],!1),d.publish(d.eventsList["disable."+this.changeEventName],i))}return c.is(this.type)&&this.setParams(this.defaults[this.type]),!0}return!1},shadowConfig:function(t){var e={visible:!1,bias:[-1e-4,-5e-4,-.001],darkness:.6,nbShadowMaps:3,resolution:4096};for(var i in void 0===t&&(t={}),e)void 0===t[i]?t[i]=e[i]:d.publish(d.eventsList[this.changeEventName+".shadow."+i],t[i]);this.shadow=t},initEffects:function(){var t=this,e=this._param.effects,i=this._urban.getView3D().webGLV6Viewer;void 0===e&&(e=this._param);this.effects.ao=new n(this._urban,"ao",i.setSSAO.bind(i),e,!1,function(t,e){var s=i.getEffect("SSAO");null!==s&&("strength"===t?(s.setStrength(e),i.setSSAOParameters({power:e})):"angle"===t&&(s.setThresholdAngle(e),i.setSSAOParameters({thresholdAngle:e}))),this._options[t]=e});this.effects.bloom=new n(this._urban,"bloom",i.setBloom.bind(i),e,!1,function(t,e){var s=i.getEffect("Bloom");null!==s&&"factor"===t&&s.setBloomFactor(e),this._options[t]=e}),this.effects.sslr=new n(this._urban,"sslr",i.setSSLR.bind(i),e,!1);this.effects.dof=new n(this._urban,"dof",function(t){i.setDOF(t);var e=i.getEffect("DOF");e&&t&&(e.useCameraInfo=!0,e.setAutoFocus(!0),e.setSceneScale(1e3),e.setBehaviour(e.Behaviours.ARTISTIC))},e,!1);this.effects.aa=new n(this._urban,"aa",function(t){i.setAntiAliasing(!0===t?"SMAA":"NoAA")},e,!0);this.effects.tone=new n(this._urban,"tone",function(t){i.setToneMapping({enable:t}),this._options.enable=t},e.tone&&e.tone.gamma?e:{tone:{gamma:2.2,type:2}},!0,function(t,e){var s=i.renderer.ToneMappingEffect;null!==s&&("gamma"===t?s.setGamma(e):"type"===t&&s.setToneMapping(this._options.enable?e:0)),this._options[t]=e});this.effects.shadow=new n(this._urban,"shadow",function(e){t.sun.shadowState(e,t.shadow)},e,!1)},update:function(){this.sky&&this.sky.update()},setAmbientFactor:function(t){return this.sun&&t!==this.sun.ambientFactor?(this.sun.setAmbientFactor(t),this):null},setDiffuseFactor:function(t){var e=null;return this.sun&&t!==this.sun.diffuseFactor&&(this.sun.setDiffuseFactor(t),e=!0),e},switchSky:function(){null===this.betasky&&(this.betasky=new u(this._urban),this.cubeSky=this.sky),this.realisticSky?(this.sky=this.cubeSky,this._urban.USR._root.remove(this.betasky.sky.mesh),this.sun.toUpdate=!0,this.realisticSky=!1,this.showAtmosphere&&this._atmosphere.disableEffect()):(this._urban.USR._root.add(this.betasky.sky.mesh),this.sky=this.betasky,this.sun.toUpdate=!0,this.realisticSky=!0,this.showAtmosphere&&(this._atmosphere||(this._atmosphere=this._urban.getView3D().getAtmosphereEffect()),this._atmosphere.enableEffect()))},setSlabColor:function(t){t&&(this.sky&&this.sky.setSkyColor(t),this.slab&&this.slab.setSkyColor(t),d.publish(d.eventsList[this.changeEventName+".slab.color"],t))},getSlabColor:function(){return this.sky?this.sky.getSkyColor():this.slab?this.slab.getSkyColor():void 0},enableEffect:function(t,e){return!!c.is(this.effects[t])&&this._enableEffect(t,e)},_enableEffect:function(t,e){if(c.is(this.disabledEffects[t]))return!1;var i=this.effectEnabled(t);if(c.is(i)&&i!==e){this.effects[t].enable(e);var s=".enable";return c.is(this._param[t].enable)||(s=""),d.publish(d.eventsList[this.changeEventName+"."+t+s],e),!0}},effectEnabled:function(t){return c.is(this.effects[t])?this.effects[t].enabled:null},setEffectAttribute:function(t,e,i){return c.is(this.effects[t])&&c.is(this.effects[t].update)&&this.effects[t].getOption(e)!==i?(this._setEffectAttribute(t,e,i),this):null},_setEffectAttribute:function(t,e,i){c.is(this.disabledEffects[t])||(this.effects[t].update(e,i),d.publish(d.eventsList[this.changeEventName+"."+t+"."+e],i))},setParams:function(t){if(this.initialized&&c.is(t)){var e=c.clone(t),i=this._urban.getRenderingProfileManager().sessionProfileName;if(c.is(this.defaults[i])){var s=c.clone(this.defaults[i]);this._mergeeffects(s,e),e=s}if(c.is(e.dof)&&this._enableEffect("dof",e.dof),c.is(e.sslr)&&this._enableEffect("sslr",e.sslr),c.is(e.ao)&&(c.is(e.ao.enable)&&this._enableEffect("ao",e.ao.enable),c.is(e.ao.strength)&&this._setEffectAttribute("ao","strength",e.ao.strength),c.is(e.ao.angle)&&this._setEffectAttribute("ao","angle",e.ao.angle)),c.is(e.bloom)&&(c.is(e.bloom.enable)&&this._enableEffect("bloom",e.bloom.enable),c.is(e.bloom.factor)&&this._setEffectAttribute("bloom","factor",e.bloom.factor)),c.is(e.tone)&&(c.is(null!==e.tone.enable)&&this._enableEffect("tone",e.tone.enable),c.is(e.tone.gamma)&&this._setEffectAttribute("tone","gamma",e.tone.gamma)),c.is(e.infinitePlane)&&this.slab&&this.slab.enableInfinitePlane(e.infinitePlane),c.is(e.sun)&&(c.is(e.sun.ambientFactor)&&this.sun.setAmbientFactor(e.sun.ambientFactor),c.is(e.sun.diffuseFactor))){var a=e.sun.diffuseFactor;this.sun&&this.sun.setDiffuseFactor(a)}c.is(e.aa)&&this._enableEffect("aa",e.aa),c.is(e.normalMap)&&(this._urban.useNormalMap=e.normalMap,this.dispatchEvent(this.ChangeEventName)),c.is(e.specularMap)&&(this._urban.useSpecularMap=e.specularMap,this.dispatchEvent(this.ChangeEventName)),c.is(e.roofMode)&&(this._urban.roofMode=e.roofMode,this.dispatchEvent(this.ChangeEventName)),c.is(e.shadow)&&(this.shadowConfig(e.shadow),c.is(e.shadow.enable)&&this._enableEffect("shadow",e.shadow.enable))}},getParams:function(){var t={};return t.bloom={enable:this.effects.bloom.enabled,factor:this.effects.bloom.getOption("factor")},t.aa=this.effects.aa.enabled,t.ao={enable:this.effects.ao.enabled,strength:this.effects.ao.getOption("strength"),angle:this.effects.ao.getOption("angle")},t.shadow={enable:this.effects.shadow.enabled},t.dof=this.effects.dof.enabled,t.sslr=this.effects.sslr.enabled,t.tone={enable:this.effects.tone.enabled,gamma:this.effects.tone.getOption("gamma")},t.normalMap=this._urban.useNormalMap,t.specularMap=this._urban.useSpecularMap,t.roofMode=this._urban.roofMode,t.sun={diffuseFactor:this._urban.environment.sun.diffuseFactor,ambientFactor:this._urban.environment.sun.ambientFactor},t},_getprofileparams:function(t){var e=null;return c.is(this.defaults[t])&&(e=c.clone(this.defaults[t])),e},setRendering:function(t){var e=this._urban.getRenderingProfileManager(),i=e.sessionProfileName,s=null;if(c.is(this.defaults[t])){s=this.defaults[t];e.sessionProfileName;this.type=t}else s=this.defaults[i],this.type=i;this.setParams(s)},applySkyMaterial:function(t){var e=this.defaultslabcolor;c.is(t)&&c.is(t.slabColor)&&(e=t.slabColor),this.setSlabColor(e);var i=null;c.is(t)&&c.is(t.cubeMap)&&(i=t.cubeMap),this.sky.setCubeMap(i)},getSkyMaterial:function(){var t={};return t.slabColor=this.sky.getSkyColor(),t.cubeMap=this.sky.getCubeMap(),t},_mergeeffects:function(t,e){if(c.is(t)&&c.is(e)&&(c.is(e.dof)&&(t.dof=e.dof),c.is(e.sslr)&&(t.sslr=e.sslr),c.is(e.ao)&&(c.is(t.ao)||(t.ao={}),c.is(e.ao.enable)&&(t.ao.enable=e.ao.enable),c.is(e.ao.strength)&&(t.ao.strength=e.ao.strength),c.is(e.ao.angle)&&(t.ao.angle=e.ao.angle)),c.is(e.bloom)&&(c.is(t.bloom)||(t.bloom={}),c.is(e.bloom.enable)&&(t.bloom.enable=e.bloom.enable),c.is(e.bloom.factor)&&(t.bloom.factor=e.bloom.factor)),c.is(e.tone)&&(c.is(t.tone)||(t.tone={}),c.is(e.tone.enable)&&(t.tone.enable=e.tone.enable),c.is(e.tone.gamma)&&(t.tone.gamma=e.tone.gamma)),c.is(e.infinitePlane)&&(t.infinitePlane=e.infinitePlane),c.is(e.sun)&&(c.is(t.sun)||(t.sun={}),c.is(e.sun.ambientFactor)&&(t.sun.ambientFactor=e.sun.ambientFactor),c.is(e.sun.diffuseFactor)&&(t.sun.diffuseFactor=e.sun.diffuseFactor)),c.is(e.aa)&&(t.aa=e.aa),c.is(e.normalMap)&&(t.normalMap=e.normalMap),c.is(e.specularMap)&&(t.specularMap=e.specularMap),c.is(e.roofMode)&&(t.roofMode=e.roofMode),c.is(e.shadow))){c.is(t.shadow)||(t.shadow={});for(var i=["enable","visible","bias","darkness","nbShadowMaps","resolution","boxSize","altitudeOff","altitudeOn","subNears","subFars"],s=0;s<i.length;s++){var a=i[s];c.is(e.shadow[a])&&(t.shadow[a]=e.shadow[a])}}}}),m=t.extend({init:function(t){if(this.resetDefaultValue(),c.is(t))for(var e,i=c.clone(t),s=Object.keys(i),a=s.length;a--;)this[e=s[a]]=i[e]},resetDefaultValue:function(){this.bloom={enable:!1,factor:.2},this.aa=!0,this.ao={enable:!1,strength:.5,angle:1},this.shadow={enable:!1},this.dof=!1,this.sslr=!1,xCity._urbanImpl._debugVisualOdt&&(this.sslr=!0),this.normalMap=!0,this.specularMap=!0,this.roofMode=!1,this.infinitePlane=!0,this.tone={enable:!0,gamma:2.2,type:2},this.sun={diffuseFactor:1,ambientFactor:1}},clone:function(){var t=new m;return t.bloom={enable:this.bloom.enable,factor:this.bloom.factor},t.aa=this.aa,t.ao={enable:this.ao.enable,strength:this.ao.strength,angle:this.ao.angle},t.shadow={enable:this.shadow.enable},t.dof=this.dof,t.sslr=this.sslr,t.normalMap=this.normalMap,t.specularMap=this.specularMap,t.roofMode=this.roofMode,t.infinitePlane=this.infinitePlane,t.tone={enable:this.tone.enable,gamma:this.tone.gamma},t.sun={diffuseFactor:this.sun.diffuseFactor,ambientFactor:this.sun.ambientFactor},t}});return b});