define("DS/ENONextGenFilterCmd/commands/ENONextGenFilterCmdEngine",["UWA/Core","UWA/Class","UWA/Utils/InterCom","DS/Core/PointerEvents","DS/ApplicationFrame/Command","DS/Logger/Logger","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/PlatformAPI/PlatformAPI","DS/WebappsUtils/WebappsUtils","UWA/Promise","i18n!DS/ENONextGenFilterCmd/assets/nls/ENONextGenFilterCmd","DS/Windows/ImmersiveFrame","DS/Windows/Dialog","DS/CollectionView/ResponsiveLargeTilesCollectionView","DS/Controls/Button","DS/Tree/TreeDocument","DS/Tree/TreeNodeModel","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/NGFServices","DS/ENOFilterBIUX/FBISettings","DS/Utilities/Utils","DS/PADServices/utils/PADTrackerManager"],function(e,t,i,n,o,s,r,a,l,d,c,h,g,u,_,p,v,m,f,I,S,F){"use strict";return t.extend({init:function(e){this._getSelectorManager=e.getSelectorManager,this._getAppParams=e.getAppParams,this._getRoots=e.getRoots,this._getSelection=e.getSelection,this._isCmdActivated=!1,this._rootsInSession={},this._selectionByEvent=0,a.subscribe("NGFilter.RemoveFilter",this._onRemoveFilter.bind(this)),a.subscribe("NGFilter.SetDefaultSecurityContext",this._onSetSecurityContext.bind(this)),a.subscribe("NGFilter_Volume",this._onFilterVolume.bind(this)),a.subscribe("NGFilter_VolumeDefined",this._onVolumeDefined.bind(this)),a.subscribe("NGFilter_CancelVolumeDefined",this._onVolumeCancelled.bind(this)),this._selectionCrossWidget=0,this._selectByEvent=-1,a.subscribe("DS/ENO/select",this._onSelectByENOEvent.bind(this)),a.subscribe("DS/PADUtils/PADCommandProxy/select",this._onSelectByPADUtilsEvent.bind(this))},execute:function(){if(this._isCmdActivated){var e=this._getAppParams.call();this._NGFUXId=e.NGFUXId||e.appId,this._appId=e.appId,this._launchAdvFilter().then(function(){})}else{var t=this;this._initialize().then(function(){t._isCmdActivated=!0,t._launchAdvFilter().then(function(){})},function(e){s.error("Error Filter Command: "+e)})}},getCmdAvailability:function(){return this._SelectedID?1:0},_onSelectByENOEvent:function(e){if(this._selectionCrossWidget=1,this._selectByEvent=-1===this._selectByEvent?1:this._selectByEvent,this._selectByEvent&&this._widgetId==e.metadata.originWidgetId&&e.data.paths&&e.data.paths.length&&this._isCmdActivated&&!this._isVolumeBeingDefine){var t=this._getRootsAndSelection(!1);this._setSelectionAndUpdateFilter(t)}},_onSelectByPADUtilsEvent:function(e){if(this._selectionCrossWidget=1,this._selectByEvent=-1===this._selectByEvent?0:this._selectByEvent,!this._selectByEvent&&this._widgetId==e.metadata.originWidgetId&&e.data.paths&&e.data.paths.length&&this._isCmdActivated&&!this._isVolumeBeingDefine){var t=this._getRootsAndSelection(!1);this._setSelectionAndUpdateFilter(t)}},_checkSelection:S.debounce(function(e){if(!this._selectionCrossWidget&&e&&this._isCmdActivated&&!this._isVolumeBeingDefine){var t=this._getRootsAndSelection(!1);this._setSelectionAndUpdateFilter(t)}},200),_initialize:function(){var e=this;return new Promise(function(t,i){e._widget=widget;var n=Date.now(),o=e._getAppParams.call(),r=Date.now()-n;e._displayInternalDurationTrace("Command.getAppParams",r),e._NGFUXId=o.NGFUXId||o.appId,e._appId=o.appId,e._widgetId=o.widgetId,e._tenantId=o.tenantId||e._getTenantId(),e._defaultSC=o.securityContext;var a=e._NGFUXId+"-"+e._widgetId;e._defaultSC=sessionStorage.getItem("NGFilter_SecurityContext_"+a),e._queryFormat=sessionStorage.getItem("NGFilter_ExpandType_"+a)||f.getQueryFormat(),n=Date.now(),e._SelectorManager=e._getSelectorManager.call();var l=Date.now()-n;if(e._displayInternalDurationTrace("Command.getSelectorManager",l),e._SelectorManager){var d=e._SelectorManager.onPostAdd,c=e._SelectorManager.onPostRemove,h=e._SelectorManager.onEmpty;if(d&&c&&h)e._SelectorManager.onPostAdd(e._checkSelection.bind(e)),e._SelectorManager.onPostRemove(e._checkSelection.bind(e)),e._SelectorManager.onEmpty(e._checkSelection.bind(e));else{var g=(d?"":" onPostAdd()")+(c?"":" onPostRemove()")+(h?"":" onEmpty()");s.error("Function not implemented = "+g),i(g)}}else e._selectionCrossWidget=1;f.setPerformanceTracker(e._widgetId,"NGF-Cmd_App_Data","NGFilter_Cmd",{AppParams_duration:r,SelectorManager_duration:l},0),e._isConfigAvailable=1,t()})},_launchAdvFilter:function(){var e=this;return f.setUsageTracker(this._widgetId,"NGF-Launch-Filter",this._getAppId()),new Promise(function(t,i){var n=e._getRootsAndSelection(!0),o=n.roots,s=o?o.length:0;s?e._completeRootsInfos(n).then(function(){if(n.label=[],o.forEach(function(e){n.label.push([e.label])}),1===s)e._setSelectionAndUpdateFilter(n),e._openFilterPanel();else if(1===n.path.length)if(1===n.path[0].length){for(var i=n.path[0][0],r=0;r<n.roots.length;r++)if(i===n.roots[r].id){n.label=[n.label[r]],n.roots=[n.roots[r]];break}e._setSelectionAndUpdateFilter(n),e._openFilterPanel()}else e._displayAndSelectRoot(o,n.path);else e._displayAndSelectRoot(o,n.path);t()}):t()})},_onSetSecurityContext:function(e){this._NGFUXId===e.NGFUXId&&this._defaultSC!==e.securityContext&&(this._defaultSC=e.securityContext)},_setFocusToWidget:function(){this._widget&&this._widget.dispatchEvent("onViewRequest",{focus:!0})},_completeRootsInfos:function(e){var t=this;return new d(function(i,n){for(var o=e.roots,r=o?o.length:0,a=!1,l=!1,d=[],c=0;c<r;c++)d.push({rootId:o[c].id,serviceId:o[c].serviceId}),a=!(!a&&o[c].label),o[c].revision?t._rootsInSession[o[c].id]=o[c].revision||"":o[c].revision=t._rootsInSession[o[c].id]||"",l=!(!l&&o[c].revision);if(1!==r||a){var h=["ds6w:label","ds6wg:revision"],g=f.getDisplaySeparator(),u=[];(a||l)&&(u=u.concat(I.getOption("displayRoot_AttributesTitle"))||h,a&&u.push("ds6w:label"),l&&u.push("ds6wg:revision")),u=[...new Set(u)];var _=I.getOption("displayRoot_AttributesLevel1")||[],p=I.getOption("displayRoot_AttributesLevel2")||[],v=u.concat(_).concat(p);v=(v=[...new Set(v)]).length?v:h,m.getPredicatesInfosFromIds(d,v,!0).then(function(e){for(var n=e.length,s=0;s<r;s++)for(var d=0;d<n;d++)if(o[s].id===e[d].id){o[s].thumbnail=e[d].thumbnail,o[s].icon=e[d].icon;var c=[];if(a){o[s].label="",o[s].revision="";for(var h=0;h<u.length;h++)for(var v=0;v<e[d].predicates.length;v++){if((m=e[d].predicates[v]).name.endsWith(u[h])){c.push(m.dispValue||m.value),"ds6wg:revision"===u[h]&&(o[s].revision=l?m.value:"",t._rootsInSession[o[s].id]=o[s].revision);break}}c.length&&(o[s].label=c.join(g))}o[s].values="",c=[];for(h=0;h<_.length;h++)for(v=0;v<e[d].predicates.length;v++){if((m=e[d].predicates[v]).name.endsWith(_[h])&&m.value&&m.value.length){c.push(m.value);break}}c.length&&(o[s].values=c.join(g)),o[s].description="",c=[];for(h=0;h<p.length;h++)for(v=0;v<e[d].predicates.length;v++){var m;if((m=e[d].predicates[v]).name.endsWith(p[h])){c.push(m.value);break}}c.length&&(o[s].description=c.join(g));break}i()},function(e){s.error("Advanced Filter: Error to retrieve Roots infos !")})}else l?t._retrieveRevision(d).then(function(e){o.forEach(i=>{i.revision=e[i.id]||"",t._rootsInSession[i.id]=i.revision}),i()}):i()})},_retrieveRevision:function(e){var t={};e.length;return new d(function(i,n){m.getPredicatesInfosFromIds(e,["ds6wg:revision"],!1).then(function(n){e.forEach(e=>{var i,o=e.rootId,s=n.findIndex(e=>o===e.id);-1!==s&&(s=(i=n[s].predicates).findIndex(function(e){return"ds6wg:revision"===e.name})),t[o]=-1===s?"":i[s].value}),i(t)},function(e){s.error("Advanced Filter: Error to retrieve Roots revisions !"),i(t)})})},_getRootsAndSelection:function(e){var t,i={},n=void 0,o=Date.now();(n=this._getRoots.call()).forEach(e=>{e.serviceId=e.serviceId||"3DSpace"}),t=Date.now()-o,this._displayInternalDurationTrace("Command.getRoots",t);o=Date.now();var s=this._getSelection.call(),r=Date.now()-o;this._displayInternalDurationTrace("Command.getSelection",r);var a=!1!==s.directSelection;if(!e){var l=[];s.path.forEach(e=>{var t=n.find(t=>e[0]===t.id);t&&l.push(t.serviceId)}),s.serviceId=l,!(!s.path||1!==s.path.length||1!==s.path[0].length)?n=[{id:s.path[0][0],label:s.label?s.label[0][0]:void 0,serviceId:s.serviceId[0]}]:(n=void 0,f.setUsageTracker(this._widgetId,"NGF-Cmd_App_Selection",this._getAppId()))}return a&&(i={roots:n,path:s.path,label:s.label,serviceId:s.serviceId}),f.setPerformanceTracker(this._widgetId,"NGF-Cmd_App_Selection","NGFilter_Cmd",{RootsSelection_duration:t,Selection_duration:r},1),i},_setSelectionAndUpdateFilter:function(e){var t=this;if(t._SelectedID=void 0,e.roots||e.path)if(e.roots&&e.roots.length){var i=e.roots[0];t._SelectedID=i.id;var n=i.serviceId,o=function(e){t._setFocusToWidget(),t._updateFilterPanel(e)};i.revision?t._rootsInSession[t._SelectedID]=i.revision||"":i.revision=t._rootsInSession[t._SelectedID]||"",i.revision?o(e):t._retrieveRevision([{rootId:t._SelectedID,serviceId:n}]).then(function(n){i.revision=n[i.id]||"",t._rootsInSession[t._SelectedID]=i.revision,o(e)},function(n){i.revision="",t._rootsInSession[t._SelectedID]=i.revision,o(e)})}else if(e.path&&e.path.length){n=e.serviceId[0];var r=f.getDisplaySeparator(),l=e.revision&&e.revision.length;if(e.label&&e.label.length&&l)e.NGFUXId=t._NGFUXId,a.publish("NGFilter.OccPath",e);else{var d=[];e.path.forEach(e=>{d=d.concat(e)}),d=[...new Set(d)];var c=[];d.forEach(e=>{c.push({rootId:e,serviceId:n})});var h=I.getOption("displayRoot_AttributesTitle")||["ds6w:label","ds6wg:revision"],g=h.indexOf("ds6wg:revision");-1===g&&h.push("ds6wg:revision"),m.getPredicatesInfosFromIds(c,h,!0).then(function(i){i.length;var n=[],o=[];e.path.forEach(e=>{var t=[],s=[];e.forEach(e=>{var n=i.find(t=>e===t.id);if(n){var o=[];if(h.forEach(e=>{var t=n.predicates.find(function(t){return e===t.name});t&&o.push(t.dispValue||t.value)}),t.push(o.join(r)),-1===g){var a=n.predicates.find(function(e){return"ds6wg:revision"===e.name});s.push(a?a.value:"")}}}),n.push(t.length?t[t.length-1]:""),o.push(s.length?s[s.length-1]:"")}),e.label=n,e.revision=o,e.NGFUXId=t._NGFUXId,a.publish("NGFilter.OccPath",e)},function(e){s.error("Advanced Filter: Error to retrieve labels on selected path !")})}}},_updateFilterPanel:function(e){var t=e.roots[0];if(this._SelectedID=t.id,this._NGFUXId&&this._widgetId){var i=sessionStorage.getItem("NGFilter_AppQueryParam_"+this._NGFUXId+"_"+this._widgetId);i=i?JSON.parse(i):{};var n={appId:this._NGFUXId,widgetId:this._widgetId,rootID:this._SelectedID,rootAlias:t.label,cmdArgs:this.cmdArgs,configUsed:this._isConfigAvailable,widgetTenant:this._tenantId,appQueryParam:i,referenceTime:Date.now(),NGFUXId:this._NGFUXId,rootRevision:t.revision,securityContext:this._defaultSC,queryFormat:this._queryFormat,rootServiceId:t.serviceId};a.publish("Frame3DXInfra.Update",{type:"Filter",options:n})}},_getTenantId:function(){var e="OnPremise";return this._widget&&(e=this._widget.getValue("x3dPlatformId")||e),e},_getAppId:function(){return this._widget&&this._widget.getValue("x3dAppId")||""},_openFilterPanel:function(){a.publish("Frame3DXInfra.Open",{identifier:"Filter_"+this._NGFUXId+"_"+this._widgetId+"_"+this._SelectedID})},_displayAndSelectRoot:function(e,t){var i=Date.now(),n=this._buildRootTiles(e);this._displayInternalDurationTrace("displayAndSelectRoot / buildRootTiles, ",Date.now()-i);var o=new h({identifier:"NGF_RootsToFilter"});o.inject(document.body);var s=this,r=new g({domId:"NGF_RootsToFilter",immersiveFrame:o,width:490,height:270,title:c.get("RootsToFilter"),content:n,modalFlag:!0,resizableFlag:!0,closeButtonFlag:!1,buttons:{Ok:new _({emphasize:"secondary",disabled:!0,onClick:s._onOKDialog.bind(s)}),Close:new _({onClick:s._onCloseDialog.bind(s)})}});if(n.onSelectionAdd(function(e){s._selectedTile=e.options.rootToFilter,r.buttons.Ok.disabled=!s._selectedTile}),n.onSelectionRemove(function(e){0===n.getTreeDocument().getSelectedNodes().length&&(r.buttons.Ok.disabled=!0)}),n.onReady(function(e){s._displayInternalDurationTrace("displayAndSelectRoot / rootTiles.onReady, ",Date.now()-i),s._rootToSelect&&n.selectNodeModel(s._rootToSelect),s._displayInternalDurationTrace("displayAndSelectRoot / rootTiles.onReady.selectNodeModel, ",Date.now()-i)}),t&&1===t.length){var a=t[0]&&t[0].length?t[0][0]:"";if(a.length){var l=n.getTreeDocument().getChildren();this._rootToSelect=l.find(e=>a===e.options.rootToFilter.id)}}},_onOKDialog:function(e){var t={roots:[this._selectedTile],path:[[this._selectedTile.id]],label:[[this._selectedTile.label]]};this._setSelectionAndUpdateFilter(t),this._openFilterPanel(),e.dsModel.dialog.close()},_onCloseDialog:function(e){this._selectedTile=void 0,e.dsModel.dialog.close(),a.publish("Frame3DXInfra.onPanelClose",{tag:"dataFilterPanelCtn"})},_buildRootTiles:function(e){for(var t=l.getWebappsAssetUrl("ENONextGenFilterCmd","icons/32/I_DefaultRootFilterThumbnail.png"),i=new p({shouldAcceptDrag:function(){return!1}}),n=e.length,o=0;o<n;o++){var s=new v({label:e[o].label,subLabel:e[o].values,thumbnail:e[o].thumbnail||t,icons:[e[o].icon],multipleTitleLineNumber:!1,emptyStatusbarVisibleFlag:!!e[o].filtered,statusbarIcons:e[o].filtered?["filter"]:[],rootToFilter:e[o],description:e[o].description});i.addChild(s)}var r=new u({model:i,useDragAndDrop:!1,selectionBehavior:{unselectAllOnEmptyArea:!0,toggle:!0,canMultiSelect:!1,canInteractiveMultiselectWithCheckboxClick:!1,enableShiftSelection:!1,enableFeedbackForActiveCell:!1}});return r.model=i,r},_onRemoveFilter:function(e){if(this._NGFUXId===e.NGFUXId&&e&&e.rootIds){var t=this;e.rootIds.forEach(e=>delete t._rootsInSession[e])}},_onFilterVolume:function(e){this._NGFUXId===e.NGFUXId&&(this._isVolumeBeingDefine=!!e.action)},_onVolumeDefined:function(e){this._NGFUXId===e.NGFUXId&&(this._isVolumeBeingDefine=!1)},_onVolumeCancelled:function(e){this._NGFUXId===e.NGFUXId&&(this._isVolumeBeingDefine=!1)},_displayInternalDurationTrace:function(e,t){f.isDebugActive("elapsedTime")&&console.log("=====> "+e+" / elapsed time (ms) = "+t)}})}),define("DS/ENONextGenFilterCmd/commands/ENOAdvancedFIlterCmdV2.js",["DS/ENONextGenFilterCmd/commands/ENONextGenFilterCmdEngine","UWA/Core","UWA/Class","DS/Logger/Logger"],function(e,t,i,n){"use strict";return i.extend({getAppParams:function(){n.error("Filter Command ......  The getAppParams() function is not implemented !");return{}},getSelectorManager:function(){n.error("Filter Command ......   The getSelectorManager() function is not implemented !")},getRoots:function(){},getSelection:function(){return{}},beginExecute:function(){if(!this._isCmdActivated&&(this._advFilter=new e({getSelectorManager:this.getSelectorManager.bind(this),getAppParams:this.getAppParams.bind(this),getRoots:this.getRoots.bind(this),getSelection:this.getSelection.bind(this)}),this._isCmdActivated=!0,this.getAppParams)){var t=this.getAppParams();this._appId=t.appId,this._widgetId=t.widgetId,this._NGFUXId=t.NGFUXId||this._appId}this._advFilter.execute()},getAvailability:function(){return this._isCmdActivated&&this._advFilterMgr?this._advFilterMgr.getCmdAvailability():0}})}),define("DS/ENONextGenFilterCmd/commands/ENONextGenFilterCmd",["DS/ENONextGenFilterCmd/commands/ENONextGenFilterCmdEngine","UWA/Core","DS/ApplicationFrame/Command","DS/Logger/Logger"],function(e,t,i,n){"use strict";return i.extend({getAppParams:function(){n.error("Filter Command ......  The getAppParams() function is not implemented !");return{}},getSelectorManager:function(){n.error("Filter Command ......   The getSelectorManager() function is not implemented !")},getRoots:function(){},getSelection:function(){return{}},init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!1});var t=[],i=[],n=arguments[0].arguments;if(Array.isArray(n)&&n.length)for(var o=n.length,s=0;s<o;s++)t.push(n[s].ID),i.push(n[s].Value);this.cmdArgs={id:t,values:i},this._isCmdActivated=!1},execute:function(){if(!this._isCmdActivated&&(this._advFilterMgr=new e({getSelectorManager:this.getSelectorManager.bind(this),getAppParams:this.getAppParams.bind(this),getRoots:this.getRoots.bind(this),getSelection:this.getSelection.bind(this)}),this._isCmdActivated=!0,this.getAppParams)){var t=this.getAppParams();this._appId=t.appId,this._widgetId=t.widgetId,this._NGFUXId=t.NGFUXId||this._appId}this._advFilterMgr.execute()},getAvailability:function(){return this._isCmdActivated&&this._advFilterMgr?this._advFilterMgr.getCmdAvailability():0}})});