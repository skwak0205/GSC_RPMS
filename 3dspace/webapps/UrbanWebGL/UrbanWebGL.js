define("DS/UrbanTool/Url",["DS/Visualization/ThreeJS_DS","UWA/Class"],function(t){"use strict";return UWA.Class.extend({init:function(t){if(this.arguments=new Array,this.options=new Array,-1!==location.href.indexOf("?")){this.url=t.substring(0,location.href.indexOf("?"));for(var e=t.substring(location.href.indexOf("?")+1).split("&"),i=0;i<e.length;i++){var n=null,s=e[i],r=!1;-1!==e[i].indexOf("=")&&(s=e[i].substring(0,e[i].indexOf("=")),n=e[i].substring(e[i].indexOf("=")+1));var o=s.split(".");if(o.length>1&&(r=!0),r)void 0===(a=this.arguments[o[0]])?(this.arguments[o[0]]={value:o[0],options:new Object},this.arguments[o[0]].options[o[1]]=n):Array.isArray(a)?a[a.length-1].options[o[1]]=n:this.arguments[o[0]].options[o[1]]=n;else if(s,void 0!==this.arguments[s]){var a=this.arguments[s];if(Array.isArray(a))a.push({value:n,options:new Object});else{var h=[];h.push(a),h.push({value:n,options:new Object}),this.arguments[s]=h}}else this.arguments[s]={value:n,options:new Object}}}else this.url=t;this.updateSlots=[]},getArgument:function(t){return this.arguments[t]},hasArgument:function(t){return void 0!==this.arguments[t]},setArgument:function(t,e){this.arguments[t]=e},removeArgument:function(t){delete this.arguments[t]},apply:function(t,e){var i=this.arguments[t];void 0!==i&&(Array.isArray(i)?i.map(e):e(i))},updateUrl:function(t){for(var e=0;e<this.updateSlots.length;e++)this.updateSlots[e](this);var i="",n=0,s=void 0,r=function(t){if(null!==t&&(void 0===t.value&&void 0!==t.options||(n>0&&(i+="&"),i+=s,void 0!==t.value?i+="="+t.value:void 0===t.options&&(i+="="+t),n++)),void 0!==t.options)for(var e in t.options)n>0&&(i+="&"),i+=s+"."+e+"="+t.options[e],n++};for(s in this.arguments)if(this.arguments.hasOwnProperty(s)){0===n&&(i+="?");var o=this.arguments[s];Array.isArray(o)?o.map(r):r(o)}window.history.replaceState("","UrbanWebGL",this.url+i)},getParameters:function(){for(var t=0;t<this.updateSlots.length;t++)this.updateSlots[t](this);var e={},i=void 0,n=function(t){if(void 0!==t.value?e[i]=t.value:void 0===t.options&&(e[i]=t),void 0!==t.options)for(var n in e[i]={},t.options)e[i][n]=t.options[n]};for(i in this.arguments)if(this.arguments.hasOwnProperty(i)){var s=this.arguments[i];Array.isArray(s)?s.map(n):n(s)}return e},setParameters:function(t){for(var e in t)if(t.hasOwnProperty(e)){var i=t[e];if(i instanceof Object)for(var n in this.arguments[e]={value:i.value,options:{}},i)"value"!==n&&(this.arguments[e].options[n]=i[n]);else this.arguments[e]={value:i}}return this}})}),define("DS/UrbanFeature/Annotation",["DS/XCityModel/Marker","DS/XCityModel/Item","DS/xCityBasicUtils/Utils"],function(t,e,i){"use strict";var n=t.extend({defaults:{classStyle:"annotation",listenToDateUpdate:!1,upTime:"",downTime:""},metaData:{type:"Marker",className:"Annotation"},create:function(t){this._parent(t),this.geometryMarker._markerContainer.addClassName(this.defaults.classStyle)},_initRenderingProfile:function(){this._parent(),this._rendering.defaultRendering.renderingData.style="annotationIconAdvanced",this._rendering.defaultRendering.renderingData.iconName="text"},addUserDataProperty:function(t,e){if(i.is(t)){var n=this.get("geojson");i.is(n)&&(n.features[0].properties||(n.features[0].properties={}),n.features[0].properties[t]=e);var s=this.get("userData");return s||(s={},this.set("userData",s)),s[t]=e,!0}return!1},removeUserDataProperty:function(t){if(i.is(t)){var e=this.get("geojson");i.is(e)&&i.is(e.features[0].properties[t])&&delete e.features[0].properties[t];var n=this.get("userData");return i.is(n[t])&&delete n[t],!0}return!1}});return e.ObjectContructor.Annotation=n}),define("DS/UrbanFeature/Bookmark",["DS/XCityModel/Item"],function(t){"use strict";var e=t.extend({defaults:{renderProfile:"",perfProfile:"",thumbnail:"",visibility:[]},metaData:{type:"Bookmark",className:"Bookmark"},setup:function(){this._parent()},_visible:function(t){var e=this.getRoot();if(void 0!==e&&this._itemParent.get("visible")){null!==this._itemParent.get("PointOfView")&&e._urban.getView3D().getControl().moveToFeature(this._itemParent);for(var i=this.get("visibility"),n=0;n<i.length;n++){var s=e.findChildById(i[n].id,!0);void 0!==s&&s.set("visible",i[n].visible)}}},getPointOfView:function(){return this.get("PointOfView")},setPointOfView:function(t){return this.set("PointOfView",t)},setItemParent:function(t){this._itemParent&&this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._parent(t),this._itemParent&&this._itemParent.addEvent("onChange:visible",this._visible,this)}});return t.ObjectContructor.Bookmark=e}),define("DS/UrbanCore/PerformanceProfile",["DS/XCityCore/ProfileManager","DS/XCityTools/EventDispatcher","DS/XCityCore/Profile","DS/xCityBasicUtils/Utils"],function(t,e,i,n){"use strict";return i.extend({init:function(t,e){this._parent(t,e)},fromJSON:function(t){for(var e in t)n.is("disabledEffects"===e)?this.setDisabledEffects(t[e]):this.getManager().acceptedValues[e].callback(this._urban,t[e])},addfunction:function(t,e,i){this.hasNodeName(e)?(this.setByName(t,i,e),this._enabled&&t(this._urban,i)):this.getManager().addProfile(this.getName(),t,i,e)},setValue:function(t,e){var i=Math.min(Math.max(e,this.getManager().acceptedValues[t].min),this.getManager().acceptedValues[t].max);this.addfunction(this.getManager().acceptedValues[t].callback,t,i)},getValue:function(t){return this.getNode(t)},getDisabledEffects:function(){return this.getNode("disableEffects")},setDisabledEffects:function(t){var e=t.slice();this.addfunction(function(t,e){t.getEnvironment().disableEffects(e)},"disableEffects",e)},getManager:function(){return this._urban.getPerformanceProfileManager()},renameProfile:function(t,i){this._parent(t,i)&&e.publish(e.eventsList.performanceProfile,i)},_getInputProfile:function(){var t=this._parent(),e=this.getDisabledEffects();for(var i in n.is(e)&&(t.disabledEffects=e),this.getManager().acceptedValues){var s=this.getNode(i);n.is(s)&&(t[i]=s)}return t},clean:function(){this.setDisabledEffects([]);var t=this.getManager();for(var e in t.acceptedValues)n.is(this[e])&&(this[e]=t.acceptedValues[e].defaultValue)}})}),define("DS/UrbanTool/FocusManager",["DS/XCityTools/EventDispatcher"],function(t){"use strict";var e=null;function i(){if(null!==e)throw new Error("Cannot instantiate more than one MySingleton, use MySingleton.getInstance()");this.initialize()}var n=function(t){e.hasFocus=!0,e.renderer&&e.renderer.allowRendering(!0)},s=function(t){t.target==window&&(document.hasFocus()||top.document.hasFocus()||(e.hasFocus=!1,e.renderer&&e.renderer.allowRendering(!1)))},r=function(t){var i="visible"==document.visibilityState;e.hasFocus=i,e.renderer&&e.renderer.allowRendering(i)},o=function(){e.renderer&&e.renderer.render()};return i.getInstance=function(){return null===e&&(e=new i),e},i.prototype={initialize:function(){this.hasFocus=!0,this._enabled=!1},setRenderer:function(t){this.renderer=t},activate:function(){this._enabled=!0,window.addEventListener("focus",n),window.addEventListener("blur",s),window.addEventListener("visibilitychange",r),window.addEventListener("resize",o),t.publish(t.eventsList.focusManager,!0)},deactivate:function(){this._enabled=!1,window.removeEventListener("focus",n),window.removeEventListener("blur",s),window.removeEventListener("visibilitychange",r),window.removeEventListener("resize",o),this.hasFocus=!0,this.renderer&&this.renderer.allowRendering(!0),t.publish(t.eventsList.focusManager,!1)},enabled:function(){return this._enabled}},i.getInstance()}),define("DS/UrbanTool/SplashScreen",["UWA/Core","UWA/Class","UWA/Class/Events","DS/WebappsUtils/WebappsUtils","DS/xCityBasicUtils/Utils","DS/UIKIT/Mask","css!DS/UIKIT/UIKIT.css"],function(t,e,i,n,s,r){"use strict";var o=null,a=e.extend(i,{init:function(){this._counter=0,this._ready=!0,this.start()},start:function(){if(this._ready){if(this._ready=!1,this._counter=1,s.is(widget)&&s.is(widget.body)&&s.is(widget.body.hasClassName))return r.mask(widget.body),void widget.body.getElement(".mask").setStyle("z-index","100000");var t=setInterval(function(){s.is(widget)&&s.is(widget.body)&&s.is(widget.body.hasClassName)&&(clearInterval(t),r.mask(widget.body),widget.body.getElement(".mask").setStyle("z-index","100000"))},100)}},end:function(){s.is(widget)&&s.is(widget.body)&&r.unmask(widget.body),this.dispatchEvent("onPageReady",!0),this._ready=!0},loading:function(){0===this._counter?this.start():this._counter++},ready:function(){this._counter--,this._counter<0&&(this._counter=0),0===this._counter&&this.end()},isReady:function(){return this._ready}});return a.getInstance=function(){return null===o&&(o=new a),o},a.getInstance()}),define("DS/UrbanFeature/PointOfInterest3D",["DS/XCityModel/Location","DS/XCityModel/Item","DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PointOfInterest3DSet","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityTools/Debug","DS/XCityRendering/RenderingHandlerPOI3D","DS/XCityRendering/RenderingHandlerPOI3DBillboard","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher"],function(t,e,i,n,s,r,o,a,h,l,d){"use strict";var u=t.extend({defaults:{styleClass:"",shapeType:"pyramid",nbVertices:3,shadingMode:"flat",_renderMode:"occluded",renderType:"icon",opacityFactor:.5,altitude:0,height:0,switchDistance:0,samplingFactor:1,renderAnchor:!1,anchorLineWidth:1,scale:1,orientation:0,renderID:"",Rendering:null},metaData:{type:"Location",className:"PointOfInterest3D"},setup:function(){this._parent(),this._poi=void 0,this._scaleZ=!0,this._node=new s,this._node.name="poi3DFeature"},destroy:function(t){t.getNode3D().remove(this._node),this._parent(t)},create:function(t){var e;if(!this._parent(t))return d.publish(d.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;t.getNode3D().add(this._node),this.urban=t._urban,this.renderingProfileManager=this.urban.getRenderingProfileManager(),this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,e="billboard"===this.get("shapeType")?new h(this.urban,this._attributes):new a(this.urban,this._attributes),this._rendering=e;var s={shapeType:this.get("shapeType"),shadingMode:this.get("shadingMode"),renderType:this.get("renderType"),renderMode:this.get("renderMode"),samplingFactor:this.get("samplingFactor"),opacityFactor:this.get("opacityFactor"),switchDistance:this.get("switchDistance"),renderAnchor:this.get("renderAnchor"),anchorLineWidth:this.get("anchorLineWidth"),nbVertices:this.get("nbVertices"),isSingleFeature:!0,rendering:this._rendering};this.renderingProfileManager.initRendering(this);var l=this.get("scale");"number"==typeof l&&(l=new i.Vector3(l,l,l));var u={color:new i.Color,name:this._itemParent.get("name"),strid:this._itemParent.get("id"),styleClass:this.get("styleClass"),altitude:this.get("altitude"),height:this.get("height"),opacity:1,localScale:[l.x,l.y,l.z],orientation:[this.get("orientation")]},c=this.getLocalPosition(),g=function(){this.poiSet=new n(this.urban,s,{posTile:new i.Vector2(0,0),tile:{LOD:0,I:0,J:0}}),this.poiSet.addPointOfInterest(new i.Vector3,u),this._poi=this.poiSet.getMesh();var t=(new i.Matrix4).identity().setPosition(new i.Vector3(c.x,c.y,0));this._node.setMatrix(t),this._node.addChild(this._poi),this._node.userData=this._itemParent,this._poi.children[0].isInstanceNode3D&&(this._node.instanceId=5),this._setVisible(this._itemParent)}.bind(this);if(this._isReady=!1,void 0!==s.shapeType){var m=s.shapeType.toLowerCase();"billboard"===m||"disc"===m||"sphere"===m||"tube"===m||"pyramid"===m?(s.shapeType=m,g(),d.publish(d.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})):this.urban.USR.hwInstancing?(s._posSize={},this.urban.modelLoader.load({url:s.shapeType},function(t,e,i){s._posSize.center=t.bSphere.center.clone(),s._posSize.radius=t.bSphere.radius,s._posSize.altitude=t.bBox.min.z,s._posSize.height=t.bBox.max.z-t.bBox.min.z,s._posSize.width=t.bBox.max.y-t.bBox.min.y,s._posSize.length=t.bBox.max.x-t.bBox.min.x,t.traverse(function(t){t instanceof r&&(s.modelMesh3d=t,g())}.bind(this)),d.publish(d.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})}.bind(this))):(o.warn("Unable to load the model or hw instancing is not activated..."),d.publish(d.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}))}return!0},getRendering:function(){return this._rendering},redraw:function(){var t=this.getRendering();l.is(t)&&(t._needRebuild&&this._node.children.length>0&&(this._node.removeChildren(),this.create(this.getRoot())),t.applyRendering(this._poi))},setItemParent:function(t){this._itemParent&&(this._itemParent.removeEvent("onChange:name",this._updateName),this._itemParent.removeEvent("onChange:selected",this._select),this._itemParent.removeEvent("onChange:visible",this._setVisible)),this._itemParent=t,t&&(this._itemParent.addEvent("onChange:name",this._updateName,this),this._itemParent.addEvent("onChange:selected",this._select,this),this._itemParent.addEvent("onChange:visible",this._setVisible,this))},_updatePosition:function(){this._parent();var t=this.getLocalPosition();if(this._poi){var e=(new i.Matrix4).identity().setPosition(new i.Vector3(t.x,t.y,t.z));this._poi.setMatrix(e)}},_updateName:function(){},_setVisible:function(t){var e=!!t.get("visible");this._poi&&(e?this._node.addChild(this._poi):this._node.removeChild(this._poi))},_select:function(t){var e;if(this._poi)if(t.get("selected")){var s={styleClass:this.get("styleClass"),pClass:"poiText",samplingFactor:this.get("samplingFactor")};(e=n.generateTextNode(this.urban,this._itemParent.get("name"),s))._excludeFromCSO=!0,e._excludeFromHSO=!0,e._excludeFromHL=!0,e._excludeFromPSO=!0,e._excludeFromPreHL=!0;var r=t.getContent().get("position");e.setMatrix((new i.Matrix4).translate(new i.Vector3(r.x,r.y,r.z))),this._node.addChild(e)}else(e=this._node.getChildByName("text"))&&this._node.removeChild(e)},get:function(t){var e,i,n=this.getRendering();return this.renderingProfileManager&&l.is(n)&&n.hasAttribute(t)?(i=this.getMaterial(),l.is(i)&&(e=i[t])):e=this._parent(t),e},set:function(t,e){var i={},n=this.getRendering();this.renderingProfileManager&&l.is(n)&&n.hasAttribute(t)?(i[t]=e,this.setMaterial(i)):this._parent(t,e)},setMaterial:function(t){return this.renderingProfileManager.addRendering(this.parentFeatureID,t),this},getMaterial:function(){var t=this.getRendering();return l.is(t)?t.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},getBoundingSphere:function(){if(this._localPosition&&this._node){var t=this.poiSet.minMaxOrig,e=this._localPosition;e.z=this._node.bSphere.center.z;var n=Math.sqrt(Math.pow(t.maxX-t.minX,2)+Math.pow(t.maxY-t.minY,2)+Math.pow(t.maxZ-t.minZ,2))/2;return new i.Sphere(e,n)}},addUserDataProperty:function(t,e,i){if(l.is(t)){var n=this.get("geojson"),s=n.features[0];if(l.is(i))for(var r=0;r<n.features.length;r++){var o=n.features[r];if(o&&o.properties&&o.properties.STRID===i){s=o;break}}s.properties||(s.properties={}),s.properties[t]=e;var a=this.get("userData");return a||(a={},this.set("userData",a)),a[t]=e,!0}return!1},removeUserDataProperty:function(t,e){if(l.is(t)){var i=this.get("geojson"),n=i.features[0];if(l.is(e))for(var s=0;s<i.features.length;s++){var r=i.features[s];if(r&&r.properties&&r.properties.STRID===e){n=r;break}}l.is(n.properties[t])&&delete n.properties[t];var o=this.get("userData");return l.is(o[t])&&delete o[t],!0}return!1}});return e.ObjectContructor.PointOfInterest3D=u}),define("DS/UrbanManipulator/CityRobot",["DS/Robot/FreeRobot","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/xCityBasicUtils/Utils"],function(t,e,i,n){"use strict";return t.extend({init:function(t,e,i,n,s){this._parent(t,e,i,n,s),this.setDisplayScalingNodes(!1),this.setDisplayTiltingArcAndPlanesNodes(!1)},setCityFeature:function(t){this._cityfeature=t;var e=t;t.impl&&(e=t.impl),this._citycontent=e.getContent()},setPickingMethod:function(t){this._picking=t},setDisplayTiltingArcAndPlanesNodes:function(t){this.rotationArcYZ.setVisibility(!!t),this.rotationArcXZ.setVisibility(!!t),this.translationPlaneYZ.setVisibility(!!t),this.translationPlaneXZ.setVisibility(!!t)},setDisplayBaseRotation:function(t){this.rotationArcXY.setVisibility(!!t),this.translationPlaneXY.setVisibility(!!t)},showcontent:function(t){if(this._citycontent){var e=this._citycontent._node;if(e.children.length>0&&(e=e.children[0]).children.length>0){e=e.children[0];for(var i=0;i<Math.round(e.children.length);i++){e.children[i].setVisibility(t)}}return this.waspickable=!0,!0}return!1},showmost:function(t){this.robotHandle.setVisibility(!!t)},ScreenPlaneTranslationBeginCB:function(t){this.target&&(this.setManipulated(!0),this.initialMatrix=(new e.Matrix4).copy(this.getMatrix()),this.initialTargetWorldMatrix=(new e.Matrix4).copy(this.target.getWorldMatrix(t.viewer)),this.showOnlyManipulated&&this.setToGhostState(),this._citycontent&&(this.showcontent(!1),this.robotwaspickable=this.visible,this.showmost(!1),this.initialPositionPicked=this._picking(t.event.from[0].currentPosition)),t.viewer.render()),this._modelEvent.publish({event:"ScreenPlaneTranslationBegin",data:{eventChannel:"ScreenPlaneTranslationBegin",target:this.target,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})},ScreenPlaneTranslationManipulationCB:function(t){if(this.target){var i=t.paths[0].externalPath;if(this.contains(this,i)){var n=new e.Vector3,s=this._picking(t.event.from[0].currentPosition);s&&this.initialPositionPicked&&(t.translationVector=s.sub(this.initialPositionPicked)),n.getPositionFromMatrix(this.initialMatrix),n.add(t.translationVector);var r=(new e.Matrix4).copy(this.getMatrix());this.setMatrix(r.setPosition(n)),this.updateCenterPosition(n)}var o=new e.Vector3;o.getPositionFromMatrix(this.initialTargetWorldMatrix),o.add(t.translationVector);var a=(new e.Matrix4).copy(this.initialTargetWorldMatrix).setPosition(o);if(this.sceneGraphState&&"OCCURRENCE_secret"===this.mode)this.sceneGraphState.applyAbsolutePositionToPath(this.target,a);else if("NODE"===this.mode){var h,l=this.target.externalPath,d=this.target.getParentPath();h=d?d.getWorldMatrix(t.viewer):new e.Matrix4;var u=new e.Matrix4;u.getInverse(h);var c=u.multiply(a);l[l.length-1].setMatrix(c)}t.viewer.render()}this._modelEvent.publish({event:"ScreenPlaneTranslationManipulation",data:{eventChannel:"ScreenPlaneTranslationManipulation",target:this.target,translationVector:t.translationVector,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})},ScreenPlaneTranslationEndCB:function(t){this.target&&(this.setManipulated(!1),this.showOnlyManipulated&&this.setToNonGhostState(),this._citycontent&&(this.waspickable&&(this.showcontent(!0),this.waspickable=null),this.robotwaspickable&&(this.showmost(!0),this.robotwaspickable=null),this.initialPositionPicked=null),t.viewer.render(),this.endCenterClick=Date.now()),this._modelEvent.publish({event:"ScreenPlaneTranslationEnd",data:{eventChannel:"ScreenPlaneTranslationEnd",target:this.target,intersection:t.intersection,manipulator:t.manipulator,event:t.event}})}})}),define("DS/UrbanTool/Utils",["UWA/Data","DS/WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/XCityTools/Debug","DS/XCityTools/Downloader"],function(t,e,i,n,s,r,o){"use strict";var a=null;function h(){if(null!==a)throw new Error("Cannot instantiate more than one MySingleton, use MySingleton.getInstance()");this.initialize()}return h.getInstance=function(){return null===a&&(a=new h),a},h.prototype={initialize:function(){window.Utils=this,this.nbImages=10,this.conccurentTextureLoading=0,this.images=new Array(this.nbImages),this.current=0;for(var t=0;t<this.nbImages;t++)this.images[t]=new Image;this.refX=new i.Vector3(0,0,-1),this.refY=new i.Vector3(-1,0,0),this.refZ=new i.Vector3(0,1,0),this.right=new i.Vector3(-1,0,0),this.zero=new i.Vector3,this.zeroQuat=new i.Quaternion,this.vertical=new i.Vector3(0,0,1),this.north=new i.Vector3(0,1,0)},loadTextureOld:function(t,e,i,n){o.download(i,{image:!0},void 0!==n?n:1,function(t,e,i,n){n(e,t,i)},void 0,e)},loadTextureCube:function(t,e,i){o.download(i,{image:!0},1,function(t,e,i,n){n(e,t,i)},void 0,e)},_downloadOrderedTree:function(t,e,i,n,s){var a=this,h=!1,l=void 0;void 0===s?(h=!0,l={all:t.length,current:0,success:0},s={}):(l=s.state).all+=t.length;var d=new Array(t.length);s.result=d;var u=function(){if(l.current===l.all){var t=[],e=function(t,i){for(var n=0;n<t.result.length;n++)t.result[n]&&(t.result[n].link&&e(t.result[n],i),i.push(t.result[n].data))};e(s,t),i&&i(t)}},c=function(t,n,s,r){if(l.current++,e){var o=e(t,n);o&&(d[s]=o,o.state=l,o.link&&a._downloadOrderedTree(o.link,e,h?u:i,r,o))}h?u():i()};!function(t){for(var e=function(e,i,n,s){var r;e&&(d[s]=i,r=t[s].url.slice(0,t[s].url.lastIndexOf("/"))+"/",l.success++),c(i,e,s,r)},i=0;i<t.length;i++){var s=t[i].url;s?("http"!==s.substring(0,4)&&n&&(t[i].url=n+s),r.log("Load: ",n,s),o.download(t[i].url,{},1,e,void 0,i)):(d[i]=t[i],l.success++,c(t[i],void 0,i,n))}}(t)},downloadOrderedTree:function(t,e,i,n){this._downloadOrderedTree(t,e,i,n)},download:function(t,e,i,n,s){o.download(n,{responseType:t},void 0!==s?s:1,function(t,e,i,n){n(e,t,i)},void 0,i)},template:function(t){var e=new RegExp("(<%)[^]+?($|%>)","g"),i=new RegExp("(<=)[^]+?($|(=>))","g"),n="var _html = '";n='var _html = "'+(n=(n=(t=t.toString()).replace(i,function(t){return'"+\n'+t.replace("<=","").replace("=>","")+' +\n"'})).replace(e,function(t){return'";\n'+t.replace("<%","").replace("%>","")+'\n _html +="'})+'"\n return _html;');var s=void 0;try{s=new Function("attr",n)}catch(t){throw t.code=n,t}return s},toDeg:function(t){return 57.29577951308232*t},toRad:function(t){return.017453292519943295*t},mercatorPosFromQuad:function(t,e,n,s){var r=t.worldSize*(e.X+n*e.Size)-t.halfWorldSize,o=t.worldSize*(e.Y+s*e.Size)-t.halfWorldSize;return new i.Vector2(r,o)},latlonFromQuad:function(t,e,i,n){t.worldSize,e.X,e.Size,t.halfWorldSize,t.worldSize,e.Y,e.Size,t.halfWorldSize},getColorGradient:function(t,e){var n,s,r,o,a,h=void 0===e.min?0:e.min,l=void 0===e.max?1:e.max;t=Math.max(0,Math.min((t-h)/l,1));var d=void 0===e.minHue?0:e.minHue,u=void 0===e.maxHue?360:e.maxHue,c=void 0===e.sat?1:e.sat,g=(t*(u-d)+d)/360;function m(t,e,i){return i<0?i++:i>1&&i--,(i=255*(i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t)|0)?(i=i.toString(16)).length>1?i:"0"+i:"00"}return 0===c?n=s=r=(t=127)?(t=t.toString(16)).length>1?t:"0"+t:"00":(n=m(o=1-(a=.5+c-.5*c),a,g+1/3),s=m(o,a,g),r=m(o,a,g-1/3)),new i.Color("#"+n+s+r)},toColor:function(t,e,i,n){return this.getColorGradient(t,{minHue:e,maxHue:i,sat:n}).getHex()},transitionEndEventName:function(){var t,e={transition:"transitionend",OTransition:"otransitionend",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(t in e)if(void 0!==e.hasOwnProperty(t))return e[t]},is:function(t){return UWA.is(t)},cleandot:function(t,e){var i=t.clone().dot(e);return i=Math.max(i,-1),i=Math.min(1,i)},displayVector:function(t){if(!this.is(t))return null;var e=" x: "+t.x.toFixed(3)+" y: "+t.y.toFixed(3);return this.is(t.z)&&(e+=" z: "+t.z.toFixed(3)),this.is(t.w)&&(e+=" w: "+t.w.toFixed(3))," "+e+" "},displayMatrix:function(t){if(!this.is(t)||!this.is(t.elements))return null;var e=new i.Vector4(t.elements[12],t.elements[13],t.elements[14],t.elements[15]);return" "+this.displayVector(e)+" "},getAngleBetween:function(t,e){if(this.is(this.zero)||(this.zero=new i.Vector3),t.equals(this.zero)||e.equals(this.zero))return null;var n=this.cleandot(t.normalize(),e.normalize());return Math.acos(n)},endsWith:function(t,e){return-1!==t.indexOf(e,t.length-e.length)},dataURItoBlob:function(t){for(var e=t.split(",")[0].split(":")[1].split(";")[0],i=atob(t.split(",")[1]),n=new Uint8Array(i.length),s=0;s<i.length;s++)n[s]=i.charCodeAt(s);return new Blob([n.buffer],{type:e})},getQuaternionBetween:function(t,e){var n=new i.Quaternion,s=this.getAngleBetween(t,e);if(0===s)return n;var r=t.normalize().clone().cross(e.normalize()).normalize();if(r.equals(this.zero))return null;n.setFromAxisAngle(r,s),n.normalize();var o=t.clone().normalize().applyQuaternion(n).normalize(),a=e.clone().normalize();return o.equals(a),n},getNorthAngle:function(t,e){var i=t.clone().add(e);i.z=0,i.normalize();var n=i.x<0?1:-1,s=this.cleandot(i,this.north);return Math.acos(s)*n},getQuaternion:function(t,e){var i=t.clone(),n=t.clone().multiplyScalar(2);return this.getQuaternion2(i,n,e)},equals:function(t,e){var n=Number(t.x.toFixed(4)),s=Number(t.y.toFixed(4)),r=Number(t.y.toFixed(4));if(this.is(t.w))var o=Number(t.w.toFixed(4)),a=new i.Quaternion(n,s,r,o);else a=new i.Vector3(n,s,r);n=Number(e.x.toFixed(4)),s=Number(e.y.toFixed(4)),r=Number(e.y.toFixed(4));if(this.is(e.w)){o=Number(e.w.toFixed(4));var h=new i.Quaternion(n,s,r,o)}else h=new i.Vector3(n,s,r);return a.equals(h)},quatFromAngles:function(t,e,n){var s=new i.Vector3(0,0,-1),r=new i.Vector3(1,0,0),o=new i.Vector3(0,-1,0),a=new i.Quaternion,h=new i.Quaternion,l=new i.Quaternion;a.setFromAxisAngle(s,t),h.setFromAxisAngle(r,e),l.setFromAxisAngle(o,n);var d=a.multiply(h);return d=d.multiply(l)},getQuaternionFromEye:function(t){if(t.normalize(),t.equals(this.refX))return new i.Quaternion;var e=this.getNorthAngle(t,new i.Vector3),n=new i.Quaternion;n.setFromAxisAngle(this.vertical,e);var s=this.refX.clone().applyQuaternion(n),r=this.getQuaternionBetween(s,t);r.multiply(n),s=this.refX.clone().applyQuaternion(r);this.refZ.clone().applyQuaternion(r);return r},getQuaternion2:function(t,e,n){var s=new i.Matrix4;s.lookAt(t,e,n);var r=new i.Quaternion;return r.setFromRotationMatrix(s),r},getUpFromCameraEye:function(t){var e=t.clone().normalize(),n=e.clone();if(n.z=0,0!==e.x||0!==e.y){n.normalize();var s=new i.Quaternion;return s.setFromAxisAngle(this.vertical,.5*-Math.PI),(n=n.applyQuaternion(s)).normalize(),n.cross(e).normalize()}return this.refZ.clone()},isOut:function(t,e){if(!this.is(t))return!0;var i=t.clone().sub(e.shiftedPosition),n=i.length();if(i.x>e.worldSize)return!0;if(e.sphericalMode){if(i.length()>1.1*e.earthRadius)return!0}else{if(i.x<0)return!0;if(i.y>e.worldSize)return!0;if(i.y<0)return!0;if(n>2*e.worldSize)return!0}return!1},clone:function(t){return JSON.parse(JSON.stringify(t))},toDownloadFile:function(t,e){var i="downloadFile",n=document.getElementById(i);this.is(n)?URL.revokeObjectURL(n.href):((n=document.createElement("a")).id=i,n.innerHTML="Download File",document.body.appendChild(n)),n.href=window.URL.createObjectURL(e),n.download=t,n.style.display="none",n.click()},areSamePosition:function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z},offsetVerticesXY:function(t,e){var n=[];n.push(new i.Vector3(t[0].x-e.x,t[0].y-e.y,t[0].z));for(var s=t.length-1;s>=0;s--)n.push(new i.Vector3(t[s].x-e.x,t[s].y-e.y,t[s].z));return n},getBuildingGISPropertiesMap:function(){return{floors:"floorsNumber",height:"HEIGHT",altitude:"ALTITUDE",floorHeight:"floorHeight",groundFloorHeight:"groundFloorHeight",roofShape:"roofShape",roofHeight:"ROOFHGT",roofAngle:"ROOFANGLE"}}},h.getInstance()}),define("DS/UrbanCore/DateTime",["UWA/Class","UWA/Class/Events","DS/XCityTools/Geocoder","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher"],function(t,e,i,n,s,r){"use strict";return UWA.Class.extend(e,{init:function(t){this.urban=t;var e=new Date;this._date=new Date(e.getFullYear(),5,21,12,0,0,0),t.url.updateSlots.push(this.updateUrl.bind(this)),this.initByUrl(),this._initDate=!1,this._implicitShiftEnabled=!0,r.subscribeTo(r.eventsList.config,this.setup.bind(this)),r.publish(r.eventsList.date,this)},reset:function(){var t=new Date;this._initDate=!1,this._implicitShiftEnabled=!0,this._offsetPos=null,this.setDate(new Date(t.getFullYear(),5,21,12,0,0,0))},setup:function(){this._initDate=!0},initByUrl:function(){var t=this.urban.url.getArgument("date");if(void 0!==t){var e=t.value.split(","),i=" "+e[0]+"/"+e[1]+"/"+e[2]+" "+e[3]+":"+e[4]+":"+e[5]+" UTC",n=new Date(i);this.setDate(n)}},setFromConfig:function(t){if(s.is(t)){var e=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*))(?:Z|(\+|-)([\d|:]*))?$/,i=/^\/Date\((d|-|.*)\)[\/|\\]$/,n=JSON.parse(JSON.stringify(t),function(t,n){if("string"==typeof n){var s=e.exec(n);if(s)return new Date(n);if(s=i.exec(n)){var r=s[1].split(/[-+,.]/);return new Date(r[0]?+r[0]:0-+r[1])}}return n});this.setDate(n)}},updateUrl:function(t){t.setArgument("date",this._date.getUTCFullYear()+","+(this._date.getUTCMonth()+1)+","+this._date.getUTCDate()+","+this._date.getUTCHours()+","+this._date.getMinutes()+","+this._date.getSeconds())},setTime:function(t,e,i){return this._date.getHours()===t&&this._date.getMinutes()===e||(this._date.setHours(t),this._date.setMinutes(e),n.log(this._date.toUTCString()),r.publish(r.eventsList.date,this)),this},setLocalTime:function(t,e,n){var s=(new Date).getTimezoneOffset(),o=this.urban.USR.viewpoint.getPosition(),a=i.proj([o.x,o.y],i.getDefaultProjection(),"WGS84");t=Math.floor(a.x/15)-s,this._date.getUTCHours()===t&&this._date.getMinutes()===e||(this._date.setUTCHours(t),this._date.setMinutes(e),r.publish(r.eventsList.date,this))},keepLocalTime:function(){if(this._initDate&&this._implicitShiftEnabled){var t=this.urban.getViewpoint().getPosition();this.urban.baseReferential&&this.urban.baseReferential.bbox&&(t.x<this.urban.baseReferential.bbox.xmin&&(t.x=this.urban.baseReferential.bbox.xmin),t.x>this.urban.baseReferential.bbox.xmax&&(t.x=this.urban.baseReferential.bbox.xmax),t.y<this.urban.baseReferential.bbox.ymin&&(t.y=this.urban.baseReferential.bbox.ymin),t.y>this.urban.baseReferential.bbox.ymax&&(t.y=this.urban.baseReferential.bbox.ymax));var e=i.proj([t.x,t.y],i.getDefaultProjection(),"WGS84");if(s.is(this._offsetPos)){var n=Math.floor(-e.x/15)-this._offsetPos;if(0!==n){this._offsetPos+=n;this._date.getUTCHours()}}else{var r=this.urban.getViewpoint().getInitialPosition(),o=i.proj([r.x,r.y],i.getDefaultProjection(),"WGS84");this._offsetPos=Math.floor(-o.x/15)}}},getDate:function(){return this.urban.localTime?this._localDate:this._date},setDate:function(t,e){if(s.is(t)&&(t instanceof Date||(t=new Date(t)),this._date.getTime()!==t.getTime())){if(e){var i=this._date.getHours();this._date=new Date(t),this._date.setHours(i)}else this._date=new Date(t);r.publish(r.eventsList.date,this)}},enableImplicitShift:function(t){this._implicitShiftEnabled=t},isImplicitShiftenabled:function(){return this._implicitShiftEnabled}})}),define("DS/UrbanManipulator/ManipulatorParams",["UWA/Class"],function(t){"use strict";return t.extend({init:function(t){var e;for(e in this.resetDefaultValue(),t)t.hasOwnProperty(e)&&(this[e]=t[e])},resetDefaultValue:function(){this.STATE={NONE:-1,ROTATE:2,ZOOM:-2,PAN:0,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5,TOUCH_TILT:6,KEYBOARD_PAN:7,KEYBOARD_ROTATE:8,KEYBOARD_ZOOM:9},this.Keys={PAN_LEFT:37,PAN_RIGHT:39,PAN_FRONT:38,PAN_BACK:40,ROTATE_LEFT:100,ROTATE_RIGHT:102,ROTATE_DOWN:98,ROTATE_UP:104,ZOOM_IN:107,ZOOM_OUT:109,RESET:32,KEYFRAME:75,PLAY:80},this.keysSpeed=.1,this.moveDuration2=1,this.moveDuration=7,this.moveToTarget=!0,this.minHeight=1.5,this.rotateSpeed=.7,this.zoomSpeed=2,this.panSpeed=1,this.touchZoom=2,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noAnimation=!1,this.focusTime=10,this.dynamicDampingFactor=.15,this.dampingTime=1,this.targetDisplay=!0,this.altMax=57403233,this.pickingAltitude=0,this.exactAltitude=2*this.altMax,this.groundModeAltitude=1.8,this.manipTransitionDuration=2,this.defaultDistance=75,this.northMoveDuration=1,this.guiPanFactor=1,this.guiPanHoldFactor=.3,this.guiRotateFactor=2,this.guiRotateHoldFactor=.2,this.guiZoomFactor=4,this.guiZoomHoldFactor=.1,this.guiTiltMin=0,this.guiPanVisualOffset=7,this.guiZoomVisualOffset=2,this.cursorChangeDelay=300,this.manipulationSpeedFactor=1,this.manipulationShiftSpeedFactor=5,this.pitchMax=85,this.maxfactor=4,this.fovMin=1,this.fovMax=179,this.noAnimationOnActivation=!1,this.defaultDistanceOnActivation=1e3,this.panLimitFactor=1e-4,this.doubleClickZoomFactor=10,this.resetTime=10,this.pandirframe=3,this.zoomExactPick=!1,this.leftDoubleClickEnable=!0,this.rightDoubleClickEnable=!0,this.noExactRepick=!1},resetDefaultGroundValue:function(){this.resetDefaultValue(),this.groundModeAltitude=1.8,this.noZoom=!0,this.minHeight=this.groundModeAltitude,this.guiPanFactor=1,this.guiPanHoldFactor=.3,this.guiRotateFactor=2,this.guiRotateHoldFactor=.2,this.guiZoomFactor=4,this.guiZoomHoldFactor=.1,this.guiTiltMin=90,this.pitchMax=180,this.panSpeed=.1,this.rotateSpeed=.3,this.zoomSpeed=3,this.targetDisplay=!1,this.defaultDistanceOnActivation=5,this.rightDoubleClickEnable=!1},resetDefaultFixedValue:function(){this.resetDefaultGroundValue(),this.noZoom=!1,this.fovMin=1,this.fovMax=179},resetDefault2DValue:function(){this.resetDefaultValue(),this.pitchMax=0},resetDefaultSphericValue:function(){this.resetDefaultValue(),this.defaultDistanceOnActivation=15e6,this.noRotate=!0,this.panSpeed=2,this.pitchMax=360,this.leftDoubleClickEnable=!1,this.rightDoubleClickEnable=!1,this.dampingTime=2,this.zoomSpeed=.75,this.noExactRepick=!0}})}),define("DS/UrbanFeature/DataModelSelection",["UWA/Class","UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Selection/CSOManager","DS/XCityTools/EventDispatcher"],function(t,e,i,n,s,r){"use strict";return t.extend(e,{init:function(t){this.urban=t,this.selection={},this.hoveredFeature=void 0,this._selectBind=this.select.bind(this),this._hoverBind=this.hover.bind(this)},addDataModel:function(t){t.addEvent("onAddTree",this.initSelection,this),t.addEvent("onRemoveTree",this.delistenSelection,this),t.addEvent("onAddTree",this.listenHovering,this),t.addEvent("onRemoveTree",this.delistenHovering,this)},initSelection:function(t){this.listenSelection(t),t.get("selected")&&this.select(t)},listenSelection:function(t){t.addEvent("onChange:selected",this._selectBind),t.addEvent("onDestroy",this.delistenSelection.bind(this))},delistenSelection:function(t){t.removeEvent("onChange:selected",this._selectBind)},listenHovering:function(t){t.get("hoverable")&&t.setPrepicking(),t.addEvent("onChange:hovered",this._hoverBind),t.addEvent("onDestroy",this.delistenHovering.bind(this))},delistenHovering:function(t){t.removeEvent("onChange:hovered",this._hoverBind)},getSelection:function(){for(var t=[],e=Object.keys(this.selection),i=0,n=e.length;i<n;i++)t.push(this.selection[e[i]]);return t},getHovered:function(){return this.hoveredFeature},select:function(t,e,i){return t.get("selected")?void 0===this.selection[t.id]&&(this.selection[t.id]=t,s.add({model:t}),this.dispatchEvent("onSelect",[t,i]),r.publish(r.eventsList.onSelect,t,i),this.dispatchEvent("onChange:selection",t)):void 0!==this.selection[t.id]&&(this.dispatchEvent("onChange:selection",t),this.dispatchEvent("onDeselect",t),r.publish(r.eventsList.onDeselect,t),s.remove({model:t}),delete this.selection[t.id],0===Object.keys(this.selection).length&&this.urban.getView3D().activateHighlightSet(),this.hoveredFeature!==t&&t.temporary&&(t.isIndexablePrimitive()?t.getContent()._layer.getItemParent().removeChild(t):this.urban._dataModelPrivate.removeChild(t)),t._itemParent||t.destroy(this.urban)),this},hover:function(t){return t.get("hovered")?void 0===this.hoveredFeature&&(this.hoveredFeature=t,this.dispatchEvent("onHover",t),this.dispatchEvent("onChange:hovering",t)):this.hoveredFeature===t&&(this.dispatchEvent("onChange:hovering",t),this.dispatchEvent("onDehover",t),void 0===this.selection[t.id]&&this.urban._dataModelPrivate.removeChild(this.hoveredFeature),delete this.hoveredFeature,t._itemParent||t.destroy(this.urban)),this},clear:function(){var t,e=this.getSelection();for(t=0;t<e.length;t++)e[t].set("selected",!1),this.dispatchEvent("onDeselect",e[t]);return this.dispatchEvent("onClear",e),this.selection={},this},clearHover:function(){return void 0!==this.hoveredFeature&&this.hoveredFeature.set("hovered",!1),this.dispatchEvent("onClearHover",this.hoveredFeature),this}})}),define("DS/UrbanCore/RenderPassManager",["DS/XCityTools/RenderPassManager"],function(t){"use strict";return t}),define("DS/UrbanFeature/R2VFeatureState",["DS/XCityModel/Item","DS/WAFData/WAFData","DS/3DXMTiles/OOCTileSetHandler","DS/3DXMTiles/OOCManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/WebappsUtils/WebappsUtils"],function(t,e,i,n,s,r,o){"use strict";var a=t.extend({defaults:{config:null,Coordinate:null,loadInfo:{loaded:1,total:1}},metaData:{type:"Geometry",className:"R2VFeatureState"},loaderJSON:{config:"loadJSONObject"},setup:function(){this._parent(),this._tileSetRootId=null,this._node=new r,this._node.name="TileSetFeature"},setPointOfView:function(t){return this.set("PointOfView",t)},getPointOfView:function(){return this.get("PointOfView")},create:function(t){var e=this;if(!this._parent(t))return!1;var r=t._urban;if(this._urban=r,this.getItemParent().get("visible")){var a=this.get("config"),h=a.objectId,l=a.displayName,d=a.urlR2VSurvey;if(!0===window.URBANODT&&(d=o.getWebappsBaseUrl()+"Web3DXCityVisuTests/assets/data/dataserver/"),null===this._urban.oocManager){var u=this._urban.USR.webGLV6Viewer;this._urban.oocTileSetHandler=new i({sortingMetric:"pixelError",triggerMetric:"pixelError"}),this._urban.oocManager=new n(u,{getServiceUrlCB:function(t){return d}})}var c=this;this.oocManager=this._urban.oocManager,this.oocTileSetHandler=this._urban.oocTileSetHandler,this.oocManager.setOnStartLoadingCB(function(t){if(!0===t.isLoading){let t=c.get("loadInfo"),e={loaded:t.loaded,total:t.total+1};c.set("loadInfo",e)}}),this.oocManager.setOnEndLoadingCB(function(t,e,i,n){if(console.log("End loading status :"+t),!1===t.isLoading){let t=c.get("loadInfo"),e={loaded:t.total,total:t.total};c.set("loadInfo",e)}}),this._root=t,t.getNode3D().add(this._node),this.oocManager.setTargetNode(this._node);var g={handler:e.oocTileSetHandler,tileSet:{sourceId:"r2vsurvey",resourceId:h}};if(window.URBANODT){let t=0,e={rootId:"/9298F6E6CB2D00006243FC06000A51CA/9298F6E6CB2D00006243FC5C0016D3B8",matrix:[t,t,t],boundingBox:[-150.734,-174.25,-27.84,150.734,174.25,27.84],viewpoint:{target:{x:t+31.716767607812685,y:t-26.720141993690476,z:t-32.41799467378662},orientation:{x:.28749440096583273,y:.1570952102050275,z:.4530472117035139,w:.8291057160046641},distanceToTarget:616.3068240696448},baseTileURL:"/debug_visu/assets/ooc/r2v/stadium/tile",baseContentURL:"/debug_visu/assets/ooc/r2v/stadium/tileContent/",tilesExtension:".json"};g.tileSet={rootURI:e.rootId,baseTileURL:e.baseTileURL,baseContentURL:e.baseContentURL,tilesExtension:e.tilesExtension}}this.oocManager.registerReference(l,g),this._tileSetRootId=this.oocManager.addRoot(l,{onLoadedCB:function(t){console.log("oocManager onLoadedCB, bbox : ");var i=e.oocManager.getReferenceBoundingBox(t);if(console.log(i),e._itemParent&&null!==e._itemParent.get("PointOfView")){console.log("updating featurestate POV...");var n=e._itemParent.get("PointOfView");n.toJSON();n.set("position",new s.Vector3(.5*(i.min.x+i.max.x),.5*(i.min.y+i.max.y),i.max.z));let t=i.max.x-i.min.x,r=i.max.y-i.min.y,o=i.max.z-i.min.z,a=Math.max(t,r,o);n.set("length",1.5*a)}}});this._urban.USR.viewpoint.addEvent("onCameraShift",function(){var t=e.oocManager.getTileSet(l);null!==t&&t.refreshWorldMatrix()})}this._node.userData=this._itemParent},destroy:function(){console.log("destroy");this.get("config").displayName;null!==this._tileSetRootId&&this.oocManager.removeRoot(this._tileSetRootId),this._root.getNode3D().remove(this._node),this._node=new r,this._node.name="TileSetFeature"},_itemParentVisible:function(t){this._created&&this._node.setVisibility(t.get("visible"))},setItemParent:function(t){this._itemParent&&this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._itemParent=t,this._itemParent&&this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this)}});return t.ObjectContructor.R2VFeatureState=a}),define("DS/UrbanManipulator/LayerAnimation",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/Animation/PropertyAnimation","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/Animation/AnimationPath"],function(t,e,i,n,s,r){"use strict";return e.extend({init:function(t){this.layerId=t.layerId,this.layerName=t.layerName,this.timeline=t.timeline;var e=new r(t.start,t.end,1e3*t.duration);this.currentPath=e,this.updateCalls=0,this.animation=new i(this,"updateTime",e),this.runOnce=!0,this.stopped=!1,this.verbose=!1},setOptions:function(t){this.layerId=t.layerId,this.layerName=t.layerName,this.timeline=t.timeline;var e=new r(t.start,t.end,1e3*t.duration);this.currentPath=e,this.updateCalls=0,this.animation=new i(this,"updateTime",e)},getKeyframes:function(){return this.currentPath.getKeyframes()},getCurrentKeyframe:function(){return this.currentPath.getCurrentKeyframe()},applyKeyframe:function(t){if(n.is(this._layer)||(this._layer=xCity.findItem({id:this.layerId})),n.is(this._layer)||(this._layer=xCity.findItem({name:this.layerName})),n.is(this._layer)){var e=this._layer.get("renderID"),i=Math.round(t);e!==i&&this._layer.set("renderID",i)}},updateTime:function(t){!0===this.verbose&&s.log(t),this.animationTime=t,this.applyKeyframe(t),this.updateCalls++},setPath:function(t){this.stop(),this.currentPath=t,this.animation.setPath(this.currentPath)},start:function(){this.updateCalls=0,this.lastStartTime=window.performance.now(),this.animation.start()},pause:function(){0===this.animation.state()&&this.animation.pause()},play:function(){this.stopped=!1,2===this.animation.state()?this.resume():this.start()},resume:function(){2===this.animation.state()&&this.animation.resume()},displayRuntime:function(){!0===this.verbose&&(s.log(" runtime "+this.lastRuntime),s.log(" calls "+this.updateCalls),s.log(" avg fps "+this.updateCalls/(this.lastRuntime/1e3)))},stop:function(){this.animation.stop(),this.lastRuntime=window.performance.now()-this.lastStartTime,this.displayRuntime()},isDone:function(){return!n.is(this.animation.state())||1===this.animation.state()},getKeyframe:function(t){return n.is(this.currentPath)?this.currentPath.getKeyframe(t):null},setKeyframe:function(t,e){return n.is(this.currentPath)?this.currentPath.setKeyframe(t,e):null},addKeyframe:function(t,e){return n.is(this.currentPath)?this.currentPath.addKeyframe(t,e):null},removeKeyframe:function(t){return n.is(this.currentPath)?this.currentPath.removeKeyframe(t):null},duration:function(){return n.is(this.currentPath)?this.currentPath.duration():0},size:function(){return n.is(this.currentPath)&n.is(this.currentPath.keyframes)?this.currentPath.keyframes.length:0},setTime:function(t){return t<=0?(this.animation.setTime(t),this.animation.stop()):(this.animation.start(),this.animation.pause(),this.animation.setTime(t)),this.animation.time()},_setFastTime:function(t){this.animation.setTime(t)},setFrame:function(t,e){var i=(t-1)/e*1e3;return i=Math.max(0,i),this.setTime(i),this.animation.time()===i},goToKeyframe:function(t){var e=this.getKeyframe(t);return n.is(e)?(this.setTime(e.time),e):null},isRunning:function(){return!0!==this.stopped&&(this.isPlaying()||(this.stopped=!0),!0)},isPlaying:function(){return 0===this.animation.state()}})}),define("DS/UrbanFeature/ViewshedCamera",["DS/XCityModel/Item","DS/Visualization/ThreeJS_DS"],function(t,e){"use strict";var i=t.extend({defaults:{near:null,fov:50,far:1e3,aspect:1.5,bias:1e-6},metaData:{type:"ViewshedCamera",className:"ViewshedCamera"},setup:function(){this._parent(),this._vse=null,this._urban=null},create:function(t){if(!this._parent(t))return!1;Utils.is(this.get("near"))||this.set("near",this.getRoot()._urban.getViewpoint().camera.near),this._itemParent.addEvent("onChange:visible",this._visible,this),this.addEvent("onChange:near",this._updateCameraParameters,this),this.addEvent("onChange:far",this._updateCameraParameters,this),this.addEvent("onChange:fov",this._updateCameraParameters,this),this.addEvent("onChange:aspect",this._updateCameraParameters,this),this.addEvent("onChange:bias",this._updateCameraParameters,this),this._itemParent.addEvent("onChange:PointOfView",this._updatePointOfView.bind(this)),this._urban=this.getRoot()._urban,this._usr=this._urban.getView3D(),this._vse=this._usr.getViewshedEffect(),!0===this._itemParent.get("visible")&&this._addViewshedCamera()},_updatePointOfView:function(){this._vse.removeCamera(this.camID),this._addViewshedCamera()},_updateCameraParameters:function(){this._vse.changeNear(this.get("near"),this.camID),this._vse.changeFar(this.get("far"),this.camID),this._vse.changeFov(this.get("fov"),this.camID),this._vse.changeAspect(this.get("aspect"),this.camID),this._vse.changeBias(this.get("bias"),this.camID)},_addViewshedCamera:function(){var t={};t.pov=this._itemParent.get("PointOfView"),t.near=this.get("near"),t.far=this.get("far"),t.fov=this.get("fov"),t.aspect=this.get("aspect"),t.bias=this.get("bias");var i=this._urban,n=this._vse,s=(this._usr,this._usr.viewpoint),r=new e.PerspectiveCamera(t.fov,t.aspect,t.near,t.far),o=t.pov.getLocalPosition(i).clone(),a=t.pov.get("rotation").clone().multiplyScalar(Math.PI/180),h=t.pov.get("length");r.quaternion=function(t,i,n){var s=new e.Vector3(0,0,-1),r=new e.Vector3(1,0,0),o=new e.Vector3(0,-1,0),a=new e.Quaternion,h=new e.Quaternion,l=new e.Quaternion;a.setFromAxisAngle(s,t),h.setFromAxisAngle(r,i),l.setFromAxisAngle(o,n);var d=a.multiply(h);return d=d.multiply(l)}(a.x,a.y,a.z);var l=new e.Vector3(-Math.sin(a.x)*Math.sin(a.y),-Math.cos(a.x)*Math.sin(a.y),Math.cos(a.y)).normalize().multiplyScalar(h).negate();r.fposition=o.clone().sub(l.normalize().multiplyScalar(h)),r.orientation=1,r.useQuaternion=!0,r.up.applyQuaternion(r.quaternion),r.up.normalize();var d=function(){r.position=s._translateToRelativePosition(r.fposition.clone(),!1),r.matrix.compose(r.position,r.quaternion,r.scale),r.updateMatrixWorld(!0),r.matrixWorldInverse.getInverse(r.matrixWorld),r.updateProjectionMatrix()};d(),r.bias=t.bias,this.camID=n.addCamera(r,void 0,t.near,t.far,t.aspect,t.fov,t.bias);var u=this.camID;s.addEvent("onCameraShift",function(){d(),n.updateCamera(u,r)}),this._updateCameraParameters()},_visible:function(t){this._itemParent.get("visible")?this._addViewshedCamera():this._vse.removeCamera(this.camID)},getPointOfView:function(){return this.get("PointOfView")},setPointOfView:function(t){return this.set("PointOfView",t)},destroy:function(t){this._parent(t),this._vse&&this._vse.removeCamera(this.camID)}});return t.ObjectContructor.ViewshedCamera=i}),define("DS/UrbanFeature/Coordinate",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/XCityModel/Item","DS/XCityModel/Location","DS/XCityTools/Geocoder","DS/xCityBasicUtils/Utils"],function(t,e,i,n,s,r){"use strict";var o=n.extend({defaults:t.merge({rotation:null,initialOffset:null,initialRotation:null,isCreatedShape:!1},n.defaults),metaData:{type:"Location",className:"Coordinate"},loaderJSON:t.merge({rotation:"loadJSONVector3",initialOffset:"loadJSONVector3",initialRotation:"loadJSONVector3"},n.loaderJSON),setup:function(){this._parent()},create:function(t){this._parent(t),this._updateRotation(),this.addEvent("onChange:rotation",this._updateRotation,this)},_updateRotation:function(){if(null!==this.get("rotation")){var t,e,i=this._matrix.decompose();t=i[0],e=i[2];var n=r.quaternionFromEulerAngles(r.toRad(this.get("rotation").x),r.toRad(this.get("rotation").y),r.toRad(this.get("rotation").z));this._matrix.identity(),this._matrix.compose(t,n,e)}this.dispatchEvent("onChange:matrix",this._matrix.clone())},_shouldApplyScale:function(){return!this._attributes||!this._attributes.isCreatedShape},_updatePosition:function(){if(this._created){if(this._oldscale=this._scale,this._scale=1,!this._shouldApplyScale()||"EPSG:3857"!==s.getDefaultProjection()&&"EPSG:900913"!==s.getDefaultProjection()||(this._scale=s.computeMercatorScaleFactor(this.get("position").x,this.get("position").y,this.get("projection"))),this._scale!==this._oldscale){var t=this._scale/this._oldscale;this._matrix.scale({x:t,y:t,z:1})}var e=this.get("position").clone();if(this._localPosition&&this._lastPosition){var i=this._localPosition.z-this._lastPosition.z;e.z+=i}if(this._localPosition=e,this.get("shifted")&&this.getRoot()&&this._localPosition.add(this.getRoot()._urban.shiftedPosition),this.get("projection")||this.getRoot()&&this.getRoot()._urban.getProjectProjection()!==this.getRoot()._urban.getUserDefaultProjection()){var n=s.proj(this.get("position"),this.get("projection"));this._localPosition.set(n.x,n.y,this.get("position").z)}this._matrix.setPosition(this._localPosition),this._lastPosition=this.get("position").clone(),this.dispatchEvent("onChange:matrix",this._matrix.clone())}},setMatrix:function(t){this._parent(t);var e=this._matrix.decompose()[1],i=r.eulerAnglesFromQuaternion(e);i.x=r.toDeg(i.x),i.y=r.toDeg(i.y),i.z=r.toDeg(i.z),this.set("rotation",i)},getMatrix:function(){return this._matrix.clone()},reset:function(){this.setMatrix((new e.Matrix4).identity())},setOffsetToRobotCenter:function(t,e,i,n){this.initialTargetWorldMatrix=t,this.initialMatrix=e,this.target=i,this.fatherWorldMatrix=n},getCentralTranslation:function(){if(r.is(this.initialTargetWorldMatrix)){var t=(new e.Matrix4).copy(this.initialTargetWorldMatrix),i=this.initialMatrix.clone(),n=(new e.Matrix4).getInverse(t).multiply(i),s=(new e.Vector3).getPositionFromMatrix(n),o=new e.Matrix4;o.getInverse(this.fatherWorldMatrix),o.multiply(this.initialMatrix);var a=(new e.Vector3).getPositionFromMatrix(o).clone().sub(s);return a=this.fromAbsoluteToRelativeTranslation(a)}return new e.Vector3},fromAbsoluteToRelativeTranslation:function(t){var e=t.clone();if(!this.get("initialOffset")){var i=t.clone();if(this.get("projection")||this.getRoot()&&this.getRoot()._urban.getProjectProjection()!==this.getRoot()._urban.getUserDefaultProjection()){var n=s.proj(t.clone(),"",this.get("projection"));i.x=n.x,i.y=n.y}this.set("initialOffset",i.clone())}var r,o=this.get("initialOffset");if(this.get("projection")||this.getRoot()&&this.getRoot()._urban.getProjectProjection()!==this.getRoot()._urban.getUserDefaultProjection()){n=s.proj(o.clone(),this.get("projection"));(r=this.get("initialOffset").clone()).x=n.x,r.y=n.y}else r=this.get("initialOffset").clone();return e.sub(r),e},setCentralTranslation:function(t){if(r.is(this.initialTargetWorldMatrix)){var e=this.getCentralTranslation(),i=t.clone().sub(e),n=this.get("position").clone();n.add(i),this.set("position",n)}},getCentralRotation:function(){var t=this.get("rotation");if(t){this.get("initialRotation")||this.set("initialRotation",t.clone());var e=this.get("initialRotation");return t=t.z-e.z}return 0},setCentralRotation:function(t){var i=0,n=this.get("rotation");if(r.is(n)&&(i=n.z),n=this.get("initialRotation"),r.is(n)&&(i-=n.z),!(Math.abs(i-t)<.001)&&this.initialTargetWorldMatrix){var s=(new e.Matrix4).copy(this.initialTargetWorldMatrix),o=new e.Vector3(0,0,1),a=(new e.Matrix4).makeRotationAxis(o,r.toRad(t-i)),h=(new e.Matrix4).setPosition((new e.Vector3).getPositionFromMatrix(this.initialMatrix)),l=(new e.Matrix4).getInverse(h).multiply(s),d=(new e.Matrix4).copy(a).multiply(l),u=(new e.Matrix4).copy(h).multiply(d),c=new e.Matrix4;c.getInverse(this.fatherWorldMatrix);var g=c.multiply(u);this.setMatrix(g)}}});return i.ObjectContructor.Coordinate=o}),define("DS/UrbanCore/Viewpoint",["UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/XCityTools/Geocoder","DS/XCityTools/Debug","DS/Visualization/PathElement","DS/CoreEvents/Events","DS/XCityModel/Item","DS/xCityBasicUtils/Utils","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/EventDispatcher"],function(t,e,i,n,s,r,o,a,h,l,d,u){"use strict";return i.extend(t,{init:function(t,i,n,s,r){this._parent({viewer:{canvas:{width:500,height:500},divCss3DElement:UWA.createElement("div")},angle:i,near:n,far:s,defaultController:r}),this.urban=t,this._numFrameCamNotMoved=0,this._numMinFrameNotMoved=10,this.camMoved=!1,this._camOldPosition=new e.Vector3(0,0,0),this._camOldTargetPosition=new e.Vector3(0,0,0),this._camShiftedTranslation=new e.Vector3(0,0,0),this.viewProjectionMatrix=new e.Matrix4,this.frustum=new e.Frustum,this._autoShift=!0,this._debugNode=void 0;var o=this.urban.worldSize;(!h.is(o)||o<=0)&&(o=100),this.camera.position.z=o,this.camera.position.x=.5*o,this.camera.position.y=.5*o,this.urban.cropBox&&(this.camera.position.z=Math.max(this.urban.cropBox.getSize().x,this.urban.cropBox.getSize().y),this.camera.position.x=this.urban.cropBox.getShiftedCenter().x,this.camera.position.y=this.urban.cropBox.getShiftedCenter().y),this.target.z=0,this.target.x=this.camera.position.x,this.target.y=this.camera.position.y,this._ngp=(new e.Vector3).copy(this.target),this._dist2ngp=this.camera.position.z,this.terrainHeight=0,this._initialPosition=this.camera.position.clone(),this._initialCenter=this.target.clone(),this._forceShift=!0,this.debugNearGround=!1,t.url.updateSlots.push(this.updateUrl.bind(this)),this.initByUrl(),this.addEvent("onCameraStopped",this.camerastopped.bind(this)),this.hasPointCloud=!1},camerastopped:function(){},getPosition:function(){return this._translateToAbsolutePosition(this.camera.position.clone(),!1)},getTarget:function(){return this._translateToAbsolutePosition(this.target.clone(),!1)},getHeightFromGround:function(){return this.camera.position.z-this.terrainHeight},getGroundHeight:function(){return this.terrainHeight},isInsideWorld:function(){var t=this._getPositionShifted(),e=void 0===this.urban.cropBox?[0,0]:this.urban.cropBox.getShiftedMin(),i=void 0===this.urban.cropBox?[this.urban.worldSize,this.urban.worldSize]:this.urban.cropBox.getShiftedMax();return t.x>e[0]&&t.x<i[0]&&t.y>e[1]&&t.y<i[1]},getScreenPosition:function(t){var e=.5*this.urban.USR.webGLV6Viewer.SCREEN_WIDTH,i=.5*this.urban.USR.webGLV6Viewer.SCREEN_HEIGHT,n=this._translateToRelativePosition(t.clone());return n.applyProjection(this.viewProjectionMatrix),n.x=(1+n.x)*e,n.y=(1-n.y)*i,n},getRadius:function(){s.log(this.camera.fov),s.log(this.camera.position.z),s.log(this.camera.position.z*Math.tan(this.camera.fov*Math.PI/180))},getDistanceCameraToNearGroundPoint:function(){return this._dist2ngp},getCameraNearGroundPoint:function(){return this._ngp},_getCameraNearGroundPoint:function(t){var e=this._getTargetShifted().sub(this._getPositionShifted()),i=e.clone();i.z=0,e.normalize(),i.normalize();var n=Math.min(Math.PI/2,Math.acos(-e.z));n=Math.max(0,n-.5*this.camera.fov*Math.PI/180);var s=i.multiplyScalar((this.camera.position.z-this.terrainHeight)*Math.tan(n)*t);this._ngp=this._getPositionShifted().add(s).setZ(this.terrainHeight);var r=void 0===this.urban.cropBox?[0,0]:this.urban.cropBox.getShiftedMin(),o=void 0===this.urban.cropBox?[this.urban.worldSize,this.urban.worldSize]:this.urban.cropBox.getShiftedMax();if(this._ngp.setX(Math.min(Math.max(r[0],this._ngp.x),o[0])),this._ngp.setY(Math.min(Math.max(r[1],this._ngp.y),o[1])),this._dist2ngp=this._getPositionShifted().sub(this._ngp).length(),this.debugNearGround){var a=this._debugNode.getMatrix(),h=this._translateToAbsolutePosition(this._ngp.clone().sub(this._camShiftedTranslation)),l=.005*this._dist2ngp;a.makeScale(l,l,l/this.urban.USR.scale),a.setPosition(h),this._debugNode.setMatrix(a)}},_debugNearGround:function(t){if(this.debugNearGround=t,this.debugNearGround){if(!h.is(this._debugNode)){var e=new l.Color(0,1,0,1);this._debugNode=d.createSphereNode({radius:10,color:e})}0===this._debugNode.getParents().length&&this.urban.getView3D().getScene().add(this._debugNode)}else h.is(this._debugNode)&&this._debugNode.getParents().length>0&&this.urban.getView3D().getScene().remove(this._debugNode)},_getRatioWorld:function(){var t=this._getPositionShifted();return{x:t.x/this.urban.worldSize,y:t.y/this.urban.worldSize}},_getPositionRelative:function(){return this.camera.position},_getPositionShifted:function(){return new e.Vector3(this.camera.position.x+this._camShiftedTranslation.x,this.camera.position.y+this._camShiftedTranslation.y,this.camera.position.z)},_getTargetShifted:function(){return new e.Vector3(this.target.x+this._camShiftedTranslation.x,this.target.y+this._camShiftedTranslation.y,this.target.z)},_translateToRelativePosition:function(t,e){return!0!==e&&t.sub(this.urban.shiftedPosition),t.sub(this._camShiftedTranslation),t},_translateToAbsolutePosition:function(t,e){return!0!==e&&t.add(this.urban.shiftedPosition),t.add(this._camShiftedTranslation),t},_setRenderer:function(t){t.viewpoints.length>0&&t.removeViewpoint(0),this.viewer=t,this.canvas=t.canvas,t.addViewpoint(this)},update:function(){var t=!1;this.control&&(t=this.control.update(!0)),this._isMoving=t;var i=this.isInsideWorld();if(this._autoShift&&i||this._forceShift){var n=Math.max(1e4,10*this.urban.worldSize/(1<<this.urban.USR.level));if(Math.abs(this.camera.position.x)>n||Math.abs(this.camera.position.y)>n||this._forceShift){this._forceShift=!1;var r=new e.Vector3(-this._camShiftedTranslation.x-this.camera.position.x,-this._camShiftedTranslation.y-this.camera.position.y,0);this.setCameraShift(r)}}else 1!==this.urban.USR.scale&&(this.urban.USR.scale=1,s.log("Scale:",this.urban.USR.scale,"Shift:",this._camShiftedTranslation.x,this._camShiftedTranslation.y),this.urban.USR._rootProjScaled.setMatrix((new e.Matrix4).identity().setPosition(this._camShiftedTranslation.clone().negate())),this.urban.USR._rootProj.setMatrix((new e.Matrix4).identity().setPosition(this._camShiftedTranslation.clone().negate())),this.dispatchEvent("onCameraShift",this));var a=this.camMoved,h=.001*(this.camera.position.z-this.terrainHeight);Math.abs(this.camera.position.x-this._camOldPosition.x)>h||Math.abs(this.camera.position.y-this._camOldPosition.y)>h||Math.abs(this.camera.position.z-this._camOldPosition.z)>h||Math.abs(this.target.x-this._camOldTargetPosition.x)>h||Math.abs(this.target.y-this._camOldTargetPosition.y)>h||Math.abs(this.target.z-this._camOldTargetPosition.z)>h?(this._camOldPosition.set(this.camera.position.x,this.camera.position.y,this.camera.position.z),this._camOldTargetPosition.set(this.target.x,this.target.y,this.target.z),this.camMoved=!0,this.numFrameCamNotMoved=0):this._numFrameCamNotMoved<this._numMinFrameNotMoved?this._numFrameCamNotMoved++:this.camMoved=!1,this.camMoved!==a&&(this.camMoved?this.dispatchEvent("onCameraMoved",this):this.dispatchEvent("onCameraStopped",this));var l=this._ngp.clone().add(this.urban.shiftedPosition);this.terrainHeight=this.urban.USR.getGroundHeight(l.x,l.y),isNaN(this.terrainHeight)?this.terrainHeight=0:this.terrainHeight*=this.urban.USR.scale,this.camera.updateMatrixWorld(),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this._getCameraNearGroundPoint(1);var d=Math.min(this._dist2ngp,this.camera.position.z-this.terrainHeight);this.camera.near=1+Math.max(0,.75*(d-1e3)),this.camera.far=Math.max(1e5,1e3*this.camera.near),this.camera.updateProjectionMatrix(),this.viewProjectionMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.frustum.setFromMatrix(this.viewProjectionMatrix),this._frustum=this.frustum,this.control&&this.control.setCurrentHeight(this.terrainHeight),this.camMoved&&(this.urban.USR._needRender=!0,u.publish(u.eventsList.pointOfView,this.get(),this));var c=this.camMoved,g={eventChannel:c?"/VISU/":"/VISU/SpriteNodeInit",eventType:"@onViewpointChange",viewpoint:this,cameraEye:this.camera.position,cameraTarget:this.target,cameraUp:this.camera.up};return o.publish({event:c?"/VISU/":"/VISU/SpriteNodeInit",data:g}),this.terrainHeight},initByUrl:function(){var t=this.urban.url.getArgument("camera");if(void 0!==t){var i=t.options,n=new e.Vector3(0,0,0),s=new e.Vector2(0,45,0),r=1e3;if(void 0!==i.target){var o=i.target.split(",");if(n.set(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2])),void 0!==i.angle){var a=i.angle.split(",");s.set(parseFloat(a[0]),parseFloat(a[1]))}void 0!==i.length&&(r=parseFloat(i.length)),this.setViewpoint(n,s,r)}}else{var h=this.urban.url.getArgument("viewpoint");if(void 0!==h){var l=h.value.split(",");6===l.length?(this.camera.position=this.urban.USR.viewpoint._translateToRelativePosition(new e.Vector3(parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2]))),this.camera.up=new e.Vector3(0,0,1),this.target=this.urban.USR.viewpoint._translateToRelativePosition(new e.Vector3(parseFloat(l[3]),parseFloat(l[4]),parseFloat(l[5])))):3===l.length&&(this.camera.position=this.urban.USR.viewpoint._translateToRelativePosition(new e.Vector3(parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2])+2e3)),this.camera.up=new e.Vector3(0,0,1),this.target=this.urban.USR.viewpoint._translateToRelativePosition(new e.Vector3(parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2])))),this.camera.lookAt(this.target)}}this.urban.url.hasArgument("viewpoint")&&this.urban.url.removeArgument("viewpoint")},updateUrl:function(t){var e=this.getViewpoint(),i={};i.target=parseFloat(e.target.x.toFixed(3))+","+parseFloat(e.target.y.toFixed(3))+","+parseFloat(e.target.z.toFixed(3)),i.angle=parseFloat(e.angle.x.toFixed(4))+","+parseFloat(e.angle.y.toFixed(4)),i.length=parseFloat(e.length.toFixed(3)),t.setArgument("camera",{options:i})},setLength:function(t){var e=this.getRotationAngle(),i=this.getTarget();return this.set({target:i,angle:e,length:t})},setRotationAngle:function(t){var e=this.getlength(),i=this.getTarget();return this.set({target:i,angle:t,length:e})},set:function(t){var i=t.target,n=t.angle,s=t.length,r=Math.PI/180,o=n.clone().multiplyScalar(r),a=new e.Vector3(-Math.sin(o.x)*Math.sin(o.y),-Math.cos(o.x)*Math.sin(o.y),Math.cos(o.y)).normalize().multiplyScalar(s);this.target=this._translateToRelativePosition(i.clone());var h=i.clone().add(a);return this._initialPosition=h.clone(),this.camera.position=this._translateToRelativePosition(h),this.camera.up=new e.Vector3(Math.sin(o.x)*Math.cos(o.y),Math.cos(o.x)*Math.cos(o.y),Math.sin(o.y)).normalize(),this.camera.lookAt(this.target),u.publish(u.eventsList.pointOfView,{target:i,angle:n,length:s}),this},get:function(){var t=180/Math.PI,i=this.target.clone().sub(this.camera.position),n=(i.clone().normalize(),i.length());i.divideScalar(n);var s=new e.Vector3(0,Math.acos(-i.z),0);return 0!==i.x&&0!==i.y?s.x=-(Math.atan2(i.y,i.x)-Math.PI/2):s.x=-(Math.atan2(this.camera.up.y,this.camera.up.x)-Math.PI/2),{target:this._translateToAbsolutePosition(this.target.clone()),angle:new e.Vector2(s.x*t,s.y*t),length:parseFloat(n.toFixed(3))}},getLength:function(){Math.PI;return this.target.clone().sub(this.camera.position).length()},getRotationAngle:function(){Math.PI;var t=this.target.clone().sub(this.camera.position),i=(t.clone().normalize(),t.length());t.divideScalar(i);var n=new e.Vector3(0,Math.acos(-t.z),0);return 0!==t.x&&0!==t.y?n.x=-(Math.atan2(t.y,t.x)-Math.PI/2):n.x=-(Math.atan2(this.camera.up.y,this.camera.up.x)-Math.PI/2),n},getViewpoint:function(){return this.get()},setViewpoint:function(t,e,i){return this.set({target:t,angle:e,length:i})},offsetCamera:function(t){return h.is(t)&&this.camera.position.add(t),this},offsetTarget:function(t){return h.is(t)&&this.target.add(t),this},setPosition:function(t){return h.is(t)&&(this.camera.position.copy(this._translateToRelativePosition(t.clone())),u.publish(u.eventsList.cameraPosition,t)),this},overwriteTarget:function(t){return h.is(t)&&(this.target.copy(this._translateToRelativePosition(t.clone())),this.camera.lookAt(this.target)),this},logPOV:function(){var t=this.get(),e={className:"Feature",name:"Point of view",visible:!0,PointOfView:{className:"PointOfView"}},i=t.target.toArray();i[0]=i[0].toFixed(4),i[1]=i[1].toFixed(4),i[2]=i[2].toFixed(4);var n=t.angle.toArray();n[0]=n[0].toFixed(4),n[1]=n[1].toFixed(4),e.PointOfView.position=i,e.PointOfView.rotation=n,e.PointOfView.length=t.length.toFixed(4),console.log(JSON.stringify(e))},getCurrentRay:function(t){var i=this.urban.USR.webGLV6Viewer.canvas.getBoundingClientRect(),n=t.clone().sub(new e.Vector2(Math.floor(i.left),Math.floor(i.top)));return this.create3DRayFrom2DPoint(n)},getMousePosition:function(t){var i=this.urban.USR.webGLV6Viewer,n=this.urban.USR.webGLV6Viewer.canvas.getBoundingClientRect(),s=t.clone().sub(new e.Vector2(Math.floor(n.left),Math.floor(n.top)));return s=new e.Vector2(s.x,s.y),i.getMousePosition(s)},fastPick:function(t,e){var i=this.getCurrentRay(t),n=null;return n=this.rayproject(i.origin,i,e),h.is(n)&&(n=this._translateToAbsolutePosition(n.clone())),n},rayproject:function(t,e,i){var n=e.direction.clone().normalize(),s=t.z-i;if(n.z>=0)return null;var r=-s/n.z,o=n.clone().setLength(r),a=t.clone().add(o);return a.clone().sub(t).normalize().sub(e).length()>5e-4&&(a=null),a},featureIntersect:function(t){var e,i=this.urban.USR.webGLV6Viewer;e=this.getMousePosition(t);var n,s=i.computeIntersection(e,i.picking.gpu,i.picking.primitive,!1,{ray:null});if(s.length&&(0,s[0].primitive&&s[0].object._occurrence)){if(s[0].primitive.userData)return s[0].primitive.userData,!0;var o;for(s[0].path=new r,s[0].path.setFromOccurrence(s[0].object._occurrence,THREEDS.SubElement.getFromSGNode(s[0].primitive)),n=0;n<s[0].path.externalPath.length&&!o;++n)s[0].path.externalPath[n].userData instanceof a&&(o=s[0].path.externalPath[n].userData);if(o&&o.get("selectable"))return!0}return!1},exactPick:function(t){var i,n;if(i=this.getMousePosition(t),h.is(i)){if(i.xPix<0)return null;if(i.yPix<0)return null}return n=this.urban.USR.webGLV6Viewer.computeIntersection(i,!0,!1,!0,{ray:null}),h.is(n)&&(n=n[0]),h.is(this.nullNormal)||(this.nullNormal=new e.Vector3(-1,-1,-1)),h.is(n)&&h.is(n.normal)&&!n.normal.equals(this.nullNormal)&&h.is(n.object)&&"XCityInfinitePlane"!==n.object.name?this._translateToAbsolutePosition(n.point.clone()):null},exactPickCPU:function(t){var i,n;if(i=this.getMousePosition(t),h.is(i)){if(i.xPix<0)return null;if(i.yPix<0)return null}return n=this.urban.USR.webGLV6Viewer.computeIntersection(i,!1,!0,!0,{ray:null}),h.is(n)&&(n=n[0]),h.is(this.nullNormal)||(this.nullNormal=new e.Vector3(-1,-1,-1)),h.is(n)&&h.is(n.normal)&&!n.normal.equals(this.nullNormal)&&h.is(n.object)?this._translateToAbsolutePosition(n.point.clone()):null},moveTo:function(t){console.warn("Moveto is not implemented on this controller")},getCamera:function(){if(this.hasPointCloud){var t=this._parent().clone(),e=this.getPosition();e.z=e.z/this.urban.USR.scale;var i=t.matrix.setPosition(e);return t.setMatrix(i),t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),t.updateProjectionMatrix(),t}return this._parent()},getInitialPosition:function(){return this._initialPosition.clone()},reset:function(){this.isInsideWorld();if(this._autoShift||this._forceShift){this._forceShift=!1;var t=this.urban.worldSize;(!h.is(t)||t<=0)&&(t=100);var i=new e.Vector3(-.5*t,-.5*t,0);this.setCameraShift(i)}},setCameraShift:function(t){this._camShiftedTranslation=new e.Vector3(-t.x,-t.y,0),this.target.x-=this.camera.position.x,this.target.y-=this.camera.position.y,this.camera.position.x=0,this.camera.position.y=0,"EPSG:3857"!==n.getDefaultProjection()&&"EPSG:900913"!==n.getDefaultProjection()||(this.urban.USR.scale=n.computeMercatorScaleFactor(this._camShiftedTranslation.x+this.urban.shiftedPosition.x,this._camShiftedTranslation.y+this.urban.shiftedPosition.y,n.getDefaultProjection())),this.urban.USR._rootProjScaled.setMatrix((new e.Matrix4).makeScale(1,1,this.urban.USR.scale).setPosition(t)),this.urban.USR._rootProj.setMatrix((new e.Matrix4).identity().setPosition(t)),h.is(this.urban.USR._freeRobot)&&this.urban.USR._freeRobot.setTarget(this.urban.USR.currentPath,null,this.urban.USR.webGLV6Viewer),this.dispatchEvent("onCameraShift",this)},getAreaInView:function(){var t=this.urban.USR.webGLV6Viewer.canvas.getBoundingClientRect(),e=this.fastPick(xCity.arrayToVector3([t.x,t.y]),0),i=this.fastPick(xCity.arrayToVector3([t.width,t.y]),0),n=this.fastPick(xCity.arrayToVector3([t.width,t.height]),0),s=this.fastPick(xCity.arrayToVector3([t.x,t.height]),0);if(null===e){var r=(o=this.getCurrentRay(xCity.arrayToVector3([t.x,t.height]))).direction.clone().normalize().clone().setLength(this.camera.far);(a=this._translateToAbsolutePosition(o.origin.clone())).x+=r.x,a.y+=r.y,a.z=0,e=a}if(null===i){var o,a;r=(o=this.getCurrentRay(xCity.arrayToVector3([t.width,t.height]))).direction.clone().normalize().clone().setLength(this.camera.far);(a=this._translateToAbsolutePosition(o.origin.clone())).x+=r.x,a.y+=r.y,a.z=0,i=a}var h=void 0!==this.urban.baseReferential.bbox?[this.urban.baseReferential.bbox.xmin,this.urban.baseReferential.bbox.ymin]:[0,0],l=void 0!==this.urban.baseReferential.bbox?[this.urban.baseReferential.bbox.xmax,this.urban.baseReferential.bbox.ymax]:[this.urban.worldSize,this.urban.worldSize],d=void 0===this.urban.cropBox?h:this.urban.cropBox._min,u=void 0===this.urban.cropBox?l:this.urban.cropBox._max,c=function(t,e){var i,n,s=function(t){return(h[0]-i[0])*(t[1]-i[1])>(h[1]-i[1])*(t[0]-i[0])},r=function(){var t=[i[0]-h[0],i[1]-h[1]],e=[n[0]-u[0],n[1]-u[1]],s=i[0]*h[1]-i[1]*h[0],r=n[0]*u[1]-n[1]*u[0],o=1/(t[0]*e[1]-t[1]*e[0]);return[(s*e[0]-r*t[0])*o,(s*e[1]-r*t[1])*o]},o=t;for(var a in i=e[e.length-1],e){var h=e[a],l=o;for(var d in o=[],n=l[l.length-1],l){var u;s(u=l[d])?(s(n)||o.push(r()),o.push(u)):s(n)&&o.push(r()),n=u}i=h}return o}([[d[0],d[1]],[d[0],u[1]],[u[0],u[1]],[u[0],d[1]]],[[e.x,e.y],[s.x,s.y],[n.x,n.y],[i.x,i.y]]);return c.push(c[0]),c}})}),define("DS/UrbanTool/DrawingManipulatorTool",["UWA/Class","UWA/Core"],function(t,e){"use strict";var i={polyline:"LineString",polygon:"polygon",building:"polygon",house:"polygon",point:"point"};return t.extend({init:function(t){this.type="drawingManipulator",this.creationCursor=null,this.additionCursor=null,this.suppressionCursor=null,this.segmentRemovalCursor=null,this.creationCursorHotSpot=null,this.additionCursorHotSpot=null,this.suppressionCursorHotSpot=null,this.segmentRemovalCursorHotSpot=null,this.parentDiv=t.frmWindow.getUIFrame(),this.measureType="polyline",this.defaultContext={Line:{id:"drawing_line_id",name:"Drawed Line"},Folder:{id:"subTemporaryFolder",temporary:!0,name:"Sub Temporary Folder"}},this.setCurrentContext(this.defaultContext)},setCurrentContext:function(t){return this.context=this._contextCopyOf(this.defaultContext),Utils.is(t)&&(Utils.is(t.Line)&&(this.context.Line={id:t.Line.id||this.defaultContext.Line.id,name:t.Line.name||this.defaultContext.Line.name,nameBase:t.Line.nameBase||this.defaultContext.Line.nameBase}),Utils.is(t.Folder)&&(this.context.Folder={id:t.Folder.id||this.defaultContext.Folder.id,name:t.Folder.name||this.defaultContext.Folder.name},this.context.Folder.temporary=Utils.is(t.Folder.temporary)?t.Folder.temporary:this.defaultContext.Folder.temporary)),this.context},_contextCopyOf:function(t){return{Line:{id:t.Line.id,name:t.Line.name,nameBase:t.Line.nameBase},Folder:{id:t.Folder.id,name:t.Folder.name}}},getCurrentContext:function(){return this.context},getGeoJSONType:function(t){return i[this.measureType]},isPoint:function(){return"point"===this.measureType},isPolygon:function(){return"polygon"===this.getGeoJSONType()},isFlat:function(){return this.isPolygon()},isRectangle:function(){return this.isHouse()},isSquare:function(){return!1},isBuilding:function(){return"building"===this.measureType},isHouse:function(){return"house"===this.measureType},isPolyline:function(){return"polyline"===this.measureType},onStart:function(t){return!0},onFinish:function(t){return!0},onAddAnchor:function(t,e){return t},onRemoveAnchor:function(t,e){return!0},onCreateLoop:function(t){return!0},onBreakLoop:function(t){return!0},onBeginPreactivateAnchor:function(t,e){return!0},onEndPreactivateAnchor:function(t,e){return!0},onManipulateAnchor:function(t,e){return!0},onUpdate:function(t,e){return!0},onCameraUpdate:function(t){return!0},onDestroy:function(t,e){return!0},onItemCreated:function(t){},isRobotEnabled:function(){return!1},hasVerticalHandle:function(){return!0}})}),define("DS/UrbanFeature/ObjectSelection",["UWA/Class","UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Selection/CSOManager","DS/XCityTools/EventDispatcher"],function(t,e,i,n,s,r){"use strict";return t.extend(e,{init:function(t){this.urban=t,this.selected=[],this.hovered=[],this.hso=WUX.Selection.HSOManager,this.pso=WUX.Selection.PSOManager},select:function(t,e){this.selected.push(t),t.XSOnode={pathElement:t.path},this.hso.isIn(t.XSOnode)&&this.hso.remove(t.XSOnode),this.dispatchEvent("onObjectSelect",[t,e])},hover:function(t){},clear:function(t){for(var e=0,i=this.selected.length;e<i;e++){var n=this.selected.pop();this.hso.isIn(n.XSOnode)&&this.hso.remove(n.XSOnode),this.dispatchEvent("onObjectDeselect",n)}this.selected=[],this.dispatchEvent("onClearSelection",t)},clearHovered:function(){},emptySelect:function(t){this.dispatchEvent("onEmptySelect",t)}})}),define("DS/UrbanFeature/View3DHighlighter",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/XCityTools/EventDispatcher","DS/XCityModel/GeometrySet","DS/xCityBasicUtils/Utils"],function(t,e,i,n,s,r,o){"use strict";return t.extend({init:function(t,e){this._renderer=t,this.hso=WUX.Selection.HSOManager,this.pso=WUX.Selection.PSOManager,this._dataModelSelection=e,e.addEvent("onSelect",this.highlight,this),e.addEvent("onDeselect",this.unhighlight,this),e.addEvent("onHover",this.highlight,this),e.addEvent("onDehover",this.unhighlight,this)},_highlightElement:function(t,e,i,r){if(!(r&&r.fromNode&&e&&e.id!==r.fromNode.id)||o.isParent(r.fromNode,e)){var a=new n,h=e;if(o.is(r)&&o.is(r.toNode)){if(!o.is(r.eventType)||"ADD"!==r.eventType)return;if(o.isParent(e,r.toNode))h=r.toNode;else{if(e.hlStoreKey!==r.toNode.storeKey||e.hlIdDataSource!==r.toNode.parents[0].idDataSource)return;h=e}}if(void 0!==e.instanceId&&""!==e.instanceId?(a.setFromArray([h]),a.instanceId=e.instanceId):i?a.setFromArray([h],[i]):(e.hwInstancing&&e.traverse(function(t){if(void 0!==t.mesh3js&&"instance"===t.mesh3js.instancingSelectionMode){t.mesh3js.instancingSelectionMode="mesh";for(var e=0;e<t._occurrences.length;++e)t._occurrences[e].renderable.instancingSelectionMode="mesh"}}),a.setFromArray([h])),t&&void 0===e.hl){e.hl=s.subscribeTo("/VISU/onSceneGraphUpdate",this._highlightElement.bind(this,t,e,i));for(var l=!1,d=e;!l&&d;)void 0!==d.storeKey&&void 0!==d.idDataSource&&(l=!0,e.hlStoreKey=d.storeKey,e.hlIdDataSource=d.idDataSource),d=d.parents?d.parents[0]:void 0;if(e.clusterInfo&&(e.clusterInfo.isLeaf||void 0!==e.clusterInfo.rtree)&&(e.hlCluster=s.subscribeTo("/3DEXPERIENCity/onClusterUpdate",this._highlightElement.bind(this,t,e,i)),e.leafStrid=e._occurrences[0].renderable.userData.cgmIds[(e.instanceId-5)/5],!e.clusterInfo.isLeaf)){d=e.clusterInfo.rtree.getNodeByInstanceId((e.instanceId-5)/5);e.leafNbInstances=d.nHits}}var u={pathElement:a},c=this._renderer.getCurrentHighlightColor();if(o.is(c)&&(u.parameters=c),t){if(this.hso.isIn(u)&&this.hso.remove(u),this.hso.add(u),e.clusterInfo&&(e.clusterInfo.isLeaf||void 0!==e.clusterInfo.rtree))if(0===e.nbInstances)this.hso.remove(u);else{e.instanceId;for(var g=-1,m=0;m<e.nbInstances;++m)if(e.leafStrid===e._occurrences[0].renderable.userData.cgmIds[m]){g=5*m+5;break}g!==e.instanceId&&this.hso.remove(u),g>-1&&g!==e.instanceId&&(e.instanceId=g,a.instanceId=e.instanceId,u={pathElement:a},this.hso.add(u))}}else if(this.pso.add(u),this.hso.remove(u),e.clusterInfo&&(e.clusterInfo.isLeaf||void 0!==e.clusterInfo.rtree))if(0===e.nbInstances)this.pso.remove(u);else{for(e.instanceId,g=-1,m=0;m<e.nbInstances;++m)if(e.leafStrid===e._occurrences[0].renderable.userData.cgmIds[m]){g=5*m+5;break}g!==e.instanceId&&this.pso.remove(u),g>-1&&g!==e.instanceId&&(e.instanceId=g,a.instanceId=e.instanceId,u={pathElement:a},this.pso.add(u))}}},highlightPrimitive:function(t){var e=t.get("Content");if(e&&e._subMeshes){if(""!==e.get("instanceId")){var i=0;for(i=0;i<e._subMeshes.length;i++)e._subMeshes[i].mesh.instanceId=e.get("instanceId")}e.traverse(this._highlightElement.bind(this,t.get("selected"))),o.getComposedProperty(this,"_renderer.urban.showPrimBbox")&&e.drawDebugBbox()}},highlightGeometry:function(t){let e=t.getContent()._layer.createPrimitive(t.getContent()._getStrid());t.set("Content",e),this.highlightPrimitive(t),o.is(this.highlightGeometryOnLoadedTokken)&&s.unsubscribe(this.highlightGeometryOnLoadedTokken)},highlight:function(t){var e=t.get("Content");if(e){if(e.highlight&&e.highlight(),e._node)this._highlightElement(t.get("selected"),e._node);else if(e._subMeshes)if(!e._layer._patch&&e._layer instanceof r){let i=t.getContent()._layer.get("loadInfo");i&&3===i.total&&i.total===i.loaded?this.highlightGeometry(t):this.highlightGeometryOnLoadedTokken=s.subscribeTo(s.eventsList.onLoaded+":"+e._layer.get("id"),this.highlightGeometry.bind(this,t))}else e._layer._patch.register(e.get("strid"),this.highlightPrimitive.bind(this,t));t.addEvent("onDestroy",this.unhighlight,this)}},_unhighlightElement:function(t,e,i){var r=new n;void 0!==e.instanceId&&""!==e.instanceId?(r.setFromArray([e]),r.instanceId=e.instanceId):i?r.setFromArray([e],[i]):(e.hwInstancing&&e.traverse(function(t){if(void 0!==t.mesh3js&&"mesh"===t.mesh3js.instancingSelectionMode){t.mesh3js.instancingSelectionMode="instance";for(var e=0;e<t._occurrences.length;++e)t._occurrences[e].renderable.instancingSelectionMode="instance"}}),r.setFromArray([e])),t&&void 0!==e.hl&&(s.unsubscribe(e.hl),e.hl=void 0,e.clusterInfo&&(e.clusterInfo.isLeaf||void 0!==e.clusterInfo.rtree)&&(s.unsubscribe(e.hlCluster),e.hlCluster=void 0,e.leafStrid=void 0));var a,h,l={pathElement:r},d=this._renderer.getCurrentHighlightColor();if(o.is(d)&&(l.parameters=d),t?this.hso.remove(l):this.pso.remove(l),void 0!==e.instanceId&&""!==e.instanceId&&o.is(e.parents)&&e.parents.length>0&&o.is(e.parents[0].parents)){var u=this.getFactoryNode(e);if(u){var c=u.id;if(c)for(a=0;a<this.hso._items.length;++a)this.hso._items[a].pathElement.externalPath[0].id===c&&this._highlightElement(!0,u)}}var g=[];for(a=0;a<this.hso._items.length;++a){var m=this.hso._items[a].pathElement;o.is(m)&&o.is(m.externalPath)&&m.externalPath[0]&&(h=m.externalPath[0],o.isParent(e,h)&&g.push(m))}for(a=0;a<g.length;++a)l={pathElement:h=g[a]},o.is(d)&&(l.parameters=d),this.hso.remove(l)},unhighlight:function(t){var e=t.get("Content");e&&(void 0!==e.unhighlight&&e.unhighlight(),e._node?this._unhighlightElement(void 0!==t._changed.selected,e._node):e._subMeshes&&(e.traverse(this._unhighlightElement.bind(this,void 0!==t._changed.selected)),e._layer._patch?e._layer._patch.unregister(e.get("strid"),this.highlightPrimitive.bind(this,t)):this.highlightGeometryOnLoadedTokken&&s.unsubscribe(this.highlightGeometryOnLoadedTokken),o.getComposedProperty(this,"_renderer.urban.showPrimBbox")&&e.eraseDebugBbox&&e.eraseDebugBbox()),t.removeEvent("onDestroy",this.unhighlight,this))},rehighlight:function(){var t=this.hso.get();this.addToHSO(t)},emptyHSO:function(){for(var t=this.hso.get(),e=[],i=0;i<t.length;i++)e.push(t[i]);return this.hso.empty(),e},addToHSO:function(t){for(var e=this._renderer.getCurrentHighlightColor(),i=0;i<t.length;i++){o.is(e)&&(t[i].parameters=e);var n=t[i];this.hso.remove(n),this.hso.add(n)}},clear:function(t){if(t){for(var e=0;e<t.length;e++)this.unhighlight(t[e]);this.hso.empty()}},getFactoryNode:function(t){for(var e=t,i=e.parents[0];"VisuQuadTreeSirocco_PointObjects"!=i.name;){if(!(e=i).parents||!e.parents[0]){e=null;break}i=e.parents[0]}return e}})}),define("DS/UrbanTool/TemporaryFolder",["UWA/Core","UWA/Class","DS/UrbanTool/Utils","DS/XCityModel/Folder","i18n!DS/UrbanTool/assets/nls/measureDistance"],function(t,e,i,n,s){"use strict";var r=null,o=e.extend({start:function(t){i.is(this.dataModel)||(this.dataModel=t.getLayerRoot().getRoot())},getFolder:function(t,e){var s=e||t,r=this.dataModel.findChildById(t,!0);return i.is(r)||(r=new n({id:t,name:s}),this._addFolderToParent(r)),r},_addFolderToParent:function(t){var e=this.dataModel.findChildById("TemporaryItems",!0);return i.is(e)||((e=new n({id:"TemporaryItems",name:s.get("3DXCity.TemporaryFolder.Treeview.Text.TemporaryItem")})).get("children").addEvent("onRemove",this._remove.bind(this)),this.dataModel.addChild(e)),t.get("children").addEvent("onRemove",this._remove.bind(this)),e.addChild(t),e},_remove:function(t){var e=t.getItemParent(),i=e.getItemParent();t.addEvent("onDestroy",this._removeEmptyFolder.bind(this,e,i))},_removeEmptyFolder:function(t,e){0===t.get("children").length&&e&&e.removeChild(t)}});return o.getInstance=function(){return i.is(r)||(r=new o),r},o.getInstance()}),define("DS/UrbanManipulator/Keyframe",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/Animation/PropertyAnimation","DS/Animation/AnimationPath","DS/UrbanTool/Utils","DS/XCityTools/Debug"],function(t,e,i,n,s,r){"use strict";var o=e.extend({init:function(e){if(this.verbose=!1,this.spheric=!1,this.position=null,this.time=null,this.date=null,this.quaternion=null,this._eye=null,this._up=null,this._target=null,s.is(e)){var i;for(i in e)e.hasOwnProperty(i)&&(this[i]=e[i]);s.is(this.position)&&(this.position=(new t.Vector3).copy(this.position)),s.is(this.date)&&(this.date=new Date(this.date)),s.is(this.quaternion)&&(this.quaternion=new t.Quaternion(this.quaternion.x,this.quaternion.y,this.quaternion.z,this.quaternion.w)),s.is(this._eye)&&(this._eye=(new t.Vector3).copy(this._eye)),s.is(this._up)&&(this._up=(new t.Vector3).copy(this._up)),s.is(this._target)&&(this._target=(new t.Vector3).copy(this._target)),s.is(this._right)&&(this._right=(new t.Vector3).copy(this._right))}this.normalize()},lerp:function(t,e,i){if(!s.is(t))return s.is(e)?e:null;if(!s.is(e))return t;var n=t.clone(),r=e.clone();return n.multiplyScalar(1-i),r.multiplyScalar(i),n.add(r)},lerpValue:function(t,e,i){return s.is(t)&&s.is(e)?t+(e-t)*i:null},lerpQuat:function(t,e,i){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w<=0&&(e.x=-e.x,e.y=-e.y,e.z=-e.z,e.w=-e.w),t.clone().slerp(e,i)},lerpTime:function(t,e,i){if(!s.is(t)||!s.is(e))return null;var n=t.getTime(),r=e.getTime(),o=this.lerpValue(n,r,i),a=new Date;return a.setTime(o),a},interpol:function(e,i,n){var a=new o;if(s.is(this.time)&&s.is(e.time)&&(a.time=this.lerpValue(this.time,e.time,i)),s.is(this.date)&&s.is(e.date)&&(a.date=this.lerpTime(this.date,e.date,i)),s.is(n)){if(a.position=n,!0===this.spheric){var h=this.lerpValue(this.position.length(),e.position.length(),i);a.position.setLength(h)}}else if(s.is(this.position)&&s.is(e.position)&&(a.position=this.lerp(this.position,e.position,i),!0===this.spheric)){var l=this.position.length(),d=e.position.length();h=this.lerpValue(l,d,i);a.position.setLength(h)}if(s.is(this.fadeOn)&&(i=this.fadeinout(i)),s.is(this._target)&&s.is(e._target)){a._target=this.lerp(this._target,e._target,i),a._eye=a._target.clone().sub(a.position),a._eye.normalize(),0===e._eye.x&&0===e._eye.y||0===this._eye.x&&0===this._eye.y?(a._up=this.lerp(this._up,e._up,i),r.log(s.displayVector(a._eye.normalize())+" "+s.displayVector(a._up))):a._up=s.getUpFromCameraEye(a._eye);var u=s.getQuaternion2(a.position,a._target,a._up);a.setQuaternion(u)}else{u=new t.Quaternion;var c=this.getQuaternion(),g=e.getQuaternion();s.is(c)&&s.is(g)?(u=this.lerpQuat(c,g,i),a.setQuaternion(u),!0===this.verbose&&r.log("up "+s.displayVector(a._up))):r.log("quaternion interpolation error ")}return a},setQuaternion:function(e){s.is(this.quaternion)||(this.quaternion=new t.Quaternion),s.is(e)&&(this.quaternion.copy(e),this.normalize())},getQuaternion:function(){return this.quaternion},normalize:function(){return s.is(this.quaternion)&&(this.quaternion.normalize(),s.is(this._eye)||(this._eye=new t.Vector3),this._eye.copy(s.refX),this._eye.applyQuaternion(this.quaternion),this._eye.normalize(),s.is(this._up)||(this._up=new t.Vector3),this._up.copy(s.refZ),this._up.applyQuaternion(this.quaternion),this._up.normalize(),s.is(this._right)||(this._right=new t.Vector3),this._right.copy(this._eye),this._right.cross(this._up),this._right.normalize()),this},clone:function(){return new o(this)},initQuat:function(t,e){var i;(s.is(this.position)&&s.is(this._target)&&s.is(this._up)&&this.initQuat2(),s.is(this.quaternion))||(i=s.is(t)?s.is(e)?s.getQuaternion(t,e):s.getQuaternionFromEye(t):s.getQuaternionBetween(s.refZ,e),this.setQuaternion(i))},initQuat2:function(){s.is(this.position)&&s.is(this._target)&&s.is(this._up)&&this.setQuaternion(s.getQuaternion2(this.position,this._target,this._up))},fadein:function(t){return 1-Math.cos(t*Math.PI/2)},fadeout:function(t){return Math.sin(t*Math.PI/2)},fadeinout:function(t){return.5*(1-Math.cos(Math.PI*t))}});return o}),define("DS/UrbanManipulator/LocalisationManipulator",["DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","UWA/Class","DS/UrbanTool/Utils","DS/XCityTools/Debug"],function(t,e,i,n,s){"use strict";return i.singleton({init:function(){this.initialized=!1},Initialize:function(e){!1===this.initialized&&(this.shiftKey=!1,this.refX=new t.Vector3(1,0,0),this.refY=new t.Vector3(0,1,0),this.refZ=new t.Vector3(0,0,1),this.urban=e,this.position=new t.Vector3,this.target=new t.Vector3,this.up=new t.Vector3,this.eye=new t.Vector3,this.northAngle=0,this.verticalAngle=0,this.currentPan=new t.Vector2(0,0),this.currentRotate=new t.Vector2(0,0),this.currentZoom=new t.Vector2(0,0))},initEvents:function(){var t=this,i=function(i){t.mouseUp(i),n.is(t.mmoveToken)&&e.unsubscribe(t.mmoveToken),t.mmoveToken=null}.bind(t);e.subscribeToLeftMouseUp(i),e.subscribeToRightMouseUp(i),e.subscribeToMiddleMouseUp(i);var s=document.getElementById("boussole_circle_div"),r=document.getElementById("gui_pan_bg"),o=document.getElementById("gui_zoom_bg"),a=document.getElementById("gui_zoom_plus"),h=document.getElementById("gui_zoom_moins");a.onclick=t.zoomPlusClick.bind(t),h.onclick=t.zoomMoinsClick.bind(t),s.onclick=t.compassClick.bind(t),s.ondblclick=t.compassDblClick.bind(t);var l=function(i){t.verbose&&console.log("mousedown"),n.is(t.mmoveToken)&&(e.unsubscribe(t.mmoveToken),t.mmoveToken=null),t.rotateMouseDown(i),t.mmoveToken=e.subscribeToMouseMove(t.rotateMouseMove.bind(t))}.bind(t),d=function(e){t.verbose&&console.log("touchstart"),t.reset(),t.rotateMouseDown(e),s.ontouchmove=t.rotateMouseMove.bind(t)}.bind(t),u=function(e){t.verbose&&console.log("pointerdown"),t.reset(),t.rotateMouseDown(e),s.onpointermove=t.rotateMouseMove.bind(t)}.bind(t);s.onmousedown=l,s.ontouchstart=d,s.onpointerdown=u,s.onpointerup=t.touchEnd.bind(t),s.ontouchend=t.touchEnd.bind(t),r.onclick=t.panClick.bind(t);var c=function(i){n.is(t.mmoveToken)&&(e.unsubscribe(t.mmoveToken),t.mmoveToken=null),t.panMouseDown(i),t.mmoveToken=e.subscribeToMouseMove(t.panMouseMove.bind(t))}.bind(t),g=function(e){t.reset(),t.panMouseDown(e),r.ontouchmove=t.panMouseMove.bind(t)}.bind(t),m=function(e){t.reset(),t.panMouseDown(e),r.onpointermove=t.panMouseMove.bind(t)}.bind(t);r.onmousedown=c,r.ontouchstart=g,r.onpointerdown=m,r.onpointerup=t.touchEnd.bind(t),r.ontouchend=t.touchEnd.bind(t);var f=function(i){n.is(t.mmoveToken)&&(e.unsubscribe(t.mmoveToken),t.mmoveToken=null),t.zoomMouseDown(i),t.mmoveToken=e.subscribeToMouseMove(t.zoomMouseMove.bind(t)),o.onpointermove=t.zoomMouseMove.bind(t)}.bind(t),p=function(e){t.reset(),t.zoomMouseDown(e),o.ontouchmove=t.zoomMouseMove.bind(t)}.bind(t),v=function(e){t.reset(),t.zoomMouseDown(e),o.onpointermove=t.zoomMouseMove.bind(t)}.bind(t);o.onmousedown=f,o.ontouchstart=p,o.onpointerdown=v,o.onpointerup=t.touchEnd.bind(t),o.ontouchend=t.touchEnd.bind(t),this.initialized=!0},zoomEnable:function(t){if(this.initialized){var e="hidden";t&&(e="visible"),document.getElementById("gui_zoom_div").style.visibility=e}},panEnable:function(t){if(this.initialized){var e="hidden";t&&(e="visible"),document.getElementById("gui_pan_div").style.visibility=e}},rotateEnable:function(t){if(this.initialized){var e="hidden";t&&(e="visible"),document.getElementById("boussole_circle_div").style.visibility=e}},enableInterns:function(t){this.zoomEnable(t),this.panEnable(t),this.rotateEnable(t)},draw:function(){this.initialized&&(this.drawCompass(),this.drawPan(),this.drawRotate(),this.drawZoom())},set:function(t){this.up.copy(t.up),this.target.copy(t.target),this.position.copy(t.position)},getStandardizedUp:function(){var e=new t.Vector3(0,0,0);return e.add(this.up),e.z=0,e.normalize(),e},compassClick:function(t){this.rotateClickOff||this.urban.getControl().faceNorth()},compassDblClick:function(t){this.urban.getControl().faceVerticalNorth()},drawCompass:function(){if(this.initialized){var t=this.getStandardizedUp();this.eye.copy(this.target).sub(this.position);var e=t.x<0?1:-1,i=this.eye.z>0,s=n.cleandot(t,this.refY),r=Math.acos(s)*e;i&&(r=Math.PI+r),s=n.cleandot(this.eye.normalize().negate(),this.refZ);var o=Math.acos(s);if(o!==this.verticalAngle||r!==this.northAngle){this.northAngle=r,this.verticalAngle=o;var a=document.getElementById("boussole_arrow");if(null===a)return;var h=n.toDeg(this.northAngle);h%=360;var l=n.toDeg(this.verticalAngle);if(l%=360,l=Math.max(0,Math.min(l,90-this.urban.getControl().getParams().guiTiltMin)),a.style.msTransform="rotateX("+l+"deg) rotateZ("+h+"deg)  ",a.style.webkitTransform="rotateX("+l+"deg) rotateZ("+h+"deg) ",a.style.transform="rotateX("+l+"deg) rotateZ("+h+"deg) ",null===(a=document.getElementById("boussole_circle")))return;a.style.msTransform="rotateX("+l+"deg) ",a.style.webkitTransform=" rotateX("+l+"deg) ",a.style.transform="rotateX("+l+"deg) "}}},panClick:function(e){if(!this.panClickOff){var i=e.target.getBoundingClientRect(),n=e.clientX-i.left,s=e.clientY-i.top,r=new t.Vector2(n,s),o=new t.Vector2(.5*e.target.clientWidth,.5*e.target.clientHeight);r.sub(o),r.multiplyScalar(-this.urban.getControl().getParams().guiPanFactor*this.urban.getControl().getParams().manipulationSpeedFactor),!0===e.shiftKey?this.shiftKey=!0:this.shiftKey=!1,!0===this.shiftKey&&r.multiplyScalar(this.urban.getControl().getParams().manipulationShiftSpeedFactor),this.urban.getControl().pan2d(r)}},panMouseDown:function(e){this.pan=!1,this.panClickOff=!1,this.pan=!0,this.panOrigin=new t.Vector2(this.getEventX(e),this.getEventY(e))},panMouseMove:function(e){if(!0===this.pan){var i=this._getEvent(e);i.preventDefault(),i.stopPropagation();var n=new t.Vector2(this.getEventX(i),this.getEventY(i));n.sub(this.panOrigin),n.length()>0&&(n.multiplyScalar(-this.urban.getControl().getParams().guiPanHoldFactor*this.urban.getControl().getParams().manipulationSpeedFactor),!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,!0===this.shiftKey&&n.multiplyScalar(this.urban.getControl().getParams().manipulationShiftSpeedFactor),this.currentPan.copy(n),this.panClickOff=!0)}},rotateMouseDown:function(e){this.rotate=!1,this.rotateClickOff=!1,this.rotate=!0,this.rotateOrigin=new t.Vector2(this.getEventX(e),this.getEventY(e)),this.verbose&&console.log("rotateOrigin",this.rotateOrigin)},rotateMouseMove:function(e){if(!0===this.rotate){var i=this._getEvent(e);i.preventDefault(),i.stopPropagation();var n=new t.Vector2(this.getEventX(i),this.getEventY(i));this.verbose&&console.log("rotateMouseMove",e.type,n,e.offsetX,e.offsetY,e.movementX,e.movementY),n.sub(this.rotateOrigin),n.length()>0&&(n.multiplyScalar(-this.urban.getControl().getParams().guiRotateHoldFactor*this.urban.getControl().getParams().manipulationSpeedFactor),!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,!0===this.shiftKey&&n.multiplyScalar(this.urban.getControl().getParams().manipulationShiftSpeedFactor),this.currentRotate.copy(n),this.rotateClickOff=!0)}},zoomPlusClick:function(e){var i=new t.Vector2(0);i.y+=1,i.multiplyScalar(this.urban.getControl().getParams().guiZoomFactor*this.urban.getControl().getParams().manipulationSpeedFactor),!0===e.shiftKey?this.shiftKey=!0:this.shiftKey=!1,!0===this.shiftKey&&i.multiplyScalar(this.urban.getControl().getParams().manipulationShiftSpeedFactor),this.urban.getControl().zoom2d(i)},zoomMoinsClick:function(e){var i=new t.Vector2(0);i.y-=1,i.multiplyScalar(this.urban.getControl().getParams().guiZoomFactor*this.urban.getControl().getParams().manipulationSpeedFactor),!0===e.shiftKey?this.shiftKey=!0:this.shiftKey=!1,!0===this.shiftKey&&i.multiplyScalar(this.urban.getControl().getParams().manipulationShiftSpeedFactor),this.urban.getControl().zoom2d(i)},zoomMouseDown:function(e){this.zoom=!1,this.zoomClickOff=!1,this.zoom=!0,this.zoomOrigin=new t.Vector2(this.getEventX(e),this.getEventY(e))},zoomMouseMove:function(e){if(!0===this.zoom){var i=this._getEvent(e);i.preventDefault(),i.stopPropagation();var n=new t.Vector2(this.getEventX(i),this.getEventY(i));n.sub(this.zoomOrigin),n.length()>0&&(!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,this.currentZoom.copy(n),this.zoomClickOff=!0)}},reset:function(){if(this.verbose&&console.log("reset"),this.initialized){var t=document.getElementById("boussole_circle_div"),e=document.getElementById("gui_pan_bg"),i=document.getElementById("gui_zoom_bg");t.ontouchmove=null,t.onmousemove=null,t.onpointermove=null,e.ontouchmove=null,e.onmousemove=null,e.onpointermove=null,i.ontouchmove=null,i.onmousemove=null,i.onpointermove=null,this.pan=!1,this.rotate=!1,this.zoom=!1,this.currentPan.set(0,0),this.currentRotate.set(0,0),this.currentZoom.set(0,0),this.shiftKey=!1}},mouseUp:function(t){this.verbose&&console.log("mouseup"),this.reset()},touchEnd:function(){this.verbose&&console.log("touchend"),this.reset()},drawPan:function(){if(this.initialized){!0===this.pan&&this.urban.getControl().pan2d(this.currentPan);var e=document.getElementById("gui_pan_arrows");if(null!==e){var i=Math.abs(this.urban.getControl().getParams().guiPanVisualOffset),n=new t.Vector2(0,0);n.copy(this.currentPan),n.length()>i?n.multiplyScalar(-i/n.length()):n.multiplyScalar(-1);var s=n.x,r=n.y;e.style.msTransform="translate("+s+"px,"+r+"px) ",e.style.webkitTransform="translate("+s+"px,"+r+"px) ",e.style.transform="translate("+s+"px,"+r+"px) "}}},drawRotate:function(){this.initialized&&!0===this.rotate&&this.urban.getControl().rotate2d(this.currentRotate)},drawZoom:function(){if(this.initialized){if(!0===this.zoom){var e=new t.Vector2(0,0);e.copy(this.currentZoom),e.multiplyScalar(-this.urban.getControl().getParams().guiZoomHoldFactor*this.urban.getControl().getParams().manipulationSpeedFactor),!0===this.shiftKey&&e.multiplyScalar(this.urban.getControl().getParams().manipulationShiftSpeedFactor),this.urban.getControl().zoom2d(e)}var i=document.getElementById("gui_zoom_slider");if(null!==i){var n=document.getElementById("gui_zoom_bg").clientHeight,s=i.clientHeight,r=Math.max(.5*n-.5*s,0);r+=Math.max(this.urban.getControl().getParams().guiZoomVisualOffset,0);var o=Math.min(r,Math.max(this.currentZoom.y,-r));i.style.msTransform="translate(0px,"+o+"px) ",i.style.webkitTransform=" translate(0px,"+o+"px) ",i.style.transform="translate(0px,"+o+"px) "}}},_getEvent:function(t){if(n.is(t.gesture)){var e=t.gesture.getEvents();if(n.is(e)&&e.length>0)return e[0].event}return t},getEventX:function(t){return n.is(t.touches)?t.touches[0].clientX:t.clientX},getEventY:function(t){return n.is(t.touches)?t.touches[0].clientY:t.clientY}})}),define("DS/UrbanManipulator/CameraAnimation",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/Animation/PropertyAnimation","DS/UrbanTool/Utils","DS/XCityTools/Debug"],function(t,e,i,n,s){"use strict";return e.extend({init:function(t,e,s,r){this.control=t,this.currentPath=e,this.updateCalls=0,this.animation=new i(this,"updateTime",e),this.name=s,this.runOnce=!0,this.stopped=!1,this.verbose=!1,n.is(r)&&(this.runOnce=r)},getKeyframes:function(){return this.currentPath.getKeyframes()},getCurrentKeyframe:function(){return this.currentPath.getCurrentKeyframe()},updateTime:function(t){!0===this.verbose&&s.log(t),this.animationTime=t;var e=this.getCurrentKeyframe();this.control.setKeyframe(e),this.updateCalls++},setPath:function(t){this.stop(),this.currentPath=t,this.animation.setPath(this.currentPath)},start:function(){this.updateCalls=0,this.lastStartTime=window.performance.now(),this.animation.start()},pause:function(){0===this.animation.state()&&this.animation.pause()},play:function(){this.stopped=!1,2===this.animation.state()?this.resume():this.start()},resume:function(){2===this.animation.state()&&this.animation.resume()},displayRuntime:function(){!0===this.verbose&&(s.log(" runtime "+this.lastRuntime),s.log(" calls "+this.updateCalls),s.log(" avg fps "+this.updateCalls/(this.lastRuntime/1e3)))},stop:function(){this.animation.stop(),this.lastRuntime=window.performance.now()-this.lastStartTime,this.displayRuntime()},isDone:function(){return!n.is(this.animation.state())||1===this.animation.state()},getKeyframe:function(t){return n.is(this.currentPath)?this.currentPath.getKeyframe(t):null},setKeyframe:function(t,e){return n.is(this.currentPath)?this.currentPath.setKeyframe(t,e):null},addKeyframe:function(t,e){return n.is(this.currentPath)?this.currentPath.addKeyframe(t,e):null},removeKeyframe:function(t){return n.is(this.currentPath)?this.currentPath.removeKeyframe(t):null},duration:function(){return n.is(this.currentPath)?this.currentPath.duration():0},size:function(){return n.is(this.currentPath)&n.is(this.currentPath.keyframes)?this.currentPath.keyframes.length:0},setTime:function(t){return t<=0?(this.animation.setTime(t),this.animation.stop()):(this.animation.start(),this.animation.pause(),this.animation.setTime(t)),this.animation.time()},setFrame:function(t,e){var i=(t-1)/e*1e3;return i=Math.max(0,i),this.setTime(i),this.animation.time()===i},goToKeyframe:function(t){var e=this.getKeyframe(t);return n.is(e)?(this.setTime(e.time),e):null},isRunning:function(){return!0!==this.stopped&&(this.isPlaying()||(this.stopped=!0),!0)},isPlaying:function(){return 0===this.animation.state()}})}),define("DS/UrbanFeature/Geometry",["DS/XCityModel/Item","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityTools/ShaderTools","DS/XCityRendering/RenderingHandlerGeometry","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/xCityPlatformUtils/xCityDocumentManagement","DS/xCityPlatformUtils/xCityPlatformIntegration","DS/xCityPlatformUtils/xCityCredentials","DS/XCityTools/RenderingTools","DS/UrbanFeature/Coordinate"],function(t,e,i,n,s,r,o,a,h,l,d,u){"use strict";var c=t.extend({defaults:{url:"",spec:null,scale:null,Coordinate:null,Shader:null,shadow:!0,extension:"",renderID:"",Rendering:null,objectId:"",fileId:"",serviceId:"",objectType:"",loadInfo:{loaded:1,total:1}},metaData:{type:"Geometry",className:"Geometry"},loaderJSON:{Shader:"loadJSONObject",spec:"loadJSONObject"},setup:function(){this._parent(),this._node=new i,this._node.name="geometryFeature",this.loaderJSON||(this.loaderJSON={}),this.addEvent("onChange:Coordinate",this._updateCoordinate,this)},destroy:function(t){t.getNode3D().remove(this._node),this._parent(t)},create:function(t){var e=this._parent(t);if(this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,!e)return!1;var i=t._urban;this._urban=i,this.renderingProfileManager=i.getRenderingProfileManager(),this._node.userData=this._itemParent,this._itemParentVisible(this._itemParent);var n;this._rendering=new s(i),this._rendering.addDefaultScaleFromAttributes("scale"),this._loaded=!1,this.renderingProfileManager.initRendering(this),this.getItemParent().get("visible")&&(n=this._loadModel(),r.is(n)&&(this._loaded=!0,this._initScale(n),this._node.addChild(n))),this._updateGeometryTags(),t.getNode3D().add(this._node)},_updateGeoloc:function(){var t=this;h.retrieveModelGeolocAttributes(h.url3DSpace,this.get("objectId"),l.preferredCredentials).then(function(i){var n=h.getCoordinateFromGeoloc(i),s=n.position;s=new e.Vector3(s[0],s[1],s[2]);var o=n.rotation,a=new e.Vector3(o[0],o[1],o[2]),l=t.get("Coordinate");if(l){n.projection,n.shifted,n.altitudeMode;var d=l.get("initialOffset");r.is(d)?d.equals(s)||(d.equals(l.get("position"))&&l.set("position",s.clone()),l.set("initialOffset",s.clone())):l.set("initialOffset",s.clone());var c=l.get("initialRotation");r.is(c)?c.equals(a)||(c.equals(l.get("rotation"))&&l.set("rotation",a.clone()),l.set("initialRotation",a.clone())):l.set("initialRotation",a.clone())}else n.position=s.clone(),n.rotation=a.clone(),l=new u(n),t.set("Coordinate",l)})},_loadModel:function(){var t,e=this.get("objectType"),i=this;if("Document"!==e&&""!==e)""!==this.get("objectId")&&(this._updateGeoloc(),t=this._urban.modelLoader.load({spec:{provider:"EV6",serverurl:h.url3DSpace,tenant:h.getTenantId(),dtype:e,requiredAuth:"passport",physicalid:this.get("objectId")},rendering:this._rendering},this.modelLoaded.bind(this),this.modelProgressed.bind(this)));else if(""!==this.get("objectId")&&""!==this.get("fileId")){var n=this.get("serviceId");""!==n&&null!=n||(n="3DSpace"),a.retrieveDocumentUrl(this.get("objectId"),this.get("fileId"),n).then(function(e){var n=i.get("extension");t="3dxc"===n||"3dx"===n||"dae"===n?i._urban.modelLoader.load({url:e,extension:i.get("extension"),shader:i.get("Shader"),shadow:i.get("shadow"),rendering:i._rendering},i.modelLoaded.bind(i),i.modelProgressed.bind(i)):i._urban.modelLoader.load({spec:{provider:"FILE",tenant:h.getTenantId(),filename:e,url:e,requestsOptions:{authentication:"passport",proxy:"none",method:"POST"},format:i.get("extension")},rendering:i._rendering},i.modelLoaded.bind(i),i.modelProgressed.bind(i)),r.is(t)&&(i._loaded=!0,i._initScale(t),i._node.addChild(t))})}else""!==this.get("url")?t=this._urban.modelLoader.load({url:this.get("url"),extension:this.get("extension"),shader:this.get("Shader"),shadow:this.get("shadow"),rendering:this._rendering},this.modelLoaded.bind(this),this.modelProgressed.bind(this)):null!==this.get("spec")&&(t=this._urban.modelLoader.load({spec:this.get("spec"),scale:this.get("scale"),rendering:this._rendering},this.modelLoaded.bind(this),this.modelProgressed.bind(this)));return t},redraw:function(){var t=this.getRendering();r.is(t)&&t.updateSpecificRendering()},modelLoaded:function(t,e){if(o.publish(o.eventsList.onLoaded+":"+this.get("id"),{success:e,item:this.getItemParent()}),!1===e)this.set("loadInfo",{loaded:1,total:1,success:!1});else{var i=this.get("loadInfo"),n={loaded:i.total,total:i.total};this.set("loadInfo",n)}this._itemParent.get("selected")&&this._urban.USR.setRobotTarget(this._itemParent,!0)},_isModelInMillimeters:function(t,e,i){return!(!t.name||!t.name.includes(".3dxml")&&!t.name.includes(".cgr"))||(!(!e||"Document"===e||""===e)||!!i)},_initScale:function(t){var i=this._rendering.getCompleteMaterialInfo(this.id,this._attributes).scale,n=new e.Vector3(0,0,0);if(i.equals(n)){if(this._isModelInMillimeters(t.name,this.get("objectType"),this.get("spec"))){o=d._initVector3(.001);this.setScale(t,o),(s=this._attributes.Coordinate._scale)&&!r.is(t.parents[0])&&this.applyScale(t,d._initVector3(s))}}else{var s,o=i;this.setScale(t,o),(s=this._attributes.Coordinate._scale)&&!r.is(t.parents[0])&&this.applyScale(t,d._initVector3(s))}this._rendering.currentRendering.renderingData.scale=o||d._initVector3(1)},setScale:function(t,i){if(t._matrix){var n=i.x/t._matrix.elements[0],s=i.y/t._matrix.elements[5],r=i.z/t._matrix.elements[10],o=new e.Vector3(n,s,r);t.setMatrix(t.getMatrix().scale(o))}else t.setMatrix((new e.Matrix4).makeScale(i.x,i.y,i.z))},applyScale:function(t,i){t._matrix?t.setMatrix(t.getMatrix().scale(i)):t.setMatrix((new e.Matrix4).makeScale(i.x,i.y,i.z))},modelProgressed:function(t){this.set("loadInfo",t)},getLocalPosition:function(){var t=this._node.getBoundingSphere().center;return this.get("Coordinate")&&t.add(this.get("Coordinate").getLocalPosition()),t},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},_updateCoordinate:function(){var t=this.previous("Coordinate");t&&t.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")&&(this.get("Coordinate").setItemParent(this),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this))},setColor:function(t){return!t||t instanceof e.Color||(t=new e.Color(t)),void 0===t&&(t=new e.Color),this.renderingProfile&&this.renderingProfileManager.addRendering(this.parentFeatureID,{color:t,ambient:t}),this},removeColor:function(){return void 0!==this._node&&void 0!==this.get("color")&&this.setColor(void 0),this},setOpacity:function(t){return this.opacity=t,this.renderingProfile&&this.renderingProfileManager.addRendering(this.parentFeatureID,{opacity:t}),this},_setMeshColor:function(t,e){var i=e.mesh3js,s=i.material,o=i.geometry;if(void 0!==s){var a=!1;if(r.is(o)&&o.length>0&&(o=o[0],r.is(o.drawingGroups)&&o.drawingGroups.length>0))for(var h=0;h<o.drawingGroups.length;h++)o.drawingGroups[h].gas.color=t,a=!0,n.updateCommonUniforms(o.drawingGroups[h].gas);a||(s.color=t,n.updateCommonUniforms(s)),e.setMaterial(s)}else void 0!==o&&o.faces&&this._setGeometryColor(t,o,0,o.faces.length,s)},_setGeometryColor:function(t,i,n,s,r){void 0===r||r.vertexColors!==e.VertexColors?this._setFaceColors(i,t,n,s):this._setVertexColors(i,t,n,s)},_setFaceColors:function(t,e,i,n){for(var s=t.faces,r=0;r<n;r++)s[i+r].color=e;t.colorsNeedUpdate=!0},_setVertexColors:function(t,e,i,n){for(var s=t.faces,r=0;r<n;r++){var o=s[i+r].vertexColors;s[i+r].color&&(s[i+r].color=e);for(var a=o.length,h=0;h<a;h++)o[h]=e}t.colorsNeedUpdate=!0},_itemParentVisible:function(t){if(this._created){if(t.get("visible")&&!1===this._loaded){var e=this._loadModel();r.is(e)&&(this._loaded=!0,this._initScale(e),this._node.addChild(e))}this._node.setVisibility(t.get("visible"))}},setItemParent:function(t){this._itemParent&&(this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._itemParent.removeEvent("onChange:tags",this._updateGeometryTags,this)),this._parent(t),this._itemParent&&(this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this),this._itemParent.addEvent("onChange:tags",this._updateGeometryTags,this))},_updateMatrix:function(t){this._node.setMatrix(t)},_updateGeometryTags:function(){if(void 0!==this._itemParent&&void 0!==this._node){var t=this._itemParent.get("tags");t&&-1!==t.indexOf("UNDERGROUND")?this._node.setRenderPasses(["UNDERGROUND_PREPASS","UNDERGROUND_POSTPASS"]):this._node.setRenderPasses(["main"]),o.publish("/xCity/needRender",this)}},getRendering:function(){return this._rendering},get:function(t){var e,i,n=this.getRendering();return this.renderingProfileManager&&r.is(n)&&n.hasAttribute(t)?(i=this.getMaterial(),r.is(i)&&(e=i[t],"scale"===t&&e.x&&(e=[e.x,e.y,e.z]))):e=this._parent(t),e},set:function(t,e){var i={},n=this.getRendering();this.renderingProfileManager&&r.is(n)&&n.hasAttribute(t)?(i[t]=e,this.setMaterial(i)):this._parent(t,e)},setMaterial:function(t){if(t.scale)for(var e in this._node.children)this.setScale(this._node.children[e],d._initVector3(t.scale));return this.renderingProfileManager.addRendering(this.parentFeatureID,t),this},getMaterial:function(){var t=this.getRendering();return r.is(t)?t.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)}});return t.ObjectContructor.Model=t.ObjectContructor.Geometry=c}),define("DS/UrbanFeature/PointOfView",["UWA/Core","DS/UrbanFeature/Coordinate","DS/XCityModel/Item","DS/Visualization/ThreeJS_DS"],function(t,e,i,n){"use strict";var s=e.extend({defaults:t.merge({length:100,thumbnail:""},e.defaults),metaData:{type:"Location",className:"PointOfView"}});return i.ObjectContructor.PointOfView=s}),define("DS/UrbanManipulator/QuaternionSpline",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/UrbanTool/Utils","DS/XCityTools/Debug"],function(t,e,i,n){"use strict";var s=e.extend({init:function(t){if(this.quaternions=[],this.verbose=null,this.extra=!1,i.is(t)&&t.length>0){if(!0===this.extra){this.quaternions[0]=t[0].normalize().clone();for(var e=0,n=t.length;e<n;e++)this.quaternions[e+1]=t[e].normalize().clone();this.quaternions[t.length+1]=t[t.length-1].normalize().clone()}else this.quaternions=t;this._normalize(this.quaternions);var s=[];s.push(this.quaternions[0].clone());for(e=1,n=this.quaternions.length-1;e<n;e++)s.push(this._quadrangle(this.quaternions[e-1],this.quaternions[e],this.quaternions[e+1]));s.push(this.quaternions[this.quaternions.length-1].clone()),this.quadrangles=s}},correctQuat:function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w<=0&&((t=t.set(-t.x,-t.y,-t.z,-t.w)).normalize(),!0===this.verbose&&n.log("correction quat00")),t},_slerpNoInvert:function(e,i,n){var s=n,r=new t.Quaternion,o=e.x,a=e.y,h=e.z,l=e.w,d=l*i.w+o*i.x+a*i.y+h*i.z;if(d<0||r.copy(i),d>=1)return r.w=l,r.x=o,r.y=a,r.z=h,r;var u=Math.acos(d),c=Math.sqrt(1-d*d);if(Math.abs(c)<.001)return r.w=.5*(l+r.w),r.x=.5*(o+r.x),r.y=.5*(a+r.y),r.z=.5*(h+r.z),r;var g=Math.sin((1-s)*u)/c,m=Math.sin(s*u)/c;return r.w=l*g+r.w*m,r.x=o*g+r.x*m,r.y=a*g+r.y*m,r.z=h*g+r.z*m,r.normalize()},slerpQuat:function(t,e,i){t.normalize(),e.normalize();var s=t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w;return s<=0&&((t=t.clone().set(-t.x,-t.y,-t.z,-t.w)).normalize(),s=t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w,!0===this.verbose&&n.log("correction quat")),this._slerpNoInvert(t.clone(),e.clone(),i).normalize()},_normalize:function(t){var e=0;for(e=0;e<t.length;e++)t[e]=t[e].normalize();for(e=t.length-1;e>0;e--)t[e-1]=this.correctQuat(t[e-1],t[e])},clone:function(){return new s(this.quaternions)},_add:function(e,i){return new t.Quaternion(e.x+i.x,e.y+i.y,e.z+i.z,e.w+i.w)},_factor:function(e,i){return new t.Quaternion(e*i.x,e*i.y,e*i.z,e*i.w)},_log:function(e){var i=Math.acos(e.w),n=Math.sin(i);if(0===n)return new t.Quaternion(0,0,0,0);var s=i/n;return new t.Quaternion(s*e.x,s*e.y,s*e.z,0)},_exp:function(e){var i=e.length();if(0===i)return new t.Quaternion(0,0,0,1);var n=Math.cos(i),s=Math.sin(i)/i;return new t.Quaternion(s*e.x,s*e.y,s*e.z,n)},_quadrangle:function(e,i,n){var s=i.clone().inverse();s.multiply(n);var r=i.clone().inverse();r.multiply(e);var o=this._factor(-.25,this._add(this._log(s),this._log(r)));return(new t.Quaternion).copy(i).multiply(this._exp(o)).normalize()},_squad:function(t,e,i,n,s){var r=this._slerpNoInvert(t,n,s),o=this._slerpNoInvert(e,i,s),a=2*s*(1-s);return this._slerpNoInvert(r,o,a)},squads:function(t){var e,s,r,o=this.quaternions,a=this.quadrangles;if(1===t)return this.quaternions[this.quaternions.length-1].clone();if(0===t)return this.quaternions[0].clone();s=t*(a.length-1),!0===this.extra&&(s=t*(a.length-3)+1),r=s-(e=Math.floor(s));var h=a[e],l=a[e+1],d=o[e],u=o[e+1],c=this._squad(d,h,l,u,r);return!0===this.verbose&&n.log(" squad "+e+" "+s+" "+t+i.displayVector(c)),c},getAt:function(t){var e=t;return this.squads(e)}});return s}),define("DS/UrbanManipulator/AnimationPath",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/Animation/PropertyAnimation","DS/Animation/AnimationPath","DS/UrbanManipulator/Keyframe","DS/UrbanTool/Utils","DS/UrbanManipulator/QuaternionSpline","DS/XCityTools/Debug"],function(t,e,i,n,s,r,o,a){"use strict";return e.extend({init:function(t){var e;for(e in this.verbose=null,this.spheric=!1,this.speedAdjust=!0,this.splineInterpolate=!0,this.keyframes=[],this.currentKeyframe=null,this.lastKeyframeIndex=-1,this.valuation=0,t)t.hasOwnProperty(e)&&(this[e]=t[e])},duration:function(){return this.keyframes.length>0?this.keyframes[this.keyframes.length-1].time-this.keyframes[0].time:0},valueAt:function(t){return this.valuation++,this.updateKeyframeIndex(t),t},reset:function(){this.start=0,this.end=this.start,this.keyframes.length>0&&(this.start=this.keyframes[0].time,this.end=this.keyframes[this.keyframes.length-1].time),this.removeSplines()},addKeyframe:function(t,e){!r.is(e)||e<0||e>=this.keyframes.length?this.keyframes[this.keyframes.length]=t:this.keyframes.splice(e,0,t),this.reset()},removeKeyframe:function(t){!r.is(t)||t<0||t>=this.keyframes.length||(this.keyframes.splice(t,1),this.reset())},setKeyframe:function(t,e){return r.is(t)?e<0?null:e>=this.keyframes.length?null:(this.keyframes[e]=t,void this.reset()):null},getKeyframes:function(){var t=0,e=[];for(t=0;t<this.keyframes.length;t++)e[t]=this.keyframes[t].clone();return e},getKeyframe:function(t){return t<0?null:t>=this.keyframes.length?null:this.keyframes[t].clone()},removeSplines:function(){this.currentPositionSpline=null,this.currentTimeSpline=null,this.currentQuaternionSpline=null,this.currentTargetSpline=null,this.dateSpline=null},createAndAddKeyframe:function(t){var e=new s(t);this.addKeyframe(e)},getCurrentKeyframe:function(){if(this.keyframes.length<=1)return null;if(!r.is(this.lastKeyframeIndex))return a.log(" inconsistent time path"),null;r.is(this.currentPositionSpline)||this.initSplines();var t=Math.floor(this.lastKeyframeIndex),e=Math.ceil(this.lastKeyframeIndex);if(t<0||e>=this.keyframes.length)return null;var i=this.lastKeyframeIndex-Math.floor(this.lastKeyframeIndex);r.is(this.curving)&&(i=this.curving(i));var n=this.keyframes[t],s=this.keyframes[e];return!0===this.verbose&&a.log("time "+this.currentTime+" "+this.lastKeyframeIndex+" "+t+" "+e+" "+i),this.interpol(n,s,i)},interpolPosition:function(e,i){var n,s,r,o;n=Math.floor(e),s=Math.min(n+1,this.keyframes.length-1),o=Math.min(s+1,this.keyframes.length-1),r=Math.max(n-1,0),n=this.frameToSpline[n],s=this.frameToSpline[s],r=this.frameToSpline[r],o=this.frameToSpline[o];var a=[];a[0]=this.keyframes[r].position.clone(),a[1]=this.keyframes[n].position.clone(),a[2]=this.keyframes[s].position.clone(),a[3]=this.keyframes[o].position.clone();var h=a[0].clone(),l=a[1].distanceTo(a[2]),d=.5*a[0].distanceTo(a[1]);if(d>l){var u=l/d;h=a[1].clone().add(a[0].clone().sub(a[1]).multiplyScalar(u))}var c=a[3].clone(),g=.5*a[3].distanceTo(a[2]);if(g>l){u=l/g;c=a[2].clone().add(a[3].clone().sub(a[2]).multiplyScalar(u))}a[0]=h,a[3]=c;var m=new t.Vector3,f=i;return m.x=t.Curve.Utils.interpolate(a[0].x,a[1].x,a[2].x,a[3].x,f),m.y=t.Curve.Utils.interpolate(a[0].y,a[1].y,a[2].y,a[3].y,f),m.z=t.Curve.Utils.interpolate(a[0].z,a[1].z,a[2].z,a[3].z,f),m},interpolQuaternion:function(t,e){var i,n,s,r;i=Math.floor(t),n=Math.min(i+1,this.keyframes.length-1),r=Math.min(n+1,this.keyframes.length-1),s=Math.max(i-1,0);var a=new o([]),h=this.keyframes[i].getQuaternion(),l=this.keyframes[n].getQuaternion(),d=this.keyframes[s].getQuaternion(),u=this.keyframes[r].getQuaternion();return d=a._quadrangle(d,h,l),u=a._quadrangle(h,l,u),a._squad(h,d,u,l,e)},interpol:function(t,e,i){var n=null;if(!0===this.splineInterpolate){var s=0;if(this.lastKeyframeIndex>=this.keyframes.length-1)s=1;else{var o=this.frameToSpline[Math.floor(this.lastKeyframeIndex)],h=this.frameToSpline[Math.floor(this.lastKeyframeIndex)+1];if((l=this.positions.length-1)>0)s=(o/=l)+((h/=l)-o)*(this.lastKeyframeIndex-Math.floor(this.lastKeyframeIndex));else s=0}n=t.interpol(e,i,this.currentPositionSpline.getPoint(s));if(this.lastKeyframeIndex>=this.keyframes.length-1)1;else{var l;o=this.quatToSpline[Math.floor(this.lastKeyframeIndex)],h=this.quatToSpline[Math.floor(this.lastKeyframeIndex)+1];if((l=this.quats.length-1)>0)(o/=l)+((h/=l)-o)*(this.lastKeyframeIndex-Math.floor(this.lastKeyframeIndex));else 0}if(!0===this.verbose&&a.log(" quat "+s+"  "+r.displayVector(this.keyframes[Math.floor(this.lastKeyframeIndex)].quaternion)+"  "+r.displayVector(n.quaternion)),r.is(this.dateSpline)){var d=Math.floor(this.lastKeyframeIndex),u=Math.min(this.keyframes.length-1,d+1);n.date=n.lerpTime(this.dateSpline[d],this.dateSpline[u],i)}}else n=t.interpol(e,i);return!0===this.verbose&&a.log(n._up.x+" "+n._up.y+" "+n._up.z," "+n.position.length()),n},fadein:function(t){return 1-Math.cos(t*Math.PI/2)},fadeout:function(t){return Math.sin(t*Math.PI/2)},fadeinout:function(t){return.5*(1-Math.cos(Math.PI*t))},easing:function(t,e){var i=t;return 2===this.keyframes.length?i=this.fadeinout(this.fadeinout(t)):0===e?i=this.fadein(this.fadein(t)):e>=this.keyframes.length-2&&(i=this.fadeout(this.fadeout(t))),i=Math.max(0,i),i=Math.min(1,i)},updateKeyframeIndex:function(t){if(r.is(this.keyframes))if(this.lasttime=this.currentTime,this.currentTime=t,this.keyframes.length<=1)this.lastKeyframeIndex=0;else if(0!==t){r.is(this.currentTimeSpline)||this.initSplines();var e=0;for(e=0;e<this.keyframes.length&&!(this.keyframes[e].time>=t);e++);if(e>=this.keyframes.length)return!0===this.verbose&&a.log("time superior to end of path !"),void(this.lastKeyframeIndex=this.keyframes.length-1);var i=Math.max(e-1,0),n=this.keyframes[e].time-this.keyframes[i].time,s=t-this.keyframes[i].time;if(0===n)return!0===this.verbose&&a.log("2 keyframes for a same time "),void(this.lastKeyframeIndex=null);s/=n,!1===this.verbose&&a.log((t-this.lasttime)/(i+s-this.lastKeyframeIndex)+" ");var o=this.easing(s,i);this.lastKeyframeIndex=i+o}else this.lastKeyframeIndex=0},getPositionSpline:function(){return r.is(this.currentPositionSpline)||this.initSplines(),this.currentPositionSpline},initSplines:function(){if(!(this.keyframes.length<=1)){var e,i,n=[],s=[],h=0,l=0,d=0,u=0,c=0;this.frameToSpline=[],this.quatToSpline=[];var g=[],m=[],f=[],p=[],v=[],_=[];for(e=0;e<this.keyframes.length;e++){if(!0===this.fadeRotation&&(this.keyframes[e].fadeOn=!0),!0===this.targetInterpol&&!r.is(this.keyframes[e]._target)){var b=this.keyframes[e]._eye.clone().setLength(this.keyframes[e].position.z);this.keyframes[e]._target=this.keyframes[e].position.clone().add(b)}this.keyframes[e].time<c&&a.log(" error Time is not strictly increasing in the path "),r.is(n[h-1])&&this.keyframes[e].position.equals(n[h-1])||(n[h]=this.keyframes[e].position.clone(),m[h]=n[h].clone(),m[h].z=n[h].length(),h++),this.frameToSpline[e]=h-1,i=this.keyframes[e].time-c,v[e]=i/this.end,s[e]=new t.Vector3(this.keyframes[e].time/this.end,e,i/this.end),c=this.keyframes[e].time,r.is(this.keyframes[e].date)&&(_[u]=e,u++),f[e]=new t.Vector2(this.keyframes[e].time/this.end,e/(this.keyframes.length-1));var y=this.keyframes[e].target;r.is(y)&&(p[l]=y,l++),r.is(g[d-1])&&this.keyframes[e].quaternion.equals(g[d-1])||(g[d]=this.keyframes[e].quaternion.clone(),d++),this.quatToSpline[e]=d-1}!0===this.bezierSpline?(this.currentPositionSpline=new t.CubicBezierCurve3(n[0],n[1],n[2],n[3]),this.keyframes[1].position=this.currentPositionSpline.getPoint(1/3),this.keyframes[2].position=this.currentPositionSpline.getPoint(2/3),this.keyframes[1].initQuat2(),this.keyframes[2].initQuat2()):this.currentPositionSpline=new t.SplineCurve3(n),this.positions=n,p.length===this.keyframes.length&&(this.currentTargetSpline=new t.SplineCurve3(p)),this.currentAtitudeSpline=new t.SplineCurve3(m),this.currenttestspline=new t.SplineCurve(f);var w=n.length-1;for(e=0;e<this.keyframes.length;e++)w<=0&&(this.frameToSpline[e]=0);this.currentTimeSpline=s,this.quats=g,this.currentQuaternionSpline=new o(g)}},timeAdjust:function(){}})}),define("DS/UrbanManipulator/CameraAnimationPath",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/Animation/PropertyAnimation","DS/Animation/AnimationPath","DS/UrbanManipulator/Keyframe","DS/UrbanTool/Utils","DS/UrbanManipulator/QuaternionSpline","DS/XCityTools/Debug"],function(t,e,i,n,s,r,o,a){"use strict";return e.extend({init:function(t){var e;for(e in this.verbose=null,this.spheric=!1,this.speedAdjust=!0,this.splineInterpolate=!0,this.keyframes=[],this.currentKeyframe=null,this.lastKeyframeIndex=-1,this.valuation=0,t)t.hasOwnProperty(e)&&(this[e]=t[e])},duration:function(){return this.keyframes.length>0?this.keyframes[this.keyframes.length-1].time-this.keyframes[0].time:0},valueAt:function(t){return this.valuation++,this.updateKeyframeIndex(t),t},reset:function(){this.start=0,this.end=this.start,this.keyframes.length>0&&(this.start=this.keyframes[0].time,this.end=this.keyframes[this.keyframes.length-1].time),this.removeSplines()},addKeyframe:function(t,e){!r.is(e)||e<0||e>=this.keyframes.length?this.keyframes[this.keyframes.length]=t:this.keyframes.splice(e,0,t),this.reset()},removeKeyframe:function(t){!r.is(t)||t<0||t>=this.keyframes.length||(this.keyframes.splice(t,1),this.reset())},setKeyframe:function(t,e){return r.is(t)?e<0?null:e>=this.keyframes.length?null:(this.keyframes[e]=t,void this.reset()):null},getKeyframes:function(){var t=0,e=[];for(t=0;t<this.keyframes.length;t++)e[t]=this.keyframes[t].clone();return e},getKeyframe:function(t){return t<0?null:t>=this.keyframes.length?null:this.keyframes[t].clone()},removeSplines:function(){this.currentPositionSpline=null,this.currentTimeSpline=null,this.currentQuaternionSpline=null,this.currentTargetSpline=null,this.dateSpline=null},createAndAddKeyframe:function(t){var e=new s(t);this.addKeyframe(e)},getCurrentKeyframe:function(){if(this.keyframes.length<=1)return null;if(!r.is(this.lastKeyframeIndex))return a.log(" inconsistent time path"),null;r.is(this.currentPositionSpline)||this.initSplines();var t=Math.floor(this.lastKeyframeIndex),e=Math.ceil(this.lastKeyframeIndex);if(t<0||e>=this.keyframes.length)return null;var i=this.lastKeyframeIndex-Math.floor(this.lastKeyframeIndex);r.is(this.curving)&&(i=this.curving(i));var n=this.keyframes[t],s=this.keyframes[e];return!0===this.verbose&&a.log("time "+this.currentTime+" "+this.lastKeyframeIndex+" "+t+" "+e+" "+i),this.interpol(n,s,i)},interpolPosition:function(e,i){var n,s,r,o;n=Math.floor(e),s=Math.min(n+1,this.keyframes.length-1),o=Math.min(s+1,this.keyframes.length-1),r=Math.max(n-1,0),n=this.frameToSpline[n],s=this.frameToSpline[s],r=this.frameToSpline[r],o=this.frameToSpline[o];var a=[];a[0]=this.keyframes[r].position.clone(),a[1]=this.keyframes[n].position.clone(),a[2]=this.keyframes[s].position.clone(),a[3]=this.keyframes[o].position.clone();var h=a[0].clone(),l=a[1].distanceTo(a[2]),d=.5*a[0].distanceTo(a[1]);if(d>l){var u=l/d;h=a[1].clone().add(a[0].clone().sub(a[1]).multiplyScalar(u))}var c=a[3].clone(),g=.5*a[3].distanceTo(a[2]);if(g>l){u=l/g;c=a[2].clone().add(a[3].clone().sub(a[2]).multiplyScalar(u))}a[0]=h,a[3]=c;var m=new t.Vector3,f=i;return m.x=t.Curve.Utils.interpolate(a[0].x,a[1].x,a[2].x,a[3].x,f),m.y=t.Curve.Utils.interpolate(a[0].y,a[1].y,a[2].y,a[3].y,f),m.z=t.Curve.Utils.interpolate(a[0].z,a[1].z,a[2].z,a[3].z,f),m},interpolQuaternion:function(t,e){var i,n,s,r;i=Math.floor(t),n=Math.min(i+1,this.keyframes.length-1),r=Math.min(n+1,this.keyframes.length-1),s=Math.max(i-1,0);var a=new o([]),h=this.keyframes[i].getQuaternion(),l=this.keyframes[n].getQuaternion(),d=this.keyframes[s].getQuaternion(),u=this.keyframes[r].getQuaternion();return d=a._quadrangle(d,h,l),u=a._quadrangle(h,l,u),a._squad(h,d,u,l,e)},interpol:function(t,e,i){var n=null;if(!0===this.splineInterpolate){var s=0;if(this.lastKeyframeIndex>=this.keyframes.length-1)s=1;else{var o=this.frameToSpline[Math.floor(this.lastKeyframeIndex)],h=this.frameToSpline[Math.floor(this.lastKeyframeIndex)+1];if((l=this.positions.length-1)>0)s=(o/=l)+((h/=l)-o)*(this.lastKeyframeIndex-Math.floor(this.lastKeyframeIndex));else s=0}n=t.interpol(e,i,this.currentPositionSpline.getPoint(s));if(this.lastKeyframeIndex>=this.keyframes.length-1)1;else{var l;o=this.quatToSpline[Math.floor(this.lastKeyframeIndex)],h=this.quatToSpline[Math.floor(this.lastKeyframeIndex)+1];if((l=this.quats.length-1)>0)(o/=l)+((h/=l)-o)*(this.lastKeyframeIndex-Math.floor(this.lastKeyframeIndex));else 0}if(!0===this.verbose&&a.log(" quat "+s+"  "+r.displayVector(this.keyframes[Math.floor(this.lastKeyframeIndex)].quaternion)+"  "+r.displayVector(n.quaternion)),r.is(this.dateSpline)){var d=Math.floor(this.lastKeyframeIndex),u=Math.min(this.keyframes.length-1,d+1);n.date=n.lerpTime(this.dateSpline[d],this.dateSpline[u],i)}}else n=t.interpol(e,i);return!0===this.verbose&&a.log(n._up.x+" "+n._up.y+" "+n._up.z," "+n.position.length()),n},fadein:function(t){return 1-Math.cos(t*Math.PI/2)},fadeout:function(t){return Math.sin(t*Math.PI/2)},fadeinout:function(t){return.5*(1-Math.cos(Math.PI*t))},easing:function(t,e){var i=t;return 2===this.keyframes.length?i=this.fadeinout(this.fadeinout(t)):0===e?i=this.fadein(this.fadein(t)):e>=this.keyframes.length-2&&(i=this.fadeout(this.fadeout(t))),i=Math.max(0,i),i=Math.min(1,i)},updateKeyframeIndex:function(t){if(r.is(this.keyframes))if(this.lasttime=this.currentTime,this.currentTime=t,this.keyframes.length<=1)this.lastKeyframeIndex=0;else if(0!==t){r.is(this.currentTimeSpline)||this.initSplines();var e=0;for(e=0;e<this.keyframes.length&&!(this.keyframes[e].time>=t);e++);if(e>=this.keyframes.length)return!0===this.verbose&&a.log("time superior to end of path !"),void(this.lastKeyframeIndex=this.keyframes.length-1);var i=Math.max(e-1,0),n=this.keyframes[e].time-this.keyframes[i].time,s=t-this.keyframes[i].time;if(0===n)return!0===this.verbose&&a.log("2 keyframes for a same time "),void(this.lastKeyframeIndex=null);s/=n,!1===this.verbose&&a.log((t-this.lasttime)/(i+s-this.lastKeyframeIndex)+" ");var o=this.easing(s,i);this.lastKeyframeIndex=i+o}else this.lastKeyframeIndex=0},getPositionSpline:function(){return r.is(this.currentPositionSpline)||this.initSplines(),this.currentPositionSpline},initSplines:function(){if(!(this.keyframes.length<=1)){var e,i,n=[],s=[],h=0,l=0,d=0,u=0,c=0;this.frameToSpline=[],this.quatToSpline=[];var g=[],m=[],f=[],p=[],v=[],_=[];for(e=0;e<this.keyframes.length;e++){if(!0===this.fadeRotation&&(this.keyframes[e].fadeOn=!0),!0===this.targetInterpol&&!r.is(this.keyframes[e]._target)){var b=this.keyframes[e]._eye.clone().setLength(this.keyframes[e].position.z);this.keyframes[e]._target=this.keyframes[e].position.clone().add(b)}this.keyframes[e].time<c&&a.log(" error Time is not strictly increasing in the path "),r.is(n[h-1])&&this.keyframes[e].position.equals(n[h-1])||(n[h]=this.keyframes[e].position.clone(),m[h]=n[h].clone(),m[h].z=n[h].length(),h++),this.frameToSpline[e]=h-1,i=this.keyframes[e].time-c,v[e]=i/this.end,s[e]=new t.Vector3(this.keyframes[e].time/this.end,e,i/this.end),c=this.keyframes[e].time,r.is(this.keyframes[e].date)&&(_[u]=e,u++),f[e]=new t.Vector2(this.keyframes[e].time/this.end,e/(this.keyframes.length-1));var y=this.keyframes[e].target;r.is(y)&&(p[l]=y,l++),r.is(g[d-1])&&this.keyframes[e].quaternion.equals(g[d-1])||(g[d]=this.keyframes[e].quaternion.clone(),d++),this.quatToSpline[e]=d-1}!0===this.bezierSpline?(this.currentPositionSpline=new t.CubicBezierCurve3(n[0],n[1],n[2],n[3]),this.keyframes[1].position=this.currentPositionSpline.getPoint(1/3),this.keyframes[2].position=this.currentPositionSpline.getPoint(2/3),this.keyframes[1].initQuat2(),this.keyframes[2].initQuat2()):this.currentPositionSpline=new t.SplineCurve3(n),this.positions=n,p.length===this.keyframes.length&&(this.currentTargetSpline=new t.SplineCurve3(p)),this.currentAtitudeSpline=new t.SplineCurve3(m),this.currenttestspline=new t.SplineCurve(f);var w=n.length-1;for(e=0;e<this.keyframes.length;e++)w<=0&&(this.frameToSpline[e]=0);this.currentTimeSpline=s,this.quats=g,this.currentQuaternionSpline=new o(g)}},timeAdjust:function(){}})}),define("DS/UrbanManipulator/Manipulator",["UWA/Class/Events","DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","DS/UrbanManipulator/ManipulatorParams","DS/UrbanManipulator/LocalisationManipulator","DS/UrbanManipulator/CameraAnimation","DS/UrbanManipulator/CameraAnimationPath","DS/UrbanManipulator/Keyframe","UWA/Class","DS/UrbanTool/Utils","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Debug","DS/WebappsUtils/WebappsUtils","DS/Visualization/PathElement","DS/XCityTools/Geocoder","DS/XCityModel/LayerVectorCluster"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g,m,f,p){"use strict";return h.extend(t,{init:function(t,i,s,r){if(this.urban=t,this.domElement=s,this.viewpoint=i,l.is(r)?this.params=r:this.params=new n,this.firstcall=!0,this.still=-1,this.lastPosition=null,this.currentSpeed=null,this.enabled=!0,this.checkH=!1,this.temp2=new e.Vector2,this.temp3=new e.Vector3,this.vertical=new e.Vector3(0,0,1),this.position=new e.Vector3,this.target=new e.Vector3,this.up=new e.Vector3,this.eye=new e.Vector3,this.distanceToTarget=19e3,this.currentQuaternion=new e.Quaternion,this.orientation=new e.Quaternion,this.currenteye=new e.Vector3,this.currentup=new e.Vector3,this._currentDir=new e.Vector3,this.dir=[],this.lastRotation=new e.Vector2,l.is(i.initQuaternion))this.position=i.camera.position,this.currentQuaternion=i.initQuaternion.clone(),this.updateBase(),this.target.copy(this.position),this.eye.setLength(this.getAltitude()),this.target.add(this.eye),this.eye.normalize(),this.updateViewpoint();else{this.currenteye.copy(i.target).sub(i.camera.position);var o=l.getQuaternionBetween(l.refX.clone(),this.currenteye);l.is(o)&&(this.currentQuaternion=o,this.updateBase())}this.terrainHeight=0,this.currentState=this.params.STATE.NONE,this.prevState=this.params.STATE.NONE,this.screen={width:0,height:0,offsetLeft:0,offsetTop:0},this.radius=(this.screen.width+this.screen.height)/4,this.mouseChange=new e.Vector2(0,0),this.lastX=0,this.lastY=0,this.currentX=0,this.currentY=0,this.currentPan=new e.Vector2,this.lastPan=new e.Vector2,this.zoomStart=new e.Vector2,this.zoomEnd=new e.Vector2,this.zoomMouse=new e.Vector2,this.heightOffset=0,this.targetDisplayed=!1,this._lastTarget=new e.Vector3,this._lastPos=new e.Vector3,this.currentKeyOffset=new e.Vector2,this.currentKeyAngle=new e.Vector2,this.currentKeyZoom=new e.Vector2,this.touchZoomDistanceStart=0,this.touchZoomDistanceEnd=0,this.startTouch=0,this.debug=!1,this.debugPicking=!1,this.debugPicking2=!1,this.debugMoveTo=!1,this.verbose=null,l.is(this.verbose)&&(this.lastMove=""),this.paths={},this.openedAnimation=null,this.buttonDown=0,this.openedKeyframe={index:-1,time:-1},this._updateFromKeyframe=!1,this.timetoFps=.025,this.movelength=0,this.moverotX=0,this.moverotY=0,this.movelapse=0,this.dampingDistance=0,this.dampingAngleX=0,this.dampingAngleY=0,this.topSpeed=0;var a=this.urban.url.getArgument("moveto");l.is(a)&&"1"===a.value&&this.debugMove(),this.type="default",this.zeroish=1e-6,this.epsilon=.001,this.dampingRotateMin=.005,this.zoomtouchfactor=.001,this.timeToOffset=62.5,this.minZoomDistance=.5,this.mountainHeight=700,this.groundMaxAlt=8848,this.touchZoomStartFactor=1.15,this.defaulttimebetweenkeys=2e3,this._lastPick=new e.Vector3},setActive:function(t){t.viewpoint?this.activate({noAnimationOnActivation:!0}):this.deactivate()},setVerbose:function(t){l.is(t)&&t?(this.verbose=t,this.lastMove=""):(this.verbose=null,this.lastMove=null)},_getWorldSize:function(){var t=this.urban.worldSize;return(!l.is(t)||t<=0)&&(t=1/0),t},activate:function(t){if(this.enabled=!0,!0===this.verbose&&c.log(" activate default manip"),this.resetMove(),this.askedmove=null,this.askedmovepos=null,this.initEvents(),!(this.firstcall||this.params.noAnimationOnActivation||l.is(t)&&l.is(t.noAnimationOnActivation))){var i=new e.Vector3(0,.5,-.5);this.moveTo3(this.target,this.params.defaultDistanceOnActivation,i,this.params.manipTransitionDuration)}s.enableInterns(!0)},deactivate:function(t){this.enabled=!1,!0===this.verbose&&c.log(" de activate manip "+this.type)},updateBase:function(){this.currentQuaternion.normalize(),this.currenteye.copy(l.refX),this.currenteye.applyQuaternion(this.currentQuaternion),this.eye.copy(this.currenteye),this.currentup.copy(l.refZ),this.currentup.applyQuaternion(this.currentQuaternion),this.up.copy(this.currentup)},initEvents:function(){if(!0!==this._initialized){i.Initialize(this.domElement),s.Initialize(this.urban),this.domElement.addEventListener("contextmenu",function(t){t.preventDefault()});var t=this;this.changeEvent={type:"change"},this.rotatemoveToken=void 0,this.mmoveToken=void 0;var e=function(e){if(!1===t.enabled)return!1;l.is(t.mmoveToken)&&(i.unsubscribe(t.mmoveToken),t.mmoveToken=null),t.mousedown(e),t.mmoveToken=i.subscribeToMouseMove(t.mousemove.bind(t))}.bind(t),n=function(e){if(!1===t.enabled)return!1;t.mouseup(e),l.is(t.mmoveToken)&&i.unsubscribe(t.mmoveToken),t.mmoveToken=null}.bind(t);this.unmin=function(e){t.unminimize(e)},i.subscribeToLeftMouseDown(e),i.subscribeToRightMouseDown(e),i.subscribeToMiddleMouseDown(e),i.subscribeToLeftMouseUp(n),i.subscribeToRightMouseUp(n),i.subscribeToMiddleMouseUp(n),i.subscribeToMouseWheel(this.mousewheel.bind(this)),i.subscribeTo("/VISU/onTouch",this.touchstart.bind(this)),i.subscribeTo("/VISU/onPinch",this.touchmove.bind(this)),i.subscribeTo("/VISU/onPan",this.touchmove.bind(this)),i.subscribeTo("/VISU/onRotate",this.touchmove.bind(this)),i.subscribeTo("/VISU/onPinchPanRotate",this.touchmove.bind(this)),i.subscribeTo("/VISU/onSwipe",this.touchmove.bind(this)),i.subscribeToRelease(this.touchend.bind(this));i.subscribeTo("/VISU/onDoubleTap",this.doubleClick.bind(this));i.subscribeTo("/VISU/onLeftDoubleClick",this.doubleClick.bind(this)),i.subscribeTo("/VISU/onRightDoubleClick",this.doubleClick.bind(this)),i.subscribeTo("/VISU/onKeyDown",this.keydown.bind(this)),i.subscribeTo("/VISU/onKeyUp",this.keyup.bind(this)),this.domElement.onkeypress=function(){c.log("keypress baaby")},i.subscribeTo("/VISU/onMiddleClick",this.centerTarget.bind(this)),i.subscribeTo("/VISU/onMiddleDoubleClick",this.testFunction.bind(this));i.subscribeTo("/VISU/onLeftClick",function(e){l.is(e)&&l.is(e.from)&&l.is(e.from[0])&&l.is(e.from[0].view)&&l.is(e.from[0].view.classList)&&l.is(e.from[0].view.classList[0])&&("POIText"!==e.from[0].view.classList[0]&&"annotationStyle"!==e.from[0].view.classList[0]||t._lastPick.copy(xCity.findItem({id:e.from[0].view.dataModelID}).get("position")),"PoiSpan"!==e.from[0].view.classList[0]&&"annotationStyleSpan"!==e.from[0].view.classList[0]&&"POIDescription"!==e.from[0].view.classList[0]||t._lastPick.copy(xCity.findItem({id:e.from[0].view.getParent().dataModelID}).get("position"))),t.dispatchEvent("onUrbanClick",t)}),i.subscribeTo("/VISU/onTap",function(e){t.dispatchEvent("onUrbanClick",t)}),this.handleResize(),this._initialized=!0}},testFunction:function(t){},reset:function(){this.initPan(),this.resetMove()},_resize:function(t,e){this.handleResize()},handleResize:function(){this.screen.width=window.innerWidth,this.screen.height=window.innerHeight,this.screen.offsetLeft=0,this.screen.offsetTop=0,this.radius=(this.screen.width+this.screen.height)/4,this.lastPan.set(.5*this.screen.width,.5*this.screen.height),this.currentPan.copy(this.lastPan)},getMouseOnScreen:function(t,i){return new e.Vector2((t-this.screen.offsetLeft)/this.radius*.5,(i-this.screen.offsetTop)/this.radius*.5)},pixeltoangle:function(t){var e=t/Math.max(this.screen.width,this.screen.height)*2*Math.PI,i=this.params.manipulationSpeedFactor*this.params.rotateSpeed*e;return!0===this.shiftKey&&(i*=this.params.manipulationShiftSpeedFactor),i},getCurrentPitchAngle:function(){var t=l.vertical.clone().negate().dot(this.eye.clone().normalize());return t=Math.acos(t)},rotatelimited:function(){var t,i,n,s,r=0,o=0,a=this.lastY-this.currentY,h=!1,d=l.toRad(this.params.pitchMax),u=0,g=0,m=this.getCurrentPitchAngle();if(u=d-m,Math.abs(u)<this.zeroish&&(u=0),g=0-m,Math.abs(g)<this.zeroish&&(g=0),this.currentState===this.params.STATE.TOUCH_ROTATE){if(l.is(this.touchLast1)&&l.is(this.touchVeryFirst1)){var f=this.touchFirst2.clone().sub(this.touchFirst1).clone(),p=this.touchLast2.clone().sub(this.touchLast1).clone(),v=f.normalize(),_=p.normalize();this.touchFirst1.y<this.touchFirst2.y&&(v.negate(),_.negate());var b=l.cleandot(v,_),y=v.sub(_).x<0?1:-1;r=Math.acos(b)*y,this.touchFirst1.copy(this.touchLast1),this.touchFirst2.copy(this.touchLast2),this.touchLast1=null,Math.abs(r)<this.epsilon&&(r=0)}o=this.pixeltoangle(a)}else if(this.currentState===this.params.STATE.TOUCH_TILT)o=this.pixeltoangle(a),r=0;else{var w=this.lastX-this.currentX;r=this.pixeltoangle(w),o=this.pixeltoangle(a)}if(this.lastRotation.set(0,0),o=Math.max(g,o),o=Math.min(o,u),0===r&&0===o){if(!(this.timeLeftRotate>0))return this.timeLeftRotate=0,this.dampingAngleX=0,this.dampingAngleY=0,!1;Math.abs(this.dampingAngleX)<this.epsilon&&(this.dampingAngleX=.25*this.currentXAngularSpeed*this.params.dampingTime,!0===this.verbose&&c.log("total damping angle X "+this.dampingAngleX)),Math.abs(this.dampingAngleY)<this.epsilon&&(this.dampingAngleY=.25*this.currentYAngularSpeed*this.params.dampingTime,!0===this.verbose&&c.log("total damping angle Y "+this.dampingAngleY));var P=this.timeLeftRotate/this.params.dampingTime,S=this.dampingAngleX*this.easing(P),x=this.dampingAngleY*this.easing(P);!0===this.verbose&&c.log("current  angle "+S+" "+x),this.timeLeftRotate-=this.urban.USR.timeDelta,this.timeLeftRotate=Math.max(0,this.timeLeftRotate);var C=this.timeLeftRotate/this.params.dampingTime;r=S-this.dampingAngleX*this.easing(C),o=x-this.dampingAngleY*this.easing(C),Math.abs(r)<this.dampingRotateMin&&(r=0),Math.abs(o)<this.dampingRotateMin&&(o=0),o=Math.max(g,o),o=Math.min(o,u),0===r&&0===o&&(this.timeLeftRotate=0,this.dampingAngleX=0,this.dampingAngleY=0)}if((new e.Vector3).copy(this.eye),(new e.Vector3).copy(this.up),h=!1,r&&(i=this.vertical,(t=new e.Quaternion).setFromAxisAngle(i,r),h=!0,this.lastRotation.x=r,this.lastX=this.currentX,!0===this.verbose&&c.log("x "+r)),o&&(s=this.position.clone().sub(this.target.clone()).normalize(),(i=(new e.Vector3).crossVectors(s,this.up).normalize()).normalize(),(n=new e.Quaternion).setFromAxisAngle(i,-o),t=l.is(t)?t.multiply(n):n,h=!0,this.lastRotation.y=o,this.lastY=this.currentY),h){if(l.is(t)){t.normalize();var M=this.target.clone();l.is(this.zoomFocus)&&!l.isOut(this.zoomFocus,this.urban)&&(M=this.zoomFocus.clone()),this.rotateAround(t,M),this.currentQuaternion=t.multiply(this.currentQuaternion),this.updateBase(),this.eye.setLength(this.distanceToTarget)}}return h},rotateAround:function(t,e){var i=e.clone().sub(this.position);i.applyQuaternion(t),this.position.copy(e),this.position.sub(i)},zoomCameraOld:function(){var t,e,i,n=!1;if(this.currentstate===this.params.STATE.TOUCH_ZOOM&&(this.zoomEnd.y=-this.touchZoomDistanceEnd*this.zoomtouchfactor,this.zoomStart.y=-this.touchZoomDistanceStart*this.zoomtouchfactor),e=this.zoomEnd.y-this.zoomStart.y,Math.abs(e)<1/Math.max(this.screen.width,this.screen.height)&&(e=0),t=e*this.params.manipulationSpeedFactor*this.params.zoomSpeed*this.urban.USR.timeDelta*this.timeToOffset,!0===this.shiftKey&&(t*=this.params.manipulationShiftSpeedFactor),0!==e&&1!==t){this.eye.length(),i=.5*-t*Math.max(this.distanceToTarget,this.minZoomDistance),this.distanceToTarget=this.distanceToTarget-i;var s=this.eye.clone();this.position.add(s.setLength(i)),n=!0,this.zoomStart.y+=(this.zoomEnd.y-this.zoomStart.y)*Math.min(1,.5*this.params.dynamicDampingFactor*this.urban.USR.timeDelta*this.timeToOffset)}return this.touchZoomDistanceStart=-this.zoomStart.y/this.zoomtouchfactor,!0===this.verbose&&c.log("touchZoomDistanceStart  "+this.touchZoomDistanceStart),n},zoomCamera:function(){var t,e,i,n,s;if(!l.is(this.zoomFocus))return this.zoomCameraOld();if(this.currentState===this.params.STATE.TOUCH_ZOOM||this.currentState===this.params.STATE.TOUCH_ROTATE?(this.zoomEnd.y=-this.touchZoomDistanceEnd*this.zoomtouchfactor/this.params.touchZoom,this.zoomStart.y=-this.touchZoomDistanceStart*this.zoomtouchfactor/this.params.touchZoom,e=this.zoomEnd.y-this.zoomStart.y):(e=this.zoomEnd.y-this.zoomStart.y,!0===this.shiftKey&&(e*=this.params.manipulationShiftSpeedFactor)),Math.abs(e)<1/Math.max(this.screen.width,this.screen.height)&&(e=0),t=e*this.params.manipulationSpeedFactor*this.params.zoomSpeed*Math.min(.16,this.urban.USR.timeDelta)*this.timeToOffset,0!==e&&1!==t){t=Math.min(2,Math.max(-2,t));var r=this.zoomFocus.clone().sub(this.position);n=r.length(),i=.5*-t*Math.max(n,0),this.currentState!==this.params.STATE.TOUCH_ZOOM&&this.currentState!==this.params.STATE.TOUCH_ROTATE||(i=n*(1-(t=this.touchZoomDistanceStart/this.touchZoomDistanceEnd)),!0===this.verbose&&c.log("zoom "+n+" "+t+" "+i+" "+this.touchZoomDistanceEnd+" "+this.touchZoomDistanceStart),this.touchZoomDistanceStart=this.touchZoomDistanceEnd),r.setLength(i);var o=this.distanceToTarget;if(0===(n=Math.abs(n)))t>0||(s=.5*-t*1,r.setLength(s));else if(this.distanceToTarget=this.distanceToTarget*(n-i)/n,this.distanceToTarget<this.minZoomDistance)this.distanceToTarget=this.minZoomDistance,s=n*(this.distanceToTarget/o),r.setLength(n-s);return!0===this.verbose&&c.log("zoom applied  "+l.displayVector(r)),this.position.add(r),this.currentState!==this.params.STATE.TOUCH_ZOOM&&this.currentState!==this.params.STATE.TOUCH_ROTATE||this.zoomStart.copy(this.zoomEnd),this.zoomStart.y+=(this.zoomEnd.y-this.zoomStart.y)*Math.min(1,.5*this.params.dynamicDampingFactor*this.urban.USR.timeDelta*this.timeToOffset),this.touchZoomDistanceStart=-this.zoomStart.y*this.params.touchZoom/this.zoomtouchfactor,!0===this.verbose&&c.log("zoomdamping "+this.zoomStart.y+" "+this.zoomEnd.y+" "+this.touchZoomDistanceEnd+" "+this.touchZoomDistanceStart),!0}return!1},getAltitude:function(){return this.position.z-this.terrainHeight},setAltitude:function(t){var e=t+this.terrainHeight;return this.position.z!==e&&(this.position.z=t+this.terrainHeight),this.position},panDamping:function(){var t=!1;if(this.timeLeft>0)if(this.currentPan.copy(this.lastPan),l.is(this.currentSpeed))if(this.getCurrentDir().length()>0){this.dampingDistance<=0&&(this.dampingDistance=.25*this.currentSpeed*this.params.dampingTime,!0===this.verbose&&c.log("total damping distance "+this.dampingDistance));var e=this.timeLeft/this.params.dampingTime,i=this.dampingDistance*this.easing(e);!0===this.verbose&&c.log("current  distance "+i),!0===this.verbose&&c.log("time delta "+this.urban.USR.timeDelta),this.timeLeft-=this.urban.USR.timeDelta,this.timeLeft=Math.max(0,this.timeLeft),!0===this.verbose&&c.log("damping time left "+this.timeLeft);var n=this.timeLeft/this.params.dampingTime,s=this.dampingDistance*this.easing(n);!0===this.verbose&&c.log("damping new dist "+s);var r=this.topSpeed*this.urban.USR.timeDelta;!0===this.verbose&&c.log("damping max "+r);var o=Math.min(i-s,r),a=o;!0===this.verbose&&c.log("moved distance "+a),a<this.position.z*this.params.panLimitFactor?(this.timeLeft=0,this.dampingDistance=0,!0===this.verbose&&c.log("too small pan")):(o=this.getCurrentDir().setLength(a),this.position.sub(o),t=!0)}else this.timeLeft=0,this.dampingDistance=0;else this.timeLeft=0,this.dampingDistance=0;else this.timeLeft=0,this.dampingDistance=0;return t},panCameraOld:function(){var t,i,n,s,r=!1;t=this.lastPan.clone().sub(this.currentPan);var o=this.getAltitude();if(Math.abs(t.length())>this.epsilon){!0===this.verbose&&c.log(" pixel pan "+l.displayVector(this.mouseChange)+" "+l.displayVector(this.lastPan)+" "+l.displayVector(this.currentPan));var a=Math.max(this.getAltitude()*this.epsilon,.1);t.multiplyScalar(a*this.params.manipulationSpeedFactor*this.params.panSpeed),!0===this.shiftKey&&t.multiplyScalar(this.params.manipulationShiftSpeedFactor),s=this.eye.clone().cross(this.up).setLength(-t.x),0===(n=(i=new e.Vector3(this.target.x-this.position.x,this.target.y-this.position.y,0)).length())?s.add(this.up.clone().setLength(t.y)):s.add(i.multiplyScalar(t.y/n));var h=Math.abs(this.position.z)*this.params.panLimitFactor;s.length()>h&&(this.position.sub(s),!0===this.verbose&&c.log(" oldpan length "+s.length()+" "+this.urban.USR.timeDelta+" "+s.length()/this.urban.USR.timeDelta),this.updateCurrentDir(s)),this.lastPan.copy(this.currentPan),r=!0}return r||(r=this.panDamping()),r&&this.setAltitude(o),r},panCamera:function(){if(this.currentState===this.params.STATE.KEYBOARD_PAN)return this.panCameraOld();var t,e=!1,i=this.getAltitude();if(l.is(this.lastPan)&&(this.mouseChange.copy(this.currentPan),this.mouseChange.sub(this.lastPan),this.mouseChange.lengthSq()>this.epsilon&&(!0===this.verbose&&c.log(" pixel pan "+l.displayVector(this.mouseChange)+" "+l.displayVector(this.lastPan)+" "+l.displayVector(this.currentPan)),l.is(this.lastMouseFocus)||this.initPan(),l.is(this.lastMouseFocus)&&(this.currentMouseFocus=this.pick2D(!1,this.currentPan,this.lastMouseFocus.z),!0===this.verbose&&c.log("pickfocus "+l.displayVector(this.currentMouseFocus)+l.displayVector(this.currentPan)+l.displayVector(this.lastMouseFocus)),l.is(this.currentMouseFocus))))){if(this.debugPicking2){if(c.log("panfocus "+l.displayVector(this.currentMouseFocus)),!l.is(this.node2)){var n=new d.Color(0,1,0,1);this.node2=u.createSphereNode({radius:10,color:n}),this.urban.getView3D().getScene().add(this.node2)}var s=this.node2.getMatrix(),r=this.currentMouseFocus.clone();s.setPosition(r),this.node2.setMatrix(s)}(t=this.currentMouseFocus.clone().sub(this.lastMouseFocus)).z=0;var o=Math.max(Math.abs(this.position.z)*this.params.panLimitFactor,.01);t.length()>o&&(!0===this.verbose&&c.log(" pan length "+t.length()+" "+this.urban.USR.timeDelta+" "+t.length()/this.urban.USR.timeDelta),this.position.sub(t),this.updateCurrentDir(t),e=!0),this.currentPan.copy(this.lastPan)}if(e||(e=this.panDamping()),!0===e){if(!0===this.verbose){var a=this.lastPosition.position.clone().sub(this.position);c.log(" meter pan "+l.displayVector(a))}this.setAltitude(i)}return e},updateCurrentDir:function(t){var i=this.params.pandirframe;if(!l.is(this.dir[i]))for(;i>0;i--)l.is(this.dir[i-1])||(this.dir[i-1]=new e.Vector3);if(l.is(t)){for(i=this.params.pandirframe;i>1;i--)this.dir[i-1].copy(this.dir[i-2]);this.dir[0].copy(t)}else for(i=this.params.pandirframe;i>0;i--)this.dir[i-1].set(0,0,0)},getCurrentDir:function(){var t=this.params.pandirframe-1;for(this._currentDir.copy(this.dir[t]);t>0;t--)this._currentDir.add(this.dir[t-1]);return this._currentDir.multiplyScalar(1/this.params.pandirframe),this._currentDir.clone()},initPan:function(){this.lastMouseFocus=this.pick2D(!1,this.lastPan)},autoFocus:function(){var t,i=new e.Vector2(.5*this.screen.width,.5*this.screen.height);!0===this.verbose&&c.log("autofocus");var n=t=this.exactPick(i);if(l.is(t)){n.length();!0===this.verbose&&c.log("picked pos "+l.displayVector(n)),this.distanceToTarget=this.position.distanceTo(n),this.updateTarget(),!0===this.verbose&&c.log("picked dtt "+this.distanceToTarget+"  newtalt"+this.getAltitudeFromVector(n)+l.displayVector(this.target))}return!0},updateTarget:function(){!0===this.verbose&&c.log("befre "+l.displayVector(this.target));var t=this.eye.setLength(this.distanceToTarget);this.target=this.position.clone().add(t),!0===this.verbose&&c.log("after "+l.displayVector(this.target))},checkOnly:function(){if(this.urban.webSocket)return!0;var t=!0;this.getAltitude(this.position)<=this.params.minHeight&&(l.is(this.currentAnimation)&&this.checkH||(t=!1)),this.up.normalize(),this.eye.normalize();var e=this.getCurrentPitchAngle(),i=l.toRad(this.params.pitchMax);return this.up.z<-.01?t=!1:e>i&&(t=!1),t},setPositionOnSphere:function(t,e){var i=this.eye.clone(),n=this.position.clone(),s=(this.target.clone(),t.clone().sub(n)),r=s.length();i.length();i.normalize(),s.normalize();var o=n.add(i.multiplyScalar(s.dot(i)*r)),a=t.sub(o).length(),h=Math.sqrt(e*e-a*a);h=Math.min(h-1,this.distanceToTarget),!0===this.verbose&&c.log("oldpos"+l.displayVector(this.position)),this.position=o.add(i.negate().setLength(h)),!0===this.verbose&&c.log("correctedpos"+l.displayVector(this.position))},checkValues:function(){if(this.urban.webSocket)return!0;var t=!0;this.getAltitude(this.position)<=this.params.minHeight&&(l.is(this.currentAnimation)&&this.checkH||(this.resetZoom(),!0===this.verbose&&c.log("too low"),this.setAltitude(this.params.minHeight+.1)));var i=this.viewpoint._translateToAbsolutePosition(this.viewpoint._initialCenter.clone());this.target.distanceTo(i)>this._getWorldSize()*this.params.maxfactor&&(this.resetMove(),this.target=this.target.sub(i),this.target.setLength(this._getWorldSize()*this.params.maxfactor),this.target.add(i),this.distanceToTarget=this.position.distanceTo(this.target),t=!0,!0===this.verbose&&c.log("correction : target too far from center")),this.position.distanceTo(i)>this._getWorldSize()*this.params.maxfactor&&(this.resetMove(),this.setPositionOnSphere(i,this._getWorldSize()*this.params.maxfactor),this.distanceToTarget=this.position.distanceTo(this.target),this.updateTarget(),t=!0,!0===this.verbose&&c.log("correction : position too far from center")),this.up.normalize(),this.eye.normalize();var n=this.getCurrentPitchAngle(),s=l.toRad(this.params.pitchMax),r=this.position.clone().sub(this.target.clone()).normalize(),o=(new e.Vector3).crossVectors(r,this.up).normalize();if(o.normalize(),this.up.z<-.01){if(t=!0,!0===this.verbose&&c.log("correction : up must not be below horizon"),l.is(this.zoomFocus))this.zoomFocus.distanceTo(this.position);this.up.z=0,this.up.normalize(),this.eye.x=0,this.eye.y=0,this.eye.normalize(),this.position.copy(this.target),this.position.z+=this.distanceToTarget,this.eye.normalize(),this.resetMove(),this.zoomFocus=null}else if(n>s){t=!0;var a=new e.Quaternion,h=n-s;a.setFromAxisAngle(o,h),a.normalize(),this.eye.normalize(),this.eye.copy(this.eye.applyQuaternion(a)),this.eye.normalize(),this.up=l.getUpFromCameraEye(this.eye).normalize();this.position.z;this.position.copy(this.target.clone().sub(this.eye.setLength(this.distanceToTarget))),this.eye.normalize(),n=this.getCurrentPitchAngle(),!0===this.verbose&&c.log("correction : pitch angle too high")}return this.distanceToTarget<this.viewpoint.camera.near+1&&(this.distanceToTarget=this.viewpoint.camera.near+1,this.position.copy(this.target.clone().sub(this.eye.setLength(this.distanceToTarget))),t=!0,!0===this.verbose&&c.log("correction : target too close")),t},setKeyframe:function(t){if(l.is(t)){var e=!1;if(l.is(t.position)&&(this.position.copy(t.position),e=!0),l.is(t._target)&&(this.target.copy(t._target),this.distanceToTarget=this.position.distanceTo(this.target),e=!0),l.is(t.quaternion)&&(this.currentQuaternion.copy(t.quaternion),this.updateBase(),e=!0),l.is(t.date)&&(this.urban.date.setDate(t.date),e=!0),!0===e)return this._updateFromKeyframe=!0,this.resetMove(),!0}return this._updateFromKeyframe=!1,!1},animate:function(){l.is(this.askedmove)&&(this.moveToClick(this.askedmovepos,this.askedmove),this.askedmove=null,this.askedmovepos=null);var t=!1;return l.is(this.currentAnimation)&&(this.currentAnimation.isDone()&&!this.currentAnimation.isRunning()?(this.urban.getView3D().getRecorder().stopRecord(),this.autoFocus(),this.checkH=!0,this.currentAnimation.stop(),this.currentAnimation=null,this.repickExact=!0,this.zoomFocus=null,t=!0):this.currentAnimation.isPlaying()&&l.is(this.timeline)&&this.timeline.setValue(this.currentAnimation.animationTime)),t},updateLastPosition:function(){!0===this.checkOnly()&&(this.lastPosition=this.getCurrentKeyframe(),!0===this.verbose&&c.log("lastposition "+l.displayVector(this.lastPosition.position)))},updateSpeed:function(){l.is(this.lastPosition)&&l.is(this.lastPosition.position)&&(this.motion=this.lastPosition.position.clone().sub(this.position),0!==this.urban.USR.timeDelta&&(this.movelapse+=this.urban.USR.timeDelta,l.is(this.motion)&&(this.movelength+=this.motion.length(),this.movelapse>0?this.currentSpeed=this.movelength/this.movelapse:this.currentSpeed=0,this.topSpeed<this.currentSpeed&&(this.topSpeed=this.currentSpeed),this.movelapse>0?(this.moverotX+=this.lastRotation.x,this.moverotY+=this.lastRotation.y,this.currentXAngularSpeed=this.moverotX/this.movelapse,this.currentYAngularSpeed=this.moverotY/this.movelapse):this.currentXAngularSpeed=this.currentYAngularSpeed=0,!0===this.verbose&&this.currentSpeed>this.epsilon&&c.log("speed "+this.currentSpeed+" m/s "+l.displayVector(this.motion)+" "+this.urban.USR.timeDelta))))},screenBound:function(t){var i=new e.Vector2;return i.x=Math.max(0,t.x),i.y=Math.max(0,t.y),i.x=Math.min(t.x,this.screen.width),i.y=Math.min(t.y,this.screen.height),i},update:function(t){if(!0!==t)return!1;l.is(this.lastPan)&&this.currentKeyOffset.length()>0&&(this.lastPan.sub(this.currentKeyOffset),this.screenBound(this.currentPan).equals(this.currentPan)||(this.lastMouseFocus=null,this.currentPan.copy(this.lastPan)));l.is(this.currentX)&&(this.currentX+=this.currentKeyAngle.x),l.is(this.currentY)&&(this.currentY+=this.currentKeyAngle.y),l.is(this.zoomStart)&&(this.zoomStart.y+=this.currentKeyZoom.y),!0===this.firstcall&&this.updateLastPosition();var e=!1,n=!1,r=!1,o=this.viewpoint.getTarget(),a=this.viewpoint.getPosition(),h=this.viewpoint.camera.up.clone(),d=o.clone().sub(a),u=this.viewpoint.camera.quaternion.clone();l.is(this.currentQuaternion)&&(u=this.viewpoint.camera.quaternion.clone());this.getAltitude();if(!0===this._updateFromKeyframe?(e=!0,n=!0,!1===this.checkH&&(this._updateFromKeyframe=!1),!0===this.verbose&&c.log(" keyframe applied ")):(l.is(a)&&(this.position.distanceTo(a)>this.epsilon&&(e=!0),this.position.copy(a)),l.is(o)&&this.target.copy(o),l.is(h)&&this.up.copy(h),l.is(d)&&this.eye.copy(d),l.is(this.currentQuaternion)&&(l.equals(this.currentQuaternion,u)||(e=!0),this.currentQuaternion.copy(u)),!0===this.verbose&&e&&c.log(" viewpoint modified outside of manipulator")),!l.is(this.currentAnimation)&&!0===this.checkH){!0===this.verbose&&c.log("checkH ...");var g=this.getAltitude();g<this.params.minHeight&&(this.heightOffset+=this.params.minHeight+1-g,this.setAltitude(this.params.minHeight+1),a.copy(this.position),e=!0,this.resetMove(),c.log("ground too high")),this.checkH=!1}this.distanceToTarget=this.position.distanceTo(this.target);var m,f;this.position.length();l.is(this.noPick)&&l.is(this.zoomFocus)||(!0!==this.repick&&!0!==this.repickExact||(this.terrainHeight>this.mountainHeight&&this.getAltitudeFromVector(this.position)<this.groundMaxAlt&&(this.repickExact=!0),!0===this.repickExact&&!1===this.params.noExactRepick?(m=this.exactPick(this.zoomMouse),l.isOut(m,this.urban)?!0===this.verbose&&c.log(" no exact pick 7 !! "+l.displayVector(this.zoomFocus)):(this.zoomFocus=m,this._lastPick.copy(m))):(!0===this.params.zoomExactPick?(m=this.exactPick(this.zoomMouse),l.isOut(m,this.urban)?!0===this.verbose&&c.log(" no exact pick 6 !! "+l.displayVector(this.zoomFocus)):this.zoomFocus=m):this.zoomFocus=this.pick2D(!1,this.zoomMouse),l.is(this.zoomFocus)||(this.zoomFocus=this.pick2D(!1,this.zoomMouse))),l.is(this.zoomFocus)&&(!0===this.verbose&&c.log("zoomfocus"+l.displayVector(this.zoomFocus)),this.lastPan.equals(this.zoomMouse)&&(this.lastMouseFocus=this.zoomFocus.clone())),this.repickExact=!1,this.repick=!1));if((this.urban.getView3D().getRecorder().isRecording()||this.still===this.params.focusTime||this.still===this.params.focusTime*this.params.focusTime)&&(l.is(this.noPick)||(r=this.autoFocus()),l.is(this.lastMove)&&r&&(this.lastMove+=" focused")),this.params.noAnimation||(e=(f=this.animate())||e,f&&l.is(this.lastMove)&&(this.lastMove+=" animation"),!f)){if(!1===e?(this.params.noRotate||(e=(f=this.rotatelimited())||e,f&&(this.resetZoom(),l.is(this.lastMove)&&(this.lastMove+=" rotate"))),this.params.noZoom||(e=(f=this.zoomCamera())||e,f&&l.is(this.lastMove)&&(this.lastMove+=" zoom")),this.params.noPan||(e=(f=this.panCamera())||e,f&&l.is(this.lastMove)&&(this.lastMove+=" pan"))):!0===this.verbose&&c.log("no movement because animation"+this.lastMove),!0===this.verbose&&l.is(this.lastMove)&&""!==this.lastMove&&c.log(this.lastMove),this.updateSpeed(),this.updateLastPosition(),!0===e||!0===r||!0===this.firstcall){if(this.updateTarget(),this.firstcall=!1,l.is(this.currentAnimation)||(this._lastTarget.copy(o),this._lastPos.copy(a),!1===this.checkValues()&&(this.target.copy(o),this.position.copy(a),this.up.copy(h),this.eye.copy(d),this.currentQuaternion.copy(u),this.distanceToTarget=this.position.distanceTo(this.target),!0===this.verbose&&c.log(" false values"))),this.updateViewpoint(),l.is(this.urban.USR.webGLV6Viewer.renderer.BokehDOFEffect)&&this.distanceToTarget<129){var p=Math.min(64,.5*this.distanceToTarget);this.urban.USR.webGLV6Viewer.renderer.BokehDOFEffect.updateFocalLength(p)}!0,e&&(this.still=0,n||(this.lastFeature=null))}var v={position:this.position,target:this.target,up:this.up,eye:this.eye};if(s.set(v),s.draw(),this.currentState===this.params.STATE.ROTATE?!0===e&&(this.targetDisplayed=!0):this.currentState===this.params.STATE.TOUCH_ROTATE?this.startTouch<=0?this.targetDisplayed=!1:!0===e&&(this.targetDisplayed=!0):this.targetDisplayed=!1,this.displayTarget(this.targetDisplayed),!1===e&&(this.still++,this.movelength=0,this.moverotX=0,this.moverotY=0,this.still>this.params.resetTime&&(this.movelapse=0,this.topSpeed=0,this.buttonDown<=0&&this.startTouch<=0&&this.setState(this.params.STATE.NONE))),(e||r)&&!0===this.verbose){this.eye.clone().normalize(),this.up.clone().normalize();var _=this.viewpoint.getPosition().clone(),b=this.viewpoint.getTarget().clone();_.length(),b.length();_.normalize(),b.normalize()}return this.currentState!==this.params.STATE.NONE}i.publish(i.eventsList.onStopAnimation)},getLastMoveType:function(){var t="";return l.is(this.lastMove)&&(t=this.lastMove,this.lastMove=""),t},getAltitudeFromVector:function(t){return t.z},setAltitudeToVector:function(t,e){return t.z=e,t},getText:function(t){var e=this.eye.clone().normalize(),i=this.up.clone().normalize(),n=this.viewpoint.get();return"<br />vangle  : "+l.displayVector(n.angle)+"<br />Tgt  : "+l.displayVector(this.target)+"<br />Talt : "+this.getAltitudeFromVector(this.target)+"<br />Pos  : "+l.displayVector(this.position)+"<br />Palt : "+(this.getAltitudeFromVector(this.position)-this.terrainHeight)+"<br />Dtot : "+this.distanceToTarget.toFixed(3)+"<br />Eye  : "+l.displayVector(e)+"<br />Up : "+l.displayVector(i)+"<br />quat : "+l.displayVector(this.currentQuaternion)+"<br />move : "+this.getLastMoveType()},updateViewpoint:function(){this.viewpoint.setPosition(this.position),this.viewpoint.camera.up.copy(this.up),this.viewpoint.overwriteTarget(this.target),this.orientation.copy(this.currentQuaternion)},moveToFeature:function(t,e){if(l.is(this.askedmove))return null;if(l.is(t)&&l.is(t.get)){if(t.get("PointOfView")){var i=t.get("PointOfView");return this.moveTo(i.getLocalPosition(this.urban).clone(),i.get("rotation").clone().multiplyScalar(Math.PI/180),i.get("length"),e)}if(t.get("Content")){var n,s=t.get("Content");if(s instanceof p){if(n=s.getLocalPosition(this.urban)){var r=s._rtreeNode.openDistance*s._rtreeNode.instance.distanceFactor*.75;return this.moveTo(n.clone(),{x:0,y:45,z:0},r,e)}}else if(n=s.getLocalPosition(this.urban)){r=this.params.defaultDistance;return l.is(s.getSphereDiameter)&&(r=Math.max(2*s.getSphereDiameter(),2),l.is(r)||(r=this.params.defaultDistance)),this.moveTo(n.clone(),void 0,r,e)}}}return null},isFrom3dViewer:function(t){if(t.target){var e=t.target;if("xCityViewer"===e.id)return"timeSlider"!==e.className;if(e.parentElement&&"xCityViewer"===e.parentElement.id)return"timeSlider"!==e.className}return!1},centerTarget:function(t){if(!1===this.enabled)return!1;!0===this.verbose&&c.log("center click");var e=this._getEvent(t);return this.isFrom3dViewer(e)?this.AskMoveToClick(t.gesture.events[0].currentPosition,1):void 0},doubleClick:function(t){if(!1===this.enabled)return!1;!0===this.verbose&&c.log("double click");var e=this._getEvent(t);if(this.isFrom3dViewer(e)&&(!t.from[0]||!0!==t.from[0]._movetoFeatureLaunched)){var i=!0;if(l.is(e.button)){if(0===e.button){if(!this.params.leftDoubleClickEnable)return!1}else if(2===e.button&&!this.params.rightDoubleClickEnable)return!1;0!==e.button&&(i=!1)}!0===e.ctrlKey&&(i=!i);var n=1/this.params.doubleClickZoomFactor;return!1===i&&(n=this.params.doubleClickZoomFactor),this.AskMoveToClick(t.gesture.events[0].currentPosition,n)}},AskMoveToClick:function(t,e){l.is(this.currentAnimation)&&!this.params.movetoclickpriority||(this.askedmove=e,this.askedmovepos=t,this.currentAnimation=null)},moveToClick:function(t,e){var i=null;if(i=e>=1?this.exactPick(t):this.viewpoint.featureIntersect(t)?null:this.exactPick(t),l.is(i)){var n=this.viewpoint._translateToAbsolutePosition(this.viewpoint._initialCenter.clone()),s=this.params.maxfactor*this._getWorldSize();s-=i.distanceTo(n);var r=Math.min(s,e*this.position.distanceTo(i));return this.moveTo3(i,r,void 0,void 0)}return null},faceNorth:function(){var t=this.distanceToTarget,i=this.getCurrentKeyframe();i.date=null;var n=l.getNorthAngle(this.eye,this.up),s=i.getQuaternion(),a=i.clone(),h=new e.Quaternion;h.setFromAxisAngle(l.vertical.clone(),.5*-n);var d=h.multiply(s);a.setQuaternion(d);var u=a._eye.clone(),c=a._target.clone().sub(u.setLength(t));a.position=c.clone(),a.time=.5*this.params.northMoveDuration*1e3;var g=i.clone(),m=new e.Quaternion;m.setFromAxisAngle(l.vertical.clone(),-n),d=m.multiply(s),g.setQuaternion(d),u=g._eye.clone(),c=g._target.clone().sub(u.setLength(t)),g.position=c.clone(),g.time=1e3*this.params.northMoveDuration,(c=new o).addKeyframe(i),c.addKeyframe(a),c.addKeyframe(g);var f=new r(this,c,"facenorth");return this.setCurrentAnimation(f)},faceVerticalNorth:function(){new e.Vector3(0,0,0);var t=new e.Vector3(0,0,-1),i=this.target,n=this.distanceToTarget;return this.moveTo3(i,n,t,this.params.northMoveDuration)},toKeyframe:function(t,e,i,n,s,r){l.is(n)||(n=0);var o=new a({position:t,time:n,date:r});return o._target=s,o._up=i,o.initQuat(e,i),o},_getFinalPositionFromViewpoint:function(t,e,i){var n=t.clone().sub(i.normalize().multiplyScalar(e)),s=this.urban.USR.getGroundHeight(n.x,n.y);s*=this.urban.USR.scale;var r=this.params.minHeight+s;return this.getAltitudeFromVector(n)<r&&(this.setAltitudeToVector(n,r+1),(i=t.clone().sub(n)).normalize()),!0===this.verbose&&c.log("moveto3 to: "+l.displayVector(n)),n},moveTo3:function(t,e,i,n){if(!l.is(t))return!1;l.is(e)||(e=this.distanceToTarget),l.is(i)||(i=this.eye.clone()),l.is(n)||(n=this.params.moveDuration2);var s=this._getFinalPositionFromViewpoint(t,e,i);return this.moveTo4(s,i,n,t)},moveTo4:function(t,e,i,n){if(t.distanceTo(this.position)<this.epsilon)return c.log("same position no anim"),!1;var s=this.toKeyframe(t,e.normalize(),this.up,1e3*i,n),a=new o({splineInterpolate:!1}),h=this.getCurrentKeyframe();return h.date=null,a.addKeyframe(h),a.addKeyframe(s),this.setCurrentAnimation(new r(this,a,"moveto4"))},getCurrentKeyframe:function(){var t=null,e=null,i=null,n=null;l.is(this.position)&&(n=this.position.clone()),l.is(this.target)&&(i=this.target.clone()),l.is(this.up)&&(t=this.up.clone().normalize()),l.is(this.eye)&&(e=this.eye.clone().normalize());var s=this.urban.date.getDate(),r=new a({position:n,time:0,date:s,_target:i,_up:t});return r.initQuat(e,t),r},interpolKey:function(t,i,n,s,r){var o=i.date,a=t.lerp(t.position,i.position,n);this.setAltitudeToVector(a,r);var h=s.clone().sub(a),d=(new e.Vector3(1,0,0),l.getUpFromCameraEye(h)),u=t.lerpValue(t.time,i.time,n);return this.toKeyframe(a,h,d,u,s.clone(),o)},positionOffset:function(t,e,i,n){i._target.clone().sub(e._target);var s=i._eye.clone().normalize().add(i._up.clone().normalize()),r=t._right.clone().normalize();r.dot(s)>this.epsilon&&r.negate();var o=t.position.clone();return o.add(r.setLength(n)),o},getPathF4:function(t,e,i,n,s){var r=null,a=this._getFinalPositionFromViewpoint(t,e,i);if(a.distanceTo(this.position)<this.epsilon)return c.log("same position no anim"),null;var h=this.getAltitudeFromVector(this.position),d=this.getAltitudeFromVector(a),u=this.getCurrentKeyframe(),g=u._target;u.date=null,u._target=null;var m=u.date,f=l.getUpFromCameraEye(i);if(r=g.distanceTo(t),!l.is(s)){(f=t.clone().sub(u.position)).z=0,f.normalize();var p=u._up.clone();p.z=0,p.normalize();var v=f.clone();v.z=0,v.normalize(),p.clone().dot(v)<this.epsilon&&r<1e3&&(f.negate(),c.log(" negated"))}var _=this.toKeyframe(a,i,f,1e3*n*1,t.clone(),m);l.is(s)&&_.setQuaternion(s);var b=a.clone(),y=this.position.clone(),w=Math.abs(.5*b.distanceTo(y)),P=0+(Math.min(h,d)+.5*w),S=_.date,x=u.lerp(u.position,_.position,.5);this.setAltitudeToVector(x,P);var C=t.clone().sub(x);f=l.getUpFromCameraEye(C),r<1e3&&(l.is(s)||(f=u.lerp(u._up.clone(),_._up.clone(),.5).normalize()));var M=u.lerpValue(u.time,_.time,.5),D=this.toKeyframe(x,C,f,M,t.clone(),S);return(r=new o({fadeRotation:!0,targetInterpol:!1})).addKeyframe(u),r.addKeyframe(D),r.addKeyframe(_),r.timeAdjust(),r},teleport:function(t,i,n){var s=null;l.is(i)||(i=.5*this.distanceToTarget),l.is(n)?(s=l.quatFromAngles(n.x,n.y,n.z),n=new e.Vector3(-Math.sin(n.x)*Math.sin(n.y),-Math.cos(n.x)*Math.sin(n.y),Math.cos(n.y)).normalize().multiplyScalar(i).negate()):n=this.vertical.clone().negate();var a=t.clone().sub(n.setLength(i)),h=this.toKeyframe(a,n,l.getUpFromCameraEye(n),0,t.clone(),null);l.is(s)&&h.setQuaternion(s);var d=new o;d.addKeyframe(h.clone()),h.time=1,d.addKeyframe(h);var u=new r(this,d,"teleport");this.setCurrentAnimation(u)},teleportToFeature:function(t){if(l.is(t))if(t.get("PointOfView")){var e=t.get("PointOfView");this.teleport(e.getLocalPosition(this.urban).clone(),e.get("length"),e.get("rotation").clone().multiplyScalar(Math.PI/180))}else if(t.get("Content")){var i=t.get("Content").getLocalPosition(this.urban);i&&this.teleport(i.clone(),this.params.defaultDistanceOnActivation,void 0)}},moveTo2:function(t,i,n,s){if(!l.is(t))return!1;var r=null;return l.is(i)||(i=this.params.defaultDistanceOnActivation),l.is(n)?(r=l.quatFromAngles(n.x,n.y,n.z),n=new e.Vector3(-Math.sin(n.x)*Math.sin(n.y),-Math.cos(n.x)*Math.sin(n.y),Math.cos(n.y)).normalize().multiplyScalar(i).negate()):n=new e.Vector3(0,0,-1),this.moveToWithOrientation(t,i,n,s,r)},moveToWithOrientation:function(t,e,i,n,s){l.is(n)||(n=this.params.moveDuration);var o=this.getPathF4(t,e,i,n,s);if(l.is(o)){if(!0===this.debug){var a,h=o.getPositionSpline(),c=h.points;if(l.is(h.points)&&h.points.length>0){var g=new d.Color(1,0,0,1);for(a=0;a<h.points.length;a++)c[a]=h.points[a].clone();var m=u.createLineNode({points:c,width:500,color:g});for(m.name="ManipulatorHelper",this.urban.getView3D().getScene().add(m),c=h.getSpacedPoints(2e3),g=new d.Color(0,0,1,1),a=0;a<c.length;a++)c[a]=c[a].clone();(m=u.createLineNode({points:c,width:500,color:g})).name="ManipulatorHelper",this.urban.getView3D().getScene().add(m)}}var f=new r(this,o,"moveto2");return!0===this.debugMoveTo&&(f.runOnce=!1,this.paths.moveto2=f,this.setCurrentPath("moveto2")),this.setCurrentAnimation(f)}return null},getCurrentAnimation:function(){return this.currentAnimation},setCurrentAnimation:function(t){return!!l.is(t)&&(l.is(this.currentAnimation)&&(this.currentAnimation.stop(),this.currentAnimation=null),this.currentAnimation=t,!0===this.currentAnimation.runOnce&&this.currentAnimation.start(),this.resetMove(),!0)},moveTo:function(t,e,i,n){return this.params.moveToTarget?this.moveTo2(t,i,e,n):null},resetPan:function(){this.timeLeft=0,this.currentKeyOffset.set(0,0),this.updateCurrentDir(null),this.dampingDistance=0,this.movelength=0},resetMove:function(){this.movelapse=0,this.resetPan(),this.resetZoom(),this.resetRotate(),this.setState(this.params.STATE.NONE)},resetRotate:function(){this.currentKeyAngle.set(0,0),this.moverotX=0,this.moverotY=0,this.currentX=this.lastX,this.currentY=this.lastY,this.timeLeftRotate=0,this.dampingAngleX=0,this.dampingAngleY=0},resetZoom:function(){!0===this.verbose&&c.log("reset zoom"),this.currentKeyZoom.set(0,0),this.zoomStart.copy(this.zoomEnd)},mousedown:function(t){if(!1===this.enabled)return!1;var i=this._getEvent(t);if(!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,!0===this.verbose&&c.log("mousedown "+i.button),this.isFrom3dViewer(i)){if(this.resetMove(),this.lastX=i.clientX,this.lastY=i.clientY,this.currentX=i.clientX,this.currentY=i.clientY,this.currentState===this.params.STATE.NONE){var n=i.button;!0===i.ctrlKey&&(n===this.params.STATE.PAN?(n=this.params.STATE.ROTATE,this.lastMouseFocus=null):n===this.params.STATE.ROTATE&&(n=this.params.STATE.PAN)),this.setState(n)}var s=new e.Vector2(i.clientX,i.clientY);return!0===this.verbose&&c.log(l.displayVector(s)),l.is(this.zoomMouse)&&!s.equals(this.zoomMouse)&&(this.zoomMouse.copy(s),this.repickExact=!0,this.zoomFocus=null),this.currentState!==this.params.STATE.ROTATE||this.params.noRotate?this.currentState!==this.params.STATE.ZOOM||this.params.noZoom?this.currentState!==this.params.STATE.PAN||this.params.noPan||(this.currentPan.set(i.clientX,i.clientY),this.lastPan.set(i.clientX,i.clientY),this.initPan(),!0===this.verbose&&c.log("mousedown"+l.displayVector(this.lastPan))):this.zoomStart=this.zoomEnd=this.getMouseOnScreen(i.clientX,i.clientY):(this.repickExact=!0,this.zoomFocus=null),this.buttonDown=1,!1}},mousemove:function(t){if(!1===this.enabled)return!1;var e=this._getEvent(t);!0===e.shiftKey?this.shiftKey=!0:this.shiftKey=!1,this.currentState!==this.params.STATE.NONE&&e.preventDefault(),this.currentState!==this.params.STATE.ROTATE||this.params.noRotate?this.currentState!==this.params.STATE.ZOOM||this.params.noZoom?this.currentState!==this.params.STATE.PAN||this.params.noPan||(this.currentPan.set(e.clientX,e.clientY),!0===this.verbose&&c.log("mousemove"+l.displayVector(this.currentPan))):this.zoomEnd=this.getMouseOnScreen(e.clientX,e.clientY):(this.currentX=e.clientX,this.currentY=e.clientY,this.noPick=!0),!0===this.verbose&&c.log("mousemove")},mouseup:function(t){if(!1===this.enabled)return!1;if(!1===this.enabled)return!1;this._getEvent(t);if(this.shiftKey=!1,!0===this.verbose&&c.log("mouseup"),this.noPick=null,this.currentState===this.params.STATE.PAN?(this.timeLeft=this.params.dampingTime,!0===this.verbose&&c.log(" damp pan start ")):this.currentState===this.params.STATE.ROTATE&&(this.timeLeftRotate=this.params.dampingTime,!0===this.verbose&&c.log(" damp rotate start ")),this.buttonDown=0,!0===this.repickExact){var e=this.exactPick(this.zoomMouse);l.isOut(e,this.urban)?!0===this.verbose&&c.log(" no exact pick 5 !! "+l.displayVector(this.zoomFocus)):(this.zoomFocus=e,this._lastPick.copy(e)),this.repickExact=!1}},mousewheel:function(t){if(!1===this.enabled)return!1;var i=this._getEvent(t);!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,l.is(i)&&UWA.Event.preventDefault(i),this.resetPan(),this.resetRotate();var n=0;i.wheelDelta?n=i.wheelDelta/40:i.detail&&(n=-i.detail),n=n>0?3:-3,!0===this.verbose&&c.log("wheel "+n),this.setState(this.params.STATE.ZOOM),this.zoomStart.y+=1/n*.05;var s=new e.Vector2(i.clientX,i.clientY);l.is(this.zoomMouse)&&!s.equals(this.zoomMouse)&&(this.zoomMouse.copy(s),this.repick=!0)},exactPick:function(t){if(!l.is(t))return null;!0===this.verbose&&c.log(" exact pick ...");var e=this.viewpoint.exactPick(t);if(l.is(e)){var i=this.getAltitudeFromVector(e);this.getAltitudeFromVector(this.position);if(l.isOut(e,this.urban))return!0===this.verbose&&c.log("pick dans lespace ..."),null;var n=-Math.abs(.001*this.position.z);i<Math.min(n,-1)&&!0===this.verbose&&console.warn("Pick error : picked altitude "+i+" "+n);var s=e.clone().sub(this.position);if(l.getAngleBetween(this.eye.clone(),s)>.5*Math.PI)return!0===this.verbose&&console.warn("Pick error : picked behind camera tgt alt : "+i+" cam alt :"+this.getAltitude()),null;if(!0===this.verbose&&c.log("pick "+l.displayVector(e)),this.debugPicking2){if(!l.is(this.node)){var r=new d.Color(1,0,0,1);this.node=u.createSphereNode({radius:10,color:r}),this.urban.getView3D().getScene().add(this.node)}var o=this.node.getMatrix(),a=e.clone();o.setPosition(a),this.node.setMatrix(o)}return e}return!0===this.verbose&&c.log("pas dintersection ..."),null},pick:function(t,i){return this.pick2D(!0,new e.Vector2(t,i))},pickFromRay:function(t,e){return this.viewpoint.fastPick(t,e)},pick2D:function(t,e,i){if(!l.is(e))return null;l.is(i)||(i=this.terrainHeight);var n=this.pickFromRay(e,i);return t&&l.isOut(n,this.urban)&&(n=null),!0===this.verbose&&c.log(" pick2D !! "+l.displayVector(n)),n},setState:function(t){t!==this.currentState&&(!0===this.verbose&&c.log(" from "+this.currentState+" to "+t),this.prevState=this.currentState,this.setCursor(t),this.currentState=t)},_getCursor:function(t){var e=g.getWebappsAssetUrl("UrbanWidget","")+"icons/32/",i="",n="";t===this.params.STATE.PAN?this.params.noPan||(i="Pan",n=" 15 15"):t===this.params.STATE.ZOOM?this.params.noZoom||(i="Zoom",n=" 13 13"):t===this.params.STATE.ROTATE&&(this.params.noRotate||(i="Rotate",n=" 16 15"));var s="url('"+e+"Urban"+i+".png')"+n+", url('"+e+"Urban"+i+".cur')"+n+", auto";return""===i&&(s="auto"),s},setCursor:function(t){var e=this,i=this._getCursor(t);this._changeCursorDelay&&(clearTimeout(this._changeCursorDelay),this._changeCursorDelay=null),this.params.cursorChangeDelay>0?this._changeCursorDelay=setTimeout(function(){e.domElement.style.cursor=i,e.urban.getView3D().webGLV6Viewer.setCursor(i,1,!0)},this.params.cursorChangeDelay):this.domElement.style.cursor=i},touchstart:function(t){if(!1===this.enabled)return!1;var i=this._getEvent(t);if(this.isFrom3dViewer(i)){!0===this.verbose&&c.log("touchstart "+this.startTouch),this.startTouch=this.startTouch+1,this.resetMove(),l.is(i)&&i.stopPropagation(),this.repickExact=!0,i=t.gesture.events[0].currentPosition;var n=new e.Vector2(i.x,i.y);l.is(this.zoomMouse)&&!n.equals(this.zoomMouse)&&(this.zoomMouse.copy(n),this.repickExact=!0,this.zoomFocus=null)}},touchmove:function(t){if(!1===this.enabled)return!1;!0===this.verbose&&c.log("touchmove");var i,n,s=t.gesture,r=this._getEvent(t);if(this.startTouch<1||void 0===s.touches||0===s.touches.length||!0===s.lastChange)return c.log("useless touch move"),!1;if(l.is(r)&&(r.preventDefault(),r.stopPropagation()),!0===this.verbose&&c.log(s.name),this.currentState===this.params.STATE.NONE)if("Pinch"===s.name)this.setState(this.params.STATE.TOUCH_ZOOM),this.touchZoomDistanceStart=s.distance,!0===this.verbose&&c.log("touchZoomDistanceStart init "+s.initDistance);else if("Swipe"===s.name)this.setState(this.params.STATE.TOUCH_PAN),this.lastPan.set(s.touches[0].currentPosition.x,s.touches[0].currentPosition.y),this.repickExact=!0,this.zoomMouse.copy(this.lastPan),this.initPan();else if("PinchPanRotate"===s.name){this.touchZoomDistanceStart=s.distance,!0===this.verbose&&c.log("touchZoomDistanceStart "+s.distance),this.setState(this.params.STATE.TOUCH_ROTATE),this.lastX=s.touches[0].currentPosition.x,this.lastY=s.touches[0].currentPosition.y,this.currentX=s.touches[0].currentPosition.x,this.currentY=s.touches[0].currentPosition.y,this.touchFirst1=new e.Vector2(this.currentX,this.currentY),this.touchFirst2=new e.Vector2(s.touches[1].currentPosition.x,s.touches[1].currentPosition.y),i=Math.floor((this.touchFirst1.x+this.touchFirst2.x)/2),n=Math.floor((this.touchFirst1.y+this.touchFirst2.y)/2);var o=new e.Vector2(i,n);this.lastPan.copy(o),this.currentPan.copy(this.lastPan),this.initPan(),l.is(this.zoomMouse)&&o.equals(this.zoomMouse)||(this.zoomMouse.copy(o),this.repick=!0),l.is(this.touchVeryFirst1)||(this.touchVeryFirst1=this.touchFirst1,this.touchVeryFirst2=this.touchFirst2),this.choice=0}if("Pinch"===s.name&&this.currentState===this.params.STATE.TOUCH_ZOOM)this.touchZoomDistanceEnd=s.distance,!0===this.verbose&&c.log("touchZoomDistanceEnd B  "+s.distance);else if("PinchPanRotate"===s.name&&this.currentState===this.params.STATE.TOUCH_TILT)this.currentY=s.touches[0].currentPosition.y;else if("PinchPanRotate"===s.name&&this.currentState===this.params.STATE.TOUCH_ROTATE){if(l.is(this.touchVeryFirst1)){var a=new e.Vector2(s.touches[0].currentPosition.x,s.touches[0].currentPosition.y),h=new e.Vector2(s.touches[1].currentPosition.x,s.touches[1].currentPosition.y),d=a.clone().sub(this.touchVeryFirst1).clone(),u=h.clone().sub(this.touchVeryFirst2).clone();if(0===this.choice&&s.distance<this.touchZoomDistanceStart*this.touchZoomStartFactor&&Math.abs(d.y)>Math.abs(2*d.x)&&Math.abs(u.y)>Math.abs(2*u.x))this.currentY=s.touches[0].currentPosition.y,this.setState(this.params.STATE.TOUCH_TILT),this.choice=1;else{this.touchLast1=a,this.touchLast2=h,this.touchZoomDistanceEnd=s.distance,!0===this.verbose&&c.log("touchZoomDistancend C "+s.distance),this.currentX=s.touches[0].currentPosition.x;s.touches[0].currentPosition.y;i=Math.floor((this.touchLast1.x+this.touchLast2.x)/2),n=Math.floor((this.touchLast1.y+this.touchLast2.y)/2),this.currentPan.set(i,n),0!==d.x&&0!==d.y&&0!==u.x&&0!==u.y&&(this.choice=-1)}}}else"Swipe"===s.name&&this.currentState===this.params.STATE.TOUCH_PAN&&this.currentPan.set(s.touches[0].currentPosition.x,s.touches[0].currentPosition.y)},touchend:function(t){if(!1===this.enabled)return!1;if(!0===this.verbose&&c.log("touchend "+this.startTouch),s.touchEnd(),this.startTouch=this.startTouch-1,this.touchVeryFirst1=null,this.getCurrentDir().length()>0&&this.currentState===this.params.STATE.TOUCH_PAN?(this.timeLeft=this.params.dampingTime,this.currentPan.copy(this.lastPan),this.lastMouseFocus=null):this.currentState===this.params.STATE.TOUCH_ROTATE?(this.timeLeftRotate=this.params.dampingTime,!0===this.verbose&&c.log(" damp rotate start ")):this.startTouch<=0&&(this.setState(this.params.STATE.NONE),this.startTouch=0,this.shiftKey=!1),!0===this.repickExact){var e=this.exactPick(this.zoomMouse);l.isOut(e,this.urban)?!0===this.verbose&&c.log(" no exact pick 8 !! "+l.displayVector(this.zoomFocus)):(this.zoomFocus=e,this._lastPick.copy(e)),this.repickExact=!1}},goToLatLonAlt:function(t){var e=l.toPos3D(this.urban,t.lat,t.lon,0);return this.moveTo(e,null,t.alt,1)},_getEvent:function(t){if(l.is(t.gesture)){var e=t.gesture.getEvents();if(l.is(e)&&e.length>0)return e[0].event}return null},getTime:function(){return l.is(this.openedAnimation)?this.openedAnimation.animationTime:0},setTime:function(t){if(l.is(t)){var e=0,i=1/0;if(l.is(this.openedAnimation)){var n=this.openedAnimation.getKeyframe(this.openedKeyframe.index-1);l.is(n)&&(e=n.time+1);var s=this.openedAnimation.getKeyframe(this.openedKeyframe.index+1);l.is(s)&&(i=s.time)}t>=e&&t<=i&&(this.openedKeyframe.time=t)}return this.openedKeyframe.time},setIndex:function(t){if(l.is(t)&&t>=0){var e=0;l.is(this.openedAnimation)&&(e=this.openedAnimation.size(),this.openedAnimation.duration()),t<e&&(this.openedKeyframe.index=t)}return this.openedKeyframe.index},recordKeyframe:function(){if(l.is(this.openedAnimation)){var t=this.getCurrentKeyframe(),e=this.openedKeyframe.index+1;if(e<=0)t.time=0;else if(e===this.openedAnimation.size())t.time=this.openedAnimation.duration()+this.defaulttimebetweenkeys;else{var i=0,n=0,s=this.openedAnimation.getKeyframe(e-1);l.is(s)?i+=l.is(s.time)?s.time:0:c.log("path error");var r=this.openedAnimation.getKeyframe(e);l.is(r)?n+=l.is(r.time)?r.time:i+this.defaulttimebetweenkeys:c.log("path error"),(t=this.getCurrentKeyframe()).time=.5*(i+n)}this.openedAnimation.addKeyframe(t,e),this.setIndex(this.openedKeyframe.index+1),this.updateOpenedKeyframe()}},removeKeyframe:function(){l.is(this.openedAnimation)&&(this.openedAnimation.removeKeyframe(this.openedKeyframe.index),this.updateOpenedKeyframe())},updateOpenedKeyframe:function(){if(l.is(this.openedAnimation)){var t=this.openedAnimation.getKeyframe(this.openedKeyframe.index);l.is(t)?this.setTime(t.time):(this.openedKeyframe.index=-1,this.openedKeyframe.time=-1)}},goToKeyframe:function(t){if(!l.is(this.openedAnimation))return null;var e=this.openedAnimation.goToKeyframe(this.openedKeyframe.index);return l.is(e)?(this.openedKeyframe.time=e.time,this.setCurrentAnimation(this.openedAnimation),!0):null},overWriteKeyframe:function(){if(!l.is(this.openedAnimation))return null;var t=this.getCurrentKeyframe();t.time=this.openedKeyframe.time,this.openedAnimation.setKeyframe(t,this.openedKeyframe.index),this.updateOpenedKeyframe()},play:function(){l.is(this.openedAnimation)&&this.setCurrentAnimation(this.openedAnimation),l.is(this.currentAnimation)&&this.currentAnimation.play()},setLoop:function(t){l.is(this.currentAnimation)&&this.currentAnimation.animation.setLoop(t)},pause:function(){l.is(this.currentAnimation)&&this.currentAnimation.pause()},stop:function(){l.is(this.currentAnimation)&&this.currentAnimation.stop()},setAnimationTime:function(t){var e=null;if(l.is(this.currentAnimation)?e=this.currentAnimation:l.is(this.openedAnimation)&&(e=this.openedAnimation),l.is(e))return!0===this.verbose&&c.log("anim set time : "+t),t=e.setTime(t),this.urban.USR.animId=Math.floor(1+t*this.timetoFps),t},setFile:function(t,e){if(l.is(e)){this.fichier=e;for(var i=JSON.parse(e),n=new o,s=0;s<i.length;s++)n.addKeyframe(new a(i[s]));this.paths[t]=new r(this,n,t,!1),this.setCurrentPath(t)}},getFile:function(){return l.is(this.openedAnimation)&&(this.fichier=JSON.stringify(this.openedAnimation.getKeyframes())),this.fichier},createPath:function(t){l.is(this.paths[t])||(this.paths[t]=new r(this,new o,t,!1))},setCurrentPath:function(t){l.is(this.paths[t])&&(this.openedAnimation=this.paths[t],this.setIndex(0))},readPthFile:function(t,i){var n,s,h,c,g,m=i.split("\n"),f=m.length,p=new e.Vector3,v=new o;for(n=0;n<f;n++){var _=m[n].split(" ");8===_.length&&(s=1e3*Number(_[0]),h=new e.Vector3(Number(_[1]),Number(_[2]),Number(_[3])).add(p).multiplyScalar(1),(c=new e.Quaternion(Number(_[4]),Number(_[5]),Number(_[6]),Number(_[7])).normalize()).normalize(),(g=new a({position:h,time:s})).setQuaternion(c),v.addKeyframe(g))}if(this.paths[t]=new r(this,v,t,!1),!0===this.debug){var b=v.getPositionSpline(),y=b.points;if(l.is(b.points)&&b.points.length>0){var w=new d.Color(1,0,0,1);for(n=0;n<b.points.length;n++)y[n]=b.points[n].clone();var P=u.createLineNode({points:y,width:500,color:w});for(P.name=t+"_line",this.urban.getView3D().getScene().add(P),y=b.getSpacedPoints(2e3),w=new d.Color(0,0,1,1),n=0;n<y.length;n++)y[n]=y[n].clone();(P=u.createLineNode({points:y,width:500,color:w})).name=t+"_spline",this.urban.getView3D().getScene().add(P)}}this.setCurrentPath(t)},updateZoomMouse:function(t){t.equals(this.zoomMouse)||(this.zoomMouse.copy(t),this.repickExact=!0,this.zoomFocus=null)},keydown:function(t){if(!1===this.enabled)return!1;if(!0!==this.urban._debugMode)return!1;var i=this.params.manipulationSpeedFactor*this.params.keysSpeed;i*=this.params.manipulationShiftSpeedFactor;var n=t.gesture.key,s=new e.Vector2;if("input"!==t.from[0].view.localName){var r=!1;switch(n){case this.params.Keys.PAN_LEFT:this.currentKeyOffset.x+=i,this.setState(this.params.STATE.KEYBOARD_PAN),r=!0;break;case this.params.Keys.PAN_FRONT:this.currentKeyOffset.y+=i,this.setState(this.params.STATE.KEYBOARD_PAN),r=!0;break;case this.params.Keys.PAN_RIGHT:this.currentKeyOffset.x-=i,this.setState(this.params.STATE.KEYBOARD_PAN),r=!0;break;case this.params.Keys.PAN_BACK:this.currentKeyOffset.y-=i,this.setState(this.params.STATE.KEYBOARD_PAN),r=!0;break;case this.params.Keys.ROTATE_LEFT:this.currentKeyAngle.x+=i,s.set(.5*this.screen.width+1,.5*this.screen.height+1),this.updateZoomMouse(s),this.setState(this.params.STATE.KEYBOARD_ROTATE),r=!0;break;case this.params.Keys.ROTATE_RIGHT:this.currentKeyAngle.x-=i,s.set(.5*this.screen.width+1,.5*this.screen.height+1),this.updateZoomMouse(s),this.setState(this.params.STATE.KEYBOARD_ROTATE),r=!0;break;case this.params.Keys.ROTATE_UP:this.currentKeyAngle.y+=i,s.set(.5*this.screen.width+1,.5*this.screen.height+1),this.updateZoomMouse(s),this.setState(this.params.STATE.KEYBOARD_ROTATE),r=!0;break;case this.params.Keys.ROTATE_DOWN:this.currentKeyAngle.y-=i,s.set(.5*this.screen.width+1,.5*this.screen.height+1),this.updateZoomMouse(s),this.setState(this.params.STATE.KEYBOARD_ROTATE),r=!0;break;case this.params.Keys.ZOOM_IN:this.currentKeyZoom.y+=i*(1/120*.05),s.set(.5*this.screen.width+1,.5*this.screen.height+1),this.updateZoomMouse(s),this.setState(this.params.STATE.KEYBOARD_ZOOM),r=!0;break;case this.params.Keys.ZOOM_OUT:this.currentKeyZoom.y-=i*(1/120*.05),s.set(.5*this.screen.width+1,.5*this.screen.height+1),this.updateZoomMouse(s),this.setState(this.params.STATE.KEYBOARD_ZOOM),r=!0;break;case this.params.Keys.RESET:this.resetMove();break;case this.params.Keys.KEYFRAME:this.recordKeyframe();break;case this.params.Keys.PLAY:this.play()}!0===r&&!0===this.verbose&&c.log("keydown"),!0===this._getEvent(t).shiftKey?this.shiftKey=!0:this.shiftKey=!1}},keyup:function(t){!0===this._getEvent(t).shiftKey?this.shiftKey=!0:this.shiftKey=!1},debugMove:function(){this.debug=!this.debug,this.debugMoveTo=!this.debugMoveTo},setParams:function(t){this.params=t},getParams:function(){return this.params},detachEvents:function(){},setCurrentHeight:function(t){this.terrainHeight!==t&&(this.terrainHeight=t)},pan2d:function(t){this.resetMove(),this.currentPan.copy(this.lastPan.set(.5*this.screen.width,.5*this.screen.height)),this.initPan(),this.currentPan.add(t),this.timeLeft=this.params.dampingTime,this.setState(this.params.STATE.KEYBOARD_PAN)},rotate2d:function(t){this.resetMove(),this.zoomFocus=null,this.lastX=this.currentX=.5*this.screen.width,this.currentY=this.lastY=.5*this.screen.width,this.currentX-=t.x,this.currentY-=t.y,this.timeLeftRotate=this.params.dampingTime,this.setState(this.params.STATE.KEYBOARD_ROTATE)},zoom2d:function(t){0!==t.y&&(this.resetMove(),this.zoomFocus=null,this.zoomStart.copy(this.zoomEnd.set(0,0)),this.zoomStart.y+=.05*t.y*.033,this.setState(this.params.STATE.KEYBOARD_ZOOM))},displayTarget:function(t){if(!0===this.params.targetDisplay){if(!l.is(this.targetDiv)){var i=document.getElementById("target_div");if(null===i)return;this.targetDiv=i}if(l.is(this.targetDiv))if(t){var n=new e.Vector2(.5*this.screen.width,.5*this.screen.height);l.is(this.zoomFocus)&&(n=this.viewpoint.getScreenPosition(this.zoomFocus)),this.targetDiv.style.visibility="visible",n.x-=.5*this.targetDiv.clientWidth,n.y-=.5*this.targetDiv.clientHeight,this.targetDiv.style.top=n.y+"px",this.targetDiv.style.left=n.x+"px"}else this.targetDiv.style.visibility="hidden"}},easing:function(t){return t*t*t*t*t},getLastPick:function(){return this._lastPick.clone()},getLastLatLon:function(){return f.proj(this.getLastPick(),f.getDefaultProjection(),"WGS84")},onMove:function(t){return i.subscribeTo(i.eventsList.pointOfView,t)},unsubscribe:function(t){return i.unsubscribe(t)},_onStopManip:function(t){this.resetMove()},_onEditEventBegin:function(t){}})}),define("DS/UrbanManipulator/GroundManipulator",["DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","DS/UrbanManipulator/Manipulator","DS/UrbanManipulator/ManipulatorParams","DS/UrbanManipulator/LocalisationManipulator","DS/UrbanManipulator/CameraAnimation","DS/UrbanManipulator/CameraAnimationPath","DS/UrbanManipulator/Keyframe","UWA/Class","DS/Visualization/Node3D","DS/UrbanTool/Utils","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Debug"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g){"use strict";return i.extend({init:function(t,e,i,n){var s=!1;d.is(n)&&(s=!0),this._parent(t,e,i,n),s||this.params.resetDefaultGroundValue(),this.type="ground"},rotateAround:function(t,e){return!0},panCamera:function(){return this.panCameraOld()},checkOnly:function(){var t=!0,e=this.getAltitude();return!(Math.abs(e-this.params.groundModeAltitude)>.001)&&(this.eye.normalize(),this.up.normalize(),this.up.z<0?t=!1:this.eye.z>.999&&(t=!1),t)},checkValues:function(){var t=!0,e=this.getAltitude();return Math.abs(e-this.params.groundModeAltitude)>.001&&(d.is(this.currentAnimation)&&this.checkH||(g.log("too low"),this.setAltitude(this.params.groundModeAltitude))),this.eye.normalize(),this.up.normalize(),this.up.z<0?(t=!0,this.up.z=0,this.up.normalize(),this.eye.x=0,this.eye.y=0,this.eye.normalize(),this.target.copy(this.position.clone().add(this.eye.setLength(this.distanceToTarget))),this.setAltitude(this.params.groundModeAltitude)):this.eye.z>.999&&(t=!0,this.eye.z=.998,this.eye.normalize(),0===this.eye.x&&0===this.eye.y?(this.up.z=0,this.up.normalize()):this.up=d.getUpFromCameraEye(this.eye.clone()).normalize(),this.target.copy(this.position.clone().add(this.eye.setLength(this.distanceToTarget))),this.setAltitude(this.params.groundModeAltitude),this.zoomFocus=null),this.distanceToTarget<this.viewpoint.camera.near+1&&(this.distanceToTarget=this.viewpoint.camera.near+1,this.position.copy(this.target.clone().sub(this.eye.setLength(this.distanceToTarget))),t=!0),t},moveToClick:function(t,e){var i=this.exactPick(t);if(d.is(i)&&this.getAltitudeFromVector(i)<8848){var n=e*this.position.distanceTo(i),s=this.urban.USR.getGroundHeight(i.x,i.y);return s*=this.urban.USR.scale,this.setAltitudeToVector(i,this.params.groundModeAltitude+s),this.moveTo3(i,n,void 0,void 0)}return null},faceNorth:function(){this.distanceToTarget;var e=this.getCurrentKeyframe();e.date=null,e._target=null;var i=d.getNorthAngle(this.eye,this.up),n=e.getQuaternion(),s=e.clone(),a=new t.Quaternion;a.setFromAxisAngle(d.vertical.clone(),.5*-i);var h=a.multiply(n);s.setQuaternion(h),s.time=.5*this.params.northMoveDuration*1e3;var l=e.clone(),u=new t.Quaternion;u.setFromAxisAngle(d.vertical.clone(),-i),h=u.multiply(n),l.setQuaternion(h),l.time=1e3*this.params.northMoveDuration;var c=new o;c.addKeyframe(e),c.addKeyframe(s),c.addKeyframe(l);var g=new r(this,c,"facenorth");return this.setCurrentAnimation(g)},faceVerticalNorth:function(){this.distanceToTarget;var e=this.getCurrentKeyframe();e.date=null,e._target=null;var i=e.getQuaternion(),n=e.clone(),s=new t.Quaternion;if(s.setFromAxisAngle(new t.Vector3(1,0,0),.5*Math.PI),!i.equals(s)){n.setQuaternion(s),n.time=1e3*this.params.northMoveDuration;var a=new o;a.addKeyframe(e),a.addKeyframe(n);var h=new r(this,a,"facenorthhorinzontal");return this.setCurrentAnimation(h)}},activate:function(t){if(this.enabled=!0,!0===this.verbose&&g.log(" activate ground manip"),this.resetMove(),this.askedmove=null,this.askedmovepos=null,this.initEvents(),this.checkH=!0,!(this.params.noAnimationOnActivation||d.is(t)&&d.is(t.noAnimationOnActivation))){var e=this.eye.clone();0===e.x&&0===e.y&&(e=this.up.clone()),e.z=0,e.normalize();var i=this.target.clone(),n=(Math.max(this.params.groundModeAltitude,this.getAltitudeFromVector(this.target)),this.urban.USR.getGroundHeight(this.target.x,this.target.y));n*=this.urban.USR.scale,this.setAltitudeToVector(i,this.params.groundModeAltitude+n);var r=Math.max(this.params.defaultDistanceOnActivation,this.eye.z*-this.params.groundModeAltitude);this.moveTo3(i,r,e,this.params.manipTransitionDuration)}s.enableInterns(!0),s.zoomEnable(!1)},_getFinalPositionFromViewpoint:function(t,e,i){var n=t.clone().sub(i.normalize().multiplyScalar(e)),s=this.urban.USR.getGroundHeight(n.x,n.y);s*=this.urban.USR.scale;var r=this.params.groundModeAltitude+s;return this.getAltitudeFromVector(n)!==r&&(this.setAltitudeToVector(n,r),(i=t.clone().sub(n)).normalize()),!0===this.verbose&&g.log("moveto3 to: "+d.displayVector(n)),n},setAltitude:function(t){this.position.z=this.terrainHeight+this.params.groundModeAltitude},setCurrentHeight:function(t){if(d.is(t)&&this.terrainHeight!==t){d.is(this._terrainLastHeights)||(this._terrainLastHeights=[]),this._terrainLastHeights.length>5&&this._terrainLastHeights.shift(),this._terrainLastHeights.push(t);for(var e=this._terrainLastHeights.length,i=0,n=0;n<e;n++)i=Math.max(this._terrainLastHeights[n],i);this.terrainHeight=i}}})}),define("DS/UrbanTool/MeasureDistance",["DS/UrbanTool/DrawingManipulatorTool","UWA/Core","i18n!DS/UrbanTool/assets/nls/measureDistance"],function(t,e,i){"use strict";return t.extend({init:function(t,e){this._parent(t),this.urban=t,this.type=e,"distance"===e?this.measureType="polyline":"surface"===e?this.measureType="polygon":console.warn("unknown measuretool type (distance / surface)"),this.parentDiv=this.urban.frmWindow.getUIFrame(),this.textSegment=i.get("3DXCity.MeasureDistance.UI.Text.Segment"),this.textPolyline=i.get("3DXCity.MeasureDistance.UI.Text.Polyline"),this.textPolygon=i.get("3DXCity.MeasureDistance.UI.Text.Polygon"),this.textArea=i.get("3DXCity.MeasureDistance.UI.Text.Area"),this.textStart=i.get("3DXCity.MeasureDistance.UI.Text.Start"),this.defaultContext={Line:{id:"drawnLine",name:i.get("3DXCity.MeasureDistance.Treeview.Text.DrawnLine")},Folder:{id:"mesure",name:i.get("3DXCity.MeasureDistance.Treeview.Text.Mesure")}},this.cssStylesContent={position:"absolute",margin:"auto",padding:"6px",textAlign:"center",backgroundColor:"rgba(161, 229, 255, 0.78)",border:"solid 2px rgba(161, 229, 255, 0.8)",pointerEvents:"none",borderRadius:"6px"},this.setCurrentContext(this.defaultContext)},setCurrentContext:function(t){return this.context=this._contextCopyOf(this.defaultContext),Utils.is(t)&&(Utils.is(t.Line)&&(this.context.Line={id:t.Line.id||this.defaultContext.Line.id,name:t.Line.name||this.defaultContext.Line.name}),Utils.is(t.Folder)&&(this.context.Folder={id:t.Folder.id||this.defaultContext.Folder.id,name:t.Folder.name||this.defaultContext.Folder.name})),this._parent(t)},onBreakLoop:function(t){this._parent(t),2===t.length&&(t[1].ph.div.style.visibility="visible"),t[0].ph.text.innerHTML=this.textStart},onAddAnchor:function(t,i){if((t=this._parent(t,i)).div=e.createElement("div",{id:"anchorDiv",styles:this.cssStylesContent}),t.div.inject(this.parentDiv),t.text=document.createElement("p"),t.text.style.pointerEvents="none",t.text.style.textAlign="justify",t.div.appendChild(t.text),i.length>1){var n=this._computeDistance(i.length-1,i),s=this._formatMeasures(n);2!==i.length?(t.text.innerHTML=this.textSegment+s.fpl.value+" "+s.fpl.unit+".<BR>",t.text.innerHTML+=this.textPolyline+s.total.value+" "+s.total.unit+"."):t.text.innerHTML+=this.textSegment+s.total.value+" "+s.total.unit+"."}else t.text.innerHTML=this.textStart;this.divStyleHeight=parseFloat(window.getComputedStyle(t.div).height),t.div.style.top=t.pos2D.y-this.divStyleHeight+"px",t.div.style.left=t.pos2D.x+20+"px";for(var r=1;r<i.length-1;r++)i[r].ph.div.style.visibility="hidden"},onCreateLoop:function(t){return t[t.length-1].ph.div.style.visibility="hidden",!0},onRemoveAnchor:function(t,e){return t.index===e.length-1&&e.length>1&&(e[t.index-1].ph.div.style.visibility="visible"),void 0!==t.div&&this.parentDiv.removeChild(t.div),!0},onManipulateAnchor:function(t){t.div.style.top=t.pos2D.y-this.divStyleHeight+"px",t.div.style.left=t.pos2D.x+20+"px"},onBeginPreactivateAnchor:function(t){return t.div.style.visibility="visible",!0},onEndPreactivateAnchor:function(t,e){return t.locked||0===t.index||t.index===e.length-1||(t.div.style.visibility="hidden"),!0},_computeDistance:function(t,e){if(t>=1){for(var i=e[t].ph.pos3D.clone().sub(e[t-1].ph.pos3D),n=i.length(),s=0,r=1;r<=t;r++)s+=(i=e[r].ph.pos3D.clone().sub(e[r-1].ph.pos3D)).length();return{fpl:n,total:s}}return{fpl:0,total:0}},_computePolygonArea:function(t){for(var e={},i={},n=0,s=t[0].ph.pos3D,r=t.length,o=2;o<r;o++){var a=t[o-1].ph.pos3D,h=t[o].ph.pos3D;e.x=s.x-h.x,e.y=s.y-h.y,i.x=s.x-a.x,i.y=s.y-a.y,n+=e.x*i.y-e.y*i.x}return{polygonArea:Math.abs(n/2)}},onUpdate:function(t,e){this.loop=t;var i=e.length;this.loop&&i--,this._updateDistanceMeasure(i,e)},_updateDistanceMeasure:function(t,e){var i;for(i=0;i<t;i++)0!==i?this._updateAnchorText(i,e):this.loop&&this._updateLastAnchorText(t,e)},_updateAnchorText:function(t,e){var i=this._computeDistance(t,e),n=this._formatMeasures(i);1!==t?(e[t].ph.text.innerHTML=this.textSegment+n.fpl.value+" "+n.fpl.unit+".<BR>",e[t].ph.text.innerHTML+=this.textPolyline+n.total.value+" "+n.total.unit+"."):e[t].ph.text.innerHTML=this.textSegment+n.total.value+" "+n.total.unit+"."},_updateLastAnchorText:function(t,e){var i=this._computeDistance(t,e),n=this._formatMeasures(i);e[0].ph.text.innerHTML=this.textPolygon+n.total.value+" "+n.total.unit+".<BR>","surface"===this.type&&(i=this._computePolygonArea(e),n=this._formatMeasures(i),e[0].ph.text.innerHTML+=this.textArea+n.area.value+" "+n.area.unit+".")},_formatMeasures:function(t){var e=function(t){if(Utils.is(t)){var e=Math.round(100*t)/100,i="m";return e>1e3&&(e=Math.round(100*e/1e3)/100,i="km"),{value:e,unit:i}}};return{fpl:e(t.fpl),total:e(t.total),area:function(t){if(Utils.is(t)){var e=Math.round(100*t)/100,i="m2";return e>1e6&&(e=Math.round(100*e/1e6)/100,i="km2"),{value:e,unit:i}}}(t.polygonArea)}},onCameraUpdate:function(t){if(this.urban.getViewpoint().camMoved){var e=t.length;this.loop&&e--;for(var i=0;i<e;i++){var n=this.urban.getView3D().viewpoint.getScreenPosition(t[i].ph.pos3D);t[i].ph.div.style.top=n.y-this.divStyleHeight+"px",t[i].ph.div.style.left=n.x+20+"px"}}},onFinish:function(t){this._parent(t),this._removeAllAnchorDiv(t),this._removeMeasureFeature()},onDestroy:function(t,e){this.onFinish(e)},_removeAllAnchorDiv:function(t){if(t)for(var e=0;e<t.length;e++)void 0!==t[e].ph.div&&this.parentDiv.removeChild(t[e].ph.div)},_removeMeasureFeature:function(){var t=xCity.findItem({id:this.context.Line.id});void 0!==t&&"mesure"===t.getParentFolder().get("id")&&xCity.removeChild(t)}})}),define("DS/UrbanManipulator/CarManipulator",["DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","DS/UrbanManipulator/Manipulator","DS/UrbanManipulator/ManipulatorParams","DS/UrbanManipulator/LocalisationManipulator","DS/UrbanManipulator/CameraAnimation","DS/UrbanManipulator/CameraAnimationPath","DS/UrbanManipulator/Keyframe","UWA/Class","DS/Visualization/Node3D","DS/UrbanTool/Utils","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Debug","DS/UrbanManipulator/GroundManipulator","DS/UrbanFeature/Coordinate"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g,m,f){"use strict";return i.extend({init:function(t,e,i,n){this._parent(t,e,i,n),this.type="car",this.turnOffset=0,this.acceleration=0},activate:function(t){this._parent(t),this.urban._setDebugMode(!0)},updateCarPosition:function(){var e=new t.Vector3(0,-20,0);if(d.is(this._lastCarPosition)){var i=this._lastCarPosition.clone();i.sub(this.target),i.setLength(20),this._lastCarPosition=this.target.clone(),this._lastCarPosition.add(i)}else this._lastCarPosition=this.target.clone(),this._lastCarPosition.add(e);return this._lastCarPosition.z=.2,this._lastCarPosition},updateCarOrientation:function(){var t=this._lastCarPosition.clone().sub(this.target);return d.getNorthAngle(t,this.up)},lerp:function(t,e,i){if(!d.is(t))return d.is(e)?e:null;if(!d.is(e))return t;var n=t.clone(),s=e.clone();return n.multiplyScalar(1-i),s.multiplyScalar(i),n.add(s)},update:function(t){if(!0!==t)return!1;this.turn(this.turnOffset),this.accelerate(this.acceleration),this._parent(t);var e=this.updateCarPosition();this.updateCoordinatePosition(e,d.toDeg(this.updateCarOrientation()))},updateCoordinatePosition:function(e,i){var n,s,r;if(n=this._car,d.is(n)&&(d.is(n.impl)?r=n.impl.getContent():d.is(n.getContent)&&(r=n.getContent()),d.is(r))){s=r.get("Coordinate"),d.is(s)||(s=new f({projection:this.urban.getUserDefaultProjection()})).create(this.urban);var o=e;s.set("position",o),s.set("rotation",new t.Vector3(0,0,i+90)),r.set("Coordinate",s)}},addModel:function(t){this._car=t},keepturn:function(t){this.turnOffset=.25*t},stopturn:function(){this.turnOffset=0},keepaccelerate:function(t){this.acceleration=.5*t},stopaccelerate:function(){this.acceleration=0},turn:function(t){0!==t&&(this.turn2d(this.currentKeyOffset,.25*t),this.setState(this.params.STATE.KEYBOARD_PAN))},turn2d:function(t,e){var i=Math.cos(e)*t.x-Math.sin(e)*t.y,n=Math.sin(e)*t.x+Math.cos(e)*t.y;return t.x=i,t.y=n,t},turnLeft:function(t){this.turn2d(this.currentKeyOffset,.25*-t),this.setState(this.params.STATE.KEYBOARD_PAN)},turnRight:function(t){this.turn2d(this.currentKeyOffset,.25*t),this.setState(this.params.STATE.KEYBOARD_PAN)},accelerate:function(t){if(0!==t){var e=this.currentKeyOffset.length();0!==e?this.currentKeyOffset.setLength(e+t):this.currentKeyOffset.y+=t,this.setState(this.params.STATE.KEYBOARD_PAN)}},resetMove:function(){this._parent(),this.turnOffset=0,this.acceleration=0},decelerate:function(t){this.acceleration-=.5*t},keydown:function(e){if(!1===this.enabled)return!1;if(!0!==this.urban._debugMode)return!1;var i=this.params.manipulationSpeedFactor*this.params.keysSpeed;i*=this.params.manipulationShiftSpeedFactor;var n=e.gesture.key;new t.Vector2;if("input"!==e.from[0].view.localName){var s=!1;switch(n){case this.params.Keys.PAN_LEFT:this.keepturn(-i),s=!0;break;case this.params.Keys.PAN_FRONT:this.keepaccelerate(i),s=!0;break;case this.params.Keys.PAN_RIGHT:this.keepturn(i),s=!0;break;case this.params.Keys.PAN_BACK:this.decelerate(i),s=!0;break;case this.params.Keys.RESET:this.resetMove();break;case this.params.Keys.KEYFRAME:this.recordKeyframe();break;case this.params.Keys.PLAY:this.play()}!0===s&&!0===this.verbose&&g.log("keydown"),!0===this._getEvent(e).shiftKey?this.shiftKey=!0:this.shiftKey=!1}},keyup:function(e){if(!1===this.enabled)return!1;if(!0!==this.urban._debugMode)return!1;var i=this.params.manipulationSpeedFactor*this.params.keysSpeed;i*=this.params.manipulationShiftSpeedFactor;var n=e.gesture.key;new t.Vector2;if("input"!==e.from[0].view.localName){var s=!1;switch(n){case this.params.Keys.PAN_RIGHT:case this.params.Keys.PAN_LEFT:this.stopturn(i),s=!0;break;case this.params.Keys.PAN_FRONT:this.stopaccelerate(i),s=!0}!0===s&&!0===this.verbose&&g.log("keyup"),!0===this._getEvent(e).shiftKey?this.shiftKey=!0:this.shiftKey=!1}}})}),define("DS/UrbanManipulator/UndergroundManipulator",["DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","DS/UrbanManipulator/Manipulator","DS/UrbanManipulator/ManipulatorParams","DS/UrbanManipulator/LocalisationManipulator","DS/UrbanManipulator/CameraAnimation","DS/UrbanManipulator/CameraAnimationPath","DS/UrbanManipulator/Keyframe","UWA/Class","DS/Visualization/Node3D","DS/UrbanTool/Utils","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Debug"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g){"use strict";return i.extend({init:function(t,e,i,n,s){this._parent(t,e,i,n),this.type="underground",this.undergroundVisu=s},mousedown:function(e){if(!1===this.enabled)return!1;var i=this._getEvent(e);if(!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,!0===this.verbose&&g.log("mousedown "+i.button),this.isFrom3dViewer(i)){if(this.resetMove(),this.lastX=i.clientX,this.lastY=i.clientY,this.currentX=i.clientX,this.currentY=i.clientY,this.currentXY=new t.Vector2(i.clientX,i.clientY),this.currentState===this.params.STATE.NONE){var n=i.button;!0===i.ctrlKey&&(n===this.params.STATE.PAN?n=this.params.STATE.NONE:n===this.params.STATE.ROTATE&&(n=this.params.STATE.PAN)),this.setState(n)}var s=new t.Vector2(i.clientX,i.clientY);return!0===this.verbose&&g.log(d.displayVector(s)),d.is(this.zoomMouse)&&s.equals(this.zoomMouse)||(this.zoomMouse.copy(s),this.repickExact=!0,this.zoomFocus=null),this.currentState!==this.params.STATE.ROTATE||this.params.noRotate?this.currentState!==this.params.STATE.ZOOM||this.params.noZoom?this.currentState!==this.params.STATE.PAN||this.params.noPan||(this.currentPan.set(i.clientX,i.clientY),this.lastPan.set(i.clientX,i.clientY),this.initPan(),!0===this.verbose&&g.log("mousedown"+d.displayVector(this.lastPan))):this.zoomStart=this.zoomEnd=this.getMouseOnScreen(i.clientX,i.clientY):(this.repickExact=!0,this.zoomFocus=null),this.buttonDown=1,!1}},mousemove:function(e){if(!1===this.enabled)return!1;var i=this._getEvent(e);!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,this.currentXY=new t.Vector2(i.clientX,i.clientY),this.currentState!==this.params.STATE.ROTATE||this.params.noRotate?this.currentState!==this.params.STATE.ZOOM||this.params.noZoom?this.currentState!==this.params.STATE.PAN||this.params.noPan||(this.currentPan.set(i.clientX,i.clientY),!0===this.verbose&&g.log("mousemove"+d.displayVector(this.currentPan))):this.zoomEnd=this.getMouseOnScreen(i.clientX,i.clientY):(this.currentX=i.clientX,this.currentY=i.clientY,this.noPick=!0),!0===this.verbose&&g.log("mousemove")},mouseup:function(t){if(!1===this.enabled)return!1;var e=this._getEvent(t);if(this.shiftKey=!1,!0===this.verbose&&g.log("mouseup"),this.noPick=null,this.currentState===this.params.STATE.PAN?(this.timeLeft=this.params.dampingTime,!0===this.verbose&&g.log(" damp pan start ")):this.currentState===this.params.STATE.ROTATE&&(this.timeLeftRotate=this.params.dampingTime,!0===this.verbose&&g.log(" damp rotate start ")),this.lastX===e.clientX&&(this.lastY,e.clientY),this.buttonDown=0,!0===this.repickExact){var i=this.exactPick(this.zoomMouse);d.isOut(i,this.urban)?!0===this.verbose&&g.log(" no exact pick !! "+d.displayVector(this.zoomFocus)):(this.zoomFocus=i,this._lastPick.copy(i)),this.repickExact=!1}},mousewheel:function(e){if(!1===this.enabled)return!1;var i=this._getEvent(e);!0===i.shiftKey?this.shiftKey=!0:this.shiftKey=!1,d.is(i)&&i.preventDefault(),this.resetPan(),this.resetRotate();var n=0;i.wheelDelta?n=i.wheelDelta/40:i.detail&&(n=-i.detail),n=n>0?3:-3,!0===this.verbose&&g.log("wheel "+n),this.setState(this.params.STATE.ZOOM),this.zoomStart.y+=1/n*.05;var s=new t.Vector2(i.clientX,i.clientY);d.is(this.zoomMouse)&&s.equals(this.zoomMouse)||(this.zoomMouse.copy(s),this.repickExact=!0)},exactPick:function(t,e){!0===this.verbose&&g.log(" exact pick ..."),e&&(this.undergroundVisu._renderPassManager.disablePass(this.undergroundVisu._undergroundStencilPass_id),this.undergroundVisu._renderPassManager.disablePass(this.undergroundVisu._windowFillPass_id),this.undergroundVisu._renderPassManager.disablePass(this.undergroundVisu._undergroundClearDepthPass_id),this.undergroundVisu._renderPassManager.disablePass(this.undergroundVisu._undergroundPostPass_id));var i=this.viewpoint.exactPick(t);return e&&(this.undergroundVisu._renderPassManager.enablePass(this.undergroundVisu._undergroundStencilPass_id),this.undergroundVisu._renderPassManager.enablePass(this.undergroundVisu._windowFillPass_id),this.undergroundVisu._renderPassManager.enablePass(this.undergroundVisu._undergroundClearDepthPass_id),this.undergroundVisu._renderPassManager.enablePass(this.undergroundVisu._undergroundPostPass_id)),d.is(i)?i:(!0===this.verbose&&g.log("pas dintersection ..."),null)}})}),define("DS/UrbanManipulator/Localisator",["UWA/Core","UWA/Class","DS/UrbanManipulator/LocalisationManipulator"],function(t,e,i){"use strict";return e.extend({init:function(e,i){this.container=t.createElement("div",{id:"Boussole"}),this.container.inject(e),this.container.control=this;var n=this.container.ownerDocument,s=n.createDocumentFragment(),r=this.create(n);s.appendChild(r),this.container.appendChild(s);var o=n.createElement("div");o.id="target_div",e.appendChild(o),this.targetDiv=o},create:function(t){var e=t.createElement("div");e.id="Urbanlocalisator",e.style["touch-action"]="none";var i=t.createElement("div");i.id="boussole_circle_div",e.appendChild(i);var n=t.createElement("div");n.id="boussole_circle",i.appendChild(n);var s=t.createElement("div");s.id="boussole_arrow",i.appendChild(s);var r=t.createElement("div");r.id="gui_pan_div",e.appendChild(r);var o=t.createElement("div");o.id="gui_pan_bg",r.appendChild(o);var a=t.createElement("div");a.id="gui_pan_arrows",o.appendChild(a);var h=t.createElement("div");h.id="gui_zoom_div",e.appendChild(h);var l=t.createElement("div");l.id="gui_zoom_bg",h.appendChild(l);var d=t.createElement("div");d.id="gui_zoom_slider",l.appendChild(d);var u=t.createElement("div");u.id="gui_slider_icon",u.className="fonticon fonticon-search",d.appendChild(u);var c=t.createElement("div");c.id="gui_zoom_plus",h.appendChild(c);var g=t.createElement("div");return g.id="gui_zoom_moins",h.appendChild(g),e},bindEvents:function(){i&&i.initEvents()},hide:function(){this._visibleFlag=!1,this.container.hide()},show:function(){this._visibleFlag=!0,this.container.show()},setAlignment:function(t){var e,i=["top","bottom","left","right"];for(e=0;e<i.length;e++)this.container.classList.contains(i[e])&&this.container.classList.remove(i[e]);this._alignment=t,this.container.classList.add(t)},getAlignment:function(){return this._alignment},getVisibility:function(){return this._visibleFlag}})}),define("DS/UrbanTool/Recorder",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityTools/Debug","DS/UrbanTool/Utils"],function(t,e,i,n,s,r){"use strict";return UWA.Class.extend({init:function(t){this._urban=t,this._controls=this._urban.controls,this._capture=!1,this._shootFrame=!1,this._animId=1,this._lastFrameTimeShooted=0,this._videoFrameRate=25,this._maxTimeBetweenTwoFrames=3e4,this._singleCapture=!1,this._frameId=1,this._fileName=void 0},setVideoFrameRate:function(t){this._videoFrameRate=t},takeSingleSnap:function(t){var e=this._urban.getView3D().getGLViewer(),i="ddl",n=e.SCREEN_WIDTH,s=e.SCREEN_HEIGHT,o="";(t&&void 0!==t.output&&(i=t.output),t&&void 0!==t.width&&(n=t.width),t&&void 0!==t.height&&(s=t.height),t&&void 0!==t.fileName)?o=".png"===t.fileName.substring(t.fileName.length-4).toLowerCase()?t.fileName:t.fileName+".png":(o="xCitySnap_"+this._frameId+".png",this._frameId++);var a={width:n,height:s,data:null};e.renderToTarget(a,this._urban.getView3D().viewpoint);var h=a.data;if(null===a.data)return null;var l=document.createElement("canvas");l.width=a.width,l.height=a.height;for(var d=l.getContext("2d"),u=d.createImageData(a.width,a.height),c=new Uint8ClampedArray(4*a.width*a.height),g=0;g<a.width;g++)for(var m=0;m<a.height;m++){var f=m*a.width+g,p=(a.height-1-m)*a.width+g;c[4*f]=h[4*p],c[4*f+1]=h[4*p+1],c[4*f+2]=h[4*p+2],c[4*f+3]=h[4*p+3]}return u.data.set(c),d.putImageData(u,0,0),"blob"===i?r.dataURItoBlob(l.toDataURL()):"URI"===i?l.toDataURL():void r.toDownloadFile(o,r.dataURItoBlob(l.toDataURL()))},_captureCanvas:function(){return r.dataURItoBlob(this._urban.getView3D().getCanvas().toDataURL())},takeASnap:function(){!0===this._capture?(this._urban.getView3D().forceUpdate=!0,!0===this._shootFrame&&(r.toDownloadFile("xCityFrame_"+this._animId+".png",this._captureCanvas()),this._lastFrameTimeShooted=Date.now(),this._animId++,s.log("[Recorder] capture frame "+this._animId))):!0===this._singleCapture&&(r.toDownloadFile(fileName,this.drawInCanvas()),this._singleCapture=!1)},check:function(){if(!0===this._capture){var t=Date.now()-this._lastFrameTimeShooted;if(!0===this._urban.USR.dataReadyForRender()||this._animId>1&&t>this._maxTimeBetweenTwoFrames?this._shootFrame=!0:this._shootFrame=!1,!0===this._shootFrame)this._urban.getControl().currentAnimation.setFrame(this._animId,this._videoFrameRate)||(this._capture=!1,this._animId=1)}},isRecording:function(){return this._capture},startRecord:function(){this._capture=!0},stopRecord:function(){this._capture=!1}})}),define("DS/UrbanManipulator/UndergroundSelectionManipulator",["DS/Visualization/ThreeJS_DS","DS/UrbanManipulator/Manipulator","DS/UrbanManipulator/ManipulatorParams","DS/XCityTools/EventDispatcher"],function(t,e,i,n){"use strict";return e.extend({init:function(e,i,n,s){this._parent(e,i,n,s),this.selectingArea=!1,this.firstFinal=null,this.lastFinal=null,this.areaBL=null,this.areaTR=null,this.clickedPosition=new t.Vector2(0,0),this.currentPosition=new t.Vector2(0,0),this.previewCrop=!1,this.done=!1,this.tokenLeftMouseUp=null,this.tokenLeftMouseDown=null,this.tokenKeyDown=null},activate:function(){this.urban.getView3D().webGLV6Viewer.setManipulators({activated:!0,preActivate:!1}),this.initEvents()},deactivate:function(){this.urban.getView3D().webGLV6Viewer.setManipulators({activated:!1,preActivate:!1}),this.detachEvents()},initEvents:function(){if(!0!==this._initialized){n.Initialize(this.domElement);var t=this;this.changeEvent={type:"change"},this.mmoveToken=void 0;var e=function(e){t.mousedown(e),t.mmoveToken=n.subscribeToMouseMove(t.mousemove.bind(t))}.bind(t),i=function(e){t.mouseup(e),n.unsubscribe(t.mmoveToken),t.mmoveToken=void 0}.bind(t);this.unmin=function(e){t.unminimize(e)},this.tokenLeftMouseDown=n.subscribeToLeftMouseDown(e),this.tokenLeftMouseUp=n.subscribeToLeftMouseUp(i),this.tokenKeyDown=n.subscribeTo("/VISU/onKeyDown",this.keydown.bind(this)),this.domElement.onkeypress=function(){Debug.log("keypress baaby")},this.handleResize(),this._initialized=!0}},mousedown:function(e){var i=this._getEvent(e);if(0===i.button){var n=new t.Vector2(i.clientX,i.clientY),s=this.exactPick(n);null!==s&&(s.z=s.z/this.urban.USR.scale,this.clickedPosition=s)}},mouseup:function(e){0===this._getEvent(e).button&&this.previewCrop&&(this.done=!0,this.firstFinal=new t.Vector2(Math.min(this.clickedPosition.x,this.currentPosition.x),Math.min(this.clickedPosition.y,this.currentPosition.y)),this.lastFinal=new t.Vector2(Math.max(this.clickedPosition.x,this.currentPosition.x),Math.max(this.clickedPosition.y,this.currentPosition.y)))},mousemove:function(e){var i=this._getEvent(e);if(0===i.button){var n=new t.Vector2(i.clientX,i.clientY),s=this.exactPick(n);null!==s&&(s.z=s.z/this.urban.USR.scale,this.previewCrop||(this.previewCrop=!0),this.currentPosition=s)}},update:function(){this.previewCrop&&(this.areaBL=new t.Vector3(Math.min(this.clickedPosition.x,this.currentPosition.x),Math.min(this.clickedPosition.y,this.currentPosition.y),Math.min(this.clickedPosition.z,this.currentPosition.z)),this.areaTR=new t.Vector3(Math.max(this.clickedPosition.x,this.currentPosition.x),Math.max(this.clickedPosition.y,this.currentPosition.y),Math.max(this.clickedPosition.z,this.currentPosition.z)))},detachEvents:function(){n.unsubscribe(this.tokenLeftMouseUp),n.unsubscribe(this.tokenLeftMouseDown),n.unsubscribe(this.tokenKeyDown)},getManipulationState:function(){return this.currentState},startAreaSelection:function(){this.selectingArea=!0},endAreaSelection:function(){},isSelectionDone:function(){return this.done},isPreviewEnabled:function(){return this.previewCrop},getFinalAreaBL:function(){return this.firstFinal},getFinalAreaTR:function(){return this.lastFinal},getAreaBL:function(){return this.areaBL},getAreaTR:function(){return this.areaTR},getData:function(){var t=(this.areaBL.z+this.areaTR.z)/2;return{xmin:this.areaBL.x,ymin:this.areaBL.y,xmax:this.areaTR.x,ymax:this.areaTR.y,height:t}}})}),define("DS/UrbanManipulator/DrawingManipulator",["DS/Manipulators/PointHandle","DS/UrbanAPI/xCityItem","DS/UrbanManipulator/Manipulator","DS/XCityTools/Geocoder","DS/UrbanTool/Utils","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/UrbanTool/DrawingManipulatorTool","DS/xCityBasicUtils/DataFormatTools","DS/SceneGraphNodes/FixedSizeNode3D","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Robot/LineTranslationNode","DS/XCityTools/ShaderTools"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g){"use strict";return i.extend({init:function(t,e,i,n,r){this.anchorRootNode=new c,this.anchorOffsetNode=new c,this._inverseCoordinate=new u.Matrix4,this._parent(t,i,n,r),this.urban=t,this.tool=this._getTool(e)||new a(t),this.type=this.tool.type,this.clickToken=null,this.doubleClickToken=null,this.onUpdateToken=null,this.urban.getView3D()._rootProjShifted.addChild(this.anchorOffsetNode),this.anchorOffsetNode.addChild(this.anchorRootNode),this.clickedColor=new u.Color("#00BFFE"),this.pointColor=new u.Color("#FFFFFF"),this.segmentColor=new u.Color("red"),this._defaultRoofHeight=this.tool.isHouse()?2:0,this._defaultRoofAngle=45,this._defaultHouseWidth=10,this._defaultHouseLength=5,this._defaultExtrusionHeight=10,this._destroyBinding=this._destroyFeature.bind(this),this._visibleBinding=this._visibilityFeature.bind(this),this._coordinateBinding=this._coordinateChange.bind(this),this._geojsonBinding=this._geojsonChange.bind(this),this._clicks=[],this._doubleclicks=[],this._lastsClicks=[],this.params.cursorChangeDelay=15;var o=s.getBuildingGISPropertiesMap();this.floorNumberAttribute=o.floors,this.floorHeightAttribute=o.floorHeight,this.groundFloorHeightAttribute=o.groundFloorHeight,this.roofHeightAttribute=o.roofHeight,this.roofAngleAttribute=o.roofAngle,this.roofShapeAttribute=o.roofShape,this.heightAttribute=o.height,this.altitudeAttribute=o.altitude,this.otherVerbose=!1,this.initialState()},_getTool:function(t){if(s.is(t))return t instanceof a?t:function(t){var e=new(a.extend(t))(this.urban);for(var i in t)e[i]=t[i];return e}.call(this,t)},initialState:function(){this._removeAllAnchors(),this.anchorRootNode.setVisibility(!0),this.anchorRootNode.setMatrix(new u.Matrix4),this._inverseCoordinate.identity(),this.nbFeatures=1,this._lastGeojsonData=null,this.currentGeometryType=null,this.currentShapeReference=null,this.lastClickedPH=null,this.preSelectedPh=null,this.justAddedPh=null,this.urban.USR.disableRobot(),this._lastItem=null,this._currentExtrusionHeight=this._defaultExtrusionHeight,this._roofHeight=null,this._lastAltitude=0},_removeAllAnchors:function(){this._removeAllPointHandle(this.anchorList),this.removeExtrusionHandle(),this.removeVerticalNode(),this.removeSegmentHandle(),this.preSelectedPh=null,this.anchorList=[],this.loop=!1},_removeAllPointHandle:function(){this.anchorRootNode.removeChildren()},drawShape:function(t){s.is(t)&&(t=s.clone(t)),this._lastGeojsonData=t;var e=h.fromJSONToArray(this._lastGeojsonData),i=this._getFirstShape(e,void 0);if(s.is(i)){this.currentShapeReference=i.index,this.currentGeometryType=this._lastGeojsonData.features[0].geometry.type,this._initAnchorListFromArray(i.coords,0);var n=this.anchorList[this.anchorList.length-1];n.loopEnd&&(n=this.anchorList[this.anchorList.length-2]),this.setLastClickedPH(n.ph)}return this.setCursor(),this.updateLine()},_getFirstShape:function(t,e){var i,n=!1;if(!s.is(t))return null;if(i=t,s.is(i)&&Array.isArray(i)&&this._containsPoints(i)&&(n=!0),!n){e||(e="0");i=t[0],s.is(i)&&Array.isArray(i)&&(this._containsPoints(i)?n=!0:e+=".0")}return s.is(i)?n?{coords:i,index:e}:this._getFirstShape(i,e):null},_initAnchorListFromArray:function(t,e){this.anchorList=[],this._initinProgress=!0;var i,n=this,r=!1,o=!0,a=0;return this.tool.isBuilding()&&this._lastGeojsonData&&this._lastGeojsonData.features&&this._lastGeojsonData.features[0]&&this._lastGeojsonData.features[0].properties&&(a=this._lastGeojsonData.features[0].properties[this.altitudeAttribute]||0),s.is(t)&&Array.isArray(t)?(i=t[0],this._containsPoints(t)?t.forEach(function(t){var s=new u.Vector3(t[0],t[1],t[2]||a),h=n.pos3DToScreenPos(s),l=!0;n._samePoint(i,t)&&(r&&(n._createLoop(),l=!1),r=!0),l&&(n._addAnchor(s,h,e,!0)||(o=!1))}):console.log("not a coordinate list")):o=!1,this._initinProgress=!1,o},_insertAnchor:function(t,e){this.anchorList.splice(e,0,t);for(var i=e;i<this.anchorList.length;i++)this.anchorList[i].ph.index=i},_addAnchor:function(t,e,i,n){var r=this.anchorList.length,o=!0;if(s.is(t)&&s.is(e)&&t instanceof u.Vector3&&(e instanceof u.Vector3||e instanceof u.Vector2)){if(this.tool.isSquare()&&this.anchorList.length>=2)return;if(this.tool.isHouse()&&this.anchorList.length>=0&&(o=!1,n&&this.anchorList.length>=1))return;var a;if(this.tool.isPoint()&&(o=!1),r)if(this.anchorList[r-1].ph.pos3D.distanceTo(t)<.001)return!1;var h={ph:a=!0===o?this._createPointHandle(t,e):{notaNode:!0,text:{innerHTML:""},pos3D:t,pos2D:e,setFillColor:function(){},addChild:function(){}},featureIndex:i||0};if(!0!==n&&!0===this.tool.smartInsert){var l=this.getinsertPointInClosestSegment(t);this._insertAnchor(h,l+1)}else s.is(this.lastClickedPH)&&!0===o?(this._insertAnchor(h,this.lastClickedPH.index+1),this.setLastClickedPH(h.ph)):this.anchorList.push(h);o&&(this.justAddedPh=a,this.tool.onAddAnchor(a,this.anchorList))}return r<this.anchorList.length},_removeAnchor:function(e){var i=this.anchorList.length;if(e instanceof t){var n=e.index;this.tool.onRemoveAnchor(e,this.anchorList),this.anchorRootNode.remove(e),this.anchorList.splice(e.index,1),!0===this.otherVerbose&&console.log("removeanchor",e.index,e.pos3D);for(var s=0;s<this.anchorList.length;s++)this.anchorList[s].ph.index=s;this.loop&&(3===this.anchorList.length?this._breakLoop():0===n&&(this._breakLoop(),this._createLoop())),this.preSelectedPh=null,this.updateLine()}return i>this.anchorList.length},_createPointHandle:function(e,i){var n,r=new t({viewer:this.urban.getView3D().webGLV6Viewer,sceneGraph:this.anchorRootNode});return s.is(this._pointTexture)?r.pointMat.map=this._pointTexture:this._pointTexture=r.pointMat.map,r.index=this.anchorList.length,r.pos3D=e,r.pos2D={x:i.x,y:i.y},r.name="ph_"+this.anchorList.length,n=e,r.setMatrix((new u.Matrix4).setPosition(n)),r.setSize(20),r.setFillColor(this.pointColor),this._attachCallbacks(r),r},removeVerticalNode:function(){var t;if(s.is(this._verticalHandleNode)){for(t=0;t<this._verticalHandleNode.parents.length;t++)this._verticalHandleNode.parents[t].removeChild(this._verticalHandleNode);this._verticalHandleNode=null}if(s.is(this._fixedSizeNode3D)){for(t=0;t<this._fixedSizeNode3D.parents.length;t++)this._fixedSizeNode3D.parents[t].removeChild(this._fixedSizeNode3D);this._fixedSizeNode3D=null}},removeExtrusionHandle:function(){var t;if(s.is(this._extrusionHandleNode)){for(t=0;t<this._extrusionHandleNode.parents.length;t++)this._extrusionHandleNode.parents[t].removeChild(this._extrusionHandleNode);this._extrusionHandleNode=null}if(s.is(this.extrusionPositionNode)){for(t=0;t<this.extrusionPositionNode.parents.length;t++)this.extrusionPositionNode.parents[t].removeChild(this.extrusionPositionNode);this.extrusionPositionNode=null}},createExtrusionHandle:function(){if(this.tool.isBuilding()){if(s.is(this._extrusionHandleNode))return void(this.extrusionPositionNode&&this.extrusionPositionNode.updateHandlePosition());var t=this;this._extrusionHandleNode=new g({touchMode:!0}),s.is(this._verticalTexture)?this._extrusionHandleNode.mat.map=this._verticalTexture:this._verticalTexture=this._extrusionHandleNode.mat.map,this._extrusionHandleNode.modelEvents=this._extrusionHandleNode._modelEvent,this._extrusionHandleNode.setRenderPasses(["noz"]);var e=new l({name:"extrusionFixedSizeNode3D",ratio:7});e.addChild(this._extrusionHandleNode),this._extrusionHandleNode.subscribe({event:"LineTranslationBegin"},function(){t.enabled=!1,t._extrusionHandleNode.initialMatrix=(new u.Matrix4).copy(t.extrusionPositionNode.getMatrix()),!0===t.tool.altitudeDisplay&&(t._extrusionHandleNode.altitudeEffect=t.urban.getView3D().getAltitudeEffect(),t._extrusionHandleNode.altitudeEffect.enableEffect())}),this._extrusionHandleNode.subscribe({event:"LineTranslationManipulation"},function(e){var i=e.translationVector,n=new u.Vector3;if(n.getPositionFromMatrix(t._extrusionHandleNode.initialMatrix),n.add(i),t._extrusionHandleNode.altitudeEffect){t._extrusionHandleNode.altitudeEffect.disableEffect();var s=(new u.Vector3).getPositionFromMatrix(t._extrusionHandleNode.getMatrixWorld());t._extrusionHandleNode.altitudeEffect._currentZ=s.z,t._extrusionHandleNode.altitudeEffect.enableEffect()}t.updateRoofAltitude(n.z),t.updateLine()}),this._extrusionHandleNode.subscribe({event:"LineTranslationEnd"},function(){t.enabled=!0,t._extrusionHandleNode.altitudeEffect&&(t._extrusionHandleNode.altitudeEffect.disableEffect(),t._extrusionHandleNode.altitudeEffect=null)}),this.extrusionPositionNode=new c,this.extrusionPositionNode.updateHandlePosition=function(){for(var e=[],i=0;i<t.anchorList.length;i++)!0!==t.anchorList[i].loopEnd&&e.push(t.anchorList[i].ph.pos3D);var n=r.compute2DPolygonCentroid(e),s=new u.Vector3(n.x,n.y,0),o=t._getShapeAltitude(),a=t._getShapeExtrusionHeight(),h=t._getRoofHeight();s.z=o+a+h,this.setMatrix((new u.Matrix4).setPosition(s))},this.extrusionPositionNode.updateHandlePosition(),this.extrusionPositionNode.addChild(e),t.anchorRootNode.addChild(this.extrusionPositionNode)}else this.removeExtrusionHandle()},_createVerticalPointHandle:function(){this.removeVerticalNode();var t=this;this._verticalHandleNode=new g({touchMode:!0}),s.is(this._verticalTexture)?this._verticalHandleNode.mat.map=this._verticalTexture:this._verticalTexture=this._verticalHandleNode.mat.map,this._verticalHandleNode.modelEvents=this._verticalHandleNode._modelEvent,this._verticalHandleNode.setRenderPasses(["noz"]);var e=this._verticalHandleNode.getMatrix().setPosition(new u.Vector3(0,0,2));this._verticalHandleNode.setMatrix(e),this._fixedSizeNode3D=new l({name:"fixedSizeNode3D",ratio:7}),this._fixedSizeNode3D.addChild(this._verticalHandleNode),this._verticalHandleNode.subscribe({event:"LineTranslationBegin"},function(e){t.enabled=!1,t._verticalHandleNode.initialMatrix=(new u.Matrix4).copy(t.lastClickedPH.getMatrix()),!0===t.tool.altitudeDisplay&&(t._verticalHandleNode.altitudeEffect=t.urban.getView3D().getAltitudeEffect(),t._verticalHandleNode.altitudeEffect.enableEffect())}),this._verticalHandleNode.subscribe({event:"LineTranslationManipulation"},function(e){var i=e.translationVector,n=new u.Vector3;if(n.getPositionFromMatrix(t._verticalHandleNode.initialMatrix),n.add(i),t._verticalHandleNode.altitudeEffect){t._verticalHandleNode.altitudeEffect.disableEffect();var s=t._verticalHandleNode.getMatrixWorld().getPosition();t._verticalHandleNode.altitudeEffect._currentZ=s.z,t._verticalHandleNode.altitudeEffect.enableEffect()}t.updateAnchorListZ(n.z,void 0,e.event.from[0].deltaPosition.y),t._segmentHandle&&t._segmentHandle.updateSegmentHandlePosition(),t.extrusionPositionNode&&t.extrusionPositionNode.updateHandlePosition(),t.updateLine()}),this._verticalHandleNode.subscribe({event:"LineTranslationEnd"},function(e){t.enabled=!0,t._verticalHandleNode.altitudeEffect&&(t._verticalHandleNode.altitudeEffect.disableEffect(),t._verticalHandleNode.altitudeEffect=null)})},updateAnchorZ:function(t,e){if(t.getMatrix){var i=(new u.Matrix4).copy(t.getMatrix()),n=i.getPosition();n.z=e,t.setMatrix(i.setPosition(n))}t.pos3D.z=e;var s=this.pos3DToScreenPos(t.pos3D);t.pos2D={x:s.x,y:s.y},this.tool.onManipulateAnchor(t,this.anchorList)},updateAnchorListZ:function(t,e){if(this.tool.isPolygon())if(s.is(e))this.updateAnchorZ(this.anchorList[e].ph,t);else for(var i=0;i<this.anchorList.length;i++)this.updateAnchorZ(this.anchorList[i].ph,t);else s.is(this.lastClickedPH)&&(e=this.lastClickedPH.index,s.is(e)&&this.updateAnchorZ(this.anchorList[e].ph,t))},_attachCallbacks:function(t){var e=this;t.subscribe("Manipulate",function(i){!0===e.tool.altitudeDisplay&&(e.tool.isPolygon()||t.altitudeEffect||(t.altitudeEffect=e.urban.getView3D().getAltitudeEffect(),t.altitudeEffect.enableEffect()));var n,r,o=i.event.from[0].currentPosition,a=!1;if(s.is(e.lastClickedPH)&&(a=t.id===e.lastClickedPH.id),e._lastItem&&e._lastItem.impl.getContent()._node&&(n=e._lastItem.impl.getContent()._node.getPickable(),e._lastItem.impl.getContent()._node.setPickable(d.NOPICKABLE)),t.setPickable(d.NOPICKABLE),t.altitudeEffect?(t.altitudeEffect.disableEffect(),r=e._getClicked3DPosition(o,a),t.altitudeEffect.enableEffect()):r=e._getClicked3DPosition(o,a),t.setPickable(d.PICKABLE),e._lastItem&&e._lastItem.impl.getContent()._node&&e._lastItem.impl.getContent()._node.setPickable(n),s.is(r)){t.altitudeEffect&&(t.altitudeEffect._currentZ=r.z);var h=r.clone();s.is(e._inverseCoordinate)&&(h.applyMatrix4(e._inverseCoordinate),r=h),h=r,t.setMatrix((new u.Matrix4).setPosition(h)),t.pos3D=r,t.pos2D={x:o.x,y:o.y},!e.tool.isPolygon()&&e.loop&&0===t.index&&(e.anchorList[e.anchorList.length-1].ph.pos3D=t.pos3D),e.tool.onManipulateAnchor(t,e.anchorList),e.updateLine(),t._segmentPH&&t._segmentPH.updateSegmentHandlePosition(),e.extrusionPositionNode&&e.extrusionPositionNode.updateHandlePosition()}}),t.subscribe("BeginManipulate",function(i){t.locked=!0,e.enabled=!1}),t.subscribe("EndManipulate",function(i){t.locked=!1,t.altitudeEffect&&(t.altitudeEffect.disableEffect(),t.altitudeEffect=null),e.enabled=!0}),t.subscribe("BeginPreactivate",function(i){e.preSelectedPh=t,e.tool.onBeginPreactivateAnchor(t,e.anchorList)}),t.subscribe("Preactivate",function(t){}),t.subscribe("EndPreactivate",function(i){e.tool.onEndPreactivateAnchor(t,e.anchorList),e.preSelectedPh=null,e.setCursor()})},_createLoop:function(){if(!(this.tool.isPolygon()||this.anchorList.length<=2)){if(this.loop=!0,this.anchorList[0].ph.pos3D.clone().sub(this.anchorList[this.anchorList.length-1].ph.pos3D).length()>.01){var t={ph:{pos3D:this.anchorList[0].ph.pos3D},featureIndex:0,loopEnd:!0};this.anchorList.push(t)}return this.tool.isPolyline()&&this.lastClickedPH&&(this._createSegmentHandle(),this.lastClickedPH.addChild(this._segmentHandle)),this.tool.onCreateLoop(this.anchorList)||!0}},_breakLoop:function(t){if(!this.tool.isPolygon()){if(this.loop=!1,this.anchorList.splice(this.anchorList.length-1,1),s.is(t)){var e,i=[],n=this.anchorList.length;for(e=0;e<n;e++){var r=this.anchorList[(e+t)%n];i.push(r)}for(this.anchorList=i,e=0;e<this.anchorList.length;e++)this.anchorList[e].ph.index=e}return this.removeSegmentHandle(),this.tool.onBreakLoop(this.anchorList)||!0}},_getCurrentGEOJSON:function(){var t=[];this._addCoordinatesTo(t,0);var e=this._lastGeojsonData;if(s.is(e)){var i=this.currentShapeReference?this.currentShapeReference.split("."):null,n=e.features[0].geometry.type,r=this._getGeometryTypeFromLength(t.length);if(r.toLowerCase()!==n.toLowerCase())this.tool.isPolygon()&&(this.loop="polygon"===r.toLowerCase(),this.loop?(this.currentShapeReference+=".0",this.createExtrusionHandle()):(this.removeExtrusionHandle(),this.currentShapeReference=this.currentShapeReference.substring(0,this.currentShapeReference.length-2))),h.updateFeatureType(e,t,i,r);else if("point"===n.toLowerCase()&&(i=null),"polygon"===n.toLowerCase()?(this.loop=!0,this.createExtrusionHandle()):this.removeExtrusionHandle(),this.tool.isHouse()){var o=0;for(o=0;o<t.length;o++){i=[o,0];var a=this._createRectangleCoordinates(t[o]);h.updateGeoJSON(e,a,i)}}else h.updateGeoJSON(e,t,i)}else{var l=this._getGeometryTypeFromLength(t.length);if(this.tool.isHouse()&&t.length>0){a=this._createRectangleCoordinates(t[0]);e=h.fromCoodinatesToJSON(a,l)}else e=h.fromCoodinatesToJSON(t,l);if(e.crs={type:"name",properties:{name:this.urban.baseProjection}},!this.tool.isBuilding()||l.toLowerCase()!==this.currentGeometryType.toLowerCase()){this.tool.isPolygon()&&(this.loop=!0,this.createExtrusionHandle()),this._lastGeojsonData=e;var d=this._getFirstShape(h.fromJSONToArray(e),"0");s.is(d)&&(this.currentShapeReference=d.index)}}return e},_initGeojsonFromCoordinates:function(){},_getGeometryTypeFromLength:function(t){var e;return s.is(this.currentGeometryType)||(this.currentGeometryType=this.tool.getGeoJSONType(!0)),e=this.currentGeometryType,this.tool.isHouse()?"Polygon":"point"===e.toLowerCase()?e:(t<3&&(e="LineString",t<2&&(e=null)),e)},updateLine:function(){if(this.anchorList.length>0&&("point"===this.tool.getGeoJSONType()||this.anchorList.length>1||this.tool.isHouse())){var t=this._getCurrentGEOJSON();this.tool.onUpdate(this.loop,this.anchorList),this.robotHasBeenSet=!1;let i=function(){!this.robotHasBeenSet&&this.tool.isRobotEnabled()&&this._lastItem&&(xCity.enableRobot(!0,this._lastItem),this.robotHasBeenSet=!0)}.bind(this);var e=this._createShape(t,i);if(e){this._lastItem=e;for(let t in e.impl._itemParent._attributes.children._models){let i=e.impl._itemParent._attributes.children._models[t];xCity._urbanImpl.modelSelection.selection[i.id]&&xCity._urbanImpl.getView3D()._modelHightlighter.highlight(i)}let t=e.impl.getContent()._node&&e.impl.getContent()._node.children&&e.impl.getContent()._node.children.length;!this.robotHasBeenSet&&t&&(xCity.enableRobot(!0,this._lastItem),this.robotHasBeenSet=!0)}return this._lastItem}return this._lastItem=this._clear(),this.urban.USR.disableRobot(),this._lastItem},_modifyCoordinates:function(t,e){return"polygon"===e?[t]:t},_createShape:function(t,e){var i;if(i=this._drawShape(t,e),s.is(i)){if(s.is(i.impl)){i.impl.removeEvent("onDestroy",this._destroyBinding),i.impl.removeEvent("onChange:visible",this._visibleBinding),i.impl.addEvent("onDestroy",this._destroyBinding),i.impl.addEvent("onChange:visible",this._visibleBinding);var n=i.impl.getContent();if(n.removeEvent("onChange:geojson",this._geojsonBinding),n.addEvent("onChange:geojson",this._geojsonBinding),this.tool.isRobotEnabled()){var r=n.get("Coordinate");s.is(r)&&(r.removeEvent("onChange:matrix",this._coordinateBinding),r.addEvent("onChange:matrix",this._coordinateBinding),this._coordinateChange(r.getMatrix()))}}return i.set("geojson",t),this._visibilityFeature(i),i}return!1},_destroyFeature:function(t){this.tool.onDestroy(t.get("id"),this.anchorList),this.initialState()},_visibilityFeature:function(t){var e=t.get("visible");this.anchorRootNode.setVisibility(e)},_addCoordinatesTo:function(t,e){var i,n=this.anchorList.length;if(s.is(e)&&"number"==typeof e||(e=0),Array.isArray(t))for(i=0;i<n;i+=1)this.anchorList[i].featureIndex===e&&t.push([this.anchorList[i].ph.pos3D.x,this.anchorList[i].ph.pos3D.y,this.anchorList[i].ph.pos3D.z/this.urban.getView3D().getScale()])},_drawShape:function(t,e){var i=this.tool.getGeoJSONType(this.loop);s.is(t)&&s.is(t.features)&&s.is(t.features[0])&&s.is(t.features[0].geometry)&&s.is(t.features[0].geometry.type)&&(i=t.features[0].geometry.type.toLowerCase()),this.shouldOffset=!1;return{linestring:this._drawLine,LineString:this._drawLine,polygon:this._drawPolygon,point:this._drawPoints}[i].call(this,t,e)||!1},_drawLine:function(t){var i=this._getFeature(),n=this._getLineContentJSON(t);if(i instanceof e){var r=i.impl.getContent().get("Coordinate");s.is(r)&&(n.Coordinate=r.toJSON()),i.reload(n)}else if(this._clear(),(i=this._getFeature()).feature.Content=n,i=xCity.add3DContent(i),this.tool.onItemCreated(i.get("id")),this.tool.isBuilding()){var o={color:"white",opacity:.7,renderMode:"occluded"};i.set("Rendering",o)}return i},_drawPoints:function(t,i){var n,r,o,a=h.initGeoJsonObject();if(a.features[0]=t.features[0],(n=this._getFeature())instanceof e){(o=n.impl.getContent().toJSON()).geojson=a;var l=n.impl.getContent().get("Coordinate");s.is(l)&&(o.Coordinate=l.toJSON()),n.reload(o)}else this._clear(),n=this._getFeature(),o=this._getPointContentJSON(a),n.feature.Content=o,n.readyCB=i,n=xCity.add3DContent(n),this.tool.onItemCreated(n.get("id"));if(r=o.geojson,t.features.length>1){for(var d=1;d<t.features.length;d++){if(this.tool.onNewShape()){if((a=h.initGeoJsonObject()).features[0]=t.features[d],n=this._getFeature(),o=this._getPointContentJSON(a),n instanceof e){l=n.get("Coordinate");s.is(l)&&(o.Coordinate=l.toJSON()),n.reload(o)}else this._clear(),(n=this._getFeature()).feature.Content=o,n.readyCB=i,n=xCity.add3DContent(n),this.tool.onItemCreated(n.get("id"));r=o.geojson}}this.resetAsOneFeature(r,t)}return n},resetAsOneFeature:function(t,e){t&&(e.features=t.features,this.initialState(),this.drawShape(t))},updateGeoJSONCoordinates:function(t,e){var i;for(i=0;i<t.features.length;i++)t.features[i],e.features[i].properties=t.features[i].properties;return e},_drawPolygon:function(t){if(this.tool.isBuilding())return this._drawBuilding(t);if(this.tool.isHouse())return this._drawHouse(t);var i,n=this._getFeature();if(t&&t.features&&t.features[0]&&t.features[0].properties&&(t.features[0].properties[this.altitudeAttribute]=this._getShapeAltitude()),this.resetZfromPolygonandanchors(t),this.shouldOffset=!0,n instanceof e&&"Polygon"===n.get("className")){i=this._getPolygonContentJSON(t);var r=n.impl.getContent().get("Coordinate");s.is(r)&&(i.Coordinate=r.toJSON()),n.reload(i)}else this._clear(),n=this._getFeature(),i=this._getPolygonContentJSON(t),n.feature.Content=i,n=xCity.add3DContent(n),this.tool.onItemCreated(n.get("id"));return n},_drawBuilding:function(t){var i,n=this._getFeature(),r=t.features[0].properties[this.floorNumberAttribute];s.is(r)?this._lastNbFloors=r:r=s.is(this._lastNbFloors)?this._lastNbFloors:1;var o=t.features[0].properties[this.floorHeightAttribute];s.is(o)?this._lastFloorHeight=o:o=s.is(this._lastFloorHeight)?this._lastFloorHeight:2.7;var a=t.features[0].properties[this.groundFloorHeightAttribute];s.is(a)?this._lastGroundFloorHeight=a:a=s.is(this._lastGroundFloorHeight)?this._lastGroundFloorHeight:o,t.features[0].properties[this.heightAttribute]=a+(r-1)*o,t.features[0].properties[this.altitudeAttribute]=this._getShapeAltitude(),t.features[0].properties[this.floorNumberAttribute]=r,t.features[0].properties[this.floorHeightAttribute]=o,t.features[0].properties[this.groundFloorHeightAttribute]=a;var h=t.features[0].properties[this.roofHeightAttribute];s.is(h)||(h=this._roofHeight=this._defaultRoofHeight),s.is(this._roofHeight)||(this._roofHeight=h),t.features[0].properties[this.roofHeightAttribute]=this._roofHeight;var l=t.features[0].properties[this.roofAngleAttribute];if(s.is(l)||(l=this._defaultRoofAngle),s.is(t.features[0].properties[this.roofAngleAttribute])||(t.features[0].properties[this.roofAngleAttribute]=l),s.is(t.features[0].properties[this.roofShapeAttribute])||(t.features[0].properties[this.roofShapeAttribute]="MANSARD"),n instanceof e&&"BuildingSet"===n.get("className")){(i=n.impl.getContent().toJSON()).geojson=t;var d=n.impl.getContent().get("Coordinate");s.is(d)&&(i.Coordinate=d.toJSON()),n.reload(i)}else this._clear(),n=this._getFeature(),i=this._getBuildingContentJSON(t),n.feature.Content=i,n=xCity.add3DContent(n),this.tool.onItemCreated(n.get("id"));return n.set("Rendering",{renderMode:"occluded"}),n},_drawHouse:function(t){for(var e,i=t.features.length,n=0;n<i;n++){var r;if(s.is(t.features[n].properties[this.roofShapeAttribute])||(t.features[n].properties[this.roofShapeAttribute]="GABLE"),(r=s.clone(t)).features=[t.features[n]],(e=this._drawBuilding(r)).set("rectangleBase",!0),i>1)if(n===i-1)this.resetAsOneFeature(r,t);else if(!this.tool.onNewShape()){this.resetAsOneFeature(r,t);break}}return e},_getFeature:function(t){var e=xCity.findItem({id:this.tool.getCurrentContext(t).Line.id});return s.is(e)?e:this._getFeatureJSON(t)},_getFeatureJSON:function(t){var e,i=this.tool.getCurrentContext(t);return!1===i.Folder.temporary?void 0===(e=xCity.findItem({id:i.Folder.id}))&&(e=xCity.addFolder({id:i.Folder.id,name:i.Folder.name})):e=xCity.getTemporaryFolder(i.Folder.id,i.Folder.name),{feature:{className:"Feature",name:i.Line.name,id:i.Line.id,visible:!0},parentFolder:e}},_getLineContentJSON:function(t){return{className:"Line",id:"drawing_line_id2",Coordinate:{isCreatedShape:!0,className:"Coordinate",position:[0,0,0],shifted:!1,projection:n.getDefaultProjection()},geojson:t||h.initGeoJsonObject()}},_getPolygonContentJSON:function(t){var e=0;return this.anchorList&&this.anchorList[0]&&this.anchorList[0].ph&&this.anchorList[0].ph.pos3D&&this.anchorList[0].ph.pos3D.z&&(e=this.anchorList[0].ph.pos3D.z/this.urban.getView3D().getScale()),this._lastAltitude&&(e=this._lastAltitude/this.urban.getView3D().getScale()),{className:"Polygon",id:"drawing_polygon_id",geojson:t||h.initGeoJsonObject(),Coordinate:{isCreatedShape:!0,className:"Coordinate",position:[0,0,e],shifted:!1,projection:n.getDefaultProjection()}}},_getBuildingContentJSON:function(t){return{className:"BuildingSet",id:"drawing_building_id",asynchronous:!1,rectangleBase:!1,geojson:t||h.initGeoJsonObject(),Coordinate:{isCreatedShape:!0,className:"Coordinate",position:[0,0,0],shifted:!1,projection:n.getDefaultProjection()}}},_getPointContentJSON:function(t){return t&&(t.crs={properties:{name:this.urban.baseProjection}}),{shapeType:"sphere",scale:8,shadingMode:"smooth",nameAttribute:"name",opacityFactor:.3,heightAttribute:10,renderAnchor:!0,switchDistance:500,className:"SimplePointOfInterest3D",id:"drawing_point_id",Coordinate:{isCreatedShape:!0,className:"Coordinate",position:[0,0,0],shifted:!1,projection:n.getDefaultProjection()},Clustering:!1,nbVertices:15,geojson:t||h.initGeoJsonObject()}},_clear:function(){var t=xCity.findItem({id:this.tool.getCurrentContext().Line.id});return void 0!==t&&(t.impl.removeEvent("onDestroy",this._destroyBinding),t.impl.removeEvent("onChange:visible",this._visibleBinding),xCity.removeChild(t),t.impl.addEvent("onDestroy",this._destroyBinding),t.impl.addEvent("onChange:visible",this._visibleBinding),!0)},setOtherClickedPh:function(){var t=0;s.is(this.lastClickedPH)&&(t=this.anchorList.length>1?(this.anchorList.length+this.lastClickedPH.index-1)%this.anchorList.length:-1);var e=null;this.anchorList[t]&&(this.anchorList[t].loopEnd&&(t=(this.anchorList.length+t-1)%this.anchorList.length),e=this.anchorList[t].ph),this.setLastClickedPH(e)},setLastClickedPH:function(t){return t?this.lastClickedPH&&(this.lastClickedPH.setFillColor(this.pointColor),t.id===this.lastClickedPH.id)?this.setOtherClickedPh():(this.lastClickedPH=t,this.lastClickedPH.setFillColor(this.clickedColor),this.updateVerticalHandle(),!1):(this.lastClickedPH=null,this.updateVerticalHandle(),!0)},updateVerticalHandle:function(){this.tool.hasVerticalHandle()&&(s.is(this.lastClickedPH)?(this._createVerticalPointHandle(),this.lastClickedPH.addChild(this._fixedSizeNode3D),s.is(this._fixedSizeNode3D)&&s.is(this._fixedSizeNode3D.parents)&&this._fixedSizeNode3D.parents.length>1&&s.is(this._fixedSizeNode3D.parents[0])&&this._fixedSizeNode3D.parents[0].removeChild(this._fixedSizeNode3D),this.tool.isPolyline()&&this.loop&&(this._createSegmentHandle(),this.lastClickedPH.addChild(this._segmentHandle))):s.is(this._fixedSizeNode3D)&&(this._fixedSizeNode3D.setVisibility(!1),s.is(this._segmentHandle)&&this._segmentHandle.setVisibility(!1)))},removeSegmentHandle:function(){var t;if(s.is(this._segmentHandle)){for(this._segmentHandle.startPh._segmentPH=null,this._segmentHandle.endPh._segmentPH=null,t=0;t<this._segmentHandle.parents.length;t++)this._segmentHandle.parents[t].removeChild(this._segmentHandle);this._segmentHandle=null,this.preSelectedSegment=null}},_createSegmentHandle:function(){this.removeSegmentHandle();var e=new t({viewer:this.urban.getView3D().webGLV6Viewer,sceneGraph:this.anchorRootNode});s.is(this._pointTexture)?e.pointMat.map=this._pointTexture:this._pointTexture=e.pointMat.map,e.index=this.lastClickedPH.index,e.startPh=this.lastClickedPH,this.lastClickedPH._segmentPH=e;var i=e.index-1;0===e.index&&(i=this.anchorList.length-1),e.othersideIndex=i;var n=this.anchorList[i];n.loopEnd&&(n=this.anchorList[i-1]),e.endPh=n.ph,e.endPh._segmentPH=e,e.updateSegmentHandlePosition=function(){var t=this.startPh.pos3D.clone().add(this.endPh.pos3D).multiplyScalar(.5);this.setMatrix((new u.Matrix4).setPosition(t))},e.name="segmentHandle"+this.anchorList.length,e.setSize(20),e.setFillColor(this.segmentColor),e.updateSegmentHandlePosition();var r=this;e.subscribe("BeginPreactivate",function(t){r.preSelectedSegment=e,r.setCursor()}),e.subscribe("EndPreactivate",function(t){r.preSelectedSegment=null,r.setCursor()}),this._segmentHandle=e},_getShapeAltitude:function(){return this.tool.isPolygon()&&this.anchorList.length>0?this.tool.isBuilding()&&this._lastGeojsonData&&this._lastGeojsonData.features&&this._lastGeojsonData.features[0]&&this._lastGeojsonData.features[0].properties&&this._lastGeojsonData.features[0].properties[this.altitudeAttribute]?this._lastGeojsonData.features[0].properties[this.altitudeAttribute]:this.anchorList[0].ph.pos3D.z:void 0},_getClicked3DPosition:function(t,e){var i,n;if(!0===e)n=this.lastClickedPH.pos3D,i=this.fromGeojsonPositionToAbsolute(n).z;else if(this.tool.isPolygon()){if(this.tool.isHouse()||!(this.anchorList.length>0)){var r=this.exactPick(t);if(s.is(r)){var o=t.clone();o.x+=1,o.y+=1;var a=this.exactPick(o);if(s.is(a)){var h=.5*r.distanceTo(a);r.z+=h}}return this._lastAltitude=r.z,r}n=this.anchorList[0].ph.pos3D,i=this.fromGeojsonPositionToAbsolute(n).z}return s.is(i)?this.pick2D(!0,t,i):this.exactPick(t)},_rememberClickedPh:function(t){this._lastsClicks.length>=2&&(this._lastsClicks=[this._lastsClicks[this._lastsClicks.length-1]]),this._lastsClicks.push(t)},isRobotCenter:function(){var t=xCity._urbanImpl.USR._freeRobot;return!!(t&&t.endCenterClick-Date.now()<500)},_moveToClick:function(t){if(!0!==this.isRobotCenter()){var e,i=t.from[0].currentPosition;if(e=this._getClicked3DPosition(i),!s.is(e))return null;var n=e.clone();return s.is(this._inverseCoordinate)&&(n.applyMatrix4(this._inverseCoordinate),e=n),this.lastClickedPH&&this._samePosition(e,this.lastClickedPH.pos3D)?(this._rememberClickedPh(this.lastClickedPH),void this.setLastClickedPH(this.lastClickedPH)):(this.preSelectedPh?(this._rememberClickedPh(this.preSelectedPh),!this.loop&&this.lastClickedPH&&this.anchorList.length>2&&this.tool.isPolyline()&&(0===this.preSelectedPh.index&&this.lastClickedPH.index===this.anchorList.length-1||0===this.lastClickedPH.index&&this.preSelectedPh.index===this.anchorList.length-1)&&(this._createLoop(),this.updateLine()),this.setLastClickedPH(this.preSelectedPh)):(this.preSelectedPh=null,this.preSelectedSegment?this._rememberClickedPh(this._segmentHandle):this.lastClickedPH?(this._addAnchor(e,i),this._rememberClickedPh(this.anchorList[this.anchorList.length-1].ph),this.updateLine()):0!==this.anchorList.length&&"point"!==this.currentGeometryType.toLowerCase()||(this._addAnchor(e,i),this.setLastClickedPH(this.anchorList[this.anchorList.length-1].ph),this._rememberClickedPh(this.anchorList[this.anchorList.length-1].ph),this.updateLine())),(this.tool.isHouse()||this.tool.isPoint())&&xCity.selectedItems.length>1&&xCity.selectedItems[0].set("selected",!1),null)}},_resizeHandle:function(){this.updateAnchorDivPosition()},activate:function(){this.urban.getView3D().webGLV6Viewer.setManipulators({activated:!0,preActivate:!0}),this.tool.onStart(this.anchorList),this.urban.getView3D().getPicker().disable(),this.clickToken=o.subscribeTo("/VISU/onLeftClick",this._moveToClick.bind(this)),this.tapToken=o.subscribeTo("/VISU/onTap",this._moveToClick.bind(this)),this.params.leftDoubleClickEnable||(this.doubleClickToken=o.subscribeTo("/VISU/onLeftDoubleClick",this._doubleClickHandle.bind(this))),this.enabled=!0,this.loop=!1,this.initEvents();var t=this;this.onUpdateToken=o.subscribeTo(o.eventsList.onUpdate,function(e){t.cameraUpdate(e),t.tool.onCameraUpdate(t.anchorList,e)}),this.onResizeToken=o.subscribeTo("/VISU/onWindowResized",this._resizeHandle.bind(this)),this.setCursor()},cameraUpdate:function(t){},deactivate:function(){this.enabled=!1,this.urban.getView3D().webGLV6Viewer.setManipulators({activated:!1,preActivate:!1}),o.unsubscribe(this.onUpdateToken),o.unsubscribe(this.clickToken),o.unsubscribe(this.tapToken),o.unsubscribe(this.onResizeToken),this.doubleClickToken&&o.unsubscribe(this.doubleClickToken),this.urban.getView3D().getPicker().enable();var t=xCity.findItem({id:this.tool.getCurrentContext().Line.id});void 0!==t&&(t.impl.removeEvent("onDestroy",this._destroyBinding),t.impl.removeEvent("onChange:visible",this._visibleBinding)),this.tool.onFinish(this.anchorList),this.initialState(),this.setCursor()},_onStopManip:function(){this.resetMove()},_containsPoints:function(t){return t.length>0&&(2===t[0].length||3===t[0].length)&&"number"==typeof t[0][0]&&"number"==typeof t[0][1]},_samePoint:function(t,e){return t[0]===e[0]&&t[1]===e[1]},_samePosition:function(t,e){return!(t.clone().sub(e).length()>.01)},pos3DToScreenPos:function(t){return this.urban.getView3D().viewpoint.getScreenPosition(t)},_doubleClickHandle:function(t){if(!0!==this.isRobotCenter()){if(this._lastsClicks[0]&&this._lastsClicks[1]&&this._lastsClicks[1].id===this._lastsClicks[0].id){if(this._segmentHandle&&this._lastsClicks[0].id===this._segmentHandle.id)return this._breakLoop(this._segmentHandle.index),this.updateLine(),void this.setCursor();this.lastClickedPH&&this._lastsClicks[0].id===this.lastClickedPH.id&&this.setOtherClickedPh(),this._removeAnchor(this._lastsClicks[0]),this.setCursor()}this._lastsClicks[0]=this._lastsClicks[1]=null}},AskMoveToClick:function(t,e){!0!==this.isRobotCenter()&&this._parent(t,e)},_getCursor:function(t){var e=this._parent(t);if(this.enabled){var i,n=" 0 0";if((this.tool.isPoint()||this.tool.isHouse())&&this.tool.canCreateNewShape&&!this.tool.canCreateNewShape())return e;(i=this.tool.creationCursor)&&(n=this.tool.creationCursorHotSpot),this.tool.additionCursor&&this.anchorList.length>0&&(this.lastClickedPH?(i=this.tool.additionCursor,n=this.tool.additionCursorHotSpot):this.tool.isPoint()||(i=null)),this.preSelectedSegment&&this.tool.segmentRemovalCursor&&(i=this.tool.segmentRemovalCursor,n=this.tool.segmentRemovalCursorHotSpot),i&&(e="url('"+i+".png')"+n+", url('"+i+".cur')"+n+", auto")}return e},setCurrentContext:function(t){this.tool&&this.tool.setCurrentContext(t),this.setCursor()},_getShapeExtrusionHeight:function(){var t;if(this.tool&&this.tool.isBuilding())return(t=s.is(this._lastItem)&&this._lastItem instanceof e?this._lastItem.get("geojson"):this._lastGeojsonData)&&(this._currentExtrusionHeight=t.features[0].properties[this.heightAttribute]),this._currentExtrusionHeight?this._currentExtrusionHeight=Number(this._currentExtrusionHeight):this._currentExtrusionHeight=this._defaultExtrusionHeight,this._currentExtrusionHeight},_getRoofHeight:function(){if(this.tool&&this.tool.isBuilding())return this._roofHeight},updateRoofAltitude:function(t){this._roofHeight=t-this._getShapeAltitude()-this._getShapeExtrusionHeight()},getsmallestdistancetoSegment:function(t,e,i){var n=new u.Vector2(i.x,i.y).sub(e),s=n.clone().normalize(),r=t.clone().sub(e),o=s.dot(r.normalize());o<=0&&(o=0),o>=1&&(o=1);var a=e.clone().add(s.clone().setLength(o*n.length()));return t.distanceTo(a)},acceptWhenprojectedBeforeSegment:function(t,e,i,n){var s=!1,r=t.clone().sub(e),o=i.clone().sub(e),a=r.clone().normalize(),h=o.clone().normalize(),l=Math.atan2(h.y,h.x);l>0&&(l-=2*Math.PI);var d=Math.atan2(a.y,a.x);return d>0&&(d-=2*Math.PI),l-d>.5*n&&(s=!0),s},acceptWhenprojectedAfterSegment:function(t,e,i,n){var s=!1,r=t.clone().sub(i),o=e.clone().sub(i),a=r.clone().normalize(),h=o.clone().normalize(),l=Math.atan2(h.y,h.x);l>0&&(l-=2*Math.PI);var d=Math.atan2(a.y,a.x);return d>0&&(d-=2*Math.PI),d-l>.5*n&&(s=!0),s},getinsertPointInClosestSegment:function(t){var e=0,i=this.anchorList.length;if(e=Math.max(0,i-1),i>2){var n,s,r,o,a,h,l,d,c,g,m,f=new u.Vector2(t.x,t.y),p=1/0,v=i-1,_=new u.Vector2(this.anchorList[v].ph.pos3D.x,this.anchorList[v].ph.pos3D.y),b=[];for(r=0;r<this.anchorList.length;r++)l=new u.Vector2(this.anchorList[(r+i-1)%i].ph.pos3D.x,this.anchorList[(r+i-1)%i].ph.pos3D.y),a=new u.Vector2(this.anchorList[r].ph.pos3D.x,this.anchorList[r].ph.pos3D.y),d=new u.Vector2(this.anchorList[(r+1)%i].ph.pos3D.x,this.anchorList[(r+1)%i].ph.pos3D.y),g=l.clone().sub(a),c=d.clone().sub(a),g.normalize(),c.normalize(),(m=Math.atan2(c.y,c.x)-Math.atan2(g.y,g.x))>0&&(m-=2*Math.PI),b.push(m);for(h=_,r=0;r<this.anchorList.length;r++){a=new u.Vector2(this.anchorList[r].ph.pos3D.x,this.anchorList[r].ph.pos3D.y),s=(n=new u.Vector2(a.x,a.y).sub(h)).clone().normalize(),o=f.clone().sub(h);var y=n.length(),w=s.dot(o),P=!0;w<=0&&(this.acceptWhenprojectedBeforeSegment(f,h,a,b[(r+i-1)%i])?w=0:P=!1),w>=y&&(this.acceptWhenprojectedAfterSegment(f,h,a,b[r])?w=y:P=!1);var S=h.clone().add(s.clone().setLength(w)),x=f.distanceTo(S);P&&x<p&&(p=x,e=(r+i-1)%i,!0),h=a}}return e},controlZ:function(){s.is(this.lastAddition)&&(this._lastRemoval=this.lastAddition,this._removeAnchor(this._lastAddition))},shiftControlZ:function(){s.is(this._lastRemoval)&&this.addAnchor(this._lastRemoval)},keydown:function(t){var e=this._parent(t),i=t.gesture.key,n=this._getEvent(t);switch(i){case 90:!0===n.ctrlKey&&(!0===n.shiftKey?this.shiftControlZ(n):this.controlZ(n));break;case 99:case 67:!0===n.ctrlKey&&this.controlC(n);break;case 86:case 118:!0===n.ctrlKey&&this.controlV(n)}return e},getSquareFromCorners:function(t,e){var i=new u.Vector2(e.x,e.y).sub(t),n=.25*Math.PI,s=(new u.Quaternion).setFromAxisAngle(new u.Vector3(0,0,1),n),o=(new u.Quaternion).setFromAxisAngle(new u.Vector3(0,0,1),-n),a=new u.Vector3(i.x,i.y,0).normalize(),h=a.clone();a.applyQuaternion(s),h.applyQuaternion(o);var l=r.projectPointOnDirection(t,t.clone().add(a),e),d=r.projectPointOnDirection(t,t.clone().add(h),e);return[t,l,e,d]},_createSquareCoordinates:function(){return this.getSquareFromCorners(this.anchorList[0].ph.pos3D,this.anchorList[1].ph.pos3D)},getRectangleFrom3Points:function(t,e,i){var n=r.projectPointOnDirection(t,e,i),s=i.clone().sub(n),o=e.clone().add(s),a=t.clone().add(s);return[t,e,o,a]},getRectangleFrom2Points:function(t,e){var i=this.eye.clone();i.z=0,i.normalize();var n=i.clone().negate(),s=r.projectPointOnDirection(e,e.clone().add(i),t),o=r.projectPointOnDirection(t,t.clone().add(n),e);return[t,s,e,o]},getRectangleFrom1Point:function(t){var e,i,n,r;if(t=Array.isArray(t)?new u.Vector3(t[0],t[1],t[2]):(new u.Vector3).setFromJSon(t),s.is(this._lastGeojsonData)){var o=this._lastGeojsonData.features[0].geometry.coordinates[0],a=new u.Vector2(o[0][0],o[0][1]),h=new u.Vector2(o[1][0],o[1][1]),l=new u.Vector2(o[3][0],o[3][1]);(e=new u.Vector3(h.x,h.y,0)).sub(new u.Vector3(a.x,a.y,0)),n=e.length(),r=(i=new u.Vector3(l.x,l.y,0).sub(new u.Vector3(a.x,a.y,0))).length()}else{(e=this.eye.clone()).z=0;e.x<.001&&e.y<.001&&((e=this.up.clone()).z=0),e.normalize();var d=.5*-Math.PI,c=(new u.Quaternion).setFromAxisAngle(new u.Vector3(0,0,1),d);(i=e.clone()).applyQuaternion(c),n=this._defaultHouseWidth,r=this._defaultHouseLength,e.setLength(n),i.setLength(r)}var g=t.clone().add(e),m=g.clone().add(i),f=t.clone().add(i);return[t,g,m,f]},_createRectangleCoordinates:function(t){var e=this.getRectangleFrom1Point(t);return e=[[e[0].x,e[0].y,e[0].z],[e[1].x,e[1].y,e[1].z],[e[2].x,e[2].y,e[2].z],[e[3].x,e[3].y,e[3].z]]},controlC:function(){},controlV:function(){},_coordinateChange:function(t){if(!0===this.shouldOffset&&this.anchorList[0]){var e=-this.anchorList[0].ph.pos3D.z;this.anchorOffsetNode.setMatrix((new u.Matrix4).setPosition(new u.Vector3(0,0,e)))}this.anchorRootNode.setMatrix(t),this._inverseCoordinate.getInverse(t)},fromGeojsonPositionToAbsolute:function(t){return t.clone().applyMatrix4(this.anchorRootNode.getMatrix())},fromAbsoluteToGeojsonPosition:function(t){return t.clone().applyMatrix4(this._inverseCoordinate)},updateRoofHeightFromItem:function(){var t;(t=s.is(this._lastItem)?this._lastItem.get("geojson"):this._lastGeojsonData)&&(this._roofHeight=t.features[0].properties[this.roofHeightAttribute]),this._roofHeight?this._roofHeight=Number(this._roofHeight):this._roofHeight=this._defaultRoofHeight},_geojsonChange:function(){s.is(this._lastItem)&&(this._lastGeojsonData=s.clone(this._lastItem.get("geojson"))),s.is(this.extrusionPositionNode)&&(this.updateRoofHeightFromItem(),this.extrusionPositionNode.updateHandlePosition())},resetZfromPolygonandanchors:function(t){if(t&&t.features&&t.features.length>0){for(var e=t.features[0].geometry.coordinates[0],i=[],n=0;n<e.length;n++){var s=new u.Vector3(e[n][0],e[n][1],0);i.push(s.toArray());var r=this.anchorList[n];r&&r.ph&&(r.ph.pos3D.z=0,r.ph.setMatrix((new u.Matrix4).setPosition(r.ph.pos3D)))}t.features[0].geometry.coordinates[0]=i}},updateAnchorDivPosition:function(){if(this.anchorList)for(var t=0;t<this.anchorList.length;t++)if("div"in this.anchorList[t].ph){var e=this.urban.getView3D().viewpoint.getScreenPosition(this.anchorList[t].ph.pos3D);this.anchorList[t].ph.div.style.top=e.y+"px",this.anchorList[t].ph.div.style.left=e.x+"px"}}})}),define("DS/UrbanFeature/Viewshed",["DS/XCityModel/Item","DS/XCityModel/Folder","DS/UrbanFeature/ViewshedCamera","DS/XCityTools/EventDispatcher"],function(t,e,i,n){"use strict";var s=e.extend({defaults:{colorVisible:"#00ff00",colorNotVisible:"#ff0000",colorOutFrustum:"#ffffff",resolution:4096},metaData:{type:"Viewshed",className:"Viewshed"},setup:function(){this._parent()},create:function(t){if(this.addEvent("onChange:visible",this._visible,this),this.addEvent("onChange:colorVisible",this._updateColors,this),this.addEvent("onChange:colorNotVisible",this._updateColors,this),this.addEvent("onChange:colorOutFrustum",this._updateColors,this),this.addEvent("onChange:resolution",this._updateResolution,this),!this._parent(t))return!1;this._urban=this.getRoot()._urban,this._vse=this._urban.getView3D().getViewshedEffect(),this._updateColors(),this._updateResolution()},_updateResolution:function(){this.get("visible")&&(this._vse.setSize(this.get("resolution"),this.get("resolution"),!0,!0),n.publish("/xCity/needRender",this))},_updateColors:function(){this.get("visible")&&(this._vse.setColors(this.get("colorVisible"),this.get("colorNotVisible"),this.get("colorOutFrustum")),n.publish("/xCity/needRender",this))},getPointOfView:function(){return this.get("PointOfView")},setPointOfView:function(t){return this.set("PointOfView",t)},_visible:function(t){this.get("visible")&&(this._updateColors(),this._updateResolution())}});return t.ObjectContructor.Viewshed=s}),define("DS/UrbanManipulator/MeasureAltitudeManipulator",["DS/Visualization/ThreeJS_DS","DS/Manipulators/PointHandle","UWA/Core","DS/UrbanManipulator/Manipulator","DS/UrbanManipulator/ManipulatorParams","DS/UrbanManipulator/LocalisationManipulator","DS/UrbanManipulator/CameraAnimation","DS/UrbanManipulator/CameraAnimationPath","DS/UrbanManipulator/Keyframe","UWA/Class","DS/Visualization/Node3D","DS/UrbanTool/Utils","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Debug","DS/XCityTools/EventDispatcher"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g,m,f){"use strict";return n.extend({init:function(t,e,i,n){this.urban=t,this._parent(t,e,i,n),this.type="altitude",this.params.movetoclickpriority=!0,this.parentDiv=this.urban.frmWindow.getUIFrame(),this.anchorList=[],this.clickToken=null,this.tapToken=null,this.updateToken=null,this.preSelectedPh=null},_moveToClick:function(n,s){var r=n.from[0].currentPosition;if(null===this.preSelectedPh){var o=this.exactPick(r);if(!u.is(o))return null;var a=new e({viewer:this.urban.getView3D().webGLV6Viewer,sceneGraph:this.urban.getView3D()._rootProjShifted});a.index=this.anchorList.length;a.div=i.createElement("div",{id:"measure",styles:{position:"absolute",margin:"auto",padding:"6px",top:"Opx",left:"Opx",textAlign:"center",backgroundColor:"rgba(161, 229, 255, 0.28)",border:"solid 2px rgba(161, 229, 255, 0.8)",pointerEvents:"none",borderRadius:"6px"}});var h=this,l=function(t){return Math.round(100*t.z/h.urban.getView3D().getScale())/100+" m.<BR>"},d=function(t){return l(t)+"x = "+Math.round(100*t.x)/100+" m.<BR>y = "+Math.round(100*t.y)/100+" m."},c=document.createElement("p");return c.innerHTML=l(o),c.style.pointerEvents="none",c.style.textAlign="justify",a.div.appendChild(c),a.div.inject(this.parentDiv),this.divStyleHeight=parseFloat(window.getComputedStyle(a.div).height),a.div.style.top=r.y-this.divStyleHeight+"px",a.div.style.left=r.x+20+"px",a.name="phMeasureAlt",a.setMatrix((new t.Matrix4).setPosition(o)),a.setSize(20),a.setFillColor(new t.Color("#FF5555")),a.pos3D=o,a.pos2D=r,this.anchorList.push({ph:a}),a.subscribe("Manipulate",function(e){var i=e.event.from[0].currentPosition,n=h.exactPick(i);a.setMatrix((new t.Matrix4).setPosition(n)),a.pos3D=n,a.pos2D=i,a.div.style.top=i.y-h.divStyleHeight+"px",a.div.style.left=i.x+20+"px",c.innerHTML=d(n)}),a.subscribe("BeginManipulate",function(t){}),a.subscribe("EndManipulate",function(t){c.innerHTML=l(a.pos3D)}),a.subscribe("BeginPreactivate",function(t){h.preSelectedPh=a,c.innerHTML=d(a.pos3D)}),a.subscribe("Preactivate",function(t){}),a.subscribe("EndPreactivate",function(t){h.preSelectedPh=null,c.innerHTML=l(a.pos3D)}),null}this.urban.getView3D()._rootProjShifted.remove(this.preSelectedPh),void 0!==this.preSelectedPh.div&&this.preSelectedPh.div.getParent()===this.parentDiv&&this.parentDiv.removeChild(this.preSelectedPh.div),this.anchorList.splice(this.preSelectedPh.index,1);for(var g=0;g<this.anchorList.length;g++)this.anchorList[g].ph.index=g},_update:function(t){if(this.urban.getViewpoint().camMoved)for(var e=0;e<this.anchorList.length;e++){var i=this.urban.getView3D().viewpoint.getScreenPosition(this.anchorList[e].ph.pos3D);i.z<-1||i.z>1||i.x<0||i.x>window.innerWidth||i.y<0||i.y>window.innerHeight?this.anchorList[e].ph.div.hide():this.anchorList[e].ph.div.show(),this.anchorList[e].ph.div.style.top=i.y-this.divStyleHeight+"px",this.anchorList[e].ph.div.style.left=i.x+20+"px"}},activate:function(){this.urban.getView3D().webGLV6Viewer.setManipulators({activated:!0,preActivate:!0}),this.enabled=!0,this.initEvents(),this.urban.getView3D().getPicker().disable(),this.clickToken=f.subscribeTo("/VISU/onLeftClick",this._moveToClick.bind(this)),this.tapToken=f.subscribeTo("/VISU/onTap",this._moveToClick.bind(this)),this.updateToken=f.subscribeTo("/3DEXPERIENCity/onUpdate",this._update.bind(this))},deactivate:function(){this.enabled=!1,this.urban.getView3D().getPicker().enable();for(var t=0;t<this.anchorList.length;t++)this.parentDiv.removeChild(this.anchorList[t].ph.div),this.urban.getView3D()._rootProjShifted.remove(this.anchorList[t].ph);this.anchorList=[],f.unsubscribe(this.clickToken),f.unsubscribe(this.tapToken),f.unsubscribe(this.updateToken),this.urban.getView3D().webGLV6Viewer.setManipulators({activated:!1,preActivate:!1})}})}),define("DS/UrbanManipulator/FixedManipulator",["DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher","DS/UrbanManipulator/GroundManipulator","DS/UrbanManipulator/ManipulatorParams","DS/UrbanManipulator/LocalisationManipulator","DS/UrbanManipulator/CameraAnimation","DS/UrbanManipulator/CameraAnimationPath","DS/UrbanManipulator/Keyframe","UWA/Class","DS/Visualization/Node3D","DS/UrbanTool/Utils","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Debug"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g){"use strict";return i.extend({init:function(e,i,n,s){var r=!1;d.is(s)&&(r=!0),this._parent(e,i,n,s),r||this.params.resetDefaultFixedValue(),this.type="fixed",this.initialPosition=new t.Vector3,this.initialFov=this.viewpoint.camera.fov},panCamera:function(){return!0===this.panCameraOld()&&this.urban.getView3D().setControl(this.urban.getView3D().manipulators.default),!1},checkOnly:function(){var t=!0;return this.position.distanceTo(this.initialPosition)>.001?(this.urban.getView3D().setControl(this.urban.getView3D().manipulators.default),!1):(this.eye.normalize(),this.up.normalize(),this.up.z<0?t=!1:this.eye.z>.999&&(t=!1),t)},checkValues:function(){var t=!0;return this.position.distanceTo(this.initialPosition)>.001&&this.position.copy(this.initialPosition),this.eye.normalize(),this.up.normalize(),this.up.z<0?(t=!0,this.up.z=0,this.up.normalize(),this.eye.x=0,this.eye.y=0,this.eye.normalize(),this.target.copy(this.position.clone().add(this.eye.setLength(this.distanceToTarget))),this.setAltitude(this.params.groundModeAltitude)):this.eye.z>.999&&(t=!0,this.eye.z=.998,this.eye.normalize(),0===this.eye.x&&0===this.eye.y?(this.up.z=0,this.up.normalize()):this.up=d.getUpFromCameraEye(this.eye.clone()).normalize(),this.target.copy(this.position.clone().add(this.eye.setLength(this.distanceToTarget))),this.setAltitude(this.params.groundModeAltitude),this.zoomFocus=null),t},moveToClick:function(t,e){return null},activate:function(){this.params.groundModeAltitude=this.getAltitude(),this.initialPosition.copy(this.position),this.initialFov=this.viewpoint.camera.fov,this.enabled=!0,!0===this.verbose&&g.log(" activate fixed manip"),this.resetMove(),this.askedmove=null,this.askedmovepos=null,this.initEvents(),this.checkH=!0,s.enableInterns(!0),s.zoomEnable(!1),s.panEnable(!1)},deactivate:function(){this.viewpoint.camera.fov=this.initialFov,this._parent()},setAltitude:function(t){this.position.copy(this.initialPosition)},zoomCamera:function(){var t,e,i=!1;if(this.currentState===this.params.STATE.TOUCH_ZOOM||this.currentState===this.params.STATE.TOUCH_ROTATE?(this.zoomEnd.y=-this.touchZoomDistanceEnd/(1e3*this.params.touchZoom),this.zoomStart.y=-this.touchZoomDistanceStart/(1e3*this.params.touchZoom),e=this.zoomEnd.y-this.zoomStart.y):(e=this.zoomEnd.y-this.zoomStart.y,!0===this.shiftKey&&(e*=this.params.manipulationShiftSpeedFactor)),Math.abs(e)<1/Math.max(this.screen.width,this.screen.height)&&(e=0),t=e*this.params.manipulationSpeedFactor*this.params.zoomSpeed*this.urban.USR.timeDelta*1e3/16,0!==e&&1!==t){var n=this.viewpoint.camera.fov+t;n=Math.max(this.params.fovMin,n),n=Math.min(this.params.fovMax,n),this.viewpoint.camera.fov=n,i=!0,this.currentState!==this.params.STATE.TOUCH_ZOOM&&this.currentState!==this.params.STATE.TOUCH_ROTATE||this.zoomStart.copy(this.zoomEnd),this.zoomStart.y+=(this.zoomEnd.y-this.zoomStart.y)*Math.min(1,.5*this.params.dynamicDampingFactor*this.urban.USR.timeDelta*1e3/16),this.touchZoomDistanceStart=-this.zoomStart.y*(1e3*this.params.touchZoom)}return i}})}),define("DS/UrbanFeature/Polygon",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityModel/Item","DS/XCityGeometry/Polygon","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/VectorLoaderEnovia","DS/XCityLayer/Vector","DS/UrbanTool/Utils","DS/XCityRendering/RenderingHandlerPolygon","DS/XCityTools/EventDispatcher","DS/UrbanFeature/Coordinate"],function(t,e,i,n,s,r,o,a,h,l,d){"use strict";var u=i.extend({defaults:{url:"",geojson:null,Coordinate:null,renderID:"",Rendering:null},metaData:{type:"Geometry",className:"Polygon"},loaderJSON:{geojson:"loadJSONObject"},setup:function(){this._parent(),this._node=new e,this._node.name="polygonFeature",this.loaderJSON||(this.loaderJSON={}),this.heightMatrix=new t.Matrix4,this.addEvent("onChange:Coordinate",this._updateCoordinate,this)},destroy:function(t){t.getNode3D().remove(this._node),this._parent(t)},create:function(e){if(!this._parent(e))return!1;var i=e._urban;this.renderingProfileManager=i.getRenderingProfileManager(),this._rendering=new h(i),this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this._node.userData=this._itemParent,this._itemParentVisible(this._itemParent),e.getNode3D().add(this._node),this.setColor(this.get("color")),this._updateCoordinate();var d=function(e,s,r,o){var h;if(a.is(e)){var l={x:e[0].x,y:e[0].y,z:0},d=a.offsetVerticesXY(e,l);h=new n(i,{shape:d,holes:s,geometricMode:o.get("geometricMode"),renderMode:o.get("renderMode"),color:o.get("color"),opacity:o.get("opacity"),opacityFactor:o.get("opacityFactor"),lineWidth:o.get("lineWidth"),rendering:o.getRendering(),attributes:r.attributes});var u=(new t.Matrix4).identity().setPosition(l);h.setMatrix(u)}return h},u=function(t,e,i){var n;if(!1!==e)if(void 0===this.geojson?(n=(-1!==t.indexOf("FeatureCollection")?new s:new r).loadDataSource(t),this.set("geojson",JSON.parse(t))):(n=("FeatureCollection"===t.type?new s:new r).loadDataSourceFromObject(t),this.geojson=void 0,this.set("geojson",t)),0!==n.count){for(var h,u,c,g=new o.Feature;null!==(g=n.getNextFeature(g));){var m=g.getGeometry();if(m){var f,p=null,v=[],_=[];if(m.type===o.Type.LINESTRING&&void 0!==m.vertexList)p=m.vertexList,h=d(p,v,g,this),_.push(h);else if(m.type===o.Type.POLYGON&&void 0!==m.geometryList&&m.geometryList.length>0){for(f={x:(p=m.geometryList[0].vertexList)[0].x,y:p[0].y,z:0},u=1;u<m.geometryList.length;u++)v.push(a.offsetVerticesXY(m.geometryList[u].vertexList,f));h=d(p,v,g,this),_.push(h)}else if(m.type===o.Type.MULTIPOLYGON){var b=m.geometryList.length;for(c=0;c<b;c++){var y=m.geometryList[c];for(f={x:(p=y.geometryList[0].vertexList)[0].x,y:p[0].y,z:0},u=1;u<y.geometryList.length;u++)v.push(a.offsetVerticesXY(y.geometryList[u].vertexList,f));h=d(p,v,g,this),_.push(h)}}if(void 0!==h){for(c=0;c<_.length;c++)h=_[c],this._node.addChild(h);var w=g.getAttributeKeys(),P=w.length;for(P>0&&(void 0===this.userData||null===this.userData)&&(this.userData={});P--;)this.userData[w[P]]=g.getAttribute(w[P])}}}l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})}else l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()});else l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()})}.bind(this);if(""!==this.get("url")){var c=this.get("url");a.download(void 0,i,u,c)}else""!==this.get("geojson")&&(this.geojson=!0,u(this.get("geojson")));i.getRenderingProfileManager().initRendering(this)},getLocalPosition:function(){var t=this._node.getBoundingSphere().center;return this.get("Coordinate")&&t.add(this.get("Coordinate").getCentralTranslation()),t},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},_updateCoordinate:function(){var t=this.previous("Coordinate");t&&t.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")?(this.get("Coordinate").setItemParent(this),this._updateMatrix(this.get("Coordinate")._matrix),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this)):this._updateMatrix()},setColor:function(e){return!e||e instanceof t.Color||(e=new t.Color(e)),void 0===e&&(e=new t.Color),this._setGeometryProperty("setColor",e),this},removeColor:function(){return void 0!==this.get("color")&&this.setColor(void 0),this},setOpacity:function(t){return this._setGeometryProperty("setOpacity",t),this},setOpacityFactor:function(t){return this._setGeometryProperty("setOpacityFactor",t),this},setLineWidth:function(t){return this._setGeometryProperty("setLineWidth",t),this},setGeometricMode:function(t){return this._setGeometryProperty("setGeometricMode",t),this},setRenderMode:function(t){return this._setGeometryProperty("setRenderMode",t),this},_setGeometryProperty:function(t,e){void 0!==this._node&&this._node.traverse(function(i){i instanceof n&&i[t](e)})},_itemParentVisible:function(t){this._created&&this._node.setVisibility(t.get("visible"))},setItemParent:function(t){this._itemParent&&this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._parent(t),this._itemParent&&this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this)},_updateMatrix:function(t){this.heightMatrix.identity(),t&&this.heightMatrix.multiply(t),this._node.setMatrix(this.heightMatrix)},redraw:function(){if(void 0!==this._node){var t=this._rendering._needRebuild;this._node.traverse(function(e){e instanceof n&&(e._applyMaterial(),!0===t&&e.rebuild())}),this._rendering._needRebuild=!1}},getRendering:function(){return this._rendering},get:function(t){var e,i,n=this.getRendering();return this.renderingProfileManager&&a.is(n)&&n.hasAttribute(t)?(i=this.getMaterial(),a.is(i)&&(e=i[t])):e=this._parent(t),e},set:function(t,e){var i={},n=this.getRendering();this.renderingProfileManager&&a.is(n)&&n.hasAttribute(t)?(i[t]=e,this.setMaterial(i)):this._parent(t,e)},setMaterial:function(t){return this.renderingProfileManager.addRendering(this.parentFeatureID,t),this},getMaterial:function(){var t=this.getRendering();return a.is(t)?t.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)},addUserDataProperty:function(t,e,i){if(a.is(t)){var n=this.get("geojson"),s=n.features[0];if(a.is(i))for(var r=0;r<n.features.length;r++){var o=n.features[r];if(o&&o.properties&&o.properties.STRID===i){s=o;break}}s.properties||(s.properties={}),s.properties[t]=e;var h=this.getUserData();return h||(h={},this.userData=h),h[t]=e,!0}return!1},removeUserDataProperty:function(t,e){if(a.is(t)){var i=this.get("geojson"),n=i.features[0];if(a.is(e))for(var s=0;s<i.features.length;s++){var r=i.features[s];if(r&&r.properties&&r.properties.STRID===e){n=r;break}}a.is(n.properties[t])&&delete n.properties[t];var o=this.getUserData();return a.is(o[t])&&delete o[t],!0}return!1},getTransformedGeoJSON:function(){var e=this.get("Coordinate"),i=this.get("geojson");if(!a.is(e))return i;var n=e.getMatrix();if(n.isIdentity())return i;for(var s=i.features[0].geometry.coordinates[0],r=[],o=0;o<s.length;o++){var h=new t.Vector3(s[o][0],s[o][1],0);h.applyMatrix4(n),r.push(h.toArray())}var l=a.clone(i);return l.features[0].geometry.coordinates[0]=r,l},toJSON:function(){var t=this._parent(),e=this.get("Coordinate");if(a.is(e)){var i=this.getTransformedGeoJSON();t.geojson=i}return t}});return i.ObjectContructor.Polygon=u}),define("DS/UrbanCore/UndergroundVisualizer",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Plugins/RenderPass","DS/Plugins/ClearPass","DS/UrbanManipulator/UndergroundSelectionManipulator","DS/UrbanManipulator/Manipulator","DS/UrbanManipulator/UndergroundManipulator","DS/xCityBasicUtils/Utils","DS/XCityTools/Debug","DS/Mesh/MeshUtils","DS/XCityTools/ShaderTools","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/CanvasNodeTexture","DS/XCityGeometry/Polygon","DS/XCityTools/EventDispatcher","DS/Visualization/TrackballControls","DS/XCityCore/Terrain","DS/XCityRendering/RenderingHandlerPolygon","DS/WebappsUtils/WebappsUtils","DS/XCityTools/Downloader"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g,m,f,p,v,_,b,y){"use strict";var w=function(e,n,s,r){this._renderPassManager=r,this._viewer=e,this._viewerDiv=e.div,this._viewpoint=n,this._renderer=s,this._undergroundClearDepthPass_id="UNDERGROUND_CLEARDEPTHPASS",this._undergroundStencilPass_id="UNDERGROUND_CROPPASS",this._windowFillPass_id="UNDERGROUND_WINDOWFILLPASS",this._undergroundPrePass_id="UNDERGROUND_PREPASS",this._undergroundPostPass_id="UNDERGROUND_POSTPASS",this._undergroundBboxPass_id="UNDERGROUND_BBOXPASS",this._undergroundClearDepthPass=null,this._undergroundStencilPass=null,this._windowFillPass=null,this._undergroundPrePass=null,this._undergroundPostPass=null,this._windowNode=null,this._undergroundNode=new i("Undg"),this.areaBox=null,this.areaClippingPlanes=null,this.areaTicks=null,this.areaDepthPlanes=null,this.areaInfoNodes=null,this.windowInfoNodes=null,this.areaLevelMarkBLNodes=null,this.areaLevelMarkBRNodes=null,this.areaLevelMarkTLNodes=null,this.areaLevelMarkTRNodes=null,this.WindowLevelMarkBLNodes=null,this.areaLevelGradNodes=null,this.matW=null,this.matA=null,this.lineMat=new u.getCustomShaderMaterial([u.common,u.urbanLights]),this.lineMat.opacity=.2,this.lineMat.transparent=!0,this.lineMat.enableClipPlanes=!1,this.blueColor=new t.Color("#005686"),this.whiteColor=new t.Color("#FFFFFF"),this.lineMat.uniforms.ambient.value=this.whiteColor,this.lineMat.uniforms.diffuse.value=this.whiteColor,this.lineMat.uniforms.specular.value=this.whiteColor,this.lineMat.line=new t.LineBasicMaterial({lineWidth:2,opacity:.6,color:this.blueColor,enableClipPlanes:!1}),u.updateCommonUniforms(this.lineMat),this.window_radius_=1,this.window_position_x_=0,this.window_position_y_=0,this.window_position_z_=0,this.area_size_x_=null,this.area_size_y_=null,this.area_position_x_=null,this.area_position_y_=null,this.areaLeft=null,this.areaRight=null,this.areaTop=null,this.areaBottom=null,this.sizeX=0,this.sizeY=0,this.activated_=!1,this.selecting_area_=!1,this.selecting_window_=!1,this.areaSquare=void 0,this.areaInfoCanvas=void 0,this.areaInfoX=void 0,this.areaInfoY=void 0,this.windowInfoCanvas=void 0,this.windowInfoX=void 0,this.windowInfoY=void 0,this.mode_="DEFAULT",this.window_sizes_=[5,10,15,25,50],this.window_size_index_=2,this.window_moving_=!1,this.window_target_=new t.Vector3(0,0,0),this.last_timestamp_=(new Date).getTime(),this.first_timestamp_=(new Date).getTime(),this.movingPlane=!1,this.clipPlanes=[],this.initMovePlaneToken=null,this.movePlaneToken=null,this.endMovePlaneToken=null,this.initialPos=null,this.rightPlaneNode=null,this.leftPlaneNode=null,this.topPlaneNode=null,this.bottomPlaneNode=null,this.maxDepth=-Math.floor(xCity._urbanImpl.USR._root.children[0].children[0].bBox.min.z),this.maxDepth<=10&&(this.maxDepth=50),void 0!==xCity.widgetData&&(xCity.widgetData.underground_saveDepth=this.maxDepth),this.initialDepth=this.maxDepth,this.saveCircle=null,this.maxHeight=0,this.groundHeight=0,this.tickDistance=25,this.showTicks=!1,this.showPlanes=!1,this.showClippingPlanes=!0,this.init()};return w.prototype={init:function(){l.log("UNDERGROUND VISU DEBUG: init"),this.matW=new t.MeshLambertMaterial({color:16777215}),this.matW.force=!0;var e=function(t,e){e&&(this.matW.map=t,this.matW.force=!0,this.matW.needsUpdate=!0)}.bind(this);if(y.loadTexture(e,"textures/underground/graduation.jpg"),this.matA=new t.MeshLambertMaterial({color:16777215}),this.matA.force=!0,this._undergroundStencilPass=new n(null,null,void 0,!0,!1,!1,this._undergroundStencilPass_id),this._undergroundStencilPass.idString=this._undergroundStencilPass_id,this._undergroundStencilPass.setDisableColorWrite(!0),this._undergroundStencilPass.setDisableDepthWrite(!0),this._undergroundStencilPass.setEnableStencilTest(!0),this._undergroundStencilPass.setEnableStencilWrite(!0),this._undergroundStencilPass.setStencilFunc("ALWAYS"),this._undergroundStencilPass.setStencilOpsSeparate("KEEP","KEEP","INCR_WRAP","DECR_WRAP"),this._undergroundStencilPass.setDisableBackFaceCulling(!0),this._undergroundClearDepthPass=new s(this._undergroundClearDepthPass_id),this._undergroundClearDepthPass.defaults.clear=!1,this._undergroundClearDepthPass.defaults.doClearDepth=!0,this._windowFillPass=new n(null,null,void 0,!0,!1,!1,this._windowFillPass_id),this._windowFillPass.idString=this._windowFillPass_id,this._windowFillPass.setDepthFunc("GREATER"),this._windowFillPass.setEnableStencilTest(!0),this._windowFillPass.setStencilFunc("NOTEQUAL"),this._windowFillPass.setDisableBackFaceCulling(!0),this._undergroundPostPass=new n(null,null,void 0,!0,!1,!1,this._undergroundPostPass_id),this._undergroundPostPass.idString=this._undergroundPostPass_id,this._undergroundPostPass.setEnableStencilTest(!0),this._undergroundPostPass.setStencilFunc("NOTEQUAL"),this._undergroundPrePass=new n(null,null,void 0,!0,!1,!1,this._undergroundPrePass_id),this._undergroundPrePass.idString=this._undergroundPrePass_id,this._undergroundBboxPass=new n(null,null,void 0,!0,!1,!1,this._undergroundBboxPass_id),this._undergroundBboxPass.setEnableStencilTest(!1),this._undergroundBboxPass.idString=this._undergroundBboxPass_id,this._renderPassManager.addPass(this._undergroundPrePass_id,this._undergroundPrePass,{pre:!0}),this._renderPassManager.addPass(this._undergroundStencilPass_id,this._undergroundStencilPass,{post:!0}),this._renderPassManager.addPass(this._windowFillPass_id,this._windowFillPass,{after:this._undergroundStencilPass_id}),this._renderPassManager.addPass(this._undergroundClearDepthPass_id,this._undergroundClearDepthPass,{before:"ClearDepthPass"}),this._renderPassManager.addPass(this._undergroundPostPass_id,this._undergroundPostPass,{after:this._undergroundClearDepthPass_id}),this._renderPassManager.addPass(this._undergroundBboxPass_id,this._undergroundBboxPass,{after:this._undergroundPostPass_id}),this._renderPassManager.disablePass(this._undergroundPrePass_id),this._renderPassManager.disablePass(this._undergroundStencilPass_id),this._renderPassManager.disablePass(this._windowFillPass_id),this._renderPassManager.disablePass(this._undergroundClearDepthPass_id),this._renderPassManager.disablePass(this._undergroundPostPass_id),this._renderPassManager.disablePass(this._undergroundBboxPass_id),this.BL=new t.Vector3,this.TR=new t.Vector3,this.areaInfoNodes=new i("Area Info"),this.windowInfoNodes=new i("Window Info"),void 0===this._renderingProfileManager){this._renderingProfileManager=this._renderer.urban.getRenderingProfileManager(),this.undergroundProfileName="Underground";var r=this._renderingProfileManager.getProfile(this.undergroundProfileName);if(!h.is(r)){(r=this._renderingProfileManager.createProfile(this.undergroundProfileName)).addRendering("Ground",{enableClipPlanes:!0,opacity:.3})}}},reset:function(){"DEFAULT"===this.mode_||("VIEWER"===this.mode_?this._DeactivateViewer():"WINDOW"===this.mode_||!0===this.selecting_window_?this.deactivateWindowMode():"AREA"!==this.mode_&&!0!==this.selecting_area_||this.deactivateAreaMode()),this.removeFromSceneGraph();let t=this.parent_node_;w.call(this,this._viewer,this._viewpoint,this._renderer,this._renderPassManager),this.addToSceneGraph(t)},addToSceneGraph:function(t){this.parent_node_=t,this._undergroundNode.name="Udgnd",this.parent_node_.addChild(this._undergroundNode)},removeFromSceneGraph:function(){this.parent_node_.removeChild(this._undergroundNode)},activate:function(){l.log("UNDERGROUND VISU DEBUG : activate"),void 0===this._renderingProfileManager&&(this._renderingProfileManager=this._renderer.urban.getRenderingProfileManager()),this.activated_||(this._renderer.setControl(this.previousControl),this.activated_=!0)},deactivate:function(){l.log("UNDERGROUND VISU DEBUG : deactivate"),this._renderer.setControl(this.previousControl,{noAnimationOnActivation:!0}),this.activated_=!1,this.selecting_window_=!1,this.selecting_area_=!1},_setClipping:function(t,e){return t.enableClippingPlane(e.plane,e.activate),!1},autoDepth:function(){var t=Math.abs(this._renderer._rootProjScaled.children[0].children[1].bBox.min.z);return t!==1/0&&(this.maxDepth=Math.max(t+10,50)),this.maxDepth},_showGround:function(t){1==t?(this.matW.opacity=.8,this.matW.transparent=!0):(this.matW.opacity=1,this.matW.transparent=!1)},_setOpacity:function(t){this.matW.opacity=t,this.matW.transparent=t<1},_ViewerMode:function(){l.log("UNDERGROUND VISU DEBUG : activateViewerMode"),this._renderPassManager.enablePass(this._undergroundPrePass_id),this._previousProfile=this._renderingProfileManager.getCurrentProfileName(),this._renderingProfileManager.setProfile(this.undergroundProfileName),v.setupUndergroundMode(!0),this.mode_="VIEWER"},_DeactivateViewer:function(){l.log("UNDERGROUND VISU DEBUG : DeactivateViwerMode"),this._renderingProfileManager.setProfile(this._previousProfile),this._renderPassManager.disablePass(this._undergroundPrePass_id),v.setupUndergroundMode(!1),this.mode_="DEFAULT"},_changeRenderingMode:function(){void 0===this._renderingProfileManager&&(this._renderingProfileManager=this._renderer.urban.getRenderingProfileManager()),this._renderPassManager.enablePass(this._undergroundPrePass_id),this._previousProfile=this._renderingProfileManager.getCurrentProfileName(),this._renderingProfileManager.setProfile(this.undergroundProfileName)},activateAreaMode:function(e){var n;l.log("UNDERGROUND VISU DEBUG : activateAreaMode"),this._renderPassManager.enablePass(this._undergroundBboxPass_id),this._renderer.urban.environment.slab._slabCubeMesh3D.setRenderPasses([this._undergroundPrePass_id]),void 0!==xCity.widgetData&&!0===xCity.widgetData.underground_automaticArea_CF&&((e={}).xmin=xCity.widgetData.underground_area_Bbox.xmin,e.ymin=xCity.widgetData.underground_area_Bbox.ymin,e.xmax=xCity.widgetData.underground_area_Bbox.xmax,e.ymax=xCity.widgetData.underground_area_Bbox.ymax),void 0!==e?(this.areaLeft=e.xmin,this.areaBottom=e.ymin,this.areaRight=e.xmax,this.areaTop=e.ymax,n={xmin:this.areaLeft,xmax:this.areaRight,ymin:this.areaBottom,ymax:this.areaTop,height:0},this.previousControl=this._renderer.controls,this.groundHeight=0):(n=this._renderer.undergroundSelectionManip.getData(),this.groundHeight=n.height),this.maxHeight=xCity._urbanImpl.USR.vqt._node.bBox.max.z,this.maxHeight<=0&&(this.maxHeight=100),this.areaBox=new i("areaBox"),this.areaClippingPlanes=new i("areaClippingPlanes"),this.areaDepthPlanes=new i("areaDepthPlanes"),this.areaTicks=new i("areaTicks"),this.ticksHeight=Math.floor(this.groundHeight/this.tickDistance)*this.tickDistance,this._createAreaLine(this.groundHeight-this.maxDepth,this.groundHeight+this.maxHeight),this._createLevelPlanes(this.ticksHeight-this.maxDepth,this.ticksHeight),this._createLevelTicks(this.ticksHeight-this.maxDepth,this.ticksHeight),this.mode_="AREA",this.updateUndergroundSettingsView();var s={};s.target=this._viewpoint.target,s.position=this._viewpoint.camera.position,s.orientation=new t.Vector3(0,0,-1),s.distanceToTarget=s.position.distanceTo(s.target);var r=new t.Vector3((this.areaLeft+this.areaRight)/2,(this.areaBottom+this.areaTop)/2,this.groundHeight);this._renderer.controls.target=r;this.previousControl.params.defaultDistanceOnActivation;var o=Math.max(this.areaRight-this.areaLeft,this.areaTop-this.areaBottom)/(2*Math.tan(.5*this._viewpoint.camera.fov*Math.PI/180));this.activate(),this._renderer.undergroundManip=new a(this._renderer.urban,this._viewpoint,this._viewerDiv,this.previousControl.params,this),this._renderer.undergroundManip.params.defaultDistanceOnActivation=o,this._renderer.undergroundManip.params.minHeight=-1e4,this._renderer.setControl(this._renderer.undergroundManip),this._renderer.undergroundManip.update(!0);var h=new t.Vector3(0,.5,-.5);this._renderer.undergroundManip.moveTo3(this._renderer.undergroundManip.target,this._renderer.undergroundManip.params.defaultDistanceOnActivation,h,this._renderer.undergroundManip.params.manipTransitionDuration);var d=new t.Vector3(this.areaLeft,this.areaBottom,0),c=new t.Vector3(this.areaRight,this.areaTop,0);this._viewpoint._translateToRelativePosition(d),this._viewpoint._translateToRelativePosition(c),this.clipPlanes[0]=new t.Plane(new t.Vector3(1,0,0),-d.x),this.clipPlanes[1]=new t.Plane(new t.Vector3(-1,0,0),c.x),this.clipPlanes[2]=new t.Plane(new t.Vector3(0,1,0),-d.y),this.clipPlanes[3]=new t.Plane(new t.Vector3(0,-1,0),c.y),xCity._urbanImpl.USR.ugVisu.clipPlanes0=this.clipPlanes[0],xCity._urbanImpl.USR.ugVisu.clipPlanes1=this.clipPlanes[1],xCity._urbanImpl.USR.ugVisu.clipPlanes2=this.clipPlanes[2],xCity._urbanImpl.USR.ugVisu.clipPlanes3=this.clipPlanes[3];for(var g=0;g<4;++g)this._renderer.webGLV6Viewer.addClippingPlane(this.clipPlanes[g]);this._renderer.webGLV6Viewer.setClippingPlanes(!0),v.setupUndergroundMode(!0),this.initMovePlaneToken=f.subscribeTo("/VISU/onLeftMouseDown",this._pickingUnderground.bind(this,[])),this.movePlaneToken=f.subscribeTo("/VISU/onMouseMove",this._movePlane.bind(this,[])),this.endMovePlaneToken=f.subscribeTo("/VISU/onLeftMouseUp",this._endMovePlane.bind(this,[]));var m=new u.getCustomShaderMaterial([u.common,u.urbanLights]);m.uniforms.ambient.value=this.blueColor,m.uniforms.diffuse.value=this.blueColor,m.uniforms.specular.value=this.blueColor,m.force=!0,this._renderPassManager.enablePass(this._undergroundPrePass_id),this.oldInfPlaneX=this._renderer.urban.environment.slab._infPlaneMatrix.elements[12],this.oldInfPlaneY=this._renderer.urban.environment.slab._infPlaneMatrix.elements[13],this.oldInfPlaneZ=this._renderer.urban.environment.slab._infPlaneMatrix.elements[14],this.oldInfPlaneScale=this._renderer.urban.environment.slab._infPlaneMatrix.elements[0];var p=this.areaLeft-this._renderer.urban.shiftedPosition.x,_=this.areaRight-this._renderer.urban.shiftedPosition.x,b=this.areaBottom-this._renderer.urban.shiftedPosition.y,y=this.areaTop-this._renderer.urban.shiftedPosition.y;this.oldInfPlaneScale;this._renderer.urban.environment.slab._infPlaneMatrix.elements[12]=(p+_)/2,this._renderer.urban.environment.slab._infPlaneMatrix.elements[13]=(b+y)/2,this._renderer.urban.environment.slab._infPlaneMatrix.elements[14]=this.groundHeight-this.maxDepth-50,this._renderer.urban.environment.slab._infPlaneMesh3D.setMatrix(this._renderer.urban.environment.slab._infPlaneMatrix),document.dispatchEvent(new Event("xCityUndergroundSelectionDone"))},deactivateAreaMode:function(){l.log("UNDERGROUND VISU DEBUG : deactivateAreaMode"),this._renderer.urban.environment.slab._slabCubeMesh3D.setRenderPasses(["GenericOverlayPass"]),this._renderPassManager.disablePass(this._undergroundBboxPass_id),this._destroyAreaNodes(),this.area_size_x_=2,this.area_size_y_=2,this.area_position_x_=-1,this.area_position_y_=-1,f.unsubscribe(this.initMovePlaneToken),f.unsubscribe(this.movePlaneToken),f.unsubscribe(this.endMovePlaneToken),this.deactivate(),this._renderingProfileManager.setProfile(this._previousProfile),this._renderer.webGLV6Viewer.setClippingPlanes(!1),this._renderer.webGLV6Viewer.removeClippingPlane(this.clipPlanes[0]),this._renderer.webGLV6Viewer.removeClippingPlane(this.clipPlanes[1]),this._renderer.webGLV6Viewer.removeClippingPlane(this.clipPlanes[2]),this._renderer.webGLV6Viewer.removeClippingPlane(this.clipPlanes[3]);for(var t=0;t<4;++t)this.clipPlanes[t]=null;this.mode_="DEFAULT",this._renderPassManager.disablePass(this._undergroundPrePass_id),v.setupUndergroundMode(!1),this._renderer.urban.environment.slab._infPlaneMatrix.elements[12]=this.oldInfPlaneX,this._renderer.urban.environment.slab._infPlaneMatrix.elements[13]=this.oldInfPlaneY,this._renderer.urban.environment.slab._infPlaneMatrix.elements[14]=this.oldInfPlaneZ,this._renderer.urban.environment.slab._infPlaneMesh3D.setMatrix(this._renderer.urban.environment.slab._infPlaneMatrix)},activateWindowMode:function(){l.log("UNDERGROUND VISU DEBUG : activateWindowMode"),this.WindowTicks=new i("WindowTicks"),this.ticksHeight=25*Math.floor(this.groundHeight/25),this._createLevelTicksWindow(this.ticksHeight-this.maxDepth,this.ticksHeight),this.activate();var e={};e.target=this._viewpoint.target,e.position=this._viewpoint.camera.position,e.orientation=new t.Vector3(0,0,-1),e.distanceToTarget=e.position.distanceTo(e.target);var n=new t.Vector3(this.window_position_x_,this.window_position_y_,this.groundHeight);this._renderer.controls.target=n;this.previousControl.params.defaultDistanceOnActivation;var s=2*this.window_radius_/(2*Math.tan(.5*this._viewpoint.camera.fov*Math.PI/180));this._renderer.undergroundManip=new a(this._renderer.urban,this._viewpoint,this._viewerDiv,this.previousControl.params,this),this._renderer.undergroundManip.params.defaultDistanceOnActivation=s,this._renderer.undergroundManip.params.minHeight=-1e4,this._renderer.setControl(this._renderer.undergroundManip),this._renderer.undergroundManip.update(!0);var r=new t.Vector3(0,.5,-.5);this._renderer.undergroundManip.moveTo3(this._renderer.undergroundManip.target,this._renderer.undergroundManip.params.defaultDistanceOnActivation,r,this._renderer.undergroundManip.params.manipTransitionDuration),this.mode_="WINDOW",xCity._urbanImpl.USR.ugVisu.updateUndergroundSettingsView()},deactivateWindowMode:function(){l.log("UNDERGROUND VISU DEBUG : deactivateWindowMode"),xCity._urbanImpl.USR.ugVisu.updateUndergroundSettingsView(),this._undergroundNode.removeChild(this.windowInfoNodes),this.deactivate(),this._destroyWindowModel(),this._renderPassManager.disablePass(this._undergroundStencilPass_id),this._renderPassManager.disablePass(this._windowFillPass_id),this._renderPassManager.disablePass(this._undergroundPostPass_id),this.mode_="DEFAULT"},updateUndergroundSettingsView:function(){"AREA"==this.mode_&&(this.showTicks?(this.showPlanes?this._updatePlanes():this._undergroundNode.remove(this.areaDepthPlanes),this._updateTicks()):(this.areaTicks.remove(this.areaLevelMarkBLNodes),this.areaTicks.remove(this.areaLevelMarkBRNodes),this.areaTicks.remove(this.areaLevelMarkTLNodes),this.areaTicks.remove(this.areaLevelMarkTRNodes),this.areaTicks.remove(this.areaLevelGradNodes),this._undergroundNode.remove(this.areaDepthPlanes)),this.showClippingPlanes?(this.areaClippingPlanes.removeChildren(),this._createAreaPlanes(this.groundHeight-this.maxDepth,this.groundHeight+this.maxHeight,!0)):(this.areaClippingPlanes.removeChildren(),this._createAreaPlanes(this.groundHeight-this.maxDepth,this.groundHeight+this.maxHeight,!1))),"WINDOW"==this.mode_&&(this.showTicks?!1===xCity.widgetData.underground_showTicks_CF?this.WindowTicks.remove(this.WindowLevelMarkBLNodes):this._updateTicks():this.WindowTicks.remove(this.WindowLevelMarkBLNodes))},_updateBox:function(){"AREA"==this.mode_&&(this.areaBox.removeChildren(),this.areaClippingPlanes.removeChildren(),this._createAreaLine(this.groundHeight-this.maxDepth,this.groundHeight+this.maxHeight),this._createAreaPlanes(this.groundHeight-this.maxDepth,this.groundHeight+this.maxHeight,this.showClippingPlanes),this._renderer.urban.environment.slab._infPlaneMatrix.elements[14]=this.groundHeight-this.maxDepth-50,this._renderer.urban.environment.slab._infPlaneMesh3D.setMatrix(this._renderer.urban.environment.slab._infPlaneMatrix))},_updateTicks:function(){this.ticksHeight=Math.floor(this.groundHeight/this.tickDistance)*this.tickDistance,"AREA"==this.mode_&&(this.areaTicks.removeChildren(),this._createLevelTicks(this.ticksHeight-this.maxDepth,this.ticksHeight)),"WINDOW"==this.mode_&&(this.WindowTicks.removeChildren(),this._createLevelTicksWindow(this.ticksHeight-this.maxDepth,this.ticksHeight))},_updatePlanes:function(){"AREA"==this.mode_&&(this.areaDepthPlanes.removeChildren(),this._createLevelPlanes(this.ticksHeight-this.maxDepth,this.ticksHeight))},updateAreaInfo:function(){if("AREA"==this.mode_)this._updateBox(),this._updateTicks(),this._updatePlanes();else if("WINDOW"==this.mode_){var t=this._windowNode.getMatrix();t.elements[14]=-this.maxDepth,this._windowNode.setMatrix(t),this._windowNode._updateMatrix()}},update:function(){var i=(new Date).getTime();if("WINDOW"===this.mode_){if(1===this._renderer.controls.buttonDown&&-1===this._renderer.controls.currentState){xCity._urbanImpl.USR._needRender=!0,xCity._urbanImpl.USR.ugVisu.updateUndergroundSettingsView();var n=this._renderer.controls.exactPick(this._renderer.controls.currentXY,!0);if(n){(A=this._windowNode.getMatrix()).elements[12]=n.x,A.elements[13]=n.y,this._windowNode.setMatrix(A),this._windowNode._updateMatrix(),this.underground_Window_mvnt_ticks=!0,this.underground_NewposX=n.x,this.underground_NewposY=n.y;var s=parseInt(Math.abs(this.BL.y-this.TR.y).toFixed(0)),r=parseInt(Math.abs(this.BL.x-this.TR.x).toFixed(0));this.TR.x=n.x+r,this.TR.y=n.y,this.BL.x=n.x,this.BL.y=n.y-s;var o=this.windowInfoX.getMatrix();o.elements[12]=.6*this.BL.x+.4*this.TR.x,o.elements[13]=this.BL.y,this.windowInfoX.setMatrix(o),this.windowInfoX._updateMatrix();var a=this.windowInfoY.getMatrix();a.elements[12]=this.BL.x,a.elements[13]=.5*this.BL.y+.5*this.TR.y,this.windowInfoY.setMatrix(a),this.windowInfoY._updateMatrix();var h=this.windowInfoCanvas.getMatrix();h.elements[12]=.6*this.BL.x+.4*this.TR.x,h.elements[13]=.5*this.BL.y+.5*this.TR.y,this.windowInfoCanvas.setMatrix(h),this.windowInfoCanvas._updateMatrix()}}}else if("AREA"===this.mode_){xCity._urbanImpl.USR._needRender=!0;var l=new t.Vector3(this.areaLeft,this.areaBottom,0),d=new t.Vector3(this.areaRight,this.areaTop,0);if(this._viewpoint._translateToRelativePosition(l),this._viewpoint._translateToRelativePosition(d),this.clipPlanes[0].constant=-l.x,this.clipPlanes[1].constant=d.x,this.clipPlanes[2].constant=-l.y,this.clipPlanes[3].constant=d.y,this.showTicks){var u=this._viewpoint.getPosition(),c=new t.Vector3(this.areaLeft,this.areaBottom,u.z),f=new t.Vector3(this.areaRight,this.areaBottom,u.z),p=new t.Vector3(this.areaLeft,this.areaTop,u.z),v=new t.Vector3(this.areaRight,this.areaTop,u.z),b=(new t.Vector3).subVectors(u,c).length(),y=(new t.Vector3).subVectors(u,f).length(),w=(new t.Vector3).subVectors(u,p).length(),P=(new t.Vector3).subVectors(u,v).length();switch(Math.max(b,y,w,P)){case b:this.areaTicks.remove(this.areaLevelMarkBLNodes),this.areaTicks.addChild(this.areaLevelMarkTRNodes),this._sign(u,v,f)>0?this.areaTicks.addChild(this.areaLevelMarkBRNodes):this.areaTicks.remove(this.areaLevelMarkBRNodes),this._sign(u,p,v)>0?this.areaTicks.addChild(this.areaLevelMarkTLNodes):this.areaTicks.remove(this.areaLevelMarkTLNodes);break;case y:this.areaTicks.remove(this.areaLevelMarkBRNodes),this.areaTicks.addChild(this.areaLevelMarkTLNodes),this._sign(u,p,v)>0?this.areaTicks.addChild(this.areaLevelMarkTRNodes):this.areaTicks.remove(this.areaLevelMarkTRNodes),this._sign(u,c,p)>0?this.areaTicks.addChild(this.areaLevelMarkBLNodes):this.areaTicks.remove(this.areaLevelMarkBLNodes);break;case w:this.areaTicks.remove(this.areaLevelMarkTLNodes),this.areaTicks.addChild(this.areaLevelMarkBRNodes),this._sign(u,f,c)>0?this.areaTicks.addChild(this.areaLevelMarkBLNodes):this.areaTicks.remove(this.areaLevelMarkBLNodes),this._sign(u,v,f)>0?this.areaTicks.addChild(this.areaLevelMarkTRNodes):this.areaTicks.remove(this.areaLevelMarkTRNodes);break;case P:this.areaTicks.remove(this.areaLevelMarkTRNodes),this.areaTicks.addChild(this.areaLevelMarkBLNodes),this._sign(u,c,p)>0?this.areaTicks.addChild(this.areaLevelMarkTLNodes):this.areaTicks.remove(this.areaLevelMarkTLNodes),this._sign(u,f,c)>0?this.areaTicks.addChild(this.areaLevelMarkBRNodes):this.areaTicks.remove(this.areaLevelMarkBRNodes)}}}else if(this.selecting_area_){if(xCity._urbanImpl.USR._needRender=!0,this._renderer.undergroundSelectionManip.isSelectionDone()){this.selecting_area_=!1,this._undergroundNode.remove(this.areaInfoNodes);var S=this._renderer.undergroundSelectionManip.getFinalAreaBL(),x=this._renderer.undergroundSelectionManip.getFinalAreaTR();this.defineArea(S.x,S.y,x.x,x.y),this.activateAreaMode()}else if(this._renderer.undergroundSelectionManip.isPreviewEnabled()){S=this._renderer.undergroundSelectionManip.getAreaBL(),x=this._renderer.undergroundSelectionManip.getAreaTR();if(this.BL.x!==S.x||this.BL.y!==S.y||this.TR.x!==x.x||this.TR.y!==x.y){this.firstFrameSelection&&(this._undergroundNode.addChild(this.areaInfoNodes),this.firstFrameSelection=!1),this.BL=S,this.TR=x;var C={shape:[new t.Vector3(-.5,-.5,0),new t.Vector3(-.5,.5,0),new t.Vector3(.5,.5,0),new t.Vector3(.5,-.5,0)],rendering:new _(this._renderer.urban)};if(C.rendering.defaultRendering.addOver({renderMode:"overlay",geometricMode:"filled",color:this.blueColor,opacity:.7}),void 0===this.areaSquare){this.areaSquare=new m(this._renderer.urban,C),this.areaInfoNodes.addChild(this.areaSquare);let t=this.areaSquare.getMatrix();t.elements[14]=x.z,this.areaSquare.setMatrix(t)}(A=this.areaSquare.getMatrix()).elements[0]=x.x-S.x,A.elements[5]=x.y-S.y,A.elements[12]=(S.x+x.x)/2,A.elements[13]=(S.y+x.y)/2,this.areaSquare.setMatrix(A),this.areaSquare._updateMatrix();var M=function(t,e,i){t.beginPath(),t.moveTo(0,0),t.lineTo(e,0),t.lineTo(e,i),t.lineTo(0,i),t.lineTo(0,0),t.closePath(),t.fill()},D=160,T=15,V=this.blueColor;if(this.sizeX=Math.abs(S.x-x.x),this.sizeY=Math.abs(S.y-x.y),this.area=this.sizeX/2*(this.sizeY/2)*Math.PI,this.area>1e3?this.area=this.area.toFixed(0):this.area=this.area.toFixed(2),Math.round(Math.abs(S.x-x.x))>=Math.round(Math.abs(S.y-x.y))?this.saveCircle=Math.round(Math.abs(S.x-x.x)):this.saveCircle=Math.round(Math.abs(S.y-x.y)),void 0!==xCity.widgetData&&void 0!==xCity.widgetData.underground_saveCircle&&(xCity.widgetData.underground_saveCircle=this.saveCircle,console.warn("xCity.widgetData.underground_saveCircle should not be used anymore. Instead use xCityUndergroundWindow radius property")),void 0===this.areaInfoCanvas){this.areaInfoCanvasTexture=new g({width:D,height:T,drawCB:function(t,e,i){var n="Area : "+this.sizeX*this.sizeY+" m2";e.fillStyle="#"+V.getHexString(),M(e,7*n.length-8,T),e.font="9pt Arial",e.fillStyle="#b2ccda",e.fillText(n,3,T-3),e.globalAlpha=1,e.strokeStyle="black",e.lineWidth=3}.bind(this),alphaTest:.02}),this.areaInfoCanvas=e.createCanvas2DNode({canvasNodeTexture:this.areaInfoCanvasTexture}),this.areaInfoCanvas.name="AreaInfoCanvas",this.areaInfoNodes.addChild(this.areaInfoCanvas);let t=this.areaInfoCanvas.getMatrix();t.elements[14]=x.z,this.areaInfoCanvas.setMatrix(t)}else this.areaInfoCanvasTexture.requestRedraw();if((A=this.areaInfoCanvas.getMatrix()).elements[12]=.6*S.x+.4*x.x,A.elements[13]=.5*S.y+.5*x.y,this.areaInfoCanvas.setMatrix(A),this.areaInfoCanvas._updateMatrix(),void 0===this.areaInfoX){this.areaInfoXTexture=new g({width:D,height:T,drawCB:function(t,e,i){var n="X : "+this.sizeX+" m";e.fillStyle="#"+V.getHexString(),M(e,7*n.length-8,T),e.font="9pt Arial",e.fillStyle="#b2ccda",e.fillText(n,3,T-3),e.globalAlpha=1,e.strokeStyle="black",e.lineWidth=3}.bind(this),alphaTest:.02}),this.areaInfoX=e.createCanvas2DNode({canvasNodeTexture:this.areaInfoXTexture}),this.areaInfoX.name="areaInfoX",this.areaInfoNodes.addChild(this.areaInfoX);let t=this.areaInfoX.getMatrix();t.elements[14]=x.z,this.areaInfoX.setMatrix(t)}else this.areaInfoXTexture.requestRedraw();if((A=this.areaInfoX.getMatrix()).elements[12]=.6*S.x+.4*x.x,A.elements[13]=S.y,this.areaInfoX.setMatrix(A),this.areaInfoX._updateMatrix(),void 0===this.areaInfoY){this.areaInfoYTexture=new g({width:D,height:T,drawCB:function(t,e,i){var n="Y : "+this.sizeY+" m";e.fillStyle="#"+V.getHexString(),M(e,7*n.length-8,T),e.font="9pt Arial",e.fillStyle="#b2ccda",e.fillText(n,3,T-3),e.globalAlpha=1,e.strokeStyle="black",e.lineWidth=3}.bind(this),alphaTest:.02}),this.areaInfoY=e.createCanvas2DNode({canvasNodeTexture:this.areaInfoYTexture}),this.areaInfoY.name="areaInfoY",this.areaInfoNodes.addChild(this.areaInfoY);let t=this.areaInfoY.getMatrix();t.elements[14]=x.z,this.areaInfoY.setMatrix(t)}else this.areaInfoYTexture.requestRedraw();(A=this.areaInfoY.getMatrix()).elements[12]=S.x,A.elements[13]=.5*S.y+.5*x.y,this.areaInfoY.setMatrix(A),this.areaInfoY._updateMatrix()}}}else if(this.selecting_window_)if(xCity._urbanImpl.USR._needRender=!0,this._renderer.undergroundSelectionManip.isSelectionDone()){this.selecting_window_=!1,this._undergroundNode.remove(this.windowInfoNodes);S=this._renderer.undergroundSelectionManip.getFinalAreaBL(),x=this._renderer.undergroundSelectionManip.getFinalAreaTR();this.window_radius_=Math.max(Math.abs(x.x-S.x),Math.abs(x.y-S.y)),this.activateWindowMode(),document.dispatchEvent(new Event("xCityUndergroundSelectionDone"))}else if(this._renderer.undergroundSelectionManip.isPreviewEnabled()){S=this._renderer.undergroundSelectionManip.getAreaBL(),x=this._renderer.undergroundSelectionManip.getAreaTR();if(this.BL.x!==S.x||this.BL.y!==S.y||this.TR.x!==x.x||this.TR.y!==x.y){if(this.firstFrameSelection)this.windowInfoNodes.pickable=!1,this._undergroundNode.addChild(this.windowInfoNodes),this.firstFrameSelection=!1,this._buildWindowModel(),this._renderPassManager.enablePass(this._undergroundStencilPass_id),this._renderPassManager.enablePass(this._windowFillPass_id),this._renderPassManager.enablePass(this._undergroundClearDepthPass_id),this._renderPassManager.enablePass(this._undergroundPostPass_id),this.window_position_x_=S.x,this.window_position_y_=S.y,(A=this._windowNode.getMatrix()).elements[12]=S.x,A.elements[13]=S.y,this._windowNode.setMatrix(A);this.BL=S,this.TR=x,(A=this._windowNode.getMatrix()).elements[0]=Math.abs(x.x-S.x),A.elements[5]=Math.abs(x.y-S.y),this._windowNode.setMatrix(A),this._windowNode._updateMatrix();var A;M=function(t,e,i){t.beginPath(),t.moveTo(0,0),t.lineTo(e,0),t.lineTo(e,i),t.lineTo(0,i),t.lineTo(0,0),t.closePath(),t.fill()},D=160,T=15,V=this.blueColor;this.area=Math.abs(S.x-x.x)*Math.abs(S.y-x.y)*Math.PI,this.area>1e3?this.area=this.area.toFixed(0):this.area=this.area.toFixed(2),this.sizeX=Math.abs(S.x-x.x),this.sizeY=Math.abs(S.y-x.y),void 0===this.windowInfoCanvas?(this.windowInfoCanvasTexture=new g({width:D,height:T,drawCB:function(t,e,i){var n="Area : "+this.area+" m2";e.fillStyle="#"+V.getHexString(),M(e,7*n.length-8,T),e.font="9pt Arial",e.fillStyle="#b2ccda",e.fillText(n,3,T-3),e.globalAlpha=1,e.strokeStyle="black",e.lineWidth=3}.bind(this),alphaTest:.02}),this.windowInfoCanvas=e.createCanvas2DNode({canvasNodeTexture:this.windowInfoCanvasTexture}),this.windowInfoCanvas.name="WindowInfoCanvas",this.windowInfoNodes.addChild(this.windowInfoCanvas)):this.windowInfoCanvasTexture.requestRedraw(),(A=this.windowInfoCanvas.getMatrix()).elements[12]=.6*S.x+.4*x.x,A.elements[13]=.5*S.y+.5*x.y,this.windowInfoCanvas.setMatrix(A),this.windowInfoCanvas._updateMatrix(),void 0===this.windowInfoX?(this.windowInfoXTexture=new g({width:D,height:T,drawCB:function(t,e,i){var n="X : "+this.sizeX+" m";e.fillStyle="#"+V.getHexString(),M(e,7*n.length-8,T),e.font="9pt Arial",e.fillStyle="#b2ccda",e.fillText(n,3,T-3),e.globalAlpha=1,e.strokeStyle="black",e.lineWidth=3}.bind(this),alphaTest:.02}),this.windowInfoX=e.createCanvas2DNode({canvasNodeTexture:this.windowInfoXTexture}),this.windowInfoX.name="areaInfoX",this.windowInfoNodes.addChild(this.windowInfoX)):this.windowInfoXTexture.requestRedraw(),(A=this.windowInfoX.getMatrix()).elements[12]=.6*S.x+.4*x.x,A.elements[13]=S.y,this.windowInfoX.setMatrix(A),this.windowInfoX._updateMatrix(),void 0===this.windowInfoY?(this.windowInfoYTexture=new g({width:D,height:T,drawCB:function(t,e,i){var n="Y : "+this.sizeY+" m";e.fillStyle="#"+V.getHexString(),M(e,7*n.length-8,T),e.font="9pt Arial",e.fillStyle="#b2ccda",e.fillText(n,3,T-3),e.globalAlpha=1,e.strokeStyle="black",e.lineWidth=3}.bind(this),alphaTest:.02}),this.windowInfoY=e.createCanvas2DNode({canvasNodeTexture:this.windowInfoYTexture}),this.windowInfoY.name="areaInfoY",this.windowInfoNodes.addChild(this.windowInfoY)):this.windowInfoYTexture.requestRedraw(),(A=this.windowInfoY.getMatrix()).elements[12]=S.x,A.elements[13]=.5*S.y+.5*x.y,this.windowInfoY.setMatrix(A),this.windowInfoY._updateMatrix()}}this.last_timestamp_=i},updateWindowUV:function(){this._windowNode.mesh3js.boundingBox.min.clone(),this._windowNode.mesh3js.boundingBox.max.clone();for(var t,e=this.window_radius_,i=0,n=this._windowNode.mesh3js.geometry[0].vertexIndexArray.length;i<n;){var s=this._windowNode.mesh3js.geometry[0].vertexIndexArray[i],r=this._windowNode.mesh3js.geometry[0].vertexIndexArray[i+1],o=this._windowNode.mesh3js.geometry[0].vertexIndexArray[i+2],a=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*s],h=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*s+1],l=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*s+2],d=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*r],u=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*r+1],c=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*r+2],g=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*o],m=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*o+1],f=this._windowNode.mesh3js.geometry[0].vertexPositionArray[3*o+2];l===c&&l===f?(t=(a+e)/(2*e),t/=2,this._windowNode.mesh3js.geometry[0].vertexUvArray[3*s]=t,t=(h+e)/(2*e),t/=2,this._windowNode.mesh3js.geometry[0].vertexUvArray[3*s+1]=t,t=(d+e)/(2*e),t/=2,this._windowNode.mesh3js.geometry[0].vertexUvArray[3*r]=t,t=(u+e)/(2*e),t/=2,this._windowNode.mesh3js.geometry[0].vertexUvArray[3*r+1]=t,t=(g+e)/(2*e),t/=2,this._windowNode.mesh3js.geometry[0].vertexUvArray[3*o]=t,t=(m+e)/(2*e),t/=2,this._windowNode.mesh3js.geometry[0].vertexUvArray[3*o+1]=t):(30===l?this._windowNode.mesh3js.geometry[0].vertexUvArray[3*s+1]=.5:-30===l&&(this._windowNode.mesh3js.geometry[0].vertexUvArray[3*s+1]=1),30===c?this._windowNode.mesh3js.geometry[0].vertexUvArray[3*r+1]=.5:-30===c&&(this._windowNode.mesh3js.geometry[0].vertexUvArray[3*r+1]=1),30===f?this._windowNode.mesh3js.geometry[0].vertexUvArray[3*o+1]=.5:-30===f&&(this._windowNode.mesh3js.geometry[0].vertexUvArray[3*o+1]=1)),i+=3}},startAreaSelection:function(t){l.log("UNDERGROUND VISU DEBUG : startAreaSelection : "+t),this._renderer.undergroundSelectionManip=new r(this._renderer.urban,this._viewpoint,this._viewerDiv),this.previousControl=this._renderer.controls,this._renderer.setControl(this._renderer.undergroundSelectionManip),"AREA"===t?this.selecting_area_=!0:"WINDOW"===t&&(this.selecting_window_=!0),this.firstFrameSelection=!0},isSelectingArea:function(){return this.selecting_area_},defineArea:function(t,e,i,n){this.area_position_x_=t,this.area_position_y_=e,this.area_size_x_=i-t,this.area_size_y_=n-e,this.areaLeft=t,this.areaRight=i,this.areaTop=n,this.areaBottom=e},defineWindow:function(t,e,i){this.window_position_x_=t,this.window_position_y_=e,this.window_radius_=i},windowSizeUp:function(){this.window_size_index_<this.window_sizes_.length-1&&(this.window_size_index_++,this.mode_)},windowSizeDown:function(){this.window_size_index_>0&&(this.window_size_index_--,this.mode_)},buildParticuleCylinder:function(){var t,e,i,n,s=this.window_radius_,r=[];for(t=0;t<10;t++)for(i=Math.cos(t*(2*Math.PI)/10),i*=s,n=Math.sin(2*t*Math.PI/10),n*=s,-30,e=0;e<13;e++)r.push(i),r.push(n),r.push(5*e-30);return r},setMaxHeightForWindowMode:function(t){this.maxHeightForWindowMode=t},_scaleArea:function(e,i){(new t.Matrix4).makeScale(e,i,1);this.area_size_x_*=e,this.area_size_y_*=i},_resizeArea:function(t,e){t>=1&&e>=1&&this._scaleArea(t/this.area_size_x_,e/this.area_size_y_)},_moveArea:function(t,e){var i=t-this.area_position_x_,n=e-this.area_position_y_;0!==i&&0!==n&&(this.area_line_node_.translateX(i),this.area_line_node_.translateY(n),this.area_position_x_=t,this.area_position_y_=e)},_scaleWindow:function(t){var e=this._windowNode.getMatrix();e.elements[0]=t,e.elements[5]=t,this._windowNode.setMatrix(e),this._windowNode._updateMatrix(),this.window_radius_=t;var i=t,n=t,s=e.elements[12],r=e.elements[13];this.TR.x=s+n,this.TR.y=r,this.BL.x=s,this.BL.y=r-i;var o=this.windowInfoX.getMatrix();o.elements[12]=.6*this.BL.x+.4*this.TR.x,o.elements[13]=this.BL.y,this.windowInfoX.setMatrix(o),this.windowInfoX._updateMatrix();var a=this.windowInfoY.getMatrix();a.elements[12]=this.BL.x,a.elements[13]=.5*this.BL.y+.5*this.TR.y,this.windowInfoY.setMatrix(a),this.windowInfoY._updateMatrix();var h=this.windowInfoCanvas.getMatrix();h.elements[12]=.6*this.BL.x+.4*this.TR.x,h.elements[13]=.5*this.BL.y+.5*this.TR.y,this.windowInfoCanvas.setMatrix(h),this.windowInfoCanvas._updateMatrix(),this.area=Math.abs(this.BL.x-this.TR.x)*Math.abs(this.BL.y-this.TR.y)*Math.PI,this.area>1e3?this.area=this.area.toFixed(0):this.area=this.area.toFixed(2),this.sizeX=Math.abs(this.BL.x-this.TR.x),this.sizeY=Math.abs(this.BL.y-this.TR.y),this.windowInfoCanvasTexture.requestRedraw(),this.windowInfoXTexture.requestRedraw(),this.windowInfoYTexture.requestRedraw()},_resizeWindow:function(t){this._scaleWindow(t/this.window_radius_)},_moveWindow:function(t,e,i){},_destroyAreaLine:function(){this._undergroundNode.removeChild(this.area_line_node_),this.area_line_node_=null},_createAreaLine:function(n,s){var r,o;this.areaBox=new i("line_node"),(r=[]).push(new t.Vector3(this.areaLeft,this.areaBottom,s)),r.push(new t.Vector3(this.areaLeft,this.areaBottom,n)),(o=e.createLineNode({material:this.lineMat,points:r,color:this.blueColor,width:1})).name="line_node",this.areaBox.addChild(o),(r=[]).push(new t.Vector3(this.areaRight,this.areaBottom,s)),r.push(new t.Vector3(this.areaRight,this.areaBottom,n)),(o=e.createLineNode({material:this.lineMat,points:r,color:this.blueColor,width:1})).name="line_node",this.areaBox.addChild(o),(r=[]).push(new t.Vector3(this.areaRight,this.areaTop,s)),r.push(new t.Vector3(this.areaRight,this.areaTop,n)),(o=e.createLineNode({material:this.lineMat,points:r,color:this.blueColor,width:1})).name="line_node",this.areaBox.addChild(o),(r=[]).push(new t.Vector3(this.areaLeft,this.areaTop,s)),r.push(new t.Vector3(this.areaLeft,this.areaTop,n)),(o=e.createLineNode({material:this.lineMat,points:r,color:this.blueColor,width:1})).name="line_node",this.areaBox.addChild(o),(r=[]).push(new t.Vector3(this.areaLeft,this.areaBottom,s)),r.push(new t.Vector3(this.areaRight,this.areaBottom,s)),r.push(new t.Vector3(this.areaRight,this.areaTop,s)),r.push(new t.Vector3(this.areaLeft,this.areaTop,s)),r.push(new t.Vector3(this.areaLeft,this.areaBottom,s)),(o=e.createLineNode({material:this.lineMat,points:r,color:this.blueColor,width:5})).name="line_node",this.areaBox.addChild(o),(r=[]).push(new t.Vector3(this.areaLeft,this.areaBottom,n)),r.push(new t.Vector3(this.areaRight,this.areaBottom,n)),r.push(new t.Vector3(this.areaRight,this.areaTop,n)),r.push(new t.Vector3(this.areaLeft,this.areaTop,n)),r.push(new t.Vector3(this.areaLeft,this.areaBottom,n)),(o=e.createLineNode({material:this.lineMat,points:r,color:this.blueColor,width:1})).name="line_node",this.areaBox.addChild(o),this._undergroundNode.addChild(this.areaBox)},_createAreaPlanes:function(i,n,s){this.areaClippingPlanes.setRenderPasses([this._undergroundBboxPass_id]),s?(this.lineMat.side=t.DoubleSide,this.lineMat.forceSide=!0,void 0!==this.lineMat._deferredMaterials.depthMaterial&&(this.lineMat._deferredMaterials.depthMaterial.forceSide=!0,this.lineMat._deferredMaterials.depthMaterial.side=t.DoubleSide)):(this.lineMat.side=t.BackSide,this.lineMat.forceSide=!0,void 0!==this.lineMat._deferredMaterials.depthMaterial&&(this.lineMat._deferredMaterials.depthMaterial.forceSide=!0,this.lineMat._deferredMaterials.depthMaterial.side=t.BackSide)),this.bottomPlaneNode=e.createRectangleNode({material:this.lineMat,width:Math.abs(this.areaRight-this.areaLeft),height:Math.abs(n-i),fill:!0,noEdge:!0}),this.bottomPlaneNode.setMatrix((new t.Matrix4).translate(new t.Vector3(this.areaLeft,this.areaBottom,i)).rotateX(Math.PI/2)),s&&(this.bottomPlaneNode.name="BottomPlane"),this.areaClippingPlanes.addChild(this.bottomPlaneNode),this.topPlaneNode=e.createRectangleNode({material:this.lineMat,width:Math.abs(this.areaRight-this.areaLeft),height:Math.abs(n-i),fill:!0,noEdge:!0}),this.topPlaneNode.setMatrix((new t.Matrix4).translate(new t.Vector3(this.areaLeft,this.areaTop,n)).rotateX(-Math.PI/2)),s&&(this.topPlaneNode.name="TopPlane"),this.areaClippingPlanes.addChild(this.topPlaneNode),this.leftPlaneNode=e.createRectangleNode({material:this.lineMat,width:Math.abs(this.areaTop-this.areaBottom),height:Math.abs(n-i),fill:!0,noEdge:!0}),this.leftPlaneNode.setMatrix((new t.Matrix4).translate(new t.Vector3(this.areaLeft,this.areaTop,i)).rotateX(Math.PI/2).rotateY(-Math.PI/2)),s&&(this.leftPlaneNode.name="LeftPlane"),this.areaClippingPlanes.addChild(this.leftPlaneNode),this.rightPlaneNode=e.createRectangleNode({material:this.lineMat,width:Math.abs(this.areaTop-this.areaBottom),height:Math.abs(n-i),fill:!0,noEdge:!0}),this.rightPlaneNode.setMatrix((new t.Matrix4).translate(new t.Vector3(this.areaRight,this.areaBottom,i)).rotateX(Math.PI/2).rotateY(Math.PI/2)),s&&(this.rightPlaneNode.name="RightPlane"),this.areaClippingPlanes.addChild(this.rightPlaneNode),this._undergroundNode.addChild(this.areaClippingPlanes)},_createLevelPlanes:function(n,s){var r,o;this.areaDepthPlanes=new i;for(var a=s;a>=n;a-=this.tickDistance)(r=new u.getCustomShaderMaterial([u.common,u.urbanLights])).uniforms.ambient.value=this.blueColor,r.uniforms.diffuse.value=this.blueColor,r.uniforms.specular.value=this.blueColor,r.transparent=!0,r.uniforms.opacity.value=.4,(o=e.createCuboidNode({cornerPoint:new t.Vector3(this.areaLeft,this.areaBottom,a),firstAxis:new t.Vector3(this.areaRight-this.areaLeft,0,0),secondAxis:new t.Vector3(0,this.areaTop-this.areaBottom,0),thirdAxis:new t.Vector3(0,0,0),material:r})).name="plane_node",this.areaDepthPlanes.addChild(o);this.areaDepthPlanes.pickable=!1,this._undergroundNode.addChild(this.areaDepthPlanes)},_createLevelTicksWindow:function(n,s){this.groundHeight;var r,o,a,h=this.blueColor,l=function(t,e,i){t.beginPath(),t.moveTo(0,0),t.lineTo(e,0),t.lineTo(e,i),t.lineTo(0,i),t.lineTo(0,0),t.closePath(),t.fill()};this.WindowLevelMarkBLNodes=new i("BLNodes");for(var d=s;d>=n;d-=this.tickDistance){var u=new g({width:70,height:15,drawCB:function(t,e,i){var n=d+" m";e.fillStyle="#"+h.getHexString(),l(e,7*n.length+5,15),e.font="9pt Arial",e.fillStyle="#b2ccda",e.fillText(n,3,12),e.globalAlpha=1,e.strokeStyle="black",e.lineWidth=3},alphaTest:.02});this.sizeX>this.sizeY?(this.offset_y=this.window_radius_,this.offset_x=0):(this.offset_x=this.window_radius_,this.offset_y=0),!0===this.underground_Window_mvnt_ticks&&(this.window_position_x_=this.underground_NewposX,this.window_position_y_=this.underground_NewposY),(o=e.createCanvas2DNode({canvasNodeTexture:u})).setMatrix((new t.Matrix4).translate(new t.Vector3(this.window_position_x_+this.offset_y,this.window_position_y_+this.offset_x,d))),o.name="level mark node",this.WindowLevelMarkBLNodes.addChild(o)}this.WindowTicks.addChild(this.WindowLevelMarkBLNodes),this.WindowLevelGradNodes=new i("GradNodes");for(d=s;d>n;d-=this.tickDistance)(a=[]).push(new t.Vector3(this.window_position_x_,this.window_position_y_+this.window_radius_,d)),(r=e.createLineNode({material:this.lineMat,points:a,color:this.blueColor,width:1})).name="tick",this.WindowLevelGradNodes.addChild(r);this.WindowTicks.addChild(this.WindowLevelGradNodes),this.WindowTicks.pickable=!1,this._undergroundNode.addChild(this.WindowTicks),this.underground_Window_mvnt_ticks=!1},_createLevelTicks:function(n,s){this.groundHeight;var r,o,a=this.blueColor,h=function(t,e,i){t.beginPath(),t.moveTo(0,0),t.lineTo(e,0),t.lineTo(e,i),t.lineTo(0,i),t.lineTo(0,0),t.closePath(),t.fill()};this.areaLevelMarkBLNodes=new i("BLNodes"),this.areaLevelMarkBRNodes=new i("BRNodes"),this.areaLevelMarkTLNodes=new i("TLNodes"),this.areaLevelMarkTRNodes=new i("TRNodes");for(var l=s;l>=n;l-=this.tickDistance){var d=new g({width:70,height:15,drawCB:function(t,e,i){var n=l+" m";e.fillStyle="#"+a.getHexString(),h(e,7*n.length+5,15),e.font="9pt Arial",e.fillStyle="#b2ccda",e.fillText(n,3,12),e.globalAlpha=1,e.strokeStyle="black",e.lineWidth=3},alphaTest:.02});(o=e.createCanvas2DNode({canvasNodeTexture:d})).setMatrix((new t.Matrix4).translate(new t.Vector3(this.areaLeft,this.areaBottom,l))),o.name="level mark node",this.areaLevelMarkBLNodes.addChild(o),(o=e.createCanvas2DNode({canvasNodeTexture:d})).setMatrix((new t.Matrix4).translate(new t.Vector3(this.areaRight,this.areaBottom,l))),o.name="level mark node",this.areaLevelMarkBRNodes.addChild(o),(o=e.createCanvas2DNode({canvasNodeTexture:d})).setMatrix((new t.Matrix4).translate(new t.Vector3(this.areaRight,this.areaTop,l))),o.name="level mark node",this.areaLevelMarkTRNodes.addChild(o),(o=e.createCanvas2DNode({canvasNodeTexture:d})).setMatrix((new t.Matrix4).translate(new t.Vector3(this.areaLeft,this.areaTop,l))),o.name="level mark node",this.areaLevelMarkTLNodes.addChild(o)}this.areaTicks.addChild(this.areaLevelMarkBLNodes),this.areaTicks.addChild(this.areaLevelMarkBRNodes),this.areaTicks.addChild(this.areaLevelMarkTLNodes),this.areaTicks.addChild(this.areaLevelMarkTRNodes),this.areaLevelGradNodes=new i("GradNodes");var u,c=(this.areaRight-this.areaLeft)/25,m=(this.areaTop-this.areaBottom)/25;for(l=s;l>n;l-=this.tickDistance)(u=[]).push(new t.Vector3(this.areaLeft,this.areaBottom+m,l)),u.push(new t.Vector3(this.areaLeft,this.areaBottom,l)),u.push(new t.Vector3(this.areaLeft+c,this.areaBottom,l)),(r=e.createLineNode({material:this.lineMat,points:u,color:this.blueColor,width:1})).name="tick",this.areaLevelGradNodes.addChild(r),(u=[]).push(new t.Vector3(this.areaRight-c,this.areaBottom,l)),u.push(new t.Vector3(this.areaRight,this.areaBottom,l)),u.push(new t.Vector3(this.areaRight,this.areaBottom+m,l)),(r=e.createLineNode({material:this.lineMat,points:u,color:this.blueColor,width:1})).name="tick",this.areaLevelGradNodes.addChild(r),(u=[]).push(new t.Vector3(this.areaRight,this.areaTop-m,l)),u.push(new t.Vector3(this.areaRight,this.areaTop,l)),u.push(new t.Vector3(this.areaRight-c,this.areaTop,l)),(r=e.createLineNode({material:this.lineMat,points:u,color:this.blueColor,width:1})).name="tick",this.areaLevelGradNodes.addChild(r),(u=[]).push(new t.Vector3(this.areaLeft+c,this.areaTop,l)),u.push(new t.Vector3(this.areaLeft,this.areaTop,l)),u.push(new t.Vector3(this.areaLeft,this.areaTop-m,l)),(r=e.createLineNode({material:this.lineMat,points:u,color:this.blueColor,width:1})).name="tick",this.areaLevelGradNodes.addChild(r);this.areaTicks.addChild(this.areaLevelGradNodes),this.areaTicks.pickable=!1,this._undergroundNode.addChild(this.areaTicks)},_destroyAreaNodes:function(){this._undergroundNode.removeChildren(),this.areaBox=null,this.areaClippingPlanes=null,this.areaTicks=null,this.areaDepthPlanes=null,this.area_line_node_=null,this.area_grad_node_=null,this.area_info_node_=null,this._areaNode=null},_buildWindowModel:function(){this._windowNode=e.createCylinderNode({bottomCenterPoint:new t.Vector3(this.window_position_x_,this.window_position_y_,this.window_position_z_-this.maxDepth),topCenterPoint:new t.Vector3(this.window_position_x_,this.window_position_y_,this.window_position_z_+1e4),radius:1,material:this.matW}),this._windowNode.setShadow(!1,!1),this.updateWindowUV(),this._undergroundNode.addChild(this._windowNode),this._windowNode.setRenderPasses([this._undergroundStencilPass_id,this._windowFillPass_id])},_destroyWindowModel:function(){this._undergroundNode.removeChild(this._windowNode),this._windowNode=null,this.window_position_z_=0,this.window_position_y_=0,this.window_position_x_=0},_sign:function(t,e,i){return(t.x-i.x)*(e.y-i.y)-(e.x-i.x)*(t.y-i.y)},_pickingUnderground:function(e,i){var n=this._viewer,s=i.from&&i.from.length?i.from[0]:null,r=n.getMousePosition(s.currentPosition),o=n.computeIntersection(r,n.picking.gpu,n.picking.primitive,!0,{ray:null});if(o.length&&o[0].object&&o[0].object._occurrence&&(this.initial3dIntersectionPoint=o[0].point,this.initial3dIntersectionPointTranslated=o[0].point.clone(),"LeftPlane"==o[0].object._occurrence.node.name&&(this.initial3dIntersectionPointTranslated.add(new t.Vector3(1,0,0)),this.movingPlane=1),"RightPlane"==o[0].object._occurrence.node.name&&(this.initial3dIntersectionPointTranslated.add(new t.Vector3(1,0,0)),this.movingPlane=2),"TopPlane"==o[0].object._occurrence.node.name&&(this.initial3dIntersectionPointTranslated.add(new t.Vector3(0,1,0)),this.movingPlane=3),"BottomPlane"==o[0].object._occurrence.node.name&&(this.initial3dIntersectionPointTranslated.add(new t.Vector3(0,1,0)),this.movingPlane=4),this.movingPlane>0)){this._renderer.undergroundManip.enabled=!1;var a=b.getWebappsAssetUrl("UrbanWidget","")+"icons/32/",h="url('"+a+"UrbanPan.png') 15 15, url('"+a+"UrbanPan.cur') 15 15, auto";this._renderer.webGLV6Viewer.div.style.cursor=h,console.log("SET ICON")}},_initMovePlane:function(e,i){this._renderer.undergroundManip.enabled=!1,this.movingPlane=e.planeId,1==e.planeId&&(this.initial3dIntersectionPoint=(new t.Vector3).copy(this.leftPlaneNode.matrix.getPosition())),2==e.planeId&&(this.initial3dIntersectionPoint=(new t.Vector3).copy(this.rightPlaneNode.matrix.getPosition())),3==e.planeId&&(this.initial3dIntersectionPoint=(new t.Vector3).copy(this.topPlaneNode.matrix.getPosition())),4==e.planeId&&(this.initial3dIntersectionPoint=(new t.Vector3).copy(this.bottomPlaneNode.matrix.getPosition())),this.initial3dIntersectionPoint.z=0,this._viewpoint._translateToRelativePosition(this.initial3dIntersectionPoint),this.initial3dIntersectionPointTranslated=(new t.Vector3).copy(this.initial3dIntersectionPoint),1==e.planeId||2==e.planeId?this.initial3dIntersectionPointTranslated.add(new t.Vector3(1,0,0)):this.initial3dIntersectionPointTranslated.add(new t.Vector3(0,1,0))},_movePlane:function(e,i){if(this.movingPlane){var n=(new t.Vector2).copy(i.from[0].getCurrentPosition(this._viewer.canvas)),s=this._viewer.currentViewpoint.create3DRayFrom2DPoint(n).computeShortestPointToLine(this.initial3dIntersectionPoint,this.initial3dIntersectionPointTranslated);this._viewpoint._translateToAbsolutePosition(s),(new t.Matrix4).setPosition(s),1==this.movingPlane&&(this.areaLeft=s.x),2==this.movingPlane&&(this.areaRight=s.x),3==this.movingPlane&&(this.areaTop=s.y),4==this.movingPlane&&(this.areaBottom=s.y),this._updateBox(),this.showTicks&&(this._updateTicks(),this.showPlanes&&this._updatePlanes())}},_endMovePlane:function(t,e){this.movingPlane&&(this.movingPlane=0,this._renderer.undergroundManip.enabled=!0,this._renderer.webGLV6Viewer.div.style.cursor="auto")},_showInformation:function(t){t?this._undergroundNode.addChild(this.windowInfoNodes):this._undergroundNode.removeChild(this.windowInfoNodes)}},w}),define("DS/UrbanFeature/KeyFrameAnimation",["DS/UrbanFeature/Geometry","DS/XCityModel/Item"],function(t,e){"use strict";var i=t.extend({metaData:{type:"KeyFrameAnimation",className:"KeyFrameAnimation"},destroy:function(t){this._parent(t)}});return e.ObjectContructor.KeyFrameAnimation=i}),define("DS/UrbanManipulator/ArrowHandle",["DS/Manipulators/PointHandle","DS/UrbanAPI/xCityItem","DS/UrbanManipulator/Manipulator","DS/XCityTools/Geocoder","DS/UrbanTool/Utils","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/UrbanTool/DrawingManipulatorTool","DS/xCityBasicUtils/DataFormatTools","DS/SceneGraphNodes/FixedSizeNode3D","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Robot/LineTranslationNode","DS/XCityTools/ShaderTools"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g){"use strict";var m;return g.extend({init:function(t){s.is(t)||(t={}),t.touchMode=!0,this._parent(t),s.is(m)?this.mat.map=m:m=this.mat.map,this.modelEvents=this._modelEvent}})}),define("DS/UrbanManipulator/AltitudeNode",["DS/Manipulators/PointHandle","DS/UrbanAPI/xCityItem","DS/UrbanManipulator/Manipulator","DS/XCityTools/Geocoder","DS/UrbanTool/Utils","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/UrbanTool/DrawingManipulatorTool","DS/xCityBasicUtils/DataFormatTools","DS/SceneGraphNodes/FixedSizeNode3D","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/UrbanManipulator/ArrowHandle","DS/XCityTools/ShaderTools"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g){"use strict";return c.extend({init:function(t,e,i){var n=this;this.urban=t,this.tool=e,window.URBANODT?this._extrusionHandleNode=new c:this._extrusionHandleNode=new g;var s=new l({name:"extrusionFixedSizeNode3D",ratio:7});s.addChild(this._extrusionHandleNode),this._extrusionHandleNode.subscribe({event:"LineTranslationBegin"},function(){n._extrusionHandleNode.initialMatrix=(new u.Matrix4).copy(n.getMatrix()),!0===n.tool.altitudeDisplay&&(n._extrusionHandleNode.altitudeEffect=n.urban.getView3D().getAltitudeEffect(),n._extrusionHandleNode.altitudeEffect.enableEffect())}),this._extrusionHandleNode.subscribe({event:"LineTranslationManipulation"},function(t){var e=t.translationVector,i=new u.Vector3;if(i.getPositionFromMatrix(n._extrusionHandleNode.initialMatrix),i.add(e),n._extrusionHandleNode.altitudeEffect){var s=n._extrusionHandleNode.getMatrixWorld().getPositionFromMatrix();n._extrusionHandleNode.altitudeEffect.disableEffect(),n._extrusionHandleNode.altitudeEffect._currentZ=s.z,n._extrusionHandleNode.altitudeEffect.enableEffect()}n.updateRoofAltitude(i.z),n.updateLine()}),this._extrusionHandleNode.subscribe({event:"LineTranslationEnd"},function(){n._extrusionHandleNode.altitudeEffect&&(n._extrusionHandleNode.altitudeEffect.disableEffect(),n._extrusionHandleNode.altitudeEffect=null)}),this._parent(),this.addChild(s)},updateHandlePosition:function(t){this.setMatrix((new u.Matrix4).setPosition(t))},handleWasUpdate:function(){}})}),define("DS/UrbanFeature/View3DPicker",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/XCityModel/Feature","DS/XCityModel/Item","DS/Visualization/PathElement","DS/XCityTools/EventDispatcher","DS/XCityTools/Debug","DS/UrbanFeature/ObjectSelection","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/xCityBasicUtils/Utils","DS/XCityModel/GeometrySet","DS/XCityTools/Geocoder"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g,m){"use strict";return UWA.Class.extend({init:function(t,e){this._urban=t,this._renderer=this._urban.getView3D(),this._eventsListeners={},this._dataModelSelection=e,this._objectSelection=new h(t),this.addEventListener("onLeftDoubleClick",this.selectAndMoveTo.bind(this)),this.addEventListener("onLeftClick",this.select.bind(this)),this.addEventListener("onTap",this.select.bind(this)),this.addEventListener("onDoubleTap",this.selectAndMoveTo.bind(this)),this._urban.poiManager.addEvent("onMouseDown",this._mouseDownPoi.bind(this)),this._urban.poiManager.addEvent("onMouseDblClick",this._mouseDblClickPoi.bind(this)),this.disabled=!1,this.leftClickDone=!1,this.nbFeatureHoverable=0,this.hoverFnBind=this.hover.bind(this)},disable:function(){this.disabled=!0},enable:function(){this.disabled=!1},getObjectSelection:function(){return this._objectSelection},setPrepicking:function(t){t?this.nbFeatureHoverable++:this.nbFeatureHoverable--,1===this.nbFeatureHoverable&&t?this.addEventListener("onMouseMove",this.hoverFnBind):0===this.nbFeatureHoverable&&this.removeEventListener("onMouseMove",this.hoverFnBind)},addEventListener:function(t,e){if(t){var i=this._eventsListeners[t];if(i)i.callbacks.push(e);else{var n=[];n.push(e),this._eventsListeners[t]={token:o.subscribeTo("/VISU/"+t,this._picking.bind(this,n)),callbacks:n}}}return this},removeEventListener:function(t,e){var i=this._eventsListeners[t];if(i)for(var n=0;n<i.callbacks.length;n++)if(i.callbacks[n]===e)return i.callbacks.splice(n,1),0===i.callbacks.length&&(o.unsubscribe(i.token),delete this._eventsListeners[t]),!0;return!1},clearEventListener:function(){return this._eventsListeners={},this},selectAndMoveTo:function(t,e,i){return this.select(t,e,i),e._movetoFeatureLaunched=!0,t instanceof s&&this._urban.getView3D().getControl().moveToFeature(t),!0},select:function(t,e,i){if(!t)return!1;if(t instanceof s){var n=t.get("selected"),r=this._renderer.webGLV6Viewer.forceMultiSel;if(e&&e.event?r=r||e.event.ctrlKey:e&&(r=e.ctrlKey),r||this._dataModelSelection.clear(),t.get("selectable"))return t._folderParent||(this._dataModelSelection.getSelection().forEach(function(e){e.id===t.id&&(t=e,n=!0)}),n||(this._dataModelSelection.listenSelection(t),t.get("hovered")&&t.set("hovered",!1))),n?a.log("Deselect",t.id):a.log("Select",t.id),t.getContent()._layer&&t.getContent()._layer.isLayer&&t.getContent()._layer.isWFS&&(t.userData={fromWFS:!0,type:t.getContent()._subMeshes[0].mesh.parents[0].indexMesh||t.getContent()._subMeshes[0].mesh.parents[0].parents[0].indexMesh}),t.set("selected",!r||!n,e),!0}else this._objectSelection.select(t,i);return!1},hover:function(t,e){if(!t)return!1;if(t instanceof s){var i=t.get("hovered"),n=t.get("selected");if(!i&&!n)return this._dataModelSelection.clearHover(),t._folderParent||i||this._dataModelSelection.listenHovering(t),i?a.log("Dehover",t.id):a.log("Hover",t.id),t.set("hovered",!0),!0}return!1},_emptyPick:function(t){this._objectSelection.emptySelect(t)},_emptyHover:function(t){},_launch:function(t,e,i,n){for(var s=0;s<t.length;s++)t[s](e,i,n)},_mouseDownPoi:function(t,e){if(t.userData instanceof n){var i="";if(1===e.which?i="onLeftClick":2===e.which?i="onMiddleClick":3===e.which&&(i="onRightClick"),i.length>0){var s=this._eventsListeners[i];s&&this._launch(s.callbacks,t.userData,e)}}a.log("_pickPOI")},_mouseDblClickPoi:function(t,e){if(t.userData instanceof n&&1===e.which){var i=this._eventsListeners.onLeftDoubleClick;i&&this._launch(i.callbacks,t.userData,e)}a.log("_mouseDblClickPoi")},getClosestObject:function(t){if(!t)return 0;if(!Array.isArray(t))return 0;var e,i,n=0,s=t[0];if(void 0===s.distance)return 0;if(t.length>1)for(e=1;e<t.length;e++)if(i=t[e]){if(i.distance>s.distance)break;n++}return n},_isNotFromCityViewer:function(t){var e=!0;if(t.event.path)"xCityViewer"===t.event.path[1].id?e=!1:"xCityViewer"===t.event.path[0].id&&(e=!1);else if(t.event.target)if("xCityViewer"===t.event.target.id)e=!1;else{var i=t.event.target.parentElement;i&&("xCityViewer"===i.id?e=!1:i.parentElement&&"xCityViewer"===i.parentElement.id&&(e=!1))}return e},_manualPrimPicking:function(t,e,i,n,o){let a=this,h=function(){l&&l[0]&&l[0].path&&(l[0].path=null),a._emptyPick(t)},l=i.computeIntersection(n,i.picking.gpu,!1,!1,o),d=!1;for(let t=0;t<l[0].object.geometry[0].drawingGroups[0].primitives.length&&!d;t++){let i;l[0].primitive=l[0].object.geometry[0].drawingGroups[0].primitives[t],l[0].path=new r,l[0].path.setFromOccurrence(l[0].object._occurrence,THREEDS.SubElement.getFromSGNode(l[0].primitive)),void 0!==l[0].instanceId&&(l[0].path.instanceId=l[0].instanceId);for(let t=0;t<l[0].path.externalPath.length&&!i;++t)l[0].path.externalPath[t].userData instanceof s&&(i=l[0].path.externalPath[t].userData);if(!i.get("Content").getRendering().getRenderingValues().polyExtruOptim)return h();let n=this._urban.baseProjection,o=function(t,e){if("WGS84"!==n){let i=m.proj(t,e,"WGS84");t[0]=i.x,t[1]=i.y}},a=this._urban.USR.getViewpoint().exactPick(e.currentPosition);o(a,n);let u=[a[0],a[1]],g=i._attributes.Content._factory.geoJSON[l[0].primitive.cgmId],f=c.structuredClone(g.features[0].geometry),p=f.coordinates,v=[];if(f.type&&"Polygon"===f.type){let t=f.coordinates;for(let e=0;e<t.length;++e){let i=t[e];for(let t=0;t<i.length;++t)o(i[t],n)}v.push(c.coordinatesToTurfPolygon(p))}else{if(!f.type||"MultiPolygon"!==f.type)return h();{let t=f.coordinates;for(let e=0;e<t.length;++e){let i=t[e][0];for(let t=0;t<i.length;++t){o(i[t],n)}v.push(c.coordinatesToTurfPolygon(t[e]))}}}let _=c.coordinatesToTurfPoint(u);d=!1;for(let t=0;t<v.length&&!d;t++){d=c.turfBooleanContains(v[t],_);const e=Math.max(.1,xCity._urbanImpl.USR.viewpoint.getTargetDistance()/1e3),i={units:"meters",method:"planar"};let n=!1;for(let s=0;s<v[t].geometry.coordinates.length&&!d;s++){let r=c.coordinatesToTurfLineString(v[t].geometry.coordinates[s]);(n=c.turfPointToLineDistance(_,r,i)<e)&&(d=!0)}}}return d?l:(l=[],h())},_picking:function(t,e){if(!this.disabled){var o=function(t){return t.ctrlKey},a=this._renderer.webGLV6Viewer,h=e.from&&e.from.length?e.from[0]:null;if(!this._isNotFromCityViewer(h)){var l=!1;if("@onMouseMoveEvent"===e.eventType){if(this.leftClickDone)return void(this.leftClickDone=!1);l=!0}if(this.leftClickDone=!0,a.picking.activated&&null!=h){var d=a.getMousePosition(h.currentPosition),u={ray:null};a.forceMultiSel||void 0!==o&&o(h.event)||l||(this._dataModelSelection.clear(),this._objectSelection.clear(e));var m,f,p,v=a.computeIntersection(d,a.picking.gpu,a.picking.primitive,!1,u),_=v[0].object;if(_&&_.geometry.length>0){var b=_.geometry[0];if(b.drawingGroups.length>1)a.picking.primitive=!0,v=a.computeIntersection(d,a.picking.gpu,a.picking.primitive,!1,u),a.picking.primitive=!1;else if(1===b.drawingGroups.length){var y=b.drawingGroups[0].getPrimitivesCount();if(y>1){a.picking.primitive=!0,v=a.computeIntersection(d,a.picking.gpu,a.picking.primitive,!1,u),a.picking.primitive=!1;const t=!0;if(0===Object.keys(v[0]).length&&t&&!(v=this._manualPrimPicking(e,h,a,d,u)))return}else 1===y&&(v[0].primitive=v[0].object.geometry[0].drawingGroups[0].primitives[0])}let t=_.geometry[0].meshList[0].getNode();if(t.name.startsWith("textNode_")){let e=t.name.split("textNode_")[1],i=t.parents[0].parents[0].children[0];if(i.mesh3js)_=i.mesh3js,v[0].primitive=i.mesh3js.geometry[0].drawingGroups[0].primitives.find(t=>t.cgmId.toString()===e).internalNode.sgNode;else{_=i.children[0].mesh3js,v[0].primitive=_.geometry[0].drawingGroups[0].primitives[0].internalNode.sgNode;let t=_.userData.instanceIds.findIndex(t=>t.toString()===e);v[0].instanceId=_.instanceAttribArrays.instanceId.array[t]}v[0].object=_}}if(v.length){if(m=0,v.length>1&&(m=this.getClosestObject(v)),void 0===v[m].object||null===v[m].object||"XCitySlabCube"===v[m].object.name||"XCityInfinitePlane"===v[m].object.name)return v[m].path=null,void this._emptyPick(e);if(v[m].primitive&&v[m].object._occurrence){if(v[m].primitive.userData)return p=v[m].primitive.userData,this._launch(t,p,e.from[0],e),p;var w;for(v[m].path=new r,v[m].path.setFromOccurrence(v[m].object._occurrence,THREEDS.SubElement.getFromSGNode(v[m].primitive)),void 0!==v[m].instanceId&&(v[m].path.instanceId=v[m].instanceId),f=0;f<v[m].path.externalPath.length&&!w;++f)v[m].path.externalPath[f].userData instanceof s&&(w=v[m].path.externalPath[f].userData);if(w){if(!w.get("selectable"))return v[m].path=null,void this._emptyPick(e);if(l&&!w.get("hoverable"))return v[m].path=null,void this._emptyPick(e);var P;if(!w.get("Content").isLayer&&!w.get("Content")._factory)return v[m].instanceId&&(w.get("Content")._node.instanceId=v[m].instanceId),this._launch(t,w,e.from[0],e),w;if("BuildingSet"===(P=w.get("Content")).metaData.className&&(p=w),P){var S=P.id,x=v[m].path.getLastElement(!0);if(x instanceof i){x.show();var C=v[m].primitive.getCgmId();if(void 0!==v[m].instanceId&&(C=v[m].object.userData.cgmIds[(v[m].instanceId-5)/5]),w.findChildrenByName&&(p=w.findChildrenByName(C,!0)[0]),void 0===p&&(void 0===(p=this._urban._dataModelPrivate.findChildrenByName(C,!0)[0])||p.getContent().get("dataSourceId")!==S)){var M;if(p=new n({name:C}),void 0!==x.clusterInfo)if(x.clusterInfo.isLeaf){M=P.createPrimitive(C,v[m].instanceId);for(var D=[],T=0;T<M._subMeshes.length;++T)M._subMeshes[T].mesh.clusterInfo&&M._subMeshes[T].mesh.clusterInfo.isLeaf&&D.push(M._subMeshes[T]);M._subMeshes=D}else M=P.createCluster(C,v[m].instanceId,x.clusterInfo);else M=P.createPrimitive(C,v[m].instanceId);p.set("Content",M),p.create(P.getRoot()),p.temporary=!0,p.isIndexablePrimitive()?p.getContent()._layer.getItemParent().addChild(p):this._urban._dataModelPrivate.addChild(p)}if(p&&p.getContent()._layer instanceof g&&P.createPrimitive(C,v[m].instanceId),void 0!==v[m].instanceId){p.get("Content")._attributes.instanceId=v[m].instanceId;var V=p.get("Content")._subMeshes;for(f=V.length-1;f>=0;--f)V[f].mesh.instanceId=v[m].instanceId}return this._launch(t,p,e.from[0],e),p}}}else if("terrainGenericMesh"===v[m].primitive.cgmId)return v[m].path=null,void this._emptyPick(e)}else if(v[m].object&&v[m].object.pickable)for(v[m].path=new r,v[m].path.setFromOccurrence(v[m].object._occurrence),f=0;f<v[m].path.externalPath.length;++f)if(v[m].path.externalPath[f].userData instanceof s)return p=v[m].path.externalPath[f].userData,this._launch(t,p,e.from[0],e),p}return this._dataModelSelection.clearHover(),c.is(v[m])&&c.is(v[m].object)?this._launch(t,v[m],e.from[0],e):this._emptyPick(e),v[m]}}}},_hovering:function(t,e){var o=this._renderer.webGLV6Viewer,a=e.from&&e.from.length?e.from[0]:null;if(!this._isNotFromCityViewer(a)){var h,l,d,u=o.getMousePosition(a.currentPosition),c={ray:null},g=o.computeIntersection(u,o.pPicking.gpu,o.pPicking.primitive,!1,c),m=g[0].object;if(m&&m.geometry.length>0){var f=m.geometry[0];if(f.drawingGroups.length>1)o.picking.primitive=!0,g=o.computeIntersection(u,o.picking.gpu,o.picking.primitive,!1,c),o.picking.primitive=!1;else if(1===f.drawingGroups.length){var p=f.drawingGroups[0].primitives;p.length>1?(o.picking.primitive=!0,g=o.computeIntersection(u,o.picking.gpu,o.picking.primitive,!1,c),o.picking.primitive=!1):1===p.length&&(g[0].primitive=g[0].object.geometry[0].drawingGroups[0].primitives[0])}}if(g.length)if(g[h=0].primitive&&g[h].object._occurrence){if(g[h].primitive.userData)return d=g[h].primitive.userData,this._launch(t,d,e.from[0],e),d;var v;for(g[h].path=new r,g[h].path.setFromOccurrence(g[h].object._occurrence,THREEDS.SubElement.getFromSGNode(g[h].primitive)),void 0!==g[h].instanceId&&(g[h].path.instanceId=g[h].instanceId),l=0;l<g[h].path.externalPath.length&&!v;++l)g[h].path.externalPath[l].userData instanceof s&&(v=g[h].path.externalPath[l].userData);if(v){if(!v.get("hoverable"))return this._dataModelSelection.clearHover(),g[h].path=null,void this._emptyHover(e);var _;if(!v.get("Content").isLayer)return this._launch(t,v,e.from[0],e),v;if(_=v.get("Content")){var b=_.id,y=g[h].path.getLastElement(!0);if(y instanceof i){y.show();var w=g[h].primitive.cgmId;if(void 0!==g[h].instanceId&&(w=g[h].object.userData.cgmIds[(g[h].instanceId-5)/5]),void 0===(d=this._urban.getLayerRoot().findChildById(w,!0))&&(void 0===(d=this._urban._dataModelPrivate.findChildById(w,!0))||d.getContent().get("dataSourceId")!==b)){d=new n({name:v.get("name")+"_"+w,id:w,hoverable:!0});var P=_.createPrimitive(w);if(d.set("Content",P),d.create(_.getRoot()),void 0!==g[h].instanceId){var S=d.get("Content")._subMeshes;for(l=S.length-1;l>=0;--l)S[l].mesh.instanceId=g[h].instanceId}this._urban._dataModelPrivate.addChild(d)}return this._launch(t,d,e.from[0],e),d}}}}else if(g[h].object&&g[h].object.pickable)for(g[h].path=new r,g[h].path.setFromOccurrence(g[h].object._occurrence),l=0;l<g[h].path.externalPath.length;++l)if(g[h].path.externalPath[l].userData instanceof s)return d=g[h].path.externalPath[l].userData,this._launch(t,d,e.from[0],e),d;this._dataModelSelection.clearHover(),g[h].path=null,this._emptyHover(e)}},clearAllSelection:function(t){this._dataModelSelection.clear(),this._objectSelection.clear(t)}})}),define("DS/UrbanFeature/SimplePointOfInterest3D",["DS/XCityModel/Location","DS/XCityModel/Item","DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PointOfInterest3DSet","DS/XCityGeometry/PatchVectorFactoryPointOfInterest3D","DS/XCityModel/LayerVectorPrimitive","DS/XCityModel/LayerVectorCluster","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityTools/Debug","DS/XCityRendering/RenderingHandlerPOI3D","DS/XCityRendering/RenderingHandlerPOI3DBillboard","DS/xCityBasicUtils/Utils","DS/UrbanTool/Utils","DS/XCityTools/EventDispatcher","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/Vector","DS/XCityTools/RTree","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Disposer","DS/XCityTools/Downloader","DS/XCityTools/Geocoder","DS/UrbanFeature/Coordinate"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g,m,f,p,v,_,b,y,w,P,S){"use strict";var x=t.extend({defaults:{url:"",geojson:"",type:"json",styleClass:"",shapeType:"sphere",nbVertices:15,shadingMode:"smooth",_renderMode:"occluded",renderType:"icon",opacityFactor:.3,altitude:0,height:10,switchDistance:500,samplingFactor:1,renderAnchor:!0,anchorLineWidth:1,scale:8,orientation:0,renderID:"",Rendering:null,nameAttribute:"NAME",stridAttribute:"STRID",styleClassAttribute:"STYLECLASS",altitudeAttribute:"ALTITUDE",heightAttribute:"HEIGHT",orientationAttribute:"ORIENTATION",rtreeMin:5,rtreeMax:10,rtreeCoverageFactor:2,magnitude:null,Coordinate:null},metaData:{type:"Location",className:"SimplePointOfInterest3D"},loaderJSON:{geojson:"loadJSONObject"},setup:function(){this._parent(),this._poi=void 0,this._scaleZ=!0,this._node=new a,this._node.name="poi3DSetFeature",this._node.hwInstancing=!0,this.addEvent("onChange:Coordinate",this._updateCoordinate,this)},destroy:function(t){t.getNode3D().remove(this._node),this._parent(t)},getMesh:function(){return new a},create:function(t){if(!this._parent(t))return m.publish(m.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;t.getNode3D().add(this._node),this.urban=t._urban,this._updateCoordinate();var e={nameAttribute:this.get("nameAttribute"),stridAttribute:this.get("stridAttribute"),styleClassAttribute:this.get("styleClassAttribute"),altitudeAttribute:this.get("altitudeAttribute"),heightAttribute:this.get("heightAttribute"),orientationAttribute:this.get("orientationAttribute"),scale:this.get("scale"),shapeType:this.get("shapeType"),shadingMode:this.get("shadingMode"),renderType:this.get("renderType"),renderMode:this.get("renderMode"),samplingFactor:this.get("samplingFactor"),opacityFactor:this.get("opacityFactor"),switchDistance:this.get("switchDistance"),renderAnchor:this.get("renderAnchor"),anchorLineWidth:this.get("anchorLineWidth"),nbVertices:this.get("nbVertices"),alwaysDisplayText:this.get("alwaysDisplayText")};this._myFactory=new s(this.urban,e),this._myFactory.eventOnVisibilityParent=!0,this._myFactory.rdblink=!1,this.renderingProfileManager=this.urban.getRenderingProfileManager(),this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this._rendering=this._myFactory._rendering,this.renderingProfileManager.initRendering(this);var n=this.get("scale");"number"==typeof n&&(n=new i.Vector3(n,n,n));var r=function(t,e){if(!1!==e){var n,s,r,o=this.get("type");if("json"===o?n=new f:"gml"===o?n=new VectorLoaderGML:"enovia"===o&&(n=new VectorLoaderEnovia(urban)),void 0===this.geojson?(s=n.loadDataSource(t),r=JSON.parse(t),this.set("geojson",r)):(s=n.loadDataSourceFromObject("string"==typeof t?JSON.parse(t):t),this.geojson=void 0,r="string"==typeof t?JSON.parse(t):t,this.set("geojson",t)),0!==(a=s.count)){var a=s.count,l=new p.Feature;this.clusteringMode=!1;for(var d={tile:{LOD:0,I:0,J:0},infos:{}},u=[],g=0;g<a;++g){var v;s.getNextFeature(l),!r.crs||r.crs&&"WGS84"!==r.crs.properties.name?v={x:l.geometry.x,y:l.geometry.y}:(v=P.proj(l.geometry,"WGS84",this.urban.baseProjection),l.geometry.x=v.x,l.geometry.y=v.y);var _,b,y={strid:l.getAttribute(this._myFactory.stridAttribute),tile:{LOD:0,I:0,J:0},posSize:{center:new i.Vector3,altitude:0,height:0,width:0,length:0},userData:{}};for(b=(_=l.getAttributeKeys()).length;b--;)y.userData[_[b]]=l.getAttribute(_[b]);this.userData=y.userData,u.push(y),d.infos[y.strid]=y,this._myFactory.buildOne(l,d,y)}this._poi=this._myFactory.getData(d),this._node.addChild(this._poi),this._node.userData=this._itemParent,this.primInfos=d.infos,this.registerPrimitive=function(t){if(c.is(this._patch)){var e=this.getRendering();c.is(e)&&(e.isPrimitiveRegistered(t)||e.registerPrimitive(this._patch,t))}}.bind(this),this.registerPrimitives=function(t){var e,i,n=Object.keys(t),s=n.length;for(e=0;e<s;e++)i=n[e],this.registerPrimitive(i)}.bind(this),this._patch={register:function(t,e){e(this.primInfos[t])}.bind(this),unregister:function(t,e){},previewMode:!0,_uidListeners:d.infos};var w=function(t){if(t instanceof h&&!0===t.pickable){t.show();var e=t.getPrimitives();if(t.isInstanceNode3D){var i=t.mesh3js.userData.cgmIds;if(void 0!==i)for(var n=i.length-1;n>=0;--n){var s;(s=d.infos[i[n]])&&(s.geom?s.geom.push({mesh:t,subElement:e[0].sgNode}):s.geom=[{mesh:t,subElement:e[0].sgNode}])}}}}.bind(this);this._poi.traverse(w.bind(this)),this._poi.children[0].children[0].userData={records:u},this._setVisible(this._itemParent),m.publish(m.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})}else m.publish(m.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()})}else m.publish(m.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()})}.bind(this),o=function(){if(this._myFactory.isReady&&this._myFactory.isReady()){var t=this.get("url");if(c.is(t)&&""!==t)g.download(void 0,this.urban,r,t);else{var e=this.get("geojson");c.is(e)&&(this.geojson=!0,r(this.get("geojson"),!0))}}else m.subscribeTo("/3DEXPERIENCity/onPostUpdate",o,!0)}.bind(this);return o(),!0},getRendering:function(){return this._rendering},redraw:function(){var t=this.getRendering();c.is(t)&&(t._needRebuild&&this._node.children.length>0&&(this._node.removeChildren(),this.create(this.getRoot())),t.applyRendering(this._poi),t._needRebuild=!1)},setItemParent:function(t){this._itemParent&&(this._itemParent.removeEvent("onChange:name",this._updateName),this._itemParent.removeEvent("onChange:visible",this._setVisible)),this._itemParent=t,t&&(this._itemParent.addEvent("onChange:name",this._updateName,this),this._itemParent.addEvent("onChange:visible",this._setVisible,this))},_updatePosition:function(){this._parent()},_updateName:function(){},_setVisible:function(t){var e=!!t.get("visible");this._poi&&(e?this._node.addChild(this._poi):this._node.removeChild(this._poi))},_select:function(t){var e;if(this._poi)if(t.get("selected")){var s=t.getContent()._node.instanceId,r=t.getContent()._node.children[0].children[0].children[0].mesh3js.userData.cgmIds[(s-5)/5],o=this.bboxes[r];new i.MeshLambertMaterial({color:16777215,side:i.DoubleSide}).force=!0;var h=o.min,l=o.max,d=new i.Vector3;d.subVectors(l,h),d.add(l);var u=b.createRectangleNode({width:l.x-h.x,height:l.y-h.y,fill:!0,color:new _.Color(.5,.2,.5,1)}),c=new a;c.addChild(u),c.setMatrix((new i.Matrix4).setPosition(h)),c.setPickable(_.NOPICKABLE),c.isAreaCluster=!0,this._node.addChild(c),this._bboxNode=c;var g={styleClass:this.get("styleClass"),pClass:"poiText",samplingFactor:this.get("samplingFactor")};(e=n.generateTextNode(this.urban,this._itemParent.get("name"),g))._excludeFromCSO=!0,e._excludeFromHSO=!0,e._excludeFromHL=!0,e._excludeFromPSO=!0,e._excludeFromPreHL=!0;var m=t.getContent().get("position");e.setMatrix((new i.Matrix4).translate(new i.Vector3(m.x,m.y,m.z))),this._node.addChild(e)}else(e=this._node.getChildByName("text"))&&this._node.removeChild(e),this._node.removeChild(this._bboxNode)},get:function(t){var e,i,n=this.getRendering();return this.renderingProfileManager&&c.is(n)&&n.hasAttribute(t)?(i=this.getMaterial(),c.is(i)&&(e=i[t])):e=this._parent(t),e},set:function(t,e){var i={},n=this.getRendering();this.renderingProfileManager&&c.is(n)&&n.hasAttribute(t)?(i[t]=e,this.setMaterial(i)):this._parent(t,e)},setMaterial:function(t){return this.renderingProfileManager.addRendering(this.parentFeatureID,t),this},getMaterial:function(){var t=this.getRendering();return c.is(t)?t.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},getBoundingSphere:function(){if(this._localPosition&&this._node){if(c.is(this._myFactory)&&c.is(this._myFactory.maxMinMax)){var t=this._myFactory.maxMinMax,e=this._node.bSphere.center,n=Math.sqrt(Math.pow(t.maxX-t.minX,2)+Math.pow(t.maxY-t.minY,2)+Math.pow(t.maxZ-t.minZ,2))/2;return new i.Sphere(e,n)}return this._node.getBoundingSphere()}},createPrimitive:function(t,e){var i;this._myFactory&&this._myFactory.getGeoJSON&&(i=this._myFactory.getGeoJSON(t));var n=new r({strid:t,geojson:i,instanceId:e});return n.setLayerVector(this),n.create(this.getRoot()),n.addSubElements(this.primInfos[t]),n},createCluster:function(t,e,n){var s;this._myFactory&&this._myFactory.getGeoJSON&&(s=this._myFactory.getGeoJSON(t));var r=new o({strid:t,geojson:s,instanceId:e,clusterInfo:n});r.setLayerVector(this),r._localPosition=new i.Vector3,r.create(this.getRoot());var a=this._node.children[0].children[0].children[0];return r._subMeshes.push({mesh:a,subElement:a.getPrimitives()}),r._subMeshes.instanceId=e,r},register:function(t){},unregister:function(t){},redrawPrimitive:function(t){if(c.is(this._patch)){var e=this.getRendering();c.is(e)&&(e.isPrimitiveRegistered(t)?e._renderprimitive(t):this.registerPrimitive(t))}},registerPrimitive:function(t){if(c.is(this._patch)){var e=this.getRendering();c.is(e)&&(e.isPrimitiveRegistered(t)||e.registerPrimitive(this._patch,t))}},addUserDataProperty:function(t,e,i){if(c.is(t)){var n=this.get("geojson"),s=n.features[0];if(c.is(i))for(var r=0;r<n.features.length;r++){var o=n.features[r];if(o&&o.properties&&o.properties.STRID===i){s=o;break}}s.properties||(s.properties={}),s.properties[t]=e;var a=this.getUserData();return a||(a={},this.userData=a),a[t]=e,!0}return!1},removeUserDataProperty:function(t,e){if(c.is(t)){var i=this.get("geojson"),n=i.features[0];if(c.is(e))for(var s=0;s<i.features.length;s++){var r=i.features[s];if(r&&r.properties&&r.properties.STRID===e){n=r;break}}c.is(n.properties[t])&&delete n.properties[t];var o=this.getUserData();return c.is(o[t])&&delete o[t],!0}return!1},getTransformedGeoJSON:function(){var t=this.get("Coordinate"),e=this.get("geojson");if(!c.is(t))return e;var n=t.getMatrix();if(n.isIdentity())return e;var s,r=e.features[0].geometry.coordinates,o=new i.Vector3(r[0],r[1],r[2]);o.applyMatrix4(n),s=o.toArray();var a=c.clone(e);return a.features[0].geometry.coordinates=s,a},getBaseAltitude:function(){var t=0,e=this.get("Coordinate");e&&(t+=e.get("position").z);var i=this.get("geojson");return c.is(i)?t+=i.features[0].geometry.coordinates[2]:t},_updateCoordinate:function(){var t=this.previous("Coordinate");t&&t.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")?(this.get("Coordinate").setItemParent(this),this._updateMatrix(this.get("Coordinate")._matrix),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this)):this._updateMatrix()},_updateMatrix:function(t){this._node.setMatrix(t)},toJSON:function(){var t=this._parent(),e=this.get("Coordinate");if(c.is(e)){var i=this.getTransformedGeoJSON();t.geojson=i,t.Coordinate=(new S).toJSON()}return t}});return e.ObjectContructor.SimplePointOfInterest3D=x}),define("DS/UrbanFeature/BuildingSet",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityModel/Item","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/VectorLoaderEnovia","DS/XCityLayer/Vector","DS/UrbanTool/Utils","DS/XCityGeometry/PatchVectorFactoryBuilding","DS/XCityModel/LayerVectorPrimitive","DS/XCityTools/EventDispatcher","DS/XCityTools/Geocoder","DS/UrbanFeature/Coordinate","DS/XCityTools/Disposer"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g){"use strict";var m,f=["floorsNumber","HEIGHT","ALTITUDE","floorHeight","groundFloorHeight","roofShape","ROOFHGT","ROOFANGLE"],p={floors:"FLOORS",height:"HEIGHT",altitude:"ALTITUDE",floorHeight:"FLOORHEIGHT",groundFloorHeight:"GROUNDFLOORHEIGHT",roofShape:"ROOFSHAPE",roofHeight:"ROOFHGT",roofAngle:"ROOFANGLE"},v=n.extend({defaults:{url:"",geojson:null,type:"json",renderMode:"occluded",Coordinate:null,renderID:"",Rendering:null,stridAttribute:"STRID",objectId:"",asynchronous:!0,lines:!0,Floor:!0,Roof:!0,Dimensions:!0,floors:1,floorHeight:2.7,groundFloorHeight:2.7,roofHeight:2,roofAngle:45,roofShape:"MANSARD",length:5,width:10,rectangleBase:null},metaData:{type:"Geometry",className:"BuildingSet"},loaderJSON:{geojson:"loadJSONObject"},setup:function(){this._parent(),this._node=new e,this._node.name="BuildingSetFeature",this.loaderJSON||(this.loaderJSON={}),this.heightMatrix=new t.Matrix4,this.addEvent("onChange:Coordinate",this._updateCoordinate,this),this.addEvent("onChange:geojson",this._updateValues,this)},destroy:function(t){t.getNode3D().remove(this._node),g.disposeV6(this._node),this._parent(t)},getNode3D:function(){return this._node},create:function(t,e){if(this.urban=t._urban,!this._parent(t))return d.publish(d.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this.renderingProfileManager=this.urban.getRenderingProfileManager(),t.getNode3D().add(this._node),this._node.userData=this._itemParent,this._itemParentVisible(this._itemParent),this._updateCoordinate();var i={stridAttribute:this.get("stridAttribute")};if(this._factory=new h(this.urban,i),a.is(this._rendering)&&(this._factory._rendering=this._rendering),this.nbPolygon=0,this.nbMultiPolygon=0,this._rendering=this._factory._rendering,""!==this.get("url")){var n=this.get("url");a.download(void 0,this.urban,this._createBuildingSet.bind(this),n)}else null!==this.get("geojson")&&(this.geojson=!0,this._createBuildingSet(this.get("geojson"),!0));return!0!==this._renderingInitialized&&(this._renderingInitialized=!0,this.renderingProfileManager.initRendering(this)),!0},_createBuildingSet:function(n,h){if(!1!==h){var l,c,g,m=this.get("type");"json"===m?l=new s:"gml"===m?l=new VectorLoaderGML:"enovia"===m&&(l=new r(urban)),void 0===this.geojson?(c=l.loadDataSource(n),g=JSON.parse(n)):(c=l.loadDataSourceFromObject("string"==typeof n?JSON.parse(n):n),g="string"==typeof n?JSON.parse(n):n);var f=c.count;if(0!==f){for(var p=new o.Feature,v=Math.ceil(f/5e3),_=[],b=0;b<v;++b)_[b]={tile:{LOD:0,I:0,J:0},infos:{},ltileGeoms:{}};var y=[],w=g.crs&&g.crs.properties&&g.crs.properties.name?g.crs.properties.name:"WGS84",P=w.indexOf("EPSG");P>0&&(w=w.slice(P)),w=w.replace("::",":"),this.registerPrimitive=function(t){if(a.is(this._patch)){var e=this.getRendering();a.is(e)&&(e.isPrimitiveRegistered(t)||e.registerPrimitive(this._patch,t))}}.bind(this),this.registerPrimitives=function(t){var e,i,n=Object.keys(t),s=n.length;for(e=0;e<s;e++)i=n[e],this.registerPrimitive(i)}.bind(this);var S=0;this._polygons=new e,this.primInfos={},this._node.addChild(this._polygons),this._node.userData=this._itemParent;var x=function(){var t=S;if(this._polygons.addChild(this._factory.getData(_[t])),Object.assign(this.primInfos,_[t].infos),t===v-1){this._patch={register:function(t,e){e(this.primInfos[t])}.bind(this),unregister:function(t,e){},previewMode:!0,_uidListeners:this.primInfos};var e=function(t){if(t instanceof i&&!0===t.pickable){t.show();var e,n,s,r=t.getPrimitives();if(!1===t.isInstanceNode3D)for(e=0;e<r.length;e++){n=r[e].sgNode;for(var o=0;o<v;++o)(s=_[o].infos[n.getCgmId()])&&(s.geom?s.geom.push({subElement:n,mesh:t}):s.geom=[{subElement:n,mesh:t}])}}}.bind(this);this._polygons.traverse(e.bind(this)),this._polygons.children[0].userData={records:y},this.userData=a.clone(this.userData),d.publish(d.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})}}.bind(this),C=0,M=0,D=function(){for(var e=0,i=!1,n=C;n<f;++n){if(50===e){C=n,d.subscribeTo("/3DEXPERIENCity/onPostUpdate",D,!0);break}n===f-1&&(i=!0),c.getNextFeature(p);var s=p.getGeometry();if(s.type===o.Type.MULTIPOLYGON)if(this.nbMultiPolygon++,w===this.urban.baseProjection);else for(var r=s.geometryList,a=0;a<r.length;++a)for(var h=r[a].geometryList,l=0;l<h.length;++l)for(var g=h[l].vertexList,m=0;m<g.length;++m){var b=g[m],P=u.proj(b,w,this.urban.baseProjection);b.x=P.x,b.y=P.y}else{if(s.type!==o.Type.POLYGON)continue;if(this.nbPolygon++,w===this.urban.baseProjection);else for(r=s.geometryList,a=0;a<r.length;++a)for(g=r[a].vertexList,m=0;m<g.length;++m){b=g[m],P=u.proj(b,w,this.urban.baseProjection);b.x=P.x,b.y=P.y}}var T={strid:p.getAttribute(this._factory.stridAttribute),tile:{LOD:0,I:0,J:0},posSize:{center:new t.Vector3,altitude:0,height:0,width:0,length:0},userData:{}};if(void 0===T.strid&&(T.strid=this.get("id")+"_"+(this.nbPolygon+this.nbMultiPolygon),p.attributes[this._factory.stridAttribute]=T.strid),s){var V,A;for(A=(V=p.getAttributeKeys()).length;A--;)T.userData[V[A]]=p.getAttribute(V[A]);y.push(T);var R=Math.floor(M/5e3);_[R].infos[T.strid]=T;var E=this._rendering.getStrokeHandler();this._rendering.defaultRendering.addOver({stroke:{enable:!0,lineWidth:2,renderMode:"occluded",minWidth:0,maxDist:2500,minDist:300,dynamicUpdate:!0,minOpacity:0},elevationMode:"advanced",elevation:0}),E.defaultRendering.addOver({lineWidth:2,renderMode:"occluded"}),this._factory.buildOne(p,_[R],T),5e3===_[R].nbFeature&&(S=R,d.subscribeTo("/3DEXPERIENCity/onPostUpdate",x,!0))}e++,M++}i&&(S=v-1,this.get("asynchronous")?d.subscribeTo("/3DEXPERIENCity/onPostUpdate",x,!0):x())}.bind(this);this.get("asynchronous")?d.subscribeTo("/3DEXPERIENCity/onPostUpdate",D,!0):D()}else d.publish(d.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()})}else d.publish(d.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()})},isDataAttribute:function(t){return this.getAttributeListImpactingGeoJSON().indexOf(t)>=0},get:function(t){var e,i,n=this.getRendering();if("length"===t)return this.getLength();if("width"===t)return this.getWidth();if("lines"===t){var s=this.getMaterial();s&&s.stroke&&(e=s.stroke.enable)}else if(this.isDataAttribute(t)){var r=this.getUserData();a.is(r)&&(a.is(m)||(m=a.getBuildingGISPropertiesMap()),e=r[m[t]],"groundFloorHeight"!==t||a.is(e)||(e=this.get("floorHeight")))}else this.renderingProfileManager&&a.is(n)&&n.hasAttribute(t)?(i=this.getMaterial(),a.is(i)&&(e=i[t])):e=this._parent(t);return e},set:function(t,e){var i={},n=this.getRendering();return"length"===t?e===this.get("length")?this._parent(t,e):this.setLength(e):"width"===t?e===this.get("width")?this._parent(t,e):this.setWidth(e):void("lines"===t?(i.stroke={enable:e},this.setMaterial(i),this._parent(t,e)):this.isDataAttribute(t)?a.is(e)&&(a.is(m)||(m=a.getBuildingGISPropertiesMap()),this.addUserDataProperty(m[t],e),this._parent(t,e)):this.renderingProfileManager&&a.is(n)&&n.hasAttribute(t)?(i[t]=e,this.setMaterial(i)):this._parent(t,e))},setMaterial:function(t){return a.is(this.renderingProfileManager)&&this.renderingProfileManager.addRendering(this.parentFeatureID,t),this},getMaterial:function(){var t=this.getRendering();return a.is(t)?t.getCompleteMaterialInfo():a.is(this.renderingProfileManager)?this.renderingProfileManager.getRenderingData(this.parentFeatureID):null},getLocalPosition:function(){var t=this._node.getBoundingSphere().center;return this.get("Coordinate")&&t.add(this.get("Coordinate").getLocalPosition()),t},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},getBoundingSphere:function(){if(this._node){if(this._localPosition&&a.is(this._factory)&&a.is(this._factory.rtrees)){var e={minX:this._factory.rtrees[0]._root.boundingBox.min.x,minY:this._factory.rtrees[0]._root.boundingBox.min.y,minZ:this._factory.rtrees[0]._root.boundingBox.min.z,maxX:this._factory.rtrees[0]._root.boundingBox.max.x,maxY:this._factory.rtrees[0]._root.boundingBox.max.y,maxZ:this._factory.rtrees[0]._root.boundingBox.max.z},i=this._localPosition;i.z=this._node.bSphere.center.z;var n=Math.sqrt(Math.pow(e.maxX-e.minX,2)+Math.pow(e.maxY-e.minY,2)+Math.pow(e.maxZ-e.minZ,2))/2;return new t.Sphere(i,n)}return this._node.getBoundingSphere()}},_updateCoordinate:function(){var t=this.previous("Coordinate");t&&t.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")?(this.get("Coordinate").setItemParent(this),this._updateMatrix(this.get("Coordinate")._matrix),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this)):this._updateMatrix()},_updateDimensions:function(){var t=this.getLength(),e=this.getWidth();this.set("length",t),this.set("width",e)},_updateValues:function(){var t,e,i=this.get("geojson"),n=i.features[0].properties,s=a.clone(n);a.is(m)||(m=a.getBuildingGISPropertiesMap());for(var r=this.toJSON(),o={},h=Object.keys(m),l=0;l<h.length;l++){t=h[l];var d=m[t];(e=n[d])||(e=n[d=p[t]])&&(i.features[0].properties[m[t]]=e);var u=r[t];a.is(e)&&u!==e&&(o[t]=e,s[d]=e)}var c=n,g=m.floors,f=m.height,v=m.floorHeight,_=m.groundFloorHeight,b=c[f];if(b&&b>0){var y=c[g],w=c[v],P=w;c[_]&&(P=c[_]),w||(w=y?b/y:2.7),P||(P=w),y||(y=(b-P)/w+1),o.floors=y,s[g]=y,o.floorHeight=w,s[v]=w,o.groundFloorHeight=P,s[_]=P}var S=this.getUserData();S||(S=a.clone(n),this.userData=S),S=Object.assign(s),a.is(S.ROOFANGLE)&&0!==S.ROOFANGLE||(S.ROOFANGLE=this.defaults.roofAngle),a.is(S.roofShape)||(S.roofShape=this.defaults.roofShape),i.features[0].properties=Object.assign(i.features[0].properties,S),this.set("userData",S),this.userData=S,this.set(o),this._updateDimensions(),this.askForRebuild()},_itemParentVisible:function(t){this._created&&this._node.setVisibility(t.get("visible"))},setItemParent:function(t){this._itemParent&&this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._parent(t),this._itemParent&&this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this)},_updateMatrix:function(t){this._node.setMatrix(t)},_setVisible:function(t){var e=!!t.get("visible");this._polygons&&(e?this._node.addChild(this._polygons):this._node.removeChild(this._polygons))},createPrimitive:function(t,e){var i;this._factory&&this._factory.getGeoJSON&&(i=this._factory.getGeoJSON(t));var n=new l({strid:t,geojson:i,instanceId:e});return n.setLayerVector(this),n.create(this.getRoot()),n.addSubElements(this.primInfos[t]),n},register:function(){},unregister:function(){},redrawPrimitive:function(t){if(a.is(this._patch)){var e=this.getRendering();a.is(e)&&(e.isPrimitiveRegistered(t)?e._renderprimitive(t):this.registerPrimitive(t))}},registerPrimitive:function(t){if(a.is(this._patch)){var e=this.getRendering();a.is(e)&&(e.isPrimitiveRegistered(t)||e.registerPrimitive(this._patch,t))}},registerPrimitives:function(t){var e,i,n=Object.keys(t),s=n.length;for(e=0;e<s;e++)i=n[e],this.registerPrimitive(i)},recalculateAttributes:function(t){a.is(m)||(m=a.getBuildingGISPropertiesMap());var e=m.floors,i=m.height,n=m.floorHeight,s=m.groundFloorHeight,r=t[e],o=t[n],h=o;t[s]&&(h=t[s]),a.is(h)&&a.is(r)&&a.is(o)&&(t[i]=h+(r-1)*o)},addUserDataProperty:function(t,e,i){if(a.is(t)){var n=a.clone(this.get("geojson")),s=n.features[0];if(a.is(i))for(var r=0;r<n.features.length;r++){var o=n.features[r];if(o&&o.properties&&o.properties.STRID===i){s=o;break}}s.properties||(s.properties={}),s.properties[t]=e,this.recalculateAttributes(s.properties);var h=this.getUserData();return h||(h=a.clone(s.properties),this.userData=h),h[t]=e,this.recalculateAttributes(h),this.set("userData",h),this.set("geojson",n),this.updateBuildFromAttributes(t),!0}return!1},updateBuildFromAttributes:function(t){this.isGeometryAttribute(t)&&this.askForRebuild()},isGeometryAttribute:function(t){return f.indexOf(t)>=0},removeUserDataProperty:function(t,e){if(a.is(t)){var i=a.clone(this.get("geojson")),n=i.features[0];if(a.is(e))for(var s=0;s<i.features.length;s++){var r=i.features[s];if(r&&r.properties&&r.properties.STRID===e){n=r;break}}a.is(n.properties[t])&&delete n.properties[t],this.recalculateAttributes(n.properties);var o=this.getUserData();return a.is(o[t])&&delete o[t],this.recalculateAttributes(o),this.set("userData",o),this.set("geojson",i),this.updateBuildFromAttributes(t),!0}return!1},redraw:function(){var t=this.getRendering();if(a.is(t)){if(t._needRebuild&&this._node.children.length>0&&(this._node.removeChildren(),this._createBuildingSet(this.get("geojson"),!0)),this._polygons)for(var e=0;e<this._polygons.children.length;++e)t.applyRendering(this._polygons.children[e]);t._needRebuild=!1}},getRendering:function(){return this._rendering},rebuild:function(){if(this.get("id")){var t=this.getRendering();a.is(t)&&(t._needRebuild=!0,this.redraw(),d.unsubscribe(this.rebuildToken),this.rebuildToken=null)}},askForRebuild:function(){a.is(this.rebuildToken)||(this.rebuildToken=d.subscribeTo("/3DEXPERIENCity/onPostUpdate",this.rebuild.bind(this)))},findChildrenByName:function(){return this},isHouse:function(){var t=this.get("rectangleBase");if(!0===t)return!0;if(!1===t)return!1;var e=this.get("geojson");if(e)if(t=!1,5!=e.features[0].geometry.coordinates[0].length)t=!1;else{var i=e.features[0].properties;t=!(!a.is(i.ROOFSHAPE)||"GABLE"!==i.ROOFSHAPE)}return this.set("rectangleBase",t),t},getWidth:function(){if(this.isHouse()){var e=this.get("geojson").features[0].geometry.coordinates[0],i=new t.Vector2(e[0][0],e[0][1]);return new t.Vector2(e[1][0],e[1][1]).clone().sub(i).length()}return null},getLength:function(){if(this.isHouse()){var e=this.get("geojson").features[0].geometry.coordinates[0],i=new t.Vector2(e[0][0],e[0][1]);return new t.Vector2(e[3][0],e[3][1]).clone().sub(i).length()}return null},setWidth:function(e){if(this.isHouse()&&a.is(e)){var i=this.get("geojson"),n=i.features[0].geometry.coordinates[0],s=new t.Vector2(n[0][0],n[0][1]),r=new t.Vector2(n[1][0],n[1][1]),o=new t.Vector2(n[2][0],n[2][1]),h=new t.Vector2(n[3][0],n[3][1]),l=r.clone().sub(s);l.setLength(e),l.add(s);var d=o.clone().sub(h);return d.setLength(e),d.add(h),i.features[0].geometry.coordinates[0][1][0]=l.x,i.features[0].geometry.coordinates[0][1][1]=l.y,i.features[0].geometry.coordinates[0][2][0]=d.x,i.features[0].geometry.coordinates[0][2][1]=d.y,i.features[0].geometry.coordinates[0][4]=i.features[0].geometry.coordinates[0][0],this.set("geojson",i),this.rebuild(),!0}return!1},setLength:function(e){if(this.isHouse()&&a.is(e)){var i=this.get("geojson"),n=i.features[0].geometry.coordinates[0],s=new t.Vector2(n[0][0],n[0][1]),r=new t.Vector2(n[1][0],n[1][1]),o=new t.Vector2(n[2][0],n[2][1]),h=new t.Vector2(n[3][0],n[3][1]).clone().sub(s);h.setLength(e),h.add(s);var l=o.clone().sub(r);l.setLength(e),l.add(r),i.features[0].geometry.coordinates[0][2][0]=l.x,i.features[0].geometry.coordinates[0][2][1]=l.y,i.features[0].geometry.coordinates[0][3][0]=h.x,i.features[0].geometry.coordinates[0][3][1]=h.y,i.features[0].geometry.coordinates[0][4]=i.features[0].geometry.coordinates[0][0],this.set("geojson",i),this.rebuild()}},getTransformedGeoJSON:function(){var e=this.get("Coordinate"),i=a.clone(this.get("geojson"));if(!a.is(e))return i;var n=e.getMatrix();if(n.isIdentity())return i;for(var s=i.features[0].geometry.coordinates[0],r=[],o=0;o<s.length;o++){var h=new t.Vector3(s[o][0],s[o][1],s[o][2]);h.applyMatrix4(n),r.push(h.toArray())}var l=i;return l.features[0].geometry.coordinates[0]=r,l},toJSON:function(){var t=this._parent(),e=this.get("Coordinate");if(a.is(e)){var i=this.getTransformedGeoJSON();t.geojson=i,t.Coordinate=(new c).toJSON()}return t},getConstructionAttributes:function(){return f},getAttributeListImpactingGeoJSON:function(){return a.is(m)||(m=a.getBuildingGISPropertiesMap()),Object.keys(m)},getBaseAltitude:function(){var t=this.get("Coordinate").get("position").z,e=this.get("geojson");return a.is(e)?t+=e.features[0].geometry.coordinates[0][0][2]:t}});return n.ObjectContructor.BuildingSet=v}),define("DS/UrbanFeature/PointCloud",["DS/XCityModel/Item","DS/UrbanFeature/Geometry","DS/XCityLoaders/ReloadSceneCommand"],function(t,e,i){"use strict";var n=e.extend({metaData:{type:"PointCloud",className:"PointCloud"},init:function(t){this._parent(t)},destroy:function(){var t=new i;t.begin(),t.setCallbackOnfinish(this._parent().bind(this))}});return t.ObjectContructor.PointCloud=n}),define("DS/UrbanCore/PerformanceProfileManager",["DS/XCityCore/ProfileManager","DS/UrbanCore/PerformanceProfile","DS/XCityTools/EventDispatcher","DS/XCityCore/Profile","DS/xCityBasicUtils/Utils","DS/Core/Events"],function(t,e,i,n,s,r){"use strict";return t.extend({init:function(t){this._parent(t,"performance"),this.defaultNewProfile="performanceProfile",r.subscribe({event:"EVT_ACTIONBAR_READY"},function(){console.log("PROUT"),i.publish(i.eventsList.performanceProfile,xCity.performanceProfile)}),this.acceptedValues={quadsPerLevel:{min:6,max:40,defaultValue:6,callback:this.setQuadsPerLevel},maxtextureLOD:{min:-1,max:10,defaultValue:10,callback:this.setMaxTextureLOD},textureLODOffset:{min:-99,max:99,defaultValue:0,callback:this.setTextureLODOffset},textureLODDistanceFactor:{min:1,max:99,defaultValue:1,callback:this.setTextureLODDistanceFactor},maxPointPreview:{min:1e4,max:1e6,defaultValue:4e5,callback:this.setMaxPointPreview},maxLinePreview:{min:1e4,max:5e5,defaultValue:2e5,callback:this.setMaxLinePreview},maxPolygonPreview:{min:1e4,max:2e5,defaultValue:1e5,callback:this.setMaxPolygonPreview},forceWorkerUsageForPreview:{min:0,max:1,defaultValue:0,callback:this.initWebWorker}},this.initialprofile()},setDefaultProfile:function(){this.setProfile(this.initialProfile)},_initEnvironment:function(){var t={name:this.initialProfile,disabledEffects:[]};this._parseOneProfile(t)},initialprofile:function(){this.initialProfile="defaultProfile",s.is(this.getProfile(this.initialProfile))||(this.createProfile(this.initialProfile),this.dispatchAddedEvent(this.initialProfile))},removeProfile:function(t,e,i){t!==this.initialProfile&&this._parent(t,e,i)},_parseOneProfile:function(t,e){var i=!1;s.is(this.getProfile(t.name))||(this.createProfile(t.name),i=!0);var n=[];s.is(t.disabledEffects)&&(n=t.disabledEffects.slice());for(var r in this.addProfile(t.name,function(t,i){s.is(e)||(e=t.getEnvironment()),s.is(e)&&e.disableEffects(i)},n,"disableEffects"),this.acceptedValues){s.is(t[r])||(t[r]=this.acceptedValues[r].defaultValue);var o=Math.min(Math.max(t[r],this.acceptedValues[r].min),this.acceptedValues[r].max);this.addProfile(t.name,this.acceptedValues[r].callback,o,r)}i&&this.dispatchAddedEvent(t.name)},setQuadsPerLevel:function(t,e){s.is(t.USR.vqtPo._qt)&&t.USR.vqtPo._qt.setNbQuadsPerLevelArea(e)},setMaxTextureLOD:function(t,e){},setTextureLODOffset:function(t,e){},setTextureLODDistanceFactor:function(t,e){},initWebWorker:function(t,e){t._initWebWorkers(e)},setMaxPointPreview:function(t,e){},setMaxLinePreview:function(t,e){},setMaxPolygonPreview:function(t,e){},setProfile:function(t,e){this._parent(t,e)&&i.publish(i.eventsList.performanceProfile,t)},_createProfile:function(t,i){return new e(t,i)},dispatchAddedEvent:function(t){i.publish(i.eventsList.performanceProfileAdded,t)},dispatchRemovedEvent:function(t){i.publish(i.eventsList.performanceProfileRemoved,t)},getValue:function(t){var e,i=this.getCurrentProfile();return s.is(i)&&(e=i.getNode(t)),s.is(e)||(i=this.getDefaultProfile(),s.is(i)&&(e=i.getNode(t))),s.is(e)||(e=this.acceptedValues[t].defaultValue),e},reset:function(){(this._parent(),s.is(this.initialProfile))&&this.getProfile(this.initialProfile).clean()}})}),define("DS/UrbanFeature/Line",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityModel/Item","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/VectorLoaderEnovia","DS/XCityLayer/Vector","DS/UrbanTool/Utils","DS/XCityGeometry/LineBuilder","DS/XCityTools/EventDispatcher","DS/UrbanFeature/Coordinate"],function(t,e,i,n,s,r,o,a,h,l){"use strict";var d=i.extend({defaults:{url:"",geojson:null,Coordinate:null,renderID:"",Rendering:null,stridAttribute:"STRID"},metaData:{type:"Geometry",className:"Line"},loaderJSON:{geojson:"loadJSONObject",animation:"loadJSONObject"},setup:function(){this._parent(),this._node=new e,this._node.name="lineFeature",this.loaderJSON||(this.loaderJSON={}),this.heightMatrix=new t.Matrix4},destroy:function(t){h.unsubscribe(this.builder.tokenUpdateEvent),t.getNode3D().remove(this._node),this._parent(t)},create:function(i){var l,d;if(!this._parent(i))return!1;this.urban=i._urban,this.renderingProfileManager=this.urban.getRenderingProfileManager(),this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this._node.userData=this._itemParent,this._itemParentVisible(this._itemParent),i.getNode3D().add(this._node),this._updateCoordinate(),this.builder=new a(this.urban);var u=function(i,a){if(!1!==a)if(void 0===this.geojson?(d=-1!==i.indexOf("FeatureCollection")?new n:new s,l=d.loadDataSource(i),this.set("geojson",JSON.parse(i))):(d="FeatureCollection"===i.type?new n:new s,l=d.loadDataSourceFromObject(i),this.geojson=void 0,this.set("geojson",i)),0!==l.count){for(var u,c,g=function(t,e,i,n,s){var r=t.getVertices();if(void 0!==r){0===s.x&&0===s.y&&(s.x=Math.round(r[0].x),s.y=Math.round(r[0].y));for(var o=0;o<t.getVertices().length;o++)t.getVertices()[o].z=m(e,t.getVertices()[o]),t.getVertices()[o].x=t.getVertices()[o].x-s.x,t.getVertices()[o].y=t.getVertices()[o].y-s.y;var a=i.getAttribute(n.get("stridAttribute")),h=!1;return void 0===a&&(a=n.get("id"),h=!0),n.builder.buildOne(a,t,n.get("Coordinate"),h,i.attributes)}},m=function(t,e){var i=0;return i=o.is(e.z)&&"geometry"===t.elevationMode?e.z:"advanced"===t.elevationMode||"geometry"===t.elevationMode?t.elevation:this.urban.USR.getGroundHeight(e.x,e.y),t.elevationOffset&&(i+=t.elevationOffset),i},f=new r.Feature,p={},v=new t.Vector2,_=void 0;null!==(f=l.getNextFeature(f));){var b=f.getGeometry();if(b){var y=this.getRendering().getCompleteMaterialInfo(this.get("id"),f.attributes);if(b.type===r.Type.LINESTRING&&void 0!==b.vertexList)u=g(b,y,f,this,v),o.is(p[u.lineId])||(p[u.lineId]=[]),p[u.lineId].push(u),u.isTransparent&&(_=!0);else if(b.type===r.Type.MULTILINESTRING){var w=b.geometryList.length;for(c=0;c<w;c++){u=g(b.geometryList[c],y,f,this,v),o.is(p[u.lineId])||(p[u.lineId]=[]),p[u.lineId].push(u),u.isTransparent&&(_=!0)}}var P=f.getAttributeKeys(),S=P.length;for(S>0&&(void 0===this.userData||null===this.userData)&&(this.userData={});S--;)this.userData[P[S]]=f.getAttribute(P[S])}}var x=new e,C=new t.Vector3(v.x,v.y,0),M=(new t.Matrix4).identity().setPosition(C);x.setMatrix(M),this._node.addChild(x),this.builder.getData(p,x,_),h.publish(h.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})}else h.publish(h.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()});else h.publish(h.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()})}.bind(this);if(""!==this.get("url")){var c=this.get("url");o.download(void 0,this.urban,u,c)}else null!==this.get("geojson")&&(this.geojson=!0,u(this.get("geojson"),!0));this.renderingProfileManager.initRendering(this)},_addListeners:function(){var t=this;a.getSettableAttributes().forEach(function(e){t.addEvent("onChange:"+e,function(){t.setAttribute(e,t.get(e))},t)})},setAttributeGeom:function(t,e){void 0!==this._node&&("renderMode"===t?this.builder.setRenderMode(e):"animation"===t?this.builder.setAnimation(e,this._node.children[0]):"dynamicUpdate"===t&&this.builder.setDynamicUpdate(e),this._node.traverse(function(i){o.is(i.setAttribute)&&i.setAttribute(t,e)}))},setAttribute:function(t,e){var i={};return void 0!==this._node&&(i[t]=e,this.setMaterial(i)),this},setMaterial:function(t){return this.renderingProfileManager.addRendering(this.parentFeatureID,t),this},getMaterial:function(){var t=this.getRendering();return o.is(t)?t.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)},get:function(t){var e,i,n=this.getRendering();return this.renderingProfileManager&&o.is(n)&&n.hasAttribute(t)?(i=this.getMaterial(),o.is(i)&&(e=i[t])):e=this._parent(t),e},getLocalPosition:function(){var t=this._node.getBoundingSphere().center;return this.get("Coordinate")&&t.add(this.get("Coordinate").getCentralTranslation()),t},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},_updateCoordinate:function(){var t=this.previous("Coordinate");t&&t.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")?(this.get("Coordinate").setItemParent(this),this._updateMatrix(this.get("Coordinate")._matrix),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this)):this._updateMatrix()},_itemParentVisible:function(t){this._created&&this._node.setVisibility(t.get("visible"))},setItemParent:function(t){this._itemParent&&this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._parent(t),this._itemParent&&this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this)},_updateMatrix:function(t){this._node.setMatrix(t)},redraw:function(){var t=this.getRendering();this._node.children.length>0&&this._node.children[0].children.length>0&&this._node.traverse(function(e){return!!e.lineBuilder&&(t.applyRendering(e),!0)})},getRendering:function(){return o.is(this.builder)?this.builder._rendering:null},set:function(t,e){var i=this.getRendering();this.renderingProfileManager&&o.is(i)&&i.hasAttribute(t)?(this.setAttribute(t,e),this.getRendering().initMesh(this._node.children[0])):this._parent(t,e)},addUserDataProperty:function(t,e,i){if(o.is(t)){var n=this.get("geojson"),s=n.features[0];if(o.is(i))for(var r=0;r<n.features.length;r++){var a=n.features[r];if(a&&a.properties&&a.properties.STRID===i){s=a;break}}s.properties||(s.properties={}),s.properties[t]=e;var h=this.getUserData();return h||(h={},this.userData=h),h[t]=e,!0}return!1},removeUserDataProperty:function(t,e){if(o.is(t)){var i=this.get("geojson"),n=i.features[0];if(o.is(e))for(var s=0;s<i.features.length;s++){var r=i.features[s];if(r&&r.properties&&r.properties.STRID===e){n=r;break}}o.is(n.properties[t])&&delete n.properties[t];var a=this.getUserData();return o.is(a[t])&&delete a[t],!0}return!1},getTransformedGeoJSON:function(){var e=this.get("Coordinate"),i=this.get("geojson");if(!o.is(e))return i;var n=e.getMatrix();if(n.isIdentity())return i;for(var s=i.features[0].geometry.coordinates,r=[],a=0;a<s.length;a++){var h=new t.Vector3(s[a][0],s[a][1],s[a][2]);h.applyMatrix4(n),r.push(h.toArray())}var l=o.clone(i);return l.features[0].geometry.coordinates=r,l},getBaseAltitude:function(){var t=this.get("Coordinate").get("position").z,e=this.get("geojson");if(!o.is(e))return t;for(var i=e.features[0].geometry.coordinates,n=i[0][2],s=1;s<i.length;s++)n=Math.min(n,i[s][2]);return t+=n},toJSON:function(){var t=this._parent(),e=this.get("Coordinate");if(o.is(e)){var i=this.getTransformedGeoJSON();t.geojson=i,t.Coordinate=new l}return t}});return i.ObjectContructor.Line=d}),define("DS/UrbanCore/SceneRenderer",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/WebGLV6Viewer","DS/Visualization/Node3D","DS/Visualization/Ambience","DS/UrbanCore/Viewpoint","DS/XCityTools/EventDispatcher","DS/XCityRendering/RenderingManager","DS/UrbanCore/PerformanceProfileManager","DS/UrbanCore/UndergroundVisualizer","DS/UrbanManipulator/Manipulator","DS/UrbanManipulator/GroundManipulator","DS/UrbanManipulator/CarManipulator","DS/UrbanManipulator/FixedManipulator","DS/UrbanManipulator/DrawingManipulator","DS/UrbanManipulator/MeasureAltitudeManipulator","DS/UrbanFeature/View3DHighlighter","DS/UrbanFeature/View3DPicker","DS/XCityModel/View3DContextualMenuManager","DS/UrbanCore/RenderPassManager","DS/UrbanTool/MeasureDistance","DS/UrbanTool/SplashScreen","DS/UrbanTool/Recorder","DS/XCityTools/Downloader","DS/XCityTools/Disposer","DS/XCityTools/Debug","DS/XCityCore/VisuQuadTree","DS/XCityCore/VisuQuadTreeSirocco","DS/XCityCore/Terrain","DS/XCityCore/Store","DS/xCityBasicUtils/Utils","DS/UrbanFeature/Coordinate","DS/XCityEffects/AltitudeEffect","DS/XCityEffects/ViewshedEffect","DS/XCityEffects/AtmosphereEffect","DS/Robot/FreeRobot","DS/Plugins/ClearPass","DS/Plugins/RenderPass","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools","DS/UrbanManipulator/CityRobot"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g,m,f,p,v,_,b,y,w,P,S,x,C,M,D,T,V,A,R,E,L,k,I,N,F,U,z,O,H){"use strict";var B,G=function(t,i){this._initialized=!1,this._needRender=!0,this._oldcode=!1,this._allowRendering=!1,this.viewpoint=null,this.webGLV6Viewer=null,this.controls=null,this.fpscounter=0,this.currentfps=0,this.projector=null,this.renderRequestID=void 0,this.workers=!1,this.urban=t,this.div=this.urban.viewerContainer,this.width=window.getComputedStyle(this.div).width.replace("px",""),this.height=window.getComputedStyle(this.div).height.replace("px",""),this.touchDevice=navigator.maxTouchPoints>0,this._profileRendering=new h(this.urban),this._profilePerformance=new l(this.urban),this._recorder=new S(t),this._renderCallback=void 0,this.renderPassManager=null,this.clock=new e.Clock,this._allowRendering=!0,this.forceUpdate=!1,this.timeUpdate=0,this.timeRender=0,this.preciseTimeUpdate=0,this.preciseTimeRender=0,this.timeDelta=0,this.frameId=0,this.ugVisu=void 0,this._pointToProject={},this.featureSelected=[],this.initialRendering=null,this.initialPerformance=null,this.renderingCurrent="",this.performanceCurrent="",this.level=0,this.originalMaxLevel=20,this.lodBiasPointObject=0,this._numQuadPo=2,this.hwInstancing=!0,R.is(i.debugHWI)&&(this.hwInstancing=i.debugHWI),this.scale=1,this.urban.url.updateSlots.push(this.updateUrl.bind(this)),this._periodicTerrainUpdate=-1,this.INTERSECTED=null,this.projector=new e.Projector,this._root=new s,this._root.name="3DEXPERIENCitySceneRoot",this._rootProj=new s,this._rootProj.name="3DEXPERIENCitySceneRootProj",this._root.add(this._rootProj),this._rootProjScaled=new s,this._rootProjScaled.name="3DEXPERIENCitySceneRootProjScaled",this._root.add(this._rootProjScaled),this._rootProjScaledShifted=new s,this._rootProjScaledShifted.name="3DEXPERIENCitySceneRootProjScaledShifted",this._rootProjScaled.add(this._rootProjScaledShifted),this._rootProjShifted=new s,this._rootProj.name="3DEXPERIENCitySceneRootProjShifted",this._rootProj.add(this._rootProjShifted),this._rootShifted=new s,this._rootShifted.name="3DEXPERIENCitySceneRootShifted",this._root.add(this._rootShifted),this._createViewer(i),this._forceViewerParameters(),a.subscribeTo("/VISU/onSceneGraphUpdate",this._forceRender.bind(this)),a.subscribeTo("/xCity/needRender",this._forceRender.bind(this));var n=this.webGLV6Viewer.getWebGLContext().getSupportedExtensions();if(this.hwInstancing){-1!==n.indexOf("ANGLE_instanced_arrays")?console.log("Hardware instancing available: activated for usage."):(console.log("Hardware instancing NOT available: automatic downgrade to non hardware instancing mode."),this.hwInstancing=!1)}n.indexOf("EXT_shader_texture_lod")>=0?(this.webGLV6Viewer.getWebGLContext().getExtension("EXT_shader_texture_lod"),console.log("Texture Lod extension available : activated for usage")):console.log("Texture Lod extension NOT available : texturing might present some artefacts"),this.webGLV6Viewer.setPicking({activated:!0,displayHL:!0,gpu:!0,computeNormalDepth:!0,primitive:!1}),this.webGLV6Viewer.setPrePicking({activated:!0,gpu:!0,primitive:!1,computeNormalDepth:!1}),this.webGLV6Viewer.setManipulators({activated:!1,preActivate:!1}),this.webGLV6Viewer.ambience.setBackGroundMap({texture:z.whiteMap,mapping:new e.LatLongEnvMapping,pngHdr:!1}),this.renderPassManager=new y(this.webGLV6Viewer.renderer.mainComposer);var r=new F("ClearDepthPass");r.defaults.clear=!1,r.defaults.doClearDepth=!0,this.renderPassManager.addPass("ClearDepthPass",r,{post:!0});var d=new U(null,null,void 0,!0,!1,!1,"GenericOverlayPass");d.idString="GenericOverlayPass",this.renderPassManager.addPass("GenericOverlayPass",d,{after:"ClearDepthPass"});var u=new U(null,null,void 0,!0,!0,!1,"GenericOccludedPass");u.idString="GenericOccludedPass",this.renderPassManager.addPass("GenericOccludedPass",u,{before:"ClearDepthPass"}),z.initialize({webglViewer:this.getGLViewer()}),this.viewpoint=new o(this.urban,40,10,1e4,!1),this.viewpoint._setRenderer(this.webGLV6Viewer);var c=20;V.initialize({webglViewer:this.getGLViewer(),renderingProfileManager:this._profileRendering}),this.vqt=new D(this.urban,"DTM",{qtTest:function(){return++c>20&&(c=0,!0)}}),this._rootProjScaled.add(this.vqt._node);var g=10;this.vqtPo=new T(this.urban,"PointObjects",{qtTest:function(){return++g>20&&(g=0,!0)}}),this._rootProjScaledShifted.add(this.vqtPo._node),a.subscribeTo("/3DEXPERIENCity/onConfig",this.vqt.setup.bind(this.vqt)),a.subscribeTo("/3DEXPERIENCity/onConfig",this.vqtPo.setup.bind(this.vqtPo)),a.subscribeTo("/3DEXPERIENCity/onConfig",V.setup.bind(V)),a.subscribeTo("/3DEXPERIENCity/onConfig",this.initScene.bind(this));A.subscribeTimeStampTo("/3DEXPERIENCity/onPreUpdate"),A.subscribeCleanTo("/3DEXPERIENCity/onPostUpdate",function(){return!0});var m=this;a.subscribeTo("/3DEXPERIENCity/onUpdate",this._computeFPS.bind(this)),M.addCallback("Update",function(){return m.timeUpdate}.bind(this)),M.addCallback("Render",function(){return m.timeRender}.bind(this)),M.addCallback("DrawCalls",function(){return m.webGLV6Viewer.getInfos().render.calls}.bind(this)),M.addCallback("Textures",function(){return m.webGLV6Viewer.getInfos().memory.textures}.bind(this)),M.addCallback("Geometries",function(){return m.webGLV6Viewer.getInfos().memory.geometries}.bind(this)),M.addCallback("Time",function(t){return Math.round(1e3*t)}.bind(this)),M.addCallback("Fps",function(){return m.currentfps}.bind(this)),M.addStates("Viewer",this._debugViewer.bind(this)),M.addStates("Quadtree",this._debugQuadTree.bind(this)),M.addStates("Infos",this._infos.bind(this)),M.addStates("Camera",this._debugCamera.bind(this)),M.addStates("Downloader",this._debugDownloader.bind(this)),this.webGLV6Viewer.getWebGLContext().canvas.addEventListener("webglcontextlost",function(t){t.preventDefault(),M.warn("WebGL context lost...\n****************************"),this.releaseGL(t)}.bind(this),!1),window.onbeforeunload=function(t){M.log("###################################################################"),M.log("Page reloading !"),this.releaseGL(t)}.bind(this),this.webGLV6Viewer.canvas.addEventListener("webglcontextrestored",function(t){M.warn("WebGL context Restored...\n****************************")}.bind(this),!1)};return G.prototype={initPart2:function(t){if(null===this.controls){var e=new p(this.urban,this.viewpoint,this.webGLV6Viewer.div);this.manipulators={default:new u(this.urban,this.viewpoint,this.webGLV6Viewer.div),ground:new c(this.urban,this.viewpoint,this.webGLV6Viewer.div),fixed:new m(this.urban,this.viewpoint,this.webGLV6Viewer.div),altitude:e,measureAltitude:e},this.addDrawingManipulator(),this.addDrawingManipulator(new w(this.urban,"distance")),this.addDrawingManipulator(new w(this.urban,"surface")),this.setControl(this.manipulators.default)}else this.controls.object=this.viewpoint.camera,this.viewpoint.control=this.controls;this._modelPicker=new _(this.urban,this.urban.modelSelection),this._modelHightlighter=new v(this,this.urban.modelSelection),this.setRendering(this.initialRendering,!0),this.setPerformance(this.initialPerformance,!0)},addDrawingManipulator:function(t){R.is(this.manipulators)||(this.manipulators={});var e=new f(this.urban,t,this.viewpoint,this.webGLV6Viewer.div),i=e.type;return this.manipulators[i]||(this.manipulators[i]=e),i},initScene:function(){var t=new e.Matrix4;if(t.identity(),t.setPosition(new e.Vector3(-this.urban.shiftedPosition.x,-this.urban.shiftedPosition.y,0)),this._rootProjScaledShifted.setMatrix(t),this._rootProjShifted.setMatrix(t),this.setRendering(this.initialRendering,!0),this.setPerformance(this.initialPerformance,!0),void 0!==this.pov)R.is(this.pov.angle)?this.pov.angle=new e.Vector2(this.pov.angle.x,this.pov.angle.y):R.is(this.pov.rotation)&&(this.pov.angle=new e.Vector2(this.pov.rotation.x,this.pov.rotation.y)),R.is(this.pov.target)?this.pov.target=new e.Vector3(this.pov.target.x,this.pov.target.y,this.pov.target.z):R.is(this.pov.position)&&(this.pov.target=new e.Vector3(this.pov.position.x,this.pov.position.y,this.pov.position.z)),this.viewpoint.set(this.pov);else{var i=0,n=new e.Vector3(0,0,this.urban.slabAltitude);void 0!==this.urban.cropBox?(n.x=this.urban.cropBox.getCenter().x,n.y=this.urban.cropBox.getCenter().y,i=Math.max(this.urban.cropBox.getSize().x,this.urban.cropBox.getSize().y)):(n.x=.5*this.urban.worldSize+this.urban.shiftedPosition.x,n.y=.5*this.urban.worldSize+this.urban.shiftedPosition.y,i=this.urban.worldSize),this.getControl().teleport(n,i,new e.Vector3(0,0,-1))}a.publish("/3DEXPERIENCity/onSceneReady"),this._initialized=!0},setup:function(t){if(void 0!==t.fov&&(this.viewpoint.camera.fov=t.fov),void 0!==t.pov&&(this.pov=t.pov),t.freezeTerrain&&(this.freezeTerrain=!0),this.urban.environment.setup(),void 0!==t.renderProfiles&&this.getProfileRendering().loadProfiles([t.renderProfiles]),void 0!==t.rendering){var e=this._profileRendering.getProfile(t.rendering);R.is(e)||(e=this._profileRendering.createProfile(t.rendering),this._profileRendering.dispatchAddedEvent(t.rendering)),this._profileRendering.setProfile(t.rendering),this.initialRendering=t.rendering}if(void 0!==t.perfProfiles&&this.getProfilePerformance().loadProfiles([t.perfProfiles]),void 0!==t.performance){var i=this._profilePerformance.getProfile(t.performance);R.is(i)||(i=this._profilePerformance.createProfile(t.performance),this._profilePerformance.dispatchAddedEvent(t.performance)),this._profilePerformance.setProfile(t.performance),this.initialPerformance=t.performance}void 0!==t.defaultRenderingProfileName&&(this.getProfileRendering().renameProfile(this.getProfileRendering().sessionProfileName,t.defaultRenderingProfileName),this.getProfileRendering().sessionProfileName=t.defaultRenderingProfileName),void 0!==t.lodBiasPointObject&&(this.lodBiasPointObject=t.lodBiasPointObject),void 0!==t.numQuadPointObject&&(this._numQuadPo=t.numQuadPointObject),void 0!==t.periodicTerrainUpdate&&(this._periodicTerrainUpdate=t.periodicTerrainUpdate,M.warn("Terrain Quadtree update is "+this._periodicTerrainUpdate+" ms.")),void 0!==t.workers&&(this.workers=t.workers),this.initByUrl()},_createViewer:function(t){var e={div:this.div,defaultLights:!1,defaultAnimationLoop:!1,autoUpdateFrustum:!1,antiAliasing:!0,useShadowMap:!1,debugShadowLight:!1,infinitePlane:!1,displayGrid:!1,debugBSphere:!1,debugPrimitiveBSphere:!1,debugRepBBox:!1,debugPicking:!1,visuFaceMaterialsAsPBR:!0};this.webGLV6Viewer=this._getExternalViewer(t),R.is(this.webGLV6Viewer)?R.is(t.debugVisualOdt)&&console.warn("Debug visual Odt mode impossible on external viewer"):(R.is(t.debugVisualOdt)&&(e.debugContext=!1,e.preserveDrawingBuffer=!0,e.ODTMode=!0),this.webGLV6Viewer=new n(e))},_getExternalViewer:function(t){var e=null;return R.is(this.urban.frmWindow)&&R.is(this.urban.frmWindow.getViewer)&&(e=this.urban.frmWindow.getViewer(),window._frm=this.urban.frmWindow),R.is(t)&&t.viewer?e=t.viewer:R.is(t)&&R.is(t.frmWindow)&&R.is(t.frmWindow.getViewer)&&(e=t.frmWindow.getViewer()),e},_forceViewerParameters:function(){this.webGLV6Viewer.setAutoUpdateLights(!1),this.webGLV6Viewer.setRenderMode("@Point",!0),this.webGLV6Viewer.setRenderMode("@Edge",!0),this.webGLV6Viewer.addNode(this._root),this.webGLV6Viewer.displayPoints(!0),this.webGLV6Viewer.setMaterialMode(!0),this.webGLV6Viewer.displayInfinitePlane(!1),this.webGLV6Viewer.setPicking({primitive:!0}),this.webGLV6Viewer.setPrePicking({activated:!1}),this.webGLV6Viewer.setManipulators({activated:!1}),this.webGLV6Viewer.setIntensityCorrection(!0)},reset:function(t){this.forceUpdate=!1,this._allowRendering=!1,this._initialized=!1,this.workers=!1,this.maxLevel=this.originalMaxLevel,this._profileRendering.reset(),this._profilePerformance.reset(),this._profileRendering.initGroundRendering(V),this.viewpoint.reset(),this.getControl()&&"default"!==this.getControl().type&&this.setControl(this.manipulators.default,{noAnimationOnActivation:!0}),this.vqt.reset(),V.reset(),this.vqtPo.reset(),this.lodBiasPointObject=0,this._allowRendering=!0,void 0!==this.ugVisu&&this.ugVisu.reset(),this.ugVisu=void 0},releaseGL:function(t){M.warn("Release context GL..."),M.warn("-------------------------------------------------------"),this.forceUpdate=!1,this._allowRendering=!1,this._initialized=!1,cancelAnimationFrame(this.renderRequestID),this.renderRequestID=void 0,this.urban.modelSelection.clear(),this.urban.modelRoot.clear(),this.urban._dataModelPrivate.clear(),V.reset(),this.vqt.reset(),this.vqt=void 0,this.vqtPo.reset(),this.vqtPo=void 0,C.disposeV6(this._root,!0),this.webGLV6Viewer.dispose(),this._root=void 0,this._rootProjScaled=void 0,this._rootProjScaledShifted=void 0,this.viewpoint=void 0,this.webGLV6Viewer=void 0,this.controls=void 0,this.vectorDataSources=void 0,this._modelPicker=void 0,this._modelHightlighter=void 0,a.publish("/3DEXPERIENCity/webglcontextlost"),M.warn("-------------------------------------------------------")},initByUrl:function(){var t=this.urban.url.getArgument("render");void 0!==t&&this.setRendering(t.value,!0)},updateUrl:function(t){t.setArgument("render",this.renderingCurrent)},renderLoop:function(){var t=this;!function e(){t.renderRequestID=requestAnimationFrame(e),!0===t._allowRendering&&(t._renderCallback?t._renderCallback(this):t.render(),t.frameId++)}()},releaseScene:function(){C.disposeV6(this._root)},render:function(t){a.publish("/3DEXPERIENCity/onPreUpdate");var i,n,s=Date.now(),r=Date.now(),o=this.clock.getDelta();this.timeDelta=o,this.terrainHeight=this.viewpoint.update();var h=this.viewpoint.getCameraNearGroundPoint().clone(),l={x:h.x/this.urban.worldSize,y:h.y/this.urban.worldSize},d=this.viewpoint.getDistanceCameraToNearGroundPoint();if(this.level=this.getLevel(256,this.maxLevel,d),a.publish("/3DEXPERIENCity/onUpdate",{clockDelta:o,camMoved:this.viewpoint.camMoved,animatedTime:this._recorder._capture?this._recorder._animId/this._recorder._videoFrameRate:this.frameId/this._recorder._videoFrameRate}),this._initialized&&!this.urban.lockQuadtree){var u=new e.Vector2(-this.viewpoint.target.x+this.viewpoint.camera.position.x,-this.viewpoint.target.y+this.viewpoint.camera.position.y);Math.atan(u.length()/(this.viewpoint.camera.position.z-this.viewpoint.target.z));this.vqt.update(this.freezeTerrain?0:this.level,l.x,l.y,this.forceUpdate),this.vqt.display(r),this.vqtPo.update(this.level,l.x,l.y,this.forceUpdate),this.vqtPo.display(r),this.forceUpdate=!1}if(!this.viewpoint.camMoved&&!R.is(this._freeRobot)){var c,g,m=Object.keys(this._pointToProject);for(i=0,n=m.length;i<n;i++)g=(c=this._pointToProject[m[i]]).cbPosition(),c.callback(this.getGroundHeight(g.x,g.y));for(var f in this._pointToProject)this._pointToProject.hasOwnProperty(f)&&(g=(c=this._pointToProject[f]).cbPosition(),c.callback(this.getGroundHeight(g.x,g.y)))}a.publish("/3DEXPERIENCity/onPostUpdate"),a.publish("/3DEXPERIENCity/onPreRender");var p=Date.now();this._recorder.check(),void 0!==this.ugVisu&&this.ugVisu.update(),this._needRender&&(this._needRender=!1,this.urban.environment.sun.updateLight(this.urban.date),this.webGLV6Viewer.render()),this.webGLV6Viewer.animate();var v=Date.now();this.preciseTimeUpdate=p-s,this.preciseTimeRender=v-p,this.timeUpdate=Math.round(this.preciseTimeUpdate),this.timeRender=Math.round(this.preciseTimeRender),a.publish("/3DEXPERIENCity/onPostRender"),this._recorder.takeASnap()},getLevel:function(t,e,i){var n=Math.min(this.webGLV6Viewer.SCREEN_WIDTH,this.webGLV6Viewer.SCREEN_HEIGHT),s=Math.round(n/t+.5),r=2*i*Math.tan(.5*this.viewpoint.camera.fov*Math.PI/180)/this.urban.worldSize,o=Math.round(Math.log(s)/Math.log(2))-Math.ceil(Math.log(r)/Math.log(2));return Math.min(e,Math.max(o,0))},getGLViewer:function(){return this.webGLV6Viewer},setPerformance:function(t,e){if(t!==this.performanceCurrent||e)return R.is(t)?(this._profilePerformance.setProfile(t),this.performanceCurrent=t):(this._profilePerformance.setDefaultProfile(),this.performanceCurrent=this._profilePerformance.getCurrentProfileName()),this.forceUpdate=!0,this},setRendering:function(t,e){if(t!==this.renderingCurrent||e)return R.is(t)?(this._profileRendering.setProfile(t),this.renderingCurrent=t):(this._profileRendering.setDefaultProfile(),this.renderingCurrent=this._profileRendering.getCurrentProfileName()),this.forceUpdate=!0,this},_debugCamera:function(t){return this.urban.getControl().getText()},_debugDownloader:function(t){return x._getDownloadLogs()},_addPointToProject:function(t,e,i){this._pointToProject[t]={cbPosition:e,callback:i}},_removePointToProject:function(t){delete this._pointToProject[t]},_updatePointToProject:function(t){},getProfileRendering:function(){return this._profileRendering},getProfilePerformance:function(){return this._profilePerformance},getScene:function(){return this._rootProjScaledShifted},getScale:function(){return this.scale},getViewpoint:function(){return this.viewpoint},getPicker:function(){return this._modelPicker},getGroundHeight:function(t,i){var n=new e.Vector2(t,i);if(!this._initialized||!this.isPointInsideWorld(n))return this.urban.slabAltitude;var s=t-this.urban.shiftedPosition.x,r=i-this.urban.shiftedPosition.y,o=this.vqt.getLoadedQuadAt(s/this.urban.worldSize,r/this.urban.worldSize);return void 0!==o?o.getGroundAltitude(s,r):this.urban.slabAltitude},getGroundColor:function(t,i){if(this._initialized){var n=this.viewpoint.exactPick(new e.Vector2(t,i)),s=n.x-this.urban.shiftedPosition.x,r=n.y-this.urban.shiftedPosition.y,o=this.vqt.getLoadedQuadAt(s/this.urban.worldSize,r/this.urban.worldSize);return void 0!==o?o.getGroundColor(s,r):void 0}},isPointInsideWorld:function(t){var e=void 0===this.urban.cropBox?[0,0]:this.urban.cropBox.getShiftedMin(),i=void 0===this.urban.cropBox?[this.urban.worldSize,this.urban.worldSize]:this.urban.cropBox.getShiftedMax();return t.x=t.x-this.urban.shiftedPosition.x,t.y=t.y-this.urban.shiftedPosition.y,t.x>e[0]&&t.x<i[0]&&t.y>e[1]&&t.y<i[1]},getControl:function(){return this.controls},setControl:function(t,e){var i=this.controls;if(R.is(t)){if(R.is(i)&&(i.deactivate(e),void 0!==i.getCurrentKeyframe&&void 0!==t.setKeyframe&&i!==t)){t instanceof f&&i.update(!0);var n=i.getCurrentKeyframe();t.setKeyframe(n)}return this.controls=t,this.viewpoint.control=t,this.controls.activate(e),i!==t&&a.publish(a.eventsList.manipulatorProfile,t.type),!0}return!1},setControlsMode:function(t){this.mode=t},getControlsMode:function(){return this.mode},displayContextualMenu:function(t){return t?b.enable():b.disable()},getQuadtree:function(){return M.warn("Deprecated: 'getQuadtree'."),this.vqt._qt},getRenderPassManager:function(){return this.renderPassManager},getCanvas:function(){return this.webGLV6Viewer.canvas},getRecorder:function(){return this._recorder},allowRendering:function(t){t?(this._allowRendering=!0,this.urban&&this.urban._frmViewerContainer&&(this.urban._frmViewerContainer.style.opacity="1.0")):this._recorder.isRecording()||(this._allowRendering=!1,this.urban&&this.urban._frmViewerContainer&&(this.urban._frmViewerContainer.style.opacity="0.5"))},_infos:function(t){return this.camAltitude=(this.viewpoint.camera.position.z-this.terrainHeight).toFixed(2),"altitude : "+this.camAltitude+" m.<br />height : "+this.terrainHeight+" m.<br />scale : x"+this.scale+"."},_debugQuadTree:function(t){var e="Level : "+this.level;return void 0!==this.vqt&&null!==this.vqt&&(e+=this.vqt.debug(t)),e},_computeFPS:function(){return this.fpscounter++,this.fps+=1e3/(Date.now()-this.initTime),10===this.fpscounter&&(this.currentfps=Math.floor(this.fps/10),this.fps=0,this.fpscounter=0),this.initTime=Date.now(),this.currentfps},_forceRender:function(){this._needRender=!0},_debugViewer:function(t){return"<br />FPS  : "+this.currentfps+"<br />calls  : "+this.webGLV6Viewer.getInfos().render.calls+"<br />texs : "+this.webGLV6Viewer.getInfos().memory.textures+"<br />geom : "+this.webGLV6Viewer.getInfos().memory.geometries+"<br />program  : "+this.webGLV6Viewer.getInfos().memory.programs+"<br />Update :"+this.timeUpdate+"  Render :"+this.timeRender},createUgVisu:function(){this.ugVisu=new d(this.webGLV6Viewer,this.viewpoint,this,this.renderPassManager),this.ugVisu.addToSceneGraph(this._rootProjScaledShifted)},activateAreaMode:function(){void 0===this.ugVisu&&this.createUgVisu(),this.ugVisu.startAreaSelection("AREA")},deactivateAreaMode:function(){void 0===this.ugVisu&&this.createUgVisu(),this.ugVisu.deactivateAreaMode()},activateWindowMode:function(){void 0===this.ugVisu&&this.createUgVisu(),this.ugVisu.startAreaSelection("WINDOW")},deactivateWindowMode:function(){void 0===this.ugVisu&&this.createUgVisu(),this.ugVisu.deactivateWindowMode()},updateCoordinatePosition:function(t){if(R.is(this._runtimeModifiedNodes)&&this._runtimeModifiedNodes.length>0){var i,n,s,r,o,a=this._runtimeModifiedNodes.length;this.webGLV6Viewer.getRobot();for(n=0;n<a;n++)if(i=this._runtimeModifiedNodes[n],R.is(this._identityMatrix)||(this._identityMatrix=new e.Matrix4,this._identityMatrix.identity()),s=i.userData,R.is(s)&&(R.is(s.impl)?o=s.impl.getContent():R.is(s.getContent)&&(o=s.getContent()),R.is(o))){r=o.get("Coordinate"),R.is(r)||(r=new E({projection:this.urban.getUserDefaultProjection()})).create(this.urban);var h=t;r.set("position",h),o.set("Coordinate",r),this._freeRobot.setTarget(this.currentPath,null,this.webGLV6Viewer)}}},askupdateCoordinatesFromMatrices:function(){R.is(this._updateCoordToken)||(this._updateCoordToken=!0,a.subscribeTo("/3DEXPERIENCity/onPostUpdate",this.updateCoordinatesFromMatrices.bind(this),!0))},updateCoordinatesFromMatrices:function(t,i){if(this._updateCoordToken=null,R.is(this._runtimeModifiedNodes)&&this._runtimeModifiedNodes.length>0){var n,s,r,o,h,l=this._runtimeModifiedNodes.length;this.webGLV6Viewer.getRobot();for(s=0;s<l;s++)if(n=this._runtimeModifiedNodes[s],R.is(this._identityMatrix)||(this._identityMatrix=new e.Matrix4,this._identityMatrix.identity()),r=this._robotFeature,R.is(r)&&(R.is(r.impl)?h=r.impl.getContent():R.is(r.getContent)&&(h=r.getContent()),R.is(h))){if(!h.customRobot){o=h.get("Coordinate"),R.is(o)||((o=new E({projection:this.urban.getUserDefaultProjection()})).create(this.urban),o.addEvent("onChange:matrix",this.centerRobot,this));o.get("position"),o.get("rotation");R.is(h._node)?o.setMatrix(h._node.getMatrix()):o.setMatrix(n.getMatrix()),h.set("Coordinate",o),a.publish("/3DEXPERIENCity/robotMoved",{Coordinate:o})}var d=null;if(R.is(this._v2Robot)){d=this.currentPath.getWorldMatrix(this.webGLV6Viewer);var u=this.currentPath.getBoundingSphere().center;h.customRobot||(u.z=o.get("position").z),h.getBaseAltitude&&(u.z=h.getBaseAltitude());var c=new e.Matrix4,g=this.currentPath.getParentPath();g&&g.getWorldMatrix(this.webGLV6Viewer,c);var m=d.clone(),f=(new e.Matrix4).setPosition(u);h.customRobot?h.customRobot():o.setOffsetToRobotCenter(m,f,this.currentPath,c),d.setPosition(u)}this._freeRobot.setTarget(this.currentPath,d,this.webGLV6Viewer)}}},askForCenterrobot:function(){R.is(this.centerRobotToken)||(this.centerRobotToken=a.subscribeTo("/3DEXPERIENCity/onPostUpdate",this.applyCenterRobot.bind(this),!0))},centerRobot:function(){this.askForCenterrobot()},applyCenterRobot:function(){if(R.is(this._freeRobot)&&R.is(this._runtimeModifiedNodes)&&this._runtimeModifiedNodes.length>0){var t,i,n,s,r,o=this._runtimeModifiedNodes.length;this.webGLV6Viewer.getRobot();for(i=0;i<o;i++)if(t=this._runtimeModifiedNodes[i],R.is(this._identityMatrix)||(this._identityMatrix=new e.Matrix4,this._identityMatrix.identity()),n=t.userData,R.is(n)&&(R.is(n.impl)?r=n.impl.getContent():R.is(n.getContent)&&(r=n.getContent()),R.is(r))){s=r.get("Coordinate"),R.is(s)||(s=new E({projection:this.urban.getUserDefaultProjection()})).create(this.urban);s.get("position"),s.get("rotation");var a=null;if(R.is(this._v2Robot)){a=this.currentPath.getWorldMatrix(this.webGLV6Viewer);var h=this.currentPath.getBoundingSphere().center;h.z=s.get("position").z,r.getBaseAltitude&&(h.z=r.getBaseAltitude());var l=new e.Matrix4,d=this.currentPath.getParentPath();d&&d.getWorldMatrix(this.webGLV6Viewer,l);var u=a.clone(),c=(new e.Matrix4).setPosition(h);s.setOffsetToRobotCenter(u,c,this.currentPath,l),a.setPosition(h)}this._freeRobot.setTarget(this.currentPath,a,this.webGLV6Viewer)}}this.centerRobotToken=null},enableRobotV2:function(){this._v2Robot=!0},disableRobotV2:function(){this._v2Robot=!1},_initRobot:function(t){if(!R.is(this._freeRobot)){var n,s=this;if(!0===this._v2Robot){var r;this._freeRobot=new H("robot",this.webGLV6Viewer,!0,!0,this.touchDevice),this._freeRobot.subscribe("ScreenPlaneTranslationBegin",function(t){var e,n=s._runtimeModifiedNodes[0].userData;R.is(n)&&(R.is(n.impl)?e=n.impl.getContent():R.is(n.getContent)&&(e=n.getContent()),R.is(e)&&(r=e._node.getPickable(),e._node.setPickable(i.NOPICKABLE)))}),this._freeRobot.subscribe("ScreenPlaneTranslationEnd",function(t){var e,i=s._runtimeModifiedNodes[0].userData;if(R.is(i)){R.is(i.impl)?e=i.impl.getContent():R.is(i.getContent)&&(e=i.getContent()),R.is(e)&&e._node.setPickable(r);var n=Date.now();R.is(B)&&n-B<500&&xCity.removeChild(i),B=n}});var o=function(){var t=s.getControl();t&&(t.enabled=!1)},a=function(){var t=s.getControl();t&&(t.enabled=!0)},h=(n=["LineTranslationEnd","PlaneTranslationEnd","RotationEnd","ScalingEnd","ScreenPlaneTranslationEnd","LineTranslationManipulation","PlaneTranslationManipulation","RotationManipulation","ScalingManipulation","ScreenPlaneTranslationManipulation"]).length;for(c=0;c<h;c++)u=n[c],this._freeRobot.subscribe(u,this.askupdateCoordinatesFromMatrices.bind(this));var l=["LineTranslationBegin","PlaneTranslationBegin","RotationBegin","ScalingBegin","ScreenPlaneTranslationBegin"];for(c=0;c<h;c++)u=l[c],this._freeRobot.subscribe(u,o.bind(this));var d=["LineTranslationEnd","PlaneTranslationEnd","RotationEnd","ScalingEnd","ScreenPlaneTranslationEnd"];for(c=0;c<h;c++)u=d[c],this._freeRobot.subscribe(u,a.bind(this))}else{this._freeRobot=new N("robot",this.webGLV6Viewer,!0),this._freeRobot.setDisplayScalingNodes(!1);var u,c;h=(n=["LineTranslationEnd","PlaneTranslationEnd","RotationEnd","ScalingEnd","ScreenPlaneTranslationEnd"]).length;for(c=0;c<h;c++)u=n[c],this._freeRobot.subscribe(u,this.updateCoordinatesFromMatrices.bind(this))}R.is(this._runtimeModifiedNodes)||(this._runtimeModifiedNodes=[]),this._runtimeModifiedNodes.push(t),this.webGLV6Viewer.getRobot()||this.webGLV6Viewer.setManipulators({activated:!0,preActivate:!0}),this._rootShifted.setMatrix((new e.Matrix4).identity()),this._rootShifted.addChild(this._freeRobot)}},setRobotVisibility:function(){if(R.is(this._freeRobot)&&R.is(this._robotFeature)){var t=this._robotFeature.get("visible");this._freeRobot.setVisibility(t)}},setRobotTarget:function(t,i){if(R.is(this._robotFeature)&&(this._robotFeature.removeEvent("onDestroy",this.setRobotTarget.bind(this)),this._robotFeature.removeEvent("onChange:visible",this.setRobotVisibility.bind(this)),this._robotFeature=null),R.is(t)&&i){var n;if(R.is(t.impl)?n=t.impl.getContent():R.is(t.getContent)&&(n=t.getContent()),!n)return;n.setRobot&&n.setRobot(i);var s=n._node;if(!R.is(s))return void console.log("no 3D node to modify");this._initRobot(s);var r=R.getUrbanPathElement(s),o=null;if(R.is(this._v2Robot)){if(this._freeRobot.setCityFeature(t),this._freeRobot.setPickingMethod(this.controls.exactPick.bind(this.controls)),o=r.getWorldMatrix(this.webGLV6Viewer),!R.is(o))return;var a=r.getBoundingSphere().center,h=0;R.is(t.impl)?f=t.impl.getContent():R.is(t.getContent)&&(f=t.getContent());var l=!1;if(R.is(f)){n.getBaseAltitude&&(h=n.getBaseAltitude(),l=!0);var d=f.get("Coordinate");if(R.is(d)){l||(h=d.get("position").z);var u=new e.Matrix4,c=r.getParentPath();c&&c.getWorldMatrix(this.webGLV6Viewer,u),a.z=h;var g=o.clone(),m=(new e.Matrix4).setPosition(a);d.setOffsetToRobotCenter(g,m,r,u),d.addEvent("onChange:matrix",this.centerRobot,this)}}a.z=h,o.setPosition(a)}this._freeRobot.setTarget(r,o,this.webGLV6Viewer),this._robotFeature=t,this._robotFeature.addEvent("onDestroy",this.setRobotTarget.bind(this)),this._robotFeature.addEvent("onChange:visible",this.setRobotVisibility.bind(this)),this.setRobotVisibility(),this.currentPath=r,t.set("selected",!0)}else{var f;if(this.disableRobot(),R.is(t))if(t.set("selected",!1),R.is(this._v2Robot))if(R.is(t.impl)?f=t.impl.getContent():R.is(t.getContent)&&(f=t.getContent()),f.setRobot&&f.setRobot(i),R.is(f)){d=f.get("Coordinate");R.is(d)&&d.removeEvent("onChange:matrix",this.centerRobot,this)}}},disableRobot:function(){R.is(this._freeRobot)&&(this._rootShifted.removeChild(this._freeRobot),this._freeRobot=null,this.currentPath=null,this.webGLV6Viewer.getRobot()||this.webGLV6Viewer.setManipulators({activated:!1,preActivate:!1}),this._runtimeModifiedNodes.pop())},getAltitudeEffect:function(){if(void 0===this.altitudeEffect){this.altitudeEffect=new L(this.webGLV6Viewer.renderer,this.webGLV6Viewer.renderer.renderTargetPool,this.urban),this.webGLV6Viewer.renderer.addCustomEffect(this.altitudeEffect);var t=this;a.subscribeTo("/VISU/onMouseMove",function(e){if(t||(t=xCity._urbanImpl.USR),t.altitudeEffect){var i=0;if(R.is(t.altitudeEffect._currentZ))i=t.altitudeEffect._currentZ;else{var n=this.exactPick(e.from[0].getCurrentPosition());n&&(i=n.z)}t.altitudeEffect.mixPass.uniforms.zRef.value=i}}.bind(this.controls))}return this.altitudeEffect},getViewshedEffect:function(){return void 0===this.viewshedEffect&&(this.viewshedEffect=new k(this.webGLV6Viewer.renderer,this.webGLV6Viewer.renderer.renderTargetPool,this._root,this.urban),this.webGLV6Viewer.renderer.addCustomEffect(this.viewshedEffect)),this.viewshedEffect},getAtmosphereEffect:function(){return void 0===this.atmosphereEffect&&(this.atmosphereEffect=new I(this.webGLV6Viewer.renderer,this.webGLV6Viewer.renderer.renderTargetPool,this._root,this.urban),this.webGLV6Viewer.renderer.addCustomEffect(this.atmosphereEffect)),this.atmosphereEffect},setMaxLevel:function(t){t>=0&&(this.maxLevel=t)},dataReadyForRender:function(){return!this.vqt.terrainInProcess&&!this.vqtPo.dataInProcess&&this.urban.environment.sky._iblReady},setOIT:function(t){this.webGLV6Viewer.setOIT(t)},getOIT:function(){return this.webGLV6Viewer.getOIT()},addHighlightSet:function(t,e){R.is(this._highlightsets)||(this._highlightsets={});var i=O._JSONToRendering({highlightSet:e});this._highlightsets[t]=this.webGLV6Viewer.createHighlightSet(i.highlightSet,!0)},getHighlightSet:function(t){var e=null;if(R.is(this._highlightsets)){var i=this._highlightsets[t];R.is(i)&&(e=O._RenderingToJSON({highlightSet:this._highlightsets[t].highlightData}).highlightSet)}return e},activateHighlightSet:function(t){if(R.is(this._highlightsets)){var e=this._highlightsets[t];e?this.webGLV6Viewer.setCurrentHighlightSet(e):this.webGLV6Viewer.setCurrentHighlightSet(null)}},getCurrentHighlightColor:function(){return R.is(this.webGLV6Viewer)&&R.is(this.webGLV6Viewer.highlightColor)?{highlightColor:this.webGLV6Viewer.highlightColor}:null},_addModel:function(){this.getControl().addModel(xCity.selectedItems[0])}},G}),define("DS/UrbanFeature/DataModel",["UWA/Class/Model","UWA/Class","UWA/Ajax","DS/Visualization/Node3D","DS/XCityModel/Item","DS/XCityModel/Folder","DS/XCityModel/RdbLink","DS/UrbanFeature/PointOfView","DS/UrbanFeature/Geometry","DS/XCityModel/GeometrySet","DS/UrbanFeature/Line","DS/XCityModel/LineSet","DS/UrbanFeature/Polygon","DS/XCityModel/PolygonSet","DS/UrbanFeature/BuildingSet","DS/XCityModel/PointOfInterest","DS/UrbanFeature/PointOfInterest3D","DS/XCityModel/PointOfInterest3DSet","DS/UrbanFeature/SimplePointOfInterest3D","DS/UrbanFeature/Coordinate","DS/XCityModel/Feature","DS/UrbanFeature/Bookmark","DS/UrbanFeature/Viewshed","DS/UrbanFeature/ViewshedCamera","DS/UrbanFeature/Annotation","DS/XCityModel/Marker","DS/XCityModel/Terrain","DS/XCityModel/RasterOverlay","DS/XCityModel/Light","DS/UrbanFeature/PointCloud","DS/UrbanFeature/KeyFrameAnimation","DS/UrbanFeature/R2VFeatureState","DS/XCityTools/Debug"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g,m,f,p,v,_,b,y,w,P,S,x,C,M,D,T,V,A,R,E){"use strict";var L=UWA.Class.extend({init:function(t){this._urban=t},load:function(t,e){if(void 0!==t.pointObjects)for(var i=Object.keys(t.pointObjects),n=0,s=i.length;n<s;n++)this.addPointObjectsLayer(i[n],t.pointObjects[i[n]],e);for(var r=Object.keys(t.models),o=0,a=r.length;o<a;o++)this.addModel(r[o],t.models[r[o]],e)},addModel:function(t,e,i){var n=new b({shifted:e.shifted});e.position&&n.loadJSONVector3(this._urban,"position",e.position);var s=new h(e);s.set("Coordinate",n);var r=new y(e);r.set("name",t),r.set("Content",s),i.addChild(r)},addPointObjectsLayer:function(t,e,i){e.name=t;var n=new y({name:t,id:t}),s=new o;s.loadJSONFactory(this._urban,"factory",e,e),s.loadJSON(this._urban,e,n),void 0!==e.credits&&this._urban.creditor.addCredit("Vectors",e.credits.name,e.credits.providers,e.credits.year),n.set("Content",s),i.addChild(n)}});return r.extend({defaults:r.prototype.defaults,init:function(t){this._parent({id:"_root",name:"Root"}),this._urban=t,this._node3D=new n,this._node3D.name="DataModel",this._root=this,this.create(this._root),this._defaultPath=""},_childAdded:function(t,e){this.dispatchEvent("onAddTree",e);var i=this;e.traverse&&e.traverse(function(t){i.dispatchEvent("onAddTree",t)},!0)},_childRemoved:function(t,e){this.dispatchEvent("onRemoveTree",e);var i=this;e.traverse&&e.traverse(function(t){i.dispatchEvent("onRemoveTree",t)},!0)},loadJSONUrl:function(t,e){var i=this;UWA.Ajax.request(t,{crossDomain:!0,onComplete:function(t){i.loadJSONFile(t),e&&e(t)}})},loadJSONFile:function(t){var e=JSON.parse(t);this.loadJSON(this._urban,e,void 0)},loadJSONList:function(t){new L(this._urban).load(t,this)},getNode3D:function(){return this._node3D},getRoot:function(){return this},addCurrentPointOfView:function(t){var e=this._urban.getViewpoint();e.logPOV(),e=e.get();var i=new y({name:void 0!==t?t:"Point of view",PointOfView:new a({position:e.target,length:e.length,rotation:e.angle})});return this.addChild(i),i},loadModelUrl:function(t,e,i){var n=new h({url:t,extension:i,Shader:{name:"building",uniforms:{normalMap:!0,specularMap:!0}}}),s=new y({name:t});s.set("Content",n),e&&e([s]),this.addChild(s)},createFeaturePrimitive:function(t,e){var i=this.findChildById(t,!0);if(i){var n=new y({name:i.get("name")+" "+e,id:i.get("id")+"_"+e});return n.set("Content",i.get("Content").createPrimitive(e)),n.create(this._urban),n}},addUserEditedFeature:function(t){var e=this.findChildById("user_edited_features");return void 0===e&&(e=new r({name:"User Edited Features",description:"User Edited Features",id:"user_edited_features",visible:!0,opened:!1}),this.addChild(e)),e.addChild(t)}})}),define("DS/UrbanCore/Urban",["require","UWA/Core","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/UrbanCore/DateTime","DS/UrbanCore/SceneRenderer","DS/XCityTools/EventDispatcher","DS/UrbanTool/Url","DS/XCityTools/Geocoder","DS/UrbanTool/Utils","DS/XCityTools/Debug","DS/xCityBasicUtils/AABBox","DS/UrbanTool/FocusManager","DS/UrbanTool/SplashScreen","DS/XCityEnvironment/Environment","DS/XCityLoaders/XCityLoader","DS/XCityGeometry/PointOfInterestManager","DS/XCityGeometry/LabelManager","DS/UrbanFeature/DataModel","DS/UrbanFeature/DataModelSelection","DS/UrbanFeature/Geometry","DS/XCityModel/PointOfInterest","DS/XCityModel/Feature","DS/XCityModel/Folder","DS/UrbanFeature/PointOfView","DS/XCityModel/RasterOverlay","DS/UrbanFeature/Coordinate","DS/XCityModel/View3DContextualMenuManager","DS/XCityTools/Downloader","DS/ApplicationFrame/FrameWindow","DS/XCityCoreUI/DebugUI","DS/UrbanManipulator/Localisator","DS/CSIViewModel3DFrame/CSIViewModel3DFrame","DS/XCityTimeManager/xCityTimer","DS/WebappsUtils/WebappsUtils","DS/XCityModel/WebWorkerPool","DS/XCityModel/WorkerSemaphore","DS/xCityPlatformUtils/xCityPlatformIntegration"],function(t,e,i,n,s,r,o,a,h,l,d,u,c,g,m,f,p,v,_,b,y,w,P,S,x,C,M,D,T,V,A,R,E,L,k,I,N,F){"use strict";function U(t){if(l.is(t)||(t={}),this.url=new a(window.location.href),this._debugMode=void 0,this.viewerContainer=void 0,this.urbanLoaded=!1,this.baseURL="",h.setBaseUrl(this.baseURL),l.is(widget)&&T.setWidget(widget),this.quadKeyToDouble=!0,this.useNormalMap=!0,this.useSpecularMap=!0,this.showQuadtree=!1,this.showQuadtreeLevels=!1,this.showQuadtreeTileInfos=!1,this.showTriangles=!1,this.lockQuadtree=!1,this.baseReferential={},this.projectName="",this.baseProjection="EPSG:900913",this.shiftedPosition={x:0,y:0,z:0},this.worldSize=0,this.slabAltitude=0,this.cropBox=void 0,this.storage=void 0,f.init(this),this.modelLoader=f,this.date=new s(this),this.url.hasArgument("crop"))this.url.getArgument("crop").value.split(",");if(l.is(window.URBANODT))F.urlGlobe="/Web3DXCityVisuTests/assets/data/dataserver";else{this.storage=new UWA.Storage({adapter:"Cookies",database:"geoviacity"});var e=this.storage.get("app");e&&this.url.setParameters(e)}this.modelRoot=new _(this),this._dataModelPrivate=new _(this),this.loader={},this.loader.zae=this.modelRoot.loadModelUrl.bind(this.modelRoot),this.loader.dae=this.modelRoot.loadModelUrl.bind(this.modelRoot),this.loader.json=this.modelRoot.loadJSONUrl.bind(this.modelRoot),this.modelSelection=new b(this),this.modelSelection.addDataModel(this.modelRoot),this.modelSelection.addDataModel(this._dataModelPrivate)}return U.prototype={init:function(t){l.is(t)||(t={}),l.is(t.debugVisualOdt)&&(this._debugVisualOdt=!0),this._initFrmWindow(t),this._createViewerContainer(t),this.USR=new r(this,t),this.USR.getScene().add(this.modelRoot.getNode3D()),this.USR.getScene().add(this._dataModelPrivate.getNode3D()),t.visuPointCloud&&(this.USR.viewpoint.hasPointCloud=!0),c.setRenderer(this.getView3D()),this.url.hasArgument("focus")&&Number(this.url.getArgument("focus").value)&&c.activate(),this.oocManager=null,this.environment=new m(this),this._frmViewerContainer=this.frmWindow.getViewerFrame(),this.poiManager=new p(this),this.labelManager=new v(this),this.USR.initPart2(this),D.initialize(this.USR,this.modelSelection),l.is(t)&&(t.enableRenderLoop=!l.is(t.enableRenderLoop)||t.enableRenderLoop),l.is(t)&&l.is(t.enableRenderLoop)&&t.enableRenderLoop&&this.USR.renderLoop(),this.transitionEnd=l.transitionEndEventName();document.body.addEventListener("drop",function(t){d.log("Drop"),t.preventDefault();var e=t.dataTransfer.files;this.onLocalFile(e)}.bind(this),!1),document.body.addEventListener("dragover",function(t){t.preventDefault()},!1),o.subscribeTo("/3DEXPERIENCity/onUpdate",d.update.bind(d)),this.viewerContainer.parentElement!==this._frmViewerContainer&&this.viewerContainer.inject(this._frmViewerContainer),console.log("DS 3DEXPERIENCity v"+this.getPluginVersion()),g.ready(),o.publish("/3DEXPERIENCity/onInit",this)},_initWebWorkers:async function(t){if(!(window.URBANODT||window.jasmine)||"web_workers_geometries_building"===self.document.title||"3DEXPERIENCity | Web workers ODT"===self.document.title||"labels_visual"===self.document.title||"3DEXPERIENCity | Labels Sample"===self.document.title){const e=this;let i;const n=async function(){if(e.USR.forceUpdate=!0,e.USR.dataReadyForRender()||t){let t;if(i&&o.unsubscribe(i),t=l.is(k.getProxifiedWebappsBaseUrl())&&""!==k.getProxifiedWebappsBaseUrl()?k.getProxifiedWebappsBaseUrl():k.getWebappsBaseUrl(),e.lineSetWorker||(e.lineSetWorker=new I(t+"XCityModelWorkers/LineBuilderSubWorker.js",4,!1)),e.polygonSetWorker||(e.polygonSetWorker=new I(t+"XCityModelWorkers/PolygonBuilderSubWorker.js",6,!1)),e.featureSorterWorkerSem||(e.featureSorterWorkerSem=new N(t+"XCityModelWorkers/FeatureSorterWorker.js",2)),!e.generalWorkerSem){e.generalWorkerSem=new N(t+"XCityModelWorkers/GeneralWorker.js",1);const i=await e.generalWorkerSem.requestWorker();i.worker.postMessage({function:"load"}),i.release()}}},s=function(){i=o.subscribeTo("/3DEXPERIENCity/onPostUpdate",n)};1===t?n():i||setTimeout(s,1e4)}},_initFrmWindow:function(t){l.is(t)&&l.is(t.frmWindow)?this.frmWindow=t.frmWindow:(this.frmWindow=this._createFrameWindow(t),l.is(widget)&&this.frmWindow.inject(widget.body)),l.is(t)&&l.is(t.container)&&this.frmWindow.inject(t.container)},_createFrameWindow:function(t){return t.visuPointCloud?new E({height:"100%",language:l.is(widget)?widget.lang:navigator.language||navigator.userLanguage,viewerOptions:{defaultLights:!1,autoUpdateFrustum:!1,infinitePlane:!1,newModelIdentification:!1,antiAliasing:"SMAA",hdr:!1,useShadowMap:!1,useVignetting:!1,ssao:!1,dof:!1,deferred:!1,defaultAnimationLoop:!0,debugShadowLight:!1,debugBSphere:!1,debugBBox:!1,debugPicking:!1,mirror:!1,displayGrid:!0},uiOptions:{displayTree:!1}}):new V({viewer:"none",height:"100%",language:l.is(widget)?widget.lang:navigator.language||navigator.userLanguage})},_createViewerContainer:function(t){l.is(t)&&l.is(t.viewer)?l.is(t.viewer.div)?this.viewerContainer=t.viewer.div:console.warn("You don't have defined a div for the webGLV6Viewer."):l.is(t)&&l.is(t.div)?this.viewerContainer=t.div:l.is(t)&&l.is(t.frmWindow)&&l.is(t.frmWindow.getViewer)?this.viewerContainer=t.frmWindow.getViewer().div:this.frmWindow&&this.frmWindow.getViewer&&this.frmWindow.getViewer()?this.viewerContainer=this.frmWindow.getViewer().div:this.viewerContainer=UWA.Element("div"),this.viewerContainer.setStyles({position:"relative",backgroundColor:"white",width:"100%",height:"100%"}),this.viewerContainer.id="xCityViewer"},getPluginVersion:function(){return"R425.23.02"},reset:function(){g.loading(),this.baseReferential={},this.baseProjection="EPSG:900913",this.worldSize=0,this.shiftedPosition={x:0,y:0,z:0},h.setDefaultProjection(this.baseProjection),this.projectName="",document.title="3DEXPERIENCity",this.slabAltitude=0,this.url.hasArgument("crop")||(this.cropBox=void 0),T.reset(),this.poiManager.reset(),this.date.reset(),this.USR.reset(this),this.modelRoot.removeChildren(),this._dataModelPrivate.removeChildren(),this.modelSelection.clear(),o.publish("/3DEXPERIENCity/onReset",this),g.ready()},setup:function(t,e){var i=function(t,e,n,s,r){var a=!0;try{for(var d={},c=0;c<t.length;c++)UWA.extend(d,t[c],!0);var m=d.UrbanProject||{};if(this._coreVersion="R425.23.02",m.version)this._coreVersion=m.version;else if(m.date){void 0===Date.getWeek&&(Date.prototype.getWeek=function(){var t=new Date(this.getTime());t.setHours(0,0,0,0),t.setDate(t.getDate()+3-(t.getDay()+6)%7);var e=new Date(t.getFullYear(),0,4);return 1+Math.round(((t.getTime()-e.getTime())/864e5-3+(e.getDay()+6)%7)/7)});var f=new Date(m.date),p=f.getWeek(),v=f.getFullYear(),_="R425.23.02".split(".");_[0]=Number(_[0].split("R")[1]),_[1]=Number(_[1]),_[2]=Number(_[2]),v===2e3+_[1]&&p>=_[2]&&(this._coreVersion="R425.23.02")}l.is(m.referential)&&(this.baseReferential.title=m.referential.title,this.baseReferential.proj=m.referential.proj,this.baseReferential.yTopToBottom=m.referential.yTopToBottom,this.baseReferential.bbox=m.referential.bbox);var b=l.is(this.baseReferential.proj)?this.baseReferential.proj:m.proj4Projection,y=l.is(this.baseReferential.bbox)?this.baseReferential.bbox.xmax-this.baseReferential.bbox.xmin:m.worldSize,w=l.is(this.baseReferential.bbox)?{x:this.baseReferential.bbox.xmin,y:this.baseReferential.bbox.ymin}:m.shiftedPosition;if(!(l.is(b)&&l.is(y)&&l.is(w)&&l.is(w.x)&&l.is(w.y)))return console.warn("Missing information to configure new base!"),l.is(s)&&s(!1),l.is(r)?r():void 0;if(b!==this.baseProjection)return this.baseProjection=b,void h.setDefaultProjection(this.baseProjection,i.bind(this,t,e,n,s));this.worldSize=y,this.shiftedPosition=w,this.shiftedPosition.z=0,l.is(m.projectName)&&(this.projectName=m.projectName,document.title="3DEXPERIENCity | "+this.projectName),l.is(m.slabAltitude)&&(this.slabAltitude=m.slabAltitude),!this.url.hasArgument("crop")&&l.is(m.crop)&&(this.cropBox=new u(m.crop,this)),this.date.setFromConfig(m.date),this.poiManager.setup(m.poiSettings);var P,S=m.withCredentials||{};for(P in S)T.setCredentials(P,S[P]);T.setUrlParams(m.urlParams),l.is(m.stylesheets)&&("object"==typeof m.stylesheets?this.addStylesheets(m.stylesheets):"string"==typeof m.stylesheets&&this.addStylesheet(m.stylesheets)),void 0!==m.viewer&&this.USR.setup(m.viewer),o.publish("/3DEXPERIENCity/onConfig",this);var x=null;if(l.is(window.URBANODT)||(x=this.storage.get("context")),x)this.modelRoot.loadJSON(this,x);else if(m.contexts&&m.contexts.length>0){var C=this,M=!0;a=!1,l.downloadOrderedTree(m.contexts,function(t,e){if(!0===e){var i=JSON.parse(t);return{data:i,ref:i.link}}if(void 0===e)return{data:t,ref:t.link};g.end(),s(!1)},function(t){try{for(c=0;c<t.length;c++)C.modelRoot.loadJSON(C,t[c],void 0,void 0,void 0,function(t,e){t||(M=!1),s(t,e)});for(c=0;c<e.length;c++)this.modelRoot.loadJSON(this,e[c],void 0,void 0,void 0,function(t,e){t||(M=!1),s(t,e)});M&&(a=!0)}catch(t){console.error(t.stack),s(!1)}},n)}else try{for(c=0;c<e.length;c++)this.modelRoot.loadJSON(this,e[c],void 0)}catch(t){console.error(t.stack),l.is(s)&&s(!1)}}catch(t){console.error(t.stack),l.is(s)&&s(!1)}g.ready(),this.urbanLoaded=!0,a&&l.is(s)&&s(!0),T._datasetToCheckList<1&&o.publish(o.eventsList.onLoaded,this)}.bind(this);t=this._cloneConfig(t),this.reset();e=this._mergeOptions(e);if(this._readOptions(e),!l.is(t))return l.is(e.onComplete)?e.onComplete(!0):void 0;t="string"==typeof t?{url:t}:t;var n=[],s=[];g.loading();try{l.downloadOrderedTree([t],function(t,i){try{var r=void 0;if(!0===i?r=JSON.parse(t):void 0===i?r=t:(g.end(),e.onComplete(!1)),r)return r.UrbanProject||!r.Root&&!r.Content?s.push(r):n.push(r),{data:r,link:r.link}}catch(t){console.error(t.stack),e.onComplete(!1)}},function(t){s.length>0&&i(s,n,e.path,e.onComplete)},e.path)}catch(t){console.error(t.stack),e.onComplete(!1)}},_mergeOptions:function(t){var e=void 0!==t?t:{};for(var i in this._oldOptions=void 0!==this._oldOptions?this._oldOptions:t,this._oldOptions)void 0===e[i]&&e[i]!==this._oldOptions[i]&&(e[i]=this._oldOptions[i]);return e},_readOptions:function(t){l.is(t)&&((this.url.hasArgument("debug")&&Number(this.url.getArgument("debug").value)||this.url.hasArgument("console")&&Number(this.url.getArgument("console").value)||l.is(t)&&t.debug)&&this._setDebugMode(!0),this.getView3D().displayContextualMenu(void 0!==t.displayContextualMenu&&t.displayContextualMenu),t.displayCompass&&!l.is(this.compass)&&this._initCompass(),t.FocusManager&&!this._debugMode&&c.activate(),l.is(t.debugVisualOdt)&&(this._debugVisualOdt=!0,this.date.enableImplicitShift(!1)))},_initCompass:function(){this.compass=new R(this.frmWindow.getUIFrame(),this),this.compass.bindEvents(),this.compass.show(),this.compass.setAlignment("top")},setBaseURL:function(t,e){this.baseURL=t,h.setBaseUrl(this.baseURL,e)},saveCookies:function(){this.storage.set("app",this.url.getParameters()),this.storage.set("context",this.getLayerRoot().toJSON())},_cloneConfig:function(t){return"object"==typeof t?JSON.parse(JSON.stringify(t)):t},_setDebugMode:function(t){this._debugMode!==t&&(this._debugMode=t,d.initialize(t,!1),this._debugMode&&(window.THREE=i,window.utils=l,window.Feature=P,window.Folder=S,window.Geometry=y,window.PointOfInterest=w,window.PointOfView=x,window.OverlayRaster=C,window.Coordinate=M,window.modelRoot=this.modelRoot,window.modelSelection=this.modelSelection,window.SplashScreen=g),this._debugMode?l.is(this.debugUI)?this.debugUI.show():this.debugUI=new A(this):this.debugUI.hide())},getPerformanceProfileManager:function(){return this.USR.getProfilePerformance()},getRenderingProfileManager:function(){return this.USR.getProfileRendering()},getView3D:function(){return this.USR},getDateTime:function(){return this.date},getProjectName:function(){return e.clone(this.projectName)},getProjectProjection:function(){return e.clone(h.getProjectProjection())},getUserDefaultProjection:function(){return e.clone(h.getDefaultProjection())},getControl:function(){return this.USR.getControl()},getViewpoint:function(){return this.USR.viewpoint},getLayerRoot:function(){return this.modelRoot},getLayerSelection:function(){return this.modelSelection},getEnvironment:function(){return this.environment},addStylesheets:function(t){for(var e=0;e<t.length;e++)this.addStylesheet(t[e])},addStylesheet:function(t){var e=document.createElement("link");e.type="text/css",e.rel="stylesheet",e.href=T.resolveUrl(t),document.getElementsByTagName("head")[0].appendChild(e)},onLocalFile:function(t,e){d.log(t);for(var i=0;i<t.length;i++){var n=t[i];if(n){var s=n.name.split("."),r=s[s.length-1],o=window.URL.createObjectURL(n),a=this.loader[r];a&&a(o,e,r)}}},subscribeToSplashScreen:function(t){g.isReady()?t():g.addEvent("onPageReady",t)},initTimeFiltering:function(){this._timefilter||(this._timefilter=new L(this))},webglReport:function(){var t=this.USR.webGLV6Viewer.getWebGLContext();function e(t){return"["+t[0]+", "+t[1]+"]"}function i(t,e){return e?""+Math.pow(2,t):"2<sup>"+t+"</sup>"}function n(t,e){var n=e?" bit mantissa":"";return"[-"+i(t.rangeMin,e)+", "+i(t.rangeMax,e)+"] ("+t.precision+n+")"}function s(e){var i=t.getShaderPrecisionFormat(e,t.HIGH_FLOAT),s=t.getShaderPrecisionFormat(e,t.MEDIUM_FLOAT),r=t.getShaderPrecisionFormat(e,t.LOW_FLOAT),o=i;return 0===i.precision&&(o=s),'<span title="High: '+n(i,!0)+"\n\nMedium: "+n(s,!0)+"\n\nLow: "+n(r,!0)+'">'+n(o,!1)+"</span>"}function r(t){return 0!==t&&0==(t&t-1)}function o(t){var e={renderer:"",vendor:""},i=t.getExtension("WEBGL_debug_renderer_info");return null!=i&&(e.renderer=t.getParameter(i.UNMASKED_RENDERER_WEBGL),e.vendor=t.getParameter(i.UNMASKED_VENDOR_WEBGL)),e}return{glVersion:t.getParameter(t.VERSION),shadingLanguageVersion:t.getParameter(t.SHADING_LANGUAGE_VERSION),vendor:t.getParameter(t.VENDOR),renderer:t.getParameter(t.RENDERER),unMaskedVendor:o(t).vendor,unMaskedRenderer:o(t).renderer,antialias:t.getContextAttributes().antialias?"Available":"Not available",angle:function(t){var i=e(t.getParameter(t.ALIASED_LINE_WIDTH_RANGE));return"Win32"!==navigator.platform&&"Win64"!==navigator.platform||"Internet Explorer"===t.getParameter(t.RENDERER)||"Microsoft Edge"===t.getParameter(t.RENDERER)||i!==e([1,1])?"No":r(t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS))&&r(t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS))?"Yes, D3D11":"Yes, D3D9"}(t),maxColorBuffers:function(t){var e=1,i=t.getExtension("WEBGL_draw_buffers");return null!=i&&(e=t.getParameter(i.MAX_DRAW_BUFFERS_WEBGL)),e}(t),redBits:t.getParameter(t.RED_BITS),greenBits:t.getParameter(t.GREEN_BITS),blueBits:t.getParameter(t.BLUE_BITS),alphaBits:t.getParameter(t.ALPHA_BITS),depthBits:t.getParameter(t.DEPTH_BITS),stencilBits:t.getParameter(t.STENCIL_BITS),maxRenderBufferSize:t.getParameter(t.MAX_RENDERBUFFER_SIZE),maxCombinedTextureImageUnits:t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxCubeMapTextureSize:t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),maxFragmentUniformVectors:t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),maxTextureImageUnits:t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:t.getParameter(t.MAX_TEXTURE_SIZE),maxVaryingVectors:t.getParameter(t.MAX_VARYING_VECTORS),maxVertexAttributes:t.getParameter(t.MAX_VERTEX_ATTRIBS),maxVertexTextureImageUnits:t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexUniformVectors:t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),aliasedLineWidthRange:e(t.getParameter(t.ALIASED_LINE_WIDTH_RANGE)),aliasedPointSizeRange:e(t.getParameter(t.ALIASED_POINT_SIZE_RANGE)),maxViewportDimensions:e(t.getParameter(t.MAX_VIEWPORT_DIMS)),maxAnisotropy:function(){var e=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic");if(e){var i=t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT);return 0===i&&(i=2),i}return"n/a"}(),vertexShaderBestPrecision:s(t.VERTEX_SHADER),fragmentShaderBestPrecision:s(t.FRAGMENT_SHADER),fragmentShaderFloatIntPrecision:function(t){var e=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),i=0!==e.precision?"highp/":"mediump/";return i+=0!==(e=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_INT)).rangeMax?"highp":"lowp"}(t),extensions:t.getSupportedExtensions(),draftExtensionsInstructions:-1!==navigator.userAgent.indexOf("Chrome")?'To see draft extensions in Chrome, browse to about:flags, enable the "Enable WebGL Draft Extensions" option, and relaunch.':-1!==navigator.userAgent.indexOf("Firefox")?"To see draft extensions in Firefox, browse to about:config and set webgl.enable-draft-extensions to true.":""}}},U});