/*!  COPYRIGHT DASSAULT SYSTEMES 2017   */
define("DS/3DPlayNavigationScenario/NavigationService",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/VisuEvents/EventsManager","DS/Visualization/PathElement","DS/WebUtils/Clock","DS/WebInfraUI/Joystick","DS/WebRunloop/Runloop","DS/3DPlay/3DPlay","DS/WebSystem/Nls","DS/WebInfraUI/Notification","DS/3DPlayAnnotation3D/AnnotationUtils","DS/3DPlayAnnotationUtils/ShapeUtils","DS/Core/PointerEvents","DS/ApplicationFrame/CommandsManager","DS/WebUtils/Tracker"],function(e,i,t,n,o,a,r,s,c,h,l,d,v,u,g){"use strict";var _,p=Math.PI;return e.extend({init:function(e){_=this,this._parent(e),this.sensitivity=10,this.defaultDelta=.01,this.speedSliderCB=e.speedSliderCB,this.frameWindow=e.frameWindow,this.setSelectionCallBack=e.setSelectionCallBack,this.ctx=this.frameWindow.options.context,void 0===t._isInit&&t.init(),this._position={x:0,y:0},this._picking={},this._prePicking={},this.setNavigationStates(),this.createReframe(),this.hideReframe(),this._setBBox(),this.upAttribute="y"==this.frameWindow.getViewer()._worldOrientation.upAttribute},_setBBox:function(){this.frameWindow.experience?this.bBox=this.frameWindow.experience.getRootBag().bBox:this.bBox=this.frameWindow._3dViewer.getRootNode().bBox},getBbox:function(){return this.bBox||this._setBBox(),this.bBox},setNavigationStates:function(){this._navigationState={pause:!1,pitch_up:!1,pitch_down:!1,yaw_right:!1,yaw_left:!1,roll_left:!1,roll_right:!1,move_forward_keyboard:!1,move_backward_keyboard:!1,move_forward_mouse:!1,move_backward_mouse:!1,move_forward_touch:!1,move_backward_touch:!1,speed:50},this.touchModeActive=!1},runloopCallBack:function(){!1===this.TOUCH_JOYSTICKS_ACTIVE&&this.clock&&!0===this.navigate&&!0===this.mouseMove&&this.update(this.clock.getDelta()),!0===this.KEYBOARD_ACTIVE&&this.updatePostionFromKeybdEvent()},updatePostionFromMouseEvent:function(e){if(!this._webGLV6Viewer||!e)return!1;if(!1===this.TOUCH_JOYSTICKS_ACTIVE&&this.navigate){var i=this._webGLV6Viewer.getMousePosition(e.from[0].getCurrentPosition());this._position.x=i.x,this._position.y=i.y}},updatePostionFromTouchEvent:function(e,t){if(!0===this.TOUCH_JOYSTICKS_ACTIVE){var n=this._webGLV6Viewer.getMousePosition(new i.Vector2(e.x,e.y));this._position.x=n.x,this._position.y=n.y,this.update(0,!0,t)}},updatePostionFromKeybdEvent:function(){console.log("updatePostionFromKeybdEvent");if(this._navigationState.roll_left||this._navigationState.roll_right)this.joystickLinearMoveLeftRight(50);else{var e={};e.x=_._webGLV6Viewer.SCREEN_WIDTH/2,e.y=_._webGLV6Viewer.SCREEN_HEIGHT/2,this._navigationState.move_forward_keyboard||this._navigationState.move_backward_keyboard||(console.log("IJKL pressed"),this._navigationState.pitch_up?e.y=e.y-100*_._webGLV6Viewer.SCREEN_HEIGHT/500:this._navigationState.pitch_down?e.y=e.y+100*_._webGLV6Viewer.SCREEN_HEIGHT/500:this._navigationState.yaw_left?e.x=e.x-100*_._webGLV6Viewer.SCREEN_WIDTH/500:this._navigationState.yaw_right&&(e.x=e.x+100*_._webGLV6Viewer.SCREEN_WIDTH/500));var t=this._webGLV6Viewer.getMousePosition(new i.Vector2(e.x,e.y));this._position.x=t.x,this._position.y=t.y,this.update(0,!0,50)}},update:function(e,t,n){var o=this._currentViewpoint.getUpDirection(),a=this._currentViewpoint.getSightDirection(),r=this._currentViewpoint.getTargetDistance(),s=(this._currentViewpoint.getTarget(),this._currentViewpoint.getEyePosition()),c=t?this.defaultDelta:80*e/100;this.isInsideBboxLimits()&&this.tranlationSpeed||(this.tranlationSpeed=s.distanceTo(this._originalTarget)/180);var h=this.tranlationSpeed?this.tranlationSpeed:1;this._navigationState.speed&&(h=this.tranlationSpeed*(this._navigationState.speed/100),c*=this._navigationState.speed/100),h<0&&(h=1),n&&(h*=n/12);var l=new i.Vector3(0,0,0);l.crossVectors(o,a),this.upAttribute?l.y=0:l.z=0;var d=p/2*c*this._position.x,v=p/2*c*this._position.y;if(d=-d,v=-v,"Walk"===this.NAVIGATION_MODE&&(v=0),a.applyAxisAngle(o,d),l.applyAxisAngle(o,d),this.upAttribute?l.y=0:l.z=0,a.applyAxisAngle(l,v),!0===this._navigationState.move_forward_mouse||!0===this._navigationState.move_backward_mouse||!0===this._navigationState.move_forward_touch||!0===this._navigationState.move_backward_touch||!0===this._navigationState.move_forward_keyboard||!0===this._navigationState.move_backward_keyboard){var u=new i.Vector3(0,0,0);u.z=h,(this._navigationState.move_forward_mouse||this._navigationState.move_forward_touch||!0===this._navigationState.move_forward_keyboard)&&(u.z=-u.z);var g=this._currentViewpoint.camera.matrixWorld;s=u.applyMatrix4(g)}var _;this.upAttribute?l.y=0:l.z=0,o.crossVectors(a,l),null!=e&&0!=e||(e=this.defaultDelta/this.sensitivity),_={upDirection:o,eyePosition:s,sightDirection:a,distanceToTarget:r,duration:e},this._currentViewpoint.moveTo(_),this.checkLookAt()},checkLookAt:function(){var e=this.frameWindow.getViewer();this.frameWindow.experience?this.bSphere=this.frameWindow.experience.getRootBag().bSphere:this.bSphere=this.frameWindow._3dViewer.getRootNode().bSphere;var i=d.onScreenProjection([this.bSphere.center],e);this.bBox||(this.bBox=this.getBbox());d.onScreenProjection(this.bBox.getPoints(),e);this.bBoxViewerFrame=this.frameWindow.getViewerFrame().getBoundingClientRect();this._currentViewpoint.getEyePosition();var t=!1,n={x:50,y:50,angle:0};this.bBoxViewerFrame.left<i[0].x&&i[0].x<this.bBoxViewerFrame.right&&this.bBoxViewerFrame.top<i[0].y&&i[0].y<this.bBoxViewerFrame.bottom&&(t=!0,n.x=i[0].x%this.bBoxViewerFrame.bottom,n.y=i[0].y%this.bBoxViewerFrame.bottom);var o=this.bSphere.center.addScalar(this.bSphere.radius),a=d.onScreenProjection([o],e);Math.sqrt((a[0].x-i[0].x)*(a[0].x-i[0].x)+(a[0].y-i[0].y)*(a[0].y-i[0].y))/this.bBoxViewerFrame.width<.025&&(t=!1),_.isInsideBboxLimits()&&(t=!0),t?this.hideReframe():(this.bBoxViewerFrame.left<=i[0].x&&i[0].x<=this.bBoxViewerFrame.right?n.x=i[0].x:i[0].x<this.bBoxViewerFrame.left?(n.x=this.bBoxViewerFrame.left+64,n.angle=90):this.bBoxViewerFrame.right<i[0].x&&(n.x=this.bBoxViewerFrame.right-64,n.angle=-90),this.bBoxViewerFrame.top<=i[0].y&&i[0].y<=this.bBoxViewerFrame.bottom?n.y=i[0].y:i[0].y<this.bBoxViewerFrame.top?(n.y=this.bBoxViewerFrame.top+64,n.angle=180):this.bBoxViewerFrame.bottom<i[0].y&&(n.y=this.bBoxViewerFrame.bottom-64,n.angle=0),this.showReframe(n))},isInsideBboxLimits:function(){this.bBox||(this.bBox=this.getBbox());var e=this._currentViewpoint.getEyePosition(),i=this.bBox.max.x-this.bBox.min.x,t=this.bBox.max.x+.05*i,n=this.bBox.min.x-.05*i,o=this.bBox.max.y-this.bBox.min.y,a=this.bBox.max.y+.05*o,r=this.bBox.min.y-.05*o,s=this.bBox.max.z-this.bBox.min.z,c=this.bBox.max.z+.05*s,h=this.bBox.min.z-.05*s;return n<e.x&&e.x<t&&r<e.y&&e.y<a&&h<e.z&&e.z<c},updateHeight:function(){this._currentViewpoint.getUpDirection(),this._currentViewpoint.getSightDirection();var e=this._currentViewpoint.getTargetDistance(),t=(this._currentViewpoint.getTarget(),this._currentViewpoint.getEyePosition()),n=this._heightConstraint;new i.Vector3(0,0,0).y=n-this._previousHeight,n-this._previousHeight!=0&&(t.setZ(t.z+(n-this._previousHeight)*(e/250)),this._previousHeight=n,this._currentViewpoint.moveTo({eyePosition:t}),_.checkLookAt())},beginNavigation:function(e){this._viewerFrame=this.frameWindow.getViewerFrame(),this._webGLV6Viewer=this.frameWindow.getViewer(),this._currentViewpoint=this._webGLV6Viewer.currentViewpoint,this._originalTarget||(this._originalTarget=this._currentViewpoint.getTarget()),this._currentViewpoint.setControlActive(!1),this.setPickingForNavigation(),this.frameWindow.experience&&this.frameWindow.experience.hideRefAxis(),this.NAVIGATION_MODE="Fly",this.TOUCH_JOYSTICKS_ACTIVE=!1,this.KEYBOARD_ACTIVE=!1,this._heightConstraint=0,this._previousHeight=0,this.setKeybdEventsMap(),this.runloop=new r({name:"flyWalkNavigation",data:this,func:this.runloopCallBack}),this.clock=new o,this.runloop.start(),this._currentViewpoint.onCenterCamera(function(){}),this.touchMode=e.touchMode,!0===e.touchMode?this.beginTouchModeNavigation():this.beginMouseModeNavigation()},setPickingForNavigation:function(){this._webGLV6Viewer.picking&&(this._picking.activated=this._webGLV6Viewer.picking.activated,this._picking.displayHL=this._webGLV6Viewer.picking.displayHL,this._picking.trapSelection=this._webGLV6Viewer.picking.trapSelection,this._picking.defaultPicking=this._webGLV6Viewer.getDefaultPicking(),this._webGLV6Viewer.setPicking({activated:!1,displayHL:!1,trapSelection:!0!==this._picking.trapSelection&&void 0},!1)),this._webGLV6Viewer.pPicking&&(this._prePicking.activated=this._webGLV6Viewer.pPicking.activated,this._prePicking.displayHL=this._webGLV6Viewer.pPicking.displayHL,this._prePicking.trapSelection=this._webGLV6Viewer.pPicking.trapSelection,this._webGLV6Viewer.setPrePicking({activated:!1,displayHL:!1,trapSelection:!0!==this._picking.trapSelection&&void 0},!1)),this.pickingOff=!0},unsetPickingForNavigation:function(){UWA.is(this._webGLV6Viewer.picking,"object")&&UWA.is(this._picking,"object")&&UWA.is(this._picking.activated,"boolean")&&UWA.is(this._picking.displayHL,"boolean")&&UWA.is(this._picking.trapSelection,"boolean")&&UWA.is(this._picking.defaultPicking,"boolean")&&this._webGLV6Viewer.setPicking({activated:this._picking.activated,displayHL:this._picking.displayHL,trapSelection:!0===this._picking.trapSelection||void 0},this._picking.defaultPicking),UWA.is(this._webGLV6Viewer.pPicking,"object")&&UWA.is(this._prePicking,"object")&&UWA.is(this._prePicking.activated,"boolean")&&UWA.is(this._prePicking.displayHL,"boolean")&&UWA.is(this._prePicking.trapSelection,"boolean")&&this._webGLV6Viewer.setPrePicking({activated:this._prePicking.activated,displayHL:this._prePicking.displayHL,trapSelection:!0===this._picking.trapSelection||void 0},this._picking.defaultPicking),this.pickingOff=!1},endNavigation:function(){this._currentViewpoint.onCenterCamera(null),this.NAVIGATION_MODE="Fly",this.TOUCH_JOYSTICKS_ACTIVE=!1,this.KEYBOARD_ACTIVE=!1,this.endTouchModeNavigation(),this.endMouseModeNavigation(),this.unsetKeybdEventsMap(),this.displayJoySticks(!1),this.destroyReframe(),this.clock&&(this.clock.stop(),this.clock=void 0),this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=void 0),this._currentViewpoint.setControlActive(!0),this.unsetPickingForNavigation(),this.frameWindow.experience&&this.frameWindow.experience.showRefAxis(),this.ctx=void 0},beginMouseModeNavigation:function(){this.setNavigationStates(),this.setMouseEventsMap()},endMouseModeNavigation:function(){this.hideReframe(),this.setNavigationStates(),this.unsetMouseEventsMap()},beginTouchModeNavigation:function(){this.reframeNavigation(),this._heightConstraint=0,this._previousHeight=0,this._position.x=0,this._position.y=0,this.setNavigationStates(),this.displayJoySticks(!0),this.setTouchEventsMap(),this.setSelectionCallBack({id:"TouchMode",state:!0})},endTouchModeNavigation:function(){this.unsetTouchEventsMap(),this.displayJoySticks(!1)},displayJoySticks:function(e){if(e){this.showcmd=!0,g.startCommand("command-Joystick"),this._joystickContainer=UWA.createElement("div",{id:"PlayWeb-joystick-ui-container",styles:{width:this._webGLV6Viewer.SCREEN_WIDTH,height:this._webGLV6Viewer.SCREEN_HEIGHT,"pointer-events":"auto"}}).inject(this._viewerFrame);var i=UWA.createElement("div",{id:"PlayWeb-joystick-ui-container-left",styles:{width:this._webGLV6Viewer.SCREEN_WIDTH/2,height:this._webGLV6Viewer.SCREEN_HEIGHT}}).inject(this._joystickContainer),t=UWA.createElement("div",{id:"PlayWeb-joystick-ui-container-right",styles:{width:this._webGLV6Viewer.SCREEN_WIDTH/2,height:this._webGLV6Viewer.SCREEN_HEIGHT}}).inject(this._joystickContainer);UWA.createElement("div",{id:"PlayWeb-joystick-ui-container-right-zone","pointer-events":"auto"}).inject(t),UWA.createElement("div",{id:"PlayWeb-joystick-ui-container-left-zone","pointer-events":"auto"}).inject(i);var n={left:{zone:document.getElementById("PlayWeb-joystick-ui-container-left-zone"),color:"black",mode:"static",position:{left:"15%",top:"75%"}},right:{zone:document.getElementById("PlayWeb-joystick-ui-container-right-zone"),color:"black",mode:"static",position:{left:"85%",top:"75%"}}};this._joystickLinearMove=new a.create(n.left),this._joystickAngularMove=new a.create(n.right),document.getElementById("PlayWeb-joystick-ui-container-left-zone").setStyle("pointer-events","auto"),document.getElementById("PlayWeb-joystick-ui-container-right-zone").setStyle("pointer-events","auto");var o=document.getElementsByClassName("front");Object.keys(o).forEach(function(e){o[e].style.background="white",o[e].style.opacity=1}),this.TOUCH_JOYSTICKS_ACTIVE=!0}else this.showcmd&&(this.showcmd=!1,g.endCommand("command-Joystick")),this._joystickLinearMove&&this._joystickLinearMove.destroy(),this._joystickAngularMove&&this._joystickAngularMove.destroy(),this._joystickContainer&&this._joystickContainer.destroy(),this._joystickContainer=void 0,this._joystickLinearMove=void 0,this._joystickAngularMove=void 0,this.TOUCH_JOYSTICKS_ACTIVE=!1},createReframe:function(){this.reframeUIMainContainer=UWA.createElement("div",{id:"PlayWeb-reframe-ui-main-container"}).inject(this.frameWindow.getUIFrame()),this.reframeUIContainer=UWA.createElement("div",{id:"PlayWeb-reframe-ui-container"}).inject(this.reframeUIMainContainer),this.reframeUIContainer.addEvent(v.POINTERDOWN,this.lookAt)},destroyReframe:function(){this.reframeUIMainContainer&&(this.reframeUIContainer.removeEvent("click",this.lookAt),this.reframeUIMainContainer.destroy()),this.reframeUIMainContainer=void 0},showReframe:function(e){e&&(this.reframeUIContainer.setStyle("top",e.y+"px"),this.reframeUIContainer.setStyle("left",e.x+"px"),this.reframeUIContainer.style.transform="rotate("+e.angle+"deg)"),!this.reframeUIMainContainer||this.reframeUIMainContainer.show(),!this.reframeUIContainer||this.reframeUIContainer.show()},hideReframe:function(){this.reframeUIMainContainer&&(this.reframeUIMainContainer.hide(),this.reframeUIContainer.hide())},setMouseEventsMap:function(){var e=this;this.evtTokenMouse=[],this.evtTokenMouse.push(t.addEvent(this._viewerFrame,"onLeftMouseDown",function(i){e.navigate=!0,e.mouseMove=!0,e.clock.start(),e.updatePostionFromMouseEvent(i),e._navigationState.move_forward_mouse=!0})),this.evtTokenMouse.push(t.addEvent(this._viewerFrame,"onLeftMouseUp",function(i){e.updatePostionFromMouseEvent(i),e.clock.stop(),e._navigationState.move_forward_mouse=!1,e.navigate=!1,e.mouseMove=!1})),this.evtTokenMouse.push(t.addEvent(this._viewerFrame,"onRightMouseDown",function(i){e.navigate=!0,e.mouseMove=!0,e.clock.start(),e.updatePostionFromMouseEvent(i),e._navigationState.move_backward_mouse=!0})),this.evtTokenMouse.push(t.addEvent(this._viewerFrame,"onRightMouseUp",function(i){e.updatePostionFromMouseEvent(i),e.clock.stop(),e._navigationState.move_backward_mouse=!1,e.navigate=!1,e.mouseMove=!1})),this.evtTokenMouse.push(t.addEvent(this._viewerFrame,"onMouseMove",function(i){1==e.navigate&&(e.mouseMove=!0,e.clock.start(),e.updatePostionFromMouseEvent(i))})),this.evtTokenMouse.push(t.addEvent(this._viewerFrame,"onMiddleMouseDown",function(i){e.navigate=!0})),this.evtTokenMouse.push(t.addEvent(this._viewerFrame,"onMiddleMouseUp",function(i){e.checkLookAt(),e.clock.stop(),e.navigate=!1,e.mouseMove=!1})),this.evtTokenMouse.push(t.addEvent(this._viewerFrame,"onLeftDoubleClick",function(i){e.tapToNavigate(i)})),this.evtTokenMouse.push(t.addEvent(this._viewerFrame,"onDoubleTap",function(i){e.tapToNavigate(i)}))},setKeybdEventsMap:function(){var e=this;this.evtTokenKeybd=[],this.evtTokenKeybd.push(t.addEvent(this._viewerFrame,"onKeyDown",function(i){switch(i.gesture.events[0].event.code||i.gesture.events[0].event.keyCode){case"KeyW":console.log("KeyW"),e.KEYBOARD_ACTIVE=!0,e._navigationState.move_forward_keyboard=!0;break;case"KeyS":console.log("KeyS"),e.KEYBOARD_ACTIVE=!0,e._navigationState.move_backward_keyboard=!0;break;case"KeyA":console.log("KeyA"),e.KEYBOARD_ACTIVE=!0,e._navigationState.roll_left=!0;break;case"KeyD":console.log("KeyD"),e.KEYBOARD_ACTIVE=!0,e._navigationState.roll_right=!0;break;case"KeyI":console.log("KeyI"),e.KEYBOARD_ACTIVE=!0,e._navigationState.pitch_up=!0;break;case"KeyK":console.log("KeyK"),e.KEYBOARD_ACTIVE=!0,e._navigationState.pitch_down=!0;break;case"KeyJ":console.log("KeyJ"),e.KEYBOARD_ACTIVE=!0,e._navigationState.yaw_left=!0;break;case"KeyL":console.log("KeyL"),e.KEYBOARD_ACTIVE=!0,e._navigationState.yaw_right=!0}switch(i.gesture.key){case 107:case 187:e.updateSpeed(5);break;case 109:case 189:e.updateSpeed(-5);break;case 37:console.log("Left arrow"),e.KEYBOARD_ACTIVE=!0,e._navigationState.roll_left=!0;break;case 38:e.KEYBOARD_ACTIVE=!0,e._navigationState.move_forward_keyboard=!0;break;case 39:console.log("Right arrow"),e.KEYBOARD_ACTIVE=!0,e._navigationState.roll_right=!0;break;case 40:e.KEYBOARD_ACTIVE=!0,e._navigationState.move_backward_keyboard=!0}})),this.evtTokenKeybd.push(t.addEvent(this._viewerFrame,"onKeyUp",function(i){e._navigationState.move_forward_keyboard=!1,e.KEYBOARD_ACTIVE=!1,e._navigationState.move_backward_keyboard=!1,e._navigationState.roll_left=!1,e._navigationState.roll_right=!1,e._navigationState.pitch_up=!1,e._navigationState.pitch_down=!1,e._navigationState.yaw_left=!1,e._navigationState.yaw_right=!1}))},updateSpeed:function(e){"number"==typeof e&&_._navigationState.speed&&_._navigationState.speed+e>0&&_._navigationState.speed+e<=100&&(_._navigationState.speed+=e,this.speedSliderCB(_._navigationState.speed))},setSpeed:function(e){_._navigationState.speed&&e>0&&e<=100&&(_._navigationState.speed=e)},tapToNavigate:function(e){var t,n,o=this.frameWindow.getViewer(),a=o.currentViewpoint.getSightDirection(),r=o.currentViewpoint.getTargetDistance(),s=o.currentViewpoint.getEyePosition(),c={},h={x:0,y:0,z:0};e.from?t={x:e.from[0].getJSEvent().pageX,y:e.from[0].getJSEvent().pageY}:(t={},console.log(e));var l=o.pick(o.getMousePosition(t),"mesh",!0);if(l.path.length>0){c=l.position.clone();var d=new i.Vector3(c.x-s.x,c.y-s.y,c.z-s.z),v=d.length();d.normalize(),h.x=c.x-d.x*v*.2,h.y=c.y-d.y*v*.2,"Walk"===this.NAVIGATION_MODE?h.z=s.z:h.z=c.z-d.z*v*.15,n={eyePosition:h,sightDirection:a,distanceToTarget:r,duration:500},o.currentViewpoint.centerCamera(l.position),this._currentViewpoint.onCenterCamera(function(){}),o.currentViewpoint.moveTo(n),this._currentViewpoint.onCenterCamera(null),o.render()}else console.log("points not recognizes on the model")},setTouchEventsMap:function(){var e=this,i={x:0,y:0};i.x=e._webGLV6Viewer.SCREEN_WIDTH/2,i.y=e._webGLV6Viewer.SCREEN_HEIGHT/2;var n={distance:void 0}.distance,o=!1,a=null;this._joystickLinearMove.on("start",function(t,r){i.x=e._webGLV6Viewer.SCREEN_WIDTH/2,i.y=e._webGLV6Viewer.SCREEN_HEIGHT/2,e._navigationState.move_forward_touch=!1,e._navigationState.move_backward_touch=!1,e.updatePostionFromTouchEvent(i,10),a=setInterval(function(i){o&&(1==e._navigationState.roll_left||1==e._navigationState.roll_right?e.joystickLinearMoveLeftRight(n):e.updatePostionFromTouchEvent(i,n))},1,i)}),this._joystickLinearMove.on("move",function(t,a){a&&a.direction&&a.distance&&(n=a.distance,o=!0,"up"===a.direction.y&&"up"===a.direction.angle&&(e._navigationState.move_forward_touch=!0,e._navigationState.move_backward_touch=!1,e._navigationState.roll_left=!1,e._navigationState.roll_right=!1,e.updatePostionFromTouchEvent(i,n)),"down"===a.direction.y&&"down"===a.direction.angle&&(e._navigationState.move_forward_touch=!1,e._navigationState.move_backward_touch=!0,e._navigationState.roll_left=!1,e._navigationState.roll_right=!1,e.updatePostionFromTouchEvent(i,n)),"left"===a.direction.x&&"left"===a.direction.angle&&(e._navigationState.roll_left=!0,e._navigationState.roll_right=!1,e.joystickLinearMoveLeftRight(n)),"right"===a.direction.x&&"right"===a.direction.angle&&(e._navigationState.roll_left=!1,e._navigationState.roll_right=!0,e.joystickLinearMoveLeftRight(n)))}),this._joystickLinearMove.on("end",function(t,o){i.x=e._webGLV6Viewer.SCREEN_WIDTH/2,i.y=e._webGLV6Viewer.SCREEN_HEIGHT/2,e._navigationState.move_forward_touch=!1,e._navigationState.move_backward_touch=!1,e._navigationState.roll_left=!1,e._navigationState.roll_right=!1,e.updatePostionFromTouchEvent(i,n),a&&clearInterval(a)});var r=!1,s=null,c={direction:!1};this._joystickAngularMove.on("start",function(t,n){i.x=e._webGLV6Viewer.SCREEN_WIDTH/2,i.y=e._webGLV6Viewer.SCREEN_HEIGHT/2,e.updatePostionFromTouchEvent(i),s=setInterval(function(i){r&&e.updatePostionFromTouchEvent(i)},1,i)}),this._joystickAngularMove.on("move dir",function(t,n){n&&n.direction&&n.distance&&n.distance>0&&(r=!0,c.angle!==n.direction.angle&&(i.x=e._webGLV6Viewer.SCREEN_WIDTH/2,i.y=e._webGLV6Viewer.SCREEN_HEIGHT/2,e.updatePostionFromTouchEvent(i),c.angle=n.direction.angle),"up"===n.direction.y&&"up"===n.direction.angle&&(i.y=i.y-e._webGLV6Viewer.SCREEN_HEIGHT*n.distance/2e3,e.updatePostionFromTouchEvent(i)),"down"===n.direction.y&&"down"===n.direction.angle&&(i.y=i.y+e._webGLV6Viewer.SCREEN_HEIGHT*n.distance/2e3,e.updatePostionFromTouchEvent(i)),"left"===n.direction.x&&"left"===n.direction.angle&&(i.x=i.x-e._webGLV6Viewer.SCREEN_WIDTH*n.distance/2e3,e.updatePostionFromTouchEvent(i)),"right"===n.direction.x&&"right"===n.direction.angle&&(i.x=i.x+e._webGLV6Viewer.SCREEN_WIDTH*n.distance/2e3,e.updatePostionFromTouchEvent(i)))}),this._joystickAngularMove.on("end",function(t,n){i.x=e._webGLV6Viewer.SCREEN_WIDTH/2,i.y=e._webGLV6Viewer.SCREEN_HEIGHT/2,e.updatePostionFromTouchEvent(i),s&&clearInterval(s)}),this.evtTokenTouch=[],this.evtTokenTouch.push(t.addEvent(this._viewerFrame,"onLeftDoubleClick",function(i){e.tapToNavigate(i)})),this.evtTokenTouch.push(t.addEvent(this._viewerFrame,"onDoubleTap",function(i){e.tapToNavigate(i)})),this.frameWindow.getViewerFrame().addEvent("resize",this.resizefun)},joystickLinearMoveLeftRight:function(e){_._navigationState.move_forward_touch=!1,_._navigationState.move_backward_touch=!1;var t,n,o=new i.Vector3;1==_._navigationState.roll_left?o.x=-e/100*(this._navigationState.speed/100):1==_._navigationState.roll_right&&(o.x=e/100*(this._navigationState.speed/100)),_.distanceToTarget&&_.isInsideBboxLimits()||(_.distanceToTarget=_._currentViewpoint.getControl().distanceToTarget),o.applyQuaternion(_._currentViewpoint.getControl().orientation),o.setLength(.05*_.distanceToTarget),t=_._currentViewpoint.getTarget().add(o),_._currentViewpoint.getControl().orientation.clone(),n=_._currentViewpoint.getTargetDistance();var a=_._currentViewpoint.getCamera().getLookAt().clone(),r=(new i.Vector3).addVectors(t,a.normalize().multiplyScalar(-n));_._currentViewpoint.moveTo({eyePosition:r,duration:1e3/e*2/(this._navigationState.speed/100)}),_.checkLookAt()},unsetTouchEventsMap:function(){this.evtTokenTouch&&(this.evtTokenTouch.forEach(function(e){t.removeEventFromToken(e)}),this.evtTokenTouch=void 0),this.evtTokenTouch=[],this.frameWindow.getViewerFrame().removeEvent("resize",this.resizefun)},unsetMouseEventsMap:function(){this.evtTokenMouse&&(this.evtTokenMouse.forEach(function(e){t.removeEventFromToken(e)}),this.evtTokenMouse=void 0)},unsetKeybdEventsMap:function(){this.evtTokenKeybd&&(this.evtTokenKeybd.forEach(function(e){t.removeEventFromToken(e)}),this.evtTokenKeybd=void 0)},levelViewPointwithGround:function(){var e=this._currentViewpoint.getUpDirection(),i=this._currentViewpoint.getSightDirection(),t=e.clone();if(t.z<0||t.y<0){if(this.upAttribute&&t.y<0){t.y*=-1;var n=t.z;t.z=t.x,t.x=n}else if(!this.upAttribute&&t.z<0){t.z*=-1;n=t.x;t.x=t.y,t.y=n}var o={sightDirection:i,upDirection:t,duration:500};this._currentViewpoint.moveTo(o),setTimeout(function(){_.levelGround()},600)}else _.levelGround()},levelGround:function(){var e={eyePosition:_._currentViewpoint.getEyePosition(),upDirection:this.upAttribute?new i.Vector3(0,1,0).normalize():new i.Vector3(0,0,1).normalize(),duration:1200};_._currentViewpoint.moveTo(e),_.checkLookAt()},getPauseValue:function(){return this._navigationState.pause},setPauseValue:function(e){this._navigationState.pause=e,e?this.clock.stop():this.clock.start()},lookAt:function(){if(_.reframeNavigation(),_.hideReframe(),"Walk"===_.NAVIGATION_MODE){var e=u.getCommand("FlyWalk",_.frameWindow.experience.ctx);e&&e.reloadWalkMode()}},reframeNavigation:function(){_.frameWindow.getViewpoint().reframe()},centerToObject:function(){this._currentViewpoint.centerCamera(this._originalTarget)},resizefun:function(e){console.log("resize"),_.endNavigation(),_.beginNavigation({touchMode:_.touchMode})}.bind(this)})}),define("DS/3DPlayNavigationScenario/3DPlayNavigationScenario",["DS/3DPlay/3DPlayScenario","DS/ApplicationFrame/CommandsManager","DS/WebSystem/Environment"],function(e,i,t){"use strict";return e.extend({init:function(e){void 0!==e&&e.scenarioManager&&(this._exp=e.scenarioManager.getExperience()),this._parent(e)},launch:function(){var e=this;if(this._exp&&this._exp.frmWindow){if(t.isSet("3DPlay.LoadOldFlyWalk"))this.loadWorkbench({module:"3DPlayNavigationScenario",name:"3DPlayNavigationScenario_old"},!0,{sections:[{id:"FlyWalk",nls:"3DPlayNavigationScenario/3DPlayNavigationScenario",rsc:"3DPlayNavigationScenario/3DPlayNavigationScenario"}]});else{for(var n=this._exp.args.workbenchs,o=null,a=[],r=0;r<n.length;r++)"EnopadRightPanel"==n[r].name?o=n[r]:a.push(n[r]);a.push({name:"3DPlayNavigationScenario",module:"3DPlayNavigationScenario"}),!o||a.push(o),this._exp.workbenchIndex=0,this._exp.manageWorkBenchs({createActionBar:!0,finishCallBack:function(e){console.log("custom workBench Loaded!",e)},customWorkBench:a})}if(e._viewer=this._exp.frmWindow.getViewer(),this._exp){this._exp.showContextualMenu(!1);var s=!1;this._exp.isSpecTreeAllowed()&&(s=!0);var c=this._exp.frmWindow.getActionBar();this.token_launch=c.onActionBarReady(function(){if(t.isSet("3DPlay.LoadOldFlyWalk")){var n=i.getCommand("FlyWalk",e._exp.ctx);n&&!n.isRunning()&&(n.hideImmersiveFrame=s,n.navgationService&&(n.navgationService._originalTarget=e._exp.frmWindow.getViewer().currentViewpoint.getTarget()),n.begin())}else{var o=i.getCommandCheckHeader("FlyWalkCmd",e._exp.ctx);o&&!1===o.getState()&&(o.setState(!0),e.token_launch&&(c.removeCallback(e.token_launch),e.token_launch=void 0))}}),1===e._viewer.currentViewpoint.getProjectionType()&&(e._viewer.currentViewpoint.setProjectionType(0),e._previousProjection=1);var h=i.getCommand("VisuPerspectiveView",e._exp.ctx);h&&h.disable();var l=i.getCommand("VisuOrthographicView",e._exp.ctx);l&&l.disable()}}else console.error("3DPlay : Navigation Scenario --\x3e Cound not launch.")},stop:function(){if(this._exp&&this._exp.frmWindow){if(this.token_launch){var e=this._exp.frmWindow.getActionBar();e&&(e.removeCallback(this.token_launch),this.token_launch=void 0)}if(this._viewer=this._exp.frmWindow.getViewer(),this._exp){this._exp.showContextualMenu(!0),1===this._previousProjection&&(this._viewer.currentViewpoint.setProjectionType(1),this._previousProjection=void 0);var n=i.getCommand("VisuPerspectiveView",this._exp.ctx);n&&n.enable();var o=i.getCommand("VisuOrthographicView",this._exp.ctx);if(o&&o.enable(),t.isSet("3DPlay.LoadOldFlyWalk")){var a=i.getCommand("FlyWalk",this._exp.ctx);a&&a.isRunning()&&a.end()}else{var r=i.getCommandCheckHeader("FlyWalkCmd",this._exp.ctx);r&&!0===r.getState()&&r.setState(!1)}this._viewer=void 0}}else console.error("3DPlay : Navigation Scenario --\x3e Cound not stop.")},isMobileCompatible:function(){return!0}})}),define("DS/3DPlayNavigationScenario/CmdFlyWalk",["DS/ApplicationFrame/Command","css!DS/3DPlayNavigationScenario/3DPlayNavigationScenario","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Controls/Slider","DS/Windows/Dialog","DS/WebInfraUI/ContextualBarManager","DS/3DPlayNavigationScenario/NavigationService","DS/WebSystem/Settings","DS/WebUtils/Tracker","DS/CoreEvents/Events"],function(e,i,t,n,o,a,r,s,c,h,l,d){"use strict";var v;Math.PI;return e.extend({init:function(e){this._parent(e,{isAsynchronous:!0})},hideImFrame:function(){this.getFrameWindow().getImmersiveFrame(),this.hideImmersiveFrame&&this.getFrameWindow().getImmersiveFrame()&&this.getFrameWindow().getImmersiveFrame().hide()},showImFrame:function(){this.getFrameWindow().getImmersiveFrame()&&this.getFrameWindow().getImmersiveFrame().show()},beginExecute:function(){this.hideImFrame(),l.command(this.getId());var e=this;v=this,this.flywalkWidgetFullscreenDisable=d.subscribe({event:"3DPLAY/MOBILEACTIONBAR/DISABLE"},function(i){e._sliderMainContainer&&e._sliderMainContainer.setAttribute("id","PlayWeb-slider-container_MAB"),e._speedSliderMainContainer&&e._speedSliderMainContainer.setAttribute("id","PlayWeb-speed-slider-container_MAB")}),this.flywalkWidgetFullscreenEnable=d.subscribe({event:"3DPLAY/MOBILEACTIONBAR/ENABLE"},function(i){e._sliderMainContainer&&e._sliderMainContainer.setAttribute("id","PlayWeb-slider-container"),e._speedSliderMainContainer&&e._speedSliderMainContainer.setAttribute("id","PlayWeb-speed-slider-container")});var i=this.getFrameWindow().getActionBar();i.close();var a=i.onActionBarReady(function(){e.isRunning()&&i.close()}),r=i.onActionBarOpen(function(){i.removeCallback(a),i.removeCallback(r),e.end()});t.empty(),n.empty(),o.empty(),this.navgationService=new c({frameWindow:this.getFrameWindow(),setSelectionCallBack:function(i){e._contextualMenu&&e._contextualMenu.setSelected(i)},speedSliderCB:this.speedSliderCB});var s=!1;"ontouchstart"in document.documentElement&&(s=!0),this.displayRightContextualMenu(!0,s),this.navgationService.beginNavigation({touchMode:s})},endExecute:function(){this.showImFrame(),d.unsubscribe(this.flywalkWidgetFullscreenDisable),d.unsubscribe(this.flywalkWidgetFullscreenEnable),this.navgationService.endNavigation(),this.navgationService=void 0,this.distroySpeedSlider(),this.displayWalkHeightSlider(!1),this.displayRightContextualMenu(!1);var e=this.getFrameWindow().getActionBar();e.open(),e.MAB&&e.MAB.showFlyout(0)},displayRightContextualMenu:function(e,i){var t=this;if(e){this._contextualMenu=new s({frameWindow:this.getFrameWindow(),UIHandlerCB:this.calculateSliderPosition.bind(this)});var n=[{type:t._contextualMenu.Button.Radio,onclickCB:function(e){l.command("Flywalk-"+e.id),"Fly"===e.id&&"Fly"!=t.navgationService.NAVIGATION_MODE?(t.navgationService.NAVIGATION_MODE="Fly",t.displayWalkHeightSlider(!1),t.hideSpeedSlider()):"Walk"===e.id&&"Walk"!=t.navgationService.NAVIGATION_MODE&&(t.navgationService.NAVIGATION_MODE="Walk",t.hideSpeedSlider(),t.displayWalkHeightSlider(!0),t.navgationService.centerToObject(),t.levelViewPointwithGround())},content:[{id:"Fly",rsc:"3DPlayNavigationScenario/3DPlayNavigationScenario",nls:"3DPlayNavigationScenario/3DPlayNavigationScenario",selected:"Fly"===t.navgationService.NAVIGATION_MODE},{id:"Walk",rsc:"3DPlayNavigationScenario/3DPlayNavigationScenario",nls:"3DPlayNavigationScenario/3DPlayNavigationScenario",selected:"Walk"===t.navgationService.NAVIGATION_MODE}]},{type:t._contextualMenu.Button.Check,onclickCB:function(e){e.state?(l.command("Flywalk-Ground"),t.hideSpeedSlider(),console.log("Ground Level"),t.levelViewPointwithGround(),t.uncheck=e.uncheck,setTimeout(function(){t.uncheck()},1e3)):console.log("Deletion of the settings panel")},id:"GroundLevel",rsc:"3DPlayNavigationScenario/3DPlayNavigationScenario",nls:"3DPlayNavigationScenario/3DPlayNavigationScenario"},{type:t._contextualMenu.Button.Check,onclickCB:function(e){t.speedSlider=e,l.command("Flywalk-Setting"),e.state?(console.log("Creation of the settings panel"),t.createSpeedSlider()):(console.log("Deletion of the settings panel"),t.hideSpeedSlider())},id:"SpeedSettings",rsc:"3DPlayNavigationScenario/3DPlayNavigationScenario",nls:"3DPlayNavigationScenario/3DPlayNavigationScenario"},{type:t._contextualMenu.Button.Master,id:"ExitNavigation",rsc:"3DPlayNavigationScenario/3DPlayNavigationScenario",nls:"3DPlayNavigationScenario/3DPlayNavigationScenario",onclickCB:function(){t.end()}},{type:t._contextualMenu.Button.MasterCheck,onclickCB:function(e){"Walk"===t.navgationService.NAVIGATION_MODE&&t.reloadWalkMode(),t.distroySpeedSlider(),!1===e.state?(t.navgationService.endTouchModeNavigation(),t.navgationService.beginMouseModeNavigation()):(t.navgationService.endMouseModeNavigation(),t.navgationService.beginTouchModeNavigation())},id:"TouchMode",rsc:"3DPlayNavigationScenario/3DPlayNavigationScenario",nls:"3DPlayNavigationScenario/3DPlayNavigationScenario",selected:!0===i}];n=n.filter(function(e){if(0!==Object.keys(e).length)return e}),this._contextualMenuToken=this._contextualMenu.addButtons(n,{barType:this._contextualMenu.Toolbar.New,showContextBarBackground:!0})}else this._contextualMenu.removeButtons(this._contextualMenuToken),this._contextualMenu.dispose(),this._contextualMenu=void 0},displayWalkHeightSlider:function(e){var i=this;if(e){var t=this.getFrameWindow().getActionBar();t.MAB&&t.MAB.state&&1==t.MAB.state.visible?this._sliderMainContainer=UWA.createElement("div",{id:"PlayWeb-slider-container_MAB","pointer-events":"none"}).inject(this.getFrameWindow().getUIFrame()):this._sliderMainContainer=UWA.createElement("div",{id:"PlayWeb-slider-container","pointer-events":"none"}).inject(this.getFrameWindow().getUIFrame()),this._walkSlider=new a({minValue:-100,maxValue:100,stepValue:1,value:i.navgationService._heightConstraint,displayStyle:"vertical"}).inject(this._sliderMainContainer),this._walkSlider.addEventListener("change",function(e){e.preventDefault&&e.preventDefault(),e.cancelBubble=!0;var t=e.dsModel;i.navgationService._heightConstraint=t.value,i.navgationService.updateHeight()}),this.adjustSliderwithPanel()}else this.distroyWalkSlider()},distroyWalkSlider:function(){this._sliderMainContainer&&this._sliderMainContainer.destroy(),this._sliderMainContainer=void 0,this._walkSlider&&this._walkSlider.destroy(),this._walkSlider=void 0,this.navgationService&&(this.navgationService._heightConstraint=0,this.navgationService._previousHeight=0)},reloadWalkMode:function(){this.distroyWalkSlider(),this.distroySpeedSlider(),this.displayWalkHeightSlider(!0),this.navgationService.centerToObject(),this.levelViewPointwithGround()},createSpeedSlider:function(){var e=this;if(!this._speedSliderMainContainer){var i=this.getFrameWindow().getActionBar();i.MAB&&i.MAB.state&&1==i.MAB.state.visible?this._speedSliderMainContainer=UWA.createElement("div",{id:"PlayWeb-speed-slider-container_MAB","pointer-events":"none"}).inject(this.getFrameWindow().getUIFrame()):this._speedSliderMainContainer=UWA.createElement("div",{id:"PlayWeb-speed-slider-container","pointer-events":"none"}).inject(this.getFrameWindow().getUIFrame()),this._speedSlider=new a({minValue:1,maxValue:100,stepValue:1,value:e.navgationService._navigationState.speed,displayStyle:"vertical"}).inject(this._speedSliderMainContainer),this._speedSlider.addEventListener("change",function(i){i.preventDefault&&i.preventDefault(),i.stopPropagation&&i.stopPropagation(),i.cancelBubble=!0;var t=i.dsModel;e.navgationService.setSpeed(t.value)})}e.showSpeedSlider()},adjustSliderwithPanel:function(){this._contextualMenu.panel.freeZoneResize()},calculateSliderPosition:function(e){function i(i){var t;t=e+73,i.setStyles({right:t+"px"})}this._speedSliderMainContainer&&i(this._speedSliderMainContainer),this._sliderMainContainer&&i(this._sliderMainContainer)},hideSpeedSlider:function(){this.speedSlider&&this.speedSlider.state&&(this.speedSlider.uncheck(),this.speedSlider.state=!1),this._speedSliderMainContainer&&this._speedSliderMainContainer.hide(),this._walkSlider&&this.navgationService&&"Walk"==this.navgationService.NAVIGATION_MODE&&(this._sliderMainContainer.show(),this._walkSlider.show())},showSpeedSlider:function(){this._walkSlider&&(this._sliderMainContainer.hide(),this._walkSlider.hide()),this.adjustSliderwithPanel(),this._speedSliderMainContainer.show()},distroySpeedSlider:function(){this.hideSpeedSlider(),this._speedSliderMainContainer&&this._speedSliderMainContainer.destroy(),this._speedSliderMainContainer=void 0,this._speedSlider&&this._speedSlider.destroy(),this._speedSlider=void 0},speedSliderCB:function(e){v._speedSlider&&(v._speedSlider.value=e)},levelViewPointwithGround:function(){this.navgationService.levelViewPointwithGround()},alignAndReframeNavigation:function(){var e=this;e.navgationService.levelViewPointwithGround(),setTimeout(function(){e.navgationService.centerToObject()},1800)},reframeNavigation:function(){this.navgationService.centerToObject()}})});