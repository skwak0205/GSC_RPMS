define("DS/CATW3DRobot/CATC3DRobotSnapPanel",["UWA/Core","UWA/Class","DS/Windows/Panel","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/Controls/LineEditor","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/Controls/Button","DS/ApplicationFrame/CommandsManager","css!DS/CATW3DRobot/CATW3DRobot"],function(e,t,n,i,o,a,r,l,s,u,c,d){"use strict";return t.extend({init:function(t){var g=t.immersiveFrame,p=i.get(),m=p._viewer.getRobot(),v=p._viewer,h=s.giveMoveManager({context:p}),b=new e.Element("div"),f=new r({});f.elements.inputField.setStyles({height:"0px",border:"0px"}),f.elements.container.setStyles({fontSize:"0px"}),f.inject(b);var x=new e.Element("div",{html:"<b>Translation</b>"}).inject(b),M=new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(x),y=new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(x),C=new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(x);new e.Element("div",{html:"<b>Rotation</b>"}).inject(x).setStyles({"padding-top":"10px"});var w=new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(x),P=new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(x),V=new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(x),F=u.getPreferenceManager({context:p.getFrameWindow()}),R=0;const E=new Map;E.set(0,0),E.set(1,0),E.set(2,0);var A,S,T,D,U=new o.Vector3,X=new o.Vector3,I=new o.Vector3,Y=v.getMousePosition(a._items[0].event.from[0].getCurrentPosition()),L=this,Z=0,_=0,B=0,O=0,W=0,N=0,k=1,G=0,j=0,z=0,H=0;new e.Element("span",{text:"U|X:"}).inject(M),L.X=new r({value:"0 "+l.getCurrentUnit("length").unit,units:l.getCurrentUnit("length").unit,selectAllOnFocus:!0}),L.X.elements.container.setStyles({width:"-webkit-fill-available",position:"absolute","margin-left":"30px","margin-right":"10px"}),L.X.inject(M),new e.Element("span",{text:"V|Y:"}).inject(y),L.Y=new r({value:"0 "+l.getCurrentUnit("length").unit,units:l.getCurrentUnit("length").unit,selectAllOnFocus:!0}),L.Y.elements.container.setStyles({width:"-webkit-fill-available",position:"absolute","margin-left":"30px","margin-right":"10px"}),L.Y.inject(y),new e.Element("span",{text:"W|Z:"}).inject(C),L.Z=new r({value:"0 "+l.getCurrentUnit("length").unit,units:l.getCurrentUnit("length").unit,selectAllOnFocus:!0}),L.Z.elements.container.setStyles({width:"-webkit-fill-available",position:"absolute","margin-left":"30px","margin-right":"10px"}),L.Z.inject(C),new e.Element("span",{text:"W:"}).inject(V);var q=new r({value:"0 "+l.getCurrentUnit("angle").unit,units:l.getCurrentUnit("angle").unit,minValue:0,maxValue:360,selectAllOnFocus:!0});q.elements.container.setStyles({width:"-webkit-fill-available",position:"absolute","margin-left":"30px","margin-right":"10px"}),q.inject(V),new e.Element("span",{text:"U:"}).inject(w);var K=new r({value:"0 "+l.getCurrentUnit("angle").unit,units:l.getCurrentUnit("angle").unit,minValue:0,maxValue:360,selectAllOnFocus:!0});K.elements.container.setStyles({width:"-webkit-fill-available",position:"absolute","margin-left":"30px","margin-right":"10px"}),K.inject(w),new e.Element("span",{text:"V:"}).inject(P);var J=new r({value:"0 "+l.getCurrentUnit("angle").unit,units:l.getCurrentUnit("angle").unit,minValue:0,maxValue:360,selectAllOnFocus:!0});J.elements.container.setStyles({width:"-webkit-fill-available",position:"absolute","margin-left":"30px","margin-right":"10px"}),J.inject(P);var Q=new c({label:"Save",emphasize:"primary",disabled:!0,showLabelFlag:!0}).inject(x);Q.elements.button.setStyles({margin:"8px"});var $=new c({label:"Cancel",emphasize:"secondary",showLabelFlag:!0}).inject(x),ee=function(e,t,n){e._modelEvent.publish({event:"LineTranslationBegin",data:{eventChannel:"LineTranslationBegin",target:e.target,intersection:t,manipulator:n}})},te=function(e,t,n,i,a){e._modelEvent.publish({event:"LineTranslationManipulation",data:{eventChannel:"LineTranslationManipulation",target:e.target,translationVector:t,intersection:n,manipulator:i,FromPanel:a}}),e.setMatrix((new o.Matrix4).copy(e.getMatrix()).setPosition((new o.Vector3).getPositionFromMatrix(e.getMatrix()).add(t))),R=1},ne=function(e,t,n,i){e._modelEvent.publish({event:"LineTranslationEnd",data:{eventChannel:"LineTranslationEnd",target:e.target,intersection:t,manipulator:n,FromPanel:i}})},ie=function(e,t,n,i){e._modelEvent.publish({event:"RotationBegin",data:{eventChannel:"RotationBegin",target:e.target,intersection:t,manipulator:n,angle:event.dsModel.value,axis:i}})},oe=function(e,t,n,i,a,r){e._modelEvent.publish({event:"RotationManipulation",data:{eventChannel:"RotationManipulation",target:e.target,intersection:t,manipulator:n,angle:a,axis:i,FromPanel:r}});var l=(new o.Matrix4).makeRotationAxis(i,a).multiply((new o.Matrix4).extractRotation(e.getMatrix()));m.setMatrix(l.setPosition((new o.Vector3).getPositionFromMatrix(e.getMatrix()))),R=1},ae=function(e,t){e._modelEvent.publish({event:"RotationEnd",data:{eventChannel:"RotationEnd",target:e.target,fromPanel:t}})},re=function(e,t,n){var i=e;return i.manipulatedPaths=[],i.manipulatedPaths[0]={externalPath:[],internalPath:[]},i.manipulatedPaths[0].externalPath[0]={name:t},i.axis=n,i},le=function(e,t,n){(isNaN(e.dsModel.valueToCommit)||0===a._items.length||0===e.dsModel.valueToCommit.length)&&(1===e.dsModel.valueToCommit.length&&45===e.dsModel.valueToCommit[0].hashCode()||(t.value=n))},se=function(e,t,n){(isNaN(e.dsModel.valueToCommit)||0===e.dsModel.valueToCommit.length||0===a._items.length||parseInt(e.dsModel.valueToCommit)>=360)&&(t.value===n&&(t.value=n+1),t.value=n)},ue=function(e){var t;return"mm"===e?(t=Math.pow(10,0),G=3):"cm"===e?(t=Math.pow(10,-1),G=4):"m"===e?(t=Math.pow(10,-3),G=6):"km"===e?(t=Math.pow(10,-6),G=9):"inch"===e?(t=1/25.4,G=4):"foot"===e?(t=1/304.8,G=5):"rad"===e?(t=Math.PI/180,j=2):"deg"===e&&(t=1,j=2),t};L.X.addEventListener("focus",function(e){if(!O){var t=m.getMatrix();Z=parseFloat(e.dsModel.value),t.extractBasis(U,X,I);var n=v.pick(Y,"mesh",!0),i=re(m.arrowX,"arrowX",U);m&&(ee(m,n,i),ne(m,n,i,!0))}}),L.X.addEventListener("uncommittedChange",function(e){O||le(e,L.X,Z)}),L.X.addEventListener("change",function(e){if(!O&&e.dsModel._isCurrentlyCalledFromUIInteraction()){m.getMatrix().extractBasis(U,X,I);var t=v.pick(Y,"mesh",!0),n=re(m.arrowX,"arrowX",U),i=(new o.Vector3).copy(U).setLength((e.dsModel.value-Z)/k);Z=parseFloat(L.X.value),m&&(ee(m,t,n),te(m,i,t,n,!0),O=1,L.X.value+=" "+l.getCurrentUnit("length").unit,O=0,ne(m,t,n,!0))}}),L.Y.addEventListener("focus",function(e){if(!O){var t=m.getMatrix();_=parseFloat(e.dsModel.value),t.extractBasis(U,X,I);var n=v.pick(Y,"mesh",!0),i=re(m.arrowY,"arrowY",X);m&&(ee(m,n,i),ne(m,n,i,!0))}}),L.Y.addEventListener("uncommittedChange",function(e){O||le(e,L.Y,_)}),L.Y.addEventListener("change",function(e){if(!O&&e.dsModel._isCurrentlyCalledFromUIInteraction()){m.getMatrix().extractBasis(U,X,I);var t=v.pick(Y,"mesh",!0),n=re(m.arrowY,"arrowY",X),i=(new o.Vector3).copy(X).setLength((e.dsModel.value-_)/k);_=parseFloat(e.dsModel.value),m&&(ee(m,t,n),te(m,i,t,n,!0),O=1,L.Y.value+=" "+l.getCurrentUnit("length").unit,O=0,ne(m,t,n,!0))}}),L.Z.addEventListener("focus",function(){if(!O){var e=m.getMatrix();B=parseFloat(event.dsModel.value),e.extractBasis(U,X,I);var t=v.pick(Y,"mesh",!0),n=re(m.arrowZ,"arrowZ",I);m&&(ee(m,t,n),ne(m,t,n,!0))}}),L.Z.addEventListener("uncommittedChange",function(e){O||le(e,L.Z,B)}),L.Z.addEventListener("change",function(e){if(!O&&e.dsModel._isCurrentlyCalledFromUIInteraction()){m.getMatrix().extractBasis(U,X,I);var t=v.pick(Y,"mesh",!0),n=re(m.arrowZ,"arrowZ",I),i=(new o.Vector3).copy(I).setLength((e.dsModel.value-B)/k);B=parseFloat(e.dsModel.value),m&&(ee(m,t,n),te(m,i,t,n,!0),O=1,L.Z.value+=" "+l.getCurrentUnit("length").unit,O=0,ne(m,t,n,!0))}}),q.addEventListener("focus",function(){if(!O){"RotXY"!==D&&("RotXZ"!==D&&"RotYZ"!==D||(O=1,q.value="0 "+l.getCurrentUnit("angle").unit,E.set(0,0),O=0)),m.getMatrix().extractBasis(U,X,I);var e=v.pick(Y,"mesh",!0),t=m.rotationArcXY;m&&(ie(m,e,t,I),ae(m,!0),D="RotXY")}}),q.addEventListener("uncommittedChange",function(e){O||se(e,q,E.get(0))}),q.addEventListener("change",function(e){if(!O&&e.dsModel._isCurrentlyCalledFromUIInteraction()){m.getMatrix().extractBasis(U,X,I);var t=v.pick(Y,"mesh",!0),n=m.rotationArcXY,i=(e.dsModel.value*Math.PI/180-E.get(0)*Math.PI/180)/T;E.set(0,e.dsModel.value),m&&(ie(m,t,n,I),oe(m,t,n,I,i,!0),O=1,q.value+=" "+l.getCurrentUnit("angle").unit,O=0,ae(m,!0),D="RotXY")}}),K.addEventListener("focus",function(){if(!O){"RotYZ"!==D&&("RotXZ"!==D&&"RotXY"!==D||(O=1,K.value="0 "+l.getCurrentUnit("angle").unit,E.set(1,0),O=0)),m.getMatrix().extractBasis(U,X,I);var e=v.pick(Y,"mesh",!0),t=m.rotationArcYZ;m&&(ie(m,e,t,U),ae(m,!0),D="RotYZ")}}),K.addEventListener("uncommittedChange",function(e){O||se(e,K,E.get(1))}),K.addEventListener("change",function(e){if(!O&&e.dsModel._isCurrentlyCalledFromUIInteraction()){m.getMatrix().extractBasis(U,X,I);var t=v.pick(Y,"mesh",!0),n=m.rotationArcYZ,i=(e.dsModel.value*Math.PI/180-E.get(1)*Math.PI/180)/T;E.set(1,e.dsModel.value),m&&(ie(m,t,n,U),oe(m,t,n,U,i,!0),O=1,K.value+=" "+l.getCurrentUnit("angle").unit,O=0,ae(m,!0),D="RotYZ")}}),J.addEventListener("focus",function(){if(!O){"RotXZ"!==D&&("RotYZ"!==D&&"RotXY"!==D||(O=1,J.value="0 "+l.getCurrentUnit("angle").unit,E.set(2,0),O=0)),m.getMatrix().extractBasis(U,X,I);var e=v.pick(Y,"mesh",!0),t=m.rotationArcXZ;m&&(ie(m,e,t,X),ae(m,!0),D="RotXZ")}}),J.addEventListener("uncommittedChange",function(e){O||se(e,J,E.get(2))}),J.addEventListener("change",function(e){if(!O&&e.dsModel._isCurrentlyCalledFromUIInteraction()){m.getMatrix().extractBasis(U,X,I);var t=v.pick(Y,"mesh",!0),n=m.rotationArcXZ,i=(e.dsModel.value*Math.PI/180-E.get(2)*Math.PI/180)/T;E.set(2,e.dsModel.value),m&&(ie(m,t,n,X),oe(m,t,n,X,i,!0),O=1,J.value+=" "+l.getCurrentUnit("angle").unit,O=0,ae(m,!0),D="RotXZ")}});t._robot._rulerformed(function(e){if(O=1,"arrowX"===e.direction){let t=m.getMatrix().getPosition().x-e.cposition.x;Z=(t*k).toFixed(G),L.X.value=(t*k).toFixed(G),L.X._myInput.select()}else if("arrowY"===e.direction){let t=m.getMatrix().getPosition().y-e.cposition.y;_=(t*k).toFixed(G),L.Y.value=(t*k).toFixed(G),L.Y._myInput.select()}else if("arrowZ"===e.direction){let t=m.getMatrix().getPosition().z-e.cposition.z;B=(t*k).toFixed(G),L.Z.value=(t*k).toFixed(G),L.Z._myInput.select()}O=0}),t._robot.rulerCB(function(e){"RulerManipulate"===e.eventName?e.direction.x.toFixed(3)===m.arrowX.manipulator.axis.x.toFixed(3)?(O=1,Z=(e.value*k).toFixed(G),L.X.value=(e.value*k).toFixed(G)+" "+l.getCurrentUnit("length").unit,L.X._myInput.select(),O=0):e.direction.y.toFixed(3)===m.arrowY.manipulator.axis.y.toFixed(3)?(O=1,_=(e.value*k).toFixed(G),L.Y.value=(e.value*k).toFixed(G)+" "+l.getCurrentUnit("length").unit,L.Y._myInput.select(),O=0):e.direction.z.toFixed(3)===m.arrowZ.manipulator.axis.z.toFixed(3)&&(O=1,B=(e.value*k).toFixed(G),L.Z.value=(e.value*k).toFixed(G)+" "+l.getCurrentUnit("length").unit,L.Z._myInput.select(),O=0):"AngularRulerManipulate"===e.eventName?e.direction.z.toFixed(3)===m.rotationArcXY.axis.z.toFixed(3)?(O=1,q.value=((e.diffAngle+E.get(0))*T).toFixed(j)+" "+l.getCurrentUnit("angle").unit,E.set(0,e.diffAngle+E.get(0)),q._myInput.select(),O=0):e.direction.x.toFixed(3)===m.rotationArcYZ.axis.x.toFixed(3)?(O=1,K.value=((e.diffAngle+E.get(1))*T).toFixed(j)+" "+l.getCurrentUnit("angle").unit,E.set(1,e.diffAngle+E.get(1)),K._myInput.select(),O=0):e.direction.y.toFixed(3)===m.rotationArcXZ.axis.y.toFixed(3)&&(O=1,J.value=((e.diffAngle+E.get(2))*T).toFixed(j)+" "+l.getCurrentUnit("angle").unit,E.set(2,e.diffAngle+E.get(2)),J._myInput.select(),O=0):"AngularRulerManipulateBegin"===e.eventName&&(e.direction.z.toFixed(3)===m.rotationArcXY.axis.z.toFixed(3)?(q.value=(e.value*T).toFixed(j),E.set(0,e.value),D="RotXY"):e.direction.x.toFixed(3)===m.rotationArcYZ.axis.x.toFixed(3)?(K.value=(e.value*T).toFixed(j),E.set(1,e.value),D="RotYZ"):e.direction.y.toFixed(3)===m.rotationArcXZ.axis.y.toFixed(3)&&(J.value=(e.value*T).toFixed(j),E.set(2,e.value),D="RotXZ"))}),t._robot.manipCB(function(e){switch(e.Rulerchannel){case"LineTranslationManipulation":A=e.Rulervalue,e.Rulersource||(e.Rulerdirection.x.toFixed(3)===m.arrowX.manipulator.axis.x.toFixed(3)?(O=1,Z=(A*k).toFixed(G),L.X.value=(A*k).toFixed(G)+" "+l.getCurrentUnit("length").unit,L.X._myInput.select(),O=0):e.Rulerdirection.y.toFixed(3)===m.arrowY.manipulator.axis.y.toFixed(3)?(O=1,_=(A*k).toFixed(G),L.Y.value=(A*k).toFixed(G)+" "+l.getCurrentUnit("length").unit,L.Y._myInput.select(),O=0):e.Rulerdirection.z.toFixed(3)===m.arrowZ.manipulator.axis.z.toFixed(3)&&(O=1,B=(A*k).toFixed(G),L.Z.value=(A*k).toFixed(G)+" "+l.getCurrentUnit("length").unit,L.Z._myInput.select(),O=0));break;case"RotationBegin":e.Rulersource||(e.Rulerdirection.z.toFixed(3)===m.rotationArcXY.axis.z.toFixed(3)&&"RotXY"!==D&&(O=1,q.value="0 "+l.getCurrentUnit("angle").unit,q._myInput.select(),E.set(0,0),O=0),e.Rulerdirection.x.toFixed(3)===m.rotationArcYZ.axis.x.toFixed(3)&&"RotYZ"!==D&&(O=1,K.value="0 "+l.getCurrentUnit("angle").unit,K._myInput.select(),E.set(1,0),O=0),e.Rulerdirection.y.toFixed(3)===m.rotationArcXZ.axis.y.toFixed(3)&&"RotXZ"!==D&&(O=1,J.value="0 "+l.getCurrentUnit("angle").unit,J._myInput.select(),E.set(2,0),O=0));break;case"RotationManipulation":A=e.Rulervalue,e.Rulersource||(e.Rulerdirection.z.toFixed(3)===m.rotationArcXY.axis.z.toFixed(3)?(O=1,q.value=(A*T).toFixed(j)+" "+l.getCurrentUnit("angle").unit,E.set(0,A),q._myInput.select(),O=0,D="RotXY"):e.Rulerdirection.x.toFixed(3)===m.rotationArcYZ.axis.x.toFixed(3)?(O=1,K.value=(A*T).toFixed(j)+" "+l.getCurrentUnit("angle").unit,E.set(1,A),K._myInput.select(),O=0,D="RotYZ"):e.Rulerdirection.y.toFixed(3)===m.rotationArcXZ.axis.y.toFixed(3)&&(O=1,J.value=(A*T).toFixed(j)+" "+l.getCurrentUnit("angle").unit,E.set(2,A),J._myInput.select(),O=0,D="RotXZ"));break;case"PlaneTranslationManipulation":var n=(new o.Vector3).getPositionFromMatrix(m.getMatrix()),i=(new o.Vector3).copy(m.arrowX.manipulator.axis).multiplyScalar((new o.Vector3).copy(t.robotP).sub(n).dot(m.arrowX.manipulator.axis)),a=(new o.Vector3).copy(m.arrowY.manipulator.axis).multiplyScalar((new o.Vector3).copy(t.robotP).sub(n).dot(m.arrowY.manipulator.axis)),r=(new o.Vector3).copy(m.arrowZ.manipulator.axis).multiplyScalar((new o.Vector3).copy(t.robotP).sub(n).dot(m.arrowZ.manipulator.axis));O=1,W=(new o.Vector3).copy(n).add(i);var s=(new o.Vector3).copy(W).sub(n).dot(m.arrowX.manipulator.axis);N=W.distanceTo(n)*(s>0?-1:1),Z=(N*k).toFixed(G),L.X.value=(N*k).toFixed(G)+" "+l.getCurrentUnit("length").unit,W=(new o.Vector3).copy(n).add(a),s=(new o.Vector3).copy(W).sub(n).dot(m.arrowY.manipulator.axis),N=W.distanceTo(n)*(s>0?-1:1),_=(N*k).toFixed(G),L.Y.value=(N*k).toFixed(G)+" "+l.getCurrentUnit("length").unit,W=(new o.Vector3).copy(n).add(r),s=(new o.Vector3).copy(W).sub(n).dot(m.arrowZ.manipulator.axis),N=W.distanceTo(n)*(s>0?-1:1),B=(N*k).toFixed(G),L.Z.value=(N*k).toFixed(G)+" "+l.getCurrentUnit("length").unit,0===e.vector.x?L.Y._myInput.select():L.X._myInput.select(),O=0}}),k=ue(l.getCurrentUnit("length").unit),T=ue(l.getCurrentUnit("angle").unit),F.subscribe("onBeforeChangingPreferences",function(){z=ue(l.getCurrentUnit("length").unit),H=ue(l.getCurrentUnit("angle").unit)}),F.subscribe("onAfterChangingPreferences",function(){"string"==typeof(S=l.getCurrentUnit("length").unit)&&(k=ue(S),T=ue(l.getCurrentUnit("angle").unit),O=1,L.X.value=(Z*k/z).toFixed(G)+" "+l.getCurrentUnit("length").unit,L.Y.value=(_*k/z).toFixed(G)+" "+l.getCurrentUnit("length").unit,L.Z.value=(B*k/z).toFixed(G)+" "+l.getCurrentUnit("length").unit,K.value=(parseFloat(K.value)*T/H).toFixed(j)+" "+l.getCurrentUnit("angle").unit,q.value=(parseFloat(q.value)*T/H).toFixed(j)+" "+l.getCurrentUnit("angle").unit,J.value=(parseFloat(J.value)*T/H).toFixed(j)+" "+l.getCurrentUnit("angle").unit,O=0)});var ce=d.getCommand("CAT3DComposeMoveHdr",i.get()._context);ce&&ce.isRunning()&&(R=1);var de=this._panel=new n({immersiveFrame:g,content:b,icon:{iconName:"part-position wux-ui-3ds",fontIconFamily:WUXManagedFontIcons.Font3DS},visibleFlag:!0,minWidth:170,height:"auto",maxHeight:660,currentDockArea:8,allowedDockAreas:15,position:{my:"right",at:"right",of:g},collapsibleFlag:!1,verticallyStretchableFlag:!0,closeButtonFlag:!1,resizableFlag:!0,activeFlag:!1}),ge=function(){Z=0,_=0,B=0,O=0,E.set(0,0),E.set(1,0),E.set(2,0)};m.subscribe("ScreenPlaneTranslationBegin",function(){de.destroy(),ge()}),m.subscribe("ScreenPlaneTranslationEnd",function(){de.destroy(),ge()}),h.subscribe("onCancelMove",function(){de.destroy(),ge()}),h.subscribe("onValidateMove",function(){ce&&ce.end(),de.destroy(),ge()}),h.subscribe("Move",function(){R=1,Q.disabled=!1}),Q.addEventListener("buttonclick",function(){h.terminateMove({save:!0})}),$.addEventListener("buttonclick",function(){if(R)h.terminateMove({save:!1}),(ce=d.getCommand("CAT3DComposeMoveHdr",i.get()._context))&&ce.end();else{var e=d.getCommand("CAT3DComposeRobotSnapMoveHdr",i.get()._context),t=d.getCommand("CAT3DComposeWidgetDefaultHdr",i.get()._context);e._isRunning?e.end():t.end(),de.destroy(),ge()}});let pe=function(e){let t=e.which||e.keyCode;27===t?de&&(de.destroy(),ge(),document.body.removeEventListener("keydown",pe)):13===t?de&&R&&(de.destroy(),ge(),document.body.removeEventListener("keydown",pe)):9!==t||de.activeFlag||(de.activeFlag=!0)};document.body.addEventListener("keydown",pe)}})}),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATW3DRobot/CATW3DRobot",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Robot/FreeRobot","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/MeshUtils","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CoreEvents/Events","DS/Visualization/Node3D","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CoreEvents/ModelEvents","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/Visualization/PathElement","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATW3DUtils/CATW3DUtils","DS/CATW3DRobot/CATC3DRobotSnapPanel"],function(e,t,n,i,o,a,r,l,s,u,c,d,g,p,m,v,h,b,f,x,M){"use strict";var y=150,C=150,w=function(e){if(!e||!e.externalPath)return!1;for(var t=e.externalPath.length-1;t>=0;--t){var n=e.externalPath[t];if(h.isPLMNode(n))break;if("AxisSystems"===n.name)return!0}return!1},P=function(e){var t=[];return o.get().forEach(function(n){var i=e.getMoveReferent(n.pathElement);i&&t.push({path:i})}),t},V=function(){o.get().forEach(function(e){i.isIn(e)||i.add(e)})},F=function(){o.get().forEach(function(e){i.remove(e)})},R=function(e,t){e.scalingNodeX.setVisibility(!1),e.scalingNodeY.setVisibility(!1),e.scalingNodeZ.setVisibility(!1);var n=!t||!t.hasOwnProperty("translate")||"boolean"!=typeof t.translate||t.translate;e.arrowX.setVisibility(n),e.arrowY.setVisibility(n),e.arrowZ.setVisibility(n),n=!t||!t.hasOwnProperty("rotate")||"boolean"!=typeof t.rotate||t.rotate,e.rotationArcXY.setVisibility(n),e.rotationArcXZ.setVisibility(n),e.rotationArcYZ.setVisibility(n),n=!t||!t.hasOwnProperty("translatePlane")||"boolean"!=typeof t.translatePlane||t.translatePlane,e.translationPlaneXY.setVisibility(n),e.translationPlaneXZ.setVisibility(n),e.translationPlaneYZ.setVisibility(n),n=!t||!t.hasOwnProperty("robotMove")||"boolean"!=typeof t.robotMove||t.robotMove,e.robotHandle.setVisibility(n)},E=e.extend({init:function(e){var E,A,S,T=e.context,D=T.getFrameWindow(),U=T.getViewer(),X=m.giveMoveManager({context:T}),I=p.getMoveReferentManager({context:T}),Y=s.getConstraintsController({context:T}),L=D.getContextualUIManager(),Z="",_=new g,B=this,O=0,W=new t.Vector3,N=function(e){var n={},i=null;if(e.translationVector)i=Y.simulateMoveWithCst({translation:e.translationVector});else if(e.rotationMatrix){var o=[[e.rotationMatrix.elements[0],e.rotationMatrix.elements[4],e.rotationMatrix.elements[8]],[e.rotationMatrix.elements[1],e.rotationMatrix.elements[5],e.rotationMatrix.elements[9]],[e.rotationMatrix.elements[2],e.rotationMatrix.elements[6],e.rotationMatrix.elements[10]]];i=Y.simulateMoveWithCst({rotation:o})}if(i&&i.matrix){var a=(new t.Matrix4).multiplyMatrices(i.matrix,e.objectMoved.path.getWorldMatrix());n.worldMatrix=a}return n},k=function(){var e=o.get();(e.length>1||Y.count()>0&&1===e.length&&!Y.isLevelConstrained(I.getMoveReferent(e[0].pathElement)))&&Y.deleteAllCst()},G=!0,j={};if(D)if(T)if(X)if(I){U.setRobot(!0,{snapOnFace:!1,showOnlyManipulated:!1});var z=U.getRobot();R(z),z.setAddToCSO(!1),z.setAddToHSO(!1),z.setDisplayScalingNodes(!1),z.setMoveMode("CALLBACK_ONLY"),z.setCheckTarget(!1),z.CallBackEventHandlerViewPoint();var H,q,K,J,Q,$,ee,te,ne,ie,oe=[],ae=[],re=[],le={},se=null,ue=null,ce=[],de=[],ge={origin:new t.Vector3,initOrigin:new t.Vector3,direction:null,initValue:null,value:null},pe={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null},me=!1,ve=null,he=function(){ae.length||(ae.push(X.subscribe("MoveBegin",function(){Q=z.getMatrix(),J=(new t.Matrix4).getInverse(q.getWorldMatrix()).multiply(Q)})),ae.push(X.subscribe("Move",function(e){if(J&&Q){if(e.from===le)return;if(Ne(),this.isVisible()&&this.setVisibility(!1),"Persistent"===e.moveMode){var t=q.getWorldMatrix().multiply(J);z.setMatrix(t)}}}.bind(this))),ae.push(X.subscribe("MoveEnd",function(e){if(J&&Q){if("Cancelled"===e.status&&z.setRobotMatrix(Q),e.from===le)return;if(this.setVisibility(!0),"Moved"===e.status){var t=q.getWorldMatrix().multiply(J);z.setRobotMatrix(t)}ve={},J=Q=void 0}}.bind(this))))}.bind(this),be=function(){ae.forEach(function(e){X.unsubscribe(e)}),ae.length=0},fe=function(e){var t=null,n=T.getRootBagPath().getLastElement(!0);return e.some(function(e){return!!e.externalPath.some(function(e){return n===e})&&(t=e,!0)}),t},xe=function(e,t){var n={pathElement:null},i=T.getRootBagPath().getLastElement(!0);if(i&&e&&e.externalPath&&e.externalPath.some(function(e){return i===e})&&(n.pathElement=e),j.filterPath&&n.pathElement&&t&&t.event){var o=t.event.gesture?t.event.gesture.getEvents()[0]:t.event.from[0],a=U.pick(U.getMousePosition(o.getCurrentPosition(U.canvas)),"primHybrid",!0);(n=j.filterPath({pathElement:fe(a.path)}))&&(n.normal=a.normal)}if(n.pathElement&&!w(n.pathElement)&&!n.pathElement.internalPath.length)for(;!h.isPLMNode(n.pathElement.getLastElement(!0));)n.pathElement=n.pathElement.getParentPath();return n};z.setSnapFilterCallback(function(e){return xe(e).pathElement}),z.setSnapTranslationCallback(function(e){if(0!==P(I).length){if($){var t=$.getSnappedTranslationVector(e);return 0!==t.returnCode?null:t.snappedTranslationVector}return e.translationVector}}),z.setSnapRotationCallback(function(e){if(0===P(I).length)return{};if(ee){var t=ee.getSnappedRotationValue(e);return 0!==t.returnCode?{value:void 0,axis:null}:{value:t.snappedRotationAngle,axis:t.axis}}var n=180*e.angle/Math.PI;return pe.direction.dot(e.axis)<0&&(n=360-n),{value:n,axis:e.axis}});var Me=function(){$&&($.direction=null,$.origin=new t.Vector3,$.origin3DPos=null,$.setValue(0)),ee&&(ee.direction=null,ee.origin=null,ee.originVector=null,ee.setValue(0)),Ne()},ye=new c("RobotLocalAxisSystem"),Ce=new c("RobotPrevisuNode");Ce.exludeFromBounding(!0),Ce.setVisibilityFree(!0),Ce.setVisibilityInTree(!1),Ce.setPickable(l.PICKTHROUGH),Ce.setNoZ(!0),U.addNode(Ce),Ce.updateDisplay=function(e,t,n){Ce.removeChildren(),e&&e.equivalentGeometry&&e.equivalentGeometry.getPrevisuNode&&Ce.addChild(e.equivalentGeometry.getPrevisuNode(t,n))};var we=new r({headLength:10,arrowLength:50,arrowWidth:2,head:r.types.ARROW,colors:{colorX:new l.Color(1,0,0,0),colorY:new l.Color(0,1,0,0),colorZ:new l.Color(0,0,1,0)}});ye.exludeFromBounding(!0),ye.setVisibilityFree(!0),ye.setVisibilityInTree(!1),ye.setPickable(l.PICKTHROUGH),ye.addChild(we),ye.updateDisplay=function(e){if(0===ye.parents.length&&U.addNode(ye),e.visibility&&e.pathElement&&0===e.pathElement.internalPath.length){if(j&&j.getFiltersState&&j.getFiltersState().surface){for(var t,n=e.pathElement.externalPath.length-1;n>=0&&!t;n--)h.isRepReference(e.pathElement.externalPath[n])&&(t=e.pathElement.externalPath[n]);if(t){var i=h.getNodeID(t);if(i&&!T.getController().hasMeshInRAM(i))return}}ye.setMatrix(e.pathElement.getWorldMatrix()),ye.setVisibility(!0)}e.visibility||ye.setVisibility(!1)},ye.updateDisplay({visibility:!1});var Pe=null,Ve=new n("RobotLocalAxisSystem",U,!1,!1);Ve.exludeFromBounding(!0),Ve.setVisibilityFree(!0),Ve.setVisibilityInTree(!1),Ve.setPickable(l.PICKTHROUGH),Ve.setVisibility(!1),R(Ve,{robotMove:!1,translate:!1}),Ve.updateDisplay=function(e){var t,n,i,o;0===Ve.parents.length&&U.addNode(Ve),e.visibility&&e.pathElement&&(Pe&&(clearInterval(Pe),Pe=null),Ve.setMatrix(e.pathElement.getWorldMatrix()),t=Ve.fixedSizeNode3D,n=Pe,i=U,o=4,t.setRatio(o/10),n=setInterval(function(){if(11===o)return clearInterval(n),void(n=null);o++,t.setRatio(4*o/10),i.render()},10),Ve.setVisibility(!0),G&&z.setVisibility(!1)),e.visibility||(clearInterval(Pe),Pe=null,Ve.setVisibility(!1),G&&z.setVisibility(!0))};var Fe,Re,Ee,Ae,Se,Te,De=function(){require(["DS/LevelSelector/LevelSelector"],function(e){e.destroyView()}),L.hideContextualMenus()},Ue=function(){if(De(),q){var e=[{name:"CATW3DRobotLevelSelectorStr",line:1,hdr_list:["CATW3DRobotLevelSelectorHdr"]}];P(I).some(function(e){var t=e.path.getMatrix();return 1!==t.elements[0]||1!==t.elements[5]||1!==t.elements[10]||1!==t.elements[15]||0!==t.elements[1]||0!==t.elements[2]||0!==t.elements[3]||0!==t.elements[4]||0!==t.elements[6]||0!==t.elements[7]||0!==t.elements[8]||0!==t.elements[9]||0!==t.elements[11]||0!==t.elements[12]||0!==t.elements[13]||0!==t.elements[14]})&&e.push({name:"CATW3DSetIdentityPositionStr",line:1,hdr_list:["CATW3DSetIdentityPositionHdr"]}),e.length>0&&L.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:e}},context:T.getCommandContext(),workbenchName:"CATW3DCommands",module:"CATW3DCommands",cmdPrefix:""}]})}},Xe=function(){z.arrowX.mat.opacity=.2,z.arrowY.mat.opacity=.2,z.arrowZ.mat.opacity=.2,z.translationPlaneYZ.planeMat.opacity=.2,z.translationPlaneXY.planeMat.opacity=.2,z.translationPlaneXZ.planeMat.opacity=.2,z.rotationArcYZ.planeMat.opacity=.2,z.rotationArcXZ.planeMat.opacity=.2,z.rotationArcXY.privilegedPlaneMat.opacity=.2},Ie=function(){z.setToNonGhostState()},Ye=function(e){var n,i,o;if(E&&E(e),"RulerManipulateBegin"===e.eventName||"AngularRulerManipulateBegin"===e.eventName){De(),F(q,X),Fe=new t.Vector3,Re=0;var a={objectsMoved:P(I),from:le,moveMode:"Persistent"};"AngularRulerManipulateBegin"===e.eventName&&(ve={},a.axis=(new t.Vector3).copy(e.direction),a.center=(new t.Vector3).getPositionFromMatrix(z.getMatrix())),X.onMoveBegin(a)}else if("RulerManipulate"===e.eventName){if(!(o=P(I)).length)return;k(),n={objectsMoved:o,from:le},e.rulerDragged||V(),Fe.add(e.translationVector),z.setMatrix((new t.Matrix4).copy(Q).setPosition((new t.Vector3).getPositionFromMatrix(Q).add(Fe))),0===Y.count()||0===n.objectsMoved.length?n.vector=Fe:(i=N({translationVector:e.translationVector,objectMoved:n.objectsMoved[0]})).worldMatrix&&(n.worldMatrix=i.worldMatrix),X.onMove(n),U.render()}else if("AngularRulerManipulate"===e.eventName){if(!(o=P(I)).length)return;k(),n={objectsMoved:o,from:le},e.rulerDragged||V();var r=e.diffAngle*Math.PI/180;Re+=r;var l=(new t.Matrix4).makeRotationAxis(e.direction,Re).multiply((new t.Matrix4).extractRotation(Q));z.setMatrix(l.setPosition((new t.Vector3).getPositionFromMatrix(Q))),pe.value=ee.value;var s=(new t.Matrix4).makeRotationAxis(e.direction,r);0===Y.count()||0===n.objectsMoved.length?n.angle=Re:(i=N({rotationMatrix:s,objectMoved:n.objectsMoved[0]})).worldMatrix&&(n.worldMatrix=i.worldMatrix),X.onMove(n),U.render()}else if("RulerManipulateEnd"===e.eventName||"AngularRulerManipulateEnd"===e.eventName){V();var u={from:le,status:"Moved"};"Cancelled"===e.status?u.status="Cancelled":z.setRobotMatrix(z.getMatrix()),X.onMoveEnd(u)}},Le=function(e){if(_.publish({event:"onRobotMoveBegin"}),q){var n;U.setCursor("pointer"),De(),Ne(),O=0,W=new t.Vector3,Z="",F(q,X),n=e.manipulator,[z.arrowX,z.arrowY,z.arrowZ,z.translationPlaneYZ,z.translationPlaneXY,z.translationPlaneXZ,z.rotationArcYZ,z.rotationArcXZ,z.rotationArcXY].forEach(function(e){e&&e.manipulator&&e.manipulator!==n&&e.setToGhostState()}),z.robotHandle.setToGhostState();var i,o={objectsMoved:P(I),from:le,moveMode:"Persistent"};if("LineTranslationBegin"===e.eventChannel){for(var a=0;a<e.manipulator.manipulatedPaths[0].externalPath.length;a++)if(e.manipulator.manipulatedPaths[0].externalPath[a].name.startsWith("arrow")){Z=e.manipulator.manipulatedPaths[0].externalPath[a].name;break}i=(new t.Vector3).copy(e.manipulator.axis);var r=(new t.Vector3).getPositionFromMatrix(z.getMatrix()),l=(new t.Vector3).copy(i).multiplyScalar((new t.Vector3).copy(ge.baseOrigin).sub(r).dot(i));ge.initOrigin=(new t.Vector3).copy(r).add(l);var s=(new t.Vector3).copy(ge.initOrigin),u=null;ve&&"string"==typeof Z&&(Z.match("arrowX")&&ve.X3Dpos?u=(new t.Vector3).copy(ve.X3Dpos):Z.match("arrowY")&&ve.Y3Dpos?u=(new t.Vector3).copy(ve.Y3Dpos):Z.match("arrowZ")&&ve.Z3Dpos&&(u=(new t.Vector3).copy(ve.Z3Dpos)),u&&(s=new t.Line3(ge.initOrigin,(new t.Vector3).copy(ge.initOrigin).add(i)).closestPointToPoint(u,!1))),ge.origin=s;var c=(new t.Vector3).copy(ge.origin).sub(r).dot(i);ge.direction=i,ge.value=s.distanceTo(r)*(c>0?-1:1),ge.initValue=ge.value,$&&($.origin=ge.origin,$.origin3DPos=u,$.initOrigin=ge.initOrigin,$.setValue(ge.value),$.direction=ge.direction,$.initValue=ge.initValue,$.displayOrigin=!$.origin.equals($.initOrigin),$.unit=b.getCurrentUnit("length").unit,$.display(),$.beginManipulation())}else if("RotationBegin"===e.eventChannel){ve={},o.center=(new t.Vector3).getPositionFromMatrix(z.getMatrix()),i=(new t.Vector3).copy(e.manipulator.axis);var d={Rulervalue:ee.value,Rulerdirection:i,Rulersource:e.FromPanel,Rulerchannel:e.eventChannel};if(A&&A(d),!pe.direction||0===Math.round(100*i.dot(pe.direction))||!function(){for(var e=new v(q.externalPath);e&&!h.isPLMNode(e.getLastElement(!0));)e=e.getParentPath();if(!pe.path)return pe.path=e,!0;var t=!!e&&e.isEqual(pe.path);return pe.path=e,t}()){var g=new t.Vector3,p=new t.Vector3,m=new t.Vector3;z.getMatrix().extractBasis(g,p,m),g.normalize(),p.normalize();var f=Math.round(100*g.dot(i)),x=Math.round(100*p.dot(i));0===f?pe.originVector=(new t.Vector3).copy(g):0===x&&(pe.originVector=(new t.Vector3).copy(p)),pe.value=0,pe.direction=i}o.axis=(new t.Vector3).copy(pe.direction),pe.origin=(new t.Vector3).getPositionFromMatrix(z.getMatrix()),pe.initValue=pe.value,ee&&(ee.originVector=pe.originVector,ee.setValue(pe.value),ee.origin=pe.origin,ee.direction=pe.direction,ee.initValue=pe.initValue,ee.unit=b.getCurrentUnit("angle").unit,ee.display(),ee.beginManipulation())}X.onMoveBegin(o)}},Ze=function(e){if(q){if(U.setCursor("pointer"),"LineTranslationManipulation"===e.eventChannel){if(ge.value=ge.initValue+e.translationVector.length()*(ge.direction.dot(e.translationVector)>0?1:-1),$){var n={Rulervalue:ge.value,Rulerdirection:ge.direction,Rulersource:e.FromPanel,Rulerchannel:e.eventChannel};A&&A(n),$.setValue(ge.value)}}else if("RotationManipulation"===e.eventChannel){ve={};var i=(new t.Vector3).copy(e.axis),o=pe.direction.dot(i)<0?2*Math.PI-e.angle:e.angle;if(pe.value=pe.initValue+180*o/Math.PI,ee.setValue(pe.value),ee){var a={Rulervalue:ee.value,Rulerdirection:pe.direction,Rulersource:e.FromPanel,Rulerchannel:e.eventChannel};A&&A(a)}}k();var r,l={objectsMoved:P(I),from:le};if(e.translationVector)0===Y.count()||0===l.objectsMoved.length?l.vector=e.translationVector:(r=N({translationVector:(new t.Vector3).subVectors(e.translationVector,W),objectMoved:l.objectsMoved[0]})).worldMatrix&&(l.worldMatrix=r.worldMatrix),W=e.translationVector;else{if(0===Y.count()||0===l.objectsMoved.length)l.angle=e.angle;else{var s=(new t.Matrix4).makeRotationAxis(e.axis,e.angle-O);(r=N({rotationMatrix:s,objectMoved:l.objectsMoved[0]})).worldMatrix&&(l.worldMatrix=r.worldMatrix)}O=e.angle}if("PlaneTranslationManipulation"===e.eventChannel){var u={vector:l.vector,Rulerchannel:"PlaneTranslationManipulation"};A&&A(u)}X.onMove(l),U.render()}},_e=function(e){q&&(Ue(),V(),Ie(),"LineTranslationEnd"===e.eventChannel?$&&($.endManipulation(),$.display()):"RotationEnd"===e.eventChannel&&ee&&(ee.endManipulation(),ee.display()),X.onMoveEnd({from:le,status:"Moved"}),_.publish({event:"onRobotMoveEnd"}))},Be=function(e){Te=!1,Se&&Se.cancel&&Se.cancel(),Se=null;var n=xe(e.target,e);if(q=n.pathElement,K=q,z.target=q,ve={},Ie(),Ne(),ye.updateDisplay({visibility:!1}),Ve.updateDisplay({visibility:!1}),q){var a=ze(n,e.intersection.position);i.empty(),o.empty(),i.add(n),o.add({pathElement:n.pathElement,event:e.event,position:e&&e.intersection&&e.intersection.position,equivalentGeometry:n.equivalentGeometry}),ge.origin=(new t.Vector3).getPositionFromMatrix(a),ge.initOrigin=(new t.Vector3).getPositionFromMatrix(a),ge.baseOrigin=(new t.Vector3).getPositionFromMatrix(a),$&&($.initOrigin=ge.initOrigin,$.origin=ge.origin,ve={})}Me(),q?(he(),window.top.__C3D_ROBOTSNAP_PANELDISPLAY||"CATC3D_AP"===window.widget.data.appId&&function(e){B._panel=new M({immersiveFrame:D.getImmersiveFrame(),_robot:B,robotP:e.intersection.position})}(e),Ue()):(ee&&(pe={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null}),be(),V(),e.target&&ke()),Ce.removeChildren(),_.publish({event:"onRobotMoveEnd"})},Oe=!1,We=function(e){G&&("@onViewpointBeginMove"===e.eventType?Oe=!0:"@onViewpointChange"===e.eventType?Oe&&(z.setVisibility(!1),U.render()):"@onViewpointEndMove"===e.eventType&&(z.setVisibility(!0),Oe=!1,U.render()))};require(["DS/ApplicationFrame/CommandsManager"],function(e){e.onCommandStart(function(e){oe.length&&("CATW3DRobotLevelSelectorHdr"===e._id?(L.hideContextualMenus(),K&&K.externalPath&&e.setRobotParams({pathContext:K,pathCurrent:q,doNotModifyCSO:!0,selectCB:function(e){He({pathElement:e.pathElement})}})):"CATW3DSetIdentityPositionHdr"===e._id?(L.hideContextualMenus(),ke()):"CAT3DComposeWidgetDefaultHdr"===e._id||"CAT3DComposeMoveHdr"===e._id?(H||(H=u.subscribe({event:"/VISU/"},We)),"CAT3DComposeWidgetDefaultHdr"===e._id&&ke()):"LevelSelectorHdr"===e._id||"HideShowHdr"===e._id||"CAT3DComposeMoveCmd"===e._id||"exclusive"===e._mode&&ke())},T.getCommandContext&&T.getCommandContext()?T.getCommandContext():void 0)}),this.setVisibility=function(e){if("boolean"==typeof e){e?(H||(H=u.subscribe({event:"/VISU/"},We)),$&&$.setVisibleFlag(!0),ee&&ee.setVisibleFlag(!0)):H&&($&&$.setVisibleFlag(!1),ee&&ee.setVisibleFlag(!1),u.unsubscribe(H),H=void 0),G=e;var t=z.isVisible();return t&&e||!t&&!e?0:(z.setVisibility(e),U.render(),0)}},this.isVisible=function(){return!!G&&z.isVisible()},this.setSelectionFilter=function(e){j=e&&e.filterPath?e:{}},this.rulerCB=function(e){E=e},this.manipCB=function(e){A=e},this._rulerformed=function(e){S=e},this.modifyTargetAndPosition=He,this.hasTarget=function(){return Boolean(q)},this.subscribe=function(e,t){return"onRobotMoveBegin"===e||"onRobotMoveEnd"===e?_.subscribe({event:e},t):void 0},this.unsubscribe=function(e){return _.unsubscribe(e)},this.activate=function(){oe.length||(oe.push(z.subscribe("LineTranslationBegin",function(e){Le(e)})),oe.push(z.subscribe("RotationBegin",function(e){Le(e)})),oe.push(z.subscribe("ScalingBegin",function(e){Le(e)})),oe.push(z.subscribe("PlaneTranslationBegin",function(e){Le(e)})),oe.push(z.subscribe("LineTranslationManipulation",function(e){Ze(e)})),oe.push(z.subscribe("RotationManipulation",function(e){Ze(e)})),oe.push(z.subscribe("ScalingManipulation",function(e){Ze(e)})),oe.push(z.subscribe("PlaneTranslationManipulation",function(e){Ze(e)})),oe.push(z.subscribe("LineTranslationEnd",function(e){_e(e)})),oe.push(z.subscribe("RotationEnd",function(e){_e(e)})),oe.push(z.subscribe("ScalingEnd",function(e){_e(e)})),oe.push(z.subscribe("PlaneTranslationEnd",function(e){_e(e)})),oe.push(z.subscribe("ScreenPlaneTranslationBegin",function(e){je(),U.setCursor("pointer"),be(),Xe(),De(),F(q,X)})),oe.push(z.subscribe("ScreenPlaneTranslationManipulation",function(e){!function e(t){if(Te||(Te=!0,_.publish({event:"onRobotMoveBegin"})),Se&&Se.cancel&&Se.cancel(),Se=null,U.setCursor("pointer"),Ne(),t.intersection.path.length){var n=t.intersection.path[0],i=xe(n,t),o=i.pathElement;j.getFiltersState&&(Se=x.switchToAV1withMesh({pathElement:n,pad3DViewer:T,selectionFilter:j.getFiltersState(),onComplete:function(){e(t),Se=null},onFailure:function(){Se=null}})),q&&o&&q.isEqual(o)||(q=o?o.clone():null,o?w(o)?(ye.updateDisplay({visibility:!1}),Ve.updateDisplay({pathElement:o,visibility:!0})):(ye.updateDisplay({pathElement:o,visibility:!0}),Ve.updateDisplay({visibility:!1})):(ye.updateDisplay({visibility:!1}),Ve.updateDisplay({visibility:!1}))),Ce.updateDisplay(i,t.intersection.position,i.normal),ze(i,t.intersection.position)}else ze(),Ce.updateDisplay(),ye.updateDisplay({visibility:!1}),Ve.updateDisplay({visibility:!1}),q=null}(e)})),oe.push(z.subscribe("ScreenPlaneTranslationEnd",function(e){Be(e)}))),re.length||(re.push(T.subscribe({event:"onRootRemoved"},function(e){Ge([e])})),re.push(T.subscribe({event:"onRootDetached"},function(e){Ge([e])})),re.push(T.subscribe({event:"onHide"},function(e){var t=[];e.paths.forEach(function(e){t.push({path:e})}),Ge(t)})),re.push(T.subscribe({event:"onBeginReparent"},function(){ke()}))),H=u.subscribe({event:"/VISU/"},We)},this.deactivate=function(){oe.forEach(function(e){z.unsubscribe(e)}),oe.length=0,re.forEach(function(e){T.unsubscribe(e)}),re.length=0,be(),u.unsubscribe(H),H=null},this.unreference=function(){this.deactivate(),te&&(ie=te.unsubscribe(ie),ne=te.unsubscribe(ne)),te=ne=ie=null,U.setRobot(!1),U.removeNode(ye),U.removeNode(Ve),Ne(),ce.forEach(function(e){$.unsubscribe(e)}),de.forEach(function(e){ee.unsubscribe(e)}),Y&&Y.unreference(),z=T=D=U=X=I=Y=ve=_=null,se=ue=L=j=$=ee=ye=Ve=null}}else window.console.error("A move referent component must be defined");else window.console.error("A move manager component must be defined");else window.console.error("A context must be defined");else window.console.error("A frame window must be defined");function Ne(){$&&$.clear(),ee&&ee.clear()}function ke(){z.ScreenPlaneTranslationEndCB({intersection:{}})}function Ge(e){q&&Array.isArray(e)&&e.some(function(e){if(e.path&&e.path.externalPath.length>1&&e.path.isAParentOf(q)||e.id&&e.id===h.getNodeID(q.externalPath[1]))return ke(),!0})}function je(){$&&ee||me||(me=!0,require(["DS/Ruler/Ruler","DS/Ruler/AngularRuler"],function(e,n){D&&($=new e(D,{displayOrigin:!1,offset:y,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!1}),se||(se=$.subscribe("OriginManipulateBegin",function(){Ae=null,Ee||(Ee=(new t.Vector3).copy($.origin))}),ce.push(se)),ue||(ue=$.subscribe("OriginManipulateEnd",function(){ve||(ve={}),Z.match("arrowX")?ve.X3Dpos=Ae?(new t.Vector3).copy(Ae):null:Z.match("arrowY")?ve.Y3Dpos=Ae?(new t.Vector3).copy(Ae):null:Z.match("arrowZ")&&(ve.Z3Dpos=Ae?(new t.Vector3).copy(Ae):null),S&&S({direction:Z,cposition:Ae}),Ae=null,a.empty()}),ce.push(ue)),$.onOriginManipulator=function(e){var n,i=null,o=Math.pow(10,6),r=U.pick(U.getMousePosition(e.event.from[0].getCurrentPosition(U.canvas)),j.filterPath?"primHybrid":"mesh",!1);if(0===r.path.length||!r.path[0])return $.displayOrigin=!1,Ae=null,Ee;if(n=j.filterPath?j.filterPath({pathElement:fe(r.path)}):{pathElement:fe(r.path)},a.empty(),!n||!n.pathElement)return h.isAModelPath(r.path[0])&&a.add({pathElement:r.path[0]}),$.displayOrigin=!1,Ee;if(void 0!==n&&n&&n.equivalentGeometry){var l=0;switch(n.equivalentGeometry.getType()){case d.GeometryType.POINT:i=n.equivalentGeometry.getPoint();break;case d.GeometryType.CYLINDER:case d.GeometryType.CONE:var s=n.equivalentGeometry.getEndPoints(),u=new t.Line3(s.beginPoint,s.endPoint);(l=Math.round(u.delta().angleTo(e.translationVector)*o)/o)!==Math.round(3*Math.PI/2*o)/o&&l!==Math.round(Math.PI/2*o)/o||(i=u.center());break;case d.GeometryType.CIRCLE:(l=Math.round(n.equivalentGeometry.getNormal().angleTo(e.translationVector)*o)/o)!==Math.round(3*Math.PI/2*o)/o&&l!==Math.round(Math.PI/2*o)/o||(i=n.equivalentGeometry.getCenter());break;case d.GeometryType.PLANE:case d.GeometryType.REFPLANE:0!==(l=Math.round(n.equivalentGeometry.getNormal().angleTo(e.translationVector)*o)/o)&&l!==Math.round(Math.PI*o)/o||(i=r.position);break;case d.GeometryType.SPHERE:i=n.equivalentGeometry.getCenter();break;case d.GeometryType.AXISSYSTEM:i=(new t.Vector3).getPositionFromMatrix(n.equivalentGeometry.getMatrix());break;default:i=null}}return i||(n.pathElement.internalPath.length=0,j.getFiltersState?j.getFiltersState().product&&(i=(new t.Vector3).getPositionFromMatrix(n.pathElement.getWorldMatrix())):i=(new t.Vector3).getPositionFromMatrix(n.pathElement.getWorldMatrix())),a.add(n),i?($.displayOrigin=!0,Ae=(new t.Vector3).copy(i),i):($.displayOrigin=!1,Ae=null,Ee)},$.setVisibilityFree(!0),ce.push($.subscribe("RulerManipulateBegin",function(e){Ye(e)})),ce.push($.subscribe("RulerManipulate",function(e){Ye(e)})),ce.push($.subscribe("RulerManipulateEnd",function(e){Ye(e)})),(ee=new n(D,{radius:C,mainGrad:10,nbSecondaryGrads:4,displayUnit:!0})).setVisibilityFree(!0),de.push(ee.subscribe("AngularRulerManipulateBegin",function(e){Ye(e)})),de.push(ee.subscribe("AngularRulerManipulate",function(e){Ye(e)})),de.push(ee.subscribe("AngularRulerManipulateEnd",function(e){Ye(e)})))})),te||((te=f.givePreferenceManager({context:T.getFrameWindow()}))&&(ne=te.subscribe("onPreferencesChanged",function(){$&&$.getVisibleFlag()&&($.unit=b.getCurrentUnit("length").unit,$.display()),ee&&ee.getVisibleFlag()&&(ee.unit=b.getCurrentUnit("angle").unit,ee.display())})),ie=te.subscribe("onAfterChangingPreferences",function(){$&&$.getVisibleFlag()&&($.unit=b.getCurrentUnit("length").unit,$.display()),ee&&ee.getVisibleFlag()&&(ee.unit=b.getCurrentUnit("angle").unit,ee.display())}))}function ze(e,n){if(e&&e.pathElement){z.connect();var i=e.normal;delete e.normal;var o,a,r,l=e.pathElement.getWorldMatrix(),s=(new t.Vector3).copy(n);if(e.equivalentGeometry){var u,c=e.equivalentGeometry.getType();if(c===d.GeometryType.POINT)s=e.equivalentGeometry.getPoint();else if(c===d.GeometryType.LINE||c===d.GeometryType.CYLINDER||c===d.GeometryType.CONE){var g=e.equivalentGeometry.getEndPoints(),p=new t.Line3(g.beginPoint,g.endPoint);u=p.delta(),s=p.closestPointToPoint(s)}else c===d.GeometryType.CIRCLE?(u=e.equivalentGeometry.getNormal(),s=e.equivalentGeometry.getCenter()):c===d.GeometryType.PLANE||c===d.GeometryType.REFPLANE?u=e.equivalentGeometry.getNormal():c===d.GeometryType.SPHERE?s=e.equivalentGeometry.getCenter():c===d.GeometryType.SURFACE?u=i:c===d.GeometryType.AXISSYSTEM&&(s=null);u&&(o=new t.Vector3,a=new t.Vector3,r=new t.Vector3,l.extractBasis(o,a,r),o.normalize(),a.normalize(),r.normalize(),u.normalize(),(new t.Vector3).crossVectors(o,u).length()<1e-9?(o.copy(a).projectOnPlane(u),o.normalize()):(o.projectOnPlane(u),o.normalize()),a.crossVectors(u,o),a.normalize(),l.makeBasis(o,a,u)),s&&l.setPosition(s),z.setRobotMatrix(l)}else j&&j.getFiltersState&&j.getFiltersState().surface?(i&&(o=new t.Vector3,a=new t.Vector3,r=new t.Vector3,l.extractBasis(o,a,r),o.normalize(),a.normalize(),r.normalize(),i.normalize(),(new t.Vector3).crossVectors(o,i).length()<1e-9?(o.copy(a).projectOnPlane(i),o.normalize()):(o.projectOnPlane(i),o.normalize()),a.crossVectors(i,o),a.normalize(),l.makeBasis(o,a,i)),l.setPosition(s),z.setRobotMatrix(l)):z.setRobotMatrix(l.setPosition(s));return l}z.disconnect()}function He(e){q=xe(e.pathElement).pathElement,K||(K=q),je(),q?z.connect():z.disconnect(),z.target=q;var n=z.getMatrix(),i=q.getWorldMatrix();i.setPosition(e.robotPosition||(new t.Vector3).getPositionFromMatrix(n)),ge.origin=(new t.Vector3).getPositionFromMatrix(i),ge.initOrigin=(new t.Vector3).getPositionFromMatrix(i),ge.baseOrigin=(new t.Vector3).getPositionFromMatrix(i),$&&($.initOrigin=ge.initOrigin,$.origin=ge.origin,ve={}),ee&&(pe={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null}),z.setRobotMatrix(i),Me(),he()}}}),A=[];return e.singleton({init:function(){},giveMove3DRobot:function(e){var t;return e&&e.context&&(t=null,A.some(function(n){return n.context===e.context&&(t=n.enveloppe)})),t},getMove3DRobot:function(e){var t;if(e&&e.context&&(A.some(function(n){return n.context===e.context&&(t=n.enveloppe)}),!t)){var n=new E({context:e.context}),i=e.context.setRobotVisibility,o=e.context.isRobotVisible;n.activate();var a={unreference:function(){n&&(n.unreference(),n=null,A.some(function(e,t){if(e.enveloppe===a)return A.splice(t,1),e.context.setRobotVisibility=i,i=null,e.context.isRobotVisible=o,o=null,a=null,!0}))},setVisibility:function(e){return n?n.setVisibility(e):null},isVisible:function(){return n?n.isVisible():null},setSelectionFilter:function(e){return n?n.setSelectionFilter(e):null},hasTarget:function(e){return n?n.hasTarget(e):null},modifyTargetAndPosition:function(e){return n?n.modifyTargetAndPosition(e):null},subscribe:function(e,t){return n?n.subscribe(e,t):null},unsubscribe:function(e){return n?n.unsubscribe(e):null},rulerCB:function(e){return n?n.rulerCB(e):null},manipCB:function(e){return n?n.manipCB(e):null},_rulerformed:function(e){return n?n._rulerformed(e):null}};Object.freeze(a),e.context.setRobotVisibility=function(e){return a?a.setVisibility(e):null},e.context.isRobotVisible=function(){return a?a.isVisible():null},A.push({context:e.context,enveloppe:a}),t=a}return t}})});