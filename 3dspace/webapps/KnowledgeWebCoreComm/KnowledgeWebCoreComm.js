define("DS/KnowledgeWebCoreComm/comm",["DS/ExperienceKernel/ExperienceKernel","DS/KnowledgeWebUtils/Listenable","DS/KnowledgeWebCore/context","DS/KnowledgeWebUtils/Utils","DS/KnowledgeWebUtils/KnowledgeWebTrace","css!DS/KnowledgeWebCoreComm/assets/Style/comm.css"],function(e,t,n,i,o){"use strict";const a=new t;function r(e){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):e}function s(e){let t=null;if(window.ActiveXObject)(t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e);else{t=(new DOMParser).parseFromString(e,"text/xml")}return t}function l(...e){const t=n.getValue("Kconsole");t&&t.log&&t.log(...e)}var u={ids:[],cbs:[],add:function(e,t){this.ids.push(e),this.cbs.push(t)},remove:function(e){var t=this.ids.indexOf(e);t>-1&&(this.cbs.splice(t,1),this.ids.splice(t,1))},get:function(e){var t,n=this.ids.indexOf(e);return n>-1&&(t=this.cbs[n]),t},getIndex:function(e){return this.cbs[e]}};Object.defineProperty(u,"length",{get:function(){return this.ids.length},set:function(){}});var c,d,h={},f={},g=new Map,m=new Map,p=0,v={status:!1,cb:[],check:function(){var e,t=!1;for(e=0;e<u.length&&!t;e++)u.cbs[e].displayWP&&(t=!0);if(v.status!==t)for(v.status=t,e=0;e<v.cb.length;e++)v.cb[e](v.status)}},y=/END:(\d*)/,b=null,C=[];function x(e){var t=y.exec(e);if(null!==t&&2===t.length)u.remove(parseInt(t[1])),b=null,null;else{var n=L(s(e));if(void 0!==n.notification){var i=n.notification.getAttr("name");l(e," > Notification : "+i),a.notify("io",{label:" > Notification : "+i,text:e}),n=function(e){if(void 0!==e.notification){var t=e.notification.getAttr("name"),n="";if(""!==e.notification.getAttr("modeler")&&(n=e.notification.getAttr("modeler")),m.has(n)&&m.get(n).forEach(function(t){var n=t(e);void 0!==n&&(e=n)}),m.has("ALL")&&m.get("ALL").forEach(function(t){var n=t(e);void 0!==n&&(e=n)}),void 0!==h[t])for(var i=0;i<h[t].length;i++)h[t][i](e)}return e}(n)}else{var o,r,c,d="",p="ALL";if(void 0!==n&&void 0!==n.response&&void 0!==n.response.cmdReturn){b=parseInt(n.response.getAttr("id")),(c=u.get(b))&&(r=c.obj);var C=[];n.response.cmdReturn.forEach(function(e,t){C.push(e.getAttr("name"))});var x=[];n.response.cmdReturn.forEach(function(e,t){x.push(e.getAttr("modeler"))}),l(e," > Response id : "+b+" - modeler : "+x.join(", ")+" -> "+C.join(", ")),a.notify("io",{label:" > Response id : "+b+" - modeler : "+x.join(", ")+" -> "+C.join(", "),text:e}),n.response.cmdReturn.forEach(function(e,t){d=e.getAttr("name"),""!==e.getAttr("modeler")&&(p=e.getAttr("modeler"));var i={};(i.response={},i.response["@attr"]=n["@attr"],i.response.getAttr=A.prototype.getAttr,i.response.cmdReturn=e,g.has(p))&&g.get(p).forEach(function(e){var t=e(i,r,b);void 0!==t&&(i=t)});g.has("ALL")&&g.get("ALL").forEach(function(e){var t=e(i,r,b);void 0!==t&&(i=t)});if(0===t?o=i:1===t?o=[o,i]:o.push(i),""!==d&&void 0!==f[d])for(var a=0;a<f[d].length;a++)f[d][a](i,r,b)})}else l(e," > Empty or invalid message !"),a.notify("io",{label:" > Empty or invalid message !",text:e});c&&c.onText&&c.onText(o,r,b)}}return v.check(),!0}function w(t){if(b){var n=u.get(b);if(l("cannot display binary"," > binary received for "+b),a.notify("io",{label:" > binary received for "+b,text:"cannot display binary"}),void 0!==n&&void 0!==n.onBinary){var i=new e.BinaryReader(t).dataView.buffer;n.onBinary(i)}}return!0}function A(e){this.tagName=e,this.children=[],this.objectType="MessageNode"}function L(e){var t,n,i,o,a,r,s,l=new A;if(1===e.nodeType){if(l.tagName=e.tagName,l["@attr"]={},e.attributes.length>0)for(n=0;n<e.attributes.length;n++)i=e.attributes.item(n),l["@attr"][i.nodeName]=i.value}else if(3===e.nodeType)l=e.nodeValue;else if(9===e.nodeType&&(l["@attr"]={},e.documentElement.attributes.length>0))for(n=0;n<e.documentElement.attributes.length;n++)i=e.documentElement.attributes[n],l["@attr"][i.name]=i.value;if(e.hasChildNodes())for(t=0;t<e.childNodes.length;t++)void 0===l[a=(o=e.childNodes.item(t)).nodeName]?(r=L(o),l[a]=r,l.children.push(r)):(void 0===l[a].push&&(s=l[a],l[a]=[],l[a].push(s)),r=L(o),l[a].push(r),l.children.push(r));return l}function T(e){return this.bName=e,this.content=[],this.modeler="",this}function j(){p++,T.call(this,"request");var e=this;return this.id=p,this.toXml=function(){for(var t="<request id='"+e.id+"' modeler='"+e.modeler+"'>",n=0;n<e.content.length;n++)t+=e.content[n].toXml();return t+="</request>"},this}function N(e){T.call(this,"command");var t=this;return this.name=e,this.id=null,this.toXml=function(){for(var e="<command name='"+t.name+"'"+(t.id?" id='"+t.id+"'":"")+(t.requestsManager?" modeler='"+t.requestsManager.getModeler()+"'":"")+" >",n=0;n<t.content.length;n++)e+=t.content[n].toXml()+"";return e+="</command>"},this}function S(e){T.call(this,"value");var t=this;return this.name=e.name,this.type=e.type,this.value=e.value,this.unit=e.unit,this.channels=e.channels,this.toXml=function(){var e="<value";if(void 0!==t.name&&(e+=" name='"+t.name+"'"),void 0!==t.type&&(e+=" type='"+t.type+"'",this.unit&&(e+=" unit='"+t.unit+"'")),e+=">",void 0!==t.value&&0===t.content.length)e+=r(t.value)+"";else if(t.content.length>0)for(var n=0;n<t.content.length;n++)e+=t.content[n].toXml()+"";return e+="</value>"},this.toJSON=function(){if("List"===this.type){for(var e="[",t=0;t<this.content.length;t++)t>0&&(e+=", "),e+=this.content[t].toJSON();return e+="]"}return this.value},this}n.addListener(function(){n.getValue("CustomCommunicationChannel")&&(C&&C.length&&C.forEach(function(e){q.send(e.request,e.onText?e.onText:function(){},e.onBinary?e.onBinary:function(){},e.displayWP,e.obj)}),C=[])},"CustomCommunicationChannelChanged"),A.prototype.get=function(e,t){var n;if(void 0!==this[e])if(this[e]instanceof Array){for(var i=0;i<this[e].length;i++)if(this[e][i].getAttr("name")===t){n=this[e][i];break}}else this[e].getAttr("name")===t&&(n=this[e]);return n},A.prototype.getAttr=function(e){return this["@attr"][e]},A.prototype.forEach=function(e){if(void 0!==this)if(this instanceof Array)for(var t=0;t<this.length;t++)e(this[t],t);else e(this,0)},T.prototype.add=function(e){this.content.push(e),e.requestsManager&&e.requestsManager.getModeler&&(this.modeler=e.requestsManager.getModeler())},T.prototype._streamSelectionReducer=function(e,t){return i.exists(t.channels[channelId])?e+JSON.stringify(t.channels[channelId]):i.isFunction(t.streamChannel)?e+t.streamChannel(channelId):e},T.prototype.streamChannel=function(e){let t=null;for(let n=0;n<this.content.length&&null===t;n++){let o=this.content[n];i.exists(o)&&(i.exists(o.channels)&&i.exists(o.channels[e])?t=o.channels[e]:i.isFunction(o.streamChannel)&&(t=o.streamChannel(e)))}return t},j.prototype=Object.create(T.prototype,{constructor:{value:j,enumerable:!1}}),j.prototype.getCommandsName=function(){for(var e=[],t=0;t<this.content.length;t++)e.push(this.content[t].name);return e},j.prototype.getCommands=function(){for(var e=[],t=0;t<this.content.length;t++){for(var n=this.content[t].name+"(",i=0;i<this.content[t].content.length;i++)i>0&&(n+=", "),n+=this.content[t].content[i].toJSON();n+=")",e.push(n)}return e},j.prototype.isReadOnly=function(){for(var e=!0,t=0;t<this.content.length&&e;t++)!0!==this.content[t].readonly&&(e=!1);return e},Object.defineProperty(j.prototype,"requireUpdate",{get:function(){for(var e=!1,t=0;t<this.content.length&&!e;t++)!0===this.content[t].requireUpdate&&(e=!0);return e},set:function(){}}),N.prototype=Object.create(T.prototype,{constructor:{value:N,enumerable:!1}}),S.prototype=Object.create(T.prototype,{constructor:{value:S,enumerable:!1}});var q={popUpErrors:function(e){var t=e.response.cmdReturn.param;if(void 0!==t){var n=[];t instanceof Array||"Errors"===t.getAttr("name")&&(n=t.value.value);for(var i=0;i<n.length;i++){var o=/Line \d* : Evaluation error in relation [^\s]* (.*)/.exec(n[i]["#text"].replace("\n"," "));2===o.length?n[i]=o[1]:n[i]=n[i]["#text"]}}},addWaitingStatusCB:function(e){v.cb.push(e)},removeWaitingStatusCB:function(e){var t=v.cb.indexOf(e);t>-1&&v.cb.splice(t,1)},sendText:function(e,t,i,o,r,s,h){var f,g;void 0===r&&(r=!1),"EKCommunication"===n.getValue("CommunicationContext")?(t&&u.add(t,{onText:i,onBinary:o,displayWP:r,obj:s}),f=" < Request id : "+t,h&&(f+=" -> "+h.join(", ")),l(e,f),a.notify("io",{label:f,text:e}),c.sendText(d,e),v.check()):n.getValue("CustomCommunicationChannel")?(g=n.getValue("CustomCommunicationChannel"),t&&u.add(t,{onText:i,onBinary:o,displayWP:r,obj:s}),f=" < Request id : "+t,h&&(f+=" -> "+h.join(", ")),l(e,f),a.notify("io",{label:f,text:e}),g.sendText({text:e,readOnly:!1,requireUpdate:!0}),v.check()):(f=" < Request id : "+t,h&&(f+=" -> "+h.join(", ")),C.push({cbid:t,display:f,message:e,onText:i,onBinary:o,displayWP:r,obj:s}))},send:function(e,t,i,o,r){function s(e,t,n,i,o){var r="";if("object"==typeof e){var s=e.id;r=e.toXml();var c=e.getCommands(),d=" < Request id : "+s+" - modeler : "+e.modeler;s&&u.add(s,{onText:t,onBinary:n,displayWP:i,obj:o}),c&&(d+=" -> "+c.join(", ")),l(r,d),a.notify("io",{label:d,text:r})}else"string"==typeof e&&(r=e);return r}if(void 0===o&&(o=!1),"EKCommunication"===n.getValue("CommunicationContext")){var h=s(e,t,i,o,r);c.sendText(d,h),v.check()}else if(n.getValue("CustomCommunicationChannel")){var f=n.getValue("CustomCommunicationChannel");h=s(e,t,i,o,r);void 0!==f.send&&"object"==typeof e?f.send(e):f.sendText(h),v.check()}else C.push({request:e,onText:t,onBinary:i,displayWP:o,obj:r})},startLongTransaction:function(e){const t=n.getValue("CustomCommunicationChannel");return t&&"function"==typeof t.startLongTransaction?t.startLongTransaction(e):Promise.reject()},endLongTransaction:function(e){const t=n.getValue("CustomCommunicationChannel");return t&&"function"==typeof t.endLongTransaction?t.endLongTransaction(e):Promise.reject()},addNotificationCallback:function(e,t){void 0===h[e]&&(h[e]=[]),h[e].push(t)},addAllNotificationCallback:function(e,t="ALL"){var n;m.has(t)?(n=m.get(t)).has(e)||n.add(e):(n=new Set([e]),m.set(t,n))},removeAllNotificationCallback:function(e,t="ALL"){if(m.has(t)){var n=m.get(t);n.has(e)&&n.delete(e),m.set(t,n)}},removeNotificationCallback:function(e,t){if(void 0!==h[e]){var n=h[e].indexOf(t);n>-1&&h[e].splice(n,1)}},addCommandCallback:function(e,t){void 0===f[e]&&(f[e]=[]),f[e].push(t)},removeCommandCallback:function(e,t){if(void 0!==f[e]){var n=f[e].indexOf(t);n>-1&&f[e].splice(n,1)}},addAllCommandCallback:function(e,t="ALL"){var n;g.has(t)?(n=g.get(t)).has(e)||n.add(e):(n=new Set([e]),g.set(t,n))},removeAllCommandCallback:function(e,t="ALL"){if(g.has(t)){var n=g.get(t);n.has(e)&&n.delete(e),g.set(t,n)}},getWaitingStatus:function(){return v.status}};return q.xmlEscape=r,q.MessageNode=A,q.Request=j,q.Command=N,q.Value=S,q.stringtoXML=s,q.xml2json=L,q.createNode=function(t,n){var i;i=void 0!==n?n:2097;var a=(c=new e.Node({onText:x,onBinary:w,onHypervisorDisconnect:function(e){o.log("KillGraphViewer"),o.log("onClose"),e?(console.log("EK Connection lost, we refresh the page"),window.location.reload()):document.body.innerHTML='<br><br><div style="text-align:center">Websocket connection failed</div>'},hypervisorIp:t,webSocketPort:i,pool:"KnowledgeGraphClientPool"})).connect("KnowledgeGraphServerPool");return d=a.select(),c.sendTextOnDisconnection(d,"DISCONNECT"),c.subscribe(d,"Notification"),{id:d,createdNode:c}},q.onText=x,q.onBinary=w,q.listenable=a,n.setValue("GraphCommunicationNode",q),q}),define("DS/KnowledgeWebCoreComm/ToValueInterface",[],function(){function e(){}return e.prototype.toValue=function(){return{name:"undefined",type:"undefined",value:"undefined"}},e}),define("DS/KnowledgeWebCoreComm/AppRequests",["DS/KnowledgeWebCoreComm/comm","DS/KnowledgeWebCoreComm/ToValueInterface","DS/KnowledgeWebUtils/Utils","DS/KnowledgeWebCore/KnowledgeMagnitudeServices"],function(e,t,n,i){"use strict";class o{constructor(e){this._modeler=e.modeler,this._grouping={activated:!1,commands:[],textCBs:[],binCBs:[],textCB:function(){var e=this.textCBs;return this.textCBs=[],function(t,n,i){for(var o=0;o<e.length;o++)e[o]&&e[o](t,n,i)}},binCB:function(){}}}static buildRequest(t,n){var i;t instanceof Array||(t=[t]);var o=new e.Request;for(n&&(o.modeler=n),o.waiting=!1,i=0;i<t.length;i++)o.add(t[i]),o.waiting=o.waiting||t[i].waiting;return o}send(t,n,i,a){var r;t instanceof Array||(t=[t]);const s=t.filter(e=>e.isValid());if(t.length!==s.length&&console.warn(t.length-s.length+" invalid resquests have been filtered."),!this._grouping.activated){const t=o.buildRequest(s,this._modeler);return e.send(t,n,i,t.waiting||a),t.id}for(r=0;r<s.length;r++)this._grouping.commands.push(s[r]),this._grouping.textCBs.push(n),this._grouping.binCBs.push(i)}startGroup(){this._grouping.activated||(this._grouping.activated=!0,this._grouping.commands=[])}endGroup(e,t){this._grouping.textCBs.push(e),this._grouping.binCBs.push(t),this._grouping.activated&&(this._grouping.activated=!1,this._grouping.commands.length>0&&this.send(this._grouping.commands,this._grouping.textCB(),t))}endGroupAndDump(){let e=null;return this._grouping.activated&&(this._grouping.activated=!1,this._grouping.commands.length>0&&(e=o.buildRequest(this._grouping.commands))),e}static startLongTransaction(t){return e.startLongTransaction(t)}static endLongTransaction(t){return e.endLongTransaction(t)}getModeler(){return this._modeler}createCommand(e,i,o){const a=this;var s,l,u;o&&(s=o.waiting,l=o.readonly,u=o.requireUpdate),a[e]=function(o,s){r.call(this,e,a),n.isObject(s)&&n.isBoolean(s.requireUpdate)&&(this.requireUpdate=s.requireUpdate),o instanceof Array||(o=[o]);for(var l=0,u=0;u<i.length&&l<o.length;u++){var c=i[u].name,d=i[u].type,h=i[u].value,f=null;if(!(o[l]instanceof Object)||o[l]instanceof Array||n.implement(o[l],t)||(void 0!==o[l].name&&(c=o[l].name),void 0!==o[l].type&&(d=o[l].type),void 0!==o[l].value&&(h=o[l].value),void 0!==o[l].unit&&(f=o[l].unit),l++),void 0===c&&(c=o[l++]),void 0===d&&l<o.length&&(d=o[l++]),void 0===h&&l<o.length&&(void 0===(h=o[l++])?(h=null,d="NULL"):n.isObject(h)&&n.exists(h.value)&&n.exists(h.unit)&&(f=h.unit,h=h.value)),void 0!==c&&void 0!==d&&void 0!==h)if(i[u].repeatable&&h instanceof Array)for(var g=0;g<h.length;g++)this.addValue(c,d,h[g],f);else this.addValue(c,d,h,f)}return this},n.inherits(a[e],r),a[e].prototype.addParam=function(e,t){for(var n,o=0;o<i.length&&void 0===n;o++)i[o].name===e&&(n=i[o]);this.addValue(n.name,n.type,t)},a[e].prototype.waiting=s,l&&(a[e].prototype.readonly=l),a[e].prototype.requireUpdate=u,a["send"+e]=function(t,n,i,o,r){var s=new a[e](t,r);return void 0!==o&&(s.waiting=o),a.send(s,n,i)}}}function a(o){var r,s,l,u,c={};o instanceof Object&&(o instanceof Array?(r="listError",s="String",l="cannot be treated without a type",u=void 0):(r=o.name,o.value instanceof Object?o.value instanceof Array?(s="List",u=o.value,l=void 0):n.implement(o.value,t)?(s=(o=o.value.toValue()).type,l=o.value):"Selection"===o.type&&(c.selection=o.value,s="Feature",l="Selection"):(s=o.type,l=o.value)));var d={name:r,type:s,value:l,channels:c};if(s&&i.isAMagnitude(s)&&(o.unit?d.unit=i.getUnitFromLabel(s,o.unit).Name:d.unit=i.getUnitToDisplay(s).Name),e.Value.call(this,d),void 0===l&&void 0!==u&&u instanceof Array)for(var h=0;h<u.length;h++)this.add(new a({name:r+"."+h,type:o.type,value:u[h]}));return this}function r(t,n){return this.requestsManager=n,e.Command.call(this,t),this}return n.inherits(a,e.Value),Object.defineProperty(a.prototype,"valid",{get:function(){return this.content.reduce((e,t)=>e&&!1!==t.valid,!0)&&n.exists(this.type)&&n.isString(this.type)&&""!==this.type}}),n.inherits(r,e.Command),r.prototype.addValue=function(e,t,n,i){this.add(new a({name:e,type:t,value:n,unit:i}))},r.prototype.addValues=function(e){for(var t=0;t<e.length;t++)e[t].name&&e[t].type&&e[t].value&&this.addValue(e[t].name,e[t].type,e[t].value)},r.prototype.send=function(e,t){this.requestsManager.send(this,e,t)},r.prototype.isValid=function(){return this.content.reduce((e,t)=>e&&!1!==t.valid,!0)},o});