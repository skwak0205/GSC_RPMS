define("DS/CAT3DWText/CAT3DWTextCommonConstants",[],function(){"use strict";return{defaultFontSize:66,defaultLineHeight:90,defaultLinkPreviewRatio:706/96,defaultStickyNoteWidth:300,defaultStickyNoteHeight:300,zoomInThreshold:2,zoomOutThreshold:.5,defaultTextPadding:{top:0,bottom:0,left:10,right:10},defaultStickyNotePadding:{top:20,bottom:20,left:40,right:40},createInputRatio:1/3,createLinkRatio:2.3,nbCharMaxInStickyNote:25,nbCharMaxInText:100}}),define("DS/CAT3DWText/CAT3DWTextRenderService",["UWA/Class","DS/VENWebHtml2Canvas/Html2Canvas","UWA/Promise","DS/CAT3DWInfraUI/CAT3DWCanvasLimits"],function(t,e,i,n){"use strict";var a=t.extend({init:function(){this._parent()},renderTextToCanvas:function(t,e,i,a,r,o,s,h){var l,c=e;if(!n.areDimensionsWithinLimits(t,e)){var u=t/e;c=Math.floor(Math.sqrt(n.MPLimit/u))}var d=c/e;l=d*t;var g=document.createElement("canvas");g.height=c,g.width=l;var f=d*a,m=d*r,p=d*o.left,_=d*o.top,D=g.getContext("2d");h&&(D.fillStyle=h,D.strokeStyle=h,D.fillRect(0,0,g.width,g.height)),D.textBaseline="top",D.font=`${m}px GochiHand`,D.fillStyle=s||"black",D.strokeStyle=s||"black",h||(D.shadowOffsetX=0,D.shadowOffsetY=0,D.shadowBlur=1*window.devicePixelRatio,D.shadowColor="white");var x=p,v=Math.round(f/(6.5*window.devicePixelRatio))+_;return i.split("\n").forEach(function(t,e){D.fillText(t,x,v+f*e)}),g},renderLinkToCanvas:function(t){return new i(function(e,i){document.body.append(t),this._makeRichLinkCanvas(t).then(function(i){t.remove(),e(i)})}.bind(this))},_makeRichLinkCanvas:function(t){var i=new e;return t?i.htmlToCanvas(t,{onclone:function(t){var e=t.getElementsByClassName("rich-link-preview");e&&(e[e.length-1].style.opacity="1")},allowTaint:!0,useCORS:!0,scale:2}):null}});return UWA.namespace("DS/CAT3DWPhoto/CAT3DWTextRenderService",a)}),define("DS/CAT3DWText/CAT3DWTextView",["DS/CAT3DWMedia/CAT3DWMediaView","DS/CAT3DWVisu/CAT3DWDataFactory","DS/Manipulators/LineTranslationManipulator","DS/Mesh/MeshUtils","DS/Visualization/MaterialApplication","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS"],function(t,e,i,n,a,r,o){"use strict";var s=t.extend({init:function(t,i){this._parent(t,i),this._defaultRectangleValue=100;var a=this.getDimensions();this._rectangle=r.createRectangleNode({width:-a.width,height:-a.height,fill:!0,color:new n.Color(255,255,255,0),cornerPoint:new o.Vector2(a.width/2,a.height/2)}),this._rectangle.setPickingPriorityId(e.getLabelOf(e.SupportTypes.IMAGE)),this.addChild(this._rectangle),this._texture=null},setTexture:function(t){return this.applyMaterial(t),this._viewer.render(),this.getDimensions()},resizeFromPixelDimensions:function(t){var e=t.width,i=t.height,n=this.getDimensions(),a=n.width,r=n.height,o=this._viewer.canvas.height,s=this._viewpoint.getCamera().getWorldSizeFromPixelSize(1,this.getCenter(),o),h=e*s*window.devicePixelRatio,l=i*s*window.devicePixelRatio;this.resize(Math.abs(h/a),Math.abs(l/r))},getAngleInDegrees:function(){var t=(new o.Matrix4).extractRotation(this.getMatrix()),e=new o.Vector3,i=new o.Vector3,n=new o.Vector3;t.extractBasis(e,i,n);var a=180*e.angleTo(new o.Vector3(0,-1,0))/Math.PI;return a*=new o.Vector3(-1,0,0).dot(e)>0?1:-1},applyMaterial:function(t){this.removeMaterialApplication();var e=new a({faceMaterial:this.getTextMaterial(t),lineMaterial:null});this._rectangle.setMaterialApplication(e),this._viewer.renderer.resetGSSOCache()},resize:function(t,e){if(t&&e){var i=(new o.Matrix4).copy(this.getMatrix()),n=this._getRectangleCorners(i).topLeft;i.scale(new o.Vector3(t,e,1));var a=new o.Vector3(this._defaultRectangleValue/2,-this._defaultRectangleValue/2,0);a.applyMatrix4(i);var r=(new o.Vector3).getPositionFromMatrix(i),s=n.clone().sub(a);r.add(s),i.setPosition(r),this.setMatrix(i),this._viewer.render()}},setOpacity:function(t){var e=this._rectangle.getMaterial("Face");e&&(e.opacity=t)},getOpacity:function(){var t=this._rectangle.getMaterial("Face");return t?t.opacity:null},createTranslationManipulator:function(t){this._translationManipulator||(this._translationManipulator=new i({axis:t}))},setTextPickable:function(t){this.setPickable(t?n.PICKABLE:n.NOPICKABLE),this._rectangle.setPickable(t?n.PICKABLE:n.NOPICKABLE)},setDepth:function(t){var e=3*t;this._rectangle.setRenderDepth(e),this._rectangle.setPickingPriorityId("imagePriority"+t),this._rectangle.material.transparent=!0,this._rectangle.material.depthTest=!1;var i=this._rectangle.getMaterial("Line");i&&(i.transparent=!0,i.depthTest=!1)},_setPolygonOffset:function(t,e){t.transparent=!0,t.polygonOffset=!0,t.polygonOffsetFactor=-e,t.polygonOffsetUnit=-.1},getDepth:function(){var t=0;return this._rectangle.mesh3js&&this._rectangle.mesh3js.renderDepth&&(t=this._rectangle.mesh3js.renderDepth/3),t},getTextMaterial:function(t){this._texture=new o.Texture(t,void 0,o.ClampToEdgeWrapping,o.ClampToEdgeWrapping,o.LinearFilter,o.LinearMipMapLinearFilter),this._texture.anisotropy=16,this._texture.needsUpdate=!0;var e=new o.MeshBasicMaterial({map:this._texture,force:!0,side:o.DoubleSide});return e.transparent=!0,e.color=new o.Color,e.polygonOffset=!0,e.polygonOffsetFactor=.7,e},getNormal:function(){var t=this.getMatrixWorld();return this._getRectangleNormal(t)},getCorners:function(){var t=this.getMatrixWorld();return this._getRectangleCorners(t)},getDimensions:function(){var t=this.getMatrixWorld();return this._getRectangleDimensions(t)},getPixelDimensions:function(){var t={},e=this.getCorners(),i=this._viewer.currentViewpoint.project(e.topLeft),n=this._viewer.currentViewpoint.project(e.topRight),a=this._viewer.currentViewpoint.project(e.bottomLeft);return t.width=i.distanceTo(n),t.height=i.distanceTo(a),t},getDefaultRectangleValue:function(){return this._defaultRectangleValue},getPlan:function(){var t=this.getNormal(),e=new o.Plane(t,0),i=(new o.Vector3).getPositionFromMatrix(this.getMatrix());return e.translate(i),e},getExtremesCorners:function(){var t=this.getCorners(),e=[this._viewer.currentViewpoint.project(t.topLeft),this._viewer.currentViewpoint.project(t.topRight),this._viewer.currentViewpoint.project(t.bottomRight),this._viewer.currentViewpoint.project(t.bottomLeft)],i=this._getExtreme(e),n=this.getPlan();return{topLeft:this._createExtremePoint(i.topLeft,n),topRight:this._createExtremePoint(i.topRight,n),bottomRight:this._createExtremePoint(i.bottomRight,n),bottomLeft:this._createExtremePoint(i.bottomLeft,n)}},_getExtreme:function(t){return{topLeft:{x:Math.min(t[0].x,t[1].x,t[2].x,t[3].x),y:Math.min(t[0].y,t[1].y,t[2].y,t[3].y)},topRight:{x:Math.max(t[0].x,t[1].x,t[2].x,t[3].x),y:Math.min(t[0].y,t[1].y,t[2].y,t[3].y)},bottomRight:{x:Math.max(t[0].x,t[1].x,t[2].x,t[3].x),y:Math.max(t[0].y,t[1].y,t[2].y,t[3].y)},bottomLeft:{x:Math.min(t[0].x,t[1].x,t[2].x,t[3].x),y:Math.max(t[0].y,t[1].y,t[2].y,t[3].y)}}},_createExtremePoint:function(t,e){return this._viewpoint.create3DRayFrom2DPoint(t,this._viewpoint.camera).intersectPlane(e)},_getRectangleNormal:function(t){var e=new o.Vector3,i=new o.Vector3,n=new o.Vector3;return t.extractBasis(e,i,n),n.normalize()},_getRectangleCenter:function(t){var e=this._getRectangleCorners(t),i=(new o.Vector3).addVectors(e.topRight,e.bottomLeft);return i.divideScalar(2),i},_getRectangleCorners:function(t){var e=new o.Vector3(this._defaultRectangleValue/2,this._defaultRectangleValue/2,0),i=new o.Vector3(-this._defaultRectangleValue/2,this._defaultRectangleValue/2,0),n=new o.Vector3(this._defaultRectangleValue/2,-this._defaultRectangleValue/2,0),a=new o.Vector3(-this._defaultRectangleValue/2,-this._defaultRectangleValue/2,0);return e.applyMatrix4(t),i.applyMatrix4(t),n.applyMatrix4(t),a.applyMatrix4(t),{bottomLeft:e,bottomRight:i,topLeft:n,topRight:a}},_getRectangleDimensions:function(t){var e=this._getRectangleCorners(t);return{width:Math.abs(e.bottomRight.distanceTo(e.bottomLeft)),height:Math.abs(e.topLeft.distanceTo(e.bottomLeft))}},showSelectionNode:function(){this._createSelectionNode(),this._selectionNode.setVisibility(!0)},hideSelectionNode:function(){this._selectionNode&&this._selectionNode.setVisibility(!1)},_createSelectionNode:function(){if(!this._selectionNode){var t=this._rectangle.mesh3js.geometry[0].vertexPositionArray,e=[new o.Vector3(t[0],t[1],t[2]),new o.Vector3(t[3],t[4],t[5]),new o.Vector3(t[6],t[7],t[8]),new o.Vector3(t[9],t[10],t[11])];e[4]=e[0],this._selectionNode=r.createLineNode({points:e}),this._selectionNode.setMatrix(this._rectangle.getMatrix()),this._selectionNode.setPickable(n.NODRAWHL),this._selectionNode.setExcludeFromBounding(!0),this._selectionNode.setMaterialApplication(new a({lineMaterial:this._buildDottedBorderMaterial()})),this.addChild(this._selectionNode)}},getCreationData:function(){var t=this._parent();return t.matrix=this.getMatrix(),t},getMoveData:function(){return{matrix:this.getMatrix()}},setMoveData:function(t){this.setMatrix(t.matrix),this._media.redrawText()},getEditData:function(){var t=this._parent();return t.depth=this.getDepth(),t},setEditData:function(t){this._parent(t),t.depth&&this.setDepth(t.depth)}});return UWA.namespace("DS/CAT3DWText/CAT3DWTextView",s)}),define("DS/CAT3DWText/CAT3DWTextDataService",["UWA/Class"],function(t){"use strict";var e=t.extend({init:function(){this._parent(),this._data={},this._saveData=[]},setValue:function(t,e){return this._data[t]=e,this._data[t]},setValues:function(t){for(var e in t)this.setValue(e,t[e])},getValue:function(t){return this._data[t]},getData:function(){return JSON.parse(JSON.stringify(this._data))},setData:function(t){return this._data=JSON.parse(JSON.stringify(t)),this._data},save:function(){this._saveData.push(JSON.parse(JSON.stringify(this._data)))},forgetChg:function(){this._saveData.length<=0?console.warn("Error during forgetChg : No data has been saved"):this._data=JSON.parse(JSON.stringify(this._saveData.pop()))},clearSave:function(){this._saveData=[]}});return UWA.namespace("DS/CAT3DWPhoto/CAT3DWTextDataService",e)}),define("DS/CAT3DWText/CAT3DWText",["DS/CAT3DWMedia/CAT3DWMedia","DS/CAT3DWText/CAT3DWTextCommonConstants","DS/CAT3DWText/CAT3DWTextView","UWA/Promise","DS/CAT3DWRichLinksUI/CAT3DWRichLinkPreviewGenerator","DS/CAT3DWInfra/CAT3DWUrlServices","DS/CAT3DWText/CAT3DWTextRenderService","css!DS/CAT3DWRichLinksUI/CAT3DWRichLinksUI"],function(t,e,i,n,a,r,o){"use strict";return t.extend({init:function(t){this._parent(t),this._textRenderService=new o,this._subscribeToZoomEvents(t.viewer.currentViewpoint.control._modelEvent)},dispose:function(){this._viewControllerModelEvents&&this._viewControllerModelEvents.unsubscribe(this._onZoomEventToken),t.prototype.dispose.call(this)},initialize:function(t){this.redrawText(t).then(function(){t.callback&&t.callback(this)}.bind(this)).catch()},_subscribeToZoomEvents:function(t){this._viewControllerModelEvents=t,this._onZoomEventToken=this._viewControllerModelEvents.subscribe({event:"Zoom"},()=>{let t=this._viewer.currentViewpoint.getTargetDistance();var i=this._mediaData.getValue("initialCameraDistance");let n=(this._lastRenderCameraDistance||i)/t;(n>e.zoomInThreshold||n<e.zoomOutThreshold)&&(this.redrawText(),this._lastRenderCameraDistance=t)})},getType:function(){return"CAT3DWText"},createMediaView:function(t){return new i(this,t)},getText:function(){return this._mediaData.getValue("text")},getColor:function(){return this._mediaData.getValue("textColor")},getFontSize:function(){var t=this._getCurrentScalingFactor();return e.defaultFontSize*t},getLineHeight:function(){var t=this._getCurrentScalingFactor();return e.defaultLineHeight*t},getMinWidth:function(){var t=this._getCurrentScalingFactor();return e.defaultStickyNoteWidth*t},getMinHeight:function(){var t=this._getCurrentScalingFactor();return e.defaultStickyNoteHeight*t},getPadding:function(){var t=this._getCurrentScalingFactor(),i=this.getBackgroundColor()?e.defaultStickyNotePadding:e.defaultTextPadding;return{top:i.top*t,bottom:i.bottom*t,left:i.left*t,right:i.right*t}},_getCurrentScalingFactor:function(){var t=this.getView().getPixelDimensions(),e=this._mediaData.getValue("inputDimensions");return t.height/e.height},getBackgroundColor:function(){return this._mediaData.getValue("backgroundColor")},redrawText:function(t){return new n(function(i,n){if(t&&t.text&&this._mediaData.setValue("text",t.text),t&&t.textColor&&this._mediaData.setValue("textColor",t.textColor),t&&t.backgroundColor&&this._mediaData.setValue("backgroundColor",t.backgroundColor),t&&t.text&&!this._mediaData.getValue("backgroundColor")&&"string"==typeof t.text){var o=(new r).isValidHttpUrl(t.text.trim());this._mediaData.setValue("isUrl",o),this._mediaData.setValue("isSwymContent",!1)}var s=1,h=1;if(t&&t.inputDimensions)if(this._mediaData.getValue("inputDimensions")){var l=this.getView().getPixelDimensions();s=this._mediaData.getValue("inputDimensions").height/l.height;var c={width:t.inputDimensions.width*s,height:t.inputDimensions.height*s};this._mediaData.setValue("inputDimensions",c)}else{s=t.createInputRatio?t.createInputRatio:s;var u={width:t.inputDimensions.width*s,height:t.inputDimensions.height*s};this._mediaData.setValues({inputDimensions:u,initialCameraDistance:this._viewer.currentViewpoint.getTargetDistance()}),this._mediaData.getValue("isUrl")&&(h=t.createLinkRatio?t.createLinkRatio:h)}var d=e.defaultFontSize,g=e.defaultLineHeight,f=this._mediaData.getValue("text"),m=this._mediaData.getValue("textColor"),p=this._mediaData.getValue("backgroundColor"),_=p?e.defaultStickyNotePadding:e.defaultTextPadding,D=this._mediaData.getValue("inputDimensions"),x=!(!t||!t.inputDimensions),v=this._mediaData.getValue("isUrl"),w=1;x?w=1/s:w=this.getView().getPixelDimensions().height/D.height;const C=D.width*w,T=D.height*w,V=d*w,S=g*w,M={top:_.top*w,bottom:_.bottom*w,left:_.left*w,right:_.right*w};if(v){if(!x)return void i();var y=f.trim();y.startsWith("http://")||y.startsWith("https://")||(y="https://"+y),a.getContentFromUrl(y).then(function(n){if(n){var r=!(!n.searchSucceeded||!n.searchNbResults);this._mediaData.setValue("isSwymContent",r);var o=a.createLinkPreview(n);this._textRenderService.renderLinkToCanvas(o).then(function(n){x&&this._mediaView.resizeFromPixelDimensions({width:T*h*e.defaultLinkPreviewRatio,height:T*h}),this._mediaView.setTexture(n),t&&t.linkPosition&&x&&(t.position=t.linkPosition),i()}.bind(this))}else{this._mediaData.setValue("isUrl",!1),this._mediaData.setValue("isSwymContent",!1),x&&this._mediaView.resizeFromPixelDimensions({width:C,height:T});var s=this._textRenderService.renderTextToCanvas(C,T,f,S,V,M,m,p);this._mediaView.setTexture(s),i()}}.bind(this))}else{x&&this._mediaView.resizeFromPixelDimensions({width:C,height:T});var R=this._textRenderService.renderTextToCanvas(C,T,f,S,V,M,m,p);this._mediaView.setTexture(R),i()}}.bind(this))}})}),define("DS/CAT3DWText/CAT3DWTextsManager",["DS/CAT3DWMedia/CAT3DWMediaManager","DS/CAT3DWText/CAT3DWText","DS/Visualization/Node3D","DS/CAT3DWVisu/CAT3DWPickingControllerFactory"],function(t,e,i,n){"use strict";return t.extend({init:function(){this._parent()},initialize:function(){this._parent();var t=this._viewer.getRootNode(),e=n.getRootTextNodeName();this._rootNode=new i(e),t.addChild(this._rootNode)},createTextInGroup:function(t,e){return this._parent(t,e)},createMediaObject:function(t){return new e(t)},reset:function(t){this._parent(t)},getResetEvent:function(){return"CAT3DWTextsManagerReset"}})});