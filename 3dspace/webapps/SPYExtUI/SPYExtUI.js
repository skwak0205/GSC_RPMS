/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/SPYExtUI/CATSimNavDataFrameViewXYChartUI",["UWA/Core","DS/CoreEvents/Events","DS/SPYUtils/TrackingManager","DS/SPYUI/CATSimNavDataFrameExtractableUI","DS/SPY/CATSimNavDataHelper","DS/SPYHC/Highcharts","css!SPYExtUI/CATSimNavDataFrameViewXYChartUI.css","i18n!DS/SPYExtUI/assets/nls/CATSimNavDataFrameViewXYChartUI"],function(t,i,e,a,n,o,s,r){"use strict";Array.prototype.find||(Array.prototype.find=function(t){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var i,e=Object(this),a=e.length>>>0,n=arguments[1],o=0;o<a;o++)if(i=e[o],t.call(n,i,o,e))return i});var l=function(t,i){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t&&t<i},h=function(t,i){for(var e=!0,a=0;a<t.length&&e;a++)e=l(t[a],i);return e},u=function(t,i){var e=t.xAxis[0].plotLinesAndBands;if(e){e.forEach(function(t){t.svgElem.removeClass("spy-chart-plot-band-current"),t.options.groupId===i&&t.svgElem.addClass("spy-chart-plot-band-current")})}},c=[25,-15],d=[10,0],p=a.extend({init:function(){this._parent(),this.svgContainer=null,this.xychartViewer=null,this.nbFrames=0,this.currentGroup=null,this.pcsData={}},_getDataDisplay:function(){var t,i=this.implementation.getDataDisplay();return i&&i.spm&&i.spm.window&&i.spm.window.SPMUI&&(t=i.spm.window.SPMUI.getActiveDD()),t},_tooltipPositionerForAnimation:function(t,i,e){return this._playFlag?{x:100,y:10}:o.Tooltip.prototype.getPosition.apply(this._chart.tooltip,[t,i,e])},_hoverPoints:function(t,i){var e=[];if(this._chart){var a,n;if(this._chart.series&&(n=this._chart.series.filter(function(t){return t.visible})),n&&n.length>0){var o=function(i){return i&&i.sma_globalFrameIdx===t};if(i)for(var s=0;!a&&s<n.length;)a=n[s++].data.find(o);else a=n[0].data.find(o)}if(a){e.push(a);for(var r=a.index,l=1;l<n.length;l++){var h=n[l].data[r];h&&e.push(h)}}e&&e.forEach(function(t){t.onMouseOver()})}},_getMarkerColor:function(t){return t.style.markerColor?t.style.markerColor:t.color},_getMarkerSize:function(t){return isNaN(t.style.markerSize)?1:t.style.markerSize},_getMarkerRadius:function(t){return 2*this._getMarkerSize(t)},_findCurveForGroup:function(t){for(var i,e=this.implementation.getCurves(),a=!0,n=0;n<e.length&&!i;n++)i=e[n].rootName===t.rootName&&e[n].loadCaseName===t.loadCaseName?e[n]:void 0,a=a&&!e[n].rootName&&e[n].isCrossGroup;return!i&&a&&(i=e[0]),i},_findLocalFrame:function(t,i,e,a){var n=NaN;if(t&&i&&!isNaN(e))if(0===t.getGroups().length)n=e;else{for(
//!! we can have more curve values (sensors values) than frames (sampling)
var o,s,r,l=i.frameList,h=0;h<l.length;h++)if(l[h].globalIndex===e+1){if(r=h,l[h].isScaledPosition)for(var u=h;u<l.length;u++)l[u].isScaledPosition||(r=u);break}if(!isNaN(r))if(o=l[r].position,s=l[r].localIndex-1,isNaN(o))isNaN(s)||(n=s);else{var c=t.getValues(),d=0,p=c.length-1,m=0;a&&(d=a.start,p=a.end);for(var g=d;g<=p;g++){if(c[g].getPosition()===o&&(c[g].getGroupId()===i.id||c[g].getGroupId()===i.idNoMode)){n=m;break}m++}}}return n},_addAxisExponent:function(t){if(t&&!isNaN(t.exponent)){var i=t.scaleFunction(t.max);i+=c[t.dimension-1];var e=d[t.dimension-1].toString(),a=1===t.dimension?"translate ("+i.toString()+", "+e+")":"translate ("+e+", "+i.toString()+" )",n=t.svg.append("g").attr("class","spy-data-chart-axis-exponent").attr("transform",a);n.append("text").style("fill",t.color).text("x 10"),n.append("text").attr("class","spy-data-chart-axis-exponent-power").style("fill",t.color).text(t.exponent.toString())}},_clickHandler:function(t){if(this._chart){var e=t.point;if(e){var a=e.sma_globalFrameIdx,n=this._getDataDisplay();n&&!isNaN(a)&&i.publish({event:n.getSPM().getContext()+"/SPY/FRAME/SELECT",data:a+1})}}},buildXYChart:function(t,a,s,r){var l=new Date;if(t){if(a){var c=t.implementation.getMetadata(),d=t.implementation.getCurves(),p=t.implementation.getAxisList("x"),m=t.implementation.getAxisList("y");if(d&&c&&p&&m&&p.length>0&&m.length>0){var g,f=c.isBarChart;if(200,(g=!isNaN(s)&&s>0?!isNaN(a.offsetWidth)&&a.offsetWidth>0?Math.min(s,a.offsetWidth):s:!isNaN(a.offsetWidth)&&a.offsetWidth>0?a.offsetWidth:200)<=0)return;g-=20;var v=70,x={count:0},y={count:0},N=function(t,i){return function(e){e.getPosition()===i&&t.count++}};m.forEach(N(x,"left")),m.forEach(N(y,"right")),p.forEach(N({count:0},"top")),p.forEach(N({count:0},"bottom")),0!==y.count||1!==x.count||m[0].getName()||(v=55);var C=g-x.count*v-(30+y.count*v),b=Math.round(C/58),_=this._getDataDisplay();if(!_)return;var A=c.animation&&_.isAnimated();this._chartOptions={boost:{useGPUTranslations:!0},chart:{styledMode:!0,className:c.secondaryGridLines?void 0:"spy-chart-hiddenSecondaryGrid",width:g,height:r,alignTicks:c.alignTicks},title:{text:void 0},xAxis:[],yAxis:[],legend:{align:"left",verticalAlign:"bottom",borderWidth:0},tooltip:{useHTML:!0,shared:!0,hideDelay:1e3,crosshairs:!0,positioner:this._tooltipPositionerForAnimation.bind(this)},plotOptions:{series:{className:"spy-chart-series",cursor:"pointer",point:{events:{click:A?this._clickHandler.bind(this):void 0}},marker:{lineWidth:1}}},series:[],credits:{enabled:!1},exporting:{enabled:!1}},this.curves=[];var S,F=!0,P=!0,D={};i.subscribe({event:_.getSPM().getContext()+"/SPY/FRAME/ENABLESELECT"},function(){this._playFlag=!1,this._chart.tooltip.positioner=void 0}.bind(this));var I,M,E,G,k=void 0;_&&_.isAnimated()&&c.animation&&(k=_.getComputedFramesByGroup());var L=d[0].getValues().length-1;if(c.animation&&_.isAnimated()&&_){E=!0===_.isPartialAnimationMode();var O=isNaN(this.initFrame)?_.getTotalNumberOfFrames()-1:this.initFrame;G=E?_.getAnimationScope(O):_.getDefaultAnimationScope(O),L=isNaN(this.initFrame)?G.frames[G.frames.length-1].globalIndex-1:this.initFrame,(I=_.getGroupForFrame(L))&&I.group&&(M=I.group.unit?" "+I.group.unit:"",I.group.rootName,I.group.loadCaseName),_.getAnimationStructure().groupList}this._displayPositionsOnX=c.hasPositions&&M&&(!c.isCrossGroup||E),p.length>1?this._displayPositionsOnX=!1:this._displayPositionsOnX=!p[0].getName()&&!p[0].getUnit()&&this._displayPositionsOnX,this.curvesScope={};var T=!0,w=[],Y=function(t){var i=n.parseGroupIds(t),e=n.buildGroupIdNoMode(i[0],i[1]),a=n.buildGroupName(i);w.push({id:t,idNoMode:e,rootName:i[0],loadCaseName:n.isModeSeparator(i[1])?void 0:i[1],name:a})},X=function(t,i){return G.groupIDs.indexOf(t)>=0||G.groupIDsNoMode.indexOf(i)>=0||G.groupIDsNoMode.indexOf(t)>=0},W=function(t){return G&&!X(t.id,t.idNoMode)&&(t.isNotInCurrentAnimation=!0),!E||X(t.id,t.idNoMode)};if(c.oneCurvePerGroup&&G){d=d.filter(function(t){var i=t.getMetadata();return void 0===t.listGroups[0]||X(t.listGroups[0],i.rootName)})}for(var U,B=!1,V=0,R=0;R<d.length;R++){var H=d[R].getMetadata();T=T&&H.isBijective,(S={id:H.name?H.name.replace(/\s+/g,""):R.toString(),name:H.name,nameY:H.nameY,rootName:H.rootName,loadCaseName:H.loadCaseName,pieces:[],domainX:[],domainY:[],domainPosition:[],domainGroup:[],offset:d[R].offset,style:d[R].getCurveStyle(),xAxis:this.implementation.getAxis(d[R].getAssignedAxisX()),yAxis:this.implementation.getAxis(d[R].getAssignedAxisY()),isFilled:H.isFilled,isStacked:H.isStacked}).style.color=S.style.color,S.color=S.style.color;var z=S.isFilled?"area":"line";f?z="column":"line"===z&&"0"===S.style.lineWidth&&(z="scatter");var q=S.isStacked?"normal":void 0;"percentage"===S.yAxis.getScale()&&(q="percent");var j=S.name;c.oneCurvePerGroup&&S.rootName&&(j=n.buildGroupName([S.rootName,S.loadCaseName]));var J={type:z,stacking:q,name:j,allowPointSelect:!0,boostThreshold:4e3,color:S.color,lineWidth:S.style.lineWidth?parseInt(S.style.lineWidth):1,dashStyle:S.style.lineStyle,marker:{radius:this._getMarkerRadius(S),fillColor:this._getMarkerColor(S)},keys:["x","y","sma_group","sma_position","sma_globalFrameIdx","sma_groupNLS"],data:[]};c.linkAllCurvesAsOneSerie&&U&&(J.linkedTo=U),U=j,V+=j?j.length:0;var K,Q=-1,Z=d[R].getGroups();w=[],Z.forEach(Y),G&&!c.oneCurvePerGroup&&(w=w.filter(W));var $=d[R].getValues();this.curvesScope.end=0;var tt,it,et=!1,at=-1;$.length>=4e3&&(B=!0);for(var nt=0;nt<$.length;nt++)if($[nt]&&(!E||E&&G&&X($[nt].getGroupId(),$[nt].getGroupId()))){var ot=this._displayPositionsOnX?$[nt].getPosition():$[nt].getX(),st=$[nt].getY(),rt=!0;if("log"===S.xAxis.getScale()&&(rt=ot>0),"log"===S.yAxis.getScale()&&(rt=st>0),rt){et||(S.pieces.push([]),at++,tt=S.pieces[at],it=0);var lt=$[nt].getPosition(),ht=$[nt].getGroupId(),ut=$[nt].getGroupIdNLS(),ct=k?_.getFrameGlobalIdxFromPosition(ht,lt):void 0;if(J.data.push([f?void 0:ot,st,ht,lt,ct,ut]),S.domainX.push(ot),S.domainY.push(st),S.domainPosition.push(lt),Q++,tt.push({x:ot,y:st,position:lt,group:ht,curveIdx:R,globalFrameIdx:ct,idx:it,pieceIdx:at}),0===R||c.oneCurvePerGroup)if(D[ht]){D[ht].count++;var dt=$[nt+1]?$[nt+1].getX():void 0;D[ht].end=isNaN(dt)?ot:(ot+dt)/2,c.oneCurvePerGroup||(K=D[ht].end)}else D[ht]={count:1,start:isNaN(K)?S.domainX[Q]:K};isNaN(this.curvesScope.start)&&(this.curvesScope.start=nt),this.curvesScope.end=nt}et=rt}P&&(P=h(S.domainX,1e3))&&(b=b>S.domainX.length?S.domainX.length:b),F&&(F=h(S.domainY,1e4)),this.curves.push(S),this._chartOptions.series.push(J)}if(V=Math.round(V/d.length),!f&&!c.oneCurvePerGroup&&c.hasPositions){var pt="",mt="{point.key}";this._displayPositionsOnX?mt+=" "+M:(pt='<span style="font-size: 12px">{point.point.sma_groupNLS}</span><br/>',mt="{point.point.sma_position} "+M),this._chartOptions.tooltip.headerFormat=pt+'<span style="font-size: 12px;">@ <b>'+mt+"</b></span><br/>"}this._chartOptions.tooltip.pointFormatter=function(){var t='<span style="color:'+this.series.color+';">‚óè</span>',i='<span style="color:'+this.series.color+';"> <b> '+this.y+" </b> </span>",e=this.series.name,a=V<=20;if(a)e+=": ";else{var n=Math.round(C/12);if(e.length>n){var o=Math.round(n/2);e=this.series.name.slice(0,o)+"..."+this.series.name.slice(e.length-o,e.length)}}var s="<span>"+e+"</span>";return t+=a?s+i:i+s,t+="<br/>"},this.xAxisLayout=[],this.yAxisLayout=[];var gt,ft,vt,xt,yt=function(t,i){i.min=t.getFixedBounds().min,i.max=t.getFixedBounds().max},Nt=function(t){var i={id:t.getId(),dimension:t.getDimension(),name:t.getName(),unit:t.getUnit(),position:t.getPosition(),scale:t.getScale(),assignedCurves:this.curves.filter(function(i){return(2===t.getDimension()?i.yAxis.getId():i.xAxis.getId())===t.getId()}),color:t.getColor(),tickNb:t.getTickNb(),valueOfInterest:t.getValueOfInterest(),precision:t.getPrecision(),exponent:t.getExponent()};return i.assignedCurves.forEach(function(e){2===t.getDimension()?e.yAxisLayout=i:e.xAxisLayout=i}),i.color||(i.color=this.curves.length>1?function(t){var i="#000";if(t.assignedCurves.length>=1){i=t.assignedCurves[0].color;for(var e=!0,a=1;a<t.assignedCurves.length&&e;a++)e=t.assignedCurves[a].color===i;i=e?i:"#000"}return i}(i):"#000"),i}.bind(this),Ct=0,bt=0,_t=0,At=0;p.forEach(function(t){var i=Nt(t);"bottom"===i.position&&(i.rank=bt++,gt=gt||i),"top"===i.position&&(i.rank=Ct++,ft=ft||i),yt(t,i),this.xAxisLayout.push(i)}.bind(this)),gt?gt.isMain=!0:ft&&(ft.isMain=!0),m.forEach(function(t){var i=Nt(t);"left"===i.position&&(i.rank=_t++,vt=vt||i),"right"===i.position&&(i.rank=At++,xt=xt||i),yt(t,i),this.yAxisLayout.push(i)}.bind(this)),vt?vt.isMain=!0:xt&&(xt.isMain=!0);for(var St=0;St<this.curves.length;St++)this._chartOptions.series[St].xAxis=this.curves[St].xAxisLayout.id,this._chartOptions.series[St].yAxis=this.curves[St].yAxisLayout.id;var Ft,Pt=function(t){var i=t.name?t.name:"";return t.unit&&t.unit.length>0&&(i.length>0?i+=" ("+t.unit+")":i=t.unit),i};c.isCrossGroup&&w.length>0&&(Ft=[],w.forEach(function(t){Ft.push(t.name)}));var Dt=0;if(this.xAxisLayout.forEach(function(t){Dt++;var i={id:t.id,className:Dt>1?"spy-chart-axis-secondary":"spy-chart-axis-primary",allowDecimals:!P,title:{text:this._displayPositionsOnX?M:Pt(t)},lineColor:t.color,tickColor:t.color,min:t.min,max:t.max,opposite:"top"===t.position,plotLines:[{color:t.color,value:t.valueOfInterest}]};f?i.categories=Ft:(i.type="log"===t.scale?"logarithmic":"linear",i.crosshair=!0),i.labels={enabled:f||!c.isCrossGroupNoMode||E},isNaN(t.precision)||(i.labels.format="{value:,."+t.precision.toString()+"e}"),this._chartOptions.xAxis.push(i)}.bind(this)),w.length>1&&!c.oneCurvePerGroup){this._chartOptions.xAxis[0].plotBands=[];var It=this._chartOptions.xAxis[0].plotBands,Mt=this._chartOptions.chart.width/w.length,Et=-.5;w.forEach(function(t){var i={groupId:t.id};f?(i.from=Et,i.to=Et+1,Et++,It.push(i)):D[t.id]&&(i.from=D[t.id].start,i.to=D[t.id].end,i.label={text:function(t,i){var e=t;if(7.13*t.length>=i){var a=3+t.length-i/7.13,n=Math.floor((t.length-a)/2),o=Math.floor((t.length+a)/2);e=t.slice(0,n)+"..."+t.slice(o,t.length)}return e}(t.name,Mt),align:"center"},It.push(i))})}var Gt=0;if(this.yAxisLayout.forEach(function(t){Gt++;var i={id:t.id,className:Gt>1?"spy-chart-axis-secondary":"spy-chart-axis-primary",type:"log"===t.scale?"logarithmic":"linear",title:{text:Pt(t)},lineColor:t.color,tickColor:t.color,tickWidth:1,allowDecimals:!F,min:t.min,max:t.max,opposite:"right"===t.position,plotLines:[{color:t.color,value:t.valueOfInterest}]};isNaN(t.precision)||(i.labels={format:"{value:,."+t.precision.toString()+"e}"}),this._chartOptions.yAxis.push(i);if("log"===t.scale){var e=t.precision;isNaN(e)?",.2e":",."+e.toString()+"e"}isNaN(t.tickNb),isNaN(t.valueOfInterest)}.bind(this)),f);else{var kt=c.animation&&_.isAnimated();isNaN(this.initFrame)||isNaN(this.currentCurveIndex)||(S=this.curves[this.currentCurveIndex]),isNaN(this.currentCurveIndex)&&(this.currentCurveIndex=this.curves.length-1),c.oneCurvePerGroup,kt&&I&&I.group&&(this.initFrame=L,L=this._findLocalFrame(this._findCurveForGroup(I.group),I.group,L,this.curvesScope)),c.oneCurvePerGroup}var Lt="hidden";f?G&&G.hasModes&&!E&&(Lt=w.find(function(t){return t.isNotInCurrentAnimation})?"hidden":"visible"):E&&(Lt=w.length>0?"visible":Lt);var Ot=function(){var t=new Date;this._chart=o.chart(a,this._chartOptions,function(i){var a=function(t,i){if(t&&i)for(var e in t.axisTitle&&(t.axisTitle.element.style.fill=i),t.axisLine&&(t.axisLine.element.style.stroke=i),t.ticks)t.ticks[e].mark.element.style.stroke=i,t.ticks[e].label.element.style.fill=i};if(i){var n=0;this.yAxisLayout.length>1&&this.yAxisLayout.forEach(function(t){a(i.yAxis[n],t.color),n++}),this.xAxisLayout.length>1&&(n=0,this.xAxisLayout.forEach(function(t){a(i.xAxis[n],t.color),n++}))}I&&w&&w.length>1&&u(i,I.group.idNoMode);var o=new Date;this.pcsData.renderDuration=o-t,this.pcsData.totalBuildDuration=o-l;var s=(i=this.implementation).analytics;if(s){var r=this._getDataDisplay(),h=r.spm.extractTypingInfoForDataDisplay(r);if(h){h.chartType=i.getMetadata().isBarChart?"BAR":"XY";var d=e.createECChartLoaded(i.getId(),void 0,h);s.visuCreationTime=this.pcsData.totalBuildDuration,e.addLoadingData(d.id,s),e.publishTracker(d.id)}}setTimeout(function(){isNaN(this.initFrame)||this._hoverPoints(this.initFrame,c.oneCurvePerGroup)}.bind(this),1e3)}.bind(this))}.bind(this);B?require(["DS/SPYTempVenHC/Boost"],Ot.bind(this)):Ot()}}}else console.log(" 3DPlay for Simulation - XY component not defined")},_buildFrame:function(t,i,e){this.implementation&&(this._lastRequiredWidth=t,void 0!==e&&(this._visibility=e),this._visibility&&this.buildXYChart(this,this.svgContainer,t,i))},updateFrame:function(t,i){if(this.svgContainer){var e=this._lastRequiredWidth!==t,a=this.layout.extracted;(e&&!a||!isNaN(i))&&(this._lastRequiredWidth=t,this.svgContainer.empty(),isNaN(i)||(this.initFrame=i),this._visibility&&this._buildFrame(t))}},buildFrame:function(i,e,a,n){this._lastRequiredWidth=i;var o=new t.Element("tr",{class:"spy-infopane-content-table-chartrow"});return this.layout.chartCell=new t.Element("td",{class:"spy-infopane-content-table-chartcell"}).inject(o),this.layout.chartCell.setAttributes({colSpan:"5"}),this.svgContainer=new t.Element("div",{id:"xychartSvgContainer",class:"spy-chart-container"}),this.buildExtractableContainer(this.svgContainer,this.layout.chartCell,e)||this._buildFrame(i,null,e),this.selectableWidget=this.svgContainer,a&&a(o),o},syncFrameWithAnimation:function(t){var i=this.implementation.getMetadata();if(i.animation){var e=this._getDataDisplay();if(e){var a=e.getGroupForFrame(t);a&&this.curves&&(this.currentGroup=a.group,u(this._chart,this.currentGroup.idNoMode),!i.isBarChart&&this._visibility&&this._hoverPoints(t,i.oneCurvePerGroup),this.currentGroupValue&&this.currentGroupValue.text(this.currentGroup.rootName),this.currentLoadCaseValue&&this.currentGroup.loadCaseName&&this.currentLoadCaseValue.text(this.currentGroup.loadCaseName))}}},initAnimation:function(t){if(this.implementation.animation){this._chart&&this._chart.tooltip&&(this._chart.tooltip.positioner=this._tooltipPositionerForAnimation),this._playFlag=!0;var i=this._getDataDisplay();i&&(this.nbFrames=i.getTotalNumberOfFrames()),t&&t()}else t&&t()},animate:function(t,i){this.implementation.animation&&(this._playFlag=!!i&&!i.navigateMode,this.syncFrameWithAnimation(t),this.initFrame=t)},onExtractableExpanderChange:function(t){this._parent(t),this._visibility=t,t?this._buildFrame():this.svgContainer.empty()},getExtractedContentId:function(){var t=this.implementation,i=t.getMetadata();return t.id?t.id:i.name},getExtractedContentTitle:function(){return this.implementation.getMetadata().name},buildExtractableContent:function(t,i,e){this._buildFrame(t,i,e)},getExtractedContent:function(){return this.svgContainer}});return t.namespace("DS/SPYExtUI/CATSimNavDataFrameViewXYChartUI",p)});