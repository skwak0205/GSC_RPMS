define("DS/DMUBaseUIWebAppCommon/DMUWebAppController",["UWA/Class","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/ApplicationFrame/CommandsManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUMeasurable/DMUToolsSceneGraph","DS/PADUtils/PADUtilsServices","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/CATWebUXComponents/CATWebUXUtils","DS/PADUtils/PADSettingsMgt","DS/DMUBaseUIControllers/DMUSceneDisplayController","DS/DMUBaseExperience/DMUContextManager","i18n!DS/DMUBaseUI/assets/nls/DMUBaseUI","i18n!DS/DMUBaseUIWebAppCommon/assets/nls/DMUBaseUIWebAppCommon"],function(e,t,r,a,n,o,i,l,s,d,g,m,c,u,D,p,C){"use strict";return e.extend({init:function(e){this._parent(e);var h,M,S,f=(e||{}).ctxViewer,U=D.getEventsController({viewer:f.getViewer()}),v=!1;this.setSlideShowController=function(e){h=e},this.setValidatedObjCreationFlag=function(e){v=e};this.loadContext=function(e,t,r,a,n){var m;t&&n&&e&&(m=S&&S.objectId===e.reviewId?S:e,i.multiTenantMgt([m],o.getRoots(f),function(e){if(!e.isMultiTenant&&("_DMUValidationValidation"===r||"_DMUValidationExposedPresentation"===r)){var t={};t.reviewId=m.objectId,t.context=f,t.displayName=m.displayName,t.displayType=m.displayType?m.displayType:"DMUValidationValidation"===m.objectType?"Review":void 0,t.type="_DMUValidationValidation"===r?"DMUValidationValidation":"DMUValidationExposedPresentation",t.readOnly=!1,t.cbRootAdded=function(){S=m},t.cbOK=function(e){let t=!1;e&&!0===e.sameReview&&(t=!0);var r=g.createReviewContext({context:f}),a=(M||(M=s.giveDMUSlidesController({context:f.getFrameWindow()})),M),o=r.getValidation(),i=o.getLoadedRepRefs();i.length>0&&a&&(a=s.giveDMUSlidesController({context:f.getFrameWindow()}),n.autoReframe=!1,"DMUValidationValidation"!==m.objectType||t||a.setActiveSlide(i[0].getMarkupContent().getSlides()[0]));var l,c,u=[];let p=o.getHighlights();if(p&&p.length)for(l=0;l<p.length;l++)u.push(p[l]);if(c=[],o){var C=o.getLoadedRepRefs();for(l=0;l<C.length;l++){c=c.concat(C[l].getMarkupContent().getSlides());for(let e=0;e<C[l].getMarkupContent().getSlides().length;e++){var h=C[l].getMarkupContent().getSlides()[e].getDMUObjects();for(let e=0;e<h.length;e++)h[e].getDMUComments&&(c=c.concat(h[e].getDMUComments()))}}}var S=function(e,t){d.giveDMUCommentsController({context:f.getFrameWindow()}).applyComment({commentId:e,markupId:t})};for(let e=0;e<c.length;e++)for(let r=0;r<u.length;r++)if(u[r].getAttribute("sPresentationSlideID")===c[e].getAttribute("sUuid")){if(u[r].getPlmID()===m.objectId)if("DMUSlide"===c[e].getType())a&&a.setActiveSlide(c[e]);else if("DMUComment"===c[e].getType()){let a=c[e].getAttribute("sUuid"),n=u[r].getAttribute("sRepRefMarkupID");if(t)S(a,n);else{let e=U.addEvent("on2DDocumentLoadSuccess",function(){S(a,n),U.removeEvent(e)})}}t||n.highlightInitialization({highlight:u[r],slide:c[e]})}U.addEvent("onReplyExpandRequest",function(e){var t=D.getReviewContext({viewer:f.getFrameWindow().getViewer()}),r=t.getValidation();U.fireEvent("onGetMarkupJsonEvt",{markup:r.getRepRef(e.data.id),onLoadingCompleted:function(e,o){r.setCurrentMarkup(o),U.fireEvent("onImportModelEvt",{asset:e,onImportCompleted:function(){var e=t.getCurrentSessionMarkup();o.setMarkupContent(e),e.setMarkupOwner(o),a&&a.setActiveSlide(e.getSlides()[0]),e.setReadOnly(t.isReadOnly());let i=r.getHighlightsData();if(i&&i.length)for(c=e.getSlides(),l=0;l<i.length;l++)for(var s=0;s<c.length;s++)i[l].slideId===c[s].getAttribute("sUuid")&&n.highlightInitialization({highlight:i[l],slide:c[s]})}})}})})},t.cbFailed=function(){},n.loadValidation(t),l.setSlidePreferences({context:f.getFrameWindow(),preferences:{displayNominal:!1,displayInWork:!1}})}}))},this.createSharedPreferences=function(e){e&&e.addPreferences([{nls:C.markerPrefTitle,id:"MarkerPreferences",type:"section",preferences:[{nls:C.validatedStampMarkerLabel,id:"DMUMarkerValidatedStampLabel",type:"editor",getValue:function(){return localStorage.getItem("DMUMarkerValidatedStampLabel")||p.defaultValidatedStampLabel},getDefaultValue:function(){return p.defaultValidatedStampLabel},setValue:function(e){e!==localStorage.getItem("DMUMarkerValidatedStampLabel")&&localStorage.setItem("DMUMarkerValidatedStampLabel",e)}},{nls:C.rejectedStampMarkerLabel,id:"DMUMarkerRejectedStampLabel",type:"editor",getValue:function(){return localStorage.getItem("DMUMarkerRejectedStampLabel")||p.defaultRejectedStampLabel},getDefaultValue:function(){return p.defaultRejectedStampLabel},setValue:function(e){e!==localStorage.getItem("DMUMarkerRejectedStampLabel")&&localStorage.setItem("DMUMarkerRejectedStampLabel",e)}}]},{nls:C.compareSectionTitle,id:"ComparePreferences",type:"section",preferences:[{nls:C.firstProductColor,id:"DMUCompareFirstColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompareFirstColor")?localStorage.getItem("DMUCompareFirstColor"):"#FF0000"},getDefaultValue:function(){return"#FF0000"},setValue:function(e){localStorage.setItem("DMUCompareFirstColor",e),U&&U.fireEvent("onDMUPreferencesChanged",{DMUCompareFirstColor:e})}},{nls:C.secondProductColor,id:"DMUCompareSecondColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompareSecondColor")?localStorage.getItem("DMUCompareSecondColor"):"#00FF00"},getDefaultValue:function(){return"#00FF00"},setValue:function(e){localStorage.setItem("DMUCompareSecondColor",e),U&&U.fireEvent("onDMUPreferencesChanged",{DMUCompareSecondColor:e})}},{nls:C.compare3DCommonColor,id:"DMUCompare3DCommonColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompare3DCommonColor")?localStorage.getItem("DMUCompare3DCommonColor"):"#D3D3D3"},getDefaultValue:function(){return"#D3D3D3"},setValue:function(e){localStorage.setItem("DMUCompare3DCommonColor",e),U&&U.fireEvent("onDMUPreferencesChanged",{DMUCompare3DCommonColor:e})}},{nls:C.compare2DCommonColor,id:"DMUCompare2DCommonColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompare2DCommonColor")?localStorage.getItem("DMUCompare2DCommonColor"):"#000000"},getDefaultValue:function(){return"#000000"},setValue:function(e){localStorage.setItem("DMUCompare2DCommonColor",e),U&&U.fireEvent("onDMUPreferencesChanged",{DMUCompare2DCommonColor:e})}}]},{nls:C.slideSectionTitle,id:"SlidePreferences",type:"section",preferences:[{nls:C.slideNameFromFeature,id:"DMUSlideNameFromFeature",type:"checkbox",getValue:function(){return"false"!==localStorage.getItem("DMUSlideNameFromFeature")},getDefaultValue:function(){return!0},setValue:function(e){e!==("false"!==localStorage.getItem("DMUSlideNameFromFeature"))&&(localStorage.setItem("DMUSlideNameFromFeature",e?"true":"false"),U&&U.fireEvent("onDMUPreferencesChanged",{DMUSlideNameFromFeature:e}))}},{nls:C.slideTitleDisplayLbl,id:"DMUDisplaySlideTitle",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("DMUDisplaySlideTitle")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("DMUDisplaySlideTitle"))&&(localStorage.setItem("DMUDisplaySlideTitle",e?"true":"false"),U&&U.fireEvent("onDMUPreferencesChanged",{DMUDisplaySlideTitle:e}))}},{nls:C.preferences.slideCaptureSpecLayers,id:"DMUCaptureSpecLayers",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("DMUCaptureSpecLayers")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("DMUCaptureSpecLayers"))&&(localStorage.setItem("DMUCaptureSpecLayers",e?"true":"false"),U&&U.fireEvent("onDMUPreferencesChanged",{DMUCaptureSpecLayers:e}))}}]}])},this.removeSharedPreferences=function(e){e&&e.removePreferences(["MarkerPreferences","ComparePreferences","SlidePreferences"])},this._onContextualBarReadyCB=function(){var e,r,a=[],n=t.get();if(n.length){for(var i,l=!1,s=null,d=!1,g=0;g<n.length;g++){for(i=n[g].pathElement.clone();i&&i.internalPath.length;)i=i.getParentPath();if(i.getLastElement(!0).getAnnotationClassType||i.getLastElement(!0).getDMUType)return{cmdList:[]};s=o.getLastReference(i);let e=!f.getController().isRootSupported||f.getController().isRootSupported(o.getNodeID(s.getLastElement(!0)));s&&o.isReference(s.getLastElement(!0))&&e?l=!0:s=null}var m=n[n.length-1];m&&m.event&&m.event.lastPosition&&m.event.startPosition&&(e=m.event.startPosition,r=m.event.lastPosition,e.x>=r.x-3&&e.x<=r.x+3&&e.y>=r.y-3&&e.y<=r.y+3)&&m.pathElement.externalPath.length>2&&m.pathElement.externalPath[0]===f.getRootBagPath().getLastElement(!0)&&(d=!0);var c=D.getReviewContext({context:f}),p=c?c.getCurrentSessionMarkup():null;let t="3D"===D.getCurrentReviewContext()||"ITF"===D.getCurrentReviewContext();if(p&&p.getActiveFlag()&&!p.isReadOnly()&&p.isVisible()&&p.getCurrentSlide()&&!v){if(l&&t&&a.push({name:"DMUHideShowOverloadStr",line:1,hdr_list:["DMUHideShowOverloadHdr"]}),s&&s.externalPath&&s.externalPath.length&&t){var C=u.getDMUSceneDisplayController({context:f});C&&!C.getCurrentComparedObjectIDPaths()&&a.push({name:"DMUColorOpacityOverloadStr",line:1,hdr_list:["DMUColorOpacityOverloadHdr"]}),a.push({name:"DMUPositionOverloadStr",line:1,hdr_list:["DMUPositionOverloadHdr"]})}}else l&&t&&a.push({name:"HideShowStr",line:1,hdr_list:["HideShowHdr"]});d&&t?a.push({name:"DMULevelSelectorStr",line:1,hdr_list:["DMULevelSelectorHdr"]}):1===n.length&&m&&m.pathElement&&m.pathElement.getParentPath().isEqual(f.getRootBagPath())&&t&&a.push({name:"RemoveRootStr",line:1,hdr_list:["RemoveRootHdr"]})}return{cmdList:a}},this._applyFlag=function(e,t){for(var r,n=0;n<e.length;n++)(r=a.getCommand(e[n],f.getCommandContext()))||(r=a.getCommandCheckHeader(e[n],f.getCommandContext())),r&&(t?r.enable():r.disable())},this._onContextualMenuReadyCB=function(e,a){var i=[];if(h&&h.getActiveState())return{cmdList:i};var l=D.getReviewContext({context:f}),s=t.get(),d=!f.getViewer().get2DMode(),g=n.getManager({name:"DMUUserExperienceManager",context:f.getFrameWindow()}),c={x:a.XmousePositionWithDevPxRatio,y:a.YmousePositionWithDevPxRatio};if(0===(g?g.pick(c,"mesh"):f.getViewer().pick({xPix:c.x,yPix:c.y},"mesh",!0).path).length){var u=r.get(),p=u&&u[0]&&u[0].pathElement?u[0].pathElement.getLastElement(!0):null,C=p&&p.getDMUType?p.getDMUType():"";if("DMUSlide"===C||"DMUFormat"===C||"DMUComment"===C||"DMUMarkup"===C||"DMUValidationExposedPresentation"===C||"DMUValidationCheck"===C||"Checks"===C||"Highlights"===C)return{cmdList:i};i=[{line:1,name:"DMU3DReviewDisplaySubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:!m.isMobile()&&d?["VisuQMCommand","PAD3DToggleStatusBarHdr"]:["PAD3DToggleStatusBarHdr"]},{line:1,name:"DMU3DReviewAmbiencesSubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]}]}else if(s.length){var M=l?l.getCurrentSessionMarkup():null,S=!1,U=!1,v=!1,P=M&&!M.isReadOnly()&&M.isVisible();for(let e=0;e<s.length;e++){if(M&&!M.isReadOnly()&&M.isVisible()){var V=M.getOrCreateOccurrenceOverloader(s[e]);if(!S)if(V&&V.isOverloadedInCurrentSlide())S=!0;else{let t=s[e].pathElement.clone();t.getParentPath()&&o.isInstance(t.getParentPath().getLastElement(!0))&&(V=M.getOrCreateOccurrenceOverloader({pathElement:t.getParentPath()}))&&V.isOverloadedInCurrentSlide()&&(S=!0)}}for(var y=!0,I=0;I<s[e].pathElement.externalPath.length;I++)s[e].pathElement.externalPath[I].getDMUType&&(U=!0,y=!1);y&&(v=!0)}var R=!1;if(g&&(R=g.areOccurenceOverloadsCopied()),S&&(i=i.concat([{line:1,name:"DMURemoveOverloadStr",hdr_list:["DMURemoveOverloadHdr"]},{line:1,name:"DMUCopyStr",hdr_list:["DMUCopyHdr"]},{line:1,name:"DMUCutStr",hdr_list:["DMUCutHdr"]}])),v&&R&&(i=i.concat([{line:1,name:"DMUPasteStr",hdr_list:["DMUPasteHdr"]},{line:1,name:"DMUPasteSpecialStr",hdr_list:["DMUPasteSpecialHdr"]}])),!U){let e=!f.getController().isRootSupported||s.length>=1&&s[0].pathElement.externalPath.length>=2&&f.getController().isRootSupported(o.getNodeID(s[0].pathElement.externalPath[1]));if(d&&e&&i.push({line:1,name:"FocusOn",hdr_list:["FocusOnHdr"]}),i.push({line:1,name:"ReframeOn",hdr_list:["ReframeOnHdr"]}),P&&d&&e){var x=!1;let e,t;for(let r=0;r<s.length;r++){for(e=s[r].pathElement.clone();e&&e.internalPath.length;)e=e.getParentPath();if((t=o.getLastReference(e))&&o.isReference(t.getLastElement(!0))){x=!0;break}}t&&t.externalPath.length<=2&&(x=!1),x&&i.push({line:1,name:"DMUHideShowOverloadStr",hdr_list:["DMUHideShowOverloadHdr"]})}i.push({line:1,name:"EditPropertiesCmd",hdr_list:["ActionBar_Attributes"]}),d&&e&&i.push({line:1,name:"PAD3DViewerToggleGeometrySection",resourceFile:"ENOPAD3DViewer/ENOPAD3DViewer",hdr_list:["PAD3DToggleSimplifiedHdr","PAD3DToggleAccurateHdr"]})}}return{cmdList:i}},this.highlightInitialization=function(e){e&&e.slide&&e.slide.setAssociatedHighlightData&&e.highlight&&e.slide.setAssociatedHighlightData(JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:i.getPlatformId(),serviceId:"3DSpace",contextId:c.getSetting("pad_security_ctx")?c.getSetting("pad_security_ctx"):void 0,objectId:e.highlight.getPlmID(),objectType:e.highlight.getType(),displayName:e.highlight.getName()}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}))}}})});