define("DS/XCityLayer/Vector",["DS/Visualization/ThreeJS_DS","UWA/Core","UWA/Class"],function(e,t){"use strict";var r={Type:{POINT:0,MULTIPOINT:1,LINESTRING:2,MULTILINESTRING:3,POLYGON:4,MULTIPOLYGON:5},getVerticesAsArrayOfLines:function(e,t){return e.getVertices(t)}};return r.Geometry=UWA.Class.extend({init:function(){},getNumGeometries:function(){return 1},getVertices:function(){return[]}}),r.Point2D=UWA.Class.extend({init:function(e,t){this.type=r.Type.POINT,this.x=e,this.y=t},getVertices:function(){return[this.x,this.y]},intersect:function(e){return Math.abs(this.x-e.getCenter().x)<.5*e.getSize().x&&Math.abs(this.y-e.getCenter().y)<.5*e.getSize().y},isInAABBOX:function(e){return Math.abs(this.x-e.getCenter().x)<.5*e.getSize().x&&Math.abs(this.y-e.getCenter().y)<.5*e.getSize().y},getCenter:function(){return new e.Vector2(this.x,this.y)}}),r.Point3D=r.Point2D.extend({init:function(e,t,r){this._parent(e,t),this.z=r},getVertices:function(){return[this.x,this.y,this.z]},getCenter:function(){return new e.Vector3(this.x,this.y,this.z)}}),r.MultiPoint=UWA.Class.extend({init:function(){this.geometryList=[],this.type=r.Type.MULTIPOINT},addGeometry:function(e){this.geometryList.push(e)},getNumGeometries:function(){return this.geometryList.length},getVertices:function(e){if(void 0===e){for(var t=[],r=0;r<this.geometryList.length;r++)t.push(this.geometryList[r].getVertices());return t}return this.geometryList[e].getVertices()},intersect:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(this.getSize().x+e.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(this.getSize().y+e.getSize().y)},isInAABBOX:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(e.getSize().x-this.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(e.getSize().y-this.getSize().y)},setAABBox:function(t,r){this.aabbox={center:new e.Vector2(.5*(r.x+t.x),.5*(r.y+t.y)),size:new e.Vector2(r.x-t.x,r.y-t.y)}},getCenter:function(){return this.aabbox.center},getSize:function(){return this.aabbox.size}}),r.LineString=UWA.Class.extend({init:function(){this.vertexList=[],this.type=r.Type.LINESTRING},addVertex:function(e){this.vertexList.push(e)},getNumGeometries:function(){return 1},getVertices:function(){return this.vertexList},intersect:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(this.getSize().x+e.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(this.getSize().y+e.getSize().y)},setAABBox:function(t,r){this.aabbox={center:new e.Vector2(.5*(r.x+t.x),.5*(r.y+t.y)),size:new e.Vector2(r.x-t.x,r.y-t.y)}},isInAABBOX:function(e){return!0},getCenter:function(){return this.aabbox.center},getSize:function(){return this.aabbox.size}}),r.MultiLineString=UWA.Class.extend({init:function(){this.geometryList=[],this.type=r.Type.MULTILINESTRING},addGeometry:function(e){this.geometryList.push(e)},getNumGeometries:function(){return this.geometryList.length},getVertices:function(e){if(void 0===e){for(var t=[],r=0;r<this.geometryList.length;r++)t.push(this.geometryList[r].getVertices());return t}return this.geometryList[e].getVertices()},intersect:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(this.getSize().x+e.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(this.getSize().y+e.getSize().y)},isInAABBOX:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(e.getSize().x-this.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(e.getSize().y-this.getSize().y)},setAABBox:function(t,r){this.aabbox={center:new e.Vector2(.5*(r.x+t.x),.5*(r.y+t.y)),size:new e.Vector2(r.x-t.x,r.y-t.y)}},getCenter:function(){return this.aabbox.center},getSize:function(){return this.aabbox.size}}),r.LinearRing=r.LineString.extend({init:function(){this._parent()}}),r.Polygon=UWA.Class.extend({init:function(){this.geometryList=[],this.aabbox=[],this.type=r.Type.POLYGON},addGeometry:function(e){this.geometryList.push(e)},getNumGeometries:function(){return this.geometryList.length},getVertices:function(e){for(var t=[],r=0;r<this.geometryList.length;r++)t.push(this.geometryList[r].getVertices());return t},intersect:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(this.getSize().x+e.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(this.getSize().y+e.getSize().y)},isInAABBOX:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(e.getSize().x-this.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(e.getSize().y-this.getSize().y)},setAABBox:function(t,r){this.aabbox={center:new e.Vector2(.5*(r.x+t.x),.5*(r.y+t.y)),size:new e.Vector2(r.x-t.x,r.y-t.y)}},getCenter:function(){return this.aabbox.center},getSize:function(){return this.aabbox.size}}),r.MultiPolygon=UWA.Class.extend({init:function(){this.geometryList=[],this.aabbox=[],this.type=r.Type.MULTIPOLYGON},addGeometry:function(e){this.geometryList.push(e)},getNumGeometries:function(){return this.geometryList.length},getVertices:function(e){if(void 0===e){for(var t=[],r=0;r<this.geometryList.length;r++)t.push(this.geometryList[r].getVertices());return t}return this.geometryList[e].getVertices()},intersect:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(this.getSize().x+e.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(this.getSize().y+e.getSize().y)},isInAABBOX:function(e){return Math.abs(this.getCenter().x-e.getCenter().x)<.5*(e.getSize().x-this.getSize().x)&&Math.abs(this.getCenter().y-e.getCenter().y)<.5*(e.getSize().y-this.getSize().y)},setAABBox:function(t,r){this.aabbox={center:new e.Vector2(.5*(r.x+t.x),.5*(r.y+t.y)),size:new e.Vector2(r.x-t.x,r.y-t.y)}},getCenter:function(){return this.aabbox.center},getSize:function(){return this.aabbox.size}}),r.Feature=UWA.Class.extend({init:function(){this.clear()},clear:function(){return this.geometry=void 0,this.attributes={},this},clone:function(){var e=new r.Feature;return e.geometry=this.geometry,e.attributes=t.clone(this.attributes),e},setGeometry:function(e){this.geometry=e},getGeometry:function(){return this.geometry},getCenter:function(){return this.geometry.getCenter()},distanceTo:function(e){return this.getCenter().clone().sub(e).length()},getAttributeKeys:function(){return Object.keys(this.attributes)},set:function(e,t){return this.attributes[e]=t,this},get:function(e){return void 0!==e?this.attributes[e]:void 0},setAttribute:function(e,t){return this.set(e,t)},getAttribute:function(e){return this.get(e)}}),r}),define("DS/XCityLayer/VectorLoaderEnovia",["DS/Visualization/ThreeJS_DS","DS/XCityLayer/Vector","DS/XCityTools/Geocoder","UWA/Class","DS/xCityBasicUtils/DataFormatTools"],function(e,t,r,n,i){"use strict";return n.extend({init:function(e){this._urban=e},requestData:function(e,t){console.error("VectorLoaderEnovia : requestData() should not be called !")},loadDataSource:function(e){if(""!==e){var t=JSON.parse(e),r={list:t.hits,index:0,count:t.hits.length,nhits:t.nhits,isCluster:t.nhits!==t.nmatches,getNextFeature:this.getNextFeature.bind(this)};return r.getNextFeature=this.getNextFeature.bind(this,r),r}return{list:[],index:0,count:0}},loadDataSourceFromObject:function(e){if(""!==e){var t={list:e.hits,index:0,count:e.hits.length,nhits:e.nhits,isCluster:e.nhits!==e.nmatches,getNextFeature:this.getNextFeature.bind(this)};return t.getNextFeature=this.getNextFeature.bind(this,t),t}return{list:[],index:0,count:0}},getNextFeature:function(e,t){if(e.index<e.count){var r=this.parseFeature(e.list[e.index],t,e.index,e.tile);return e.index++,r}return null},parseFeature:function(e,t,r,n){for(var i={},s=e.metas.length-1;s>=0;--s){var o=e.metas[s];i[o.name]=o.value}var a=this.parseGeometry(i);t.clear(),t.setGeometry(a);for(var u=Object.keys(i),g=0,y=u.length;g<y;g++)t.setAttribute(u[g],i[u[g]]);return void 0===t.get("STRID")&&t.setAttribute("STRID",t.get("url")),t},parsePoint:function(e,n){return void 0!==n?(e=r.proj(e,n),new t.Point3D(e.x,e.y,e.z)):3===e.length&&e[2]?new t.Point3D(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])):new t.Point2D(parseFloat(e[0]),parseFloat(e[1]))},parseMultiPoint:function(r,n){for(var i=r.length,s=new t.MultiPoint,o=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),a=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),u=0;u<i;++u){var g=this.parsePoint(r[u],n);s.addGeometry(g),o.set(o.x>g.x?g.x:o.x,o.y>g.y?g.y:o.y),a.set(a.x<g.x?g.x:a.x,a.y<g.y?g.y:a.y)}return s.setAABBox(o,a),s},parsePolygon:function(r,n){for(var i=new t.Polygon,s=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),o=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),a=0,u=r.length;a<u;a++){for(var g=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),y=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),x=new t.LineString,h=r[a],c=0,l=h.length;c<l;c++){var m=this.parsePoint(h[c],n);(c!==l-1||x.vertexList[0].x!==m.x&&x.vertexList[0].y!==m.y)&&(g.set(g.x>m.x?m.x:g.x,g.y>m.y?m.y:g.y),y.set(y.x<m.x?m.x:y.x,y.y<m.y?m.y:y.y),x.addVertex(m))}x.setAABBox(g,y),i.addGeometry(x),s.set(s.x>g.x?g.x:s.x,s.y>g.y?g.y:s.y),o.set(o.x<y.x?y.x:o.x,o.y<y.y?y.y:o.y)}return i.setAABBox(s,o),i},parseMultiPolygon:function(r,n){for(var i=r.length,s=new t.MultiPolygon,o=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),a=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),u=0;u<i;++u){var g=this.parsePolygon(r[u],n);s.addGeometry(g);var y=g.getSize().clone();y.multiplyScalar(.5);var x=g.getCenter().clone().sub(y),h=g.getCenter().clone().add(y);o.set(o.x>x.x?x.x:o.x,o.y>x.y?x.y:o.y),a.set(a.x<h.x?h.x:a.x,a.y<h.y?h.y:a.y)}return s.setAABBox(o,a),s},parseLine:function(r,n){for(var i=new t.LineString,s=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),o=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),a=0;a<r.length;a++){var u=this.parsePoint(r[a],n);i.addVertex(u),s.set(s.x>u.x?u.x:s.x,s.y>u.y?u.y:s.y),o.set(o.x<u.x?u.x:o.x,o.y<u.y?u.y:o.y)}return i.setAABBox(s,o),i},parseMultiLine:function(r,n){for(var i=r.length,s=new t.MultiLineString,o=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),a=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),u=0;u<i;++u){var g=this.parseLine(r[u],n);s.addGeometry(g);var y=g.getSize().clone();y.multiplyScalar(.5);var x=g.getCenter().clone().sub(y),h=g.getCenter().clone().add(y);o.set(o.x>x.x?x.x:o.x,o.y>x.y?x.y:o.y),a.set(a.x<h.x?h.x:a.x,a.y<h.y?h.y:a.y)}return s.setAABBox(o,a),s},parseGeometry:function(e){if(void 0!==e){var t=e.geometry||e.gdal_default_geo;if(void 0!==t){var r=i.fromWKTToArray(t),n=t.indexOf("MULTIPOLYGON");return-1!==n?this.parseMultiPolygon(r,void 0):-1!==(n=t.indexOf("POLYGON"))?this.parsePolygon(r,void 0):-1!==(n=t.indexOf("MULTILINESTRING"))?this.parseMultiLine(r,void 0):-1!==(n=t.indexOf("LINESTRING"))?this.parseLine(r,void 0):-1!==(n=t.indexOf("MULTIPOINT"))?this.parseMultiPoint(r,void 0):-1!==(n=t.indexOf("POINT"))?this.parsePoint(r[0],void 0):null}}}})}),define("DS/XCityLayer/VectorLoaderJSON",["DS/Visualization/ThreeJS_DS","DS/XCityLayer/Vector","UWA/Class"],function(e,t){"use strict";return UWA.Class.extend({init:function(e){this.type=e},requestData:function(e,t){var r=new XMLHttpRequest;r.open("GET",e,!0);r.onload=function(e){var n=JSON.parse(r.response),i={list:n.features,index:0,count:n.features.length};i.getNextFeature=this.getNextFeature.bind(this,i),t(i,r.status)}.bind(this),r.send()},loadDataSource:function(e){if(""!==e){var t=JSON.parse(e),r={list:t.features,index:0,count:t.features.length,getNextFeature:this.getNextFeature.bind(this)};return r.getNextFeature=this.getNextFeature.bind(this,r),r}return{list:[],index:0,count:0}},loadDataSourceFromObject:function(e){if(null!==e){var t={list:e.features,index:0,count:e.features.length,getNextFeature:this.getNextFeature.bind(this)};return t.getNextFeature=this.getNextFeature.bind(this,t),t}return{list:[],index:0,count:0}},getNextFeature:function(e,t){if(e.index<e.count){var r=this.parseFeature(e.list[e.index],t);return"wfs"===this.type&&(r.attributes.STRID=e.list[e.index].id,void 0===r.attributes.STRID&&(r.attributes.STRID=e.idDataSource+"_"+e.tile.key+"_"+e.count)),e.index++,r}return null},parseFeature:function(e,t){var r=this.parseGeometry(e.geometry);if(t.clear(),t.setGeometry(r),void 0!==e.properties)for(var n=Object.keys(e.properties),i=0,s=n.length;i<s;i++)t.setAttribute(n[i],e.properties[n[i]]);return t},parsePoint:function(e){return 3===e.length?new t.Point3D(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])):new t.Point2D(parseFloat(e[0]),parseFloat(e[1]))},parseMultiPoint:function(r){for(var n=r.length,i=new t.MultiPoint,s=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),o=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),a=0;a<n;++a){var u=this.parsePoint(r[a]);i.addGeometry(u),s.set(s.x>u.x?u.x:s.x,s.y>u.y?u.y:s.y),o.set(o.x<u.x?u.x:o.x,o.y<u.y?u.y:o.y)}return i.setAABBox(s,o),i},parsePolygon:function(r){for(var n=new t.Polygon,i=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),s=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),o=0,a=r.length;o<a;o++){for(var u=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),g=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),y=new t.LineString,x=r[o],h=0,c=x.length;h<c;h++){var l=x[h];(h!==c-1||y.vertexList[0].x!==l[0]&&y.vertexList[0].y!==l[1])&&(u.set(u.x>l[0]?l[0]:u.x,u.y>l[1]?l[1]:u.y),g.set(g.x<l[0]?l[0]:g.x,g.y<l[1]?l[1]:g.y),3===l.length?y.addVertex(new t.Point3D(parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2]))):y.addVertex(new t.Point2D(parseFloat(l[0]),parseFloat(l[1]))))}y.setAABBox(u,g),n.addGeometry(y),i.set(i.x>u.x?u.x:i.x,i.y>u.y?u.y:i.y),s.set(s.x<g.x?g.x:s.x,s.y<g.y?g.y:s.y)}return n.setAABBox(i,s),n},parseMultiPolygon:function(r){for(var n=r.length,i=new t.MultiPolygon,s=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),o=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),a=0;a<n;++a){var u=this.parsePolygon(r[a]);i.addGeometry(u);var g=u.getSize().clone();g.multiplyScalar(.5);var y=u.getCenter().clone().sub(g),x=u.getCenter().clone().add(g);s.set(s.x>y.x?y.x:s.x,s.y>y.y?y.y:s.y),o.set(o.x<x.x?x.x:o.x,o.y<x.y?x.y:o.y)}return i.setAABBox(s,o),i},parseLine:function(r){for(var n=new t.LineString,i=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),s=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),o=0;o<r.length;o++){var a=r[o];3===a.length?n.addVertex(new t.Point3D(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]))):n.addVertex(new t.Point2D(parseFloat(a[0]),parseFloat(a[1]))),i.set(i.x>a[0]?a[0]:i.x,i.y>a[1]?a[1]:i.y),s.set(s.x<a[0]?a[0]:s.x,s.y<a[1]?a[1]:s.y)}return n.setAABBox(i,s),n},parseMultiLine:function(r){for(var n=r.length,i=new t.MultiLineString,s=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),o=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),a=0;a<n;++a){var u=this.parseLine(r[a]);i.addGeometry(u);var g=u.getSize().clone();g.multiplyScalar(.5);var y=u.getCenter().clone().sub(g),x=u.getCenter().clone().add(g);s.set(s.x>y.x?y.x:s.x,s.y>y.y?y.y:s.y),o.set(o.x<x.x?x.x:o.x,o.y<x.y?x.y:o.y)}return i.setAABBox(s,o),i},parseGeometry:function(e){if(null!=e)return"polygon"===e.type.toLowerCase()?this.parsePolygon(e.coordinates):"multipolygon"===e.type.toLowerCase()?this.parseMultiPolygon(e.coordinates):"point"===e.type.toLowerCase()?this.parsePoint(e.coordinates):"multipoint"===e.type.toLowerCase()?this.parseMultiPoint(e.coordinates):"linestring"===e.type.toLowerCase()?this.parseLine(e.coordinates):"multilinestring"===e.type.toLowerCase()?this.parseMultiLine(e.coordinates):null}})}),define("DS/XCityLayer/VectorLoaderGML",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/XCityLayer/Vector","DS/XCityTools/Debug"],function(e,t,r,n){"use strict";return UWA.Class.extend({init:function(){this.charset="utf-8",this.gmlNamespaceURI="gml",this.featureNamespaceURI="ms",this.featureTagName="featureMember",this.geometryTagName="msGeometry"},requestData:function(e,t){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="text",n.log("requestData:");r.onload=function(e){var i=this.getXmlDocument(r.response),s=i.lookupNamespaceURI(this.gmlNamespaceURI),o=i.getElementsByTagNameNS(s,this.featureTagName);n.log(o);var a={list:o,namespace:s,index:0,count:o.length,getNextFeature:this.getNextFeature.bind(this)};a.getNextFeature=this.getNextFeature.bind(this,a),t(a,r.status)}.bind(this),r.send()},loadDataSource:function(e){var t=this.getXmlDocument(e),r=t.lookupNamespaceURI(this.gmlNamespaceURI),n=t.getElementsByTagNameNS(r,this.featureTagName),i={list:n,namespace:r,index:0,count:n.length};return i.getNextFeature=this.getNextFeature.bind(this,i),i},getNextFeature:function(e,t){if(e.index<e.count){var r=this.parseFeature(e.list[e.index],e.namespace,t);return e.index++,r}return null},parseFeature:function(e,t,n){var i=e.lookupNamespaceURI(this.featureNamespaceURI),s=this.parseGeometry(e,t,i);void 0===n?n=new r.Feature:n.clear(),n.setGeometry(s);for(var o=e.getElementsByTagNameNS(i,"*"),a=0,u=o.length;a<u;a++){var g=o[a],y=g.childNodes;if(1===g.nodeType&&1===y.length){var x=y[0],h=x.nodeType;3!==h&&4!==h||n.setAttribute(g.localName,x.textContent)}}return n},parsePointText:function(e){var t,n=e.split(","),i=parseFloat(n[0]),s=parseFloat(n[1]);return n.length>2&&(t=parseFloat(n[2])),new r.Point3D(i,s,t)},parsePoint:function(e,t,r){var n=e.getElementsByTagNameNS(t,"coordinates")[0].textContent;return this.parsePointText(n)},parsePolygon:function(e,n,i){for(var s=new r.Polygon,o=e.getElementsByTagNameNS(n,"coordinates"),a=new t.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),u=new t.Vector2(Number.MIN_VALUE,Number.MIN_VALUE),g=0,y=o.length;g<y;g++){for(var x=new r.LineString,h=o[g].textContent.replace(/^\s+|\s+$/g,"").split(" "),c=0,l=h.length;c<l;c++){var m=h[c].split(","),f=parseFloat(m[0]),A=parseFloat(m[1]);a.set(a.x>f?f:a.x,a.y>A?A:a.y),u.set(u.x<f?f:u.x,u.y<A?A:u.y);var d=0;m.length>2&&(d=parseFloat(m[2])),x.addVertex(new r.Point3D(f,A,d))}s.addGeometry(x)}return s.setAABBox(a,u),s},parseGeometry:function(e,t,r){var n=e.getElementsByTagNameNS(r,this.geometryTagName);if(n.length>0)for(var i=n[0],s=["Polygon","LineString","Point"],o=0;o<s.length;o++){var a=s[o];if(i.getElementsByTagNameNS(t,a).length>0){if("Polygon"===a)return this.parsePolygon(i,t,r);if("Point"===a)return this.parsePoint(i,t,r)}}return null},getXmlDocument:function(e){if(window.DOMParser)return(new DOMParser).parseFromString(e,"text/xml");var t=new ActiveXObject("Microsoft.XMLDOM");return t.async=!1,t.loadXML(e),t}})});