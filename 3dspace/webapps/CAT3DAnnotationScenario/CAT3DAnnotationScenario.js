define("DS/CAT3DAnnotationScenario/CAT3DAnnotationScenario",["DS/3DPlay/PlayScenario3D","DS/WebSystem/App","DS/WebappsUtils/WebappsUtils","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/ApplicationFrame/CommandsManager","i18n!DS/CAT3DAnnotationScenario/assets/nls/CAT3DAnnotationScenario"],function(e,t,n,o,a,i){"use strict";return e.extend({init:function(e){this._parent(e);var r,l,s,c,d,A,u,g,C,D,m,S=e.scenarioManager.getExperience(),f=S.pad3DViewer,p=this,h={},T=!1,v=!1,b=!1,x=!1,w=n.getWebappsAssetUrl("CAT3DAnnotationScenario","icons/I_A3E_3DPlayScenario.png");this.setScenarioResetActionBarPolicy&&this.setScenarioResetActionBarPolicy(!1),S.subscribe("ASSET/LOADINGSTARTED",function(){o.setLoadedAssetType(null),c=null,T=!1},!0),S.subscribe("ASSET/LOADINGFINISHED",function(e){T=!0,b=!1,D=e.loadAssetInfo,o.setLoadedAssetType(D&&"3dxml"===D.format?"3DXML":null),C&&C()},!0),S.subscribe("EXPERIENCE/STOP",function(){l&&p.stop()},!0),this.launch=function(){m=S.autoReframe,S.autoReframe=!1,s||((s={}).assetChanged=S.subscribe("ASSET/CHANGE",function(){f.publish({event:"on3DPlayAssetChanged",data:{}})}),s.transition=S.subscribe("EXPERIENCE/TRANSITION",function(e){l&&"ENOR3D_AP"===e.options.id&&(x=!0)})),require(["DS/CAT3DAnnotPlayServices/CAT3DAnnotPlayServices","DS/CAT3DAnnotationController/CAT3DAnnotBaseControllerInstance","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController","DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager","DS/PADUtils/PADUtilsServices","DS/CoreEvents/Events","DS/3DPlayConnectors/3DPlayInputPreProcessor"],function(e,n,i,w,y,E,P,L,M){var I;C=function(){if(T&&c&&v){if(c&&c.length)for(var e=0;e<c.length;e++)c[e].node&&c[e].xml&&(c[e].node.xml=c[e].xml);!b&&l&&(l.setActiveState(1),I.setActiveState(!0))}},window.widget&&window.widget.setMetas({helpPath:"CAT3DAnnotationScenario/assets/help"});var R=S.getModelLoader&&S.getModelLoader()?S.getModelLoader().getCGRWithSG():"notAssigned";!function(){var e={lastCommand:[],currentCommand:null,defaultCommand:null},n=f.getCommandContext?f.getCommandContext():null;n?a._commandsState[n]=e:a._commandsState=e,a.resetDefaultCommand(n),a._isCommandEnding=!1,a._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach(function(e){var t=n?a[e][n]:a[e];Object.keys(t).forEach(function(e){var n=t[e];n&&n._destroy&&n._destroy(),delete t[e]})});var o=0,i=f.getFrameWindow().getActionBar().onActionBarReady(function(){0===o?(o=1,p.loadWorkbench({name:"3DPlay.xml",module:"3DPlay"},!0)):1===o?(o=2,p.loadWorkbench({name:"3DPlayShare.xml",module:"3DPlay"},!0)):f.getFrameWindow().getActionBar().removeCallback(i)});p.loadWorkbench({name:t.is3DPlay()?"CAT3DAnnotationScenario.xml":"CAT3DAnnotationScenario_embed.xml",module:"CAT3DAnnotationScenario"},!1)}(),I=new n({ctxViewer:f}),r=I.subscribe("onSlideShowActiveStateModified",function(e){L.publish({event:e.state?"3DPLAY/SPECTREE/DISABLE":"3DPLAY/SPECTREE/ENABLE",data:{}}),S._enableCMenu=!e.state}),w.registerAnnotationController({annotController:I,context:f}),u=new M;var V=function(e){u.run(e,function(e){S.clearView(),S.load(e)})},F=E.getFavoriteContextManager({context:f,addRoots:function(e){b=!0;var t=D&&D.originalAsset?D.originalAsset:{provider:"EV6",tenant:P.getPlatformId()};t.physicalid=e[0].path[0],t.id=e[0].path[0],V(t)},addRootNodesFromContent:function(e){b=!0;var t=D&&D.originalAsset?D.originalAsset:{provider:"EV6",tenant:P.getPlatformId()};t.physicalid=e[0].objectId,t.id=e[0].objectId,t.displayName=e[0].displayName,t.type=e[0].objectType,t.dtype=e[0].objectType,V(t)}});h.onAddRoot=f.subscribe({event:"onRootAdded"},function(){o.setLoadedAssetType(null)}),l=i.getAnnotationModelLoader({context:f,favoriteCtxManager:F}),y.get3DAnnotBrowserController({context:f,defaultDockingSide:"left"}).setActiveState(!0),v=!0,f.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(){return d||(d=I.onAdditionalInfosRequired({controller:"AnnotScenario"}).getSelectedAnnotationsVisibilityFlag),e.getContextualCommandList({ctxViewer:f,getSelectedAnnotationsVisibilityFlag:d})},context:f.getCommandContext?f.getCommandContext():S.ctx,workbenchName:"CAT3DAnnotationScenario",module:"CAT3DAnnotationScenario",cmdPrefix:"",subscriberId:"CAT3DAnnotationScenario",merge:!0}),A=f.getViewer().currentViewpoint.control.lockZ;let _=e.initSelAndPrefMgrs({ctxViewer:f});o.setLoadedAssetType(null),D&&"3dxml"===D.format?(o.setLoadedAssetType("3DXML"),u.run(D.originalAsset?D.originalAsset:D,function(e){S.getModelLoader().setCGRWithSG(!0),S.clearView(),S.load(e,{ConversionOpts:{PMI:1},"3DXMLLoadOpts":{V4V5_FDT:{doneCallback:function(e){c=e,C()},errorCallBack:function(){}}}})})):(l.setActiveState(1),I.setActiveState(!0));var B=0,W=setInterval(function(){if(l&&!l.isRunning()){clearInterval(W);var e=f.getRootBagPath().getChildrenPathes();1===e.length&&o.is3DLeaf(e[0].getLastElement())&&F.manageFavoriteContext({path:e[0]},!0)}++B>=100&&clearInterval(W)},500);g=function(){var t;if("notAssigned"!==R&&S.getModelLoader()&&S.getModelLoader().setCGRWithSG(R),R="notAssigned",S.autoReframe=m,_&&(_.ctxViewer=f,e.cleanSelAndPrefMgrs(_)),f.getViewer()&&f.getViewer().currentViewpoint&&(f.getViewer().currentViewpoint.control.lockZ=A),c&&c.length)for(t=0;t<c.length;t++)c[t].node.xml=null;c=null;var n=w.giveAnnotationController({context:f});r&&n&&n.unsubscribe(r),x&&n&&n.saveLastFTAViewOrCaptureDisplayed(!0),w.unreferenceAnnotationController({context:f}),x||i.unreferenceAnnotationModelLoader({context:f}),y.unreference3DAnnotBrowserController({context:f}),E.unreferenceFavoriteContextManager({context:f});var o=Object.keys(h);for(t=0;t<o.length;t++)f.unsubscribe(h[o[t]]);for(h={},o=Object.keys(s),t=0;t<o.length;t++)S.unsubscribe(s[o[t]]);s=null,f.getFrameWindow()&&f.getFrameWindow().getContextualUIManager().unregister("CAT3DAnnotationScenario"),l=u=null,g=C=d=null,x=!1}})};var y=this.stop;this.stop=function(){v=!1,window.widget&&window.widget.setMetas({helpPath:void 0}),g&&g(),y()},this.getTitle=function(){return i.A3EScenario_Title},this.getDescription=function(){return i.A3EScenario_Description},this.getIcon=function(){return w}}})});