define("DS/XCityModel/WorkerSemaphore",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e,t){this._workerPath=e,this._workerNumber=t,this._freeWorkers=[],this._workers=[],this._waitingList=[];for(let i=0;i<t;i++){let t=function(){this._unlock(i)}.bind(this),r={worker:new Worker(e),release:t};this._workers[i]=r,this._freeWorkers[i]=r}},requestWorker:function(){let e={},t=new Promise((t,i)=>{e.resolve=t,e.reject=i});return this._waitingList.push(e),this._freeWorkers.length>0&&this._waitingList.pop().resolve(this._freeWorkers.pop()),t},_unlock:function(e){this._waitingList.length>0?this._waitingList.pop().resolve(this._workers[e]):this._freeWorkers.push(this._workers[e])}})}),define("DS/XCityModel/Item",["UWA/Class/Model","DS/Visualization/ThreeJS_DS","DS/xCityBasicUtils/AABBox","DS/XCityTools/Debug","DS/XCityTools/Downloader","DS/XCityTools/EventDispatcher","DS/xCityBasicUtils/Utils","DS/XCityCore/Store","DS/XCityTools/Debug"],function(e,t,i,r,s,n,o,a,h){"use strict";String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"g"),t)};var l=e.extend({urlRoot:"/item",metaData:{type:"",className:"Item"},setup:function(){for(var e in this.id||(this.id=UWA.Utils.getUUID()),this._attributes.id=this.id,this._itemParent=null,this._created=!1,this.userData=null,this._attributes)null===this._attributes[e]?this.addEvent("onChange:"+e,this._itemChildChanged.bind(this,e)):void 0===this._attributes[e]||this._attributes[e].setItemParent&&(this.addEvent("onChange:"+e,this._itemChildChanged.bind(this,e)),this._itemChildChanged(e,this._attributes[e]));this.addEvent("onChange:visible",this._cleanStoreWaitingList.bind(this)),this._order=-1},_cleanStoreWaitingList:function(e,t){if(!t&&o.is(this._attributes)&&o.is(this._attributes.Content)){if(this.findTags&&this.findTags("landcover"))return;var i=a.getStore(this._attributes.Content._attributes.url);if(i||(i=a.getStore(this._attributes.Content.id)),o.is(i)&&o.is(i._data))h.log("Layer unselected: removing all waiting downloads for "+this._attributes.name),Object.entries(i._data).map(e=>e[0]).forEach(e=>i.cancelDownloadData(e))}},setItemParent:function(e){!e&&this._created?(this.destroy(this._itemParent.getRoot()),this._itemParent=void 0):(this._itemParent=e,this._itemParent&&!this._created&&this._itemParent._root&&this.create(this._itemParent._root))},getItemParent:function(){return this._itemParent},getUserData:function(){return this.userData},getDownloadLog:function(){let e=void 0,t=this.getContent();return t&&(e=s.getDownloadLog(t.get("url"))),e},getFactory:function(){return this._factory},getDataModelOrder:function(){if(-1===this._order)return[];var e=this._itemParent.getDataModelOrder();return e.push(this._order),e},_itemChildChanged:function(e,t){var i=this._attributes[e];i&&i.setItemParent&&i.setItemParent(this);var r=this.previous(e);r&&r.removeItemParent&&r.removeItemParent(this),this._created&&i&&i.create&&!i._created&&i.create(this.getRoot())},removeItemParent:function(e,t){this._itemParent===e&&this._created&&(this.destroy(t||e.getRoot()),this._itemParent=void 0)},getRoot:function(){if(this._itemParent)return this._itemParent.getRoot()},toJSON:function(e){var t=this._parent();t.className=this.metaData.className;var i=(new this.__proto__.constructor)._attributes;if(e)for(var s in t)null===t[s]||void 0===t[s]||o.isEnumerable(t[s])&&0===Object.keys(t[s]).length?delete t[s]:(o.is(i[s])&&i[s]==t[s]&&delete t[s],"Geometry"!==s?"object"==typeof t[s]&&o.is(t[s])&&o.is(t[s].toJSON)&&(t[s]=t[s].toJSON(!0)):r.warn("warning : Geometry is still existing in experience datamodel"));return t},loadJSONVector3:function(e,i,r,s){var n=this.get(i);n||(n=new t.Vector3),void 0!==r.x&&void 0!==r.y?n.set(r.x,r.y,r.z):n.set(r[0],r[1],r[2]),this.set(i,n)},loadJSONColor:function(e,i,r,s){var n=this.get(i);n||(n=new t.Color),n.set(r),o.is(this.setMaterial)||o.is(this.setAttribute)||this.set(i,n)},loadJSONObject:function(e,t,i,r){this.set(t,i)},loadJSONAABox:function(e,t,r,s){r.className&&"AABBox"!==r.className||this.set(t,new i(r,e))},checkDataset:function(e,t,i,r,a,h,l){let d="undefined"!=typeof xCity&&xCity.widgetData&&xCity.widgetData.datasetCollection;if(t.Geometry&&!t.Content&&(t.Content=t.Geometry),t.Content&&t.Content.url){var u=t.Content.url,c=s.resolveUrl(u);if(s.isAPlatformService(c)){s._datasetToCheckList++;var g="";if("enovia"===t.Content.type){var f=c.replaceAll("%xmin","0.0");f=(f=(f=(f=(f=(f=f.replaceAll("%ymin","0.0")).replaceAll("%ymax","0.0")).replaceAll("%xmax","0.0")).replaceAll("%l","0")).replaceAll("%x","0")).replaceAll("%y","0"),g=f}else{var _=t.Content.objectId,p=!1;o.is(_)||(t.Content.userData&&t.Content.userData.cache&&t.Content.userData.cache.dataset&&(_=t.Content.userData.cache.dataset.uuid),o.is(_)||(_=s.getUuidFromUrl(t.Content.url)),o.is(_)&&(t.Content.objectId=_)),o.is(t.Content.userData)&&o.is(t.Content.userData.cache)&&o.is(t.Content.userData.cache.dataset)&&o.is(t.Content.userData.cache.dataset.type)&&!o.is(t.Content.userData.datasetType)&&(t.Content.userData.datasetType=t.Content.userData.cache.dataset.type),t.Content.userData&&t.Content.userData.datasetType&&"RawData"===t.Content.userData.datasetType&&(p=!0);var m=u;if(p){var y=u.split("resources/");if(2===y.length){var b=y[1].split("?")[0];m=s.getDataSupplierUrl()+_+"/resources/"+b+"?tenant="+s._platformID}}else m=s.getDataSupplierUrl()+_+"/%l/%x/%y?tenant="+s._platformID;u=t.Content.url=m,g=s.getDataSupplierUrlFromUrl(u)}var v=t.name,S=this,D=function(o,u,c){if(s._datasetToCheckList--,o){var f=JSON.parse(u);const s=f&&f.uuid;if(d&&s&&d.push(f),"RawData"!==f.type){if(t&&t.Content&&void 0!==t.Content.levelMin&&f&&f.customization&&void 0!==f.customization.startLevel&&(t.Content.levelMin=f.customization.startLevel,t.Geometry&&(t.Geometry.levelMin=f.customization.startLevel)),t&&t.Content&&void 0!==t.Content.levelMax&&f&&f.customization&&void 0!==f.customization.endLevel){var _=Math.min(42,f.customization.endLevel);t.Content.levelMax=_,t.Geometry&&(t.Geometry.levelMax=_)}t&&t.Content&&f&&void 0!==f.outputFormat&&"JsonProxy"!==f.outputFormat&&("Model3DXC"===f.outputFormat?t.Content.type="3DXC":t.Content.type="json",t.Geometry&&(t.Geometry.type=t.Content.type))}S._loadJSON(e,t,i,r,a,h,l)}else{i.decrNumChildrenToLoad();var p=c.message.substring(c.message.length-5,c.message.length-2);s.addRejectedDataset(v,g,u,c.message,Number(p))}0===s._datasetToCheckList&&(!0===e.urbanLoaded?n.publish(n.eventsList.onLoaded,this):s._datasetToCheckList=-1)};let P=d?d.get(_):null;P?D(!0,JSON.stringify(P)):s.download(g,{headers:{Accept:"application/json"}},999999,D)}else this._loadJSON(e,t,i,r,a,h,l)}else this._loadJSON(e,t,i,r,a,h,l)},loadJSON:function(e,t,i,r,s,n,o){var a=-1;void 0!==o?a=o:i&&r&&(a=i.getNumChildren()+i.getNumChildrenToLoad(),i.incrNumChildrenToLoad()),void 0!==s&&!1===s?this._loadJSON(e,t,i,r,s,a,n):this.checkDataset(e,t,i,r,s,a,n)},loadJSONFile:function(e){var t=JSON.parse(e);return this.loadJSON(this._urban,t,void 0)},_loadJSON:function(e,t,i,s,a,h,d){var u=!1;o.is(t.Content)&&(u=!0);try{for(var c in t){var g=t[c];if(("Geometry"!==c||!u)&&("Geometry"!==c||u||(c="Content"),null!==g))if(void 0!==this.loaderJSON&&this.loaderJSON[c])this[this.loaderJSON[c]].apply(this,[e,c,g,i,d]);else if(void 0!==this.get(c))if(!(g.className||g instanceof Object)||g instanceof Array)this.set(c,t[c]);else{var f=g.className||c,_=l.ObjectContructor[f];if(_){var p=new _;p.loadJSON(e,g,this,!1,a,d),this.set(c,p)}else"interactionBehaviours"===c?this.set("interactionBehaviours",g):r.warn("Warning: Object %s unknow",g.className)}else"userData"===c&&g&&this.set("userData",g)}if(i&&s&&(i.decrNumChildrenToLoad(),i.addChild(this,h)),void 0!==d)var m=n.subscribeTo(n.eventsList.onLoaded+":"+this.get("id"),function(e){var t,i;n.unsubscribe(m),o.is(e)&&("boolean"==typeof e?t=e:(t=e.success,i=e.item)),d(t,i)})}catch(e){console.error(e.stack),void 0!==d&&d(!1)}},saveJSONFile:function(){return JSON.stringify(this)},create:function(e){if(!e._urban)return!1;for(var t in this._created=!0,this._root=e,this._attributes){var i=this._attributes[t];i&&!1===i._created&&i.create(e)}return!0},destroy:function(e){if(this.dispatchEvent("onDestroy",this),this._attributes&&this._attributes.loadInfo&&this._attributes.loadInfo.total&&this._attributes.loadInfo.loaded<this._attributes.loadInfo.total){var t={loaded:this.get("loadInfo").total,total:this.get("loadInfo").total};this.set("loadInfo",t)}for(var i in this._attributes){var r=this._attributes[i];r&&r.removeItemParent&&r.removeItemParent(this,e)}this._created=!1,this.clear({silent:!0})},sync:function(){},getBoundingSphere:function(){if(this._node){var e=this.getLocalPosition();return e?new t.Sphere(e,this._node.bSphere.radius):this._node.bSphere}},setRenderable:function(e,t,i){var r=this.getRendering();if(this.renderingProfileManager&&o.is(r)&&r.hasAttribute(e)){var s={};s[e]=t,this.setMaterial(s,i)}else console.log("item has not renderable attribute ",e)},setMaterial:function(e,t){var i=this.getRendering();return i&&(e=i.updatePresetValues(e),this.renderingProfileManager.addRendering(this.parentFeatureID,e,null,t)),this},addFilterRendering:function(e,t){var i=this.getRendering();if(i)return t=i.updatePresetValues(t),this.renderingProfileManager.addFilterRendering(this.parentFeatureID,e,t,this.get("renderID"))},addDatavizRendering:function(e){var t=this.getRendering();if(t)return e=t.updatePresetValues(e),this.renderingProfileManager.addDatavizRendering(this.parentFeatureID,e,this.get("renderID"))},updateDatavizRendering:function(e,t,i,r){var s=this.getRendering();if(s)return i=s.updatePresetValues(i),this.renderingProfileManager.updateDatavizRendering(this.parentFeatureID,e,t,i,r,this.get("renderID"))},deleteDatavizRendering:function(e){if(this.getRendering())return this.renderingProfileManager.deleteDatavizRendering(this.parentFeatureID,e,this.get("renderID"))}});return l.ObjectContructor={},l}),define("DS/XCityModel/WebWorkerPool",["UWA/Class","DS/XCityTools/Debug"],function(e,t){"use strict";return e.extend({init:function(e,i,r){r?t.log("Creating a worker pool with dynamic pool size management"):t.log(`Creating a worker pool with static pool size of ${i} worker(s)`),this.useDynamicManagement=r,this.workerPath=e,this.maxIdleWorkers=8,this.poolSize=r?this.maxIdleWorkers:i,this.pool=[],this.freeWorkers=[],this.taskQueue=[],this.refreshTaskFrequency=20,this.slowDownFactorThresholmd=.85,this.speedUpFactorThreshold=1.1,this.perfQueueLength=4,this.performanceQueue=[],this.currAvgPerf,this.prevAvgPerf=Number.MIN_VALUE,this.activeWorkers=r?1:this.poolSize,this.fakeDecrements=0,this.poolManagementFrequency=1e3,this.isLocked=!0,this.pendingGeomSet=[],this.preloadWorkers=!0,this.msecBetweenWorkerSpawn=0,this.msecBeforeFirstSpawn=8e3,this.lockOwner,this.isAborting=!1,this.abortCallback;let s=0,n=this;var o=function(){s<n.poolSize?(n.pool[s]=new Worker(n.workerPath),n.pool[s].onerror=function(e){e.preventDefault(),t.log(e)},n.preloadWorkers&&n.pool[s].postMessage("just_load_dependencies"),s++,setTimeout(o,this.msecBetweenWorkerSpawn)):n._finishInit()};setTimeout(o,this.msecBeforeFirstSpawn)},_finishInit:function(){for(let e=0;e<this.activeWorkers;e++)this.freeWorkers.push(this.pool[e]);this._updateInterval=setInterval(this._update.bind(this),this.refreshTaskFrequency),this.useDynamicManagement&&(this._managePoolInterval=setInterval(this._managePool.bind(this),this.poolManagementFrequency)),this.unlock()},lock:function(e){let t={},i=new Promise((e,i)=>{t.resolve=e,t.reject=i});return this.pendingGeomSet.push(t),this.isLocked&&this.lockOwner!==e||(this.lockOwner=e,this.isLocked=!0,this.pendingGeomSet.pop().resolve()),i},abort:function(e){let t={},i=new Promise((e,i)=>{t.resolve=e,t.reject=i});return this.isLocked&&this.lockOwner!==e?t.reject():(this._flushPerfQueue(),this.taskQueue=[],this.abortCallback=t.resolve,this.freeWorkers.length===this.poolSize?(this.isAborting=!1,this.abortCallback()):this.isAborting=!0),i},unlock:function(){this.pendingGeomSet.length>0&&this.pendingGeomSet.pop().resolve(),this.isLocked=!1},_update:function(){if(this.taskQueue.length>0&&this.freeWorkers.length>0){let e=this.taskQueue.shift();t.log("Assigning a task to a free worker "+(void 0!==e.workerData.indexSession?e.workerData.indexSession:""));let i=this.freeWorkers.pop();i.onmessage=(r=>{t.log("A worker completed its task"),this.freeWorkers.push(i),this.isAborting?this.freeWorkers.length===this.poolSize&&(this.isAborting=!1,this.abortCallback()):e.resolve(r.data)}),i.postMessage(e.workerData)}},setPerfHook:function(e){this.perfHook=e},_managePool:function(){if(this.perfHook){let e=this.perfHook();void 0===e||isNaN(e)?t.warn("Perf measure is undefined or NaN. Waiting for next measure..."):this._addPerfToPerfQueue(e)}else t.error("Worker pool can't manage workers without performance statistics. Please plug in the function returning your performance score at initialization using setPerfHook(yourPerfFunction)");if(this.performanceQueue.length===this.perfQueueLength){this.currAvgPerf=this._getPerfQueueAvg(this.performanceQueue);let e=performance.now(),i=Math.round(e/1e3);i+=", "+this.currAvgPerf,this.currAvgPerf>this.prevAvgPerf*this.speedUpFactorThreshold?(0===this.fakeDecrements?(this.activeWorkers++,this.freeWorkers.push(this.pool[this.activeWorkers-1])):this.fakeDecrements--,this.prevAvgPerf=this.currAvgPerf,this._flushPerfQueue()):this.currAvgPerf<this.prevAvgPerf*this.slowDownFactorThresholmd&&(this.fakeDecrements++,this.prevAvgPerf=this.currAvgPerf,this._flushPerfQueue()),i+=", "+this.fakeDecrements,i+=", "+this.activeWorkers,t.log("WebWorkerPool[DEBUG]: "+i)}},_getPerfQueueAvg:function(e){let t=0;for(let e=0;e<this.performanceQueue.length;e++)t+=this.performanceQueue[e];return t/=this.performanceQueue.length},_addPerfToPerfQueue:function(e){this.performanceQueue.push(e),this.performanceQueue.length>this.perfQueueLength&&this.performanceQueue.shift()},_flushPerfQueue:function(){this.performanceQueue=[]},submit:function(e){t.log("Task submited");let i={};i.workerData=e;let r=new Promise((e,t)=>{i.resolve=e,i.reject=t});return this.taskQueue.push(i),r},invokeAll:function(e){let t=[];for(let i in e){let r=e[i],s={};s.workerData=r;let n=new Promise((e,t)=>{s.resolve=e,s.reject=t});t.push(n),this.taskQueue.push(s)}return Promise.all(t)},isTerminated:function(){},isShutdown:function(){},shutdown:function(){},shutdownNow:function(){clearInterval(this._updateInterval),clearInterval(this._managePoolInterval);for(let e=0;e<this.poolSize;e++)this.pool[e].terminate(),this.freeWorkers.push(this.pool[e]);return this.taskQueue}})}),define("DS/XCityModel/View3DContextualMenuManager",["UWA/Class","DS/ApplicationFrame/ContextualUIManager","DS/Selection/CSOManager","DS/XCityTools/EventDispatcher","DS/XCityTools/Debug"],function(e,t,i,r,s){"use strict";return e.singleton({init:function(){this._frmWindow,this._dataModelSelection,this._manager,this.updateMouseToken,this.updateTouchToken,this._mousePos={x:0,y:0},this._contextualCase={},this._visibility=!1},initialize:function(e,t){this._dataModelSelection=t,void 0!==e.urban&&(this._frmWindow=e.urban.frmWindow),this._visibility&&this.enable()},updateMouse:function(e){var t=e;e.from&&e.from.length&&(t=e.from[0].event),t.touches&&t.touches.length>0?this._mousePos={x:t.touches[0].clientX,y:t.touches[0].clientY}:this._mousePos={x:t.clientX,y:t.clientY}},enable:function(){return this._visibility?(s.log("Contextual Menu Manager already enable."),!1):(this._visibility=!0,this._manager=new t({frameWindow:this._frmWindow}),this._manager.register({workbenchName:"View3DContextualMenu",module:"XCityCoreUI",cmdPrefix:"",fileName:"View3DContextualMenu.xml",onContextualBarReady:this._onContextualBarReady.bind(this)}),void 0===this._dataModelSelection?(s.warn("Contextual Menu Manager could not be enable: DataModelSelection is missing."),!1):(this._dataModelSelection.addEvent("onDeselect",this._hide,this),this.updateMouseToken=r.subscribeToLeftMouseDown(this.updateMouse.bind(this)),this.updateTouchToken=r.subscribeTo("/VISU/onTouch",this.updateMouse.bind(this)),!0))},disable:function(){return this._dataModelSelection.removeEvent("onDeselect",this._hide,this),r.unsubscribe(this.updateMouseToken),r.unsubscribe(this.updateTouchToken),this._hide(),!0},addNewContextualMenu:function(e,t){this._contextualCase[e]?this._contextualCase[e].cmdList=this._mergeCmdList(this._contextualCase[e].cmdList,t):this._contextualCase[e]={comparator:e,cmdList:t}},_mergeCmdList:function(e,t){var i,r=[];for(i=0;i<e.length;++i)r.push(e[i]);for(i=0;i<t.length;++i)r.push(t[i]);return r},_onContextualBarReady:function(){var e,t,r=i.get(),s=[];if(r.length>0&&(e=r[r.length-1].model)&&e.get("selected"))for(t in this._contextualCase)(0,this._contextualCase[t].comparator)(e)&&(s=this._mergeCmdList(s,this._contextualCase[t].cmdList));return s.length>0?{cmdList:s}:void 0},_display:function(e){},_hide:function(){},clear:function(e){}})}),define("DS/XCityModel/RasterOverlay",["DS/Visualization/ThreeJS_DS","DS/XCityModel/Item","DS/XCityCore/Store","DS/XCityCore/Terrain","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/EventDispatcher","DS/xCityPlatformUtils/xCityDocumentManagement","DS/Manipulators/PointHandle","DS/Visualization/Node3D","DS/Mesh/MeshUtils"],function(e,t,i,r,s,n,o,a,h,l,d,u){"use strict";var c=function(e,t){var i=n.cloneQuad(t);return i.LOD>e.get("levelMax")&&(i.I=i.I>>i.LOD-e.get("levelMax"),i.J=i.J>>i.LOD-e.get("levelMax"),i.LOD=e.get("levelMax"),i.key=void 0),e.get("yTopToBottom")&&(i.J=(1<<i.LOD)-1-i.J,i.key=void 0),void 0===i.key&&(i.key=n.getQuadKey(i.LOD,i.I,i.J)),i},g=t.extend({defaults:{levelMin:0,levelMax:-1,levelMaxVisu:99999,priority:3,cache:50,AABBox:null,url:"",res:1,opacity:1,yTopToBottom:!1,listenToDateUpdate:!1,upTime:"",downTime:"",objectId:"",serviceId:"",loadInfo:{loaded:1,total:1}},metaData:{type:"RasterOverlay",className:"RasterOverlay"},loaderJSON:{AABBox:"loadJSONAABox"},setup:function(){this._parent()},create:function(t){if(!this._parent(t))return a.publish(a.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;this._urban=t._urban,this._attributes.loadInfo.loaded=1,this._attributes.loadInfo.total=1;var s=function(){""===this.get("objectId")&&""===this.get("url")||-1===i.getStoreList().indexOf(this.get("url"))&&(i.deleteStore(this.previous("url")),this.get("url").search("%xmin")>-1&&this.get("url").search("%xmax")>-1&&this.get("url").search("%ymin")>-1&&this.get("url").search("%ymax")>-1?i.createStore(this.get("url"),{url:this.get("url"),cacheSize:this.get("cache"),priority:this.get("priority"),texture:!0,wms:{worldSize:t._urban.worldSize,shiftedPosition:t._urban.shiftedPosition},onFinish:{func:this._onFinish.bind(this),bound:this},listenToDateUpdate:this.get("listenToDateUpdate"),upTime:this.get("upTime"),downTime:this.get("downTime")}):i.createStore(this.get("url"),{url:this.get("url"),cacheSize:this.get("cache"),priority:this.get("priority"),texture:!0,tile:!0,onFinish:{func:this._onFinish.bind(this),bound:this},listenToDateUpdate:this.get("listenToDateUpdate"),upTime:this.get("upTime"),downTime:this.get("downTime")}),i.deprecateAll("terrain"))}.bind(this);s(),this.addEvent("onChange:url",s),this.addEvent("onChange:opacity",this.deprecateTerrain),this.addEvent("onChange:levelMin",this.rebuildTerrain),this.addEvent("onChange:levelMax",this.rebuildTerrain),this.addEvent("onChange:AABBox",this.deprecateTerrain),this.get("objectId");var n=this,o=this.get("url"),l="null"!==o&&"undefined"!==o&&!0===o.includes("datasupplier");if(""!==this.get("objectId")&&!l){var u=this.get("objectId"),c=null,g="3DSpace";"3DDrive"===this.get("serviceId")&&(c=u,g="3DDrive"),h.retrieveDocumentUrl(u,c,g).then(function(e){n.userData={isPreview:!0,editablePosition:!0,cache:{dataset:{previewRaster:!0}}},n._itemParent&&(n._itemParent.userData||(n._itemParent.userData={}),n._itemParent.userData.isPreview=!0,n._itemParent.userData.editablePosition=!0),n.set("url",e)})}return r.registerRasterSource(this.get("id"),this),this._updateVisibility(this.getItemParent()),this.anchorList=[],this.anchorRootNode=new d,this.anchorOffsetNode=new d,this.anchorRootNode.setVisibility(!0),this.anchorRootNode.setMatrix(new e.Matrix4),this.clickedColor=new e.Color("#00BFFE"),this.pointColor=new e.Color("#FFFFFF"),this._node=new d,t._urban.getView3D()._rootProjShifted.addChild(this.anchorOffsetNode),this.anchorOffsetNode.addChild(this.anchorRootNode),this.anchorOffsetNode.addChild(this._node),!0},_onFinish:function(e){a.publish(a.eventsList.onLoaded+":"+this.get("id"),{success:e,item:this.getItemParent()})},destroy:function(e){r.deactivateRasterSource(this.get("id")),r.unregisterRasterSource(this.get("id"));var t=!0;e.traverse(function(e){e.get("Content")&&e.get("Content").get("url")&&e.get("Content").get("id")!==this.get("id")&&e.get("Content").get("url")===this.get("url")&&(t=!1)}.bind(this),!0),t&&i.deleteStore(this.get("url"),!0),e._urban.getView3D()._rootProjShifted.removeChild(this.anchorOffsetNode),this._parent(e)},isLandcover:function(){return this._itemParent.findTags("landcover")},acceptTile:function(e){if(e.LOD<this.get("levelMin")||e.LOD>this.get("levelMaxVisu"))return!1;if(n.is(this.get("AABBox"))){var t={};if(this.get("AABBox").getIJBox(e.LOD,t),e.I<t.IMin||e.I>t.IMax)return!1;if(e.J<t.JMin||e.J>t.JMax)return!1}return!0},isTileContainedInSource:function(e){if(e.LOD<this.get("levelMin")||e.LOD>this.get("levelMaxVisu"))return!1;if(n.is(this.get("AABBox"))){var t=this.get("AABBox"),i=t.getShiftedBBox(e.LOD,e.I,e.J);return!(i.xMax>t._maxShifted[0]||i.xMin<t._minShifted[0]||i.yMax>t._maxShifted[1]||i.yMin<t._minShifted[1])}return!0},cancelTile:function(e){var t=c(this,e);t.LOD===e.LOD&&i.cancelDownloadData(this.get("url"),t.key)},updateTile:function(e){var t=c(this,e);i.updateTimestampData(this.get("url"),t.key)},getTile:function(e){var t=c(this,e);return i.getData(this.get("url"),t.key)},downloadTile:function(e,t,r,s,o){var a,h={tile:c(this,e),priority:r,undeletable:t.undeletable},l=i.getData(this.get("url"),h.tile.key);if(!n.is(l)&&(t.isVisible&&(this._incrementTotalItems(),(a=Array.prototype.slice.call(arguments,3)).unshift(this.get("url"),h.tile.key,h,function(e,t,i,r){if(e&&t&&(t.anisotropy=1),void 0!==i){var s=Array.prototype.slice.call(arguments,4);s.unshift(e,t),i.apply(r,s)}this._incrementLoadedItems()},this),i.getOrDownloadData.apply(i,a)),t&&t.canUseParent))for(var d=this.get("levelMin"),u=h.tile.LOD,g=h.tile.I,f=h.tile.J,_=void 0;!n.is(_)&&u>d;)u-=1,g>>=1,f>>=1,_=i.getData(this.get("url"),n.getQuadKey(u,g,f));return l},_incrementTotalItems:function(){var e={loaded:this.get("loadInfo").loaded,total:this.get("loadInfo").total+1};this.set("loadInfo",e)},_incrementLoadedItems:function(){var e={loaded:this.get("loadInfo").loaded+1,total:this.get("loadInfo").total};this.set("loadInfo",e)},_attachCallbacks:function(t){var i=this;t.subscribe("Manipulate",function(r){var s=r.event.from[0].currentPosition;t.setPickable(u.NOPICKABLE);var n=i._urban.getViewpoint().exactPick(s);if(t.setPickable(u.PICKABLE),Utils.is(n)){var o=n.clone();o=n,t.setMatrix((new e.Matrix4).setPosition(o)),t.pos3D=n,t.pos2D={x:s.x,y:s.y},0===t.index?(i._SWanchor=[n.x,n.y],i._centroid.x=(i.anchorList[1].ph.pos3D.x+n.x)/2,i._centroid.y=(i.anchorList[1].ph.pos3D.y+n.y)/2,i._node.setMatrix((new e.Matrix4).setPosition(i._centroid)),i._urban.USR.setRobotTarget(i._itemParent,!0),i.rebuildTerrain()):1===t.index&&(i._NEanchor=[n.x,n.y],i._centroid.x=(n.x+i.anchorList[0].ph.pos3D.x)/2,i._centroid.y=(n.y+i.anchorList[0].ph.pos3D.y)/2,i._node.setMatrix((new e.Matrix4).setPosition(i._centroid)),i._urban.USR.setRobotTarget(i._itemParent,!0),i.rebuildTerrain()),i.widthTexture=i.anchorList[1].ph.pos3D.x-i.anchorList[0].ph.pos3D.x,i.heightTexture=i.anchorList[1].ph.pos3D.y-i.anchorList[0].ph.pos3D.y}}),t.subscribe("BeginManipulate",function(e){t.locked=!0}),t.subscribe("EndManipulate",function(e){t.locked=!1}),t.subscribe("BeginPreactivate",function(e){i.preSelectedPh=t}),t.subscribe("Preactivate",function(e){}),t.subscribe("EndPreactivate",function(e){i.preSelectedPh=null})},_createPointHandle:function(t,i){var r,s=new l({viewer:this._urban.getView3D().webGLV6Viewer,sceneGraph:this.anchorRootNode});return Utils.is(this._pointTexture)?s.pointMat.map=this._pointTexture:this._pointTexture=s.pointMat.map,s.index=this.anchorList.length,s.pos3D=t,s.pos2D={x:i.x,y:i.y},s.name="ph_"+this.anchorList.length,r=t,s.setMatrix((new e.Matrix4).setPosition(r)),s.setSize(20),s.setFillColor(this.pointColor),this._attachCallbacks(s),s},_addAnchor:function(t,i,r,s){if(Utils.is(t)&&Utils.is(i)&&t instanceof e.Vector3&&(i instanceof e.Vector3||i instanceof e.Vector2)){var n={ph:this._createPointHandle(t,i),featureIndex:r||0};this.anchorList.push(n)}},_computePreviewCoefs:function(){if(this.get("objectId")&&this.userData&&this.userData.isPreview){if(this.centroidInit)this.target.getPositionFromMatrix(this._node.getMatrix()),this._rotation=180*Math.acos(this._node._matrix.elements[0])/Math.PI,this._node._matrix.elements[1]<0&&(this._rotation=-this._rotation);else{this.centroidInit=!0,this.widthTexture=xCity.pointOfView.length/4,this.heightTexture=xCity.pointOfView.length/4,this.target=xCity.targetPosition;var t=new e.Vector3(this.target.x,this.target.y,0);this._centroid=t,this._node.setMatrix((new e.Matrix4).setPosition(t)),this._node.userData=this._itemParent;var i=this;this.customRobot=function(){var t=i._node._matrix.getPosition(),r=t.x-i._centroid.x,s=t.y-i._centroid.y;i._SWanchor[0]+=r,i._SWanchor[1]+=s,i._NEanchor[0]+=r,i._NEanchor[1]+=s;var n=new e.Vector3(-i.widthTexture/2,-i.heightTexture/2,0).applyMatrix4(i._node._matrix),o=new e.Vector3(i.widthTexture/2,i.heightTexture/2,0).applyMatrix4(i._node._matrix);i.anchorList[0].ph.pos3D.x=n.x,i.anchorList[0].ph.pos3D.y=n.y,i.anchorList[1].ph.pos3D.x=o.x,i.anchorList[1].ph.pos3D.y=o.y,i.anchorList[0].ph.setMatrix((new e.Matrix4).setPosition(new e.Vector3(i.anchorList[0].ph.pos3D.x,i.anchorList[0].ph.pos3D.y,0))),i.anchorList[1].ph.setMatrix((new e.Matrix4).setPosition(new e.Vector3(i.anchorList[1].ph.pos3D.x,i.anchorList[1].ph.pos3D.y,0))),i._centroid=t.clone(),i.rebuildTerrain()}}if(this._SWanchor||(this._SWanchor=[this.target.x-this.widthTexture/2,this.target.y-this.heightTexture/2]),this.get("selected")){var r=new e.Vector3(this._SWanchor[0],this._SWanchor[1],0),s=xCity._urbanImpl.getViewpoint().getScreenPosition(r);0===this.anchorList.length&&this._addAnchor(r,s,0)}if(this._NEanchor||(this._NEanchor=[this.target.x+this.widthTexture/2,this.target.y+this.heightTexture/2]),this.get("selected")){var n=new e.Vector3(this._NEanchor[0],this._NEanchor[1],0),o=xCity._urbanImpl.getViewpoint().getScreenPosition(n);1===this.anchorList.length&&this._addAnchor(n,o,0)}var a=(xCity._urbanImpl.baseReferential.bbox.xmin-this._SWanchor[0])/(xCity._urbanImpl.baseReferential.bbox.xmin-xCity._urbanImpl.baseReferential.bbox.xmax),h=(xCity._urbanImpl.baseReferential.bbox.ymin-this._SWanchor[1])/(xCity._urbanImpl.baseReferential.bbox.ymin-xCity._urbanImpl.baseReferential.bbox.ymax),l=(xCity._urbanImpl.baseReferential.bbox.xmin-this._NEanchor[0])/(xCity._urbanImpl.baseReferential.bbox.xmin-xCity._urbanImpl.baseReferential.bbox.xmax);return{xMin:h,xMax:(xCity._urbanImpl.baseReferential.bbox.ymin-this._NEanchor[1])/(xCity._urbanImpl.baseReferential.bbox.ymin-xCity._urbanImpl.baseReferential.bbox.ymax),yMin:a,yMax:l,rotation:this._rotation}}},applyOverlay:function(t,r,s){var a=t.getPDSFXUniform("raster");if(n.is(a)){var h,l,d,u,g,f,_,p;void 0===s?void 0!==a.value&&(p=a.value,i.unlock(p.storeId,p.storeKey),t.updatePDSFXUniform("raster",void 0)):void 0!==a.value[s]&&(p=a.value[s],i.unlock(p.storeId,p.storeKey),a.value[s]=void 0);var m=t.getPDSFXUniform("rasterOffset");void 0===s?void 0===m.value&&t.updatePDSFXUniform("rasterOffset",new e.Vector4(0,0,1,1)):void 0===m.value[s]&&(m.value[s]=new e.Vector4(0,0,1,1)),_=c(this,r),p=i.getData(this.get("url"),_.key);if(n.is(p))d=r.LOD-_.LOD;else{for(h=this.get("levelMin"),l=_.LOD,g=_.I,f=_.J;!n.is(p)&&l>h;)l-=1,g>>=1,f>>=1,p=i.getData(this.get("url"),n.getQuadKey(l,g,f)),1;d=r.LOD-l}var y=this.get("opacity");if(n.is(p)||(p=o.whiteMap,2,y=0),n.is(p))if(u=1<<d,g=r.I>>d,f=r.J>>d,i.lock(p.storeId,p.storeKey),void 0===s){if(t.updatePDSFXUniform("raster",p),t.updatePDSFXUniform("rasterOffset",new e.Vector4(r.I/u-g,r.J/u-f,1/u,y)),t.updatePDSFXUniform("previewCoefs",new e.Vector4(-1,-1,-1,-1)),this.get("objectId")&&this.userData&&this.userData.isPreview){var b=this._computePreviewCoefs();t.updatePDSFXUniform("previewCoefs",new e.Vector4(b.yMin,b.xMin,b.yMax,b.xMax)),t.updatePDSFXUniform("previewRotation",new e.Vector4(b.rotation,0,0,0))}}else{a.value[s]=p,m.value[s]=new e.Vector4(r.I/u-g,r.J/u-f,1/u,y);var v=t.getPDSFXUniform("previewCoefs");void 0===v.value[s]&&(v.value[s]=new e.Vector4(0,0,1,1)),v.value[s]=new e.Vector4(-1,-1,-1,-1);var S=t.getPDSFXUniform("previewRotation");if(void 0===S.value[s]&&(S.value[s]=new e.Vector4(0,0,1,1)),S.value[s]=new e.Vector4(0,-1,-1,-1),this.get("objectId")&&this.userData&&this.userData.isPreview){b=this._computePreviewCoefs();v.value[s]=new e.Vector4(b.yMin,b.xMin,b.yMax,b.xMax),S.value[s]=new e.Vector4(b.rotation,0,0,0)}}t.force=!0}},applyLandcover:function(e,t,r){var s=e.getPDSFXUniform("landcover");if(n.is(s)){if(void 0!==s.value){var o=s.value;i.unlock(o.storeId,o.storeKey),e.updatePDSFXUniform("landcover",void 0)}var a,h,l,d,u,g,f=c(this,t);o=i.getData(this.get("url"),f.key);if(n.is(o))l=t.LOD-f.LOD;else{for(a=this.get("levelMin"),h=f.LOD,u=f.I,g=f.J;!n.is(o)&&h>a;)h-=1,u>>=1,g>>=1,o=i.getData(this.get("url"),n.getQuadKey(h,u,g));l=t.LOD-h}if(n.is(o)){i.lock(o.storeId,o.storeKey),e.updatePDSFXUniform("landcover",o),d=1<<l,u=t.I>>l,g=t.J>>l;var _=e.getPDSFXUniform("landcoverOffset");_.value.set(t.I/d-u,t.J/d-g,1/d),e.updatePDSFXUniform("landcoverOffset",_.value)}e.force=!0}},applyLandcover2:function(e,t,i){var r=e.getPDSFXUniform("landcoverIndex");n.is(r)&&(void 0!==r.value&&e.updatePDSFXUniform("landcoverIndex",-1),e.updatePDSFXUniform("landcoverIndex",i))},deprecateTerrain:function(){return i.deprecateAll("terrain"),this},rebuildTerrain:function(){return r.deactivateRasterSource(this.get("id"),this.previous("levelMin")),r.activateRasterSource(this.get("id")),this},setRobot:function(t){if(t){var i=new e.Vector3(this._SWanchor[0],this._SWanchor[1],0),r=xCity._urbanImpl.getViewpoint().getScreenPosition(i);0===this.anchorList.length&&this._addAnchor(i,r,0);var s=new e.Vector3(this._NEanchor[0],this._NEanchor[1],0),n=xCity._urbanImpl.getViewpoint().getScreenPosition(s);1===this.anchorList.length&&this._addAnchor(s,n,0),this.anchorOffsetNode.setVisibility(!0)}else this.anchorOffsetNode.setVisibility(!1)},getLocalPosition:function(){if(this.get("AABBox")){var t=this.get("AABBox").getCenter();return new e.Vector3(t.x,t.y,0)}},setItemParent:function(e){this._itemParent&&(this._itemParent.removeEvent("onChange:visible",this._updateVisibility),this._itemParent.removeEvent("onChange:order",this._reload),this._itemParent.removeEvent("onChange:tags",this._tagChanged.bind(this))),this._parent(e),this._updateVisibility(e),this._itemParent&&(this._itemParent.addEvent("onChange:visible",this._updateVisibility,this),this._itemParent.addEvent("onChange:order",this._reload),this._itemParent.addEvent("onChange:tags",this._tagChanged.bind(this)))},_updateVisibility:function(e){void 0!==e&&(e.get("visible")?r.activateRasterSource(this.get("id")):r.deactivateRasterSource(this.get("id")))},_reload:function(){i.deprecateAll("terrain")},_tagChanged:function(){r.unregisterRasterSource(this.get("id")),r.registerRasterSource(this.get("id"),this)}});return t.ObjectContructor.RasterOverlay=g}),define("DS/XCityModel/LayerVectorPrimitive",["DS/Visualization/ThreeJS_DS","DS/XCityTools/Geocoder","DS/XCityModel/Item","DS/XCityModel/View3DContextualMenuManager","DS/xCityBasicUtils/Utils"],function(e,t,i,r,s){"use strict";var n=i.extend({defaults:{strid:"",dataSourceId:"",geojson:null,instanceId:""},metaData:{type:"Geometry",className:"LayerVectorPrimitive"},setup:function(){this._parent(),this._subMeshes=[],this._localPosition=void 0,this._verticalCameraAltitude=0,this._deselectParent=this.deselectParent.bind(this)},traverse:function(e){for(var t=0;t<this._subMeshes.length;t++)e(this._subMeshes[t].mesh,this._subMeshes[t].subElement)},create:function(e){if(this.created=this._parent(e),!this.created)return!1;this._visible=!0,this._itemParent&&(this._visible=this._itemParent.get("visible")),this.urban=e._urban,this.renderingProfileManager=this.urban.getRenderingProfileManager();for(var t=this.getItemParent();!this._layer&&s.is(t);){var i=t.getItemParent();s.is(i)&&(this._layer=i.getContent()),t=i}return this._layer&&(this._layer.register(this),s.is(this._layer.getItemParent())&&this._layer.getItemParent().addEvent("onChange:selected",this._deselectParent)),this._attachToMesh(),!0},deselectParent:function(){s.is(this.getItemParent())&&this.getItemParent().set("selected",!1)},destroy:function(){if(this._layer){this.resetRenderingAttributes(),s.is(this._layer.getItemParent())&&this._layer.getItemParent().removeEvent("onChange:selected",this._deselectParent),this._layer.unregister(this);for(var e=void 0,t=0;t<this._layer._node.children.length;++t)if(this._layer._node.children[t].isAreaCluster){e=this._layer._node.children[t];break}void 0!==e&&this._layer._node.removeChild(e)}this._layer=void 0,this._detachToMesh(),this._subMeshes=[],this._parent()},addSubElements:function(i,r){if(i){if(i.geom){r&&(this._subMeshes=[]);for(var s=0;s<i.geom.length;s++){var n=i.geom[s];n.start?this.addSubElement(n.geometry,{start:n.start,count:n.count}):this.addSubElement(n.mesh,n.subElement)}this._visible||this.setVisible(!1)}var o;if(i.userData)for(o in null===this.userData&&(this.userData={}),i.userData)i.userData.hasOwnProperty(o)&&(this.userData[o]=i.userData[o]);if(i.posSize&&i.posSize.center&&i.posSize.center instanceof e.Vector3){if(this._localPosition=i.posSize.center.clone(),"EPSG:3857"===t.getDefaultProjection()||"EPSG:900913"===t.getDefaultProjection()){var a=t.computeMercatorScaleFactor(this._localPosition.x,this._localPosition.y,t.getDefaultProjection());this._localPosition.z*=a}i.posSize.diameter?this._localSphereDiameter=i.posSize.diameter:this._localSphereDiameter=Math.max(i.posSize.height,i.posSize.length,i.posSize.width)}}else this._subMeshes=[]},setLayerVector:function(e){this._layer=e,this.set("dataSourceId",this._layer.id)},addSubElement:function(e,t){t instanceof THREEDS.SubElement||(t=THREEDS.SubElement.getFromSGNode(t)),e.instanceId=this.get("instanceId");for(var i=!1,r=0;r<this._subMeshes.length;++r)this._subMeshes[r].mesh.id===e.id&&this._subMeshes[r].subElement.id===t.id&&(i=!0);i||(this._subMeshes.push({mesh:e,subElement:t}),t.sgNode.userData=this._feature)},_attachToMesh:function(){for(var e=0;e<this._subMeshes.length;e++)this._subMeshes[e].subElement.sgNode&&(this._subMeshes[e].subElement.sgNode.userData=this._feature)},_detachToMesh:function(){for(var e=0;e<this._subMeshes.length;e++)this._subMeshes[e].subElement.sgNode&&(this._subMeshes[e].subElement.sgNode.userData=void 0)},_setFeature:function(e){this._feature=e,this._attachToMesh(this)},getLocalPosition:function(){return this._localPosition},getSphereDiameter:function(){return this._localSphereDiameter},getBoundingSphere:function(){if(this._localPosition&&this._localSphereDiameter)return new e.Sphere(this._localPosition,this._localSphereDiameter/2)},getBbox:function(){var t=this.getFactory()._getPrimInfo(this).posSize;if(!s.is(t)){var i=this.getFactory()._getPrimInfo(this).geom[0].mesh.getBoundingBox();(t={}).width=i.max.x-i.min.x,t.length=i.max.y-i.min.y,t.height=i.max.z-i.min.z}var r=t.center;r.z=t.altitude;var n=parseFloat(t.width),o=parseFloat(t.length),a=parseFloat(t.height);return i=[new e.Vector3(r.x-o/2,r.y-n/2,r.z),new e.Vector3(r.x+o/2,r.y-n/2,r.z),new e.Vector3(r.x-o/2,r.y+n/2,r.z),new e.Vector3(r.x-o/2,r.y-n/2,r.z+a),new e.Vector3(r.x+o/2,r.y+n/2,r.z),new e.Vector3(r.x-o/2,r.y+n/2,r.z+a),new e.Vector3(r.x+o/2,r.y-n/2,r.z+a),new e.Vector3(r.x+o/2,r.y+n/2,r.z+a)]},getBboxFromTurf:function(){var t=this.getFactory()._getFeatureDataFromStrid(this._getStrid()),i=s.getBbox(t),r=i[0],n=i[1],o=i[2],a=i[3],h=this.getFactory()._getPrimInfo(this).posSize.altitude,l=i[4]?h+i[4]:h,d=i[5]?h+i[5]:h;return[new e.Vector3(r,n,l),new e.Vector3(o,n,l),new e.Vector3(r,a,l),new e.Vector3(o,a,l),new e.Vector3(r,n,d),new e.Vector3(o,n,d),new e.Vector3(r,a,d),new e.Vector3(o,a,d)]},getBboxProjectedInScreen:function(){var t;if("billboard"===this.get("shapeType")){let t=this.getFactory()._computeLabelPos(this),i=this.urban.USR.viewpoint.getScreenPosition(t),r=this.getFactory()._computeGeometrySize(this),s=r.width,n=r.height;if(this.get("switchDistance")){let i=this._subMeshes[0].mesh.mesh3js.getNode().getMatrixWorld();i.elements[14]=t.z;let r=(new e.Matrix4).multiplyMatrices(this.urban.USR.viewpoint.camera.matrixWorldInverse,i),o=-(new e.Vector3).getPositionFromMatrix(r).z;if(o<this.get("switchDistance")){let e=this.get("switchDistance")/o;s*=e,n*=e}}return[new e.Vector3(i.x-s/2,i.y-n,i.z),new e.Vector3(i.x+s/2,i.y-n,i.z),new e.Vector3(i.x-s/2,i.y,i.z),new e.Vector3(i.x-s/2,i.y-n,i.z),new e.Vector3(i.x+s/2,i.y,i.z),new e.Vector3(i.x-s/2,i.y,i.z),new e.Vector3(i.x+s/2,i.y-n,i.z),new e.Vector3(i.x+s/2,i.y,i.z)]}if(t=this.getBbox(),this.urban.showPrimBbox&&!this.renderedBbox){var i=(new e.Vector3).subVectors(t[7],t[0]);this.renderedBbox=s.drawCuboid(t[0],i.x,i.y,i.z)}var r=[];for(let e=0;e<t.length;e++){let i=this.urban.USR.viewpoint.getScreenPosition(t[e]);i.z>-1&&i.z<1&&r.push(i)}return r},getScreenAABbox:function(){var t=this.getBboxProjectedInScreen(),i=Math.min.apply(Math,t.map(e=>e.x)),r=Math.max.apply(Math,t.map(e=>e.x)),s=Math.min.apply(Math,t.map(e=>e.y)),n=Math.max.apply(Math,t.map(e=>e.y));if(!t.length)throw Error("No posSize available with web workers yet");return{min:new e.Vector2(i,s),max:new e.Vector2(r,n)}},drawDebugBbox:function(){this.getScreenAABbox()},eraseDebugBbox:function(){(s.is(this.renderedBbox)&&(this.urban.getView3D()._rootProjShifted.removeChild(this.renderedBbox),this.urban.getView3D()._rootProjShifted.removeChild(this.renderedBbox),delete this.renderedBbox),s.is(this.canvasBbox))&&this.canvasBbox.getContext("2d").clearRect(0,0,this.canvasBbox.width,this.canvasBbox.height)},getVerticalCameraAltitude:function(){return this._verticalCameraAltitude},setVisible:function(e){this._visible=e;for(var t=0;t<this._subMeshes.length;t++)if(this._subMeshes[t].mesh.isInstanceNode3D&&s.is(this._subMeshes[t].mesh.setVisible))this._subMeshes[t].mesh.setVisible(e,this.get("strid"));else{var i=this._subMeshes[t].subElement;i.sgNode&&(e?this._subMeshes[t].mesh.show([i]):this._subMeshes[t].mesh.hide([i]))}return this.urban.USR._forceRender(),this},setMaterial:function(e){var t,i=this._subMeshes;s.is(this._layer)&&(t=this.get("strid")||this.getSubMeshId(i),this.renderingProfileManager.addRendering(this._layer.parentFeatureID,e,t),this.getItemParent().temporary=!1)},getMaterial:function(){var e=this.get("strid")||this.getSubMeshId(this._subMeshes),t=this.getRendering();return s.is(t)?t.getCompleteMaterialInfo(e,this.userData):this.renderingProfileManager.getRenderingData(this._layer.parentFeatureID,e)},getSubMeshId:function(e){if(s.is(e)&&s.is(e[0])&&s.is(e[0].subElement)&&s.is(e[0].subElement.sgNode)&&s.is(e[0].subElement.sgNode.cgmId))return e[0].subElement.sgNode.cgmId},getFactory:function(){if(this._layer)return this._layer.getFactory()},get:function(e){var t,i,r=this.getRendering();return this.renderingProfileManager&&s.is(r)&&r.hasAttribute(e)?(i=this.getMaterial(),s.is(i)&&(t=i[e])):t=this._parent(e),t},setItemParent:function(e){var t=this,i=function(e){t.setVisible(e.get("visible"))};this._itemParent&&this._itemParent.removeEvent("onChange:visible",i),this._parent(e),this._itemParent&&this._itemParent.addEvent("onChange:visible",i)},setAttribute:function(t,i){if("color"===t&&(s.is(i)?i instanceof e.Color||(i=new e.Color(i)):i=new e.Color),this.get(t)!==i)return this.set(t,i),this;var r,n;for(r=0;r<this._subMeshes.length;r++)(n=this._subMeshes[r].mesh).setAttribute&&n.setAttribute(t,i,[this._subMeshes[r].subElement.sgNode]);return this},set:function(e,t){var i={},r=this.getRendering();this.renderingProfileManager&&s.is(r)&&r.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t)},getRendering:function(){if(s.is(this._layer))return s.is(this.indexMesh)?this._layer.getRendering(this.indexMesh):this._layer.getRendering()},resetRenderingAttributes:function(){if(s.is(this.renderingProfileManager)&&s.is(this._layer)){var e=this._getStrid();this.renderingProfileManager.resetPrimitive(this._layer.parentFeatureID,e)&&(this.renderingProfileManager.updateGeomRenderings([this._layer]),this._layer.redrawPrimitive(e))}},resetRenderingAttribute:function(e){if(s.is(this.renderingProfileManager)&&s.is(this._layer)){var t=this._getStrid();this.renderingProfileManager.resetPrimitiveAttributeOnly(this._layer.parentFeatureID,t,e)&&(this.renderingProfileManager.updateGeomRenderings([this._layer]),this._layer.redrawPrimitive(t))}},_getStrid:function(){return this.get("strid")||this.getSubMeshId(this._subMeshes)},highlight:function(){if(this._layer&&this._layer._patch&&!this._layer._patch.previewMode){var e=XCityCoreStore.getStore(this._layer.id),t=this._layer._patch.miDToTile[this.get("strid")];if(t){var i=t.tile;if(i){var r=e._invertY?(1<<i.LOD)-1-i.J:i.J,n=s.getQuadKey(i.LOD,i.I,r);e.lockData(n)}}}},unhighlight:function(){if(this._layer&&this._layer._patch&&!this._layer._patch.previewMode){var e=XCityCoreStore.getStore(this._layer.id),t=this._layer._patch.miDToTile[this.get("strid")];if(t){var i=t.tile;if(i){var r=e._invertY?(1<<i.LOD)-1-i.J:i.J,n=s.getQuadKey(i.LOD,i.I,r);e.unlockData(n)}}}}});return r.addNewContextualMenu(function(e){return e.get("Content")instanceof n},[{name:"ContextualTreeview",line:1,hdr_list:["pTreeview"]},{name:"ContextualVisibility",line:1,hdr_list:["pVisibility"]},{name:"ContextualInfo",line:1,hdr_list:["pInfo"]},{name:"ContextualColor",line:1,hdr_list:["pColor"]},{name:"ContextualOpacity",line:1,hdr_list:["pOpacity"]}]),i.ObjectContructor.LayerVectorPrimitive=n}),define("DS/XCityModel/Location",["DS/XCityTools/Geocoder","UWA/Core","DS/XCityModel/Item","DS/Visualization/ThreeJS_DS","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s){"use strict";var n=i.extend({defaults:t.merge({position:null,projection:null,shifted:!1,altitudeMode:"absolute"},i.defaults),metaData:{type:"Location",className:"Location"},loaderJSON:{position:"loadJSONVector3"},setup:function(){this._parent(),this._matrix=new r.Matrix4,this._localPosition=void 0,this._scale=1,this.get("position")||this.set("position",new r.Vector3);var t=function(t){e.loadProjection(t.get("projection"),t._updatePosition.bind(t))};this.get("projection")&&t(this),this.addEvent("onChange:projection",t,this)},destroy:function(e){e._urban.getView3D()._removePointToProject(this.id),this._parent(e)},set:function(e,t){this._parent(e,t)},create:function(e){if(!this._parent(e))return!1;e._urban;this._matrix.identity(),this._updatePosition(),this._updateAltitudeMode(),this.addEvent("onChange:position",this._updatePosition,this),this.addEvent("onChange:altitudeMode",this._updateAltitudeMode,this);return this.addEvent("onChange:matrix",function(){s.publish("/xCity/needRender",this)},this),!0},getLocalPosition:function(){return this._localPosition},_updatePosition:function(){if(this._created){if(this._oldscale=this._scale,this._scale=1,"EPSG:3857"!==e.getDefaultProjection()&&"EPSG:900913"!==e.getDefaultProjection()||(this._scale=e.computeMercatorScaleFactor(this.get("position").x,this.get("position").y,this.get("projection"))),this._scale!==this._oldscale){var t=this._scale/this._oldscale;this._matrix.scale({x:t,y:t,z:1})}var i=this.get("position").clone();if(this._localPosition&&this._lastPosition){var r=this._localPosition.z-this._lastPosition.z;i.z+=r}if(this._localPosition=i,this.get("shifted")&&this.getRoot()&&this._localPosition.add(this.getRoot()._urban.shiftedPosition),this.get("projection")||this.getRoot()&&this.getRoot()._urban.getProjectProjection()!==this.getRoot()._urban.getUserDefaultProjection()){var s=e.proj(this.get("position"),this.get("projection"));this._localPosition.set(s.x,s.y,this.get("position").z)}this._matrix.setPosition(this._localPosition),this._lastPosition=this.get("position").clone(),this.dispatchEvent("onChange:matrix",this._matrix.clone())}},_setAltitude:function(e){this._localPosition.z=(this._scaleZ?this._scale:1)*(e+this.get("position").z),this._matrix.elements[14]=this._localPosition.z,this.dispatchEvent("onChange:matrix",this._matrix.clone())},_updateAltitudeMode:function(e){"absolute"!==this.previous("altitudeMode")&&this.getRoot()&&this.getRoot()._urban.getView3D()._removePointToProject(this.id),"absolute"!==this.get("altitudeMode")?this.getRoot()&&this.getRoot()._urban.getView3D()._addPointToProject(this.id,this.getLocalPosition.bind(this),this._setAltitude.bind(this)):this._setAltitude(0)},setMatrix:function(t){this._matrix.copy(t);var i=this._matrix.decompose()[0],r=i.z;(i=e.proj(i,"",this.get("projection"))).z=r,this.set("position",i)},highlight:function(){},unhighlight:function(){}});return i.ObjectContructor.Location=n}),define("DS/XCityModel/Light",["DS/Visualization/ThreeJS_DS","DS/XCityModel/Location","DS/XCityModel/Item","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/Visualization/Node3D","DS/SceneGraphNodes/PointLightNode","DS/SceneGraphNodes/SpotLightNode","DS/SceneGraphNodes/AreaLightNode","DS/Visualization/SceneGraphFactory"],function(e,t,i,r,s,n,o,a,h,l){"use strict";var d=t.extend({defaults:{type:"pointLight",color:"#ffffff",intensity:1,power:0,distance:0,outerAngle:1.5707963267948966,innerAngle:1.5697963267948967,physicalAttenuation:!0,attenuationScale:null,mode:"LUMINOUS_EXITANCE",width:1,height:1,Coordinate:null},metaData:{type:"Location",className:"Light"},setup:function(){this._node=new n,this._node.name="LightFeature",this._parent(),this.addEvent("onChange:Coordinate",this._updateCoordinate,this)},destroy:function(e){this._parent(e),e.getNode3D().remove(this._node)},create:function(t){if(!this._parent(t))return s.publish(s.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;t._urban;this._updateCoordinate();this.getLocalPosition();var i=this.get("intensity");-1===i&&(i=void 0);var r=this.get("type");return this.lightNode="pointLight"===r?new o({color:new e.Color(this.get("color")),intensity:i,power:this.get("power"),distance:this.get("distance"),physicalAttenuation:this.get("physicalAttenuation"),attenuationScale:this.get("attenuationScale")}):"areaLight"===r?new h({color:new e.Color(this.get("color")),intensity:i,width:this.get("width"),height:this.get("height"),mode:this.get("mode")}):new a({color:new e.Color(this.get("color")),intensity:i,power:this.get("power"),distance:this.get("distance"),physicalAttenuation:this.get("physicalAttenuation"),attenuationScale:this.get("attenuationScale"),outerAngle:this.get("outerAngle"),innerAngle:this.get("innerAngle")}),this.helperNode=l.createSphereNode({radius:2}),this._node.add(this.lightNode),t.getNode3D().add(this._node),this.userData={},!0},getRendering:function(){},redraw:function(){},setItemParent:function(e){this._itemParent&&this._itemParent.removeEvent("onChange:selected",this._select),this._itemParent=e,this._itemParent.userData={editablePosition:!0},e&&this._itemParent.addEvent("onChange:selected",this._select,this)},getBaseAltitude:function(){return this._node.getMatrix().elements[14]},_updateCoordinate:function(){var e=this.previous("Coordinate");e&&e.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")?(this.get("Coordinate").setItemParent(this),this._updateMatrix(this.get("Coordinate")._matrix),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this)):this._updateMatrix()},_updateMatrix:function(e){this._node.setMatrix(e)},_updatePosition:function(){this._parent();var e=this.getLocalPosition();this._poi&&this._poi.setPosition(e)},_setVisible:function(e){var t=!!e.get("visible");this._poi&&(this._poi.setVisibility(t),this.getRoot()?this.getRoot()._urban.poiManager.check():this._root&&this._root._urban&&this._root._urban.poiManager&&this._root._urban.poiManager.check())},_select:function(e){e.get("selected")?this._node.add(this.helperNode):this._node.remove(this.helperNode)},addUserDataProperty:function(e,t,i){},removeUserDataProperty:function(e,t){}});return i.ObjectContructor.Light=d}),define("DS/XCityModel/PointOfInterest",["DS/XCityModel/Location","DS/XCityModel/Item","DS/XCityGeometry/PointOfInterest","DS/XCityRendering/RenderingHandlerPointOfInterest","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n){"use strict";var o=e.extend({defaults:{classStyle:"poiText"},metaData:{type:"Location",className:"PointOfInterest"},setup:function(){this._parent(),this._poi=void 0,this._scaleZ=!0,this.addEvent("onChange:position",this._updatePosition,this),this.addEvent("onChange:classStyle",this._updateClassStyle,this)},destroy:function(e){this._poi&&(this._poi.remove(),this._poi.destroy()),this._parent(e)},create:function(e){if(!this._parent(e))return n.publish(n.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;var t=e._urban,r=this._attributes.groupId,s=(t.poiManager.addGroup(r,!0),this.getLocalPosition());return this._poi=new i(t,this,s,this.get("classStyle"),this._itemParent?this._itemParent.get("name"):"",void 0,void 0,void 0,this._itemParent.get("description")),this._poi.setUserData(this._itemParent),this._updateName(),this._setVisible(this._itemParent),this._initRenderingProfile(t,this._attributes),this._updateClassStyle(),this._poi.textDiv.dataModelID=this._itemParent.get("id"),n.publish(n.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()}),!0},_initRenderingProfile:function(e,t){this._rendering=new r(e,t),this.renderingProfileManager=e.getRenderingProfileManager(),this.renderingProfileManager.initRendering(this)},getRendering:function(){return this._rendering},redraw:function(){var e=this.getRendering();if(s.is(e)){var t=e.getCompleteMaterialInfo();s.is(t)&&s.is(t.classStyle)&&this.set("classStyle",t.classStyle)}},_updateClassStyle:function(){this._poi&&this._poi.updateClassName(this.get("classStyle"))},setItemParent:function(e){this._itemParent&&(this._itemParent.removeEvent("onChange:name",this._updateName),this._itemParent.removeEvent("onChange:selected",this._select),this._itemParent.removeEvent("onChange:visible",this._setVisible),this._itemParent.removeEvent("onChange:description",this._setDescription)),this._itemParent=e,e&&(this._itemParent.addEvent("onChange:name",this._updateName,this),this._itemParent.addEvent("onChange:selected",this._select,this),this._itemParent.addEvent("onChange:visible",this._setVisible,this),this._itemParent.addEvent("onChange:description",this._setDescription,this),this._poi&&this._poi.setUserData(e),this._updateName()),this._poi&&this._poi.setUserData(this._itemParent)},_updatePosition:function(){this._parent();var e=this.getLocalPosition();this._poi&&this._poi.setPosition(e)},_updateName:function(){this._poi&&this._itemParent&&this._poi.setText(this._itemParent.get("name"))},_setDescription:function(){this._poi&&this._itemParent&&this._poi.setDescription(this._itemParent.get("description"))},_setVisible:function(e){var t=!!e.get("visible");this._poi&&(this._poi.setVisibility(t),this.getRoot()?this.getRoot()._urban.poiManager.check():this._root&&this._root._urban&&this._root._urban.poiManager&&this._root._urban.poiManager.check())},_select:function(e){this._poi&&this._poi.select(e.get("selected"))}});return t.ObjectContructor.PointOfInterest=o}),define("DS/XCityModel/Content",["DS/XCityModel/Item","DS/XCityTools/Downloader","DS/xCityBasicUtils/Utils","DS/XCityTools/ShaderTools","DS/XCityTools/RenderingTools"],function(e,t,i,r,s){"use strict";return e.extend({defaults:{renderID:"",objectId:"",Rendering:null,loadInfo:{loaded:1,total:1}},metaData:{type:"Content",className:"Content"},create:function(e){var t=this._parent(e);this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this.addEvent("OnDestroy",this._cleanResource.bind(this));var i=e._urban;return this._urban=i,this.renderingProfileManager=this._urban.getRenderingProfileManager(),t},_cleanResource:function(){this.renderingProfileManager.getResourceProfile().removeRendering(this.parentFeatureID)},redraw:function(){console.error("redraw Interface should be implemented on derived classes ")},_getUrlOptions:function(e){return t.getUrlOptions(e)},_getDatasetBaseUrl:function(e){var t=e.split("?")[0],r=this._getDatasetId(t);if(i.is(r))return this._getDataSupplierUrl()+r+"/"},_changeUrlEnd:function(e){var t=this.get("url"),r=this._getDatasetBaseUrl(t),s=r.length,n=r.indexOf("resources");n>=s-10&&(r=r.slice(0,n));var o=t.split("?")[1],a=r+e;return i.is(o)&&(a+="?"+o),a},_getResourceUrl:function(e){return this._changeUrlEnd("resources/"+e)},_getStyleUrl:function(){return this._changeUrlEnd("style")},loadResource:function(e){t.isAPlatformService(this.get("url"))&&("enovia"!==this.get("type")&&i.is(e)&&(i.endsWith(e,".sld")?this.addSLDResource(this._getResourceUrl(e)):(i.endsWith(e,".png")||i.endsWith(e,".jpg"))&&this.addMapResource(this._getResourceUrl(e))))},loadStyle:function(){let e=this._attributes&&this._attributes.objectId,t="undefined"!=typeof xCity&&xCity.widgetData&&xCity.widgetData.datasetCollection&&xCity.widgetData.datasetCollection.get({id:e}),i=t?t.get("style"):null;return!1===(i&&(i.insource||i.customized))?null:this.getStyleFromServer()},getRendering:function(){var e=null;return i.is(this._rendering)&&(e=this._rendering),e},getRenderingHandler:function(){var e=null;return i.is(this._rendering)&&(e=this._rendering),e},getMaterial:function(){var e=this.getRendering();return i.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)},get:function(e){var t,r,n=this.getRendering();return"heightOffset"===e&&(e="elevationOffset"),this.renderingProfileManager&&i.is(n)&&n.hasAttribute(e)?(r=this.getMaterial(),i.is(r)&&(t=(r=s.getJSONFromRendering(r))[e])):t=this._parent(e),t},set:function(e,t){var r={},s=this.getRendering();"heightOffset"===e&&(e="elevationOffset"),this.renderingProfileManager&&i.is(s)&&s.hasAttribute(e)?(r[e]=t,this.setMaterial(r)):this._parent(e,t)},resetRenderingAttribute:function(e){if(i.is(this.renderingProfileManager)){let t=this.getRendering();if(i.is(t)){let i=t.getDependantAttributes(e);for(let e=0;e<i.length;e++){const t=i[e];this.renderingProfileManager.resetRenderingAttribute(this.parentFeatureID,t)}}}},addSLDResource:function(e,t){if(i.is(e)&&i.is(this.renderingProfileManager)&&i.is(this.parentFeatureID)){var r=this;this.downloadResource(e,function(i,s,n){if(s)try{var o=i;r.renderingProfileManager._parseSLD(o,r.parentFeatureID,e)}catch(e){console.error("Error while parsing SLD: "+e.stack)}t&&t(i,s,n)})}},addMapResource:function(e){if(i.is(e)&&i.is(this.renderingProfileManager)&&i.is(this.parentFeatureID)){var t=this;this.downloadResource(e,function(i,r,s){if(r){var n={};n.mapUrl=e,t.renderingProfileManager.getResourceProfile().addRendering(t.parentFeatureID,n)}})}},downloadResource:function(e,i){t.download(e,{},999999,function(e,t,i,r){r(t,e,i)},void 0,i)},updateStatistics:function(){var e=this.get("url");if(t.isAPlatformService(e)){var i=t.getDataSupplierUrlFromUrl(e),r=this;this.requestStatistics(i,function(e,t,i){t&&r.setStatistics(e.analytics)})}},_getDatasetId:function(e){return this.get("objectId")},getUrlOptions:function(e){var t=e.split("?");return t[t.length-1]},setStatistics:function(e){this.set("statistics",e)},requestStatistics:function(e,i){const r="undefined"!=typeof xCity&&xCity.widgetData&&xCity.widgetData.datasetCollection,s=t.getUuidFromUrl(e);if(r&&r.get(s)&&r.get(s).get("analytics")){let e=JSON.parse(JSON.stringify(r.get(s)));setTimeout(i.bind(this),0,e,!0)}else t.download(e,{responseType:"json"},999999,function(e,t,i,r){r(t,e,i)},void 0,i)},toJSON:function(e){var t=this._parent(e);return delete t.Rendering,t},requestResourceStyle:function(e,t){if(i.is(e)&&i.is(this.renderingProfileManager)&&i.is(this.parentFeatureID)){var r=this;this.downloadResource(e,function(i,s,n){if(s)try{var o=i;r.renderingProfileManager._parseSLDInfos(o,r.parentFeatureID,e)}catch(e){try{var a=JSON.parse(i);r.renderingProfileManager.addStyleToResource(r.parentFeatureID,a)}catch(t){console.error("Error while parsing SLD: "+e.stack),console.error("Error while parsing JSON: "+t.stack)}}t&&t(i,s,n)})}},getStyleFromServer:function(e){if(t.isAPlatformService(this.get("url"))&&"enovia"!==this.get("type")){var i=this._getStyleUrl();this.requestResourceStyle(i,e)}},uploadStyleToServer:function(e){if(t.isAPlatformService(this.get("url"))&&"enovia"!==this.get("type")){var i=this.getRenderingToUpload(),r=this._getAuthoringStyleUrl(),s={method:"PUT"},n=new FormData,o=new Blob([JSON.stringify(i)],{type:"text/json"});n.append("file",o,"style.json"),s.data=n,this.serverRequest(r,s,e)}},deleteStyleOnserver:function(e){if(t.isAPlatformService(this.get("url"))&&"enovia"!==this.get("type")){var i=this._getAuthoringStyleUrl(),r={method:"DELETE"};this.serverRequest(i,r,e)}},_getUUid:function(e){return this.get("objectId")},_getOptions:function(e){var t=e.split("?");return 2===t.length?"?"+t[1]:""},_getAuthoringStyleUrl:function(){var e=this.get("url"),r=t.resolveUrl(e),s=r.split("/datasupplier/");if(2!==s.length)return console.error("globe url format not usable for authoring"),"";var n=this._getOptions(r),o=this._getUUid(r),a=null;return i.is(o)&&(a=s[0]+"/authoring/dataset/"+o+"/style"+n),a},getRenderingToUpload:function(){var e=this.renderingProfileManager.getResourceProfile().getRenderingForLayer(this),t=this.renderingProfileManager.getSessionProfile().getRenderingForLayer(this);return e._priorityClean(t.getRenderingData()),e.addOver(t),e.toJSON()},serverRequest:function(e,i,r){var s={headers:{},withCredentials:!0,onComplete:r,onFailure:r},n=Object.assign(s,i);t.authenticatedRequest(e,n)},_getDataSupplierUrl:function(){return t.getDataSupplierUrl()}})}),define("DS/XCityModel/Terrain",["DS/Visualization/ThreeJS_DS","DS/XCityModel/Item","DS/XCityModel/Content","DS/XCityCore/Store","DS/XCityCore/Terrain","DS/XCityTools/Debug","DS/xCityBasicUtils/Utils","DS/XCityRendering/RenderingHandlerGeometricTerrain","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n,o,a,h){"use strict";var l=function(e,t){var i=o.cloneQuad(t);return"geometricMode"!==e.get("sourceMode")&&i.LOD>e.get("levelMax")&&(i.I=i.I>>i.LOD-e.get("levelMax"),i.J=i.J>>i.LOD-e.get("levelMax"),i.LOD=e.get("levelMax"),i.key=void 0),e.get("yTopToBottom")&&(i.J=(1<<i.LOD)-1-i.J,i.key=void 0),void 0===i.key&&(i.key=o.getQuadKey(i.LOD,i.I,i.J)),i},d=i.extend({defaults:{levelMin:0,levelMax:-1,levelMaxVisu:99999,priority:3,cache:50,AABBox:null,url:"",sourceMode:"raster",border:0,res:1,yTopToBottom:!1,statistics:null,loadInfo:{loaded:1,total:1}},metaData:{type:"Terrain",className:"Terrain"},loaderJSON:{AABBox:"loadJSONAABox"},setup:function(){this._parent()},create:function(t){if(!this._parent(t))return!1;this._partial=[],this._complete=[],this._attributes.loadInfo.loaded=1,this._attributes.loadInfo.total=1;var i=function(){-1===r.getStoreList().indexOf(this.get("url"))&&(r.deleteStore(this.previous("url")),this.get("url").search("%xmin")>-1&&this.get("url").search("%xmax")>-1&&this.get("url").search("%ymin")>-1&&this.get("url").search("%ymax")>-1?r.createStore(this.get("url"),{url:this.get("url"),cacheSize:this.get("cache"),priority:this.get("priority"),floatTexture:{width:this.get("res"),height:this.get("res")},wms:{worldSize:t._urban.worldSize,shiftedPosition:t._urban.shiftedPosition},onFinish:{func:this._onFinish.bind(this),bound:this}}):(r.createStore(this.get("url"),{url:this.get("url"),cacheSize:this.get("cache"),priority:this.get("priority"),floatTexture:{width:this.get("res"),height:this.get("res")},tile:!0,onFinish:{func:this._onFinish.bind(this),bound:this}}),this.updateStatistics()),r.deprecateAll("terrain"))}.bind(this),n=function(){-1===r.getStoreList().indexOf(this.get("url"))&&(r.deleteStore(this.previous("url")),this.get("url").search("%xmin")>-1&&this.get("url").search("%xmax")>-1&&this.get("url").search("%ymin")>-1&&this.get("url").search("%ymax")>-1?r.createStore(this.get("url"),{url:this.get("url"),cacheSize:this.get("cache"),priority:this.get("priority"),streamvisu:!0,rendering:this._rendering,wms:{worldSize:t._urban.worldSize,shiftedPosition:t._urban.shiftedPosition},onFinish:{func:this._onFinish.bind(this),bound:this}}):r.createStore(this.get("url"),{url:this.get("url"),cacheSize:this.get("cache"),priority:this.get("priority"),streamvisu:!0,rendering:this._rendering,tile:!0,onFinish:{func:this._onFinish.bind(this),bound:this}}),r.deprecateAll("terrain"))}.bind(this);if(this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this.isGeometric()){this._rendering=new a(t._urban),this.renderingProfileManager=t._urban.getRenderingProfileManager(),this.renderingProfileManager.initRendering(this),this.renderingProfileManager.addRendering("3DXCityGeometricTerrain",{showOcean:s._isOceanEnabled()});var o=this.renderingProfileManager.getProfile("Underground");Utils.is(o)||(o=this.renderingProfileManager.createProfile("Underground"));o.addRendering(this.parentFeatureID,{opacity:.3}),n(),this.addEvent("onChange:url",n),this.loadResource("landuse_atlas.jpg")}else{i(),this.addEvent("onChange:url",i),this._dtmProperties=new e.Vector4(0);var h=function(){this._dtmProperties.setX(1/this.get("res")),this._dtmProperties.setY(1/this.get("res")),this._dtmProperties.setZ(this.get("border")*this._dtmProperties.x),this._dtmProperties.setW(this.get("border")*this._dtmProperties.y)}.bind(this);h(),this.addEvent("onChange:res",h),this.addEvent("onChange:border",h)}return s.registerTerrainSource(this.get("id"),this),this._updateVisibility(this.getItemParent()),!0},_onFinish:function(e){h.publish(h.eventsList.onLoaded+":"+this.get("id"),{success:e,item:this.getItemParent()})},destroy:function(e){s.deactivateTerrainSource(this.get("id")),s.unregisterTerrainSource(this.get("id"));var t=!0;e.traverse(function(e){e.get("Content")&&e.get("Content").get("url")&&e.get("Content").get("id")!==this.get("id")&&e.get("Content").get("url")===this.get("url")&&(t=!1)}.bind(this),!0),t&&r.deleteStore(this.get("url"),!0),this._parent(e)},isGeometric:function(){return-1!==this.get("sourceMode").indexOf("geometric")},isHD:function(){return-1!==this.get("sourceMode").indexOf("HD")},acceptTile:function(e){if(e.LOD<this.get("levelMin")||e.LOD>this.get("levelMaxVisu"))return!1;if(o.is(this.get("AABBox"))){var t={};if(this.get("AABBox").getIJBox(e.LOD,t),e.I<t.IMin||e.I>t.IMax)return!1;if(e.J<t.JMin||e.J>t.JMax)return!1}var i=void 0;if(e.LOD<=this.get("levelMax")){if(!(i=this._complete.indexOf(e.key)>-1)&&-1===this._partial.indexOf(e.key)){i=void 0;for(var r={LOD:e.LOD,I:e.I,J:e.J,key:0},s=!1,n=!1,a=e.LOD;a>=0&&(r.I=r.I>>1,r.J=r.J>>1,--r.LOD,r.key=o.getQuadKey(r.LOD,r.I,r.J),!(n=this._complete.indexOf(r.key)>-1));--a);n&&(i=!0)}}else{for(r={LOD:e.LOD,I:e.I,J:e.J,key:0},s=!1,n=!1,a=e.LOD;a>=0&&(r.I=r.I>>1,r.J=r.J>>1,--r.LOD,r.key=o.getQuadKey(r.LOD,r.I,r.J),s=this._partial.indexOf(r.key)>-1,!(n=this._complete.indexOf(r.key)>-1)&&!s);--a);n?i=!0:s&&(i=!1)}return{valid:!0,complete:i}},acceptStrictTile:function(e){if(e.LOD<this.get("levelMin")||e.LOD>this.get("levelMax"))return!1;if(o.is(this.get("AABBox"))){var t={};if(this.get("AABBox").getIJBox(e.LOD,t),e.I<t.IMin||e.I>t.IMax)return!1;if(e.J<t.JMin||e.J>t.JMax)return!1}return!0},cancelTile:function(e){if(!this.isGeometric()){var t=l(this,e);t.LOD===e.LOD&&r.cancelDownloadData(this.get("url"),t.key)}},updateTile:function(e){var t=l(this,e);r.updateTimestampData(this.get("url"),t.key)},getTile:function(e){var t=l(this,e);return r.getData(this.get("url"),t.key)},downloadTile:function(e,t,i,s,n){var a=function(e,t,i,r,s,n){if(206===n?-1===this._partial.indexOf(s)&&this._partial.push(s):200===n&&-1===this._complete.indexOf(s)&&this._complete.push(s),void 0!==i){var o=Array.prototype.slice.call(arguments,4);o.unshift(e,t),i.apply(r,o)}this._incrementLoadedItems()};if(!this.isGeometric()){_={tile:l(this,e),priority:i,undeletable:t.undeletable};var h=r.getData(this.get("url"),_.tile.key);if(!o.is(h)&&(t.isVisible&&(this._incrementTotalItems(),(f=Array.prototype.slice.call(arguments,3)).unshift(this.get("url"),_.tile.key,_,a,this),r.getOrDownloadData.apply(r,f)),t&&t.canUseParent))for(var d=this.get("levelMin"),u=_.tile.LOD,c=_.tile.I,g=_.tile.J;!o.is(h)&&u>d;)u-=1,c>>=1,g>>=1,r.getData(this.get("url"),o.getQuadKey(u,c,g));return h}if(this.acceptStrictTile(e)){var f,_={tile:l(this,e),priority:i,undeletable:t.undeletable},p=r.getData(this.get("url"),_.tile.key);return o.is(p)||t.isVisible&&(this._incrementTotalItems(),(f=Array.prototype.slice.call(arguments,3)).unshift(this.get("url"),_.tile.key,_,a,this),r.getOrDownloadData.apply(r,f)),p}},_incrementTotalItems:function(){var e={loaded:this.get("loadInfo").loaded,total:this.get("loadInfo").total+1};this.set("loadInfo",e)},_incrementLoadedItems:function(){var e={loaded:this.get("loadInfo").loaded+1,total:this.get("loadInfo").total};this.set("loadInfo",e)},applyDTM:function(t,i){var s=t.getPDSFXUniform("dtm");if(o.is(s)){var n,a,h,d,u,c,g,f;o.is(s.value)&&(f=s.value,r.unlock(f.storeId,f.storeKey),t.updatePDSFXUniform("dtm",void 0)),g=l(this,i),f=r.getData(this.get("url"),g.key);g.key;if(o.is(f))h=i.LOD-g.LOD;else{for(n=this.get("levelMin"),a=g.LOD,u=g.I,c=g.J;!o.is(f)&&a>n;)a-=1,u>>=1,c>>=1,f=r.getData(this.get("url"),o.getQuadKey(a,u,c));h=i.LOD-a}if(o.is(f)){t.updatePDSFXUniform("dtm",f),t.updatePDSFXUniform("dtmProperties",this._dtmProperties.clone()),r.lock(f.storeId,f.storeKey),d=1<<h,u=i.I>>h,c=i.J>>h,t.updatePDSFXUniform("dtmOffset",new e.Vector4(i.I/d-u,i.J/d-c,1/d,Math.max(f.bounds.max-f.bounds.min,1))),(p=t.getPDSFXUniform("dtmAltitudes")).value.setW((f.bounds.max+f.bounds.min)/2),p.value.setY(f.bounds.min-25),t.updatePDSFXUniform("dtmAltitudes",p.value),(_=t.getPDSFXUniform("terrainDebug")).value.setZ(0),t.updatePDSFXUniform("terrainDebug",_.value)}else{var _;(_=t.getPDSFXUniform("terrainDebug")).value.setZ(1),t.updatePDSFXUniform("terrainDebug",_.value);var p,m=t.getPDSFXUniform("dtmOffset");m.value.setW(1),t.updatePDSFXUniform("dtmOffset",m.value),(p=t.getPDSFXUniform("dtmAltitudes")).value.setW(0),p.value.setY(-25),t.updatePDSFXUniform("dtmAltitudes",p.value)}t.force=!0}},getLocalPosition:function(){if(this.get("AABBox")){var t=this.get("AABBox").getCenter();return new e.Vector3(t.x,t.y,0)}},setItemParent:function(e){this._itemParent&&(this._itemParent.removeEvent("onChange:visible",this._updateVisibility),this._itemParent.removeEvent("onChange:order",this._reload)),this._parent(e),this._updateVisibility(e),this._itemParent&&(this._itemParent.addEvent("onChange:visible",this._updateVisibility,this),this._itemParent.addEvent("onChange:order",this._reload))},redraw:function(){if(this.isGeometric()){this.getRendering();s.redrawGeometricTiles(this)}},getRendering:function(){return this._rendering},_updateVisibility:function(e){e.get("visible")?s.activateTerrainSource(this.get("id")):s.deactivateTerrainSource(this.get("id"))},_reload:function(){r.deprecateAll("terrain")},setStatistics:function(e){var t=e.geoItemTypeList.GridRelief.altitude,i={maximalAltitude:t.max,minimalAltitude:t.min};this.set("statistics",i)}});return t.ObjectContructor.Terrain=d}),define("DS/XCityModel/LayerVectorCluster",["DS/Visualization/ThreeJS_DS","DS/XCityModel/LayerVectorPrimitive","DS/XCityTools/Geocoder","DS/XCityModel/Item","DS/XCityModel/View3DContextualMenuManager","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/xCityBasicUtils/Utils","DS/XCityTools/Downloader","DS/XCityCore/Store"],function(e,t,i,r,s,n,o,a,h,l,d){"use strict";var u=t.extend({defaults:{clusterInfo:null},metaData:{type:"Geometry",className:"LayerVectorCluster"},setup:function(){this._parent(),this._bboxDisplayed=!1,this._bboxNode=null},setItemParent:function(e){var t=this,i=function(e){t.setVisible(e.get("visible"))};this._itemParent&&(this._itemParent.removeEvent("onChange:visible",i),this._itemParent.removeEvent("onChange:selected",this.displayBbox.bind(this)),this._itemParent.removeEvent("onChange:hovered",this.displayBbox.bind(this))),this._parent(e),this._itemParent&&(this._itemParent.addEvent("onChange:visible",i),this._itemParent.addEvent("onChange:selected",this.displayBbox.bind(this)),this._itemParent.addEvent("onChange:hovered",this.displayBbox.bind(this)))},create:function(t){this.created=this._parent(t);var i=xCity._urbanImpl.getView3D().getControl();this.initialPOV={target:i.target,direction:i.eye,distance:i.distanceToTarget};var r=this.get("instanceId"),s=this.get("clusterInfo");if(s.rtree){var n=(r-5)/5;s.rtree._root;this._rtreeNode=s.rtree.getNodeByInstanceId(n);var o,a=this._rtreeNode.getAllLeaves(),h=[];if(this._layer._patch._uidListeners)for(var d=0;d<a.length;++d)a[d].infos&&a[d].infos.strid&&(o=this._layer._patch._uidListeners[a[d].infos.strid],h.push(o.userData),h[h.length-1].position=o.posSize.center);this.userData=h;for(var u=[],c=0;c<this._subMeshes.length;++c)this._subMeshes[c].mesh.clusterInfo&&this._subMeshes[c].mesh.clusterInfo.isLeaf||u.push(this._subMeshes[c]);this._subMeshes=u,this._leaves=a,this._localPosition.x=(this._rtreeNode.boundingBox.max.x+this._rtreeNode.boundingBox.min.x)/2,this._localPosition.y=(this._rtreeNode.boundingBox.max.y+this._rtreeNode.boundingBox.min.y)/2,this._localSphereDiameter=2*this._rtreeNode.radius,this._bMin=this._rtreeNode.boundingBox.min,this._bMax=this._rtreeNode.boundingBox.max}else{var g=this._layer.get("url");g=(g=(g=(g=(g=g.replace("%l",s.LOD)).replace("%i",s.I)).replace("%x",s.I)).replace("%j",s.J)).replace("%y",s.J);l.download(g,{responseType:"json"},999999,function(e,t,i,r){r(t,e,i)},void 0,function(e,t,i){if(t&&e.features){for(var r=e,s=[],n=0;n<r.features.length;++n)r.features[n].properties&&(s.push(r.features[n].properties),s[s.length-1].position=r.features[n].geometry.coordinates);this.userData=s}}.bind(this)),this._bMin=new e.Vector3(s.qtClusterBbox.xmin,s.qtClusterBbox.ymin,0),this._bMax=new e.Vector3(s.qtClusterBbox.xmax,s.qtClusterBbox.ymax,0)}return!0},destroy:function(){this._layer&&(Utils.is(this._layer.getItemParent())&&this._layer.getItemParent().removeEvent("onChange:selected",this._deselectParent),this._layer.unregister(this)),this._layer=void 0,this._detachToMesh(),this._subMeshes=[],this._parent()},moveToInitial:function(e){var t=this.getLocalPosition();if(t&&this._rtreeNode.parent){var i=this._rtreeNode.parent.openDistance*this._rtreeNode.instance.distanceFactor*.75;return this._rtreeNode.nHits===this._rtreeNode.parent.nHits&&this._rtreeNode.parent.parent&&(i=this._rtreeNode.parent.parent.openDistance*this._rtreeNode.instance.distanceFactor*.75),xCity._urbanImpl.getView3D().getControl().moveTo(t.clone(),{x:0,y:45,z:0},i,e)}},moveToChildren:function(e){var t=this.getLocalPosition();if(t){var i=this._rtreeNode.openDistance*this._rtreeNode.instance.distanceFactor*.75;return xCity._urbanImpl.getView3D().getControl().moveTo(t.clone(),{x:0,y:45,z:0},i,e)}},moveToParent:function(e){var t=this.getLocalPosition();if(t&&this._rtreeNode.parent&&this._rtreeNode.parent.parent){var i=this._rtreeNode.parent.parent.openDistance*this._rtreeNode.instance.distanceFactor*.75;return this._rtreeNode.parent.nHits===this._rtreeNode.parent.parent.nHits&&this._rtreeNode.parent.parent.parent&&(i=this._rtreeNode.parent.parent.parent.openDistance*this._rtreeNode.instance.distanceFactor*.75),xCity._urbanImpl.getView3D().getControl().moveTo(t.clone(),{x:0,y:45,z:0},i,e)}},displayBbox:function(){var t=this._itemParent.get("selected")||this._itemParent.get("hovered");if(t&&!this._bboxDisplayed){var i=this.convexHull();if(void 0===i)return;var r=new e.MeshLambertMaterial({color:16711680,side:e.DoubleSide,transparent:!0,opacity:.5});r.force=!0;var s=this._bMin,h=this._bMax,l=new e.Vector3;l.subVectors(h,s),l.add(h);var d=new e.Shape(i),u=new e.ShapeGeometry(d),c=new e.Mesh(u),g=n.createNodeFromTHREEMesh(c);g.setMaterial(r);var f=new o;f.addChild(g),f.setMatrix((new e.Matrix4).setPosition(new e.Vector3(0,0,100))),f.setPickable(a.NOPICKABLE),f.isAreaCluster=!0,this._layer._node.addChild(f),this._bboxNode=f,this._bboxDisplayed=!0}else!t&&this._bboxDisplayed&&(this._layer._node.removeChild(this._bboxNode),this._bboxNode=null,this._bboxDisplayed=!1)},highlight:function(){var e=d.getStore(this._layer.id);if(e){var t=this.get("clusterInfo"),i=e._invertY?(1<<t.LOD)-1-t.J:t.J,r=h.getQuadKey(t.LOD,t.I,i);e.lockData(r)}},unhighlight:function(){var e=d.getStore(this._layer.id);if(e){var t=this.get("clusterInfo"),i=e._invertY?(1<<t.LOD)-1-t.J:t.J,r=h.getQuadKey(t.LOD,t.I,i);e.unlockData(r)}},getMinimumAbscisseNode:function(e){if(e.length>0){for(var t,i=e[0].center,r=0;r<e.length;++r)(t=e[r]).center.x<i.x&&(i=t.center);return i}},getMaximumAbscisseNode:function(e){if(e.length>0){for(var t,i=e[0].center,r=0;r<e.length;++r)(t=e[r]).center.x>i.x&&(i=t.center);return i}},computeAngle:function(e,t){return e>0&&t>=0?Math.atan(t/e):e>0&&t<0?Math.atan(t/e)+2*Math.PI:e<0?Math.atan(t/e)+Math.PI:0===e&&t>0?Math.PI/2:3*Math.PI/2},findNextPoint:function(e,t,i){for(var r,s,n,o,a=void 0,h=2*Math.PI-3*Math.PI/2,l=0;l<e.length;++l)e[l].center.x==t.x&&e[l].center.y==t.y||(s=e[l].center.x-t.x,n=e[l].center.y-t.y,o=this.computeAngle(s,n),(o=2*Math.PI-o-h)<0&&(o+=2*Math.PI),(void 0===a||o<a)&&(a=o,r=e[l]));return{x:r.center.x,y:r.center.y}},computeConvexHull:function(){for(var e=this.getMinimumAbscisseNode(this._leaves),t=this.getMaximumAbscisseNode(this._leaves),i=e,r=this.findNextPoint(this._leaves,i),s=[e,r],n=0;r.x!==t.x&&r.y!==t.y&&n<50;)r=this.findNextPoint(this._leaves,r),s.push(r),n++;for(n=0;r.x!==e.x&&r.y!==e.y&&n<50;)r=this.findNextPoint(this._leaves,r,!1),s.push(r),n++;return s},orientation:function(e,t,i){var r=(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y);return 0===r?0:r>0?1:2},convexHull:function(){var e=this._leaves.length;if(!(e<3)){for(var t=[],i=0,r=1;r<e;++r)this._leaves[r].center.x<this._leaves[i].center.x&&(i=r);var s,n,o=i;do{n=this._leaves[o].center,t.push(n),s=(o+1)%e;for(r=0;r<e;++r)2===this.orientation(this._leaves[o].center,this._leaves[r].center,this._leaves[s].center)&&(s=r);o=s}while(o!==i);return t.length<3?[]:t}}});return s.addNewContextualMenu(function(e){return e.get("Content")instanceof u},[{name:"ContextualTreeview",line:1,hdr_list:["pTreeview"]},{name:"ContextualVisibility",line:1,hdr_list:["pVisibility"]},{name:"ContextualInfo",line:1,hdr_list:["pInfo"]},{name:"ContextualColor",line:1,hdr_list:["pColor"]},{name:"ContextualOpacity",line:1,hdr_list:["pOpacity"]}]),r.ObjectContructor.LayerVectorCluster=u}),define("DS/XCityModel/RdbLink",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/XCityModel/Item","DS/XCityModel/Content","DS/XCityModel/LayerVectorPrimitive","DS/XCityModel/LayerVectorCluster","DS/XCityGeometry/PatchVector","DS/XCityGeometry/PatchVectorCityFormat","DS/XCityGeometry/PatchVector3DXMFormat","DS/XCityGeometry/PatchVectorFactoryBuilding","DS/XCityGeometry/PatchVectorFactoryCrossQuad","DS/XCityGeometry/PatchVectorFactoryTree","DS/XCityGeometry/PatchVectorFactoryElement","DS/XCityGeometry/PatchVectorFactoryFile","DS/XCityGeometry/PatchVectorFactoryModel","DS/XCityGeometry/PatchVectorFactoryParticle","DS/XCityGeometry/PatchVectorFactoryPointOfInterest","DS/XCityGeometry/PatchVectorFactoryPointOfInterest3D","DS/XCityGeometry/PatchVectorFactoryMarker","DS/XCityGeometry/PatchVectorFactoryLine","DS/XCityGeometry/PatchVectorFactoryPolygon","DS/XCityGeometry/PatchVectorFactoryGeometry","DS/XCityGeometry/PatchVectorFactoryPipe","DS/xCityBasicUtils/Utils","DS/XCityLayer/VectorLoaderGML","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/VectorLoaderEnovia","DS/XCityLayer/Vector","DS/XCityCore/Store","DS/XCityTools/EventDispatcher","DS/XCityTools/RTree","DS/XCityTools/Downloader","DS/XCityTools/Disposer","DS/XCityTools/ExpressionEvaluator","DS/XCityTools/Expression","DS/xCityGlobeUtils/xCityDatasetServices","DS/WebappsUtils/WebappsUtils"],function(e,t,i,r,s,n,o,a,h,l,d,u,c,g,f,_,p,m,y,b,v,S,D,P,C,x,M,I,w,N,T,R,L,O,k,A,E){"use strict";var F=r.extend({defaults:{levelMin:0,levelMax:-1,priority:3,priorityOffset:1,cache:50,lodBias:0,AABBox:null,Clustering:null,type:"json",url:"",listenToDateUpdate:!1,upTime:"",downTime:"",invertY:!1,alternUrl:"",alternDict:[],geolocalized:!0,interactionBehaviours:{onSelect:{label:!0},onHover:{label:!0}}},metaData:{type:"LayerVector",className:"RdbLink"},loaderJSON:{Factory:"loadJSONFactory",AABBox:"loadJSONAABox",Clustering:"loadJSONClustering"},loadJSONClustering:function(e,t,i,r){i.className&&"Clustering"!==i.className||this.set(t,{enable:i.enable,nbSteps:i.nbSteps,minimumHits:i.minimumHits})},computeSteps:function(e){for(var t=[2],i=Math.log(this._nhitsTotal)/e,r=1;r<=e;++r)t.push(Math.ceil(Math.exp(r*i)));return t=[2,10,100,1e3,1e4,1e5,1e6,1e7]},setClustering:function(e){var t={enable:!(!e||!e.enable)&&e.enable,nbSteps:e&&e.nbSteps?e.nbSteps:6,minimumHits:e&&e.minimumHits?e.minimumHits:1};this.set("Clustering",t);var i=!0===t.enable;i&&!this.clusteringMode?this.create(this._root):!i&&this.clusteringMode&&this.create(this._root),t.nbSteps&&(this._clusterSteps=this.computeSteps(t.nbSteps),this._factory._clusterSteps=this._clusterSteps,this._patch&&w.traverse(this.get("id"),this._patch.rebuild.bind(this._patch),!1)),t.minimumHits&&(this._factory._minimumHits=t.minimumHits)},setup:function(){this._parent(),this._patch=void 0,this._factory=void 0,this._quadTree=void 0,this._manager=void 0,this._node=void 0,this.isLayer=!0,this.clusterlimit=1},destroy:function(e){this._manager.removeDataSource(this.get("id")),this._factory.destroy(),w.deleteStore(this.get("id")),this._parent(e)},createPrimitive:function(e,t){var i;if(this._factory&&this._factory.getGeoJSON&&(i=this._factory.getGeoJSON(e)),void 0===t&&this._factory.instancing&&this._patch&&this._patch.miDToTile[e]&&this._patch.miDToTile[e].geom&&this._patch.miDToTile[e].geom[0]){var r=this._patch.miDToTile[e].geom[0].mesh.mesh3js.userData.cgmIds;if(r)for(var n=0;n<r.length;++n)if(r[n]===e){t=5*n+5;break}}var o=new s({strid:e,geojson:i,instanceId:t});return this._patch&&this._patch.miDToTile[e]&&this._patch.miDToTile[e].indexMesh>-1&&(o.indexMesh=this._patch.miDToTile[e].indexMesh),o.setLayerVector(this),o.create(this.getRoot()),o},createCluster:function(e,t,i){var r;this._factory&&this._factory.getGeoJSON&&(r=this._factory.getGeoJSON(e));var s=new n({strid:e,geojson:r,instanceId:t,clusterInfo:i});return s.setLayerVector(this),s.create(this.getRoot()),s},loadJSONFactory:function(e,t,i,r){var s=i.className;s||(s=r.factory),"building"===(s=s.toLowerCase())?this._factory=new l(e,i):"crossquad"===s?this._factory=new d(e,i,this.get("url")):"tree"===s?this._factory=new u(e,i,this.get("url")):"element"===s?this._factory=new c(e,i,this.get("url")):"placemark"===s?this._factory=new _(e,i):"file"===s?this._factory=new g(e,i):"model"===s?this._factory=new f(e,i,this.get("type")):"pointofinterest"===s?this._factory=new p(e,i,r.cid):"pointofinterest3d"===s?this._factory=new m(e,i):"marker"===s?this._factory=new y(e,i,r.get("id")):"linestring"===s?this._factory=new b(e,i):"polygon"===s?this._factory=new v(e,i):"pipe"===s?this._factory=new D(e,i):"geometryset"===s&&(this._factory=new S(e,i)),void 0===this._factory.toJSON&&(this._factory.toJSON=function(){return i}),this._factory.setProgressCallback(this._onProgress.bind(this))},toJSON:function(e){var t=this._parent(e);return this._factory&&(t.Factory=this._factory.toJSON()),t},_createNewStore:function(){w.getStoreList().indexOf(this.get("id"))>-1&&w.deleteStore(this.previous("id"));var e={url:this.get("url"),listenToDateUpdate:this.get("listenToDateUpdate"),upTime:this.get("upTime"),downTime:this.get("downTime"),cacheSize:this.get("cache"),priority:this.get("priority")};this.clusteringMode&&(e.url=e.url.concat("&clustered=true&clusterlimit="+this.clusterlimit+"&averagecount=20")),this.isWFS&&(e.url=e.url.concat("&limit=200")),e.url.search("%xmin")>-1&&e.url.search("%xmax")>-1&&e.url.search("%ymin")>-1&&e.url.search("%ymax")>-1?e.wms={worldSize:this._root._urban.worldSize,shiftedPosition:this._root._urban.shiftedPosition}:e.tile={worldSize:this._root._urban.worldSize,shiftedPosition:this._root._urban.shiftedPosition},void 0!==this._storeOptions&&(e.dataDownloader=this._storeOptions.dataDownloader,e.dataBuilder=this._storeOptions.dataBuilder,e.dataCleaner=this._storeOptions.dataCleaner,e.invertY=this._storeOptions.invertY,e.dlOptions=this._storeOptions.dlOptions,e.onFinish=this._storeOptions.onFinish,e.resultEditor=this._storeOptions.resultEditor),this._shouldUpdateProgress()&&(e.getProgress=this._storeOptions.getProgress,e.setProgress=this._storeOptions.setProgress),w.createStore(this.get("id"),e)},requestProxyInformation:function(e){var t=this;A.getProxyInformation(e).then(function(i){if(200===i.request.status){t._factory._isReady=!0,t._attributes.userData.proxyInformation=i.data;var r="xCityTreeviewSimpleFeatures.png";if(t._attributes.userData.proxyInformation.layerInformation.inReferentialContext){var s=t._attributes.userData.proxyInformation.layerInformation.inReferentialContext.geometryTypeMap,n=0;s&&((s.Point&&s.Point>0||s.MultiPoint&&s.MultiPoint>0)&&(r="xCityTreeviewPoint.png",n++),(s.LineString&&s.LineString>0||s.MultiLineString&&s.MultiLineString>0)&&(r="xCityTreeviewLine.png",n++),(s.Polygon&&s.Polygon>0||s.MultiPolygon&&s.MultiPolygon>0)&&(r="xCityTreeviewPolygon.png",n++),n>1&&(r="xCityTreeviewSimpleFeatures.png"))}else t._attributes.userData.proxyInformation.layerInformation.inReferentialContext={featureCount:t._attributes.userData.proxyInformation.layerInformation.featureCount,geometryTypeMap:{Point:"NA",MultiPoint:"NA",LineString:"NA",MultiLineString:"NA",Polygon:"NA",MultiPolygon:"NA"}};var o=E.getWebappsAssetUrl("xCityUI","icons/TreeView/")+r;t._itemParent.userData=t._itemParent.userData||{},t._itemParent.userData.iconUrl=o;var a=t._getProgress();a&&(a.loaded+=1,a.total+=1,t._onProgress(a))}else 202===i.request.status&&(t._nbIterationWFS||(t._nbIterationWFS=0),t._nbIterationWFS<5?(t._nbIterationWFS++,window.setTimeout(t.requestProxyInformation.bind(t,e),5e3)):t._factory._isReady=!0)})},create:function(e){if(!this._parent(e))return N.publish(N.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;var i=e._urban;this._urban=i;var r=null,s=null,n=this.get("type");"json"===n?r=new x:"wfs"===n?r=new x("wfs"):"gml"===n?r=new C:"enovia"===n&&(r=new M(i)),this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null;var l=this.toJSON();if(l.previewMode="enovia"===this.get("type")||"wfs"===this.get("type"),this.isWFS="wfs"===this.get("type"),this.isWFS){this._factory._isReady=!1;var d=E.getWebappsAssetUrl("xCityUI","icons/TreeView/")+"xCityTreeviewSimpleFeatures.png";this._itemParent.userData=this._itemParent.userData||{},this._itemParent.userData.iconUrl=d,this.requestProxyInformation(this.get("objectId")),this.addEvent("onChange:levelMin",this._updateLevelMin)}if(l.Clustering&&l.Clustering.enable&&!this.isWFS){this.clusteringMode=!0,this._nhitsTotal=1e4,this._factory._isReady=!1;let e=!1;if(l.previewMode)u=(u=this.get("url").concat("&clustered=true&clusterlimit=1&averagecount=2")).replace("%l",0).replace("%x",0).replace("%y",0);else{var u=this.get("url");if(R.wasAPlatformService(u))u=R.getDataSupplierUrlFromUrl(u),e=!0;else{var c=u.indexOf("datasupplier"),g=u.indexOf("?"),f=u.slice(g),_=this.get("objectId").length;u=(u=u.slice(0,c+18+_)).concat(f),e=!0}}var b=function(e,t){if(t){var i=JSON.parse(e);if(l.previewMode)this._nhitsTotal=i.nhits;else if(i.statistics)this._nhitsTotal=i.statistics.geoItemCount;else{var r=Object.keys(i.analytics.geoItemTypeList)[0];this._nhitsTotal=i.analytics.geoItemTypeList[r].count}var s=this.get("Clustering").nbSteps||6;this._clusterSteps=this.computeSteps(s),this._factory._clusterSteps=this._clusterSteps,this._factory._nhitsTotal=this._nhitsTotal}this._factory._isReady=!0};const t="undefined"!=typeof xCity&&xCity.widgetData&&xCity.widgetData.datasetCollection,r=R.getUuidFromUrl(u);e&&t&&t.get(r)?setTimeout(b.bind(this),0,JSON.stringify(t.get(r)),!0):R.download(u,{},9999999,function(e,t,i,r){r(t,e,i)},void 0,b.bind(this)),this.setClustering(l.Clustering),!1===l.previewMode&&(s=new M(i))}else this.clusteringMode=!1;if(l.clusteringMode=this.clusteringMode,this._factory){this._node=this._factory._node,this._storeOptions=void 0;var v=this._attributes.url.split(".");if("3DXM"===n||"3DXC"===n||"3dxc"===v[v.length-1].toLowerCase()?(this._patch=new h(i,this._factory,l),this._storeOptions={dataBuilder:this._patch.build.bind(this._patch,i,this.get("geolocalized"),this._attributes.priority),dlOptions:{responseType:"arraybuffer"},invertY:this.get("invertY"),onFinish:{func:this._onFinish.bind(this),bound:this}},this._createNewStore()):"cty"===n||"city"===n?(this._patch=new a(i,this._factory,l),this._storeOptions={dataBuilder:this._patch.buildV2.bind(this._patch,r,i,this.get("geolocalized")),dlOptions:{responseType:"arraybuffer"},invertY:this.get("invertY"),onFinish:{func:this._onFinish.bind(this),bound:this}},this._createNewStore()):(this._patch=new o(i,this._factory,l),this._storeOptions={dataBuilder:this._patch.buildV2.bind(this._patch,r,s,i),invertY:this.get("invertY"),onFinish:{func:this._onFinish.bind(this),bound:this},dataCleaner:l.clusteringMode?this._dataCleaner.bind(this):void 0,resultEditor:l.clusteringMode?this._resultEditor.bind(this):void 0},this._shouldUpdateProgress()&&(this._storeOptions.setProgress=this._onProgress.bind(this),this._storeOptions.getProgress=this._getProgress.bind(this)),this._createNewStore()),this.isWFS&&l.Clustering&&l.Clustering.enable&&(this.clusteringMode=!0,this._patch.clusteringMode=this.clusteringMode,this.setClustering(l.Clustering)),this._factory.patch=this._patch,this._factory instanceof p&&(this._itemParent.addEvent("onChange:hoverable",this._factory.hoverable,this._factory),this._itemParent.addEvent("onChange:selected",this._factory.select,this._factory)),this._factory instanceof y&&this._itemParent.addEvent("onChange:selected",this._factory.select,this._factory),this._factory instanceof m&&this.clusteringMode,this._factory instanceof m&&this._factory.isBillboard()){var D=this.get("url");if(R.isAPlatformService(D)){var P=this._getDatasetBaseUrl(D),I=P.length,w=P.indexOf("resources");w>=I-10&&(P=P.slice(0,w));var T=P+"resources/",L=this._getUrlOptions(D),O={mapUrl:new k(T).add((new k).propertyName("FILENAME").add(L))};this.getRendering().addDefaultDatavizMapping(O)}}if(this._factory instanceof m&&this._factory.alwaysDisplayText){this.set("label",{enable:!0});var A={label:{name:xCity.createExpression().propertyName(this._factory.nameAttribute)}};xCity.getSessionRenderingProfile().addDatavizRendering(this.parentFeatureID,A),this._factory.alwaysDisplayText=!1}this.addEvent("onChange:url",this._createNewStore),this.loadStyle()}else{var F=this.get("type"),V=this;this._patch=new o(i,{},{});var j={extension:F,rendering:V.getRendering(),uidToPrim:{}};j.url=this.get("url"),V._node=i.modelLoader.load(j,function(e){j.patch=V._patch,V._node.addChild(e)}),this._node=new t,this._node.name="RdbLink"}return this._node.userData=this._itemParent,this._factory instanceof S&&(this._factory._factoryPoint._node.userData=this._itemParent,this._factory._factoryLine._node.userData=this._itemParent,this._factory._factoryPolygon._node.userData=this._itemParent),l.filterLevelMax=!0,l.visible=this._itemParent.get("visible"),i.USR.vqtPo.addDataSource(l,this._node),this._manager=i.USR.vqtPo,this.renderingProfileManager.initRendering(this),this._elevationRetroCompatibilty(),this._updateGeometryTags(),!0},_shouldUpdateProgress:function(){const e=["FactoryModel","Buildings"];return!(this._factory&&this._factory._node&&this._factory._node.name)||!e.includes(this._factory._node.name)},_elevationRetroCompatibilty:function(){if(P.is(this._factory)){var e,t=!1;this._factory instanceof b&&(e=this.get("elevationOffset"))!==this.getRenderingHandler().defaultRendering.get("elevationOffset")&&P.is(this._factory._initialHeightOffset)&&(e+=this._factory._initialHeightOffset+this._factory._initialHeightOffset,t=!0),this._factory instanceof v&&(e=this.get("elevationOffset"))!==this.getRenderingHandler().defaultRendering.get("elevationOffset")&&P.is(this._factory._initialHeightOffset)&&(e+=this._factory._initialHeightOffset,t=!0),t&&(this.set("elevationOffset",e),this._factory._initialHeightOffset=null,this.renderingProfileManager.updateFeatureRendering(this))}},_onFinish:function(e){N.publish(N.eventsList.onLoaded+":"+this.get("id"),{success:e,item:this.getItemParent()})},_onProgress:function(e){this.set("loadInfo",e)},_getProgress:function(e){return this.get("loadInfo")},getRenderingHandler:function(){var e=null;return P.is(this._rendering)?e=this._rendering:this._factory&&(P.is(this._factory._rendering)?e=this._factory._rendering:this._factory.getRendering&&(e=this._factory.getRendering())),e},getRendering:function(){return this.getRenderingHandler()},redraw:function(){var e=this.getRendering();!0===e.needsRebuild()?(w.traverse(this.get("id"),this._patch.rebuild.bind(this._patch),!1),e.flagAsRebuilt(!0)):w.traverse(this.get("id"),e.applyRendering.bind(e))},resetFlags:function(){var e=this.getRendering();w.traverse(this.get("id"),e.resetFlags.bind(e))},redrawPrimitive:function(e){if(P.is(this._patch)){var t=this.getRendering();P.is(t)&&(t.isPrimitiveRegistered(e)?t._renderprimitive(e):this.registerPrimitive(e))}},registerPrimitive:function(e){if(P.is(this._patch)){var t=this.getRendering();P.is(t)&&(t.isPrimitiveRegistered(e)||t.registerPrimitive(this._patch,e))}},registerPrimitives:function(e){var t,i,r=Object.keys(e),s=r.length;for(t=0;t<s;t++)i=r[t],this.registerPrimitive(i)},each:function(e,t){return e instanceof Function&&(t=e),this._patch&&this._patch.each(t),w.traverse(this.get("id"),this._patch.each.bind(this._patch,t),!1),this},filter:function(e,t){return e instanceof Function&&(t=e),this._patch&&this._patch.filter(t),w.traverse(this.get("id"),this._patch.filter.bind(this._patch,t),!1),this},reset:function(){return this._patch&&this._patch.reset(),w.traverse(this.get("id"),this._patch.reset.bind(this._patch),!1),this},register:function(e){this._patch&&this._patch.register(e.get("strid"),e.addSubElements.bind(e))},unregister:function(e){this._patch&&this._patch.unregister(e.get("strid"),e.addSubElements.bind(e))},getBoundingSphere:function(){if(this._factory instanceof m){var t=this._factory.maxMinMax;if(t){var i=new e.Vector3(this._node.bSphere.center.x,this._node.bSphere.center.y,(t.minZ+t.maxZ)/2),r=Math.sqrt(Math.pow(t.maxX-t.minX,2)+Math.pow(t.maxY-t.minY,2)+Math.pow(t.maxZ-t.minZ,2))/2;return new e.Sphere(i,r)}}return this._node.bSphere},getLocalPosition:function(){if(this.get("AABBox")){var t=this.get("AABBox").getCenter();return new e.Vector3(t.x,t.y,0)}},getSphereDiameter:function(){if(this.get("AABBox")){var e=this.get("AABBox").getSize();return Math.max(e.x,e.y)}},setFactoryAttribute:function(e,t){this._factory&&this._factory.setAttribute(e,t)&&(w.traverse(this.get("id"),this._factory.updateAttribute.bind(this._factory,e)),this.dispatchEvent("onChange:factoryAttribute:"+e,t))},setItemParent:function(e){this._itemParent&&(this._itemParent.removeEvent("onChange:visible",this._itemParentVisible),this._itemParent.removeEvent("onChange:tags",this._updateGeometryTags,this)),this._parent(e),this._itemParentVisible(e),this._itemParent&&(this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this),this._itemParent.addEvent("onChange:tags",this._updateGeometryTags,this))},_itemParentVisible:function(e){this._created&&(this._node.setVisibility(e.get("visible")),this._manager.setDataSourceAttribute(this.get("id"),"visible",e.get("visible")))},_updateGeometryTags:function(){if(void 0!==this._itemParent&&void 0!==this._node){var e=this._itemParent.get("tags");e&&-1!==e.indexOf("UNDERGROUND")?this._node.setRenderPasses(["UNDERGROUND_PREPASS","UNDERGROUND_POSTPASS"]):this._node.setRenderPasses(["main"]),N.publish("/xCity/needRender",this)}},modifier:function(e,t){var i=this;w.traverse(this.get("id"),function(t){var r,s=i._patch.getUidListeners(),n=t.userData.source,o=new I.Feature,a=i._factory.stridAttribute||"STRID";for(n.index=0;o=n.getNextFeature(o);)(r=s[o.getAttribute(a)])&&r.geom&&e(o,r)}),P.is(t)&&this._patch.each(function(e){return t(e)})},colorize:function(e){var t,i,r=this,s=this._factory,n={color:s.colorAttribute||"color",opacity:s.opacityAttribute||"opacity",id:s.stridAttribute||"STRID"},o=this.renderingProfileManager;t=function(t,i){var a,h,l=s.getDatas(i),d=l.length;for(h=0;h<d;h+=1)l[h].attributes.center=t.getCenter(),(a=e(l[h].attributes)||!1)&&o.addPrimitiveRenderingNoDraw(r.parentFeatureID,a,t.getAttribute(n.id))},i=function(t){t.attributes.center=t.getCenter();var i=e(t.attributes);return i&&o.addRendering(r.parentFeatureID,i,t.getAttribute(n.id)),t},this.modifier(t,i),this.renderingProfileManager.setRender(this.get("id"))},findPrimitivesByCriteria:function(e){var t,i,r=this._factory,s={color:r.colorAttribute||"color",opacity:r.opacityAttribute||"opacity",id:r.stridAttribute||"STRID"},n=new O(e),o={};return P.is(n)?(i=function(e){return n.apply(e)},t=function(e,t){var n=r.getDatas(t);n.length;!0===(i(e.attributes)||!1)&&(o[e.getAttribute(s.id)]=n[void 0])},this.modifier(t),o):null},search:function(e,i,r,s,n){return new Promise((s,o)=>{var a=this.get("objectId");null==e&&(e=[[{operator:"equals",attribute:"datasetUuid",value:a}]]),null==e&&(i=[]),null==r&&(r=xCity.widgetData.currentReferential.get("uuid"));var h={datamodel:"geoItemDatasetRepresentation",referentialUuid:r,filterList:e,spatialFilterList:i};n&&(h.response=n);var l=function(e,i,r){if(console.log("SEARCH REQUEST RECEIVED"),0===e.nhits){var n={nhits:e.nhits,offset:e.offset};s({primitiveList:[],info:n})}else{this.searchNode=new t,this.searchNode.name="searchNode";var o=new t;this.searchNode.addChild(o);var a=this.searchNode.removeChild.bind(this.searchNode),h=this.searchNode.addChild.bind(this.searchNode);this.searchNode.removeChild=function(e){console.log("SEARCH NODE READY"),a(e)},this.searchNode.addChild=function(t){console.log("SEARCH NODE ADDED"),h(t);for(var i=[],r=t.userData.records,n=0;n<r.length;++n)i.push(r[n].strid);var o={nhits:e.nhits,offset:e.offset};s({primitiveList:i,info:o})};var l={key:"searchRequest",value:{node:o},oldValue:[],url:void 0,tile:{LOD:0,I:1,J:0},bbox:{xmin:-9999999999.9,ymin:-9999999999.9,xmax:9999999999.9,ymax:9999999999.9},timestamp:this._timestamp,requeststamp:this._timestamp,dlOptions:this._dlOptions,callbacks:[],locks:0,deprecated:!1,isVisible:!0,tmp:!1,undeletable:!1,temporary:!0};this._storeOptions.dataBuilder(l,e),this._node.addChild(this.searchNode)}}.bind(this),d={method:"POST",type:"json",proxy:"passport",headers:{"content-type":"application/json;charset=UTF-8"},data:JSON.stringify(h),onComplete:l,onFailure:function(e,t,i){o(t)}},u=R.getDataSupplierUrl(!0)+"search?tenant="+R._platformID+"&xrequestedwith=xmlhttprequest";R.authenticatedRequest(R.resolveUrl(u),d)})},getFactory:function(){return this._factory},_dataCleaner:function(e){this._factory.disposeRtree(e.node),L.disposeV6(e)},highlight:function(){},unhighlight:function(){},_updateLevelMin:function(){this._manager.setDataSourceAttribute(this.get("id"),"levelMin",this.get("levelMin")),w.traverse(this.get("id"),this._patch.rebuild.bind(this._patch),!1)},_resultEditor:function(e,t,i){return void 0!==(e=JSON.parse(e)).cluster&&(e.hits=[],e.hits.push({}),e.hits[0].metas=[],e.hits[0].metas.push({name:"STRID",value:i.key}),e.hits[0].metas.push({name:"gdal_default_geo",value:e.cluster.center}),e.hits[0].metas.push({name:"nhits",value:e.nhits}),e.cluster.bbox&&e.hits[0].metas.push({name:"bbox",value:e.cluster.bbox}),e.cluster.radius&&e.hits[0].metas.push({name:"radius",value:e.cluster.radius}),e.cluster.magnitude&&e.hits[0].metas.push({name:"magnitude",value:e.cluster.magnitude}),e.nmatches=e.nhits,e.nhits=1,e.hits.length=1),e}});return i.ObjectContructor.LayerVector=i.ObjectContructor.RdbLink=F}),define("DS/XCityModel/Feature",["DS/XCityModel/Item","DS/XCityTools/Debug"],function(e,t){"use strict";var i=e.extend({defaults:{name:"",description:"",tags:[],visible:!0,selectable:!0,selected:!1,hoverable:!1,hovered:!1,PointOfView:null,Content:null,Credits:null,loadInfo:{loaded:1,total:1}},metaData:{type:"Feature",className:"Feature"},setup:function(){this._parent();var e=this;this.addEvent("onChange:PointOfView",this._setupSubElementsOrder.bind(this)),this.addEvent("onChange:Content",this._setupSubElementsOrder.bind(this)),this.addEvent("onChange:Content",function(){this.get("Content").addEvent("onChange:loadInfo",function(){e._updateLoadInfo()})}.bind(this)),this.addEvent("onChange:tags",function(){var e=this.get("tags");this.dispatchEvent("onAdded:tag",e);var t,i=this.previousAttributes().tags.length;for(t=0;t<i;++t)-1===e.indexOf(this.previousAttributes().tags[t])&&this.removeTag(this.previousAttributes().tags[t]);this.addTags(e)}.bind(this)),this.addEvent("onChange:hoverable",this.setPrepicking,this),this.addEvent("onChange:visible",function(e,t){var i=e.getRoot();Utils.is(i)&&Utils.is(e.getContent())&&Utils.is(e.getContent()._getStrid)&&i._urban.labelManager.onChangeVisibilityPrimitive(e,t)})},_setupSubElementsOrder:function(){var e=0;void 0!==this.get("PointOfView")&&null!==this.get("PointOfView")&&(this.get("PointOfView")._order=e,e++),void 0!==this.get("Content")&&null!==this.get("Content")&&(this.get("Content")._order=e,e++)},setPrepicking:function(){var e=this.get("hoverable"),t=this.getRoot();void 0!==t&&t._urban.getView3D().getPicker().setPrepicking(e)},setVisible:function(e){return this.set("visible",e),this},show:function(){return this.set("visible",!0),this},hide:function(){return this.set("visible",!1),this},select:function(e){return this.set("selected",e),this},getContent:function(){return this.get("Content")},setContent:function(e){return this.set("Content",e)},findTags:function(e){var t,i,r=!0,s=this.get("tags");if(e instanceof Array)for(i=e.length,t=0;t<i;++t)r&=-1!==s.indexOf(e[t].toUpperCase());else r&=-1!==s.indexOf(e.toUpperCase());return r},addTags:function(e){var t,i=e.length;for(t=0;t<i;++t)this.addTag(e[t])},addTag:function(e){var t=this.get("tags").slice(0),i=e.toUpperCase(),r=t.indexOf(i);-1===r&&(i!==e&&-1!==(r=t.indexOf(e))?t[r]=i:t.push(i),this.set("tags",t),this.dispatchEvent("onAdded:tag",e))},removeTags:function(){var e,t=this.get("tags").slice(0),i=t.length;for(e=0;e<i;++e)this.removeTag(t[e])},removeTag:function(e){var t=this.get("tags").slice(0),i=e.toUpperCase(),r=t.indexOf(i);-1!==r&&(t.splice(r,1),this.set("tags",t),this.dispatchEvent("onRemoved:tag",e))},reload:function(e){var t;t=Utils.is(e)?"string"==typeof e?JSON.parse(e):e:this.getContent().toJSON(!0);var i=this.getRoot();return void 0!==i?(this.loadJSON(i._urban,{Content:t}),t):null},set:function(e,t,i){this._parent(e,t,i),this.getContent()&&this.getContent().created&&"selected"!==e&&"hovered"!==e&&"Content"!==e&&(this.temporary=!1)},isIndexablePrimitive:function(){return this._isLayerVectorPrimitive()&&this._hasRdbLinkParentFolder()},_isLayerVectorPrimitive:function(){return Utils.is(this.getContent())&&"LayerVectorPrimitive"===this.getContent().metaData.className},_hasRdbLinkParentFolder:function(){return Utils.is(this.getContent()._layer)&&Utils.is(this.getContent()._layer.getItemParent())&&"Folder"===this.getContent()._layer.getItemParent().metaData.className},_updateLoadInfo:function(){var e=this.get("Content");if(Utils.is(e)){var t=e.get("loadInfo");this.set("loadInfo",t)}}});return e.ObjectContructor.Feature=i}),define("DS/XCityModel/ParallelFeatBuildingAPI",["UWA/Class","DS/WebappsUtils/WebappsUtils","DS/XCityLayer/VectorLoaderJSON","DS/XCityModel/WebWorkerPool","DS/XCityGeometry/Line","DS/XCityTools/Debug"],function(e,t,i,r,s,n){"use strict";return e.extend({init:function(e,t){this.urban=e,this.isBuildingFeatureSet=!1,this.sessionBuffer=[],this.promiseBuffer=[],this.pendingSessionToSend=0,this.indexSessionToSend=0,this.nbFeatPerNode,this.nbNode,this.useDynamicManagement=t,this.polygonSetWorker=e.urban.polygonSetWorker,this.lineSetWorker=e.urban.lineSetWorker},lock:function(e,t){switch(this.featureType=e,e){case"polygon":return this.polygonSetWorker.lock(t);case"line":return this.lineSetWorker.lock(t);case"default":return n.error("Feature of type ["+e+"] not handled"),null}},abort:function(e,t){this.featureType=e;let i={},r=new Promise((e,t)=>{i.resolve=e,i.reject=t});switch(e){case"polygon":return this.polygonSetWorker.abort(t).then(e=>{this._reset(),i.resolve(e)},e=>{i.reject(e)}),r;case"line":return this.lineSetWorker.abort(t).then(e=>{this._reset(),i.resolve(e)},e=>{i.reject(e)}),r;case"default":return n.error("Feature of type ["+e+"] not handled"),null}},_reset:function(){switch(this.isBuildingFeatureSet=!1,this.sessionBuffer=[],this.promiseBuffer=[],this.pendingSessionToSend=0,this.indexSessionToSend=0,this.featureType){case"polygon":this.polygonSetWorker.unlock();break;case"line":this.lineSetWorker.unlock();break;case"default":n.error("Feature of type ["+featureType+"] not handled")}},setPerfHook:function(e){this.currentWorkerPoolPerfHook=e},_createWorkerPool:function(e,t,i){return e?n.log("Returning already instantiated pool, close this pool to create a new one with different parameters"):this.useDynamicManagement?(e=new r(i,null,!0)).setPerfHook(this.currentWorkerPoolPerfHook):e=new r(i,t,!1),e},_assignFeaturesTasks(e,t,i){this.indexSessionToSend=0;let r=t.count;if(this.nbNode=e.nbNode,0===this.nbNode)this._reset();else for(let s=0;s<this.nbNode;s++){let n=s*e.nbFeatPerNode,o=s===this.nbNode-1?Math.min(e.nbFeatureMax,r):(s+1)*e.nbFeatPerNode,a={features:t.list.slice(n,o)},h={};h.features=a,h.indexSession=s,Object.assign(h,e),this._submitTask(h,i)}},_submitTask:function(e,t){switch(t){case"polygon":this.polygonSetWorker.submit(e).then(e=>this.addSessiontoBuffer(e));break;case"line":this.lineSetWorker.submit(e).then(e=>this.addSessiontoBuffer(e));break;default:n.error("Feature of type ["+t+"] has no associated worker pool")}},buildPolygonSet:function(e){n.log("Parallel building of a polygon set in progress");let t={};t.loaderType=this.get("type"),t.nbFeatPerNode=this.nbFeatPerNode,t.nbNode=this.nbNode,t.isPickable=!0,t.urbanBaseProjection=this.urban.baseProjection,t.refBbox=this.urban.baseReferential.bbox,t.factoryStridAttribute=this.get("stridAttribute"),t.infoStrid=this.get("id"),t.useNormalMap=this.urban.useNormalMap,t.useSpecularMap=this.urban.useSpecularMap,t.elevationMode=this.get("elevationMode"),t.elevation=this.get("elevation"),t.elevationOffset=this.get("elevationOffset"),t.slabAltitude=this.urban.slabAltitude,t.precomputedZValues=this.precomputedZValues,t.preloadedUrbanProj=this.preloadedUrbanProj,t.preloadedInputCRS=this.preloadedInputCRS,t.fromGeometrySet=this.fromGeometrySet,t.inputCRS=this._inputCRS,t.nbFeatureMax=this.nbFeatureMax;let i=["elevation","elevationOffset","precomputedZValues"];for(let e in t)if(void 0===t[e]&&!i.includes(e))return void n.error(`A required parameter is undefined for the polygon set parallel building: [${e}]`);if(!e)return void n.error("The data source content is undefined for the polygon set parallel building");t.roofObjects=this.urban.url.getArgument("roofObjects")?parseFloat(this.urban.url.getArgument("roofObjects").value):void 0,t.defaultRendering=this._rendering.getDefaultRendering(),t.proj4Projection=this.urban.proj4Projection,t.magnitude=this.get("magnitude");let r=this.getRendering().currentRendering.toJSON();t.datavizRenderings=r.DatavizRendering,t.datavizRenderings&&(t.datavizRenderings.length=this.getRendering().currentRendering.getDatavizIds().length),t.primitiveRenderings=r.ElementRendering,t.currentRenderingData=this._rendering.currentRendering.renderingData,t.defaultRenderingData=this._rendering.defaultRendering.renderingData,this.parallelBuilder._assignFeaturesTasks(t,e,"polygon")},buildLineSet:function(e){n.log("Parallel building of a line set in progress");let t={};t.loaderType=this.get("type"),t.nbFeatPerNode=this.nbFeatPerNode,t.nbNode=this.nbNode,t.factoryStridAttribute=this.get("stridAttribute"),t.infoStrid=this.get("id"),t.nbInfoPix=Object.keys(s.BUFFER_IMAGE).length,t.refBbox=this.urban.baseReferential.bbox,t.urbanBaseProjection=this.urban.baseProjection,t.camPos=this.urban.getViewpoint().getPosition(),t.elevationMode=this.get("elevationMode"),t.elevation=this.get("elevation"),t.elevationOffset=this.get("elevationOffset"),t.slabAltitude=this.urban.slabAltitude,t.precomputedZValues=this.precomputedZValues,t.preloadedUrbanProj=this.preloadedUrbanProj,t.preloadedInputCRS=this.preloadedInputCRS,t.fromGeometrySet=this.fromGeometrySet,t.inputCRS=this._inputCRS,t.nbFeatureMax=this.nbFeatureMax;let i=["elevation","elevationOffset","precomputedZValues"];for(let e in t)if(void 0===t[e]&&!i.includes(e))return void n.error(`A required parameter is undefined for the line set parallel building: [${e}]`);if(!e)return void n.error("The data source content is undefined for the line set parallel building");let r=this.getRendering().currentRendering.toJSON();t.datavizRenderings=r.DatavizRendering,t.datavizRenderings&&(t.datavizRenderings.length=this.getRendering().currentRendering.getDatavizIds().length),t.primitiveRenderings=r.ElementRendering,t.currentRenderingData=this._rendering.currentRendering.renderingData,t.defaultRenderingData=this._rendering.defaultRendering.renderingData,this.parallelBuilder._assignFeaturesTasks(t,e,"line")},next:function(){n.log(`Session number ${this.indexSessionToSend} is being asked`);let e={},t=new Promise((t,i)=>{e.resolve=t});return this.promiseBuffer[this.indexSessionToSend]=e,this.pendingSessionToSend++,this.sendBufferSession(),t},addSessiontoBuffer:function(e){n.log(`Receiving session number ${e.indexNodeReady}`),this.sessionBuffer[e.indexNodeReady]=e,this.pendingSessionToSend>0&&this.sendBufferSession()},sendBufferSession:function(){if(this.sessionBuffer[this.indexSessionToSend]&&this.pendingSessionToSend>0){n.log(`Sending session number ${this.indexSessionToSend}`);let e=this.sessionBuffer[this.indexSessionToSend];delete this.sessionBuffer[this.indexSessionToSend],this.promiseBuffer[this.indexSessionToSend].resolve(e),delete this.promiseBuffer[this.indexSessionToSend],this.pendingSessionToSend--,this.indexSessionToSend++,this.nbNode===this.indexSessionToSend&&this._reset()}},close:function(){}})}),define("DS/XCityModel/AbstractSet",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityModel/Item","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/VectorLoaderEnovia","DS/XCityLayer/Vector","DS/xCityBasicUtils/Utils","DS/XCityModel/LayerVectorPrimitive","DS/XCityTools/EventDispatcher","DS/XCityTools/Geocoder","DS/XCityTools/Downloader","DS/XCityTools/ExpressionEvaluator","DS/XCityTools/Disposer","DS/XCityModel/ParallelFeatBuildingAPI","DS/XCityLayer/VectorLoaderGML"],function(e,t,i,r,s,n,o,a,h,l,d,u,c,g,f,_){"use strict";var p=r.extend({defaults:{url:"",geojson:null,type:"json",Coordinate:null,renderID:"",Rendering:null,objectId:"",serviceId:"",stridAttribute:"STRID",interactionBehaviours:{onSelect:{label:!0},onHover:{label:!0}}},setup:function(){this._parent(),this._node=new t,this.loaderJSON||(this.loaderJSON={}),this.heightMatrix=new e.Matrix4,this.nbOutside=0,this.nbInside=0,this.nbError=0,this.oversized=!1,this.isBuilt=!1,this.nbInputFeature=0,this.oldPrimInfos={}},destroy:function(e){if(this.primInfos=null,this._data=null,this._patch)for(var t in this._patch._uidListeners)delete this._patch._uidListeners[t];this._factory&&(this._factory.destroy(),this._factory=null),delete this._patch,e.getNode3D().remove(this._node),g.disposeV6(this._node),this._parent(e)},rebuild:async function(){if(this.oldPrimInfos=Object.assign({},this.primInfos),!this.isBuilt&&this.parallelBuilder){await this.parallelBuilder.lock(this._geometrySTRIDName,this),this.isAborting=!0,await this.parallelBuilder.abort(this._geometrySTRIDName,this);const e=function(){this.isAborting=!1,this.isBuilt=!1,this._createAbstractSet(this._data,!0)}.bind(this);setTimeout(e,1e3)}else this.isBuilt=!1,this._createAbstractSet(this._data,!0)},_shouldUseWebWorkers:function(e){if(!this._builderWorker)return!1;return!(e<1e4&&!this.urban.forceWebWorkers)&&(this.parallelBuilder||(this.parallelBuilder=new f(this,!1)),!0)},_shouldUseSorterWorkers:function(e){return this.urban.featureSorterWorkerSem&&!this._isDataSorted&&e>this.nbFeatPerNode},_terminate:function(){this.isBuilt=!0,l.publish(l.eventsList.onUpdate+":"+this.get("id"),{loaded:this.nbNodeBeforeCleaning+1+1+1,total:this.nbNodeBeforeCleaning+3}),l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})},_processMultiTypeGeometry:function(e,t,i){return!1},_processSimpleTypeGeometry:function(e,t,i){return!1},_handleOnNextBatchReady:function(e,t){},_createAbstractSet:function(r,h){if(this.nbGeometry=0,this.nbMultiGeometry=0,!1===h)return this.isBuilt=!0,void l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()});var u,c;r instanceof ArrayBuffer&&(this.geojsonArrayBuffer=r.slice(0),r=(new TextDecoder).decode(r)),this._data=r;var g=this.get("type");if("json"===g?u=new s:"gml"===g?u=new _:"enovia"===g&&(u=new n(this.urban)),this._savedDatasource?(c=this._savedDatasource).index=0:(c=u.loadDataSourceFromObject("string"==typeof r?JSON.parse(r):r),this._savedDatasource=c),this._inputCRS)p=this._inputCRS;else{var f,p=(f="string"==typeof r?JSON.parse(r):r).crs&&f.crs.properties&&f.crs.properties.name?f.crs.properties.name:"WGS84";if(-1===p.indexOf("AUTHORITY")){var m=p.indexOf("EPSG"),y=p.indexOf("CRS84");m>0?p=p.slice(m):y>0&&(p="WGS84"),p=p.replace("::",":")}this._inputCRS=p}if(this.nbOutside=0,this.nbInside=0,this.nbError=0,this.primInfos={},this._shouldUseSorterWorkers(c.count)){let e=function(e){e.worker.onmessage=(t=>{if(this._sortedFeaturesIndexes=Array.from(new Int32Array(t.data.sortedFeaturesIndexesBuffer)),this._precomputedNbFeatures=t.data.geometriesCount[this._geometryName]+t.data.geometriesCount[this._multiGeometryName],e.release(),0===this._precomputedNbFeatures)return this.nbNodeBeforeCleaning=0,this._terminate();this._createAbstractSet(r,!0)});let t=!1,i=!1;r.shpContent&&(t=!0),r.dbfContent&&(i=!0);let s=t&&i;if(this.geojsonArrayBuffer||s||(this.geojsonArrayBuffer=(new TextEncoder).encode(JSON.stringify(r)).buffer),s){let t={geometries:[this._geometryVectorMultiType,this._geometryVectorType],dbf:r.dbfContent.slice(0),shp:r.shpContent.slice(0)};e.worker.postMessage(t,[t.dbf,t.shp])}else{let t={geometries:[this._geometryVectorMultiType,this._geometryVectorType],geojson:this.geojsonArrayBuffer};e.worker.postMessage(t,[t.geojson])}this._isDataSorted=!0}.bind(this);return void this.urban.featureSorterWorkerSem.requestWorker().then(t=>e(t))}if(this._sortedFeaturesIndexes&&!1!==this._shouldSorterDatasource){let e=[];for(let t=0;t<this._sortedFeaturesIndexes.length;t++)e.push(c.list[this._sortedFeaturesIndexes[t]]);c.list=e,c.count=c.list.length,this._shouldSorterDatasource=!1}var b=c.count;this.nbInputFeature=b;var v=!1;this._shouldUseWebWorkers(b)&&(v=!0);var S=new o.Feature;this.nbFeatureMax=xCity._urbanImpl.USR.getProfilePerformance().getValue(this._maxGeometryPreview),b=Math.min(b,this.nbFeatureMax),this._precomputedNbFeatures&&(this._precomputedNbFeatures=Math.min(this._precomputedNbFeatures,this.nbFeatureMax)),this.oversized=!1,this.nbInputFeature>b&&(this.oversized=!0);var D=this.nbFeatPerNode;this.nbNode=Math.ceil(b/D),this.nbNodeBeforeCleaning=this.nbNode;var P=[];l.publish(l.eventsList.onUpdate+":"+this.get("id"),{loaded:1,total:this.nbNode+3});for(let e=0;e<this.nbNode;++e)P[e]={tile:{LOD:0,I:0,J:0},infos:{},ltileGeoms:{}};var C=[];p!==this.urban.baseProjection&&d.loadProjection(p);var x=[];if(this._nodes=new t,this._node.addChild(this._nodes),this._node.userData=this._itemParent,this._factory._node.userData=this._itemParent,0===b)return this.isBuilt=!0,this.oversized=!1,void l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()});this._patch={register:function(t,i){var r=this.primInfos[t];r?(r.listeners?r.listeners.push(i):r.listeners=[i],r.tile&&i(r)):this.primInfos[t]={listeners:[i],strid:t,tile:{LOD:0,I:0,J:0},posSize:{center:new e.Vector3,altitude:0,height:0,width:0,length:0},userData:{}}}.bind(this),unregister:function(e,t){var i=this.primInfos[e];if(i&&i.listeners){for(var r=-1,s=0;s<i.listeners.length;++s)if(i.listeners[s].name===t.name){r=s;break}r>-1&&i.listeners.splice(r,1)}}.bind(this),previewMode:!0,_uidListeners:this.primInfos};var M=function(){if(!this.isAborting){var e=x.shift(),t=e.indexSession;if(!Number.isFinite(t))return this._terminate();if(0!==e.nbInsideSession&&(this._nodes.addChild(this._factory.getData(P[t])),Object.assign(this.primInfos,P[t].infos)),l.publish(l.eventsList.onUpdate+":"+this.get("id"),{loaded:t+1+1,total:this.nbNode+3}),t===this.nbNode-1){var r=performance.now(),s=function(e){if(e instanceof i&&!0===e.pickable){e.show();var t,s,n,o=e.getPrimitives();if(!1===e.isInstanceNode3D)for(t=0;t<o.length;t++){let i=(s=o[t].sgNode).getCgmId();for(let t=0;t<this.nbNode;++t)if(n=P[t].infos[i]){n.geom?n.geom.push({subElement:s,mesh:e}):n.geom=[{subElement:s,mesh:e}];var h=this.oldPrimInfos[i];if(a.is(h&&h.listeners)&&(n.listeners=h.listeners),n.listeners&&n.listeners.length>0)for(let e=0;e<n.listeners.length;++e){(0,n.listeners[e])(n)}}}}r=performance.now()}.bind(this);const e=function(){const t=Math.min(200*this.nbNode,2e3);if(!(performance.now()-r>t))return setTimeout(e,200);this._nodes.children.map(e=>{let t=e;return t.userData={records:C},t}),this._terminate()}.bind(this);this._nodes.traverse(function(e){a.requestIdleCallback(()=>s(e))}.bind(this)),e()}if(v){var n=function(){this.isAborting||(function(){this.nbGeometrySession=0,this.nbMultiGeometrySession=0}.bind(this)(),this.parallelBuilder.next().then(e=>this.onNextBatchReadyCallback(e)))}.bind(this);t!==this.nbNode-1?l.subscribeTo("/3DEXPERIENCity/onPostUpdate",n,!0):(this.nbGeometrySession=0,this.nbMultiGeometrySession=0),N=!1}}}.bind(this),I=0;this.nbBuiltTotal=0;var w=function(){for(var t=0,i=!1,r=I;r<b;++r){if(50===t){I=r,l.subscribeTo("/3DEXPERIENCity/onPostUpdate",w,!0);break}r===b-1&&(i=!0),c.getNextFeature(S);var s=S.getGeometry(),n=!0,o=this.urban.baseReferential.bbox;if(s&&s.type===this._geometryVectorMultiType)n=this._processMultiTypeGeometry(s,p,o);else{if(!s||s.type!==this._geometryVectorType){this.nbError++;continue}n=this._processSimpleTypeGeometry(s,p,o)}if(n)this.nbOutside++;else{this.nbInside++,this.nbInsideSession++;var a={listeners:null,strid:S.getAttribute(this._factory.stridAttribute),tile:{LOD:0,I:0,J:0},posSize:{center:new e.Vector3,altitude:0,height:0,width:0,length:0},userData:{}};if(void 0!==a.strid&&null!==a.strid||(this.fromGeometrySet?a.strid=this.get("id")+"_"+(this.nbGeometry+this.nbMultiGeometry):a.strid=this.get("id")+"_"+this._geometrySTRIDName+"_"+(this.nbGeometry+this.nbMultiGeometry),S.attributes[this._factory.stridAttribute]=a.strid),s){var h,d;for(d=(h=S.getAttributeKeys()).length;d--;)a.userData[h[d]]=S.getAttribute(h[d]);C.push(a);var u=Math.floor(this.nbBuiltTotal/D);P[u].infos[a.strid]=a,this._factory.buildOne(S,P[u],a),(r+1)%this.nbFeatPerNode==0&&(x.push({indexSession:u,nbInsideSession:this.nbInsideSession}),this.nbInsideSession=0,l.subscribeTo("/3DEXPERIENCity/onPostUpdate",M,!0))}t++,this.nbBuiltTotal++}}i&&(this.nbNode-1!==u&&(this.nbNode=Math.max(1,u-1)),u=this.nbNode-1,x.push({indexSession:u,nbInsideSession:this.nbInsideSession}),this.nbInsideSession=0,l.subscribeTo("/3DEXPERIENCity/onPostUpdate",M,!0))}.bind(this),N=!1,T=-1;let R=0;var L=function(){if(!this.isAborting){-1===T&&(T=performance.now());for(var t=!1,i=I;i<b;++i){if(N){I=i;break}if(performance.now()-T>10){T=-1,I=i,l.subscribeTo("/3DEXPERIENCity/onPostUpdate",L,!0);break}i===b-1&&(t=!0),c.getNextFeature(S);var r=S.getGeometry(),s=!0,n=this.urban.baseReferential.bbox;if(r&&r.type===this._geometryVectorMultiType)s=this._processMultiTypeGeometry(r,p,n);else{if(!r||r.type!==this._geometryVectorType){this.nbError++,(i+1)%this.nbFeatPerNode==0&&(x.push({indexSession:R,nbInsideSession:this.nbInsideSession}),this.nbInsideSession=0,l.subscribeTo("/3DEXPERIENCity/onPostUpdate",M,!0),N=!0);continue}s=this._processSimpleTypeGeometry(r,p,n)}if(s)this.nbOutside++,(i+1)%this.nbFeatPerNode==0&&(x.push({indexSession:R,nbInsideSession:this.nbInsideSession}),this.nbInsideSession=0,l.subscribeTo("/3DEXPERIENCity/onPostUpdate",M,!0),N=!0);else{this.nbInside++,this.nbInsideSession++;var o={strid:S.getAttribute(this._factory.stridAttribute),tile:{LOD:0,I:0,J:0},posSize:{center:new e.Vector3,altitude:0,height:0,width:0,length:0},userData:{}};if(void 0!==o.strid&&null!==o.strid||(this.fromGeometrySet?o.strid=this.get("id")+"_"+(this.nbMultiGeometrySession+this.nbGeometrySession)+"_"+this.receivedSessionId:o.strid=this.get("id")+"_"+this._geometrySTRIDName+"_"+(this.nbMultiGeometrySession+this.nbGeometrySession)+"_"+this.receivedSessionId,S.attributes[this._factory.stridAttribute]=o.strid),r){var a,h;for(h=(a=S.getAttributeKeys()).length;h--;)o.userData[a[h]]=S.getAttribute(a[h]);C.push(o),R=this.receivedSessionId,P[R].infos[o.strid]=o,P[R][this._webWorkersDataName]=this.webWorkersData,this._factory.buildOne(S,P[R],o)}(i+1)%this.nbFeatPerNode==0&&(x.push({indexSession:R,nbInsideSession:this.nbInsideSession}),this.nbInsideSession=0,l.subscribeTo("/3DEXPERIENCity/onPostUpdate",M,!0),N=!0),0,this.nbBuiltTotal++}}t&&(this.parallelBuilder.close(),this.nbNode-1!==R&&(this.nbNode=Math.max(1,R-1)),R=this.nbNode-1,x.push({indexSession:R,nbInsideSession:this.nbInsideSession}),this.nbInsideSession=0,l.subscribeTo("/3DEXPERIENCity/onPostUpdate",M,!0))}}.bind(this);if(this.onNextBatchReadyCallback=function(e){this.isAborting||(this.webWorkersData=e,this.receivedSessionId=this.webWorkersData.indexNodeReady,e.empty||!0===e.empty||this._handleOnNextBatchReady(e,P),l.subscribeTo("/3DEXPERIENCity/onPostUpdate",L,!0))}.bind(this),v)Promise.all(this._prepareDataForWorkers(r)).then(()=>{this.parallelBuilder.lock(this._geometrySTRIDName,this).then(()=>{this.isAborting||(this.parallelBuilder[this._parallelBuilderFunName].call(this,c),this.parallelBuilder.next().then(e=>this.onNextBatchReadyCallback(e)))})});else{var O=function(){void 0===d.projections[p]||1!==d.projections[p].ready?l.subscribeTo("/3DEXPERIENCity/onPostUpdate",O,!0):l.subscribeTo("/3DEXPERIENCity/onPostUpdate",w,!0)}.bind(this);l.subscribeTo("/3DEXPERIENCity/onPostUpdate",O,!0)}},create:function(e){if(!this._parent(e))return l.publish(l.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;this.urban=e._urban,this.renderingProfileManager=this.urban.getRenderingProfileManager(),this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this._node.userData=this._itemParent,this._itemParentVisible(this._itemParent),e.getNode3D().add(this._node),this._isDataSorted=!1,this.fromGeometrySet=!1,this._itemParent.get("Content")._poiSet&&this._itemParent.get("Content")._lineSet&&this._itemParent.get("Content")._polygonSet&&(this.fromGeometrySet=!0),this._updateCoordinate(),this.nbGeometry=0,this.nbMultiGeometry=0,this.nbGeometrySession=0,this.nbMultiGeometrySession=0,this.nbInsideSession=0,this.nbFeatPerNode=1e3,this._rendering=this._factory._rendering,this._rendering.defaultRendering.addOver({renderMode:"overlay"}),this.renderingProfileManager.initRendering(this);var t=this,i=this.get("serviceId");if(void 0!==this.get("objectId")&&""!==this.get("objectId")&&void 0!==i&&""!==i)"3DSpace"===i?u.downloadFrom3DSpace(this.get("objectId")).then(function(e){t._createAbstractSet(e,!0)}):"3DDrive"===i&&u.downloadFrom3DDrive(this.get("objectId")).then(function(e){t._createAbstractSet(e,!0)});else if(""!==this.get("url")){var r=this.get("url");u.download(r,{type:"arraybuffer"},99999,function(e,t,i,r){r(t,e,i)},void 0,t._createAbstractSet.bind(this))}else null!==this.get("geojson")&&this._createAbstractSet(this.get("geojson"),!0);return l.publish(l.eventsList.onUpdate+":"+this.get("id"),{loaded:0,total:3}),!0},get:function(e){var t,i,r=this.getRendering();return this.renderingProfileManager&&a.is(r)&&r.hasAttribute(e)?(i=this.getMaterial(),a.is(i)&&(t=i[e])):t=this._parent(e),t},set:function(e,t){var i={},r=this.getRendering();this.renderingProfileManager&&a.is(r)&&r.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t)},getMaterial:function(){var e=this.getRendering();return a.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)},getLocalPosition:function(){var e=this._node.getBoundingSphere().center;return this.get("Coordinate")&&e.add(this.get("Coordinate").getLocalPosition()),e},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},getBoundingSphere:function(){if(this._localPosition&&this._node){if(a.is(this._factory)&&a.is(this._factory.rtrees)){var t={minX:this._factory.rtrees[0]._root.boundingBox.min.x,minY:this._factory.rtrees[0]._root.boundingBox.min.y,minZ:this._factory.rtrees[0]._root.boundingBox.min.z,maxX:this._factory.rtrees[0]._root.boundingBox.max.x,maxY:this._factory.rtrees[0]._root.boundingBox.max.y,maxZ:this._factory.rtrees[0]._root.boundingBox.max.z},i=this._localPosition;i.z=this._node.bSphere.center.z;var r=Math.sqrt(Math.pow(t.maxX-t.minX,2)+Math.pow(t.maxY-t.minY,2)+Math.pow(t.maxZ-t.minZ,2))/2;return new e.Sphere(i,r)}return this._node.getBoundingSphere()}},_shouldCreateLabelFromMaterial:function(e){return e.label&&!0===e.label.enable&&a.is(e.label.name)&&""!==e.label.name},_updateCoordinate:function(){var e=this.previous("Coordinate");e&&e.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")?(this.get("Coordinate").setItemParent(this),this._updateMatrix(this.get("Coordinate")._matrix),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this)):this._updateMatrix()},_itemParentVisible:function(e){this._created&&this._node.setVisibility(e.get("visible"))},setItemParent:function(e){this._itemParent&&this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._itemParent=e,this._itemParent&&this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this)},_updateMatrix:function(e){this._node.setMatrix(e)},_setVisible:function(e){var t=!!e.get("visible");this._nodes&&(t?this._node.addChild(this._nodes):this._node.removeChild(this._nodes))},createPrimitive:function(e,t){var i;this._factory&&this._factory.getGeoJSON&&(i=this._factory.getGeoJSON(e));var r=new h({strid:e,geojson:i,instanceId:t});return r.setLayerVector(this),r.create(this.getRoot()),r.addSubElements(this.primInfos[e]),r},register:function(e){},unregister:function(e){},redrawPrimitive:function(e){if(a.is(this._patch)){var t=this.getRendering();a.is(t)&&(t.isPrimitiveRegistered(e)?t._renderprimitive(e):this.registerPrimitive(e))}},registerPrimitive:function(e){if(a.is(this._patch)){var t=this.getRendering();a.is(t)&&(t.isPrimitiveRegistered(e)||t.registerPrimitive(this._patch,e))}},registerPrimitives:function(e){var t,i,r=Object.keys(e),s=r.length;for(t=0;t<s;t++)i=r[t],this.registerPrimitive(i)},addUserDataProperty:function(e,t,i){if(a.is(e)){var r=this.get("geojson"),s=r.features[0];if(a.is(i))for(var n=0;n<r.features.length;n++){var o=r.features[n];if(o&&o.properties&&o.properties.STRID===i){s=o;break}}s.properties||(s.properties={}),s.properties[e]=t;var h=this.get("userData");return h||(h={},this.set("userData",h)),h[e]=t,!0}return!1},removeUserDataProperty:function(e,t){if(a.is(e)){var i=this.get("geojson"),r=i.features[0];if(a.is(t))for(var s=0;s<i.features.length;s++){var n=i.features[s];if(n&&n.properties&&n.properties.STRID===t){r=n;break}}a.is(r.properties[e])&&delete r.properties[e];var o=this.get("userData");return a.is(o[e])&&delete o[e],!0}return!1},redraw:function(){var e=this.getRendering();if(a.is(e)){if(e._needRebuild&&this._node.children.length>0&&this._node.children[0].children.length>0&&(g.disposeV6(this._node),this.rebuild()),this._nodes)for(var t=0;t<this._nodes.children.length;++t)e.applyRendering(this._nodes.children[t]);e._needRebuild=!1}},getRendering:function(){return this._rendering},findPrimitivesByCriteria:function(e){var t=new c(e),i={};if(!a.is(t))return null;var r;for(var s in this.primInfos){var n=this.primInfos[s].userData;!0===(r=n,t.apply(r)||!1)&&(i[s]=n)}return i},getTransformedGeoJSON:function(){var t=this.get("Coordinate"),i=this.get("geojson");if(!a.is(t))return i;var r=t.getMatrix();if(r.isIdentity())return i;for(var s=i.features[0].geometry.coordinates[0],n=[],o=0;o<s.length;o++){var h=new e.Vector3(s[o][0],s[o][1],s[o][2]);h.applyMatrix4(r),n.push(h.toArray())}var l=a.clone(i);return l.features[0].geometry.coordinates[0]=n,l}});return r.ObjectContructor.AbstractSet=p}),define("DS/XCityModel/Folder",["DS/XCityModel/Feature","UWA/Core","UWA/Class/Collection","DS/XCityModel/Item","DS/xCityBasicUtils/LoadingProgressList"],function(e,t,i,r,s){"use strict";var n=i.extend({model:e}),o=e.extend({defaults:t.merge({children:null,exclusive:!1,opened:!0},e.prototype.defaults),metaData:{type:"Feature",className:"Folder"},loaderJSON:t.merge({children:"loadJSONChildren",Root:"loadJSONChildren"},e.loaderJSON),setup:function(){this._parent(),this.set("children",new n),this.addEvent("onChange:visible",this._visibilityUpdatedFolder,this),this.nbChildrenToLoad=0},_setupSubElementsOrder:function(){var e=0;void 0!==this.get("PointOfView")&&null!==this.get("PointOfView")&&(this.get("PointOfView")._order=e,e++),void 0!==this.get("Content")&&null!==this.get("Content")&&(this.get("Content")._order=e,e++);for(var t=0,i=this.getNumChildren();t<i;++t){var r=this.getChild(t);r._order=e,r.dispatchEvent("onChange:order"),e++}},destroy:function(e){this.clear(),this._parent(e)},loadJSONChildren:function(e,t,i,s,n){for(var o=0;o<i.length;o++){var a=i[o];if(Utils.is(a)){var h=a.className||"Feature",l=r.ObjectContructor[h];if(l)(new l).loadJSON(e,a,this,!0,void 0,n)}else console.warn("A "+this.get("name")+"'s child is not valid")}},clear:function(){return this.removeChildren(),this.get("children").reset(),this},removeChildren:function(){for(var e=this.get("children").toArray(),t=0;t<e.length;t++)this.removeChild(e[t])},create:function(e){if(!this._parent(e))return!1;for(var t=this.get("children").toArray(),i=0;i<t.length;i++)t[i]._created||t[i].create(e);return!0},addChild:function(e,t){var i;return e._itemParent&&e._itemParent.removeChild(e),e.addEvent("onChange:loadInfo",this.updateLoadInfo,this),e.setItemParent(this),e.index=t,i=this._checkFeaturePosition(e,t),this.get("children").add(e,{at:i}),!0===e.get("visible")&&(this.setVisible(!0,!1),!0===this.get("exclusive")&&this.childVisible(e,!0)),e.addTags(this.get("tags")),this._childAdded(this,e),e.addEvent("onChange:visible",this.childVisible,this),this.addEvent("onAdded:tag",e.addTag,e),this.addEvent("onRemoved:tag",e.removeTag,e),this._setupSubElementsOrder(),this},_checkFeaturePosition:function(e,t){var i=t;return this.get("children").length<=t&&(i=this._positionInTheHead(e,t)),i},_positionInTheHead:function(e,t){var i=t;return this.get("children").length>0&&this.get("children").last().index>e.index&&(i=this.get("children").length-1),i},removeChild:function(e){return this.findChildById(e.get("id"))&&(e.set("selected",!1),e.getContent()&&"RdbLink"===e.getContent().metaData.className&&e.dispatchEvent("onChange:selected",e),this.get("children").remove(e),e.setItemParent(void 0),this._childRemoved(this,e),e.removeEvent("onChange:visible",this.childVisible),e.removeEvent("onChange:loadInfo",this.updateLoadInfo,this),this.removeEvent("onAdded:tag",e.addTag),this.removeEvent("onRemoved:tag",e.removeTag),this._setupSubElementsOrder()),this},getNumChildren:function(){return this.get("children").length},incrNumChildrenToLoad:function(){this.nbChildrenToLoad++},decrNumChildrenToLoad:function(){this.nbChildrenToLoad>0&&this.nbChildrenToLoad--},getNumChildrenToLoad:function(){return this.nbChildrenToLoad},getChild:function(e){return this.get("children").at(e)},findWhere:function(e,t){var i=this.get("children").findWhere(e);return i||!0!==t||this.traverse(function(t){var r=t.get("children");return r&&r.length&&!i&&(i=r.findWhere(e)),void 0!==i},!0),i},where:function(e,t){var i=this.get("children").where(e);return!0===t&&this.traverse(function(t){var r=t.get("children");r&&r.length&&(i=i.concat(r.where(e)))},!0),i},findChildByName:function(e,t){return this.findWhere({name:e},t)},findChildById:function(e,t){return this.findWhere({id:e},t)},findChildrenByName:function(e,t){return this.where({name:e},t)},getChildrenByClassName:function(e,t){var i=[];return this.traverse(function(t){t.metaData.className===e&&i.push(t)},t),i},childVisible:function(e){!0===e.get("visible")&&(this.set("visible",!0),!0===this.get("exclusive")&&this.get("children").forEach(function(t){t!==e&&t.setVisible(!1,!0)}))},updateLoadInfo:function(e){Utils.is(e)&&(Utils.is(this._loadingProgressList)||(this._loadingProgressList=new s(this._progressEvent.bind(this),this._loadFinished.bind(this))),this._loadingProgressList.updateLoading(e.get("id"),e.get("loadInfo")))},_progressEvent:function(e){this.set("loadInfo",e)},_loadFinished:function(){},setVisible:function(e,t){return this._parent(e),t&&!0===e&&(!0===this.get("exclusive")&&!0===e&&this.get("children").length>0?this.get("children").at(0).setVisible(!0,t):this.invoke("setVisible",e,t)),this},select:function(e,t){return this._parent("select"),t&&this.invoke("select",e,t),this},traverse:function(e,t,i){this.get("children").forEach(function(r){!0!==e(r,i)&&!0===t&&r.traverse&&r.traverse(e,t,i)},this)},invoke:function(e,t){var i=Array.prototype.slice.call(arguments,1);return this.get("children").forEach(function(r){r[e].apply(r,i),!0===t&&r.invoke&&r.invoke(e,t)},this),this},moveChild:function(e,t,i){return this.findChildById(e.get("id"))?(e.set("selected",!1),this.get("children").remove(e),this.dispatchEvent("onChildRemove",e),e._itemParent=void 0,Utils.is(i)||(i=this),i.addChild(e,t),this._setupSubElementsOrder(),i.dispatchEvent("onChildMove",e),this):this},_childAdded:function(e,t){this._itemParent&&this._itemParent._childAdded(e,t),this.dispatchEvent("onChildAdd",t)},_childRemoved:function(e,t){this._itemParent&&this._itemParent._childRemoved(e,t),this.dispatchEvent("onChildRemove",t)},_visibilityUpdatedFolder:function(){!1===this.get("visible")&&this.invoke("setVisible",!1)},_selectedUpdated:function(){if(!0===this.get("selected"))for(var e=this.get("children").toArray(),t=0;t<e.length;t++)e[t].set("selected",!0)}});return r.ObjectContructor.Folder=o}),define("DS/XCityModel/Marker",["DS/XCityTools/Downloader","DS/XCityModel/Location","DS/XCityGeometry/MarkerManager","DS/XCityModel/Item","DS/XCityGeometry/Marker","DS/xCityBasicUtils/Utils","DS/xCityBasicUtils/DataFormatTools","DS/Visualization/ThreeJS_DS","DS/XCityRendering/RenderingHandlerMarker","DS/XCityModel/Folder","DS/XCityModel/Feature","DS/XCityTools/Geocoder","DS/XCityTools/EventDispatcher"],function(e,t,i,r,s,n,o,a,h,l,d,u,c){"use strict";var g=t.extend({defaults:{renderID:"",Rendering:null,url:"",geojson:null,nameAttribute:"NAME",descriptionAttribute:"DESCRIPTION",visibleAttribute:"VISIBLE",selectedAttribute:"SELECTED",stridAttribute:"STRID",objectId:""},metaData:{type:"Location",className:"Marker",customClass:"Marker"},init:function(e){this._parent(e),n.is(e)&&n.is(e._rendering)&&(this._rendering=e._rendering),n.is(e)&&n.is(e.parentId)&&(this._parentId=e.parentId),this._created=!1},create:function(t){var r=this;this._created=!0,this._urban=t._urban,this.initEvents(),n.is(i.markerCollection)||i.build({urban:this._urban}),n.is(this._rendering)||this._initRenderingProfile();var h=this._rendering.getCompleteMaterialInfo();if(!this.get("url")||""===this.get("url")){var f=this.get("position");this.geometryMarker=new s({feature:this,urban:this._urban,markerManager:i,name:this._itemParent?this._itemParent.get("name"):"",selected:!!this._itemParent&&this._itemParent.get("selected"),visible:!this._itemParent||this._itemParent.get("visible"),description:this._itemParent?this._itemParent.get("description"):"",position:f,customClass:h.customClass,style:h.style,stroke:h.stroke,iconName:h.iconName,icon:h.icon,color:"#"+h.color.getHexString(),textStyle:h.textStyle,textColor:"#"+h.textColor.getHexString(),descriptionDisplayMode:h.descriptionDisplayMode}),i.markerCollection.add(this.geometryMarker);var _=o.fromArrayToJSON([f.toArray()],"point");this.set("geojson",_),c.publish(c.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})}if(this.get("url")&&""!==this.get("url")){var p=this.get("url");e.download(p,void 0,9,function(e,t){if(!1!==e&&n.is(t)){r.geometryMarker&&(r.geometryMarker.destroy(),i.markerCollection.remove(r.geometryMarker));var s=JSON.parse(t);r.set("geojson",s),r.privateFolder=r._urban._dataModelPrivate.findChildById("vector_markers"),void 0===r.privateFolder&&(r.privateFolder=new l({id:"vector_markers",name:"vector_markers",visible:!0,opened:!1}),r._urban._dataModelPrivate.addChild(r.privateFolder)),r._itemParent.addEvent("onChange:visible",function(){i.render()});for(var o=0;o<s.features.length;o++)if(s.features[o].geometry){var h,c=s.features[o].geometry;h=s.crs&&"WGS84"!==s.crs.properties.name?{x:c.coordinates[0],y:c.coordinates[1]}:u.proj(c.coordinates,"WGS84",r._urban.baseProjection);var f=Object.assign({},r._rendering.currentMaterial,{position:new a.Vector3(h.x,h.y,c.coordinates[2]?c.coordinates[2]:0),_rendering:r._rendering}),_=new g(f);r._featureSet||(r._featureSet=[]),r._featureSet.push(_);var p=new d({name:"",description:"",selected:r._itemParent.get("selected"),visible:r._itemParent.get("visible")});p.set("Content",_),r.privateFolder.addChild(p),s.features[o].properties[r.get("nameAttribute")]&&_._itemParent.set("name",s.features[o].properties[r.get("nameAttribute")]),s.features[o].properties[r.get("descriptionAttribute")]&&_._itemParent.set("description",s.features[o].properties[r.get("descriptionAttribute")]),s.features[o].properties[r.get("visibleAttribute")]&&_._itemParent.set("visible",s.features[o].properties[r.get("visibleAttribute")]),s.features[o].properties[r.get("selectedAttribute")]&&_._itemParent.set("selected",s.features[o].properties[r.get("selectedAttribute")]),s.features[o].properties[r.get("stridAttribute")]&&_._itemParent.set("strid",s.features[o].properties[r.get("stridAttribute")]);var m=r._rendering.getRenderingValues(_._itemParent.get("strid"),s.features[o].properties);_.applyMaterialOnGeometry(m)}i.onMarkerLayerLoaded({number:s.features.length,id:r._itemParent.get("id")}),i.render()}})}},_initRenderingProfile:function(){this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this._rendering=new h(this._urban),this.renderingProfileManager=this._urban.getRenderingProfileManager(),this.renderingProfileManager.initRendering(this)},destroy:function(){if(this._featureSet)for(var e=0;e<this._featureSet.length;e++)this._featureSet[e].destroy();this.geometryMarker&&(this.geometryMarker.destroy(),i.markerCollection.remove(this.geometryMarker)),this._parent(this.getRoot())},getRendering:function(){return this._rendering},set:function(e,t){var i={},r=this.getRendering();n.is(r)&&r.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t)},get:function(e){var t,i,r=this._rendering;return n.is(r)&&r.hasAttribute(e)?(i=this._rendering.getCompleteMaterialInfo(),n.is(i)&&(t=i[e])):t=this._parent(e),t},setMaterial:function(e){if(this._parentId){this.renderingProfileManager||(this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this.renderingProfileManager=this._urban.getRenderingProfileManager()),this.renderingProfileManager.addRendering(this._parentId,e,this.parentFeatureID);var t=this._rendering._elementRendering._materials[this._rendering._elementRendering._ids[this.parentFeatureID]];this.applyMaterialOnGeometry(t)}else this.renderingProfileManager.addRendering(this.parentFeatureID,e)},redraw:function(){var e,t,i=this.getRendering();if(n.is(i)&&n.is(this.geometryMarker))if(this._featureSet)for(var r=0;r<this._featureSet.length;r++)e=this._featureSet[r]._itemParent.get("strid"),t=i.getRenderingValues(e,this.get("geojson").features[r].properties),this._featureSet[r].applyMaterialOnGeometry(t);else t=i.getCompleteMaterialInfo(),this.applyMaterialOnGeometry(t)},applyMaterialOnGeometry:function(e){var t;if(n.is(e)){if(n.is(e.color)&&"annotationIconAdvanced"!==e.style&&(this.geometryMarker.set("color","#"+e.color.getHexString()),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("color","#"+e.color.getHexString());if(n.is(e.style)&&(this.geometryMarker.set("style",e.style),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("style",e.style);if(n.is(e.customClass)&&(this.geometryMarker.set("customClass",e.customClass),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("customClass",e.customClass);if(n.is(e.iconName)&&(this.geometryMarker.set("iconName",e.iconName),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("iconName",e.iconName);if(n.is(e.icon)&&(this.geometryMarker.set("icon",""),this.geometryMarker.set("icon",e.icon),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("icon",e.icon);if(n.is(e.textStyle)&&(this.geometryMarker.set("textStyle",e.textStyle),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("textStyle",e.textStyle);if(n.is(e.stroke)&&(this.geometryMarker.set("stroke",e.stroke),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("stroke",e.stroke);if(n.is(e.textColor)&&(this.geometryMarker.set("textColor","#"+e.textColor.getHexString()),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("textColor","#"+e.textColor.getHexString());if(n.is(e.descriptionDisplayMode)&&(this.geometryMarker.set("descriptionDisplayMode",e.descriptionDisplayMode),this._featureSet))for(t=0;t<this._featureSet.length;t++)this._featureSet[t].geometryMarker.set("descriptionDisplayMode",e.descriptionDisplayMode)}},initEvents:function(){var e=this;n.is(this._itemParent)&&(this._itemParent.addEvent("onChange:name",function(){e._itemParent&&e.geometryMarker&&e.geometryMarker.set("name",e._itemParent.get("name"))}),this._itemParent.addEvent("onChange:selected",function(){if(e._itemParent&&(e.geometryMarker&&e.geometryMarker.set("selected",e._itemParent.get("selected")),e._featureSet))for(var t=0;t<e._featureSet.length;t++)e._featureSet[t]._itemParent.set("selected",e._itemParent.get("selected"))}),this._itemParent.addEvent("onChange:visible",function(){if(e._itemParent&&(e.geometryMarker&&e.geometryMarker.set("visible",e._itemParent.get("visible")),e._featureSet))for(var t=0;t<e._featureSet.length;t++)e._featureSet[t]._itemParent.set("visible",e._itemParent.get("visible"))}),this._itemParent.addEvent("onChange:description",function(){e.geometryMarker&&e.geometryMarker.set("description",e._itemParent.get("description"))})),this.addEvent("onChange:position",function(){e._itemParent&&e.geometryMarker&&e.geometryMarker.set("position",e.get("position"))}),this.addEvent("onChange:geojson",function(){if(e.geometryMarker){var t=e.get("geojson");if(t&&t.features&&t.features[0]&&t.features[0].geometry&&t.features[0].geometry.coordinates){var i=t.features[0].geometry.coordinates,r=new a.Vector3(i[0],i[1],i[2]);this.set("position",r)}}})}});return r.ObjectContructor.Marker=g}),define("DS/XCityModel/LineSet",["DS/XCityModel/AbstractSet","DS/XCityModel/Item","DS/XCityLayer/Vector","DS/xCityBasicUtils/Utils","DS/XCityGeometry/PatchVectorFactoryLine","DS/XCityTools/Geocoder","DS/XCityTools/Debug"],function(e,t,i,r,s,n,o){"use strict";var a=e.extend({metaData:{type:"Geometry",className:"LineSet"},loaderJSON:{geojson:"loadJSONObject",animation:"loadJSONObject"},setup:function(){this._parent(),this._node.name="lineSetFeature"},_processMultiTypeGeometry:function(e,t,i){let r=!0;for(var s=e.geometryList,o=0;o<s.length&&(r||t!==this.urban.baseProjection);++o){let e=s[o].vertexList;for(var a=0;a<e.length&&(r||t!==this.urban.baseProjection);++a){if(t!==this.urban.baseProjection){let i=n.proj(e[a],t,this.urban.baseProjection);e[a].x=i.x,e[a].y=i.y}r&&e[a].x>i.xmin&&e[a].x<i.xmax&&e[a].y>i.ymin&&e[a].y<i.ymax&&(r=!1,this.nbMultiGeometry++,this.nbMultiGeometrySession++)}}return r},_processSimpleTypeGeometry:function(e,t,i){let r=!0,s=e.vertexList;for(var o=0;o<s.length&&(r||t!==this.urban.baseProjection);++o){if(t!==this.urban.baseProjection){let e=n.proj(s[o],t,this.urban.baseProjection);s[o].x=e.x,s[o].y=e.y}r&&s[o].x>i.xmin&&s[o].x<i.xmax&&s[o].y>i.ymin&&s[o].y<i.ymax&&(r=!1,this.nbGeometry++,this.nbGeometrySession++)}return r},_handleOnNextBatchReady:function(e,t){t[this.receivedSessionId].lines=e.lines,this.webWorkersData.lineCreator.primitiveList=JSON.parse(this.webWorkersData.lineCreator.primitiveList),this.webWorkersData.lineCreator.color.buffer.data=new Float32Array(this.webWorkersData.lineCreator.color.buffer.data),this.webWorkersData.lineCreator.position.buffer.data=new Float32Array(this.webWorkersData.lineCreator.position.buffer.data),this.webWorkersData.lineCreator.vertexBindingArray.buffer.data=new Uint32Array(this.webWorkersData.lineCreator.vertexBindingArray.buffer.data),this.webWorkersData.textureInfoCreator.data=new Float32Array(this.webWorkersData.textureInfoCreator.data)},_prepareDataForWorkers:function(e){let t=[],r=this._inputCRS,s=this,a=this._savedDatasource;a.index=0;let h=new Promise((e,t)=>{n.loadProjection(s.urban.baseProjection,function(i){i?(e(),s.preloadedUrbanProj=Object.assign({},n.projections[s.urban.baseProjection].proj4js),delete s.preloadedUrbanProj.forward,delete s.preloadedUrbanProj.init,delete s.preloadedUrbanProj.inverse):(o.error("Failed loading projection: "+s.urban.baseProjection),t("Failed loading projection: "+s.urban.baseProjection))})});t.push(h);let l=new Promise((e,t)=>{n.loadProjection(r,function(i){i?(e(),s.preloadedInputCRS=Object.assign({},n.projections[r].proj4js),delete s.preloadedInputCRS.forward,delete s.preloadedInputCRS.init,delete s.preloadedInputCRS.inverse):(o.error("Failed loading projection: "+r),t("Failed loading projection: "+r))})});t.push(l);let d=new i.Feature,u=[];return"ground"===this._rendering.currentRendering.renderingData.elevationMode&&void 0!==this._rendering.currentRendering.renderingData.elevationOffset&&(a.list.forEach(e=>{a.getNextFeature(d);let t=d.getGeometry();t.type===i.Type.LINESTRING&&e.geometry.coordinates.forEach(e=>{u.push(s.urban.USR.getGroundHeight(e[0],e[1]))}),t.type===i.Type.MULTILINESTRING&&e.geometry.coordinates.forEach(e=>{e.forEach(e=>{u.push(s.urban.USR.getGroundHeight(e[0],e[1]))})})}),a.index=0),this.precomputedZValues=u,t},create:function(e){this._urban=e._urban,this._geometrySTRIDName="line",this._builderWorker=this._urban.lineSetWorker,this._parallelBuilderFunName="buildLineSet",this._geometryName="linestring",this._multiGeometryName="multilinestring",this._geometryVectorMultiType=i.Type.MULTILINESTRING,this._geometryVectorType=i.Type.LINESTRING,this._maxGeometryPreview="maxLinePreview",this._webWorkersDataName="creatorsFromWorker";const t={stridAttribute:this.get("stridAttribute")};return this._factory=new s(this._urban,t),this._parent(e)},_setElevationAttributesFromMaterials:function(e,...t){var i,r,s=["elevationMode","elevation","elevationOffset"],n={},o=1,a=0,h=1;for(let e in s)n[s[e]]=o,a|=o,o<<=1;for(let o in t)for(let l in s)if(i=l=s[l],r=t[o],i in r&&void 0!==r[i]&&null!==r[i]&&(e[l]=t[o][l],a===(h|=n[l])))return},_shouldCreateLabelFromMaterial:function(e){return e.label&&!0===e.label.enable&&r.is(e.label.name)&&""!==e.label.name}});return t.ObjectContructor.LineSet=a}),define("DS/XCityModel/PolygonSet",["DS/XCityModel/AbstractSet","DS/XCityModel/Item","DS/XCityLayer/Vector","DS/XCityGeometry/PatchVectorFactoryPolygon","DS/XCityTools/Geocoder","DS/XCityTools/Debug"],function(e,t,i,r,s,n){"use strict";var o=e.extend({defaults:{renderMode:"occluded"},metaData:{type:"Geometry",className:"PolygonSet"},loaderJSON:{geojson:"loadJSONObject"},setup:function(){this._parent(),this._node.name="polygonSetFeature"},_processMultiTypeGeometry:function(e,t,i){let r=!0,n=e.geometryList;for(let e=0;e<n.length&&(r||t!==this.urban.baseProjection);++e){let o=n[e].geometryList;for(let e=0;e<o.length&&(r||t!==this.urban.baseProjection);++e){let n=o[e].vertexList;for(let e=0;e<n.length;++e){let o=n[e];if(t!==this.urban.baseProjection){let e=s.proj(o,t,this.urban.baseProjection);o.x=e.x,o.y=e.y}r&&o.x>i.xmin&&o.x<i.xmax&&o.y>i.ymin&&o.y<i.ymax&&(r=!1,this.nbMultiGeometry++,this.nbMultiGeometrySession++)}}}return r},_processSimpleTypeGeometry:function(e,t,i){let r=!0,n=e.geometryList;for(let e=0;e<n.length&&(r||t!==this.urban.baseProjection);++e){let o=n[e].vertexList;for(let e=0;e<o.length;++e){let n=o[e];if(t!==this.urban.baseProjection){let e=s.proj(n,t,this.urban.baseProjection);n.x=e.x,n.y=e.y}r&&n.x>i.xmin&&n.x<i.xmax&&n.y>i.ymin&&n.y<i.ymax&&(r=!1,this.nbGeometry++,this.nbGeometrySession++)}}return r},_handleOnNextBatchReady:function(e,t){this.webWorkersData.roofCreator.primitiveList=JSON.parse(this.webWorkersData.roofCreator.primitiveList),this.webWorkersData.wallCreator.primitiveList=JSON.parse(this.webWorkersData.wallCreator.primitiveList),this.webWorkersData.textureInfoCreator.data=new Float32Array(this.webWorkersData.textureInfoCreator.data)},geometryRemoved:function(e){if(e.userData&&e.userData.records){for(var t=e.userData.records,i=t.length;i--;){var r=t[i].strid,s=this.miDToTile[r];this.cleanInfo(s,r)}e.userData=void 0}},_prepareDataForWorkers:function(e){let t=[],r=this._inputCRS,o=this,a=this._savedDatasource;a.index=0;let h=new Promise((e,t)=>{s.loadProjection(o.urban.baseProjection,function(i){i?(e(),o.preloadedUrbanProj=Object.assign({},s.projections[o.urban.baseProjection].proj4js),delete o.preloadedUrbanProj.forward,delete o.preloadedUrbanProj.init,delete o.preloadedUrbanProj.inverse):(n.error("Failed loading projection: "+o.urban.baseProjection),t("Failed loading projection: "+o.urban.baseProjection))})});t.push(h);let l=new Promise((e,t)=>{s.loadProjection(r,function(i){i?(e(),o.preloadedInputCRS=Object.assign({},s.projections[r].proj4js),delete o.preloadedInputCRS.forward,delete o.preloadedInputCRS.init,delete o.preloadedInputCRS.inverse):(n.error("Failed loading projection: "+r),t("Failed loading projection: "+r))})});t.push(l);let d=new i.Feature,u=[];return"ground"===this._rendering.currentRendering.renderingData.elevationMode&&void 0!==this._rendering.currentRendering.renderingData.elevationOffset&&(a.list.forEach(e=>{a.getNextFeature(d);let t=d.getGeometry();t.type===i.Type.POLYGON&&e.geometry.coordinates.forEach(e=>{e.forEach(e=>{u.push(o.urban.USR.getGroundHeight(e[0],e[1]))})}),t.type===i.Type.MULTIPOLYGON&&e.geometry.coordinates.forEach(e=>{e.forEach(e=>{e.forEach(e=>{u.push(o.urban.USR.getGroundHeight(e[0],e[1]))})})})}),a.index=0),this.precomputedZValues=u,t},create:function(e){this._urban=e._urban,this._geometrySTRIDName="polygon",this._builderWorker=this._urban.polygonSetWorker,this._parallelBuilderFunName="buildPolygonSet",this._geometryName="polygon",this._multiGeometryName="multipolygon",this._geometryVectorMultiType=i.Type.MULTIPOLYGON,this._geometryVectorType=i.Type.POLYGON,this._maxGeometryPreview="maxPolygonPreview",this._webWorkersDataName="dataFromWebWorkers";const t={stridAttribute:this.get("stridAttribute")};return this._factory=new r(this._urban,t),this._parent(e)}});return t.ObjectContructor.PolygonSet=o}),define("DS/XCityModel/PointOfInterest3DSet",["DS/XCityModel/Location","DS/XCityModel/Item","DS/Visualization/ThreeJS_DS","DS/XCityGeometry/PointOfInterest3DSet","DS/XCityGeometry/PatchVectorFactoryPointOfInterest3D","DS/XCityModel/LayerVectorPrimitive","DS/XCityModel/LayerVectorCluster","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityTools/Debug","DS/XCityRendering/RenderingHandlerPOI3D","DS/XCityRendering/RenderingHandlerPOI3DBillboard","DS/xCityBasicUtils/Utils","DS/XCityTools/EventDispatcher","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/Vector","DS/XCityTools/RTree","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/XCityTools/Disposer","DS/XCityTools/Downloader","DS/XCityTools/Geocoder","DS/XCityTools/ExpressionEvaluator"],function(e,t,i,r,s,n,o,a,h,l,d,u,c,g,f,_,p,m,y,b,v,S,D){"use strict";var P=e.extend({defaults:{url:"",geojson:"",type:"json",styleClass:"",shapeType:"sphere",nbVertices:15,shadingMode:"smooth",_renderMode:"occluded",renderType:"icon",opacityFactor:.3,altitude:0,height:10,switchDistance:500,samplingFactor:1,renderAnchor:!0,anchorLineWidth:1,scale:8,orientation:0,renderID:"",Rendering:null,Clustering:null,nameAttribute:"NAME",stridAttribute:"STRID",styleClassAttribute:"STYLECLASS",altitudeAttribute:"ALTITUDE",heightAttribute:"HEIGHT",orientationAttribute:"ORIENTATION",objectId:"",serviceId:"",rtreeMin:5,rtreeMax:10,rtreeCoverageFactor:2,magnitude:null,interactionBehaviours:{onSelect:{label:!0},onHover:{label:!0}}},metaData:{type:"Location",className:"PointOfInterest3DSet"},loaderJSON:{Clustering:"loadJSONClustering",geojson:"loadJSONObject"},loadJSONClustering:function(e,t,i,r){i.className&&"Clustering"!==i.className||this.set(t,{enable:i.enable,nbSteps:i.nbSteps,minimumHits:i.minimumHits})},setup:function(e){this._parent(),this._poi=void 0,this._scaleZ=!0,this._node=new a,this._node.name="poi3DSetFeature",this._node.hwInstancing=!0,this.addEvent("onChange:rtreeCoverageFactor",this._changeCoverageFactor,this),c.is(e)&&(this._geometrySet=e.geometrySet),this.nbOutside=0,this.nbInside=0,this.nbError=0,this.nbPoint=0,this.nbMultiPoint=0,this.oversized=!1,this.isBuilt=!1,this.nbInputFeature=0,this.oldPrimInfos={}},destroy:function(e){this.primInfos=null,this._data=null,this._factory&&(this._factory.destroy(),this._factory=null),delete this._patch,e.getNode3D().remove(this._node),b.disposeV6(this._node),this._parent(e)},getMesh:function(){return new a},_changeCoverageFactor:function(e){this._factory.rtreeCoverageFactor=this.get("rtreeCoverageFactor")},setClustering:function(e){var t={enable:!(!e||!e.enable)&&e.enable,nbSteps:e&&e.nbSteps?e.nbSteps:6,minimumHits:e&&e.minimumHits?e.minimumHits:1};this.set("Clustering",t);var i=!0===t.enable;i&&!this.clusteringMode?(this._geometrySet?this._geometrySet.getNode3D().remove(this._node):this.getRoot().getNode3D().remove(this._node),this._node=new a,this._node.name="poi3DSetFeature",this._node.hwInstancing=!0,this._poi=void 0,this.create(this._root||this.getRoot())):!i&&this.clusteringMode&&(this._geometrySet?this._geometrySet.getNode3D().remove(this._node):this.getRoot().getNode3D().remove(this._node),this._node=new a,this._node.name="poi3DSetFeature",this._node.hwInstancing=!0,this._poi=void 0,this.create(this._root||this.getRoot()))},rebuild:function(){this.oldPrimInfos=Object.assign({},this.primInfos),this._createSet(this._data,!0)},_createSet:function(e,t){if(this.nbPoint=0,this.nbMultiPoint=0,!1===t)return this.isBuilt=!0,void g.publish(g.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()});var r,s;e instanceof ArrayBuffer&&(e=(new TextDecoder).decode(e)),this._data=e;var n,o=this.get("type");"json"===o?r=new f:"gml"===o?r=new VectorLoaderGML:"enovia"===o&&(r=new VectorLoaderEnovia(urban)),void 0===this.geojson?(s=r.loadDataSourceFromObject("string"==typeof e?JSON.parse(e):e),n="string"==typeof e?JSON.parse(e):e):(s=r.loadDataSourceFromObject("string"==typeof e?JSON.parse(e):e),this.geojson=void 0,n="string"==typeof e?JSON.parse(e):e);var l=n.crs&&n.crs.properties&&n.crs.properties.name?n.crs.properties.name:"WGS84";if(-1===l.indexOf("AUTHORITY")){var d=l.indexOf("EPSG"),u=l.indexOf("CRS84");d>0?l=l.slice(d):u>0&&(l="WGS84"),l=l.replace("::",":")}this._inputCRS=l,this.nbOutside=0,this.nbInside=0,this.nbError=0;var p=s.count;if(this.nbInputFeature=p,0===p)return this.isBuilt=!0,this.oversized=!1,void g.publish(g.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()});this.nbFeatureMax=xCity._urbanImpl.USR.getProfilePerformance().getValue("maxPointPreview"),this.oversized=!1,this.nbInputFeature>p&&(this.oversized=!0);var m=new _.Feature;this.clusteringMode=!1;var y=void 0,b=this.get("Clustering");b&&b.enable&&(y=1,this.clusteringMode=!0);var v=[{tile:{LOD:0,I:0,J:0},infos:{}}],D=[];l!==this.urban.baseProjection&&S.loadProjection(l);this._poi=new a,this.primInfos={},this._node.userData=this._itemParent,this._factory._node.userData=this._itemParent,this._itemParentVisible(this._itemParent);var P=this.getLocalPosition(),C=(new i.Matrix4).identity().setPosition(new i.Vector3(P.x,P.y,0));this._node.setMatrix(C),this._patch={register:function(e,t){var r=this.primInfos[e];r?(r.listeners?r.listeners.push(t):r.listeners=[t],r.tile&&t(r)):this.primInfos[e]={listeners:[t],strid:e,tile:{LOD:0,I:0,J:0},posSize:{center:new i.Vector3,altitude:0,height:0,width:0,length:0},userData:{}}}.bind(this),unregister:function(e,t){var i=this.primInfos[e];if(i&&i.listeners){for(var r=-1,s=0;s<i.listeners.length;++s)if(i.listeners[s].name===t.name){r=s;break}r>-1&&i.listeners.splice(r,1)}}.bind(this),previewMode:!0,_uidListeners:v[0].infos};var x=function(){this._node.addChild(this._factory.getData(v[0])),Object.assign(this.primInfos,v[0].infos),g.publish(g.eventsList.onUpdate+":"+this.get("id"),{loaded:1,total:1}),1===y&&(v[0].rtree.computeClusterIds(),v[0].rtree.computeDistances(xCity._urbanImpl.getViewpoint().camera.projectionMatrix.elements[0],xCity._urbanImpl.getViewpoint().camera.projectionMatrix.elements[5]),v[0].rtree.firstUpdate=!0);var e=function(e){if(e instanceof h&&!0===e.pickable){e.show();var t=e.getPrimitives();if(e.isInstanceNode3D){var i=e.mesh3js.userData.cgmIds;if(void 0!==i)for(var r=i.length-1;r>=0;--r){var s;if(s=v[0].infos[i[r]]){s.geom?s.geom.push({mesh:e,subElement:t[0].sgNode}):s.geom=[{mesh:e,subElement:t[0].sgNode}];var n=this.oldPrimInfos[i[r]];if(c.is(n&&n.listeners)&&(s.listeners=n.listeners),s.listeners&&s.listeners.length>0)for(let e=0;e<s.listeners.length;++e){(0,s.listeners[e])(s)}}}}}}.bind(this);this._node.traverse(e.bind(this)),this._node.children.length>0&&this._node.children[0].children&&this._node.children[0].children.length>0&&(this._node.children[0].children[0].userData={records:D}),this.isBuilt=!0,g.publish(g.eventsList.onLoaded+":"+this.get("id"),{success:!0,item:this.getItemParent()})}.bind(this);this.nbBuiltTotal=0;var M=function(){for(var e=!1,t=0;t<p;++t){t===p-1&&(e=!0),s.getNextFeature(m);var r=m.getGeometry(),n=!0,o=this.urban.baseReferential.bbox;if(r&&r.type===_.Type.MULTIPOINT)for(var a=r.geometryList,h=0;h<a.length;++h){if(l!==this.urban.baseProjection){var d=S.proj(a[h],l,this.urban.baseProjection);a[h].x=d.x,a[h].y=d.y}n&&a[h].x>o.xmin&&a[h].x<o.xmax&&a[h].y>o.ymin&&a[h].y<o.ymax&&(this.nbMultiPoint++,n=!1)}else{if(!r||r.type!==_.Type.POINT){this.nbError++;continue}if(l!==this.urban.baseProjection){d=S.proj(r,l,this.urban.baseProjection);r.x=d.x,r.y=d.y}n&&r.x>o.xmin&&r.x<o.xmax&&r.y>o.ymin&&r.y<o.ymax&&(this.nbPoint++,n=!1)}if(n)this.nbOutside++;else{this.nbInside++;var u={listeners:null,strid:m.getAttribute(this._factory.stridAttribute),tile:{LOD:0,I:0,J:0},posSize:{center:new i.Vector3,altitude:0,height:0,width:0,length:0},userData:{}};if(void 0===u.strid&&(this.fromGeometrySet?u.strid=this.get("id")+"_"+(this.nbPoint+this.nbMultiPoint):u.strid=this.get("id")+"_point_"+(this.nbPoint+this.nbMultiPoint),m.attributes[this._factory.stridAttribute]=u.strid),r){var c,f;for(f=(c=m.getAttributeKeys()).length;f--;)u.userData[c[f]]=m.getAttribute(c[f]);D.push(u),v[0].infos[u.strid]=u,this.nbFeature++,this._factory.buildOne(m,v[0],u,y)}0,this.nbBuiltTotal++}}e&&g.subscribeTo("/3DEXPERIENCity/onPostUpdate",x,!0)}.bind(this),I=function(){void 0===S.projections[l]||1!==S.projections[l].ready?g.subscribeTo("/3DEXPERIENCity/onPostUpdate",I,!0):g.subscribeTo("/3DEXPERIENCity/onPostUpdate",M,!0)}.bind(this);g.subscribeTo("/3DEXPERIENCity/onPostUpdate",I,!0)},create:function(e){if(this._urban=e._urban,!this._parent(e))return g.publish(g.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;this.fromGeometrySet=!1,this._itemParent.get("Content")._poiSet&&this._itemParent.get("Content")._lineSet&&this._itemParent.get("Content")._polygonSet&&(this.fromGeometrySet=!0),e.getNode3D().add(this._node),this.urban=e._urban;var t={nameAttribute:this.get("nameAttribute"),stridAttribute:this.get("stridAttribute"),styleClassAttribute:this.get("styleClassAttribute"),altitudeAttribute:this.get("altitudeAttribute"),heightAttribute:this.get("heightAttribute"),orientationAttribute:this.get("orientationAttribute"),scale:this.get("scale"),shapeType:this.get("shapeType"),shadingMode:this.get("shadingMode"),renderType:this.get("renderType"),renderMode:this.get("renderMode"),samplingFactor:this.get("samplingFactor"),opacityFactor:this.get("opacityFactor"),switchDistance:this.get("switchDistance"),renderAnchor:this.get("renderAnchor"),anchorLineWidth:this.get("anchorLineWidth"),nbVertices:this.get("nbVertices"),alwaysDisplayText:this.get("alwaysDisplayText"),geometrySet:this._geometrySet};this._factory=new s(this.urban,t),this._factory.rtreeMax=this.get("rtreeMax"),this._factory.rtreeMin=this.get("rtreeMin"),this._factory.rtreeCoverageFactor=this.get("rtreeCoverageFactor"),this._factory._magnitude=this.get("magnitude"),this._factory.eventOnVisibilityParent=!0,this._factory._clusterSteps=[2,10,100,1e3,1e4,1e5,1e6,1e7],this._factory.rdblink=!1,this.renderingProfileManager=this.urban.getRenderingProfileManager(),this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this._rendering=this._factory._rendering,this._rendering.defaultRendering.addOver({renderMode:"overlay"}),this.renderingProfileManager.initRendering(this),this._geometrySet&&this._geometrySet.getRendering()&&this._geometrySet.getRendering()._subRenderingHandler&&(this._geometrySet._poiSet._rendering=this._rendering,this._geometrySet.getRendering()._subRenderingHandler[0]=this._rendering),this.nbPoint=0,this.nbMultiPoint=0,this.isBuilt=!1;var r=this.get("scale");"number"==typeof r&&(r=new i.Vector3(r,r,r));this.getLocalPosition();this.nbFeature=0;var n=function(){if(this._factory.isReady&&this._factory.isReady()){var e=this.get("serviceId");if(void 0!==this.get("objectId")&&""!==this.get("objectId")&&void 0!==e&&""!==e)"3DSpace"===e?v.downloadFrom3DSpace(this.get("objectId")).then(function(e){this._createSet(e,!0)}):"3DDrive"===e&&v.downloadFrom3DDrive(this.get("objectId")).then(function(e){this._createSet(e,!0)});else if(""!==this.get("url")){var t=this.get("url");v.download(t,{},99999,function(e,t,i,r){r(t,e,i)},void 0,this._createSet.bind(this))}else null!==this.get("geojson")&&(this.geojson=!0,this._createSet(this.get("geojson"),!0))}else g.subscribeTo("/3DEXPERIENCity/onPostUpdate",n,!0)}.bind(this);return n(),!0},getRendering:function(){return this._rendering},redraw:function(){var e=this.getRendering();c.is(e)&&(e._needRebuild&&this._node.children.length>0&&(b.disposeV6(this._node),this.rebuild()),e.applyRendering(this._node.children[0]),e._needRebuild=!1)},setItemParent:function(e){this._itemParent&&(this._itemParent.removeEvent("onChange:name",this._updateName),this._itemParent.removeEvent("onChange:visible",this._itemParentVisible)),this._itemParent=e,e&&(this._itemParent.addEvent("onChange:name",this._updateName,this),this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this))},_updatePosition:function(){this._parent();var e=this.getLocalPosition();if(this._node){var t=(new i.Matrix4).identity().setPosition(new i.Vector3(e.x,e.y,e.z));this._node.setMatrix(t)}},_updateName:function(){},_itemParentVisible:function(e){this._created&&this._node.setVisibility(e.get("visible"))},_select:function(e){var t;if(this._poi)if(e.get("selected")){var s=e.getContent()._node.instanceId,n=e.getContent()._node.children[0].children[0].children[0].mesh3js.userData.cgmIds[(s-5)/5],o=this.bboxes[n];new i.MeshLambertMaterial({color:16777215,side:i.DoubleSide}).force=!0;var h=o.min,l=o.max,d=new i.Vector3;d.subVectors(l,h),d.add(l);var u=y.createRectangleNode({width:l.x-h.x,height:l.y-h.y,fill:!0,color:new m.Color(.5,.2,.5,1)}),c=new a;c.addChild(u),c.setMatrix((new i.Matrix4).setPosition(h)),c.setPickable(m.NOPICKABLE),c.isAreaCluster=!0,this._node.addChild(c),this._bboxNode=c;var g={styleClass:this.get("styleClass"),pClass:"poiText",samplingFactor:this.get("samplingFactor")};(t=r.generateTextNode(this.urban,this._itemParent.get("name"),g))._excludeFromCSO=!0,t._excludeFromHSO=!0,t._excludeFromHL=!0,t._excludeFromPSO=!0,t._excludeFromPreHL=!0;var f=e.getContent().get("position");t.setMatrix((new i.Matrix4).translate(new i.Vector3(f.x,f.y,f.z))),this._node.addChild(t)}else(t=this._node.getChildByName("text"))&&this._node.removeChild(t),this._node.removeChild(this._bboxNode)},get:function(e){var t,i,r=this.getRendering();return this.renderingProfileManager&&c.is(r)&&r.hasAttribute(e)?(i=this.getMaterial(),c.is(i)&&(t=i[e])):t=this._parent(e),t},set:function(e,t){var i={},r=this.getRendering();this.renderingProfileManager&&c.is(r)&&r.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t)},getMaterial:function(){var e=this.getRendering();return c.is(e)?e.getCompleteMaterialInfo():this.renderingProfileManager.getRenderingData(this.parentFeatureID)},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},getBoundingSphere:function(){if(this._localPosition&&this._node){if(c.is(this._factory)&&c.is(this._factory.rtrees)){var e={minX:this._factory.rtrees[0]._root.boundingBox.min.x,minY:this._factory.rtrees[0]._root.boundingBox.min.y,minZ:this._factory.rtrees[0]._root.boundingBox.min.z,maxX:this._factory.rtrees[0]._root.boundingBox.max.x,maxY:this._factory.rtrees[0]._root.boundingBox.max.y,maxZ:this._factory.rtrees[0]._root.boundingBox.max.z},t=this._localPosition;t.z=this._node.bSphere.center.z;var r=Math.sqrt(Math.pow(e.maxX-e.minX,2)+Math.pow(e.maxY-e.minY,2)+Math.pow(e.maxZ-e.minZ,2))/2;return new i.Sphere(t,r)}return this._node.getBoundingSphere()}},createPrimitive:function(e,t){var i;if(this._factory&&this._factory.getGeoJSON&&(i=this._factory.getGeoJSON(e)),void 0===t){var r=function(i){if(i instanceof h&&!0===i.pickable&&i.isInstanceNode3D){var r=i.mesh3js.userData.cgmIds;if(void 0!==r)for(var s=r.length-1;s>=0;--s)r[s]===e&&(t=5*s+5)}}.bind(this);this._node.traverse(r.bind(this))}var s=new n({strid:e,geojson:i,instanceId:t});return s.setLayerVector(this),s.create(this.getRoot()),s.addSubElements(this.primInfos[e]),s},createCluster:function(e,t,r){var s;this._factory&&this._factory.getGeoJSON&&(s=this._factory.getGeoJSON(e));var n=new o({strid:e,geojson:s,instanceId:t,clusterInfo:r});n.setLayerVector(this),n._localPosition=new i.Vector3,n.create(this.getRoot());var a=this._node.children[0].children[0].children[0];return n._subMeshes.push({mesh:a,subElement:a.getPrimitives()}),n._subMeshes.instanceId=t,n},register:function(e){},unregister:function(e){},redrawPrimitive:function(e){if(c.is(this._patch)){var t=this.getRendering();c.is(t)&&(t.isPrimitiveRegistered(e)?t._renderprimitive(e):this.registerPrimitive(e))}},registerPrimitive:function(e){if(c.is(this._patch)){var t=this.getRendering();c.is(t)&&(t.isPrimitiveRegistered(e)||t.registerPrimitive(this._patch,e))}},registerPrimitives:function(e){var t,i,r=Object.keys(e),s=r.length;for(t=0;t<s;t++)i=r[t],this.registerPrimitive(i)},addUserDataProperty:function(e,t,i){if(c.is(e)){var r=this.get("geojson"),s=r.features[0];if(c.is(i))for(var n=0;n<r.features.length;n++){var o=r.features[n];if(o&&o.properties&&o.properties.STRID===i){s=o;break}}s.properties||(s.properties={}),s.properties[e]=t;var a=this.get("userData");return a||(a={},this.set("userData",a)),a[e]=t,!0}return!1},removeUserDataProperty:function(e,t){if(c.is(e)){var i=this.get("geojson"),r=i.features[0];if(c.is(t))for(var s=0;s<i.features.length;s++){var n=i.features[s];if(n&&n.properties&&n.properties.STRID===t){r=n;break}}c.is(r.properties[e])&&delete r.properties[e];var o=this.get("userData");return c.is(o[e])&&delete o[e],!0}return!1},findPrimitivesByCriteria:function(e){var t=new D(e),i={};if(!c.is(t))return null;var r;for(var s in this.primInfos){var n=this.primInfos[s].userData;!0===(r=n,t.apply(r)||!1)&&(i[s]=n)}return i}});return t.ObjectContructor.PointOfInterest3DSet=P}),define("DS/XCityModel/GeometrySet",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/XCityModel/Item","DS/XCityLayer/VectorLoaderJSON","DS/XCityLayer/VectorLoaderEnovia","DS/XCityLayer/Vector","DS/xCityBasicUtils/Utils","DS/XCityModel/PointOfInterest3DSet","DS/XCityModel/LineSet","DS/XCityModel/PolygonSet","DS/XCityModel/LayerVectorPrimitive","DS/XCityTools/EventDispatcher","DS/XCityTools/Geocoder","DS/XCityTools/Downloader","DS/XCityTools/ExpressionEvaluator","DS/XCityTools/Disposer","DS/XCityRendering/RenderingHandlerProxy","DS/XCityTools/RenderingTools"],function(e,t,i,r,s,n,o,a,h,l,d,u,c,g,f,_,p,m,y){"use strict";var b=r.extend({defaults:{SUB_REND_HANDLER_LINE_INDEX:1,SUB_REND_HANDLER_POLY_INDEX:2,SUB_REND_HANDLER_POINT_INDEX:0,url:"",geojson:null,type:"json",Coordinate:null,renderID:"",Rendering:null,Clustering:null,objectId:"",serviceId:"",stridAttribute:"STRID",interactionBehaviours:{onSelect:{label:!0},onHover:{label:!0}}},metaData:{type:"Geometry",className:"GeometrySet"},loaderJSON:{Clustering:"loadJSONClustering",geojson:"loadJSONObject",animation:"loadJSONObject"},loadJSONClustering:function(e,t,i,r){i.className&&"Clustering"!==i.className||this.set(t,{enable:i.enable,nbSteps:i.nbSteps,minimumHits:i.minimumHits})},setup:function(){this._parent(),this._node=new t,this._node.name="geometrySetFeature",this.loaderJSON||(this.loaderJSON={}),this.heightMatrix=new e.Matrix4,this._poiSet=new h({geometrySet:this}),this._lineSet=new l,this._polygonSet=new d,this.analytics=null},destroy:function(e){c.unsubscribe(this.onPointLoadedToken),c.unsubscribe(this.onLineLoadedToken),c.unsubscribe(this.onPolygonLoadedToken),c.unsubscribe(this.onPointUpdatedToken),c.unsubscribe(this.onLineUpdatedToken),c.unsubscribe(this.onPolygonUpdatedToken),this._poiSet.destroy(this),delete this._poiSet,this._lineSet.destroy(this),delete this._lineSet,this._polygonSet.destroy(this),delete this._polygonSet,delete this._rendering,delete this.heightMatrix,e.getNode3D().remove(this._node),p.disposeV6(this._node),this._parent(e)},getNode3D:function(){return this._node},create:function(e){if(this._urban=e._urban,!this._parent(e))return c.publish(c.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()}),!1;this.parentFeatureID=this.getItemParent()?this.getItemParent().id:null,this.renderingProfileManager=this._urban.getRenderingProfileManager(),e.getNode3D().add(this._node),this._poiSet.setItemParent(this._itemParent),this._lineSet.setItemParent(this._itemParent),this._polygonSet.setItemParent(this._itemParent),this.get("stridAttribute")&&(this._poiSet.set("stridAttribute",this.get("stridAttribute")),this._lineSet.set("stridAttribute",this.get("stridAttribute")),this._polygonSet.set("stridAttribute",this.get("stridAttribute"))),this._poiSet._attributes.id=this.get("id")+"_point",this._lineSet._attributes.id=this.get("id")+"_line",this._polygonSet._attributes.id=this.get("id")+"_polygon",this._nbLayerBuilt=0;var t=this,i=function(e){a.is(e)&&("boolean"==typeof e||(e.success,e.item)),t._nbLayerBuilt++,3===t._nbLayerBuilt&&(t.get("Clustering")&&t.setClustering(t.get("Clustering")),c.publish(c.eventsList.onLoaded+":"+t.get("id"),{success:!0,item:t.getItemParent()}))},r={loaded:1,total:1},s={loaded:1,total:1},n={loaded:1,total:1},o=function(e){var i=r.loaded+s.loaded+n.loaded,o=r.total+s.total+n.loaded;t.set("loadInfo",{loaded:i,total:o})};this.onPointLoadedToken=c.subscribeTo(c.eventsList.onLoaded+":"+this.get("id")+"_point",i),this.onLineLoadedToken=c.subscribeTo(c.eventsList.onLoaded+":"+this.get("id")+"_line",i),this.onPolygonLoadedToken=c.subscribeTo(c.eventsList.onLoaded+":"+this.get("id")+"_polygon",i),this.onLineUpdatedToken=c.subscribeTo(c.eventsList.onUpdate+":"+this.get("id")+"_line",function(e){r=e,o()}),this.onPolygonUpdatedToken=c.subscribeTo(c.eventsList.onUpdate+":"+this.get("id")+"_polygon",function(e){s=e,o()}),this.onPointUpdatedToken=c.subscribeTo(c.eventsList.onUpdate+":"+this.get("id")+"_point",function(e){n=e,o()});t=this;var h=function(e,i){if(i)t._poiSet._attributes.geojson=e,t._lineSet._attributes.geojson=e,t._polygonSet._attributes.geojson=e,t._poiSet.create(t),t._lineSet.create(t),t._polygonSet.create(t),t.getLayerAttributes(),t._rendering.addSubRenderingHandler(this._poiSet.getRendering(),this.get("SUB_REND_HANDLER_POINT_INDEX")),t._rendering.addSubRenderingHandler(this._lineSet.getRendering(),this.get("SUB_REND_HANDLER_LINE_INDEX")),t._rendering.addSubRenderingHandler(this._polygonSet.getRendering(),this.get("SUB_REND_HANDLER_POLY_INDEX")),t._rendering.setContent(t);else if(e){e instanceof ArrayBuffer&&(e=(new TextDecoder).decode(e));var r=JSON.parse(e);t.serviceError=r,c.publish(c.eventsList.onLoaded+":"+this.get("id"),{success:!1,item:this.getItemParent()})}}.bind(this);this._rendering=new m(this._urban,{});var l=this.get("serviceId"),d=this.get("objectId"),u=this._urban.baseProjection.split(":");if(u=u[u.length-1],void 0!==d&&""!==d&&void 0!==l&&""!==l)"3DSpace"===l?f.downloadFrom3DSpace(d,!0).then(function(e){e&&e.needServiceSidePreview?f.download(f.getDataSupplierUrl(!0)+"togeojson?serviceId=3DSpace&objectId="+d+"&outputEPSG="+u+"&tenant="+f._platformID,{type:"arraybuffer"},99999,function(e,t,i,r){r(t,e,i)},void 0,h):h(e,!0)}):"3DDrive"===l&&f.downloadFrom3DDrive(d,!0).then(function(e){e&&e.needServiceSidePreview?f.download(f.getDataSupplierUrl(!0)+"togeojson?serviceId=3DDrive&objectId="+d+"&outputEPSG="+u+"&tenant="+f._platformID,{type:"arraybuffer"},99999,function(e,t,i,r){r(t,e,i)},void 0,h):h(e,!0)});else if(""!==this.get("url")){var g=this.get("url");f.download(g,{type:"arraybuffer"},99999,function(e,t,i,r){r(t,e,i)},void 0,h)}else null!==this.get("geojson")&&(t._poiSet._attributes.geojson=this.get("geojson"),t._lineSet._attributes.geojson=this.get("geojson"),t._polygonSet._attributes.geojson=this.get("geojson"),t._poiSet.create(t),t._lineSet.create(t),t._polygonSet.create(t),t._rendering.addSubRenderingHandler(this._poiSet.getRendering()),t._rendering.addSubRenderingHandler(this._lineSet.getRendering()),t._rendering.addSubRenderingHandler(this._polygonSet.getRendering()));return this._factory=!0,!0},get:function(e){var t,i,r=this.getRendering();if(this.renderingProfileManager&&a.is(r)&&r.hasAttribute(e)){if(i=this._rendering._getMaterialInfo(),a.is(i)){t=(i=y.getJSONFromRendering(i))[e];let s=function(t,i){let s=y.getJSONFromRendering(r._subRenderingHandler[i]._getMaterialInfo())[e];return s||t};this._lineSet.nbBuiltTotal&&this._lineSet.nbBuiltTotal>0&&(t=s(t,this.get("SUB_REND_HANDLER_LINE_INDEX"))),this._poiSet.nbBuiltTotal&&this._poiSet.nbBuiltTotal>0&&"stroke"!==e&&(t=s(t,this.get("SUB_REND_HANDLER_POINT_INDEX"))),this._polygonSet.nbBuiltTotal&&this._polygonSet.nbBuiltTotal>0&&(t=s(t,this.get("SUB_REND_HANDLER_POLY_INDEX")))}}else t=this._parent(e);return t},set:function(e,t){if("renderID"===e||"id"===e||"interactionBehaviours"===e){let i=e;this._polygonSet.set(i,t),this._poiSet.set(i,t),this._lineSet.set(i,t)}var i={},r=this.getRendering();this.renderingProfileManager&&a.is(r)&&r.hasAttribute(e)?(i[e]=t,this.setMaterial(i)):this._parent(e,t)},getLocalPosition:function(){var e=this._node.getBoundingSphere().center;return this.get("Coordinate")&&e.add(this.get("Coordinate").getLocalPosition()),e},getSphereDiameter:function(){return 2*this._node.getBoundingSphere().radius},_updateCoordinate:function(){var e=this.previous("Coordinate");e&&e.removeEvent("onChange:matrix",this._updateMatrix,this),this.get("Coordinate")?(this.get("Coordinate").setItemParent(this),this._updateMatrix(this.get("Coordinate")._matrix),this.get("Coordinate").addEvent("onChange:matrix",this._updateMatrix,this)):this._updateMatrix()},_itemParentVisible:function(e){this._created},setItemParent:function(e){this._itemParent&&this._itemParent.removeEvent("onChange:visible",this._itemParentVisible,this),this._parent(e),this._itemParent&&this._itemParent.addEvent("onChange:visible",this._itemParentVisible,this)},_updateMatrix:function(e){this._node.setMatrix(e)},_setVisible:function(e){var t=!!e.get("visible");this._poi&&(t?this._node.addChild(this._poi):this._node.removeChild(this._poi))},createPrimitive:function(e,t){var i,r=this,s=void 0,n=void 0;if(void 0!==this._poiSet.primInfos[e]){if(s=this._poiSet._factory,n=this._poiSet.primInfos[e],r=this._poiSet,void 0===t){var o=function(t){if(t.mesh3js){for(var i=t.mesh3js.userData.cgmIds,r=-1,s=0;s<i.length;++s)if(i[s]===e){r=s;break}if(r>-1)return 5*r+5}}.bind(this);t=this._poiSet._node.traverse(o)}}else void 0!==this._lineSet.primInfos[e]?(s=this._lineSet._factory,n=this._lineSet.primInfos[e],r=this._lineSet):void 0!==this._polygonSet.primInfos[e]&&(s=this._polygonSet._factory,n=this._polygonSet.primInfos[e],r=this._polygonSet);let a=!1;if(this._polygonSet._itemParent._attributes.children){let t=this._polygonSet._itemParent._attributes.children._models.filter(t=>t.get("name")===e);t&&t[0]&&(a=!0,(i=t[0].getContent()).setLayerVector(r),i.addSubElements(n))}var h;a||(s&&s.getGeoJSON&&(h=s.getGeoJSON(e)),(i=new u({strid:e,geojson:h,instanceId:t})).setLayerVector(r),i.create(this.getRoot()),i.addSubElements(n));return s&&(s.geometrySubsetId=r.id),i},register:function(e){},unregister:function(e){},redrawPrimitive:function(e){var t=this.getRendering();a.is(t)&&(t.isPrimitiveRegistered(e)?t._renderprimitive(e):this.registerPrimitive(e))},registerPrimitive:function(e){var t=this.getRendering();a.is(t)&&(t.isPrimitiveRegistered(e)||t.registerPrimitive(this._patch,e))},registerPrimitives:function(e){var t,i,r=Object.keys(e),s=r.length;for(t=0;t<s;t++)i=r[t],this.registerPrimitive(i)},addUserDataProperty:function(e,t,i){if(a.is(e)){var r=this.get("geojson"),s=r.features[0];if(a.is(i))for(var n=0;n<r.features.length;n++){var o=r.features[n];if(o&&o.properties&&o.properties.STRID===i){s=o;break}}s.properties||(s.properties={}),s.properties[e]=t;var h=this.get("userData");return h||(h={},this.set("userData",h)),h[e]=t,!0}return!1},removeUserDataProperty:function(e,t){if(a.is(e)){var i=this.get("geojson"),r=i.features[0];if(a.is(t))for(var s=0;s<i.features.length;s++){var n=i.features[s];if(n&&n.properties&&n.properties.STRID===t){r=n;break}}a.is(r.properties[e])&&delete r.properties[e];var o=this.get("userData");return a.is(o[e])&&delete o[e],!0}return!1},redraw:function(){var e=this.getRendering();a.is(e)&&(this._poiSet&&(this._poiSet.nbPoint>0||this._poiSet.nbMultiPoint>0)&&this._poiSet.redraw(),this._lineSet&&(this._lineSet.nbGeometry>0||this._lineSet.nbMultiGeometry>0)&&this._lineSet.redraw(),this._polygonSet&&(this._polygonSet.nbGeometry>0||this._polygonSet.nbMultiGeometry>0)&&this._polygonSet.redraw())},getRendering:function(){return this._rendering},highlight:function(){this._poiSet._node.traverse(function(e){if(void 0!==e.mesh3js&&"instance"===e.mesh3js.instancingSelectionMode){e.mesh3js.instancingSelectionMode="mesh";for(var t=0;t<e._occurrences.length;++t)e._occurrences[t].renderable.instancingSelectionMode="mesh"}})},unhighlight:function(){this._poiSet._node.traverse(function(e){if(void 0!==e.mesh3js&&"mesh"===e.mesh3js.instancingSelectionMode){e.mesh3js.instancingSelectionMode="instance";for(var t=0;t<e._occurrences.length;++t)e._occurrences[t].renderable.instancingSelectionMode="instance"}})},findPrimitivesByCriteria:function(e){var t=new _(e),i={};if(!a.is(t))return null;var r=function(e){return t.apply(e)};if(this._poiSet){this._poiSet._factory;for(var s in this._poiSet.primInfos){!0===(r(n=this._poiSet.primInfos[s].userData)||!1)&&(i[s]=n)}}if(this._lineSet){this._lineSet._factory;for(var s in this._lineSet.primInfos){!0===(r(n=this._lineSet.primInfos[s].userData)||!1)&&(i[s]=n)}}if(this._polygonSet){this._polygonSet._factory;for(var s in this._polygonSet.primInfos){var n;!0===(r(n=this._polygonSet.primInfos[s].userData)||!1)&&(i[s]=n)}}return i},setClustering:function(e){this._poiSet.nbBuiltTotal&&this._poiSet.nbBuiltTotal>0&&(this._poiSet.setClustering(e),this.set("Clustering",this._poiSet.get("Clustering")))},getLayerAttributes:function(){let e,t,i=this,r=function(){i._urban.generalWorkerSem.requestWorker().then(t=>(function(t){t.worker.onmessage=(r=>{i.analytics=r.data,t.release(),e(i.analytics)});let r=i._polygonSet._attributes.geojson,s=!1,n=!1;if(r.shpContent&&(s=!0),r.dbfContent&&(n=!0),s&&n){let e={function:"analytics",dbf:r.dbfContent.slice(0),shp:r.shpContent.slice(0)};t.worker.postMessage(e,[e.dbf,e.shp])}else{let e={function:"analytics",geojson:r.slice(0)};t.worker.postMessage(e,[e.geojson])}})(t))};return new Promise(function(s,n){e=s,t=n,i._polygonSet._attributes.geojson?i._urban.generalWorkerSem?i.analytics?e(i.analytics):a.requestIdleCallback(r,{timeout:100}):n("General worker not available"):n("Layer has no geojson attached")})},getLayerAttributesSync:function(){return this.analytics?this.analytics:(this.getLayerAttributes(),null)},getStatistics:function(e){let t,i,r=this,s=function(){r._urban.generalWorkerSem.requestWorker().then(i=>(function(i){i.worker.onmessage=(e=>{i.release(),t(e.data)});let s=r._polygonSet._attributes.geojson,n=!1,o=!1;if(s.shpContent&&(n=!0),s.dbfContent&&(o=!0),n&&o){let t={function:"stats",param:e,dbf:s.dbfContent.slice(0),shp:s.shpContent.slice(0)};i.worker.postMessage(t,[t.dbf,t.shp])}else{let t={function:"stats",param:e,geojson:s.slice(0)};i.worker.postMessage(t,[t.geojson])}})(i))};return new Promise(function(e,n){t=e,i=n,r._lineSet.isBuilt&&r._poiSet.isBuilt&&r._polygonSet.isBuilt?r._urban.generalWorkerSem?r.getLayerAttributes().then(()=>{a.requestIdleCallback(s,{timeout:100})}):n("General worker not available"):n("Layer is not built")})}});return r.ObjectContructor.GeometrySet=b});