define("DS/Materials/ShaderDynamicPrefixBuilder",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t=function(t){const i=e.MaterialToUse;switch(t){case i.originalMaterial:return"ORIGINAL_MATERIAL";case i.normalMaterial:return"NORMAL_MATERIAL";case i.depthMaterial:return"DEPTH_MATERIAL";case i.normalDepthIoRRoughnessMaterial:return"NORMAL_DEPTH_IOR_ROUGHNESS_MATERIAL";case i.shadowMapDepthMaterial:return"SHADOWMAP_MATERIAL";case i.highlightMaterial:return"HIGHLIGHT_MATERIAL";case i.pickingMaterial:return"PICKING_MATERIAL";case i.pickingMaterialInstancing:return"PICKING_INSTANCING_MATERIAL";case i.oitAccumMaterial:return"OIT_ACCUM_MATERIAL";case i.oitRevealMaterial:return"OIT_REVEAL_MATERIAL";case i.ZOnlyMaterial:return"ZONLY_MATERIAL";case i.depthRGBAMaterial:return"DEPTH_RGBA_MATERIAL";case i.decalNormalStencilDepthMaterial:return"DECAL_NORMAL_STENCIL_DEPTH_MATERIAL";case i.normalDepthMaterial:return"NORMAL_DEPTH_MATERIAL";case i.transparentShadowMaterial:return"TRANSPARENT_SHADOWMAP_MATERIAL";case i.texCoordMaterial:return"TEXTURE_COORDINATES_MATERIAL";default:throw"Invalid Material to use "+t}};function i(i){var a=e._isSelectionMaterial;return["#define "+t(i.materialToUse),a(i.materialToUse)?"#define SELECTION_MATERIAL":"",i.mobile?"#define MOBILE_MODE":"",i.mobileDevice?"#define MOBILE_DEVICE_MODE":"",i.noCompositing?"#define NO_COMPOSITING":"",i.mobileHL?"#define MOBILE_HIGHLIGHT_MODE":"",i.primitiveHighlight?"#define PRIMITIVE_HIGHLIGHT":"",i.adjacenceHighlight?"#define ADJACENCE_HIGHLIGHT":"",i.deferrable?"#define DEFERRABLE_MATERIAL":"",i.politeHighlight?"#define HIGHLIGHT_POLITE 1":"#define HIGHLIGHT_POLITE 0",i.noZObject?"#define NOZ_OBJECT":"",i.largeScale?"#define MODELVIEW_GPU":"#define MODELVIEW_CPU",i.useNormalMatrix?"#define USE_NORMAL_MATRIX":"",i.depthDebugMaterial?"#define DEBUG_DEPTH":"",i.normalDebugMaterial?"#define DEBUG_NORMAL":"",i.shadowMapDebugMaterial?"#define DEBUG_SHADOW":"",i.geomUVDebug?"#define DEBUG_GEOM_UVS":"",i.mappingUVDebug?"#define DEBUG_MAPPING_UVS":"",i.geomUV2Debug?"#define DEBUG_GEOM_UV2S":"",i.mappingUV2Debug?"#define DEBUG_MAPPING_UV2S":"","#define MAX_DIR_LIGHTS "+i.maxDirLights,"#define MAX_DIR_IBL_LIGHTS "+i.maxDirIBLLights,"#define MAX_DIR_PHONG_LIGHTS "+i.maxDirPhongLights,"#define MAX_POINT_LIGHTS "+i.maxPointLights,"#define MAX_SPOT_LIGHTS "+i.maxSpotLights,"#define MAX_SPHERE_LIGHTS "+i.maxSphereLights,"#define MAX_TUBE_LIGHTS "+i.maxTubeLights,"#define MAX_DISK_LIGHTS "+i.maxDiskLights,"#define MAX_AREA_LIGHTS "+i.maxAreaLights,"#define MAX_IES_LIGHTS "+i.maxIESLights,i.lightMap?"#define USE_LIGHTMAP":"","#define MAX_SHADOWS "+i.maxShadows,"#define MAX_SHADOWS_DIR "+i.maxDirShadows,"#define MAX_SHADOWS_DIR_IBL "+i.maxDirIBLShadows,"#define MAX_SHADOWS_SPOT "+i.maxSpotShadows,"#define MAX_SHADOWS_CUBE "+i.maxShadowsCube,i.shadowMapEnabled?"#define USE_SHADOWMAP":"","#define "+i.shadowMapTypeDefine,"#define "+i.shadowMapQualityDefine,i.shadowMapCubeEnabled?"#define USE_SHADOWMAP_CUBE":"",i.transparentShadowEnabled?"#define USE_TRANSPARENTSHADOWMAP":"",i.uintESM?"#define USE_UINT_ESM":"",i.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",i.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",i.useUV?"#define NEEDS_UVTOUSE":"",0==i.mappingUseFragment?"#define USE_MAPPING_OPERATOR_VERTEX":"",1==i.mappingUseFragment?"#define USE_MAPPING_OPERATOR_FRAGMENT":"",i.mappingType>-1?"#define MAPPING_OPERATOR":"",i.needTangentBinormal?"#define USE_TANGENT_BINORMAL":"",i.clipPlanesEnabled?"#define USE_CLIPPINGPLANES":"",i.fogViewMode?"#define USE_BACKGROUNDVIEWMODE_FOG":"",i.lowlightViewMode?"#define USE_BACKGROUNDVIEWMODE_LOWLIGHT":"",i.perPixel?"#define PHONG_PER_PIXEL":"",i.wrapAround?"#define WRAP_AROUND":"",(i.doubleSided,"#define DOUBLE_SIDED"),i.flipSided?"#define FLIP_SIDED":"",i.vertexColors||i.objectVertexColors?"#define USE_COLOR":"",i.objectVertexColors?"#define USE_OBJECT_COLOR":"",i.allowObjectVertexColors?"#define ALLOW_OBJECT_COLOR":"",i.gpuTangentBinormal?"#define GPU_TANGENT_BINORMAL":"",i.specgloss?"#define SPECGLOSS":"",i.specglossNRE?"#define SPECGLOSS_NRE":"",i.dspbr?"#define DSPBR":"",i.dspbr19x?"#define DSPBR19x":"",i.dspbr21x?"#define DSPBR21x":"",i.dspbr22x?"#define DSPBR22x":"",i.dspbr23x?"#define DSPBR23x":"",i.NRECompatibility?"#define NRE_COMPATIBILITY":"",i.fromGLTF?"#define PBR_FROM_GLTF "+i.fromGLTF:"",i.isDecal?"#define DECAL":"",i.useOIT?"#define USE_OIT":"",i.PDSFX?"#define PDSFX":"",i.pdsfxUseMap?"#define PDSFX_USE_MAP":"",i.refractionRatioMap?"#define USE_REFRACTIONRATIOMAP":"",i.newSslr?"#define USE_NEWSSLR":"",i.sslrefractionEnabled?"#define SSLREFRACTION_ENABLED":"",i.sslreflectionEnabled?"#define SSLREFLECTION_ENABLED":"",i.isMultiInstanced?"#define IS_MULTI_INSTANCED":"",i._definePickingInstancing?"#define PICKING_INSTANCING":"",i.specialPickingInstancing?"#define SPECIAL_PICKING_INSTANCING":"",i.envMap?"#define USE_ENVMAP":"",1===i.envMapping?"#define USE_LIGHTPROBEMAP":"",2===i.envMapping?"#define USE_LATLONGMAP":"",i.useFiniteEnvMap?"#define USE_FINITE_ENVMAP":"",i.reflectionProbes?"#define USE_REFLECTION_PROBE":"",i.dashedLine?"#define USE_DASHEDLINE":"",i.cpuPattern?"#define CPU_PATTERN":"",i.worldSizePattern?"#define WORLD_SIZE_PATTERN":"",i.invertedPattern?"#define DASHEDLINE_INVERTED":"",i.patternSize?"#define PATTERN_LENGTH "+i.patternSize:"",i.wideLine?"#define USE_WIDELINE":"",i.wideLine&&i.polygonBorderMode?"#define USE_POLYGON_BORDER_MODE":"",i.wideLine&&i.linejoin?"#define USE_"+i.linejoin.toUpperCase()+"JOIN":"",i.wideLine&&i.linecap?"#define USE_"+i.linecap.toUpperCase()+"CAP":""].join("\n")}return{_FragmentPrefixBuilder:function(t){return e.SplitTrimStickString([i(t),t.alphaTest?"#define ALPHATEST "+t.alphaTest.toFixed(5):"",t.discardOrOpaque?"#define DISCARD_OR_OPAQUE":"",t.inlinedPostProActivated?"#define INLINED_POSTPROCESS":"",6==t.inlinedPostProTonemapping?"#define TONEMAP_PHOTOGRAPHIC":"",t.useLighting?"#define USE_LIGHTING":"",t.reflectivityEnvMap?"#define REFLECTIVITY_ENVMAP":"",1===t.lightMapMode?"#define LIGHTMAP_IRRADIANCE_MODE":"",t.lightMapLinear?"#define USE_LIGHTMAP_LINEAR":"",t.phongFirstDir?"#define PHONG_FIRST_DIR_ONLY":"",void 0!==t.textureBlending?"#define TEXTURE_BLENDING "+t.textureBlending:"",t.map?"#define TEXTURE_FORMAT "+t.textureFormat.format:"#define TEXTURE_FORMAT 0",t.bumpMap?"#define USE_BUMPMAP":"",t.bumpMap&&t.bumpScaleMap?"#define USE_BUMPSCALEMAP":"",t.bumpMap&&t.bumpScaleMulCoef&&t.bumpScaleAddCoef?"#define USE_BUMPSCALE_COEFFICIENTS":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMap&&t.normalMulCoef&&t.normalAddCoef?"#define USE_NORMAL_COEFFICIENTS":"",t.normalMapFlipY?"#define NORMALFLIPY":"",t.normalMap&&t.normalScaleMap?"#define USE_NORMALSCALEMAP":"",t.normalMap&&t.normalScaleMulCoef&&t.normalScaleAddCoef?"#define USE_NORMALSCALE_COEFFICIENTS":"",t.map?"#define USE_MAP":"",t.mapHDR?"#define USE_MAP_HDR":"",t.diffuseMulCoef&&t.diffuseAddCoef?"#define USE_DIFFUSE_COEFFICIENTS":"",t.diffuseBorderColorU?"#define USE_DIFFUSEMAP_BORDER_COLOR_U":"",t.diffuseBorderColorV?"#define USE_DIFFUSEMAP_BORDER_COLOR_V":"",t.useAlphaFromDiffuseMap?"#define USE_ALPHA_FROM_MAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularMulCoef&&t.specularAddCoef?"#define USE_SPECULAR_COEFFICIENTS":"",t.specularMapLinear?"#define SPECULAR_LINEAR":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.metalnessMulCoef&&t.metalnessAddCoef?"#define USE_METALNESS_COEFFICIENTS":"",t.specularContribMap?"#define USE_SPECULARCONTRIBMAP":"",t.specularContribMulCoef&&t.specularContribAddCoef?"#define USE_SPECULARCONTRIB_COEFFICIENTS":"",t.emissionColorMap?"#define USE_EMISSIONCOLORMAP":"",t.emissionColorMulCoef&&t.emissionColorAddCoef?"#define USE_EMISSIONCOLOR_COEFFICIENTS":"",t.emissionNormalized?"#define USE_NORMALIZED_EMISSION":"",t.emissionColorMapLinear?"#define EMISSION_LINEAR":"",t.transparencyMap?"#define USE_TRANSPARENCYMAP":"",t.transparencyMulCoef&&t.transparencyAddCoef?"#define USE_TRANSPARENCY_COEFFICIENTS":"",t.opacityMap?"#define USE_OPACITYMAP":"",t.opacityBorderColorU?"#define USE_OPACITYMAP_BORDER_COLOR_U":"",t.opacityBorderColorV?"#define USE_OPACITYMAP_BORDER_COLOR_V":"",t.opacityMulCoef&&t.opacityAddCoef?"#define USE_OPACITY_COEFFICIENTS":"",t.translucencyMap?"#define USE_TRANSLUCENCYMAP":"",t.translucencyMulCoef&&t.translucencyAddCoef?"#define USE_TRANSLUCENCY_COEFFICIENTS":"",t.translucencyColorMap?"#define USE_TRANSLUCENCY_COLOR_MAP":"",t.translucencyColorMapLinear?"#define TRANSLUCENCY_COLOR_LINEAR":"",t.translucencyColorMulCoef&&t.translucencyColorAddCoef?"#define USE_TRANSLUCENCY_COLOR_COEFFICIENTS":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.glossinessMap?"#define USE_GLOSSINESSMAP":"",t.roughnessMulCoef&&t.roughnessAddCoef?"#define USE_ROUGHNESS_COEFFICIENTS":"",t.glossinessMulCoef&&t.glossinessAddCoef?"#define USE_GLOSSINESS_COEFFICIENTS":"",t.anisotropy?"#define USE_ANISOTROPY":"",t.anisotropyMap?"#define USE_ANISOTROPYMAP":"",t.anisotropyMulCoef&&t.anisotropyAddCoef?"#define USE_ANISOTROPY_COEFFICIENTS":"",t.anisotropyAngleMap?"#define USE_ANISOTROPYANGLEMAP":"",t.anisotropyAngleMulCoef&&t.anisotropyAngleAddCoef?"#define USE_ANISOTROPYANGLE_COEFFICIENTS":"",t.sheen?"#define USE_SHEEN":"",t.sheenMap?"#define USE_SHEEN_MAP":"",t.sheenMulCoef&&t.sheenAddCoef?"#define USE_SHEEN_COEFFICIENTS":"",t.sheenColorMap?"#define USE_SHEEN_COLOR_MAP":"",t.sheenColorMulCoef&&t.sheenColorAddCoef?"#define USE_SHEEN_COLOR_COEFFICIENTS":"",t.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESS_MAP":"",t.sheenRoughnessMulCoef&&t.sheenRoughnessAddCoef?"#define USE_SHEEN_ROUGHNESS_COEFFICIENTS":"",t.sheenMode?"#define "+t.sheenMode:"",t.sheenColorMapLinear?"#define SHEEN_COLOR_LINEAR":"",t.specGlossFlakes?"#define USE_SPECGLOSS_FLAKES":"",t.dspbrFlakes?"#define USE_DSPBR_FLAKES":"",t.specGlossFlakes&&t.flakesMode<2?"#define ADVANCED_FLAKES_BLENDING":"",t.specGlossFlakes&&t.flakesMode<2?"#define ADVANCED_PRESENCE_NOISE":"",t.specGlossFlakes&&t.flakesMode<1?"#define FLAKES_NORMAL_PERTURBATION":"",t.specGlossFlakes&&t.flakesMode<1?"#define PEARL_FLAKES_ACTIVATED":"",t.dspbrFlakes&&0===t.flakesMode?"#define DSPBR_FLAKES_FULL_GRID":"",t.dspbrFlakes&&t.flakesMode<=1?"#define DSPBR_FLAKES_THREE_LAYERS":"",t.dspbrFlakes&&2===t.flakesMode?"#define DSPBR_FLAKES_TWO_LAYERS":"",t.dspbrFlakes&&3===t.flakesMode?"#define DSPBR_FLAKES_ONE_LAYER":"",t.flakesCoverageMap?"#define USE_FLAKESCOVERAGE_MAP":"",t.flakesCoverageMulCoef&&t.flakesCoverageAddCoef?"#define USE_FLAKESCOVERAGE_COEFFICIENTS":"",t.flakesRoughnessMap?"#define USE_FLAKESROUGHNESS_MAP":"",t.flakesRoughnessMulCoef&&t.flakesRoughnessAddCoef?"#define USE_FLAKESROUGHNESS_COEFFICIENTS":"",t.flakesColorMap?"#define USE_FLAKESCOLOR_MAP":"",t.flakesColorMulCoef&&t.flakesColorAddCoef?"#define USE_FLAKESCOLOR_COEFFICIENTS":"",t.flakesSizeMap?"#define USE_FLAKESSIZE_MAP":"",t.flakesSizeMulCoef&&t.flakesSizeAddCoef?"#define USE_FLAKESSIZE_COEFFICIENTS":"",t.flakesColorMapLinear?"#define FLAKES_LINEAR":"",t.flipFlop?"#define USE_FLIPFLOP":"",t.flipFlopColorMap?"#define USE_FLIPFLOP_COLOR_MAP":"",t.flipFlopColorMulCoef&&t.flipFlopColorAddCoef?"#define USE_FLIPFLOP_COLOR_COEFFICIENTS":"",t.flipFlopColorMapLinear?"#define FLIPFLOP_COLOR_LINEAR":"",t.flipFlopMap?"#define USE_FLIPFLOP_MAP":"",t.flipFlopMulCoef&&t.flipFlopAddCoef?"#define USE_FLIPFLOP_COEFFICIENTS":"",t.clearCoat?"#define CLEAR_COAT":"",t.clearCoatMap?"#define CLEAR_COAT_MAP":"",t.clearCoatMulCoef&&t.clearCoatAddCoef?"#define USE_CC_COEFFICIENTS":"",t.clearCoatColorMap?"#define CLEAR_COAT_COLORMAP":"",t.clearCoatColorMulCoef&&t.clearCoatColorAddCoef?"#define USE_CC_COLOR_COEFFICIENTS":"",t.clearCoatNormalMap?"#define CLEAR_COAT_NORMALMAP":"",(t.clearCoatNormalMap||t.orangePeel)&&t.clearCoatNormalMulCoef&&t.clearCoatNormalAddCoef?"#define USE_CC_NORMAL_COEFFICIENTS":"",t.clearCoatNormalMapFlipY?"#define CLEAR_COAT_NORMALMAPFLIPY":"",t.clearCoatRoughnessMap?"#define USE_CC_ROUGHNESSMAP":"",t.coatingGlossinessMap?"#define USE_CC_GLOSSINESSMAP":"",t.coatingGlossinessMulCoef&&t.coatingGlossinessAddCoef?"#define USE_CC_GLOSSINESS_COEFFICIENTS":"",t.clearCoatRoughnessMulCoef&&t.clearCoatRoughnessAddCoef?"#define USE_CC_ROUGHNESS_COEFFICIENTS":"",t.orangePeel?"#define USE_ORANGE_PEEL":"",t.clearCoatColorMapLinear?"#define CLEARCOAT_LINEAR":"",t.subsurface?"#define USE_SUBSURFACE":"",t.sssLUT?"#define USE_SSSLUT":"",t.thickness?"#define USE_THICKNESS":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.thicknessAddCoef&&t.thicknessMulCoef?"#define USE_THICKNESS_COEFFICIENTS":"",t.envMapSheen?"#define USE_ENVMAP_SHEEN":"",t.envMapDiffuse?"#define USE_ENVMAP_DIFFUSE":"",t.envMapHDR?"#define USE_ENVMAP_HDR":"",t.envMapRGBHDR?"#define USE_ENVMAP_RGB_HDR":"",t.envMapRGBsRGB?"#define USE_ENVMAP_RGB_SRGB":"",t.thinWalled?"#define THIN_WALLED":"",t.iridescence?"#define USE_IRIDESCENCE":"",t.iridescenceMap?"#define USE_IRIDESCENCE_MAP":"",t.iridescenceAddCoef&&t.iridescenceMulCoef?"#define USE_IRIDESCENCE_COEFFICIENTS":"",t.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESS_MAP":"",t.iridescenceThicknessAddCoef&&t.iridescenceThicknessMulCoef?"#define USE_IRIDESCENCE_THICKNESS_COEFFICIENTS":"",t.instancingMeshSelectionMode?"#define INSTANCING_MESH_SELECTION":"",t.skipTranspar?"#define SKIP_TRANSPARENT":"",t.isFromGAS?"#define PBR_FROM_GAS":"",t.metal?"#define METAL":""].join("\n"))},_VertexPrefixBuilder:function(t){return e.SplitTrimStickString([i(t),t.morphTargets?"#define USE_MORPHTARGETS":"",t.morphNormals?"#define USE_MORPHNORMALS":"",t.fixedSize?"#define FIXED_SIZE":"",t.fixedSizeCenter?"#define FIXED_SIZE_CENTER":"",t.billboard?"#define BILLBOARD":"",t.skinning?"#define USE_SKINNING":"",t.useEulerAngles?"#define USE_SKINNING_ANGLES":"",t.skinningMapWidth&&!t.isMultiInstanced?"#define N_BONE_PIXEL_X "+t.skinningMapWidth.toFixed(1):"",t.skinningMapHeight&&!t.isMultiInstanced?"#define N_BONE_PIXEL_Y "+t.skinningMapHeight.toFixed(1):"",t.skinningInstancingMapsInfo&&t.isMultiInstanced?"#define NB_INSTANCING_SKIN_MAPS "+t.skinningInstancingMapsInfo.nbTextures+"\n#define NB_BONES "+t.skinningInstancingMapsInfo.nbBones.toFixed(1)+"\n#define MAX_MAP_SIZE "+t.skinningInstancingMapsInfo.maxTextureSize.toFixed(1)+"\n#define LAST_INSTANCING_SKIN_MAP_SIZE_X "+t.skinningInstancingMapsInfo.lastTextureSizeX.toFixed(1)+"\n#define LAST_INSTANCING_SKIN_MAP_SIZE_Y "+t.skinningInstancingMapsInfo.lastTextureSizeY.toFixed(1)+"\n":"",t.sizeAttenuation?"#define USE_SIZEATTENUATION":"",t.map?"#define USE_MAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.glossinessMap?"#define USE_GLOSSINESSMAP":"",t.anisotropy?"#define USE_ANISOTROPY":"",t.anisotropyMap?"#define USE_ANISOTROPYMAP":"",t.anisotropyAngleMap?"#define USE_ANISOTROPYANGLEMAP":"",t.anisotropy?"#define USE_TANGENT_BINORMAL":"",t.displacementMap?"#define USE_DISPLACEMENTMAP":"",t.displacementMap&&t.displacementAddCoef&&t.displacementMulCoef?"#define USE_DISPLACEMENT_COEFFICIENTS":"",t.dspbrFlakes?"#define USE_DSPBR_FLAKES":"",t.specGlossFlakes?"#define USE_SPECGLOSS_FLAKES":"",t.orangePeel?"#define USE_ORANGE_PEEL":"",t.subsurface?"#define USE_SUBSURFACE":"",t.compressedVertices?"#define COMPRESSED_VERTICES":"",t.compressedNormals?"#define COMPRESSED_NORMALS":"",t.compressedUVs?"#define COMPRESSED_UVS":"",t.compressedColors?"#define COMPRESSED_COLORS":""].join("\n"))}}}),define("DS/Materials/DeferredCaches",["DS/Mesh/ThreeJS_Base","WebappsUtils/WebappsUtils"],function(e,t){"use strict";var i=new Map,a=new Map,s=new Map,r=new Map,n=new Map,o=new Map,l=new Map,h=t.getWebappsAssetUrl("Visualization","")+"textures/predefinedMaterials/",p=[],d=function(e){this.material=e,this.usedBy=new Set};d.prototype.get=function(e){return this.usedBy.add(e.id),this.material};return{_loadPredefinedMaterialTextures:function(t,i,a){if(p.length>0||a)return p;p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_Brass_Albedo.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_Brass_roughness.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_BrushedSteel_Albedo.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_BrushedSteel_Anisotropy.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),p.push(e.ImageUtils.loadTexture(h+"Appearance_BrushedSteel_Normal.png",void 0,i,null,!0,!1,t)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_BrushedSteel_Roughness.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_CastAluminum_Albedo.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),p.push(e.ImageUtils.loadTexture(h+"Appearance_CastAluminum_Normal.png",void 0,i,null,!0,!1,t)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_CastAluminum_Roughness.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_CastSteel_Albedo.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_CastSteel_Roughness.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_Copper_Albedo.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),p.push(e.ImageUtils.loadTexture(h+"Appearance_Copper_Normal.png",void 0,i,null,!0,!1,t)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_Copper_Roughness.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_MachinedAluminum_Albedo.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),p.push(e.ImageUtils.loadTexture(h+"Appearance_MachinedAluminum_Normal.png",void 0,i,null,!0,!1,t)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_MachinedAluminum_Roughness.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_MachinedStainlessSteel_Albedo.basis",void 0,i,null,!0,e.BasisUsage.RGB,t)),p.push(e.ImageUtils.loadTexture(h+"Appearance_MachinedStainlessSteel_Normal.png",void 0,i,null,!0,!1,t)),p.push(e.ImageUtils.loadBasisTexture(h+"Appearance_MachinedStainlessSteel_Roughness.basis",void 0,i,null,!0,e.BasisUsage.RGB,t));for(var s=0;s<p.length;s++)p[s].wrapS=e.RepeatWrapping,p[s].wrapT=e.RepeatWrapping,p[s].flipY=!1;return p},DeferredMaterial:d,DefaultNormalDepthMaterials:i,DefaultShadowDepthMaterials:a,DefaultPickingMaterials:s,DefaultHighlightMaterials:r,DefaultMaterials:n,PredefinedMaterials:o,GeomTypeMaterials:l}}),define("DS/Materials/PDSFXData",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t=[/(\W+)modelViewMatrix(\W+)/,/(\W+)viewMatrix(\W+)/,/(\W+)projectionMatrix(\W+)/],i=["modelViewMatrix","viewMatrix","projectionMatrix"],a=["vGetWorldViewMatrix()","vGetViewMatrix()","vGetProjectionMatrix()"],s=function(e){for(var s=i.length,r="",n=0;n<s;n++){e.search(t[n])>=0&&(r||(r=['BAD PDSFX USAGE!!!: DO NOT USE THE "'+i[n]+'" token in your overridden function!',"This is henceforth an internal PRIVATE variable. Use the following appropriate PDSFX getter function: "+a[n],"Please take time to correct your PDSFX materials by using the getters/setters provided by the API."].join("\n")),console.warn(r))}},r=function(){this.PDSFX=!1,this.PDSFX_OverridableFunctions_VS={},this.PDSFX_OverridableFunctions_FS={},this.pdsfxUniformsCode={common:"",vertex:"",fragment:""},this.pdsfxUniforms=null,this._pdsfxUniformsList=null,this.pdsfxVaryingsCode="",this.pdsfxGlobalVariablesCode_VS="",this.pdsfxGlobalVariablesCode_FS="",this.pdsfxAttributesCode="",this.PDSFX_hasAlbedo=!1,this.PDSFX_hasOpacity=!1,this.PDSFX_hasHalfWidth=!1,this.PDSFX_hasEmissive=!1,this.PDSFX_hasSpecular=!1,this.pdsfxUseMap=!1,this.CPULargeScale=!1};return r.prototype.clone=function(){var t=new r;return t.PDSFX=!0,t.PDSFX_OverridableFunctions_VS=this.PDSFX_OverridableFunctions_VS,t.PDSFX_OverridableFunctions_FS=this.PDSFX_OverridableFunctions_FS,this.pdsfxUniformsCode&&(t.pdsfxUniformsCode=this.pdsfxUniformsCode),this.pdsfxUniforms&&(t.pdsfxUniforms=e.UniformsUtils.clone(this.pdsfxUniforms)),this.pdsfxVaryingsCode&&(t.pdsfxVaryingsCode=this.pdsfxVaryingsCode),this.pdsfxGlobalVariablesCode_VS&&(t.pdsfxGlobalVariablesCode_VS=this.pdsfxGlobalVariablesCode_VS),this.pdsfxGlobalVariablesCode_FS&&(t.pdsfxGlobalVariablesCode_FS=this.pdsfxGlobalVariablesCode_FS),this.pdsfxAttributesCode&&(t.pdsfxAttributesCode=this.pdsfxAttributesCode),this.PDSFX_hasAlbedo&&(t.PDSFX_hasAlbedo=!0),this.PDSFX_hasOpacity&&(t.PDSFX_hasOpacity=!0),this.PDSFX_hasHalfWidth&&(t.PDSFX_hasHalfWidth=!0),this.PDSFX_hasEmissive&&(t.PDSFX_hasEmissive=!0),this.PDSFX_hasSpecular&&(t.PDSFX_hasSpecular=!0),this.pdsfxUseMap&&(t.pdsfxUseMap=!0),t.CPULargeScale=this.CPULargeScale,t._setUniformsList(),t},r.prototype._setUniformsList=function(){if(this.pdsfxUniforms)for(var e in this._pdsfxUniformsList=new Map,this.pdsfxUniforms)this._pdsfxUniformsList.set(e,this.pdsfxUniforms[e])},r.prototype._setPDSFXOverridableFunctions=function(e,t){var i;for(i in e)this.PDSFX_OverridableFunctions_VS[i]&&e[i]&&(s(e[i]),this.PDSFX_OverridableFunctions_VS[i]=e[i]);for(i in t)this.PDSFX_OverridableFunctions_FS[i]&&t[i]&&(s(t[i]),this.PDSFX_OverridableFunctions_FS[i]=t[i])},r}),define("DS/Materials/WebGLProgramManager",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t=function(e,t){this.program=e,this.shaderVersion=t};t.prototype.disposeProgram=function(e,t){e(t,this.program.program,!1)};var i,a=function(){this.programs=new Map};a.prototype.disposeAllPrograms=function(e,t){this.programs.forEach(function(i,a,s){i.disposeProgram(e,t)}),this.programs.clear()};var s=function(){this.renderers=new Array(i);for(var e=0;e<i;e++)this.renderers[e]=new Map};s.prototype.getActive=function(e,t){var i=this.renderers[t];return i.has(e)||i.set(e,new a),i.get(e)},s.prototype.disposeAllPrograms=function(e,t){for(var i=0;i<this.renderers.length;i++){var a=this.renderers[i];a.forEach(function(i,a,s){i.disposeAllPrograms(e,t)}),a.clear()}},s.prototype.disposeAllRendererPrograms=function(e,t,i){for(var a=0;a<this.renderers.length;a++){var s=this.renderers[a];s.has(i)&&(s.get(i).disposeAllPrograms(e,t),s.delete(i))}};var r=function(t){i=e.RendererMode._count,this.material=t,this.programPools=new Map,this.activeProgramPool=null,this.currentContextId=-1,this.currentRendererId=-1,this.currentRendererMode=-1};r.prototype.setActive=function(e,t,i){this.programPools.has(e)||this.programPools.set(e,new s),this.activeProgramPool=this.programPools.get(e).getActive(t,i).programs,this.currentContextId=e,this.currentRendererId=t,this.currentRendererMode=i},r.prototype.getProgram=function(e,t,i){var a=this.activeProgramPool.get(e);return a?a.shaderVersion!==t?(this.disposeCurrentProgram(i,e),null):a.program:null},r.prototype.addProgram=function(e,i,a){this.activeProgramPool.set(e,new t(i,a))},r.prototype.disposeAllPrograms=function(e){var t=this;this.programPools.forEach(function(i,a,s){i.disposeAllPrograms(e,t.material)}),this.programPools.clear(),this.activeProgramPool=null,this.currentContextId=-1,this.currentRendererId=-1,this.currentRendererMode=-1},r.prototype.disposeAllRendererPrograms=function(e,t,i){this.programPools.has(t)&&this.programPools.get(t).disposeAllRendererPrograms(e,this.material,i)},r.prototype.disposeCurrentProgram=function(e,t){if(this.activeProgramPool.has(t)){var i=this.activeProgramPool.get(t);this.activeProgramPool.delete(t),e(this.material,i.program,!1)}};Math.pow(2,31);return r.prototype.getProgramID=function(e,t,i){var a=e?e._programID:0,s=t?t._programID:0;return i+(a|this.material._programID|s)},r.prototype.getTokenProgramID=function(e,t){return t+((e?e._programID:0)|this.material._programID)},r}),define("DS/Materials/Material",["DS/Mesh/ThreeJS_Base","DS/Materials/WebGLProgramManager","DS/Materials/DeferredCaches","DS/CoreEvents/Events"],function(e,t,i,a){"use strict";var s=0,r=new e.Matrix3,n=new e.Matrix4;const o=new Set;o.add("programManager"),o.add("program"),o.add("_displayRangeLists"),o.add("_PDSFXData"),o.add("_deferredMaterials"),o.add("_deferredMaterialsInit"),o.add("_dspbrFlakes"),o.add("_specGlossFlakes"),o.add("_clearCoat"),o.add("_volume"),o.add("_sheenData"),o.add("_sheen"),o.add("_anisotropy"),o.add("_displacement"),o.add("_iridescence"),o.add("_thickness"),o.add("_fromGLTF"),o.add("__physicalMode");var l=function(){e.EventDispatcher.call(this),this._usePhongLighting=!1,this.id=s++,this._sceneGraphOrderMode=0,this.name="",this._useCount=0,this._source=e.AssetSource.MANUAL,this._side=e.Constants.FrontSide,this.forceSide=!1,this._opacity=1,this._transparent=!1,this.blending=e.NormalBlending,this.blendSrc=e.SrcAlphaFactor,this.blendDst=e.OneMinusSrcAlphaFactor,this.blendEquation=e.AddEquation,this.depthTest=!0,this.depthFunc=null,this.depthWrite=!0,this.colorWrite=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.vertexColors=e.VertexColorType.NoColors,this.polite=!1,this.politeMaterial=null,this.useGASColor=!1,this.useGASOpacity=!1,this._alphaTest=0,this.alphaTestMode=e.AlphaTestMode.DISCARD,this._visible=!0,this.enableClipPlanes=!0,this.clipPlaneIndex=0,this.clipPlaneUseModelMaterial=null,this.mappingType=-1,this.mappingTransformSemantic=1,this.mappingObjTransformation=n,this.mappingNormTransformation=r,this.mappingUVTransformation=r,this.mappingUseFragment=!1,this.needsUpdate=!0,this.overridable=!0,this._forceAllowFullMaterialOverride=!1,this.force=!1,this.context=null,this.backMaterial=null,this.isBackMaterial=!1,this.isOIT=!1,this.useBlending=!1,this.previousOccurrenceRenderingOverride=null,this._programID=0,this.uniforms=null,this.vertexShader=null,this.fragmentShader=null,this.program=null,this.programManager=new t(this),this.shaderID=0,this.attributes=null,this._definePickingInstancing=!1,this.isInstancingMaterial=!1,this.enableReceiveShadowOnCapping=!1,this._renderedClipPlane=null,this.line=null,this.point=null,this._allowObjectColor=!1,this._PDSFXData=null,this.isWideLine=!1,this.isDashedLine=!1,this.is2DLine=!1,this.isCPUPattern=!1,this.refreshUniforms=function(e,t,i){},this._refreshPDSFXUniforms_private=function(e,t,i){this.refreshPDSFXUniforms&&this.refreshPDSFXUniforms()},this.refreshPDSFXUniforms=function(){},this._displayRangeLists=new Map,this._deferredMaterialsInit=!1,this._deferredMaterials=[];for(var i=0;i<e.MaterialToUse.totalMaterial;i++)this._deferredMaterials[i]=null;this._deferredMaterials[e.MaterialToUse.originalMaterial]=this,this._loadingTextures=null};l.prototype.isPDSFX=function(){return!!this._PDSFXData&&this._PDSFXData.PDSFX},l.prototype._needsUpdateIfTexturesAreReady=function(){var t=this;if(this.needsUpdate)for(var i=this._getTextures(!1),a=0;a<i.length;a++){var s=i[a];s&&s.onLoadCallbacks&&s.loadEndStatus!==e.AssetLoadingStatus.READY&&s.loadEndStatus!==e.AssetLoadingStatus.INIT&&(this._loadingTextures||(this._loadingTextures=new Set),this._loadingTextures.has(s)||(this._loadingTextures.add(s),s.onLoadCallbacks.push(function(){t._sendEvent("requestVisuUpdate")}),s.onRequest&&s.onRequest()))}if(this._loadingTextures){var r=!0;this._loadingTextures.forEach(function(t){r=r&&(t.loadEndStatus===e.AssetLoadingStatus.READY||t.loadEndStatus===e.AssetLoadingStatus.INIT||t.loadEndStatus===e.AssetLoadingStatus.ERROR),t.onRequest&&t.onRequest()}),r&&(this._loadingTextures=null,this.needsUpdate=!0)}},l.prototype._isTextureAvailable=function(t){return!!this[t]&&(this[t].loadEndStatus===e.AssetLoadingStatus.READY||this[t].loadEndStatus===e.AssetLoadingStatus.INIT)},l.prototype.requireTangentBinormal=function(){return!1},l.prototype.requireVertexTangentBinormal=function(){return!1},l.prototype.deferrable=!1,l.prototype.isPhysicalMaterial=!1,l.prototype._autoForceSide=!1,l.prototype._setMaterialShaderOptions=function(e,t,i,a,s,r){var n={};(t||i||a)&&Object.assign(n,{normalMap:this._isTextureAvailable("normalMap"),normalMapFlipY:!!this.normalMapFlipY,bumpMap:this._isTextureAvailable("bumpMap")}),Object.assign(e,n)},l.prototype._dump=function(){return{type:this.getType(),pdsfx:this.isPDSFX(),opacity:this.opacityMap?"texture":this._opacity,useGASColor:this.useGASColor}},l.prototype._getTextures=function(e){return[]},l.prototype._transparencyOnGPU=function(t){if(this.isPDSFX()||this.alphaTest>0)return!0;var i=!1;return t&&t._vertexColors>0?i=this._allowObjectColor&&((t._vertexColors&e.VertexColorType.A)>0||t._vertexColors<=e.VertexColorType.RGBA):this.vertexColors>0&&(i=(this.vertexColors&e.VertexColorType.A)>0||this.vertexColors<=e.VertexColorType.RGBA),i},l.prototype._isTransparent=function(e){return this._transparent||this._opacity<1||this._transparencyOnGPU(e)},l.prototype._loadTextureInfo=function(e,t,i,a,s,r){},l.prototype._loadMappingInfo=function(e,t,i,a){if(a.mappingType){var s=e.mappingNormTransformation;i.uniformMatrix3fv(a.mappingNormTransformation,!1,t.float32Matrix3x3Temp.setDoubles(s.elements)),s=e.mappingUVTransformation,i.uniformMatrix3fv(a.mappingUVTransformation,!1,t.float32Matrix3x3Temp.setDoubles(s.elements)),s=e.mappingObjTransformation,i.uniformMatrix4fv(a.mappingObjTransformation,!1,t.float32Matrix4x4Temp.setDoubles(s.elements)),i.uniform1i(a.mappingType,e.mappingType),i.uniform1i(a.mappingTransformSemantic,e.mappingTransformSemantic)}},l.prototype._computeAmbianceKeyAndProcessMaterial=function(){return this._needsUpdateIfTexturesAreReady(),0},Object.defineProperty(l.prototype,"opacity",{set:function(e){this.setOpacity(e)},get:function(){return this._opacity}}),Object.defineProperty(l.prototype,"alphaTest",{set:function(e){this.setAlphaTest(e)},get:function(){return this._alphaTest}}),Object.defineProperty(l.prototype,"transparent",{set:function(e){e!==this._transparent&&this._invalidateDisplayRangeLists(),this._transparent=e},get:function(){return this._transparent}}),Object.defineProperty(l.prototype,"side",{set:function(e){this._side!==e&&this._invalidateDisplayRangeLists(),this._side=e},get:function(){return this._side}}),Object.defineProperty(l.prototype,"visible",{set:function(e){this._visible!==e&&this._invalidateDisplayRangeLists(),this._visible=e},get:function(){return this._visible}}),Object.defineProperty(l.prototype,"PDSFX_OverridableFunctions_FS",{get:function(){return this._PDSFXData?this._PDSFXData.PDSFX_OverridableFunctions_FS:null}}),Object.defineProperty(l.prototype,"pdsfxUniforms",{get:function(){return console.warn("Do not access the 'pdsfxUniforms' property! Use one of these API functions instead: Material.getPDSFXUniform, Material.setPDSFXUniforms, or Material.updatePDSFXUniform."),this._PDSFXData?this._PDSFXData.pdsfxUniforms:null}}),Object.defineProperty(l.prototype,"PDSFX",{get:function(){return console.warn("Please call the Material.isPDSFX function instead."),this.isPDSFX()}}),l.prototype._invalidateDisplayRangeLists=function(){this._displayRangeLists.forEach(function(e,t){e.flagObjectsAsGSSOInvalidated()})},l.prototype._notifyDLtoBeSortedNextFrame=function(){this._displayRangeLists.forEach(function(e,t){e.dl._sortByProgramNextFrame=!0})},l.prototype.setPDSFXUniforms=function(t){if(this._PDSFXData&&this._PDSFXData.PDSFX){var i=!1,a=0,s=this._PDSFXData.pdsfxUniformsCode,r=null;for(var n in t)if(r=e.ToGLSLTypes[t[n].type]){r.isTexture&&(this._PDSFXData.pdsfxUseMap=!0),i=r.isArray;var o=r.isInt?t[n].stage===e.FragmentStage?"fragment":"vertex":"common";i?t[n].length>0&&(a=t[n].length,s[o]+="uniform "+r.t+" "+n+"["+a+"];\n"):s[o]+="uniform "+r.t+" "+n+";\n"}this._PDSFXData.pdsfxUniforms=t,this._PDSFXData._setUniformsList(),this.needsUpdate=!0}},l.prototype.updatePDSFXUniform=function(e,t){this._PDSFXData&&this._PDSFXData.PDSFX&&void 0!==this._PDSFXData.pdsfxUniforms[e]&&(this._PDSFXData.pdsfxUniforms[e].value=t)},l.prototype.getPDSFXUniform=function(e){if(this._PDSFXData&&this._PDSFXData.PDSFX)return this._PDSFXData.pdsfxUniforms&&void 0!==this._PDSFXData.pdsfxUniforms[e]?{name:e,value:this._PDSFXData.pdsfxUniforms[e].value}:null},l.prototype.setBackMaterial=function(e){this.isBackMaterial?console.warn("You can't set a back material on a back material"):(this.backMaterial=e,null!==this.backMaterial&&(this.backMaterial.polygonOffset=!0,this.backMaterial.polygonOffsetFactor=-10,this.backMaterial.polygonOffsetUnits=-10,this.backMaterial.isCPUPattern=this.isCPUPattern,this.backMaterial.isBackMaterial=!0,this.targetPrimitiveType!==this.backMaterial.targetPrimitiveType||this.is2DLine&&!this.backMaterial.is2DLine?(console.warn("The back material you are using is not compatible with the main material: primitive types don't match"),this.backMaterial=null):this.needsUpdate=!0),this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())},l.prototype.setPDSFXVaryings=function(t){if(this._PDSFXData&&this._PDSFXData.PDSFX){var i=0,a="",s=null;for(var r in t)(s=e.ToGLSLTypes[t[r].type])&&(s.canBeVarying||console.warn("setPDSFXVaryings - The type "+t[r].type+" cannot be used for a varying."),s.isArray&&t[r].length>0?(i=t[r].length,a+="varying "+s.t+" "+r+"["+i+"];\n"):a+="varying "+s.t+" "+r+";\n");this._PDSFXData.pdsfxVaryingsCode=a,this.needsUpdate=!0}},l.prototype.setPDSFXGlobalShaderCode=function(e,t){this._PDSFXData&&this._PDSFXData.PDSFX&&(this._PDSFXData.pdsfxGlobalVariablesCode_VS=e,this._PDSFXData.pdsfxGlobalVariablesCode_FS=t,this.needsUpdate=!0)},l.prototype.setPDSFXPolygonOffset=function(t){if(this._PDSFXData&&this._PDSFXData.PDSFX){this.polygonOffset=!0;var i=e.PDSFXPolygonOffsetParams[t];i&&(this.polygonOffsetFactor=i[0],this.polygonOffsetUnits=i[1])}},l.prototype.setMappingOperator=function(t,i,a,s){if(t.length)switch(t){case"PLANAR":t=1;break;case"SPHERICAL":t=2;break;case"CUBIC":t=3;break;case"CYLINDRICAL":t=4;break;case"INFINITE_CYLINDRICAL":t=5;break;case"SPHERICAL_NORMALIZED":t=6;break;case"INFINITE_CYLINDRICAL_NORMALIZED":t=7;break;case"INFINITE_CYLINDRICAL_NORM_ANGLE_PRES":t=8}this.mappingType=t,void 0!==s&&(this.mappingUseFragment=s),i instanceof e.Matrix4&&(this.mappingObjTransformation=i,this.mappingObjTransformation.isIdentity()?(this.mappingObjTransformation=n,this.mappingNormTransformation=r):this.mappingNormTransformation=(new e.Matrix3).getInverse(i).transpose()),a instanceof e.Matrix3&&(this.mappingUVTransformation=a,this.mappingUVTransformation.isIdentity()&&(this.mappingUVTransformation=r)),this.needsUpdate=!0},l.prototype.getType=function(){return"Unknown"},l.prototype.areTexturesLoaded=function(){return!this.map||!this._alphaTest||this.map.loadEndStatus!==e.AssetLoadingStatus.LOADING&&this.map.loadEndStatus!==e.AssetLoadingStatus.PAUSED},l.prototype._sendEvent=function(e,t){t=t||{},a.publish({event:"/VISU/"+e,data:{eventChannel:"/VISU/"+e,eventType:"@"+e,extraData:t}})},l.prototype.setOpacity=function(e){(1===this._opacity&&e<1||this._opacity<1&&1===e)&&this._invalidateDisplayRangeLists(),this._opacity=e},l.prototype.setAlphaTest=function(e){this._alphaTest!==e&&(this.needsUpdate=!0,this._deferredMaterialsInit&&this.updateDeferredMaterials()),(0===this._alphaTest&&e>0||this._alphaTest>0&&0===e)&&this._invalidateDisplayRangeLists(),this._alphaTest=e},l.prototype.getOpacity=function(){return this._opacity},l.prototype.setValues=function(t){void 0!==t&&(e.setValuesToObject(this,t,o),null!==this.backMaterial&&(this.backMaterial.polygonOffset=!0,this.backMaterial.polygonOffsetFactor=-10,this.backMaterial.polygonOffsetUnits=-10,this.backMaterial.isCPUPattern=this.isCPUPattern,this.backMaterial.isBackMaterial=!0,(this.targetPrimitiveType!==this.backMaterial.targetPrimitiveType||this.is2DLine&&!this.backMaterial.is2DLine)&&(console.warn("The back material you are using is not compatible with the main material: primitive types don't match"),this.backMaterial=null)),this.alphaTest&&this.alphaTestMode===e.AlphaTestMode.DISCARD&&(this.transparent=!0),null===this.mappingObjTransformation||this.mappingObjTransformation.isIdentity()?(this.mappingObjTransformation=n,this.mappingNormTransformation=r):this.mappingNormTransformation=(new e.Matrix3).getInverse(this.mappingObjTransformation).transpose(),(null===this.mappingUVTransformation||this.mappingUVTransformation.isIdentity())&&(this.mappingUVTransformation=r))},l.prototype._defaultPDSFXOverridableFunctions=function(){return{vertex:{ComputeCommonValues:e.ShaderChunk.PDSFXComputeCommonValues_VS,ComputeObjectPosition:e.ShaderChunk.PDSFXComputeObjectPosition_VS,ComputeObjectNormal:e.ShaderChunk.PDSFXComputeObjectNormal_VS,ComputeObjectTexCoord0:e.ShaderChunk.PDSFXComputeObjectTexCoord0_VS,ComputeObjectTexCoord1:e.ShaderChunk.PDSFXComputeObjectTexCoord1_VS,ComputeObjectTexCoord2:e.ShaderChunk.PDSFXComputeObjectTexCoord2_VS,ComputeObjectTangent:e.ShaderChunk.PDSFXComputeObjectTangent_VS,ComputeObjectBinormal:e.ShaderChunk.PDSFXComputeObjectBinormal_VS,ProcessViewTangentSpace:e.ShaderChunk.PDSFXProcessViewTangentSpace_VS,ProcessClipSpacePosition:e.ShaderChunk.PDSFXProcessClipSpacePosition_VS,ComputeVaryingValues:e.ShaderChunk.PDSFXComputeVaryingValues_VS},fragment:{ComputeCommonValues:e.ShaderChunk.PDSFXComputeCommonValues_FS,ComputeDiscard:e.ShaderChunk.PDSFXComputeDiscard_FS,ComputeAlbedo:e.ShaderChunk.PDSFXComputeAlbedo_FS,_ComputeDiffuseTexel:e.ShaderChunk.PDSFX_ComputeDiffuseTexel_FS,ComputeViewPosition:e.ShaderChunk.PDSFXComputeViewPosition_FS,ComputeViewNormal:e.ShaderChunk.PDSFXComputeViewNormal_FS,ComputeOpacity:e.ShaderChunk.PDSFXComputeOpacity_FS,ProcessFinalColor:e.ShaderChunk.PDSFXProcessFinalColor_FS}}},l.prototype._setDefaultPDSFXOverridableFunctions=function(){var e=this._defaultPDSFXOverridableFunctions();Object.assign(this._PDSFXData.PDSFX_OverridableFunctions_VS,e.vertex),Object.assign(this._PDSFXData.PDSFX_OverridableFunctions_FS,e.fragment),this.needsUpdate=!0},l.prototype._getPDSFXOverridableFunctions_VS=function(){return this._PDSFXData?Object.values(this._PDSFXData.PDSFX_OverridableFunctions_VS).join("\n"):""},l.prototype._getPDSFXOverridableFunctions_FS=function(){return this._PDSFXData?Object.values(this._PDSFXData.PDSFX_OverridableFunctions_FS).join("\n"):""},l.prototype.activatePDSFX=function(){throw"Called abstract activatePDSFX"},l.prototype.setPDSFXOverridableFunctions=function(e,t){this._PDSFXData&&this._PDSFXData.PDSFX?(this._PDSFXData._setPDSFXOverridableFunctions(e,t),this.needsUpdate=!0):console.warn("Not a PDSFX material: please call activatePDSFX() first.")},l.prototype._canUseLights=function(){return!0},l.prototype.clone=function(e){return void 0===e&&(e=new l),e.name=this.name,e.side=this.side,e.forceSide=this.forceSide,e._opacity=this._opacity,e.transparent=this.transparent,e.blending=this.blending,e.blendSrc=this.blendSrc,e.blendDst=this.blendDst,e.blendEquation=this.blendEquation,e.useGASColor=this.useGASColor,e.useGASOpacity=this.useGASOpacity,e.depthTest=this.depthTest,e.depthFunc=this.depthFunc,e.depthWrite=this.depthWrite,e.colorWrite=this.colorWrite,e.polygonOffset=this.polygonOffset,e.polygonOffsetFactor=this.polygonOffsetFactor,e.polygonOffsetUnits=this.polygonOffsetUnits,e.polite=this.polite,e.politeMaterial=this.politeMaterial,e.alphaTest=this.alphaTest,e.alphaTestMode=this.alphaTestMode,e.visible=this.visible,e.force=this.force,e.vertexColors=this.vertexColors,e.enableClipPlanes=this.enableClipPlanes,e.clipPlaneIndex=this.clipPlaneIndex,e.clipPlaneUseModelMaterial=this.clipPlaneUseModelMaterial,e.overridable=this.overridable,e.mappingType=this.mappingType,e.mappingUseFragment=this.mappingUseFragment,e.mappingNormTransformation=this.mappingNormTransformation,e.mappingObjTransformation=this.mappingObjTransformation,e.mappingUVTransformation=this.mappingUVTransformation,this._definePickingInstancing&&(e._definePickingInstancing=this._definePickingInstancing),this.isInstancingMaterial&&(e.isInstancingMaterial=this.isInstancingMaterial),this._PDSFXData&&this._PDSFXData.PDSFX&&(e._PDSFXData=this._PDSFXData.clone(),this.refreshPDSFXUniforms&&(e.refreshPDSFXUniforms=this.refreshPDSFXUniforms),this._refreshPDSFXUniforms_private&&(e._refreshPDSFXUniforms_private=this._refreshPDSFXUniforms_private)),e.isOIT=this.isOIT,e.backMaterial=this.backMaterial,e.isBackMaterial=this.isBackMaterial,e.previousOccurrenceRenderingOverride=this.previousOccurrenceRenderingOverride,e.useBlending=this.useBlending,e._programID=this._programID,e.uniforms=this.uniforms,e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader,e.program=this.program,e.attributes=Object.assign(this.attributes?this.attributes:{},e.attributes),e.enableReceiveShadowOnCapping=this.enableReceiveShadowOnCapping,e._renderedClipPlane=this._renderedClipPlane,e.line=this.line,e.point=this.point,e.isWideLine=this.isWideLine,e.isDashedLine=this.isDashedLine,e.is2DLine=this.is2DLine,e.isCPUPattern=this.isCPUPattern,e.refreshUniforms=this.refreshUniforms,e._allowObjectColor=this._allowObjectColor,e._usePhongLighting=this._usePhongLighting,e},l.prototype.updateDeferredMaterials=function(e){this._deferredMaterialsInit=!0},l.prototype.getGeomTypeDeferredMaterial=function(e,t){return this},l.prototype.dispose=function(){this.dispatchEvent({type:"dispose"})},l.prototype._needsIBLLightExtraction=function(){return!1},l.prototype._shaderID=null,l.prototype._forceOpaqueShadowMapPass=function(){return!1},l.prototype.recompileShaders=function(e,t){if(t&&t.onlyDeferred||(t&&t.callback&&t.callback(this),this.needsUpdate=!0),this._deferredMaterialsInit){var i=this._deferredMaterials,a=t?t.deferredChannels:null;if(a&&a.length>0)for(var s=0;s<a.length;s++){(r=i[a[s]])&&(t&&t.callback&&t.callback(r),r.needsUpdate=!0)}else for(s=0;s<i.length;s++){var r;(r=i[s])&&(t&&t.callback&&t.callback(r),r.needsUpdate=!0)}}e&&(this.line&&this.line.recompileShaders(!1,t),this.point&&this.point.recompileShaders(!1,t))},l.prototype.getBaseId=function(){var e="id";return this._PDSFXData&&this._PDSFXData.PDSFX&&(e+=this._getPDSFXOverridableFunctions_FS(),e+=this._getPDSFXOverridableFunctions_VS(),null!==this._PDSFXData.pdsfxUniforms&&(e+=this.id)),e};var h=new e.Matrix3(.01,0,0,0,-.01,0,0,.01,1);return l.prototype.getPredefinedMaterial=function(t,a,s){if(a===e.DefaultAppearanceMode.BASIC)return this;var r=this,n=i._loadPredefinedMaterialTextures(!0,function(){r._sendEvent("requestVisuUpdate")},!1),o=this.getBaseId();switch(o+="Lighted",o+="S"+this.side,o+="CP"+this.enableClipPlanes,o+="Type"+a,a){case e.DefaultAppearanceMode._GASLOOK_OLD:if(o+="Col"+this.color.getHex(),o="id"+(o+="O"+this._opacity).hashCode(),!i.PredefinedMaterials.has(o)){(m=new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,ior:1.576,roughness:.3,color:this.color,opacity:this._opacity})).activatePDSFX();var l={noiseVolume:{type:"t2",value:t}};m.setPDSFXUniforms(l);m.setPDSFXVaryings({noiseCoords:{type:"v3"}});var p=[].join("\n"),d=["#define SLICE_SIDE 64.0","#define SLICES_PER_ROW 8.0","#define INV_SLICES_PER_ROW 1.0 / SLICES_PER_ROW","#define MAP_INVSIZE 0.001953125","vec4 sample3DTexture(vec3 pos) {","pos *= (SLICE_SIDE - 1.0);","float rowID = floor(pos.z * INV_SLICES_PER_ROW);","float rowID2 = rowID;","float colID = mod(floor(pos.z), SLICES_PER_ROW);","float colID2 = mod(ceil(pos.z), SLICES_PER_ROW);","if (colID2 == 0.0) { rowID2 = rowID2 + 1.0; }","float x1 = colID  * SLICE_SIDE + pos.x + 0.5;","float x2 = colID2 * SLICE_SIDE + pos.x + 0.5;","float y1 = rowID  * SLICE_SIDE + pos.y + 0.5;","float y2 = rowID2 * SLICE_SIDE + pos.y + 0.5;","vec2 mapUV  = vec2(x1 * MAP_INVSIZE, 1.0 - y1 * MAP_INVSIZE);","vec2 mapUV2 = vec2(x2 * MAP_INVSIZE, 1.0 - y2 * MAP_INVSIZE);","vec4 alpha1 = texture2D(noiseVolume, mapUV);","vec4 alpha2 = texture2D(noiseVolume, mapUV2);","return mix(alpha1, alpha2, fract(pos.z));","}"].join("\n");m.setPDSFXGlobalShaderCode(p,d);var f={ComputeVaryingValues:["void ComputeVaryingValues() {","noiseCoords = vGetAttribPosition();","}"].join("\n")},c={ComputeViewNormal:["vec3 ComputeViewNormal() {","vec3 vNormal;","vNormal = vGetViewNormal();","vec3 bumpNorm = sample3DTexture(fract(noiseCoords * 0.5)).xxx * 0.04;","bumpNorm = (vGetViewMatrix() * vec4(bumpNorm, 0.0)).xyz;","vNormal += bumpNorm;","vNormal = normalize(vNormal);","return vNormal;","}"].join("\n")};m.setPDSFXOverridableFunctions(f,c);var u=new i.DeferredMaterial(m);i.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.GASLOOK:if(o+="Col"+this.color.getHex(),o="id"+(o+="O"+this._opacity).hashCode(),!i.PredefinedMaterials.has(o)){var m=new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,ior:1.5,roughness:.3,color:(new e.Color).set(this.color).multiplyScalar(.85),opacity:this._opacity,clearCoat:.918,clearCoatRoughness:.1,_allowObjectColor:!0});u=new i.DeferredMaterial(m);i.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode._TRANSPARENT:if(o="id"+(o+="Col"+(M=this.color).getHex()).hashCode(),!i.PredefinedMaterials.has(o)){u=new i.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:M,opacity:.25,roughness:.34,ior:1.5,_allowObjectColor:!0}));i.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.CLAY:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){u=new i.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:(new e.Color).setRGB(.64,.34,.26),specular:(new e.Color).setRGB(.996,.851,.694),roughness:.41,ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0}));i.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.WHITE_MAT_PLASTER:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){u=new i.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:(new e.Color).setRGB(.922,.922,.922),roughness:1,ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0}));i.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.GREY_SHINY_PLASTIC:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){u=new i.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:(new e.Color).setRGB(.584,.584,.584),roughness:.045,ior:1.5,overridable:!1}));i.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.CAST_ALUMINUM:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){(S=new e.DSPBR19xMaterial({color:11184810,map:n[6],side:this.side,normalMap:n[7],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.6,roughnessMap:n[8],ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0})).setMappingOperator(e.MappingType.CUBIC,null,h,!0);u=new i.DeferredMaterial(S);i.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.MACHINED_ALUMINUM:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){(S=new e.DSPBR19xMaterial({color:11184810,map:n[14],side:this.side,normalMap:n[15],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.6,roughnessMap:n[16],ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0})).setMappingOperator(e.MappingType.CUBIC,null,h,!0);u=new i.DeferredMaterial(S);i.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.CAST_STEEL:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){(S=new e.DSPBR19xMaterial({color:8947848,map:n[9],side:this.side,enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.4,roughnessMap:n[10],ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0})).setMappingOperator(e.MappingType.CUBIC,null,h,!0);u=new i.DeferredMaterial(S);i.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.BRUSHED_STEEL:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){(S=new e.DSPBR19xMaterial({color:11184810,map:n[2],side:this.side,normalMap:n[4],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.15,roughnessMap:n[5],anisotropyMap:n[3],anisotropyAngle:.14,ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0})).setMappingOperator(e.MappingType.CUBIC,null,h,!0);u=new i.DeferredMaterial(S);i.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.MACHINED_STAINLESS_STEEL:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){(S=new e.DSPBR19xMaterial({color:11184810,map:n[17],side:this.side,normalMap:n[18],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.15,roughnessMap:n[19],anisotropy:.17,anisotropyAngle:.09,ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0})).setMappingOperator(e.MappingType.CUBIC,null,h,!0);u=new i.DeferredMaterial(S);i.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.COPPER:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){(S=new e.DSPBR19xMaterial({color:13809841,map:n[11],side:this.side,normalMap:n[12],enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.4,roughnessMap:n[13],ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0})).setMappingOperator(e.MappingType.CUBIC,null,h,!0);u=new i.DeferredMaterial(S);i.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.BRASS:if(o="id"+o.hashCode(),!i.PredefinedMaterials.has(o)){var S;(S=new e.DSPBR19xMaterial({color:14472604,map:n[0],side:this.side,enableClipPlanes:this.enableClipPlanes,specular:(new e.Color).setRGB(.996,.996,.996),metalness:1,roughness:.4,roughnessMap:n[1],ior:1.5,overridable:!1,_forceAllowFullMaterialOverride:!0})).setMappingOperator(e.MappingType.CUBIC,null,h,!0);u=new i.DeferredMaterial(S);i.PredefinedMaterials.set(o,u)}break;case e.DefaultAppearanceMode.GENERIC_PLASTIC:case e.DefaultAppearanceMode.GENERIC_METAL:var M=s.colorFromGAS?this.color:s.color;if(o="id"+(o+="Col"+(s.colorFromGAS?this.color.getHex():"Custom")).hashCode(),!i.PredefinedMaterials.has(o)){u=new i.DeferredMaterial(new e.DSPBR19xMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,ior:1.5,color:this.color,overridable:s.colorFromGAS,_forceAllowFullMaterialOverride:!0,_allowObjectColor:s.colorFromGAS}));i.PredefinedMaterials.set(o,u)}(m=i.PredefinedMaterials.get(o).get(this)).color.copy(M),m.metalness=a===e.DefaultAppearanceMode.GENERIC_PLASTIC?0:1,m.roughness=1-s.shininess,m._opacity=s.opacity;break;case e.DefaultAppearanceMode.__QA_AUTOMATION__:var _=this.map||0===this.color.getHex()?new e.Color(11184810):this.color,C=this.opacityMap?1:this._opacity;if(o+="Col"+_.getHex(),o="id"+(o+="Op"+C).hashCode(),!i.PredefinedMaterials.has(o)){(m=new e.MeshBasicMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:_,opacity:C})).activatePDSFX();c={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","vec3 color = ComputeAlbedo();","ioFinalColor.a = ComputeOpacity();","mat4 viewMat = vGetViewMatrix();","vec3 light1 = normalize((viewMat*vec4(0.0,0.0,1.0,0.0)).xyz);","vec3 light2 = normalize((viewMat*vec4(0.0,-1.0,-1.0,0.0)).xyz);","vec3 light3 = normalize((viewMat*vec4(0.0,1.0,-1.0,0.0)).xyz);","vec3 viewNorm = vGetViewNormal();","float ambientCoef = 0.11;","ioFinalColor.rgb = 2.0 * color * (ambientCoef + 0.44*clamp(dot(viewNorm, light1), 0.0, 1.0) + 0.22*clamp(dot(viewNorm, light2), 0.0, 1.0) + 0.22*clamp(dot(viewNorm, light3), 0.0, 1.0));","#ifdef GAMMA_OUTPUT","ioFinalColor.rgb = sqrt(ioFinalColor.rgb);","#endif","}"].join("\n")};m.setPDSFXOverridableFunctions({},c);u=new i.DeferredMaterial(m);i.PredefinedMaterials.set(o,u)}}return i.PredefinedMaterials.get(o).get(this)},l.prototype.__getGAS=function(e){return this},l.prototype._deallocate=function(t){if(this._deferredMaterialsInit){var i=e.MaterialToUse;e.cleanDeferredCache(this.id),this._deferredMaterialsInit=!1,this._deferredMaterials=[];for(var a=0;a<i.totalMaterial;a++)this._deferredMaterials[a]=null;this._deferredMaterials[i.originalMaterial]=this,this.backMaterial&&this._deferredMaterials[i.pickingMaterial]&&this._deferredMaterials[i.pickingMaterial].dispose()}this.needsUpdate=!0},l.prototype.getZOnlyMaterial=function(){var t=this.transparent||this._opacity<1,a="ZOnly-Tr"+t;if(a="id"+a.hashCode(),i.DefaultMaterials.has(a))return i.DefaultMaterials.get(a).get(this);var s=new e.MeshBasicMaterial({force:!0});s.blending=e.CustomBlending,s.useBlending=!0,s.blendDst=e.OneFactor,s.blendSrc=e.ZeroFactor,s.transparent=t,s._opacity=t?.5:1,s.overridable=!1;var r=new i.DeferredMaterial(s);return i.DefaultMaterials.set(a,r),r.get(this)},l.prototype.__dimension=2,l.prototype.targetPrimitiveType="FACES",l.prototype.useClippingTolerance=!1,l}),define("DS/Materials/GradientBackgroundMaterials",["DS/Mesh/ThreeJS_Base","DS/Materials/Material"],function(e,t){"use strict";var i=function(e){this.colors=null,this.YUp=0,this.ratio=1,t.call(this,e)};(i.prototype=Object.create(t.prototype)).clone=function(){throw"Unsupported operation"},i.prototype.getPredefinedMaterial=function(e,t,i){return this},i.prototype.loadUniforms=function(e,t,i,a,s,r){t.uniform1i(i.YUp,this.YUp),t.uniform1f(i.ratio,this.ratio),t.uniform3fv(i.colors,this.colors)},i.prototype.getType=function(){throw"Abstract Gradient material"};var a=function(e){i.call(this,e)};(a.prototype=Object.create(i.prototype)).getType=function(){return"GradientBackground2"},a.prototype._shaderID="gradient2";var s=function(e){i.call(this,e)};(s.prototype=Object.create(i.prototype)).getType=function(){return"GradientBackground3"},s.prototype._shaderID="gradient3";var r=function(e){this.skylineFading=0,this.horizonHeight=0,i.call(this,e)};return(r.prototype=Object.create(i.prototype)).loadUniforms=function(e,t,a,s,r,n){i.prototype.loadUniforms.call(this,e,t,a,s,r,n),t.uniform1f(a.skylineFading,this.skylineFading),t.uniform1f(a.horizonHeight,this.horizonHeight)},r.prototype._shaderID="gradient4",r.prototype.getType=function(){return"GradientBackground4"},{GradientBackgroundMaterial2:a,GradientBackgroundMaterial3:s,GradientBackgroundMaterial4:r}}),define("DS/Materials/DeferrableMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/Material"],function(e,t){"use strict";var i=function(){t.call(this)};return(i.prototype=Object.create(t.prototype)).updateDeferredMaterials=function(t){e.cleanDeferredCache(this.id);for(var i=0;i<this._deferredMaterials.length;i++)this._deferredMaterials[i]=this;this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial]=null,this._deferredMaterials[e.MaterialToUse.ZOnlyMaterial]=this.getZOnlyMaterial(),this._deferredMaterialsInit=!0},i.prototype._setMaterialShaderOptions=function(e,i,a,s,r,n){t.prototype._setMaterialShaderOptions.call(this,e,i,a,s,r,n)},i.prototype.clone=function(e){return void 0===e&&(e=new i),t.prototype.clone.call(this,e),e},i.prototype.deferrable=!0,i}),define("DS/Materials/MeshLambertMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData"],function(e,t,i){"use strict";var a=new e.Color,s=function(i){t.call(this),this.color=new e.Color(16777215),this.ambient=new e.Color(16777215),this.emissive=new e.Color(0),this.wrapAround=!1,this.wrapRGB=new e.Vector3(1,1,1),this.map=null,this.specularMap=null,this.envMap=null,this.combine=e.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.shading=e.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.morphTargets=!1,this.morphNormals=!1,this.lights=!0,this.numSupportedMorphTargets=0,this.numSupportedMorphNormals=0,this._usePhongLighting=!0,this.setValues(i)};return(s.prototype=Object.create(t.prototype))._getTextures=function(e){var i=t.prototype._getTextures.call(this,e);return i=i.concat([this.map,this.specularMap])},s.prototype._dump=function(){var e=t.prototype._dump.call(this);return e.color=this.color.toArray(),this.map&&(e.color="textured"),e},s.prototype._shaderID="lambert",s.prototype._transparencyOnGPU=function(e){return t.prototype._transparencyOnGPU.call(this,e)||this.map&&this.transparent},s.prototype.getType=function(){return"Lambert"},s.prototype.areTexturesLoaded=function(){return!!t.prototype.areTexturesLoaded.call(this)&&(!this.envMap||this.envMap.loadEndStatus!==e.AssetLoadingStatus.LOADING)},s.prototype.clone=function(){var e=new s;return t.prototype.clone.call(this,e),e.color.copy(this.color),e.ambient.copy(this.ambient),e.emissive.copy(this.emissive),e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.map=this.map,e.specularMap=this.specularMap,e.envMap=this.envMap,e.combine=this.combine,e.reflectivity=this.reflectivity,e.refractionRatio=this.refractionRatio,e.shading=this.shading,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e.numSupportedMorphTargets=this.numSupportedMorphTargets,e.numSupportedMorphNormals=this.numSupportedMorphNormals,e},s.prototype._autoForceSide=!0,s.prototype.activatePDSFX=function(e){e=e||{},this._PDSFXData=new i,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions(),this._PDSFXData.PDSFX_hasOpacity=!0},s.prototype.loadUniforms=function(e,t,i,s,r,n){var o;i.ambient&&(o=e.gammaInput?a.copyToLinear(this.ambient,e.simpleGamma):this.ambient,t.uniform3f(i.ambient,o.r,o.g,o.b)),i.emissive&&(o=e.gammaInput?a.copyToLinear(this.emissive,e.simpleGamma):this.emissive,t.uniform3f(i.emissive,o.r,o.g,o.b)),i.wrapRGB&&this.wrapAround&&t.uniform3f(i.wrapRGB,this.wrapRGB.x,this.wrapRGB.y,this.wrapRGB.z),e.loadUniformsCommon(t,this,i,s,r,n)},s}),define("DS/Materials/ParticleBasicMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData","DS/Materials/DeferredCaches"],function(e,t,i,a){"use strict";var s=function(i){t.call(this),this.color=new e.Color(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.setValues(i)};return(s.prototype=Object.create(t.prototype))._getTextures=function(e){var i=t.prototype._getTextures.call(this,e);return i=i.concat([this.map])},s.prototype._shaderID="particle_basic",s.prototype._dump=function(){var e=t.prototype._dump.call(this);return e.color=this.color.toArray(),this.map&&(e.color="textured"),e.size=this.size,e},s.prototype.clone=function(){var e=new s;return t.prototype.clone.call(this,e),e.color.copy(this.color),e.map=this.map,e.size=this.size,e.sizeAttenuation=this.sizeAttenuation,e},s.prototype.getType=function(){return"Point"},s.prototype.activatePDSFX=function(e){e=e||{},this._PDSFXData=new i,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions(),this._PDSFXData.PDSFX_hasAlbedo=!0,this._PDSFXData.PDSFX_hasOpacity=!0},s.prototype._canUseLights=function(){return!1},s.prototype.loadUniforms=function(e,t,i,a,s,r){e.loadGASUniforms(t,this,i,a,null),i.scale&&t.uniform1f(i.scale,e.domElement.height/2),i.size&&t.uniform1f(i.size,this.size?this.size:1),i.map&&e.loadTexture(t,i.map,this.map)},s.prototype.getPredefinedMaterial=function(t,i,r){var n=this.getBaseId();switch(n+="Point",n+="S"+this.side,n+="CP"+this.enableClipPlanes,n+="Type"+i,i){case e.DefaultAppearanceMode.__QA_AUTOMATION__:if(n+="Col"+this.color.getHex(),n+="Op"+this._opacity,n="id"+(n+="SA"+this.sizeAttenuation).hashCode(),!a.PredefinedMaterials.has(n)){var o=new s({size:5,side:this.side,enableClipPlanes:this.enableClipPlanes,color:this.color,sizeAttenuation:this.sizeAttenuation,opacity:this._opacity});o.activatePDSFX();var l={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor.rgb = _DSalbedo_.rgb;","ioFinalColor.a = _DSopacity_;","#if defined(GAMMA_INPUT)","ioFinalColor.rgb = sqrt(ioFinalColor.rgb);","#endif","#if defined(GAMMA_OUTPUT)","ioFinalColor.rgb = sqrt(ioFinalColor.rgb);","#endif","}"].join("\n")};o.setPDSFXOverridableFunctions({},l);var h=new a.DeferredMaterial(o);a.PredefinedMaterials.set(n,h)}break;default:return this}return a.PredefinedMaterials.get(n).get(this)},s.prototype.__dimension=0,s.prototype.getZOnlyMaterial=function(){return this},s.prototype._defaultPDSFXOverridableFunctions=function(){var i=t.prototype._defaultPDSFXOverridableFunctions.call(this);return Object.assign(i.vertex,{ComputePointSize:e.ShaderChunk.PDSFXComputePointSize_VS}),i},s.prototype.updateDeferredMaterials=function(i){t.prototype.updateDeferredMaterials.call(this,i),this._deferredMaterials[e.MaterialToUse.shadowMapDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalDepthIoRRoughnessMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.oitAccumMaterial]=null,this._deferredMaterials[e.MaterialToUse.oitRevealMaterial]=null,this._deferredMaterials[e.MaterialToUse.texCoordMaterial]=null},s.prototype.targetPrimitiveType="POINTS",s.prototype.useClippingTolerance=!0,s}),define("DS/Materials/AbstractAmbianceMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/Material"],function(e,t){"use strict";var i=function(i){this.ambienceMatrix=new e.Matrix4,this.ambienceMatrix2=new e.Matrix4,this.tEnvMap=null,this.tEnvMap2=null,this.envMapExposure=1,this.envMapExposure2=1,this.blurCoef=0,this.intensity=1,this.invScreenSize=new e.Vector2,this.invSize=new e.Vector2,this.offset=new e.Vector2,this.startOffset=new e.Vector2,this.endOffset=new e.Vector2,this.ambient=new e.Color(16777215),this.backgroundColor=new e.Color(16777215),this.backgroundAlpha=1,this.groundPosition=new e.Vector3,this.groundPosition2=new e.Vector3,this.groundNormal=new e.Vector3(0,0,1),this.groundHeight=new e.Vector3(0,0,.23),this.groundRadius=5e3,this.groundRadius2=5e3,this.groundOffset=0,this.groundScale=.78,this.groundScale2=.78,this.transitionCoef=0,this.withGround=0,this.withPlane=0,this.planeColor=new e.Color(16777215),this.tFlip=-1,this.cameraSize=new e.Vector3,this.cameraSight=new e.Vector3,this.cameraUp=new e.Vector3,this.cameraRight=new e.Vector3,this.sceneHeight=new e.Vector3(0,0,.15),this.near=1,this.right=1,this.up=1,this.projectionConic=1,this.defines={},this.enableClipPlanes=!1,t.call(this,i),i&&i.defines&&Object.assign(this.defines,i.defines)};return(i.prototype=Object.create(t.prototype)).clone=function(){throw"Unsupported operation"},i.prototype.getPredefinedMaterial=function(e,t,i){return this},i.prototype.loadUniforms=function(e,t,i,a,s,r){t.uniform1f(i.envMapExposure,this.envMapExposure),t.uniform1f(i.tFlip,this.tFlip),t.uniform1f(i.groundRadius,this.groundRadius),t.uniform1f(i.groundScale,this.groundScale),t.uniform1f(i.groundOffset,this.groundOffset),t.uniform1f(i.projectionConic,this.projectionConic),t.uniform1f(i.up,this.up),t.uniform1f(i.right,this.right),t.uniform1f(i.near,this.near),t.uniform1f(i.intensity,this.intensity),t.uniform1f(i.withGround,this.withGround),t.uniform1f(i.blurCoef,this.blurCoef),t.uniform1f(i.envMapExposure2,this.envMapExposure2),t.uniform1f(i.groundRadius2,this.groundRadius2),t.uniform1f(i.groundScale2,this.groundScale2),t.uniform1f(i.transitionCoef,this.transitionCoef),t.uniform1f(i.withPlane,this.withPlane),t.uniform1f(i.backgroundAlpha,this.backgroundAlpha),t.uniform2f(i.startOffset,this.startOffset.x,this.startOffset.y),t.uniform2f(i.endOffset,this.endOffset.x,this.endOffset.y),t.uniform2f(i.invScreenSize,this.invScreenSize.x,this.invScreenSize.y),t.uniform2f(i.invSize,this.invSize.x,this.invSize.y),t.uniform2f(i.offset,this.offset.x,this.offset.y),t.uniform3f(i.ambient,this.ambient.r,this.ambient.g,this.ambient.b),t.uniform3f(i.groundPosition,this.groundPosition.x,this.groundPosition.y,this.groundPosition.z),t.uniform3f(i.groundPosition2,this.groundPosition2.x,this.groundPosition2.y,this.groundPosition2.z),t.uniform3f(i.groundNormal,this.groundNormal.x,this.groundNormal.y,this.groundNormal.z),t.uniform3f(i.groundHeight,this.groundHeight.x,this.groundHeight.y,this.groundHeight.z),t.uniform3f(i.cameraSize,this.cameraSize.x,this.cameraSize.y,this.cameraSize.z),t.uniform3f(i.cameraSight,this.cameraSight.x,this.cameraSight.y,this.cameraSight.z),t.uniform3f(i.cameraUp,this.cameraUp.x,this.cameraUp.y,this.cameraUp.z),t.uniform3f(i.cameraRight,this.cameraRight.x,this.cameraRight.y,this.cameraRight.z),t.uniform3f(i.sceneHeight,this.sceneHeight.x,this.sceneHeight.y,this.sceneHeight.z),t.uniform3f(i.planeColor,this.planeColor.r,this.planeColor.g,this.planeColor.b),t.uniform3f(i.backgroundColor,this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b),t.uniformMatrix4fv(i.ambienceMatrix,!1,e.float32Matrix4x4Temp.setDoubles(this.ambienceMatrix.elements)),t.uniformMatrix4fv(i.ambienceMatrix2,!1,e.float32Matrix4x4Temp.setDoubles(this.ambienceMatrix2.elements)),i.tEnvMap&&e.loadTexture(t,i.tEnvMap,this.tEnvMap),i.tEnvMap2&&e.loadTexture(t,i.tEnvMap2,this.tEnvMap2);var n=1,o=1;if(this.tEnvMap.hdr&&i.envMapHDRSize&&(this.tEnvMap.image?(n=parseInt(this.tEnvMap.image.width),o=parseInt(this.tEnvMap.image.height)):(n=parseInt(this.tEnvMap.width),o=parseInt(this.tEnvMap.height)),t.uniform2f(i.envMapHDRSize,n,o)),this.tEnvMap2&&(i.envMapHDRToMipsRatio||i.envMapHDRSize2)){var l=1;l=this.tEnvMap2.image?parseInt(this.tEnvMap2.image.width)/n:parseInt(this.tEnvMap2.width)/n,t.uniform1f(i.envMapHDRToMipsRatio,l),this.tEnvMap2.image?(n=parseInt(this.tEnvMap2.image.width),o=parseInt(this.tEnvMap2.image.height)):(n=parseInt(this.tEnvMap2.width),o=parseInt(this.tEnvMap2.height)),t.uniform2f(i.envMapHDRSize2,n,o)}},i.prototype._setMaterialShaderOptions=function(e,i,a,s,r,n){t.prototype._setMaterialShaderOptions.call(this,e,i,a,s,r,n)},i.prototype.areTexturesLoaded=function(){return!!t.prototype.areTexturesLoaded.call(this)&&((!this.tEnvMap||this.tEnvMap.loadEndStatus!==e.AssetLoadingStatus.LOADING)&&(!this.tEnvMap2||this.tEnvMap2.loadEndStatus!==e.AssetLoadingStatus.LOADING))},i}),define("DS/Materials/CubeMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],function(e,t){"use strict";var i=function(e){t.call(this,e)};return(i.prototype=Object.create(t.prototype)).getType=function(){return"CubeMap"},i.prototype._shaderID="cubemap",i}),define("DS/Materials/FiniteTransitionEnvMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],function(e,t){"use strict";var i=function(e){t.call(this,e)};return(i.prototype=Object.create(t.prototype))._shaderID="finitetransition",i.prototype._setMaterialShaderOptions=function(e,i,a,s,r,n){t.prototype._setMaterialShaderOptions.call(this,e,i,a,s,r,n)},i.prototype.getType=function(){return"LatLongMap"},i}),define("DS/Materials/FiniteEnvMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],function(e,t){"use strict";var i=function(e){t.call(this,e)};return(i.prototype=Object.create(t.prototype))._shaderID="finiteenvmap",i.prototype._setMaterialShaderOptions=function(e,i,a,s,r,n){t.prototype._setMaterialShaderOptions.call(this,e,i,a,s,r,n)},i.prototype.getType=function(){return"FiniteEnvMap"},i}),define("DS/Materials/LatLongMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],function(e,t){"use strict";var i=function(e){t.call(this,e)};return(i.prototype=Object.create(t.prototype))._shaderID="latlong",i.prototype._setMaterialShaderOptions=function(e,i,a,s,r,n){t.prototype._setMaterialShaderOptions.call(this,e,i,a,s,r,n)},i.prototype.getType=function(){return"LatLongMap"},i}),define("DS/Materials/SimpleMapMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/AbstractAmbianceMaterial"],function(e,t){"use strict";var i=function(e){t.call(this,e)};return(i.prototype=Object.create(t.prototype))._shaderID="simplemap",i.prototype.getType=function(){return"SimpleMap"},i}),define("DS/Materials/PhysicalMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData"],function(e,t,i){"use strict";const a={GGX:0,ASHIKMIN:1,BECKMANN:2,ESTEVEZKULLA:3};e._BRDFS=a;const s=function(e){this.hdr=e.hdr||null,this.brdf=a.GGX,this.direct=e.direct||!1,this.name=e.name||"",this.mips=e.mips||null,this.curID=-1};s.prototype._useCustom=function(){return null!==this.hdr},s.prototype.clone=function(){return new s({hdr:this.hdr,direct:this.direct,name:this.name,mips:this.mips})},e.IBLOverrider=s;const r=0,n=.5,o=1,l=2,h=3,p=4;e.DSPBRSubTypes={Generic:0,Metal:1,Glass:2,Plastic:3,Textile:4,Leather:5,"Car Paint":6,Emissive:7,Basic:8,Wood:9};const d={_NO_SHEEN:"NONE",VELVET:"USE_VELVET",VELVET_SOFT:"USE_SOFT_VELVET",SATIN:"USE_SATIN"};e.SheenMode=d;const f={None:-1,Apple:0,Chicken1:1,Chicken2:2,Cream:3,Ketchup:4,Marble:5,Potato:6,Skimmilk:7,Skin1:8,Skin2:9,Wholemilk:10};e.SubsurfaceScatteringPresets=f;var c=[{absorptionCoeffs:[.003,.0034,.046],scatteringCoeffs:[2.29,2.39,1.97]},{absorptionCoeffs:[.015,.077,.19],scatteringCoeffs:[.15,.21,.38]},{absorptionCoeffs:[.018,.088,.2],scatteringCoeffs:[.19,.25,.32]},{absorptionCoeffs:[2e-4,.0028,.0163],scatteringCoeffs:[7.38,5.47,3.15]},{absorptionCoeffs:[.061,.97,1.45],scatteringCoeffs:[.18,.07,.03]},{absorptionCoeffs:[.0021,.0041,.0071],scatteringCoeffs:[2.19,2.62,3]},{absorptionCoeffs:[.0024,.009,.12],scatteringCoeffs:[.68,.7,.55]},{absorptionCoeffs:[.0014,.0025,.0142],scatteringCoeffs:[.7,1.22,1.9]},{absorptionCoeffs:[.032,.17,.48],scatteringCoeffs:[.74,.88,1.01]},{absorptionCoeffs:[.013,.07,.145],scatteringCoeffs:[1.09,1.59,1.79]},{absorptionCoeffs:[.0011,.0024,.014],scatteringCoeffs:[2.55,3.21,3.77]}],u=function(e){this.envMipMap=e.envMipMap||null,this.overrideIBL=e.overrideIBL||null};u.prototype.clone=function(){return new u({envMipMap:this.envMipMap,overrideIBL:null!==this.overrideIBL?this.overrideIBL.clone():null})},u.prototype._useCustom=function(){return null!==this.overrideIBL&&this.overrideIBL._useCustom()};var m=new e.Matrix3,S=new e.Color,M=function(e,t){e[t+"Map"]=null,e[t+"AddCoef"]=null,e[t+"MulCoef"]=null,e[t+"UvTransform"]=m,e[t+"UvSlot"]=1},_=function(e,t,i){e[t]=i,M(e,t)},C=function(e,t,i){t[i+"Map"]=e[i+"Map"],t[i+"AddCoef"]=e[i+"AddCoef"],t[i+"MulCoef"]=e[i+"MulCoef"],t[i+"UvTransform"]=e[i+"UvTransform"],t[i+"UvSlot"]=e[i+"UvSlot"]},v=function(e,t,i,a){a?t[i].copy(e[i]):t[i]=e[i],C(e,t,i)},g=function(e){return null===e||e.isIdentity()?m:e};const P=new Set;P.add("__parent__"),P.add("__needDisplacementUpdate"),P.add("_sssLUT"),P.add("_scatteringCoeffs"),P.add("_absorptionCoeffs"),P.add("_translucencyDepth"),P.add("_updateSSS"),P.add("_subsurface");var y=function(e,t){this.__parent__=t,this.setParameters(e)};y.prototype.loadUniforms=function(e,t,i,a){},y.prototype.setParameters=function(t){var i=this.__parent__,a={};if(i&&!i.needsUpdate&&this.setMaterialShaderOptions(a),e.setValuesToObject(this,t,P),i&&!i.needsUpdate){var s={};this.setMaterialShaderOptions(s);for(var r=Object.keys(a),n=0;n<r.length;n++)if(a[r[n]]!==s[r[n]]){i.needsUpdate=!0;break}}},y.prototype.isEnabled=function(){return!1},y.prototype.setMaterialShaderOptions=function(){},y.prototype.getTextures=function(){return[]},y.prototype._isTextureAvailable=t.prototype._isTextureAvailable,y.prototype.clone=function(e){return null};var D=function(t,i){_(this,"flakesCoverage",0),_(this,"flakesSize",0),_(this,"flakesRoughness",0),_(this,"flakesColor",new e.Color(16777215)),_(this,"flipFlopColor",new e.Color(16777215)),_(this,"flipFlop",0),y.call(this,t,i)};(D.prototype=Object.create(y.prototype)).loadUniforms=function(e,t,i,a){var s;this.isEnabled()&&(i.flakesColor&&(s=e.gammaInput?S.copyToLinear(this.flakesColor,e.simpleGamma):this.flakesColor,t.uniform3f(i.flakesColor,s.r,s.g,s.b)),i.flakesColorMap&&e.loadTexture(t,i.flakesColorMap,this.flakesColorMap),i.flakesColorMulCoef&&(t.uniform3f(i.flakesColorMulCoef,this.flakesColorMulCoef.x,this.flakesColorMulCoef.y,this.flakesColorMulCoef.z),t.uniform3f(i.flakesColorAddCoef,this.flakesColorAddCoef.x,this.flakesColorAddCoef.y,this.flakesColorAddCoef.z)),i.flakesCoverage&&t.uniform1f(i.flakesCoverage,this.flakesCoverage),i.flakesCoverageMap&&e.loadTexture(t,i.flakesCoverageMap,this.flakesCoverageMap),i.flakesCoverageMulCoef&&(t.uniform1f(i.flakesCoverageMulCoef,this.flakesCoverageMulCoef),t.uniform1f(i.flakesCoverageAddCoef,this.flakesCoverageAddCoef)),i.flakesSize&&t.uniform1f(i.flakesSize,this.flakesSize),i.flakesSizeMap&&e.loadTexture(t,i.flakesSizeMap,this.flakesSizeMap),i.flakesSizeMulCoef&&(t.uniform1f(i.flakesSizeMulCoef,this.flakesSizeMulCoef),t.uniform1f(i.flakesSizeAddCoef,this.flakesSizeAddCoef)),i.flakesRoughness&&t.uniform1f(i.flakesRoughness,this.flakesRoughness),i.flakesRoughnessMap&&e.loadTexture(t,i.flakesRoughnessMap,this.flakesRoughnessMap),i.flakesRoughnessMulCoef&&(t.uniform1f(i.flakesRoughnessMulCoef,this.flakesRoughnessMulCoef),t.uniform1f(i.flakesRoughnessAddCoef,this.flakesRoughnessAddCoef)),i.flipFlop&&t.uniform1f(i.flipFlop,this.flipFlop),i.flipFlopMap&&e.loadTexture(t,i.flipFlopMap,this.flipFlopMap),i.flipFlopMulCoef&&(t.uniform1f(i.flipFlopMulCoef,this.flipFlopMulCoef),t.uniform1f(i.flipFlopAddCoef,this.flipFlopAddCoef)),i.flipFlopColor&&(s=e.gammaInput?S.copyToLinear(this.flipFlopColor,e.simpleGamma):this.flipFlopColor,t.uniform3f(i.flipFlopColor,s.r,s.g,s.b)),i.flipFlopColorMap&&e.loadTexture(t,i.flipFlopColorMap,this.flipFlopColorMap),i.flipFlopColorMulCoef&&(t.uniform3f(i.flipFlopColorMulCoef,this.flipFlopColorMulCoef.x,this.flipFlopColorMulCoef.y,this.flipFlopColorMulCoef.z),t.uniform3f(i.flipFlopColorAddCoef,this.flipFlopColorAddCoef.x,this.flipFlopColorAddCoef.y,this.flipFlopColorAddCoef.z)))},D.prototype.isEnabled=function(){return this.flakesCoverage>0||this._isTextureAvailable("flakesCoverageMap")},D.prototype.clone=function(e){return new D(this,e)},D.prototype.setParameters=function(e){y.prototype.setParameters.call(this,e),this.flakesRoughnessUvTransform=g(this.flakesRoughnessUvTransform),this.flakesSizeUvTransform=g(this.flakesSizeUvTransform),this.flakesCoverageUvTransform=g(this.flakesCoverageUvTransform),this.flakesColorUvTransform=g(this.flakesColorUvTransform),this.flipFlopUvTransform=g(this.flipFlopUvTransform),this.flipFlopColorUvTransform=g(this.flipFlopColorUvTransform)},D.prototype.setMaterialShaderOptions=function(e){var t=this.isEnabled(),i=t&&(this._isTextureAvailable("flipFlopMap")||this.flipFlop>0);Object.assign(e,{dspbrFlakes:t,flakesSizeMap:t&&this._isTextureAvailable("flakesSizeMap"),flakesSizeMulCoef:t&&null!==this.flakesSizeMulCoef,flakesSizeAddCoef:t&&null!==this.flakesSizeAddCoef,flakesCoverageMap:t&&this._isTextureAvailable("flakesCoverageMap"),flakesCoverageMulCoef:t&&null!==this.flakesCoverageMulCoef,flakesCoverageAddCoef:t&&null!==this.flakesCoverageAddCoef,flakesRoughnessMap:t&&this._isTextureAvailable("flakesRoughnessMap"),flakesRoughnessMulCoef:t&&null!==this.flakesRoughnessMulCoef,flakesRoughnessAddCoef:t&&null!==this.flakesRoughnessAddCoef,flakesColorMap:t&&this._isTextureAvailable("flakesColorMap"),flakesColorMapLinear:t&&!!this.flakesColorMap&&this.flakesColorMap.hdr,flakesColorMulCoef:t&&null!==this.flakesColorMulCoef,flakesColorAddCoef:t&&null!==this.flakesColorAddCoef,flipFlop:i,flipFlopColorMap:i&&this._isTextureAvailable("flipFlopColorMap"),flipFlopColorMapLinear:i&&!!this.flipFlopColorMap&&this.flipFlopColorMap.hdr,flipFlopColorMulCoef:i&&null!==this.flipFlopColorMulCoef,flipFlopColorAddCoef:i&&null!==this.flipFlopColorAddCoef,flipFlopMap:i&&this._isTextureAvailable("flipFlopMap"),flipFlopMulCoef:i&&null!==this.flipFlopMulCoef,flipFlopAddCoef:i&&null!==this.flipFlopAddCoef})},D.prototype.getTextures=function(){return[this.flakesSizeMap,this.flakesCoverageMap,this.flakesRoughnessMap,this.flakesColorMap,this.flipFlopColorMap,this.flipFlopMap]};var T=function(t,i){this.flakes=!1,this.flakesColor=new e.Color(0),this.flakesBump=0,this.flakesDensity=0,this.flakesScale=0,this.flakesRoughness=0,this.flakesColorMulCoef=new e.Vector3(1,1,1),this.flakesColorAddCoef=new e.Vector3(0,0,0),this.pearlFlakesColor=new e.Color(0),this.pearlFlakesBump=0,this.pearlFlakesDensity=0,this.pearlFlakesColorMulCoef=new e.Vector3(1,1,1),this.pearlFlakesColorAddCoef=new e.Vector3(0,0,0),y.call(this,t,i)};(T.prototype=Object.create(y.prototype)).loadUniforms=function(e,t,i,a){var s;this.isEnabled()&&(i.flakesColor&&(s=e.gammaInput?S.copyToLinear(this.flakesColor,e.simpleGamma):this.flakesColor,t.uniform3f(i.flakesColor,s.r,s.g,s.b)),i.pearlFlakesColor&&(s=e.gammaInput?S.copyToLinear(this.pearlFlakesColor,e.simpleGamma):this.pearlFlakesColor,t.uniform3f(i.pearlFlakesColor,s.r,s.g,s.b)),i.flakesBump&&t.uniform1f(i.flakesBump,this.flakesBump),i.flakesDensity&&t.uniform1f(i.flakesDensity,this.flakesDensity),i.flakesScale&&t.uniform1f(i.flakesScale,this.flakesScale),i.flakesRoughness&&t.uniform1f(i.flakesRoughness,this.flakesRoughness),i.pearlFlakesDensity&&t.uniform1f(i.pearlFlakesDensity,this.pearlFlakesDensity),i.pearlFlakesBump&&t.uniform1f(i.pearlFlakesBump,this.pearlFlakesBump),this.flakesColorMulCoef&&i.flakesColorMulCoef&&t.uniform3f(i.flakesColorMulCoef,this.flakesColorMulCoef.x,this.flakesColorMulCoef.y,this.flakesColorMulCoef.z),this.flakesColorAddCoef&&i.flakesColorAddCoef&&t.uniform3f(i.flakesColorAddCoef,this.flakesColorAddCoef.x,this.flakesColorAddCoef.y,this.flakesColorAddCoef.z),this.pearlFlakesColorMulCoef&&i.pearlFlakesColorMulCoef&&t.uniform3f(i.pearlFlakesColorMulCoef,this.pearlFlakesColorMulCoef.x,this.pearlFlakesColorMulCoef.y,this.pearlFlakesColorMulCoef.z),this.pearlFlakesColorAddCoef&&i.pearlFlakesColorAddCoef&&t.uniform3f(i.pearlFlakesColorAddCoef,this.pearlFlakesColorAddCoef.x,this.pearlFlakesColorAddCoef.y,this.pearlFlakesColorAddCoef.z))},T.prototype.isEnabled=function(){return this.flakes},T.prototype.clone=function(e){return new T(this,e)},T.prototype.setMaterialShaderOptions=function(e){Object.assign(e,{specGlossFlakes:this.isEnabled()})};var b=function(t,i){_(this,"clearCoat",0),_(this,"clearCoatRoughness",0),_(this,"clearCoatColor",new e.Color(3684408)),this.coatingGlossinessMap=null,this.coatingGlossinessMulCoef=null,this.coatingGlossinessAddCoef=null,M(this,"clearCoatNormal"),this.clearCoatNormalMapFlipY=!1,this.clearCoatNormalScaleMulCoef=1,this.clearCoatNormalScaleAddCoef=0,this.clearCoatNormalScale=1,this.orangePeel=!1,this.orangePeelScale=0,y.call(this,t,i)};(b.prototype=Object.create(y.prototype)).loadUniforms=function(e,t,i,a){if(this.isEnabled()){var s;if(i.clearCoat&&t.uniform1f(i.clearCoat,this.clearCoat),i.clearCoatMap&&e.loadTexture(t,i.clearCoatMap,this.clearCoatMap),i.clearCoatMulCoef&&t.uniform1f(i.clearCoatMulCoef,this.clearCoatMulCoef),i.clearCoatAddCoef&&t.uniform1f(i.clearCoatAddCoef,this.clearCoatAddCoef),i.clearCoatRoughness&&t.uniform1f(i.clearCoatRoughness,this.clearCoatRoughness),i.clearCoatRoughnessMap&&e.loadTexture(t,i.clearCoatRoughnessMap,this.clearCoatRoughnessMap),i.clearCoatRoughnessMulCoef&&(t.uniform1f(i.clearCoatRoughnessMulCoef,this.clearCoatRoughnessMulCoef),t.uniform1f(i.clearCoatRoughnessAddCoef,this.clearCoatRoughnessAddCoef)),i.coatingGlossinessMap&&e.loadTexture(t,i.coatingGlossinessMap,this.coatingGlossinessMap),i.coatingGlossinessMulCoef&&(t.uniform1f(i.coatingGlossinessMulCoef,this.coatingGlossinessMulCoef),t.uniform1f(i.coatingGlossinessAddCoef,this.coatingGlossinessAddCoef)),i.clearCoatNormalMap&&e.loadTexture(t,i.clearCoatNormalMap,this.clearCoatNormalMap),i.clearCoatNormalMulCoef&&(t.uniform3f(i.clearCoatNormalAddCoef,this.clearCoatNormalAddCoef.x,this.clearCoatNormalAddCoef.y,this.clearCoatNormalAddCoef.z),t.uniform3f(i.clearCoatNormalMulCoef,this.clearCoatNormalMulCoef.x,this.clearCoatNormalMulCoef.y,this.clearCoatNormalMulCoef.z)),i.clearCoatNormalScale&&t.uniform1f(i.clearCoatNormalScale,this.clearCoatNormalScaleMulCoef*this.clearCoatNormalScale+this.clearCoatNormalScaleAddCoef),i.clearCoatColor)s=e.gammaInput?S.copyToLinear(this.clearCoatColor,e.simpleGamma):this.clearCoatColor,t.uniform3f(i.clearCoatColor,s.r,s.g,s.b);i.clearCoatColorMap&&e.loadTexture(t,i.clearCoatColorMap,this.clearCoatColorMap),i.clearCoatColorMulCoef&&(t.uniform3f(i.clearCoatColorMulCoef,this.clearCoatColorMulCoef.x,this.clearCoatColorMulCoef.y,this.clearCoatColorMulCoef.z),t.uniform3f(i.clearCoatColorAddCoef,this.clearCoatColorAddCoef.x,this.clearCoatColorAddCoef.y,this.clearCoatColorAddCoef.z)),i.orangePeelScale&&i.orangePeelScale&&t.uniform1f(i.orangePeelScale,this.orangePeelScale)}},b.prototype.isEnabled=function(){return this.clearCoat>0||this._isTextureAvailable("clearCoatMap")},b.prototype.setMaterialShaderOptions=function(e){var t=this.isEnabled();Object.assign(e,{clearCoat:t,clearCoatMap:t&&this._isTextureAvailable("clearCoatMap"),clearCoatMulCoef:t&&null!==this.clearCoatMulCoef,clearCoatAddCoef:t&&null!==this.clearCoatAddCoef,clearCoatRoughnessMap:t&&this._isTextureAvailable("clearCoatRoughnessMap"),clearCoatRoughnessMulCoef:t&&null!==this.clearCoatRoughnessMulCoef,clearCoatRoughnessAddCoef:t&&null!==this.clearCoatRoughnessAddCoef,clearCoatColorMap:t&&this._isTextureAvailable("clearCoatColorMap"),clearCoatColorMapLinear:t&&!!this.clearCoatColorMap&&this.clearCoatColorMap.linear,clearCoatColorMulCoef:t&&null!==this.clearCoatColorMulCoef,clearCoatColorAddCoef:t&&null!==this.clearCoatColorAddCoef,coatingGlossinessMap:t&&!e.dspbr&&this._isTextureAvailable("coatingGlossinessMap"),coatingGlossinessMulCoef:t&&!e.dspbr&&null!==this.coatingGlossinessMulCoef,coatingGlossinessAddCoef:t&&!e.dspbr&&null!==this.coatingGlossinessAddCoef,clearCoatNormalMap:t&&this._isTextureAvailable("clearCoatNormalMap"),clearCoatNormalMapFlipY:t&&this.clearCoatNormalMapFlipY,clearCoatNormalMulCoef:t&&null!==this.clearCoatNormalMulCoef,clearCoatNormalAddCoef:t&&null!==this.clearCoatNormalAddCoef,orangePeel:t&&this.orangePeel&&!this.clearCoatNormalMap})},b.prototype.getTextures=function(){return[this.clearCoatMap,this.clearCoatColorMap,this.coatingGlossinessMap,this.clearCoatRoughnessMap,this.clearCoatNormalMap]},b.prototype.setParameters=function(e){y.prototype.setParameters.call(this,e),this.clearCoatUvTransform=g(this.clearCoatUvTransform),this.clearCoatRoughnessUvTransform=g(this.clearCoatRoughnessUvTransform),this.clearCoatColorUvTransform=g(this.clearCoatColorUvTransform),this.clearCoatNormalUvTransform=g(this.clearCoatNormalUvTransform)},b.prototype.clone=function(e){return new b(this,e)};var A=function(t,i){this.attenuationColor=new e.Color(16777215),this.attenuationDistance=1e6,this.subsurfaceColor=new e.Color(0),this.subsurfaceAnisotropy=0,this._sssLUT=null,this._scatteringCoeffs=null,this._absorptionCoeffs=null,this._translucencyDepth=null,this._updateSSS=0,this._subsurface=!1,y.call(this,t,i)};(A.prototype=Object.create(y.prototype)).loadUniforms=function(e,t,i,a){this.isEnabled()&&(i.sssLUT?(e.loadTexture(t,i.sssLUT,this._sssLUT),t.uniform3f(i.maxTranslucencyDepth,this._translucencyDepth[0],this._translucencyDepth[1],this._translucencyDepth[2])):i.absorptionCoefficients&&t.uniform3f(i.absorptionCoefficients,this._absorptionCoeffs[0],this._absorptionCoeffs[1],this._absorptionCoeffs[2]))},A.prototype.isEnabled=function(){return this._subsurface},A.prototype.setMaterialShaderOptions=function(e){var t=this.isEnabled();Object.assign(e,{subsurface:t,sssLUT:t&&!!this._sssLUT})},A.prototype.getTextures=function(){return[]},A.prototype.setParameters=function(t){var i=this.__parent__,a=this._subsurface,s=void 0!==t.subsurfacePreset&&t.subsurfacePreset!==f.None,r=t.subsurfaceColor?t.subsurfaceColor:this.subsurfaceColor,n=t.attenuationColor?t.attenuationColor:this.attenuationColor;this._subsurface=r.getHex()>0||s;var o=!0;if(!this._subsurface&&n.getHex()<16711422&&(o=!1,this._subsurface=!0),this._subsurface=this._subsurface&&!i.thinWalled,y.prototype.setParameters.call(this,t),this._subsurface){if(s){var l=c[t.subsurfacePreset];this.subsurfaceColor=new e.Color(16777215),this._absorptionCoeffs=l.absorptionCoeffs.slice(0),this._scatteringCoeffs=l.scatteringCoeffs.slice(0)}else{var h=this.attenuationColor,p=Math.max(this.attenuationDistance,1e-6),d=this.subsurfaceColor,u=new e.Color(0);u.r=-Math.log(Math.min(.999,Math.max(h.r,.001)))/p,u.b=-Math.log(Math.min(.999,Math.max(h.b,.001)))/p,u.g=-Math.log(Math.min(.999,Math.max(h.g,.001)))/p;var m=new e.Color(0);m.r=1-Math.pow(4.09712+4.20863*d.r-Math.sqrt(9.59217+41.6808*d.r+17.7126*d.r*d.r),2),m.b=1-Math.pow(4.09712+4.20863*d.b-Math.sqrt(9.59217+41.6808*d.b+17.7126*d.b*d.b),2),m.g=1-Math.pow(4.09712+4.20863*d.g-Math.sqrt(9.59217+41.6808*d.g+17.7126*d.g*d.g),2);var S=new e.Color(0);S.r=u.r*(1-m.r),S.g=u.g*(1-m.g),S.b=u.b*(1-m.b),this._absorptionCoeffs=S.toArray();var M=new e.Color(0);M.r=u.r*m.r,M.g=u.g*m.g,M.b=u.b*m.b,this._scatteringCoeffs=M.toArray()}this._updateSSS=o?2:1}i&&this._subsurface!==a&&(i.needsUpdate=!0)},A.prototype.clone=function(e){return new A(this,e)};var x=function(e,t){_(this,"thickness",0),y.call(this,e,t)};(x.prototype=Object.create(y.prototype)).loadUniforms=function(e,t,i,a){this.isEnabled()&&(i.thickness&&t.uniform1f(i.thickness,this.thickness),i.thicknessMap&&e.loadTexture(t,i.thicknessMap,this.thicknessMap),i.thicknessAddCoef&&(t.uniform1f(i.thicknessMulCoef,this.thicknessMulCoef),t.uniform1f(i.thicknessAddCoef,this.thicknessAddCoef)))},x.prototype.isEnabled=function(){return!this.__parent__.thinWalled&&(this.thickness>0||this._isTextureAvailable("thicknessMap"))},x.prototype.setMaterialShaderOptions=function(e,t){var i=this.isEnabled();Object.assign(e,{thicknessMap:i&&this._isTextureAvailable("thicknessMap"),thickness:i,thicknessMulCoef:i&&null!==this.thicknessMulCoef,thicknessAddCoef:i&&null!==this.thicknessAddCoef})},x.prototype.getTextures=function(){return[this.thicknessMap]},x.prototype.setParameters=function(e){y.prototype.setParameters.call(this,e),this.thicknessUvTransform=g(this.thicknessUvTransform)},x.prototype.clone=function(){return new x(this)};var U=function(e,t){_(this,"anisotropy",0),_(this,"anisotropyAngle",0),y.call(this,e,t)};(U.prototype=Object.create(y.prototype)).loadUniforms=function(e,t,i,a){this.isEnabled()&&(i.anisotropy&&t.uniform1f(i.anisotropy,this.anisotropy),i.anisotropyMap&&e.loadTexture(t,i.anisotropyMap,this.anisotropyMap),i.anisotropyMulCoef&&(t.uniform1f(i.anisotropyMulCoef,this.anisotropyMulCoef),t.uniform1f(i.anisotropyAddCoef,this.anisotropyAddCoef)),i.anisotropyAngle&&t.uniform1f(i.anisotropyAngle,this.anisotropyAngle),i.anisotropyAngleMap&&e.loadTexture(t,i.anisotropyAngleMap,this.anisotropyAngleMap),i.anisotropyAngleMulCoef&&(t.uniform1f(i.anisotropyAngleMulCoef,this.anisotropyAngleMulCoef),t.uniform1f(i.anisotropyAngleAddCoef,this.anisotropyAngleAddCoef)))},U.prototype.isEnabled=function(){return this.anisotropy>0||this._isTextureAvailable("anisotropyMap")},U.prototype.setMaterialShaderOptions=function(e){var t=this.isEnabled();Object.assign(e,{anisotropy:t,anisotropyMap:t&&this._isTextureAvailable("anisotropyMap"),anisotropyMulCoef:t&&null!==this.anisotropyMulCoef,anisotropyAddCoef:t&&null!==this.anisotropyAddCoef,anisotropyAngleMap:t&&this._isTextureAvailable("anisotropyAngleMap"),anisotropyAngleMulCoef:t&&null!==this.anisotropyAngleMulCoef,anisotropyAngleAddCoef:t&&null!==this.anisotropyAngleAddCoef})},U.prototype.getTextures=function(){return[this.anisotropyMap,this.anisotropyAngleMap]},U.prototype.setParameters=function(e,t){y.prototype.setParameters.call(this,e,t),this.anisotropyUvTransform=g(this.anisotropyUvTransform),this.anisotropyAngleUvTransform=g(this.anisotropyAngleUvTransform)},U.prototype.clone=function(e){return new U(this,e)};var E=function(e,t){M(this,"displacement"),this.displacementScale=1,this.displacementBias=0,this.__needDisplacementUpdate=!1,y.call(this,e,t)};(E.prototype=Object.create(y.prototype)).loadUniforms=function(e,t,i,a){if(this.isEnabled()&&i.displacementMap){if(e.loadTexture(t,i.displacementMap,this.displacementMap),this.__needDisplacementUpdate)if(this.__needDisplacementUpdate=!("complete"===this.displacementMap.loadEndStatus||"error"===this.displacementMap.loadEndStatus),!this.__needDisplacementUpdate)this.__parent__._sendEvent("requestShadowMapUpdate");i.displacementBias&&t.uniform1f(i.displacementBias,this.displacementBias),i.displacementMapSize&&t.uniform2f(i.displacementMapSize,this.displacementMap.image.width,this.displacementMap.image.height),i.displacementScale&&t.uniform1f(i.displacementScale,this.displacementScale),i.displacementAddCoef&&(t.uniform3f(i.displacementAddCoef,this.displacementAddCoef.x,this.displacementAddCoef.y,this.displacementAddCoef.z),t.uniform3f(i.displacementMulCoef,this.displacementMulCoef.x,this.displacementMulCoef.y,this.displacementMulCoef.z))}},E.prototype.isEnabled=function(){return this._isTextureAvailable("displacementMap")},E.prototype.setMaterialShaderOptions=function(e){var t=this.__parent__.__physicalMode,i=!e._isDecal&&this.isEnabled()&&(e.specgloss||t>=l);Object.assign(e,{displacementMap:i,displacementAddCoef:i&&null!==this.displacementAddCoef,displacementMulCoef:i&&null!==this.displacementMulCoef})},E.prototype.getTextures=function(){return[this.displacementMap]},E.prototype.setParameters=function(t){y.prototype.setParameters.call(this,t),this.displacementUvTransform=g(this.displacementUvTransform),this.__needDisplacementUpdate=this.displacementMap&&this.displacementMap.loadEndStatus!==e.AssetLoadingStatus.READY},E.prototype.clone=function(e){return new E(this,e)};var F=function(e,t){_(this,"iridescence",0),_(this,"iridescenceThickness",1),this.iridescenceIoR=1.5,this.iridescenceThicknessAddCoef=.1,this.iridescenceThicknessMulCoef=.3,y.call(this,e,t)};(F.prototype=Object.create(y.prototype)).loadUniforms=function(e,t,i,a){this.isEnabled()&&(t.uniform1f(i.iridescenceIoR,this.iridescenceIoR),i.iridescence&&t.uniform1f(i.iridescence,this.iridescence),i.iridescenceMap&&e.loadTexture(t,i.iridescenceMap,this.iridescenceMap),i.iridescenceAddCoef&&(t.uniform1f(i.iridescenceAddCoef,this.iridescenceAddCoef),t.uniform1f(i.iridescenceMulCoef,this.iridescenceMulCoef)),i.iridescenceThickness&&t.uniform1f(i.iridescenceThickness,this.iridescenceThickness),i.iridescenceThicknessMap&&e.loadTexture(t,i.iridescenceThicknessMap,this.iridescenceThicknessMap),i.iridescenceThicknessAddCoef&&(t.uniform1f(i.iridescenceThicknessAddCoef,this.iridescenceThicknessAddCoef),t.uniform1f(i.iridescenceThicknessMulCoef,this.iridescenceThicknessMulCoef)))},F.prototype.isEnabled=function(){return this.iridescence>0||this._isTextureAvailable("iridescenceMap")},F.prototype.setMaterialShaderOptions=function(e){var t=this.isEnabled();Object.assign(e,{iridescence:t,iridescenceMap:t&&this._isTextureAvailable("iridescenceMap"),iridescenceAddCoef:t&&null!==this.iridescenceAddCoef,iridescenceMulCoef:t&&null!==this.iridescenceAddCoef,iridescenceThicknessMap:t&&this._isTextureAvailable("iridescenceThicknessMap"),iridescenceThicknessAddCoef:t&&null!==this.iridescenceThicknessAddCoef,iridescenceThicknessMulCoef:t&&null!==this.iridescenceThicknessMulCoef})},F.prototype.getTextures=function(){return[this.iridescenceMap,this.iridescenceThicknessMap]},F.prototype.setParameters=function(e){y.prototype.setParameters.call(this,e),this.iridescenceThicknessUvTransform=g(this.iridescenceThicknessUvTransform),this.iridescenceUvTransform=g(this.iridescenceUvTransform)},F.prototype.clone=function(e){return new F(this,e)};var O=function(t,i){_(this,"sheen",0),_(this,"sheenRoughness",0),_(this,"sheenColor",new e.Color(0)),this.sheenMode=d._NO_SHEEN,y.call(this,t,i)};(O.prototype=Object.create(y.prototype)).loadUniforms=function(e,t,i,a){if(this.isEnabled()){var s;i.sheen&&t.uniform1f(i.sheen,this.sheen),i.sheenMap&&e.loadTexture(t,i.sheenMap,this.sheenMap),i.sheenMulCoef&&(t.uniform1f(i.sheenMulCoef,this.sheenMulCoef),t.uniform1f(i.sheenAddCoef,this.sheenAddCoef)),i.sheenRoughness&&t.uniform1f(i.sheenRoughness,this.sheenRoughness),i.sheenRoughnessMap&&e.loadTexture(t,i.sheenRoughnessMap,this.sheenRoughnessMap),i.sheenRoughnessMulCoef&&(t.uniform1f(i.sheenRoughnessMulCoef,this.sheenRoughnessMulCoef),t.uniform1f(i.sheenRoughnessAddCoef,this.sheenRoughnessAddCoef)),i.sheenColor&&(s=e.gammaInput?S.copyToLinear(this.sheenColor,e.simpleGamma):this.sheenColor,t.uniform3f(i.sheenColor,s.r,s.g,s.b)),i.sheenColorMap&&e.loadTexture(t,i.sheenColorMap,this.sheenColorMap),i.sheenColorMulCoef&&(t.uniform3f(i.sheenColorMulCoef,this.sheenColorMulCoef.x,this.sheenColorMulCoef.y,this.sheenColorMulCoef.z),t.uniform3f(i.sheenColorAddCoef,this.sheenColorAddCoef.x,this.sheenColorAddCoef.y,this.sheenColorAddCoef.z));var r=this.__parent__;i.envMapSheen&&null!==r._sheenData&&e.loadTexture(t,i.envMapSheen,r._sheenData.envMipMap)}},O.prototype.isEnabled=function(){return this.sheen>0||!!this._isTextureAvailable("sheenMap")},O.prototype.setMaterialShaderOptions=function(e){var t=this.isEnabled();Object.assign(e,{sheen:t,sheenMap:t&&this._isTextureAvailable("sheenMap"),sheenMulCoef:t&&null!==this.sheenMulCoef,sheenAddCoef:t&&null!==this.sheenAddCoef,sheenColorMap:t&&this._isTextureAvailable("sheenColorMap"),sheenColorMapLinear:t&&!!this.sheenColorMap&&this.sheenColorMap.hdr,sheenColorMulCoef:t&&null!==this.sheenColorMulCoef,sheenColorAddCoef:t&&null!==this.sheenColorAddCoef,sheenRoughnessMap:t&&this._isTextureAvailable("sheenRoughnessMap"),sheenRoughnessMulCoef:t&&null!==this.sheenRoughnessMulCoef,sheenRoughnessAddCoef:t&&null!==this.sheenRoughnessAddCoef,sheenMode:t&&this.sheenMode})},O.prototype.getTextures=function(){return[this.sheenMap,this.sheenColorMap,this.sheenRoughnessMap]},O.prototype.setParameters=function(e){y.prototype.setParameters.call(this,e),this.sheenUvTransform=g(this.sheenUvTransform),this.sheenRoughnessUvTransform=g(this.sheenRoughnessUvTransform),this.sheenColorUvTransform=g(this.sheenColorUvTransform)},O.prototype.clone=function(e){return new O(this,e)};var I=function(i){t.call(this),i=i||{},this.__physicalMode=o,i&&i.dspbr21x&&(this.__physicalMode=l),i&&i.dspbr22x&&(this.__physicalMode=h),i&&i.dspbr23x&&(this.__physicalMode=p),this._phongFallbackMaterial=null,this.lights=!0,this.thinWalled=!0,this.color=new e.Color(16777215),this.map=null,this.diffuseUvSlot=1,this.diffuseUvTransform=m,this.diffuseMulCoef=null,this.diffuseAddCoef=null,_(this,"specular",new e.Color(16777215)),_(this,"metalness",0),_(this,"specularContrib",1),_(this,"emissionColor",new e.Color(16777215)),this.emissionValue=0,this.emissionNormalized=!1,_(this,"transparency",0),_(this,"opacity",1),this.useAlphaFromDiffuseMap=!0,this.ior=1.4,_(this,"roughness",0),this.glossinessMap=null,this.glossinessMulCoef=null,this.glossinessAddCoef=null,this.reflectionProbes=null,this.envMipMap=null,this.envMap=null,this.overrideIBL=null,_(this,"translucency",0),_(this,"translucencyColor",new e.Color(0)),this.bumpMap=null,this.bumpUvSlot=1,this.bumpUvTransform=m,_(this,"bumpScale",1),M(this,"normal"),this.normalMapFlipY=!1,_(this,"normalScale",new e.Vector2(1,1)),this.useLighting=!0,this.perPixel=!0,this.needTangent=!1,this.needTangentBinormal=!1,this.NRECompatibility=!0,this.setValues(i),this.normalUvTransform=g(this.normalUvTransform),this.bumpUvTransform=g(this.bumpUvTransform),this.bumpScaleUvTransform=g(this.bumpScaleUvTransform),this.normalScaleUvTransform=g(this.normalScaleUvTransform),this.diffuseUvTransform=g(this.diffuseUvTransform),this.specularUvTransform=g(this.specularUvTransform),this.metalnessUvTransform=g(this.metalnessUvTransform),this.emissionColorUvTransform=g(this.emissionColorUvTransform),this.specularContribUvTransform=g(this.specularContribUvTransform),this.transparencyUvTransform=g(this.transparencyUvTransform),this.opacityUvTransform=g(this.opacityUvTransform),this.translucencyUvTransform=g(this.translucencyUvTransform),this.translucencyColorUvTransform=g(this.translucencyColorUvTransform),this.roughnessUvTransform=g(this.roughnessUvTransform),this._dspbrFlakes=null,this.setDSPBRFlakes(i),this._specGlossFlakes=null,this._dspbrFlakes||this.setSpecGlossFlakes(i),this._clearCoat=null,this.setClearCoat(i),this._volume=null,this.setVolume(i),this._mapFromOldParameters(i),this._sheenData=null,this._sheen=null,this.setSheen(i),this._anisotropy=null,this.setAnisotropy(i),this._displacement=null,this.setDisplacement(i),this._iridescence=null,this.setIridescence(i),this._thickness=null,this.setThickness(i),this.ambienceMatrix=new e.Matrix4,this.useFiniteEnvMap=!1,this.parallaxCorrectionParameters=null,this._fromGLTF=i&&i._fromGLTF?1:0,this._fromGLTF=i&&i._fromGLTF_SpecGloss?2:this._fromGLTF};return(I.prototype=Object.create(t.prototype)).isPhysicalMaterial=!0,I.prototype._setTypeParams=function(e){e.specGloss=!1,e.specGlossNRE=!1,e.dspbr19x=!1,e.dspbr21x=!1,e.dspbr22x=!1,e.dspbr23x=!1},I.prototype._shaderID="physicalDS",I.prototype.requireVertexTangentBinormal=function(){return this._displacement&&this._displacement.isEnabled()},I.prototype._dump=function(){var e=t.prototype._dump.call(this);e.subType=this.getSubType(),e.color=this.color.toArray(),e.specular=this.specular.toArray(),this.specularMap&&(e.specularMap="textured"),e.roughness=this.roughness,this.roughnessMap&&(e.roughness="textured");var i=this.getType();return i.includes("DSPBR")?(this.map&&(e.color="textured"),e.transparency=this.transparency,this.transparencyMap&&(e.transparency="textured"),e.emissionColor=this.emissionColor.toArray(),this.emissionColorMap&&(e.emissionColor="textured"),e.emissionValue=this.emissionValue,e.metalness=this.metalness,this.metalnessMap&&(e.metalness="textured"),e.specularContribution=this.specularContrib,this.specularContribMap&&(e.specularContribution="textured"),e.ior=this.ior):i.includes("SpecGloss")?(this.map&&(e.color="textured"),e.transparency=this.transparency,this.transparencyMap&&(e.transparency="textured"),e.emissionColor=this.emissionColor.toArray(),this.emissionColorMap&&(e.emissionColor="textured")):"CATGraphicalMaterial"===i&&this.map&&(e.texture=!0),e},I.prototype.requireTangentBinormal=function(){return this.needTangentBinormal||this._anisotropy&&this._anisotropy.isEnabled()||!!this.normalMap||!(!this._clearCoat||!this._clearCoat.clearCoatNormalMap)||this.requireVertexTangentBinormal()},I.prototype.getSubType=function(){return"Generic"},I.prototype.getType=function(){switch(this.__physicalMode){case r:case n:return"SpecGloss";case o:return"DSPBR19x";case l:return"DSPBR21x";case h:return"DSPBR22x";case p:return"DSPBR23x"}return"DSPBR19x"},I.prototype._deallocate=function(e){t.prototype._deallocate.call(this,e),e&&(e.ambianceGenerators&&(e.ambianceGenerators.decreaseUseCount("m"+this.id),e.ambianceGenerators.decreaseUseCount("ms"+this.id)),e.sssGenerator&&this._volume&&this._volume._sssLUT&&e.sssGenerator.decreaseUseCount(this._volume._sssLUT.id)),this._phongFallbackMaterial&&this._phongFallbackMaterial.dispose()},I.prototype._autoForceSide=!0,I.prototype._transparencyOnGPU=function(e){return t.prototype._transparencyOnGPU.call(this,e)||this.opacityMap||this.transparencyMap||this.opacityAddCoef>0||this.transparencyAddCoef>0||this.map&&(this.useAlphaFromDiffuseMap||this.transparency>0)},I.prototype._isTransparent=function(e){return t.prototype._isTransparent.call(this,e)||this.transparency>0},I.prototype._mapFromOldParameters=function(e){this.__physicalMode>=l||(e.hasOwnProperty("emissive")&&(this.emissionColor.copy(e.emissive),this.emissionColorMap=e.hasOwnProperty("emissiveMap")?e.emissiveMap:this.emissionColorMap,this.emissionColorAddCoef=e.hasOwnProperty("emissiveAddCoef")?e.emissiveAddCoef:this.emissionColorAddCoef,this.emissionColorMulCoef=e.hasOwnProperty("emissiveMulCoef")?e.emissiveMulCoef:this.emissionColorMulCoef,this.emissionColorUvSlot=e.hasOwnProperty("emissiveUvSlot")?e.emissiveUvSlot:this.emissionColorUvSlot,this.emissionColorUvTransform=e.hasOwnProperty("emissiveUvTransform")?e.emissiveUvTransform:this.emissionColorUvTransform,this.emissionValue=1,this.emissionNormalized=!1),e.hasOwnProperty("coating")&&(this._clearCoat||(this._clearCoat=new b(e)),this._clearCoat.clearCoat=e.coating),e.hasOwnProperty("glossiness")&&(this.metalness<1e-6&&null===this.metalnessMap&&(this.__physicalMode=r,this.metalness=0,this.metalnessMap=null),this.roughness=1-e.glossiness,this.roughnessMap=null,this.thinWalled=!0),e.hasOwnProperty("glossinessMap")&&(this.metalness<1e-6&&null===this.metalnessMap&&(this.__physicalMode=r,this.metalness=0,this.metalnessMap=null),this.roughnessMap=null,this.thinWalled=!0,this.roughnessUvSlot=e.hasOwnProperty("glossinessUvSlot")?e.glossinessUvSlot:this.roughnessUvSlot,this.roughnessUvTransform=e.hasOwnProperty("glossinessUvTransform")?e.glossinessUvTransform:this.roughnessUvTransform),this._clearCoat&&(e.hasOwnProperty("coatingGlossiness")&&(this.metalness<1e-6&&null===this.metalnessMap&&(this.__physicalMode=r,this.metalness=0,this.metalnessMap=null),this._clearCoat.clearCoatRoughness=1-e.coatingGlossiness),e.hasOwnProperty("coatingGlossinessMap")&&(this.metalness<1e-6&&null===this.metalnessMap&&(this.__physicalMode=r,this.metalness=0,this.metalnessMap=null),this._clearCoat.clearCoatRoughnessMap=null,this.thinWalled=!0,this._clearCoat.clearCoatRoughnessUvSlot=e.hasOwnProperty("coatingGlossinessUvSlot")?e.coatingGlossinessUvSlot:this._clearCoat.clearCoatRoughnessUvSlot,this._clearCoat.clearCoatRoughnessUvTransform=e.hasOwnProperty("coatingGlossinessUvTransform")?e.coatingGlossinessUvTransform:this._clearCoat.clearCoatRoughnessUvTransform)),e.specGloss&&(this.__physicalMode=r,this.metalness=0,this.metalnessMap=null),e.specGlossNRE&&(this.__physicalMode=n,this.metalness=0,this.metalnessMap=null))},I.prototype._canUseLights=function(){return this.useLighting},I.prototype._setMaterialShaderOptions=function(e,i,a,s,d,f){t.prototype._setMaterialShaderOptions.call(this,e,i,a,s,d,f);var c={specgloss:this.__physicalMode===r||this.__physicalMode===n,specglossNRE:this.__physicalMode===n,dspbr:this.__physicalMode>=o,dspbr19x:this.__physicalMode===o,dspbr21x:this.__physicalMode===l,dspbr22x:this.__physicalMode===h,dspbr23x:this.__physicalMode===p,NRECompatibility:!!this.NRECompatibility,thinWalled:this.thinWalled,useAlphaFromDiffuseMap:this.useAlphaFromDiffuseMap,fromGLTF:this._fromGLTF};Object.assign(c,{diffuseMulCoef:null!==this.diffuseMulCoef,diffuseAddCoef:null!==this.diffuseAddCoef,diffuseBorderColorU:!!this.map&&this.map._useBorderColor().u,diffuseBorderColorV:!!this.map&&this.map._useBorderColor().v,specularContribMap:this._isTextureAvailable("specularContribMap"),specularContribMulCoef:null!==this.specularContribMulCoef,specularContribAddCoef:null!==this.specularContribAddCoef,specularMap:this._isTextureAvailable("specularMap"),specularMapLinear:!!this.specularMap&&this.specularMap.hdr,specularMulCoef:null!==this.specularMulCoef,specularAddCoef:null!==this.specularAddCoef,transparencyMap:this._isTextureAvailable("transparencyMap"),transparencyMulCoef:null!==this.transparencyMulCoef,transparencyAddCoef:null!==this.transparencyAddCoef,metalnessMap:this._isTextureAvailable("metalnessMap"),metalnessMulCoef:null!==this.metalnessMulCoef,metalnessAddCoef:null!==this.metalnessAddCoef,opacityMap:this._isTextureAvailable("opacityMap"),opacityBorderColorU:!!this.opacityMap&&this.opacityMap._useBorderColor().u,opacityBorderColorV:!!this.opacityMap&&this.opacityMap._useBorderColor().v,opacityMulCoef:null!==this.opacityMulCoef,opacityAddCoef:null!==this.opacityAddCoef}),this._thickness&&this._thickness.setMaterialShaderOptions(c),this._volume&&this._volume.setMaterialShaderOptions(c),this._displacement&&(c._isDecal=e._isDecal,this._displacement.setMaterialShaderOptions(c)),i&&(Object.assign(c,{emissionColorMap:this._isTextureAvailable("emissionColorMap"),emissionNormalized:this.emissionNormalized,emissionColorMapLinear:/*!!material.emissionColorMapLinear || */!!this.emissionColorMap&&this.emissionColorMap.hdr,emissionColorMulCoef:null!==this.emissionColorMulCoef,emissionColorAddCoef:null!==this.emissionColorAddCoef,translucencyMap:this._isTextureAvailable("translucencyMap"),translucencyMulCoef:null!==this.translucencyMulCoef,translucencyAddCoef:null!==this.translucencyAddCoef,translucencyColorMap:this._isTextureAvailable("translucencyColorMap"),translucencyColorMapLinear:!!this.translucencyColorMap&&this.translucencyColorMap.hdr,translucencyColorMulCoef:null!==this.translucencyColorMulCoef,translucencyColorAddCoef:null!==this.translucencyColorAddCoef}),this._dspbrFlakes?this._dspbrFlakes.setMaterialShaderOptions(c):this._specGlossFlakes&&this._specGlossFlakes.setMaterialShaderOptions(c),this._clearCoat&&this._clearCoat.setMaterialShaderOptions(c),this._sheen&&this._sheen.setMaterialShaderOptions(c),this._anisotropy&&this._anisotropy.setMaterialShaderOptions(c),this._iridescence&&this._iridescence.setMaterialShaderOptions(c),c.useFlakes=c.dspbrFlakes||c.specGlossFlakes),(i||a||s)&&Object.assign(c,{normalScaleMap:this._isTextureAvailable("normalScaleMap"),normalMulCoef:null!==this.normalMulCoef,normalAddCoef:null!==this.normalAddCoef,normalScaleMulCoef:null!==this.normalScaleMulCoef,normalScaleAddCoef:null!==this.normalScaleAddCoef,bumpScaleMap:this._isTextureAvailable("bumpScaleMap"),bumpScaleMulCoef:null!==this.bumpScaleMulCoef,bumpScaleAddCoef:null!==this.bumpScaleAddCoef}),(i||d||s)&&Object.assign(c,{roughnessMap:this._isTextureAvailable("roughnessMap"),glossinessMap:!c.dspbr&&this._isTextureAvailable("glossinessMap"),glossinessMulCoef:!c.dspbr&&null!==this.glossinessMulCoef,glossinessAddCoef:!c.dspbr&&null!==this.glossinessAddCoef,roughnessMulCoef:null!==this.roughnessMulCoef,roughnessAddCoef:null!==this.roughnessAddCoef}),Object.assign(e,c),e.subsurface&&!e.thickness&&(e.maxDirIBLShadows=e._maxDirIBLShadows,e.maxShadows+=e._maxDirIBLShadows,e.shadowMapEnabled=e._shadowMapEnabled&&e.maxShadows>0)},I.prototype.getOpacity=function(){return 1-Math.max(1-this.opacity,Math.min(this.transparency,.99))},I.prototype._getTextures=function(e){var i=t.prototype._getTextures.call(this,e);return i=i.concat([this.map,this.specularMap,this.metalnessMap,this.specularContribMap,this.emissionColorMap,this.transparencyMap,this.opacityMap,this.translucencyMap,this.translucencyColorMap,this.normalScaleMap,this.bumpScaleMap,this.roughnessMap,this.glossinessMap,this.bumpMap,this.normalMap]),this._dspbrFlakes?i=i.concat(this._dspbrFlakes.getTextures()):this._specGlossFlakes&&(i=i.concat(this._specGlossFlakes.getTextures())),this._clearCoat&&(i=i.concat(this._clearCoat.getTextures())),this._volume&&!e&&(i=i.concat(this._volume.getTextures())),this._thickness&&(i=i.concat(this._thickness.getTextures())),this._sheen&&(i=i.concat(this._sheen.getTextures())),this._anisotropy&&(i=i.concat(this._anisotropy.getTextures())),this._displacement&&(i=i.concat(this._displacement.getTextures())),this._iridescence&&(i=i.concat(this._iridescence.getTextures())),i},I.prototype.clone=function(e){return e||(e=new I),e.__physicalMode=this.__physicalMode,t.prototype.clone.call(this,e),e.useLighting=this.useLighting,e.perPixel=this.perPixel,e.thinWalled=this.thinWalled,e.color.copy(this.color),e.map=this.map,e.diffuseUvSlot=this.diffuseUvSlot,e.diffuseUvTransform=this.diffuseUvTransform,e.diffuseMulCoef=this.diffuseMulCoef,e.diffuseAddCoef=this.diffuseAddCoef,v(this,e,"specular",!0),v(this,e,"metalness",!1),v(this,e,"specularContrib",!1),v(this,e,"emissionColor",!0),e.emissionValue=this.emissionValue,e.emissionNormalized=this.emissionNormalized,v(this,e,"transparency",!1),v(this,e,"opacity",!1),e.useAlphaFromDiffuseMap=this.useAlphaFromDiffuseMap,e.ior=this.ior,v(this,e,"roughness",!1),e.glossinessMap=this.glossinessMap,e.glossinessMulCoef=this.glossinessMulCoef,e.glossinessAddCoef=this.glossinessAddCoef,e.reflectionProbes=this.reflectionProbes,e.envMipMap=this.envMipMap,e.envMap=this.envMap,e.overrideIBL=null!==this.overrideIBL?this.overrideIBL.clone():null,v(this,e,"translucency",!1),v(this,e,"translucencyColor",!0),e.bumpMap=this.bumpMap,e.bumpUvSlot=this.bumpUvSlot,e.bumpUvTransform=this.bumpUvTransform,v(this,e,"bumpScale",!1),C(this,e,"normal"),e.normalMapFlipY=this.normalMapFlipY,v(this,e,"normalScale",!0),this._dspbrFlakes?e._dspbrFlakes=this._dspbrFlakes.clone(e):this._specGlossFlakes&&(e._specGlossFlakes=this._specGlossFlakes.clone(e)),this._clearCoat&&(e._clearCoat=this._clearCoat.clone(e)),this._volume&&(e._volume=this._volume.clone(e)),e._sheenData=null!==this._sheenData?this._sheenData.clone():null,this._sheen&&(e._sheen=this._sheen.clone(e)),this._anisotropy&&(e.anisotropy=this._anisotropy.clone(e)),this._displacement&&(e._displacement=this._displacement.clone(e)),this._iridescence&&(e._iridescence=this._iridescence.clone(e)),this._thickness&&(e._thickness=this._thickness.clone(e)),e.needTangent=this.needTangent,e.needTangentBinormal=this.needTangentBinormal,e.NRECompatibility=this.NRECompatibility,e.ambienceMatrix=this.ambienceMatrix,e.parallaxCorrectionParameters=this.parallaxCorrectionParameters,e.useFiniteEnvMap=this.useFiniteEnvMap,e._fromGLTF=this._fromGLTF,e},I.prototype.setOverrideIBL=function(e){this.overrideIBL=new s(e),null!==this._sheenData&&(this._sheenData.overrideIBL.hdr=this.overrideIBL.hdr),this.needsUpdate=!0},I.prototype._needsIBLLightExtraction=function(){var e=this._volume&&this._volume.isEnabled(),t=this._thickness&&(this._thickness.thickness>0||!!this._thickness.thicknessMap);return e&&!t},I.prototype._forceOpaqueShadowMapPass=function(){var e=this._volume&&this._volume.isEnabled(),t=this._thickness&&(this._thickness.thickness>0||!!this._thickness.thicknessMap);return e&&!t},I.prototype.setAnisotropy=function(e){e&&(this._anisotropy?this._anisotropy.setParameters(e):(e.anisotropyMap||e.anisotropy>0)&&(this._anisotropy=new U(e,this),this.needsUpdate=!0))},I.prototype.setDisplacement=function(e){e&&(this._displacement?this._displacement.setParameters(e):e.displacementMap&&(this._displacement=new E(e,this),this.needsUpdate=!0))},I.prototype.setIridescence=function(e){e&&(this._iridescence?this._iridescence.setParameters(e):(e.iridescence>0||e.iridescenceMap)&&(this._iridescence=new F(e,this),this.needsUpdate=!0))},I.prototype.setThickness=function(e){e&&(!this._thickness&&(e.thicknessMap||e.thickness>0)?(this._thickness=new x(e,this),this.needsUpdate=!0):this._thickness&&this._thickness.setParameters(e))},I.prototype.setVolume=function(e){if(e){var t=this.thinWalled;this.thinWalled=void 0!==e.thinWalled?!!e.thinWalled:this.thinWalled,this.ior=e.ior?e.ior:this.ior,!this._volume&&(e.subsurfacePreset||e.subsurfaceColor&&e.subsurfaceColor.getHex()>0||e.attenuationColor&&e.attenuationColor.getHex()<16711422)?(this._volume=new A(e,this),this.needsUpdate=!0):this._volume&&this._volume.setParameters(e),t!==this.thinWalled&&(this.needsUpdate=!0),this.needsUpdate&&this._volume&&(this._sendEvent("requestShadowMapUpdate"),this._invalidateDisplayRangeLists())}},I.prototype._updateSubsurfaceScattering=function(e){var t=this._volume;if(e.manager){this.needsUpdate=this.needsUpdate||null===t._sssLUT;var i=t._sssLUT;if(1===t._updateSSS)i&&e.decreaseUseCount(i.id),t._sssLUT=null,t._translucencyDepth=null,i&&(this.needsUpdate=!0);else{var a={absorptionCoeffs:t._absorptionCoeffs,scatteringCoeffs:t._scatteringCoeffs,eta:this.ior,subsurfaceAnisotropy:t.subsurfaceAnisotropy,color:t.subsurfaceColor.toArray()},s=e.getTextures(a);t._sssLUT=s.sssLUT,t._translucencyDepth=s.translucencyDepth,null!==i&&i.id!==t._sssLUT.id&&e.decreaseUseCount(i.id)}t._updateSSS=0}else e.init()},I.prototype.activatePDSFX=function(e){e=e||{},this._PDSFXData=new i,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions()},I.prototype.setDSPBRFlakes=function(e){e&&(null===this._dspbrFlakes&&(e.flakesCoverageMap||e.flakesCoverage>0)?(this._dspbrFlakes=new D(e,this),this._specGlossFlakes&&(this._specGlossFlakes=null),this.needsUpdate=!0):this._dspbrFlakes&&this._dspbrFlakes.setParameters(e))},I.prototype.setSpecGlossFlakes=function(e){e&&(null===this._specGlossFlakes&&e.flakes?(this._specGlossFlakes=new T(e,this),this._dspbrFlakes&&(this._dspbrFlakes=null),this.needsUpdate=!0):this._specGlossFlakes&&this._specGlossFlakes.setParameters(e))},I.prototype.setClearCoat=function(e){e&&(null===this._clearCoat&&(e.clearCoat>0||e.clearCoatMap)?(this._clearCoat=new b(e,this),this.needsUpdate=!0):this._clearCoat&&this._clearCoat.setParameters(e))},I.prototype.setSheen=function(t){var i={};Object.assign(i,t);var r=!1;if(this.__physicalMode>=h?(i.sheen=void 0,i.sheenMap=void 0,i.sheenMulCoef=void 0,i.sheenAddCoef=void 0,i.sheenUvSlot=void 0,i.sheenUvTransform=void 0,!i.sheenColor||i.sheenColor instanceof e.Color||(i.sheenColor=new e.Color(i.sheenColor)),i.sheenColor&&i.sheenColor.getHex()>0||i.sheenColorMap?(i.sheen=1,r=!0):i.sheenColor&&0===i.sheenColor.getHex()&&(i.sheen=0)):(i.sheen>0||i.sheenMap)&&(r=!0),this._sheen?this._sheen.setParameters(i):r&&(i.sheenMode||(i.sheenMode=this.__physicalMode>=l?d.VELVET_SOFT:d.VELVET),this._sheen=new O(i,this),this.needsUpdate=!0),this._sheen){var n=this._sheen;if(n.sheenMode!==d._NO_SHEEN){var o=null;switch(null===this._sheenData?(null!==this.overrideIBL?(o=this.overrideIBL.clone()).mips=null:o=new s({}),this._sheenData=new u({overrideIBL:o})):(o=this._sheenData.overrideIBL,null!==this.overrideIBL&&(o.hdr=this.overrideIBL.hdr)),n.sheenMode){case d.VELVET:o.brdf=a.ASHIKMIN;break;case d.SATIN:o.brdf=a.BECKMANN;break;case d.VELVET_SOFT:o.brdf=a.ESTEVEZKULLA}}}},I.prototype.loadUniforms=function(e,t,i,a,s,r){if(e.loadUniformsCommon(t,this,i,a,s,r),e.loadUniformsNormalMap(t,this,i),i.reflectionColorTexture&&(t.uniform2f(i.invScreenSize,1/e.domElement.width,1/e.domElement.height),e.loadTexture(t,i.reflectionColorTexture,e._getReflectionColorBufferResult())),i.refractionColorTexture&&(t.uniform2f(i.invScreenSize,1/e.domElement.width,1/e.domElement.height),e.loadTexture(t,i.refractionColorTexture,e._getRefractionColorBufferResult())),i.normalMap&&(i.normalScale&&t.uniform2f(i.normalScale,this.normalScale.x,this.normalScale.y),i.normalScaleMap&&e.loadTexture(t,i.normalScaleMap,this.normalScaleMap),i.normalScaleAddCoef&&(t.uniform1f(i.normalScaleAddCoef,this.normalScaleAddCoef),t.uniform1f(i.normalScaleMulCoef,this.normalScaleMulCoef)),i.normalAddCoef&&(t.uniform3f(i.normalAddCoef,this.normalAddCoef.x,this.normalAddCoef.y,this.normalAddCoef.z),t.uniform3f(i.normalMulCoef,this.normalMulCoef.x,this.normalMulCoef.y,this.normalMulCoef.z))),i.bumpMap&&(i.bumpScale&&t.uniform1f(i.bumpScale,this.bumpScale),i.bumpScaleAddCoef&&(t.uniform1f(i.bumpScaleAddCoef,this.bumpScaleAddCoef),t.uniform1f(i.bumpScaleMulCoef,this.bumpScaleMulCoef)),i.bumpMap&&e.loadTexture(t,i.bumpMap,this.bumpMap),i.bumpScaleMap&&e.loadTexture(t,i.bumpScaleMap,this.bumpScaleMap)),i.diffuseAddCoef&&(t.uniform3f(i.diffuseAddCoef,this.diffuseAddCoef.x,this.diffuseAddCoef.y,this.diffuseAddCoef.z),t.uniform3f(i.diffuseMulCoef,this.diffuseMulCoef.x,this.diffuseMulCoef.y,this.diffuseMulCoef.z)),i.diffuseBorderColor){var n={r:(l=this.map.borderColor).x,g:l.y,b:l.z};e.gammaInput&&(n=S.copyToLinear(n,e.simpleGamma)),t.uniform4f(i.diffuseBorderColor,n.r,n.g,n.b,l.w)}if(i.specular){var o=this.specular;n=e.gammaInput?S.copyToLinear(o,e.simpleGamma):o,t.uniform3f(i.specular,n.r,n.g,n.b)}if(i.specularAddCoef&&(t.uniform3f(i.specularAddCoef,this.specularAddCoef.x,this.specularAddCoef.y,this.specularAddCoef.z),t.uniform3f(i.specularMulCoef,this.specularMulCoef.x,this.specularMulCoef.y,this.specularMulCoef.z)),i.metalness&&t.uniform1f(i.metalness,this.metalness),i.metalnessMap&&e.loadTexture(t,i.metalnessMap,this.metalnessMap),i.metalnessMulCoef&&(t.uniform1f(i.metalnessMulCoef,this.metalnessMulCoef),t.uniform1f(i.metalnessAddCoef,this.metalnessAddCoef)),i.specularContrib&&t.uniform1f(i.specularContrib,this.specularContrib),i.specularContribMap&&e.loadTexture(t,i.specularContribMap,this.specularContribMap),i.specularContribMulCoef&&(t.uniform1f(i.specularContribMulCoef,this.specularContribMulCoef),t.uniform1f(i.specularContribAddCoef,this.specularContribAddCoef)),i.emissionColor){n=this.emissionColor;e.gammaInput&&(n=S.copyToLinear(this.emissionColor,e.simpleGamma)),t.uniform3f(i.emissionColor,n.r,n.g,n.b)}if(i.emissionColorMap&&e.loadTexture(t,i.emissionColorMap,this.emissionColorMap),i.emissionColorAddCoef&&(t.uniform3f(i.emissionColorAddCoef,this.emissionColorAddCoef.x,this.emissionColorAddCoef.y,this.emissionColorAddCoef.z),t.uniform3f(i.emissionColorMulCoef,this.emissionColorMulCoef.x,this.emissionColorMulCoef.y,this.emissionColorMulCoef.z)),i.emissionValue&&t.uniform1f(i.emissionValue,this.emissionValue),i.transparency&&t.uniform1f(i.transparency,this.transparency),i.transparencyMap&&e.loadTexture(t,i.transparencyMap,this.transparencyMap),i.transparencyMulCoef&&(t.uniform1f(i.transparencyMulCoef,this.transparencyMulCoef),t.uniform1f(i.transparencyAddCoef,this.transparencyAddCoef)),i.opacityMap&&(e.loadTexture(t,i.opacityMap,this.opacityMap),i.opacityBorderValue)){var l=this.opacityMap.borderColor;t.uniform1f(i.opacityBorderValue,l.x)}if(i.opacityMulCoef&&(t.uniform1f(i.opacityMulCoef,this.opacityMulCoef),t.uniform1f(i.opacityAddCoef,this.opacityAddCoef)),i.ior&&t.uniform1f(i.ior,this.ior),i.translucency&&t.uniform1f(i.translucency,this.translucency),i.translucencyMap&&e.loadTexture(t,i.translucencyMap,this.translucencyMap),i.translucencyMulCoef&&(t.uniform1f(i.translucencyMulCoef,this.translucencyMulCoef),t.uniform1f(i.translucencyAddCoef,this.translucencyAddCoef)),i.translucencyColor){n=this.translucencyColor;e.gammaInput&&(n=S.copyToLinear(this.emissionColor,e.simpleGamma)),t.uniform3f(i.translucencyColor,n.r,n.g,n.b)}if(i.translucencyColorMap&&e.loadTexture(t,i.translucencyMap,this.translucencyMap),i.translucencyColorMulCoef&&(t.uniform3f(i.translucencyColorMulCoef,this.translucencyColorMulCoef.x,this.translucencyColorMulCoef.y,this.translucencyColorMulCoef.z),t.uniform3f(i.translucencyColorAddCoef,this.translucencyColorAddCoef.x,this.translucencyColorAddCoef.y,this.translucencyColorAddCoef.z)),i.roughness&&t.uniform1f(i.roughness,this.roughness),i.roughnessMap&&e.loadTexture(t,i.roughnessMap,this.roughnessMap),i.roughnessMulCoef&&(t.uniform1f(i.roughnessMulCoef,this.roughnessMulCoef),t.uniform1f(i.roughnessAddCoef,this.roughnessAddCoef)),i.glossinessMap&&e.loadTexture(t,i.glossinessMap,this.glossinessMap),i.glossinessMulCoef&&(t.uniform1f(i.glossinessMulCoef,this.glossinessMulCoef),t.uniform1f(i.glossinessAddCoef,this.glossinessAddCoef)),this.useFiniteEnvMap&&(i.sphereCenter&&t.uniform3f(i.sphereCenter,this.parallaxCorrectionParameters.sphereCenter.x,this.parallaxCorrectionParameters.sphereCenter.y,this.parallaxCorrectionParameters.sphereCenter.z),i.projectionCenter&&t.uniform3f(i.projectionCenter,this.parallaxCorrectionParameters.projectionCenter.x,this.parallaxCorrectionParameters.projectionCenter.y,this.parallaxCorrectionParameters.projectionCenter.z),i.sphereRadius&&t.uniform1f(i.sphereRadius,this.parallaxCorrectionParameters.sphereRadius)),this._dspbrFlakes?this._dspbrFlakes.loadUniforms(e,t,i,a):this._specGlossFlakes&&this._specGlossFlakes.loadUniforms(e,t,i,a),this._clearCoat&&this._clearCoat.loadUniforms(e,t,i,a),this._sheen&&this._sheen.loadUniforms(e,t,i,a,this),this._volume&&this._volume.loadUniforms(e,t,i,a),this._thickness&&this._thickness.loadUniforms(e,t,i,a),this._anisotropy&&this._anisotropy.loadUniforms(e,t,i,a),this._displacement&&this._displacement.loadUniforms(e,t,i,a,this),this._iridescence&&this._iridescence.loadUniforms(e,t,i,a),i.precomputedTexture){var h=e.precomputedTexture;e.loadTexture(t,i.precomputedTexture,h)}if(i.envMap&&this.envMipMap&&this.envMipMap[0]){var p=1,d=1;if(i.envMap&&e.loadTexture(t,i.envMap,this.envMipMap[0]),i.envMap2&&e.loadTexture(t,i.envMap2,this.envMipMap[1]),this.envMipMap[0].hdr&&i.envMapHDRSize&&(this.envMipMap[0].image?(p=parseInt(this.envMipMap[0].image.width),d=parseInt(this.envMipMap[0].image.height)):(p=parseInt(this.envMipMap[0].width),d=parseInt(this.envMipMap[0].height)),t.uniform2f(i.envMapHDRSize,p,d)),this.envMipMap[1]&&i.envMapHDRToMipsRatio){var f=1;f=this.envMipMap[1].image?parseInt(this.envMipMap[1].image.width)/p:parseInt(this.envMipMap[1].width)/p,t.uniform1f(i.envMapHDRToMipsRatio,f)}var c=this.envMipMap[0].envMapExposureSpecular,u=this.envMipMap[0].envMapExposureDiffuse;i.envMapExposureSpecular&&t.uniform1f(i.envMapExposureSpecular,c||0===c?c:1),i.envMapExposureDiffuse&&t.uniform1f(i.envMapExposureDiffuse,u||0===u?u:1),i.ambienceMatrix&&t.uniformMatrix4fv(i.ambienceMatrix,!1,e.float32Matrix4x4Temp.setDoubles(this.ambienceMatrix.elements))}i.reflectionProbe&&this.reflectionProbes&&this.reflectionProbes.length&&(i.reflectionProbe&&e.loadTexture(t,i.reflectionProbe,this.reflectionProbes[0].map0),i.reflectionProbeMips&&e.loadTexture(t,i.reflectionProbeMips,this.reflectionProbes[0].map1),i.reflectionProbePos&&t.uniform3f(i.reflectionProbePos,this.reflectionProbes[0].position.x,this.reflectionProbes[0].position.y,this.reflectionProbes[0].position.z),i.reflectionProbeProxyMin&&t.uniform3f(i.reflectionProbeProxyMin,this.reflectionProbes[0].geomProxy.min.x,this.reflectionProbes[0].geomProxy.min.y,this.reflectionProbes[0].geomProxy.min.z),i.reflectionProbeProxyMax&&t.uniform3f(i.reflectionProbeProxyMax,this.reflectionProbes[0].geomProxy.max.x,this.reflectionProbes[0].geomProxy.max.y,this.reflectionProbes[0].geomProxy.max.z),i.envMapHDRToMipsRatio&&t.uniform1f(i.envMapHDRToMipsRatio,1)),r&&r._mappingOperator||this._loadTextureInfo(this,this,e,t,i,!1)},I.prototype._loadTextureInfo=function(e,t,i,a,s,r){var n=e,o=t;s.normalUvTransform&&(a.uniform1i(s.normalUvSlot,o.normalUvSlot),a.uniformMatrix3fv(s.normalUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.normalUvTransform.elements))),s.bumpUvTransform&&(a.uniform1i(s.bumpUvSlot,o.bumpUvSlot),a.uniformMatrix3fv(s.bumpUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.bumpUvTransform.elements))),s.bumpScaleUvTransform&&(a.uniform1i(s.bumpScaleUvSlot,o.bumpScaleUvSlot),a.uniformMatrix3fv(s.bumpScaleUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.bumpScaleUvTransform.elements))),s.normalScaleUvTransform&&(a.uniform1i(s.normalScaleUvSlot,o.normalScaleUvSlot),a.uniformMatrix3fv(s.normalScaleUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.normalScaleUvTransform.elements))),s.diffuseUvTransform&&(a.uniform1i(s.diffuseUvSlot,o.diffuseUvSlot),a.uniformMatrix3fv(s.diffuseUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.diffuseUvTransform.elements))),s.specularUvTransform&&(a.uniform1i(s.specularUvSlot,o.specularUvSlot),a.uniformMatrix3fv(s.specularUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.specularUvTransform.elements))),s.metalnessUvTransform&&(a.uniform1i(s.metalnessUvSlot,o.metalnessUvSlot),a.uniformMatrix3fv(s.metalnessUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.metalnessUvTransform.elements))),s.emissionColorUvTransform&&(a.uniform1i(s.emissionColorUvSlot,o.emissionColorUvSlot),a.uniformMatrix3fv(s.emissionColorUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.emissionColorUvTransform.elements))),s.specularContribUvTransform&&(a.uniform1i(s.specularContribUvSlot,o.specularContribUvSlot),a.uniformMatrix3fv(s.specularContribUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.specularContribUvTransform.elements))),s.transparencyUvTransform&&(a.uniform1i(s.transparencyUvSlot,o.transparencyUvSlot),a.uniformMatrix3fv(s.transparencyUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.transparencyUvTransform.elements))),s.opacityUvTransform&&(a.uniform1i(s.opacityUvSlot,o.opacityUvSlot),a.uniformMatrix3fv(s.opacityUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.opacityUvTransform.elements))),s.translucencyUvTransform&&(a.uniform1i(s.translucencyUvSlot,o.translucencyUvSlot),a.uniformMatrix3fv(s.translucencyUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.translucencyUvTransform.elements))),s.translucencyColorUvTransform&&(a.uniform1i(s.translucencyColorUvSlot,o.translucencyColorUvSlot),a.uniformMatrix3fv(s.translucencyColorUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.translucencyColorUvTransform.elements))),s.roughnessUvTransform&&(a.uniform1i(s.roughnessUvSlot,o.roughnessUvSlot),a.uniformMatrix3fv(s.roughnessUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.roughnessUvTransform.elements))),s.anisotropy&&(n=r?e:e._anisotropy,o=r?t:t._anisotropy,s.anisotropyUvTransform&&(a.uniform1i(s.anisotropyUvSlot,o.anisotropyUvSlot),a.uniformMatrix3fv(s.anisotropyUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.anisotropyUvTransform.elements))),s.anisotropyAngleUvTransform&&(a.uniform1i(s.anisotropyAngleUvSlot,o.anisotropyAngleUvSlot),a.uniformMatrix3fv(s.anisotropyAngleUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.anisotropyAngleUvTransform.elements)))),s.displacementUvTransform&&(n=r?e:e._displacement,o=r?t:t._displacement,a.uniform1i(s.displacementUvSlot,o.displacementUvSlot),a.uniformMatrix3fv(s.displacementUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.displacementUvTransform.elements))),s.iridescenceUvTransform&&(n=r?e:e._iridescence,o=r?t:t._iridescence,a.uniform1i(s.iridescenceUvSlot,o.iridescenceUvSlot),a.uniformMatrix3fv(s.iridescenceUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.iridescenceUvTransform.elements))),s.iridescenceThicknessUvTransform&&(n=r?e:e._iridescence,o=r?t:t._iridescence,a.uniform1i(s.iridescenceThicknessUvSlot,o.iridescenceThicknessUvSlot),a.uniformMatrix3fv(s.iridescenceThicknessUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.iridescenceThicknessUvTransform.elements))),(s.sheen||s.sheenMap||s.sheenColor||s.sheenColorMap)&&(n=r?e:e._sheen,o=r?t:t._sheen,s.sheenUvTransform&&(a.uniform1i(s.sheenUvSlot,o.sheenUvSlot),a.uniformMatrix3fv(s.sheenUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.sheenUvTransform.elements))),s.sheenRoughnessUvTransform&&(a.uniform1i(s.sheenRoughnessUvSlot,o.sheenRoughnessUvSlot),a.uniformMatrix3fv(s.sheenRoughnessUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.sheenRoughnessUvTransform.elements))),s.sheenColorUvTransform&&(a.uniform1i(s.sheenColorUvSlot,o.sheenColorUvSlot),a.uniformMatrix3fv(s.sheenColorUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.sheenColorUvTransform.elements)))),(s.clearCoat||s.clearCoatMap)&&(n=r?e:e._clearCoat,o=r?t:t._clearCoat,s.clearCoatRoughnessUvTransform&&(a.uniform1i(s.clearCoatRoughnessUvSlot,o.clearCoatRoughnessUvSlot),a.uniformMatrix3fv(s.clearCoatRoughnessUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.clearCoatRoughnessUvTransform.elements))),s.clearCoatUvTransform&&(a.uniform1i(s.clearCoatUvSlot,o.clearCoatUvSlot),a.uniformMatrix3fv(s.clearCoatUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.clearCoatUvTransform.elements))),s.clearCoatNormalUvTransform&&(a.uniform1i(s.clearCoatNormalUvSlot,o.clearCoatNormalUvSlot),a.uniformMatrix3fv(s.clearCoatNormalUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.clearCoatNormalUvTransform.elements))),s.clearCoatColorUvTransform&&(a.uniform1i(s.clearCoatColorUvSlot,o.clearCoatColorUvSlot),a.uniformMatrix3fv(s.clearCoatColorUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.clearCoatColorUvTransform.elements)))),s.thicknessUvTransform&&(n=r?e:e._thickness,o=r?t:t._thickness,a.uniform1i(s.thicknessUvSlot,o.thicknessUvSlot),a.uniformMatrix3fv(s.thicknessUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.thicknessUvTransform.elements))),(s.flakesCoverage||s.flakesCoverageMap)&&(n=r?e:e._dspbrFlakes,o=r?t:t._dspbrFlakes,s.flakesRoughnessUvTransform&&(a.uniform1i(s.flakesRoughnessUvSlot,o.flakesRoughnessUvSlot),a.uniformMatrix3fv(s.flakesRoughnessUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.flakesRoughnessUvTransform.elements))),s.flakesSizeUvTransform&&(a.uniform1i(s.flakesSizeUvSlot,o.flakesSizeUvSlot),a.uniformMatrix3fv(s.flakesSizeUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.flakesSizeUvTransform.elements))),s.flakesCoverageUvTransform&&(a.uniform1i(s.flakesCoverageUvSlot,o.flakesCoverageUvSlot),a.uniformMatrix3fv(s.flakesCoverageUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.flakesCoverageUvTransform.elements))),s.flakesColorUvTransform&&(a.uniform1i(s.flakesColorUvSlot,o.flakesColorUvSlot),a.uniformMatrix3fv(s.flakesColorUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.flakesColorUvTransform.elements))),s.flipFlopUvTransform&&(a.uniform1i(s.flipFlopUvSlot,o.flipFlopUvSlot),a.uniformMatrix3fv(s.flipFlopUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.flipFlopUvTransform.elements))),s.flipFlopColorUvTransform&&(a.uniform1i(s.flipFlopColorUvSlot,o.flipFlopColorUvSlot),a.uniformMatrix3fv(s.flipFlopColorUvTransform,!1,i.float32Matrix3x3Temp.setDoubles(n.flipFlopColorUvTransform.elements))))},I.prototype.areTexturesLoaded=function(){return!!t.prototype.areTexturesLoaded.call(this)&&((!this.envMipMap||!this.envMipMap[0]||this.envMipMap[0].loadEndStatus!==e.AssetLoadingStatus.LOADING)&&(!this.envMipMap||!this.envMipMap[1]||this.envMipMap[1].loadEndStatus!==e.AssetLoadingStatus.LOADING))},I.prototype._computeAmbianceKeyAndProcessMaterial=function(e,t,i,s,r,n){if(this._needsUpdateIfTexturesAreReady(),this._volume&&this._volume._updateSSS>0&&this._updateSubsurfaceScattering(s),!e)return 0;if(t.envMipMap.length>0&&t.envMipMap[0].hdr&&(null===t.envMipMap[1]||t.envMipMapID)){var o=t.envMipMap[0],l=t.id+"s"+o.id,h=o.id;h+="-"+a.GGX,t.envMipMapID&&t.envMipMapID!==l&&i.decreaseUseCount(t.envMipMapID),t.envMipMapID=l,i.manager?t.envMipMap[1]=i.getAmbiance(h,!0,{hdr:o,brdf:a.GGX},l).ambiance:(i.init(0),t.envMipMap[1]=i._dummyRoughnessTexture)}var p=null!==this.overrideIBL&&this.overrideIBL._useCustom();if(t.envMipMap.length>0&&t.envMipMap[1]||p){if(p){l="m"+this.id,o=(S=this.overrideIBL).hdr,h=S.name;h+="-"+o.id,h+="-"+S.brdf,this.overrideIBL.curID&&this.overrideIBL.curID!==o.id&&i.decreaseUseCount(l),this.overrideIBL.curID=o.id;var d=null;null!==S.mips?d=S.mips:i.manager?d=i.getAmbiance(h,!S.direct,{hdr:o,brdf:S.brdf},l).ambiance:(i.init(0),d=i._dummyRoughnessTexture),null!==d&&(this.envMap=o,this.envMipMap=[o,d])}else this.envMipMap=t.envMipMap,this.envMap=t.envMipMap[0];this.ambienceMatrix=t.ambienceMatrix}else t.reflectionProbes.length||(this.envMipMap=null,this.envMap=null);if(this._sheenData){var f=this._sheenData,c=null!==f.overrideIBL,u=c&&f._useCustom(),m=c&&!u&&t.envMipMap.length>0;if(c=u||m){var S=f.overrideIBL;if(m){o=t.envMipMap[0],l=t.id+"s"+o.id;h=o.id;h+="-"+S.brdf,t.envMipMapSheenID&&t.envMipMapSheenID!==l&&i.decreaseUseCount(t.envMipMapSheenID),t.envMipMapSheenID=l}else{l="ms"+this.id,o=S.hdr;h=S.name;h+="-"+o.id,h+="-"+S.brdf,f.overrideIBL.curID&&f.overrideIBL.curID!==o.id&&i.decreaseUseCount(l),f.overrideIBL.curID=o.id}d=null;i.manager?d=i.getAmbiance(h,!S.direct,{hdr:o,brdf:S.brdf},l).ambiance:(i.init(1),d=i._dummyRoughnessTexture),this._sheenData.envMipMap=d}}return this._needsIBLLightExtraction()&&this.envMap&&0===r.dirIBLLights&&this._sendEvent("requestIBLLightExtraction",{rendererID:n}),t.reflectionProbes.length?(this.envMap=t.reflectionProbes[0].map0,this.reflectionProbes=t.reflectionProbes):this.reflectionProbes=null,t.useFiniteEnvMap?(this.useFiniteEnvMap=t.useFiniteEnvMap,this.parallaxCorrectionParameters=t.parallaxCorrectionParameters):this.useFiniteEnvMap=!1,(this.envMap?1:0)|(this.reflectionProbes?2:0)|(this._sheenData&&this._sheenData.envMipMap?4:0)|(this.useFiniteEnvMap?8:0)|(this.envMap&&this.envMap.rgbHdr?16:0)|(this.envMipMap&&this.envMipMap[1]&&this.envMipMap[1].hasDiffuse?32:0)},I.prototype._defaultPDSFXOverridableFunctions=function(){var i=t.prototype._defaultPDSFXOverridableFunctions.call(this);return Object.assign(i.fragment,{ComputeViewNormal:e.ShaderChunk.PDSFXComputeViewNormal_FS,ComputeSpecularReflectance:e.ShaderChunk.PDSFXComputeSpecularReflectance_FS,ComputeEmissive:e.ShaderChunk.PDSFXComputeEmissive_FS,ComputeRoughness:e.ShaderChunk.PDSFXComputeRoughness_FS,ComputeTransparency:e.ShaderChunk.PDSFXComputeTransparency_FS}),i},I.prototype.updateDeferredMaterials=function(i){t.prototype.updateDeferredMaterials.call(this,i),this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial]=this},I}),define("DS/Materials/DSPBR22x",["DS/Mesh/ThreeJS_Base","DS/Materials/PhysicalMaterial"],function(e,t){"use strict";const i=e.DSPBRSubTypes;var a=function(e){e=e||{};var a={};Object.assign(a,e),this._setTypeParams(a),a.dspbr22x=!0,this._subtype=void 0!==a._subtype?a._subtype:i.Generic,t.call(this,a)};return(a.prototype=Object.create(t.prototype)).getSubType=function(){switch(this._subtype){case i.Metal:return"Metal";case i.Glass:return"Glass";case i.Plastic:return"Plastic";case i.Textile:return"Textile";case i.Leather:return"Leather";case i["Car Paint"]:return"Car Paint";case i.Emissive:return"Emissive";case i.Basic:return"Basic";case i.Wood:return"Wood"}return"Generic"},a.prototype.clone=function(){var e=new a;return t.prototype.clone.call(this,e),e._subtype=this._subtype,e},a}),define("DS/Materials/DSPBR21x",["DS/Mesh/ThreeJS_Base","DS/Materials/PhysicalMaterial"],function(e,t){"use strict";var i=function(e){e=e||{};var i={};Object.assign(i,e),this._setTypeParams(i),i.dspbr21x=!0,t.call(this,i)};return(i.prototype=Object.create(t.prototype)).clone=function(){var e=new i;return t.prototype.clone.call(this,e),e},i}),define("DS/Materials/DSPBR23x",["DS/Mesh/ThreeJS_Base","DS/Materials/PhysicalMaterial"],function(e,t){"use strict";const i=e.DSPBRSubTypes;var a=function(e){e=e||{};var a={};Object.assign(a,e),this._setTypeParams(a),a.DSPBR23x=!0,this._subtype=void 0!==a._subtype?a._subtype:i.Generic,t.call(this,a)};return(a.prototype=Object.create(t.prototype)).getSubType=function(){switch(this._subtype){case i.Metal:return"Metal";case i.Glass:return"Glass";case i.Plastic:return"Plastic";case i.Textile:return"Textile";case i.Leather:return"Leather";case i["Car Paint"]:return"Car Paint";case i.Emissive:return"Emissive";case i.Basic:return"Basic";case i.Wood:return"Wood"}return"Generic"},a.prototype.clone=function(){var e=new a;return t.prototype.clone.call(this,e),e._subtype=this._subtype,e},a}),define("DS/Materials/MeshBasicMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData","DS/Materials/DeferredCaches"],function(e,t,i,a){"use strict";var s=function(i){t.call(this),this.color=new e.Color(16777215),this.map=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this._depthValue=0,this._sceneGraphOrderMode=0,this.morphTargets=!1,this.numSupportedMorpTargets=0,this.canvasNodeTextureSaveParams=null,this.setValues(i)};return(s.prototype=Object.create(t.prototype))._getTextures=function(e){var i=t.prototype._getTextures.call(this,e);return i=i.concat([this.map])},s.prototype.getType=function(){return"Basic"},s.prototype._dump=function(){var e=t.prototype._dump.call(this);return e.color=this.color.toArray(),this.map&&(e.color="textured"),e},s.prototype._canUseLights=function(){return!1},s.prototype._shaderID="basic",s.prototype._transparencyOnGPU=function(e){return t.prototype._transparencyOnGPU.call(this,e)||this.map&&this.transparent},s.prototype.getPredefinedMaterial=function(t,i,r){var n=this.getBaseId();switch(n+="NonLighted",n+="S"+this.side,n+="CP"+this.enableClipPlanes,n+="Type"+i,i){case e.DefaultAppearanceMode.__QA_AUTOMATION__:var o=this.map?new e.Color(11184810):this.color;if(n+="Col"+o.getHex(),n="id"+(n+="Op"+this._opacity).hashCode(),!a.PredefinedMaterials.has(n)){var l=new s({side:this.side,enableClipPlanes:this.enableClipPlanes,color:o,opacity:this._opacity});l.activatePDSFX();var h={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor.rgb = ComputeAlbedo();","ioFinalColor.a = ComputeOpacity();","#ifdef GAMMA_OUTPUT","ioFinalColor.rgb = sqrt(ioFinalColor.rgb);","#endif","}"].join("\n")};l.setPDSFXOverridableFunctions({},h);var p=new a.DeferredMaterial(l);a.PredefinedMaterials.set(n,p)}break;default:return this}return a.PredefinedMaterials.get(n).get(this)},s.prototype.clone=function(e){return e||(e=new s),t.prototype.clone.call(this,e),e.color.copy(this.color),e.map=this.map,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.morphTargets=this.morphTargets,e.numSupportedMorpTargets=this.numSupportedMorpTargets,e.canvasNodeTextureSize=this.canvasNodeTextureSize,e.canvasNodeTextureSaveParams=this.canvasNodeTextureSaveParams,e},s.prototype.activatePDSFX=function(e){e=e||{},this._PDSFXData=new i,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions(),this._PDSFXData.PDSFX_hasAlbedo=!0,this._PDSFXData.PDSFX_hasOpacity=!0},s.prototype.loadUniforms=function(e,t,i,a,s,r){e.loadUniformsCommon(t,this,i,a,s,r),e.loadUniformsDepthLayer(t,this,i)},s}),define("DS/Materials/SectionBuilderMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/MeshBasicMaterial"],function(e,t){"use strict";var i={};i.VS_global=["#define SECTION_BUILDER","vec4 getClipPlaneEquation(in int index);","float getDist(vec4 pos) {","  vec4 clipPlaneEquation = getClipPlaneEquation(currentClipPlane);","  float dist = dot( pos.xyz, clipPlaneEquation.xyz ) + clipPlaneEquation.w;","  return dist;","}","vec4 getIntersection( vec4 M, vec4 N) {","  vec4 clipPlaneEquation = getClipPlaneEquation(currentClipPlane);","  vec3 direction = vec3(N.x - M.x, N.y - M.y, N.z - M.z);","  vec4 result;","  float t;","  float denominator = dot(direction, clipPlaneEquation.xyz);","  if(denominator == 0.0) {","    return M;","  } else {","    t = -(dot(M.xyz, clipPlaneEquation.xyz) + clipPlaneEquation.w) / denominator;","    result = vec4(t*direction+M.xyz, 1.0);","    return result;","  }","}","float far;","float near;","bool hide;","vec4 mvCurrInter;","vec4 mvOtherInter;","float linearizeNDC(in float iNonLinearNDC) {","\tfloat z01 = 0.5*iNonLinearNDC + 0.5;","\tfloat res = 2.0*near/(far + near - z01*(far - near));","\tres = res *2.0 - 1.0;","\treturn res;","}"].join("\n"),i.FS_global="#define SECTION_BUILDER";var a=["vec3 _position = vGetAttribPosition();","float i1 = _position.x;","float i2 = _position.y;","float i3 = _position.z;","float maxMapTotalSize = MAX_OUTLINE_MAP_SIZE*MAX_OUTLINE_MAP_SIZE;","int texId_1 = int(floor(i1/maxMapTotalSize));","int texId_2 = int(floor(i2/maxMapTotalSize));","int texId_3 = int(floor(i3/maxMapTotalSize));","float dx_1, dx_2, dx_3;","float dy_1, dy_2, dy_3;","float x_1, x_2, x_3;","float y_1, y_2, y_3;","float idInTexture_1 = i1 - float(texId_1)*maxMapTotalSize;","float idInTexture_2 = i2 - float(texId_2)*maxMapTotalSize;","float idInTexture_3 = i3 - float(texId_3)*maxMapTotalSize;","if (texId_1 == NB_OUTLINE_MAPS - 1) {","dx_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_1 = floor(idInTexture_1/LAST_OUTLINE_MAP_SIZE_X);","x_1 = idInTexture_1 - y_1*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_1 = floor(idInTexture_1/MAX_OUTLINE_MAP_SIZE);","x_1 = idInTexture_1 - y_1*MAX_OUTLINE_MAP_SIZE;","}","if (texId_2 == NB_OUTLINE_MAPS - 1) {","dx_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_2 = floor(idInTexture_2/LAST_OUTLINE_MAP_SIZE_X);","x_2 = idInTexture_2 - y_2*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_2 = floor(idInTexture_2/MAX_OUTLINE_MAP_SIZE);","x_2 = idInTexture_2 - y_2*MAX_OUTLINE_MAP_SIZE;","}","if (texId_3 == NB_OUTLINE_MAPS - 1) {","dx_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;","dy_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;","y_3 = floor(idInTexture_3/LAST_OUTLINE_MAP_SIZE_X);","x_3 = idInTexture_3 - y_3*LAST_OUTLINE_MAP_SIZE_X;","} else {","dx_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;","dy_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;","y_3 = floor(idInTexture_3/MAX_OUTLINE_MAP_SIZE);","x_3 = idInTexture_3 - y_3*MAX_OUTLINE_MAP_SIZE;","}","vec3 P = texture2D( outlinePositionMaps[texId_1], vec2( dx_1 * ( x_1 + 0.5 ), dy_1 * ( y_1 + 0.5 ) ) ).xyz;","vec3 M = texture2D( outlinePositionMaps[texId_2], vec2( dx_2 * ( x_2 + 0.5 ), dy_2 * ( y_2 + 0.5 ) ) ).xyz;","vec3 N = texture2D( outlinePositionMaps[texId_3], vec2( dx_3 * ( x_3 + 0.5 ), dy_3 * ( y_3 + 0.5 ) ) ).xyz;","mat4 PM = vGetProjectionMatrix();","float m22 = PM[2][2];","float m32 = PM[3][2];","bool isPersp = PM[2][3] == -1.0;","if (isPersp) {","near = m32 / (m22 - 1.0);","far = ((m22 - 1.0)*near)/(m22 + 1.0);","} else {","near = (m32+1.0)/m22;","far = near - 2.0/m22;","}","vec4 mvP = computeModelViewPosition(vec4(P, 1.0));","vec4 mvM = computeModelViewPosition(vec4(M, 1.0));","vec4 mvN = computeModelViewPosition(vec4(N, 1.0));","mvCurrInter = mvP;","mvOtherInter = mvM;","hide = true;"].join("\n");i.SimpleSectionShader={VS_overridables:{ComputeCommonValues:["void ComputeCommonValues() {",a,"if (vGetAttribTexCoord0().x > 0.0 && getDist(mvP) > 0.0 && getDist(mvM) < 0.0) {","  mvCurrInter = getIntersection(mvP, mvM);","  hide = false;","}","if (vGetAttribTexCoord0().x < 0.0 && getDist(mvP) < 0.0 && getDist(mvN) > 0.0) {","  if(getDist(mvM) < 0.0) {","    mvCurrInter = getIntersection(mvM, mvN);","  } else {","    mvCurrInter = getIntersection(mvM, mvP);","  }","  hide = false;","}","}"].join("\n"),ProcessViewTangentSpace:["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","ioWorldViewTS.Position = mvCurrInter.xyz;","}"].join("\n"),ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) {","if (hide) ioPosition.z = 10000000.0 * far;","}"].join("\n")},FS_overridables:{}},i.WideSectionShader={VS_overridables:{ComputeCommonValues:["void ComputeCommonValues() {",a,"if (vGetAttribTexCoord0().x > 0.0 && getDist(mvP) > 0.0 && getDist(mvM) < 0.0) {","  mvCurrInter = getIntersection(mvP, mvM);","  if(getDist(mvN) > 0.0) {","    mvOtherInter = getIntersection(mvM, mvN);","  } else {","    mvOtherInter = getIntersection(mvN, mvP);","  }","  hide = false;","}","if (vGetAttribTexCoord0().x < 0.0 && getDist(mvP) < 0.0 && getDist(mvN) > 0.0) {","  if(getDist(mvM) < 0.0) {","    mvCurrInter = getIntersection(mvM, mvN);","  } else {","    mvCurrInter = getIntersection(mvM, mvP);","  }","  mvOtherInter = getIntersection(mvN, mvP);","  hide = false;","}","}"].join("\n"),ProcessViewTangentSpace:["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","ioWorldViewTS.Position = mvCurrInter.xyz;","}"].join("\n"),ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) {","mat4 PM = vGetProjectionMatrix();","vec4 mvpCurr = PM*vec4(mvCurrInter.xyz,1.0);","vec4 mvpOpp = PM*vec4(mvOtherInter.xyz,1.0);","screenCurr = (mvpCurr.xy / mvpCurr.w + 1.0) / pixelSize;","screenOpp = (mvpOpp.xy / mvpOpp.w + 1.0) / pixelSize;","vec3 ndcCurr = mvpCurr.xyz/mvpCurr.w;","vec3 ndcOpp = mvpOpp.xyz/mvpOpp.w;","float sideExtrusion = vGetAttribTexCoord0().y * vGetAttribTexCoord0().x;","float offset = sign(sideExtrusion) * sectionLineHalfWidth;","vec2 line = normalize(screenOpp - screenCurr);","vec2 lineNormal = vec2(-line.y, line.x);","vec2 ptAlongLine = screenCurr - sectionLineHalfWidth*line;","vec2 ndcPtAlongLine = ptAlongLine*pixelSize - 1.0;","float ndcD = length(ndcCurr.xy - ndcPtAlongLine);","float lengthCurrOpp = length(ndcCurr.xy - ndcOpp.xy);","float ndcZDelta = ndcD*abs(ndcCurr.z-ndcOpp.z)/lengthCurrOpp;","float ndcZDeltaLin = ndcD*abs(linearizeNDC(ndcCurr.z)-linearizeNDC(ndcOpp.z))/lengthCurrOpp;","vec2 px_pos;","if (ndcZDeltaLin > 0.7*ndcD) {","px_pos = screenCurr + offset*lineNormal;","ndcZDelta = 0.0;","} else {","px_pos = screenCurr + offset*lineNormal - sectionLineHalfWidth*line;","}","ndcZDelta *= sign(ndcCurr.z - ndcOpp.z);","float ndcFinalZ = mvpCurr.z/mvpCurr.w + ndcZDelta;","vec3 ndcPos = vec3((px_pos*pixelSize - 1.0), ndcFinalZ);","if (vGetAttribTexCoord0().x < 0.0) {","vec2 tmp = screenCurr;","screenCurr = screenOpp;","screenOpp = tmp;","}","vec4 clipSpacePos = vec4(ndcPos*mvpCurr.w, mvpCurr.w);","ioPosition = clipSpacePos;","if (hide) ioPosition.z = 10000000.0 * far;","}"].join("\n")},FS_overridables:{ComputeDiscard:["bool ComputeDiscard() { ","vec2 fCoord = gl_FragCoord.xy;","vec2 currOpp = screenOpp - screenCurr;","vec2 currFcoord = fCoord - screenCurr;","vec2 oppFcoord = fCoord - screenOpp;","bool toDiscard = false;","if (dot(currOpp, currFcoord ) < 0.0) {","if (length(currFcoord) > sectionLineHalfWidth) toDiscard = true;","} else if (dot(-currOpp, oppFcoord ) < 0.0) {","if (length(oppFcoord) > sectionLineHalfWidth) toDiscard = true;","}","return toDiscard;","}"].join("\n")}};var s=function(){t.call(this),this.activatePDSFX(),this.force=!0,this.enableClipPlanes=!0,this.side=e.DoubleSide,this.polygonOffset=!0,this.clipPlaneIndex=0};(s.prototype=Object.create(t.prototype)).getPredefinedMaterial=function(e,t,i){return this},s.prototype.__dimension=1,s.prototype.__isSectionLine=!0;var r=function(e,t){if(s.call(this),this.setPDSFXGlobalShaderCode(i.VS_global,i.FS_global),this.setPDSFXOverridableFunctions(i.SimpleSectionShader.VS_overridables,i.SimpleSectionShader.FS_overridables),e){this.defines={NB_OUTLINE_MAPS:e.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:e.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:e.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:e.LAST_OUTLINE_MAP_SIZE_Y};var a={outlinePositionMaps:{type:"t2v",value:t,length:this.defines.NB_OUTLINE_MAPS},currentClipPlane:{type:"i",value:0}};this.setPDSFXUniforms(a)}else this.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0};this.refreshPDSFXUniforms=function(){this.updatePDSFXUniform("currentClipPlane",this.clipPlaneIndex-1)}};(r.prototype=Object.create(s.prototype)).getType=function(){return"Section"},r.prototype.clone=function(){var e=new r;return s.prototype.clone.call(this,e),e};var n=function(t,a,r){if(s.call(this),this.forceSide=!0,this.side=e.DoubleSide,this.setPDSFXGlobalShaderCode(i.VS_global,i.FS_global),this.setPDSFXOverridableFunctions(i.WideSectionShader.VS_overridables,i.WideSectionShader.FS_overridables),t){this.defines={NB_OUTLINE_MAPS:t.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:t.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:t.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:t.LAST_OUTLINE_MAP_SIZE_Y};var n={outlinePositionMaps:{type:"t2v",value:a,length:this.defines.NB_OUTLINE_MAPS},currentClipPlane:{type:"i",value:0},sectionLineHalfWidth:{type:"f",value:r},pixelSize:{type:"v2",value:new e.Vector2}};this.setPDSFXUniforms(n)}else this.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0};this.setPDSFXVaryings({screenCurr:{type:"v2"},screenOpp:{type:"v2"}}),this._refreshPDSFXUniforms_private=function(t,i){this.updatePDSFXUniform("pixelSize",new e.Vector2(2/t.domElement.width,2/t.domElement.height)),this.updatePDSFXUniform("currentClipPlane",this.clipPlaneIndex-1)}};return(n.prototype=Object.create(s.prototype)).getType=function(){return"WideSection"},n.prototype.clone=function(){var e=new n;return s.prototype.clone.call(this,e),e},{_SectionMaterial:r,_WideSectionMaterial:n}}),define("DS/Materials/GridMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/MeshBasicMaterial"],function(e,t){"use strict";let i=["float mixDistance;"].join("\n"),a=["void ComputeCommonValues() {","vec3 vecDist = vGetViewPosition() - gridCenter;","mixDistance = 16.0 * dot(vecDist, vecDist);","mixDistance /= (gridSize * gridSize);","mixDistance = clamp(mixDistance, 0.0, 1.0);","}"].join("\n"),s=["vec3 ComputeAlbedo() {","vec3 cCenter = _DSalbedo_.xyz;","vec3 cBorder = cCenter*cCenter;","return mix(cCenter, cBorder, mixDistance);","}"].join("\n"),r=["void ProcessFinalColor(inout vec4 ioFinalColor) {","vec4 texelColor = texture2D( gridTexture, gridRepeat * vGetTexCoord0().xy + gridOffset );","vec3 cCenter = _DSalbedo_.rgb * texelColor.rgb;","vec3 cBorder = cCenter*cCenter;","ioFinalColor.rgb = mix(cCenter, cBorder, mixDistance);","ioFinalColor.a = texelColor.a * _DSopacity_ * mix(attenuation, 0.0, mixDistance);","#ifdef GAMMA_OUTPUT","ioFinalColor.rgb = sqrt(ioFinalColor.rgb);","#endif","}"].join("\n"),n=["float ComputeOpacity() {","return _DSopacity_ * mix(attenuation, 0.0, mixDistance);","}"].join("\n"),o=function(){t.call(this,{}),this.useBlending=!0,this.side=e.DoubleSide,this.depthTest=!1,this.force=!0,this.opacity=1,this.transparent=!0,this.enableClipPlanes=!1,this.activatePDSFX();let r={gridCenter:{type:"v3",value:new e.Vector3},gridSize:{type:"f",value:1},attenuation:{type:"f",value:1},gridTexture:{type:"t2",value:null},gridOffset:{type:"v2",value:new e.Vector2},gridRepeat:{type:"v2",value:new e.Vector2}};this.setPDSFXUniforms(r),this.setPDSFXGlobalShaderCode("",i),this.setPDSFXOverridableFunctions({},{ComputeCommonValues:a,ComputeAlbedo:s,ComputeOpacity:n}),this._refreshPDSFXUniforms_private=function(e,t){var i=this.getPDSFXUniform("gridTexture").value;i&&(this.updatePDSFXUniform("gridOffset",i.offset),this.updatePDSFXUniform("gridRepeat",i.repeat))}};return(o.prototype=Object.create(t.prototype)).getType=function(){return"Grid"},o.prototype.setGridTexture=function(t){this.updatePDSFXUniform("gridTexture",t),this.needsUpdate=!0,t?this.setPDSFXOverridableFunctions({},{ComputeCommonValues:a,ComputeAlbedo:e.ShaderChunk.PDSFXComputeAlbedo_FS,ProcessFinalColor:r,ComputeOpacity:e.ShaderChunk.PDSFXComputeOpacity_FS}):this.setPDSFXOverridableFunctions({},{ComputeCommonValues:a,ComputeAlbedo:s,ProcessFinalColor:e.ShaderChunk.PDSFXProcessFinalColor_FS,ComputeOpacity:n})},o.prototype._setMaterialShaderOptions=function(e,i,a,s,r,n){e.inlinedPostProActivated=!1,t.prototype._setMaterialShaderOptions.call(this,e,i,a,s,r,n)},o.prototype.getPredefinedMaterial=function(e,t,i){return this},o.prototype.updateDeferredMaterials=function(e){t.prototype.updateDeferredMaterials.call(this,e);for(let e=1;e<this._deferredMaterials.length;e++)this._deferredMaterials[e]=null},o}),define("DS/Materials/OutlineMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/MeshBasicMaterial"],function(e,t){"use strict";const i="\n\t\tvoid ComputeCommonValues() {\n\n\t\t\tvec3 _position = vGetAttribPosition();\n\t\t\tvec3 _normal = vGetAttribNormal();\n\t\t\tfloat texSharingOffset = _normal.z; //in rgb pixel\n\n\t\t\tfloat i1 = _position.x+texSharingOffset;\n\t\t\tfloat i2 = _position.y+texSharingOffset;\n\t\t\tfloat i3 = _position.z+texSharingOffset;\n\t\t\tfloat i4 = _normal.x+texSharingOffset;\n\n\t\t\tfloat maxMapTotalSize = MAX_OUTLINE_MAP_SIZE*MAX_OUTLINE_MAP_SIZE; //both dimension\n\t\t\tint texId_1 = int(floor(i1/maxMapTotalSize));\n\t\t\tint texId_2 = int(floor(i2/maxMapTotalSize));\n\t\t\tint texId_3 = int(floor(i3/maxMapTotalSize));\n\t\t\tint texId_4 = int(floor(i4/maxMapTotalSize));\n\n\t\t\tfloat dx_1, dx_2, dx_3, dx_4;\n\t\t\tfloat dy_1, dy_2, dy_3, dy_4;\n\t\t\tfloat x_1, x_2, x_3, x_4;\n\t\t\tfloat y_1, y_2, y_3, y_4;\n\n\n\t\t\tfloat idInTexture_1 = i1 - float(texId_1)*maxMapTotalSize;\n\t\t\tfloat idInTexture_2 = i2 - float(texId_2)*maxMapTotalSize;\n\t\t\tfloat idInTexture_3 = i3 - float(texId_3)*maxMapTotalSize;\n\t\t\tfloat idInTexture_4 = i4 - float(texId_4)*maxMapTotalSize;\n\n\n\t\t\tif (texId_1 == NB_OUTLINE_MAPS - 1) {\n\t\t\t\tdx_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t\tdy_1 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;\n\t\t\t\ty_1 = floor(idInTexture_1/LAST_OUTLINE_MAP_SIZE_X);\n\t\t\t\tx_1 = idInTexture_1 - y_1*LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t} else {\n\t\t\t\tdx_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\tdy_1 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\ty_1 = floor(idInTexture_1/MAX_OUTLINE_MAP_SIZE);\n\t\t\t\tx_1 = idInTexture_1 - y_1*MAX_OUTLINE_MAP_SIZE;\n\t\t\t}\n\n\t\t\tif (texId_2 == NB_OUTLINE_MAPS - 1) {\n\t\t\t\tdx_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t\tdy_2 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;\n\t\t\t\ty_2 = floor(idInTexture_2/LAST_OUTLINE_MAP_SIZE_X);\n\t\t\t\tx_2 = idInTexture_2 - y_2*LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t} else {\n\t\t\t\tdx_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\tdy_2 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\ty_2 = floor(idInTexture_2/MAX_OUTLINE_MAP_SIZE);\n\t\t\t\tx_2 = idInTexture_2 - y_2*MAX_OUTLINE_MAP_SIZE;\n\t\t\t}\n\n\t\t\tif (texId_3 == NB_OUTLINE_MAPS - 1) {\n\t\t\t\tdx_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t\tdy_3 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;\n\t\t\t\ty_3 = floor(idInTexture_3/LAST_OUTLINE_MAP_SIZE_X);\n\t\t\t\tx_3 = idInTexture_3 - y_3*LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t} else {\n\t\t\t\tdx_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\tdy_3 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\ty_3 = floor(idInTexture_3/MAX_OUTLINE_MAP_SIZE);\n\t\t\t\tx_3 = idInTexture_3 - y_3*MAX_OUTLINE_MAP_SIZE;\n\t\t\t}\n\n\t\t\tif (texId_4 == NB_OUTLINE_MAPS - 1) {\n\t\t\t\tdx_4 = 1.0 / LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t\tdy_4 = 1.0 / LAST_OUTLINE_MAP_SIZE_Y;\n\t\t\t\ty_4 = floor(idInTexture_4/LAST_OUTLINE_MAP_SIZE_X);\n\t\t\t\tx_4 = idInTexture_4 - y_4*LAST_OUTLINE_MAP_SIZE_X;\n\t\t\t} else {\n\t\t\t\tdx_4 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\tdy_4 = 1.0 / MAX_OUTLINE_MAP_SIZE;\n\t\t\t\ty_4 = floor(idInTexture_4/MAX_OUTLINE_MAP_SIZE);\n\t\t\t\tx_4 = idInTexture_4 - y_4*MAX_OUTLINE_MAP_SIZE;\n\t\t\t}\n\n\n\t\t\tvec3 current = sampleOutlineMaps(texId_1, vec2( dx_1 * ( x_1 + 0.5 ), dy_1 * ( y_1 + 0.5 ) ) ).xyz;\n\t\t\tvec3 opposite = sampleOutlineMaps(texId_2, vec2( dx_2 * ( x_2 + 0.5 ), dy_2 * ( y_2 + 0.5 ) ) ).xyz;\n\t\t\tvec3 firstSide = sampleOutlineMaps(texId_3, vec2( dx_3 * ( x_3 + 0.5 ), dy_3 * ( y_3 + 0.5 ) ) ).xyz;\n\t\t\tvec3 secondSide = sampleOutlineMaps(texId_4, vec2( dx_4 * ( x_4 + 0.5 ), dy_4 * ( y_4 + 0.5 ) ) ).xyz;\n\n\n\t\t\tmat4 PM = vGetProjectionMatrix();\n\n\t\t\tviewCurrent = vec3(computeModelViewPosition(vec4(current, 1.0)));\n\t\t\tviewOpposite = vec3(computeModelViewPosition(vec4(opposite, 1.0)));\n\t\t\tvec3 viewFirst = vec3(computeModelViewPosition(vec4(firstSide, 1.0)));\n\t\t\tvec3 viewSecond = vec3(computeModelViewPosition(vec4(secondSide, 1.0)));\n\n\t\t\tisPersp = PM[2][3] == -1.0;\n\n\t\t\tnewViewPosition = vec4(viewCurrent, 1.0);\n\n\t\t\tvec3 mvNormal = vec3(0.0,0.0,0.0);\n\n\t\t\t//first side normal\n\t\t\tvec3 mv_firstNormal = normalize(cross(opposite-current, firstSide-current));\n\t\t\tmv_firstNormal = normalize(computeModelViewDirection(mv_firstNormal).xyz);\n\t\t\t//second side normal\n\t\t\tvec3 mv_secondNormal = normalize(cross(secondSide-current,opposite-current));\n\t\t\tmv_secondNormal = normalize(computeModelViewDirection(mv_secondNormal).xyz);\n\n\n\t\t\tisOutline=false;\n\t\t\tif (isPersp) {\n\t\t\t\tisOutline = isOutlinePerspective(viewCurrent, viewOpposite, viewFirst, viewSecond, mv_firstNormal, mv_secondNormal);\n\t\t\t} else {\n\t\t\t\tisOutline = isOutlineOrthographic(mv_firstNormal, mv_secondNormal);\n\t\t\t}\n\t\t}\n\t",a="\n\t\tvoid ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {\n\t\t\tfloat far = vGetNearFarLogFactor().y;\n\t\t\tif (isPersp) {\n\t\t\t\tif (!isOutline) newViewPosition.xyz*=(1000000000.0*far); //if both side normals are on the same side with respect to the camera plan\n\t\t\t} else {\n\t\t\t\tif (!isOutline) newViewPosition.z = 1000000000.0*far; //if both side normals are on the same side with respect to the camera plan\n\t\t\t}\n\t\t\tioWorldViewTS.Position = newViewPosition.xyz;\n\t\t}\n\t",s={VS_global:"\n\t\t\t#define GPU_OUTLINES\n\t\t\tbool isOutline;\n\t\t\tvec4 newViewPosition;\n\n\t\t\tvec3 viewCurrent;\n\t\t\tvec3 viewOpposite;\n\n\t\t\tfloat far;\n\t\t\tfloat near;\n\t\t\tbool isPersp;\n\n\t\t\tbool isOutlinePerspective(vec3 viewCurrent, vec3 viewOpposite, vec3 viewFirstSide, vec3 viewSecondSide, vec3 mv_firstNormal, vec3 mv_secondNormal) {\n\n\t\t\t\tvec3 viewRayCurrent = normalize(viewCurrent);\n\t\t\t\tvec3 viewRayOpposite = normalize(viewOpposite);\n\t\t\t\tvec3 viewRayFirst = normalize(viewFirstSide);\n\t\t\t\tvec3 viewRaySecond = normalize(viewSecondSide);\n\n\t\t\t\t//first triangle\n\t\t\t\tfloat dot_curr_first = dot(viewRayCurrent,mv_firstNormal);\n\t\t\t\tfloat dot_opp_first = dot(viewRayOpposite,mv_firstNormal);\n\t\t\t\tfloat dot_first_first = dot(viewRayFirst,mv_firstNormal);\n\n\t\t\t\t//second triangle\n\t\t\t\tfloat dot_curr_second = dot(viewRayCurrent,mv_secondNormal);\n\t\t\t\tfloat dot_opp_second = dot(viewRayOpposite,mv_secondNormal);\n\t\t\t\tfloat dot_second_second = dot(viewRaySecond,mv_secondNormal);\n\n\t\t\t\tif (dot_curr_first*dot_opp_first > 0.0\n\t\t\t\t\t&& dot_curr_first*dot_first_first > 0.0\n\t\t\t\t\t&& dot_curr_second*dot_opp_second > 0.0\n\t\t\t\t\t&& dot_curr_second*dot_second_second > 0.0)\n\t\t\t\t{\n\t\t\t\t\tif (dot_first_first*dot_second_second < 0.0) return true;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\n\t\t\t}\n\n\t\t\tbool isOutlineOrthographic(in vec3 mv_firstNormal, in vec3 mv_secondNormal) {\n\t\t\t\treturn mv_firstNormal.z*mv_secondNormal.z < 0.0;\n\t\t\t}\n\n\t\t\tvec4 sampleOutlineMaps(in int idInTextureArray, in vec2 texCoords) {\n\t\t\t\t__OUTLINES_MAPS_SAMPLING__\n\t\t\t}\n\t\t",FS_global:"\n\t\t\t#define GPU_OUTLINES\n\t\t\t#ifdef RENDER_TO_FLOAT_TEXTURE\n\n\t\t\t\tvec4 getNormalDepth(in vec2 coord) {\n\t\t\t\t\tvec4 res = texture2D( depthBuffer, coord );\n\t\t\t\t\tvec3 normal = normalize(2.0 * res.xyz - 1.0);\n\t\t\t\t\tfloat depth = res.w;\n\t\t\t\t\tif (depth < 0.01) depth = 1.0;\n\t\t\t\t\treturn vec4(normal,depth);\n\t\t\t\t}\n\n\t\t\t\tfloat getPolygonOffset(in vec2 coord,in vec3 vN, in float depth) {\n\t\t\t\t\tmat4 P = projectionMatrix;\n\t\t\t\t\tbool isPersp = P[2][3] == -1.0;\n\n\t\t\t\t\tfloat slopeFactor = isPersp ? 1.0 : 0.1;\n\n\t\t\t\t\tvec2 sr = vec2(2.0)/depthMapSize;\n\t\t\t\t\tvec2 vC = (gl_FragCoord.xy - 0.5) / depthMapSize;\n\t\t\t\t\tvC = 2.0*vC - 1.0;\n\n\t\t\t\t\tfloat K = dot(vec3(P[1][1] * (vC.x + P[2][0]), P[0][0] * (vC.y + P[2][1]), -P[0][0] * P[1][1]), vN);\n\t\t\t\t\tvec2 offset = vec2(P[1][1] * vN.x*sr.x, P[0][0] * vN.y*sr.y);\n\n\t\t\t\t\tfloat factor = (-depth - 0.5 * (P[2][2] - 1.0)) / K;\n\t\t\t\t\tfloat dFdxOfZ = abs(offset.x * factor);\n\t\t\t\t\tfloat dFdyOfZ = abs(offset.y * factor);\n\n\t\t\t\t\tfloat slope = max(dFdxOfZ, dFdyOfZ);\n\t\t\t\t\tslope = min(max(slope, 1e-6), 1e-3);\n\n\t\t\t\t\treturn (slope * slopeFactor) + (DEPTH_PRECISION * 1.5);\n\t\t\t\t}\n\n\t\t\t\tfloat getOffsetedDepth(in vec2 coord) {\n\t\t\t\t\tvec4 nDepth = getNormalDepth(coord);\n\t\t\t\t\tfloat offset = getPolygonOffset(coord,nDepth.xyz,nDepth.w);\n\n\t\t\t\t\treturn nDepth.w + offset;\n\t\t\t\t}\n\n\t\t\t\tfloat depthSampleTest(in vec2 coord, in float delta, in float depth) {\n\t\t\t\t\tfloat fDepth = getOffsetedDepth(coord);\n\t\t\t\t\tif ( fDepth < depth ) return delta;\n\t\t\t\t\treturn 0.0;\n\t\t\t\t}\n\n\t\t\t#else\n\n\n\t\t\t\tfloat getDepth(in vec2 coord) {\n\t\t\t\t\tvec4 rgba_depth = texture2D( depthBuffer, coord );\n\n\t\t\t\t\tfloat depth = unpackRGBA(rgba_depth);\n\t\t\t\t\treturn depth > 1e-6 ? depth + 1.0* DEPTH_PRECISION : 1.0;\n\n\t\t\t\t}\n\n\t\t\t\tfloat depthSampleTest(in vec2 coord, in float delta, in float depth) {\n\t\t\t\t\tfloat fDepth = getDepth(coord);\n\t\t\t\t\tif ( fDepth < depth ) return delta;\n\t\t\t\t\treturn 0.0;\n\t\t\t\t}\n\n\t\t\t#endif\n\n\n\t\t\tbool correctZFighting() {\n\n\n\n\t\t\t\tvec2 coord = 0.5 + 0.5*cP.xy/cP.w;\n\t\t\t\tfloat depth = 0.5 + 0.5 * cP.z / cP.w;\n\t\t\t\tfloat delta = 1.0/9.0;\n\t\t\t\tfloat test = 0.0;\n\n\t\t\t\tfloat dx0 =  -0.5/depthMapSize.x;\n\t\t\t\tfloat dy0 = -0.5/depthMapSize.y;\n\t\t\t\tfloat dx1 = -dx0;\n\t\t\t\tfloat dy1 = -dy0;\n\n\n\t\t\t\ttest += depthSampleTest(coord,delta, depth);\n\t\t\t\ttest += depthSampleTest(coord + vec2(dx0,dy0),delta, depth);\n\t\t\t\ttest += depthSampleTest(coord.xy + vec2( 0.0, dy0 ),delta, depth);\n\t\t\t\ttest += depthSampleTest(coord.xy + vec2( dx1, dy0 ),delta, depth);\n\t\t\t\ttest += depthSampleTest(coord.xy + vec2( dx0, 0.0 ),delta, depth);\n\t\t\t\ttest += depthSampleTest(coord.xy + vec2( dx1, 0.0 ),delta, depth);\n\t\t\t\ttest += depthSampleTest(coord.xy + vec2( dx0, dy1 ),delta, depth);\n\t\t\t\ttest += depthSampleTest(coord.xy + vec2( 0.0, dy1 ),delta, depth);\n\t\t\t\ttest += depthSampleTest(coord.xy + vec2( dx1, dy1 ),delta, depth);\n\t\t\t\t// if at this point 80% of the tests failed, discard\n\t\t\t\tif (test > 0.8) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t}\n\t\t",SimpleOutlinesShader:{VS_overridables:{ComputeCommonValues:i,ProcessViewTangentSpace:a,ProcessClipSpacePosition:"void ProcessClipSpacePosition(inout vec4 ioPosition) { cP = ioPosition; }"},FS_overridables:{ComputeAlbedo:"vec3 ComputeAlbedo()\n\t\t\t\t\t{\n\t\t\t\t\t\t#ifdef OUTLINES_SHOW_OCCLUDED\n\t\t\t\t\t\t\tbool occluded = correctZFighting();\n\t\t\t\t\t\t\tgl_FragDepthEXT = occluded ? 0.001 : 0.0;\n\t\t\t\t\t\t\treturn occluded ? occludedColor : _DSalbedo_;\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\treturn _DSalbedo_;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}",ComputeDiscard:"bool ComputeDiscard()\n\t\t\t\t\t{\n\t\t\t\t\t\t#ifdef OUTLINES_SHOW_OCCLUDED\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\treturn correctZFighting();\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}"}},WideOutlinesShader:{VS_overridables:{ComputeCommonValues:i,ProcessViewTangentSpace:a,ProcessClipSpacePosition:"\n\t\t\t\t\tvoid ProcessClipSpacePosition(inout vec4 ioPosition) {\n\t\t\t\t\t\tmat4 PM = vGetProjectionMatrix();\n\t\t\t\t\t\tif (isOutline) {\n\t\t\t\t\t\t\tfloat sideExtrusion = vGetAttribNormal().y;\n\t\t\t\t\t\t\tbool isOpposite = mod(abs(sideExtrusion), 2.0) == 0.0;\n\n\n\t\t\t\t\t\t\tvec4 mvpCurr = PM*vec4(viewCurrent,1.0);\n\t\t\t\t\t\t\tvec4 mvpOpp = PM*vec4(viewOpposite,1.0);\n                            \n                            \n                            //from wideLineClip chunk: in case curr or opp have a negative w component (i.e. behind the camera)\n\t\t\t\t\t\t\tvec2 testClip = vec2(sign(mvpCurr.w + mvpCurr.z), sign(mvpOpp.w + mvpOpp.z));\n\t\t\t\t\t\t\tif ( testClip.x * testClip.y < 0.0 ){\n\t\t\t\t\t\t\t\t\tfloat a = (mvpCurr.w + mvpCurr.z)/((mvpCurr.w + mvpCurr.z) - (mvpOpp.w + mvpOpp.z));\n\t\t\t\t\t\t\t\t\tif (testClip.y < 0.0) {\n\t\t\t\t\t\t\t\t\t\tmvpOpp = (1.0 - a) * mvpCurr + a * mvpOpp;\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tmvpCurr = (1.0 - a) * mvpCurr + a * mvpOpp;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t//curr and opp in real pixel\n\t\t\t\t\t\t\tscreenCurr = (mvpCurr.xy / mvpCurr.w + 1.0) / pixelSize; // in [0,w]x[0,h] in pixel\n\t\t\t\t\t\t\tscreenOpp = (mvpOpp.xy / mvpOpp.w + 1.0) / pixelSize; // in [0,w]x[0,h] in pixel\n                            \n                            //extrusion of the wide outline quad + computing the z so the quad is flat\n\t\t\t\t\t\t\tvec3 ndcCurr = mvpCurr.xyz/mvpCurr.w;\n\t\t\t\t\t\t\tvec3 ndcOpp = mvpOpp.xyz/mvpOpp.w;\n\n\t\t\t\t\t\t\tfloat offset = sign(sideExtrusion) * outlineHalfWidth;\n\t\t\t\t\t\t\tvec2 line = normalize(screenOpp - screenCurr);\n\t\t\t\t\t\t\tvec2 lineNormal = vec2(-line.y, line.x);\n\n\t\t\t\t\t\t\tvec2 px_pos;\n\n\t\t\t\t\t\t\tpx_pos = screenCurr + offset*lineNormal - outlineHalfWidth*line;\n\n\t\t\t\t\t\t\tvec3 ndcPos = vec3((px_pos*pixelSize - 1.0), mvpCurr.z/mvpCurr.w);\n                            \n                            \n                            //so the 4 vertices of the outline have the same curr and opp for fragment shader treatment\n\t\t\t\t\t\t\tif (isOpposite) {\n\t\t\t\t\t\t\t\tvec2 tmp = screenCurr;\n\t\t\t\t\t\t\t\tscreenCurr = screenOpp;\n\t\t\t\t\t\t\t\tscreenOpp = tmp;\n\t\t\t\t\t\t\t}\n                            \n                            //Final position\t\n\t\t\t\t\t\t\tvec4 clipSpacePos = vec4(ndcPos*mvpCurr.w, mvpCurr.w);\n\t\t\t\t\t\t\tioPosition = clipSpacePos;\n\t\t\t\t\t\t\tcP = mvpCurr;\n\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tioPosition = PM*newViewPosition;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t"},FS_overridables:{ComputeAlbedo:"vec3 ComputeAlbedo()\n\t\t\t\t\t{\n\t\t\t\t\t\t#ifdef OUTLINES_SHOW_OCCLUDED\n\t\t\t\t\t\t\tbool occluded = correctZFighting();\n\t\t\t\t\t\t\tgl_FragDepthEXT = occluded ? 0.001 : 0.0;\n\t\t\t\t\t\t\treturn occluded ? occludedColor : _DSalbedo_;\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\treturn _DSalbedo_;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}",ComputeDiscard:"\n\t\t\t\t\tbool ComputeDiscard()\n\t\t\t\t\t{\n\t\t\t\t\t\t#ifdef OUTLINES_SHOW_OCCLUDED\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tbool toDiscard = correctZFighting();\n\t\t\t\t\t\t\tif (toDiscard) return toDiscard;\n\t\t\t\t\t\t\tvec2 fCoord = vGetFragCoord().xy;\n\n\t\t\t\t\t\t\tvec2 currOpp = screenOpp - screenCurr;\n\t\t\t\t\t\t\tvec2 currFcoord = fCoord - screenCurr;\n\t\t\t\t\t\t\tvec2 oppFcoord = fCoord - screenOpp;\n\n\t\t\t\t\t\t\ttoDiscard = false;\n                            \n                            //round caps so each individual line can nicely connect to its neighbour\n\t\t\t\t\t\t\tif (dot(currOpp, currFcoord ) < 0.0) {\n\t\t\t\t\t\t\t\tif (length(currFcoord) > outlineHalfWidth) toDiscard = true;\n\t\t\t\t\t\t\t} else if (dot(-currOpp, oppFcoord ) < 0.0) {\n\t\t\t\t\t\t\t\tif (length(oppFcoord) > outlineHalfWidth) toDiscard = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn toDiscard;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}\n\t\t\t\t"}}};class r extends t{constructor(){super(),this.__dimension=1,this.activatePDSFX(),this.enableClipPlanes=!0,this.depthTest=!1,this.force=!0,this.color=new e.Color(0),this.occludedColor=new e.Color(11184810),this.showHidden=!1}getPredefinedMaterial(e,t,i){return this}setShowHiddenOutlines(e){this.showHidden!==!!e&&(this.showHidden=!!e,this.showHidden?this.defines.OUTLINES_SHOW_OCCLUDED=1:delete this.defines.OUTLINES_SHOW_OCCLUDED,this.depthTest=this.showHidden,this.needsUpdate=!0)}}class n extends r{constructor(t,i){if(super(),this.setPDSFXGlobalShaderCode(s.VS_global,s.FS_global),this.setPDSFXOverridableFunctions(s.SimpleOutlinesShader.VS_overridables,s.SimpleOutlinesShader.FS_overridables),t){this.defines={NB_OUTLINE_MAPS:t.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:t.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:t.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:t.LAST_OUTLINE_MAP_SIZE_Y};var a={occludedColor:{type:"v3",value:new e.Vector3(this.occludedColor.r,this.occludedColor.g,this.occludedColor.b)},outlinePositionMaps:{type:"t2v",value:i,length:this.defines.NB_OUTLINE_MAPS},depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new e.Vector2(.01,.01)}};this.setPDSFXUniforms(a)}else this.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0};this.setPDSFXVaryings({cP:{type:"v4"}}),this._refreshPDSFXUniforms_private=function(t,i){this.updatePDSFXUniform("occludedColor",new e.Vector3(this.occludedColor.r,this.occludedColor.g,this.occludedColor.b)),t.requestRealDepthBuffer(),t.dBuffer&&(this.updatePDSFXUniform("depthBuffer",t.dBuffer),this.updatePDSFXUniform("depthMapSize",new e.Vector2(t.dBuffer.width,t.dBuffer.height)))}}getType(){return"Outline"}clone(){let e=new n;return super.clone(e),e}}class o extends r{constructor(t,i,a){if(super(),this.forceSide=!0,this.side=e.DoubleSide,this.setPDSFXGlobalShaderCode(s.VS_global,s.FS_global),this.setPDSFXOverridableFunctions(s.WideOutlinesShader.VS_overridables,s.WideOutlinesShader.FS_overridables),t){this.defines={NB_OUTLINE_MAPS:t.NB_OUTLINE_MAPS,MAX_OUTLINE_MAP_SIZE:t.MAX_OUTLINE_MAP_SIZE,LAST_OUTLINE_MAP_SIZE_X:t.LAST_OUTLINE_MAP_SIZE_X,LAST_OUTLINE_MAP_SIZE_Y:t.LAST_OUTLINE_MAP_SIZE_Y};var r={occludedColor:{type:"v3",value:new e.Vector3(this.occludedColor.r,this.occludedColor.g,this.occludedColor.b)},outlinePositionMaps:{type:"t2v",value:i,length:this.defines.NB_OUTLINE_MAPS},depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new e.Vector2(.01,.01)},outlineHalfWidth:{type:"f",value:a},pixelSize:{type:"v2",value:new e.Vector2}};this.setPDSFXUniforms(r)}else this.defines={NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:0,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0};this.setPDSFXVaryings({screenCurr:{type:"v2"},screenOpp:{type:"v2"},cP:{type:"v4"}}),this._refreshPDSFXUniforms_private=function(t,i){this.updatePDSFXUniform("occludedColor",new e.Vector3(this.occludedColor.r,this.occludedColor.g,this.occludedColor.b)),this.updatePDSFXUniform("pixelSize",new e.Vector2(2/t.domElement.width,2/t.domElement.height)),t.requestRealDepthBuffer(),t.dBuffer&&(this.updatePDSFXUniform("depthBuffer",t.dBuffer),this.updatePDSFXUniform("depthMapSize",new e.Vector2(t.dBuffer.width,t.dBuffer.height)))}}getType(){return"WideOutline"}clone(){let e=new o;return super.clone(e),e}}return{_OutlineMaterial:n,_WideOutlineMaterial:o}}),define("DS/Materials/DSPBR19x",["DS/Mesh/ThreeJS_Base","DS/Materials/PhysicalMaterial"],function(e,t){"use strict";var i=function(e){e=e||{};var i={};Object.assign(i,e),this._setTypeParams(i),i.dspbr19x=!0,t.call(this,i)};return(i.prototype=Object.create(t.prototype)).clone=function(e){return e||(e=new i),t.prototype.clone.call(this,e),e},i}),define("DS/Materials/CATGraphicalMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DSPBR19x"],function(e,t){"use strict";var i={User:0,ObjectLinearPlanar:1,EyeLinearPlanar:2,Environment:3},a={VisuBasic_diffuseTexCoord:{type:"v4"}},s=[null,["vec4 VisuBasic_ComputeDiffuseTexCoord() {","vec4 res = vec4(0.0);","vec4 pos = vec4(vGetAttribPosition(), 1.0);","res.s = dot(VisuBasic_ProjectionPlaneS, pos);","res.t = dot(VisuBasic_ProjectionPlaneT, pos);","return res;","}"].join("\n"),["mat4 VisuBasic_Transpose(in mat4 m) {","mat4 mT;","mT[0] = vec4(m[0][0], m[1][0], m[2][0], m[3][0]);","mT[1] = vec4(m[0][1], m[1][1], m[2][1], m[3][1]);","mT[2] = vec4(m[0][2], m[1][2], m[2][2], m[3][2]);","mT[3] = vec4(m[0][3], m[1][3], m[2][3], m[3][3]);","return mT;","}","vec4 VisuBasic_ComputeDiffuseTexCoord() {","vec4 res = vec4(0.0);","vec4 pos = vec4(vGetAttribPosition(), 1.0);","pos = computeModelViewPosition(pos);","mat4 modelViewInv = VisuBasic_Transpose(vGetViewInverseTransposeMatrix() * vGetWorldInverseTransposeMatrix()); ","res.s = dot(modelViewInv*VisuBasic_ProjectionPlaneS, pos);","res.t = dot(modelViewInv*VisuBasic_ProjectionPlaneT, pos);","return res;","}"].join("\n"),["vec4 VisuBasic_ComputeDiffuseTexCoord() {","vec4 res = vec4(0.0);","vec4 pos = vec4(vGetAttribPosition(), 1.0);","pos = computeModelViewPosition(pos);","res.xyz = normalize(pos.xyz);","return res;","}"].join("\n")],r=["VisuBasic_diffuseTexCoord = VisuBasic_ComputeDiffuseTexCoord();"].join("\n"),n=["#define _VISUBASIC_FORCE_PHYSICAL_DIFFUSE_UV","vec2 VisuBasic_diffuseTexUvToUse;","vec2 VisuBasic_ComputeSphereMapCoord(in vec3 r)","{","r.z+=1.0;","float m = 0.5/sqrt(dot(r,r));","return vec2(r.x*m+0.5, r.y*m+0.5);","}"].join("\n"),o=["VisuBasic_diffuseTexUvToUse = VisuBasic_diffuseTexCoord.xy;"].join("\n"),l=[null,o,o,["vec3 VisuBasic_orientedViewNormal = vGetViewNormal();","vec3 VisuBasic_dir = reflect(VisuBasic_diffuseTexCoord.xyz, VisuBasic_orientedViewNormal);","VisuBasic_diffuseTexUvToUse = VisuBasic_ComputeSphereMapCoord(VisuBasic_dir).st;"].join("\n")],h=function(o){o=o||{};var h={};Object.assign(h,o),h.textureMapping=o.textureMapping||"User",h.sheen=0,h.flakesCoverage=0,h.specularContrib=1,h.clearCoat=0,h.thinWalled=!0,t.call(this,h),this.reflectivity=void 0!==h.reflectivity?h.reflectivity:1,this.reflectivityEnvMap=void 0!==h.reflectivityEnvMap?h.reflectivityEnvMap:null,this.combine=void 0!==h.combine?h.combine:e.MultiplyOperation,this.textureBlending=void 0!==h.textureBlending?h.textureBlending:e.TextureBlendOperations.KEEP_DEFAULT;var p=i[h.textureMapping],d=s[p];if(this._internalPDSFXData=null,null!==d){var f={VisuBasic_ProjectionPlaneS:{type:"v4",value:new e.Vector4(1,0,0,0)},VisuBasic_ProjectionPlaneT:{type:"v4",value:new e.Vector4(0,1,0,0)}};if(void 0!==typeof h.projectionPlaneS){var c=h.projectionPlaneS;f.VisuBasic_ProjectionPlaneS.x=c[0],f.VisuBasic_ProjectionPlaneS.y=c[1],f.VisuBasic_ProjectionPlaneS.z=c[2],f.VisuBasic_ProjectionPlaneS.w=c[3]}if(void 0!==typeof h.projectionPlaneT){c=h.projectionPlaneT;f.VisuBasic_ProjectionPlaneT.x=c[0],f.VisuBasic_ProjectionPlaneT.y=c[1],f.VisuBasic_ProjectionPlaneT.z=c[2],f.VisuBasic_ProjectionPlaneT.w=c[3]}this._internalPDSFXData={uniforms:f,varyings:a,VS_global:d,FS_global:n,ComputeVaryingValuesVSBody:r,ComputeCommonValuesFSBody:l[p]},this.diffuseAddCoef=new e.Vector3,this.diffuseMulCoef=new e.Vector3(1,1,1),p===i.Environment&&(this.diffuseMulCoef=new e.Vector3(this.reflectivity,this.reflectivity,this.reflectivity)),this.activatePDSFX(),this.setPDSFXUniforms(null),this.setPDSFXVaryings(null),this.setPDSFXGlobalShaderCode(null,null),this.setPDSFXOverridableFunctions(null,null)}};return(h.prototype=Object.create(t.prototype)).clone=function(){var e=new h;return t.prototype.clone.call(this,e),e.reflectivity=this.reflectivity,e.reflectivityEnvMap=this.reflectivityEnvMap,e.combine=this.combine,e.textureBlending=this.textureBlending,e._internalPDSFXData=this._internalPDSFXData,e},h.prototype.setPDSFXUniforms=function(e){this._internalPDSFXData&&(e||(e={}),Object.assign(e,this._internalPDSFXData.uniforms)),t.prototype.setPDSFXUniforms.call(this,e)},h.prototype.setPDSFXVaryings=function(e){this._internalPDSFXData&&(e||(e={}),Object.assign(e,this._internalPDSFXData.varyings)),t.prototype.setPDSFXVaryings.call(this,e)},h.prototype.setPDSFXGlobalShaderCode=function(e,i){this._internalPDSFXData&&(e||(e=""),i||(i=""),i+="\n"+this._internalPDSFXData.FS_global,e+="\n"+this._internalPDSFXData.VS_global),t.prototype.setPDSFXGlobalShaderCode.call(this,e,i)},h.prototype.setPDSFXOverridableFunctions=function(e,i){if(this._internalPDSFXData){var a;if(e||(e={}),i||(i={}),e.ComputeVaryingValues){if(-1!==(a=e.ComputeVaryingValues.lastIndexOf("}"))){var s=e.ComputeVaryingValues;e.ComputeVaryingValues=s.substring(0,a)+"\n"+this._internalPDSFXData.ComputeVaryingValuesVSBody+"\n"+s.substring(a)}}else e.ComputeVaryingValues=["void ComputeVaryingValues() {",this._internalPDSFXData.ComputeVaryingValuesVSBody,"}"].join("\n");if(i.ComputeCommonValues){if(-1!==(a=i.ComputeCommonValues.lastIndexOf("}"))){s=i.ComputeCommonValues;i.ComputeCommonValues=s.substring(0,a)+"\n"+this._internalPDSFXData.ComputeCommonValuesFSBody+"\n"+s.substring(a)}}else i.ComputeCommonValues=["void ComputeCommonValues() {",this._internalPDSFXData.ComputeCommonValuesFSBody,"}"].join("\n")}t.prototype.setPDSFXOverridableFunctions.call(this,e,i)},h.prototype.getSubType=function(){return"CATGraphicalMaterial"},h.prototype.getType=function(){return"CATGraphicalMaterial"},h.prototype._transparencyOnGPU=function(i){return t.prototype._transparencyOnGPU.call(this,i)||this.map&&(this.textureBlending===e.TextureBlendOperations.BLEND||this.textureBlending===e.TextureBlendOperations.MODULATE)},h.prototype._getTextures=function(e){var i=t.prototype._getTextures.call(this,e);return e||(i=i.concat([this.reflectivityEnvMap])),i},h}),define("DS/Materials/SmallPlaneMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DSPBR19x"],function(e,t){"use strict";var i=function(){t.call(this,{specularContrib:0,metalness:0,ior:1,transparency:0,opacity:1,color:new e.Color(16777215)}),this.useLighting=!0,this.transparent=!1,this.useBlending=!0,this.blending=e.GroundShadowBlending,this.depthWrite=!1,this.side=e.DoubleSide,this.force=!0,this.polygonOffset=!0,this.polygonOffsetFactor=2,this.polygonOffsetUnits=1,this.enableClipPlanes=!1,this.defines={GROUND_SHADOW:0,INVISIBLE_PLANE_MATERIAL:!0},this.activatePDSFX();this.setPDSFXUniforms({groundShadow:{type:"t2",value:null}}),this.setPDSFXGlobalShaderCode("",""),this.setPDSFXOverridableFunctions({},{ComputeDiscard:"\n                bool ComputeDiscard() {\n                    vec3 I = vec3(0.0,0.0,1.0);\n                    if (!(vGetProjectionMatrix()[3][3] > 0.0)) {\n                        I = normalize(-vGetViewPosition());\n                    }\n                    return dot(I, vGetViewNormal()) < 0.0;\n                }\n            ",ProcessFinalColor:"\n            void ProcessFinalColor(inout vec4 ioFinalColor) {\n                ioFinalColor.rgb = clamp(ioFinalColor.rgb, vec3(0.0), vec3(1.0));\n                #ifdef GAMMA_OUTPUT\n                ioFinalColor.rgb *= ioFinalColor.rgb;\n                #endif\n                vec2 uv = vGetTexCoord0().xy;\n                #if GROUND_SHADOW == 1\n                    float shadowCoeff = texture2D(groundShadow, uv).x;\n                    ioFinalColor.xyz *= shadowCoeff;\n                #endif\n                vec2 toCenter = 2.0 * (vec2(0.5) - uv);\n                float distToCenter = min(1.0, dot(toCenter, toCenter));\n                float alpha = 1.0-max(ioFinalColor.x,max(ioFinalColor.y,ioFinalColor.z));\n                ioFinalColor = vec4(mix(ioFinalColor.xyz, vec3(1.0), distToCenter), alpha);\n                #ifdef GAMMA_OUTPUT\n                ioFinalColor.rgb = sqrt(ioFinalColor.rgb);\n                #endif\n                ioFinalColor.rgb = clamp(ioFinalColor.rgb, vec3(0.0), vec3(1.0));\n            }\n            "})};return(i.prototype=Object.create(t.prototype)).getType=function(){return"Small Plane"},i.prototype.getPredefinedMaterial=function(e,t,i){return this},i.prototype._setMaterialShaderOptions=function(e,i,a,s,r,n){e.useOIT=!1,e.inlinedPostProActivated=!1,e.invisiblePlaneMaterial=!0,e.maxDirIBLLights=0,e.maxDirPhongLights=0,e.maxSphereLights=0,e.maxTubeLights=0,e.maxDiskLights=0,e.maxAreaLights=0,e.maxIESLights=0,t.prototype._setMaterialShaderOptions.call(this,e,i,a,s,r,n)},i.prototype.areTexturesLoaded=function(){return!0},i.prototype.updateDeferredMaterials=function(i){t.prototype.updateDeferredMaterials.call(this,i),this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial]=null,this._deferredMaterials[e.MaterialToUse.pickingMaterial]=null,this._deferredMaterials[e.MaterialToUse.depthMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalMaterial]=null,this._deferredMaterials[e.MaterialToUse.highlightMaterial]=null,this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepth]=null,this._deferredMaterials[e.MaterialToUse.oitAccumMaterial]=null,this._deferredMaterials[e.MaterialToUse.oitRevealMaterial]=null},i}),define("DS/Materials/GASPBR",["DS/Mesh/ThreeJS_Base","DS/Materials/DSPBR19x"],function(e,t){"use strict";var i=function(e,i){if(!i)throw"Missing low quality material";t.call(this,e),this._phongFallbackMaterial=i,i._isGAS=!0,this._allowObjectColor=!0,i._allowObjectColor=!0};return(i.prototype=Object.create(t.prototype)).clone=function(){var e=new i(null,this._phongFallbackMaterial);return t.prototype.clone.call(this,e),e},i.prototype.getSubType=function(){return"GAS"},i.prototype.getType=function(){return"GAS"},i}),define("DS/Materials/MeshPhongMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData"],function(e,t,i){"use strict";var a=new e.Color,s=function(i){t.call(this),this.color=new e.Color(16777215),this.ambient=new e.Color(16777215),this.emissive=new e.Color(0),this.specular=new e.Color(1118481),this.shininess=30,this.shininessInSpecMap=!1,this.metal=!1,this.perPixel=!0,this.wrapAround=!1,this.wrapRGB=new e.Vector3(1,1,1),this._isGAS=!1,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new e.Vector2(1,1),this._firstDirOnly=!1,this.specularMap=null,this.envMap=null,this.combine=e.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.refractionRatioMap=null,this.reflectionCoef=0,this.shading=e.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.morphTargets=!1,this.morphNormals=!1,this.textureBlending=e.TextureBlendOperations.KEEP_DEFAULT,this.lights=!0,this.numSupportedMorphTargets=0,this.numSupportedMorphNormals=0,this._usePhongLighting=!0,this.setValues(i)};return(s.prototype=Object.create(t.prototype))._transparencyOnGPU=function(i){return t.prototype._transparencyOnGPU.call(this,i)||this.map&&(this.textureBlending===e.TextureBlendOperations.KEEP_DEFAULT||this.textureBlending===e.TextureBlendOperations.BLEND||this.textureBlending===e.TextureBlendOperations.MODULATE)},s.prototype._shaderID="phong",s.prototype._getTextures=function(e){var i=t.prototype._getTextures.call(this,e);return i=i.concat([this.map,this.specularMap,this.bumpMap,this.normalMap,this.refractionRatioMap])},s.prototype._dump=function(){var e=t.prototype._dump.call(this);return e.color=this.color.toArray(),this.map&&(e.color="textured"),e.specular=this.specular.toArray(),this.specularMap&&(e.specular="textured"),e.shininess=this.shininess,e},s.prototype.areTexturesLoaded=function(){return!!t.prototype.areTexturesLoaded.call(this)&&(!this.envMap||this.envMap.loadEndStatus!==e.AssetLoadingStatus.LOADING)},s.prototype.clone=function(){var e=new s;return t.prototype.clone.call(this,e),e.color.copy(this.color),e.ambient.copy(this.ambient),e.emissive.copy(this.emissive),e.specular.copy(this.specular),e.shininess=this.shininess,e.shininessInSpecMap=this.shininessInSpecMap,e.reflectionCoef=this.reflectionCoef,e.metal=this.metal,e.perPixel=this.perPixel,e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.map=this.map,e.bumpMap=this.bumpMap,e.bumpScale=this.bumpScale,e.normalMap=this.normalMap,e.normalScale.copy(this.normalScale),e.specularMap=this.specularMap,e.envMap=this.envMap,e.combine=this.combine,e.reflectivity=this.reflectivity,e.refractionRatio=this.refractionRatio,e.refractionRatioMap=this.refractionRatioMap,e.shading=this.shading,e._firstDirOnly=this._firstDirOnly,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e.textureBlending=this.textureBlending,e.numSupportedMorphTargets=this.numSupportedMorphTargets,e.numSupportedMorphNormals=this.numSupportedMorphNormals,e._isGAS=this._isGAS,e},s.prototype._autoForceSide=!0,s.prototype.getType=function(){return this._isGAS?"GAS":"Phong"},s.prototype.activatePDSFX=function(e){e=e||{},this._PDSFXData=new i,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions(),this._PDSFXData.PDSFX_hasAlbedo=!0,this._PDSFXData.PDSFX_hasEmissive=!0,this._PDSFXData.PDSFX_hasSpecular=!0,this._PDSFXData.PDSFX_hasOpacity=!0},s.prototype._defaultPDSFXOverridableFunctions=function(){var i=t.prototype._defaultPDSFXOverridableFunctions.call(this);return Object.assign(i.fragment,{ComputeEmissive:e.ShaderChunk.PDSFXComputeEmissive_FS,ComputeSpecularReflectance:e.ShaderChunk.PDSFXComputeSpecularReflectance_FS}),i},s.prototype._setMaterialShaderOptions=function(e,i,a,s,r,n){t.prototype._setMaterialShaderOptions.call(this,e,i,a,s,r,n),e.phongFirstDir=this._firstDirOnly,i&&Object.assign(e,{refractionRatioMap:this._isTextureAvailable("refractionRatioMap")})},s.prototype.loadUniforms=function(e,t,i,s,r,n){var o;i.ambient&&(o=this.ambient,this._isGAS&&(o=this.color,s&&s.getColor()&&(o=a.set(s.getColor()))),e.gammaInput&&(o=a.copyToLinear(o,e.simpleGamma)),t.uniform3f(i.ambient,o.r,o.g,o.b)),i.emissive&&(o=e.gammaInput?a.copyToLinear(this.emissive,e.simpleGamma):this.emissive,t.uniform3f(i.emissive,o.r,o.g,o.b)),i.specular&&(o=e.gammaInput?a.copyToLinear(this.specular,e.simpleGamma):this.specular,t.uniform3f(i.specular,o.r,o.g,o.b)),i.shininess&&t.uniform1f(i.shininess,Math.max(this.shininess,1e-6)),i.reflectionCoef&&t.uniform1f(i.reflectionCoef,this.reflectionCoef),i.shininessInSpecMap&&t.uniform1i(i.shininessInSpecMap,this.shininessInSpecMap),i.wrapRGB&&this.wrapAround&&t.uniform3f(i.wrapRGB,this.wrapRGB.x,this.wrapRGB.y,this.wrapRGB.z),e.loadUniformsCommon(t,this,i,s,r,n),e.loadUniformsBump(t,this,i),e.loadUniformsNormalMap(t,this,i)},s}),define("DS/Materials/PlaneMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/MeshPhongMaterial"],function(e,t){"use strict";var i=function(){t.call(this,{ambient:328965,specular:1118481}),this.lights=!0,this._usePhongLighting=!0,this.useBlending=!0,this.depthTest=!1,this.depthWrite=!1,this.side=e.DoubleSide,this.force=!0,this.enableClipPlanes=!1,this.activatePDSFX();let i={border:{type:"c",value:new e.Color(516)},borderAlpha:{type:"f",value:1},attenuation:{type:"i",value:0,stage:e.FragmentStage},displayGrid:{type:"f",value:1},displayPlane:{type:"f",value:1},gridFromBelow:{type:"f",value:1},planeMap:{type:"t2",value:null},gridTexture:{type:"t2",value:null},gridTexture2:{type:"t2",value:null},gridTexture3:{type:"t2",value:null},gridTexture4:{type:"t2",value:null},nbSteps:{type:"f",value:5},gridUnit:{type:"f",value:1},gridOffset:{type:"v2",value:new e.Vector2},gridCoeff:{type:"f",value:0},gridColor:{type:"c",value:new e.Color(16777215)},planeSize:{type:"f",value:100},planeBorder:{type:"f",value:1},planeFalloff:{type:"f",value:0},onlyDiffuse:{type:"f",value:0},gridFalloff:{type:"f",value:0},uvScale:{type:"f",value:1},planeOpacity:{type:"f",value:1}};this._v2Plane=!0,this.setPDSFXUniforms(i),this.setPlaneV2(!1)};return(i.prototype=Object.create(t.prototype)).getType=function(){return"Plane"},i.prototype.setPlaneV2=function(e){this._v2Plane!==e&&(this._v2Plane=e,e?(this.setPDSFXGlobalShaderCode("","\n        float stepFactor;\n        vec4 borderColor;\n        float fresnelFactor;\n        vec4 gridCol;\n        float planeAlpha;\n\n        const float alphaSlope = 0.66666666667;\n        const float alphaSlope2 = 0.44444444444;\n        const float edgeSize = 0.01;\n        const float stepSize = 0.001;\n        const float small2GridWidth = 0.0005;\n        const float smallGridWidth = 0.0005;\n        const float bigGridWidth = 0.0005;\n\n        #ifdef PLANE_MAP\n            vec4 planeMapColor;\n        #endif\n    "),this.setPDSFXOverridableFunctions({},{ComputeCommonValues:"\n        void ComputeCommonValues() {\n            vec3 I = vec3(0.0,0.0,1.0);\n            if (!(vGetProjectionMatrix()[3][3] > 0.0)) {\n                I = normalize(-vGetViewPosition());\n            }\n            fresnelFactor = dot(I, vGetViewNormal());\n\n            vec2 planeUV = vGetTexCoord0().xy * 2.0 - 1.0;\n            stepFactor = length(planeUV);\n            float borderMask = planeBorder * smoothstep(1.0 - 2.0 * edgeSize, 1.0 - 2.0 * edgeSize + stepSize, stepFactor) * smoothstep(1.0 - edgeSize + stepSize, 1.0 - edgeSize, stepFactor);\n            borderColor = vec4(border, borderMask);\n\n            float a2 = max(1.0 - alphaSlope2 * (1.0 + gridCoeff) * (1.0 + gridCoeff), 0.0);\n            float a1 = 1.0 - alphaSlope2 * gridCoeff * gridCoeff;\n            float a0 = 1.0 - alphaSlope2 * (1.0 - gridCoeff) * (1.0 - gridCoeff);\n            float a00 = max(1.0 - alphaSlope2 * (2.0 - gridCoeff) * (2.0 - gridCoeff), 0.0);\n            vec2 div = 0.5 * planeSize * planeUV + gridOffset;\n            vec2 big2Div = (1.0 / (nbSteps * nbSteps)) * div / gridUnit;\n            vec2 bigDiv = (1.0 / nbSteps) * div / gridUnit;\n            vec2 smallDiv = div / gridUnit;\n            vec2 small2Div = nbSteps * div / gridUnit;\n\n            float gridAlpha = texture2D(gridTexture, small2Div).a;\n            gridAlpha *= a2;\n            gridAlpha += a1 * texture2D(gridTexture2, smallDiv).a;\n            gridAlpha += a0 * texture2D(gridTexture3, bigDiv).a;\n            gridAlpha += a00 * texture2D(gridTexture4, big2Div).a;\n            gridAlpha = min(1.0, gridAlpha);\n\n            planeAlpha = 1.0001 - smoothstep(planeFalloff, 1.0, stepFactor);\n            gridAlpha *= 1.0001 - smoothstep(gridFalloff, 1.0, stepFactor);\n\n            planeAlpha *= planeOpacity * step(0.0, fresnelFactor) * displayPlane;\n            gridAlpha *= step(-gridFromBelow, fresnelFactor) * displayGrid;\n\n            gridCol = vec4(gridColor * gridColor, gridAlpha);\n\n            #ifdef PLANE_MAP\n                vec4 planeMapColor = texture2D( map,  vGetTexCoord0().xy * uvScale );\n            #endif\n        }   \n    ",ComputeDiscard:"\n        bool ComputeDiscard() {\n            return false;\n        }       \n    ",ProcessFinalColor:"\n                    void ProcessFinalColor(inout vec4 ioFinalColor) {\n                        #ifdef GAMMA_OUTPUT\n                        ioFinalColor.rgb *= ioFinalColor.rgb;\n                        #endif\n                        \n        vec3 cCenter = (ioFinalColor.xyz * (1.0 - onlyDiffuse)) + (onlyDiffuse * _DSalbedo_);\n        #ifdef PLANE_MAP\n            #ifdef GAMMA_INPUT\n                planeMapColor.xyz = convertToLinear(planeMapColor.xyz);\n            #endif\n            cCenter = mix(cCenter, planeMapColor.xyz, planeMapColor.a);\n        #endif\n        vec4 planeCol = vec4(mix(mix(cCenter, border, planeBorder), cCenter, planeAlpha), mix(planeAlpha, 1.0, planeBorder));\n        vec4 gridOverPlaneColor = vec4((gridCol.xyz * gridCol.a + planeCol.xyz * planeCol.a * (1.0 - gridCol.a)) / (0.0001 + gridCol.a + planeCol.a * (1.0 - gridCol.a)), gridCol.a + planeCol.a * (1.0 - gridCol.a));\n        ioFinalColor = mix(gridOverPlaneColor, borderColor, step(1.0 - 2.0 * edgeSize, stepFactor));\n    \n                        #ifdef GAMMA_OUTPUT\n                        ioFinalColor.rgb = sqrt(ioFinalColor.rgb);\n                        #endif\n                    }\n                "}),this.getPDSFXUniform("planeMap").value?this.defines={PLANE_MAP:1}:this.defines={}):(this.defines={},this.setPDSFXGlobalShaderCode("","\n        float fresnelFactor;\n        bool discardPlane;\n    "),this.setPDSFXOverridableFunctions({},{ComputeCommonValues:"\n        void ComputeCommonValues() {\n\n            vec3 I = vec3(0.0,0.0,1.0);\n            if (!(vGetProjectionMatrix()[3][3] > 0.0)) {\n                I = normalize(-vGetViewPosition());\n            }\n            fresnelFactor = dot(I, vGetViewNormal());\n\n            discardPlane = fresnelFactor < 0.0;\n            if (attenuation == 0) {\n                fresnelFactor = 1.0;\n            }\n        }   \n    ",ComputeDiscard:"\n        bool ComputeDiscard() {\n            return discardPlane;\n        }       \n    ",ProcessFinalColor:"\n                    void ProcessFinalColor(inout vec4 ioFinalColor) {\n                        #ifdef GAMMA_OUTPUT\n                        ioFinalColor.rgb *= ioFinalColor.rgb;\n                        #endif\n                        \n        vec2 dUV = 2.0 * (vGetTexCoord0().xy * 2.0 - 1.0);\n        float dist = dot(dUV, dUV);\n        float dist2 = clamp(dist * dist, 0.0, 1.0);\n        dist = clamp(dist, 0.0, 1.0);\n        ioFinalColor = vec4(mix(ioFinalColor.rgb, mix(ioFinalColor.rgb, border.rgb, borderAlpha), dist), fresnelFactor*(1.0 - dist2));\n    \n                        #ifdef GAMMA_OUTPUT\n                        ioFinalColor.rgb = sqrt(ioFinalColor.rgb);\n                        #endif\n                    }\n                "})),this.needsUpdate=!0)},i.prototype.setPlaneTexture=function(e){(this.getPDSFXUniform("planeMap").value?!e:e)&&(this.defines={},this.updatePDSFXUniform("planeMap",e),e&&this._v2Plane&&(this.defines={PLANE_MAP:1}),this.needsUpdate=!0)},i.prototype.getPredefinedMaterial=function(e,t,i){return this},i.prototype._setMaterialShaderOptions=function(e,i,a,s,r,n){e.useOIT=!1,t.prototype._setMaterialShaderOptions.call(this,e,i,a,s,r,n)},i.prototype.updateDeferredMaterials=function(i){t.prototype.updateDeferredMaterials.call(this,i),this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial]=null,this._deferredMaterials[e.MaterialToUse.pickingMaterial]=null,this._deferredMaterials[e.MaterialToUse.depthMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalMaterial]=null,this._deferredMaterials[e.MaterialToUse.highlightMaterial]=null,this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepth]=null,this._deferredMaterials[e.MaterialToUse.oitAccumMaterial]=null,this._deferredMaterials[e.MaterialToUse.oitRevealMaterial]=null},i}),define("DS/Materials/OldInfraMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/Material","DS/Materials/DeferredCaches","DS/MaterialLibs/GenericLib"],function(e,t,i,a){"use strict";var s=function(){t.call(this)};return(s.prototype=Object.create(t.prototype))._setMaterialShaderOptions=function(e,i,a,s,r,n){t.prototype._setMaterialShaderOptions.call(this,e,i,a,s,r,n)},s.prototype.clone=function(e){return void 0===e&&(e=new s),t.prototype.clone.call(this,e),e},s.prototype.copyPDSFXParameters=function(e){this._PDSFXData&&this._PDSFXData.PDSFX&&(e.activatePDSFX(),e.setPDSFXOverridableFunctions(this._PDSFXData.PDSFX_OverridableFunctions_VS,this._PDSFXData.PDSFX_OverridableFunctions_FS),this._PDSFXData.pdsfxVaryingsCode&&(e._PDSFXData.pdsfxVaryingsCode=this._PDSFXData.pdsfxVaryingsCode),this._PDSFXData.pdsfxUniformsCode&&(e._PDSFXData.pdsfxUniformsCode=this._PDSFXData.pdsfxUniformsCode),this._PDSFXData.pdsfxUniforms&&(e._PDSFXData.pdsfxUniforms=this._PDSFXData.pdsfxUniforms),this._PDSFXData.pdsfxGlobalVariablesCode_VS&&(e._PDSFXData.pdsfxGlobalVariablesCode_VS=this._PDSFXData.pdsfxGlobalVariablesCode_VS),this._PDSFXData.pdsfxGlobalVariablesCode_FS&&(e._PDSFXData.pdsfxGlobalVariablesCode_FS=this._PDSFXData.pdsfxGlobalVariablesCode_FS),this._PDSFXData.pdsfxAttributesCode&&(e._PDSFXData.pdsfxAttributesCode=this._PDSFXData.pdsfxAttributesCode),this._PDSFXData.pdsfxUseMap&&(e._PDSFXData.pdsfxUseMap=!0),e._PDSFXData.CPULargeScale=this._PDSFXData.CPULargeScale,e.refreshPDSFXUniforms=this.refreshPDSFXUniforms,e._refreshPDSFXUniforms_private=this._refreshPDSFXUniforms_private,!e.line||e.line._PDSFXData&&e.line._PDSFXData.PDSFX||this.copyPDSFXParameters(e.line),!e.point||e.point._PDSFXData&&e.point._PDSFXData.PDSFX||this.copyPDSFXParameters(e.point),e.defines=this.defines,e._PDSFXData._setUniformsList())},s.prototype.copyPDSFXParametersPicking=function(e){if(this._PDSFXData&&this._PDSFXData.PDSFX){e.activatePDSFX();var t={ComputeCommonValues:this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeCommonValues,ComputeDiscard:this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeDiscard,ComputeHalfWidth:this._PDSFXData.PDSFX_OverridableFunctions_FS.ComputeHalfWidth,ProcessLinePattern:this._PDSFXData.PDSFX_OverridableFunctions_FS.ProcessLinePattern};e.setPDSFXOverridableFunctions(this._PDSFXData.PDSFX_OverridableFunctions_VS,t),this._PDSFXData.pdsfxVaryingsCode&&(e._PDSFXData.pdsfxVaryingsCode=this._PDSFXData.pdsfxVaryingsCode),this._PDSFXData.pdsfxUniformsCode&&(e._PDSFXData.pdsfxUniformsCode=this._PDSFXData.pdsfxUniformsCode),this._PDSFXData.pdsfxUniforms&&(e._PDSFXData.pdsfxUniforms=this._PDSFXData.pdsfxUniforms),this._PDSFXData.pdsfxGlobalVariablesCode_VS&&(e._PDSFXData.pdsfxGlobalVariablesCode_VS=this._PDSFXData.pdsfxGlobalVariablesCode_VS),this._PDSFXData.pdsfxGlobalVariablesCode_FS&&(e._PDSFXData.pdsfxGlobalVariablesCode_FS=this._PDSFXData.pdsfxGlobalVariablesCode_FS),this._PDSFXData.pdsfxAttributesCode&&(e._PDSFXData.pdsfxAttributesCode=this._PDSFXData.pdsfxAttributesCode),this._PDSFXData.pdsfxUseMap&&(e._PDSFXData.pdsfxUseMap=!0),e._PDSFXData.CPULargeScale=this._PDSFXData.CPULargeScale,e.refreshPDSFXUniforms=this.refreshPDSFXUniforms,e._refreshPDSFXUniforms_private=this._refreshPDSFXUniforms_private,e.defines=this.defines,e._PDSFXData._setUniformsList()}},s.prototype.updateGenericDeferredMaterials=function(t){var i=this._deferredMaterials[e.MaterialToUse.normalMaterial];i.force=!0,i.wireframe=this.wireframe,i.vertexColors=this.vertexColors,i.attributes=Object.assign(i.attributes?i.attributes:{},this.attributes),this.copyPDSFXParameters(i);var a=this._deferredMaterials[e.MaterialToUse.depthMaterial];a.force=!0,a.defines||(a.defines={}),a.wireframe=this.wireframe,a.vertexColors=this.vertexColors,a.attributes=Object.assign(a.attributes?a.attributes:{},this.attributes),this.copyPDSFXParameters(a);var s=this._deferredMaterials[e.MaterialToUse.depthRGBAMaterial];s.force=!0,s.defines||(s.defines={}),s.wireframe=this.wireframe,s.vertexColors=this.vertexColors,s.attributes=Object.assign(s.attributes?s.attributes:{},this.attributes),this.copyPDSFXParameters(s);var r=this._deferredMaterials[e.MaterialToUse.normalDepthIoRRoughnessMaterial];this.reflectionCoef&&this.reflectionCoef>0&&(r.uniforms.reflectionCoef={type:"f",value:this.reflectionCoef}),r.force=!0,r.wireframe=this.wireframe,r.vertexColors=this.vertexColors,r.attributes=Object.assign(r.attributes?r.attributes:{},this.attributes),this.copyPDSFXParameters(r);var n=this._deferredMaterials[e.MaterialToUse.normalDepthMaterial];n.force=!0,n.wireframe=this.wireframe,n.vertexColors=this.vertexColors,n.attributes=Object.assign(n.attributes?n.attributes:{},this.attributes),this.copyPDSFXParameters(n);var o=this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepthMaterial];o.force=!0,o.wireframe=this.wireframe,o.vertexColors=this.vertexColors,o.attributes=Object.assign(o.attributes?o.attributes:{},this.attributes),this.copyPDSFXParameters(o);var l=this._deferredMaterials[e.MaterialToUse.shadowMapDepthMaterial];l.force=!0,l.wireframe=this.wireframe,l.vertexColors=this.vertexColors,l.attributes=Object.assign(l.attributes?l.attributes:{},this.attributes),this.copyPDSFXParameters(l);var h=this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial];h&&(h.force=!0,h.wireframe=this.wireframe,h.vertexColors=this.vertexColors,h.attributes=Object.assign(h.attributes?h.attributes:{},this.attributes),this.copyPDSFXParameters(h));var p=this._deferredMaterials[e.MaterialToUse.highlightMaterial];e._mobileHighlight&&(p.useBlending=!0,p.blending=e.CustomBlending,p.depthTest=!1,p.depthWrite=!1),p.vertexColors=this.vertexColors,p.attributes=Object.assign(p.attributes?p.attributes:{},this.attributes),this.copyPDSFXParameters(p);var d=this._deferredMaterials[e.MaterialToUse.pickingMaterial],f=this._deferredMaterials[e.MaterialToUse.pickingMaterialInstancing];this.isInstancingMaterial&&f&&(f.vertexColors=this.vertexColors,f.attributes=Object.assign(f.attributes?f.attributes:{},this.attributes),f.force=!0,f.transparent=this.transparent,this.copyPDSFXParametersPicking(f)),d.attributes=Object.assign(d.attributes?d.attributes:{},this.attributes),d.force=!0,this.copyPDSFXParametersPicking(d),this.backMaterial&&!this.backMaterial._deferredMaterialsInit&&(this.backMaterial.updateDeferredMaterials(),this._deferredMaterials[e.MaterialToUse.pickingMaterial]=this._deferredMaterials[e.MaterialToUse.pickingMaterial].clone(),this._deferredMaterials[e.MaterialToUse.pickingMaterial].backMaterial=this.backMaterial._deferredMaterials[e.MaterialToUse.pickingMaterial]),this instanceof e.ParticleBasicMaterial||(this._deferredMaterials[e.MaterialToUse.oitAccumMaterial]=this,this._deferredMaterials[e.MaterialToUse.oitRevealMaterial]=this),this._deferredMaterials[e.MaterialToUse.ZOnlyMaterial]=this.getZOnlyMaterial();for(var c=0;c<e.MaterialToUse.totalMaterial;c++){var u=this._deferredMaterials[c];null!==u&&(u.isBackMaterial=this.isBackMaterial)}var m=this.getTexCoordMaterial();this.copyPDSFXParameters(m),this._deferredMaterials[e.MaterialToUse.texCoordMaterial]=m,this._deferredMaterialsInit=!0},s.prototype.updateDeferredMaterials=function(t){e.cleanDeferredCache(this.id),this._deferredMaterials[e.MaterialToUse.normalMaterial]=this.getNormalMaterial(),this._deferredMaterials[e.MaterialToUse.depthMaterial]=this.getDepthMaterial(0),this._deferredMaterials[e.MaterialToUse.depthRGBAMaterial]=this.getDepthMaterial(1),this._deferredMaterials[e.MaterialToUse.normalDepthIoRRoughnessMaterial]=this.getNormalDepthIoRRoughnessMaterial(t),this._deferredMaterials[e.MaterialToUse.shadowMapDepthMaterial]=this.getShadowDepthMaterial(),this._deferredMaterials[e.MaterialToUse.transparentShadowMaterial]=this.getTransparentShadowMaterial(),this._deferredMaterials[e.MaterialToUse.highlightMaterial]=e._mobileHighlight?this.getHighlightMaterial("HighlightMobile"):this.getHighlightMaterial("Highlight");var i=this.getPickingMaterial(),a=i.pickingMaterial,s=i.pickingMaterialInstancing;this._deferredMaterials[e.MaterialToUse.normalDepthMaterial]=this.getNormalDepthMaterial("NormalDepth"),this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepthMaterial]=this.getNormalDepthMaterial("DecalNormalStencilDepth"),this._deferredMaterials[e.MaterialToUse.pickingMaterialInstancing]=s,this._deferredMaterials[e.MaterialToUse.pickingMaterial]=a,this.updateGenericDeferredMaterials(t)},s.prototype.getInvisibleMaterial=function(){var t=this.getBaseId();if(t="id"+(t+="TInvisible").hashCode(),i.DefaultMaterials.has(t))return i.DefaultMaterials.get(t).get(this);var a=new e.ShaderMaterial;a.visible=!1,a.force=!0;var s=new i.DeferredMaterial(a);return i.DefaultMaterials.set(t,s),s.get(this)},s.prototype.getTexCoordMaterial=function(){var t=this.getBaseId();if(t+="TTexCoord",t+=this.map?this.map.id:this.map,t+="AT"+this.alphaTest,t="id"+(t+="BM"+this.isBackMaterial).hashCode(),i.DefaultMaterials.has(t))return i.DefaultMaterials.get(t).get(this);var a,s=e._DeferredShaders.TextureCoordinate,r={uniforms:e.UniformsUtils.clone(s.uniforms),fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,side:e.DoubleSide,enableClipPlanes:this.enableClipPlanes};this.map&&this.alphaTest?(r.defines={USE_MAP_ALPHATEST:!0,ALPHATEST:this.alphaTest.toFixed(5)},r.uniforms.map.value=this.map,r.uniforms.offsetAlphaMap.value=this.map.offset,r.uniforms.repeatAlphaMap.value=this.map.repeat,a=new e.ShaderMaterial(r)):(r.force=!0,a=new e.ShaderMaterial(r));var n=new i.DeferredMaterial(a);return i.DefaultMaterials.set(t,n),n.get(this)},s.prototype.getHighlightInfo=function(t){var i,a="Highlight";switch(t){case"Highlight":i=e._AdvancedHighlightShader,a="Highlight";break;case"HighlightMobile":i=e._AdvancedHighlightShaderSinglePass,a="Highlight"}return{shaderLib:i,shaderName:a}},s.prototype.getHighlightMaterial=function(t){var a=this.getBaseId();if(a+="T"+t,a+="GTFace",a+="CP"+this.enableClipPlanes,a+="M",a+=this.map?this.map.id:this.map,a+="AT"+this.alphaTest,a="id"+(a+="BM"+this.isBackMaterial).hashCode(),i.DefaultHighlightMaterials.has(a))return i.DefaultHighlightMaterials.get(a).get(this);var s,r=this.getHighlightInfo(t),n=r.shaderLib,o=r.shaderName;o+="Face";var l={uniforms:e.UniformsUtils.clone(n[o].uniforms),fragmentShader:n[o].fragmentShader,vertexShader:n[o].vertexShader,side:e.DoubleSide,enableClipPlanes:this.enableClipPlanes};this.map&&this.alphaTest?(l.defines={USE_MAP_ALPHATEST:!0,ALPHATEST:this.alphaTest.toFixed(5)},l.uniforms.map.value=this.map,l.uniforms.offsetAlphaMap.value=this.map.offset,l.uniforms.repeatAlphaMap.value=this.map.repeat,s=new e.ShaderMaterial(l)):(l.force=!0,s=new e.ShaderMaterial(l));var h=new i.DeferredMaterial(s);return i.DefaultHighlightMaterials.set(a,h),h.get(this)},s.prototype.getPickingMaterial=function(){var t=this.getBaseId();if(t+="GTFaceS"+this.side+"CP"+this.enableClipPlanes+"TR"+(this.transparent||this.getOpacity()<1),t+="SD"+this.shading,t+="M",t+=this.map?this.map.id:this.map,t+="AT"+this.alphaTest,t="id"+(t+="BM"+this.isBackMaterial).hashCode(),i.DefaultPickingMaterials.has(t))return i.DefaultPickingMaterials.get(t).get(this);var a=null,s=null;if(this.map&&this.alphaTest){var r=e._DeferredShaders.PickingFragment,n=e.UniformsUtils.clone(r.uniforms),o={USE_MAP_ALPHATEST:!0};o.ALPHATEST=this.alphaTest.toFixed(5),n.map.value=this.map,n.offsetAlphaMap.value=this.map.offset,n.repeatAlphaMap.value=this.map.repeat,a=new e.ShaderMaterial({uniforms:n,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,defines:o,blending:e.NoBlending,transparent:this.transparent||this.getOpacity()<1,side:this.side,enableClipPlanes:this.enableClipPlanes}),this.shading&&(a.shading=this.shading),a.uniforms.pickingColor={type:"c",value:new e.Color},this.isInstancingMaterial&&(s=new e.ShaderMaterial({uniforms:n,vertexShader:e._DeferredShaders.PickingFragmentInstancing.vertexShader,fragmentShader:e._DeferredShaders.PickingFragmentInstancing.fragmentShader,defines:o,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,transparent:this.transparent||this.getOpacity()<1}),this.shading&&(s.shading=this.shading))}else a=new e.MeshBasicMaterial({color:new e.Color,side:this.side,enableClipPlanes:this.enableClipPlanes,transparent:this.transparent||this.getOpacity()<1}),this.isInstancingMaterial&&((s=a.clone())._definePickingInstancing=!0,s.isInstancingMaterial=!0);var l={pickingMaterial:a,pickingMaterialInstancing:s},h=new i.DeferredMaterial(l);return i.DefaultPickingMaterials.set(t,h),h.get(this)},s.prototype.getShadowDepthMaterial=function(){var t,s=this.getBaseId();if(s+="S"+this.side+"CP"+this.enableClipPlanes+"SD"+this.shading,s+="M",s+=this.map?this.map.id:this.map,s+="AT"+this.alphaTest,s="id"+(s+="BM"+this.isBackMaterial).hashCode(),i.DefaultShadowDepthMaterials.has(s))return i.DefaultShadowDepthMaterials.get(s).get(this);var r=a.depthRGBA,n=e.UniformsUtils.clone(r.uniforms);if(this.map&&this.alphaTest){var o={USE_MAP_ALPHATEST:!0};o.ALPHATEST=this.alphaTest.toFixed(5),n.map.value=this.map,n.offsetAlphaMap.value=this.map.offset,n.repeatAlphaMap.value=this.map.repeat,t=new e.ShaderMaterial({uniforms:n,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,defines:o,blending:e.NoBlending,side:e.DoubleSide,enableClipPlanes:this.enableClipPlanes}),this.shading&&(t.shading=this.shading),t.force=!0,t.wireframe=this.wireframe,t.vertexColors=this.vertexColors}else t=new e.ShaderMaterial({uniforms:n,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,side:e.DoubleSide,enableClipPlanes:this.enableClipPlanes});t.attributes=Object.assign(t.attributes?t.attributes:{},this.attributes);var l=new i.DeferredMaterial(t);return i.DefaultShadowDepthMaterials.set(s,l),l.get(this)},s.prototype.getTransparentShadowMaterial=function(){return this.isPhysicalMaterial?((t=this.clone()).useLighting=!1,t.useBlending=!0,t.blending=e.TransparentShadowBlending,t):null;var t},s.prototype.getNormalDepthMaterialCommons=function(t){var a=this.getBaseId();if(a+="T"+t+"GTFaceS"+this.side+"CP"+this.enableClipPlanes+"SD"+this.shading,a+="M",a+=this.map?this.map.id:this.map,a+="AT"+this.alphaTest,a+="BM",a+=this.bumpMap?this.bumpMap.id:this.bumpMap,a+="NM",a+=this.normalMap?this.normalMap.id:this.normalMap,a+="Ro",a+=this.roughness,a+="RM",a+=this.roughnessMap?this.roughnessMap.id:this.roughnessMap,a+="GM",a+=this.glossinessMap?this.glossinessMap.id:this.glossinessMap,a+="MT"+this.morphTargets,a+="MN"+this.morphNormals,a="id"+(a+="BM"+this.isBackMaterial).hashCode(),i.DefaultNormalDepthMaterials.has(a))return{id:a,materialParams:null,material:i.DefaultNormalDepthMaterials.get(a).get(this)};var s=t,r=e._DeferredShaders[s];return{id:a,materialParams:{uniforms:e.UniformsUtils.clone(r.uniforms),vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,side:this.side,enableClipPlanes:this.enableClipPlanes},material:null}},s.prototype.getNormalMaterial=function(){var t=this.getNormalDepthMaterialCommons("Normal");if(null!==t.material)return t.material;var a=t.materialParams;if(this.bumpMap||this.map&&this.alphaTest){var s={};this.map&&this.alphaTest&&(s.USE_MAP_ALPHATEST=!0,s.ALPHATEST=this.alphaTest.toFixed(5),a.uniforms.map.value=this.map,a.uniforms.offsetAlphaMap.value=this.map.offset,a.uniforms.repeatAlphaMap.value=this.map.repeat),this.bumpMap&&(s.USE_BUMPMAP=!0,a.uniforms.bumpMap.value=this.bumpMap,a.uniforms.bumpScale.value=this.bumpScale,a.uniforms.offsetBumpMap.value=this.bumpMap.offset,a.uniforms.repeatBumpMap.value=this.bumpMap.repeat),a.defines=s,this.shading&&(a.shading=this.shading),this.morphTargets&&(a.morphTargets=this.morphTargets),this.morphNormals&&(a.morphNormals=this.morphNormals),a.blending=e.NoBlending}var r=new e.ShaderMaterial(a),n=new i.DeferredMaterial(r);return i.DefaultNormalDepthMaterials.set(t.id,n),n.get(this)},s.prototype.getNormalDepthIoRRoughnessMaterial=function(t){var a=this.getNormalDepthMaterialCommons("NormalDepthIoRRoughness");if(null!==a.material)return a.material;var s=a.materialParams;s.uniforms.roughness.value=this.roughness;var r={};(this.bumpMap||this.normalMap||this.roughnessMap||this.map&&this.alphaTest)&&(this.map&&this.alphaTest&&(r.USE_MAP_ALPHATEST=!0,r.ALPHATEST=this.alphaTest.toFixed(5),s.uniforms.map.value=this.map,s.uniforms.offsetAlphaMap.value=this.map.offset,s.uniforms.repeatAlphaMap.value=this.map.repeat),this.bumpMap&&(r.USE_BUMPMAP=!0,s.uniforms.bumpMap.value=this.bumpMap,s.uniforms.bumpScale.value=this.bumpScale,s.uniforms.offsetBumpMap.value=this.bumpMap.offset,s.uniforms.repeatBumpMap.value=this.bumpMap.repeat),this.normalMap&&(r.USE_NORMALMAP=!0,s.uniforms.normalMap.value=this.normalMap),this.roughnessMap?(r.USE_ROUGHNESSMAP=!0,s.uniforms.roughnessMap.value=this.roughnessMap):this.glossinessMap&&(r.USE_GLOSSINESSMAP=!0,s.uniforms.glossinessMap.value=this.glossinessMap),this.shading&&(s.shading=this.shading),this.morphTargets&&(s.morphTargets=this.morphTargets),this.morphNormals&&(s.morphNormals=this.morphNormals),s.blending=e.NoBlending),s.defines=r;var n=new e.ShaderMaterial(s),o=new i.DeferredMaterial(n);return i.DefaultNormalDepthMaterials.set(a.id,o),o.get(this)},s.prototype.getDepthMaterial=function(t){var a=this.getNormalDepthMaterialCommons(0===t?"Depth":"DepthRGBA");if(null!==a.material)return a.material;var s=a.materialParams;if(this.map&&this.alphaTest){var r={USE_MAP_ALPHATEST:!0};r.ALPHATEST=this.alphaTest.toFixed(5),s.defines=r,s.uniforms.map.value=this.map,s.uniforms.offsetAlphaMap.value=this.map.offset,s.uniforms.repeatAlphaMap.value=this.map.repeat,this.shading&&(s.shading=this.shading),this.morphTargets&&(s.morphTargets=this.morphTargets),this.morphNormals&&(s.morphNormals=this.morphNormals),s.blending=e.NoBlending}var n=new e.ShaderMaterial(s),o=new i.DeferredMaterial(n);return i.DefaultNormalDepthMaterials.set(a.id,o),o.get(this)},s.prototype.getNormalDepthMaterial=function(t){var a=this.getNormalDepthMaterialCommons(t);if(a.material)return a.material;var s=a.materialParams;s.uniforms.roughness.value=this.roughness;var r={};(this.bumpMap||this.normalMap||this.roughnessMap||this.map&&this.alphaTest)&&(this.map&&this.alphaTest&&(r.USE_MAP_ALPHATEST=!0,r.ALPHATEST=this.alphaTest.toFixed(5),s.uniforms.map.value=this.map,s.uniforms.offsetAlphaMap.value=this.map.offset,s.uniforms.repeatAlphaMap.value=this.map.repeat),this.bumpMap&&(r.USE_BUMPMAP=!0,s.uniforms.bumpMap.value=this.bumpMap,s.uniforms.bumpScale.value=this.bumpScale,s.uniforms.offsetBumpMap.value=this.bumpMap.offset,s.uniforms.repeatBumpMap.value=this.bumpMap.repeat),this.normalMap&&(r.USE_NORMALMAP=!0,s.uniforms.normalMap.value=this.normalMap),this.roughnessMap?(r.USE_ROUGHNESSMAP=!0,s.uniforms.roughnessMap.value=this.roughnessMap):this.glossinessMap&&(r.USE_GLOSSINESSMAP=!0,s.uniforms.glossinessMap.value=this.glossinessMap),this.shading&&(s.shading=this.shading),this.morphTargets&&(s.morphTargets=this.morphTargets),this.morphNormals&&(s.morphNormals=this.morphNormals),s.blending=e.NoBlending),s.defines=r;var n=new e.ShaderMaterial(s),o=new i.DeferredMaterial(n);return i.DefaultNormalDepthMaterials.set(a.id,o),o.get(this)},s}),define("DS/Materials/LineDSMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/DeferrableMaterial","DS/Materials/PDSFXData","DS/Materials/DeferredCaches"],function(e,t,i,a){"use strict";var s=function(i){if(t.call(this),this.color=new e.Color(16777215),this.scale=6.66666,this.dashSize=0,this.gapSize=0,this.dashPattern=new Float32Array(2),this.dashType="None",this.patternOffset=0,this.linecap="square",this.linejoin="miter",this.lineWidth=1,this.pixelSize=new e.Vector2(.001,.001),this.side=e.Constants.DoubleSide,this.setValues(i),this._invertedPattern=i&&!!i.invertedPattern,"None"!==this.dashType&&(this.dashSize=this.gapSize=-1,this._setDashPatternType()),(this.dashSize>0&&this.gapSize>0||this.dashPattern[0]>1e-6)&&(this.isDashedLine=!0,this.dashSize>0&&this.gapSize>0&&(console.error("DEPRECATED: Usage of dashSize and gapSize is deprecated, use dashPattern instead."),this.dashPattern[0]=this.dashSize,this.dashPattern[1]=this.gapSize,this.dashSize=-1,this.gapSize=-1),this.dashPattern[0]>1e-6))for(var a=1;a<this.dashPattern.length;a++)this.dashPattern[a]+=this.dashPattern[a-1];this.isDashedLine&&"None"===this.dashType&&(this.dashType="Custom")};return(s.prototype=Object.create(t.prototype)).clone=function(e){return void 0===e&&(e=new s),t.prototype.clone.call(this,e),e.color.copy(this.color),e.scale=this.scale,e.dashPattern=new Float32Array(this.dashPattern),e.dashType=this.dashType,e.patternOffset=this.patternOffset,e.lineWidth=this.lineWidth,e.linecap=this.linecap,e.linejoin=this.linejoin,e.pixelSize=this.pixelSize,e.side=this.side,e._invertedPattern=this._invertedPattern,e},s.prototype._dump=function(){var e=t.prototype._dump.call(this);return e.color=this.color.toArray(),e.dashPattern=Array.from(this.dashPattern),e.lineWidth=this.lineWidth,e},s.prototype._canUseLights=function(){return!1},s.prototype._setMaterialShaderOptions=function(e,i,a,s,r,n){t.prototype._setMaterialShaderOptions.call(this,e,i,a,s,r,n);var o={};n||Object.assign(o,{dashedLine:this.isDashedLine,patternSize:this.isDashedLine&&this.dashPattern?this.dashPattern.length:0,invertedPattern:this._invertedPattern}),Object.assign(o,{wideLine:this.isWideLine||this.is2DLine,linejoin:this.linejoin,linecap:this.linecap}),Object.assign(e,o)},s.prototype.setPatternOffset=function(e){this.patternOffset=e,this.isDashedLine&&(this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())},s.prototype.setScale=function(e){this.scale=e,this.isDashedLine&&(this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())},s.prototype.setDashPatternArray=function(e){e&&0!==e.length||(e=[0,0]),this.dashPattern=new Float32Array(e),this.dashType="Custom";for(var t=1;t<this.dashPattern.length;t++)this.dashPattern[t]+=this.dashPattern[t-1];this.isDashedLine=this.dashPattern[0]>0,this.needsUpdate=!0,this._invalidateDisplayRangeLists(),this.updateDeferredMaterials()},s.prototype._setDashPatternType=function(){switch(this._invertedPattern=!1,this.dashType){case 1:this.dashType="Solid";case"Solid":this.dashPattern[0]=-1;break;case 2:this.dashType="Dotted";case"Dotted":this.dashPattern=new Float32Array(2),this.dashPattern[0]=2,this.dashPattern[1]=2;break;case 3:this.dashType="Dashed";case"Dashed":this.dashPattern=new Float32Array(2),this.dashPattern[0]=3,this.dashPattern[1]=1;break;case 4:this.dashType="Dot-Dashed";case"Dot-Dashed":this.dashPattern=new Float32Array(4),this.dashPattern[0]=3,this.dashPattern[1]=2,this.dashPattern[2]=1,this.dashPattern[3]=2;break;case 5:this.dashType="Phantom";case"Phantom":this.dashPattern=new Float32Array(6),this.dashPattern[0]=6,this.dashPattern[1]=2,this.dashPattern[2]=2,this.dashPattern[3]=2,this.dashPattern[4]=2,this.dashPattern[5]=2;break;case 6:this.dashType="Small-Dotted";case"Small-Dotted":this.dashPattern=new Float32Array(2),this.dashPattern[0]=1,this.dashPattern[1]=1,this._invertedPattern=!0;break;case 7:this.dashType="JIS Axis";case"JIS Axis":this.dashPattern=new Float32Array(4),this.dashPattern[0]=2,this.dashPattern[1]=1,this.dashPattern[2]=12,this.dashPattern[3]=1;break;default:this.dashType="None",this.dashPattern[0]=-1}},s.prototype.setDashPatternType=function(e){this.dashType=e,this._setDashPatternType();for(var t=1;t<this.dashPattern.length;t++)this.dashPattern[t]+=this.dashPattern[t-1];this.isDashedLine=this.dashPattern[0]>0,this.needsUpdate=!0,this._invalidateDisplayRangeLists(),this.updateDeferredMaterials()},s.prototype.activatePDSFX=function(e){e=e||{},this._PDSFXData=new i,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions(),this._PDSFXData.PDSFX_hasAlbedo=!0,this._PDSFXData.PDSFX_hasHalfWidth=!0,this._PDSFXData.PDSFX_hasOpacity=!0},s.prototype.loadUniforms=function(e,t,i,a,s,r){e.loadGASUniforms(t,this,i,a,null),i.pixelSize&&t.uniform2f(i.pixelSize,this.pixelSize.x,this.pixelSize.y),this.isDashedLine&&(i.dashPattern&&t.uniform1fv(i.dashPattern,this.dashPattern),i.totalSize&&t.uniform1f(i.totalSize,this.dashPattern[this.dashPattern.length-1]),i.patternOffset&&t.uniform1f(i.patternOffset,this.patternOffset))},s.prototype.getPredefinedMaterial=function(t,i,s){var r=this.getBaseId();switch(r+="Line",r+="S"+this.side,r+="CP"+this.enableClipPlanes,r+="Type"+i,i){case e.DefaultAppearanceMode.__QA_AUTOMATION__:if(r+="Col"+this.color.getHex(),r="id"+(r+="Op"+this._opacity).hashCode(),!a.PredefinedMaterials.has(r)){var n=new e.LineBasicMaterial({side:this.side,enableClipPlanes:this.enableClipPlanes,color:this.color,opacity:this._opacity});n.activatePDSFX();var o={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor.rgb = ComputeAlbedo();","ioFinalColor.a = ComputeOpacity();","#ifdef GAMMA_OUTPUT","ioFinalColor.rgb = sqrt(ioFinalColor.rgb);","#endif","}"].join("\n")};n.setPDSFXOverridableFunctions({},o);var l=new a.DeferredMaterial(n);a.PredefinedMaterials.set(r,l)}break;default:return this}return a.PredefinedMaterials.get(r).get(this)},s.prototype.getZOnlyMaterial=function(){return this},s.prototype._defaultPDSFXOverridableFunctions=function(){var i=t.prototype._defaultPDSFXOverridableFunctions.call(this);return Object.assign(i.vertex,{ComputeObjectFollowingPosition:e.ShaderChunk.PDSFXComputeObjectFollowingPosition_VS,ComputeObjectPreviousPosition:e.ShaderChunk.PDSFXComputeObjectPreviousPosition_VS,ProcessLineDistance:e.ShaderChunk.PDSFXProcessLineDistance_VS,ComputeHalfWidth:e.ShaderChunk.PDSFXComputeHalfWidth_VS}),Object.assign(i.fragment,{ComputeHalfWidth:e.ShaderChunk.PDSFXComputeHalfWidth_FS,ProcessLinePattern:e.ShaderChunk.PDSFXProcessLinePattern_FS}),i},s.prototype._getBodyEdgeMaterial=function(){return this},s.prototype.updateDeferredMaterials=function(i){t.prototype.updateDeferredMaterials.call(this,i),this._deferredMaterials[e.MaterialToUse.shadowMapDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalDepthIoRRoughnessMaterial]=null,this._deferredMaterials[e.MaterialToUse.normalDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepthMaterial]=null,this._deferredMaterials[e.MaterialToUse.texCoordMaterial]=null},s.prototype.targetPrimitiveType="LINES",s.prototype.useClippingTolerance=!0,s.prototype.__dimension=1,s}),define("DS/Materials/LineBasicMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/LineDSMaterial","DS/Materials/DeferredCaches","DS/Mesh/Mesh"],function(e,t,i,a){"use strict";const s={createDiskXY:function(t,i=.5){const s=new Uint16Array(3*t),r=new Float32Array(3*(t+1));r[0]=0,r[1]=0,r[2]=i;for(let e=0;e<t;e++){let a=2*Math.PI*e/t;r[3*(e+1)+0]=Math.cos(a),r[3*(e+1)+1]=Math.sin(a),r[3*(e+1)+2]=i,s[3*e+0]=0,s[3*e+1]=e+1,s[3*e+2]=e+1==t?1:e+2}let n=new e.BufferGeometryDS;n.vertexIndexArray=s,n.vertexPositionArray=r;const o=new a.DrawingGroup(null,null,4,0,s.length);return o.geometry=n,n.drawingGroups=[o],n},homogeneousDistance:function(e,t){const i=e.x/e.w-t.x/t.w,a=e.y/e.w-t.y/t.w,s=e.z/e.w-t.z/t.w;return Math.sqrt(i*i+a*a+s*s)},screenDistance:function(t,i,a=NaN){function s(e,t){const i=e.x/e.w-t.x/t.w,a=e.y/e.w-t.y/t.w;return Math.sqrt(i*i+a*a)}const r=Math.abs(t.z)>Math.abs(t.w),n=Math.abs(i.z)>Math.abs(i.w);if(!r&&!n)return s(t,i);if(r&&n)return a;const o=-(t.w+t.z)/(i.z-t.z+(i.w-t.w)),l=new e.Vector4(t.x+o*(i.x-t.x),t.y+o*(i.y-t.y),t.z+o*(i.z-t.z),t.w+o*(i.w-t.w));return r?s(l,i):s(t,l)}},r=function({points_flattened:t,is_triangle_mesh:i}){const a=t.length/3,s={lineNumPoints:{type:"i",value:a},linePoints:{type:"fv3",value:t,length:a},lineScreenDists:{type:"fv1",value:Array(a).fill(0),length:a},lineShapeColor:{type:"v3",value:new e.Vector3(1,1,1)},lineScreenSpace:{type:"b",value:!0},lineShapeThickness:{type:"f",value:1},lineCurvilinearScale:{type:"f",value:1},lineShapeTransform:{type:"m4",value:new e.Matrix4}},r=["mat4 transpose(mat4 m)","{","mat4 n;","n[0] = vec4(m[0][0], m[1][0], m[2][0], m[3][0]);","n[1] = vec4(m[0][1], m[1][1], m[2][1], m[3][1]);","n[2] = vec4(m[0][2], m[1][2], m[2][2], m[3][2]);","n[3] = vec4(m[0][3], m[1][3], m[2][3], m[3][3]);","return n;","}","mat4 GetClip2Screen()","{","vec2 v = vec2(vGetViewportSize()) / 2.0;","return mat4(","\tv.x, 0.0, 0.0, 0.0,","\t0.0, v.y, 0.0, 0.0,","\t0.0, 0.0, 1.0, 0.0,","\tv.x, v.y, 0.0, 1.0",");","}","mat4 GetScreen2Clip()","{","vec2 v = vec2(vGetViewportSize()) / 2.0;","return mat4(","\t1.0/v.x,     0.0, 0.0, 0.0,","\t    0.0, 1.0/v.y, 0.0, 0.0,","\t    0.0,     0.0, 1.0, 0.0,","\t   -1.0,    -1.0, 0.0, 1.0",");","}","int GetLinePtRangeBegin() { return int(lineShapeSegment.z); }","int GetLinePtRangeEnd()   { return int(lineShapeSegment.w); }","float GetLineMaxDistance() { return lineScreenDists[GetLinePtRangeEnd() - 1]; }","int GetLineSegment(float lx)","{","int begin = GetLinePtRangeBegin();","int end   = GetLinePtRangeEnd();","int i = begin + 1;","for(int _=0; _<64; _++)","{","if(i >= end) break;","if(lx <= lineScreenDists[i]) return i - 1;","i++;","}","return end - 2;","}","mat4 GetLineBase2Clip(float lx, vec4 Pi, vec4 Pj)","{","vec2 half_screen = vec2(vGetViewportSize()) / 2.0;","vec4 D = Pj - Pi;","D.xy *= half_screen;","float t = (lx - Pi.w) / D.w;","vec2 sXY = vec2(length(D.xy) / D.w) / half_screen;","float sZ = D.z / D.w;","mat4 frame;","frame[0] = vec4(sXY * normalize(vec2(D.x,  D.y)), sZ, 0.0);","frame[1] = vec4(sXY * normalize(vec2(-D.y, D.x)), 0.0, 0.0);","frame[2] = vec4(0.0);","frame[3] = vec4(Pi.xy + t * D.xy / half_screen, Pi.z + t * D.z, 1.0);","return frame;","}","mat4 GetLineBase2Model(float lx, vec4 Pi, vec4 Pj)","{","vec4 D = Pj - Pi;","vec3 N = normalize(cross(vec3(0.0, 0.0, 1.0), D.xyz));","if(dot(N, N) < 0.9) N = vec3(0.0, 1.0, 0.0);","float t = (lx - Pi.w) / D.w;","float len = length(D.xyz);","mat4 frame;","frame[0] = vec4(D.xyz / D.w, 0.0);","frame[1] = vec4(N * len / D.w, 0.0);","frame[2] = vec4(0.0);","frame[3] = vec4(Pi.xyz + t * D.xyz, 1.0);","return frame;","}","void GetLineEndpoints(int segment, out vec4 Pi, out vec4 Pj)","{","int i = segment, j = segment + 1;","Pi = vec4(linePoints[i].xyz, lineScreenDists[i]);","Pj = vec4(linePoints[j].xyz, lineScreenDists[j]);","}","bool ClipLineSegment(inout vec4 Pi, inout vec4 Pj, mat4 obj2clip)","{","vec4 Pi4 = obj2clip * vec4(Pi.xyz, 1.0);","vec4 Pj4 = obj2clip * vec4(Pj.xyz, 1.0);","float dist_i = Pi.w;","float dist_j = Pj.w;","bool clip_i = abs(Pi4.z) > abs(Pi4.w);","bool clip_j = abs(Pj4.z) > abs(Pj4.w);","if(clip_i && clip_j) return true;","if(clip_i != clip_j)","{","float t = -(Pi4.w + Pi4.z) / (Pj4.z - Pi4.z + (Pj4.w - Pi4.w));","vec4 Pclipped = Pi4 + t * (Pj4 - Pi4);","if(clip_i) Pi4 = Pclipped;","else       Pj4 = Pclipped;","float new_delta = length((Pj4.xy / Pj4.w - Pi4.xy / Pi4.w) * vec2(vGetViewportSize()) / 2.0) / lineCurvilinearScale;","if(clip_i) dist_i = dist_j - new_delta;","else       dist_j = dist_i + new_delta;","}","Pi = vec4(Pi4.xyz / Pi4.w, dist_i);","Pj = vec4(Pj4.xyz / Pj4.w, dist_j);","return false;","}","vec3 ComputeModelPosition(vec3 input_position, out vec3 curvilinear)","{","const int lineKeepShapeAspect = 1;","vec4 base = lineShapeTransform * vec4(input_position, 1.0);","base /= base.w;","float inst_cx = lineShapeSegment.x;","curvilinear = vec3(inst_cx + base.x * lineShapeSegment.y, base.y, GetLineMaxDistance());","float cx = inst_cx + base.z * lineShapeSegment.y;","base.x -= base.z;","vec4 Pi, Pj;","GetLineEndpoints(GetLineSegment(cx), Pi, Pj);","if(lineScreenSpace && ClipLineSegment(Pi, Pj, vGetProjectionMatrix() * vGetWorldViewMatrix()))","return vec3(0.0 / 0.0);","if(lineScreenSpace)","{","mat4 base2Clip = GetLineBase2Clip(cx, Pi, Pj);","base2Clip[0].xyz *= lineShapeSegment.y;","if(lineKeepShapeAspect != 0)","base2Clip[1].xyz *= lineShapeSegment.y;","else","base2Clip[1] = GetScreen2Clip() * normalize(GetClip2Screen() * base2Clip[1]) * lineShapeThickness;","vec4 clip = base2Clip * base;","mat4 clip2obj = transpose(vGetWorldViewInvTranspMatrix()) * vGetProjectionInvMatrix();","vec4 model = clip2obj * clip;","return model.xyz / model.w;","}","else","{","mat4 base2Model = GetLineBase2Model(cx, Pi, Pj);","base2Model[0].xyz *= lineShapeSegment.y;","base2Model[1].xyz *= lineShapeSegment.y;","vec4 model = base2Model * base;","return model.xyz / model.w;","}","}"].join("\n");let n=new(i?e.MeshBasicMaterial:e.LineBasicMaterial)({color:16777215,force:!0});return n.activatePDSFX(),n.setPDSFXUniforms(s),n.setPDSFXVaryings({curvilinear:{type:"v3"}}),n.setPDSFXGlobalShaderCode(r,""),n.setPDSFXOverridableFunctions({ComputeObjectPosition:"vec3 ComputeObjectPosition()                   {           return ComputeModelPosition(vGetAttribPosition(), curvilinear); }",ComputeObjectFollowingPosition:"vec3 ComputeObjectFollowingPosition() { vec3 tmp; return ComputeModelPosition(vGetAttribFollowingPosition(), tmp); }",ComputeObjectPreviousPosition:"vec3 ComputeObjectPreviousPosition()   { vec3 tmp; return ComputeModelPosition(vGetAttribPreviousPosition(), tmp); }"},{ComputeViewNormal:"vec3 ComputeViewNormal() { return vec3(0.0, 0.0, -1.0); }",ComputeAlbedo:"vec3 ComputeAlbedo() { return lineShapeColor * lineShapeColor; }",ComputeDiscard:"bool ComputeDiscard() { return curvilinear.x > curvilinear.z || curvilinear.x < 0.0; }"}),n.side=e.Constants.DoubleSide,n},n=function(t,i){void 0!==i.distances&&t.updatePDSFXUniform("lineScreenDists",i.distances),void 0!==i.color&&t.updatePDSFXUniform("lineShapeColor",new e.Vector3(i.color.r,i.color.g,i.color.b)),void 0!==i.thickness&&(t.updatePDSFXUniform("lineShapeThickness",i.thickness),t.setLineWidth&&t.setLineWidth(i.thickness)),void 0!==i.scale&&t.updatePDSFXUniform("lineCurvilinearScale",i.scale),void 0!==i.screenSpace&&t.updatePDSFXUniform("lineScreenSpace",i.screenSpace),void 0!==i.shapeTransform&&t.updatePDSFXUniform("lineShapeTransform",i.shapeTransform)},o={isValidPattern:e=>Array.isArray(e)||ArrayBuffer.isView(e),isDashPatternArray:e=>e.length>0&&"number"==typeof e[0],segmentIsDash:e=>e.length>0&&(void 0===e.shape||null===e.shape),segmentIsShape:e=>e.length>0&&void 0!==e.shape&&null!==e.shape,segmentIsPoint:e=>0===e.length,collapseSameSign:function(e){if(0===e.length)return e;let t=0;for(let i=1;i<e.length;i++){const a=e[i];Math.sign(e[t])*Math.sign(a)>-.5?e[t]+=a:++t!==i&&(e[t]=a)}return e.length=t+1,e},instantiatePatternPoints:function(e,t,i,a){let r=!1;for(let s=0;s<e.length;s++){let n=e[s];this.segmentIsPoint(n)&&(n.length=i/a,n.shape=t.length,r=!0)}return r&&t.push(s.createDiskXY(31).drawingGroups[0]),r},extractDashPattern:function(e){const t=this.collapseSameSign(e.map(e=>this.segmentIsShape(e)?-e.length:e.length));return Float32Array.from(t,Math.abs)},trimUnusedShapes:function(e,t){let i=new Set(e.filter(this.segmentIsShape).map(e=>e.shape));if(0===(i=[...i].sort((e,t)=>e-t)).length)return[];if(i[i.length-1]>=t.length)return console.error(`Complex line pattern requires shape n°${i[i.length-1]}, but only ${t.length} were specified. No shapes will be used.`),[];for(let t=0;t<e.length;t++){let a=e[t];this.segmentIsShape(a)&&(a.shape=i.indexOf(a.shape))}return i.map(e=>t[e])},setSegmentTransforms4x4:function(t){for(let i=0;i<t.length;i++){const a=t[i];if(a.matrix)if(16!==a.matrix.elements.length){let t=a.matrix.elements;a.matrix=new e.Matrix4,a.matrix.elements=[t[0],t[1],0,t[2],t[3],t[4],0,t[5],0,0,1,0,t[6],t[7],0,t[8]]}else if(!(a.matrix instanceof e.Matrix4)){const t=a.matrix.elements;a.matrix=new e.Matrix4,a.matrix.elements=t}}},computeOffsetsAndStride:function(e){let t=0;for(let i=0;i<e.length;i++){let a=e[i];a.offset=t,t+=Math.abs(a.length)}return t},computeBaseTransform:function(t){const i=1/t.size().x,a=new e.Vector3(-i*t.min.x,-i*(t.min.y+t.max.y)/2,0);let s=(new e.Matrix4).makeScale(i,i,1);return s.setPosition(a),s},normalizeSegments:function(t,i){for(let a=0;a<t.length;a++){let s=t[a];if(!this.segmentIsShape(s))continue;const r=i[s.shape],n=r.start,o=r.start+r.count,l=new e.Box3,h=new e.Vector3;for(let e=n;e<o;e++)r.geometry.getVertexPosition(r.geometry.vertexIndexArray[e],h),l.expandByPoint(h);const p=this.computeBaseTransform(l);s.matrix?s.matrix.multiply(p):s.matrix=p}},deduplicatePoints:function(e){const t=e=>Math.round(2e5*e-.5)/2e5,i=e=>Math.round(2e5*e+.5)/2e5;const a=e.length/3;let s={},r=a>65535?new Uint32Array(a):new Uint16Array(a);for(let h=0;h<a;h++){const a=(n=e[3*h+0],o=e[3*h+1],l=e[3*h+2],[t(n)+";"+t(o)+";"+t(l),t(n)+";"+t(o)+";"+i(l),t(n)+";"+i(o)+";"+t(l),t(n)+";"+i(o)+";"+i(l),i(n)+";"+t(o)+";"+t(l),i(n)+";"+t(o)+";"+i(l),i(n)+";"+i(o)+";"+t(l),i(n)+";"+i(o)+";"+i(l)]);let p=void 0;for(let e=0;e<a.length&&void 0===p;e++)p=s[a[e]];if(void 0===p){p=h;for(let e=0;e<a.length;e++)s[a[e]]=h}r[h]=p}var n,o,l;return r},extractLineStrips:function(e,t,i){function a(e){const a=t[e];return i?i[a]:a}const s=e.length/3;let r=Array.from({length:s},()=>new Set),n=Array.from({length:s},()=>new Set);for(let e=0;e<t.length;e+=2){const t=a(e),i=a(e+1);n[t].add(i),r[i].add(t)}function o(e,t,i){const a=t[e].values().next().value;return void 0===a?a:(t[e].delete(a),i[a].delete(e),a)}let l=[];for(let e=0;e<s;e++){if(0===r[e].size&&0===n[e].size)continue;let t=[];function h(e,i,a){let s=e;for(;void 0!==s;)t.push(s),s=o(s,i,a)}h(e,r,n),t.reverse().pop(),h(e,n,r),l.push(t)}let p=[],d=[];for(let t=0;t<l.length;t++){const i=l[t];d.push(p.length/3);for(let t=0;t<i.length;t++){const a=i[t];p.push(e[3*a+0]),p.push(e[3*a+1]),p.push(e[3*a+2])}}return{points:new Float32Array(p),starts:p.length>65535?new Uint32Array(d):new Uint16Array(d)}},distanceAndSubStrips:function({scale:t,strips:i,pointTransform:a,distanceFunction:s,initial_dist:r=0}){let n=new e.Vector4,o=new e.Vector4;function l(e){n.copy(o),o.set(i.points[3*e+0],i.points[3*e+1],i.points[3*e+2],1).applyMatrix4(a)}const h=i.points.length/3,p=i.starts.length,d=r/t;let f=new Float32Array(h),c=[];for(let e=0;e<p;e++){const a=i.starts[e],r=e+1<p?i.starts[e+1]:h;l(a),f[a]=d,c.push(a);for(let e=a;e+1<r;e++){l(e+1);const i=s(n,o)/t;Number.isFinite(i)?f[e+1]=f[e]+i:(f[e+1]=d,c.push(e+1))}}return{distances:f,starts:c}},computeInstancePlacements:function({pattern:e,stride:t,scale:i,strips:a,pointTransform:s,distanceFunction:r,initial_dist:n=0,wholePatternsOnly:o=!1}){const l=this.distanceAndSubStrips({scale:i,strips:a,pointTransform:s,distanceFunction:r,initial_dist:n});let h=e.map(e=>Number.isInteger(e.shape)?{count:function(){return this.attrib.data.length/4},transform:e.matrix,attrib:{attribName:"lineShapeSegment",type:"v4",isFlattened:!0,data:[]}}:null);function p(i,a,s,r,n=0){if(i>a)return;const o=Math.floor(i/t),l=Math.ceil(a/t);for(let p=o;p<l;p++){const o=p*t;for(let t=0;t<e.length;t++){if(null===h[t])continue;const l=e[t],p=o+l.offset;p<i||p>=a||h[t].attrib.data.push(p+n,l.length,s,r)}}}function d(i,a,s){const r=t*Math.floor(i/t);for(let t=0;t<e.length;t++){if(null===h[t])continue;const n=e[t],o=r+n.offset,l=o+n.length;o>=i||l<=i||h[t].attrib.data.push(o,n.length,a,s)}}function f(e){for(let t=0;t<h.length;t++){if(null===h[t])continue;const i=h[t].count();if(i<1)continue;let a=h[t].attrib;const s=a.data[4*(i-1)+3];(s<0||s>e)&&(a.data[4*(i-1)+3]=e)}}const c=a.points.length/3,u=l.starts.length,m=l.distances;for(let e=0;e<u;e++){const i=l.starts[e],a=e+1<u?l.starts[e+1]:c;if(o){const e=m[i],s=m[a-1]-e,r=t*Math.floor(s/t),n=e+(s-r)/2;for(let t=i;t+1<a;t++)p(m[t]-e,Math.min(m[t+1]-e,r),t,-1,n)}else{d(m[i],i,-1);for(let e=i;e+1<a;e++)p(m[e],m[e+1],e,-1)}f(a)}for(let e=0;e<h.length;e++){if(null===h[e])continue;const t=h[e].count();let i=h[e].attrib;if(t<1)continue;let a=c;for(let e=t-1;e>=0;e--){let t=i.data[4*e+3];t>=0&&t<a&&(a=t),t=i.data[4*e+2];const s=Math.max(i.data[4*e+0],i.data[4*e+0]+i.data[4*e+1]);for(;s>m[t]&&t<a;)t++;t<a&&t++,i.data[4*e+3]=t,t<a&&(a=t)}}let S=null;if(o){S=[];const i=this.collapseSameSign(e.map(e=>this.segmentIsShape(e)?-e.length:e.length));for(let e=0;e<u;e++){const a=l.starts[e],s=e+1<u?l.starts[e+1]:c,r=m[a],n=m[s-1]-r,o=Math.floor(n/t);if(o<1){S.push(n+2*r);continue}const h=r+(n-t*o)/2;S.push(h);for(let e=0;e<i.length*o;e++)S.push(i[e%i.length]);S.push(h)}S=Float32Array.from(this.collapseSameSign(S),Math.abs)}return{distances:m,instances:h.filter(e=>null!==e),dashes:S}},createShapeDrawingGroup:function(e,t){let i=r({points_flattened:t,is_triangle_mesh:4===e.glType});const s=new a.DrawingGroup(void 0,i,e.glType,e.start,e.count);return s._primitives=[{group:s,start:s.start,count:s.count}],s.geometry=e.geometry,s},computeDependentDGs:function(t,i,a,r){let o=e=>this.computeDependentDGs(t,i,a,e),l=t._dependentDGs;if(!i._isLineWithShapes||0===i._patternShapes.length)return l&&l.lineShapes&&delete l.lineShapes,[];if(l||(l=t._dependentDGs={}),!l.lineShapes){const e=this.extractLineStrips(a.vertexPositionArray,a.vertexIndexArray.subarray(t.start,t.start+t.count),i._wholePatternsOnly?null:this.deduplicatePoints(a.vertexPositionArray)),s=i._pattern.map(e=>Number.isInteger(e.shape)?i._patternShapes[e.shape]:null).filter(e=>null!==e);l.lineShapes={obj2screen:null,strips:e,drawingGroups:s.map(t=>this.createShapeDrawingGroup(t,e.points))};for(let e=0;e<l.lineShapes.drawingGroups.length;e++)l.lineShapes.drawingGroups[e]._updateLineWithShapes=o}if(!l.lineShapes.obj2screen||!l.lineShapes.obj2screen.equals(r)){l.lineShapes.obj2screen=r;const t=!i._worldSizePattern,a=this.computeInstancePlacements({pattern:i._pattern,stride:i._patternStride,scale:i.scale,strips:l.lineShapes.strips,pointTransform:t?l.lineShapes.obj2screen:new e.Matrix4,distanceFunction:t?s.screenDistance:s.homogeneousDistance,initial_dist:"butt"!=i.linecap?i.lineWidth/2:0,wholePatternsOnly:i._wholePatternsOnly});a.dashes&&i.setDashPatternArray(a.dashes);for(let e=0;e<a.instances.length;e++){const s=l.lineShapes.drawingGroups[e],r=a.instances[e];s.setInstancingParameters(r.count(),[r.attrib],"mesh"),n(s.material,{distances:a.distances,color:i.color,scale:i.scale,thickness:i.lineWidth,screenSpace:t,shapeTransform:r.transform});const o=s.geometry.wideLinesLinker&&s.geometry.wideLinesLinker.originalDGToWideDG.get(s);o&&o.setInstancingParameters(r.count(),[r.attrib],"mesh")}}return l.lineShapes.drawingGroups}};var l=function(e){this._isLineWithShapes=!1,this._isBidimLine=!1,this._pattern=null,this._patternShapes=[],this._patternStride=NaN,t.call(this,e),this._worldSizePattern=e&&!!e._worldSizePattern,this._wholePatternsOnly=e&&!!e._wholePatternsOnly,this.polygonBorderMode=e&&!!e.polygonBorderMode,this._worldSizePattern&&(this.backMaterial&&this.backMaterial._worldSizePattern!==this._worldSizePattern&&(console.error("Non matching pattern units in back material"),this.setBackMaterial(null)),this.isCPUPattern&&(console.error("CPU Pattern not possible in model space unit"),this.setCPUPattern(!1)),this.linecap="butt"),this.isWideLine=this.lineWidth>1||this.isCPUPattern&&this.isDashedLine,this.backMaterial&&(this.backMaterial.isWideLine=this.backMaterial.lineWidth>1||this.isCPUPattern&&this.backMaterial.isDashedLine),this.polygonBorderMode&&(this.polygonOffset=this.polygonOffset?this.polygonOffset:this.lineWidth>1,this.polygonOffsetFactor=this.polygonOffsetFactor?this.polygonOffsetFactor:-1,this.polygonOffsetUnits=this.polygonOffsetUnits?this.polygonOffsetUnits:-10),e&&e.pattern&&this.setPattern({pattern:e.pattern,shapes:e.patternShapes}),this._wholePatternsOnly&&(this._isBidimLine=!1,this._invertedPattern=!1)};function h(e,t,i){var a=e.getBaseId();if(a+="GT-Edge"+t+"S"+e.side+"CP"+e.enableClipPlanes+"TR"+(e.transparent||e.getOpacity()<1)+"LW"+e.lineWidth,a+="PBM"+e.polygonBorderMode,a+="LC"+e.linecap+"LJ"+e.linejoin,a+="O"+e.opacity,e.isDashedLine){a+="SC"+e.scale,a+="IP"+e._invertedPattern+"WS"+e._worldSizePattern+"CPU"+e.isCPUPattern;for(var s=0;s<e.dashPattern.length;s++){a+=s+"p"+e.dashPattern[s]}}return a="id"+(a+=i||"").hashCode()}function p(t,i){var a={color:i||new e.Color,opacity:t.opacity,side:t.side,lineWidth:t.lineWidth,enableClipPlanes:t.enableClipPlanes,linejoin:t.linejoin,linecap:t.linecap,scale:t.scale,pixelSize:t.pixelSize,isCPUPattern:t.isCPUPattern,patternOffset:t.patternOffset,transparent:t.transparent||t.getOpacity()<1,polygonBorderMode:t.polygonBorderMode,invertedPattern:t._invertedPattern,_worldSizePattern:t._worldSizePattern};if(t.isDashedLine){a.dashPattern=new Float32Array(t.dashPattern);for(var s=a.dashPattern.length-1;s>0;s--)a.dashPattern[s]-=a.dashPattern[s-1]}return a}return(l.prototype=Object.create(t.prototype)).clone=function(){var e=new l;return t.prototype.clone.call(this,e),e.polygonBorderMode=this.polygonBorderMode,e._isBidimLine=this._isBidimLine,e._isLineWithShapes=this._isLineWithShapes,e._pattern=this._pattern,e._patternShapes=this._patternShapes,e._patternStride=this._patternStride,e},l.prototype._shaderID="line",l.prototype._setMaterialShaderOptions=function(e,i,a,s,r,n){t.prototype._setMaterialShaderOptions.call(this,e,i,a,s,r,n);var o={};n||Object.assign(o,{worldSizePattern:this._worldSizePattern,cpuPattern:this.isCPUPattern}),Object.assign(o,{polygonBorderMode:this.polygonBorderMode}),Object.assign(e,o)},l.prototype.setPattern=function(e){if(!e||!e.pattern)return this._isLineWithShapes=!1,this._isBidimLine=!1,this._pattern=null,this._patternShapes=[],this._patternStride=NaN,void this.setDashPatternArray([]);if(!o.isValidPattern(e.pattern))return void console.error("Invalid pattern: expected an array (of numbers or of segments), got: ",e.pattern);if(o.isDashPatternArray(e.pattern))return void this.setDashPatternArray(e.pattern);let t=JSON.parse(JSON.stringify(e.pattern)),i=(e.shapes||[]).slice();o.setSegmentTransforms4x4(t),o.instantiatePatternPoints(t,i,this.lineWidth,this.scale),this._invertedPattern=!o.segmentIsDash(t[0]),this.setDashPatternArray(o.extractDashPattern(t)),0!==(i=o.trimUnusedShapes(t,i)).length&&(o.normalizeSegments(t,i),this._pattern=t,this._patternShapes=i,this._patternStride=o.computeOffsetsAndStride(this._pattern),this._isLineWithShapes=!0,this._isBidimLine=!this._pattern.some(o.segmentIsDash))},l.prototype.loadUniforms=function(e,i,a,s,r,n){if(t.prototype.loadUniforms.call(this,e,i,a,s,r,n),a.halfWidth&&i.uniform1f(a.halfWidth,this.lineWidth?e._renderScale*this.lineWidth/2:.5),a.scale){var o=this._worldSizePattern?1:e._renderScale;i.uniform1f(a.scale,this.scale?o*this.scale:.15)}},l.prototype.getType=function(){return"Line"},l.prototype._computeDependentDGs=function(e,t,i){return o.computeDependentDGs(e,this,t,i)},l.prototype.setLineWidth=function(e){e<1&&(e=1);var t=Math.round(e);if(Math.abs(this.lineWidth-t)>1e-6){var i=this.isWideLine;this.lineWidth=t,this.polygonBorderMode&&(this.polygonOffset=this.polygonOffset?this.polygonOffset:this.lineWidth>1,this.polygonOffsetFactor=this.polygonOffsetFactor?this.polygonOffsetFactor:-1,this.polygonOffsetUnits=this.polygonOffsetUnits?this.polygonOffsetUnits:-10),this.isWideLine=this.lineWidth>1||this.isCPUPattern&&this.isDashedLine,this.needsUpdate=i!==this.isWideLine,this._invalidateDisplayRangeLists(),this.updateDeferredMaterials()}},l.prototype.getGeomTypeDeferredMaterial=function(t,i){switch(t){case e.GeomTypeEnum.BOUNDARY_EDGE:return this._getBoundaryEdgeMaterial(i.boundaryEdge);case e.GeomTypeEnum.SMOOTH_EDGE:return this._getSmoothEdgeMaterial(i.smoothEdge)}return this},l.prototype.setBackMaterial=function(t){t&&t._worldSizePattern!==this._worldSizePattern?console.error("Non matching pattern units in back material"):(e.DeferrableMaterial.prototype.setBackMaterial.call(this,t),this.backMaterial&&(this.backMaterial.isWideLine=this.backMaterial.lineWidth>1||this.isCPUPattern&&this.backMaterial.isDashedLine),this.updateDeferredMaterials())},l.prototype.setDashPatternArray=function(e){t.prototype.setDashPatternArray.call(this,e),this.needsUpdate&&(this.isWideLine=this.lineWidth>1||this.isCPUPattern&&this.isDashedLine,this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())},l.prototype.setDashPatternType=function(e){t.prototype.setDashPatternType.call(this,e),this.needsUpdate&&(this.isWideLine=this.lineWidth>1||this.isCPUPattern&&this.isDashedLine,this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())},l.prototype.setCPUPattern=function(e){this._worldSizePattern&&e&&(console.error("CPU Pattern not possible in model space unit"),e=!1),this.isCPUPattern!==e&&(this.isCPUPattern=e,this.needsUpdate=!0,this.isWideLine=this.lineWidth>1||this.isCPUPattern&&this.isDashedLine,null!==this.backMaterial&&(this.backMaterial.isCPUPattern=this.isCPUPattern,this.backMaterial.isWideLine=this.backMaterial.lineWidth>1||this.isCPUPattern&&this.backMaterial.isDashedLine,this.backMaterial.needsUpdate=!0,this.backMaterial._invalidateDisplayRangeLists(),this.backMaterial.updateDeferredMaterials()),this._invalidateDisplayRangeLists(),this.updateDeferredMaterials())},l.prototype._getBoundaryEdgeMaterial=function(t){if(!t.enabled)return this;var a=h(this,e.GeomTypeEnum.BOUNDARY_EDGE);if(i.GeomTypeMaterials.has(a))return i.GeomTypeMaterials.get(a).get(this);var s=p(this,null),r=new l(s);r.color=t.color;var n=new i.DeferredMaterial(r);return i.GeomTypeMaterials.set(a,n),n.get(this)},l.prototype._getSmoothEdgeMaterial=function(t){if(!t)return this;var a=h(this,e.GeomTypeEnum.SMOOTH_EDGE,"Col"+this.color.getHex());if(i.GeomTypeMaterials.has(a))return i.GeomTypeMaterials.get(a).get(this);var s=p(this,this.color);s.opacity*=.5;var r=new l(s),n=new i.DeferredMaterial(r);return i.GeomTypeMaterials.set(a,n),n.get(this)},l.prototype._getBodyEdgeMaterial=function(){var e=this.getBaseId();if(e+="BodyEdgeS"+this.side+"CP"+this.enableClipPlanes+"TR"+(this.transparent||this.getOpacity()<1),e+="O"+this.opacity,e="id"+(e+="Col"+this.color.getHex()).hashCode(),i.GeomTypeMaterials.has(e))return i.GeomTypeMaterials.get(e).get(this);var t={color:this.color,opacity:this.opacity,side:this.side,enableClipPlanes:this.enableClipPlanes,transparent:this.transparent||this.getOpacity()<1},a=new l(t),s=new i.DeferredMaterial(a);return i.GeomTypeMaterials.set(e,s),s.get(this)},l}),define("DS/Materials/ShaderMaterial",["DS/Mesh/ThreeJS_Base","DS/Materials/OldInfraMaterial","DS/Materials/PDSFXData"],function(e,t,i){"use strict";var a=function(i){t.call(this),this.fragmentShader="void main() {}",this.vertexShader="void main() {}",this.uniforms={},this.defines={},this.attributes=null,this.shaderID=-1,this.shading=e.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.lights=!1,this.morphTargets=!1,this.morphNormals=!1,this.enableClipPlanes=!1,this.physical=!1,this.enableOIT=!0,this.uniformsList=null,this.numSupportedMorphTargets=0,this.numSupportedMorphNormals=0,this.map=null,this.setValues(i)};return(a.prototype=Object.create(t.prototype))._getTextures=function(e){var i=t.prototype._getTextures.call(this,e);return i=i.concat([this.map])},a.prototype.getType=function(){return"Custom"},a.prototype.getPredefinedMaterial=function(e,t,i){return this},a.prototype.clone=function(i){var s=void 0!==i?i:new a;return t.prototype.clone.call(this,s),s.fragmentShader=this.fragmentShader,s.vertexShader=this.vertexShader,s.uniforms=e.UniformsUtils.clone(this.uniforms),s.attributes=this.attributes,s.defines=this.defines,s.shading=this.shading,s.wireframe=this.wireframe,s.wireframeLinewidth=this.wireframeLinewidth,s.lights=this.lights,s.morphTargets=this.morphTargets,s.morphNormals=this.morphNormals,s.physical=this.physical,s.enableOIT=this.enableOIT,s.uniformsList=this.uniformsList,s.numSupportedMorphTargets=this.numSupportedMorphTargets,s.numSupportedMorphNormals=this.numSupportedMorphNormals,s.map=this.map,s},a.prototype.activatePDSFX=function(e){e=e||{},this._PDSFXData=new i,this._PDSFXData.PDSFX=!0,this._setDefaultPDSFXOverridableFunctions(),this._PDSFXData.PDSFX_hasOpacity=!0},a.prototype.getPickingMaterial=function(){var t=e.UniformsUtils.mergeNoClone([this.uniforms]),i=this.clone();return i.fragmentShader=e._DeferredShaders.PickingFragment.fragmentShader,i.uniforms=t,i.uniforms.pickingColor={type:"c",value:new e.Color},i.vertexColors=this.vertexColors,{pickingMaterial:i,pickingMaterialInstancing:null}},a.prototype.getTexCoordMaterial=function(){return this.getInvisibleMaterial()},a.prototype._dump=function(){throw"Unsupported operation"},a}),define("DS/Materials/ShaderMaterialDS",["DS/Mesh/ThreeJS_Base","DS/Materials/ShaderMaterial","DS/MaterialLibs/GenericLib"],function(e,t,i){"use strict";var a=function(i){console.error("ShaderMaterialDS is deprecated, please use a usual material (Basic, DSPBR19x, LineBasic, ...) with PDSFX instead."),this.vertexShaderPars="",this.fragmentShaderPars="",this.vertexShaderBody="",this.fragmentShaderBody="",this.originalMaterialRef=null,this.needTangentBinormal=!1,t.call(this,i),this.enableOIT&&(this.vertexShaderPars=[this.vertexShaderPars,e.DeferredShaderChunk.oit_pars_vertex].join("\n"),this.vertexShaderBody=[this.vertexShaderBody,e.DeferredShaderChunk.oit_vertex].join("\n"),this.fragmentShaderPars=[this.fragmentShaderPars,e.DeferredShaderChunk.oit_pars_fragment].join("\n"),this.fragmentShaderBody=[this.fragmentShaderBody,e.DeferredShaderChunk.oit_fragment].join("\n")),this.update()};return(a.prototype=Object.create(t.prototype)).clone=function(){var e=new a;return t.prototype.clone.call(this,e),e.vertexShaderPars=this.vertexShaderPars,e.fragmentShaderPars=this.fragmentShaderPars,e.vertexShaderBody=this.vertexShaderBody,e.fragmentShaderBody=this.fragmentShaderBody,e.originalMaterialRef=this,e.needTangentBinormal=this.needTangentBinormal,e},a.prototype.requireTangentBinormal=function(){return this.needTangentBinormal},a.prototype.setShaders=function(e,t,i,a){this.vertexShaderPars=e,this.fragmentShaderPars=i,this.vertexShaderBody=t,this.fragmentShaderBody=a,this.update()},a.prototype.update=function(){var e="";e=[e,this.vertexShaderPars,""].join("\n"),e+="void main() { \n",e+=this.vertexShaderBody,e+="\n",e+="}",this.vertexShader=e;var t="";t+="#if defined( NEEDS_UVTOUSE )\n",t+="vec2 uvToUse; \n",t=[t+="#endif \n",this.fragmentShaderPars,""].join("\n"),t+="void main() { \n",t+="#if defined( NEEDS_UVTOUSE )\n",t+="uvToUse=vUv; \n",t+="#endif \n",t+=this.fragmentShaderBody,t+="\n",t+="}",this.fragmentShader=t,this.needsUpdate=!0},a.prototype.updateDeferredMaterials=function(t){if(this.originalMaterialRef&&this.originalMaterialRef._deferredMaterialsInit){this._deferredMaterials[0]=this;for(var s=1;s<this.originalMaterialRef._deferredMaterials.length;s++)if(this.originalMaterialRef._deferredMaterials[s]instanceof a)for(var r in this._deferredMaterials[s]=this.originalMaterialRef._deferredMaterials[s].clone(),this._deferredMaterials[s].uniforms)r in this.uniforms&&(this._deferredMaterials[s].uniforms[r]=this.uniforms[r]);this._deferredMaterialsInit=!0}else{var n=e.UniformsUtils.mergeNoClone([this.uniforms,e.UniformsUtils.clone(e._DeferredShaders.Normal.uniforms)]),o=e.UniformsUtils.mergeNoClone([this.uniforms,e.UniformsUtils.clone(e._DeferredShaders.Depth.uniforms)]),l=e.UniformsUtils.mergeNoClone([this.uniforms,e.UniformsUtils.clone(e._DeferredShaders.NormalDepthIoRRoughness.uniforms)]),h=e.UniformsUtils.mergeNoClone([this.uniforms,e.UniformsUtils.clone(e._DeferredShaders.NormalDepth.uniforms)]),p=i.depthRGBA,d=e.UniformsUtils.mergeNoClone([this.uniforms,e.UniformsUtils.clone(p.uniforms)]),f=(e._mobileHighlight?e._AdvancedHighlightShaderSinglePass:e._AdvancedHighlightShader).HighlightFace,c=e.UniformsUtils.mergeNoClone([this.uniforms,e.UniformsUtils.clone(f.uniforms)]),u=e._DeferredShaders.PickingFragment,m=e.UniformsUtils.mergeNoClone([this.uniforms,e.UniformsUtils.clone(u.uniforms)]),S=this.defines?this.defines:{};if(this.map&&this.alphaTest){S.USE_MAP_ALPHATEST=!0,S.ALPHATEST=this.alphaTest.toFixed(5),n.map.value=this.map,o.map.value=this.map,l.map.value=this.map,h.map.value=this.map,d.map.value=this.map,c.map.value=this.map,m.map.value=this.map;var M=this.map.offset,_=this.map.repeat;n.offsetAlphaMap.value=M,n.repeatAlphaMap.value=_,o.offsetAlphaMap.value=M,o.repeatAlphaMap.value=_,l.offsetAlphaMap.value=M,l.repeatAlphaMap.value=_,h.offsetAlphaMap.value=M,h.repeatAlphaMap.value=_,d.offsetAlphaMap.value=M,d.repeatAlphaMap.value=_,c.offsetAlphaMap.value=M,c.repeatAlphaMap.value=_,m.offsetAlphaMap.value=M,m.repeatAlphaMap.value=_}var C=new a({uniforms:n,vertexShaderPars:[this.vertexShaderPars,e._DeferredShaders.Normal.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,e._DeferredShaders.Normal.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,e._DeferredShaders.Normal.fragmentShaderPars].join("\n"):e._DeferredShaders.Normal.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,e._DeferredShaders.Normal.fragmentShaderBody].join("\n"):e._DeferredShaders.Normal.fragmentShaderBody,shading:this.shading,defines:S,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:!1});this._deferredMaterials[e.MaterialToUse.normalMaterial]=C;var v=new a({uniforms:o,vertexShaderPars:[this.vertexShaderPars,e._DeferredShaders.Depth.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,e._DeferredShaders.Depth.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,e._DeferredShaders.Depth.fragmentShaderPars].join("\n"):e._DeferredShaders.Depth.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,e._DeferredShaders.Depth.fragmentShaderBody].join("\n"):e._DeferredShaders.Depth.fragmentShaderBody,defines:S,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:!1});this._deferredMaterials[e.MaterialToUse.depthMaterial]=v;var g=new a({uniforms:o,vertexShaderPars:[this.vertexShaderPars,e._DeferredShaders.DepthRGBA.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,e._DeferredShaders.DepthRGBA.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,e._DeferredShaders.DepthRGBA.fragmentShaderPars].join("\n"):e._DeferredShaders.DepthRGBA.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,e._DeferredShaders.DepthRGBA.fragmentShaderBody].join("\n"):e._DeferredShaders.DepthRGBA.fragmentShaderBody,defines:S,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:!1});this._deferredMaterials[e.MaterialToUse.depthRGBAMaterial]=g;var P=new a({uniforms:l,vertexShaderPars:[this.vertexShaderPars,e._DeferredShaders.NormalDepthIoRRoughness.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,e._DeferredShaders.NormalDepthIoRRoughness.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,e._DeferredShaders.NormalDepthIoRRoughness.fragmentShaderPars].join("\n"):e._DeferredShaders.NormalDepthIoRRoughness.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,e._DeferredShaders.NormalDepthIoRRoughness.fragmentShaderBody].join("\n"):e._DeferredShaders.NormalDepthIoRRoughness.fragmentShaderBody,shading:this.shading,defines:S,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:!1});this._deferredMaterials[e.MaterialToUse.normalDepthIoRRoughnessMaterial]=P;var y=new a({uniforms:h,vertexShaderPars:[this.vertexShaderPars,e._DeferredShaders.NormalDepth.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,e._DeferredShaders.NormalDepth.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,e._DeferredShaders.NormalDepth.fragmentShaderPars].join("\n"):e._DeferredShaders.NormalDepth.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,e._DeferredShaders.NormalDepth.fragmentShaderBody].join("\n"):e._DeferredShaders.NormalDepth.fragmentShaderBody,shading:this.shading,defines:S,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes});this._deferredMaterials[e.MaterialToUse.normalDepthMaterial]=y;var D=new a({uniforms:h,vertexShaderPars:[this.vertexShaderPars,e._DeferredShaders.DecalNormalStencilDepth.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,e._DeferredShaders.DecalNormalStencilDepth.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,e._DeferredShaders.DecalNormalStencilDepth.fragmentShaderPars].join("\n"):e._DeferredShaders.DecalNormalStencilDepth.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,e._DeferredShaders.DecalNormalStencilDepth.fragmentShaderBody].join("\n"):e._DeferredShaders.DecalNormalStencilDepth.fragmentShaderBody,shading:this.shading,defines:S,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes});this._deferredMaterials[e.MaterialToUse.decalNormalStencilDepthMaterial]=D;var T=new a({uniforms:d,vertexShaderPars:[this.vertexShaderPars,p.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,p.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,p.fragmentShaderPars].join("\n"):p.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,p.fragmentShaderBody].join("\n"):p.fragmentShaderBody,shading:this.shading,defines:S,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:!1});this._deferredMaterials[e.MaterialToUse.shadowMapDepthMaterial]=T,this.copyPDSFXParameters(this._deferredMaterials[e.MaterialToUse.shadowMapDepthMaterial]);var b=new a({uniforms:c,defines:S,vertexShaderPars:[this.vertexShaderPars,f.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,f.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,f.fragmentShaderPars].join("\n"):f.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,f.fragmentShaderBody].join("\n"):f.fragmentShaderBody,blending:e.NoBlending,enableOIT:!1});b.side=e.DoubleSide,b.enableClipPlanes=this.enableClipPlanes,b.vertexColors=this.vertexColors,this._deferredMaterials[e.MaterialToUse.highlightMaterial]=b;var A=new a({uniforms:m,vertexShaderPars:[this.vertexShaderPars,u.vertexShaderPars].join("\n"),vertexShaderBody:[this.vertexShaderBody,u.vertexShaderBody].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,u.fragmentShaderPars].join("\n"):u.fragmentShaderPars,fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,u.fragmentShaderBody].join("\n"):u.fragmentShaderBody,shading:this.shading,defines:S,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:!1});if(A.uniforms.pickingColor={type:"c",value:new e.Color},A.wireframe=this.wireframe,A.vertexColors=this.vertexColors,this.isInstancingMaterial){var x=new a({uniforms:m,vertexShaderPars:[this.vertexShaderPars,u.vertexShaderPars,"varying vec3 vInstancePickingColor;"].join("\n"),vertexShaderBody:[this.vertexShaderBody,u.vertexShaderBody,e._DeferredShaders.Chunks.picking_instancing_vertex].join("\n"),fragmentShaderPars:this.enableClipPlanes?[e.ShaderChunk.clip_pars_fragment,u.fragmentShaderPars,"varying vec3 vInstancePickingColor;"].join("\n"):[u.fragmentShaderPars,"varying vec3 vInstancePickingColor;"].join("\n"),fragmentShaderBody:this.enableClipPlanes?[e.ShaderChunk.clip_fragment,u.fragmentShaderBody,e._DeferredShaders.Chunks.picking_instancing_fragment].join("\n"):[u.fragmentShaderBody,e._DeferredShaders.Chunks.picking_instancing_fragment].join("\n"),shading:this.shading,defines:S,blending:e.NoBlending,side:this.side,enableClipPlanes:this.enableClipPlanes,enableOIT:!1});x.wireframe=this.wireframe,x.vertexColors=this.vertexColors,this._deferredMaterials[e.MaterialToUse.pickingMaterialInstancing]=x}else this._deferredMaterials[e.MaterialToUse.pickingMaterialInstancing]=null;this._deferredMaterials[e.MaterialToUse.pickingMaterial]=A,this._deferredMaterials[e.MaterialToUse.pickingMaterial].refreshUniforms=this.refreshUniforms,this._deferredMaterials[e.MaterialToUse.normalMaterial].refreshUniforms=this.refreshUniforms,this._deferredMaterials[e.MaterialToUse.depthMaterial].refreshUniforms=this.refreshUniforms,this._deferredMaterials[e.MaterialToUse.depthRGBAMaterial].refreshUniforms=this.refreshUniforms,null!==this._deferredMaterials[e.MaterialToUse.pickingMaterialInstancing]&&(this._deferredMaterials[e.MaterialToUse.pickingMaterialInstancing].refreshUniforms=this.refreshUniforms),this.updateGenericDeferredMaterials(t)}},a});