define("DS/CAT3DExpLinkContext/CAT3DExpLinkContext",["UWA/Core","UWA/Class/Promise"],function(e,t){"use strict";return e.Class.extend({init:function(){},getJSONDescription:function(){console.error("not yet implemented");return{}},retrieveLinkDescriptions:function(){return console.error("not yet implemented"),[]},getNameForLinkDescription:function(e){return console.error("not yet implemented"+e),"error"},getFirstLink:function(t){return e.Promise.reject(new Error("DEPRECATED! use getLinkDescriptionByType instead"+t))},resolveLinkAsStream:function(e){return t.reject(new Error("Not yet implemented"+e))},pushStream:function(e,r){return t.reject(new Error("Not yet implemented"+r))},getLinkDescriptionByType:function(e){return t.reject(new Error("Not yet implemented"+e))}})}),define("DS/CAT3DExpLinkContext/CAT3DExpWebLinkContext",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpLinkContext/CAT3DExpLinkContext"],function(e,t,r){"use strict";return r.extend({init:function(e){this._parent(),this._baseURL=e.baseURL,this._links=[],this._links.push({StreamName:e.experienceFile})},getLinkDescriptionByType:function(t){var r,n=[];for(r=0;r<this._links.length;r++)this._getLinkType(this._links[r])===t&&n.push(this._links[r]);if(0===n.length)return e.Promise.reject(new Error("Cant retrieve link for type : "+t));if("CXPExperience_Spec"===n&&n.length>1){for(r=0;r<n.length;r++)if("content.json"===n[r])return e.Promise.resolve(n[r]);console.warn("Media format issue")}return e.Promise.resolve(n[0])},_typeExtMap:{".json":"CXPExperience_Spec",".cgr":"Model_VPMReference_Spec",".xcgr":"Model_VPMReference_Spec",".3dxml":"Model_VPMReference_Spec",".3dx":"Model_VPMReference_Spec",".jpg":"CXPPictureResource_Spec"},_getLinkType:function(e){for(var t in this._typeExtMap)if(e.StreamName.endsWith(t))return this._typeExtMap[t]},retrieveLinkDescriptions:function(){return t.resolve(this._links)},resolveLinkAsStream:function(e){var t=this;return this._httpGet(this._baseURL+e.StreamName).then(function(r){return r.format=t._getLinkFormat(e),r})},_httpGet:function(t){var r=e.Promise.deferred(),n=new XMLHttpRequest;return n.onreadystatechange=function(){4===n.readyState&&200===n.status&&r.resolve(n.response)},n.open("GET",t,!0),n.responseType="blob",n.send(),r.promise},_formatExtMap:{".cgr":"cgr",".xcgr":"cgr",".3dxml":"xmlv43",".3dx":"3dx"},_getLinkFormat:function(e){for(var t in this._formatExtMap)if(e.StreamName.endsWith(t))return this._formatExtMap[t]}})}),define("DS/CAT3DExpLinkContext/CAT3DExpPlatformMediaLinkContext",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpLinkContext/CAT3DExpLinkContext","DS/WAFData/WAFData"],function(e,t,r,n){"use strict";return r.extend({init:function(e){this._parent(),this._objectId=e.physicalid,this._3DSpaceURL=e.serverurl,this._securityContext=e.contextid},getLinkDescriptionByType:function(t){if("CXPExperience_Spec"!==t)return e.Promise.reject(new Error("Cant retrieve link for type : "+t));var r=this;return this.retrieveLinkDescriptions().then(function(n){var i,o=[];for(i=0;i<n.length;i++)r._getLinkType(n[i])===t&&o.push(n[i]);if(0===o.length)return e.Promise.reject(new Error("CAT3DExpPlatformMediaLinkContext unknown Link"));if(o.length>1){for(i=0;i<o.length;i++)if("content.json"===o[i].StreamName)return e.Promise.resolve(o[i]);console.warn("Media format issue")}return e.Promise.resolve(o[0])})},_typeExtMap:{".json":"CXPExperience_Spec",".cgr":"Model_VPMReference_Spec",".xcgr":"Model_VPMReference_Spec",".3dx":"Model_VPMReference_Spec",".3dxc":"Model_VPMReference_Spec",".jpg":"CXPPictureResource_Spec"},_getLinkType:function(e){for(var t in this._typeExtMap)if(e.StreamName.endsWith(t))return this._typeExtMap[t]},retrieveLinkDescriptions:function(){if(this._links)return e.Promise.resolve(this._links);if(this._retrieveLinksPromise)return this._retrieveLinksPromise;var t=this;return this._retrieveLinksPromise=this._retrieveStreamsDef().then(function(e){t._links=[];for(var r=0;r<e.length;r++)t._links.push({StreamName:e[r].persistencyname});return t._links}),this._retrieveLinksPromise},_retrieveStreamsDef:function(){if(this._streamsDef)return e.Promise.resolve(this._streamsDef);if(this._retrieveStreamsDeferred)return this._retrieveStreamsDeferred.promise;this._retrieveStreamsDeferred=e.Promise.deferred();var t=this,r=this._3DSpaceURL+"/resources/experience/medias/"+t._objectId+"/streams";return n.authenticatedRequest(r,{method:"GET",type:"json",headers:{"Content-Type":"application/json",SecurityContext:this._securityContext},onComplete:function(e){t._streamsDef=e.results,t._retrieveStreamsDeferred.resolve(t._streamsDef)},onFailure:function(e){t._retrieveStreamsDeferred.reject(e)}}),this._retrieveStreamsDeferred.promise},resolveLinkAsStream:function(t){if(t)switch(this._getLinkType(t)){case"CXPExperience_Spec":return this._resolveExperienceAsStream(t);default:return this._resolveMediaLinkAsBinaryStream(t)}return e.Promise.reject(new Error("Unknown Link"))},_retrieveStreamDefByLink:function(t){return this._retrieveStreamsDef().then(function(r){for(var n=0;n<r.length;n++)if(r[n].persistencyname===t.StreamName)return r[n];return e.Promise.reject(new Error("Unable to retrieve stream def for"+t.StreamName))})},_resolveExperienceAsStream:function(e){var t=this;return this._retrieveStreamDefByLink(e).then(function(e){return t._retreiveStreamInfo(e)}).then(function(e){return t._retrieveExperienceStream(e)}).then(function(e){return new Blob([e],{type:"text/xml"})})},_resolveMediaLinkAsBinaryStream:function(e){var t=this;return this._retrieveStreamDefByLink(e).then(function(e){return t._retreiveStreamInfo(e)}).then(function(e){return t._retrieveBinaryStream(e)}).then(function(r){var n=new Blob([r],{type:"application/octet-binary"});return n.format=t._getLinkFormat(e),n.filename=e.StreamName,n})},_formatExtMap:{".cgr":"cgr",".xcgr":"cgr",".3dxml":"xmlv43",".3dx":"3dx",".3dxc":"3dxc"},_getLinkFormat:function(e){for(var t in this._formatExtMap)if(e.StreamName.endsWith(t))return this._formatExtMap[t]},_retrieveStream:function(e,t){var r=this;return this._retreiveStreamInfo(e).then(function(e){return r._retrieveStreamContent(e,t)})},_retreiveStreamInfo:function(t){var r=e.Promise.deferred(),i=this._3DSpaceURL+"/resources/experience/medias/"+t.physicalid+"/streams/"+t.persistencyname;return n.authenticatedRequest(i,{cache:-1,method:"GET",type:"json",headers:{"Content-Type":"application/json",SecurityContext:this._securityContext},onComplete:function(e){r.resolve(e.results[0])},onFailure:function(e){r.reject(e)}}),r.promise},_retrieveExperienceStream:function(t){var r=e.Promise.deferred(),i={timeout:1e5,method:"POST",data:"__fcs__jobTicket="+encodeURIComponent(t.ticket),type:"text",proxy:"passport",headers:{"Content-type":"application/x-www-form-urlencoded",Accept:"text/plain"},onComplete:function(e){r.resolve(e)},onFailure:function(e){r.reject(e)}};return n.authenticatedRequest(t.fcsurl,i),r.promise},_retrieveBinaryStream:function(t){var r=e.Promise.deferred(),i={timeout:1e5,method:"POST",data:"__fcs__jobTicket="+encodeURIComponent(t.ticket),type:"arraybuffer",proxy:"passport",headers:{Accept:"text/plain"},onComplete:function(e){r.resolve(e)},onFailure:function(e){r.reject(e)}};return n.authenticatedRequest(t.fcsurl,i),r.promise}})}),define("DS/CAT3DExpLinkContext/CAT3DExpRTVLinkContext",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpLinkContext/CAT3DExpLinkContext","DS/WebappsUtils/WebappsUtils"],function(e,t,r,n){"use strict";return r.extend({getJSONDescription:function(){return{protocol:"RTVContent"}},resolveLinkAsStream:function(e){return new t(function(t,r){var i=new XMLHttpRequest;i.open("GET",n.getWebappsBaseUrl()+e,!0),i.responseType="blob",i.onload=function(){if(200===this.status){var n=e.split(".").pop();n="3dxml"!==n?n:"xmlv43",this.response.format=n,t(this.response)}else r(new Error("status !== 200"))},i.send()})}})}),define("DS/CAT3DExpLinkContext/CAT3DExpLocalStorageLinkContext",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpLinkContext/CAT3DExpLinkContext","UWA/Storage/Adapter/Dom"],function(e,t,r){"use strict";return r.extend({init:function(t){this._parent(),this._dataBaseName=t.databaseName,this._storage=new e.Storage({adapter:"Dom",database:"uwaLocalStorage-"+this._dataBaseName}),this._storage.currentAdapter.options.duration=100},getLinkDescriptionByType:function(t){var r=this._storage.getAll();for(var n in r)if(r.hasOwnProperty(n)&&r[n].type===t)return e.Promise.resolve(n);return e.Promise.fail()},retrieveLinkDescriptions:function(){var t=[],r=this._storage.getAll();for(var n in r)r.hasOwnProperty(n)&&t.push(n);return e.Promise.resolve(t)},pushStream:function(t){var r=e.Promise.deferred(),n=e.Utils.getUUID(),i=this,o=new FileReader;return o.onload=function(){i._storage.set(n,{data:i._arrayBufferToBase64(this.result),format:t.format,type:i._getStreamType(t)}),r.resolve(n)},o.readAsArrayBuffer(t),r.promise},_typeMap:{"application/json":"CXPExperience_Spec","image/jpeg":"CXPPictureResource_Spec"},_getStreamType:function(e){for(var t in this._typeMap)if(e.type===t)return this._typeMap[t]},resolveLinkAsStream:function(t){var r=this._storage.get(t);if(!r)return e.Promise.reject(new Error("Unknown Link"));if(e.is(r.data)){var n=new Blob([this._base64ToArrayBuffer(r.data)],{type:"application/octet-binary"});return n.format=r.format,e.Promise.resolve(n)}return e.Promise.reject(new Error("cannot read that"))},_base64ToArrayBuffer:function(e){for(var t=window.atob(e),r=new Uint8Array(t.length),n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r.buffer},_arrayBufferToBase64:function(e){for(var t="",r=new Uint8Array(e),n=0;n<r.byteLength;n++)t+=String.fromCharCode(r[n]);return window.btoa(t)},getJSONDescription:function(){return{objectType:"CAT3DExpLocalStorage",databaseName:this._dataBaseName}}})}),define("DS/CAT3DExpLinkContext/CAT3DExpFilesLinkContext",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpLinkContext/CAT3DExpLinkContext"],function(e,t,r){"use strict";return r.extend({init:function(e){this._links=[],this._files=e;for(var t=0;t<e.length;t++)this._links.push({StreamName:this._files[t].name})},getLinkDescriptionByType:function(t){var r,n=[];for(r=0;r<this._links.length;r++)this._getLinkType(this._links[r])===t&&n.push(this._links[r]);if(0===n.length)return e.Promise.reject(new Error("Cant retrieve link for type : "+t));if("CXPExperience_Spec"===t&&n.length>1){for(r=0;r<n.length;r++)if("content.json"===n[r].StreamName)return e.Promise.resolve(n[r]);console.warn("Media format issue")}return e.Promise.resolve(n[0])},_typeExtMap:{".json":"CXPExperience_Spec",".cgr":"Model_VPMReference_Spec",".xcgr":"Model_VPMReference_Spec",".3dxml":"Model_VPMReference_Spec",".3dx":"Model_VPMReference_Spec",".3dxc":"Model_VPMReference_Spec",".jpg":"CXPPictureResource_Spec",".bmp":"CXPPictureResource_Spec",".png":"CXPPictureResource_Spec"},_getLinkType:function(e){for(var t in this._typeExtMap)if(e.StreamName.endsWith(t))return this._typeExtMap[t]},retrieveLinkDescriptions:function(){return t.resolve(this._links)},resolveLinkAsStream:function(t){if(t)for(var r=0;r<this._files.length;r++)if(this._files[r].name===t.StreamName)return this._files[r].format=this._getLinkFormat(t),e.Promise.resolve(this._files[r]);return e.Promise.reject(new Error("Unknown Link"))},_formatExtMap:{".cgr":"cgr",".xcgr":"cgr",".3dxml":"xmlv43",".3dx":"3dx",".3dxc":"3dxc"},_getLinkFormat:function(e){for(var t in this._formatExtMap)if(e.StreamName.endsWith(t))return this._formatExtMap[t]},getNameForLinkDescription:function(e){var t=e.StreamName.lastIndexOf(".");return-1!==t?e.StreamName.substr(0,t):e.StreamName}})}),define("DS/CAT3DExpLinkContext/CAT3DExpZipLinkContext",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpLinkContext/CAT3DExpLinkContext","DS/ZipJS/zip"],function(e,t,r,n){"use strict";return r.extend({init:function(e){this._blob=new Blob([e],{type:"application/zip"}),this._blobReader=new n.BlobReader(this._blob),this._links=null,this._entries=null},getLinkDescriptionByType:function(t){var r=this;return this.retrieveLinkDescriptions().then(function(n){var i,o=[];for(i=0;i<n.length;i++)r._getLinkType(n[i])===t&&o.push(n[i]);if(0===o.length)return e.Promise.reject(new Error("Cant retrieve link for type : "+t));if("CXPExperience_Spec"===t&&o.length>1){for(i=0;i<o.length;i++)if("content.json"===o[i].StreamName)return e.Promise.resolve(o[i]);console.warn("Media format issue")}return e.Promise.resolve(o[0])})},_typeExtMap:{".json":"CXPExperience_Spec",".cgr":"Model_VPMReference_Spec",".xcgr":"Model_VPMReference_Spec",".3dx":"Model_VPMReference_Spec",".3dxc":"Model_VPMReference_Spec",".jpg":"CXPPictureResource_Spec",".bmp":"CXPPictureResource_Spec",".png":"CXPPictureResource_Spec"},_getLinkType:function(e){for(var t in this._typeExtMap)if(e.StreamName.endsWith(t))return this._typeExtMap[t]},retrieveLinkDescriptions:function(){if(this._links)return e.Promise.resolve(this._links);if(this._retrieveLinksPromise)return this._retrieveLinksPromise;var t=this;return this._retrieveLinksPromise=this._retrieveEntries().then(function(e){t._links=[];for(var r=0;r<e.length;r++)t._links.push({StreamName:e[r].filename});return t._links}),this._retrieveLinksPromise},_retrieveEntries:function(){if(this._entries)return e.Promise.resolve(this._entries);if(this._retrieveEntriesDeferred)return this._retrieveEntriesDeferred.promise;this._retrieveEntriesDeferred=e.Promise.deferred();var t=this;return n.createReader(this._blobReader,function(e){e.getEntries(function(e){t._entries=e,t._retrieveEntriesDeferred.resolve(t._entries)})}),this._retrieveEntriesDeferred.promise},resolveLinkAsStream:function(t){if(!t)return e.Promise.reject(new Error("Unknown Link"));var r=this;return this._retrieveEntries().then(function(n){for(var i=0;i<n.length;i++)if(n[i].filename===t.StreamName)return r._getBlobFromZippedFile(n[i],t);return e.Promise.reject(new Error("Unknown Link"))})},_getBlobFromZippedFile:function(t,r){var i=e.Promise.deferred(),o=this;return t.getData(new n.BlobWriter,function(e){e.name=t.filename,e.format=o._getLinkFormat(r),i.resolve(e)}),i.promise},_formatExtMap:{".cgr":"cgr",".xcgr":"cgr",".3dxml":"xmlv43",".3dx":"3dx",".3dxc":"3dxc"},_getLinkFormat:function(e){for(var t in this._formatExtMap)if(e.StreamName.endsWith(t))return this._formatExtMap[t]},getNameForLinkDescription:function(e){var t=e.StreamName.lastIndexOf(".");return-1!==t?e.StreamName.substr(0,t):e.StreamName}})}),define("DS/CAT3DExpLinkContext/CAT3DExpPLMDocumentLinkContext",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpLinkContext/CAT3DExpLinkContext","DS/DocumentManagement/DocumentManagement","DS/WAFData/WAFData","DS/CAT3DExpModel/CAT3DXModel"],function(e,t,r,n,i,o){"use strict";return r.extend({init:function(e){this._objectId=e.objectId},getLinkDescriptionByType:function(t){return this.retrieveLinkDescriptions().then(function(r){var n=r[0].split(".").pop();return"ctps"===n&&"CityPresentation"===t?e.Promise.resolve(r[0]):"json"!==n&&"ctxp"!==n||"CIDAsset_Spec"!==t?"exprd"===n&&"ProductPresentation"===t?e.Promise.resolve(r[0]):e.Promise.reject(new Error("Cant retrieve link for type : "+t)):e.Promise.resolve(r[0])})},retrieveLinkDescriptions:function(){return this._links?e.Promise.resolve(this._links):this._retrieveLinksPromise?this._retrieveLinksPromise:(this._retrieveLinksPromise=this._getFilesInfo().then(function(e){return self._links=e.map(function(e){return e.fileName}),self._links}),this._retrieveLinksPromise)},_getFilesInfo:function(){if(this._filesInfo)return e.Promise.resolve(this._filesInfo);if(this._filesInfoPromise)return this._filesInfoPromise;var t,r,i=this;return this._filesInfoPromise=o.getFactory().getPlatformId().then(function(e){return t=e,o.getFactory().getServerURL()}).then(function(o){r=o;var s=e.Promise.deferred();return n.getDocuments([i._objectId],{tenant:t,tenantUrl:r,onComplete:function(e){if(e.data.length<1)s.reject(new Error("Cant Retrieve PLMDocument"));else{var t=e.data[0].relateddata.files;i._filesInfo=[];for(var r=0;r<t.length;r++)i._filesInfo.push({id:t[r].id,fileName:t[r].dataelements.title});s.resolve(i._filesInfo)}},onFailure:function(e){s.reject(new Error(e))}}),s.promise}),this._filesInfoPromise},_getFileId:function(t){return this._getFilesInfo().then(function(r){for(var n=0;n<r.length;n++)if(r[n].fileName===t)return r[n].id;return e.Promise.reject(new Error("Cant Retrieve File : "+t))})},_getFileURL:function(t){var r,i,s=this;return o.getFactory().getPlatformId().then(function(e){return r=e,o.getFactory().getServerURL()}).then(function(o){i=o;var a=e.Promise.deferred();return n.downloadDocument([s._objectId],t,!1,{tenant:r,tenantUrl:i,onComplete:function(e){a.resolve(e)},onFailure:function(e){a.reject(new Error(e))}}),a.promise})},_getFile:function(t){var r=this;return this._getFileId(t).then(function(e){return r._getFileURL(e)}).then(function(t){var r=e.Promise.deferred();return i.authenticatedRequest(t,{method:"GET",type:"json",headers:{"content-type":"application/json"},proxy:"passport",onComplete:function(e){r.resolve(new Blob([JSON.stringify(e)],{type:"text/plain;charset=utf-8"}))},onFailure:function(e){r.reject(new Error(e))}}),r.promise})},resolveLinkAsStream:function(e){return this._getFile(e)},getJSONDescription:function(){return{protocol:"PLMDoc",objectId:this._objectId}},pushStream:function(t){var r,i,s={title:t.name,type:"Document",policy:"Document Release",fileInfo:{file:t}};return o.getFactory().getPlatformId().then(function(e){return r=e,o.getFactory().getServerURL()}).then(function(e){return i=e,o.GetSecurityContext()}).then(function(t){var o=e.Promise.deferred(),a={tenant:r,tenantUrl:i,securityContext:t.role+"."+t.organization+"."+t.space,onComplete:function(){o.resolve()},onFailure:function(e){o.reject(new Error(e))}};return n.createDocument(s,a),o.promise})}})}),define("DS/CAT3DExpLinkContext/CAT3DExpLinkContextFactory",["UWA/Core","UWA/Class/Promise","DS/CAT3DExpModel/CAT3DXModel","DS/CAT3DExpLinkContext/CAT3DExpFilesLinkContext","DS/CAT3DExpLinkContext/CAT3DExpLocalStorageLinkContext","DS/CAT3DExpLinkContext/CAT3DExpRTVLinkContext","DS/CAT3DExpLinkContext/CAT3DExpZipLinkContext","DS/CAT3DExpLinkContext/CAT3DExpPLMDocumentLinkContext"],function(e,t,r,n,i,o,s,a){"use strict";return e.Class.extend({init:function(){this._dataTransferLinkContext=[{constructor:i,description:{objectType:"CAT3DExpLocalStorage"}},{constructor:a,description:{objectType:"Document",serviceId:"3DSpace"}}],this._jsonDescriptionLinkContext=[{constructor:i,description:{objectType:"CAT3DExpLocalStorage"}},{constructor:a,description:{protocol:"PLMDoc"}}]},registerLinkContextForDatatransfer:function(e,t){this._dataTransferLinkContext.push({constructor:e,description:t})},getLinkContextFromDataTransfer:function(e){if(e.files.length>0)return 1===e.files.length&&(e.files[0].name.endsWith(".3dx")||e.files[0].name.endsWith(".dsxm"))?new s(e.files[0]):new n(e.files);try{for(var t=JSON.parse(e.getData("text/plain")).data.items[0],r=0;r<this._dataTransferLinkContext.length;r++)if(this._isObjectMatchDescription(t,this._dataTransferLinkContext[r].description))return new this._dataTransferLinkContext[r].constructor(t);return void console.error("cannot retrieve link context")}catch(e){return void console.error("cannot compute link context : error parsing data")}},_isObjectMatchDescription:function(e,t){for(var r in t)if(e[r]!==t[r])return!1;return!0},registerLinkContextForJSONDescription:function(e,t){this._jsonDescriptionLinkContext.push({constructor:e,description:t})},getLinkContextFromJSONDescription:function(e){for(var t=0;t<this._jsonDescriptionLinkContext.length;t++)if(this._isObjectMatchDescription(e,this._jsonDescriptionLinkContext[t].description))return new this._jsonDescriptionLinkContext[t].constructor(e)}})});