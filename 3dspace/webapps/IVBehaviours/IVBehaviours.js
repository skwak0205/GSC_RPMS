define("DS/IVBehaviours/IVBehaviours",["UWA/Core","DS/CoreEvents/Events"],function(e,t){"use strict";return e.Class.extend({init:function(e){this._odt=!!e||!1,this._viewer=null,this._actionList=[],this._controllerConnectionEvent=null,this._activated=!1,this._behaviourType="empty",this.PRIMARYCTR=1,this.SECONDARYCTR=0,this.triggerIdx=0,this.gripIdx=1,this.thumbpadIdx=2},isActivated:function(){return this._activated},activate:function(e){this._viewer=e.getViewer();var i=this;this._activated=!0,this._controllerConnectionEvent=t.subscribe({event:"/VR/onControllerConnect"},function(t){t&&-1===t.findBehaviourIndex(i)&&(t._behaviourList.push(i),i._bindController(e,t))}),this._HMDDeactivateEvent=t.subscribe({event:"/VR/preHMDDeactivate"},function(){var t=e.getControllers();for(var o in i._actionList){var n=i._actionList[o];t[n.controllerIndex].removeControllerAction(n)}for(var a in i._actionList=[],t)t[a].unbindBehaviour(i)})},_bindController:function(e,t){t.index===this.PRIMARYCTR&&this._bindPrimaryController?this._bindPrimaryController(e,t):t.index===this.SECONDARYCTR&&this._bindSecondaryController&&this._bindSecondaryController(e,t)},deactivate:function(e){this._preDeactivate&&this._preDeactivate(e),behaviour._activated=!1,t.unsubscribe(behaviour._controllerConnectionEvent);var i=e.getControllers();for(var o in this._actionList){var n=this._actionList[o];i[n.controllerIndex].removeControllerAction(n)}for(var a in this._actionList=[],i)i[a].unbindBehaviour(this);t.unsubscribe(this._HMDDeactivateEvent),t.unsubscribe(this._controllerConnectionEvent)}})}),define("DS/IVBehaviours/PanelBehaviour",["DS/Visualization/Node3D","DS/IVBehaviours/IVBehaviours","WebIVHTML2Canvas/html2canvas","DS/ApplicationFrame/FrameWindow3D","DS/Controls/Button","DS/Visualization/ThreeJS_DS","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils"],function(e,t,i,o,n,a,r,s,l){"use strict";return t.extend({init:function(e){this._parent(),this._mainController=null,this._secondaryController=null,this._panelNode=null,this._visibilityPanel=!1,this._visibilityLaser=!1,this._behaviourType="Panel",this._panelHtml=null,this._panelSize=null,this._prevEl=null,this.tablet=null,this._manager=e,this._lineNode=null},createWindow:function(){this._panelHtml=document.getElementsByClassName("wux-afr-actionbar")[0],this.makeCanva()},makeCanva:function(){var t=this;i(t._panelHtml).then(function(i){i.getContext("2d");var o=new a.Texture(i);o.flipY=!1,o.needsUpdate=!0,(c=new a.MeshBasicMaterial({color:16777215,shading:a.FlatShading,map:o,side:a.FrontSide,transparent:!0})).force=!0;var n=(new r).createRectangle({width:10*i.width,height:10*i.height,fill:!0,color:new l.Color(0,0,0,1)});t._tablet=s.createMeshNode(n,c);var c=new a.Matrix4,d=new a.Vector3(50,120,10*-i.height),h=new a.Quaternion,u=new a.Vector3(1,0,0);h.setFromAxisAngle(u,2);var p=new a.Quaternion,_=new a.Vector3(0,1,0);p.setFromAxisAngle(_,-Math.PI/2);(new a.Quaternion).multiplyQuaternions(h,p);var v=new a.Vector3(1,1,1);c.compose(d,h,v),t._tablet.setMatrix(c),t._panelNode=new e,t._secondaryController.getNode().addChild(t._panelNode),t._panelNode.addChild(t._tablet),t._panelNode.setVisibility(t._visibilityPanel),t._panelNode.exludeFromBounding(!0),t._panelNode.getChildren()[0].intersectable=!1,t._panelNode.getChildren()[0].mesh3js.name="panel",t._lineNode=t.createLine(),t._panelSize=t._panelHtml.children[0].getBoundingClientRect()})},updateCanvas:function(){var e=this;i(e._panelHtml).then(function(t){var i=new a.Texture(t);i.flipY=!1,i.needsUpdate=!0;var o=new a.MeshBasicMaterial({color:16777215,shading:a.FlatShading,map:i,side:a.FrontSide,transparent:!0});o.force=!0,e._tablet.setMaterial(o),e._viewer.render()})},_dispatchMouseEvent:function(e,t,i,o){o||(o={}),o=Object.assign(o,{bubbles:!0,view:window,cancelable:!0});let n={left:0,top:0};if(e.getBoundingClientRect?n=e.getBoundingClientRect():e.getContent&&e.getContent()&&e.getContent().getBoundingClientRect&&(n=e.getContent().getBoundingClientRect()),(o.moveX||o.moveY)&&(o.clientX=o.moveX+n.left,o.clientY=o.moveY+n.top),o.clientX||o.screenX||(o.clientX=n.left),o.clientY||o.screenY||(o.clientY=n.top),(o.clientX||o.clientY)&&(o.clientX=o.clientX?o.clientX:0,o.clientY=o.clientY?o.clientY:0,o.screenX=o.clientX*window.devicePixelRatio,o.screenY=o.clientY*window.devicePixelRatio,o.offsetX=o.clientX-n.left,o.offsetY=o.clientY-n.top),"object"==typeof i)for(var a=Object.keys(i),r=0;r<a.length;r++)o[a[r]]=i[a[r]];var s=new MouseEvent(t,o);return s.isSimulated=!0,"click"===t&&o.touchFlag&&(s.touchFlag=!0),e.dispatchEvent(s),s},getParentButton:function(e){var t=e;if(null!==t){for(;-1==t.className.toString().search("Sections")&&-1==t.className.toString().search("Content")&&-1==(t=t.parentNode).className.toString().search("wux-controls-button"););-1==t.className.toString().search("Sections")&&-1==t.className.toString().search("Content")&&(this._prevEl&&this._prevEl,this._prevEl=t)}},laserOnCanva:function(e){if(this._visibilityPanel){var t=this._mainController.picking3d({type:"line",viewer:this._viewer,intersectFloor:!1}),i=this._lineNode.getBuffer(l.VertexComponentEnum.POSITION);if(null!==t&&(i[5]=-t.distance),this._lineNode.updateBuffer(l.VertexComponentEnum.POSITION,0,2),t.object){var o=this._panelNode.getChildren()[0].getMatrixWorld().decompose(),n=o[0],r=o[1],s=new a.Vector3(1,0,0).applyQuaternion(r),c=new a.Vector3(0,1,0).applyQuaternion(r),d=(new a.Vector3).subVectors(t.point,n).dot(s),h=(new a.Vector3).subVectors(t.point,n).dot(c);h=Math.abs(h),d/=10,h/=10,d+=this._panelSize.x,h+=this._panelSize.y;var u=document.elementFromPoint(d,h);if(!u)return;this.currentElement=u}}},clickOnCanva:function(){if(this._visibilityPanel){var e=this.currentElement;e&&(e.click(),this._dispatchMouseEvent(e,"mousedown"),this._dispatchMouseEvent(e,"mouseup"),this.updateCanvas())}},showLaser:function(e){this._visibilityPanel&&(this._visibilityLaser=0!=e,this._mainController.getNode().getChildByName("canvaLine")&&this._mainController.getNode().getChildByName("canvaLine").setVisibility(this._visibilityLaser))},_setController:function(e,t){t!=this.PRIMARYCTR?this._secondaryController=e:this._mainController=e},showPanel:function(){this._visibilityPanel=!this._visibilityPanel,this._panelNode.getChildren()[0].intersectable=this._visibilityPanel,this._panelNode.setVisibility(this._visibilityPanel)},createLine:function(){var e=[];e.push(new a.Vector3(0,0,0)),e.push(new a.Vector3(0,0,-5e3));var t=new a.LineBasicMaterial({color:6943292,force:!0}),i=s.createLineNode({points:e,material:t,editable:!0,drawMode:l.ConnectivityTypeEnum.LINES});return i.intersectable=!1,i.setName("canvaLine"),i.setVisibility(!1),i.exludeFromBounding(!0),this._mainController._node.addChild(i),i},muteSelection:function(e){this._manager.changeStateOfBehaviour("Selection",!this._visibilityPanel),this._visibilityPanel||(this._visibilityLaser=!1,this._lineNode.setVisibility(!1))},_bindController:function(e,t){if(this._setController(t,t.index),this._mainController&&this._secondaryController){var i=this;this.createWindow();var o=this._secondaryController.addControllerAction({type:"pressed",buttonIdx:i.thumbpadIdx,controllerType:i.SECONDARYCTR,onDeactivate:function(){i.showPanel(),i.muteSelection()}}),n=this._mainController.addControllerAction({type:"pressed",buttonIdx:i.triggerIdx,controllerType:i.PRIMARYCTR,onDeactivate:function(){i.clickOnCanva()}}),a=this._mainController.addControllerAction({type:"axis",buttonIdx:i.triggerIdx,triggerIdx:!0,controllerType:i.PRIMARYCTR,onFrameUpdate:function(e){i.showLaser(e),i.laserOnCanva(e)}});this._activated=!0,this._actionList.push(o),this._actionList.push(n),this._actionList.push(a)}}})}),define("DS/IVBehaviours/TeleportAndRotationBehaviour",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/IVBehaviours/IVBehaviours","DS/WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper"],function(e,t,i,o,n,a,r,s,l){"use strict";return r.extend({init:function(e){this._parent(e),this._viewer=null,this._actionList=[],this._controllerConnectionEvent=null,this._behaviourType="TeleportAndRotation",this.odt=!!e,this._directRotation=!1,this._curIntersection=null,this._teleportInactiveUINode=null,this._teleportActiveUINode=null,this._rotateLUINode=null,this._rotateRUINode=null},teleport:function(e){if(null!==this._curIntersection&&this._curIntersection.valid){var i=this._curIntersection.point,o=e.getUser().head;if(!o)return;var n=e.getPosition().z,a=o.getVirtualGlobalMatrix().decompose(),r=new t.Vector3(i.x-a[0].x,i.y-a[0].y,i.z-n);e.translate(r)}},createLine:function(e){var i=[];i.push(new t.Vector3(0,0,0)),i.push(new t.Vector3(0,0,-5e3));var a=new t.LineBasicMaterial({color:8961493,force:!0}),r=o.createLineNode({points:i,material:a,editable:!0,drawMode:n.ConnectivityTypeEnum.LINES});return r.intersectable=!1,r.setName("teleportLine2"),r.setVisibility(!1),r.exludeFromBounding(!0),e.addChild(r),r},update:function(e){var t=e.controller,i=t.getNode().getMatrix().decompose()[2].x,o=t.getNode().getChildByName("teleportLine2");if(o.isVisible()){this._curIntersection=t.picking3d({type:"line",intersectFloor:!0,viewer:this._viewer});var a=o.getBuffer(n.VertexComponentEnum.POSITION);null!==this._curIntersection&&this._curIntersection.valid||(a[5]=-this._curIntersection.distance/i||-5e3/i),o.updateBuffer(n.VertexComponentEnum.POSITION,0,2)}else this._curIntersection=null},_bindPrimaryController:function(e,t){var i,o=e.getContext(),n=(e._vrNode,this.createLine(t.getNode())),a=this,r=t.addControllerAction({type:"axis",axesIdx:[1],onFrameUpdate:function(e){a._touchpadActivated?(n.setVisibility(!0),null!==a._teleportActiveUINode&&null!==a._teleportInactiveUINode&&(a._teleportInactiveUINode.setVisibility(!1),a._teleportActiveUINode.setVisibility(!0))):(n.setVisibility(!1),null!==a._teleportActiveUINode&&null!==a._teleportInactiveUINode&&(a._teleportActiveUINode.setVisibility(!1),a._teleportInactiveUINode.setVisibility(!0)))}}),s=t.addControllerAction({type:"touched",buttonIdx:a.thumbpadIdx,onDeactivate:function(){a._touchpadActivated=!1},onActivate:function(){a._touchpadActivated=!0}}),l=t.addControllerAction({type:"pressed",buttonIdx:a.thumbpadIdx,onDeactivate:function(){a.teleport(o)}}),c=t.addControllerAction({onFrameUpdate:(i=t,function(){a.update({controller:i})})});this._createTeleportUINode(t),this._activated=!0,this._actionList.push(s),this._actionList.push(l),this._actionList.push(c),this._actionList.push(r)},_bindSecondaryController:function(e,i){var o=this,n=i.addControllerAction({type:"axis",axesIdx:[0],onFrameUpdate:function(e){e[0]<.5?o._directRotation=!0:o._directRotation=!1}});this._actionList.push(n);var a=i.addControllerAction({type:"pressed",buttonIdx:o.thumbpadIdx,onActivate:function(){var i=new t.Quaternion,n=new t.Vector3(0,1,0),a=e.getContext();o._directRotation?i.setFromAxisAngle(n,Math.PI/16):i.setFromAxisAngle(n,-Math.PI/16),a.multiplyQuaternion(i)},onDeactivate:function(){}});this._createRotateUINode(i),this._actionList.push(a)},_createTeleportUINode:function(e){var i=new l,a=s.getWebappsAssetUrl("IVBehaviours","Teleport.png"),r=new t.MeshBasicMaterial({map:t.ImageUtils.loadTexture(a),side:t.DoubleSide,transparent:!0,force:!0});r.force=!0;var c=i.createRectangle({width:30,height:30,fill:!0,color:new n.Color(0,0,0,1)});this._teleportActiveUINode=o.createMeshNode(c,r),(u=e.getTouchPadPose()).elements[12]-=15,u.elements[14]+=15,this._teleportActiveUINode.setMatrix(u),this._teleportActiveUINode.setVisibility(!1),e.getNode().addChild(this._teleportActiveUINode);var d=s.getWebappsAssetUrl("IVBehaviours","TeleportInactive.png"),h=new t.MeshBasicMaterial({map:t.ImageUtils.loadTexture(d),side:t.DoubleSide,transparent:!0,force:!0});h.force=!0;var u,p=i.createRectangle({width:30,height:30,fill:!0,color:new n.Color(0,0,0,1)});this._teleportInactiveUINode=o.createMeshNode(p,h),(u=e.getTouchPadPose()).elements[12]-=15,u.elements[14]+=15,this._teleportInactiveUINode.setMatrix(u),this._teleportInactiveUINode.setVisibility(!0),e.getNode().addChild(this._teleportInactiveUINode)},_createRotateUINode:function(e){var i=new l,a=s.getWebappsAssetUrl("IVBehaviours","RotateLeft.png"),r=new t.MeshBasicMaterial({map:t.ImageUtils.loadTexture(a),side:t.DoubleSide,transparent:!0,force:!0});r.force=!0;var c=i.createRectangle({width:20,height:20,fill:!0,color:new n.Color(0,0,0,1)});this._rotateLUINode=o.createMeshNode(c,r);var d=e.getTouchPadPose();d.elements[12]-=20,d.elements[14]+=10,this._rotateLUINode.setMatrix(d),e.getNode().addChild(this._rotateLUINode);var h=s.getWebappsAssetUrl("IVBehaviours","RotateRight.png"),u=new t.MeshBasicMaterial({map:t.ImageUtils.loadTexture(h),side:t.DoubleSide,transparent:!0,force:!0});u.force=!0;var p=i.createRectangle({width:20,height:20,fill:!0,color:new n.Color(0,0,0,1)});this._rotateRUINode=o.createMeshNode(p,u);var _=e.getTouchPadPose();_.elements[14]+=10,this._rotateRUINode.setMatrix(_),e.getNode().addChild(this._rotateRUINode)},_preDeactivate:function(e,t){this._teleportInactiveUINode.parentNode&&this._teleportInactiveUINode.parentNode.removeChild(this._teleportInactiveUINode),this._teleportActiveUINode.parentNode&&this._teleportActiveUINode.parentNode.removeChild(this._teleportActiveUINode),this._rotateLUINode.parentNode&&this._rotateLUINode.parentNode.removeChild(this._rotateLUINode),this._rotateRUINode.parentNode&&this._rotateRUINode.parentNode.removeChild(this._rotateRUINode),this._teleportInactiveUINode=null,this._teleportActiveUINode=null,this._rotateLUINode=null,this._rotateRUINode=null}})}),define("DS/IVBehaviours/AirGrabBehaviour",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/Visualization/PathElement","DS/IVBehaviours/IVBehaviours","DS/WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper"],function(e,t,i,o,n,a,r,s,l,c,d){"use strict";return l.extend({init:function(e){this._parent(e),this._controllerConnectionEvent=null,this._leftActivationTime=null,this._rightActivationTime=null,this._initHandLPose=null,this._initHandRPose=null,this._initCtxPose=null,this._oneHandNavigation=!1,this._twoHandsNavigation=!1,this._oneHandRotatingMode=!1,this._prevHeadToHandVec=null,this._UINodes={}},leftActivateNavigation:function(e){if(null!==this._leftActivationTime){if(this._oneHandNavigation||this._twoHandsNavigation)this._oneHandNavigation?(e.initHandPose=this._initHandLPose,e.hand="left",this.oneHandNavigate(e)):this._twoHandsNavigation&&this.twoHandsNavigate(e);else if(this._initCtxPose=e.context.getMatrix(),null!==this._rightActivationTime){var i=e.context.getUser().leftHand.getPhysicalLocalMatrix(),o=e.context.getUser().rightHand.getPhysicalLocalMatrix();this._initHandLPose=i,this._initHandRPose=o,this._twoHandsNavigation=!0}else if(Date.now()-this._leftActivationTime>100){var n=e.context.getUser().leftHand.getPhysicalLocalMatrix();this._initHandLPose=n;var a=this._initHandLPose.decompose()[0],r=e.context.getUser().head.getPhysicalLocalMatrix().decompose()[0];this._prevHeadToHandVec=(new t.Vector3).subVectors(a,r),this._prevHeadToHandVec.y=0,this._prevHeadToHandVec.normalize(),this._oneHandNavigation=!0}}else null===this._rightActivationTime&&(this._oneHandNavigation=!1,this._initHandRPose=null,this._oneHandRotatingMode=!1),this._twoHandsNavigation=!1,"airGrabCylinder"in this._UINodes&&this._UINodes.airGrabCylinder.setVisibility(!1),this._initHandLPose=null,this._initHeadPose=null},rightActivateNavigation:function(e){if(null!==this._rightActivationTime){if(this._oneHandNavigation||this._twoHandsNavigation)this._oneHandNavigation&&(e.initHandPose=this._initHandRPose,e.hand="right",this.oneHandNavigate(e));else if(this._initCtxPose=e.context.getMatrix(),null!==this._leftActivationTime){var i=e.context.getUser().leftHand.getPhysicalLocalMatrix(),o=e.context.getUser().rightHand.getPhysicalLocalMatrix();this._initHandLPose=i,this._initHandRPose=o,this._twoHandsNavigation=!0}else if(Date.now()-this._rightActivationTime>100){var n=e.context.getUser().rightHand.getPhysicalLocalMatrix();this._initHandRPose=n;var a=this._initHandRPose.decompose()[0],r=e.context.getUser().head.getPhysicalLocalMatrix().decompose()[0];this._prevHeadToHandVec=(new t.Vector3).subVectors(a,r),this._prevHeadToHandVec.y=0,this._prevHeadToHandVec.normalize(),this._oneHandNavigation=!0}}else null===this._leftActivationTime&&(this._oneHandNavigation=!1,this._oneHandRotatingMode=!1,this._initHandLPose=null),this._twoHandsNavigation=!1,"airGrabCylinder"in this._UINodes&&this._UINodes.airGrabCylinder.setVisibility(!1),this._initHandRPose=null,this._initHeadPose=null},oneHandNavigate:function(e){if(e.initHandPose){var i,o=e.initHandPose.decompose();"left"===e.hand?i=e.context.getUser().leftHand.getPhysicalLocalMatrix().decompose():"right"===e.hand&&(i=e.context.getUser().rightHand.getPhysicalLocalMatrix().decompose());var n=i[0],a=(new t.Vector3).subVectors(n,o[0]),r=this._initCtxPose.decompose()[0];a.applyQuaternion(this._initCtxPose.decompose()[1]);var s=(new t.Vector3).subVectors(r,a),l=e.context.getUser().head.getPhysicalLocalMatrix().decompose()[0],c=(new t.Vector3).subVectors(n,l);c.y=0,c.normalize();var d=this._prevHeadToHandVec.angleTo(c);if(!this._oneHandRotatingMode&&Math.abs(d)>.08)this._oneHandRotatingMode=!0;else if(this._oneHandRotatingMode){var h=this._initCtxPose.decompose()[1],u=(new t.Vector3).crossVectors(this._prevHeadToHandVec,c);u.normalize(),u.applyQuaternion(h);var p=(new t.Quaternion).setFromAxisAngle(u,d);p.multiply(h),e.context.setOrientation(p)}else this._prevHeadToHandVec=c;e.context.setPosition(s)}},twoHandsNavigate:function(e){var i=this._initHandLPose.decompose()[0],o=this._initHandRPose.decompose()[0],n=(new t.Vector3).addVectors(i,o);n.multiplyScalar(.5);var a=e.context.getUser().leftHand.getPhysicalLocalMatrix().decompose()[0],r=e.context.getUser().rightHand.getPhysicalLocalMatrix().decompose()[0],s=(new t.Vector3).addVectors(a,r);s.multiplyScalar(.5);var l=(new t.Vector3).subVectors(s,n);l.applyQuaternion(this._initCtxPose.decompose()[1]);var c=this._initCtxPose.decompose()[0],d=(new t.Vector3).subVectors(c,l),h=(new t.Vector3).subVectors(r,a);h.y=0;var u=(new t.Vector3).subVectors(o,i);u.y=0;var p=(new t.Vector3).crossVectors(u,h);p.applyQuaternion(this._initCtxPose.decompose()[1]),p.normalize();var _=-u.angleTo(h),v=(new t.Quaternion).setFromAxisAngle(p,_),g=this._initCtxPose.decompose()[1];v.multiply(g),e.context.setOrientation(v),e.context.setPosition(d);var m=this._initCtxPose.decompose()[2].x*(i.distanceTo(o)/a.distanceTo(r));e.context.setScale(m);var N=e.context.getUser().leftHand.getVirtualGlobalMatrix(),b=e.context.getUser().rightHand.getVirtualGlobalMatrix(),f=new t.Vector3(25,-8,80).applyMatrix4(N),I=new t.Vector3(-25,-8,80).applyMatrix4(b);this._updateCylinderNode(I,f)},_bindPrimaryController:function(e,t){var i,o=this,n=t.addControllerAction({onFrameUpdate:(i=t,function(){o.rightActivateNavigation({controller:i,context:e.getContext()})})});this._actionList.push(n);var a=t.addControllerAction({type:"pressed",buttonIdx:o.gripIdx,onActivate:function(){o._rightActivationTime=Date.now(),o._UINodes.primLabelLine.setVisibility(!1),o._UINodes.primAirGrab.setVisibility(!1),o._UINodes.primRotScale.setVisibility(!1),null!==o._leftActivationTime?(o._UINodes.secLabelLine.setVisibility(!1),o._UINodes.secAirGrab.setVisibility(!1),o._UINodes.secRotScale.setVisibility(!1)):(o._UINodes.secAirGrab.setVisibility(!1),o._UINodes.secRotScale.setVisibility(!0))},onDeactivate:function(){o._rightActivationTime=null,o._UINodes.primLabelLine.setVisibility(!0),null!==o._leftActivationTime?(o._UINodes.primAirGrab.setVisibility(!1),o._UINodes.primRotScale.setVisibility(!0)):(o._UINodes.primAirGrab.setVisibility(!0),o._UINodes.primRotScale.setVisibility(!1),o._UINodes.secAirGrab.setVisibility(!0),o._UINodes.secRotScale.setVisibility(!1))}});this._actionList.push(a);t.addControllerAction({type:"pressed",buttonIdx:o.thumbpadIdx,onActivate:function(){null!==o._rightActivationTime&&e.getContext().setScale(1)}});this._createPrimLabelNode(t)},_bindSecondaryController:function(e,t){var i,o=this,n=t.addControllerAction({onFrameUpdate:(i=t,function(){o.leftActivateNavigation({controller:i,context:e.getContext()})})});this._actionList.push(n);var a=t.addControllerAction({type:"pressed",buttonIdx:o.gripIdx,onActivate:function(){o._leftActivationTime=Date.now(),o._UINodes.secLabelLine.setVisibility(!1),o._UINodes.secAirGrab.setVisibility(!1),o._UINodes.secRotScale.setVisibility(!1),null!==o._rightActivationTime?(o._UINodes.primLabelLine.setVisibility(!1),o._UINodes.primAirGrab.setVisibility(!1),o._UINodes.primRotScale.setVisibility(!1)):(o._UINodes.primAirGrab.setVisibility(!1),o._UINodes.primRotScale.setVisibility(!0))},onDeactivate:function(){o._leftActivationTime=null,o._UINodes.secLabelLine.setVisibility(!0),null!==o._rightActivationTime?(o._UINodes.secAirGrab.setVisibility(!1),o._UINodes.secRotScale.setVisibility(!0)):(o._UINodes.secAirGrab.setVisibility(!0),o._UINodes.secRotScale.setVisibility(!1),o._UINodes.primAirGrab.setVisibility(!0),o._UINodes.primRotScale.setVisibility(!1))}});this._actionList.push(a),this._createSecLabelNode(t)},_createPrimLabelNode:function(e){if(!("primAirGrab"in this._UINodes||"primRotScale"in this._UINodes||"primLabelLine"in this._UINodes)){var i=new d,a=new t.LineBasicMaterial({color:8961493,force:!0}),r=[],s=e.getLeftGripPose().decompose()[0];r.push(s);var l=e.getLeftGripTooltipPose().decompose()[0];l.x-=45,l.z-=10,r.push(l),this._UINodes.primLabelLine=o.createLineNode({points:r,material:a,editable:!0,drawMode:n.ConnectivityTypeEnum.LINES}),e.getNode().addChild(this._UINodes.primLabelLine),this._UINodes.primLabelLine.intersectable=!1;var h=c.getWebappsAssetUrl("IVBehaviours","AirGrab.png"),u=new t.MeshBasicMaterial({map:t.ImageUtils.loadTexture(h),side:t.DoubleSide,transparent:!0,force:!0});u.force=!0;var p=i.createRectangle({width:47.5,height:20,fill:!0,color:new n.Color(0,0,0,1)});this._UINodes.primAirGrab=o.createMeshNode(p,u),(g=e.getLeftGripTooltipPose()).elements[12]-=92.5,this._UINodes.primAirGrab.setMatrix(g),e.getNode().addChild(this._UINodes.primAirGrab);var _=c.getWebappsAssetUrl("IVBehaviours","RotateScale.png"),v=new t.MeshBasicMaterial({map:t.ImageUtils.loadTexture(_),side:t.DoubleSide,transparent:!0,force:!0});v.force=!0;var g,m=i.createRectangle({width:69,height:20,fill:!0,color:new n.Color(0,0,0,1)});this._UINodes.primRotScale=o.createMeshNode(m,v),(g=e.getLeftGripTooltipPose()).elements[12]-=114,this._UINodes.primRotScale.setMatrix(g),this._UINodes.primRotScale.setVisibility(!1),e.getNode().addChild(this._UINodes.primRotScale)}},_createSecLabelNode:function(e){if(!(this._UINodes.secLabelLine||this._UINodes.secRotScale||this._UINodes.secAirGrab)){var i=new d,a=new t.LineBasicMaterial({color:8961493,force:!0}),r=[],s=e.getRightGripPose().decompose()[0];r.push(s);var l=e.getRightGripTooltipPose().decompose()[0];l.z-=10,r.push(l),this._UINodes.secLabelLine=o.createLineNode({points:r,material:a,editable:!0,drawMode:n.ConnectivityTypeEnum.LINES}),e.getNode().addChild(this._UINodes.secLabelLine),this._UINodes.secLabelLine.intersectable=!1;var h=c.getWebappsAssetUrl("IVBehaviours","AirGrab.png"),u=new t.MeshBasicMaterial({map:t.ImageUtils.loadTexture(h),side:t.DoubleSide,transparent:!0,force:!0});u.force=!0;var p=i.createRectangle({width:47.5,height:20,fill:!0,color:new n.Color(0,0,0,1)});this._UINodes.secAirGrab=o.createMeshNode(p,u);var _=e.getRightGripTooltipPose();this._UINodes.secAirGrab.setMatrix(_),e.getNode().addChild(this._UINodes.secAirGrab);var v=c.getWebappsAssetUrl("IVBehaviours","RotateScale.png"),g=new t.MeshBasicMaterial({map:t.ImageUtils.loadTexture(v),side:t.DoubleSide,transparent:!0,force:!0});g.force=!0;var m=i.createRectangle({width:69,height:20,fill:!0,color:new n.Color(0,0,0,1)});this._UINodes.secRotScale=o.createMeshNode(m,g);_=e.getRightGripTooltipPose();this._UINodes.secRotScale.setMatrix(_),this._UINodes.secRotScale.setVisibility(!1),e.getNode().addChild(this._UINodes.secRotScale)}},_createCylinderNode:function(e,i){var a=new t.LineBasicMaterial({color:8961493,force:!0,lineWidth:4}),r=[];r.push(e,i),this._UINodes.airGrabCylinder=o.createLineNode({points:r,material:a,editable:!0,drawMode:n.ConnectivityTypeEnum.LINES}),this._UINodes.airGrabCylinder.exludeFromBounding(!0),this._viewer.addNode(this._UINodes.airGrabCylinder)},_updateCylinderNode:function(e,t){if("airGrabCylinder"in this._UINodes){this._UINodes.airGrabCylinder.isVisible()||this._UINodes.airGrabCylinder.setVisibility(!0);var i=this._UINodes.airGrabCylinder.getBuffer(n.VertexComponentEnum.POSITION);i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=t.x,i[4]=t.y,i[5]=t.z,this._UINodes.airGrabCylinder.updateBuffer(n.VertexComponentEnum.POSITION,0,2)}else this._createCylinderNode(e,t)},_preDeactivate:function(e,t){for(var i of this._UINodes)i.parentNode&&i.parentNode.removeChild(i)}})}),define("DS/IVBehaviours/SelectionBehaviour",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/Visualization/PathElement","DS/IVBehaviours/IVBehaviours"],function(e,t,i,o,n,a,r,s,l){"use strict";return l.extend({init:function(e){this._parent(e.odt),this._viewer=null,this._pickedObject=null,this._HLPathElem=null,this._controllerConnectionEvent=null,this._lineNode=null,this._sphereNode=null,this._behaviourType="Selection",e&&(this._granularity=e.granularity||"prim",this._odt=!!e.odt||!1)},deactivate:function(e,t){t._activated=!1,n.unsubscribe(t._controllerConnectionEvent);var i=e.getControllers();for(var o in t._actionList){var a=t._actionList[o];i[a.controllerIndex].removeControllerAction(a)}for(var r in t._actionList=[],i)i[r].unbindBehaviour(t);this._lineNode&&this._lineNode.setVisibility(!1)},selectObject:function(){if(a._items)for(;a._items.length>0;)a.remove(a._items[0]);if(r._items)for(;r._items.length>0;)r.remove(r._items[0]);if(null!==this._pickedObject&&this._pickedObject.pathElement){var e={pathElement:this._pickedObject.pathElement};a.isIn(e)&&r.isIn(e)||(a.isIn(e)||a.add(e),r.isIn(e)||r.add(e))}},createLine:function(e){if(null===e.getChildByName("selectionLine")){var n=[];n.push(new t.Vector3(0,0,0)),n.push(new t.Vector3(0,0,-5e3));var a=new t.LineBasicMaterial({color:8961493,force:!0}),r=i.createLineNode({points:n,material:a,editable:!0,drawMode:o.ConnectivityTypeEnum.LINES});return r.intersectable=!1,r.setName("selectionLine"),r.setVisibility(!1),r.exludeFromBounding(!0),this._sphereNode=i.createSphereNode({radius:20,material:a}),this._sphereNode.intersectable=!1,this._sphereNode.setName("selectionSphere"),this._sphereNode.setVisibility(!1),this._sphereNode.exludeFromBounding(!0),e.addChild(this._sphereNode),e.addChild(r),r}},update:function(e){var i=e.controller;if(this._lineNode&&this._lineNode.isVisible()){var n=i.picking3d({type:"line",viewer:this._viewer}),a=this._lineNode.getBuffer(o.VertexComponentEnum.POSITION);if(null!==n){var r=i.getNode().getMatrix().decompose()[2].x;a[5]=-n.distance/r,this._pickedObject=n;var s=(new t.Matrix4).makeTranslation(0,0,-n.distance/r);this._sphereNode.setMatrix(s),this._pickedObject&&this._pickedObject.pathElement?this._sphereNode.setVisibility(!0):this._sphereNode.setVisibility(!1)}else this._sphereNode.setVisibility(!1);this._lineNode.updateBuffer(o.VertexComponentEnum.POSITION,0,2)}else this._sphereNode.setVisibility(!1)},_bindPrimaryController:function(e,t){t.getNode().getChildByName("selectionLine")!==this._lineNode&&(this._lineNode=null),this._lineNode||(this._lineNode=this.createLine(t.getNode()));var i,o=this,n=t.addControllerAction({type:"pressed",buttonIdx:o.triggerIdx,onDeactivate:function(){o.selectObject()}}),a=t.addControllerAction({type:"touched",buttonIdx:o.triggerIdx,onActivate:function(){o._lineNode&&o._lineNode.setVisibility(!0)},onDeactivate:function(){o._lineNode&&o._lineNode.setVisibility(!1)}}),r=t.addControllerAction({onFrameUpdate:(i=t,function(){o.update({controller:i})})});o._activated=!0,this._actionList.push(n),this._actionList.push(a),this._actionList.push(r)}})}),define("DS/IVBehaviours/FlyWalkBehaviour",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/IVBehaviours/IVBehaviours"],function(e,t,i){"use strict";return i.extend({init:function(e){this._parent(e),this._flyAngle=!1,this._flyActivated=!1,this._walkActivated=!1},_bindPrimaryController:function(e,t){var i,o=this,n=t.addControllerAction({type:"touched",buttonIdx:o.triggerIdx,onActivate:function(){o._flyAngle?o._flyActivated=!0:o._walkActivated=!0},onDeactivate:function(){o._flyActivated=!1,o._walkActivated=!1}}),a=t.addControllerAction({onFrameUpdate:(i=t,function(){o.update(i,e.getContext())})});this._actionList.push(a),this._actionList.push(n)},update:function(e,i){var o=e.getNode().getMatrix().decompose()[1],n=new t.Vector3(0,0,-1);n.applyQuaternion(o);var a=(new t.Vector3).copy(n);a.z=0,a.normalize();var r=a.angleTo(n);r<0&&(r+=2*Math.PI),r>2*Math.PI/9?this._flyAngle=!0:this._flyAngle=!1,this._flyActivated?(n.multiplyScalar(5),i.translate(n)):this._walkActivated&&(a.multiplyScalar(5),i.translate(a))}})}),define("DS/IVBehaviours/TeleportBehaviour",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/IVBehaviours/IVBehaviours"],function(e,t,i,o,n,a,r){"use strict";return r.extend({init:function(e){this._parent(e),this._viewer=null,this._actionList=[],this._controllerConnectionEvent=null,this._behaviourType="Teleport",this.odt=!!e},teleport:function(e,i){if(null!==e.intersection&&e.intersection.valid){var o=e.intersection.point,n=i.getUser().head;if(!n)return;var a=i.getPosition().z,r=e.matrix.decompose(),s=new t.Vector3(1,0,0).applyQuaternion(r[1]),l=n.getVirtualGlobalMatrix().decompose(),c=new t.Vector3(1,0,0).applyQuaternion(l[1]),d=c.x*s.x+c.y*s.y,h=c.x*s.y-c.y*s.x,u=Math.atan2(d,h),p=(new t.Quaternion).setFromAxisAngle(new t.Vector3(0,1,0),-u);i.multiplyQuaternion(p),l=n.getVirtualGlobalMatrix().decompose();var _=new t.Vector3(o.x-l[0].x,o.y-l[0].y,o.z-a);i.translate(_)}},createLine:function(e){if(null===e.getChildByName("teleportLine")){var i=[];i.push(new t.Vector3(0,0,0)),i.push(new t.Vector3(0,0,-5e3));var a=new t.LineBasicMaterial({color:8961493,force:!0}),r=o.createLineNode({points:i,material:a,editable:!0,drawMode:n.ConnectivityTypeEnum.LINES});return r.intersectable=!1,r.setName("teleportLine"),r.setVisibility(!1),r.exludeFromBounding(!0),e.addChild(r),r}},createHitModel:function(e){var n=new i;n.setVisibility(!1),n.intersectable=!1,n.exludeFromBounding(!0),n.setName("hitEntity");var a=document.createElement("canvas");a.width=1,a.height=16;var r=a.getContext("2d"),s=r.createLinearGradient(0,1,0,15);s.addColorStop(0,"rgba(255, 255, 255, 1)"),s.addColorStop(1,"rgba(255, 255, 255, 0)"),r.fillStyle=s,r.fillRect(0,0,a.width,16),n.removeChildren();var l=new t.Texture(a);l.needsUpdate=!0;var c=new t.MeshBasicMaterial({color:6925514,side:t.DoubleSide,map:l,transparent:!0,force:!0}),d=o.createTubeNode({bottomCenterPoint:new t.Vector3(0,0,0),extrusionVector:new t.Vector3(0,0,50),internalRadius:80,externalRadius:81,sag:30,material:c});d.intersectable=!1,d.exludeFromBounding(!0),d.setShadow(!1,!0),n.addChild(d);var h=new t.LineBasicMaterial({color:2314597,force:!0}),u=o.createLineNode({points:[new t.Vector3(0,0,0),new t.Vector3(80,0,0)],material:h});return u.intersectable=!1,u.exludeFromBounding(!0),n.addChild(u),e.addChild(n),n},update:function(e,i){var o=e.controller,a=o.getNode().getMatrix().decompose()[2].x,r=o.getNode().getChildByName("teleportLine"),s=e.hitEntity;if(r.isVisible()){var l=o.picking3d({type:"line",intersectFloor:!0,viewer:this._viewer});i.intersection=l;var c=r.getBuffer(n.VertexComponentEnum.POSITION);if(null!==l&&l.valid){c[5]=-l.distance/a;var d=new t.Vector3(0,0,-l.distance/a),h=o.getNode().getMatrix();d.applyMatrix4(h);var u=h.decompose(),p=new t.Vector3(0,1,0).applyQuaternion(u[1]);p.z=0,p.normalize();var _=Math.atan2(p.y,p.x),v=(new t.Quaternion).setFromAxisAngle(new t.Vector3(0,0,1),_);i.matrix=(new t.Matrix4).compose(d,v,new t.Vector3(a,a,a)),s.setMatrix(i.matrix),s.setVisibility(!0)}else s&&s.setVisibility(!1),c[5]=-l.distance/a||-5e3/a;r.updateBuffer(n.VertexComponentEnum.POSITION,0,2)}else s.setVisibility(!1),this.teleportTarget={matrix:null,intersection:{}}},_bindPrimaryController:function(e,t){var i,o=e.getContext(),n=e._vrNode;this.createLine(t.getNode());var a=this.createHitModel(n);i={intersection:null,matrix:null};var r,s=this,l=t.addControllerAction({type:"pressed",buttonIdx:s.thumbpadIdx,onDeactivate:function(){s.teleport(i,o)}}),c=t.addControllerAction({type:"touched",buttonIdx:s.thumbpadIdx,onDeactivate:(r=t,function(){r.getNode().getChildByName("teleportLine").setVisibility(!1)}),onActivate:function(e){return function(){e.getNode().getChildByName("teleportLine").setVisibility(!0)}}(t)}),d=t.addControllerAction({onFrameUpdate:function(e,t){return function(){s.update({controller:e,hitEntity:t},i)}}(t,a)});this._activated=!0,this._actionList.push(c),this._actionList.push(l),this._actionList.push(d)},_preDeactivate:function(e,t){var o=e._vrNode,n=o.getChildByName("hitEntity");null!==n&&n instanceof i&&o.removeChild(n)}})}),define("DS/IVBehaviours/ControllerManager",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/IVBehaviours/TeleportBehaviour","DS/IVBehaviours/AirGrabBehaviour","DS/IVBehaviours/SelectionBehaviour","DS/IVBehaviours/TeleportAndRotationBehaviour","DS/IVBehaviours/FlyWalkBehaviour"],function(e,t,i,o,n,a,r){"use strict";return e.Class.extend({init:function(e){this._behaviourList={Teleport:null,Selection:null,AirGrab:null,FlyWalk:null,TeleportAndRotation:null},this.PRIMARYCTR=1,this.SECONDARYCTR=0,this._scenario=e,this._instantiateBList()},activate:function(e){e in this._behaviourList&&this._behaviourList[e].activate&&(this._behaviourList[e].activate(this._scenario),this._scenario.reportConnectedControllers())},deactivate:function(e){e in this._behaviourList&&this._behaviourList[e].deactivate&&this._behaviourList[e].deactivate(this._scenario)},changeStateOfBehaviour:function(e,t){e in this._behaviourList&&(t?(this._behaviourList[e].activate(this._scenario),this._scenario.reportConnectedControllers()):this._behaviourList[e].deactivate(this._scenario,this._behaviourList[e]))},_instantiateBList:function(){this._behaviourList.Teleport=new i(this._scenario._odt),this._behaviourList.Selection=new n({odt:this._scenario._odt}),this._behaviourList.AirGrab=new o,this._behaviourList.TeleportAndRotation=new a,this._behaviourList.FlyWalk=new r},attachNodeToController:function(e){if(!e.node||!e.controllerType)return;let t=this._scenario.getControllers();"Primary"===e.controllerType?t.length>this.PRIMARYCTR&&t[this.PRIMARYCTR].getNode().addChild(e.node):"Secondary"===e.controllerType&&t.length>this.SECONDARYCTR&&t[this.SECONDARYCTR].getNode().addChild(e.node)},detachNodeOfController:function(e){if(!e.node||!e.controllerType)return;let t=this._scenario.getControllers();"Primary"===e.controllerType?t.length>this.PRIMARYCTR&&t[this.PRIMARYCTR].getNode().removeChild(e.node):"Secondary"===e.controllerType&&t.length>this.SECONDARYCTR&&t[this.SECONDARYCTR].getNode().removeChild(e.node)}})});