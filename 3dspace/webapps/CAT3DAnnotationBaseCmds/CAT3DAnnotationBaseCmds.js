/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationShowHideCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(e,t,n,i,o,a,r){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0}),this.setRepeatMode(!1)},beginExecute:function(){var e=function(e){var t;if(e.getLastElement(!0).getAnnotationClassType){for(var n=e;n;){if((t=n.getLastElement(!0)).getAnnotationClassType&&"tpsAnnotationSet"===t.getAnnotationClassType())return n;n=n.getParentPath()}return null}for(var i=e.getChildrenPathes(),o=0;o<i.length;o++)if((t=i[o].getLastElement(!0)).getAnnotationClassType&&"tpsAnnotationSet"===t.getAnnotationClassType())return i[o]},n=i.get();if(n){this.ctxBarPosition=this.getFrameWindow().getContextualUIManager().getContextualBar().getPosition(),this.ctxBarPosition=this.ctxBarPosition?{x:this.ctxBarPosition.x,y:this.ctxBarPosition.y}:{x:0,y:0};for(var s=o.giveAnnotationModelLoader({context:n}),l=t.get(),d="CAT3DAnnotationShowHdr"===this.options.ID||"CAT3DAnnotationSetShowHdr"===this.options.ID,g=0;g<l.length;g++){var c=l[g].pathElement.clone();if(c.internalPath.length)for(;c.internalPath.length;)c=c.getParentPath();for(;!r.isPLMNode(c.getLastElement(!0))&&!c.getLastElement(!0).getAnnotationClassType;)c=c.getParentPath();var u,h=e(c),A=c.getLastElement(!0);if(A.getAnnotationClassType){A.setVisibility(d);var f=A.getAnnotationClassType();if("tpsView"===f||"tpsCapture"===f){var m=A.getVisibleAnnotations(h,!0);for(u=0;u<m.length;u++)m[u].getLastElement(!0).setVisibility(d)}else"tpsAnnotationSet"===f&&d&&s.setAnnotationSetFavoriteCtxPath(h.getParentPath())}else if(r.is3DLeaf(A)){var p=!1;h&&(p=!0,h.getLastElement(!0).setVisibility(d),d&&s.setAnnotationSetFavoriteCtxPath(h.getParentPath())),!p&&d&&s.loadFTAModel({path:c})}else if(r.isReference(A)){var v=s.getDirectChildrenAnnotSets(c);if(v.length)for(u=0;u<v.length;u++)v[u].annotSetPath.getLastElement(!0).setVisibility(d);s.loadFTAModel({path:c}),a.getPreference("3DAnnotLoadARMPartsPref")&&s.loadFTAModel({path:c,ctxTypes:[2]})}}n.getViewer().render()}this.end()},endExecute:function(){for(var e=t.get(),i=[],o=0;o<e.length;o++)i.push({pathElement:e[o].pathElement.clone()});t.empty(),n.empty(),t.add(i),n.add(i),this.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!0,x:this.ctxBarPosition.x,y:this.ctxBarPosition.y}),this.ctxBarPosition=null}})}),define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotStandardsInfoMgr",["UWA/Class","DS/PADUtils/PADContext","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationPanels/CAT3DAnnotationStandardsInfoPanel","DS/Windows/Dialog","DS/Controls/Button","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotationBaseCmds"],function(e,t,n,i,o,a,r,s,l){"use strict";return e.extend({init:function(){this._parent();var e,d,g=this,c=t.get(),u=r.giveAnnotationController({context:c}),h=s.giveAnnotationModelLoader({context:c});this.build=function(t){var r;if(e&&e.cleanPanel(),u&&h){(e=new i).subscribe("onPreferenceModified",function(e){n.setPreference("3DAnnotSemStd",JSON.stringify(e))}),e.subscribe("onShowAllClick",function(){u.onAdditionalInfosRequired({controller:"AnnotStandardMgr"}).getJSONModel(function(t){e.updatePanel(t)})});var s=n.getPreference("3DAnnotSemStd"),A=!0,f=h.getLoadedAnnotationSets();if(1===f.length)A=!1;else{for(var m=0,p=0;p<f.length;p++)f[p].getSemanticStandards&&(m+=1);m<2&&(A=!1)}r=new a({emphasize:"primary",label:l.CloseButton,onClick:function(){e&&e.cleanPanel(),e=null,d.destroy()}}),(d=new o({modalFlag:!0,maximizeButtonFlag:!0,resizableFlag:!0,width:750,height:800,ensureHeightDefinitionOnHierarchy:!0,title:l.InfosPanelTitle,content:e.buildPanel(t,s||JSON.stringify({groupBy:"0",columnSize:{name:"200",code:"200",standard:"200",year:"200",title:"1000"}}),A),immersiveFrame:c.getFrameWindow().getImmersiveFrame(),buttons:{Close:r}})).addEventListener("close",function(){d&&g&&(e&&e.cleanPanel(),e=null,d.destroy())}),d.addEventListener("keydown",function(e){v(e)}),d.addEventListener("keypress",function(e){v(e)})}function v(t){if(d&&g){var n=t.keyCode||t.which;13!==n&&27!==n||(e&&e.cleanPanel(),e=null,d.destroy())}}},this.clearManager=function(){this.destroyPanel(),e=g=c=u=h=null},this.destroyPanel=function(){e&&e.cleanPanel(),d&&d.destroy()}}})}),define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotShowAttrRelatedInfosCmd",["UWA/Core","DS/CAT3DAnnotationPanels/CAT3DAnnotationPliesAndLayersPanel","DS/ApplicationFrame/CommandCheckHeader","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/CATWebUXComponents/CATWebUXPanel","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotationBaseCmds","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationAttributesSubTypes","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationTypes"],function(e,t,n,i,o,a,r,s,l,d,g){"use strict";return n.extend({init:function(n){this._parent(n,{});var c,u,h,A,f,m,p,v=this,C=a.get(),D={};function S(){v.setState(!1)}function b(){var e,t;if(c&&u&&h){if(c.maximizedFlag){var n=window.getComputedStyle(c.getContent());t=Math.round(parseInt(n.width)),e=Math.round(parseInt(n.height))}else c.currentDockArea?c.currentDockArea===WUXDockAreaEnum.LeftDockArea||c.currentDockArea===WUXDockAreaEnum.RightDockArea?(e=C.getFrameWindow().getImmersiveFrame().getContent().offsetHeight-30,t=c.getWidth()):(e=c.getHeight(),t=C.getFrameWindow().getImmersiveFrame().getContent().offsetWidth-30):(e=c.getHeight(),t=c.getWidth());var i=e-10-u.getTextualAndListHeight();h.parentNode&&(i<e/2?(i=e/2,h.parentNode.setStyles({"overflow-y":"scroll"})):h.parentNode.setStyles({overflow:"hidden"})),u.updateViewerSize(t-10,i)}}function P(e){var t=e.split("&#xA;"),n=[];t.forEach(function(e){n=n.concat(e.split("&#10;"))});var i=[];return n.forEach(function(e){i=i.concat(e.split(/(\r\n|\n|\r)/gm))}),n}function w(e,t,n){var i=[],o=g[e.type];o=e.attrType&&d[e.category]&&d[e.category][e.attrType]?d[e.category][e.attrType]:void 0;var a=function(e){var t,n,i,o=[];if(Array.isArray(e))for(t=0;t<e.length;t++)if(i=e[t].Magnitude,(n=e[t].Value)&&e[t].Name){i&&i.toLowerCase&&(i=i.toLowerCase());var a=!1;s.isMagnitudeSupported(i)?(n=s.convertValueToString(e[t].Value,i,{displayUnit:!1}),a=!0):"boolean"===i?n=("1"===n).toString():"string"===i&&(n=P(n)),o.push({colID:e[t].Name,title:e[t].Name+(a?" ("+s.getCurrentUnit(i).nls+")":""),value:n,hidden:e[t].Hidden})}return o}(e.param);return a&&a.length&&(i=i.concat(a)),{uuid:e.uuid,attrType:e.type,attrSubtype:e.attrType,pointedUuids:e.pointedAttrs,idPath:t,isAStructuralItem:e.isRootAttr,name:e.name,type:o,activeState:e.activeState,icon:e.icon,attributes:i,hidden:n}}function y(){var e;if(o.get().some(function(t){return t.pathElement.getLastElement(!0).getAttributeCategory&&"4"===t.pathElement.getLastElement(!0).getAttributeCategory()&&32===t.pathElement.getLastElement(!0).getAttributeType()&&(e=t.pathElement),e}),e&&!e.isEqual(f)&&e.getLastElement(!0).getPointedFeatureIds&&Array.isArray(e.getLastElement(!0).getPointedFeatureIds())){if(f=e.clone(),u&&u.clean(),h)for(;h.firstChild;)h.removeChild(h.firstChild);u=null,m={name:null,entities:null,thickness:null,thicknessUnit:s.getCurrentUnit("length").nls,directionUnit:s.getCurrentUnit("angle").nls,plies:[]};var n,i,a,r,l=e.getLastElement(!0).getAttributeParam(),d={};for(r=0;r<l.length;r++)if(n=l[r],i=n.Name,a=n.Value,"Core Sample"===i)m.name=a;else if("Entities Number"===i)m.entities=a;else if("Thickness"===i)m.thickness=s.convertValueToString(a,"length",{displayUnit:!1});else if(-1!==i.indexOf("CoreThickness")){var g=i.split("CoreThickness")[1];g&&a&&(d[g]=a)}for(var A=[],v=e.clone();v&&v.getLastElement(!0).getAnnotationClassType&&"tpsRoot"!==v.getLastElement(!0).getAnnotationClassType();)v=v.getParentPath();var D=function(e,t){if(t&&t.getLastElement(!0).getAnnotationUuid&&t.getLastElement(!0).getAnnotationUuid()===e)return t;for(var n,i=t.getChildrenPathes(),o=0;o<i.length;o++)if(n=D(e,i[o]))return n},S=[];for(e.getLastElement(!0).getPointedFeatureIds().forEach(function(e){S=S.concat(e.uuids)}),S.forEach(function(e){var t=D(e,v);if(t){var o=t.getLastElement(!0).getAttributeParam(),l={path:t.clone()};for(r=0;r<o.length;r++)n=o[r],i=n.Name,a=n.Value,"PlyName"===i?l.name=a:"Direction"===i?(l.direction=parseFloat(a)*Math.PI/180,l.directionNls=s.convertValueToString(l.direction,"angle",{displayUnit:!1})):"Cured Thickness"===i&&(l.curedThickness=parseFloat(a),l.curedThicknessNls=s.convertValueToString(l.curedThickness,"length",{displayUnit:!1}));!l.curedThickness&&d[t.getLastElement(!0).getAnnotationUuid()]&&(l.curedThickness=parseFloat(d[t.getLastElement(!0).getAnnotationUuid()]),l.curedThicknessNls=s.convertValueToString(l.curedThickness,"length",{displayUnit:!1})),m.plies.push(l);var g=[];t.getLastElement(!0).getPointedFeatureIds()&&(t.getLastElement(!0).getPointedFeatureIds().forEach(function(e){g=g.concat(e.uuids)}),g.forEach(function(e){var t=D(e,v);t&&t.getLastElement(!0).getAttributeType&&14===t.getLastElement(!0).getAttributeType()&&A.push({path:t.clone()})}))}}),c.title=m.name,c.icon=f.getLastElement(!0).getAnnotationIcon(),(u=new t).subscribe("onPlyListExpandedOrCollapsed",b),u.subscribe("onPlyAndLayersPanelCreated",b),r=0;r<m.plies.length;r++)m.plies[r].attrModel=w(m.plies[r].path.getLastElement(!0).toJSON(),[r]);for(m.rosettesAttrModel=[],r=0;r<A.length;r++)m.rosettesAttrModel.push(w(A[r].path.getLastElement(!0).toJSON(),[m.plies.length+r],!0));var P=u.build(m);h.appendChild(P),p||(C.getFrameWindow().getImmersiveFrame().addEventListener("freeZoneResize",b),p=1)}}this.clean=function(e){if(c&&c.clean(),u&&u.clean(),p&&C.getFrameWindow().getImmersiveFrame().removeEventListener("freeZoneResize",b),p=null,h=null,e){A&&o.unsubscribe(A),A=null;var t=i.giveAnnotationModelLoader({context:C});t&&D.onAnnotationSetRemoved&&t.unsubscribe(D.onAnnotationSetRemoved),D={}}c=u=h=f=m=null};var T=this.onStateChange(function(){if(v.getState()){A=o.onAdd(y);var t=i.giveAnnotationModelLoader({context:C});t&&(D.onAnnotationSetRemoved=t.subscribe("onAnnotationSetRemoved",S)),function(){v.clean(),h=new e.Element("div");var t={id:"CAT3DAnnotAttrInfosPanel",className:"CAT3DAnnotAttrInfosPanel",title:l.relatedAttrPanelTitle,immersiveFrame:C.getFrameWindow().getImmersiveFrame(),viewerFrame:C.getFrameWindow().getViewerFrame(),content:h,minWidth:320,width:320,minHeight:300,height:300,closeButtonFlag:!0,allowedDockAreas:WUXDockAreaEnum.TopDockArea|WUXDockAreaEnum.BottomDockArea|WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.RightDockArea,closePanelCB:S,onPanelResizedCB:b};(c=new r(t)).ensureVisible(),y()}()}else v.clean(!0)}),E=this._destroy;this._destroy=function(){v.clean(!0),v._modelEvents.unsubscribe(T),E.call(v),C=v=null}}})}),define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationLevelSelectorCmd",["DS/ApplicationFrame/Command","DS/LevelSelector/LevelSelector","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(e,t,n,i,o,a){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0}),this.setRepeatMode(!1);var r,s=this,l=o.get(),d=!1,g=0,c={x:0,y:0};this.beginExecute=function(){g=n.onEmpty(function(){s._isRunning&&!d&&s.end()});var e=s.getFrameWindow().getContextualUIManager().getContextualBar();c=e&&e.getPosition()?e.getPosition():{x:0,y:0},e&&(c.x=c.x+e.elements.container.getDimensions().width-40*window.devicePixelRatio,c.y=c.y-e.elements.container.getDimensions().height/2-10*window.devicePixelRatio,e.hide())},this.execute=function(){var e=r;if(!e){var o=n.get();e=r=o.length>0?o[o.length-1]:void 0}if("pathElement"in e&&e.pathElement){var g,u=e.pathElement,h=function(e){if(!e)return!1;for(var t=e;t&&!t.getLastElement(!0).getAnnotationClassType;)t=t.getParentPath();return t}(u);g=h?function(){var e=[],t={levels:e};if(!h.getLastElement(!0).getAnnotationClassType||"tpsAnnotationSet"!==h.getLastElement(!0).getAnnotationClassType()){e.push({pathElement:h,name:h.getLastElement(!0).getAnnotationName(),icon:h.getLastElement(!0).getAnnotationIcon()});var n=h.getParentPath();if(n.getLastElement(!0).getAnnotationClassType&&"tpsRoot"===n.getLastElement(!0).getAnnotationClassType()){var i=n.getLastElement(!0).getAnnotationType?n.getLastElement(!0).getAnnotationType():null;if(i&&"RootViews"!==i&&"RootCaptures"!==i&&"RootGeometries"!==i){var o=function(e){if(!e)return null;var t,n=void 0!==e.getLastElement(!0).getAnnotationID?e.getLastElement(!0).getAnnotationID():null,i=e.getParentPath().getParentPath();if(!i.getLastElement(!0).getAnnotationClassType||"tpsAnnotationSet"!==i.getLastElement(!0).getAnnotationClassType())return null;var o=null,a=i.getChildrenPathes();for(t=0;t<a.length;t++)if("RootViews"===a[t].getLastElement(!0).getAnnotationType()){o=a[t];break}if(o){var r=o.getChildrenPathes();for(t=0;t<r.length;t++){var s=r[t].getLastElement(!0).getTPSList();if(s&&s.length)for(var l=0;l<s.length;l++)if(s[l]===n)return r[t]}}}(h);o&&e.push({pathElement:o,name:o.getLastElement(!0).getAnnotationName(),icon:o.getLastElement(!0).getAnnotationIcon()})}n=n.getParentPath()}return n.getLastElement(!0).getAnnotationClassType&&"tpsAnnotationSet"===n.getLastElement(!0).getAnnotationClassType()&&e.push({pathElement:n,name:n.getLastElement(!0).getAnnotationName(),icon:n.getLastElement(!0).getAnnotationIcon()}),t}}:function(e){for(var t=[],n=[],i=[],o=u;o;){var r=o.getLastElement(!0);if(a.isPLMNode(r)&&(a.isReference(r)||a.is3DLeaf(r))){var s={pathElement:o,idRef:a.getNodeID(r)};t.push(s),n.push(s.idRef),i.push({node:o.getLastElement(!0),id:s.idRef});var d=o.externalPath.length>1?o.externalPath[o.externalPath.length-2]:null;a.isPLMNode(d)&&a.isInstance(d)&&(n.push(s.idInst=a.getNodeID(d)),i.push({node:d,id:s.idInst}))}o=o.getParentPath()}var g,c,h=["ds6w:label","type_icon_url"],A=function(n){t.forEach(function(e){e.name=n[e.idRef]?n[e.idRef]["ds6w:label"]:"",e.idInst&&n[e.idInst]&&n[e.idInst]["ds6w:label"]&&(e.name+=" ("+n[e.idInst]["ds6w:label"]+")"),e.icon=n[e.idRef]?n[e.idRef].type_icon_url:void 0,g&&c&&(e.canvasColor=c.getColorValueForPredicate(n[e.idRef][g])),delete e.idRef,delete e.idInst}),e(t)};if("3DXML"===a.getLoadedAssetType()){for(var f=[],m=0;m<i.length;m++){var p=a.getNodeInfos(i[m].node);f[i[m].id]={},f[i[m].id]["ds6w:label"]=p.name,f[i[m].id].type_icon_url=p.icon}A(f)}else(c=l.getController()).isColorizeActivated()&&c.isStandalone()&&h.push(g=c.getBIColorMap().predicate),c.getAttributes({ids:n,attributes:h,callbacks:{onComplete:A,onFailure:function(){e(t)}}});return t};var A={positionX:c.x,positionY:c.y,uiFrame:l.getFrameWindow().getUIFrame(),getLevels:g,onHover:function(e){i.empty(),i.add(e)},onLeave:function(e){r&&(i.remove(e),i.add(r))},onSelect:function(e){d=!0,n.empty(),i.empty(),r.pathElement=e.pathElement;var t=r;setTimeout(function(){s.end(),n.add(t),i.add(t),s.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!0})},0),d=!1}};t.createView(A)}else s.end()},this.endExecute=function(){this._isRunning&&(r=void 0,t.destroyView()),n.unsubscribe(g)}}})}),define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationResetDisplayHistoryCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/PADUtils/views/PADAlert"],function(e,t,n,i){"use strict";var o="";return require(["i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotationBaseCmds"],function(e){o=e.DisplayHistorySuccessfulLbl}),e.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0}),this.setRepeatMode(!1)},beginExecute:function(){var e,a,r=t.get(),s=n.giveAnnotationModelLoader({context:r}).getLoadedAnnotationSets();for(e=0;e<s.length;e++){var l=s[e].getRootAnnotationNode("RootCaptures");if(l&&l.children&&l.children.length)for(a=0;a<l.children.length;a++)l.children[a].setDisplayFlag(!1);if((l=s[e].getRootAnnotationNode("RootViews"))&&l.children&&l.children.length)for(a=0;a<l.children.length;a++)l.children[a].setDisplayFlag(!1)}i.displayNotification({eventID:"info",msg:o}),this.end()}})}),define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationBaseCmds",[],function(){}),define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationBlankingCmd",["DS/ApplicationFrame/CommandCheckHeader"],function(e){"use strict";return e.extend({init:function(e){this._parent(e,{});var t=this,n=this.onStateChange(function(){t.getFrameWindow().getViewer().displayBlankingPolygon&&t.getFrameWindow().getViewer().displayBlankingPolygon(t.getState()),t.getFrameWindow().getViewer().render(),localStorage.setItem("CAT3DAnnotationBlankingCmd",t.getState()?"true":"false")}),i=this._destroy;this._destroy=function(){t._modelEvents.unsubscribe(n),i.call(t)};var o=localStorage.getItem("CAT3DAnnotationBlankingCmd");this.setState("true"===o)},_destroy:function(){this._parent()}})}),define("DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/CAT3DAnnotationPanels/CAT3DAnnotationThumbnailPanel","DS/CATWebUXComponents/CATWebUXPanel","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/ApplicationFrame/CommandsManager","DS/Visualization/SceneGraphUtils","DS/Visualization/Viewpoint","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationBaseCmds/CAT3DAnnotStandardsInfoMgr","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Selection/HSOManager","DS/Visualization/PathElement","DS/Visualization/IdPath"],function(e,t,n,i,o,a,r,s,l,d,g,c,u,h,A,f){"use strict";var m=t.extend({init:function(t){this._parent(t);var m,p,v,C,D,S,b,P,w,y,T,E,L,F,I,B,V,x=t||{},k=!1,R=!1,M=!1,U=!1,W=null,O=null,_=!0,N=[],H=x.ctxViewer,G=!1,X={},z={},q={},j=0,J=0,Z=0,Y=0,K=0,Q=0,$=150,ee=0,te=this,ne=e.createElement("canvas"),ie=function(e){if(N&&N.length&&N[e[0]]&&N[e[0]].children&&N[e[0]].children[e[1]]&&N[e[0]].children[e[1]].path){var t=N[e[0]].children[e[1]].path.getChildrenPathes();if(t&&t.length&&t[e[2]]){var n=t[e[2]].getChildrenPathes();if(n&&n.length&&n[e[3]])return n[e[3]]}}},oe=function(e){for(var t=0;t<N.length;t++)for(var n=0;n<N[t].children.length;n++)for(var i=N[t].children[n].path,o=0;o<i.getChildrenPathes().length;o++)for(var a=i.getChildrenPathes()[o],r=0;r<a.getChildrenPathes().length;r++)if(a.getChildrenPathes()[r].isEqual(e))return[t,n,o,r];return null},ae=function(e,t){(!t||t&&!e.getLastElement(!0).previewUpdated)&&P.getFTAViewOrCaptureDisplayInfos({path:e,cb:async function(n){var i,o=function(){t&&t()};if(!k||!W)return void o();var a=H.getViewer(),r=[e],s=[],g=H.getRootBagPath().getLastElement(!0);if(H.getViewer().comparisonActive)return;var c,h=!!H.getFrameWindow().getReviewModelVisibleFlag&&H.getFrameWindow().getReviewModelVisibleFlag();h&&H.getFrameWindow().setReviewModelVisibleFlag&&H.getFrameWindow().setReviewModelVisibleFlag(!1);var m=w.getOrderedAnnotationSetPaths();for(i=0;i<m.length;i++)m[i].annotSetPath.isAParentOf(e)&&(c=m[i].annotSetPath,r.push(c)),s.push(m[i].annotSetPath);if(!c)return void o();var p=e.getLastElement(!0),y=a.infinitePlane;a.displayInfinitePlane(!1);var T=a.useShadowPlane;a.setShadowPlane(!1);var B=a.useSSAO;a.setSSAO(!1);var V=a.getShadow();a.setShadow(!1);var x=a.getGrid();a.setGrid(!1);var R=a.getMirror(),M=a.blurryMirror;a.setMirror(!1,!1);var U=c.getChildrenPathes();for(i=0;i<U.length;i++)for(var O=U[i].getChildrenPathes(),_=0;_<O.length;_++)s.push(O[_]);if(e.externalPath[0]!==H.getDecorationBag()){var N=H.getRootBagPath().getChildrenPathes();if(H.getRootBagPath().isAParentOf(e))for(i=0;i<N.length;i++)N[i].isAParentOf(e)?r.push(N[i]):s.push(N[i])}const G=function(e,t){e&&e.length&&l.applyVisibilityToPaths(e,t)};var X=b();const z=[],q=[];if(X){if(X.hiddenBodies&&X.hiddenBodies.length&&X.hiddenBodies[0].getLastElement)for(i=0;i<X.hiddenBodies.length;i++)l.getVisibilityFromPath&&!l.getVisibilityFromPath(X.hiddenBodies[i])&&q.push(X.hiddenBodies[i]);if(X.visibleBodies&&X.visibleBodies.length&&X.visibleBodies[0].getLastElement)for(i=0;i<X.visibleBodies.length;i++)l.getVisibilityFromPath&&l.getVisibilityFromPath(X.visibleBodies[i])&&z.push(X.visibleBodies[i])}G(q,1),G(z,0);const j=[],J=[];if(n.hiddenBodies&&n.hiddenBodies.length||n.visibleBodies&&n.visibleBodies.length){if(n.visibleBodies&&n.visibleBodies.length)for(i=0;i<n.visibleBodies.length;i++)l.getVisibilityFromPath&&!l.getVisibilityFromPath(n.visibleBodies[i])&&J.push(n.visibleBodies[i]);if(n.hiddenBodies&&n.hiddenBodies.length)for(i=0;i<n.hiddenBodies.length;i++)(l.getVisibilityFromPath&&l.getVisibilityFromPath(n.hiddenBodies[i])||!l.getVisibilityFromPath)&&j.push(n.hiddenBodies[i])}G(J,1),G(j,0),I&&I.visibleAssemblyPathElts&&I.visibleAssemblyPathElts.length&&(s=s.concat(I.visibleAssemblyPathElts)),I&&I.hiddenAssemblyPathElts&&I.hiddenAssemblyPathElts.length&&(r=r.concat(I.hiddenAssemblyPathElts)),n.visibleAnnotations&&n.visibleAnnotations.length&&(r=r.concat(n.visibleAnnotations)),n.hiddenAssemblyPathElts&&n.hiddenAssemblyPathElts.length&&(s=s.concat(n.hiddenAssemblyPathElts)),n.visibleAssemblyPathElts&&n.visibleAssemblyPathElts.length&&(r=r.concat(n.visibleAssemblyPathElts));var Z=H.getController().getRootBagId();L||(L=new u(g,Z)),F||(F=new u(H.getDecorationBag())),a.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(L),a.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(F);let Y,K,Q=[],$=[],ee=s.filter(e=>e.externalPath[0]===H.getDecorationBag()?e:null),te=s.filter(e=>e.externalPath[0]===H.getDecorationBag()?null:e);ee.length&&(Y=F.createOverride({pathes:ee}))&&(Y.setVisibility(!1),$.push(Y)),te.length&&(Y=L.createOverride({pathes:te}))&&(Y.setVisibility(!1),Q.push(Y)),ee=r.filter(e=>e.externalPath[0]===H.getDecorationBag()?e:null),te=r.filter(e=>e.externalPath[0]===H.getDecorationBag()?null:e),ee.length&&(K=F.createOverride({pathes:ee}))&&(K.setVisibility(!0),$.push(K)),te.length&&(K=L.createOverride({pathes:te}))&&(K.setVisibility(!0),Q.push(K)),n.visibleAssemblyIdPaths&&n.visibleAssemblyIdPaths.length&&((Y=L.createIdPathOverride({idPathes:new f([Z]),propagateUntilRepRefs:!0})).setVisibility(!1),Q.push(Y),(K=L.createIdPathOverride({idPathes:[new f([Z])]}))&&(K.setVisibility(!0),Q.push(K)),n.visibleAssemblyIdPaths.forEach(function(e){(K=L.createIdPathOverride(e))&&(K.setVisibility(!0),Q.push(K))}));var ie=a.getNodes(),ae=[];for(i=0;i<ie.length;i++)-1!==ie[i].name.indexOf("3D Grid")&&(ae.push(new u(ie[i])),a.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(ae[ae.length-1]),ae[ae.length-1].createOverride({pathes:[new A([ie[i]])]}).setVisibility(!1));var re=D();C(re),n.clippingInfos&&v(n.clippingInfos);let se=H.getFrameWindow().getViewpoint();E||(E=new d({viewer:H.getViewer(),projectionType:se.getProjectionType(),angle:se.getAngle(),near:se.getCamera().near,far:se.getCamera().far})).getControl().setMode(se.getControl()._mode),E.setProjectionType(se.getProjectionType());let le=t?E:se,de={distanceToTarget:le.getTargetDistance(),origin:le.getEyePosition(),projectionType:le.getProjectionType(),sight:le.getSightDirection(),target:le.getTarget(),up:le.getUpDirection()};S(le,P.getDisplayAreaInfos(n.path),0);var ge=await async function(e,t,n){let i=2*n,o=2*t,a=H.getViewer().SCREEN_HEIGHT,r=Math.round(a*(t/n)),s=new ImageData(r,a);H.getViewer().renderToTarget(s,e),ne.height=i,ne.width=o;var l=ne.getContext("2d");if(l){let e=await createImageBitmap(s,0,0,s.width,s.height);l.clearRect(0,0,ne.width,ne.height),l.scale(1,-1),l.drawImage(e,0,0,ne.width,-ne.height),e.close()}return ne.toDataURL("image/jpeg",.3)}(le,200,113);for(p.setPreview(ge),p.previewUpdated=!0,W.setAdditionalInformations([{idPath:oe(e),infos:{preview:ge}}]),S(le,de,0),h&&H.getFrameWindow().setReviewModelVisibleFlag&&H.getFrameWindow().setReviewModelVisibleFlag(!0),L.deleteOverrides(L.getOverrides()),F.deleteOverrides(F.getOverrides()),a.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(L),a.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(F),i=0;i<ae.length;i++)a.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(ae[i]);G(j,1),G(J,0),G(q,0),G(z,1),y&&a.displayInfinitePlane(y),T&&a.setShadowPlane(T),B&&a.setSSAO(B),V&&a.setShadow(V),x&&a.setGrid(x),(R||M)&&a.setMirror(R,M),n.clippingInfos&&C(n.clippingInfos),re&&v(re),H.getViewer().render(),o()}})};let re;var se=function(e){var t=function(){"requestIdleCallback"in window?window.requestIdleCallback(se):(re&&(clearTimeout(re),re=null),re=setTimeout(se,1e3))};if(k&&W&&m&&!M)if(!H.getFrameWindow().getViewpoint().isMoving()&&(!e||e.timeRemaining()>0)&&Q>=0&&0===h.get().length&&P&&w&&!w.isRunning()&&!P.isRunning()&&!H.getController().isRunning())for(var n=W.getThumbnailsIDPaths(),i=0;i<n.length;i++){var o=ie(n[i]);if(o&&!o.getLastElement(!0).previewUpdated)return void ae(o,t)}else setTimeout(t,500)},le=function(){q.onViewOrCaptureDisplayed||(q.onViewOrCaptureDisplayed=P.subscribe("onViewOrCaptureDisplayed",function(e){!e||e&&!e.path||(I=e,W&&W.setAdditionalInformations([{idPath:oe(e.path),infos:{displayFlag:!0}}]))})),q.onFilteringAndClippingRemoved||(q.onFilteringAndClippingRemoved=P.subscribe("onFilteringAndClippingRemoved",function(){I=null})),"requestIdleCallback"in window?window.requestIdleCallback(se):(re&&(clearTimeout(re),re=null),re=setTimeout(se,1e3))},de=function(){setTimeout(function(){if(k&&W){for(var e=W.getThumbnailsIDPaths(),t=0;t<e.length;t++){var n=ie(e[t]);n&&n.getLastElement(!0).previewUpdated&&(n.getLastElement(!0).previewUpdated=!1)}le()}},100)},ge=function(e){k&&(Q+=!0===e?1:-1,ee&&(clearTimeout(ee),ee=0),O&&(O.setEnableFlag(Q>=0),Q<0&&(ee=setTimeout(function(){k&&O&&O.setEnableFlag(!0),Q=0},2e4))))},ce=function(){for(var e=0,t=0;t<N.length;t++)if(N[t].children)for(var n=0;n<N[t].children.length;n++){var i=N[t].children[n];if(i.isVisible)for(var o=0;o<i.children.length;o++){var a=i.children[o];if(("RootViews"===a.type||"RootCaptures"===a.type)&&a.children.length>0){e++;break}}}return 0===e||1===e?228:248},ue=function(){var e=window&&window.widget?window.widget.id:"";if("undefined"!=typeof sessionStorage)if("true"===sessionStorage.getItem("CAT3DAnnotBrowserExpFlag_"+e))sessionStorage.setItem("CAT3DAnnotBrowserExpFlag_"+e,"false"),O.setWidth(ce());else{var t=parseFloat(sessionStorage.getItem("CAT3DAnnotBrowserWidth_"+e));t&&t!==ce()&&(sessionStorage.setItem("CAT3DAnnotBrowserExpFlag_"+e,"true"),O.setWidth(t))}},he=function(e){var t=ie(e.idPath);t&&(P.displayFTAViewOrCapture({path:t,data:6===t.getLastElement(!0).getAnnotationType()?{label:e.label,icon:e.icon.replace("icons/22/","icons/32/")}:null}),!m||"requestIdleCallback"in window||t.getLastElement(!0).previewUpdated||W.setAdditionalInformations([{idPath:e.idPath,infos:{preview:null}}])),O&&O.isSmallWidth()&&O.collapsePanel()},Ae=function(){var e=s.getCommand("CAT3DAnnotationResetDisplayHistoryHdr",H.getCommandContext?H.getCommandContext():null);if(e){e.begin();for(var t=W.getThumbnailsIDPaths(),n=[],i=0;i<t.length;i++)n.push({idPath:t[i],infos:{displayFlag:!1}});n.length&&W.setAdditionalInformations(n)}},fe=function(e){if(e){for(var t=[],n=0;n<e.length;n++){var i=ie(e[n].idPath);if(i){for(var o=i.getLastElement(!0),a=e[n].dataTypes,r={idPath:e[n].idPath,infos:{}},s=0;s<a.length;s++)"preview"===a[s]?r.infos.preview=o.getPreview():"displayFlag"===a[s]&&(r.infos.displayFlag=o.getDisplayFlag());t.push(r)}}W.setAdditionalInformations(t)}},me=function(){if(!W){var e=s.getCommand("CAT3DAnnotationResetDisplayHistoryHdr",H.getCommandContext?H.getCommandContext():null);W=new i({additionalCmdAvailability:null!=e}),(z={}).onBrowserPanelResized=W.subscribe("onBrowserPanelResized",ue),z.onInfoStandardsClicked=W.subscribe("onInfoClick",function(e){y.build(e)}),z.onThumbnailSelected=W.subscribe("onThumbnailSelected",he),z.onDeleteDisplayHistory=W.subscribe("onDeleteDisplayHistory",Ae),z.onAdditionalInfosRequired=W.subscribe("onAdditionalInfosRequired",fe)}W.setDisplayOnlyCapturesFlag(g.getPreference("3DAnnotDisplayCapturesPref")),N.backgroundColor="#"+new n.Color(H.getViewer().backgroundColor).getHexString();var t=W.buildPanel(N);if(t){var a,r=ce(),l=window&&window.widget?window.widget.id:"";if("true"===sessionStorage.getItem("CAT3DAnnotBrowserExpFlag_"+l)&&(a=parseFloat(sessionStorage.getItem("CAT3DAnnotBrowserWidth_"+l))),a||(a=void 0!==T?T:r),a=a>=r?a:r,O)O.setMinWidth(r);else{var d={id:"CAT3DAnnotBrowserPanel",className:"CAT3DAnnotBrowserSidePanel",showTitleFlag:!1,icon:"fonticon fonticon-viewBrowser CAT3DAnnotBrowserIcon",immersiveFrame:H.getFrameWindow().getImmersiveFrame(),viewerFrame:H.getFrameWindow().getViewerFrame(),content:t,minWidth:r,width:a,widthStep:212,closeButtonFlag:!1,minHeight:324,height:324,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:"right"===x.defaultDockingSide?WUXDockAreaEnum.RightDockArea:WUXDockAreaEnum.LeftDockArea,onPanelResizedCB:function(e){if((e.currentDockArea===WUXDockAreaEnum.RightDockArea||e.currentDockArea===WUXDockAreaEnum.LeftDockArea)&&(T=e.width,e.widthModifiedInteractively)){var t=window&&window.widget?window.widget.id:"";sessionStorage.setItem("CAT3DAnnotBrowserExpFlag_"+t,"true"),sessionStorage.setItem("CAT3DAnnotBrowserWidth_"+t,e.width)}}};O=new o(d)}O.setEnableFlag(Q>=0)}O&&W&&O.setPanelVisibilityFlag(_&&0!==W.getThumbnailsIDPaths().length),le()},pe=function(){K&&(clearTimeout(K),K=0),V&&(clearInterval(V),V=null),O&&(T=O.getWidth(),O.clean(),O=null),W&&W.cleanPanel()};var ve=function(){if(k&&P.getActiveState())if(M||w.isRunning()){if(V)return;V=setInterval(function(){(M||w.isRunning())&&k&&P.getActiveState()||(clearInterval(V),V=null,ve())},100)}else K&&(clearTimeout(K),K=0),K=setTimeout(function(){k?U||(U=!0,N.splice(0,N.length),p(function(e){if(U=!1,k){N=e;for(var t=0;t<N.length;t++)if(N[t].children)for(var n=0;n<N[t].children.length;n++){var i=N[t].children[n];if(i.isVisible)for(var o=0;o<i.children.length;o++){var a=i.children[o];if(("RootViews"===a.type||"RootCaptures"===a.type)&&a.children.length>0)return me(),void(O&&O.setEnableFlag(Q>=0))}}pe()}else pe()})):pe(),$=150,K=0},$)};this.setActiveState=function(e){if(k=e,P&&w){if(!p){var t=P.onAdditionalInfosRequired({controller:"AnnotBrowser"});p=t.getJSONModel,v=t.addClipping,C=t.removeClipping,D=t.getCurrentClippingInfos,S=t.reframe,b=t.getOverloadedPaths}if(Q=0,k)G||(y=new c,q.onAnnotUIDisabled=P.subscribe("onAnnotUIDisabled",function(){te.setPanelVisibilityFlag(!1)}),q.onAnnotUIEnabled=P.subscribe("onAnnotUIEnabled",function(){te.setPanelVisibilityFlag(!0)}),q.onAnnotControllerActiveStateChanged=P.subscribe("onAnnotControllerActiveStateChanged",function(e){e.state?ve():pe()}),q.onAnnotationsLinkedDataSolved=P.subscribe("onAnnotationsLinkedDataSolved",function(){le()}),X.onAnnotModelLoaderActiveStateChanged=w.subscribe("onAnnotModelLoaderActiveStateChanged",function(e){e.state?ve():pe()}),X.onAnnotationVisibilityModifiedToken=w.subscribe("onAnnotationVisibilityModified",function(e){"tpsAnnotationSet"===e.node.getAnnotationClassType()&&ve()}),X.onAnnotationSetLoadedToken=w.subscribe("onAnnotationSetLoaded",function(){ge(!0),ve(),y&&y.destroyPanel()}),X.onAnnotationSetPartiallyLoaded=w.subscribe("onAnnotationSetPartiallyLoaded",function(){ge(!0),ve()}),X.onAnnotationSetRemovedToken=w.subscribe("onAnnotationSetRemoved",function(){$=0,ve(),y&&y.destroyPanel()}),X.onAnnotationSetBeginLoadToken=w.subscribe("onAnnotationSetBeginLoad",function(){ge(!1)}),X.onAnnotationSetLoadingFailedToken=w.subscribe("onAnnotationSetLoadingFailed",function(){ge(!0)}),X.onNoAnnotationSetLoadedToken=w.subscribe("onNoAnnotationSetLoaded",function(e){e&&e.loadingAlreadyStarted&&ge(!0)}),X.onAnnotationSetLoadingCanceledToken=w.subscribe("onAnnotationSetLoadingCanceled",function(){ge(!0)}),m=g.getPreference("3DAnnotUpdateThumbnailsPref"),le(),J=g.subscribe("onPreferenceModified",function(e){"3DAnnotDisplayCapturesPref"===e.preference&&ve(),"3DAnnotUpdateThumbnailsPref"===e.preference&&(m=e.value,le())}),X.onVisuModificationToken=w.subscribe("onAnnotationParentVisibilityModified",function(){ve()}),j=H.subscribe({event:"onModelUpdated"},de),Z=H.getViewer().onBackgroundModify(de),Y=H.getViewer().onSwapVisibleSpace?H.getViewer().onSwapVisibleSpace(function(){M=0===H.getViewer().getVisibleSpace(),1===H.getViewer().getVisibleSpace()?ve():pe()}):null,M=0===H.getViewer().getVisibleSpace(),G=!0),ve();else{var n,i;if(W){for(n=Object.keys(z),i=0;i<n.length;i++)W.unsubscribe(z[n[i]]);W=null}if(z={},O&&(O.clean(),O=null),G){for(n=Object.keys(X),i=0;i<n.length;i++)w.unsubscribe(X[n[i]]);for(n=Object.keys(q),i=0;i<n.length;i++)P.unsubscribe(q[n[i]]);J&&g.unsubscribe(J),Z&&H.getViewer().unsubscribe(Z),Y&&H.getViewer()&&H.getViewer().unsubscribe(Y),j&&H.unsubscribe(j),pe(),y.clearManager()}K&&(clearTimeout(K),K=0),ee&&(clearTimeout(ee),ee=0),X={},q={},J=0,Z=0,Y=0,j=0,G=!1,y=null,N.length=0}}else B||(B=setInterval(function(){w=r.giveAnnotationModelLoader({context:H}),(P=a.giveAnnotationController({context:H}))&&w&&(clearInterval(B),B=null,te.setActiveState(k))},100))},this.getActiveState=function(){return k},this.clearController=function(){this.setActiveState(!1),B&&clearInterval(B),U=!1,O=P=w=null,I=B=null,p=null,H=te=ne=L=F=null},this.setControllerEnableFlag=function(e){var t=s.getCommandCheckHeader("CAT3DAnnotationBrowserHdr",H.getCommandContext());t&&(e?t.enable():t.disable()),R?(te.setActiveState(!0),R=!1):e||k&&(te.setActiveState(!1),R=!0,p=P=w=null)},this.setPanelVisibilityFlag=function(e){_=e,O&&W&&O.setPanelVisibilityFlag(_&&0!==W.getThumbnailsIDPaths().length)},this.getPanelVisibilityFlag=function(){return _}}}),p=[];return t.singleton({init:function(){},give3DAnnotBrowserController:function(e){if(e&&e.context)for(var t=0;t<p.length;t++)if(p[t].context===e.context)return p[t].browserController},get3DAnnotBrowserController:function(e){var t;if(e&&e.context&&!(t=this.give3DAnnotBrowserController(e))){var n=new m({ctxViewer:e.context,defaultDockingSide:e.defaultDockingSide});t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){return n?n.getActiveState():null},setPanelVisibilityFlag:function(e){n&&n.setPanelVisibilityFlag(e)},getPanelVisibilityFlag:function(){return n?n.getPanelVisibilityFlag():null},setControllerEnableFlag:function(e){if(n)return n.setControllerEnableFlag(e)},clearController:function(){n&&(n.clearController(),n=null)}}),p.push({context:e.context,browserController:t})}return t},unreference3DAnnotBrowserController:function(e){if(e&&e.context)for(var t=0;t<p.length;t++)if(p[t].context===e.context){p[t].browserController.clearController(),p.splice(t,1);break}}})}),define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationBrowserCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController"],function(e,t,n){"use strict";return e.extend({init:function(e){this._parent(e,{});var i,o=this,a=this.onStateChange(function(){i||(i=t.get());var e=o.options&&o.options.arguments&&1===o.options.arguments.length&&"defaultDockingSide"===o.options.arguments[0].ID?o.options.arguments[0].Value:null;n.get3DAnnotBrowserController({context:i,defaultDockingSide:e}).setActiveState(o.getState()),localStorage.setItem("CAT3DAnnotationBrowserCmd",o.getState()?"true":"false")}),r=this._destroy;this._destroy=function(){i&&n.unreference3DAnnotBrowserController({context:i}),o._modelEvents.unsubscribe(a),r.call(o)},this.setState("false"!==localStorage.getItem("CAT3DAnnotationBrowserCmd"),!0)},_destroy:function(){this._parent()}})});