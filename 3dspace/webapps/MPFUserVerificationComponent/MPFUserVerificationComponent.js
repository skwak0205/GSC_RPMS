define("DS/MPFUserVerificationComponent/DocumentInput",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFSheerIdVerificationModel/SheerIdVerificationModel","DS/MPFView/DropZone","i18n!DS/MPFUserVerificationComponent/assets/nls/UserVerification"],function(e,t,i,n,s,r){"use strict";const o={FILE_SELECTION:"fileSelection"},a=t.extend({className:"mpf-document-input",setup(e){i.requiredOfPrototype(e.studentVerification,n,"options.studentVerification must be a SheerIdVerificationModel"),this.studentVerification=e.studentVerification,this.hiddenInput=this._createHiddenInput(),this.dropZone=this._createDropZone()},render(){return this.container.setContent([this.hiddenInput,this.dropZone.render(),{tag:"div",class:"mpf-file-type-info",text:r.get("acceptedFileTypes")}]),this},destroy(){this.stopListening(),this.dropZone.destroy(),this.studentVerification=null,this._parent(),this.container=null},_createHiddenInput(){const t=this;return e.createElement("input",{attributes:{multiple:!0,name:"documents",type:"file"},events:{change:function(){t.dispatchEvent(o.FILE_SELECTION,{files:[...this.files]}),this.value=""}}})},_createDropZone(){const e="draggable"in document.createElement("span")?"":"mpf-mobile",t=new s({acceptedFileTypes:["application/pdf","image/png","image/jpeg","image/bmp","image/gif"],additionalClassName:e});return this.listenTo(t,s.Events.ON_CLICK,()=>{this.hiddenInput.click()}),this.listenTo(t,s.Events.ON_DROP,this.dispatchEvent.bind(this,o.FILE_SELECTION)),t}});return a.Events=Object.freeze(o),a}),define("DS/MPFUserVerificationComponent/OrganizationInput",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFSheerIdVerificationModel/SheerIdVerificationModel","DS/MPFCountryModel/CountryCollection","DS/MPFUrl/UrlUtils","DS/UIKIT/Autocomplete"],function(e,t,i,n,s,r,o){"use strict";const a={ON_CHANGE:"onChange"},c=t.extend({className:"mpf-entry-v2 mpf-organisation-input",setup(e){i.requiredOfPrototype(e.studentVerification,n,"options.studentVerification must be a SheerIdVerificationModel"),i.requiredOfPrototype(e.countries,s,"options.countries must be a CountryCollection"),i.requiredOfType(e.orgSearchUrl,"string","options.orgSearchUrl must be a string"),i.requiredOfType(e.fieldLabel,"string","options.fieldLabel must be a string"),this.studentVerification=e.studentVerification,this.countries=e.countries,this.url=new r(e.orgSearchUrl),this.fieldLabel=e.fieldLabel,this.country=e.country,this.input=this._createInput(),this.errorContainer=this._createErrorContainer()},render(){return this.container.setContent([{tag:"label",html:[{tag:"span",class:"mpf-label",html:this.fieldLabel+'&nbsp;<em class="mpf-required">*</em>'},this.input]},this.errorContainer]),this},validate(){const e=this.studentVerification.validate(n.Fields.ORGANIZATION),t=!(e&&e.length>0);return t?this._clearError():this._showError(e[0].message),{errors:e,isValid:t}},destroy(){this.studentVerification=null,this._parent(),this.container=null},_showError(e){this.container.addClassName("mpf-invalid"),this.errorContainer.setContent({tag:"p",class:"mpf-error",text:e})},_clearError(){this.container.removeClassName("mpf-invalid"),this.errorContainer.empty()},_createInput(){const e=this._createDataSetConfig();return new o({datasets:{configuration:e},events:{onSelect:this._onSelect.bind(this),onUnselect:this._onUnSelect.bind(this)}})},_onSelect(e){this.studentVerification.set(n.Fields.ORGANIZATION,{id:e.id,name:e.value}),this.validate(),this.dispatchEvent(a.ON_CHANGE,e)},_onUnSelect(){this.studentVerification.unset(n.Fields.ORGANIZATION),this.dispatchEvent(a.ON_CHANGE,null)},_createDataSetConfig(){return{dataParser:(e,t)=>t.map(e=>{const t=this.countries.getCountryWithIso2(e.country),i=t?t.getName():null;return{id:e.id,value:e.name,label:e.name,subLabel:i}}),remoteSearchEngine:(e,t)=>window.fetch(this._computeUrl(t)).then(e=>e.json()).then(t=>({dataset:e,matchingItems:e.dataParser(e,t)}))}},_computeUrl(e){return this.url.hasParameter("country")&&this.url.deleteParameter("country"),this.url.hasParameter("name")&&this.url.deleteParameter("name"),this.country&&this.url.addParameter("country",this.country),e&&this.url.addParameter("name",e),this.url.getUrl()},_createErrorContainer:()=>e.createElement("div",{class:"mpf-error-container"})});return c.Events=Object.freeze(a),c}),define("DS/MPFUserVerificationComponent/VerificationStatusPanel",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFSheerIdVerificationModel/VerificationSteps","DS/MPFSheerIdVerificationModel/SheerIdVerificationModel","i18n!DS/MPFUserVerificationComponent/assets/nls/UserVerification"],function(e,t,i,n,s,r){"use strict";return t.extend({className:"mpf-verification-status-panel",setup(e){i.requiredOfPrototype(e.studentVerification,s,"options.studentVerification must be a SheerIdVerificationModel"),this.studentVerification=e.studentVerification},render(){const e=this.studentVerification.getCurrentStep();let t,i,o,a;if(e===n.SUCCESS)o="status-ok",a="success",t=r.get("verificationCompleted"),i=r.get("studentStatusVerified");else if(e===n.PENDING){o="clock",a="pending";const e=this.studentVerification.get(s.Fields.AWAITING_STEP);if(e===n.SSO)t=r.get("ssoVerificationInProgress"),i=r.get("ssoPendingMessage");else if(e===n.DOC_UPLOAD){const e=this.studentVerification.get(s.Fields.ESTIMATED_REVIEW_TIME),n=this.studentVerification.get(s.Fields.MAX_REVIEW_TIME);t=r.get("docVerificationInProgress"),i=e&&n?r.get("docPendingMessage",{estimatedReviewTime:r.get(e),maxReviewTime:r.get(n)}):r.get("docPendingMessageDefault")}}else if(e===n.SSO)o="login",a="pending",i=r.get("ssoLinkMessage"),t=r.get("loginNecessary");else if(e===n.ERROR){o="attention",a="error";const e=this.studentVerification.getFirstErrorId();e===s.Errors.VERIFICATION_LIMIT_EXCEEDED?(t=r.get("verificationLimitExceeded"),i=r.get("verLimitExceededMessage")):e===s.Errors.DOC_REVIEW_LIMIT_EXCEEDED?(t=r.get("docReviewLimitExceeded"),i=r.get("docLimitExceededMessage")):(t=r.get("error"),i=r.get("defaultErrorMessage")),i=this.studentVerification.isErrorRecoverable()?i+" "+r.get("startOver"):i+" "+r.get("contactSupport")}return this.container.setContent(this._fillTemplate(t,o,a,i,void 0)),this},destroy(){this.studentVerification=null,this._parent(),this.container=null},_fillTemplate(e,t,i,n,s){const r=[{tag:"div",class:`fonticon fonticon-${t} mpf-icon mpf-${i}`},{tag:"h2",text:e},{tag:"div",text:n}];return s&&r.push({tag:"a",class:"btn btn-info",text:s.text,attributes:{href:s.href,target:"_blank"}}),r}})}),define("DS/MPFUserVerificationComponent/SsoLinkPanel",["UWA/Class/View","i18n!DS/MPFUserVerificationComponent/assets/nls/UserVerification"],function(e,t){"use strict";return e.extend({className:"mpf-sso-link-panel",setup(){},render(){return this.container.setContent([{tag:"h2",text:t.get("loginNecessary")},{tag:"p",text:t.get("ssoLinkMessage")}]),this},destroy(){this._parent(),this.container=null}})}),define("DS/MPFUserVerificationComponent/StudentInfoForm",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFSheerIdVerificationModel/SheerIdVerificationModel","DS/MPFCountryModel/CountryCollection","DS/MPFView/FieldTextInputV2","DS/MPFView/FieldDateInput","DS/MPFUserVerificationComponent/OrganizationInput","i18n!DS/MPFUserVerificationComponent/assets/nls/UserVerification"],function(e,t,i,n,s,r,o,a,c){"use strict";const d={ON_CHANGE:"onChange"},l=t.extend({className:"mpf-student-info-form",setup(e){i.requiredOfPrototype(e.studentVerification,n,"options.studentVerification must be a SheerIdVerificationModel"),i.requiredOfPrototype(e.countries,s,"options.countries must be a CountryCollection"),i.requiredOfType(e.orgSearchUrl,"string","options.orgSearchUrl must be a string"),this.studentVerification=e.studentVerification,this.countries=e.countries,this.orgSearchUrl=e.orgSearchUrl,this.firstNameInput=this._createFirstNameInput(),this.lastNameInput=this._createLastNameInput(),this.birthDateInput=this._createBirthDateInput(),this.emailInput=this._createEmailInput(),this.organizationInput=this._createOrganizationInput(),this.listenTo(this.firstNameInput,r.Events.UPDATE,this.dispatchEvent.bind(this,d.ON_CHANGE)),this.listenTo(this.lastNameInput,r.Events.UPDATE,this.dispatchEvent.bind(this,d.ON_CHANGE)),this.listenTo(this.birthDateInput,o.Events.UPDATE,this.dispatchEvent.bind(this,d.ON_CHANGE)),this.listenTo(this.emailInput,r.Events.UPDATE,this.dispatchEvent.bind(this,d.ON_CHANGE)),this.listenTo(this.organizationInput,a.Events.ON_CHANGE,this.dispatchEvent.bind(this,d.ON_CHANGE))},render(){return this.container.setContent([this.firstNameInput.render(),this.lastNameInput.render(),this.emailInput.render(),this.birthDateInput.render(),this.organizationInput.render()]),this},validate({silent:e=!1}={}){if(e){const e=this.studentVerification.validate(),t=[this.firstNameInput,this.lastNameInput,this.emailInput];return!e&&t.reduce((e,t)=>e&&this._checkModelAndInputValueEquality(t),!0)}return![this.firstNameInput.validate().isValid,this.lastNameInput.validate().isValid,this.emailInput.validate().isValid,this.birthDateInput.validate().isValid,this.organizationInput.validate().isValid].includes(!1)},save(){return this.studentVerification.submitStudentData()},getVerificationErrorMessage(){const e=this.studentVerification.get(n.Fields.ERROR_IDS);if(e&&e.length>0){const t=`verifRejection_${e[0]}`,i=c.get(t);if(t!==i)return i}},destroy(){this.stopListening(),this.firstNameInput.destroy(),this.lastNameInput.destroy(),this.emailInput.destroy(),this.birthDateInput.destroy(),this.organizationInput.destroy(),this.studentVerification=null,this.countries=null,this._parent(),this.container=null},_checkModelAndInputValueEquality(e){return e.getValue()===this.studentVerification.get(e.fieldName).trim()},_createFirstNameInput(){return new r({model:this.studentVerification,fieldName:n.Fields.FIRST_NAME,fieldLabel:c.get("firstName"),readOnly:!!this.studentVerification.get(n.Fields.FIRST_NAME),required:!0,dynamicValidation:!0})},_createLastNameInput(){return new r({model:this.studentVerification,fieldName:n.Fields.LAST_NAME,fieldLabel:c.get("lastName"),readOnly:!!this.studentVerification.get(n.Fields.LAST_NAME),required:!0,dynamicValidation:!0})},_createEmailInput(){return new r({model:this.studentVerification,fieldName:n.Fields.EMAIL,fieldLabel:c.get("emailAddress"),readOnly:!!this.studentVerification.get(n.Fields.EMAIL),required:!0,dynamicValidation:!0})},_createBirthDateInput(){const e=new Date;return e.setFullYear(e.getFullYear()-18),new o({model:this.studentVerification,fieldName:n.Fields.BIRTH_DATE,fieldLabel:c.get("birthDate"),required:!0,min:new Date("1900-01-01"),max:e,useIsoFormat:!0,renderDatePickerInside:!0})},_createOrganizationInput(){return new a({studentVerification:this.studentVerification,countries:this.countries,orgSearchUrl:this.orgSearchUrl,fieldLabel:c.get("univerityCollegeName")})}});return l.Events=Object.freeze(d),l}),define("DS/MPFUserVerificationComponent/StudentDocForm",["UWA/Core","UWA/Class/View","UWA/String","DS/MPFServices/ObjectService","DS/MPFSheerIdVerificationModel/SheerIdVerificationModel","DS/MPFUserVerificationComponent/DocumentInput","DS/MPFView/ControlsTag","i18n!DS/MPFUserVerificationComponent/assets/nls/UserVerification"],function(e,t,i,n,s,r,o,a){"use strict";const c={ON_CHANGE:"onChange"},d=t.extend({className:"mpf-student-doc-form",setup(e){n.requiredOfPrototype(e.studentVerification,s,"options.studentVerification must be a SheerIdVerificationModel"),this.studentVerification=e.studentVerification,this.files=[],this.docInput=this._createDocInput()},render(){const e=[{tag:"h2",text:a.get("documentUpload")},{tag:"p",text:a.get("docUploadMessage")},this.docInput.render(),this._createFileList()];return this.container.setContent(e),this},clear(){return this.files=[],this},validate(){return this.files.length>0},save(){return this.studentVerification.uploadDocuments(this.files)},destroy(){this.stopListening(),this.docInput.destroy(),this.studentVerification=null,this._parent(),this.container=null},getRejectionMessage(){const e=this.studentVerification.get(s.Fields.REJECTION_REASONS);if(e&&e.length>0){const t=`docUploadRejection_${e[0]}`;let i=a.get(t);return i===t&&(i=a.get("docUploadRejectionDefault")),e.splice(0,1),this.studentVerification.set(s.Fields.REJECTION_REASONS,e),i}},_addFiles({files:e}){this.files=this.files.concat(e),this.render(),this.dispatchEvent(c.ON_CHANGE,this.files)},_deleteFile(e){this.files.splice(e,1),this.render(),this.dispatchEvent(c.ON_CHANGE,this.files)},_createDocInput(){const e=new r({studentVerification:this.studentVerification});return this.listenTo(e,r.Events.FILE_SELECTION,this._addFiles.bind(this)),e},_createFileList(){return e.createElement("div",{class:"mpf-file-list",html:this.files.map(this._createFileItem.bind(this))})},_createFileItem(e,t){const i=new o({value:e.name,isReadOnly:!0});return this.listenTo(i,o.Events.DELETE,this._deleteFile.bind(this,t)),i.render()}});return d.Events=Object.freeze(c),d}),define("DS/MPFUserVerificationComponent/VerificationModal",["UWA/Core","UWA/Promise","UWA/Class/View","DS/UIKIT/Input/Button","DS/UIKIT/Modal","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFSheerIdVerificationModel/VerificationSteps","DS/MPFSheerIdVerificationModel/SheerIdVerificationModel","DS/MPFCountryModel/CountryCollection","DS/MPFUserVerificationComponent/StudentInfoForm","DS/MPFUserVerificationComponent/StudentDocForm","DS/MPFUserVerificationComponent/VerificationStatusPanel","DS/MPFUserVerificationComponent/SsoLinkPanel","i18n!DS/MPFUserVerificationComponent/assets/nls/UserVerification","css!DS/MPFUserVerificationComponent/MPFUserVerificationComponent"],function(e,t,i,n,s,r,o,a,c,d,l,u,h,f,m,p){"use strict";const S={ON_VERIFIED:"onVerified",ON_HIDE:"onHide",ON_PAGE_UPDATE:"onPageUpdate"},g=i.extend({className:"mpf-verification-modal",setup(e){a.requiredOfPrototype(e.studentVerification,d,"options.studentVerification must be a SheerIdVerificationModel"),a.requiredOfPrototype(e.countries,l,"options.countries must be a CountryCollection"),a.requiredOfType(e.orgSearchUrl,"string","options.orgSearchUrl must be a string"),this.studentVerification=e.studentVerification,this.countries=e.countries,this.orgSearchUrl=e.orgSearchUrl,this.alert=this._createAlert(),this.infoForm=this._createInfoForm(),this.docForm=this._createDocForm(),this.statusPanel=this._createStatusPanel(),this.ssoLinkPanel=this._createSsoLinkPanel(),this.submitButton=this._createSubmitButton(),this.modal=this._createModal(this.submitButton),this.listenTo(this.infoForm,u.Events.ON_CHANGE,this._updateSubmitButtonState.bind(this,this.infoForm)),this.listenTo(this.docForm,h.Events.ON_CHANGE,this._updateSubmitButtonState.bind(this,this.docForm))},render(){return this.container.empty(),this.modal.inject(this.container),this},show(){return this._renderCurrentStep(),this.modal.show(),this},hide(){return this.modal.hide(),this},submit(){const e=this.studentVerification.getCurrentStep();let i;if(e!==c.SUCCESS){if(e===c.COLLECT_STUDENT_INFO)i=this.infoForm.validate()?this.infoForm.save():t.reject("Information not valid");else if(e===c.SSO)i=this._waitForStepChange(c.SSO),window.open(this.studentVerification.get(d.Fields.LOGIN_URL),"_blank");else if(e===c.PENDING)i=this.studentVerification.fetchVerification();else if(e===c.DOC_UPLOAD)i=this.docForm.validate()?this.docForm.save():t.reject("Document(s) not valid");else if(e===c.ERROR){if(!this.studentVerification.isErrorRecoverable())return void this.hide();i=this._resetVerificationModel()}return this.setLoading(!0),i.then(()=>this.setLoading(!1)).then(()=>this._renderCurrentStep()).then(()=>this.dispatchEvent(S.ON_PAGE_UPDATE,this.studentVerification.getCurrentStep())).catch(e=>{console.error(e),this.setLoading(!1)})}this.dispatchEvent(S.ON_VERIFIED,this.studentVerification)},setLoading(e){!0===e?(r.mask(this.modal.getBody()),this.submitButton.load(!0)):(r.unmask(this.modal.getBody()),this.submitButton.load(!1))},destroy(){this.stopListening(),this.modal.destroy(),this.alert.destroy(),this.infoForm.destroy(),this.docForm.destroy(),this.statusPanel.destroy(),this.studentVerification=null,this.countries=null,this._parent(),this.container=null},_updateSubmitButtonState(e){this.submitButton.setDisabled(!e.validate({silent:!0}))},_resetVerificationModel(){return this.studentVerification.unset(d.Fields.VERIFICATION_ID),this.studentVerification.fetchVerification()},_waitForStepChange(e){return new Promise((t,i)=>{const n=setInterval(async()=>{this.studentVerification.fetchVerification().then(()=>{this.studentVerification.getCurrentStep()!==e&&(clearInterval(n),t())}).catch(e=>{clearInterval(n),i(e)})},2e3)})},_renderCurrentStep(){const e=this.studentVerification.getCurrentStep();let t,i,n;if(e===c.COLLECT_STUDENT_INFO)i=p.get("submit"),t=this.infoForm.render(),n=this.infoForm.getVerificationErrorMessage(),this._updateSubmitButtonState(this.infoForm);else if(e===c.DOC_UPLOAD)i=p.get("submit"),t=this.docForm.clear().render(),n=this.docForm.getRejectionMessage(),this._updateSubmitButtonState(this.docForm);else if(e===c.PENDING||e===c.SSO){const n=this.studentVerification.get(d.Fields.AWAITING_STEP);i=e!==c.SSO||n?p.get("checkStatus"):p.get("goToLogin"),t=this.statusPanel.render()}else e===c.ERROR?(i=this.studentVerification.isErrorRecoverable()?p.get("proceed"):p.get("cancel"),t=this.statusPanel.render()):(i=p.get("proceed"),t=this.statusPanel.render());this.modal.setBody([this.alert,t]),this.submitButton.setValue(i),n&&this.alert.add({className:"error",message:n}).show()},_createModal(e){return new s({closable:!0,overlay:!0,header:p.get("studentStatusVerification"),footer:e,events:{onHide:this.dispatchEvent.bind(this,S.ON_HIDE)}})},_createAlert:()=>new o({autoHide:!1,closable:!0,closeOnClick:!0,visible:!1}),_createInfoForm(){return new u({studentVerification:this.studentVerification,countries:this.countries,orgSearchUrl:this.orgSearchUrl})},_createDocForm(){return new h({studentVerification:this.studentVerification})},_createStatusPanel(){return new f({studentVerification:this.studentVerification})},_createSsoLinkPanel:()=>new m,_createSubmitButton(){return new n({className:"primary",events:{onClick:this.submit.bind(this)}})}});return g.Events=Object.freeze(S),g}),define("DS/MPFUserVerificationComponent/VerificationHandler",["UWA/Class","UWA/Class/Listener","DS/UIKIT/Mask","DS/MPFConnector/MarketplaceConnector","DS/MPFConnector/SheerIdConnector","DS/MPFServices/MarketplaceServices","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFPersonModel/PersonFactory","DS/MPFCountryModel/CountryFactory","DS/MPFSheerIdVerificationModel/SheerIdVerificationModel","DS/MPFSheerIdVerificationModel/SheerIdProgramModel","DS/MPFSheerIdVerificationModel/VerificationSteps","DS/MPFUserVerificationComponent/VerificationModal"],function(e,t,i,n,s,r,o,a,c,d,l,u,h){"use strict";const f=e.extend();return f.verifyUser=function({programId:e,container:f,verificationId:m,user:p,countries:S,service:g=r.CLICK_AND_BUY,onComplete:I=(()=>{})}){i.mask(f);const V=new s,E=new l({[l.Fields.PROGRAM_ID]:e},{connector:V});return n.fetchPromise({service:g}).then(e=>{const t=o.getInstance(e);return Promise.all([function(e,t){return t&&t.get("id")?Promise.resolve(t):e.getFactory(o.Types.PERSON).then(e=>(t=e.createModel(a.Types.ME)).fetchPromise())}(t,p),function(e,t){return t&&t.size&&t.size()>0?Promise.resolve(t):e.getFactory(o.Types.COUNTRY).then(e=>(t=e.createCollection(c.Types.BUYER)).fetchPromise())}(t,S),function(e,t){return t.getProgramId()?Promise.resolve(t):t.fetchProgramId(e)}(e,E)])}).then(([e,n,s])=>{const r=new d({[d.Fields.FIRST_NAME]:e.getFirstName(),[d.Fields.LAST_NAME]:e.getLastName(),[d.Fields.EMAIL]:e.getEmail(),[d.Fields.PROGRAM_ID]:s.getProgramId(),[d.Fields.TRACKING_ID]:e.get("id"),[d.Fields.VERIFICATION_ID]:m},{connector:V});return r.fetchVerification().then(()=>{if(r.getCurrentStep()!==u.SUCCESS)return s.fetchProgramTheme().then(()=>{i.unmask(f);const e=new h({studentVerification:r,countries:n,orgSearchUrl:s.getOrgSearchUrl()}),o=new t;return o.listenToOnce(e,h.Events.ON_VERIFIED,()=>{e.hide(),I(r)}),o.listenToOnce(e,h.Events.ON_HIDE,()=>{e.destroy()}),e.render().inject(f),e.show(),e});i.unmask(f),I(r)})})},f});