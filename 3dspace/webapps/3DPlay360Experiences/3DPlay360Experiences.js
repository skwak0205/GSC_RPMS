define("DS/3DPlay360Experiences/MediaLoader",["UWA/Class"],function(i){"use strict";return i.extend({init:function(i){this._parent(i)},dispose:function(){},img:function(i){var t=null;return i&&i.format&&i.path&&(t=new Promise(function(t,e){var n=document.createElement("img");n.crossOrigin="use-credentials",n.onload=function(){var e={format:i.format,fullPanoWidthPixels:n.width,fullPanoHeightPixels:n.height},o={width:n.width,height:n.height};t({img:n,imgData:e,size:o})}.bind(this),n.onerror=function(i){e({error:i})}.bind(this),n.src=i.path}.bind(this))),t},video:function(i){var t=null;return i&&i.format&&i.path&&(t=new Promise(function(t,e){var n=document.createElement("video");n.crossOrigin="use-credentials",n.src=i.path,t({video:n})}.bind(this))),t}})}),define("DS/3DPlay360Experiences/DirectionIndicatorSwitch",["UWA/Class","css!DS/3DPlay360Experiences/Img360CurvedLayout.css","DS/3DPlayAnnotationUtils/CurvedLayout","DS/Core/PointerEvents","text!DS/3DPlay360Experiences/assets/templates/directionIndicator.hbs"],function(i,t,e,n,o){"use strict";var a,r=null,s=[];return i.extend({init:function(i){a=this,s=i.directionIndicatorArray,r=i.directionIndicatorArray.length,this.UIFrame=i.frmWindow.getUIFrame(),this.mainDiv=null,this._createMainDiv(),i.iData&&this._setSwitchCB(i.iData),this._createCurvedUI(i.frmWindow),this._injectDiUi()},_injectDiUi:function(){this.mainDiv.innerHTML=o},_createMainDiv:function(){this.mainDiv=new UWA.Element("div",{class:"direction-indicator-main-div"}).inject(a.UIFrame),this.mainDiv.addEvent("click",function(){a._showCurvedUI()})},_setProjectionType:function(i){s.forEach(function(t){t.id&&t.id.toString()===i&&a._projTypeChangeCB&&(a._projTypeChangeCB(t.id),a._hideCurvedUI())})},_showCurvedUI:function(){a.curvedUIOuterDiv.style.transition="right 0.6s ease",a.curvedUIOuterDiv.style.right="0px"},_hideCurvedUI:function(){a.curvedUIOuterDiv.style.transition="right 0.6s ease",a.curvedUIOuterDiv.style.right=-a.curvedUIOuterDiv.clientWidth+"px",a.curvedUIOuterDiv.style.left=""},_createCurvedUI:function(i){var t=function(){a._setProjectionType(this.id),a._hideCurvedUI()};a.curvedUIOuterDiv=new UWA.Element("div",{class:"i360-curved-ui-outer-div"}).inject(a.UIFrame);var o=new UWA.Element("div",{id:"curvedUI",class:"i360-curved-ui"}).inject(a.curvedUIOuterDiv);return setTimeout(function(){for(var h=new e({childCount:r,containerElement:o,layoutOpts:{containerHeight:o.clientHeight,containerWidth:o.clientWidth,offsetX:10,offsetY:0}}),l=0;l<s.length;++l){var c=UWA.createElement("img",{src:s[l].icon,id:s[l].id,class:"i360-curved-ui-element"}).inject(h.contentArray[l]);c.addEvent("click",t),c.addEvent("touchstart",t),a.mainDiv?a.curvedUIOuterDiv.style.top=a.mainDiv.offsetTop-a.mainDiv.offsetHeight+"px":a.curvedUIOuterDiv.style.top="100px",a._hideCurvedUI()}this.proxyEventTarget=i.getViewerFrame(),this.proxyEventTarget.addEvent(n.POINTERDOWN,function(i){"i360-curved-ui-element"===i.srcElement.className&&"i360-curved-ui-element"===i.target.className||a._hideCurvedUI()})},0),a.curvedUIOuterDiv},resetCurvedUIDiv:function(i){a.mainDiv&&(a.curvedUIOuterDiv.style.top=a.mainDiv.offsetTop-a.mainDiv.offsetHeight+"px",a.curvedUIOuterDiv.style.transition="top .2s ease-in")},_setSwitchCB:function(i){this._projTypeChangeCB=i.func},_removeSwitchCB:function(){this._projTypeChangeCB=null},destroy:function(){this.curvedUIOuterDiv.remove(),this.curvedUIOuterDiv=void 0,this.mainDiv.remove(),this.mainDiv=void 0,this._removeSwitchCB(),this.projType=void 0,this.UIFrame=void 0,r=void 0,s=void 0,a=void 0}})}),define("DS/3DPlay360Experiences/MediaAbstractViewerController",["UWA/Class","DS/Visualization/WebGLV6Viewer","DS/Visualization/Node3D","DS/Visualization/Viewpoint"],function(i,t,e,n){"use strict";return i.extend({init:function(i){this._trackball=null,this._directionIndicator=null,this._viewer=null,this._viewpoint=null,this._node=null,this.initViewer(i.viewer,i.div)},dispose:function(){this.stoptrackBall(),this.cleanViewer(),this._trackball.dispose(),this._trackball=null,this._directionIndicator=null,this._viewer=null,this._viewpoint=null,this._node=null},viewer:function(){return this._viewer},viewpoint:function(){return this._viewpoint},trackBall:function(){return this._trackball},directionIndicator:function(){return this._directionIndicator},createTrackball:function(){return null},reframe:function(){return null},_createNode:function(){return null},activate:function(i){this.activateTrackball({iViewer:this.viewer(),iViewpoint:this.viewpoint(),imgSize:i}),this.showIndicator&&this.showIndicator(),this.reframe()},initViewer:function(i,t){if(this._viewer=i||null,!this._viewer){var e=this.createViewer(t);this._viewer=e.viewer}this._viewer&&(this._viewpoint=this._viewer.currentViewpoint),this._viewer&&this._viewpoint&&this.customizeViewer(this._viewer,this._viewpoint)},cleanViewer:function(){this.cleanNodes(),this._viewer=null,this._viewpoint=null},createViewer:function(i){var o=new t({div:i,mobile:!0,useShadowMap:!1,infinitePlane:!1,displayGrid:!1,backgroundColor:16777215});o.setRenderMode("@Edge",!0);var a=new e;o.addNode(a);var r=new n(o);return r.onMove(o.render),o.addViewpoint(r),{viewer:o,viewpoint:r}},customizeViewer:function(i,t){if(i&&t){i.displayGrid=!1,i.infinitePlane=!1,i.setBackgroundColor(16777215),i.setShadow(!1),t.setProjectionType(0),i.setDefaultPicking(!1),i.setPicking({activated:!1},!1),i.setPrePicking({activated:!1},!1),i.setManipulators({activated:!1,preActivate:!1});var e=t.getControl();e&&(e.lockZ=!0,e.setRotationInertia({mouse:!0,touch:!0}),e.setZoomActive(!0),e.setPanActive(!0)),i.setReferenceAxisSystem(!0),i.setReferenceAxisSystem(!1),i.setCursor("Grab",0,!1)}},activateTrackball:function(i){i.iViewer&&i.iViewpoint&&(this._trackball||(this._trackball=this.createTrackball(i.imgSize)),this._trackball&&this._trackball.activate(i.iViewpoint))},_deactivateTrackball:function(){this._trackball&&this._trackball.deactivate()},stoptrackBall:function(){this._trackball&&this._trackball.stop()},node:function(){return this._node||(this._node=this._createNode(),this.viewer().getRootNode().addChild(this._node)),this._node},cleanNodes:function(){this._node&&(this.viewer().getRootNode().remove(this._node),this._node=null)}})}),define("DS/3DPlay360Experiences/shaderFactory360",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(i,t){"use strict";return i.extend({init:function(i){this._parent(i)},getFlippedTextureMaterial:function(i){var e=new t.MeshBasicMaterial({force:!0,side:t.DoubleSide,forceSide:!0});e.activatePDSFX();var n={uSampler:{type:"t2",value:i}};e.setPDSFXUniforms(n);e.setPDSFXVaryings({vUV:{type:"v2"}});var o={ComputeVaryingValues:["void ComputeVaryingValues() {","vec2 _uv = vGetAttribTexCoord0().xy;","vUV =vec2(1.0-_uv.x,1.0-_uv.y);","}"].join("\n")},a={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = texture2D(uSampler, vec2(vUV.s, vUV.t));","#ifndef GAMMA_OUTPUT","ioFinalColor.xyz *= ioFinalColor.xyz;","#endif","ioFinalColor = vec4(1.0,0.0,0.0,1.0)","}"].join("\n")};return e.setPDSFXOverridableFunctions(o,a),e},getEdgeMaterial:function(i){return this.getTextureForFilterMaterial(i,{kernel:[-1,-1,-1,-1,8,-1,-1,-1,-1],kernelDim:3})},getBlurMaterial:function(i){return this.getTextureForFilterMaterial(i,{kernel:[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9],kernelDim:3,effectRadius:10})},getTextureForFilterMaterial:function(i,e){var n=e.kernel||null,o=e.kernelDim||null,a=Math.floor((o-1)/2),r=e.effectRadius||10,s=e.applyOnAllImage||!1,h=new t.MeshBasicMaterial({force:!0,side:t.DoubleSide,forceSide:!0});h.activatePDSFX();var l={uSampler:{type:"t2",value:i},fullPanoWidthPixels:{type:"f",value:1},fullPanoHeightPixels:{type:"f",value:1},croppedAreaImageWidthPixels:{type:"f",value:1},croppedAreaImageHeightPixels:{type:"f",value:1},croppedAreaLeftPixels:{type:"f",value:0},croppedAreaTopPixels:{type:"f",value:0},kernelMatrix:{type:"fv1",value:n,length:o*o},effectRadius:{type:"f",value:r},applyEffect:{type:"f",value:0}};h.setPDSFXUniforms(l);h.setPDSFXVaryings({vUV:{type:"v2"}});var c={ComputeVaryingValues:["void ComputeVaryingValues() {","vec2 _uv = vGetAttribTexCoord0().xy;","vec2 uvF=vec2(1.0-_uv.x,1.0-_uv.y);","mat2 scale2Inv=mat2(fullPanoWidthPixels/croppedAreaImageWidthPixels, 0.0, 0.0, fullPanoHeightPixels/croppedAreaImageHeightPixels);","vec2 trans2=vec2((croppedAreaLeftPixels/fullPanoWidthPixels), ((fullPanoHeightPixels-croppedAreaTopPixels-croppedAreaImageHeightPixels)/fullPanoHeightPixels));","vUV=scale2Inv*(uvF-trans2);","}"].join("\n")},u={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","float x=vUV.x;","float y=vUV.y;","float tx=100.0/fullPanoWidthPixels;","float ty=100.0/fullPanoHeightPixels;","float minDX=min(vUV.x-tx, (1.0-tx)-vUV.x);","float minDY=min(vUV.y-ty, (1.0-ty)-vUV.y);","float minD=min(minDX, minDY);","if(applyEffect>0.0 && (minD<0.0 || "+s+"))","{","vec2 uvToUse=vUV;","float blurRadius="+(s?"effectRadius;":"effectRadius*(min(-minD/max(tx,ty),1.0));"),"float hStep=blurRadius/fullPanoWidthPixels;","float vStep=blurRadius/fullPanoHeightPixels;","vec4 sum = vec4( 0.0 );","for(int j=0; j<"+o+"; j++)","{","for(int i=0;i<"+o+";i++)","{","sum += kernelMatrix[i*"+o+"+j]*texture2D( uSampler, vec2( uvToUse.x - (float(i-"+a+"))*hStep, uvToUse.y - (float(j-"+a+"))*vStep ));","}","}","sum.a = 1.0;","ioFinalColor = sum;","}","else","{","ioFinalColor = texture2D(uSampler, vec2(vUV.s, vUV.t));","}","#ifndef GAMMA_OUTPUT","ioFinalColor.xyz *= ioFinalColor.xyz;","#endif","}"].join("\n")};return h.setPDSFXOverridableFunctions(c,u),h},getTextureForTilesMaterial:function(i,e){var n=new t.MeshBasicMaterial({force:!0,side:t.DoubleSide,forceSide:!0});n.activatePDSFX();var o={uSampler:{type:"t2",value:i},fullPanoWidthPixels:{type:"f",value:1},fullPanoHeightPixels:{type:"f",value:1},croppedAreaImageWidthPixels:{type:"f",value:1},croppedAreaImageHeightPixels:{type:"f",value:1},croppedAreaLeftPixels:{type:"f",value:0},croppedAreaTopPixels:{type:"f",value:0}};n.setPDSFXUniforms(o);n.setPDSFXVaryings({vUV:{type:"v2"}});var a={ComputeVaryingValues:["void ComputeVaryingValues() {","vec2 _uv = vGetAttribTexCoord0().xy;","vec2 uvF=vec2(1.0-_uv.x,1.0-_uv.y);","mat2 scale2Inv=mat2(fullPanoWidthPixels/croppedAreaImageWidthPixels, 0.0, 0.0, fullPanoHeightPixels/croppedAreaImageHeightPixels);","vec2 trans2=vec2((croppedAreaLeftPixels/fullPanoWidthPixels), ((fullPanoHeightPixels-croppedAreaTopPixels-croppedAreaImageHeightPixels)/fullPanoHeightPixels));","vUV=scale2Inv*(uvF-trans2);","}"].join("\n")},r={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = texture2D(uSampler, vec2(vUV.s, vUV.t));","#ifndef GAMMA_OUTPUT","ioFinalColor.xyz *= ioFinalColor.xyz;","#endif","}"].join("\n")};return n.setPDSFXOverridableFunctions(a,r),n}})}),define("DS/3DPlay360Experiences/DirectionIndicatorAbstract",["UWA/Class","DS/Core/Events","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/WebSystem/Rsc","text!DS/3DPlay360Experiences/assets/templates/directionIndicator.hbs","css!DS/3DPlay360Experiences/directionIndicator.css"],function(i,t,e,n,o,a,r){"use strict";return i.extend({init:function(i){var t=this;this._view=null,this._angle=0,this._height=0,this._radius=0,this._light=null,this._viewpointChangeToken=null,this._viewpoint=null,this.id=i.id,o.rsc("3DPlay360Experiences/3DPlay360Experiences",{iconName:this.iconName,iconSize:"Normal"},function(e){t.icon=e,i.callback()})},getDirectionIndicatorData:function(){return{id:this.id,icon:this.icon}},show:function(){this._getView(),this.showIndicator()},hide:function(){this._detachVP(),this._hideIndicator()},_getView:function(){if(null===this._view){var i=document.createElement("div");this._view=i}return this._view&&this._view.classList.add("directionIndicator"),this._view},_getLight:function(){return this._light||this._getView()&&(this._light=document.querySelector("#light")),this._light},_getOuterContainer:function(){return this._outerContainer||this._getView()&&(this._outerContainer=document.querySelector("#indicatorOuterContainer")),this._outerContainer},_getContainer:function(){return this._container||this._getView()&&(this._container=document.querySelector("#indicatorContainer")),this._container},_getNorth:function(){return this._north||this._getView()&&(this._north=document.querySelector("#north")),this._north},getAngle:function(){return this._angle},setAngle:function(i){i&&(this._angle=i)},getHeight:function(){return this._height},setHeight:function(i){i&&(this._height=i)},getWidth:function(){return this._width},setWidth:function(i){i&&(this._width=i)},radius:function(){return this._radius},setRadius:function(i){i&&(this._radius=i)},attachTo:function(i){i&&i!==this._viewpoint&&(this._detachVP(),this._viewpoint=i),this._addVPChangeListener()},_detachVP:function(){this._removeVPChangeListener(),this._viewpoint=null},_addVPChangeListener:function(){null===this._viewpointChangeToken&&(this._viewpointChangeToken=t.subscribe({event:"/VISU/"},this._viewpointChangeCB.bind(this)))},_removeVPChangeListener:function(){this._viewpointChangeToken&&(t.unsubscribe(this._viewpointChangeToken),this._viewpointChangeToken=null)},_viewpointChangeCB:function(i){if(i&&"@onViewpointChange"===i.eventType&&i.viewpoint&&i.viewpoint==this._viewpoint){var t=i.viewpoint.getSightDirection().clone(),e=i.viewpoint.getCamera().height/i.viewpoint.viewer.SCREEN_HEIGHT*100,o=i.viewpoint.getCamera().width/i.viewpoint.viewer.SCREEN_WIDTH*100;t.normalize(),t.projectOnPlane(new n.Vector3(0,0,1));var a=t.length(),r=new n.Vector3(1,0,0).length()*a,s=Math.acos(t.x/r);t.y<0&&(s=2*Math.PI-s),this.setAngle(s),this.setRadius(a),this.setHeight(e),this.setWidth(o);var h=i.viewpoint.getCamera().x/i.viewpoint.getCamera().fullWidth*100,l=i.viewpoint.getCamera().y/i.viewpoint.getCamera().fullHeight*100;this._updateLight(h,l)}},destroy:function(){this._view=null,this._angle=null,this._radius=null,this._light=null,this._viewpointChangeToken=null,this._viewpoint=null,this.id=null,this.icon=null}})}),define("DS/3DPlay360Experiences/mathUtils360",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(i,t){"use strict";return i.extend({init:function(i){this._parent(i)},getSPhericalCoordinates:function(i){var t=null,e=null,n=null;i&&((t=i.length())>0&&(e=Math.acos(i.z),n=Math.atan2(i.y,i.x)));return{r:t,theta:n,phi:e}},getSPhericalFromCartesian:function(i){var t;return{r:t=Math.sqrt(i.x*i.x+i.y*i.y+i.z+i.z),theta:Math.atan(i.y/i.x),phi:Math.acos(i.z/t)}},getCartesianCoord:function(i){var e=i.r>0?i.r:0,n=i.theta,o=i.phi;return new t.Vector3(e*Math.sin(o)*Math.cos(n),e*Math.sin(o)*Math.sin(n),e*Math.cos(o))},ur:function(i){var e=i.theta,n=i.phi;return new t.Vector3(1*Math.sin(n)*Math.cos(e),1*Math.sin(n)*Math.sin(e),1*Math.cos(n))},uTheta:function(i){var e=i.theta;i.phi;return new t.Vector3(-1*Math.sin(e),1*Math.cos(e),0)},uPhi:function(i){var e=i.theta,n=i.phi;return new t.Vector3(1*Math.cos(n)*Math.cos(e),1*Math.cos(n)*Math.sin(e),-1*Math.sin(n))}})}),define("DS/3DPlay360Experiences/ImgData",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(i,t){"use strict";return i.extend({init:function(i){this._src=null,this._img=null,this._imgGeomData=null,this._isReady=!1,this._parent(i)},setImg:function(i){this._img=i},img:function(){return this._img},setGeomData:function(i){i&&(this._imgGeomData=i,this._imgGeomData.croppedAreaImageWidthPixels=i.fullPanoWidthPixels,this._imgGeomData.croppedAreaImageHeightPixels=i.fullPanoHeightPixels,this._imgGeomData.croppedAreaLeftPixels=null!==i.croppedAreaLeftPixels?i.croppedAreaLeftPixels:.5*(i.fullPanoWidthPixels-i.croppedAreaImageWidthPixels),this._imgGeomData.croppedAreaTopPixels=null!==i.croppedAreaTopPixels?i.croppedAreaTopPixels:.5*(i.fullPanoHeightPixels-i.croppedAreaImageHeightPixels))},geomData:function(){return this._imgGeomData?this._imgGeomData:null},readyCB:function(i){this._readyCB=i},isReady:function(){return this._isReady},activate:function(){return this._isReady?Promise.resolve(this):this._checkImg(this._img).then(function(i){return this._isReady=!0,Promise.resolve(this)}.bind(this)).catch(function(i){console.log(i)})},dispose:function(){this.reset()},reset:function(){this._isReady=!1,this._readyCB=null,this._src=null,this._img=null,this._imgGeomData=null},thetaPhiForPixel:function(i){var t=this.geomData(),e=null,n=null;if(i&&t){var o=i.x,a=i.y;t.fullPanoWidthPixels>0&&t.fullPanoHeightPixels>0&&(e=2*Math.PI/t.fullPanoWidthPixels*o-Math.PI,n=-Math.PI/t.fullPanoHeightPixels*a+Math.PI)}return{theta:e,phi:n}},pixelForThetaPhi:function(i){var t=this.geomData(),e=null,n=null;if(i&&t){var o=i.theta,a=i.phi;t.fullPanoWidthPixels>0&&t.fullPanoHeightPixels>0&&(e=t.fullPanoWidthPixels/(2*Math.PI)*(o+Math.PI),n=t.fullPanoHeightPixels/-Math.PI*(a-Math.PI))}return{px:e,py:n}},computeImgRangeInSphericalCoord:function(){var i=this.geomData(),t=null;if(i){var e=i.croppedAreaLeftPixels,n=i.croppedAreaLeftPixels+i.croppedAreaImageWidthPixels,o=i.fullPanoHeightPixels-i.croppedAreaTopPixels-i.croppedAreaImageHeightPixels,a=i.fullPanoHeightPixels-i.croppedAreaTopPixels;(t={}).thetaMax=this.thetaPhiForPixel({x:n,y:0}).theta+.75,t.thetaMin=this.thetaPhiForPixel({x:e,y:0}).theta-.75,t.phiMin=this.thetaPhiForPixel({x:0,y:a}).phi+.9,t.phiMax=this.thetaPhiForPixel({x:0,y:o}).phi-.9}return t},computeMiddlePointSphericalCoord:function(){var i=this.geomData(),e=null;if(i){var n=i.croppedAreaLeftPixels,o=i.croppedAreaLeftPixels+i.croppedAreaImageWidthPixels,a=i.fullPanoHeightPixels-i.croppedAreaTopPixels-i.croppedAreaImageHeightPixels,r={x:n+(o-n)/2,y:a+(i.fullPanoHeightPixels-i.croppedAreaTopPixels-a)/2},s=this.thetaPhiForPixel(r,i);e=new t.Vector2(s.theta,s.phi)}return e},_checkImg:function(i){return new Promise(function(t,e){i?(i.complete&&t(i),i.onload=function(){t(i)}):e("_checkImg")}.bind(this))}})}),define("DS/3DPlay360Experiences/TrackballAbstractControl",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/VisuEvents/EventsManager","DS/Core/Events","DS/VisuEvents/ScreenEvent","DS/3DPlay360Experiences/mathUtils360","DS/WebSystem/Environment"],function(i,t,e,n,o,a,r,s,h){"use strict";var l;return i.extend({init:function(i){this._userExpConfig={inertia:{minVelocity:.1,tau:.3,toleranceAngle:5,dtStationary:.1},rotation:{speedRadius:1e3,toleranceAngle:50},zoom:{minFovDeg:0,maxFovDeg:130,toleranceAngle:5,rightClickScalingAcceleration:.015},elasticReturn:{animDuration:75}},this.checkSize(i.size),this._viewpoint=null,this._animation=null,this._VisuEventsManagerTokens=null,this._basicEventToken=null,this._kinematicConstraints=null,this._applyKinematicConstraints=!i||void 0===i.applyKinematicConstraints||i.applyKinematicConstraints,this._inertianAnim=null,this._inertia=!i||void 0===i.inertia||i.inertia,this._currT=-1,this._angularVelocity={vTheta:null,vPhi:null},this._velocity={x:null,y:null},l=this;var e=void 0!==window.devicePixelRatio?window.devicePixelRatio:1;this.viewerHeight=t.glStates.currentHeight/e,this.viewerWidth=t.glStates.currentWidth/e,h.isSet("3DPlay.GyroscopeEvents")&&(this._gyroInfo={activated:!1,supported:!!window.DeviceOrientationEvent&&window.DeviceOrientationEvent,alpha:null,beta:null,gamma:null,get orientation(){return l.getDeviceOrientation()}}),this._zoomCoeff=null,this._onZoomCB=null,i&&(this._viewpoint=i.viewpoint||null),this._parent(i)},dispose:function(){this.clear(),this._userExpConfig=null,this._viewpoint=null,this._animation=null,this._VisuEventsManagerTokens=null,this._basicEventToken=null,this._kinematicConstraints=null,this._applyKinematicConstraints=null,this._inertianAnim=null,this._inertia=null,this._currT=null,this._angularVelocity=null,this._gyroInfo=null,this._zoomCoeff=null,this._onZoomCB=null,this._viewpoint=null,l=null,this._parent()},checkSize:function(i){"object"==typeof i.imgSize?i.imgSize.height>1024&&i.imgSize.width>2048?this.defaultZoom=!0:this.defaultZoom=!1:0!=i.imgSize&&i.imgSize<100?this.defaultZoom=!1:this.defaultZoom=!0},setApplyConstraints:function(i){!0===i&&!1===this._applyKinematicConstraints&&this._kinematicConstraints&&(this._applyKinematicConstraints=!0,this._animateBackToBestViewpointCompliantWithConstraints()),this._applyKinematicConstraints=i},applySphericalConstraints:function(){return this._applyKinematicConstraints},clear:function(){this.stop(),this._onZoomCB=null,this._animation=null,this._basicEventToken=null,this._kinematicConstraints=null,this._viewpoint=null,this._applyKinematicConstraints=!0,this._inertia=!0,this._currT=-1,this._angularVelocity={vTheta:null,vPhi:null},l=null},activate:function(i){l=this,i&&(this._setViewpoint(i),this.overloadScreenControls(),this.subscribeToUserInteractions(),h.isSet("3DPlay.GyroscopeEvents")&&this.activateGyro())},deactivate:function(){this.stopAnimation(),this.stopInertia(),h.isSet("3DPlay.GyroscopeEvents")&&this.stopGyro();var i=this._viewpoint.getControl();this.resetScreenControls(i),this.unsubscribeFromUserInteractions()},stop:function(){this.stopAnimation(),this.stopInertia(),h.isSet("3DPlay.GyroscopeEvents")&&this.stopGyro(),this._setViewpoint(null),this.resetScreenControls(),this.unsubscribeFromUserInteractions()},onZoomCB:function(i){this._onZoomCB=i},_setViewpoint:function(i){this._viewpoint=i},viewpoint:function(){return this._viewpoint},inertia:function(){return this._inertia},setInertia:function(i){!1!==i&&this.stopInertia(),this._inertia=i},computeMaxHFovGivenConstraints:function(){var i=null;if(this._applyKinematicConstraints){var t=this._kinematicConstraints,e=t.thetaMax-t.thetaMin,n=t.phiMax-t.phiMin;e=Math.min(e,this.hFov(n));var o=this._userExpConfig.zoom.toleranceAngle;i=180*e/Math.PI-o}return i},activateGyro:function(){this._gyroInfo.alpha=null,this._gyroInfo.beta=null,this._gyroInfo.gamma=null,this._gyroInfo.supported?(console.log("browser Supported"),window.top.addEventListener("deviceorientation",l.onDeviceOrientationEvent,!0),window.top.addEventListener("devicemotion",l.onDeviceMotionEvent,!0),window.top.addEventListener("MozOrientation",function(i){console.log(i),console.log(50*orientation.x,50*orientation.y)},!0)):console.log("Gyroscope not supported on this browser version")},stopGyro:function(){this._gyroInfo.alpha=null,this._gyroInfo.beta=null,this._gyroInfo.gamma=null,this._gyroInfo.supported&&window.top.removeEventListener("deviceorientation",l.onDeviceOrientationEvent,!0)},getDeviceOrientation:function(){var i=null;switch(window.matchMedia("(orientation: portrait)").matches&&console.log("you're in PORTRAIT mode"),window.matchMedia("(orientation: landscape)").matches&&console.log("you're in LANDSCAPE mode"),void 0!==window.orientation?i=window.orientation:console.log("This browser does not support device orientation"),window.orientation){case 0:console.log("UP");break;case 90:case-90:break;case 180:console.log("DOWN")}return i},onDeviceOrientationEvent:function(i){if(console.log("onDeviceOrientationEvent"),i){console.log(event.gamma),console.log(event.target.screen.orientation.type,event.target.screen.orientation.angle);var e=Math.PI/180,n=event.alpha*e,o=-event.beta*e,a=event.gamma*e,r=new t.Vector3(1,0,0),h=new s,c=null;if(null!=l._gyroInfo.alpha&&null!=l._gyroInfo.beta&&null!=l._gyroInfo.gamma){var u=new t.Vector3(l._gyroInfo.alpha,l._gyroInfo.beta,l._gyroInfo.gamma,"ZXY"),p=(new t.Quaternion).setFromEuler(u),d=r.clone().applyQuaternion(p);c=h.getSPhericalCoordinates(d)}var g=new t.Vector3(n,o,a),v=(new t.Quaternion).setFromEuler(g),m=r.clone().applyQuaternion(v),f=h.getSPhericalCoordinates(m);if(c)f.theta,c.theta,f.phi,c.phi;l._gyroInfo.alpha=n,l._gyroInfo.beta=o,l._gyroInfo.gamma=a}},onDeviceMotionEvent:function(i){if(i.acceleration&&null!=i.acceleration.x&&0!=i.acceleration.x&&null!=i.acceleration.y&&0!=i.acceleration.y){console.log(i),console.log(i.acceleration);var e=new t.Vector3(1,0,0),n=new s,o=new t.Vector3(2*i.acceleration.x,2*i.acceleration.y,0),a=(new t.Quaternion).setFromEuler(o),r=e.clone().applyQuaternion(a),h=n.getSPhericalFromCartesian(r),c=n.getSPhericalCoordinates(l._viewpoint.getSightDirection().clone().normalize());if(c){var u=c.theta-h.theta,p=c.phi-h.phi;console.log(h);var d={x:h.r*Math.sin(h.phi)*Math.cos(h.theta),y:h.r*Math.sin(h.phi)*Math.sin(h.theta),z:h.r*Math.cos(h.phi)};console.log(d),l.setViewpointForRotation({dTheta:u,dPhi:p})}else console.log("no recoard found")}else console.log("no acceleration")},onUserEndScreenInteraction:function(i){i.from[0].view.className.includes("indicator")||i.from[0].view.className.includes("curved")||this._inertia&&this.applyInertia.call(this)},onUserStartScreenInteraction:function(){this.stopInertia()},subscribeToUserInteractions:function(){this._VisuEventsManagerTokens=[],this._VisuEventsManagerTokens.push(o.addEvent(document,"onLeftMouseUp",this.onUserEndScreenInteraction.bind(this))),this._VisuEventsManagerTokens.push(o.addEvent(document,"onRelease",this.onUserEndScreenInteraction.bind(this))),this._VisuEventsManagerTokens.push(o.addEvent(document,"onTap",this.onUserEndScreenInteraction.bind(this))),this._VisuEventsManagerTokens.push(o.addEvent(document,"onLeftMouseDown",this.onUserStartScreenInteraction.bind(this))),this._VisuEventsManagerTokens.push(o.addEvent(document,"onRightMouseDown",this.onUserStartScreenInteraction.bind(this))),this._VisuEventsManagerTokens.push(o.addEvent(document,"onTouch",this.onUserStartScreenInteraction.bind(this)))},unsubscribeFromUserInteractions:function(){if(this._VisuEventsManagerTokens){for(var i=this._VisuEventsManagerTokens.length,t=0;t<i;t++)o.removeEventFromToken(this._VisuEventsManagerTokens[t]);this._VisuEventsManagerTokens=null}},overloadScreenControls:function(i){if(this._viewpoint){this._viewpoint.onReframe(function(){}),this._viewpoint.onCenterCamera(function(){});var t=this._viewpoint.getControl();t&&(t.onPan(function(i){i.defaultBehavior=!1,console.log("onpan")}.bind(this)),t.onZoom(this.zoomFun),t.onRotate(this.rotateFun))}},resetScreenControls:function(i){i&&(i.onPan(null),i.onZoom(null),i.onRotate(null))},setViewpointForSphericalCoord:function(i){if(i&&void 0!==i.theta&&void 0!==i.phi){var t=this.computeViewpointForSphericalCoord({theta:i.theta,phi:i.phi});this._viewpoint.setEyePosition(t.eyePosition),this._viewpoint.setSightDirection(t.sightDirection),this._viewpoint.setUpDirection(t.upDirection)}},setViewpointForRotation:function(i){if(i&&void 0!==i.dTheta&&void 0!==i.dPhi){var t=this._computeViewpointForRotation({dTheta:i.dTheta,dPhi:i.dPhi});this._viewpoint.setEyePosition(t.eyePosition),this._viewpoint.setSightDirection(t.sightDirection),this._viewpoint.setUpDirection(t.upDirection)}},computeAngleForScalingFactor:function(i){console.log(i);var t=null;if(null!==i&&0!==i&&1!==i){var e=this.computeFieldOfViews(this.viewpoint());e&&e.vFov&&(t=2*Math.atan(1/i*Math.tan(e.vFov/2))*180/Math.PI)}return t},computeViewpointForSightDir:function(i){var t=new s,e=t.getSPhericalCoordinates(i),n=this._viewpoint.getSightDirection(),o=t.getSPhericalCoordinates(n),a=e.theta-o.theta,r=e.phi-o.phi;return this._computeViewpointForRotation({dTheta:a,dPhi:r})},computeViewpointForSphericalCoord:function(i){var t=this._viewpoint.getSightDirection(),e=(new s).getSPhericalCoordinates(t),n=i.theta-e.theta,o=i.phi-e.phi;return this._computeViewpointForRotation({dTheta:n,dPhi:o})},_computeViewpointForRotation:function(i){var t=null,e=null,n=null;if(i&&null!==i.dTheta&&null!==i.dPhi){var o=i.dTheta,a=i.dPhi,r=new s,h=r.getSPhericalCoordinates(this._viewpoint.getSightDirection().clone().normalize()),l={r:1,theta:h.theta+o,phi:h.phi+a},c={min:.05,max:Math.PI-.05};l.phi=l.phi<c.min?c.min:l.phi,l.phi=l.phi>c.max?c.max:l.phi,n=this._viewpoint.getEyePosition(),t=r.getCartesianCoord(l),e=r.uPhi(l).multiplyScalar(-1)}return{eyePosition:n,sightDirection:t,upDirection:e}},computeFieldOfViews:function(i){var t=null,e=null;if(i){var n=i.getCamera();if(n){e=n.fov*Math.PI/180;var o=n.aspect;t=2*Math.atan(o*Math.tan(e/2))}}return{hFov:t,vFov:e}},vFov:function(i){var t=null;if(i){var e=this.viewpoint().getCamera();if(e){var n=e.aspect;n&&(t=2*Math.atan(1/n*Math.tan(i/2)))}}return t},hFov:function(i){var t=null;if(i){var e=this.viewpoint().getCamera();if(e){var n=e.aspect;n&&(t=2*Math.atan(n*Math.tan(i/2)))}}return t},getRotationSphericalAngleForScreenDisplacement:function(i){var t=null,e=null;if(i&&void 0!==i.dx&&void 0!==i.dy){var n=this.computeFieldOfViews(this.viewpoint()),o=n.hFov?n.hFov:0,a=n.vFov?n.vFov:0;t=o/this.viewerWidth*i.dx,e=-a/this.viewerHeight*i.dy}return{dTheta:t,dPhi:e}},getDt:function(){var i=0,t=Date.now();return this._currT>0&&(i=(t-this._currT)/1e3),i},updateT:function(){this._currT=Date.now()},stopInertia:function(){this._inertianAnim&&(this._inertianAnim.stop(),this._inertianAnim=null)},applyInertia:function(){this.stopInertia();var i=new t.Vector2;i.x=this._angularVelocity.vTheta,i.y=this._angularVelocity.vPhi;var o=this,a=0,r=new e(0,0,1e3);r.setInterpolator(function(t){var e=o._userExpConfig.inertia.tau,n=(t=1e3*t/1e3)-a;a=t;var r=i,h=r.x,l=r.y,c=h*Math.exp(-t/e),u=l*Math.exp(-t/e),p=new s,d=o._viewpoint.getSightDirection().clone().normalize(),g=p.getSPhericalCoordinates(d);return{theta:g.theta+c*n,phi:g.phi+u*n}});var h={me:this,setOrientation:function(i){this.me.setViewpointForSphericalCoord({theta:i.theta,phi:i.phi})}};this._inertianAnim=new n(h,"setOrientation",r),this._inertianAnim.start()},viewpointAnimationCB:function(i){i&&i.viewpoint&&i.sightDir&&(i.viewpoint.setEyePosition(i.eyePosition),i.viewpoint.setSightDirection(i.sightDir))},stopAnimation:function(){this._basicEventToken&&(a.unsubscribe(this._basicEventToken),this._basicEventToken=null),this._animation&&(this._animation.stop(),this._animation=null)},zoomFun:function(i){i.defaultBehavior=!1;var e=i.evt,n=i.factor,o=i&&i.gesture?i.gesture.getEvents():null,a=i&&i.gesture&&i.gesture.view.length>0&&i.gesture.view[0]?i.gesture.view[0]:null;if(o&&2==o.length){var s,h;if(s=o[0],h=o[1],s&&h&&a){var c=1,u=s.currentPosition,p=h.currentPosition,d=s.lastPosition,g=h.lastPosition,v=new t.Vector2(p.x-u.x,p.y-u.y),m=new t.Vector2(g.x-d.x,g.y-d.y),f=v.length();if(0!=(w=m.length())&&(c=f/w),(D=l.computeFieldOfViews(this.viewpoint))&&D.vFov&&c&&0!=c&&1!=c){var _=2*Math.atan(1/c*Math.tan(D.vFov/2))*180/Math.PI;l._setZoomForAngle(_),this.viewer.render()}}}else if(o&&1==o.length){if((e=o[0])&&null!=e.event)if(e.event.button===r.MouseButton.RIGHT){e.currentPosition,e.lastPosition,c=1,u=e.startPosition,p=e.currentPosition,d=e.startPosition,g=e.lastPosition,v=new t.Vector2(0,p.y-u.y),m=new t.Vector2(0,g.y-d.y),f=v.length();var w=m.length();0!=f&&(c=w/f);_=this.computeAngleForScalingFactor(c);this._setZoomForAngle(_),this.viewer.render()}}else if(null!=n&&0!=n){var D,P=this._viewpoint?this._viewpoint:this.viewpoint,y=180*((D=l.computeFieldOfViews(P)).vFov?D.vFov:0)/Math.PI-n;l._setZoomForAngle(y),this.viewer?this.viewer.render():this._viewpoint.viewer.render()}},rotateFun:function(i){if(console.log("onRotate"),i.defaultBehavior=!1,i&&i.gesture.events&&i.gesture.view&&i.gesture.view.length&&this){l.stopInertia();var t=i.gesture.events,e=i.gesture.view[0],n=t[0].getCurrentPosition?t[0].getCurrentPosition(e):t[0].currentPosition,o=t[0].getLastPosition?t[0].getLastPosition(e):t[0].lastPosition;if(n&&o){var a=n.x-o.x,r=n.y-o.y,s=l.getRotationSphericalAngleForScreenDisplacement({dx:a,dy:r}),h=s.dTheta,c=s.dPhi,u=l.getDt();u>0&&(l._angularVelocity.vTheta=h/u,l._angularVelocity.vPhi=c/u),l.updateT(),l.setViewpointForRotation({dTheta:h,dPhi:c})}l.lastLockZState=this._state}},reframe:function(){},setKinematicConstraints:function(){},startAnimation:function(){}})}),define("DS/3DPlay360Experiences/ImgAbstractViewerController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/3DPlay360Experiences/MediaAbstractViewerController"],function(i,t,e){"use strict";return e.extend({init:function(i){this._parent(i),i.size&&i.size.height&&i.size.width&&(this.nodeDim={height:i.size.height,width:i.size.width}),this._imgData=null},dispose:function(){this._parent()},reframe:function(i){this._reframeOnInitialView(i),this._trackball.reframe()},setImgData:function(i){this._imgData=i},getImgData:function(){return this._imgData},getDirectionIndicatorData:function(){return this._directionIndicator.getDirectionIndicatorData()},hide:function(){this.setDefaultVP(),this._hideNode(),this._deactivateTrackball(),this._hideIndicator()},_hideIndicator:function(){this._directionIndicator.hide()},showIndicator:function(){this._directionIndicator&&this._directionIndicator.show()},_hideNode:function(){this.createdNode&&this.createdNode.setVisibility(!1)},displayDirIndicator:function(){this.viewpoint()&&this._directionIndicator.attachTo(this.viewpoint())},showNode:function(){this.createdNode&&this.createdNode.setVisibility(!0)},build:function(i){var t=this;this._imgMaterial||(console.log("MATERIAL"),this._imgMaterial=this.createMaterial()),this._imgMaterial.setImgData(this.getImgData()).then(function(e){return console.time("[360 perfos] - node Creation"),console.log("NODE : "+t.node().name),console.timeEnd("[360 perfos] - node Creation"),console.time("[360 perfos] - apply material and render"),t.node().setMaterial(e.material()),t.viewer().render(),console.timeEnd("[360 perfos] - apply material and render"),i(),Promise.resolve()})},applyKinematicConstraints:function(){},removeKinematicConstraints:function(){},_computeInitialView:function(){},_reframeOnInitialView:function(){},_getVisiblePixelCoord:function(){},setDefaultVP:function(){}})}),define("DS/3DPlay360Experiences/ImgMaterialAbstract",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/3DPlay360Experiences/shaderFactory360","DS/3DPlay360Experiences/ImgData"],function(i,t,e,n){"use strict";return i.extend({init:function(){this._imgData=null,this._src=null,this._img=null,this._imgMaterial=null},setImgData:function(i){return this._imgData=i,this.activate()},imgData:function(){return this._imgData},material:function(){return this._imgMaterial},activate:function(){return this.imgData().activate().then(function(i){return this._createimgTexture(i.img())}.bind(this)).then(function(i){return this._imgMaterial?this._imgMaterial&&this._updateMaterial(this._imgData,this._imgMaterial,i):this._imgMaterial=this._createimgMaterial(this.imgData(),i),Promise.resolve(this)}.bind(this)).catch(function(i){console.log(i)})},dispose:function(){this.reset()},reset:function(){this._imgMaterial=null,this._src=null,this._img=null,this._imgData=null},_createimgTexture:function(i){return new Promise(function(e,n){var o=null;if(i){var a=document.createElement("canvas");a.width=i.width,a.height=i.height,a.getContext("2d").drawImage(i,0,0);var r=a.toDataURL("image/png");(o=t.ImageUtils.loadTexture(r,void 0,null,null,t.ImageUtils.crossOriginPolicy)).minFilter=t.LinearFilter,o.needsUpdate=!0,o.anisotropy=1024,a=void 0,r=void 0,e(o)}else n("_createimgTexture");o=null}.bind(this))},_createimgMaterial:function(i,n){var o=(new e).getBlurMaterial(n);return o.side=t.BackSide,o.forceSide=!0,o.force=!0,this._updateMaterial(i,o,n),o}})}),define("DS/3DPlay360Experiences/DirectionIndicatorSpherical",["UWA/Class","DS/Core/Events","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/WebSystem/Environment","DS/3DPlay360Experiences/DirectionIndicatorAbstract","css!DS/3DPlay360Experiences/directionIndicatorSpherical.css"],function(i,t,e,n,o,a,r){"use strict";return a.extend({init:function(i){this.iconName="Spherical",this._parent(i)},_hideIndicator:function(){this._getOuterContainer()&&this._getContainer()&&this._getLight()&&(this._getOuterContainer().classList.remove("indicatorOuterContainerSpherical"),this._getContainer().classList.remove("directionIndicatorSpherical"),this._getLight().classList.remove("lightSpherical"),this._getNorth().classList.add("hide"))},showIndicator:function(){this._getOuterContainer()&&this._getContainer()&&this._getLight()&&(this._getOuterContainer().classList.add("indicatorOuterContainerSpherical"),this._getContainer().classList.add("directionIndicatorSpherical"),this._getLight().classList.add("lightSpherical"),this._getNorth().classList.remove("hide"),"white"!==this._getLight().style.backgroundColor&&(this._getLight().style.backgroundColor="white",this._getLight().style.border="2px solid black"),this._getLight().style.height="16px",this._getLight().style.width="16px")},_updateLight:function(){var i=this._getLight();if(i){var t=.6*this._radius,e=this._angle,n=50-50*(t*Math.cos(e)),o=50-50*(t*Math.sin(e));i.style.top=n+"%",i.style.left=o+"%"}}})}),define("DS/3DPlay360Experiences/ImgMaterialPlaner",["DS/3DPlay360Experiences/ImgMaterialAbstract"],function(i){"use strict";return i.extend({init:function(i){this._parent(i)},_updateMaterial:function(i,t,e){if(i&&i.isReady){e&&t.updatePDSFXUniform("uSampler",e);var n=i.geomData();n&&t&&(t.updatePDSFXUniform("fullPanoWidthPixels",n.fullPanoWidthPixels),t.updatePDSFXUniform("fullPanoHeightPixels",n.fullPanoHeightPixels),t.updatePDSFXUniform("croppedAreaImageWidthPixels",n.fullPanoWidthPixels),t.updatePDSFXUniform("croppedAreaImageHeightPixels",n.fullPanoHeightPixels),t.updatePDSFXUniform("croppedAreaLeftPixels",0),t.updatePDSFXUniform("croppedAreaTopPixels",0),t.updatePDSFXUniform("applyEffect",-1)),t.needsUpdate=!0,n=void 0}}})}),define("DS/3DPlay360Experiences/ImgMaterialSpherical",["DS/3DPlay360Experiences/ImgMaterialAbstract"],function(i){"use strict";return i.extend({init:function(i){this._parent(i)},_updateMaterial:function(i,t,e){if(i&&i.isReady){e&&t.updatePDSFXUniform("uSampler",e);var n=i.geomData();n&&t&&(t.updatePDSFXUniform("fullPanoWidthPixels",n.fullPanoWidthPixels),t.updatePDSFXUniform("fullPanoHeightPixels",n.fullPanoHeightPixels),t.updatePDSFXUniform("croppedAreaImageWidthPixels",n.fullPanoWidthPixels),t.updatePDSFXUniform("croppedAreaImageHeightPixels",n.fullPanoHeightPixels),t.updatePDSFXUniform("croppedAreaLeftPixels",0),t.updatePDSFXUniform("croppedAreaTopPixels",0),t.updatePDSFXUniform("applyEffect",1))}}})}),define("DS/3DPlay360Experiences/DirectionIndicatorCylindrical",["UWA/Class","DS/Core/Events","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/WebSystem/Environment","DS/3DPlay360Experiences/DirectionIndicatorAbstract","css!DS/3DPlay360Experiences/directionIndicatorCylindrical.css"],function(i,t,e,n,o,a,r){"use strict";return a.extend({init:function(i){this.iconName="Cylindrical",this._parent(i)},_hideIndicator:function(){this._getOuterContainer()&&this._getContainer()&&this._getLight()&&(this._getOuterContainer().classList.remove("indicatorOuterContainerCylindrical"),this._getContainer().classList.remove("directionIndicatorCylindrical"),this._getLight().classList.remove("lightCylindrical"),this._getLight().style.backgroundColor="white",this._getLight().style.border="2px solid black",this._getNorth().classList.remove("hide"))},showIndicator:function(){this._getOuterContainer()&&this._getContainer()&&this._getLight()&&(this._getOuterContainer().classList.add("indicatorOuterContainerCylindrical"),this._getContainer().classList.add("directionIndicatorCylindrical"),this._getLight().classList.add("lightCylindrical"),this._getNorth().classList.add("hide"),this._getLight().style.height="25px",this._getLight().style.width="13px")},_updateLight:function(){var i=this._getLight();if(i){var t=.6*this._radius,e=this._angle,n=50-50*(t*Math.cos(e));i.style.left=n+"%","50%"!==i.style.top&&(i.style.top="50%"),e<3?(i.style.backgroundColor="black",i.style.border="2px solid white"):e>3&&(i.style.backgroundColor="white",i.style.border="2px solid black")}}})}),define("DS/3DPlay360Experiences/TrackballControlPlane",["DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/VisuEvents/EventsManager","DS/Core/Events","DS/VisuEvents/ScreenEvent","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballAbstractControl","DS/Visualization/ThreeJS_DS"],function(i,t,e,n,o,a,r,s){"use strict";var h=null;return r.extend({init:function(i){i.onDeviceOrientationEvent=this.onDeviceOrientationEvent,this._parent(i),this._applyKinematicConstraints=!1,this._userExpConfig.translation={toleranceDistance:100},h=this},dispose:function(){this._applyKinematicConstraints=null,this._parent(),h=null},setKinematicConstraints:function(i){this._kinematicConstraints={origin:i.origin,width:i.width,height:i.height}},_viewerRect:function(){void 0!==window.devicePixelRatio&&window.devicePixelRatio;return{origin:new s.Vector2(0,0),width:this.viewerHeight,height:this.viewerWidth}},_visibleRect:function(){void 0!==window.devicePixelRatio&&window.devicePixelRatio;var i=this.viewpoint(),t=this.viewerHeight,e=this.viewerWidth,n=void 0!==i.getCamera().width?i.getCamera().width:e,o=void 0!==i.getCamera().height?i.getCamera().height:t,a=void 0!==i.getCamera().x?i.getCamera().x:0,r=void 0!==i.getCamera().y?i.getCamera().y:0;return{origin:new s.Vector2(a,r),width:n,height:o}},_convertVect:function(i,t,e){var n=new s.Vector2;if(i&&t&&e&&t.width>0&&t.height>0&&e.width>0&&e.height>0){var o=e.width/t.width,a=e.height/t.height;(n=i).x=n.x*o,n.y=n.y*a}return n},_interpolatedRect:function(i,t,e,n){var o={origin:t.origin.clone(),width:t.width,height:t.height},a=t.origin.x-i.origin.x,r=t.origin.y-i.origin.y;if(i&&t&&e&&n>0&&0!==a&&0!==r){var s,h=n,l=e.origin.x,c=e.origin.x+e.width,u=e.origin.y,p=e.origin.y+e.height;if(a<0&&i.origin.x+a<l){var d=Math.abs(l-i.origin.x);s=Math.abs(1-d/h),o.origin.x=i.origin.x+a*s}if(r<0&&i.origin.y+r<u){var g=Math.abs(u-i.origin.y);s=Math.abs(1-g/h),o.origin.y=i.origin.y+r*s}if(a>0&&i.origin.x+i.width+a>c){var v=Math.abs(c-(i.origin.x+i.width));s=Math.abs(1-v/h),o.origin.x=i.origin.x+a*s}if(r>0&&i.origin.y+i.height+r>p){var m=Math.abs(p-(i.origin.y+i.height));s=Math.abs(1-m/h),o.origin.y=i.origin.y+r*s}}return o},maxRectInContainer:function(i){var t=null;if(this._kinematicConstraints&&i){if(t={origin:i.origin.clone(),width:i.width,height:i.height},this._kinematicConstraints.width<i.width||this._kinematicConstraints.height<i.height){var e=Math.min(this._kinematicConstraints.width/i.width,this._kinematicConstraints.height/i.height);t.width*=e,t.height*=e}var n=this._kinematicConstraints.origin.x,o=this._kinematicConstraints.origin.x+this._kinematicConstraints.width,a=this._kinematicConstraints.origin.y,r=this._kinematicConstraints.origin.y+this._kinematicConstraints.height;t.origin.x<n&&(t.origin.x=n),t.origin.y<a&&(t.origin.y=a),t.origin.x+t.width>o&&(t.origin.x=o-t.width),t.origin.y+t.height>r&&(t.origin.y=r-t.height)}return t},offsetRectForScreenDisplacement:function(i){var t=null;if(i){var e=this._visibleRect(),n=this._viewerRect(),o=this._convertVect(i,n,e);t={origin:new s.Vector2(e.origin.x-o.x,e.origin.y-o.y),width:e.width,height:e.height}}return t},_zoomRectForScaleWithCenter:function(i){var t=null;if(i&&null!=i.scalingFactor&&1!=i.scalingFactor&&null!=i.center){var e=i.scalingFactor,n=this._visibleRect(),o=this._viewerRect(),a=this._convertVect(i.center,o,n).clone().multiplyScalar(1-e);t={origin:new s.Vector2(n.origin.x+a.x,n.origin.y+a.y),width:e*n.width,height:e*n.height}}return t},zoomToRect:function(i,t){if(i){void 0!==window.devicePixelRatio&&window.devicePixelRatio;var e=this.viewpoint(),n=this.viewerHeight,o=this.viewerWidth,a=void 0!==e.getCamera().width?e.getCamera().width:o,r=void 0!==e.getCamera().height?e.getCamera().height:n,h=void 0!==e.getCamera().x?e.getCamera().x:0,l=void 0!==e.getCamera().y?e.getCamera().y:0,c=i;c.width=void 0!==i.width&&i.width>0?i.width:a,c.height=void 0!==i.height&&i.height>0?i.height:r,c.origin=void 0!==i.origin?i.origin:s.Vector2(h,l),t&&t.ignoreConstraints||!this._applyKinematicConstraints||!this._kinematicConstraints||(c=t&&t.useResistence?this._interpolatedRect(this._visibleRect(),c,this._kinematicConstraints,this._userExpConfig.translation.toleranceDistance):this.maxRectInContainer(c));c.origin.x,c.origin.y;this._kinematicConstraints&&(c.width>this._kinematicConstraints.width&&(c.width=this._kinematicConstraints.width),c.height>this._kinematicConstraints.height&&(c.height=this._kinematicConstraints.height)),e.setViewOffset({width:c.width,height:c.height,x:c.origin.x,y:c.origin.y})}},_animateBackToBestViewpointCompliantWithConstraints:function(){if(this._applyKinematicConstraints&&this._kinematicConstraints)new s.Vector3(200,100,-50),new s.Vector3(200,-100,-50),new s.Vector3(200,100,50)},applyInertia:function(){this.stopInertia();this._velocity;if(Math.abs(this._velocity.x)<0&&Math.abs(this._velocity.y)<0||this.getDt()>this._userExpConfig.inertia.dtStationary)this._animateBackToBestViewpointCompliantWithConstraints();else{new a;var e=this,n=0,o=new i(0,0,1e3);o.setInterpolator(function(i){var t=e._userExpConfig.inertia.tau,o=(i=1e3*i/1e3)-n;n=i;var a=e._velocity,r=a.x,s=a.y;return{dx:r*Math.exp(-i/t)*o,dy:s*Math.exp(-i/t)*o}});var r={me:this,setOrientation:function(i){var t=i.dx,e=i.dy,n=this.me.offsetRectForScreenDisplacement(new s.Vector2(t,e));if(this.me._applyKinematicConstraints&&this.me._kinematicConstraints){var o=this.me._kinematicConstraints,a=o.origin.x,r=o.origin.x+o.width,h=o.origin.y,l=o.origin.y+o.height;n.origin.x<a&&(this.me._velocity.x=this.me._velocity.x>0?-this.me._velocity.x:this.me._velocity.x),n.origin.y<h&&(this.me._velocity.y=this.me._velocity.y>0?-this.me._velocity.y:this.me._velocity.y),n.origin.x+n.width>r&&(this.me._velocity.x=this.me._velocity.x<0?-this.me._velocity.x:this.me._velocity.x),n.origin.y+n.height>l&&(this.me._velocity.y=this.me._velocity.y<0?-this.me._velocity.y:this.me._velocity.y)}this.me.zoomToRect(n,{ignoreConstraints:!0})}};this._inertianAnim=new t(r,"setOrientation",o),this._inertianAnim.start()}},startAnimation:function(i){if(this.stopInertia(),this.stopAnimation(),null===this._basicEventToken&&(this._basicEventToken=n.subscribe({event:"/VISU/onBasicEvent"},function(i){if(i)for(var t=0;t<i.from.length;t++){var e=i.from[t],n=e.getType(),a=e.getState();e instanceof o&&"Keyboard"!==n&&a===o.State.BEGIN&&this.stopAnimation()}}.bind(this))),null===this._animation){var e=new function(i){this._nbLoops=void 0!==i.animationData.nbLoops?i.animationData.nbLoops:5,this._duration=void 0!==i.animationData.duration?i.animationData.duration:1e4,this._T=this._duration/this._nbLoops,this._rotVect=i.viewpointData.rotVect,this._rotAngle=i.viewpointData.rotAngle,this._sightDir_t0=i.viewpointData.sightDir,this.duration=function(){return this._duration},this.valueAt=function(t){var e=t%this._T/this._T,n=new s.Matrix4;n.makeRotationAxis(this._rotVect,e*this._rotAngle);var o=this._sightDir_t0.clone();return o.applyMatrix4(n),{viewpoint:i.viewpointData.viewpoint,sightDir:o,eyePosition:new s.Vector3(0,0,0)}}}({animationData:{nbLoops:1,duration:1e5},viewpointData:{viewpoint:i,sightDir:new s.Vector3(1,0,0),rotVect:new s.Vector3(0,0,1),rotAngle:-2*Math.PI}});this._animation=new t(this,"viewpointAnimationCB",e)}},zoomFun:function(i){i.defaultBehavior=!1;var t=i.evt,e=-1*i.factor;if(Math.abs(e)>=1){e*=.025}var n=1+e,o=t._currentPosition,a=h._zoomRectForScaleWithCenter({center:o,scalingFactor:n});a&&a.origin.x&&h.zoomToRect(a)},rotateFun:function(i){if(i.defaultBehavior=!1,i&&i.gesture.events&&i.gesture.view&&i.gesture.view.length){h.stopInertia();var t=i.gesture.events,e=i.gesture.view[0],n=t[0].getCurrentPosition?t[0].getCurrentPosition(e):t[0].currentPosition,o=t[0].getLastPosition?t[0].getLastPosition(e):t[0].lastPosition;if(n&&o){var a=n.x-o.x,r=n.y-o.y,l=h.getDt();l>0&&(h._velocity.x=a/l,h._velocity.y=r/l),h.updateT();var c=h.offsetRectForScreenDisplacement(new s.Vector2(a,r));h.zoomToRect(c,{useResistence:!1})}}},onDeviceOrientationEvent:function(){console.log("Deactivated in Flat mode!")}})}),define("DS/3DPlay360Experiences/TrackballControlCylindrical",["UWA/Class","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/VisuEvents/EventsManager","DS/Core/Events","DS/VisuEvents/ScreenEvent","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballAbstractControl","DS/Visualization/ThreeJS_DS"],function(i,t,e,n,o,a,r,s,h){"use strict";return s.extend({init:function(i){this._parent(i);var t=Math.min(this.viewerHeight,i.size.imgSize.height),e=Math.min(this.viewerWidth,i.size.imgSize.width),n=t/e*2*180/Math.PI;this._userExpConfig.zoom.maxFovDeg=n||125,this._userExpConfig.rotation.toleranceAngle=e/t*10,this},dispose:function(){this._applyKinematicConstraints=null,this._parent(),null},setKinematicConstraints:function(i){this._kinematicConstraints={thetaMin:i.thetaMin,thetaMax:i.thetaMax,phiMin:i.phiMin,phiMax:i.phiMax}},_computeSightDirRangeGivenConstraints:function(){var i=this._kinematicConstraints,t=this.computeFieldOfViews(this._viewpoint),e=t.hFov?t.hFov:0,n=t.vFov?t.vFov:0;return{thetaMin:i.thetaMin+e/2,thetaMax:i.thetaMax-e/2,phiMin:i.phiMin+n/2,phiMax:i.phiMax-n/2}},_computeMaxVFovGivenConstraints:function(){var i=null,t=this._kinematicConstraints;if(t){var e=t.phiMax-t.phiMin,n=this._userExpConfig.zoom.toleranceAngle;i=180*e/Math.PI-n}return i},_animateBackToBestViewpointCompliantWithConstraints:function(){var i=this.computeFieldOfViews(this.viewpoint()),t=180*(i.vFov?i.vFov:0)/Math.PI,e=this._computeMaxVFovGivenConstraints();t>e&&this._setZoomForAngle(e);var n=new r,o=this._viewpoint.getSightDirection().clone().normalize(),a=n.getSPhericalCoordinates(o),s=a.theta,h=a.phi,l=this._computeSightDirRangeGivenConstraints(),c=a.theta-l.thetaMin,u=a.theta-l.thetaMax,p=a.phi-l.phiMin,d=a.phi-l.phiMax;c<0&&(s=l.thetaMin),u>0&&(s=l.thetaMax),p<0&&(h=l.phiMin),d>0&&(h=l.phiMax);var g={r:1,theta:s,phi:h},v=n.getCartesianCoord(g),m=n.uPhi(g).multiplyScalar(-1);this._viewpoint.moveTo({eyePosition:this._viewpoint.getEyePosition(),sightDirection:v,upDirection:m,duration:this._userExpConfig.elasticReturn.animDuration})},_setZoomForAngle:function(i){if(i){var t=i,e=this._computeMaxVFovGivenConstraints();(t=t>e?e:t)&&t>=this._userExpConfig.zoom.minFovDeg&&t<=this._userExpConfig.zoom.maxFovDeg&&(this.viewpoint().setAngle(t),this._onZoomCB&&this._onZoomCB())}},_computeViewpointForRotation:function(i){var t=null,e=null,n=null;if(i&&null!==i.dTheta&&null!==i.dPhi){var o=i.dTheta,a=i.dPhi,s=new r,h=s.getSPhericalCoordinates(this._viewpoint.getSightDirection().clone().normalize()),l={r:1,theta:h.theta+o,phi:h.phi+a};if(this._kinematicConstraints){var c=this._computeSightDirRangeGivenConstraints(),u=l.theta-c.thetaMin,p=l.theta-c.thetaMax,d=l.phi-c.phiMin,g=l.phi-c.phiMax,v=this._userExpConfig.rotation.toleranceAngle*(Math.PI/180);u<0&&(o*=1-Math.abs(u)/v),p>0&&(o*=1-Math.abs(p)/v),d<0&&(a*=1-Math.abs(d)/v),g>0&&(a*=1-Math.abs(g)/v),l={r:1,theta:h.theta+o,phi:h.phi+a}}var m={min:.05,max:Math.PI-.05};l.phi=l.phi<m.min?m.min:l.phi,l.phi=l.phi>m.max?m.max:l.phi,n=this._viewpoint.getEyePosition(),t=s.getCartesianCoord(l),e=s.uPhi(l).multiplyScalar(-1)}return{eyePosition:n,sightDirection:t,upDirection:e}},startAnimation:function(i){if(this.stopInertia(),this.stopAnimation(),null===this._basicEventToken&&(this._basicEventToken=o.subscribe({event:"/VISU/onBasicEvent"},function(i){if(i)for(var t=0;t<i.from.length;t++){var e=i.from[t],n=e.getType(),o=e.getState();e instanceof a&&"Keyboard"!==n&&o===a.State.BEGIN&&this.stopAnimation()}}.bind(this))),null===this._animation){var t=new function(i){this._nbLoops=void 0!==i.animationData.nbLoops?i.animationData.nbLoops:5,this._duration=void 0!==i.animationData.duration?i.animationData.duration:1e4,this._T=this._duration/this._nbLoops,this._rotVect=i.viewpointData.rotVect,this._rotAngle=i.viewpointData.rotAngle,this._sightDir_t0=i.viewpointData.sightDir,this.duration=function(){return this._duration},this.valueAt=function(t){var e=t%this._T/this._T,n=new h.Matrix4;n.makeRotationAxis(this._rotVect,e*this._rotAngle);var o=this._sightDir_t0.clone();return o.applyMatrix4(n),{viewpoint:i.viewpointData.viewpoint,sightDir:o,eyePosition:new h.Vector3(0,0,0)}}}({animationData:{nbLoops:1,duration:1e5},viewpointData:{viewpoint:i,sightDir:new h.Vector3(1,0,0),rotVect:new h.Vector3(0,0,1),rotAngle:-2*Math.PI}});this._animation=new e(this,"viewpointAnimationCB",t)}this._animation&&(this._animation.setLoop(1),this._animation.start())},reframe:function(){var i,t=this.computeFieldOfViews(this.viewpoint()),e=t.vFov?t.vFov:0;i=this.defaultZoom?180*e/Math.PI:this._userExpConfig.zoom.maxFovDeg,this._setZoomForAngle(i),this.viewer&&this.viewer.render()}})}),define("DS/3DPlay360Experiences/DirectionIndicatorPlaner",["UWA/Class","DS/Core/Events","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/WebSystem/Environment","DS/3DPlay360Experiences/DirectionIndicatorAbstract","css!DS/3DPlay360Experiences/directionIndicatorPlaner.css"],function(i,t,e,n,o,a,r){"use strict";return a.extend({init:function(i){this.iconName="Planer",this._parent(i)},_hideIndicator:function(){this._getOuterContainer()&&this._getContainer()&&this._getLight()&&(this._getOuterContainer().classList.remove("indicatorOuterContainerPlaner"),this._getContainer().classList.remove("directionIndicatorPlaner"),this._getLight().classList.remove("lightPlaner"),this._getNorth().classList.remove("hide"))},showIndicator:function(){this._getOuterContainer()&&this._getContainer()&&this._getLight()&&(this._getOuterContainer().classList.add("indicatorOuterContainerPlaner"),this._getContainer().classList.add("directionIndicatorPlaner"),this._getLight().classList.add("lightPlaner"),this._getNorth().classList.add("hide"))},_updateLight:function(i,t){var e=this._getLight();if(e){var n=this.getHeight(),o=this.getWidth();e.style.height=20+n+"%",e.style.width=5+o+"%",e.style.top=t-10+"%",e.style.left=i+"%"}},setOrigin:function(i){this._origin=i}})}),define("DS/3DPlay360Experiences/ImgMaterialCylindrical",["DS/3DPlay360Experiences/ImgMaterialAbstract"],function(i){"use strict";return i.extend({init:function(i){this._parent(i)},_updateMaterial:function(i,t,e){if(i&&i.isReady){e&&t.updatePDSFXUniform("uSampler",e);var n=i.geomData();n&&t&&(t.updatePDSFXUniform("fullPanoWidthPixels",n.fullPanoWidthPixels),t.updatePDSFXUniform("fullPanoHeightPixels",n.fullPanoHeightPixels),t.updatePDSFXUniform("croppedAreaImageWidthPixels",n.croppedAreaImageWidthPixels),t.updatePDSFXUniform("croppedAreaImageHeightPixels",n.croppedAreaImageHeightPixels),t.updatePDSFXUniform("croppedAreaLeftPixels",n.croppedAreaLeftPixels),t.updatePDSFXUniform("croppedAreaTopPixels",n.croppedAreaTopPixels),t.updatePDSFXUniform("applyEffect",-1)),t.needsUpdate=!0,n=void 0}}})}),define("DS/3DPlay360Experiences/ImgFlatViewerController",["DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/3DPlay360Experiences/TrackballControlPlane","DS/3DPlay360Experiences/DirectionIndicatorPlaner","DS/3DPlay360Experiences/ImgAbstractViewerController","DS/3DPlay360Experiences/ImgMaterialPlaner"],function(i,t,e,n,o,a,r){"use strict";return a.extend({init:function(i){this._parent(i),this._planeData={width:200,height:100,distance:150},this.nodeDim&&this.nodeDim.width&&this.nodeDim.height&&(this._planeData.width=this.nodeDim.width,this._planeData.height=this.nodeDim.height,this._planeData.distance=this.nodeDim.width+this.nodeDim.height/2),this._userExpConfig={zoom:{defaultFOV:45}},this._directionIndicator=new o({id:i.id,callback:i.callback})},dispose:function(){this._planeData=null,this._parent()},createTrackball:function(i){return new n({applyKinematicConstraints:!1,inertia:!0,size:i})},createMaterial:function(){return new r},_createNode:function(){var i=this._planeData.width,n=this._planeData.height,o=new t.PlaneGeometry(i,n);o.applyMatrix((new t.Matrix4).makeBasis(new t.Vector3(0,-1,0),new t.Vector3(0,0,-1),new t.Vector3(1,0,0)));var a=new t.Mesh(o,new t.MeshPhongMaterial,!0),r=e.createNodeFromTHREEMesh(a);return r.setMatrix((new t.Matrix4).setPosition(new t.Vector3(30,0,0))),r.name="planeNode",this.createdNode=r,r},applyKinematicConstraints:function(){var i=this.trackBall().offsetRectForScreenDisplacement(new t.Vector2(0,0)),e=this.trackBall();e&&(e.setKinematicConstraints(i),e.setApplyConstraints(!0)),this._directionIndicator&&this._directionIndicator.setOrigin(i.origin)},removeKinematicConstraints:function(){var i=this.trackBall();i&&i.setApplyConstraints(!1)},_reframeOnInitialView:function(i){var e=i?1e3:0,n=(this._planeData&&this._planeData.distance&&this._planeData.distance,this.viewer());n&&(n.setShadow(!1),n.setGrid(!1),n.setMirror(!1,!1),n.displayInfinitePlane(!1),n.setPrePicking({activated:!1,displayHL:!1},!0),n.setPicking({activated:!1,displayHL:!1},!0)),this.defaultOffsetRect=this.trackBall().offsetRectForScreenDisplacement(new t.Vector2(0,0)),this.setDefaultVP(e)},setDefaultVP:function(i){i=i||1e3,this.viewpoint().moveTo({eyePosition:new t.Vector3(-this._planeData.distance,0,0),upDirection:new t.Vector3(0,0,1),sightDirection:new t.Vector3(1,0,0),duration:i}),this.viewpoint().setAngle(this._userExpConfig.zoom.defaultFOV),this.trackBall().zoomToRect(this.defaultOffsetRect,{useResistence:!1})}})}),define("DS/3DPlay360Experiences/ImgCylindricalViewerController",["UWA/Class","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballControlCylindrical","DS/3DPlay360Experiences/DirectionIndicatorCylindrical","DS/3DPlay360Experiences/ImgAbstractViewerController","DS/3DPlay360Experiences/ImgMaterialCylindrical"],function(i,t,e,n,o,a,r,s,h){"use strict";return s.extend({init:function(i){this._parent(i),this._directionIndicator=new r({id:i.id,callback:i.callback})},dispose:function(){this._parent()},createTrackball:function(i){return new a({applyKinematicConstraints:!1,inertia:!0,size:i})},createMaterial:function(){return new h},_createNode:function(){var i=100,t=200;this.nodeDim&&(i=this.nodeDim.width/(2*Math.PI),t=this.nodeDim.height);var o={bottomCenterPoint:new e.Vector3(0,0,-t),topCenterPoint:new e.Vector3(0,0,t),bottomRadius:i,topRadius:i,bottomCap:!1,topCap:!1},a=n.createCylinderCustomNode(o);return a.name="imgCylinderNode",a.setMatrix((new e.Matrix4).setPosition(new e.Vector3(0,0,0))),this.createdNode=a,a},applyKinematicConstraints:function(){var i=this.getImgData().computeImgRangeInSphericalCoord(),t=this.trackBall();t&&i&&(t.setKinematicConstraints(i),t.setApplyConstraints(!0))},removeKinematicConstraints:function(){var i=this.trackBall();i&&i.setApplyConstraints(!1)},_computeInitialView:function(i){var t=null,e=null;if(i){var n=i.computeMiddlePointSphericalCoord(),a=new o;t=a.ur({r:1,theta:n.x,phi:n.y}),e=a.uPhi({r:1,theta:n.x,phi:n.y}).multiplyScalar(-1)}return{sight:t,up:e}},_reframeOnInitialView:function(i){var t=this.getImgData();if(t&&t._img&&t._imgGeomData){var n=this._computeInitialView(t);n&&n.sight&&n.up&&this.viewpoint()&&this.viewpoint().moveTo({eyePosition:new e.Vector3,sightDirection:n.sight,upDirection:n.up,duration:i?500:0})}},_getVisiblePixelCoord:function(i){i=this.getImgData();var t=null,e=null,n=null,a=this.trackBall();if(a){var r=a.computeFieldOfViews(this.viewpoint()),s=r.hFov?r.hFov:0,h=r.vFov?r.vFov:0,l=this.viewpoint().getSightDirection(),c=(new o).getSPhericalCoordinates(l),u=c.theta-s/2,p=c.theta+s/2,d=c.phi-h/2,g=c.phi+h/2,v={theta:u,phi:g},m={theta:p,phi:g},f={theta:u,phi:d};t=i.pixelForThetaPhi(v),e=i.pixelForThetaPhi(m),n=i.pixelForThetaPhi(f)}return{bottomLeftPixel:t,bottomRightPixel:e,topLeftPixel:n}}})}),define("DS/3DPlay360Experiences/TrackballControlSpherical",["UWA/Class","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/VisuEvents/EventsManager","DS/Core/Events","DS/VisuEvents/ScreenEvent","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballAbstractControl","DS/Visualization/ThreeJS_DS"],function(i,t,e,n,o,a,r,s,h){"use strict";return s.extend({init:function(i){this._parent(i),this._applyKinematicConstraints=!1,this},dispose:function(){this._applyKinematicConstraints=null,this._parent(),null},setKinematicConstraints:function(){},_animateBackToBestViewpointCompliantWithConstraints:function(){},_setZoomForAngle:function(i){if(i){var t=i;t&&t>=this._userExpConfig.zoom.minFovDeg&&t<=this._userExpConfig.zoom.maxFovDeg&&(this.viewpoint().setAngle(t),this._onZoomCB&&this._onZoomCB())}},_computeViewpointForRotation:function(i){var t=null,e=null,n=null;if(i&&null!==i.dTheta&&null!==i.dPhi){var o=i.dTheta,a=i.dPhi,s=new r,h=s.getSPhericalCoordinates(this._viewpoint.getSightDirection().clone().normalize()),l={r:1,theta:h.theta+o,phi:h.phi+a},c={min:.05,max:Math.PI-.05};l.phi=l.phi<c.min?c.min:l.phi,l.phi=l.phi>c.max?c.max:l.phi,n=this._viewpoint.getEyePosition(),t=s.getCartesianCoord(l),e=s.uPhi(l).multiplyScalar(-1)}return{eyePosition:n,sightDirection:t,upDirection:e}},startAnimation:function(i){if(this.stopInertia(),this.stopAnimation(),null===this._basicEventToken&&(this._basicEventToken=o.subscribe({event:"/VISU/onBasicEvent"},function(i){if(i)for(var t=0;t<i.from.length;t++){var e=i.from[t],n=e.getType(),o=e.getState();e instanceof a&&"Keyboard"!==n&&o===a.State.BEGIN&&this.stopAnimation()}}.bind(this))),null===this._animation){var t=new function(i){this._nbLoops=void 0!==i.animationData.nbLoops?i.animationData.nbLoops:5,this._duration=void 0!==i.animationData.duration?i.animationData.duration:1e4,this._T=this._duration/this._nbLoops,this._rotVect=i.viewpointData.rotVect,this._rotAngle=i.viewpointData.rotAngle,this._sightDir_t0=i.viewpointData.sightDir,this.duration=function(){return this._duration},this.valueAt=function(t){var e=t%this._T/this._T,n=new h.Matrix4;n.makeRotationAxis(this._rotVect,e*this._rotAngle);var o=this._sightDir_t0.clone();return o.applyMatrix4(n),{viewpoint:i.viewpointData.viewpoint,sightDir:o,eyePosition:new h.Vector3(0,0,0)}}}({animationData:{nbLoops:1,duration:1e5},viewpointData:{viewpoint:i,sightDir:new h.Vector3(1,0,0),rotVect:new h.Vector3(0,0,1),rotAngle:-2*Math.PI}});this._animation=new e(this,"viewpointAnimationCB",t)}this._animation&&(this._animation.setLoop(1),this._animation.start())},reframe:function(){var i,t=this.computeFieldOfViews(this.viewpoint()),e=t.vFov?t.vFov:0;i=this.defaultZoom?180*e/Math.PI:this._userExpConfig.zoom.maxFovDeg,this._setZoomForAngle(i),this.viewer&&this.viewer.render()}})}),define("DS/3DPlay360Experiences/ImgSphericalViewerController",["UWA/Class","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/3DPlay360Experiences/mathUtils360","DS/3DPlay360Experiences/TrackballControlSpherical","DS/3DPlay360Experiences/DirectionIndicatorSpherical","DS/3DPlay360Experiences/ImgAbstractViewerController","DS/3DPlay360Experiences/ImgMaterialSpherical"],function(i,t,e,n,o,a,r,s,h){"use strict";return s.extend({init:function(i){this._parent(i),this._directionIndicator=new r({id:i.id,callback:i.callback})},dispose:function(){this._parent()},createTrackball:function(i){return new a({applyKinematicConstraints:!1,inertia:!0,size:i})},createMaterial:function(){return new h},_createNode:function(){var i={matrix:(new e.Matrix4).makeBasis(new e.Vector3(-1,0,0),new e.Vector3(0,-1,0),new e.Vector3(0,0,1)),radius:100},t=n.createSphereNode(i);return t.name="imgSphereNode",t.setMatrix((new e.Matrix4).setPosition(new e.Vector3(0,0,0))),this.createdNode=t,t},applyKinematicConstraints:function(){},removeKinematicConstraints:function(){var i=this.trackBall();i&&i.setApplyConstraints(!1)},_computeInitialView:function(i){var t=null,e=null;if(i){var n=i.computeMiddlePointSphericalCoord(),a=new o;t=a.ur({r:1,theta:n.x,phi:n.y}),e=a.uPhi({r:1,theta:n.x,phi:n.y}).multiplyScalar(-1)}return{sight:t,up:e}},_reframeOnInitialView:function(i){var t=this.getImgData();if(t&&t._img&&t._imgGeomData){var n=this._computeInitialView(t);n&&n.sight&&n.up&&this.viewpoint()&&this.viewpoint().moveTo({eyePosition:new e.Vector3,sightDirection:n.sight,upDirection:n.up,duration:i?500:0})}},_getVisiblePixelCoord:function(i){i=this.getImgData();var t=null,e=null,n=null,a=this.trackBall();if(a){var r=a.computeFieldOfViews(this.viewpoint()),s=r.hFov?r.hFov:0,h=r.vFov?r.vFov:0,l=this.viewpoint().getSightDirection(),c=(new o).getSPhericalCoordinates(l),u=c.theta-s/2,p=c.theta+s/2,d=c.phi-h/2,g=c.phi+h/2,v={theta:u,phi:g},m={theta:p,phi:g},f={theta:u,phi:d};t=i.pixelForThetaPhi(v),e=i.pixelForThetaPhi(m),n=i.pixelForThetaPhi(f)}return{bottomLeftPixel:t,bottomRightPixel:e,topLeftPixel:n}}})}),define("DS/3DPlay360Experiences/ProjectionTypeManager",["UWA/Class","DS/3DPlay360Experiences/ImgFlatViewerController","DS/3DPlay360Experiences/ImgSphericalViewerController","DS/3DPlay360Experiences/ImgCylindricalViewerController"],function(i,t,e,n){"use strict";return i.extend({init:function(i){this.PROJECTION_TYPE={CYLINDRICAL:1,EQUIRECTANGULAR:2,PLANER:3},this.imgData=null,this._defaultProjType=this.decideDefault(i.size),this._currentProjType=this._defaultProjType,this.viewerControllerEnum={CYLINDRICAL:null,EQUIRECTANGULAR:null,PLANER:null},this._createImgViewerControllers(i)},decideDefault:function(i){var t=this.PROJECTION_TYPE.EQUIRECTANGULAR;i&&i.height&&i.width&&(i.width/i.height>2&&(console.log("CYLINDRICAL"),t=this.PROJECTION_TYPE.CYLINDRICAL));return t},getdirectionIndicatorArray:function(){return[this.viewerControllerEnum.CYLINDRICAL.getDirectionIndicatorData(),this.viewerControllerEnum.EQUIRECTANGULAR.getDirectionIndicatorData(),this.viewerControllerEnum.PLANER.getDirectionIndicatorData()]},dispose:function(){this.viewerControllerEnum={CYLINDRICAL:null,EQUIRECTANGULAR:null,PLANER:null},this._currentProjType=null,this.imgData=null,this.PROJECTION_TYPE=null},getCurrProjeType:function(){return this._currentProjType},getProjeTypeList:function(){return this.PROJECTION_TYPE},getDefaultProjeType:function(){return this._defaultProjType},getDefaultVC:function(){return this.PROJECTION_TYPE.CYLINDRICAL===this._defaultProjType?this.viewerControllerEnum.CYLINDRICAL:this.PROJECTION_TYPE.EQUIRECTANGULAR===this._defaultProjType?this.viewerControllerEnum.EQUIRECTANGULAR:this.PROJECTION_TYPE.PLANER===this._defaultProjType?this.viewerControllerEnum.PLANER:null},checkProjectionType:function(i){return this._currentProjType||(this._currentProjType=this._defaultProjType),this.PROJECTION_TYPE[i]==this._currentProjType},changeProjType:function(i){return this._currentProjType=this.PROJECTION_TYPE[i],this._imgViewerController=this.viewerControllerEnum[i],this._imgViewerController},_createImgViewerControllers:function(i){for(var o=Object.keys(this.PROJECTION_TYPE),a={CYLINDRICAL:n,EQUIRECTANGULAR:e,PLANER:t},r=0;r<o.length;r++){var s=o[r];i.id=s,this.viewerControllerEnum[s]=new a[s](i),this.viewerControllerEnum[s].name=s}},getAllVCs:function(){return[this.viewerControllerEnum.EQUIRECTANGULAR,this.viewerControllerEnum.CYLINDRICAL,this.viewerControllerEnum.PLANER]}})}),define("DS/3DPlay360Experiences/Img360",["UWA/Class","DS/3DPlay360Experiences/ImgData","DS/3DPlay360Experiences/ProjectionTypeManager","DS/3DPlay360Experiences/DirectionIndicatorSwitch"],function(i,t,e,n){"use strict";var o;return i.extend({init:function(i){o=this,this.countForDiIcon=0,this.countForImgVC=0,this.frmWindow=i.frmWindow,this._view=null,this._imgData=null,this._imgMaterial=null,this._directionIndicator=null,this._projectionTypeManager=this._createProjectionTypeManager({viewer:i.frmWindow.getViewer(),div:this._getView(),callback:this.callbackDiIcon,size:i.size}),this.frmWindow.getViewerFrame().addEvent("resize",this._onResize.bind(this))},_getView:function(){return this._view||(this._view=document.createElement("div"),this._view.style.width="100%",this._view.style.height="100%",this._view.className="img360"),this._view},setImg:function(i){i&&i.img?(this._imgData&&(this._imgData.dispose(),this._imgData=null),this._imgData=new t,this._imgData.setImg(i.img),this._imgData.setGeomData(i),this.iData={size:i.size}):(console.error("Image Data Not Found! "),console.log("Data : "+i))},_displayDefault:function(){this._imgViewerController=this._projectionTypeManager.getDefaultVC(),this._display(this._imgViewerController)},_getImgData:function(){return this._imgData},readyCB:function(i){this._readyCB=i},_readyVCForDisplay:function(i){i&&(console.log("IMG DATA"),console.time("[360 perfos] - Img Data Activation"),this._getImgData().activate().then(function(){return console.log("VIEWER CONTROLLER"),console.timeEnd("[360 perfos] - Img Data Activation"),i.setImgData(this._getImgData()),i.applyKinematicConstraints(),i.build(this.callbackImgVC.bind(this)),i.name}.bind(this)).then(function(i){return this._readyCB&&this._readyCB(i),Promise.resolve()}.bind(this)).catch(function(i){console.log(i)}))},callbackImgVC:function(){o.countForImgVC++,3===o.countForImgVC&&(o.hideAllVC(),o._displayDefault(),o.countForImgVC=0)},callbackDiIcon:function(){if(o.countForDiIcon++,3===o.countForDiIcon)var i=setInterval(function(){o._projectionTypeManager&&(clearInterval(i),o._projectionTypeSwitch=o._createSwitch(o.frmWindow),o._readyAllVCForDisplay({imgSize:o.iData.size}))},100)},_display:function(i){i.activate(),i.trackBall().startAnimation(i.viewpoint()),this._displayOrientationIndicator(i),i.showNode()},_readyAllVCForDisplay:function(i){for(var t=this._projectionTypeManager.getAllVCs(),e=0;e<t.length;e++){var n=t[e];n&&(n.activate(i),this._readyVCForDisplay(n))}},hideAllVC:function(){for(var i=this._projectionTypeManager.getAllVCs(),t=0;t<i.length;t++){var e=i[t];e&&e.hide()}},_createProjectionTypeManager:function(i){return new e(i)},_createSwitch:function(){var i={func:this.changeImageViewerController.bind(this)},t=this._projectionTypeManager.getdirectionIndicatorArray();return new n({iData:i,frmWindow:this.frmWindow,directionIndicatorArray:t,defaultProjType:this._projectionTypeManager.getDefaultProjeType()})},changeImageViewerController:function(i){this._projectionTypeManager.checkProjectionType(i)||(this._imgViewerController&&this._imgViewerController.hide(),this._imgViewerController=this._projectionTypeManager.changeProjType(i),this._display(this._imgViewerController))},_cleanImgViewer:function(){this._imgViewerController&&(this._imgViewerController.dispose(),this._imgViewerController=null)},_displayOrientationIndicator:function(i){i&&i.displayDirIndicator()},dispose:function(){this._projectionTypeSwitch.destroy(),this._projectionTypeSwitch=null,this._readyCB=null,this._cleanImgViewer(),this._imgViewerController=null,this._imgMaterial&&(this._imgMaterial.dispose(),this._imgMaterial=null),this._imgData&&(this._imgData.dispose(),this._imgData=null),this._directionIndicator&&(this._directionIndicator.dispose(),this._directionIndicator=null),this._projectionTypeManager&&(this._projectionTypeManager.dispose(),this._projectionTypeManager=null),this._view=null,o&&(o=void 0)},_onResize:function(){console.log(this),this._projectionTypeSwitch&&this._projectionTypeSwitch.resetCurvedUIDiv(this._projectionTypeManager._currentProjType)},_sampleImgData:function(){this.PROJECTION_TYPE.EQUIRECTANGULAR;return{projectionType:this.PROJECTION_TYPE.CYLINDRICAL,croppedAreaImageWidthPixels:5200,croppedAreaImageHeightPixels:1760,fullPanoWidthPixels:10400,fullPanoHeightPixels:3520,croppedAreaLeftPixels:null,croppedAreaTopPixels:null}}})}),define("DS/3DPlay360Experiences/3DPlay360Experience",["DS/3DPlayExperienceModule/PlayExperience3D","DS/3DPlay360Experiences/Img360","DS/3DPlay360Experiences/MediaLoader"],function(i,t,e){"use strict";return i.extend({init:function(i){this.ERROR_TYPE={unsupportedFormat:1,imageSize:2,loadingError:3},i.commandApplication=!1,i.workbenchs=[],this._filePath=null,this._img360=null,i&&i.options&&(i.options.splashscreen=i.options.splashscreen||{},i.options.splashscreen.waitloading=!0),this._parent(i),this.autoReframe=!1,this.showSplashBetweenLoad=!0,this.refreshImage360()},dispose:function(){this.refreshImage360(),this._parent()},img360:function(){return this._img360},onPreCreate:function(){},onPostCreate:function(){this.frmWindow&&(this._viewer=this.frmWindow.getViewer(),this._viewpoint=this.frmWindow.getViewpoint())},_step:function(){},loadModel:function(i,e,n){if(i&&i.asset&&i.asset.filename&&i.asset.format){this.refreshImage360();var o=void 0===n||n;this.onModelLoadingStarted(o),this.loadAndCheckImage({format:i.asset.format,path:i.asset.filename,requestsOptions:i.asset.requestsOptions}).then(function(i){i&&i.img&&i.imgData&&(this._img360||(this._img360=new t({frmWindow:this.frmWindow,size:i.size})),this.progress.updateProgression(50),this.img360().readyCB(function(i){this.modelName=i,this.onModelLoadingCompleted(),o&&this.onModelLoadingProgression({loaded:100,total:100}),Promise.resolve("Success")}.bind(this)),this.img360().setImg({img:i.img,projectionType:i.imgData.projectionType,fullPanoWidthPixels:i.imgData.fullPanoWidthPixels,fullPanoHeightPixels:i.imgData.fullPanoHeightPixels,croppedAreaImageWidthPixels:null,croppedAreaImageHeightPixels:null,croppedAreaLeftPixels:null,croppedAreaTopPixels:null,size:i.size?i.size:0}))}.bind(this)).catch(function(t){console.log(t),t&&t.errorType&&this.onError({error:{errorType:t.errorType,errorData:t.error},input:{format:i.asset.format,path:i.asset.filename}}),this.getPhaseProgress().hideProgressBar()}.bind(this))}},onError:function(i){var t=i;if(t&&t.error&&t.error.errorType)switch(t.error.errorType){case this.ERROR_TYPE.unsupportedFormat:case this.ERROR_TYPE.imageSize:this.onModelLoadingError({type:"FORMAT",url:"dummy."+t.input.format})}},loadAndCheckImage:function(i){return new Promise(function(t,n){if(i&&i.format&&i.path)if("jpg"===i.format||"jpeg"===i.format?i.format:null){console.time("[360 perfos] - Load img");var o=new e;o&&o.img(i).then(function(i){console.timeEnd("[360 perfos] - Load img"),t(i)}.bind(this)).catch(function(i){n({errorType:this.ERROR_TYPE.loadingError,error:i})}.bind(this))}else n({errorType:this.ERROR_TYPE.unsupportedFormat,error:i.format})}.bind(this))},refreshImage360:function(){this._img360&&(this._img360.dispose(),this._img360=null)}})});