/*!  Copyright 2022 Dassault Systemes. All rights reserved. */
define("DS/SMAMpw3DMarkupImpl/SMAMpwMSRHelper",["UWA/Class","DS/SPYUI/controllers/SPYContext"],function(t,e){"use strict";var i=function(t){var e,i=require("DS/CATWebUXSelectionManager/CATWebUXSelectionManager");return i&&(e=i.getSelectionManager({context:t})),e};return t.singleton({getAppContextName:function(){return e.getAppContext()},configureUXforMSR:function(t){var n=e.getCurrentContent();if(n){var s=n.getSPM();if(s){var a=s.window?s.window.SPMUI:void 0;a&&(a.setReframeOnContentChange(!1),a.setContextualBar(!0),a.setExtractableUIsupport(!1),a.onClean(),a.setPublishPCSEvent(),a.setUpdateStats())}}if(!this._pickingToRestore){var o=i(t||e.getCurrentPad());o&&(this._pickingToRestore=o.getPicking(),o.setPicking(0))}},restorePickingConfiguration:function(t){if(void 0!==this._pickingToRestore){var e=i(t);e&&e.setPicking(this._pickingToRestore)}}})}),define("DS/SMAMpw3DMarkupImpl/SMAMpwMSRLoadCtrl",["UWA/Class","DS/CoreEvents/ModelEvents","DS/CoreEvents/Events","DS/Notifications/NotificationsManagerUXMessages","DS/SMAMpw3DMarkupImpl/SMAMpwMSRHelper","DS/SPYLoader/SPYLoader","DS/SPY/SimulationPlayerModel","DS/SPYUI/controllers/SimulationPlayerUI","DS/SPYUI/controllers/SPYContext","i18n!DS/SPYLoader/assets/nls/Loading"],function(t,e,i,n,s,a,o,r,l,p){"use strict";return t.singleton({_appController:{_spm:void 0,_spmui:void 0},_loader:{_spyLoader:a,_mdlEvents:new e,_publish:function(t,e){return this._mdlEvents.publish({event:t,data:e})},_onDefaultDDActivation:function(){this._publish("onDMUCtxtLoadingSuccess")},_postCreateSequenceCallback:function(t){var e=function(){var e=this._appCtrl._spmui;e&&-1===e.getActiveSequence()&&(t&&t.state&&e.setStateData(t.state),e.activateDefaultContent(this._onDefaultDDActivation.bind(this)))}.bind(this);if(this.pad&&!this._rootRequested){var i=this.pad.subscribe({event:"onRootAdded"},function(t){this.pad.unsubscribe(i),s.configureUXforMSR(this.pad),e()}.bind(this)),n=this.pad.subscribe({event:"onRootRemoved"},function(t){this.pad.unsubscribe(n),this._clean()}.bind(this));this.pad.setAutomaticReframePolicy(!1);var a=this._asset.physicalid,o=t.spm.getSimulationAlias();this._spyLoader.declareToPAD(this.pad,a,o),this._rootRequested=!0}else e();this._spyLoader.continueLoading()},_createSequenceErrorCallback:function(){var t=this._spyLoader.getReport();if(t){var e=!1,i="noValidStream";if(isNaN(t.streamNb)||isNaN(t.invalidStreamNb)||t.streamNb!==t.invalidStreamNb?t.filteredContent&&(e=!0,i="filteredContent"):e=!0,e){var n=l.appNotificationTypes.info;l.sendAppNotification(n,{title:p.infoTitle,message:p[i]})}}this._spyLoader.continueLoading()},setPADContext:function(t){this.pad=t,this.ctx=t._context,this.frm=t.getFrameWindow()},setAppController:function(t){this._appCtrl=t},load:function(t){this._clean(),this.pad&&this.pad.getViewer().setMaterialMode(!0),this._MkpNotifProxy||(this._MkpNotifProxy=Object.create(l.AppEventProxy),this._MkpNotifProxy.sendAppNotification=function(t,e){var i={level:this._MkpNotifProxy[t],title:e.title,subtitle:e.subtitle,message:e.message,category:"spyLoading"};n.addNotif(i)}.bind(this),this._MkpNotifProxy[l.appNotificationTypes.info]="info",this._MkpNotifProxy[l.appNotificationTypes.warning]="warning",this._MkpNotifProxy[l.appNotificationTypes.error]="error",this._MkpNotifProxy[l.appNotificationTypes.success]="success",l.setAppEventProxy(this._MkpNotifProxy));var e={window:this.frm,context:this.ctx,msrID:t.data.msrID};this._appCtrl._spm=new o(e);var s={spm:this._appCtrl._spm,window:this.frm,context:this.ctx,reframeOnContentChange:!1,allowExtractableUI:!1,captureHidden3DElements:!0,contextualBar:!0,onClean:function(){},publishPCSEvent:function(){},updateStats:function(){}};this._appCtrl._spmui=new r(s);var a=function(){t.onFailure&&t.onFailure()},c=require("DS/PADUtils/PADUtilsServices");this._asset={dtype:"DesignSight",provider:"3DSPACE",physicalid:t.data.msrID,serverurl:c.get3DSpaceUrl(),tenant:c.getPlatformId(),requiredAuth:"passport"};var u=require("DS/PADUtils/views/PADProgressBar");u.on(p.progressBarText,null),this._spyLoader.onQueryStart(this.ctx,function(){}),this._spyLoader.onQueryProgress(this.ctx,function(t){}),this._spyLoader.onQueryError(this.ctx,function(t){var e,i,n;switch(t){case"NOSTREAM":e="infoTitle",i="noLightWeightStream",n=l.appNotificationTypes.info;break;case"NOACCESS":e="warningTitle",i="noDataAccess",n=l.appNotificationTypes.warning;break;default:e="errorTitle",i="failed",n=l.appNotificationTypes.error}l.sendAppNotification(n,{title:p[e],message:p[i]}),u.off(),a()}),this._spyLoader.onUnstreamStart(this.ctx,function(){}),this._spyLoader.onFileNotSupported(this.ctx,function(){alert("File not supported"),u.off(),a()}),this._spyLoader.onUnstreamComplete(this.ctx,function(e){this._postCreateSequenceCallback(e),this._spyLoader.isLoadingComplete()&&(i.publish({event:this.ctx+"/SPY/ASSET/LOADINGCOMPLETE"}),u.off(),t.onComplete&&t.onComplete())}.bind(this)),this._spyLoader.onUnstreamError(this.ctx,function(){this._createSequenceErrorCallback(),this._spyLoader.isLoadingComplete()&&(i.publish({event:this.ctx+"/SPY/ASSET/LOADINGCOMPLETE"}),u.off(),a())}.bind(this)),this._spyLoader.onTimeOut(this.ctx,function(){var t=l.appNotificationTypes.warning;l.sendAppNotification(t,{title:p.warningTitle,message:p.timeOut}),u.off(),a()});var d="DS/SPY/CATSimNavDataLWBasicFactory";this._appCtrl._spmui&&this._appCtrl._spmui._roleForFullFound&&(d="DS/SPY/CATSimNavDataLWFactory"),this._spyLoader.load(this._asset,d,this._appCtrl._spm)},remove:function(t){console.error(" SMAMpwMSRCtrl - remove not implemented !")},_clean:function(){s.restorePickingConfiguration(),this._appCtrl._spmui&&(this._appCtrl._spmui.clean(),this._appCtrl._spmui.destroy(),delete this._appCtrl._spmui),this.frm&&this.frm.SPMUI&&delete this.frm.SPMUI,this._appCtrl._spm&&(this._appCtrl._spm.clean(),delete this._appCtrl._spm),this._spyLoader.clean(),this._rootRequested=!1}},unreferenceApplicativeController:function(t){if(!t||!t.context)return null},giveApplicativeController:function(t){if(!t||!t.context)return null},getApplicativeController:function(t){if(!t||!t.context)return null;console.error(" SMAMpwMSRCtrl - getApplicativeController not implemented !")},giveLoaderForMarkup:function(t){if(!t||!t.context)return null;console.error(" SMAMpwMSRCtrl - giveLoaderForMarkup not implemented !")},getLoaderForMarkup:function(t){return t&&t.context?(this._loader.setPADContext(t.context),this._loader.setAppController(this._appController),this._loader):null}})}),define("DS/SMAMpw3DMarkupImpl/SMAMpwMSRAppCtrl",["UWA/Class","DS/CoreEvents/ModelEvents","DS/CoreEvents/Events","DS/SMAMpw3DMarkupImpl/SMAMpwMSRHelper","DS/SPYUI/controllers/SessionStateManager","DS/SPYLoader/SPYLoader"],function(t,e,i,n,s,a){"use strict";return t.singleton({_mdlEvents:new e,_publish:function(t,e){return this._mdlEvents.publish({event:t,data:e})},getApplicativeController:function(){return this},setActiveState:function(t){},getActiveState:function(){return this._active=!0,this._active},subscribe:function(t,e){var i;return t&&e&&this._mdlEvents&&(i=this._mdlEvents.subscribe({event:t},e)),i},unsubscribe:function(t){t&&this._mdlEvents&&this._mdlEvents.unsubscribe(t)},initializeAppContainer:function(t){n.configureUXforMSR();var e=n.getAppContextName(),s=function(){this._active&&!this._loadingSlideContext&&this._publish("onApplicativeContextChanged",{id:"MSR"})}.bind(this);this._datadisplayActivatedCallback=i.subscribe({event:e+"/SPY/REVIEWCONTEXT/CONTENTCHANGED"},function(){this._loadingSlideContext||s()}.bind(this)),this._frameSelectionCallback=i.subscribe({event:e+"/SPY/REVIEWCONTEXT/FRAMECHANGED"},s);var a=function(){this._active&&!this._loadingSlideContext&&this._publish("onApplicativeContentChanged",{id:"MSR"})}.bind(this);this._animScopeCallback=i.subscribe({event:e+"/SPY/REVIEWCONTENT/ANIMSCOPECHANGED"},a),this._legendEditMinCallback=i.subscribe({event:e+"/SPY/REVIEWCONTENT/LEGEND/EDIT/USERMINCHANGED"},a),this._legendEditMaxCallback=i.subscribe({event:e+"/SPY/REVIEWCONTENT/LEGEND/EDIT/USERMAXCHANGED"},a),this._visibilityCallback=i.subscribe({event:e+"/SPY/REVIEWCONTENT/HIDDEN3DELEMENTSCHANGED"},a),this._sidePanelToggleCallback=i.subscribe({event:e+"/SPY/REVIEWCONTENT/SIDEPANEL/TOGGLECHANGED"},a),this._panelLayoutCallback=i.subscribe({event:e+"/SPY/REVIEWCONTENT/PANEL/LAYOUTCHANGED"},a),this._expandableUICallback=i.subscribe({event:e+"/SPY/REVIEWCONTENT/EXPANDABLEUICHANGED"},a),this._extractableUICallback=i.subscribe({event:e+"/SPY/REVIEWCONTENT/EXTRACTABLEUICHANGED"},a),this._loadingSlideContext=!0,t&&t.onApplicativeControllerInitialized&&t.onApplicativeControllerInitialized()},updateAppContainer:function(t){},onLeavingApp:function(t){i.unsubscribe(this._datadisplayActivatedCallback),i.unsubscribe(this._frameSelectionCallback),i.unsubscribe(this._animScopeCallback),i.unsubscribe(this._legendEditMaxCallback),i.unsubscribe(this._legendEditMinCallback),i.unsubscribe(this._visibilityCallback),i.unsubscribe(this._sidePanelToggleCallback),i.unsubscribe(this._panelLayoutCallback),i.unsubscribe(this._expandableUICallback),i.unsubscribe(this._extractableUICallback)},displayAppContainerState:function(t){var e=function(){t&&t.callback&&t.callback()};t.state?(this._loadingSlideContext=!0,s.restoreStateForMarkupSlide(t.state,{onComplete:function(){this._loadingSlideContext=!1,e()}.bind(this),loadExtensionMode:!0,onExtensionGranted:function(){var i=t.state.context.datadisplay.sequenceName;a.extensionLoad(void 0,i,function(){s.restoreStateForMarkupSlide(t.state,{onComplete:function(){this._loadingSlideContext=!1,e()}.bind(this)})}.bind(this))}})):e()},getCurrentAppContainerState:function(){return s.getStateForMarkupSlide()},getApplicativeContainerID:function(){return"MSR"},getOrderedAppContainerStates:function(t,e){},getCurrentAppContainerStateTitle:function(){return s.getTitleForMarkupSlide()},setMinimalUIFlag:function(t){this._minimalMode=t},getMinimalUIFlag:function(){return this._minimalMode},setAppSectionPlanesVisibleFlag:function(t){},getAppSectionPlanesVisibleFlag:function(){return!0},setAppViewpointManipFlag:function(t){},getAppViewpointManipFlag:function(){return!0},unreferenceApplicativeController:function(t){}})});