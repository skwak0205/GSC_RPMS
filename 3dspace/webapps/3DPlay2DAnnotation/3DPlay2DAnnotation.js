define("DS/3DPlay2DAnnotation/Annotation2DEditPreview",["UWA/Class","DS/3DPlayAnnotationUtils/CursorManager","DS/WebUtils/Vector2","DS/3DPlayAnnotationUtils/AnnotationShapeManipulator","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/3DPlayAnnotationUtils/CanvasShapes","DS/3DPlayAnnotationUtils/ShapeUtils","DS/WebSystem/Environment","DS/WebRunloop/Runloop","DS/3DPlayAnnotationUtils/AnnotationUtilities"],function(t,e,i,a,n,s,o,r,h,d,l){"use strict";return t.extend({init:function(t){this._parent(t),this.annotationEdit=[],this.annotationData=void 0,this.editStarted=!1,this.editStartbbox=[],this.editDataPoints=[],this.currentPageNum=void 0,this.draw=!1,this.frameWindow=t.frameWindow,this.viewer=t.viewer,this.context=t.frameWindow.options.context,this.drawSettings=t.drawSettings,this.hideUICB=t.hideUICB,this.drawCB=t.drawCB,this.editCB=t.editCB,this.endCB=t.endCB,this.begincount=0,this.mode=t.mode,this.data=t.data},begin:function(){this.container=this.viewer.getDocContainer(),this._activateManipulators(),this.mode&&"edition"==this.mode&&this.data||this._activateCustomCursor(),this.runloop=new d({data:this,func:this._runloopFunc}),this.runloop.start(),this.keyboardcallbackBind=this._keyboardcallback.bind(this),n.addEvent(this.container,"onKeyDown",this.keyboardcallbackBind),this.startingZoomScale=this.viewer.getCurrentZoomScale(),this.zoomchange=function(t){(t.zoomScale!=this.startingZoomScale||void 0!==this.currentPageNum&&this.viewer.getCurrentPage().index!=this.currentPageNum&&1==this.viewer.currentView)&&(this.annotationEdit.length&&this.annotationData&&void 0!==this.currentPageNum&&this.viewer&&(this.viewer.createAnnotationWithShapeData({pageNumber:this.currentPageNum,id:this.annotationEdit[0],shape:this.annotationData,render:!1}),this.annotationEdit=[],this.annotationData=void 0,this.editStarted=!1,this.viewer.renderPageAnnotation({pageNumber:this.currentPageNum}),this.currentPageNum=void 0),this.editcanvas&&(this.editcanvas.width=0,this.editcanvas.height=0,this.editcanvas.remove()),this.tempcanvas&&(this.tempcanvas.width=0,this.tempcanvas.height=0,this.tempcanvas.remove()),this.creationcanvas&&(this.creationcanvas.width=0,this.creationcanvas.height=0,this.creationcanvas.remove(),this.creationcanvas=void 0),this.editStartbbox=[],this.editDataPoints=[],this.manipulators.cleanManipulators(),this.startingZoomScale=t.zoomScale,this.mode&&"edition"==this.mode&&this.endCB&&this.endCB())}.bind(this),this.settingsChanged=function(t){this.mode&&"edition"==this.mode&&this.data||this._setMouseCursor("custom"),1==this.editStarted&&this.annotationEdit.length&&this.annotationData&&void 0!==this.currentPageNum&&(this.annotationData.graphicalProp.color=this.drawSettings.getColor(),this.viewer.destroyAnnotations({pageNumber:this.currentPageNum,idList:this.annotationEdit,bToRender:!1}),this.viewer.createAnnotationWithShapeData({pageNumber:this.currentPageNum,id:this.annotationEdit[0],shape:JSON.parse(JSON.stringify(this.annotationData)),editMode:!1,render:!1}),this.viewer.renderPageAnnotation({pageNumber:this.currentPageNum}))}.bind(this),this.zoomToken=this.frameWindow.experience.subscribe("3DPLAY/2DEXP/STATECHANGE",this.zoomchange),this.tokenSettingsChanged=s.subscribe({event:"3DPlay.Annotation.SettingsChanged"},this.settingsChanged),this.mode&&"edition"==this.mode&&this.data&&this._onClick({clientX:this.data.point.x,clientY:this.data.point.y},!0)},end:function(){this.annotationEdit.length&&this.annotationData&&void 0!==this.currentPageNum&&this.viewer&&(this.viewer.createAnnotationWithShapeData({pageNumber:this.currentPageNum,id:this.annotationEdit[0],shape:this.annotationData,render:!1}),this.annotationEdit=[],this.annotationData=void 0,this.editStarted=!1,this.viewer.renderPageAnnotation({pageNumber:this.currentPageNum}),this.currentPageNum=void 0),this.editcanvas&&(this.editcanvas.width=0,this.editcanvas.height=0,this.editcanvas.remove()),this.tempcanvas&&(this.tempcanvas.width=0,this.tempcanvas.height=0,this.tempcanvas.remove()),this.creationcanvas&&(this.creationcanvas.width=0,this.creationcanvas.height=0,this.creationcanvas.remove(),this.creationcanvas=void 0),this.editStartbbox=[],this.editDataPoints=[],this._deactivateCustomCursor(),this._deactivateManipulators(),n.removeEvent(this.container,"onKeyDown",this.keyboardcallbackBind),this.zoomToken&&(this.frameWindow.experience.unsubscribe(this.zoomToken),this.zoomToken=void 0),this.tokenSettingsChanged&&(s.unsubscribe(this.tokenSettingsChanged),this.tokenSettingsChanged=void 0),this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null)},destroy:function(){this._deactivateManipulators(),this._deactivateCustomCursor(),this.frameWindow=void 0,this.viewer=void 0,this.drawSettings=void 0,this.hideUICB=void 0,this.drawCB=void 0,this.editCB=void 0,this.endCB=void 0},_beginMove:function(t){if(1==this.editStarted&&this.annotationEdit.length){var e=this.currentPageNum;this.viewer.createAnnotationWithShapeData({pageNumber:e,id:this.annotationEdit[0],shape:this.annotationData,render:!1}),this.annotationEdit=[],this.annotationData=void 0,this.editStarted=!1,this.currentPageNum=void 0,this.manipulators.cleanManipulators(),this.viewer.renderPageAnnotation({pageNumber:e}),this.viewer.annotationValidateOnClick=!0,this.mode&&"edition"==this.mode&&this.endCB&&this.endCB()}else{this._onClick(t,!1,!0)}},_move:function(t){var e=t.clientY,a={x:t.clientX,y:e},n=this.viewer.getViewerPositionFromMouse(a);if(n&&!1===this.editStarted&&!1===this.draw&&t&&"mousemove"==t.type);else if(!0===this.draw&&n)if(n.pageNumber==this.page){this.endPoint=new i(n.pos.x,n.pos.y);var s={position:this.endPoint,isShiftKeyDown:t.shiftKey&&h.isSet("3DPlay.ActivateShiftStraightLineAnnotation"),direction:this.direction,viewerPoints:this.viewerPoints};this.direction=l._addPositionToViewerPoints(s),this.viewer.drawPreview({pageNumber:this.page,startPoint:this.startPoint,endPoint:this.endPoint,canvas:this.creationcanvas}),this.startPoint=this.endPoint,this.currentScreenPt=new i(t.clientX,e)}else this.page>=0&&this.viewer.renderPageAnnotation({pageNumber:this.page}),this._cleanDrawData()},_endMove:function(t){if(!0===this.draw){this.begincount=0;var e={x:t.clientX,y:t.clientY},a=this.viewer.getViewerPositionFromMouse(e);if(a&&this.page===a.pageNumber){if(1==this.viewerPoints.length&&this.viewerPoints[0].x==a.pos.x&&this.viewerPoints[0].y==a.pos.y);else{var n={position:new i(a.pos.x,a.pos.y),isShiftKeyDown:t.shiftKey&&h.isSet("3DPlay.ActivateShiftStraightLineAnnotation"),direction:this.direction,viewerPoints:this.viewerPoints};if(this.direction=l._addPositionToViewerPoints(n),void 0!==this.direction){(g=r.shapeEval(this.viewerPoints).shape).angle=this.viewer.angle;var s=this.viewer.getPageFromNumber(this.page),d={color:this.drawSettings.getColor(),thickness:parseInt(this.drawSettings.getThickness()),transparency:1},c=s.getScale();d.thickness/=c,this.recognizedshapeData=o.createShape({shapeData:g,settings:d}),this.recognizedshapeData.angle=s.angle}this.direction=void 0}this.viewerLineThickness.length>0&&this.viewerLineThickness.push(this.viewerLineThickness[this.viewerLineThickness.length-1]),this.endPoint=new i(a.pos.x,a.pos.y)}else this.endPoint=this.viewerPoints[this.viewerPoints.length-1];this.viewer.drawPreview({pageNumber:this.page,startPoint:this.startPoint,endPoint:this.endPoint,canvas:this.creationcanvas});var p=!1;if(this.recognizedshapeData)p=!0;else try{var g=r.filterAndSmoothPoints(this.viewerPoints,!0);this.viewerPoints=g}catch(t){console.log("error in shapeUtil")}var v=this.viewerPoints;1==v.length&&((v=[])[0]={x:this.viewerPoints[0].x-.1,y:this.viewerPoints[0].y-.1},v[1]={x:this.viewerPoints[0].x+.1,y:this.viewerPoints[0].y-.1},v[2]={x:this.viewerPoints[0].x+.1,y:this.viewerPoints[0].y+.1},v[3]={x:this.viewerPoints[0].x-.1,y:this.viewerPoints[0].y+.1}),this.recognizedshapeData?this.viewer.drawPreviewWithShapeData({pageNumber:this.page,shapeData:this.recognizedshapeData}):this.viewer.drawPreview({pageNumber:this.page,viewerPoints:v}),this.drawCB({points:this.viewerPoints,pageNumber:this.page,recognizeShape:p,recognizedshapeData:this.recognizedshapeData}),this._cleanDrawData()}},_cleanDrawData:function(){this.draw=!1,this.endPoint=null,this.startPoint=null,this.currentScreenPt=null,this.startScreenPt=null,this.viewerPoints=[],this.viewerLineThickness=[],this.page=-1,this.creationcanvas&&(this.creationcanvas.width=0,this.creationcanvas.height=0,this.creationcanvas.remove(),this.creationcanvas=void 0)},_runloopFunc:function(t){if(this.draw&&this.creationcanvas)if(null==this.stationaryPos)this.stationaryPos=this.currentScreenPt,this.starttime=t.deltaTime,this.recognizedshapeData=void 0;else if(this.currentScreenPt.distanceTo(this.stationaryPos)<5){if(this.starttime=this.starttime+t.deltaTime,300<this.starttime){var e=r.shapeEval(this.viewerPoints).shape;if(e.angle=this.viewer.angle,"unknownOpen"!=e.type&&"unknownClosed"!=e.type){var i=this.viewer.getPageFromNumber(this.page),a={color:this.drawSettings.getColor(),thickness:parseInt(this.drawSettings.getThickness()),transparency:1},n=i.getScale();a.thickness/=n,this.recognizedshapeData=o.createShape({shapeData:e,settings:a}),this.recognizedshapeData.angle=i.angle,(s=this.creationcanvas.getContext("2d")).clearRect(0,0,this.creationcanvas.width,this.creationcanvas.height),s.globalAlpha=1,o.drawShape({shape:JSON.parse(JSON.stringify(this.recognizedshapeData)),canvas:this.creationcanvas,scale:i.getScale(),angle:i.angle,height:i.getOriginalHeight(),width:i.getOriginalWidth()}),s.globalAlpha=.3,this.viewer.drawPreview({pageNumber:this.page,viewerPoints:this.viewerPoints,canvas:this.creationcanvas})}}}else{var s;if(this.recognizedshapeData)this.stationaryPos=this.currentScreenPt,this.starttime=t.deltaTime,this.recognizedshapeData=void 0,(s=this.creationcanvas.getContext("2d")).clearRect(0,0,this.creationcanvas.width,this.creationcanvas.height),s.globalAlpha=1,this.viewer.drawPreview({pageNumber:this.page,viewerPoints:this.viewerPoints,canvas:this.creationcanvas});this.stationaryPos=this.currentScreenPt,this.starttime=t.deltaTime}},_initCreationCanvas:function(){var t=this.viewer.getPageFromNumber(this.page),e=t.getOriginalWidth(),i=t.getOriginalHeight(),a=(t.uiElements.pageContainer.clientWidth,window.devicePixelRatio>1?window.devicePixelRatio:1);t.canvas.clientWidth,t.canvas.width;this.creationcanvas=new UWA.Element("canvas",{id:"creationcanvas",context:this.context,styles:{width:"100%",height:"100%",position:"absolute",top:"0px",left:"0px","background-color":"transparent","pointer-events":"none","z-index":10}}).inject(t.uiElements.pageContainer);var n=e*t.getScale(),s=i*t.getScale(),o=this.creationcanvas.getContext("2d"),r=n*(a=window.devicePixelRatio>1?window.devicePixelRatio:1),h=s*a;this.creationcanvas.width=r,this.creationcanvas.height=h,o.scale(a,a),o.strokeStyle="transparent",o.clearRect(0,0,this.creationcanvas.width,this.creationcanvas.height)},_onCancel:function(){this._cleanDrawData()},_onClick:function(t,e,a){this.hideUICB();var n={x:t.clientX,y:t.clientY},s=this.viewer.getViewerPositionFromMouse(n);if(s)if(!0===a){var o;if(this.annotationEdit.length)o=this.editStarted?this.currentPageNum:s.pageNumber,this.viewer.createAnnotationWithShapeData({pageNumber:o,id:this.annotationEdit[0],shape:this.annotationData,render:!1}),this.annotationEdit=[],this.annotationData=void 0,this.editStarted=!1,this.currentPageNum=void 0,this.manipulators.cleanManipulators(),this.viewer.renderPageAnnotation({pageNumber:o});this.hideUICB(),this.viewerPoints=[],this.viewerLineThickness=[],this.page=-1,this.page=s.pageNumber,this._initCreationCanvas(),this.viewer.setDrawStyle({pageNumber:this.page,color:this.drawSettings.getColor(),thickness:parseInt(this.drawSettings.getThickness()),transparency:1}),this.viewer.setDrawStyle({pageNumber:this.page,color:this.drawSettings.getColor(),thickness:parseInt(this.drawSettings.getThickness()),transparency:1,canvas:this.creationcanvas}),this.startPoint=new i(s.pos.x,s.pos.y),this.currentScreenPt=new i(t.clientX,t.clientY),this.startScreenPt=new i(t.clientX,t.clientY),this.viewerPoints.push(new i(s.pos.x,s.pos.y)),this.draw=!0}else{var r=this.viewer.getUnderneathAnnotations({pageNumber:s.pageNumber,positionX:s.pos.x,positionY:s.pos.y});if(r.length)r.splice(1);else if(this.mode&&"edition"==this.mode&&this.data&&this.endCB)return void this.endCB();if(!0===e)if(0===this.annotationEdit.length&&r.length)if(this.annotationEdit=r,(p=this.viewer.getUnProcessedAnnotationInformation({pageNumber:s.pageNumber,annotID:r[0]}))&&p.data&&"text"==p.data.type);else{this.annotationData=p;var h=this.viewer.getProcessedAnnotationInformation({pageNumber:s.pageNumber,annotID:r[0]}),d=this.viewer.getPageFromNumber(s.pageNumber);this.annotationData.data=h.data,this.annotationData.angle=d.angle,this.viewer.destroyAnnotations({pageNumber:s.pageNumber,idList:r,bToRender:!1}),this.viewer.createAnnotationWithShapeData({pageNumber:s.pageNumber,id:r[0],shape:JSON.parse(JSON.stringify(this.annotationData)),editMode:!1,render:!1}),this.viewer.renderPageAnnotation({pageNumber:s.pageNumber})}var l=!1;if(this.annotationEdit.length==r.length)for(var c=0;c<this.annotationEdit.length&&!(0>r.indexOf(this.annotationEdit[c]));c++)c==this.annotationEdit.length-1&&(l=!0);if(1==r.length&&1==l){d=this.viewer.getPageFromNumber(s.pageNumber);var p=this.viewer.getUnProcessedAnnotationInformation({pageNumber:s.pageNumber,annotID:r[0]});if(0==this.editStarted){this.editStarted=!0,this.currentPageNum=s.pageNumber;var g=this.viewer.getAnnotationInformation({pageNumber:s.pageNumber,annotID:this.annotationEdit[0]});if(g){d=this.viewer.getPageFromNumber(s.pageNumber);var v=!1;g.bbox[0].y<30&&(v=!0),this.manipulators.createManipulators({bbox:g.bbox,color:this.annotationData.graphicalProp.color,container:d.uiElements.pageContainer,flipRotatePosition:v})}this._cleanDrawData()}}}},_startShapeEdit:function(t){var e=this.viewer.getPageFromNumber(this.currentPageNum),a=e.getOriginalWidth(),n=e.getOriginalHeight(),s=(e.uiElements.pageContainer.clientWidth,window.devicePixelRatio>1?window.devicePixelRatio:1),r=e.canvas.clientWidth*s/e.canvas.width;if(this.annotationData.data&&this.annotationData.data.path)for(var h=0;h<this.annotationData.data.path.length;h++)this.annotationData.data.path[h]=new i(this.annotationData.data.path[h].x,this.annotationData.data.path[h].y);var d=this.viewer.getAnnotationInformation({pageNumber:this.currentPageNum,annotID:this.annotationEdit[0]});this.editStartbbox=d.bbox,this.editDataPoints=d.dataPoints,this.viewer.destroyAnnotations({pageNumber:this.currentPageNum,idList:this.annotationEdit,bToRender:!1});var l,c,p,g=[];if(this.annot2DPoints=[],this.currDeltaType=t.deltaType,"Rotate"==t.deltaType){var v={x:d.bbox[0].x+(d.bbox[1].x-d.bbox[0].x)/2,y:d.bbox[0].y+(d.bbox[2].y-d.bbox[1].y)/2},u=d.bbox[2].y-d.bbox[1].y,w=d.bbox[1].x-d.bbox[0].x,m=Math.sqrt(u/2*(u/2)+w/2*(w/2));g.push({x:v.x-m,y:v.y-m}),g.push({x:v.x+m,y:v.y-m}),g.push({x:v.x+m,y:v.y+m}),g.push({x:v.x-m,y:v.y+m}),this.annot2DPoints=JSON.parse(JSON.stringify(this.annotationData));for(h=0;h<this.annot2DPoints.data.path.length;h++)this.annot2DPoints.data.path[h]=new i(this.annot2DPoints.data.path[h].x,this.annot2DPoints.data.path[h].y)}"Rotate"==t.deltaType?(this.editcanvas=new UWA.Element("canvas",{id:"editCanvas",context:this.context,styles:{height:g[2].y-g[1].y+"px",width:g[1].x-g[0].x+"px",position:"absolute","z-index":5,top:g[0].y+"px",left:g[0].x+"px"}}).inject(e.uiElements.pageContainer),l=g[2].y-g[1].y,c=g[1].x-g[0].x,p=g[0]):(this.editcanvas=new UWA.Element("canvas",{id:"editCanvas",context:this.context,styles:{height:d.bbox[2].y-d.bbox[1].y+"px",width:d.bbox[1].x-d.bbox[0].x+"px",position:"absolute","z-index":5,top:d.bbox[0].y+"px",left:d.bbox[0].x+"px"}}).inject(e.uiElements.pageContainer),l=d.bbox[2].y-d.bbox[1].y,c=d.bbox[1].x-d.bbox[0].x,p=d.bbox[0]),this.tempcanvas=new UWA.Element("canvas",{id:"tempCanvas",context:this.context,styles:{width:"100%",height:"100%",position:"absolute","z-index":5,top:"0px",left:"0px","background-color":"transparent"}}).inject(e.uiElements.pageContainer);var b=a*e.getScale(),y=n*e.getScale(),D=this.tempcanvas.getContext("2d"),f=b*(s=window.devicePixelRatio>1?window.devicePixelRatio:1),x=y*s;this.tempcanvas.width=f,this.tempcanvas.height=x,D.scale(s,s),D.strokeStyle="transparent",D.clearRect(0,0,this.tempcanvas.width,this.tempcanvas.height),o.drawShape({shape:JSON.parse(JSON.stringify(this.annotationData)),editMode:!1,canvas:this.tempcanvas,scale:e.getScale(),angle:e.angle,height:e.getOriginalHeight(),width:e.getOriginalWidth()});var P=this.editcanvas.getContext("2d");this.editcanvas.width=c*s,this.editcanvas.height=l*s,P.scale(s,s),P.strokeStyle="transparent",P.clearRect(0,0,c*s,l*s),P.drawImage(this.tempcanvas,p.x/r*s,p.y/r*s,c/r*s,l/r*s,0,0,c,l),this.tempcanvas.style.display="none",t.cursor&&this.editcanvas.style.setProperty("cursor",t.cursor),this.viewer.renderPageAnnotation({pageNumber:this.currentPageNum})},_editShape:function(t){var e={x:t.event.clientX,y:t.event.clientY},a=this.viewer.getViewerPositionFromMouse(e);if(a&&a.pageNumber==this.currentPageNum){var n=this.viewer.getPageFromNumber(this.currentPageNum),s=n.getPhysicalScale(),h=window.devicePixelRatio>1?window.devicePixelRatio:1,d=n.canvas.clientWidth*h/n.canvas.width;if("BothWithCenter"==t.deltaType){var l=parseFloat(this.editcanvas.style.top)+t.deltaY;(x=parseFloat(this.editcanvas.style.left)+t.deltaX)<=0?x=0:x>=n.uiElements.pageContainer.offsetWidth-parseFloat(this.editcanvas.style.width)&&(x=n.uiElements.pageContainer.offsetWidth-parseFloat(this.editcanvas.style.width)),l<=0?l=0:l>=n.uiElements.pageContainer.offsetHeight-parseFloat(this.editcanvas.style.height)&&(l=n.uiElements.pageContainer.offsetHeight-parseFloat(this.editcanvas.style.height)),this.editcanvas.style.top=l+"px",this.editcanvas.style.left=x+"px"}else{for(var c=!1,p=JSON.parse(JSON.stringify(this.annotationData)),g=0;g<p.data.path.length;g++)p.data.path[g]=new i(p.data.path[g].x,p.data.path[g].y);if("BottomWithCenter"==t.deltaType){var v=parseFloat(this.editcanvas.style.height)+t.deltaY;if(parseFloat(this.editcanvas.style.top)>=n.uiElements.pageContainer.offsetHeight-v&&(v=parseFloat(this.editcanvas.style.height)),0<v){var u=1*v/s-(C=1*(this.editStartbbox[2].y-this.editStartbbox[1].y)/s),w=1*this.editStartbbox[1].y/s;for(g=0;g<p.data.path.length;g++)p.data.path[g].y=p.data.path[g].y+(p.data.path[g].y-w)/C*u;this.editcanvas.style.height=v+"px"}else c=!0}else if("TopWithCenter"==t.deltaType){v=parseFloat(this.editcanvas.style.height)-t.deltaY;if((l=parseFloat(this.editcanvas.style.top)+t.deltaY)<=0&&(l=0,v=parseFloat(this.editcanvas.style.height)),0<v){u=1*v/s-(C=1*(this.editStartbbox[2].y-this.editStartbbox[1].y)/s);var m=1*this.editStartbbox[2].y/s;for(g=0;g<p.data.path.length;g++)p.data.path[g].y=p.data.path[g].y+(p.data.path[g].y-m)/C*u;this.editcanvas.style.height=v+"px",this.editcanvas.style.top=l+"px"}else c=!0}else if("LeftWithCenter"==t.deltaType){var b=parseFloat(this.editcanvas.style.width)-t.deltaX;if((x=parseFloat(this.editcanvas.style.left)+t.deltaX)<=0&&(x=0,b=parseFloat(this.editcanvas.style.width)),0<b){var y=1*b/s-(P=1*(this.editStartbbox[1].x-this.editStartbbox[0].x)/s),D=1*this.editStartbbox[1].x/s;for(g=0;g<p.data.path.length;g++)p.data.path[g].x=p.data.path[g].x+(p.data.path[g].x-D)/P*y;this.editcanvas.style.width=b+"px",this.editcanvas.style.left=x+"px"}else c=!0}else if("RightWithCenter"==t.deltaType){b=parseFloat(this.editcanvas.style.width)+t.deltaX;if(parseFloat(this.editcanvas.style.left)>=n.uiElements.pageContainer.offsetWidth-b&&(b=parseFloat(this.editcanvas.style.width)),0<b){y=1*b/s-(P=1*(this.editStartbbox[1].x-this.editStartbbox[0].x)/s);var f=1*this.editStartbbox[0].x/s;for(g=0;g<p.data.path.length;g++)p.data.path[g].x=p.data.path[g].x+(p.data.path[g].x-f)/P*y;this.editcanvas.style.width=b+"px"}else c=!0}else if("LeftWithTop"==t.deltaType){b=parseFloat(this.editcanvas.style.width)-t.deltaX;var x=parseFloat(this.editcanvas.style.left)+t.deltaX;v=parseFloat(this.editcanvas.style.height)-t.deltaY;if((l=parseFloat(this.editcanvas.style.top)+t.deltaY)<=0&&(l=0,v=parseFloat(this.editcanvas.style.height)),x<=0&&(x=0,b=parseFloat(this.editcanvas.style.width)),0<b&&0<v){for(y=1*b/s-(P=1*(this.editStartbbox[1].x-this.editStartbbox[0].x)/s),D=1*this.editStartbbox[1].x/s,u=1*v/s-(C=1*(this.editStartbbox[2].y-this.editStartbbox[1].y)/s),m=1*this.editStartbbox[2].y/s,g=0;g<p.data.path.length;g++)p.data.path[g].x=p.data.path[g].x+(p.data.path[g].x-D)/P*y,p.data.path[g].y=p.data.path[g].y+(p.data.path[g].y-m)/C*u;this.editcanvas.style.width=b+"px",this.editcanvas.style.left=x+"px",this.editcanvas.style.height=v+"px",this.editcanvas.style.top=l+"px"}else c=!0}else if("RightWithBottom"==t.deltaType){b=parseFloat(this.editcanvas.style.width)+t.deltaX,v=parseFloat(this.editcanvas.style.height)+t.deltaY;if(parseFloat(this.editcanvas.style.top)>=n.uiElements.pageContainer.offsetHeight-v&&(v=parseFloat(this.editcanvas.style.height)),parseFloat(this.editcanvas.style.left)>=n.uiElements.pageContainer.offsetWidth-b&&(b=parseFloat(this.editcanvas.style.width)),0<b&&0<v){for(y=1*b/s-(P=1*(this.editStartbbox[1].x-this.editStartbbox[0].x)/s),f=1*this.editStartbbox[0].x/s,u=1*v/s-(C=1*(this.editStartbbox[2].y-this.editStartbbox[1].y)/s),w=1*this.editStartbbox[1].y/s,g=0;g<p.data.path.length;g++)p.data.path[g].x=p.data.path[g].x+(p.data.path[g].x-f)/P*y,p.data.path[g].y=p.data.path[g].y+(p.data.path[g].y-w)/C*u;this.editcanvas.style.width=b+"px",this.editcanvas.style.height=v+"px"}else c=!0}else if("LeftWithBottom"==t.deltaType){b=parseFloat(this.editcanvas.style.width)-t.deltaX,x=parseFloat(this.editcanvas.style.left)+t.deltaX,v=parseFloat(this.editcanvas.style.height)+t.deltaY;if(x<=0&&(x=0,b=parseFloat(this.editcanvas.style.width)),parseFloat(this.editcanvas.style.top)>=n.uiElements.pageContainer.offsetHeight-v&&(v=parseFloat(this.editcanvas.style.height)),0<b&&0<v){for(y=1*b/s-(P=1*(this.editStartbbox[1].x-this.editStartbbox[0].x)/s),D=1*this.editStartbbox[1].x/s,u=1*v/s-(C=1*(this.editStartbbox[2].y-this.editStartbbox[1].y)/s),w=1*this.editStartbbox[1].y/s,g=0;g<p.data.path.length;g++)p.data.path[g].x=p.data.path[g].x+(p.data.path[g].x-D)/P*y,p.data.path[g].y=p.data.path[g].y+(p.data.path[g].y-w)/C*u;this.editcanvas.style.width=b+"px",this.editcanvas.style.left=x+"px",this.editcanvas.style.height=v+"px"}else c=!0}else if("RightWithTop"==t.deltaType){b=parseFloat(this.editcanvas.style.width)+t.deltaX,v=parseFloat(this.editcanvas.style.height)-t.deltaY,l=parseFloat(this.editcanvas.style.top)+t.deltaY;if(parseFloat(this.editcanvas.style.left)>=n.uiElements.pageContainer.offsetWidth-b&&(b=parseFloat(this.editcanvas.style.width)),l<=0&&(l=0,v=parseFloat(this.editcanvas.style.height)),0<b&&0<v){var P,C;for(y=1*b/s-(P=1*(this.editStartbbox[1].x-this.editStartbbox[0].x)/s),f=1*this.editStartbbox[0].x/s,u=1*v/s-(C=1*(this.editStartbbox[2].y-this.editStartbbox[1].y)/s),m=1*this.editStartbbox[2].y/s,g=0;g<p.data.path.length;g++)p.data.path[g].x=p.data.path[g].x+(p.data.path[g].x-f)/P*y,p.data.path[g].y=p.data.path[g].y+(p.data.path[g].y-m)/C*u;this.editcanvas.style.width=b+"px",this.editcanvas.style.height=v+"px",this.editcanvas.style.top=l+"px"}else c=!0}else if("Rotate"==t.deltaType){var S={x:(this.editStartbbox[3].x+this.editStartbbox[1].x)/2,y:(this.editStartbbox[3].y+this.editStartbbox[1].y)/2};S.x=1*S.x/s,S.y=1*S.y/s,"line"==this.annot2DPoints.type&&(S.y=(this.annot2DPoints.data.path[0].y+this.annot2DPoints.data.path[this.annot2DPoints.data.path.length-1].y)/2,S.x=(this.annot2DPoints.data.path[0].x+this.annot2DPoints.data.path[this.annot2DPoints.data.path.length-1].x)/2);for(g=0;g<this.annot2DPoints.data.path.length;g++){var A=new i(this.annot2DPoints.data.path[g].x,this.annot2DPoints.data.path[g].y);A.rotateAround(S,t.deltaAngle),this.annot2DPoints.data.path[g]=A}}if(0==c){if("circle"!=p.type&&"ellipse"!=p.type&&"line"!=p.type||"Rotate"==t.deltaType){if(("ellipse"==this.annot2DPoints.type||"line"==this.annot2DPoints.type)&&"Rotate"==t.deltaType)if("line"==this.annot2DPoints.type)this.annot2DPoints.data.start=this.annot2DPoints.data.path[0],this.annot2DPoints.data.end=this.annot2DPoints.data.path[this.annot2DPoints.data.path.length-1];else{_=r.shapeEval(this.annot2DPoints.data.path).shape,T=o.createShape({shapeData:_,settings:this.annot2DPoints.graphicalProp});this.annot2DPoints.data=T.data,this.annot2DPoints.type=T.type}}else{var _=r.shapeEval(p.data.path).shape,T=o.createShape({shapeData:_,settings:p.graphicalProp});p.data=T.data,p.type=T.type}this.tempcanvas.style.display="inherit",this.tempcanvas.getContext("2d").clearRect(0,0,this.tempcanvas.width,this.tempcanvas.height),"Rotate"==t.deltaType?o.drawShape({shape:JSON.parse(JSON.stringify(this.annot2DPoints)),editMode:!1,canvas:this.tempcanvas,scale:n.getScale(),angle:n.angle,height:n.getOriginalHeight(),width:n.getOriginalWidth()}):o.drawShape({shape:JSON.parse(JSON.stringify(p)),editMode:!1,canvas:this.tempcanvas,scale:n.getScale(),angle:n.angle,height:n.getOriginalHeight(),width:n.getOriginalWidth()});var M=this.editcanvas.getContext("2d");this.editcanvas.width=parseFloat(this.editcanvas.style.width)*h,this.editcanvas.height=parseFloat(this.editcanvas.style.height)*h,M.scale(h,h),M.strokeStyle="transparent",M.clearRect(0,0,parseFloat(this.editcanvas.style.width)*h,parseFloat(this.editcanvas.style.height)*h),M.drawImage(this.tempcanvas,parseFloat(this.editcanvas.style.left)/d*h,parseFloat(this.editcanvas.style.top)/d*h,parseFloat(this.editcanvas.style.width)/d*h,parseFloat(this.editcanvas.style.height)/d*h,0,0,parseFloat(this.editcanvas.style.width),parseFloat(this.editcanvas.style.height))}}t.cursor&&this.editcanvas.style.setProperty("cursor",t.cursor);var E=[{x:parseFloat(this.editcanvas.style.left),y:parseFloat(this.editcanvas.style.top)},{x:parseFloat(this.editcanvas.style.left)+parseFloat(this.editcanvas.style.width),y:parseFloat(this.editcanvas.style.top)},{x:parseFloat(this.editcanvas.style.left)+parseFloat(this.editcanvas.style.width),y:parseFloat(this.editcanvas.style.top)+parseFloat(this.editcanvas.style.height)},{x:parseFloat(this.editcanvas.style.left),y:parseFloat(this.editcanvas.style.top)+parseFloat(this.editcanvas.style.height)}],N=!1;parseFloat(this.editcanvas.style.top)<30&&(N=!0),"Rotate"==t.deltaType?this.manipulators.moveRotateManipulators({x:t.finalX,y:t.finalY}):this.manipulators.moveManipulators({bbox:E,flipRotatePosition:N})}},_endShapeEdit:function(t){var e=(_=this.viewer.getPageFromNumber(this.currentPageNum)).getPhysicalScale(),a=window.devicePixelRatio>1?window.devicePixelRatio:1,n=_.canvas.clientWidth*a/_.canvas.width;if("BothWithCenter"==t.deltaType){var s={x:this.editStartbbox[0].x+(this.editStartbbox[1].x-this.editStartbbox[0].x)/2,y:this.editStartbbox[0].y+(this.editStartbbox[2].y-this.editStartbbox[1].y)/2},h={x:parseFloat(this.editcanvas.style.left)+parseFloat(this.editcanvas.style.width)/2,y:parseFloat(this.editcanvas.style.top)+parseFloat(this.editcanvas.style.height)/2},d={x:1*(h.x-s.x)/e,y:1*(h.y-s.y)/e};if("circle"==this.annotationData.type||"ellipse"==this.annotationData.type||"line"==this.annotationData.type){"line"==this.annotationData.type?(this.annotationData.data.start.x=this.annotationData.data.start.x+d.x,this.annotationData.data.start.y=this.annotationData.data.start.y+d.y,this.annotationData.data.end.x=this.annotationData.data.end.x+d.x,this.annotationData.data.end.y=this.annotationData.data.end.y+d.y):(this.annotationData.data.centre.x=this.annotationData.data.centre.x+d.x,this.annotationData.data.centre.y=this.annotationData.data.centre.y+d.y);for(var l=0;l<this.annotationData.data.path.length;l++)this.annotationData.data.path[l].x=this.annotationData.data.path[l].x+d.x,this.annotationData.data.path[l].y=this.annotationData.data.path[l].y+d.y}else if("text"==this.annotationData.type)this.annotationData.data.path.bottomLeft.x=this.annotationData.data.path.bottomLeft.x+d.x,this.annotationData.data.path.bottomLeft.y=this.annotationData.data.path.bottomLeft.y+d.y,this.annotationData.data.path.bottomRight.x=this.annotationData.data.path.bottomRight.x+d.x,this.annotationData.data.path.bottomRight.y=this.annotationData.data.path.bottomRight.y+d.y,this.annotationData.data.path.topLeft.x=this.annotationData.data.path.topLeft.x+d.x,this.annotationData.data.path.topLeft.y=this.annotationData.data.path.topLeft.y+d.y,this.annotationData.data.path.topRight.x=this.annotationData.data.path.topRight.x+d.x,this.annotationData.data.path.topRight.y=this.annotationData.data.path.topRight.y+d.y,this.annotationData.data.point.x=this.annotationData.data.point.x+d.x,this.annotationData.data.point.y=this.annotationData.data.point.y+d.y;else for(l=0;l<this.annotationData.data.path.length;l++)this.annotationData.data.path[l].x=this.annotationData.data.path[l].x+d.x,this.annotationData.data.path[l].y=this.annotationData.data.path[l].y+d.y}else if("BottomWithCenter"==t.deltaType){var c=1*(this.editStartbbox[2].y-this.editStartbbox[1].y)/e,p=1*parseFloat(this.editcanvas.style.height)/e-c,g=1*this.editStartbbox[1].y/e;for(l=0;l<this.annotationData.data.path.length;l++)this.annotationData.data.path[l].y=this.annotationData.data.path[l].y+(this.annotationData.data.path[l].y-g)/c*p;if("circle"==this.annotationData.type||"ellipse"==this.annotationData.type||"line"==this.annotationData.type){var v=r.shapeEval(this.annotationData.data.path).shape,u=o.createShape({shapeData:v,settings:this.annotationData.graphicalProp});this.annotationData.data=u.data,this.annotationData.type=u.type}}else if("TopWithCenter"==t.deltaType){c=1*(this.editStartbbox[2].y-this.editStartbbox[1].y)/e,p=1*parseFloat(this.editcanvas.style.height)/e-c;var w=1*this.editStartbbox[2].y/e;for(l=0;l<this.annotationData.data.path.length;l++)this.annotationData.data.path[l].y=this.annotationData.data.path[l].y+(this.annotationData.data.path[l].y-w)/c*p;if("circle"==this.annotationData.type||"ellipse"==this.annotationData.type||"line"==this.annotationData.type){v=r.shapeEval(this.annotationData.data.path).shape,u=o.createShape({shapeData:v,settings:this.annotationData.graphicalProp});this.annotationData.data=u.data,this.annotationData.type=u.type}}else if("RightWithCenter"==t.deltaType){var m=1*(this.editStartbbox[1].x-this.editStartbbox[0].x)/e,b=1*parseFloat(this.editcanvas.style.width)/e-m,y=1*this.editStartbbox[0].x/e;for(l=0;l<this.annotationData.data.path.length;l++)this.annotationData.data.path[l].x=this.annotationData.data.path[l].x+(this.annotationData.data.path[l].x-y)/m*b;if("circle"==this.annotationData.type||"ellipse"==this.annotationData.type||"line"==this.annotationData.type){v=r.shapeEval(this.annotationData.data.path).shape,u=o.createShape({shapeData:v,settings:this.annotationData.graphicalProp});this.annotationData.data=u.data,this.annotationData.type=u.type}}else if("LeftWithCenter"==t.deltaType){m=1*(this.editStartbbox[1].x-this.editStartbbox[0].x)/e,b=1*parseFloat(this.editcanvas.style.width)/e-m;var D=1*this.editStartbbox[1].x/e;for(l=0;l<this.annotationData.data.path.length;l++)this.annotationData.data.path[l].x=this.annotationData.data.path[l].x+(this.annotationData.data.path[l].x-D)/m*b;if("circle"==this.annotationData.type||"ellipse"==this.annotationData.type||"line"==this.annotationData.type){v=r.shapeEval(this.annotationData.data.path).shape,u=o.createShape({shapeData:v,settings:this.annotationData.graphicalProp});this.annotationData.data=u.data,this.annotationData.type=u.type}}else if("RightWithBottom"==t.deltaType){for(m=1*(this.editStartbbox[1].x-this.editStartbbox[0].x)/e,b=1*parseFloat(this.editcanvas.style.width)/e-m,y=1*this.editStartbbox[0].x/e,c=1*(this.editStartbbox[2].y-this.editStartbbox[1].y)/e,p=1*parseFloat(this.editcanvas.style.height)/e-c,g=1*this.editStartbbox[1].y/e,l=0;l<this.annotationData.data.path.length;l++)this.annotationData.data.path[l].x=this.annotationData.data.path[l].x+(this.annotationData.data.path[l].x-y)/m*b,this.annotationData.data.path[l].y=this.annotationData.data.path[l].y+(this.annotationData.data.path[l].y-g)/c*p;if("circle"==this.annotationData.type||"ellipse"==this.annotationData.type||"line"==this.annotationData.type){v=r.shapeEval(this.annotationData.data.path).shape,u=o.createShape({shapeData:v,settings:this.annotationData.graphicalProp});this.annotationData.data=u.data,this.annotationData.type=u.type}}else if("LeftWithTop"==t.deltaType){for(m=1*(this.editStartbbox[1].x-this.editStartbbox[0].x)/e,b=1*parseFloat(this.editcanvas.style.width)/e-m,D=1*this.editStartbbox[1].x/e,c=1*(this.editStartbbox[2].y-this.editStartbbox[1].y)/e,p=1*parseFloat(this.editcanvas.style.height)/e-c,w=1*this.editStartbbox[2].y/e,l=0;l<this.annotationData.data.path.length;l++)this.annotationData.data.path[l].x=this.annotationData.data.path[l].x+(this.annotationData.data.path[l].x-D)/m*b,this.annotationData.data.path[l].y=this.annotationData.data.path[l].y+(this.annotationData.data.path[l].y-w)/c*p;if("circle"==this.annotationData.type||"ellipse"==this.annotationData.type||"line"==this.annotationData.type){v=r.shapeEval(this.annotationData.data.path).shape,u=o.createShape({shapeData:v,settings:this.annotationData.graphicalProp});this.annotationData.data=u.data,this.annotationData.type=u.type}}else if("RightWithTop"==t.deltaType){for(m=1*(this.editStartbbox[1].x-this.editStartbbox[0].x)/e,b=1*parseFloat(this.editcanvas.style.width)/e-m,y=1*this.editStartbbox[0].x/e,c=1*(this.editStartbbox[2].y-this.editStartbbox[1].y)/e,p=1*parseFloat(this.editcanvas.style.height)/e-c,w=1*this.editStartbbox[2].y/e,l=0;l<this.annotationData.data.path.length;l++)this.annotationData.data.path[l].x=this.annotationData.data.path[l].x+(this.annotationData.data.path[l].x-y)/m*b,this.annotationData.data.path[l].y=this.annotationData.data.path[l].y+(this.annotationData.data.path[l].y-w)/c*p;if("circle"==this.annotationData.type||"ellipse"==this.annotationData.type||"line"==this.annotationData.type){v=r.shapeEval(this.annotationData.data.path).shape,u=o.createShape({shapeData:v,settings:this.annotationData.graphicalProp});this.annotationData.data=u.data,this.annotationData.type=u.type}}else if("LeftWithBottom"==t.deltaType){for(m=1*(this.editStartbbox[1].x-this.editStartbbox[0].x)/e,b=1*parseFloat(this.editcanvas.style.width)/e-m,D=1*this.editStartbbox[1].x/e,c=1*(this.editStartbbox[2].y-this.editStartbbox[1].y)/e,p=1*parseFloat(this.editcanvas.style.height)/e-c,g=1*this.editStartbbox[1].y/e,l=0;l<this.annotationData.data.path.length;l++)this.annotationData.data.path[l].x=this.annotationData.data.path[l].x+(this.annotationData.data.path[l].x-D)/m*b,this.annotationData.data.path[l].y=this.annotationData.data.path[l].y+(this.annotationData.data.path[l].y-g)/c*p;if("circle"==this.annotationData.type||"ellipse"==this.annotationData.type||"line"==this.annotationData.type){v=r.shapeEval(this.annotationData.data.path).shape,u=o.createShape({shapeData:v,settings:this.annotationData.graphicalProp});this.annotationData.data=u.data,this.annotationData.type=u.type}}else if("Rotate"==t.deltaType){a=window.devicePixelRatio>1?window.devicePixelRatio:1;var f=this.tempcanvas.width/a*n,x=this.tempcanvas.height/a*n,P=0,C=0;parseFloat(this.editcanvas.style.top)<0?C=1*Math.abs(parseFloat(this.editcanvas.style.top))/e:parseFloat(this.editcanvas.style.top)>0&&parseFloat(this.editcanvas.style.top)+parseFloat(this.editcanvas.style.height)>x&&(C=1*(x-parseFloat(this.editcanvas.style.top)-parseFloat(this.editcanvas.style.height))/e),parseFloat(this.editcanvas.style.left)<0?P=1*Math.abs(parseFloat(this.editcanvas.style.left))/e:parseFloat(this.editcanvas.style.left)>0&&parseFloat(this.editcanvas.style.left)+parseFloat(this.editcanvas.style.width)>f&&(P=1*(f-parseFloat(this.editcanvas.style.left)-parseFloat(this.editcanvas.style.width))/e),this.annotationData=JSON.parse(JSON.stringify(this.annot2DPoints));for(l=0;l<this.annotationData.data.path.length;l++){var S=new i(this.annotationData.data.path[l].x+P,this.annotationData.data.path[l].y+C);this.annotationData.data.path[l]=S}if("circle"==this.annotationData.type||"ellipse"==this.annotationData.type||"line"==this.annotationData.type){v=r.shapeEval(this.annotationData.data.path).shape,u=o.createShape({shapeData:v,settings:this.annotationData.graphicalProp});this.annotationData.data=u.data,this.annotationData.type=u.type}}parseFloat(this.editcanvas.style.left),parseFloat(this.editcanvas.style.top),parseFloat(this.editcanvas.style.left),parseFloat(this.editcanvas.style.width),parseFloat(this.editcanvas.style.top),parseFloat(this.editcanvas.style.left),parseFloat(this.editcanvas.style.width),parseFloat(this.editcanvas.style.top),parseFloat(this.editcanvas.style.height),parseFloat(this.editcanvas.style.left),parseFloat(this.editcanvas.style.top),parseFloat(this.editcanvas.style.height);this.viewer.createAnnotationWithShapeData({pageNumber:this.currentPageNum,id:this.annotationEdit[0],shape:JSON.parse(JSON.stringify(this.annotationData)),editMode:!1,render:!1}),this.viewer.renderPageAnnotation({pageNumber:this.currentPageNum});var A=this.viewer.getAnnotationInformation({pageNumber:this.currentPageNum,annotID:this.annotationEdit[0]});if(A){var _=this.viewer.getPageFromNumber(this.currentPageNum),T=!1;A.bbox[0].y<30&&(T=!0),this.manipulators.createManipulators({bbox:A.bbox,color:this.annotationData.graphicalProp.color,container:_.uiElements.pageContainer,flipRotatePosition:T})}this.editcanvas&&(this.editcanvas.width=0,this.editcanvas.height=0,this.editcanvas.remove()),this.tempcanvas&&(this.tempcanvas.width=0,this.tempcanvas.height=0,this.tempcanvas.remove()),this.editStartbbox=[],this.editDataPoints=[],this.currDeltaType=""},_activateManipulators:function(){this.pointerOut=function(t){if(0==t.button)if(this.direction=void 0,this.draw)this.page>=0&&this.viewer.renderPageAnnotation({pageNumber:this.page}),this._cleanDrawData();else if(1==this.editStarted&&this.annotationEdit.length&&this.annotationData&&this.viewer&&null!=this.currentPageNum){var e={x:t.clientX,y:t.clientY};this.viewer.getViewerPositionFromMouse(e);this.currDeltaType&&(this.manipulators.manipulation=!1,this.manipulators.manipulatorType="",this._endShapeEdit({deltaType:this.currDeltaType}))}},this.manipulators=new a({eventTarget:this.container,floatingBarContainer:this.viewer.getPagesContainer(),frameWindow:this.frameWindow,context:this.context,viewer:this.viewer,beginMove:this._beginMove.bind(this),move:this._move.bind(this),endMove:this._endMove.bind(this),onCancel:this._onCancel.bind(this),startShapeEdit:this._startShapeEdit.bind(this),editShape:this._editShape.bind(this),endShapeEdit:this._endShapeEdit.bind(this),mouseLeave:this.pointerOut.bind(this),coordinateScaling:this.coordinateScaling.bind(this),floatingbarCallback:this.floatingbarCallback.bind(this)})},coordinateScaling:function(t){var e={x:t.clientX,y:t.clientY},i=this.viewer.getViewerPositionFromMouse(e);if(i){var a=this.viewer.getPageFromNumber(i.pageNumber).getPhysicalScale(),n=i.pos.x*a/1,s=i.pos.y*a/1;e.x=n,e.y=s}return e},floatingbarCallback:function(t){"Delete3DPlay"==t.id?this.cleanCurrentAnnotation():"Color3DPlay"==t.id&&this.drawSettings.setColor(t.color)},_deactivateManipulators:function(){this.manipulators&&(this.manipulators.destroy(),this.manipulators=void 0)},_activateCustomCursor:function(){this.cursorManager=new e,this._setMouseCursor("custom")},_setMouseCursor:function(t){this.cursorManager&&this.cursorManager.setMouseCursor({container:this.container,caller:"2D",type:t,drawSettings:this.drawSettings})},_deactivateCustomCursor:function(){this.cursorManager&&(this._setMouseCursor("auto"),this.cursorManager.dispose(),this.cursorManager=null)},_keyboardcallback:function(t){this.viewer.checkContext(t)&&"Delete"==t.gesture.events[0].event.code&&this.cleanCurrentAnnotation()},cleanCurrentAnnotation:function(t){this.annotationEdit.length&&this.editStarted&&this.viewer&&null!=this.currentPageNum&&(this.viewer.destroyAnnotations({pageNumber:this.currentPageNum,idList:this.annotationEdit,bToRender:!1}),this.annotationEdit=[],this.annotationData=void 0,this.editStarted=!1,this.manipulators.cleanManipulators(),this.draw=!1,this.editStartbbox=[],this.viewer.renderPageAnnotation({pageNumber:this.currentPageNum}),this.currentPageNum=void 0,this.mode&&"edition"==this.mode&&this.endCB&&this.endCB())}})}),define("DS/3DPlay2DAnnotation/AnnotationManager",["UWA/Class","DS/3DPlayAnnotationUtils/AnnotationAbbreviations"],function(t,e){"use strict";return t.extend({init:function(t){this.options=t,this.frameWindow=this.options.frameWindow,this.AnnotationAbbreviations=new e},saveAnnotationsToJSON:function(t){var e={ver:"1.0",annotations:{}};t&&(e.options=t),e.annotations=this.getAnnotations();var i=this.AnnotationAbbreviations.processJSON(e,"minify");return JSON.stringify(i)},getAllAnnotationAvailibility:function(){var t=this.frameWindow.getViewer();if(t){var e=t.getAllPages();if(e)for(var i=0;i<e.length;i++){var a=e[i].getAnnotations();if(Object.keys(a).length>0)return!0}}return!1},getAnnotations:function(){var t={},e=this.frameWindow.getViewer();if(e){var i=e.getAllPages();if(i)for(var a=0;a<i.length;a++){var n=i[a].getAnnotations();t[a]=n}}return t},deleteAllAnnotations:function(){var t=this.getAnnotations(),e=this.frameWindow.getViewer();if(e){var i=Object.keys(t),a=e.getAllPages();if(i.length==a.length)for(var n=0;n<i.length;n++){var s=i[n],o=a[n],r=t[s],h=Object.keys(r);0<h.length&&o.destroyAnnotations({idList:h,bToRender:!1})}}},applyAnnotationViewPoint:function(t){var e=t.currAnnot,i=t.currAnnotID,a=t.pageNo,n=this.frameWindow.getViewer(),s={pageNumber:a+1,annotID:i},o=t.dir,r=t.annotationListForPage,h=(t.pageNo,t.annotIndex),d=t.callback,l=1;if(n.angle-e.angle==90||n.angle-e.angle==270){var c=n.getDocContainer(),p=n.doc.getOriginalPageInfoWithMargin(a+1),g=c.offsetWidth/(p.height*e.shape.scale);l=c.offsetWidth/(p.width*e.shape.scale)/g}var v,u=e.shape.scale*l,w=function(){n.scale(u);var t=n.getAnnotationInformation(s),i=n.getDocContainer().getBoundingClientRect(),d=n.getPagesContainer().getBoundingClientRect();let l=Math.min(i.height,d.height),c=Math.min(i.width,d.width);var p=n.getCurrentPage().getPageContainer().getBoundingClientRect(),g=0;if(p.width!=d.width&&(g=Math.abs(d.width-p.width)/2,c=Math.min(i.width,p.width)),t){var v=t.bbox[0].y,w=t.bbox[0].x,m=t.bbox[2].y,b=t.bbox[2].x,y=v+l-m,D=w+c-b,f={left:w,top:v,bottom:m,right:b};let i=Object.keys(r);for(h+=o;h>=0&&h<i.length&&e.shape.scale===r[i[h]].shape.scale;){s.annotID=r[h].shape.id;let t=n.getAnnotationInformation(s);if(console.log(s.annotID),f.left=Math.min(f.left,t.bbox[0].x),f.top=Math.min(f.top,t.bbox[0].y),f.bottom=Math.max(f.bottom,t.bbox[2].y),f.right=Math.max(f.right,t.bbox[2].x),f.left+c<f.right||f.top+l<f.bottom)break;y=f.top+l-f.bottom,D=f.left+c-f.right,v=f.top,w=f.left,h+=o}h-=o,y/2>v?v=0:v-=y/2,D/2>w?w=g:(w-=D/2,w+=g);var x=0,P=(n.getDocContainer().getBoundingClientRect(),n.doc.getOriginalPageInfoWithMargin(a+1));return P&&(x-=P.top*u),x-=v,n.updateLayout({top:x,left:-w}),n.render(),r[i[h]]}console.log("Issue to be reproduced",s)};if(n.getCurrentPage().index===a+1)return w();n.setCurrentPage(a+1),n.render(function(){v=w(),d({currAnnotID:v.shape.id.toString(),pageIndex:a+1})})},process:function(t,e){var i=this.frameWindow.getViewer();let a=Object.keys(e);var n=[];for(let e of a){var s={pageNumber:t+1,annotID:e},o=i.getAnnotationInformationRaw(s);o&&n.push(o)}return n.sort((t,e)=>t.bBoxUnScaled[0].y-e.bBoxUnScaled[0].y),n},updateViewPoint:function(t){var e=this.getAnnotations(),i=this.frameWindow.getViewer(),a=t.currentAnnotation,n=a.currAnnotID,s=a.pageIndex?a.pageIndex:i.getCurrentPage().index,o=s-1,r=!0;switch(t.direction){case"right":for(;r;){if(Object.keys(e[o]).length>0){var h=this.process(o,e[o]),d=Object.keys(h);if(!n){c={currAnnot:h[d[0]],currAnnotID:n=h[0].shape.id,pageNo:o,annotationListForPage:h,annotIndex:0,callback:t.setCurrAnnot,dir:1};(p=this.applyAnnotationViewPoint(c))&&(n=p.shape.id.toString(),t.setCurrAnnot({currAnnotID:n,pageIndex:o+1}));break}for(var l=0;l<d.length&&h[l]&&h[l].shape&&h[l].shape.id!=n;)l++;if(d[l+1]){var c={currAnnot:h[d[l+1]],currAnnotID:n=h[l+1].shape.id,pageNo:o,annotationListForPage:h,annotIndex:l+1,callback:t.setCurrAnnot,dir:1};(p=this.applyAnnotationViewPoint(c))&&(n=p.shape.id.toString(),t.setCurrAnnot({currAnnotID:n,pageIndex:o+1}));break}null,n=null}(o+=1)===s-1&&(r=!1),o>=Object.keys(e).length&&(o=0)}break;case"left":for(;r;){h=this.process(o,e[o]),d=Object.keys(h);if(Object.keys(e[o]).length>0){if(!n){c={currAnnot:h[d[d.length-1]],currAnnotID:n=h[d.length-1].shape.id,pageNo:o,annotationListForPage:h,annotIndex:d.length-1,callback:t.setCurrAnnot,dir:-1};(p=this.applyAnnotationViewPoint(c))&&(n=p.shape.id.toString(),t.setCurrAnnot({currAnnotID:n,pageIndex:o+1}));break}for(l=d.length-1;l>=0&&h[l]&&h[l].shape&&h[l].shape.id!=n;)l--;if(d[l-1]){var p,c={currAnnot:h[d[l-1]],currAnnotID:n=h[l-1].shape.id,pageNo:o,annotationListForPage:h,annotIndex:l-1,callback:t.setCurrAnnot,dir:-1};(p=this.applyAnnotationViewPoint(c))&&(n=p.shape.id.toString(),t.setCurrAnnot({currAnnotID:n,pageIndex:o+1}));break}null,n=null}(o-=1)===s-1&&(r=!1),o<0&&(o=Object.keys(e).length-1)}}},drawAnnotationsFromJSON:function(t,e){e&&this.deleteAllAnnotations();var i=null,a=JSON.parse(t),n=this.AnnotationAbbreviations.processJSON(a,"expand"),s=n.annotations;n.options&&(i=n.options);var o=this.frameWindow.getViewer();o&&(i?(o.useDocumentOptionFromJson(i,!1),o.drawAnnotationsFromJSON(s)):o.drawAnnotationsFromJSONOld(s))},dispose:function(){}})}),define("DS/3DPlay2DAnnotation/Annotation2DManipulator",["UWA/Class","DS/Core/PointerEvents","DS/VisuEvents/EventsManager","DS/WebSystem/Environment"],function(t,e,i,a){"use strict";return t.extend({init:function(t){if(this._parent(t),this.viewer=t.viewer,this.eventTarget=t.eventTarget,this.beginMove=t.beginMove,this.move=t.move,this.endMove=t.endMove,this.mouseLeave=t.mouseLeave,this.onTap=t.onTap,this.Hybrid=t.Hybrid,window.HybridAppArgs&&this.Hybrid&&a.isSet("3DPlay.HybridMotionEvents")){require(["DS/HybridInfraCore/HybridApp"],function(t){this.HybridApp=t,this.draw=!1,t.onDeviceReady(function(e){t.addDelegate("MotionEventDelegate").then(function(t){window.MotionEventDelegate=t,console.log("MotionEventDelegate has been added!",window.MotionEventDelegate),window.MotionEventDelegate.addJsonWatch(this._getMotionPoint),window.MotionEventDelegate.execute("START",null).then(function(t){console.log("Motion sensing has been started")},function(t){console.error(t)})},function(t){console.error(t)})})})}else this.beginManipulateBind=this._beginManipulate.bind(this),this.manipulateBind=this._manipulate.bind(this),this.endManipulateBind=this._endManipulate.bind(this),this.dragBind=this._onDrag.bind(this),this.onTapBind=this._onTap.bind(this),this.manipulatorLeaveBind=this._manipulatorLeave.bind(this),i.addEvent(this.eventTarget,"onLeftMouseDown",this.beginManipulateBind),i.addEvent(this.eventTarget,"onMouseMove",this.manipulateBind),i.addEvent(this.eventTarget,"onLeftMouseUp",this.endManipulateBind),i.addEvent(this.eventTarget,"onDrag",this.dragBind),this.onTap&&i.addEvent(this.eventTarget,"onTap",this.onTapBind),this.mouseLeave&&this.eventTarget.addEventListener("mouseleave",this.manipulatorLeaveBind,!0)},_getMotionPoint:function(t){var e=window.devicePixelRatio>1?window.devicePixelRatio:1;if("ACTION_DOWN"==t.action){var i={type:"Hybrid",clientX:t.eventX/e,clientY:t.eventY/e,sizeOfImpression:t.sizeOfImpression};this.draw=!0,this._beginManipulate(i)}else if("ACTION_MOVE"==t.action){i={type:"Hybrid",clientX:t.eventX/e,clientY:t.eventY/e,sizeOfImpression:t.sizeOfImpression};this._manipulate(i)}else if("ACTION_UP"==t.action){i={type:"Hybrid",clientX:t.eventX/e,clientY:t.eventY/e,sizeOfImpression:t.sizeOfImpression};this._endManipulate(i)}else"MULTI_TOUCH"==t.action&&(this.draw=!1)},destroy:function(){window.HybridAppArgs&&this.Hybrid&&a.isSet("3DPlay.HybridMotionEvents")?(window.MotionEventDelegate&&window.MotionEventDelegate.execute("STOP",null).then(function(t){console.log("Motion sensing has been stopped")},function(t){console.error(t)}),this.HybridApp&&this.HybridApp.removeDelegate("MotionEventDelegate")):(i.removeEvent(this.eventTarget,"onLeftMouseDown",this.beginManipulateBind),i.removeEvent(this.eventTarget,"onMouseMove",this.manipulateBind),i.removeEvent(this.eventTarget,"onLeftMouseUp",this.endManipulateBind),i.removeEvent(this.eventTarget,"onDrag",this.dragBind),this.onTap&&i.removeEvent(this.eventTarget,"onTap",this.onTapBind),this.mouseLeave&&this.eventTarget.removeEventListener("mouseleave",this.manipulatorLeaveBind,!0)),this.viewer=void 0,this.eventTarget=void 0},_beginManipulate:function(t){if(window.HybridAppArgs&&this.Hybrid&&a.isSet("3DPlay.HybridMotionEvents"))this.beginMove(t);else{var e=t.gesture.events[0].event;e.preventDefault&&e.preventDefault(),0==e.button?this.beginMove(e):"Drag"===t.gesture.name&&this.beginMove(e.changedTouches[0],!0)}},_manipulate:function(t){if(window.HybridAppArgs&&this.Hybrid&&a.isSet("3DPlay.HybridMotionEvents"))1==this.draw&&this.move(t);else{var e=t.gesture.events[0].event;e.preventDefault&&e.preventDefault(),0==e.button?this.move(e):"Drag"===t.gesture.name&&this.move(e.changedTouches[0],!0)}},_endManipulate:function(t){if(window.HybridAppArgs&&this.Hybrid&&a.isSet("3DPlay.HybridMotionEvents"))1==this.draw&&this.endMove(t),this.draw=!1;else{var e=t.gesture.events[0].event;e.preventDefault&&e.preventDefault(),0===e.button?this.endMove(e):"Drag"===t.gesture.name&&this.endMove(e.changedTouches[0],!0)}},_onDrag:function(t){var e=t.gesture.events[0].event;e&&"mousemove"!=e.type&&"mouseup"!=e.type&&"mousedown"!=e.type&&("begin"===t.state?this._beginManipulate(t):""===t.state?this._manipulate(t):"end"===t.state&&this._endManipulate(t))},_onTap:function(t){var e=t.gesture.events[0].event;e.preventDefault&&e.preventDefault(),this.onTap(e.changedTouches[0])},_manipulatorLeave:function(t){this.mouseLeave&&this.mouseLeave(t)}})}),define("DS/3DPlay2DAnnotation/AnnotationTour2D",["DS/ApplicationFrame/Command","DS/WebInfraUI/NavigationArrows","DS/WebUtils/ContextedSingleton","DS/CoreEvents/Events","DS/WebUtils/Tracker"],function(t,e,i,a,n){"use strict";return t.extend({init:function(t){this._parent(t,{isAsynchronous:!0,mode:"exclusive"}),this.currentAnnotation=null,this._exp=this.getFrameWindow().experience,this.disable(),this.enableCommand=function(){this.enable()},this.disableCommand=function(){this.disable()},this.tokenEnable=this._exp.subscribe("3DPLAY/ANNONATION/INSESSION",this.enableCommand.bind(this)),this.tokenDisable=this._exp.subscribe("3DPLAY/ANNONATION/NOTINSESSION",this.disableCommand.bind(this))},beginExecute:function(){this.currentAnnotation={currAnnotID:null,pageIndex:null},this.viewer=this.getFrameWindow().getViewer(),this.viewer.reframe(),n.startCommand(this.getId());var t=i.get(this._ctx,"ANNOTATION_MANAGER"),a=this,s=function(e){t&&t.updateViewPoint({direction:e,currentAnnotation:a.currentAnnotation,setCurrAnnot:a.setCurrAnnot.bind(a)})};this.navigationArrows=new e({arrowCB:{left:function(){s("left")}.bind(this),right:function(){s("right")}.bind(this)}},{container:this.viewer.uiElements.documentContainer,frmWindow:this.getFrameWindow()}),this._exp&&this._exp.notifyAction&&!0===this._exp.collabMode&&this._exp.notifyAction("StartAnnotationTour")},setCurrAnnot:function(t){this.currentAnnotation=t},endExecute:function(){n.endCommand(this.getId()),this.navigationArrows.dispose(),this.navigationArrows=null,this._exp&&this._exp.notifyAction&&!0===this._exp.collabMode&&this._exp.notifyAction("StopAnnotationTour")},_destroy:function(){this._exp.unsubscribe(this.tokenEnable),this._exp.unsubscribe(this.tokenDisable),this.tokenZoom=void 0,this._exp=void 0,this._parent()}})}),define("DS/3DPlay2DAnnotation/Annotation2DCommand",["UWA/Class","DS/3DPlayAnnotationUtils/AnnotationSettings"],function(t,e){"use strict";return t.extend({init:function(t){this._parent(t),this._isRunning=!1,this.frameWindow=t.frameWindow,this.hideTools=t.hideTools,this.viewer=this.frameWindow.getViewer(),this.drawSettings=new e},begin:function(t){this._isRunning=!0},end:function(t){this._isRunning=!1},isRunning:function(){return this._isRunning},destroy:function(){this._isRunning=void 0,this.viewer=void 0,this.frameWindow=void 0,this.hideTools=void 0,this.drawSettings=void 0},hideUI:function(){this.hideTools&&this.hideTools()}})}),define("DS/3DPlay2DAnnotation/Annotation2DText",["DS/3DPlay2DAnnotation/Annotation2DCommand","DS/3DPlayAnnotationUtils/AnnotationText","DS/CoreEvents/Events","DS/3DPlayAnnotationUtils/AnnotationSettings","DS/WebUtils/GeometryUtils","DS/Core/PointerEvents","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/WebSystem/Nls","DS/WebUtils/Tracker"],function(t,e,i,a,n,s,o,r,h,d){"use strict";return t.extend({init:function(t){this._parent(t),this.frmWindow=t.frameWindow,t.previousCommand&&(this.previousCommand=t.previousCommand),t.endCommandCB&&(this.endCommandCB=t.endCommandCB),this.drawSettings=new a,this._exp=t.frameWindow.experience,this._exp&&this._exp.registerCollabAction&&this._exp.registerCollabAction("annotTextEnd",this.end.bind(this)),t.isMobile?this.mab=!0:this.mab=!1},begin:function(t){this._parent(t),this.viewerFrame=this.frameWindow.getViewerFrame(),this.viewer=this.frameWindow.getViewer(),this.currentView=this.viewer.currentView;this.frameWindow.getActionBar();this.viewer.disableNavigationKeyboardEvents(),this.annotEvent=function(t,e){var i={x:void 0!==t.clientX?t.clientX:t.touches[0].clientX,y:void 0!==t.clientY?t.clientY:t.touches[0].clientY};if(this.viewer&&this.viewer.getViewerPositionFromMouse){var a=this.viewer.getViewerPositionFromMouse(i);if(a)if(a.pageNumber!=this.currentTextControl.index){var n={touch:!0,pos:t,index:a.pageNumber,scale:this.currentTextControl.getScale(),text:this.currentTextControl.getFieldText(),color:this.currentTextControl.getColor()};this.changePageCallback(n)}else this.textControlList[a.pageNumber][e](t)}},this.listnerContainer=this.viewer.getDocContainer(),this.pointerDown=function(t){this.currentTextControl.pointerDown(t)}.bind(this),this.pointerMove=function(t){this.annotEvent(t,"pointerMove")}.bind(this),this.pointerUp=function(t){this.annotEvent(t,"pointerup")}.bind(this),this.mouseleave=function(t){this.textControlList[this.currentTextControl.index].mouseleave(t)}.bind(this),this.listnerContainer.addEventListener(s.POINTERDOWN,this.pointerDown),this.listnerContainer.addEventListener(s.POINTERMOVE,this.pointerMove),this.listnerContainer.addEventListener(s.POINTERUP,this.pointerUp),this.viewer.getPagesContainer().addEventListener("mouseleave",this.mouseleave),t&&t.data&&(this.data=t.data),this._createTextControlList(t),this.currentTextControl.enable(),this.currentTextControl.showControls(),this.startingZoomScale=this.viewer.getCurrentZoomScale(),this.tokenscroll=this.frmWindow.experience.subscribe("3DPLAY/2DEXP/STATECHANGE_PAGE",function(t){this.performForceValidate()}.bind(this)),this.tokenZoom=this.frmWindow.experience.subscribe("3DPLAY/2DEXP/STATECHANGE",function(t){this.startingZoomScale!=t.zoomScale&&(this.currentTextControl.zoom(t),this.startingZoomScale=t.zoomScale);var e=this.viewer.getVisiblePages(),i=0;e.forEach(function(t,a){var n=!1,s=Object.keys(this.textControlList);for(i=0;i<s.length;i++)t.index==this.textControlList[s[i].toString()].index&&(n=!0);0==n&&(this.textControlList[t.index.toString()]=this._createTextControl(e[a].getPageContainer(),t.index))}.bind(this))}.bind(this))},end:function(t){t.isCommandcancelled&&this.data&&(this.viewer.createAnnotationWithTextData(this.data),this.viewer.renderPageAnnotation({pageNumber:this.data.pageNumber})),this.listnerContainer.removeEventListener(s.POINTERDOWN,this.pointerDown),this.listnerContainer.removeEventListener(s.POINTERMOVE,this.pointerMove),this.listnerContainer.removeEventListener(s.POINTERUP,this.pointerUp),this.viewer.getPagesContainer().removeEventListener("mouseleave",this.mouseleave),this.viewer.enableNavigationKeyboardEvents(),this.frmWindow.experience.unsubscribe(this.tokenZoom),this.frmWindow.experience.unsubscribe(this.tokenscroll),this.tokenZoom=void 0,this.tokenscroll=void 0,this._destroyTextControl(),this._onMouseDownCB=void 0,this.viewerFrame=void 0,this.viewer=void 0,this._parent(t)},destroy:function(){this._parent(),this.drawSettings=void 0},_onWidgetResize:function(){var t=this;setTimeout(function(){var e=t.currentTextControl.getFieldText();t.refresh(),e&&(t.currentTextControl.enable(),t.currentTextControl.showControls(),t.currentTextControl.setFieldText(e))},100)},widgetResize:function(t){},performForceValidate:function(){this.currentTextControl&&this.currentTextControl.validate()},_onValidate:function(t,e){d.command("Annotation2DText"),this._createAnnotation(t),this.currentTextControl.clearTextField(),e&&(this.viewer.annotationValidateOnClick=!0),this.endCommandCB({command:this.previousCommand})},_createAnnotation:function(t){parseInt(this.drawSettings.getThickness());var e=t.fontSize+'px "3ds"',i=n.wrapText({text:t.text,width:t.w/t.scale,height:t.h/t.scale,font:e}),a=(i.wrappedLines.length,t.x),s=t.y,o=t.index,r=this.viewer.getCurrentZoomScale(),h={type:"text",text:i.wrappedLines,point:{x:a/r,y:s/r},height:t.h/r,width:t.w/r,offsetHeight:t.offsetHeight/r,fontSize:t.fontSize/r,controlScale:t.scale,viewerScale:r};this.viewer.createAnnotation({pageNumber:o,shapeData:h,render:!0,settings:{color:t.color,thickness:parseInt(this.drawSettings.getThickness()),transparency:1}})},changePageCallback:function(t){this.currentTextControl&&t&&t.index&&this.currentTextControl.mDragging&&(t.text=this.currentTextControl.getFieldText(),t.color=this.currentTextControl.getColor(),t.scale=this.currentTextControl.getScale(),t.viewerScale=this.currentTextControl.getViewerScale(),t.width=this.currentTextControl.getWidth(),this.currentTextControl.disable(),this.currentTextControl=this.textControlList[t.index.toString()],this.currentTextControl.enable(t),this.currentTextControl.dragPointerDown(t.pos),this.currentTextControl.setDragging(!0))},_createTextControlList:function(t){this.textControlList={};var e,i,a=this.viewer.getVisiblePages();t.data?i=this.viewer.getPageFromNumber(t.data.pageNumber).index:i=this.viewer.getCurrentPage().index;if(1==a.length){e=(s=a[0]).getVisibleArea();var n=s.getContent().getParent();this.textControlList[s.index.toString()]=this._createTextControl(n,s.index,t),this.currentTextControl=this.textControlList[this.viewer.getCurrentPage().index.toString()],t&&t.data?this.currentTextControl.setTextControlPosForEdit(t.data):this.currentTextControl.setTextControlPos(e)}else{var s,o=0;n=(s=a[o]).getPageContainer();for((e=s.getVisibleArea())&&!t.data&&(e.height<90&&(i+=1,e=a[o+1].getVisibleArea()),null==e&&console.log("area undefined"),e.width<260&&(this.viewer.fitWidth(),a=this.viewer.getVisiblePages())),o=0;o<a.length;o++)n=(s=a[o]).getPageContainer(),this.textControlList[s.index.toString()]=this._createTextControl(n,s.index,t),e=s.getVisibleArea(),t&&t.data&&i==s.index?this.textControlList[s.index.toString()].setTextControlPosForEdit(t.data):e&&this.textControlList[s.index.toString()].setTextControlPos(e);o=t.data?i:this.viewer.getCurrentPage().index,this.currentTextControl=this.textControlList[i.toString()]}},_createTextControl:function(t,i,a){var n,s,o=!0;a&&a.data&&(i!=this.viewer.getPageFromNumber(a.data.pageNumber).index&&0!=i||(n=a.data,o=!1),s=a.directEdit);return new e({viewer:this.viewer,container:t,listnerContainer:this.listnerContainer,floatingBarContainer:this.viewer.getPagesContainer(),floatingbarCallback:this.floatingbarCallback.bind(this),onOk:function(t,e){this._onValidate(t,e)}.bind(this),onCancel:function(){this.endCommandCB({command:this.previousCommand})}.bind(this),onTypeStartCB:this.hideUI.bind(this),disabled:o,index:i,data:n,directEdit:s})},_destroyTextControl:function(){if(this.currentTextControl&&(this.currentTextControl.destroy(),this.currentTextControl=void 0),this.textControlList){var t=1,e=Object.keys(this.textControlList);for(t=0;t<e.length;t++)!this.textControlList[e[t].toString()]||this.textControlList[e[t].toString()].destroy();this.textControlList=[]}},floatingbarCallback:function(t){"Delete3DPlay"==t.id?this.endCommandCB({command:this.previousCommand}):"Color3DPlay"==t.id&&this.drawSettings.setColor(t.color)}})}),define("DS/3DPlay2DAnnotation/Annotation2DEdit",["DS/3DPlay2DAnnotation/Annotation2DCommand","DS/3DPlay2DAnnotation/Annotation2DEditPreview","DS/3DPlayAnnotationUtils/ShapeUtils","DS/WebUtils/Tracker"],function(t,e,i,a){"use strict";return t.extend({init:function(t){this._parent(t),t.startCommandCB&&(this.startCommandCB=t.startCommandCB),t.endCommandCB&&(this.endCommandCB=t.endCommandCB),t.data&&(this.data=t.data),t.mode&&(this.mode=t.mode)},begin:function(t){a.command("Annotation2DEdit"),this._parent(t),this._createPreview()},end:function(t){this._destroyPreview(),this._parent(t)},destroy:function(){this._parent()},cleanCurrentAnnotation:function(){this.drawPreview&&this.drawPreview.cleanCurrentAnnotation()},_onSheetChange:function(){this._destroyPreview(),this._createPreview()},_onResize:function(){this._destroyPreview(),this._createPreview()},_edit:function(t){this.startCommandCB&&this.startCommandCB({command:{id:"2DText"},data:{annotationData:t.annotationData,pageNumber:t.pageNumber}})},_endCommand:function(t){this.endCommandCB&&this.endCommandCB()},_draw:function(t){if(t.recognizeShape&&t.recognizedshapeData)this.viewer.createAnnotationWithShapeData({pageNumber:t.pageNumber,shape:t.recognizedshapeData,render:!1,id:t.recognizedshapeData.id});else{var e,a=t.points,n=!0;"unknownOpen"!=(e=i.shapeUnEval(a).shape).type&&"unknownClosed"!=e.type||(n=!1),e.angle=this.viewer.angle,this.viewer.createAnnotation({pageNumber:t.pageNumber,shapeData:e,render:n,angle:this.viewer.angle,settings:{color:this.drawSettings.getColor(),thickness:parseInt(this.drawSettings.getThickness()),transparency:1}})}},_createPreview:function(){this.drawPreview=new e({viewer:this.viewer,frameWindow:this.frameWindow,drawSettings:this.drawSettings,data:this.data,mode:this.mode,hideUICB:this.hideUI.bind(this),drawCB:this._draw.bind(this),editCB:this._edit.bind(this),endCB:this._endCommand.bind(this)}),this.drawPreview.begin()},_destroyPreview:function(){this.drawPreview&&(this.drawPreview.end(),this.drawPreview.destroy(),this.drawPreview=void 0)}})}),define("DS/3DPlay2DAnnotation/Annotation2DDrawHighlightPreview",["UWA/Class","DS/3DPlayAnnotationUtils/CursorManager","DS/WebUtils/Vector2","DS/3DPlay2DAnnotation/Annotation2DManipulator","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/3DPlayAnnotationUtils/ShapeUtils","DS/WebUtils/GeometryUtils","DS/WebRunloop/Runloop","DS/3DPlayAnnotationUtils/CanvasShapes","DS/WebSystem/Environment","DS/3DPlayAnnotationUtils/AnnotationUtilities"],function(t,e,i,a,n,s,o,r,h,d,l,c){"use strict";var p=12;return t.extend({init:function(t){this._parent(t),this.frameWindow=t.frameWindow,this.viewer=t.viewer,this.drawSettings=t.drawSettings,this.hideUICB=t.hideUICB,this.drawCB=t.drawCB,this.editCB=t.editCB,this._draw=!1,this._yCoord=0},begin:function(t){this.container=this.viewer.getDocContainer(),this._activateManipulators(),this._activateCustomCursor(),this.creationcanvas&&(this.creationcanvas.width=0,this.creationcanvas.height=0,this.creationcanvas.remove(),this.creationcanvas=void 0),this.runloop=new h({data:this,func:this._runloopFunc}),this.runloop.start()},end:function(t){this._deactivateCustomCursor(),this._deactivateManipulators(),this.creationcanvas&&(this.creationcanvas.width=0,this.creationcanvas.height=0,this.creationcanvas.remove(),this.creationcanvas=void 0),this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null)},destroy:function(){this._deactivateManipulators(),this._deactivateCustomCursor(),this.frameWindow=void 0,this.viewer=void 0,this.drawSettings=void 0,this.hideUICB=void 0,this.drawCB=void 0,this.editCB=void 0},_checkAndLaunchEdition:function(t){},adjustCursorSizeBasedOnBelowText:function(t){var e={x:t.clientX,y:t.clientY},a=this.viewer.getViewerPositionFromMouse(e);if(a){var n=this.viewer.getPageFromNumber(a.pageNumber);if(n&&n.textLayer)for(var s=n.textLayer.childNodes,o=0;o<s.length;o++){var h=s[o];if(h){for(var d=h.getBoundingClientRect(),l=new i(t.clientX,t.clientY),c=l.x,p=l.y,g=2*Math.PI/10,v=[],u=0;u<2*Math.PI;u+=g)v.push({x:c+15*Math.cos(u),y:p+15*Math.sin(u)});var w=[];if(w.push(new i(d.left,d.top)),w.push(new i(d.left+d.width,d.top)),w.push(new i(d.left+d.width,d.top+d.height)),w.push(new i(d.left,d.top+d.height)),r.isIntersect(v,w)||r._isInsidePolygon(l,w)){var m=d.height;m=""+m,this.drawSettings.setHighlightThickness(m),this._setMouseCursor("custom_highlight");break}}}}},_runloopFunc:function(t){if(this._draw&&this.creationcanvas)if(null==this.stationaryPos)this.stationaryPos=this.currentScreenPt,this.starttime=t.deltaTime,this.recognizedshapeData=void 0;else if(this.currentScreenPt.distanceTo(this.stationaryPos)<5){if(this.starttime=this.starttime+t.deltaTime,300<this.starttime){var e=o.shapeEval(this.viewerPoints).shape;if(e.angle=this.viewer.angle,"unknownOpen"!=e.type&&"unknownClosed"!=e.type){var i=this.viewer.getPageFromNumber(this.page),a={color:this.drawSettings.getColor(),thickness:parseInt(this.drawSettings.getHighlightThickness()),transparency:parseFloat(this.drawSettings.getHighlightOpacity())},n=i.getScale();a.thickness/=n,this.recognizedshapeData=d.createShape({shapeData:e,settings:a}),this.recognizedshapeData.angle=i.angle,this.creationcanvas.getContext("2d").clearRect(0,0,this.creationcanvas.width,this.creationcanvas.height),d.drawShape({shape:JSON.parse(JSON.stringify(this.recognizedshapeData)),canvas:this.creationcanvas,scale:i.getScale(),angle:i.angle,height:i.getOriginalHeight(),width:i.getOriginalWidth()}),this.viewer.drawPreview({pageNumber:this.page,viewerPoints:this.viewerPoints,canvas:this.creationcanvas})}}}else{if(this.recognizedshapeData)this.stationaryPos=this.currentScreenPt,this.starttime=t.deltaTime,this.recognizedshapeData=void 0,this.creationcanvas.getContext("2d").clearRect(0,0,this.creationcanvas.width,this.creationcanvas.height),this.viewer.drawPreview({pageNumber:this.page,viewerPoints:this.viewerPoints,canvas:this.creationcanvas});this.stationaryPos=this.currentScreenPt,this.starttime=t.deltaTime}},_onTap:function(t){var e=this._checkAndLaunchEdition(t);e&&this.editCB(e)},_beginMove:function(t){this.hideUICB(),this.viewerPoints=[],this.page=-1;var e=this._checkAndLaunchEdition(t);if(this.adjustCursorSizeBasedOnBelowText(t),e)this.editCB(e);else{this.scale=1;var a={x:t.clientX/this.scale,y:t.clientY/this.scale},n=this.viewer.getViewerPositionFromMouse(a);n&&(this.page=n.pageNumber,this._initCreationCanvas(),p=parseFloat(this.drawSettings.getHighlightThickness()),this.viewer.setDrawStyleForHighlight({pageNumber:this.page,color:this.drawSettings.getColor(),thickness:p,transparency:parseFloat(this.drawSettings.getHighlightOpacity())}),this.viewer.setDrawStyleForHighlight({pageNumber:this.page,color:this.drawSettings.getColor(),thickness:p,transparency:parseFloat(this.drawSettings.getHighlightOpacity()),canvas:this.creationcanvas}),this.startPoint={x:n.pos.x,y:n.pos.y},this.currentScreenPt=new i(t.clientX,t.clientY),this.startScreenPt=new i(t.clientX,t.clientY),this.viewerPoints.push(new i(n.pos.x,n.pos.y)),this._draw=!0)}},_move:function(t){if(!0===this._draw){var e=t.clientY,a={x:t.clientX/this.scale,y:e/this.scale},n=this.viewer.getViewerPositionFromMouse(a);if(n&&this.page===n.pageNumber){this.currentScreenPt=new i(t.clientX,e),this.endPoint=new i(n.pos.x,n.pos.y);var s={position:this.endPoint,isShiftKeyDown:t.shiftKey&&l.isSet("3DPlay.ActivateShiftStraightHighlight"),direction:this.direction,viewerPoints:this.viewerPoints};this.direction=c._addPositionToViewerPoints(s);var o=this.creationcanvas.getContext("2d"),r=this.getCurrentViewPort();r?o.clearRect(r.xtop,r.ytop,r.xbottom-r.xtop,r.ybottom-r.ytop):o.clearRect(0,0,this.creationcanvas.clientWidth,this.creationcanvas.clientHeight),this.viewer.drawPreview({pageNumber:this.page,viewerPoints:this.viewerPoints,canvas:this.creationcanvas}),this.startPoint=this.endPoint}}},_endMove:function(t){if(!0===this._draw){var e=t.clientY,a={x:t.clientX/this.scale,y:e/this.scale},n=this.viewer.getViewerPositionFromMouse(a);if(n&&this.page===n.pageNumber)if(1==this.viewerPoints.length&&this.viewerPoints[0].x==n.pos.x&&this.viewerPoints[0].y==n.pos.y);else{var s={position:new i(n.pos.x,n.pos.y),isShiftKeyDown:t.shiftKey&&l.isSet("3DPlay.ActivateShiftStraightHighlight"),direction:this.direction,viewerPoints:this.viewerPoints};if(this.direction=c._addPositionToViewerPoints(s),void 0!==this.direction){(u=o.shapeEval(this.viewerPoints).shape).angle=this.viewer.angle;var r=this.viewer.getPageFromNumber(this.page),h={color:this.drawSettings.getColor(),thickness:parseInt(this.drawSettings.getHighlightThickness()),transparency:parseFloat(this.drawSettings.getHighlightOpacity())},p=r.getScale();h.thickness/=p,this.recognizedshapeData=d.createShape({shapeData:u,settings:h}),this.recognizedshapeData.angle=r.angle}this.direction=void 0,this.endPoint={x:n.pos.x,y:n.pos.y}}else{var g=this.viewerPoints[this.viewerPoints.length-1];this.endPoint=new i(g.x,g.y)}this.creationcanvas.getContext("2d").clearRect(0,0,this.creationcanvas.width,this.creationcanvas.height),this.viewer.drawPreview({pageNumber:this.page,viewerPoints:this.viewerPoints,canvas:this.creationcanvas});var v=!1;if(this.recognizedshapeData)v=!0;else try{var u=o.filterAndSmoothPoints(this.viewerPoints,!0);this.viewerPoints=u}catch(t){console.log("error in shapeUtil")}var w=this.viewerPoints;1==w.length&&((w=[])[0]={x:this.viewerPoints[0].x-.1,y:this.viewerPoints[0].y-.1},w[1]={x:this.viewerPoints[0].x+.1,y:this.viewerPoints[0].y-.1},w[2]={x:this.viewerPoints[0].x+.1,y:this.viewerPoints[0].y+.1},w[3]={x:this.viewerPoints[0].x-.1,y:this.viewerPoints[0].y+.1}),this.recognizedshapeData?this.viewer.drawPreviewWithShapeData({pageNumber:this.page,shapeData:this.recognizedshapeData}):this.viewer.drawPreview({pageNumber:this.page,viewerPoints:w}),this.drawCB({points:this.viewerPoints,pageNumber:this.page,recognizeShape:v,recognizedshapeData:this.recognizedshapeData})}this._cleanDrawData(),this.drawSettings.setHighlightThickness("30"),this._setMouseCursor("custom_highlight")},getCurrentViewPort:function(){var t;if(-1!=this.page){for(var e=this.viewer.getPageFromNumber(this.page).getScale(),i=parseFloat(this.drawSettings.getHighlightThickness()),a=r.convexHullCompute(this.viewerPoints),n=[],s=[],o=0;o<a.length;++o)n.push(a[o].x),s.push(a[o].y);n.sort(function(t,e){return t-e}),s.sort(function(t,e){return t-e});var h=n.length-1;t={xtop:n[0]*e-i,ytop:s[0]*e-i,xbottom:n[h]*e+i,ybottom:s[h]*e+i}}return t},_cleanDrawData:function(){this._draw=!1,this.endPoint=null,this.startPoint=null,this.viewerPoints=[],this.page=-1,this.currentScreenPt=null,this.startScreenPt=null,this.creationcanvas&&(this.creationcanvas.width=0,this.creationcanvas.height=0,this.creationcanvas.remove(),this.creationcanvas=void 0)},_initCreationCanvas:function(){var t=this.viewer.getPageFromNumber(this.page),e=t.getOriginalWidth(),i=t.getOriginalHeight(),a=(t.getPageContainer().clientWidth,window.devicePixelRatio>1?window.devicePixelRatio:1);t.canvas.clientWidth,t.canvas.width;this.creationcanvas=new UWA.Element("canvas",{id:"creationcanvas",styles:{width:"100%",height:"100%",position:"absolute",top:"0px",left:"0px","background-color":"transparent","pointer-events":"none","z-index":10}}).inject(t.getPageContainer());var n=e*t.getScale(),s=i*t.getScale(),o=this.creationcanvas.getContext("2d"),r=n*(a=window.devicePixelRatio>1?window.devicePixelRatio:1),h=s*a;this.creationcanvas.width=r,this.creationcanvas.height=h,o.scale(a,a),o.strokeStyle="transparent",o.clearRect(0,0,this.creationcanvas.width,this.creationcanvas.height)},_activateManipulators:function(){this.pointerOut=function(t){0==t.button&&(this.direction=void 0,this._draw&&(this.page>=0&&this.viewer.renderPageAnnotation({pageNumber:this.page}),this._cleanDrawData(),this.drawSettings.setHighlightThickness("30"),this._setMouseCursor("custom_highlight")))},this.manipulators=new a({eventTarget:this.container,beginMove:this._beginMove.bind(this),move:this._move.bind(this),endMove:this._endMove.bind(this),mouseLeave:this.pointerOut.bind(this),onTap:this._onTap.bind(this)})},_deactivateManipulators:function(){this.manipulators&&(this.manipulators.destroy(),this.manipulators=void 0)},_activateCustomCursor:function(){this.cursorManager=new e,this._checkAndSetHighlightThickness(),this._setMouseCursor("custom_highlight"),this.settingsChanged=function(t){this._setMouseCursor("custom_highlight")}.bind(this),this.tokenSettingsChanged=s.subscribe({event:"3DPlay.Annotation.SettingsChanged"},this.settingsChanged),this.zoomChanged=function(t){this._checkAndSetHighlightThickness(),this._setMouseCursor("custom_highlight")}.bind(this),this.tokenZoomChanged=this.frameWindow.experience.subscribe("3DPLAY/2DEXP/ZOOM",this.zoomChanged)},_setMouseCursor:function(t){this.cursorManager&&this.cursorManager.setMouseCursor({container:this.container,caller:"2D",type:t,drawSettings:this.drawSettings})},_checkAndSetHighlightThickness:function(){},getHighliterThickness:function(){return p},_deactivateCustomCursor:function(){s.unsubscribe(this.tokenSettingsChanged),this.frameWindow.experience.unsubscribe(this.tokenZoomChanged),this.cursorManager&&(this._setMouseCursor("auto"),this.cursorManager.dispose(),this.cursorManager=null)}})}),define("DS/3DPlay2DAnnotation/Annotation2DDrawHighlight",["DS/3DPlay2DAnnotation/Annotation2DCommand","DS/3DPlay2DAnnotation/Annotation2DDrawHighlightPreview","DS/3DPlayAnnotationUtils/ShapeUtils","DS/WebUtils/Tracker"],function(t,e,i,a){"use strict";return t.extend({init:function(t){this._parent(t),t.startCommandCB&&(this.startCommandCB=t.startCommandCB)},begin:function(t){a.command("Annotation2DHighlight"),this._parent(t),this._createPreview()},end:function(t){this._destroyPreview(),this._parent(t)},destroy:function(){this._parent()},_onSheetChange:function(){this._destroyPreview(),this._createPreview()},_onResize:function(){this._destroyPreview(),this._createPreview()},_draw:function(t){if(t.recognizeShape&&t.recognizedshapeData)this.viewer.createAnnotationWithShapeData({pageNumber:t.pageNumber,shape:t.recognizedshapeData,render:!1,id:t.recognizedshapeData.id});else{var e=t.points,a=i.shapeUnEval(e).shape;this.viewer.createAnnotation({pageNumber:t.pageNumber,shapeData:a,render:!1,settings:{color:this.drawSettings.getColor(),thickness:this.drawPreview.getHighliterThickness(),transparency:parseFloat(this.drawSettings.getHighlightOpacity())}})}},_createPreview:function(){this.drawPreview=new e({viewer:this.viewer,frameWindow:this.frameWindow,drawSettings:this.drawSettings,hideUICB:this.hideUI.bind(this),drawCB:this._draw.bind(this),editCB:function(t){this.startCommandCB&&this.startCommandCB({command:{id:"2DText"},data:{annotationData:t.annotationData,pageNumber:t.pageNumber}})}.bind(this)}),this.drawPreview.begin()},_destroyPreview:function(){this.drawPreview&&(this.drawPreview.end(),this.drawPreview.destroy(),this.drawPreview=void 0)}})}),define("DS/3DPlay2DAnnotation/Annotation2DEraseHandle",["UWA/Class","DS/3DPlayAnnotationUtils/CursorManager","DS/3DPlay2DAnnotation/Annotation2DManipulator","DS/WebUtils/Vector2","DS/WebSystem/Environment"],function(t,e,i,a,n){"use strict";var s=t.extend({init:function(t){this._parent(t),this.container=t.container,this.motionTrailLength=t.motionTrailLength,this.canvas=new UWA.Element("canvas",{id:"annotPreviewCanvas",styles:{position:"relative","z-index":"2000",pointerEvents:"none"}}).inject(this.container);var e=this.container.getDimensions();this.canvas.width=e.width,this.canvas.height=e.height,this.canvasContext=this.canvas.getContext("2d"),this.canvasPointsArray=[],this.erase=!1,this.draw=!1},drawBegin:function(t){this.draw=!0,this.canvasPointsArray=[];var e=this._translateToCanvasPosition(t);this._storeLastPosition(e.x,e.y)},drawContinue:function(t){if(this.drawBegin){var e=this._translateToCanvasPosition(t);if(this.canvasContext.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvasPointsArray.length>=12){for(var i=0;i<this.canvasPointsArray.length-3;i+=2){var a=(i+1)/this.canvasPointsArray.length;this._drawLine(this.canvasPointsArray[i].x,this.canvasPointsArray[i].y,this.canvasPointsArray[i+2].x,this.canvasPointsArray[i+2].y,a)}this._drawLine(this.canvasPointsArray[this.canvasPointsArray.length-3].x,this.canvasPointsArray[this.canvasPointsArray.length-3].y,this.canvasPointsArray[this.canvasPointsArray.length-1].x,this.canvasPointsArray[this.canvasPointsArray.length-1].y,"source")}this._storeLastPosition(e.x,e.y)}},drawEnd:function(){this.draw=!1,this.canvasPointArray=[],this.canvasContext.clearRect(0,0,this.canvas.width,this.canvas.height)},_drawLine:function(t,e,i,a,n){"source"==n?n=.5:n/=2,this.canvasContext.beginPath(),this.canvasContext.moveTo(t,e),this.canvasContext.lineTo(i,a),this._setStrokeStyle(n),this.canvasContext.stroke()},_setStrokeStyle:function(t){this.canvasContext.lineWidth=8,this.canvasContext.lineJoin="round",this.canvasContext.strokeStyle="rgba(204, 102, 153, "+t+")"},_storeLastPosition:function(t,e){this.canvasPointsArray.push({x:t,y:e}),this.canvasPointsArray.length>this.motionTrailLength&&this.canvasPointsArray.shift()},_translateToCanvasPosition:function(t){var e=this.canvas.getBoundingClientRect();return{x:t.x-e.left,y:t.y-e.top}},destroy:function(){this.canvasContext=void 0,this.canvas&&(this.canvas.destroy(),this.canvas=void 0)}});return t.extend({init:function(t){this._parent(t),this.frameWindow=t.frameWindow,this.viewer=t.viewer,this.drawSettings=t.drawSettings,this.hideUICB=t.hideUICB,this.markCB=t.markCB,this.eraseCB=t.eraseCB,this.erase=!1,this.mousePosition=[]},begin:function(t){this.container=this.viewer.getDocContainer(),this._activateManipulators(),n.isSet("3DPlay.ActivateDrawTrail")&&this._createCanvas(),this._activateCustomCursor()},end:function(t){this._deactivateCustomCursor(),this._destroyCanvas(),this._deactivateManipulators()},destroy:function(){this._destroyCanvas(),this._deactivateManipulators(),this._deactivateCustomCursor(),this.frameWindow=void 0,this.viewer=void 0,this.drawSettings=void 0,this.hideUICB=void 0,this.markCB=void 0,this.eraseCB=void 0,this.mousePosition=[]},_beginMove:function(t,e){this.hideUICB(),this.page=-1;var i={x:t.clientX,y:t.clientY},n=this.viewer.getViewerPositionFromMouse(i);if(n&&(this.eraseCanvas&&this.eraseCanvas.drawBegin(i),this.page=n.pageNumber,this.startPoint=new a(n.pos.x,n.pos.y),this.erase=!0,e&&this.cursorManager)){var s=this.frameWindow.getUIFrame().getBoundingClientRect();this.cursorManager.setTouchCursor({position:[t.clientX-s.left,t.clientY-s.top],container:this.frameWindow.getUIFrame(),drawSettings:this.drawSettings})}},_move:function(t,e){if(!0===this.erase){if(e&&this.cursorManager){var i=this.frameWindow.getUIFrame().getBoundingClientRect();this.cursorManager.setTouchCursor({position:[t.clientX,t.clientY],container:this.frameWindow.getUIFrame(),drawSettings:this.drawSettings}),this.cursorManager.setTouchCursor({position:[t.clientX-i.left,t.clientY-i.top],container:this.frameWindow.getUIFrame(),drawSettings:this.drawSettings})}var s={x:t.clientX,y:t.clientY};if(n.isSet("3DPlay.EraserWithSpeed")&&(this.mousePosition.push(s),this.mousePosition.length>10)){var o=Math.abs(s.x-this.mousePosition[this.mousePosition.length-10].x),r=Math.abs(s.y-this.mousePosition[this.mousePosition.length-10].y),h=Math.sqrt(o*o+r*r);h<=50?this.drawSettings.setEraserThickness(30):h>50&&h<=70?this.drawSettings.setEraserThickness(40):h>70&&h<=90?this.drawSettings.setEraserThickness(50):h>90&&h<=110?this.drawSettings.setEraserThickness(60):h>110&&h<=130?this.drawSettings.setEraserThickness(70):h>130&&h<=150?this.drawSettings.setEraserThickness(80):this.drawSettings.setEraserThickness(90),this._setMouseCursor("custom_eraser")}var d=this.viewer.getViewerPositionFromMouse(s);d&&this.page===d.pageNumber&&(this.eraseCanvas&&this.eraseCanvas.drawContinue(s),this.endPoint=new a(d.pos.x,d.pos.y),this.markCB({startPoint:this.startPoint,endPoint:this.endPoint,pageNumber:this.page,thickness:this.drawSettings.getEraserThickness()}),this.startPoint=this.endPoint)}},_endMove:function(t,e){if(!0===this.erase){e&&this.cursorManager&&this.cursorManager.deleteTouchCursor();var i={x:t.clientX,y:t.clientY},n=this.viewer.getViewerPositionFromMouse(i);n&&this.page===n.pageNumber?(this.eraseCanvas&&this.eraseCanvas.drawEnd(i),this.endPoint=new a(n.pos.x,n.pos.y)):this.endPoint=new a(this.startPoint.x,this.startPoint.y),this.markCB({startPoint:this.startPoint,endPoint:this.endPoint,pageNumber:this.page})}this.drawSettings.setEraserThickness(30),this.mousePosition=[],this._setMouseCursor("custom_eraser"),this._cancelMove()},_cancelMove:function(){!0===this.erase&&this.eraseCB({pageNumber:this.page}),this.erase=!1,this.eraseCanvas&&this.eraseCanvas.drawEnd(),this.startPoint=null,this.endPoint=null,this.page=-1},_activateManipulators:function(){this.manipulators=new i({eventTarget:this.container,beginMove:this._beginMove.bind(this),move:this._move.bind(this),endMove:this._endMove.bind(this)})},_deactivateManipulators:function(){this.manipulators&&(this.manipulators.destroy(),this.manipulators=void 0)},_activateCustomCursor:function(){this.cursorManager=new e,this._setMouseCursor("custom_eraser")},_setMouseCursor:function(t){this.cursorManager&&this.cursorManager.setMouseCursor({container:this.container,caller:"2D",type:t,drawSettings:this.drawSettings})},_deactivateCustomCursor:function(){this.cursorManager&&(this.drawSettings.setEraserThickness(30),this._setMouseCursor("auto"),this.cursorManager.dispose(),this.cursorManager=null)},_createCanvas:function(){this.eraseCanvas=new s({container:this.container,motionTrailLength:20})},_destroyCanvas:function(){this.eraseCanvas&&(this.eraseCanvas.destroy(),this.eraseCanvas=void 0)}})}),define("DS/3DPlay2DAnnotation/Annotation2DErase",["DS/3DPlay2DAnnotation/Annotation2DCommand","DS/3DPlay2DAnnotation/Annotation2DEraseHandle"],function(t,e){"use strict";return t.extend({init:function(t){this._parent(t)},begin:function(t){this._parent(t),this.idListErase=[],this._createEraseHandle();for(var e=this.viewer.getAllPages(),i=0;i<e.length;i++)e[i].markForRender();this.viewer.render()},end:function(t){this._destroyEraseHandle(),this._parent(t)},destroy:function(){this._parent()},_onSheetChange:function(){this._destroyEraseHandle(),this._createEraseHandle()},_onResize:function(){this._destroyEraseHandle(),this._createEraseHandle()},_markRep:function(t){var e=this.viewer.getIntersectingAnnotations(t);if(e&&e.length>0){for(var i=0;i<e.length;++i)this.idListErase.push(e[i]);this.viewer.drawAnnotations({pageNumber:t.pageNumber,idList:e,lowLightMode:!0})}},_erase:function(t){this.viewer.destroyAnnotations({pageNumber:t.pageNumber,idList:this.idListErase}),this.idListErase=[]},_createEraseHandle:function(){var t=this.frameWindow.getViewer();this.eraseHandle=new e({viewer:t,frameWindow:this.frameWindow,drawSettings:this.drawSettings,hideUICB:this.hideUI.bind(this),markCB:this._markRep.bind(this),eraseCB:function(t){this._erase(t)}.bind(this)}),this.eraseHandle.begin()},_destroyEraseHandle:function(){this.eraseHandle&&(this.eraseHandle.end(),this.eraseHandle.destroy(),this.eraseHandle=void 0)}})}),define("DS/3DPlay2DAnnotation/AnnotationCommandText",["DS/ApplicationFrame/Command","DS/WebInfraUI/ContextualBarManager","DS/3DPlayAnnotationUtils/AnnotationToolsMenu","DS/3DPlay2DAnnotation/Annotation2DErase","DS/3DPlay2DAnnotation/Annotation2DEdit","DS/3DPlay2DAnnotation/Annotation2DText","DS/3DPlay2DAnnotation/Annotation2DDrawHighlight","DS/CoreEvents/Events","DS/WebSystem/Environment","DS/WebSystem/BrowserInfos","DS/WebUtils/Tracker"],function(t,e,i,a,n,s,o,r,h,d,l){"use strict";var c=d.isMobile();return t.extend({init:function(t){this._parent(t,{isAsynchronous:!0,mode:"exclusive"})},beginExecute:function(){this.frameWindow=this.getFrameWindow(),this.viewer=this.frameWindow.getViewer(),this.ab=this.frameWindow.getActionBar(),this.ab.close(),this.ab.MAB&&this.ab.MAB.state&&this.ab.MAB.state.open&&this.ab.MAB.toggleMainView(),this._enableEvents(),this.viewer.enableAntiBackGroundBorder(),this.frameWindow.experience&&this.frameWindow.experience.publish("3DPLAY/ANNOTATION/CMD_ACTIVATED",{}),this.data=this.viewer.shapeEditionData},execute:function(){var t,e;if(l.startCommand(this.getId()),this.Text2D=new s({frameWindow:this.frameWindow,hideTools:this._removeTools.bind(this),data:this.data,mode:"edition",endCommandCB:this.endCommandCB.bind(this)}),this.data){e=this.data.directEdit;var i=this.viewer.getViewerPositionFromMouse(this.data.point);if(i){var a=this.viewer.getUnderneathAnnotations({pageNumber:i.pageNumber,positionX:i.pos.x,positionY:i.pos.y});if(a.length){a.splice(1);var n=this.viewer.getUnProcessedAnnotationInformation({pageNumber:i.pageNumber,annotID:a[0]});if(n&&n.data&&"text"==n.data.type){var o=this.viewer.getPageFromNumber(i.pageNumber),r=(this.viewer.getProcessedAnnotationInformation({pageNumber:i.pageNumber,annotID:a[0]}),o.rotateAnnotations(1,1,n.data.point.x,n.data.point.y,n.angle-o.angle));n.data.point.x=r[0],n.data.point.y=r[1],this.viewer.destroyAnnotations({pageNumber:i.pageNumber,idList:a,bToRender:!1}),this.viewer.renderPageAnnotation({pageNumber:i.pageNumber}),t={annotationData:n,pageNumber:i.pageNumber}}}}}this.Text2D.begin({data:t,directEdit:e})},endExecute:function(){l.endCommand(this.getId()),this._disableEvents(),this.viewer.disableAntiBackGroundBorder(),this._destroyUI(),this._endCommand(),this.frameWindow.experience&&this.frameWindow.experience.publish("3DPLAY/ANNOTATION/CMD_DEACTIVATED",{}),this.Text2D&&(this.Text2D.destroy(),this.Text2D=void 0),this.ab&&(this.ab.open(),this.ab.MAB&&this.ab.MAB.toggleMainView(),this.ab=void 0),this.viewer.shapeEditionData=void 0,this.viewer=void 0,this.frameWindow=void 0},_enableEvents:function(){this.viewer.disableEvents(),c&&this.viewer.enableResize(!1),this.abToken=this.ab.onActionBarOpen(function(){this.data&&this.Text2D?this.Text2D.performForceValidate():this._exitAnnotations()}.bind(this)),this.onResizeBind=this._onResize.bind(this),this.frameWindow.getViewerFrame().addEvent("resize",this.onResizeBind),this.MABShow=r.subscribe({event:"3DPlay.MAB.Show"},function(){this._exitAnnotations()}.bind(this)),this.MABHide=r.subscribe({event:"3DPlay.MAB.Hide"},function(){this._exitAnnotations()}.bind(this))},_disableEvents:function(){this.viewer.enableEvents(),c&&this.viewer.enableResize(!0),this.ab&&this.abToken&&this.ab.removeCallback(this.abToken),this.frameWindow.getViewerFrame().removeEvent("resize",this.onResizeBind),r.unsubscribe(this.MABShow),r.unsubscribe(this.MABHide)},_onResize:function(t){},_exitAnnotations:function(){this.end()},_buildCommands:function(){},_destroyCommands:function(){},_buildUI:function(){this.contextualMenu=new e({frameWindow:this.frameWindow});this.frameWindow.getActionBar();var t={type:this.contextualMenu.Button.Check,id:"2DDelete",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",onclickCB:function(t){this.setSelected=t.setSelected,this._startCommand(t)}.bind(this)};this.contextualMenuToken=this.contextualMenu.addButtons([t],{barType:this.contextualMenu.Toolbar.New,showContextBarBackground:!0}),this.annotationToolsMenu=new i({contextualMenu:this.contextualMenu,frameWindow:this.frameWindow,newToolsUI:!0}),this.annotationToolsMenu.addToolsButton(),this.contextualMenu.panel.container.style.cursor="pointer",this._hideColorPalette()},_destroyUI:function(){this.annotationToolsMenu&&(this.annotationToolsMenu.dispose(),this.annotationToolsMenu=void 0),this.contextualMenu&&this.contextualMenuToken&&(this.contextualMenu.removeButtons(this.contextualMenuToken),this.contextualMenu.dispose(),this.contextualMenuToken=void 0,this.contextualMenu=void 0)},_startCommand:function(t,e){this._hideColorPalette(),"2DDelete"===t.id&&this._exitAnnotations()},_endCommand:function(){this._hideColorPalette();var t=!1;this.isCanceled()&&(t=!0),this.Text2D&&this.Text2D.isRunning()&&this.Text2D.end({isCommandcancelled:t})},endCommandCB:function(t){this._exitAnnotations()},_removeTools:function(){this._hideColorPalette()},_hideColorPalette:function(t){this.annotationToolsMenu&&this.annotationToolsMenu.hideColorPalette&&this.annotationToolsMenu.hideColorPalette()}})}),define("DS/3DPlay2DAnnotation/AnnotationCommandEditShape",["DS/ApplicationFrame/Command","DS/WebInfraUI/ContextualBarManager","DS/3DPlayAnnotationUtils/AnnotationToolsMenu","DS/3DPlay2DAnnotation/Annotation2DErase","DS/3DPlay2DAnnotation/Annotation2DEdit","DS/3DPlay2DAnnotation/Annotation2DText","DS/3DPlay2DAnnotation/Annotation2DDrawHighlight","DS/CoreEvents/Events","DS/WebSystem/Environment","DS/WebSystem/BrowserInfos","DS/WebUtils/Tracker"],function(t,e,i,a,n,s,o,r,h,d,l){"use strict";d.isMobile();return t.extend({init:function(t){this._parent(t,{isAsynchronous:!0,mode:"exclusive"})},beginExecute:function(){this.frameWindow=this.getFrameWindow(),this.viewer=this.frameWindow.getViewer(),this.ab=this.frameWindow.getActionBar(),this.ab.close(),this.ab.MAB&&this.ab.MAB.state&&this.ab.MAB.state.open&&this.ab.MAB.toggleMainView(),this._enableEvents(),this.viewer.enableAntiBackGroundBorder(),this.frameWindow.experience&&this.frameWindow.experience.publish("3DPLAY/ANNOTATION/CMD_ACTIVATED",{}),this.data=this.viewer.shapeEditionData},execute:function(){l.startCommand(this.getId()),this.Draw2D=new n({frameWindow:this.frameWindow,hideTools:this._removeTools.bind(this),data:this.data,mode:"edition",endCommandCB:this.endCommandCB.bind(this)}),this.Draw2D.begin()},endExecute:function(){l.endCommand(this.getId()),this._disableEvents(),this.viewer.disableAntiBackGroundBorder(),this._destroyUI(),this._endCommand(),this.frameWindow.experience&&this.frameWindow.experience.publish("3DPLAY/ANNOTATION/CMD_DEACTIVATED",{}),this.Draw2D&&(this.Draw2D.destroy(),this.Draw2D=void 0),this.ab&&(this.ab.open(),this.ab.MAB&&this.ab.MAB.toggleMainView(),this.ab=void 0),this.viewer.shapeEditionData=void 0,this.viewer=void 0,this.frameWindow=void 0},_enableEvents:function(){this.viewer.disableEvents(),this.abToken=this.ab.onActionBarOpen(function(){this._exitAnnotations()}.bind(this)),this.onResizeBind=this._onResize.bind(this),this.frameWindow.getViewerFrame().addEvent("resize",this.onResizeBind),this.MABShow=r.subscribe({event:"3DPlay.MAB.Show"},function(){this._exitAnnotations()}.bind(this)),this.MABHide=r.subscribe({event:"3DPlay.MAB.Hide"},function(){this._exitAnnotations()}.bind(this))},_disableEvents:function(){this.viewer.enableEvents(),this.ab&&this.abToken&&this.ab.removeCallback(this.abToken),this.frameWindow.getViewerFrame().removeEvent("resize",this.onResizeBind),r.unsubscribe(this.MABShow),r.unsubscribe(this.MABHide)},_onResize:function(t){this._exitAnnotations()},_exitAnnotations:function(){this.end()},_buildCommands:function(){},_destroyCommands:function(){},_buildUI:function(){this.contextualMenu=new e({frameWindow:this.frameWindow});this.frameWindow.getActionBar();var t={type:this.contextualMenu.Button.Check,id:"2DDelete",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",onclickCB:function(t){this.setSelected=t.setSelected,this._startCommand(t)}.bind(this)};this.contextualMenuToken=this.contextualMenu.addButtons([t],{barType:this.contextualMenu.Toolbar.New,showContextBarBackground:!0}),this.annotationToolsMenu=new i({contextualMenu:this.contextualMenu,frameWindow:this.frameWindow,newToolsUI:!0}),this.annotationToolsMenu.addToolsButton(),this.contextualMenu.panel.container.style.cursor="pointer",this._hideColorPalette()},_destroyUI:function(){this.annotationToolsMenu&&(this.annotationToolsMenu.dispose(),this.annotationToolsMenu=void 0),this.contextualMenu&&this.contextualMenuToken&&(this.contextualMenu.removeButtons(this.contextualMenuToken),this.contextualMenu.dispose(),this.contextualMenuToken=void 0,this.contextualMenu=void 0)},_startCommand:function(t,e){this._hideColorPalette(),"2DDelete"===t.id&&this.Draw2D.cleanCurrentAnnotation()},_endCommand:function(){this._hideColorPalette(),this.Draw2D&&this.Draw2D.isRunning()&&this.Draw2D.end()},endCommandCB:function(t){this._exitAnnotations()},_removeTools:function(){this._hideColorPalette()},_hideColorPalette:function(t){this.annotationToolsMenu&&this.annotationToolsMenu.hideColorPalette&&this.annotationToolsMenu.hideColorPalette()}})}),define("DS/3DPlay2DAnnotation/AnnotationCommands",["DS/ApplicationFrame/Command","DS/WebInfraUI/ContextualBarManager","DS/3DPlayAnnotationUtils/AnnotationToolsMenu","DS/3DPlay2DAnnotation/Annotation2DErase","DS/3DPlay2DAnnotation/Annotation2DEdit","DS/3DPlay2DAnnotation/Annotation2DText","DS/3DPlay2DAnnotation/Annotation2DDrawHighlight","DS/CoreEvents/Events","DS/WebSystem/Environment","DS/WebSystem/BrowserInfos","DS/WebUtils/Tracker"],function(t,e,i,a,n,s,o,r,h,d,l){"use strict";var c=d.isMobile();return t.extend({init:function(t){this._parent(t,{isAsynchronous:!0,mode:"exclusive"})},beginExecute:function(){this.frameWindow=this.getFrameWindow(),this.viewer=this.frameWindow.getViewer(),this.ab=this.frameWindow.getActionBar(),this.ab.close(),this._enableEvents(),this.viewer.enableAntiBackGroundBorder(),this.frameWindow.experience&&this.frameWindow.experience.publish("3DPLAY/ANNOTATION/CMD_ACTIVATED",{})},execute:function(){l.startCommand(this.getId()),this.Draw2D=new n({frameWindow:this.frameWindow,hideTools:this._removeTools.bind(this),startCommandCB:this.startCommandCB.bind(this)}),this.Erase2D=new a({frameWindow:this.frameWindow,hideTools:this._removeTools.bind(this)}),this.Highlight2D=new o({frameWindow:this.frameWindow,hideTools:this._removeTools.bind(this),startCommandCB:this.startCommandCB.bind(this)}),this._buildUI(),this.Draw2D.begin()},endExecute:function(){l.endCommand(this.getId()),this._disableEvents(),this.viewer.disableAntiBackGroundBorder(),this._destroyUI(),this._endCommand(),this.frameWindow.experience&&this.frameWindow.experience.publish("3DPLAY/ANNOTATION/CMD_DEACTIVATED",{}),this.Draw2D&&(this.Draw2D.destroy(),this.Draw2D=void 0),this.Erase2D&&(this.Erase2D.destroy(),this.Erase2D=void 0),this.Highlight2D&&(this.Highlight2D.destroy(),this.Highlight2D=void 0),this.ab&&(this.ab.open(),this.ab=void 0),this.viewer=void 0,this.frameWindow=void 0},_enableEvents:function(){this.viewer.disableEvents(),c&&this.viewer.enableResize(!1),this.abToken=this.ab.onActionBarOpen(function(){this._exitAnnotations()}.bind(this)),this.onResizeBind=this._onResize.bind(this),this.frameWindow.getViewerFrame().addEvent("resize",this.onResizeBind),this.MABShow=r.subscribe({event:"3DPlay.MAB.Show"},function(){this._exitAnnotations()}.bind(this)),this.MABHide=r.subscribe({event:"3DPlay.MAB.Hide"},function(){this._exitAnnotations()}.bind(this))},_disableEvents:function(){this.viewer.enableEvents(),c&&this.viewer.enableResize(!0),this.ab&&this.abToken&&this.ab.removeCallback(this.abToken),this.frameWindow.getViewerFrame().removeEvent("resize",this.onResizeBind),r.unsubscribe(this.MABShow),r.unsubscribe(this.MABHide)},_onResize:function(t){},_exitAnnotations:function(){this.end()},_buildCommands:function(){},_destroyCommands:function(){},_buildUI:function(){this.childCommandClickCB=function(t){this.setSelected=t.setSelected,this._endCommand(),this._startCommand(t)},this.contextualMenu=new e({frameWindow:this.frameWindow});this.frameWindow.getActionBar();var t=[{type:this.contextualMenu.Button.Radio,content:[{id:"2DDrawing",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",selected:!0},{id:"2DHighlight",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation"},{id:"2DErase",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation"}],onclickCB:this.childCommandClickCB.bind(this)},{type:this.contextualMenu.Button.Master,id:"ExitAnnotation",rsc:"3DPlayAnnotationUtils/3DPlayAnnotation",nls:"3DPlayAnnotationUtils/3DPlayAnnotation",onclickCB:function(){this._exitAnnotations()}.bind(this)}];this.contextualMenuToken=this.contextualMenu.addButtons(t,{barType:this.contextualMenu.Toolbar.New,showContextBarBackground:!0}),this.annotationToolsMenu=new i({contextualMenu:this.contextualMenu,frameWindow:this.frameWindow,newToolsUI:!0}),this.annotationToolsMenu.addToolsButton(),this.contextualMenu.panel.container.style.cursor="pointer",this._hideColorPalette()},_destroyUI:function(){this.annotationToolsMenu&&(this.annotationToolsMenu.dispose(),this.annotationToolsMenu=void 0),this.contextualMenu&&this.contextualMenuToken&&(this.contextualMenu.removeButtons(this.contextualMenuToken),this.contextualMenu.dispose(),this.contextualMenuToken=void 0,this.contextualMenu=void 0)},_startCommand:function(t,e){this._hideColorPalette(),"2DDrawing"===t.id?this.Draw2D.begin():"2DErase"===t.id?this.Erase2D.begin():"2DHighlight"===t.id&&this.Highlight2D.begin()},_endCommand:function(){this._hideColorPalette(),this.Draw2D&&this.Draw2D.isRunning()&&this.Draw2D.end(),this.Erase2D&&this.Erase2D.isRunning()&&this.Erase2D.end(),this.Highlight2D&&this.Highlight2D.isRunning()&&this.Highlight2D.end()},startCommandCB:function(t){var e=t.command,i=t.data;void 0===e&&(e={id:"2DDrawing"}),this._endCommand(),this._startCommand(e,i),this.setSelected&&!1===this.setSelected(e)&&this.refreshAnnotations()},refreshAnnotations:function(){},_removeTools:function(){this._hideColorPalette()},_hideColorPalette:function(t){this.annotationToolsMenu&&this.annotationToolsMenu.hideColorPalette&&this.annotationToolsMenu.hideColorPalette()}})});