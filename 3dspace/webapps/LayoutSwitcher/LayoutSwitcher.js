define("DS/LayoutSwitcher/GridLayoutConverter",["UWA/Core"],function(t){"use strict";return{getGridCoordinates:function(e,i){var n=[],o=[],r=[],a=e.elements.wrapper,s=a.getBoundingClientRect(),d=e.minWidgetWidth*e.cols/a.scrollWidth;function h(t,e){return!(e.col>t.col-1+t.sizex||e.col-1+e.sizex<t.col||e.row>t.row-1+t.sizey||e.row-1+e.sizey<t.row)}function c(t){return t.col-1+t.sizex>e.cols}function u(t,e){var i=[],n=[];return i[0]=Math.max(t.row,e.row),i[1]=Math.min(t.row+t.sizey-1,e.row+e.sizey-1),n[0]=Math.max(t.col,e.col),n[1]=Math.min(t.col+t.sizex-1,e.col+e.sizex-1),{horizontal:Math.max(0,i[1]-i[0]),vertical:Math.max(0,n[1]-n[0])}}function l(t,e){var i=u(t,e);return h(t,e)&&i.vertical>0&&i.vertical>=i.horizontal}function f(i){var r=t.clone(i),a=function(t){var i=[];function r(t){return t?n.filter(function(e){return e.widgetId===t})[0]:{col:1,row:1,sizex:e.cols}}return o.forEach(function(e){var n;t.widgetId===e.w1?n=r(e.w2):t.widgetId===e.w2&&(n=r(e.w1)),n&&i.push({side:e.side,position:n})}),i}(r);return n.forEach(function(t){if(t!==i){for(;a=void 0,a=u(n=r,o=t),h(n,o)&&a.horizontal>0&&a.horizontal>=a.vertical;)if(r.col>t.col)++r.col;else{if(!(r.sizex>e.minSizex))break;--r.sizex}for(var n,o,a;l(r,t);)if(r.row>t.row)++r.row;else{if(!(r.sizey>e.minSizey))break;--r.sizey}}}),a.forEach(function(t){switch(t.side){case"left":r.sizex+=r.col-t.position.col,r.col=t.position.col;break;case"top":r.sizey+=r.row-t.position.row,r.row=t.position.row;break;case"right":r.col+e.minSizex-1<=e.cols&&(r.sizex=Math.max(t.position.col+t.position.sizex-r.col,e.minSizex));break;case"bottom":r.sizey=Math.max(t.position.row+t.position.sizey-r.row,e.minSizey)}}),r.col+e.minSizex-1<=e.cols&&c(r)&&(r.sizex=e.cols-r.col+1),r}return i.forEach(function(t,e){var i={left:t.left,top:t.top,width:t.width,height:t.height};i.widgetId=e,r.push(i)}),r.forEach(function(t,e){function i(t,e,i){o.push({w1:t.widgetId,w2:e.widgetId,side:i})}Math.round(t.left)===Math.round(s.left)&&i(t,{},"left"),Math.round(t.top)===Math.round(s.top)&&i(t,{},"top"),Math.round(t.left+t.width)===Math.round(s.left+s.width)&&i(t,{},"right"),r.forEach(function(n,o){o>=e||(Math.round(t.left)===Math.round(n.left)&&i(t,n,"left"),Math.round(t.top)===Math.round(n.top)&&i(t,n,"top"),Math.round(t.left+t.width)===Math.round(n.left+n.width)&&i(t,n,"right"),Math.round(t.top+t.height)===Math.round(n.top+n.height)&&i(t,n,"bottom"))})}),r.sort(function(t,e){return t.top-e.top||t.left-e.left}).forEach(function(t){n.push(f({widgetId:t.widgetId,col:function(t){return Math.max(0,Math.round(d*(t.left-s.left)/e.minWidgetWidth-.5))+1}(t),row:function(t){return Math.max(0,Math.round((t.top-s.top)/e.minWidgetHeight-.5))+1}(t),sizex:function(t){return Math.min(Math.min(Math.max(e.minSizex,Math.ceil(d*t.width/e.minWidgetWidth-.5)),e.cols))}(t),sizey:function(t){return Math.max(e.minSizey,Math.ceil(t.height/e.minWidgetHeight-.5))}(t)}))}),n.slice().forEach(function(e,i){n[i]=f(e),c(e)&&(n[i]=function(e){var i=t.clone(e),o=!1;function r(t){if(e!==t)for(;c(i)||h(i,t);)c(i)?(i.col=1,++i.row,o=!0):++i.col}do{o=!1,n.forEach(r)}while(o);return i}(f(e)),o=o.filter(function(t){return-1===[t.w1,t.w2].indexOf(e.widgetId)}))}),n}}}),define("DS/LayoutSwitcher/SwitchableLayout",["UWA/Class"],function(t){"use strict";function e(){throw new Error("Unimplemented abstract method")}var i=t.extend({name:"",autoBreakpointFallback:!0,init:function(t){this.widget=t.widget,this.switcher=t.switcher},setup:e,getDefaultConfig:e,refresh:e,serializeChildren:e,loadChild:e,addChild:e,removeChild:e,getChildCoordinates:e,getDuplicatedChildCoordinates:e,destroy:e,clean:e,buildFrom:e});return i.getNew=function(t,e){return new(i.getClass(t))(e)},i.getClass=function(t){switch(t){case"grid":return require("DS/LayoutSwitcher/GridLayout");case"dock":return require("DS/LayoutSwitcher/DockLayout");default:throw new Error("Unkown layout type "+t)}},i.acceptsCoordinates=e,i}),define("DS/LayoutSwitcher/DockLayoutConverter",["DS/WebappsUtils/Map"],function(t){"use strict";function e(e){var i,n=e.slice();function o(t,e,i){for(var n=0;n<t.length;++n){if(t[n]===e)return;if(i(t[n],e)>0)return void t.splice(n,0,e)}t.push(e)}function r(t,e){var i=t.indexOf(e);i>-1&&t.splice(i,1)}function a(t){return{x:t.left+t.width/2,y:t.top+t.height/2}}function s(t,e){return t===e||!!t.type&&t.reduce(function(t,i){return t||s(i,e)},!1)}function d(t,e,i,n){var o,r,a,s=e.x-t.x,d=e.y-t.y,h=n.x-i.x,c=n.y-i.y,u=s*c-d*h;return 0!==u&&(!((r=((o={x:i.x-t.x,y:i.y-t.y}).x*c-o.y*h)/u)<0||r>1)&&!((a=(o.x*d-o.y*s)/u)<0||a>1))}function h(t,e,i){var n,o,r=[];return"horizontal"===i?(r[0]=Math.max(t.top,e.top),r[1]=Math.min(t.top+t.height-1,e.top+e.height-1),n=Math.min(t.top,e.top),o=Math.max(t.top+t.height,e.top+e.height)):(r[0]=Math.max(t.left,e.left),r[1]=Math.min(t.left+t.width-1,e.left+e.width-1),n=Math.min(t.left,e.left),o=Math.max(t.left+t.width,e.left+e.width)),(Math.max(0,r[1]-r[0])/(o-n||1)).toFixed(2)}function c(t,e){return!(e.left>t.left+t.width-1||e.left+e.width-1<t.left||e.top>t.top+t.height-1||e.top+e.height-1<t.top)}function u(t,e){var i,o=e.left>t.left?t:e,r=e.left>t.left?e:t,a={left:o.left+o.width,top:i=Math.max(o.top,r.top),width:r.left-(o.left+o.width),height:Math.min(o.top+o.height,r.top+r.height)-i};return h(t,e,"horizontal")>0&&0===n.filter(function(t){return c(t,a)}).length}function l(t,e){var i,o=e.top>t.top?t:e,r=e.top>t.top?e:t,a={left:i=Math.max(o.left,r.left),top:o.top+o.height,width:Math.min(o.left+o.width,r.left+r.width)-i,height:r.top-(o.top+o.height)};return h(t,e,"vertical")>0&&0===n.filter(function(t){return c(t,a)}).length}function f(t,e,i){t.left=Math.min(e.left,i.left),t.top=Math.min(e.top,i.top),t.width=Math.max(e.left+e.width-i.left,i.left+i.width-e.left),t.height=Math.max(e.top+e.height-i.top,i.top+i.height-e.top)}function g(t,n,s){function d(t,e){var i=a(t),n=a(e),o="row"===s?"x":"y";return i[o]-n[o]}var h,c=[];t.type===s&&n.type===s?(n.forEach(function(e){o(t,e,d)}),r(e,n),h=t):t.type===s?(o(t,n,d),r(e,n),h=t):n.type===s?(o(n,t,d),r(e,t),h=n):(o(c,t,d),r(e,t),o(c,n,d),r(e,n),h=c,c.type=s,e.push(c)),i=!0,f(h,t,n)}function p(t,e){(function(t,e){return t.top===e.top&&t.height===e.height&&u(t,e)})(t,e)&&g(t,e,"row")}function w(t,e){(function(t,e){return t.left===e.left&&t.width===e.width&&l(t,e)})(t,e)&&g(t,e,"column")}function m(t){var n="horizontal"===t?p:w;e.slice().forEach(function(t){e.slice().forEach(function(o){i||t===o||-1===e.indexOf(t)||n(t,o)})})}function y(){var i,o,r=new t,p=0,w=1/0,m=1/0,y=[],v=[];function C(t,e){var i={horizontal:[],vertical:[]},n=r.get(t)||i,o=r.get(e)||i;return n.horizontal.length+n.vertical.length+o.horizontal.length+o.vertical.length}function b(t,e){return!(t.type||e.type)||function(t,e){var i=a(t),o=a(e);return 0===n.filter(function(n){if(s(t,n)||s(e,n))return!1;var r={x:n.left,y:n.top},a={x:n.left+n.width-1,y:n.top},h={x:n.left,y:n.top+n.height-1},c={x:n.left+n.width-1,y:n.top+n.height-1};return d(i,o,r,a)||d(i,o,a,c)||d(i,o,c,h)||d(i,o,h,r)}).length}(t,e)&&!c(t,e)}e.forEach(function(t){r.set(t,{horizontal:[],vertical:[]}),e.forEach(function(e){t!==e&&(u(t,e)&&b(t,e)?r.get(t).horizontal.push(e):l(t,e)&&b(t,e)&&r.get(t).vertical.push(e))})}),r.forEach(function(t,e){t.horizontal.concat(t.vertical).forEach(function(t){var i=C(e,t),n=Math.min(C(e),C(t));i<=w&&i>0&&n<m&&(w=i,m=n)})}),r.forEach(function(t,e){t.horizontal.concat(t.vertical).forEach(function(t){C(e,t)===w&&Math.min(C(e),C(t))===m&&y.push([e,t])})}),y.forEach(function(t){var e=t[0],n=t[1],a=u(e,n)?"horizontal":"vertical",s=h(e,n,a),d=!1;v.filter(function(t){return t[0]===e&&t[1]===n||t[0]===n&&t[1]===e}).length>0||(r.get(e)["horizontal"===a?"vertical":"horizontal"].forEach(function(i){var o,r;f(o={},e,i),r=h(o,n,a),(d=d||r>s)&&v.push(t)}),s>p&&!d&&(p=s,i=e,o=n))}),i&&o&&g(i,o,u(i,o)?"row":"column")}function v(){var t,i,n,o,r,s,d=[],c=e.map(function(t){var e=a(t);return e.rectangle=t,e});function u(t){return Math.sqrt(t.x*t.x+t.y*t.y)}c.forEach(function(t,e){c.forEach(function(i,n){n>=e||d.push({p1:t,p2:i,vector:{x:i.x-t.x,y:i.y-t.y}})})}),d.sort(function(t,e){return u(t.vector)-u(e.vector)||t.p1.y-t.p2.y||t.p1.x-t.p2.x}),r=h(i=(t=d[0]).p1.rectangle,n=t.p2.rectangle,"horizontal"),s=h(i,n,"vertical"),o=Math.acos(t.vector.x/u(t.vector)),g(i,n,Math.max(r,s)>0?r>s?"row":"column":Math.abs(o)<Math.PI/4||Math.abs(o)>3*Math.PI/4?"row":"column")}for(i=!0,e=e.slice();i&&e.length>1;)e.sort(function(t,e){var i=a(t),n=a(e);return i.y-n.y||i.x-n.x}),i=!1,m("horizontal"),!i&&e.length>1&&(m("vertical"),!i&&e.length>1&&(y(),!i&&e.length>1&&v()));return e[0]}return{getStructure:function(t){var i=[];return t.forEach(function(t,e){i.push({widgetId:e,left:t.left,top:t.top,width:t.width,height:t.height})}),function t(e){var i,n,o={};return e?(e.type?(o.type=e.type,i="row"===o.type?"width":"height",o.content=e.map(function(e){return t(e)}),n=e.reduce(function(t,e){return t+e[i]},0),o.content.forEach(function(t,o){t.weight=100*e[o][i]/n})):(o.type="item",o.content=e.widgetId),o):{}}(e(i))}}}),define("DS/LayoutSwitcher/BreakpointUtils",["UWA/Core","UWA/Class","DS/UWPClientControls/Utils"],function(t,e,i){"use strict";return e.extend({init:function(){this.breakpoint=i.getPlatform()},getPriorityMap:function(){return[this.breakpoint,"desktop","tablet","mobile"]},getBreakpointAwareData:function(t){var e;return this.getPriorityMap().forEach(function(i){null==e&&(e=t[i])}),e},getLayoutAndBreakpointAwareChildrenCoordinates:function(t,e){var i=this.getPriorityMap(),n=i.length,o={},r={};return t.forEach(function(t){o[t.id]=e(JSON.parse(t.coordinates)),i.forEach(function(e,i){null!=o[t.id][e]&&(n=Math.min(n,i))})},this),t.forEach(function(t){r[t.id]=o[t.id][i[n]]}),r},getUpdatedCoordinates:function(e,i){var n={};return n[this.breakpoint]=i,t.extend(t.clone(e),n)},getBreakpointAgnosticStringifiedCoordinates:function(t){var e;try{e=JSON.parse(t)}catch(t){}if(null==e)t='"'+(t+"").trim()+'"';else if(null!=this.getBreakpointAwareData(e))return t;return'{"'+this.breakpoint+'":'+t+"}"}})}),define("DS/LayoutSwitcher/GridLayout",["UWA/Core","DS/WebappsUtils/Map","DS/UWPClientControls/Grid","DS/LayoutSwitcher/SwitchableLayout","DS/LayoutSwitcher/GridLayoutConverter"],function(t,e,i,n,o){"use strict";var r=n.extend({name:"grid",autoBreakpointFallback:!1,init:function(){this._parent.apply(this,arguments)},setup:function(n){var r,a,s=n.children,d=n.config,h={},c=this.switcher.breakpoint;return this._widgetElToId=new e,this._previousLayoutCoordinates&&(r=new i(d),a=o.getGridCoordinates(r,this._previousLayoutCoordinates),r.destroy(),this._previousLayoutCoordinates=void 0,a.forEach(function(e){var i=t.clone(e);delete i.widgetId,h[e.widgetId]={},h[e.widgetId][c]=i},this)),d.widgets=s.map(function(e){var i=this.widget.body.getElement(".wi-"+e.id);e.el=i||e.el,this._widgetElToId.set(e.el,e.id);try{return e.parsedCoordinates=h[e.id]||e.parsedCoordinates||JSON.parse(e.coordinates)||{},{child:e,wdg:t.extend({el:e.el},e.parsedCoordinates)}}catch(t){return{child:e,wdg:{el:e.el}}}},this).sort(function(t,e){var i=t.child,n=e.child,o=(i.parsedCoordinates||{})[c]||i.parsedCoordinates||{},r=(n.parsedCoordinates||{})[c]||n.parsedCoordinates||{};return o.row-r.row}).map(function(t){return t.wdg}),this.grid=new i(d),this.grid},getDefaultConfig:function(){return this.refresh(),{el:this.widget.body,handle:".moduleHeader *",widgets:[],serialize:function(t,e){return{id:this._widgetElToId.get(t),coordinates:JSON.stringify(e)}}.bind(this),smartBreakpointDebut:!0,containerWidth:this.gridWidth,baseX:this.gridOffsets.x,baseY:this.gridOffsets.y,events:{onDrop:this.switcher.reorder.bind(this.switcher),onResize:this.switcher.reorder.bind(this.switcher)}}},refresh:function(){this.gridOffsets=this.widget.body.getOffsets(),this.gridWidth=this.widget.body.getSize().width},serializeChildren:function(){if(this.grid)return this.grid.serialize().map(function(t){var e=JSON.parse(t.coordinates);return{id:t.id,coordinates:e[this.switcher.breakpoint]||e}},this)},loadChild:function(){},addChild:function(e){this.grid.add(t.extend({el:e.el},e.coordinates||{})),this._widgetElToId.set(e.el,e.id)},removeChild:function(t){this.grid.remove({widget:t}),this._widgetElToId.delete(t)},getChildCoordinates:function(e){var i=t.extend({},this.grid.findWidget(e));return delete i.el,i[this.switcher.breakpoint]||i},getDuplicatedChildCoordinates:function(t){return this.getChildCoordinates(t)},destroy:function(){this.grid&&this.grid.destroy()},clean:function(){var t=this.grid;this.widget.body.getElements("."+t.options.widgetClassName).forEach(r.cleanupWidget.bind(null,t)),t.elements.container.removeClassName(t.name)},buildFrom:function(t,e){this._previousLayoutCoordinates=e}});return r.cleanupWidget=function(t,e){var i=t.options;e.removeClassName(i.widgetClassName),["data-col","data-row","data-sizex","data-sizey"].forEach(function(t){e.removeAttribute(t)}),e.getElements("."+i.resizeClassName).forEach(function(t){t.remove()})},r.acceptsCoordinates=function(t){var e=!0;try{t=t.map(function(t){return Object.keys(t).reduce(function(e,i){return e&&"object"==typeof t[i]},!0)?Object.keys(t).map(function(e){return t[e]}):t},this).reduce(function(t,e){return t.concat(e)},[]);for(var i=0;i<t.length&&e;++i)e=e&&t[i].col>0&&t[i].row>0&&t[i].sizex>0&&t[i].sizey>0}catch(t){e=!1}return e},r}),define("DS/LayoutSwitcher/DockLayout",["UWA/Core","DS/WebappsUtils/Map","DS/UWPClientControls/DockLayout/Manager","DS/LayoutSwitcher/SwitchableLayout","DS/LayoutSwitcher/DockLayoutConverter"],function(t,e,i,n,o){"use strict";function r(t){var e={content:[]};return Object.keys(t).forEach(function(i){var n,o,r=t[i],a=r.containers.slice(0).reverse(),s={type:"item",content:i,weight:r.weight},d=e;for(n=0;n<a.length;++n)o=a[n],d.content[o.index]=d.content[o.index]||{type:o.type,content:[],weight:o.weight},d=d.content[o.index];d.content[r.index]=s}),e.content[0]}function a(t){var e={};function i(t){if("r"===t)return"row";if("c"===t)return"column";throw new Error("Invalid compressed type "+t)}return Object.keys(t).forEach(function(n){var o=(t[n]+" 0 1").trim().split(" ");for(e[n]={index:parseInt(o.shift()),weight:parseInt(o.shift()),containers:[]};o.length;)e[n].containers.push({type:i(o.shift()),index:parseInt(o.shift()),weight:parseInt(o.shift())})}),e}function s(e){return t.createElement("div",{class:"dock-placeholder",id:"placeholder-"+e})}function d(t,e,i){var n=t.dockItem;n.swapElement(e),n.content=i,e.classList.remove("dock-placeholder")}var h,c=!1,u=!1;return(h=n.extend({name:"dock",init:function(){this._parent.apply(this,arguments)},setup:function(t){var n=t.children,o=t.config;return this._widgetIdToEl=new e,this._deletedWidgetIds=[],this._consecutivePossibleCleanUndo=0,this._consecutiveUndoableResize=0,this._idsUnknownToBreakpoint=[],o.structure=this._convertedStructure||this._deserializeChildren(n),this._convertedStructure=void 0,o.leafReviver=function(t){var e=this._widgetIdToEl.get(t);return c?(c=!1,s(t)):u?e:e||s(t)}.bind(this),n.forEach(function(t){this._widgetIdToEl.set(t.id,t.el)},this),this.manager=new i(o),this._idsUnknownToBreakpoint.forEach(function(t){this.addChild({id:t,el:this._widgetIdToEl.get(t)})},this),this._idsUnknownToBreakpoint=void 0,this.widget.body.parentElement.addClassName(this.name),this.manager},getDefaultConfig:function(){return{container:this.widget.body,onChange:function(t){"remove"===t?++this._consecutivePossibleCleanUndo:"addChild"===t&&u?this._consecutivePossibleCleanUndo=Math.max(this._consecutivePossibleCleanUndo-1,0):"resize"!==t&&(this._consecutivePossibleCleanUndo=0),"resize"===t?++this._consecutiveUndoableResize:this._consecutiveUndoableResize=0,-1!==["addChild","removeChild","reorder","resize"].indexOf(t)&&this.switcher.reorder()}.bind(this)}},refresh:function(){},serializeChildren:function(){if(this.manager){var t,e,i,n=this.manager.serialize();return n?(e=JSON.parse(n||"null"),i={},e&&function t(e,n,o){"item"===e.type?i[e.content]={weight:e.weight,index:o,containers:n}:e.content.forEach(function(i,r){t(i,[{type:e.type,index:o||0,weight:e.weight}].concat(n||[]),r)})}(e),t=function(t){var e={};function i(t){return"number"==typeof t?Math.round(t):1}return Object.keys(t).forEach(function(n){var o=t[n];e[n]=((o.index||0)+" "+i(o.weight)+" "+(o.containers||[]).map(function(t){return t.type.charAt(0)+" "+t.index+" "+i(t.weight)}).join(" ")).trim().replace(/( |^)0 [0-9]+$/,"")}),e}(i),Object.keys(t).map(function(e){return{id:e,coordinates:t[e]}})):[]}},_deserializeChildren:function(t){var e={};return t.forEach(function(t){e[t.id]=t.parsedCoordinates},this),Object.keys(e).forEach(function(t){null==e[t]&&(this._idsUnknownToBreakpoint.push(t),delete e[t])},this),r(a(e))},addChild:function(t){var e=this.widget.body.getElement(".dock-placeholder"),i=t.id,n=t.el,o=this._deletedWidgetIds.indexOf(i);if(e)e.parentElement.appendChild(n),n.dockItem=e.dockItem,e.removeClassName("dock-placeholder");else{if(this._widgetIdToEl.set(i,n),0===o){if(this._deletedWidgetIds.shift(),u=!0,0===o&&this._consecutivePossibleCleanUndo>0){for(var r=0;r<this._consecutiveUndoableResize+1;++r)this.manager.undo(!0);this.manager.paint()}else this._addItemAtTheTop(i);u=!1}else this._addItemAtTheTop(i),this._deletedWidgetIds=[];this.manager.paint()}setTimeout(function(){e&&(d(e,n,i),e.remove()),this._widgetIdToEl.set(i,n),-1===o&&this.manager.onChange("addChild")}.bind(this))},_addItemAtTheTop:function(t){(this.manager.root.content||this.manager.root).getDropTargets().filter(function(t){return-1!==["top","root"].indexOf(t.name)})[0].createItems([t])},loadChild:function(t){var e=this.widget.body.getElement("#placeholder-"+t),i=this._widgetIdToEl.get(t);e&&(e.parentElement.appendChild(i),i.setAttribute("style",e.getAttribute("style")),i.addClassName("dock-item"),d(e,i,t),e.remove())},removeChild:function(t){var e=t.dockItem,i=e.content;this._deletedWidgetIds.unshift(i),this._widgetIdToEl.delete(i),e.remove(!0)},getChildCoordinates:function(t){var e;return this._widgetIdToEl.forEach(function(i,n){t===i&&(e=n)}),this.serializeChildren().filter(function(t){return t.id===e})[0].coordinates},getDuplicatedChildCoordinates:function(t){c=!0;var e="_duplicate"+Date.now();return t.dockItem.duplicate(!0).content=e,this.serializeChildren().filter(function(t){return t.id===e})[0].coordinates},destroy:function(){this._widgetIdToEl&&(this.clean(),this._widgetIdToEl=void 0)},clean:function(){var t=this.widget.body;this.manager.freeze(),t.getElements(".dock-item").forEach(function(t){h.cleanupWidget(t),t.removeAttribute("style")}),t.parentElement.removeClassName(this.name)},buildFrom:function(t,e){this._convertedStructure=o.getStructure(e),0===Object.keys(this._convertedStructure).length&&(this._convertedStructure=void 0)}})).cleanupWidget=function(t){t.removeClassName("dock-item"),t.removeClassName("dock-dragging"),t.removeClassName("dock-maximized"),t.removeClassName("dock-minimized")},h.acceptsCoordinates=function(t){try{r(a(t))}catch(t){return!1}return!0},h}),define("DS/LayoutSwitcher/Switcher",["UWA/Core","UWA/Class","DS/UWPClientCode/Data/Widgets","DS/UWPClientCode/PublicAPI","DS/UWPClientCode/WidgetFactory","DS/UWPClientControls/LazyLoader","DS/PubSub/PubSub","DS/WebappsUtils/Map","DS/LayoutSwitcher/BreakpointUtils","DS/LayoutSwitcher/SwitchableLayout","DS/LayoutSwitcher/GridLayout","DS/LayoutSwitcher/DockLayout"],function(t,e,i,n,o,r,a,s,d,h){"use strict";function c(){}function u(t,e){return t.filter(function(t){return t.id===e},this)[0]}function l(t,e){t.forEach(function(t){t.widget&&t.widget.environment.setVisible(e)})}return e.extend({init:function(t){var e,i,o;this.widget=t.widget,e=this.widget,i=e.data,o=e.setValue,Object.defineProperty(e,"data",{get:function(){return i},set:function(){}}),e._layoutData={hasChanged:!1,value:i.layout},e.setValue=function(t,i){return"layout"===t?Object.assign(e._layoutData,{hasChanged:!0,value:i}):o.apply(e,arguments),i},e.getValue=function(t){return"layout"===t?e._layoutData.value:e.data[t]},this.env=this.widget.environment,this.wp=this.env.wp,this.contextType=this.wp.allowedChildrenContextType,this.breakpointUtils=new d,this.breakpoint=this.breakpointUtils.breakpoint,this.nonMutatedParent={id:this.wp.id,name:this.wp.name,isEditable:this.wp.isEditable},this.module={init:void 0,onBeforeLoad:c,onAfterLoad:c,onDestroy:c,onBeforeAddChild:c,onAddChild:c,onRemoveChild:void 0,onShow:c,onHide:c,onBeforeConvert:c,onAfterConvert:c},this.wp.children=[],this._migrateLayout2018xFD05ToFD06(),this.activeLayout=this._getNewActiveLayout(),this.show=function(){this.module.onShow.call(this,this.widget),l(this.wp.children,!0)}.bind(this),this.hide=function(){this.module.onHide.call(this,this.widget),l(this.wp.children,!1)}.bind(this),this.contextType?n.getActiveContext({type:this.contextType,success:this.setup.bind(this),failure:this.setup.bind(this)}):this.setup()},setup:function(e){var i=this.widget.getValue("module");this.contextId=e&&e.modelId,this.activeLayout.refresh(),this.contextId&&this.contextType||(this.contextType=null,this.contextId=null),i?require([i],function(e){Object.keys(e).forEach(function(t){this.module[t]=e[t]},this),t.is(this.module.init,"function")?this.module.init.call(this,this.widget,this.refresh.bind(this)):this.refresh()}.bind(this),this.refresh):this.refresh()},refresh:function(){this.wp.isVisible&&(this.activeLayout.refresh(),this.clean(),this.display())},display:function(){this.widget.getValue("isTransientMode")?this.parse({}):this.contextId||this.contextType?n.getContext({serviceName:this.widget.serviceName,id:this.contextId,type:this.contextType,success:function(t){i.getWidgetInstanceChildren({serviceName:this.widget.serviceName,id:this.nonMutatedParent.id,contextType:this.contextType,contextId:this.contextId,cacheId:((window.wap||{}).widgetInstancesCacheId||"")+t.cacheId,success:this.parse.bind(this)})}.bind(this),failure:function(t){throw t}}):i.getWidgetInstanceChildren({serviceName:this.widget.serviceName,id:this.nonMutatedParent.id,cacheId:(window.wap||{}).widgetInstancesCacheId,success:this.parse.bind(this)})},getLayoutSpecificCoordinates:function(t){var e=this.widget.getValue("layout"),i={};return Object.keys(e).forEach(function(n){e[n]===this.activeLayout.name&&n in t&&(i[n]=t[n])},this),i},parse:function(t){var e,i=t.children||[];this._setChildrenParsedCoordinates(i),this._fixDesyncBetweenLayoutAndCoordinates(t.children),this.env.setEditable(this.wp.isEditable||!1),a.has("widget-"+this.widget.id)||a.add("widget-"+this.widget.id,function(t,e){this[t+"Widget"](e[0],this.reorder.bind(this))}.bind(this)),e=this.activeLayout.getDefaultConfig(),this.module.onBeforeLoad.call(this,this.activeLayout.name,e,i,this.widget),this.setupChildren(i),this.layoutInstance=this.activeLayout.setup({children:i,config:e}),this.loadChildren(i),this.module.onAfterLoad.call(this,this.activeLayout.name,this.layoutInstance,this.widget)},setupChildren:function(e){this.lazy&&r.init(this.lazy),e.forEach(function(e){e.el=e.el||t.createElement("div",{class:"module"}),e.parent=this.widget.environment,e.callback=e.callback||c,this.wp.children.push(e)},this)},loadChildren:function(t){this.lazy?(t.forEach(function(t){r.track({element:t.el,widget:t,callback:function(){o.load(t,function(){t.callback.apply(t,arguments),r.revalidate()},t.customEnvironment),this.activeLayout.loadChild(t.id)}.bind(this)})},this),setTimeout(function(){r.revalidate()},100)):t.forEach(function(t){o.load(t,t.callback,t.customEnvironment),this.activeLayout.loadChild(t.id)},this)},clean:function(){this.module.onDestroy.call(this,this.widget),this.wp.children.forEach(function(t){t.widget&&t.widget.environment&&t.widget.environment.destroy(),r.untrack(t.el)},this),this.wp.children=[],this.activeLayout.destroy(),this.widget.body.empty(),a.remove("widget-"+this.widget.id)},reorder:function(){if(!this.activeLayout)return!1;var t=this.activeLayout.serializeChildren();if(t&&0!==t.length){var e=t.map(function(t){var e=u(this.wp.children,t.id);return e?{id:t.id,coordinates:JSON.stringify(this.breakpointUtils.getUpdatedCoordinates(JSON.parse(e.coordinates||"{}"),t.coordinates))}:null},this).filter(function(t){return t});if(e.length)return this.widget.getValue("layout")[this.breakpoint]||this._setCurrentBreakpointLayout(this.activeLayout.name),i.reorderWidgetInstances({serviceName:this.widget.serviceName,parentId:this.widget.id,children:e,success:function(){var t=this.widget,e=t._layoutData;e.hasChanged&&(e.hasChanged=!1,i.editWidgetInstance({serviceName:t.serviceName,id:t.id,data:Object.assign({},t.data,{layout:e.value})}))}.bind(this)}),t}},addWidget:function(e){var i;e.configId&&t.merge(e,n.getWidgetConfiguration(e.configId)||{}),i={widgetIdOrUrl:e.widgetIdOrUrl||e.widgetId,parentId:this.widget.id,coordinates:this.breakpointUtils.getBreakpointAgnosticStringifiedCoordinates(e.coordinates)},t.merge(i,e),n.addWidgetInstance(i)},showWidget:function(e,i){var n;e.el=t.createElement("div",{class:"module"}),e.parent=this.widget.environment,this.wp.children.push(e),this.activeLayout.addChild({el:e.el,id:e.id,coordinates:this.breakpointUtils.getBreakpointAwareData(JSON.parse(e.coordinates))}),e.sourceId&&(n=u(this.wp.children,e.sourceId),e.initialView=n&&n.widget.getView()),this.module.onBeforeAddChild.call(this,e,this.widget),o.load(e,i,e.customEnvironment),this.module.onAddChild.call(this,e,this.widget)},duplicateWidget:function(t){var e,i,o;(e=u(this.wp.children,t))&&e.widget&&(i=e.widget.environment,o=JSON.stringify(this.breakpointUtils.getUpdatedCoordinates({},this.activeLayout.getDuplicatedChildCoordinates(i.html.module))),n.copyWidgetInstance({serviceName:this.widget.serviceName,sourceId:t,coordinates:o,name:i.wp.name}))},removeWidget:function(e){var i,n,o;(i=u(this.wp.children,e))&&i.widget&&(n=i.widget.environment,o=function(){this.wp.children=this.wp.children.filter(function(t){return t.id!==e}),n.wp||(n.wp={id:e}),n.removeWidget(this.reorder.bind(this))}.bind(this),t.is(this.module.onRemoveChild,"function")?this.module.onRemoveChild.call(this,i,this.widget,o):o())},convertTo:function(t){var e,i,n,o=this,r=new s;return e=o.activeLayout,o.activeLayout=h.getNew(t,{widget:o.widget,switcher:o}),i=o.activeLayout.getDefaultConfig(),o.module.onBeforeConvert.call(o,e.name,t,i,o.wp.children,o.layoutInstance,o.widget).then(function(){(n=o.wp.children).forEach(function(t){t.el.parentElement&&r.set(t.id,t.el.getBoundingClientRect())}),o._setCurrentBreakpointLayout(t),o.activeLayout.buildFrom(e,r),o.layoutInstance=o.activeLayout.setup({children:n,config:i}),e.clean()}).then(function(){o.module.onAfterConvert.call(o,e.name,t,o.layoutInstance,o.widget)}).then(function(){o.reorder()})},_migrateLayout2018xFD05ToFD06:function(){var t=this.widget.getValue("layout"),e={};null==t?(e[this.breakpoint]="grid",this.widget.setValue("layout",e)):"string"==typeof t&&this.widget.setValue("layout",{desktop:t,tablet:t,mobile:t})},_getCurrentBreakpointLayout:function(){return this.breakpointUtils.getBreakpointAwareData(this.widget.getValue("layout"))||"grid"},_setCurrentBreakpointLayout:function(e){var i={};i[this.breakpoint]=e,this.widget.setValue("layout",t.extend(t.clone(this.widget.getValue("layout")),i))},_getNewActiveLayout:function(){return h.getNew(this._getCurrentBreakpointLayout(),{widget:this.widget,switcher:this})},_fixDesyncBetweenLayoutAndCoordinates:function(t,e){var i=function(t){this._setCurrentBreakpointLayout(t),this.activeLayout=this._getNewActiveLayout()}.bind(this),n=this._getCurrentBreakpointLayout(),o=(t||this.wp.children).map(function(t){return t.parsedCoordinates}),r={grid:h.getClass("grid").acceptsCoordinates(o),dock:h.getClass("dock").acceptsCoordinates(o)},a="grid"===n?"dock":"grid";if(!r[n]){if(!r[a]){if(!e)return i(a),this._setChildrenParsedCoordinates(t),void this._fixDesyncBetweenLayoutAndCoordinates(t,!0);a="grid"}this._getCurrentBreakpointLayout()!==a&&i(a),this.activeLayout.refresh(),this.clean()}},_setChildrenParsedCoordinates:function(t){var e;t.forEach(function(t){t.coordinates=this.breakpointUtils.getBreakpointAgnosticStringifiedCoordinates(t.coordinates)},this),this.activeLayout.autoBreakpointFallback?(e=this.breakpointUtils.getLayoutAndBreakpointAwareChildrenCoordinates(t,this.getLayoutSpecificCoordinates.bind(this)),t.forEach(function(t){t.parsedCoordinates=e[t.id]})):t.forEach(function(t){t.parsedCoordinates=JSON.parse(t.coordinates)})}})});