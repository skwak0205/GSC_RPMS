define("DS/SocialToolbarWdg/CropModal",["UWA/Core","DS/UIKIT/SuperModal","DS/UIKIT/Spinner","i18n!DS/SocialToolbarWdg/assets/nls/main"],function(e,t,n,i){"use strict";function o(o){var r=o.canvas,a=o.initialCrop,c={left:0,top:0,width:r.width,height:r.height},l=!1,u=s._elements.buttons=[],d=s._elements.body=e.createElement("div",{class:"crop-modal-body"});function h(){l=!0}function m(e){s._superModal.modals.current.getFooter().getElement("button").disabled=!e}function p(){l=!1,s._cropper.setData({x:c.left,y:c.top,width:c.width,height:c.height})}return u.push({className:"default",value:i.cancelButton,action:function(){o.cancel()}}),u.push({className:"primary",value:i.cropButton,action:function(){o.confirm(c)}}),r.style.opacity=0,d.appendChild(o.canvas),new t({className:"crop-modal",renderTo:top.document.body,closable:!0,events:{onShow:function(){m(!1),s._elements.spinner=(new n).inject(s._elements.body).show(),function(e,t){return new Promise(function(n,i){top.require(["DS/Cropperjs/Cropperjs"],function(i){n(new i(e,{viewMode:2,autoCropArea:1,initialAspectRatio:e.width/e.height,rotatable:!1,scalable:!1,movable:!1,zoomable:!1,cropBoxMovable:!0,cropBoxResizable:!0,background:!1,crop:t}))},i)})}(r,function(e){l||(c={left:e.detail.x,top:e.detail.y,width:e.detail.width,height:e.detail.height})}).then(function(e){s._cropper=e,setTimeout(function(){a&&e.setData({x:a.left,y:a.top,width:a.width,height:a.height}),s._elements.spinner.hide(),s._elements.body.addClassName("cropper-modal-ready"),m(!0)}),top.addEventListener("resize",h),s._elements.body.addEvent("resize",p)})},onHide:function(){top.removeEventListener("resize",h),s._elements.body.removeEvent("resize",p),o.cancel()}}})}top.require(["css!DS/SocialToolbarWdg/assets/stylesheet/CropModal"]);var s={_superModal:null,_elements:{},_cropper:null,show:function(e){s._superModal&&this.hide(),s._superModal=o({canvas:e.canvas,initialCrop:e.initialCrop,confirm:function(t){e.onConfirm(t),s.hide()},cancel:function(){e.onCancel(),s.hide()}}),s._superModal.dialog({body:s._elements.body,title:i.cropScreenshot,buttons:s._elements.buttons})},hide:function(){s._cropper&&s._cropper.destroy(),s._elements.body&&s._elements.body.remove(),s._superModal&&s._superModal.modals.current&&s._superModal.modals.current.hide(),s._superModal&&s._superModal.destroy(),s._cropper=null,s._superModal=null,s._elements={}}};return s}),define("DS/SocialToolbarWdg/ScreenshotMediaMiddleware",["DS/SocialToolbar/Models/BaseModel","i18n!DS/SocialToolbarWdg/assets/nls/main"],function(e,t){"use strict";var n=top.require("DS/UWPClientCode/PublicAPI");function i(e){var t=Object.assign(document.createElement("div"),{innerHTML:e});return Array.from(t.querySelectorAll('img[data-source="3DDashboard"]'))}function o(e){return(t=e.dataset.data,o=new Image,i=new Promise(function(e){o.addEventListener("load",function(){var t=document.createElement("canvas"),n=t.getContext("2d");t.width=o.naturalWidth,t.height=o.naturalHeight,n.drawImage(o,0,0),t.toBlob(function(t){e(t)},"image/jpeg")})}),o.src=t,i).then(function(e){return new Promise(function(t,i){n.createCommentMedia({serviceUrl:top.dsBaseUrl,data:e,subjectUri:widget.getValue("subjectUri"),type:"image",success:t,failure:i})})});var t,i,o}function s(e){return new Promise(function(t,i){n.deleteCommentMedia({serviceUrl:top.dsBaseUrl,id:e.dataset.mediaId,subjectUri:widget.getValue("subjectUri"),type:"image",success:t,failure:i})})}function r(e){return Promise.all(e.map(o))}function a(e){return Promise.all(e.map(s))}function c(e,t){var n=i(e.get("richMessage")),o=n.filter(function(e){return!e.dataset.mediaId}),s=n[0]&&n[0].parentElement;s&&(o.forEach(function(e,n){delete e.dataset.data,e.dataset.mediaId=t[n].id}),e._attributes.richMessage=s.innerHTML)}return{init:function(n){var o=e.prototype.sync;e.prototype.sync=function(e,s,l){var u,d,h,m,p,g=this;function f(){return new Promise(function(t,n){o.call(g,e,s,Object.assign({},l,{onComplete:function(){t(),l.onComplete&&l.onComplete.apply(this,arguments)},onFailure:function(){n(),l.onFailure&&l.onFailure.apply(this,arguments)}}))})}"create"===(e=e.toLowerCase())?r(i(s.get("richMessage"))).then(function(e){return c(s,e),f()},function(){n.onFailure({message:t.screenshotCreationError})}):"update"===e?(u=i(s.previousAttributes().richMessage),d=i(s.get("richMessage")),h=d.map(function(e){return e.dataset.mediaId}).filter(function(e){return!!e}),m=d.filter(function(e){return!e.dataset.mediaId}),p=u.filter(function(e){return!h.includes(e.dataset.mediaId)}),Promise.all([r(m),a(p)]).then(function(e){return{created:e[0],deleted:e[1]}})).then(function(e){return c(s,e.created),f()},function(){n.onFailure({message:t.screenshotUpdateError})}):"delete"===e?f().then(function(){return a(i(s.get("richMessage"))).catch(function(){n.onFailure({message:t.screenshotDeletionError})})}):f()}}}}),define("DS/SocialToolbarWdg/Views/AnnotationToggleButton",["UWA/Class/View","DS/UIKIT/Input/Button","DS/UIKIT/Tooltip","i18n!DS/SocialToolbarWdg/assets/nls/main"],function(e,t,n,i){"use strict";var o=null,s={};function r(){return window.matchMedia("(max-width: 500px)").matches}function a(e){Object.assign(s,e);var t=o&&o.isVisible;o&&o.destroy(),(o=r()?new n(s):null)&&t&&o.show()}return window.addEventListener("resize",function(){s.target&&(r()?a(s):(o&&o.destroy(),o=null))}),e.extend({className:"st-btn-wrapper annotation-toggle-btn-wrapper",init:function(e){this._opts=e,this._button=new t({className:"default",icon:"pencil",value:i.annotations}),this._active=!1,a({body:i.enableAnnotations,target:this._button.elements.container,position:"bottom"}),this._parent.apply(this,arguments)},setup:function(){this._parent.apply(this,arguments),this._button.inject(this.container),this._setupEvents()},setEnabled:function(e){this._button.setDisabled(!e)},setActive:function(e){this._active=e,e?(this._button.setClassName("primary"),a({body:i.disableAnnotations}),this._opts.onActive()):(this._button.setClassName("default"),a({body:i.enableAnnotations}),this._opts.onInactive())},_setupEvents:function(){var e=this;e._button.addEvent("onClick",function(){e.setActive(!e._active)})}})}),define("DS/SocialToolbarWdg/Views/ScreenshotPreview",["UWA/Core","UWA/Class/View","DS/UIKIT/Tooltip","DS/UIKIT/Spinner","i18n!DS/SocialToolbarWdg/assets/nls/main"],function(e,t,n,i,o){"use strict";var s=top.require("DS/UWPClientCode/PublicAPI");return t.extend({className:"screenshot-preview",init:function(t){this._mediaId=t.mediaId,this._img=e.createElement("img",{attributes:{alt:o.screenshot}}),this._spinner=new i,this._error=e.createElement("span",{class:this.className+"-error",styles:{display:"none"},html:o.screenshotLoadingError}),this._close=e.createElement("span",{class:"fonticon fonticon-close"}),this._tooltip=new n({target:this._close,body:o.close}),this._initImg(),this._setupEvents(),this._parent.apply(this,arguments)},setup:function(){this._img.inject(this.container),this._error.inject(this.container),this._spinner.inject(this.container).show(),this._close.inject(this.container),this._parent.apply(this,arguments)},destroy:function(){this._tooltip.destroy(),this.container.remove(),this._parent.apply(this,arguments)},_initImg:function(){var e=this;e._img.style.opacity=0,s.getCommentMediaUrl({serviceUrl:top.dsBaseUrl,id:e._mediaId,subjectUri:widget.getValue("subjectUri"),type:"image",success:function(t){e._img.addEventListener("load",function(){e._img.style.opacity=1,e._spinner.hide()}),e._img.addEventListener("error",function(){e._error.show(),e._spinner.hide()}),e._img.src=t}})},_setupEvents:function(){var e=this;e._close.addEvent("click",function(){e.destroy()})}})}),define("DS/SocialToolbarWdg/Views/ScreenshotThumbnail",["UWA/Core","UWA/Class/View","i18n!DS/SocialToolbarWdg/assets/nls/main"],function(e,t,n){"use strict";var i=top.require("DS/UWPClientCode/PublicAPI");return t.extend({init:function(t){this._opts=Object.assign({},t),this._img=e.createElement("img",{attributes:{alt:n.screenshot},styles:{minWidth:120,minHeight:90}}),this._parent.apply(this,arguments)},setup:function(){this._initImg(),this._img.inject(this.container),this._parent.apply(this,arguments)},destroy:function(){this.container.remove(),this._parent.apply(this,arguments)},_initImg:function(){var e=this;e._img.style.opacity=0,e._getThumbnail().then(function(t){e._img.addEventListener("load",function(){e._img.style.opacity=1}),e._img.src=t})},_getThumbnail:function(){var e,t=new Image;return e=new Promise(function(e){t.addEventListener("load",function(){var n,i,o=document.createElement("canvas"),s=o.getContext("2d");o.width=120,o.height=90,n=o.width/o.height,i=t.naturalWidth/t.naturalHeight<n?{x:0,y:(t.naturalHeight-t.naturalWidth/n)/2,width:t.naturalWidth,height:t.naturalWidth/n}:{x:(t.naturalWidth-t.naturalHeight*n)/2,y:0,width:t.naturalHeight*n,height:t.naturalHeight},s.drawImage(t,i.x,i.y,i.width,i.height,0,0,o.width,o.height),e(o.toDataURL("image/png"))})}),this._getThumbnailSrc().then(function(e){t.src=e}),e},_getThumbnailSrc:function(){var e=this;return e._opts.dataUrl?Promise.resolve(e._opts.dataUrl):new Promise(function(t){i.getCommentMediaThumbnailUrl({serviceUrl:top.dsBaseUrl,id:e._opts.mediaId,subjectUri:widget.getValue("subjectUri"),type:"image",success:t})})}})}),define("DS/SocialToolbarWdg/Views/TakeScreenshotButton",["UWA/Class/View","i18n!DS/SocialToolbar/assets/nls/social-toolbar","i18n!DS/SocialToolbarWdg/assets/nls/main"],function(e,t,n){"use strict";var i=e.extend({});return i.init=function(e){t.AddMedia=n.takeScreenshot,document.addEventListener("click",function(t){var n=t.target.getParent&&t.target.getParent(".st-text-editor-container"),i=n&&n.getElement(".st-rte-media-attach-btn");i&&i.contains(t.target)&&(e.onClick({textEditor:n}),t.preventDefault(),t.stopPropagation())},!0)},i}),define("DS/SocialToolbarWdg/Views/ScreenshotEditionThumbnail",["UWA/Core","DS/SocialToolbarWdg/Views/ScreenshotThumbnail"],function(e,t){"use strict";return t.extend({className:"screenshot-edition-thumbnail",init:function(t){this._close=e.createElement("span",{class:"fonticon fonticon-close"}),this._richCommentImg=e.createElement("img",{attributes:{"data-source":"3DDashboard","data-media-type":"picture"}}),t.mediaId?this._richCommentImg.dataset.mediaId=t.mediaId:this._richCommentImg.dataset.data=t.dataUrl,this._observer=null,this._parent.apply(this,arguments),this._setupEvents()},setup:function(){this._parent.apply(this,arguments),this._richCommentImg.inject(this._opts.editor),this._close.inject(this.container)},destroy:function(){this._parent.apply(this,arguments),this._richCommentImg.remove(),this._observer.disconnect()},_setupEvents:function(){var e=this;e._close.addEvent("click",function(){e.destroy()}),e._observer=new MutationObserver(function(){e._opts.editor.contains(e._richCommentImg)||(e.container.isInjected()?e._richCommentImg.inject(e._opts.editor):e.destroy())}),e._observer.observe(e._opts.editor,{childList:!0,subtree:!0})}})}),define("DS/SocialToolbarWdg/CroppableScreenshotSession",["UWA/Core","DS/SocialToolbarWdg/CropModal"],function(e,t){"use strict";function n(e){this._session=null,this._options=Object.assign({},e)}return n.isSupported=function(){return n._loadSignableScreenshotSession().then(function(e){return e.isSupported()})},n._loadSignableScreenshotSession=function(){return new Promise(function(e,t){top.require(["DS/Screenshot/SignableScreenshotSession"],e,t)})},n._withOverlay=function(t,n){var i=e.createElement("div",{styles:{position:"absolute",top:0,left:0,zIndex:2e3,width:"100vw",height:"100vh",cursor:t,pointerEvents:"all"}}).inject(top.document.body);return n().finally(function(){i.remove()})},n._roundCrop=function(e){return{left:Math.round(e.left),top:Math.round(e.top),width:Math.round(e.width+(e.left-Math.round(e.left))),height:Math.round(e.height+(e.top-Math.round(e.top)))}},n.prototype.start=function(){var e=this;return n._withOverlay("not-allowed",function(){return n._loadSignableScreenshotSession().then(function(t){return e._session=new t(e._options),e._session.start()})})},n.prototype.take=function(e){var i,o,s=this._session,r=e.signOptions&&e.signOptions.container;return this._checkSessionStarted(),r&&s.sign(e.signOptions),n._withOverlay("wait",function(){return s.take({subjects:[e.target]}).then(function(t){if(i=t.reproduce(),r)return s.unsign(),t.certify().then(function(t){return t.reproduce().locate(e.target)}).then(function(e){o=e},function(e){console.error(e)})})}).then(function(){return new Promise(function(e,s){t.show({canvas:i.getCanvas(),initialCrop:o,onConfirm:function(t){t=n._roundCrop(t),e(i.crop(t).getCanvas().toDataURL())},onCancel:s})})})},n.prototype.stop=function(){return this._checkSessionStarted(),this._session.stop()},n.prototype._checkSessionStarted=function(){if(!this._session)throw new Error(this.constructor.name+" instance has yet to start")},n}),define("DS/SocialToolbarWdg/Views/ScreenshotReadonlyThumbnail",["UWA/Core","DS/SocialToolbarWdg/Views/ScreenshotThumbnail","DS/SocialToolbarWdg/Views/ScreenshotEditionThumbnail","DS/SocialToolbarWdg/Views/ScreenshotPreview"],function(e,t,n,i){"use strict";var o=t.extend({className:"screenshot-readonly-thumbnail",init:function(t){this._commentRoot=e.extendElement(t.commentRoot),this._observer=null,this._editionThumbnail=null,this._parent.apply(this,arguments),this._setupEvents()},destroy:function(){this._observer.disconnect(),this._parent.apply(this,arguments)},_setupEvents:function(){var e=this;e._img.addEvent("click",function(){new i({mediaId:e._opts.mediaId}).inject(document.body)}),e._observer=new MutationObserver(function(){e._commentRoot.classList.contains("st-edit")?e._editionThumbnail||(e._editionThumbnail=new n({mediaId:e._opts.mediaId,editor:e._commentRoot.getElement(".st-text-editor")}).inject(e._commentRoot.querySelector(".st-media-list-editor"))):(e._editionThumbnail&&e._editionThumbnail.destroy(),e._editionThumbnail=null)}),e._observer.observe(e._commentRoot,{attributes:!0,attributeFilter:["class"]})}});return o.init=function(){new MutationObserver(function(t){t.forEach(function(t){t.addedNodes.forEach(function(t){t.tagName&&[t].concat(Array.from(t.querySelectorAll("img"))).forEach(function(t){if("img"===t.tagName.toLowerCase()&&t.dataset.mediaId&&!t.dataset.loaded){var n=e.extendElement(t).getParent(".st-comment-main-section"),i=n&&n.getElement(".st-media-zone");i&&new o({mediaId:t.dataset.mediaId,commentRoot:i.getParent(".st-comment-root")}).inject(i),t.dataset.loaded="true"}})})})}).observe(document.body,{childList:!0,subtree:!0})},o}),define("DS/SocialToolbarWdg/ScreenshotManager",["DS/SocialToolbarWdg/CroppableScreenshotSession","DS/SocialToolbarWdg/ScreenshotMediaMiddleware","DS/SocialToolbarWdg/Views/AnnotationToggleButton","DS/SocialToolbarWdg/Views/TakeScreenshotButton","DS/SocialToolbarWdg/Views/ScreenshotReadonlyThumbnail","DS/SocialToolbarWdg/Views/ScreenshotEditionThumbnail","DS/UIKIT/Alert"],function(e,t,n,i,o,s,r){"use strict";var a,c,l,u,d,h,m,p=!1;function g(){return u=u||new Promise(function(e,t){top.require(["DS/W3DDComponents/Views/AnnotationView"],function(t){e(new t({annotated:l}))},t)})}function f(){if(!u)return Promise.resolve();var e=g().then(function(e){e.destroy()});return u=null,e}function b(){p=!0,g(),top.document.body.addClassName("ifw-clear-pointer-path")}function _(){p=!1,f(),top.document.body.removeClassName("ifw-clear-pointer-path")}function S(){return top.document.body.addClassName("ifw-clear-view"),h||(h=new e({onAbort:function(){h=null}}),m=h.start().catch(function(e){throw h=null,e})),m.then(function(){return h.take({target:d,signOptions:{container:d,position:{top:"0px",left:"0px"},zIndex:"1000"}})}).catch(function(e){e&&console.error(e)}).finally(function(){top.document.body.removeClassName("ifw-clear-view")})}return{init:function(){a=new r({closable:!0,visible:!0,autoHide:!0,maximumVisibleMessages:1,className:"screenshot-alert"}).inject(document.body,"top"),t.init({onFailure:function(e){a.add({className:"error",message:e.message})}}),o.init(),i.init({onClick:function(e){S().then(function(t){t&&new s({dataUrl:t,editor:e.textEditor.getElement(".st-text-editor")}).inject(e.textEditor.getElement(".st-media-list-editor"))})}})},augmentSocialToolbar:function(e){var t;(c=new n({onActive:b,onInactive:_})).setEnabled(!!l),(t=new MutationObserver(function(){var n=e.container.getElement(".st-action-toolbar-buttons");n&&!c.container.isInjected()&&(c.inject(n),t.disconnect())})).observe(e.container,{childList:!0,subtree:!0})},setTargets:function(t){d=t.screenshot&&top.document.querySelector(t.screenshot),l=t.annotation&&top.document.querySelector(t.annotation),document.body.toggleClassName("has-screenshot-target",!!d),t.enable?(e.isSupported().then(function(e){e&&document.body.addClassName("allow-screenshot")}),p&&(f(),d&&g()),c&&c.setEnabled(!!l)):(document.body.removeClassName("allow-screenshot"),h&&h.stop(),h=m=void 0,c?(c.setActive(!1),c.setEnabled(!1)):_())}}}),define("DS/SocialToolbarWdg/Main",["DS/SocialToolbarWdg/ScreenshotManager","DS/PlatformAPI/PlatformAPI","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/UIKIT/Spinner","DS/UIKIT/Alert","i18n!DS/SocialToolbarWdg/assets/nls/main","css!DS/SocialToolbarWdg/SocialToolbarWdg"],function(e,t,n,i,o,s){"use strict";var r={_serviceCache:null,widget:null,elements:{socialToolbar:null,spinner:new i,alert:new o({visible:!0})},init:function(e){this.widget=e.widget,this.widget.addEvents({onLoad:this.render.bind(this),onRefresh:this.render.bind(this)}),this._setupMessaging(),this._setupScreenshot()},render:function(){var t=this;return t.widget.body.setContent(),t.elements.spinner.inject(t.widget.body).show(),t._getSocialToolbar().then(function(n){t.elements.socialToolbar=n,t.widget.body.setContent(n),e.augmentSocialToolbar(n)},function(e){t.widget.body.setContent(),t.elements.alert.inject(t.widget.body).add({className:"error",message:s[e+"Error"]})})},_setupMessaging:function(){var t=this;t._messaging.subscribe("update",function(n){t.widget.setValues(n),"enableScreenshot"in n?e.setTargets({enable:n.enableScreenshot,screenshot:n.screenshotTarget,annotation:n.annotationTarget}):t.render()}),t.widget.addEvent("onRefresh",function(){t._messaging.publish("refresh",t.widget.data)})},_setupScreenshot:function(){var t=this.widget.getValue("enableScreenshot");e.init(),t&&e.setTargets({enable:!0,screenshot:this.widget.getValue("screenshotTarget"),annotation:this.widget.getValue("annotationTarget")})},_getSocialToolbar:function(){var e=this,n=t.getUser(),i=e.widget.getValue("x3dPlatformId"),o=e.widget.getValue("service"),s=e.widget.getValue("subjectUri");return i?o||e.widget.getValue("serviceUrl")?s?e._getServices().then(function(t){return new Promise(function(r,a){require(["DS/SocialToolbar/SocialToolbar"],function(a){r(new a(Object.assign({userLogin:n.login,userName:n.firstName+" "+n.lastName,tenantId:i,"3DSwymUrl":t[i]["3DSwym"],serviceUrl:t[i][o],subjectUri:s},function e(t){if(!t||"object"!=typeof t)return t;var n={};return Object.keys(t).forEach(function(i){var o=i.split("."),s=o[0],r=o.slice(1).join(".");1===o.length?n[s]=t[i]:(n[s]=n[s]||{},n[s][r]=e(t[i]))}),n}(e.widget.data))))},a)})}):Promise.reject("noSubject"):Promise.reject("noService"):Promise.reject("noTenant")},_getServices:function(){var e=this;return e._serviceCache?Promise.resolve(e._serviceCache):new Promise(function(t,i){n.getPlatformServices({onComplete:function(n){var i=n.reduce(function(e,t){return e[t.platformId]=t,e},{});e._serviceCache=i,t(i)},onFailure:i})})},_messaging:function(){var e="SocialToolbarWdg",n="sidepanel";function i(t,n){return e+":"+(n||r.widget.id)+":"+t}function o(e,n,i){t[e].apply(t,[n].concat(i))}function s(e,t,s){o(e,i(t),s),r.widget.getView().type===n&&o(e,i(t,n),s)}return{publish:s.bind(null,"publish"),subscribe:s.bind(null,"subscribe")}}()};return r});