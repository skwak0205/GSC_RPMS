/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoFitCmd",["DS/ApplicationFrame/CommandCheckHeader"],function(e){"use strict";return e.extend({init:function(e){this._parent(e,{}),this.setState(!0,!0)}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridEditCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(e,t){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),this.setRepeatMode(!1)},beginExecute:function(){t.get().setRobotVisibility(!1)},endExecute:function(){t.get().setRobotVisibility(!0)}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridBoxHandle",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Manipulators/LineTranslationManipulator","DS/CoreEvents/ModelEvents","DS/Mesh/MeshUtils","DS/Web3DUXUtils/Web3DUXArrow","DS/Ruler/Ruler","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/AxisSystemNode","DS/Manipulators/PointHandle","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager"],function(e,t,i,n,r,a,o,d,s,l,c,u,g){"use strict";return e.extend({init:function(e){var h,f,x,p,y,m,v=e||{},b=this,D=[],w=!0,A=9689341,C=6543615,V=v.window.getViewer(),P=v.stepRequired,T=new Array(6),M=new Array(6),S=!0,z=new i("BoxEditor_HandleBag");z.setVisibility(!1),z.exludeFromBounding(!0);var R=new i,N=new Array(6),G=null,E=new r,L=!1,I=!1,O=0,B=new i("BoxEditor_Axis");B.exludeFromBounding(!0),B.setPickable(a.PICKTHROUGH),B.setVisibility(!1);var F=new l({headLength:10,arrowLength:50,arrowWidth:2,head:l.types.ARROW,colors:{colorX:new a.Color(1,.5,0,0),colorY:new a.Color(1,.5,0,0),colorZ:new a.Color(1,.5,0,0)}});B.addChild(F);var k=new i,U=new i;U.setVisibilityFree(!0),U.setVisibilityInTree(!1);var X=new o({sceneGraph:U,width:60,viewer:V});X.setVisibility(!1),X.setPickable(a.PICKTHROUGH),U.addChild(k),U.addChild(X),U.addChild(z),U.addChild(R),U.addChild(B),V.addNode(U);var H,Y,_=u.getCurrentUnit("length"),W=new d(v.window,{displayOrigin:!0,startValue:0,offset:5,unit:_.unit,nbDecimals:_.decimalPlaceRO}),Z=0,q=0;this.display=function(e){H||(H=g.givePreferenceManager({context:v.window}))&&(Y=H.subscribe("onPreferencesChanged",function(){if(W){var e=u.getCurrentUnit("length");W.unit=e.unit,W.nbDecimals=e.decimalPlaceRO,W.display()}})),m=e.matrix,U.setMatrix(m),U.name="BoxGridEditor "+e.rootID;var t=$(e);h=t.selectedCorner,f=t.fstAxis,x=t.sndAxis,p=t.thdAxis,y=t.cornerPoint,S=e.displayHandlePoints,Q(),ee(e.gridDataPreference);for(var i=0;i<6;i++)re(i,A,C);z.setVisibility(!0),Z||(Z=W.subscribe("RulerManipulate",j),q=W.subscribe("RulerManipulateEnd",K)),V.render()},this.refresh=function(){me(),W.clear(),V.render()},this.setHandlePointsVisibility=function(e){S=e,me(),V.render()},this.setDataPreference=function(e){var t=$({gridDataPreference:e});y=t.cornerPoint,h=t.selectedCorner,D=[],f=t.fstAxis,x=t.sndAxis,p=t.thdAxis,ee(b.getDataPreference())},this.getDataPreference=function(){var e=(new t.Vector3).subVectors(y,h),i=0===Math.round(e.x)?f.x:e.x,n=0===Math.round(e.y)?x.y:e.y,r=0===Math.round(e.z)?p.z:e.z;return{origin:h,xAxis:i,yAxis:n,zAxis:r}},this.updateAutomaticCorner=function(){var e=(new t.Vector3).crossVectors(x,f),i=(new t.Vector3).crossVectors(f,p),n=(new t.Vector3).crossVectors(p,x),r=y.clone(),a=V.currentViewpoint.getSightDirection();a.dot(e)<0&&a.dot(i)>0&&a.dot(n)>0?r.add(p):a.dot(e)>0&&a.dot(i)<0&&a.dot(n)>0?r.add(x):a.dot(e)>0&&a.dot(i)>0&&a.dot(n)<0?r.add(f):a.dot(e)<0&&a.dot(i)<0&&a.dot(n)>0?(r.add(x),r.add(p)):a.dot(e)>0&&a.dot(i)<0&&a.dot(n)<0?(r.add(x),r.add(f)):a.dot(e)<0&&a.dot(i)>0&&a.dot(n)<0?(r.add(p),r.add(f)):a.dot(e)<0&&a.dot(i)<0&&a.dot(n)<0&&(r.add(f),r.add(x),r.add(p)),!r||h.x===r.x&&h.y===r.y&&h.z===r.z||ie({selectedCorner:r})},this.clean=function(){H&&(Y=H.unsubscribe(Y)),H=Y=null;for(var e=0;e<6;e++)N[e]&&N[e].unlink(M[e]),T[e]&&T[e].removeChildren();T.splice(0,T.length),M.splice(0,M.length),N.splice(0,N.length),R&&R.removeChildren(),B&&B.removeChildren(),k&&k.removeChildren(),z&&z.removeChildren(),U.removeChildren(),V.removeNode(U),X=null,k=null,R=null,B=null,Z&&(W.unsubscribe(Z),Z=0),q&&(W.unsubscribe(q),q=0),W.clear(),W=null,E=null,z=null,V.render()},this.getBag=function(){return R},this.isSizeOK=function(){return w},this.subscribe=function(e,t){return E.subscribe({event:e},t)},this.unsubscribe=function(e){E.unsubscribe(e)};var j=function(e){L=!0,ce(e.translationVector)},K=function(){ge()},J=function(e){var i=new c({viewer:V,sceneGraph:e.parent});i.name=e.name,i.setMatrix((new t.Matrix4).setPosition(e.position));var n=a.PICKABLE;return i.setPickable(n),i.setVisibility(!0),i.setSize(20),i.subscribe("EndManipulate",function(e){var i=e.paths[0].externalPath[2],n=(new t.Vector3).getPositionFromMatrix(i.getMatrix());h!==n?(ie({selectedCorner:n}),ye("BoxCornerChanged",{cornerChanged:!0})):ye("BoxCornerChanged",{cornerChanged:!1})}),i},Q=function(){for(var e,i=function(e){var i=new t.Vector3;return i.x=e.x.toFixed(4),i.y=e.y.toFixed(4),i.z=e.z.toFixed(4),i},n=new t.Matrix4,r=new t.Color("#FFFFFF"),a=new t.Color("#FF8000"),o=["mO","mOX","mOY","mOZ","mOXY","mOYZ","mOXZ","mOXYZ"],d=[y.clone(),y.clone().add(f),y.clone().add(x),y.clone().add(p),y.clone().add(f).add(x),y.clone().add(x).add(p),y.clone().add(f).add(p),y.clone().add(f).add(x).add(p)],s=0;s<o.length;s++){(e=z.getChildByName(o[s]))?e.setMatrix(n.setPosition(d[s])):(n=n.setPosition(d[s]),e=J({name:o[s],position:d[s],parent:z}));var l=i(d[s]).equals(i(h));e.setFillColor(l?a:r),e.setVisibility(S||l)}},$=function(e){var i=(new t.Vector3).copy(e.gridDataPreference.origin),n=(new t.Vector3).copy(e.gridDataPreference.origin),r=new t.Vector3(e.gridDataPreference.xAxis,0,0),a=new t.Vector3(0,e.gridDataPreference.yAxis,0),o=new t.Vector3(0,0,e.gridDataPreference.zAxis);return i.x+e.gridDataPreference.xAxis<i.x&&(n.x=i.x+r.x,r.x*=-1),i.y+e.gridDataPreference.yAxis<i.y&&(n.y=i.y+a.y,a.y*=-1),i.z+e.gridDataPreference.zAxis<i.z&&(n.z=i.z+o.z,o.z*=-1),{selectedCorner:i,cornerPoint:n,fstAxis:r,sndAxis:a,thdAxis:o}},ee=function(e){var i=function(e){return 0===(e=Number(e))||isNaN(e)?e:e>0?1:-1};B.setMatrix((new t.Matrix4).setPosition(e.origin)),B.setVisibility(!0);var n=(new t.Matrix4).rotateX(3*i(e.yAxis)*Math.PI/2);B.children[0].children[0].setMatrix(n);var r=(new t.Matrix4).rotateY(i(e.xAxis)*Math.PI/2);B.children[0].children[1].setMatrix(r);var a=new t.Matrix4;e.zAxis<0&&a.rotateX(Math.PI),B.children[0].children[2].setMatrix(a)},te=function(e,i){var n=(new t.Vector3).copy(e),r=(new t.Vector3).copy(i),a=n.cross(r).length();return 0===Math.round(100*a)},ie=function(e){D=[],h=e.selectedCorner,me(),ee(b.getDataPreference())},ne=function(){var e=function(e,t){var i=e%t;return i>0?e-i:i<0?e-(t+i):e};w=!0,A=9689341,C=6543615;var i=(new t.Vector3).copy(y);if(i.x%P!=0&&i.x%P!=0&&i.x%P!=0){var n=(new t.Vector3).copy(i).add(f).add(x).add(p),r=e(n.x,P),a=e(n.y,P),o=e(n.z,P);r<i.x&&a<i.y&&o<i.z&&(w=!1,A=16711765,C=14876748)}},re=function(e,n,r){T[e]&&T[e].removeChildren();var a=null,o=null,d=null,l=null;switch(e){case 0:a=y,o=x,d=f,3!==D.length&&(l=(new t.Vector3).subVectors(h,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(l))&&D.push(e));break;case 1:a=y,o=p,d=x,3!==D.length&&(l=(new t.Vector3).subVectors(h,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(l))&&D.push(e));break;case 2:a=y,o=f,d=p,3!==D.length&&(l=(new t.Vector3).subVectors(h,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(l))&&D.push(e));break;case 3:a=(new t.Vector3).copy(y).add(f),o=x,d=p,3!==D.length&&(l=(new t.Vector3).subVectors(h,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(l))&&D.push(e));break;case 4:a=(new t.Vector3).copy(y).add(x),o=p,d=f,3!==D.length&&(l=(new t.Vector3).subVectors(h,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(l))&&D.push(e));break;case 5:a=(new t.Vector3).copy(y).add(p),o=f,d=x,3!==D.length&&(l=(new t.Vector3).subVectors(h,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(l))&&D.push(e))}var c=ae(a,o,d,n,r,e),u=s.createMeshNode(c);u.excludeFromCSO(!0),u.excludeFromHighlight(!0),u.setSSAO(!1),u.setShadow(!1,!1),T[e]||(T[e]=new i("Face"+e),R.add(T[e])),T[e].add(u),N[e]&&N[e].unlink(M[e]),N[e]=oe(e,(new t.Vector3).copy(o).cross(d).normalize()),M[e]=N[e].linkToNode(T[e]),oe(-1,new t.Vector3)},ae=function(e,i,n,r,o){var d,s,l,c,u,g,h,f,x,p,y;(d=new a.PrimitiveGroup).fillAttr=new a.FillAttributes,d.lineAttr=new a.LineAttributes,d.pointAttr=new a.PointAttributes,(s=new a.Buffer).size=12,s.component=a.VertexComponentEnum.POSITION,s.format=a.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(12),(c=new a.Buffer).indexBuffer=!0,c.size=9,c.format=a.DataTypeEnum.UINT,c.dimension=1,c.data=new Uint16Array(9),(l=new a.Buffer).size=3,l.component=a.VertexComponentEnum.NORMAL,l.format=a.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(3),(u=new a.Buffer).indexBuffer=!0,u.size=4,u.format=a.DataTypeEnum.UINT,u.dimension=1,u.data=new Uint16Array(4),d.addBuffer(0,s),d.addBuffer(1,c),d.addBuffer(2,l),d.addBuffer(3,u),h=0,(g=s.data)[h++]=e.x,g[h++]=e.y,g[h++]=e.z,y=(new t.Vector3).copy(e).add(i),g[h++]=y.x,g[h++]=y.y,g[h++]=y.z,y=(new t.Vector3).copy(e).add(i).add(n),g[h++]=y.x,g[h++]=y.y,g[h++]=y.z,y=(new t.Vector3).copy(e).add(n),g[h++]=y.x,g[h++]=y.y,g[h++]=y.z,(g=c.data)[0]=0,g[1]=1,g[2]=3,g[3]=2,(g=l.data)[0]=0,g[1]=0,g[2]=1,(g=u.data)[0]=0,g[1]=0,g[2]=0,g[3]=0,(f=new a.Primitive).nbIndices=4,f.connectivity=a.ConnectivityTypeEnum.TRIANGLE_STRIP,f.material=new t.MeshBasicMaterial({side:t.DoubleSide,color:r,opacity:.5,transparent:!0}),(x=new a.VertexComponent).component=a.VertexComponentEnum.POSITION,x.nbVertices=4,x.nbValuesPerVertex=3,x.format=a.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=0,x.indices=new a.IndexArray,x.indices.format=a.DataTypeEnum.UINT,x.indices.bufferId=1,x.indices.offset=0,f.addVertexComponent(x),(p=new a.VertexComponent).component=a.VertexComponentEnum.NORMAL,p.nbVertices=4,p.nbValuesPerVertex=3,p.format=a.DataTypeEnum.FLOAT,p.cardinality=0,p.bufferId=2,p.indices=new a.IndexArray,p.indices.format=a.DataTypeEnum.UINT,p.indices.bufferId=3,p.indices.offset=0,f.addVertexComponent(p),d.addPrimitive(f),h=4,(g=c.data)[h++]=0,g[h++]=1,g[h++]=2,g[h++]=3,g[h++]=0;var m=new a.Primitive;return m.nbIndices=4,m.connectivity=a.ConnectivityTypeEnum.LINE_STRIP,m.attr={fill:new a.FillAttributes,line:new a.LineAttributes(new a.Color(o)),point:new a.PointAttributes},(x=new a.VertexComponent).component=a.VertexComponentEnum.POSITION,x.nbVertices=5,x.nbValuesPerVertex=3,x.format=a.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=0,x.indices=new a.IndexArray,x.indices.format=a.DataTypeEnum.UINT,x.indices.bufferId=1,x.indices.offset=4,m.addVertexComponent(x),d.addPrimitive(m),d.noz=!1,d},oe=function(e,i){var r=new n({axis:(new t.Vector3).copy(i)});return r.setExclusive(!0),e>=0&&(r.subscribe("BeginManipulate",function(){le(e)}),r.subscribe("Manipulate",function(e){ue(e)}),r.subscribe("EndManipulate",function(e){he(e)}),r.subscribe("BeginPreactivate",function(t){fe(e,t)}),r.subscribe("EndPreactivate",function(){xe()})),r},de=function(e){var i=null,n=null;switch(e){case 0:i=(new t.Vector3).copy(x),n=(new t.Vector3).copy(f);break;case 1:i=(new t.Vector3).copy(p),n=(new t.Vector3).copy(x);break;case 2:i=(new t.Vector3).copy(f),n=(new t.Vector3).copy(p);break;case 3:i=(new t.Vector3).copy(x),n=(new t.Vector3).copy(p);break;case 4:i=(new t.Vector3).copy(p),n=(new t.Vector3).copy(f);break;case 5:i=(new t.Vector3).copy(f),n=(new t.Vector3).copy(x)}return(new t.Vector3).copy(n).cross(i).normalize()},se=function(e,i){var n=null,r=null,a=null;switch(e){case 0:n=(new t.Vector3).copy(y),r=(new t.Vector3).copy(x),a=(new t.Vector3).copy(f);break;case 1:n=(new t.Vector3).copy(y),r=(new t.Vector3).copy(p),a=(new t.Vector3).copy(x);break;case 2:n=(new t.Vector3).copy(y),r=(new t.Vector3).copy(f),a=(new t.Vector3).copy(p);break;case 3:n=(new t.Vector3).copy(y).add(f),r=(new t.Vector3).copy(x),a=(new t.Vector3).copy(p);break;case 4:n=(new t.Vector3).copy(y).add(x),r=(new t.Vector3).copy(p),a=(new t.Vector3).copy(f);break;case 5:n=(new t.Vector3).copy(y).add(p),r=(new t.Vector3).copy(f),a=(new t.Vector3).copy(x)}var o=r.length();a.length()>o&&(o=a.length());var d=(new t.Vector3).copy(r).setLength(r.length()/2),s=(new t.Vector3).copy(a).setLength(a.length()/2);n.add(d).add(s);var l=(new t.Vector3).copy(a).cross(r).normalize(),c=new t.Matrix4;r.normalize(),a.normalize();var u=c.elements;i&&l.applyAxisAngle(r,Math.PI),u[0]=r.x,u[1]=r.y,u[2]=r.z,u[4]=a.x,u[5]=a.y,u[6]=a.z,u[8]=l.x,u[9]=l.y,u[10]=l.z,c.setPosition(n),X.setMatrix(c),I=i},le=function(e){O=e,G=new t.Vector3(0,0,0),se(O),X.setVisibility(!0),k.removeChildren(),L=!0,W.clear();var i=de(O),n=null;te(i,f)?n=f:te(i,x)?n=x:te(i,p)&&(n=p);var r=null,a=null;switch(O){case 0:r=(new t.Vector3).copy(y),a=f;break;case 1:r=(new t.Vector3).copy(y),a=x;break;case 2:r=(new t.Vector3).copy(y).sub(p),a=p;break;case 3:r=(new t.Vector3).copy(y).add(f).sub(p),a=p;break;case 4:r=(new t.Vector3).copy(y).add(x),a=f;break;case 5:r=(new t.Vector3).copy(y).add(p),a=x}var o=(new t.Vector3).copy(i).setLength(n.length()).add((new t.Vector3).copy(a).setLength(a.length()));W.origin=(new t.Vector3).copy(r).add(o).add((new t.Vector3).getPositionFromMatrix(m)),W.initValue=n.length(),W.value=W.initValue,W.direction=i.multiplyScalar(-1),W.setVisibleFlag(!0),W.display(),W.beginManipulation(),V.render()},ce=function(e){var i;G.add(e),0===O?(i=(new t.Vector3).copy(p).sub(e),p.copy(i)):1===O?(i=(new t.Vector3).copy(f).sub(e),f.copy(i)):2===O?(i=(new t.Vector3).copy(x).sub(e),x.copy(i)):3===O?(i=(new t.Vector3).copy(f).add(e),f.copy(i)):4===O?(i=(new t.Vector3).copy(x).add(e),x.copy(i)):5===O&&(i=(new t.Vector3).copy(p).add(e),p.copy(i)),0!==O&&1!==O&&2!==O||y.add(e),D.indexOf(O)>-1&&h.add(e);var n=T[O].children[0],r=n.getMatrix();r.setPosition((new t.Vector3).getPositionFromMatrix(r).add(e)),n.setMatrix(r),pe(O);var a=e.dot(de(O));a>0&&!I?se(O,!0):a<0&&I&&se(O,!1);var o=(new t.Vector3).getPositionFromMatrix(X.getMatrix()).add(e);X.setMatrix((new t.Matrix4).copy(X.getMatrix()).setPosition(o)),z.setVisibility(!1),B.setVisibility(!1)},ue=function(e){var i=W.getSnappedTranslationVector(e);if(0!==i.returnCode)return null;var n=(new t.Vector3).copy(i.snappedTranslationVector).sub(G),r=W.value+n.length()*(n.dot(de(O))<0?1:-1);r<=0&&(r=0,n.setLength(W.value)),W.setValue(r),ce(n)},ge=function(){X&&X.setVisibility(!1),L=!1,Q(),z.setVisibility(!0),ee(b.getDataPreference()),ye("EndBoxChanged")},he=function(){ge(),W.endManipulation(),W.display()},fe=function(e){if(L)return!0;var i=null,n=null,r=null;switch(e){case 0:i=y,n=x,r=f;break;case 1:i=y,n=p,r=x;break;case 2:i=y,n=f,r=p;break;case 3:i=(new t.Vector3).copy(y).add(f),n=x,r=p;break;case 4:i=(new t.Vector3).copy(y).add(x),n=p,r=f;break;case 5:i=(new t.Vector3).copy(y).add(p),n=f,r=x}var a=(new t.Vector3).copy(n);a.cross(r),a.normalize(),a.setLength(.05);var o=(new t.Vector3).copy(i).sub(a),d=ae(o,n,r,9689341,6543615,e),l=s.createMeshNode(d);l.excludeFromCSO(!0),l.excludeFromHighlight(!0),l.setSSAO(!1),l.setShadow(!1,!1),k.removeChildren(),k.add(l),se(e),X.setVisibility(!0),V.render()},xe=function(){L||(X.setVisibility(!1),k.removeChildren(),V.render())},pe=function(e){ne();for(var t=0;t<6;t++)t!==e&&re(t,A,C)},ye=function(e){return E.publish({event:e,context:this,data:b.getDataPreference()})},me=function(){var e;for(k.removeChildren(),L=!1,e=0;e<6;e++)N[e]&&N[e].unlink(M[e]),N[e]=null,T[e]&&T[e].removeChildren(),T[e]=null;for(R&&(R.removeChildren(),U.remove(R)),T=new Array(6),R=new i,U.addChild(R),N=new Array(6),Q(),ne(),e=0;e<6;e++)re(e,A,C);V.render()}}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoOriginCmd",["DS/ApplicationFrame/CommandCheckHeader"],function(e){"use strict";return e.extend({init:function(e){this._parent(e,{}),this.setState(!0,!0)}})}),define("DS/CATRelatedData3DGrid/CATRelatedData3DGrid",[],function(){}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridView",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/CanvasNodeTexture","DS/Mesh/MeshUtils","DS/Core/Events","DS/VisuEvents/EventsManager","DS/ApplicationFrame/CommandsManager","DS/Manipulators/HandlePointManipulator","DS/CATRelatedData3DGrid/CATRelatedData3DGridEditCmd","DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoFitCmd","DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoOriginCmd","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/PathElement","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,n,r,a,o,d,s,l,c,u,g,h,f,x,p,y,m){"use strict";return t.extend({init:function(t){if(t){var v=t.viewer,b=t.window,D=t.context,w=!1,A=null,C=null,V=this,P=[],T=JSON.parse(localStorage.getItem("CATRelatedData3DGridDftOrigin"));T||(T={x:"min",y:"min",z:"min"});var M={xStep:t.stepRequiredX,yStep:t.stepRequiredY,zStep:t.stepRequiredZ},S=new i.Matrix4;t.gridMatrix&&(S=t.gridMatrix.clone());var z=t.id,R=void 0===t.isEditable||t.isEditable,N=void 0===t.isLabelManipulable||t.isLabelManipulable,G=t.owner,E=void 0!==t.isAbsoluteMode&&t.isAbsoluteMode,L=t.nbMaxLabel,I={x:"L",y:"W",z:"H"},O=2*Math.round(10*window.devicePixelRatio/2),B=window.widget,F=null;B&&(F=B.getValue("3DGridData")),F?F=JSON.parse(F):(B&&B.addPreference({name:"3DGridData",type:"hidden"}),F={gridList:[]});var k,U,X,H=null,Y=!1,_=new i.Vector3,W=null,Z=null,q=null,j=null,K=null,J=!1,Q=null,$=null,ee=b.getContextualUIManager(),te=null,ie={},ne={},re={},ae=null,oe=null,de=null,se=null,le=null,ce=null,ue=null,ge=null,he=null,fe=null,xe=[],pe=[],ye=!1,me=[],ve=[],be=null,De=0,we=!1,Ae={width:t.freeZoneDim?t.freeZoneDim.width:0,height:t.freeZoneDim?t.freeZoneDim.height:0,left:t.freeZoneDim?t.freeZoneDim.left:0,right:t.freeZoneDim?t.freeZoneDim.width-t.freeZoneDim.right:0,top:t.freeZoneDim?t.freeZoneDim.top:0,bottom:t.freeZoneDim?t.freeZoneDim.height-t.freeZoneDim.bottom:0},Ce="mm",Ve=function(e,t){var i=e%t;return i>0?e-i:i<0?e-(t+i):e},Pe=function(e,t){var i=e%t;return i>0?e+(t-i):i<0?e-i:e},Te=function(e){return 0===(e=parseFloat(e))||isNaN(e)?e:e>0?1:-1},Me=function(e){return e.x<0||e.y<0||e.z<0?-1:1},Se=function(){be&&(v.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(be),be=null)},ze=function(e){e&&(be&&Se(),be=new p(e.externalPath[0]),v.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(be))},Re=function(e,t){be&&e&&t&&("color"===t.type?be.createOverride(e).setColor(t.value):"pickability"===t.type&&be.createOverride(e).setPickability(t.value))},Ne=function(e,t,i){var n=e.getContext("2d");n.font=O+"pt sans-serif",n.fillStyle=i,n.fillText(t,0,e.height);for(var r=A.childNodes.length-1;r>=0;r--)A.childNodes[r].label.name===t&&((n=A.childNodes[r].getContext("2d")).font=O+"pt sans-serif",n.fillStyle=i,n.fillText(t,0,A.childNodes[r].height))},Ge=function(e){for(var t=new y,i=[],n=e;n&&!n.notAllowedInPathElement;)i.splice(0,0,n),n=n.parents[0];return t.setFromArray(i),t},Ee=function(e){var t,i;if(e.preactivated&&(i=e.preactivated.path.externalPath.length),j=e.preactivated?e.preactivated.path.externalPath[i-2]:e.currentTarget.label,K=e.currentTarget,j){var n=j.canvasNodeTexture;n.isHighlighted=!0,n.requestRedraw(),K&&Ne(K,j.name,"#FF8000");var r=e.preactivated?e.preactivated.path:null;if(r)for(;r&&-1===r.getLastElement(!0).name.indexOf("3D Grid");)r=r.getParentPath();else if(G)for(t=0;t<P.length;t++)P[t].grid.name===e.currentTarget.label.gridID&&(r=Ge(G)).addElement(P[t].grid);else for(t=0;t<P.length;t++)P[t].grid.name===e.currentTarget.label.gridID&&(r=new y).addElement(P[t].grid);ze(r);var a=r.getChildrenPathes();for(t=0;t<a.length;t++)for(var o=a[t].getChildrenPathes()[0].getChildrenPathes(),d=0;d<o.length;d++)o[d].getLastElement(!0).relatedLabel&&n.labelValue&&o[d].getLastElement(!0).relatedLabel.prefix===n.labelValue.prefix&&o[d].getLastElement(!0).relatedLabel.value===n.labelValue.value&&(Re(o[d],{type:"color",value:"#FF8000"}),Y||o[d].getLastElement(!0).setNoZ(!0),me.push(o[d].getLastElement(!0)));v.render()}},Le=function(){if(j){var e=j.canvasNodeTexture;if(e.isHighlighted=!1,e.requestRedraw(),K&&Ne(K,j.name,$),j=null,Se(),!Y)for(var t=0;t<me.length;t++)me[t].setNoZ(!1);me.splice(0,me.length),v.render()}},Ie=function(e){if(De<2&&De++,2===De&&!k&&(De=4,v.currentViewpoint.getControl()._changeState(3),(k={}).eyePosition=v.currentViewpoint.getEyePosition(),k.upDirection=v.currentViewpoint.getUpDirection(),k.sightDirection=v.currentViewpoint.getSightDirection(),k.distanceToTarget=v.currentViewpoint.getTargetDistance(),Ee(X?{currentTarget:X}:{preactivated:{path:e.paths[0]}}),2===me.length)){var t=(new i.Vector3).copy(me[0].explicitBBox.min),n=(new i.Vector3).copy(me[0].explicitBBox.max);t.applyMatrix4(me[0].getMatrix()),n.applyMatrix4(me[0].getMatrix());var a,d=(new i.Vector3).copy(me[1].explicitBBox.min),s=(new i.Vector3).copy(me[1].explicitBBox.max);if(d.applyMatrix4(me[1].getMatrix()),s.applyMatrix4(me[1].getMatrix()),X){for(var l=0;l<P.length;l++)if(P[l].grid.name===X.label.gridID){a=P[l].grid.getMatrix();break}}else a=e.paths[0].externalPath[0].getMatrix();t.applyMatrix4(a),n.applyMatrix4(a),d.applyMatrix4(a),s.applyMatrix4(a);var c=t,u=new i.Vector3,g=new i.Vector3;c.x===d.x&&c.y===d.y&&c.z===d.z||c.x===s.x&&c.y===s.y&&c.z===s.z?u=(new i.Vector3).subVectors(n,t):(c=n,u=(new i.Vector3).subVectors(t,c)),c.x===d.x&&c.y===d.y&&c.z===d.z?g.subVectors(s,c):g.subVectors(d,c),U&&(v.removeNode(U),U=null),(U=function(e,t,n,a,d){var s=new o.PrimitiveGroup;s.noz=!1,s.fillAttr=new o.FillAttributes,s.lineAttr=new o.LineAttributes,s.pointAttr=new o.PointAttributes;var l=new o.Buffer;l.size=12,l.component=o.VertexComponentEnum.POSITION,l.format=o.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(12);var c=new o.Buffer;c.indexBuffer=!0,c.size=4,c.format=o.DataTypeEnum.UINT,c.dimension=1,c.data=new Uint16Array(4),c.data[0]=0,c.data[1]=1,c.data[2]=3,c.data[3]=2;var u=new o.Buffer;u.size=3,u.component=o.VertexComponentEnum.NORMAL,u.format=o.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(3),u.data[0]=0,u.data[1]=0,u.data[2]=1;var g=new o.Buffer;g.indexBuffer=!0,g.size=4,g.format=o.DataTypeEnum.UINT,g.dimension=1,g.data=new Uint16Array(4),g.data[0]=0,g.data[1]=0,g.data[2]=0,g.data[3]=0,s.addBuffer(0,l),s.addBuffer(1,c),s.addBuffer(2,u),s.addBuffer(3,g);var h=l.data,f=0;h[f++]=e.x,h[f++]=e.y,h[f++]=e.z;var x=(new i.Vector3).copy(e).add(t);h[f++]=x.x,h[f++]=x.y,h[f++]=x.z,x=(new i.Vector3).copy(e).add(t).add(n),h[f++]=x.x,h[f++]=x.y,h[f++]=x.z,x=(new i.Vector3).copy(e).add(n),h[f++]=x.x,h[f++]=x.y,h[f++]=x.z;var p=new o.Primitive;p.nbIndices=4,p.connectivity=o.ConnectivityTypeEnum.TRIANGLE_STRIP;var y=new i.MeshBasicMaterial({side:i.DoubleSide,color:a,opacity:d,transparent:!0});p.material=y;var m=new o.VertexComponent;m.component=o.VertexComponentEnum.POSITION,m.nbVertices=4,m.nbValuesPerVertex=3,m.format=o.DataTypeEnum.FLOAT,m.cardinality=0,m.bufferId=0,m.indices=new o.IndexArray,m.indices.format=o.DataTypeEnum.UINT,m.indices.bufferId=1,m.indices.offset=0;var v=new o.VertexComponent;v.component=o.VertexComponentEnum.NORMAL,v.nbVertices=4,v.nbValuesPerVertex=3,v.format=o.DataTypeEnum.FLOAT,v.cardinality=0,v.bufferId=2,v.indices=new o.IndexArray,v.indices.format=o.DataTypeEnum.UINT,v.indices.bufferId=3,v.indices.offset=0,p.addVertexComponent(m),p.addVertexComponent(v),s.addPrimitive(p);var b=r.createMeshNode(s);return b.setSSAO(!1),b.setShadow(!1,!1),b.excludeFromCSO(!0),b.excludeFromHighlight(!0,!0),b.setMatrix(S),b}(c,u,g,16744448,.5)).name="Box_PreviewPlane",v.addNode(U)}},Oe=function(e){we=!0,setTimeout(function(){we&&(De=2,Ie(e))},100)},Be=function(){we=!1,X&&(X=null),k&&(v.currentViewpoint.getControl()._changeState(-1),v.currentViewpoint.moveTo({eyePosition:k.eyePosition,upDirection:k.upDirection,sightDirection:k.sightDirection,distanceToTarget:k.distanceToTarget,duration:100}),k=null),U&&(v.removeNode(U),U=null,Le()),De=0},Fe=function(e){De=0,we=!1,"touch"===(e.type?e.type:e.event.from[0].type).indexOf!==-1&&(se&&(clearTimeout(se),Le(),se=null),se=setTimeout(function(){Le(),se=null},1e3),Ee(X?{currentTarget:X}:{preactivated:{path:e.intersection.path[0]}}));for(var t=X?X.label.gridID:e.intersection?e.intersection.path[0].externalPath[0].name:e.gesture.currentEvent[0].view.label.gridID,i=0;i<P.length;i++)if(P[i].grid.name===t){W=P[i];break}le&&le.setState("userDefined"!==W.type),ae&&(ae=l.getCommand("CATRelatedData3DGridEditHdr",D.getCommandContext()));var n=[{name:"CATRelatedData3DGridEdit",line:1,hdr_list:["CATRelatedData3DGridEditHdr"]},{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"]}];ee.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:n}},context:D.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]}),X&&(X=null)},ke=function(e){var t;e.stopPropagation(),e.preventDefault(),-1!==e.type.indexOf("touch")?("function"==typeof window.UIEvent?t=new window.UIEvent(e.type):(t=document.createEvent("UIEvent")).initUIEvent(e.type,!0,!0,window,1),t.touches=e.touches,t.changedTouches=e.changedTouches):"function"==typeof window.MouseEvent?t=new MouseEvent(e.type,{bubbles:!0,cancelable:!0,view:window,clientX:e.clientX,clientY:e.clientY,screenX:e.clientX,screenY:e.clientY,button:0}):(t=document.createEvent("MouseEvent")).initMouseEvent(e.type,!0,!0,window,1,0,0,e.clientX,e.clientY,!1,!1,!1,!1,0,null),t._simul=!0===s._ODTMode||void 0,v.canvas.dispatchEvent(t)},Ue=function(e){we=!0,X=e.currentTarget,De=0,setTimeout(function(){we&&X&&(De=2,"Touch"===e.type&&ke(e),Ie())},100)},Xe=function(e){e.stopPropagation(),e.preventDefault(),X&&ke(e)},He=function(e){X&&!De?Fe(e):Be()},Ye=function(e,t){var n;e.setVisibility(!0);var r,a,o,d=(new i.Matrix4).multiplyMatrices(t,e.getMatrix()),s=(new i.Vector3).getPositionFromMatrix(d),l=v.currentViewpoint.project(s),c=l.clone(),u=Ae.width-Ae.right,g=Ae.height-Ae.bottom,h=Ae.left,f=Ae.top,x=wt(e);function p(e){e.x-=x.x,e.y+=x.y;var t=Ae.left+(u-Ae.left)/2,i=Ae.top+(g-Ae.top)/2;e.x<=t/2&&e.y<=i/2?e.y-=x.height:e.x>t/2&&e.y>i/2?e.x+=x.width:e.x>t/2&&e.y<=i/2&&(e.x+=x.width,e.y-=x.height)}if(p(c),c.x<h||c.y<f||c.x>u||c.y>g||Math.abs(c.z)>1){e.setVisibility(!1);var y,m,b=new i.Vector2(-1,-1),D=(new i.Vector3).copy(e.boundaries[0]).applyMatrix4(t),w=(new i.Vector3).copy(e.boundaries[1]).applyMatrix4(t);if(y=D.x===s.x&&D.y===s.y&&D.z===s.z?l:v.currentViewpoint.project(D),m=w.x===s.x&&w.y===s.y&&w.z===s.z?l:v.currentViewpoint.project(w),Math.abs(y.z)>1&&Math.abs(m.z)>1)return n;if(Math.abs(y.z)>1||Math.abs(m.z)>1){var C=new i.Line3(D,w),V=v.currentViewpoint.getSightDirection().setLength(v.currentViewpoint.camera.near),P=v.currentViewpoint.getEyePosition().add(V),T=(new i.Plane).setFromNormalAndCoplanarPoint(v.currentViewpoint.getSightDirection(),P).intersectLine(C);if(!T)return n;Math.abs(y.z)>1?(y=v.currentViewpoint.project(T),D.x===s.x&&D.y===s.y&&D.z===s.z&&p(c=y.clone())):(m=v.currentViewpoint.project(T),w.x===s.x&&w.y===s.y&&w.z===s.z&&p(c=m.clone()))}if(y.x<h&&m.x<h||y.x>u&&m.x>u||y.y<f&&m.y<f||y.y>g&&m.y>g)return n;var M=m.x-y.x!=0?(m.y-y.y)/(m.x-y.x):"infinity";M="infinity"!==M?Math.round(100*M)/100:"infinity",Math.abs(M)>1e7&&(M="infinity");var S=Math.round("infinity"!==M?y.y-y.x*M:y.y);if(c.y<=f){if(0===M)return n;if(c.x>h&&c.x<u)b.x="infinity"!==M?-1*S/M:y.x,b.y=f;else if(c.x<=h){if("infinity"===M)return n;M*h+S>f&&M*h+S<g?(b.x=h,b.y=M*h+S):(b.x=-1*S/M,b.y=f)}else{if("infinity"===M)return n;M*u+S>f&&M*u+S<g?(b.x=u,b.y=M*u+S):(b.x=-1*S/M,b.y=f)}}else if(c.y>=g){if(0===M)return n;if(c.x>h&&c.x<u)b.x="infinity"!==M?(g-S)/M:y.x,b.y=g;else if(c.x<=h){if("infinity"===M)return n;M*h+S>f&&M*h+S<g?(b.x=h,b.y=M*h+S):(b.x=(g-S)/M,b.y=g)}else{if("infinity"===M)return n;M*u+S>f&&M*u+S<g?(b.x=u,b.y=M*u+S):(b.x=(g-S)/M,b.y=g)}}else if(c.x<=h){if("infinity"===M)return n;c.y>f&&c.y<g&&(b.x=h,b.y=0!==M?M*h+S:y.y)}else if(c.x>=u){if("infinity"===M)return n;c.y>f&&c.y<g&&(b.x=u,b.y=0!==M?M*u+S:y.y)}if(b.x>=h&&b.y>=f&&b.x<=u&&b.y<=g&&b.x>=Math.min(y.x,m.x)-x.width&&b.y>=Math.min(y.y,m.y)-x.height&&b.x<=Math.max(y.x,m.x)+x.width&&b.y<=Math.max(y.y,m.y)+x.height){b.x=Math.floor(b.x),b.y=Math.floor(b.y);for(var z=0;z<pe.length;z++)if(pe[z].label.name===e.name&&null===pe[z].isUsed&&pe[z].label.gridID===e.gridID){n=pe[z];break}n||(r=e.canvasNodeTexture._canvas2DCanvas,a=document.createElement("canvas"),o=a.getContext("2d"),a.width=r.width,a.height=r.height,o.drawImage(r,0,0),(n=a).style.transform="scale("+1/window.devicePixelRatio+")",n.className="Grid3D_AnchoredLabel",n.style.position="absolute",n.ondrag=function(){},n.label=e,N&&(n.addEventListener("mouseenter",Ee),n.addEventListener("mouseleave",Le),n.addEventListener("mousedown",Ue),n.addEventListener("mousemove",Xe),n.addEventListener("mouseup",He),n.addEventListener("touchstart",Ue),n.addEventListener("touchmove",Xe),n.addEventListener("touchend",He)),pe.push(n)),n.isUsed=!0,n.style.visibility="";var R=0,G=0;b.x===h&&(R=-5,G=n.height/2),b.y===f&&(R=n.width/2,G=-5),b.x===u&&(R=n.width+5,G=n.height/2),b.y===g&&(R=n.width/2,G=n.height+5),R=Math.floor(R),G=Math.floor(G),n.position2D={x:b.x,y:b.y},n.offset2D={x:R,y:G},n.style.top=b.y-G+"px",n.style.left=b.x-R+"px",n.parentNode||A.appendChild(n)}}return n},_e=function(e){var t,n,r,a,o,d,s,l,c;if(A){if(e)for(pe.splice(0,pe.length);A.firstChild;)A.removeChild(A.firstChild);else{for(t=A.childNodes.length-1;t>=0;t--)A.childNodes[t].style.visibility="hidden";for(t=0;t<pe.length;t++)pe[t].isUsed=null}var u=[],g=[];for(t=0;t<P.length;t++)if(P[t].grid&&P[t].grid.isVisible())for(var h=(new i.Matrix4).multiplyMatrices(P[t].grid.getMatrix(),S),f=0;f<P[t].grid.children.length;f++)if(P[t].grid.children[f].isVisible()){var x=P[t].grid.children[f].children[1];if(x&&x.isVisible())for(var p=0;p<x.children.length;p++){var y=x.children[p];if(y.isVisible())for(var m=0;m<y.children.length;m++){var v=Ye(y.children[m],h);if(v){var b="x:"+v.position2D.x+", y:"+v.position2D.y,D=u.indexOf(b);-1!==D&&(n=v,r=g[D],a=void 0,o=void 0,d=void 0,s=void 0,l=void 0,c=void 0,a=0,o=0,d=Ae.width-Ae.right,s=Ae.height-Ae.bottom,l=Ae.left,c=Ae.top,n.position2D.x===l&&(a=-5-r.width),n.position2D.y===c&&(o=-5-r.height),n.position2D.x===d&&(a=r.width+5),n.position2D.y===s&&(o=r.height+5),n.style.top=n.position2D.y-n.offset2D.y-o+"px",n.style.left=n.position2D.x-n.offset2D.x-a+"px"),u.push(b),g.push(v)}}}}}},We=function(e){var t={};return e.origin.x+e.xAxis<e.origin.x?t.x="max":t.x="min",e.origin.y+e.yAxis<e.origin.y?t.y="max":t.y="min",e.origin.z+e.zAxis<e.origin.z?t.z="max":t.z="min",t},Ze=function(e){if(e.grid){var t={origin:(new i.Vector3).copy(e.gridDataPreference.origin),xAxis:Math.abs(e.gridDataPreference.xAxis),yAxis:Math.abs(e.gridDataPreference.yAxis),zAxis:Math.abs(e.gridDataPreference.zAxis)};e.gridDataPreference.xAxis<0&&(t.origin.x+=e.gridDataPreference.xAxis),e.gridDataPreference.yAxis<0&&(t.origin.y+=e.gridDataPreference.yAxis),e.gridDataPreference.zAxis<0&&(t.origin.z+=e.gridDataPreference.zAxis),t.origin.applyMatrix4(e.grid.getMatrix());var n=new i.Vector3(0,t.yAxis,0),r=new i.Vector3(t.xAxis,0,0);n.applyMatrix4(S),r.applyMatrix4(S);var a=(new i.Vector3).crossVectors(n,r);n=new i.Vector3(t.xAxis,0,0),r=new i.Vector3(0,0,t.zAxis),n.applyMatrix4(S),r.applyMatrix4(S);var o=(new i.Vector3).crossVectors(n,r);n=new i.Vector3(0,0,t.zAxis),r=new i.Vector3(0,t.yAxis,0),n.applyMatrix4(S),r.applyMatrix4(S);var d=(new i.Vector3).crossVectors(n,r),s=v.currentViewpoint.getSightDirection();return s.dot(a)<0&&s.dot(o)>0&&s.dot(d)>0?t.zAxis=-t.zAxis:s.dot(a)>0&&s.dot(o)<0&&s.dot(d)>0?t.yAxis=-t.yAxis:s.dot(a)>0&&s.dot(o)>0&&s.dot(d)<0?t.xAxis=-t.xAxis:s.dot(a)<0&&s.dot(o)<0&&s.dot(d)>0?(t.yAxis=-t.yAxis,t.zAxis=-t.zAxis):s.dot(a)>0&&s.dot(o)<0&&s.dot(d)<0?(t.xAxis=-t.xAxis,t.yAxis=-t.yAxis):s.dot(a)<0&&s.dot(o)>0&&s.dot(d)<0?(t.xAxis=-t.xAxis,t.zAxis=-t.zAxis):s.dot(a)<0&&s.dot(o)<0&&s.dot(d)<0&&(t.xAxis=-t.xAxis,t.yAxis=-t.yAxis,t.zAxis=-t.zAxis),We(t)}},qe=function(e){if(e.grid&&"userDefined"!==e.originType)if(J&&H&&e===W)H.updateAutomaticCorner();else{var t=Ze(e),i=We(e.gridDataPreference);t.x===i.x&&t.y===i.y&&t.z===i.z||(e.bBox?V.drawGrids({specifications:[e.bBox]}):e.root&&V.drawGrids({rootPaths:[e.root]}))}},je=function(e){var t=new i.Vector2(0,0),n=e.positionOnAxis;return"left"===e.anchor?"first"===n?t.x=e.width:"last"===n?(t.x=e.width,t.y=e.height):(t.x=e.width,t.y=e.height/2):"right"===e.anchor?"last"===n?t.y=e.height:"first"!==n&&(t.y=e.height/2):"top"===e.anchor?"first"===n?t.y=-e.height/3:"last"===n?(t.x=e.width,t.y=-e.height/3):(t.x=e.width/2,t.y=-e.height/3):"bottom"===e.anchor&&("first"===n?t.y=4*e.height/3:"last"===n?(t.x=e.width,t.y=4*e.height/3):(t.x=e.width/2,t.y=4*e.height/3)),t.x=Math.round(10*t.x)/10,t.y=Math.round(10*t.y)/10,e.node&&(e.node.hotspotWidth=e.width,e.node.hotspotHeight=e.height),t},Ke=function(e){var t=e.isFirst?"first":!1===e.hasNext?"last":"else",i="xAxis"===e.axis&&e.axisOrientation>0||"xAxis"!==e.axis&&e.axisOrientation<0;return e.planeSightOrientation.side&&(i=!i),-1!==e.planeID.indexOf("yx")?e.planeSightOrientation.top||"left"!==e.labelPositionOnGrid&&"right"!==e.labelPositionOnGrid||(i=!i):-1===e.planeID.indexOf("yz")&&-1===e.planeID.indexOf("xz")||e.planeSightOrientation.top||"top"!==e.labelPositionOnGrid&&"bottom"!==e.labelPositionOnGrid||(i=!i),i&&"else"!==t&&(t="first"===t?"last":"first"),t},Je=function(e){var t=(new i.Vector3).copy(e.plane.localYAxis).clone().normalize(),n=v.currentViewpoint.getSightDirection(),r=v.currentViewpoint.getUpDirection(),a=(new i.Vector3).crossVectors(n,r),o=t.projectOnPlane(a),d=0!==o.x||0!==o.y||0!==o.z?o.angleTo(r):0,s={},l={},c=Te(e.plane.normal.dot(n));l.top=c>0,l.side=!1,c>0?(s.localYAxis="left",s.oppositeLocalYAxis="right",s.localXAxis="bottom",s.oppositeLocalXAxis="top"):-1!==e.plane.getName().indexOf("yz")||-1!==e.plane.getName().indexOf("xz")?(s.localYAxis="right",s.oppositeLocalYAxis="left",s.localXAxis="bottom",s.oppositeLocalXAxis="top"):(s.localYAxis="left",s.oppositeLocalYAxis="right",s.localXAxis="top",s.oppositeLocalXAxis="bottom");var u=!1,g=null,h=null;return-1!==e.plane.getName().indexOf("yz")||-1!==e.plane.getName().indexOf("xz")?Me(e.plane.localYAxis)>0?(g=Math.PI/2,h=Math.PI):(g=0,h=Math.PI/2):Me(e.plane.localYAxis)===c?(g=0,h=Math.PI/2):(g=Math.PI/2,h=Math.PI),d&&d>=g&&d<=h&&(u=!0,l.side=!0),u&&(s.localXAxis="bottom"===s.localXAxis?"top":"bottom",s.oppositeLocalXAxis="top"===s.oppositeLocalXAxis?"bottom":"top",s.localYAxis="right"===s.localYAxis?"left":"right",s.oppositeLocalYAxis="left"===s.oppositeLocalYAxis?"right":"left"),s.planeSightOrientation=l,s},Qe=function(e){for(var t=Je({plane:e}),i=e.getChildByName("Labels").children,n=0;n<i.length;n++)if(i[n].isVisible())for(var r=i[n].children,a=0;a<r.length;a++){var o=wt(r[a]),d=Ke({axis:r[a].axis,axisOrientation:r[a].axisOrientation,isFirst:r[a].labelIsFirst,hasNext:r[a].labelHasNext,labelPositionOnGrid:t[i[n].getName()],planeSightOrientation:t.planeSightOrientation,planeID:e.getName()});r[a].labelIsFirst&&r[a].labelHasNext&&ve.push({node:r[a]});var s=je({node:r[a],anchor:t[i[n].getName()],width:o.width,height:o.height,positionOnAxis:d});s.x===o.x&&s.y===o.y&&s.width===o.width&&s.height===o.height||r[a].setHotspot(s)}},$e=function(e){var t=e.plane.getChildByName("Labels"),i="",n="";-1!==e.plane.getName().indexOf("yx")?(i=Me(e.plane.localYAxis)>0?"oppositeLocalXAxis":"localXAxis",t.getChildByName(i).setVisibility(e.flag),n=Me(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis",t.getChildByName(n).setVisibility(e.flag)):-1!==e.plane.getName().indexOf("yz")?(i=Me(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis",t.getChildByName(i).setVisibility(e.flag),n=Me(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis",t.getChildByName(n).setVisibility(e.flag)):-1!==e.plane.getName().indexOf("xz")&&(i=Me(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis",t.getChildByName(i).setVisibility(e.flag),n=Me(e.plane.localXAxis)>0?"oppositeLocalYAxis":"localYAxis",t.getChildByName(n).setVisibility(e.flag))},et=function(e){if(e.grid){var t;if(0===e.gridDataPreference.xAxis||0===e.gridDataPreference.yAxis||0===e.gridDataPreference.zAxis)for(t=0;t<e.grid.children.length;t++)$e({plane:e.grid.children[t],flag:!0});else{var i=null;for(t=0;t<e.grid.children.length;t++){var n;if((n=v.currentViewpoint.getSightDirection().clone().projectOnPlane(e.grid.children[t].normal.applyMatrix4(S))).x=parseFloat(n.x.toFixed(4)),n.y=parseFloat(n.y.toFixed(4)),n.z=parseFloat(n.z.toFixed(4)),0===n.x&&0===n.y&&0===n.z){i=e.grid.children[t].name;break}}if(i){for(e.grid.setNoZ(!0),t=0;t<e.grid.children.length;t++)e.grid.children[t].setVisibility(i===e.grid.children[t].name),i===e.grid.children[t].name&&($e({plane:e.grid.children[t],flag:!0}),Qe(e.grid.children[t]));Y=!0}}v.render()}},tt=function(){for(var e,t,n=0;n<ve.length;n++)if(!ve[n].updated){var r=wt(t=ve[n].node),a=(new i.Vector3).getPositionFromMatrix(t.getMatrix()),o=[];for(e=0;e<ve.length;e++)if(n!==e){var d=(new i.Vector3).getPositionFromMatrix(ve[e].node.getMatrix());if(d.x===a.x&&d.y===a.y&&d.z===a.z){var s=wt(ve[e].node);s.y<r.y-r.height||r.y-r.height>s.y||s.x<r.x-r.width||r.x-r.width>s.x||o.push(e)}}if(1===o.length){o.push(n);var l=0;for(e=0;e<o.length;e++){var c=wt(t=ve[o[e]].node),u=new i.Vector2;u.x=c.width/2,u.y=l,t.hotspotWidth=c.width,t.hotspotHeight=c.height,u.x===c.x&&u.y===c.y||t.setHotspot(u),l+=c.height,l+=3,ve[o[e]].updated=!0}}ve[n].updated=!0}},it=function(e){var t,i;if(-1!==e.eventType.indexOf("@onViewpoint")){var n=v.currentViewpoint.getSightDirection();if("@onViewpointBeginMove"===e.eventType)Q=!0,Le(),ye=!0;else if("@onViewpointChange"===e.eventType){if(null===Q&&(Q=!0),!n.equals(_)){if(Y){for(t=0;t<P.length;t++)for(P[t].grid.setNoZ(!1),i=0;i<P[t].grid.children.length;i++)Qe(P[t].grid.children[i]),$e({plane:P[t].grid.children[i],flag:!1}),P[t].grid.children[i].setVisibility(!0);Y=!1}for(t=0;t<P.length;t++)et(P[t]);_.copy(n)}if(!k)for(t=0;t<P.length;t++)qe(P[t]);_e(Q),Q=!1}else if("@onViewpointEndMove"===e.eventType)if(we)Be();else if(Q=null,ye=!1,_e(!0),!Y){for(ve.splice(0,ve.length),t=0;t<P.length;t++)if(P[t].grid)for(i=0;i<P[t].grid.children.length;i++)Qe(P[t].grid.children[i]);tt()}v.render()}},nt=function(){if(R){(H=new C({window:b,stepRequired:M.xStep})).display({rootID:m.getNodeID(W.root.getLastElement(!0)),gridDataPreference:W.gridDataPreference,matrix:W.grid.getMatrix(),displayHandlePoints:"userDefined"===W.originType}),Z=H.subscribe("EndBoxChanged",function(){W.type="userDefined",le.setState(!1),ee.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"]}]}},context:D.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})}),q=H.subscribe("BoxCornerChanged",function(e){!0===e.cornerChanged?(W.originType="userDefined",ue.setState(!1),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","false")):ue.setState("userDefined"!==W.originType),ee.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATRelatedData3DGridAutoOrigin",line:1,hdr_list:["CATRelatedData3DGridAutoOriginHdr"]}]}},context:D.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})});var e=function(t){0!==v.pick(v.getMousePosition(t.from[0].currentPosition),"mesh",!1).path.length||v.currentViewpoint.isMoving()||(s.removeEvent(v.canvas,"onPrimaryPointerClick",e),ae&&ae.end())};ae=l.getCommand("CATRelatedData3DGridEditHdr",D.getCommandContext()),s.addEvent(v.canvas,"onPrimaryPointerClick",e),te.disable()}},rt=function(e){var t;if(e){if(ye&&"Labels"===e.name)return;if(e.material&&(e.material.dispose(),e.material=null,e.canvasNodeTexture&&(e.canvasNodeTexture._canvas2DTexture&&(e.canvasNodeTexture._canvas2DTexture.dispose(),e.canvasNodeTexture._canvas2DTexture=null),e.canvasNodeTexture.materials&&e.canvasNodeTexture.materials.length)))for(t=0;t<e.materials.canvasNodeTexture.length;t++)e.canvasNodeTexture.materials[t].dispose(),e.canvasNodeTexture.materials[t]=null;for(t=e.children.length-1;t>=0;t--)rt(e.children[t]);e.removeChildren()}},at=function(e){var t=!0;"userDefined"===e.fitToStep&&(t=!1);var n=new i.Vector3(e.min.x,e.min.y,e.min.z),r=Te(e.max.x-e.min.x),a=Te(e.max.y-e.min.y),o=Te(e.max.z-e.min.z),d=new i.Vector3(e.min.x,e.min.y,e.min.z),s=e.max.x,l=e.max.y,c=e.max.z;t&&(d.x=r?r>0?Ve(n.x,M.xStep):Pe(n.x,M.xStep):0,d.y=a?a>0?Ve(n.y,M.yStep):Pe(n.y,M.yStep):0,d.z=o?o>0?Ve(n.z,M.zStep):Pe(n.z,M.zStep):0,s=r?r>0?Pe(e.max.x,M.xStep):Ve(e.max.x,M.xStep):0,l=a?a>0?Pe(e.max.y,M.yStep):Ve(e.max.y,M.yStep):0,c=o?o>0?Pe(e.max.z,M.zStep):Ve(e.max.z,M.zStep):0);var u=s-d.x,g=l-d.y,h=c-d.z,f=e.defaultOrigin;return f&&("max"===f.x&&(d.x=d.x+u,u*=-1),"max"===f.y&&(d.y=d.y+g,g*=-1),"max"===f.z&&(d.z=d.z+h,h*=-1)),{origin:d,xAxis:u,yAxis:g,zAxis:h}},ot=function(){D&&(ae=new u({ID:"CATRelatedData3DGridEditHdr",isEnabled:!0,context:D.getCommandContext()}),oe=ae.onBegin(function(){!function(){J=!0,ze(t.rootBagPath);for(var e=0;e<P.length;e++)Re(P[e].root,{type:"pickability",value:"NOT_PICKABLE"}),P[e].grid.name===W.grid.name&&rt(P[e].grid);for(;A.firstChild;)A.removeChild(A.firstChild);C?nt():require(["DS/CATRelatedData3DGrid/CATRelatedData3DGridBoxHandle"],function(e){C=e,nt()})}()}),de=ae.onEnd(function(){if(J){H.unsubscribe(null),H.unsubscribe(Z),H.unsubscribe(q);for(var e=0;e<P.length;e++)if(P[e].grid.name===W.grid.name){H.isSizeOK()&&(P[e].gridDataPreference=H.getDataPreference(),P[e].type=W.type,P[e].originType=W.originType,T=We(P[e].gridDataPreference));break}H.clean(),H=null,J=!1,Se(),V.drawGrids({rootPaths:[W.root]}),te.enable()}}))},dt=function(){for(var e={gridList:[]},t=0;t<P.length;t++)e.gridList.push({rootID:P[t].gridName.split("3D Grid ")[1],gridDataPreference:P[t].gridDataPreference,type:P[t].type,originType:P[t].originType});B&&B.setValue("3DGridData",JSON.stringify(e)),localStorage.setItem("CATRelatedData3DGridDftOrigin",JSON.stringify(T))},st=function(){le=new g({ID:"CATRelatedData3DGridAutoFitHdr",isEnabled:!0,context:D.getCommandContext()}),ce=le.onStateChange(function(){!function(e){if(W)if("userDefined"===W.type||e){if("userDefined"===W.type&&e){W.type="auto";var t=At(W.root),i=null;if(t)if(J)i=at({min:t.min,max:t.max,defaultOrigin:We(H.getDataPreference())}),H.setDataPreference(i),H.refresh();else{i=at({min:t.min,max:t.max,defaultOrigin:We(W.gridDataPreference)}),W.gridDataPreference=i,V.drawGrids({rootPaths:[W.root]});var n=[{name:"CATRelatedData3DGridEdit",line:1,hdr_list:["CATRelatedData3DGridEditHdr"]},{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"]}];ee.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:n}},context:D.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})}localStorage.setItem("CATRelatedData3DGridAutoFitCmd","true")}}else W.type="userDefined",dt(),localStorage.setItem("CATRelatedData3DGridAutoFitCmd","false")}(this.getState())})},lt=function(){ue=new h({ID:"CATRelatedData3DGridAutoOriginHdr",isEnabled:!0,context:D.getCommandContext()}),ge=ue.onStateChange(function(){var e;e=this.getState(),"userDefined"===W.originType||e?"userDefined"===W.originType&&e&&(W.originType="auto",J&&(H.setHandlePointsVisibility(!1),H.updateAutomaticCorner()),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","true")):(W.originType="userDefined",dt(),J&&H.setHandlePointsVisibility(!0),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","false"))})},ct=function(e,t){var i=e.height;t.font=O+"pt sans-serif",t.fillStyle=this.isHighlighted?"#FF8000":$,t.fillText(this.txtValue,0,i)},ut=function(e){var t,n=fe.getContext("2d");n.font=O+"pt sans-serif";var d,s=e.prefix+f.convertValueToString(e.value,"Length",{displayUnit:!1}),l=Math.round(10*n.measureText(s).width)/10,c=O;fe.width=l,fe.height=c;var u=e.plane.getName();for(t=0;t<xe.length;t++)if(xe[t].txtValue===s&&xe[t].gridID===e.gridID){d=xe[t].canvasNodeTexture;break}d||((d=new a({width:l,height:c,drawCB:ct})).txtValue=s,d.labelValue={prefix:e.prefix,value:e.value},xe.push({txtValue:s,canvasNodeTexture:d,gridID:e.gridID}));var g=Je({plane:e.plane});for(t=0;t<e.position.length;t++){var h="";-1!==u.indexOf("yx")?h="yAxis"===e.axis?Me(e.plane.localYAxis)>0?"oppositeLocalXAxis":"localXAxis":Me(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis":-1!==u.indexOf("yz")?h="yAxis"===e.axis?Me(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis":Me(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis":-1!==u.indexOf("xz")&&(h="xAxis"===e.axis?Me(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis":Me(e.plane.localXAxis)>0?"oppositeLocalYAxis":"localYAxis"),t>0&&("localXAxis"===h?h="oppositeLocalXAxis":"oppositeLocalXAxis"===h?h="localXAxis":"localYAxis"===h?h="oppositeLocalYAxis":"oppositeLocalYAxis"===h&&(h="localYAxis"));var x=Ke({axis:e.axis,axisOrientation:e.gridData[e.axis],planeID:u,isFirst:e.isFirst,hasNext:e.hasNext,planeSightOrientation:g.planeSightOrientation,labelPositionOnGrid:g[h]}),p=je({anchor:g[h],positionOnAxis:x,width:l,height:c}),y=r.createCanvas2DNode({name:s,hotspot:p,canvasNodeTexture:d});y.hotspotWidth=l,y.hotspotHeight=c,y.setMatrix((new i.Matrix4).makeTranslation(e.position[t].x,e.position[t].y,e.position[t].z)),y.setPickable(o.PICKABLE),y.labelIsFirst=e.isFirst,y.gridID=e.gridID,y.labelHasNext=e.hasNext,y.axis=e.axis,y.axisOrientation=e.gridData[e.axis],y.boundaries=[e.position[0].clone(),e.position[1].clone()],e.labels.getChildByName(h).addChild(y),te&&(ie[e.gridID]||(ie[e.gridID]=[]),ie[e.gridID].push(te.linkToNode(y))),e.isFirst&&e.hasNext&&ve.push({node:y})}},gt=function(){var e=new i.Vector3,t=new i.Vector3,n=new i.Vector3,r=new i.Vector3;S.extractBasis(t,n,r);var a=new i.Vector3(S.elements[12],S.elements[13],S.elements[14]);return e.x=t.dot(a),e.y=n.dot(a),e.z=r.dot(a),e},ht=function(e){var t;ve.splice(0,ve.length),E&&(t=gt());for(var r,a=["yx","yz","xz"],o=0;o<a.length;o++){var d=e.gridData.gridDataPreference,s=a[o].charAt(0),l=a[o].charAt(1),c=s+"Axis",u=l+"Axis",g=e.gridData.grid.getChildByName(a[o]+" Plane");if(0!==d[c]&&0!==d[u]&&g){var h=g.getChildByName("Labels");if(h)for(r=0;r<h.children.length;r++)h.children[r].removeChildren();else(h=new n("Labels")).addChild(new n("localXAxis")),h.addChild(new n("localYAxis")),h.addChild(new n("oppositeLocalXAxis")),h.addChild(new n("oppositeLocalYAxis")),g.addChild(h);var f=s+"Step",x=l+"Step",p=Te(d[c])<0?Ve(d.origin[s],M[f]):Pe(d.origin[s],M[f]),y=p,m=0;if(E)for("x"===s&&(y=y=Te(p)<0?p+t.x:p-t.x),"y"===s&&(y=y=Te(p)<0?p+t.y:p-t.y),"z"===s&&(y=y=Te(p)<0?p+t.z:p-t.z);Math.abs(y)>Math.abs(d.origin[s]);)m+=M[f],y=Te(y)<0?y+=M[f]:y-=M[f];var v,b,D=0;for(r=0;Math.abs(y+r*Te(d[c])-d.origin[s])<=Math.abs(d[c]);r+=M[f])0!==D&&D%e.gridData.labelRatio!=0&&D!==e.labelsInfos[a[o]].fstAxis||(v=(new i.Vector3).copy(d.origin),b=(new i.Vector3).copy(d.origin),v[s]=y+r*Te(d[c]),v[l]=d.origin[l],b[s]=y+r*Te(d[c]),b[l]=d.origin[l]+d[u],ut({prefix:I[s],value:Math.pow(10,-3)*(p+m+r*Te(d[c])),isFirst:0===r,hasNext:Math.abs(y+(r+M[f])*Te(d[c])-d.origin[s])<=Math.abs(d[c]),position:[v,b],axis:c,labels:h,plane:g,gridData:d,gridID:e.gridData.grid.getName()})),D++;var w=Te(d[u])<0?Ve(d.origin[l],M[x]):Pe(d.origin[l],M[x]),A=0,C=w;if(E)for("x"===l&&(C=C=Te(w)<0?w+t.x:w-t.x),"y"===l&&(C=C=Te(w)<0?w+t.y:w-t.y),"z"===l&&(C=C=Te(w)<0?w+t.z:w-t.z);Math.abs(C)>Math.abs(d.origin[l]);)A+=M[x],C=Te(C)<0?C+=M[x]:C-=M[x];for(D=0,r=0;Math.abs(C+r*Te(d[u])-d.origin[l])<=Math.abs(d[u]);r+=M[x])0!==D&&D%e.gridData.labelRatio!=0&&D!==e.labelsInfos[a[o]].scdAxis||(v=(new i.Vector3).copy(d.origin),b=(new i.Vector3).copy(d.origin),v[s]=d.origin[s],v[l]=C+r*Te(d[u]),b[s]=d.origin[s]+d[c],b[l]=C+r*Te(d[u]),ut({prefix:I[l],value:Math.pow(10,-3)*(w+A+r*Te(d[u])),isFirst:0===r,hasNext:Math.abs(C+(r+M[x])*Te(d[u])-d.origin[l])<=Math.abs(d[u]),position:[v,b],axis:u,labels:h,plane:g,gridData:d,gridID:e.gridData.grid.getName()})),D++;$e({plane:g,flag:!1})}}tt()},ft=function(e){if(e){for(var t,i={max:0},n=["yx","yz","xz"],r=0;r<n.length;r++){var a=n[r].charAt(0),o=n[r].charAt(1),d=a+"Axis",s=o+"Axis";if(0!==e[d]&&0!==e[s]){var l=a+"Step",c=o+"Step";i[n[r]]={};var u=0,g=Te(e[d])<0?Ve(e.origin[a],M[l]):Pe(e.origin[a],M[l]);for(t=0;Math.abs(g+t*Te(e[d])-e.origin[a])<=Math.abs(e[d]);t+=M[l])u++,i.max++;i[n[r]].fstAxis=u,u=0;var h=Te(e[s])<0?Ve(e.origin[o],M[c]):Pe(e.origin[o],M[c]);for(t=0;Math.abs(h+t*Te(e[s])-e.origin[o])<=Math.abs(e[s]);t+=M[c])u++,i.max++;i[n[r]].scdAxis=u}}return i}},xt=function(e){var t,i=0,n=[];for(t=0;t<P.length;t++)if(P[t].grid&&P[t].gridDataPreference){var r=ft(P[t].gridDataPreference);r&&(n.push(r),i+=r.max)}var a=i,o=1;if(L)for(;i>L;)i=a/++o;for(t=0;t<P.length;t++)P[t].grid&&(P[t].labelRatio!==o||e)&&(P[t].labelRatio=o,ht({gridData:P[t],labelsInfos:n[t]}));_e(!0)};this.setActiveState=function(t){var i;if(t!==w)if(w=t)fe||(fe=document.createElement("canvas")),A||(A=e.createElement("div").inject(b.getUIFrame())),he=d.subscribe({event:"/VISU/"},it),_.copy(v.currentViewpoint.getSightDirection()),N&&((te=new c).setExclusive(!0),ne.beginPreactivate=te.onBeginPreactivate(Ee),ne.endPreactivate=te.onEndPreactivate(Le),ne.primaryPointerClick=te.onPrimaryPointerClick(Fe),ne.beginManipulate=te.onBeginManipulate(Oe),ne.manipulate=te.onManipulate(Ie),ne.endanipulate=te.onEndManipulate(Be)),R&&(ot(),st(),lt()),(i=x.getPreferenceManager({context:b}))&&(re.CATWebUXPreferences_UnitsAndDecimalPlace=i.subscribe("CATWebUXPreferences_UnitsAndDecimalPlace",Ct),re.CATWebUXPreferences_TrailingZeros=i.subscribe("CATWebUXPreferences_TrailingZeros",function(){Ct(!0)}));else{var n;A&&b.getUIFrame().removeChild(A),A=null,fe=null,d.unsubscribe(he),he=0,N&&((n=Object.keys(ne)).forEach(function(e){te.unsubscribe(ne[e])}),ne={}),(i=x.givePreferenceManager({context:b}))&&((n=Object.keys(re)).forEach(function(e){i.unsubscribe(re[e])}),re={}),x.unreferencePreferenceManager({context:b}),R&&(d.unsubscribe(de),de=null,d.unsubscribe(oe),oe=null,ae=null,le._modelEvents.unsubscribe(ce),ce=null,le=null,ue._modelEvents.unsubscribe(ge),ge=null,ue=null),n=Object.keys(ie);for(var r=0;r<n.length;r++)for(var a=0;a<ie[n[r]].length;a++)te.unlink(ie[n[r]][a]);ie={}}},this.endEditMode=function(){ae&&ae.end()};var pt=function(e,t){var n,r;if(r="userDefined"!==e.type?at({min:t.min,max:t.max,defaultOrigin:T}):e.gridDataPreference,(n="userDefined"===e.originType?We(e.gridDataPreference):Ze(e))&&(r=function(e,t,n){for(var r,a,o=t.origin,d=[new i.Vector3(o.x,o.y,o.z),new i.Vector3(o.x+t.xAxis,o.y,o.z),new i.Vector3(o.x,o.y+t.yAxis,o.z),new i.Vector3(o.x,o.y,o.z+t.zAxis),new i.Vector3(o.x+t.xAxis,o.y+t.yAxis,o.z),new i.Vector3(o.x,o.y+t.yAxis,o.z+t.zAxis),new i.Vector3(o.x+t.xAxis,o.y,o.z+t.zAxis),new i.Vector3(o.x+t.xAxis,o.y+t.yAxis,o.z+t.zAxis)],s=0;s<d.length;s++)void 0===r&&void 0===a?(r=(new i.Vector3).copy(d[s]),a=(new i.Vector3).copy(d[s])):(r.x=Math.min(d[s].x,r.x),r.y=Math.min(d[s].y,r.y),r.z=Math.min(d[s].z,r.z),a.x=Math.max(d[s].x,a.x),a.y=Math.max(d[s].y,a.y),a.z=Math.max(d[s].z,a.z));return at({min:r,max:a,defaultOrigin:n,fitToStep:e.type})}(e,r,n)),r!==e.gridDataPreference)return r},yt=function(e){var t;if(F.gridList&&F.gridList.length>0)for(var i=0;i<F.gridList.length;i++){if((t=F.gridList[i]).rootID===e.split("3D Grid ")[1]){F.gridList.splice(i,1);break}t=null}return t},mt=function(e,t,i){for(var n,r=0;r<P.length;r++)if(P[r].gridName===e){if(t&&(P[r].root=t.clone()),i&&(P[r].bBox=i.clone()),n=P[r],ie&&ie[e]){for(var a=0;a<ie[e].length;a++)te.unlink(ie[e][a]);ie[e].splice(0,ie[e].length)}break}return n},vt=function(e,t,a,d,s){var l,c,u,g,h,f=!0;return e&&(u=e.gridDataPreference,e.type&&(g=e.type),e.originType&&(h=e.originType)),t?(t.grid||(t.grid=new n(t.gridName),t.grid.setVisibilityFree(!0)),l=t.grid,u=t.gridDataPreference,g=t.type,h=t.originType,f=t.visibility):((l=new n(s)).setVisibilityFree(!0),s==="3D Grid "+z?(void 0===h&&(h="auto"),void 0===g&&(g="userDefined"),void 0===u&&(u=at({min:a.min,max:a.max,defaultOrigin:T,fitToStep:g})),t={bBox:a?a.clone():void 0,gridName:s,grid:l,gridDataPreference:u,type:g,originType:h}):(void 0===g&&(g="false"===localStorage.getItem("CATRelatedData3DGridAutoFitCmd")?"userDefined":"auto"),void 0===h&&(h="false"===localStorage.getItem("CATRelatedData3DGridAutoOriginCmd")?"userDefined":"auto"),void 0===u&&(u=at({min:a.min,max:a.max,defaultOrigin:T})),t={root:d?d.clone():void 0,gridName:s,grid:l,gridDataPreference:u,type:g,originType:h}),P.push(t)),rt(l),t.labelRatio=null,l.setVisibility(f),t.visibility=f,(c=pt(t,a))&&(t.gridDataPreference=c),function(e){var t,a,d=["yx","yz","xz"];E&&(a=gt());for(var s=0;s<d.length;s++){var l=e.gridData.gridDataPreference,c=d[s].charAt(0),u=d[s].charAt(1),g=c+"Axis",h=u+"Axis";if(0!==l[g]&&0!==l[h]){var f=new n(c+u+" Plane");e.gridData.grid.addChild(f);var x=new n("Lines");x.setPickable(o.PICKTHROUGH),f.addChild(x);var p=new i.Vector3,y=new i.Vector3;p[c]=l[g],y[u]=l[h],f.localXAxis=p,f.localYAxis=y,f.normal=(new i.Vector3).crossVectors(p,y).normalize(),Me(f.normal)>0&&(f.normal=f.normal.negate());var m=c+"Step",v=u+"Step",b=Te(l[g])<0?Ve(l.origin[c],M[m]):Pe(l.origin[c],M[m]);if(E)for("x"===c&&(b=Te(b)<0?b+=a.x:b-=a.x),"y"===c&&(b=Te(b)<0?b+=a.y:b-=a.y),"z"===c&&(b=Te(b)<0?b+=a.z:b-=a.z);Math.abs(b)>Math.abs(l.origin[c]);)b=Te(b)<0?b+=M[m]:b-=M[m];var D=(new i.Vector3).copy(l.origin),w=(new i.Vector3).copy(l.origin);D[c]=b,D[u]=l.origin[u],w[c]=b,w[u]=l.origin[u]+l[h];var A=r.createLineNode({points:[D,w]});for(t=0;Math.abs(b+t*Te(l[g])-l.origin[c])<=Math.abs(l[g]);t+=M[m]){var C=A;0!==t&&(C=C.clone()),C.setMatrix((new i.Matrix4).makeTranslation("x"===c?t*Te(l[g]):0,"y"===c?t*Te(l[g]):0,"z"===c?t*Te(l[g]):0)),C.relatedLabel={prefix:I[c],value:Math.pow(10,-3)*Math.round(b+t*Te(l[g]))},x.addChild(C)}var V=Te(l[h])<0?Ve(l.origin[u],M[v]):Pe(l.origin[u],M[v]);if(E)for("x"===u&&(V=Te(V)<0?V+=a.x:V-=a.x),"y"===u&&(V=Te(V)<0?V+=a.y:V-=a.y),"z"===u&&(V=Te(V)<0?V+=a.z:V-=a.z);Math.abs(V)>Math.abs(l.origin[u]);)V=Te(V)<0?V+=M[v]:V-=M[v];for(D=(new i.Vector3).copy(l.origin),w=(new i.Vector3).copy(l.origin),D[c]=l.origin[c],D[u]=V,w[c]=l.origin[c]+l[g],w[u]=V,A=r.createLineNode({points:[D,w]}),t=0;Math.abs(V+t*Te(l[h])-l.origin[u])<=Math.abs(l[h]);t+=M[v]){var P=A;0!==t&&(P=P.clone()),P.setMatrix((new i.Matrix4).makeTranslation("x"===u?t*Te(l[h]):0,"y"===u?t*Te(l[h]):0,"z"===u?t*Te(l[h]):0)),P.relatedLabel={prefix:I[u],value:Math.pow(10,-3)*Math.round(V+t*Te(l[h]))},x.addChild(P)}}}}({gridData:t}),l.exludeFromBounding(!1),l.setVisibilityInTree(!1),xt(),l};this.drawGrids=function(e){var t,n,r,a;Ce=f.getCurrentUnit("Length").unit,n=v.backgroundColor,r=new i.Color(n),a=Math.round((255*r.r*299+255*r.g*587+255*r.b*114)/1e3),$=a>125?"black":"white";var o,d,s,l,c,u=null;if(e.rootPaths){var g;for(g=0;g<e.rootPaths.length;g++)l=e.rootPaths[g],s="3D Grid "+m.getNodeID(l.getLastElement(!0)),(c=yt(s))||(u=mt(s,l,d)),(d=At(l))?(o=vt(c,u,d,l,s),v.getRootNode().getChildByName("3D Grid "+m.getNodeID(l.getLastElement(!0)))||v.addNode(o)):u&&u.grid&&u.grid.setVisibility(!1);for(g=0;g<e.rootPaths.length;g++)for(t=0;t<P.length;t++)if(P[t].root&&P[t].root.isEqual(e.rootPaths[g])){et(P[t]);break}e.rootPaths.length>0&&(dt(),v.render({updateInfinitePlane:!0}))}else e.specifications&&(d=e.specifications[0].BBox,(c=yt(s="3D Grid "+z))||(u=mt(s,l,d)),!d&&u&&u.grid&&u.grid.setVisibility(!1),o=vt(c,u,d,l,s),et(P[0]),dt(),G&&G.addChild(o))};var bt=function(e){var t=ie[e];if(t&&t.length){for(var i=0;i<t.length;i++)te.unlink(t[i]);t.splice(0,t.length)}},Dt=function(e,t){for(var i=P.length-1;i>=0;i--)if(P[i].gridName===t){rt(P[i].grid),e.rootPaths?v.removeNode(P[i].grid):e.owner&&e.owner.removeChild(P[i].grid),e.fromStorage?P.splice(i,1):(P[i]&&P[i].grid&&delete P[i].grid,P[i]&&P[i].root&&delete P[i].root,P[i]&&P[i].bBox&&delete P[i].bBox,P[i]&&P[i].labelRatio&&delete P[i].labelRatio),bt(t);break}!function(e){if(A&&A.childNodes&&A.childNodes.length)for(var t=A.childNodes.length-1;t>=0;t--)A.childNodes[t].label.gridID===e&&A.removeChild(A.childNodes[t])}(t),function(e){if(xe)for(var t=xe.length-1;t>=0;t--)xe[t].gridID===e&&xe.splice(t,1)}(t)};this.deleteGrids=function(e){var t=void 0;if(e.rootPaths)for(var i=0;i<e.rootPaths.length;i++)t="3D Grid "+m.getNodeID(e.rootPaths[i].getLastElement(!0)),Dt(e,t);else Dt(e,t="3D Grid "+z);e.fromStorage&&e.rootPaths&&e.rootPaths.length>0&&(dt(),v.render()),0===P.length?xe.splice(0,xe.length):xt()},this.getGridRootNames=function(){for(var e=[],t=0;t<P.length;t++)e.push(P[t].gridName);return e},this.setGridsVisibility=function(e){var t,i=[];for(t=0;t<e.roots.length;t++)for(var n=0;n<P.length;n++)if(m.getNodeID(P[n].root.getLastElement(!0))===m.getNodeID(e.roots[t].getLastElement(!0))&&P[n].grid&&P[n].grid.isVisible()!==e.flag){if(P[n].grid.setVisibility(e.flag),P[n].visibility=e.flag,e.flag){var r=At(P[n].root);if(r){var a=pt(P[n],r);a&&(P[n].gridDataPreference=a,i.push(e.roots[t]))}else P[n].grid.setVisibility(!1)}break}for(t=A.childNodes.length-1;t>=0;t--)A.childNodes[t].style.visibility=e.flag?"":"hidden";i.length&&V.drawGrids({rootPaths:i}),v.render()},this.updateFreeZone=function(e){Ae=e,_e(!0)}}function wt(e){var t=e.getHotspot();return t.width=e.hotspotWidth||0,t.height=e.hotspotHeight||0,t}function At(e){var t;if(e){var n=e.getOrientedBoundingBox?e.getOrientedBoundingBox(new i.Matrix4,v):e.getBoundingBox(null,v,v.getVisibleSpace()?"visibleSpace":"invisibleSpace");t=n&&!n.isNaN()?n:void 0}return t}function Ct(e){(f.getCurrentUnit("Length").unit!==Ce||e)&&(Ce=f.getCurrentUnit("Length").unit,xt(!0),v.render())}}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridController",["UWA/Core","UWA/Utils","UWA/Class","DS/ApplicationFrame/CommandsManager","DS/CATRelatedData3DGrid/CATRelatedData3DGridView","DS/Core/Events","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,n,r,a,o){"use strict";var d=i.extend({init:function(i){var d=i||{};this._parent(d);var s=!1,l=!1,c=null,u=["CAT3DComposeExamineSelectionHdr","Explode","CAT3DComposeFakeMoveHdr","CATW3DSetIdentityPositionHdr"],g=d.ctxViewer,h={},f=g.getViewer(),x=null,p=this,y=function(){if(s&&!c&&x){var e=g.getFrameWindow().getImmersiveFrame().getFreeZone().getBoundingClientRect();x.updateFreeZone({width:e.width,height:e.height,left:e.left,right:e.width-e.right,bottom:e.height-e.bottom,top:e.top})}},m=function(e){if(g&&s&&!c){for(var t=!1,i=0;i<u.length;i++)if(u[i]===e._id){t=!0;break}if(t){var r=n.getCommandCheckHeader("CATRelatedData3DGridHdr",g.getCommandContext?g.getCommandContext():null);r.disable(),x.deleteGrids({rootPaths:g.getRootBagPath().getChildrenPathes(),fromStorage:!1}),c=e.onEnd(function(){(r=n.getCommandCheckHeader("CATRelatedData3DGridHdr",g.getCommandContext?g.getCommandContext():null)).enable(),x.drawGrids({rootPaths:g.getRootBagPath().getChildrenPathes()}),a.unsubscribe(c),c=null})}}},v=m;n.onCommandStart(v,g.getCommandContext&&g.getCommandContext()?g.getCommandContext():void 0);this.setActiveState=function(i){var a,d;if(i!==s){s=i;var p=g.getRootBagPath().getChildrenPathes();if(s){if(!x){var b={};""!==window.location.search&&(e.extend(b,t.parseQuery(window.location.search)),b.widgetDomain&&e.extend(b,t.parseQuery(b.widgetDomain))),x=new r({window:g.getFrameWindow(),rootBagPath:g.getRootBagPath(),viewer:f,context:g,nbMaxLabel:"CAT3DGRID_MAXLABEL"in b?b.CAT3DGRID_MAXLABEL:300,stepRequiredX:100,stepRequiredY:100,stepRequiredZ:100}),y()}x.setActiveState(!0);var D=x.getGridRootNames(),w=!1,A=[];for(a=0;a<D.length;a++){for(d=0;d<p.length;d++)if("3D Grid "+o.getNodeID(p[d].getLastElement(!0))===D[a]){w=!0;break}if(!w)for(d=0;d<p.length;d++)if("3D Grid "+o.getNodeID(p[d].getLastElement(!0))===D[a]){A.push(p[d]);break}}for(x.deleteGrids({rootPaths:A,fromStorage:!0}),x.drawGrids({rootPaths:p}),g.getFrameWindow().getImmersiveFrame().addEventListener("freeZoneResize",y),h.onViewerResizedToken=f.onViewerResize(y),h.onRootAddedToken=g.subscribe({event:"onRootAdded"},function(e){if(s&&!c){x.endEditMode();var t=e.path;if(e.inContext)for(var i=g.getRootBagPath().getChildrenPathes(),n=0;n<i.length;n++)if(i[n].isAParentOf(e.path)){t=i[n];break}x.drawGrids({rootPaths:[t]})}}),h.onLoadingCompleteToken=g.subscribe({event:"onLoadingComplete"},function(){if(s&&!c){x.drawGrids({rootPaths:g.getRootBagPath().getChildrenPathes()});var e=g.getFrameWindow().getImmersiveFrame().getFreeZone().getBoundingClientRect();x.updateFreeZone({width:e.width,height:e.height,left:e.left,right:e.width-e.right,bottom:e.height-e.bottom,top:e.top})}}),h.onRenderComplete=g.subscribe({event:"onEndProgressiveLoad"},function(){s&&!c&&x.drawGrids({rootPaths:g.getRootBagPath().getChildrenPathes()})}),h.onRootRemovedToken=g.subscribe({event:"onRootRemoved"},function(e){if(s&&!c){x.endEditMode();var t=!l;x.deleteGrids({rootPaths:[e.path],fromStorage:t})}}),h.onHide=g.subscribe({event:"onHide"},function(e){if(s&&e&&e.paths instanceof Array&&x&&!c){x.endEditMode();for(var t=[],i=g.getRootBagPath().getChildrenPathes(),n=0;n<e.paths.length;n++)for(var r=0;r<i.length;r++)if(i[r].isAParentOf(e.paths[n])){t.push(i[r]);break}t.length&&x.drawGrids({rootPaths:t})}}),h.onShow=g.subscribe({event:"onShow"},function(e){if(s&&e&&e.paths instanceof Array&&x&&!c){x.endEditMode();for(var t=[],i=g.getRootBagPath().getChildrenPathes(),n=0;n<e.paths.length;n++)for(var r=0;r<i.length;r++)if(i[r].isAParentOf(e.paths[n])){t.push(i[r]);break}t.length&&x.drawGrids({rootPaths:t})}}),h.onRefreshBeginToken=g.subscribe({event:"onRefreshBegin"},function(){l=!0,x.endEditMode()}),h.onRefreshCompletedToken=g.subscribe({event:"onRefreshCompleted"},function(){l=!1}),h.onRootAttachedToken=g.subscribe({event:"onRootAttached"},function(e){s&&!c&&x.drawGrids({rootPaths:[e.path]})}),h.onRootDetachedToken=g.subscribe({event:"onRootDetached"},function(e){s&&!c&&(x.endEditMode(),x.deleteGrids({rootPaths:[e.path],fromStorage:!1}))}),h.onLayoutComputedToken=g.subscribe({event:"onLayoutComputationBegin"},function(){s&&!c&&(x.endEditMode(),x.deleteGrids({rootPaths:g.getRootBagPath().getChildrenPathes(),fromStorage:!1}))}),h.onLayoutResetToken=g.subscribe({event:"onLayoutComputationEnd"},function(){s&&!c&&x.drawGrids({rootPaths:g.getRootBagPath().getChildrenPathes()})}),h.onModelUpdatedToken=g.subscribe({event:"onModelUpdated"},function(e){if(s&&!c){x.endEditMode();var t=[],i=g.getRootBagPath().getChildrenPathes();if(e.rootNodes){for(var n=0;n<e.rootNodes.length;n++)for(var r=0;r<i.length;r++)if(i[r].getLastElement(!0)===e.rootNodes[n]){t.push(i[r]);break}x.drawGrids({rootPaths:t})}else x.drawGrids({rootPaths:i})}}),v=m,h.onBackgroundModifyToken=f.onBackgroundModify(function(){s&&!c&&(x.endEditMode(),x.drawGrids({rootPaths:g.getRootBagPath().getChildrenPathes()}))}),a=0;a<u.length;a++){var C=n.getCommand(u[a],g.getCommandContext?g.getCommandContext():null);if(C&&C.isRunning()){m(C);break}}}else x&&(x.endEditMode(),x.deleteGrids({rootPaths:p,fromStorage:!1}),x.setActiveState(!1)),g.unsubscribe(h.onRefreshBeginToken),g.unsubscribe(h.onRefreshCompletedToken),g.unsubscribe(h.onRenderComplete),g.unsubscribe(h.onRootAddedToken),g.unsubscribe(h.onRootRemovedToken),g.unsubscribe(h.onRootAttachedToken),g.unsubscribe(h.onRootDetachedToken),g.unsubscribe(h.onLayoutComputedToken),g.unsubscribe(h.onLayoutResetToken),g.unsubscribe(h.onModelUpdatedToken),f.unsubscribe(h.onBackgroundModifyToken),f.unsubscribe(h.onViewerResizedToken),g.getFrameWindow().getImmersiveFrame().removeEventListener("freeZoneResize",y),h={},v=null}},this.getActiveState=function(){return s},this.clearController=function(){p.setActiveState(!1),g=f=u=x=p=null},this.hide3DGrids=function(){s&&!c&&x.setGridsVisibility({roots:g.getRootBagPath().getChildrenPathes(),flag:!1})},this.display3DGrids=function(){s&&!c&&x.setGridsVisibility({roots:g.getRootBagPath().getChildrenPathes(),flag:!0})}}}),s=[];return i.singleton({init:function(){},give3DGridController:function(e){if(e&&e.context)for(var t=0;t<s.length;t++)if(s[t].context===e.context)return s[t].gridController},get3DGridController:function(e){var t=this.give3DGridController(e);if(e&&e.context&&!t){var i=new d({ctxViewer:e.context});t={setActiveState:function(e){i&&i.setActiveState(e)},getActiveState:function(){if(i)return i.getActiveState()},clearController:function(){i&&(i.clearController(),i=null)},hide3DGrids:function(){i&&i.hide3DGrids()},display3DGrids:function(){i&&i.display3DGrids()}},s.push({context:e.context,gridController:Object.freeze(t)})}return t},unreference3DGridController:function(e){if(e&&e.context)for(var t=s.length-1;t>=0;t--)s[t].context===e.context&&(s[t].gridController.clearController(),s.splice(t,1))}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/CATRelatedData3DGrid/CATRelatedData3DGridController"],function(e,t,i){"use strict";return e.extend({init:function(e){this._parent(e,{});var n=this,r=null,a=this.onStateChange(function(){r||(r=t.get()),i.get3DGridController({context:r}).setActiveState(n.getState()),localStorage.setItem("CATRelatedData3DGridCmd",n.getState()?"true":"false")}),o=this._destroy;this._destroy=function(){r&&i.unreference3DGridController({context:r}),n._modelEvents.unsubscribe(a),o.call(n)};var d="true"===localStorage.getItem("CATRelatedData3DGridCmd");this.setState(d,!0),d&&require(["DS/CATWebUXComponents/CATWebUXUtils"],function(e){e._sendUsageProbe("commandCheck","3DGridOn")})},_destroy:function(){this._parent()}})});