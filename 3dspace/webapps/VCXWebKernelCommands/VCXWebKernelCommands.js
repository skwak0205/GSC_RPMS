define("DS/VCXWebKernelCommands/VCXCommand",["UWA/Class"],function(e){"use strict";return e.extend({init:function(){this._bLinkedCmd=!1,this._callback=null,this._parameter=null},SetCallback:function(e,t){this._callback=e,this._parameter=t},IsLinkedCmd:function(){return this._bLinkedCmd},SetLinkedCmd:function(e){this._bLinkedCmd=e},Do:function(){},Redo:function(){this.Do()},Undo:function(){this.Invert(),this.Do(),this.Invert()},Invert:function(){},SaveContext:function(){},IsMergeable:function(){return!1}})}),define("DS/VCXWebKernelCommands/VCXCommandManager",["DS/CoreEvents/Events","UWA/Class"],function(e,t){"use strict";var n=t.extend({initialize:function(){this._stackCmd=[],this._stackCmdUndo=[],this._isUnDoRunning=!1,this._isReDoRunning=!1,this._isDoRunning=!1,this._pushLevel=0,this._bTransaction=!1,this._stackLevelOfTransaction=[],this._stackMaxSize=500},unInitialize:function(){this._stackCmd=[],this._stackCmdUndo=[],this._isUnDoRunning=!1,this._isReDoRunning=!1,this._isDoRunning=!1,this._pushLevel=0,this._bTransaction=!1,this._stackLevelOfTransaction=[],this._stackMaxSize=500},postInitialize:function(){},SetStackMaxSize:function(e){this._stackMaxSize=e},GetStackMaxSize:function(){return this._stackMaxSize},Do:function(e){"VCXCmdChangeSelection"!==e.GetType()?(0===this._pushLevel&&(this._isDoRunning=!0),this._pushLevel++,e.Do(),this._pushLevel--,0===this._pushLevel&&(this._isDoRunning=!1)):e.Do()},Push:function(t){this._isUnDoRunning||(this._isReDoRunning||(this._isDoRunning?this.Do(t):(this._pushLevel>0&&t.SetLinkedCmd(!0),this._bTransaction&&(t=this.MergeTransaction(t)),this._stackCmdUndo=[],this._pushLevel++,this._stackCmd.length===this._stackMaxSize&&this._stackCmd.shift(),this._stackCmd.push(t),t.SaveContext(),t.Do(),this._pushLevel--,e.publish({event:"VCX_UNDOREDO_STACK_UPDATE"}))))},MergeTransaction:function(e){var t=e.GetType();if(!e.IsMergeable())return e;for(var n=this._stackLevelOfTransaction.length,i=this._stackLevelOfTransaction[n-1],o=null,a=this._stackCmd.length-1;a>=i;a--){var s=this._stackCmd[a];if(s)if(!s.IsLinkedCmd()){o=s;break}}return o?o.GetType()!==t?e:(this.Undo(!0),e=o.Merge(e)):e},Undo:function(t){if(t);else if(this._bTransaction)return void console.log("#### ERROR : undo inside a start transaction");this._isUnDoRunning=!0;for(var n=this._stackCmd.pop();n&&n.IsLinkedCmd();)n.Undo(),this._stackCmdUndo.push(n),n=this._stackCmd.pop();n&&(n.Undo(),this._stackCmdUndo.push(n)),this._isUnDoRunning=!1,this._bTransaction||e.publish({event:"VCX_UNDOREDO_DONE"})},Redo:function(){console.log("#### Redo"),this._isReDoRunning=!0;var t=this._stackCmdUndo.pop();for(t&&(this._stackCmd.push(t),t.Redo()),t=this._stackCmdUndo.pop();t&&t.IsLinkedCmd();)t.Redo(),this._stackCmd.push(t),t=this._stackCmdUndo.pop();t&&this._stackCmdUndo.push(t),this._isReDoRunning=!1,e.publish({event:"VCX_UNDOREDO_DONE"})},Empty:function(){this._stackCmd=[],this._stackCmdUndo=[],e.publish({event:"VCX_UNDOREDO_STACK_UPDATE"})},StartTransaction:function(){console.log("### startTransaction , undo stack size = ",this._stackCmd.length),this._bTransaction&&console.log("### ERROR : WE ARE ALREADY INSIDE A TRANSACTION ###"),this._bTransaction=!0,this._stackLevelOfTransaction.push(this._stackCmd.length),e.publish({event:"VCX_STARTED_TRANSACTION"})},EndTransaction:function(t){var n=this._stackLevelOfTransaction.pop();if(!(this._stackLevelOfTransaction.length>0))if(void 0!==n){for(var i=n+1;i<this._stackCmd.length;i++){this._stackCmd[i].SetLinkedCmd(!0)}if(n<this._stackCmd.length){var o=this._stackCmd[n];if(o){var a="Transaction commands";t&&(a=t),o.GetTitle=function(){return a}}}this._bTransaction=!1,console.log("### EndTransaction, undo stack size = ",this._stackCmd.length),e.publish({event:"VCX_END_TRANSACTION"})}else console.log("No index of start found here !")}});return Object.defineProperty(n.prototype,"componentType",{enumerable:!0,get:function(){return"VCXCommandManager"}}),n}),define("DS/VCXWebKernelCommands/VCXCmdChangeComponent",["DS/VCXWebKernelCommands/VCXCommand"],function(e){"use strict";return e.extend({init:function(e,t){this._parent(),this._commandManager=e,this._ComponentsMap=t,this._listCompToAdd=[],this._listCompToRemove=[],this._type="VCXCmdChangeComponent"},GetType:function(){return this._type},GetTitle:function(){return"Change component"},RemoveComponents:function(e){this._listCompToRemove=this._listCompToRemove.concat(e)},AddComponents:function(e){this._listCompToAdd=this._listCompToAdd.concat(e)},Do:function(){for(var e=0;e<this._listCompToAdd.length;e++){(n=this._listCompToAdd[e])&&this._ComponentsMap.AddComponent(n)}for(var t=0;t<this._listCompToRemove.length;t++){var n;if(n=this._listCompToRemove[t]){var i=this._listCompToRemove[t].GetID();this._ComponentsMap.RemoveComponent(i)}}},Invert:function(){var e=this._listCompToAdd;this._listCompToAdd=this._listCompToRemove,this._listCompToRemove=e}})}),define("DS/VCXWebKernelCommands/VCXCmdChangeModifiable",["DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebProperties/VCXPropertyMap"],function(e,t,n){"use strict";return t.extend({init:function(e){this._parent(),this._scenarioManager=e,this._modTracks={},this._styles={},this._neutrals=new n,this._listModToAdd=[],this._listModToRemove=[],this._bLockEvents=!1,this._type="VCXCmdChangeModifiable"},GetType:function(){return this._type},GetTitle:function(){return"Change modifiable"},RemoveModifiables:function(e){this._listModToRemove=this._listModToRemove.concat(e)},AddModifiables:function(e){this._listModToAdd=this._listModToAdd.concat(e)},Do:function(){for(var t=this._scenarioManager.ModifiableServer,n=this._scenarioManager.GetScenarios(),i=0;i<this._listModToAdd.length;i++){var o=this._listModToAdd[i];if(d=o.GetHashing()){var a=this._modTracks[d];if(a)for(var s in a)if(a.hasOwnProperty(s)){var r=a[s];this._scenarioManager.AddObjectAnimation(this._listModToAdd[i],n[s],r)}this._styles[d]&&o.SetStyle(this._styles[d])}t.AddModifiable(o);var c=this._neutrals.GetPropertySet(o.GetHashing());c&&this._scenarioManager.AddNeutrals(o,c)}for(var h=0;h<this._listModToRemove.length;h++){var _=this._listModToRemove[h];_.SetStyle("");var d=_.GetHashing(),u=this._scenarioManager.GetScenarios();for(var l in u)if(u.hasOwnProperty(l)){var C=u[l];this._scenarioManager.RemoveObjectAnimation(d,C)}this._scenarioManager.RemoveModifiableFromRestoreSet(d),t.RemoveModifiable(d),this._scenarioManager.RemoveNeutrals(d)}this._bLockEvents||(e.publish({event:"VCX_MODIFIABLE_CHANGED"}),e.publish({event:"VCX_KEYS_CHANGED"}))},Invert:function(){var e=this._listModToAdd;this._listModToAdd=this._listModToRemove,this._listModToRemove=e},SaveContext:function(){for(var e=this._scenarioManager.GetScenarios(),t=0;t<this._listModToRemove.length;t++){var n=!1,i={},o=this._listModToRemove[t],a=o.GetHashing();for(var s in this._styles[a]=o._styleID,e)if(e.hasOwnProperty(s)){var r=e[s].GetObjectAnimation(a);r&&(i[s]=r,n=!0)}n&&(this._modTracks[a]=i);var c=this._scenarioManager.GetNeutrals(a);c&&this._neutrals.AddOrModifyPropertySet(a,c)}},SetLockEvents:function(e){this._bLockEvents=e}})}),define("DS/VCXWebKernelCommands/VCXCmdApplyScenario",["DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebProperties/VCXPropertyMap"],function(e,t){"use strict";return e.extend({init:function(e){this._parent(),this._scenarioManager=e,this._propMapForUndo=new t,this._scenarioForDo=null,this._viewForUndo=null,this._bDoNotApplyVis=!1,this._type="VCXCmdApplyScenario"},GetType:function(){return this._type},GetTitle:function(){return"Apply scenario"},ApplyScenario:function(e,t,n){this._scenarioForDo=e,t&&(this._bDoNotApplyVis=t),n&&(this._viewForUndo=n)},Do:function(){var e=this._scenarioManager._experienceBase.getManager("VCXVisuManager");if(e&&(e.CameraControlsViewpoint=!0),this._scenarioManager.ApplyView(this._scenarioForDo,this._bDoNotApplyVis),e&&(e.CameraControlsViewpoint=!1),this._scenarioForDo.GetZoomFitAll()){var t=this._scenarioManager._experienceBase.getManager("VCXContextManager");t&&t.zoomFitAll()}},SaveContext:function(){this._viewForUndo||(this._viewForUndo=this._scenarioManager.CaptureCurrentView())},Redo:function(){this.Do()},Undo:function(){if(this._viewForUndo){var e=this._scenarioManager._experienceBase.getManager("VCXVisuManager");e&&(e.CameraControlsViewpoint=!0),this._scenarioManager.ApplyView(this._viewForUndo),e&&(e.CameraControlsViewpoint=!1)}}})}),define("DS/VCXWebKernelCommands/VCXCmdChangeTimePos",["DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCommand"],function(e,t){"use strict";return t.extend({init:function(e){this._parent(),this._scenarioManager=e,this._timePosForUndo=-1,this._timePosForDo=-1,this._scenarioForDoUndo=null,this._bLockEvents=!1,this._type="VCXCmdChangeTimePos",this._viewForUndo=null},GetType:function(){return this._type},GetTitle:function(){return"Change time position"},Do:function(){var t=!1,n=this._scenarioManager._experienceBase.getManager("VCXVisuManager");n&&(t=n.CameraControlsViewpoint,n.CameraControlsViewpoint=!0);var i=this._scenarioManager._experienceBase.ComponentsMap.GetComponentFromID(this._scenarioForDoUndo);i&&i.SetCurrentFrame(this._timePosForDo);this._scenarioManager._experienceBase.getManager("VCXCommandManager");if(this._scenarioManager.UpdateProperties(),this._bLockEvents);else{e.publish({event:"VCX_TIMEPOS_CHANGED",data:this._timePosForDo}),e.publish({event:"VCX_PROPERTIES_CHANGED"});var o=this._scenarioManager._experienceBase.getManager("VCXExperience");o&&o.SetVolatileNotSaved(!1)}n&&(n.CameraControlsViewpoint=t)},Undo:function(){this._scenarioManager._experienceBase.ComponentsMap.GetComponentFromID(this._scenarioForDoUndo).SetCurrentFrame(this._timePosForUndo),this._scenarioManager.ApplyView(this._viewForUndo,!0),this._bLockEvents||(e.publish({event:"VCX_TIMEPOS_CHANGED",data:this._timePosForUndo}),e.publish({event:"VCX_PROPERTIES_CHANGED"}))},SaveContext:function(){this._timePosForUndo=this._scenarioManager.GetCurrentFrame(),null===this._viewForUndo&&(this._viewForUndo=this._scenarioManager.CaptureCurrentView())},ChangeTimePos:function(e,t){this._scenarioForDoUndo=this._scenarioManager.GetCurrentScenario(),this._timePosForDo=e,t&&(this._timePosForUndo=t)},SetViewForUndo:function(e){this._viewForUndo=e},SetLockEvents:function(e){this._bLockEvents=e}})}),define("DS/VCXWebKernelCommands/VCXCmdPlayScenario",["DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebKernelCommands/VCXCmdApplyScenario"],function(e,t,n){"use strict";return t.extend({init:function(e,t,n){this._parent(),this._scenarioManager=e,this._componentsMap=t,this._commandManager=n,this._scenarioToPlay=null,this._type="VCXCmdPlayScenario",this._startFrame=0,this._bLockEvents=!1,this._playCurrent=!1,this._bDoNotApplyVis=!1,this._bIsBounce=!1,this._bIsLoop=!1,this._bIsReverse=!1,this._speed=1},GetType:function(){return this._type},GetTitle:function(){return"Play Scenario"},PlayScenario:function(e,t,n,i,o,a,s){this._scenarioToPlay=e,void 0!==t?this._startFrame=t:-1===t&&(this._startFrame=e.GetCurrentFrame()),n&&(this._bDoNotApplyVis=n),void 0!==o&&(this._bIsBounce=o),void 0!==i&&(this._bIsLoop=i),void 0!==a&&(this._bIsReverse=a),void 0!==s&&(this._speed=Math.round(s))},Do:function(){if(this._scenarioToPlay){var t=this,i=this._scenarioManager.PlayScenario(this._scenarioToPlay,this._startFrame,this._bIsLoop,this._bIsBounce,this._bIsReverse,this._speed);i&&this._scenarioToPlay.SetID(i);var o=new n(this._scenarioManager,this._commandManager);o.ApplyScenario(this._scenarioToPlay,this._bDoNotApplyVis),this._commandManager.Do(o),this._playEndEvent=e.subscribe({event:"VCX_SCENARIO_PLAY_END_REACHED"},function(n){t._scenarioToPlay.GetID()===n&&(e.unsubscribe(t._playEndEvent),e.publish({event:"VCX_END_PLAY_SCENARIO",data:n}),t._callback&&(t._callback(t._parameter),t._scenarioManager.SetCallback(null,null)))})}else e.publish({event:"VCX_END_PLAY_SCENARIO"})},StopPlayingScenario:function(){e.unsubscribe(this._playEndEvent),this._scenarioManager.StopPlayingScenario(this._scenarioToPlay.GetID()),this._callback&&(this._callback(this._parameter),this._scenarioManager.SetCallback(null,null))},Undo:function(){console.log("apply undo VCXCmdPlayScenario"),this.StopPlayingScenario()},Redo:function(){this.Do()},SaveContext:function(){},SetLockEvents:function(e){this._bLockEvents=e}})}),define("DS/VCXWebKernelCommands/VCXCmdGoToScenario",["DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebKernelCommands/VCXCmdChangeTimePos","DS/VCXWebKernelCommands/VCXCmdApplyScenario"],function(e,t,n,i){"use strict";return t.extend({init:function(e,t){this._parent(),this._scenarioManager=e,this._commandManager=t,this._bLockEvents=!1,this._bSetActiveScenario=!0,this._cmdApplyScenario=null,this._type="VCXCmdGoToScenario",this._viewForUndo=null},GetType:function(){return this._type},GetTitle:function(){return"Go to scenario"},GoToScenario:function(e,t){this._scenarioIdForDo=e,this._timePosForUndo=this._scenarioManager.GetCurrentFrame();this._scenarioManager._Scenarios[e];t&&(this._viewForUndo=t)},Do:function(){if(this._bSetActiveScenario){this._scenarioManager.SetCurrentScenario(this._scenarioIdForDo);var t=new n(this._scenarioManager);t.ChangeTimePos(0),t.SetLockEvents(this._bLockEvents),t.SetViewForUndo(this._viewForUndo),this._commandManager.Push(t);var o=this._scenarioManager._Scenarios[this._scenarioIdForDo];if(o){var a=new i(this._scenarioManager,this._commandManager);a.ApplyScenario(o,null,this._viewForUndo),this._commandManager.Push(a),this._bLockEvents||e.publish({event:"VCX_CURRENT_SCENARIO_CHANGED",data:o})}else console.log("VCXCmdGoToScenario : scenario NOT found !")}},SaveContext:function(){this._bSetActiveScenario&&(this._scenarioIdForUndo=this._scenarioManager.GetCurrentScenario(),""===this._scenarioIdForUndo&&console.log("No current scenario !!"))},Redo:function(){if(this._bLockEvents);else if(this._bSetActiveScenario){this._scenarioManager.SetCurrentScenario(this._scenarioIdForDo);var t=this._scenarioManager._Scenarios[this._scenarioIdForDo];e.publish({event:"VCX_CURRENT_SCENARIO_CHANGED",data:t})}},Undo:function(){if(this._bLockEvents);else if(this._bSetActiveScenario&&this._scenarioIdForUndo){this._scenarioManager.SetCurrentScenario(this._scenarioIdForUndo);var t=this._scenarioManager._Scenarios[this._scenarioIdForUndo];e.publish({event:"VCX_CURRENT_SCENARIO_CHANGED",data:t})}},SetLockEvents:function(e){this._bLockEvents=e},SetActiveScenario:function(e){this._bSetActiveScenario=e}})}),define("DS/VCXWebKernelCommands/VCXCmdChangeKeys",["DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebTracks/VCXKey","DS/VCXKeyFramer/VCXObjectAnimation","DS/VCXWebTracks/VCXTrack","DS/WebRBTree/WebRBIterator"],function(e,t,n,i,o,a){"use strict";return t.extend({init:function(e){this._parent(),this._scenarioManager=e,this._keysForDo=[],this._keysForUndo=[],this._bLockEvents=!1,this._bLockUpdateProperties=!1,this._bCloneValues=!0,this._type="VCXCmdChangeKeys"},GetType:function(){return this._type},GetTitle:function(){return"Change keys"},Do:function(){for(var t={setModifiablesTrackRemoved:{},setModifiablesTrackModified:{}},a=0;a<this._keysForDo.length;a++){var s=this._keysForDo[a],r=s.scenario.GetObjectAnimation(s.modifiable.GetHashing());if(r||s.value&&(r=new i,s.scenario.AddObjectAnimation(s.modifiable.GetHashing(),r)),r){var c=r.GetTrack(s.propertyName);if(c||s.value&&(c=new o,r.AddTrack(s.propertyName,c)),c){if(t.setModifiablesTrackModified[s.modifiable.GetHashing()]=!0,s.value){var h=new n;h.SetFrame(s.frame),h.SetEasing(s.easing),this._bCloneValues?h.SetValue(s.value.Clone()):h.SetValue(s.value),c.AddKey(h)}else c.RemoveKey(s.frame),c.IsEmpty()&&(r.RemoveTrack(s.propertyName),t.setModifiablesTrackRemoved[s.modifiable.GetHashing()]=!0,0===r.GetTrackNumber()&&s.scenario.RemoveObjectAnimation(s.modifiable.GetHashing()));this._bLockUpdateProperties||this._scenarioManager.UpdateProperty(s.modifiable.GetHashing(),s.propertyName)}}}this._bLockEvents||(t.keysForDo=this._keysForDo,e.publish({event:"VCX_KEYS_CHANGED",data:t}),e.publish({event:"VCX_PROPERTIES_CHANGED"}))},Invert:function(){var e=this._keysForDo;this._keysForDo=this._keysForUndo,this._keysForUndo=e},SaveContext:function(){for(var e=0;e<this._keysForDo.length;e++){var t=this._keysForDo[e],n=null;t.modifiable.GetHashing()?n=t.scenario.GetObjectAnimation(t.modifiable.GetHashing()):console.log("VCXCmdChangeKey: hashing is empty !");var i=null;if(n){var o=n.GetTrack(t.propertyName);if(o){var a=o.GetKey(t.frame);a&&a.GetFrame()===t.frame&&(i=a.GetValue().Clone())}}var s={};s.scenario=t.scenario,s.modifiable=t.modifiable,s.propertyName=t.propertyName,s.frame=t.frame,s.value=i,this._keysForUndo.push(s)}},ChangeKey:function(e,t,n,i,o,a){if(e){var s={};s.scenario=e,s.modifiable=t,s.propertyName=n,s.frame=i,s.easing=a,o&&(this._bCloneValues?s.value=o.Clone():s.value=o),this._keysForDo.push(s)}},MoveKey:function(e,t,n,i,o){if(null!==t){var a=null,s=e.GetObjectAnimation(t.GetHashing());if(s){var r=s.GetTrack(n);if(r){var c=r.GetKey(i);c&&(a=c.GetValue())}}a&&(this.ChangeKey(e,t,n,i,null),this.ChangeKey(e,t,n,o,a))}},RemoveTracks:function(e,t,n){var i=e.GetObjectAnimation(t.GetHashing());if(i){n&&n.length>0||(n=[],i.GetListTrackNames(n));for(var o=0;o<n.length;o++){var s=n[o],r=i.GetTrack(s);if(r)for(var c=r._treekeys,h=new a(c),_=h.next();null!==_;)this.ChangeKey(e,t,s,_.GetFrame()),_=h.next()}}},SetLockEvents:function(e){this._bLockEvents=e},SetLockUpdateProperties:function(e){this._bLockUpdateProperties=e},SetCloneValues:function(e){this._bCloneValues=e}})}),define("DS/VCXWebKernelCommands/VCXCmdGoToScenarioWithInterpolation",["DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebKernelCommands/VCXCmdGoToScenario","DS/VCXWebKernelCommands/VCXCmdPlayScenario","DS/VCXWebProperties/VCXPropertyMap","DS/VCXWebProperties/VCXPropertyValueFloat","DS/VCXKeyFramer/VCXObjectAnimation","DS/VCXWebTracks/VCXTrack","DS/VCXWebTracks/VCXKey","DS/VCXWebTracks/VCXEasing","DS/VCXWebVisibility/VCXIVisibility"],function(e,t,n,i,o,a,s,r,c,h,_){"use strict";return t.extend({init:function(e,t,n){this._parent(),this._scenarioManager=e,this._componentsMap=t,this._commandManager=n,this._scenarioForDo=null,this._scenarioTransition=null,this._wuxEventScenarioPlayed=null,this._bSetActiveScenario=!0,this._bLockEvents=!1,this._transitionTime=null,this._type="VCXCmdGoToScenarioWithInterpolation"},GetType:function(){return this._type},GetTitle:function(){return"Go To Scenario With Interpolation"},SetTransitionTime:function(e){this._transitionTime=e},Do:function(){var t=this._scenarioTransition.GetMaxFrame(),o=this._scenarioManager.GetTransitionTime();this._transitionTime&&(o=this._transitionTime),this._bLockEvents||e.publish({event:"VCX_BEGIN_TRANSITION",data:{maxframe:o/1e3,scenario:this._scenarioForDo}});var a=null;this._bSetActiveScenario&&((a=new n(this._scenarioManager,this._commandManager)).GoToScenario(this._scenarioForDo.GetID(),this._viewForUndo),a.SetActiveScenario(this._bSetActiveScenario));var s=this._scenarioManager._experienceBase.getManager("VCXVisuManager");s&&s.setTransitionMode(!0);var r=this._scenarioManager.GetFPS();if(this._scenarioManager.SetFPS(50),0!=o){var c=t/(o/1e3);this._scenarioManager.SetFPS(c)}var h=this._scenarioManager.GetInterFramesMax();this._scenarioManager.SetInterFramesMax(-1);var _=new i(this._scenarioManager,this._componentsMap,this._commandManager);_.PlayScenario(this._scenarioTransition),this._commandManager.Do(_);var d=function(){this._scenarioManager.SetInterFramesMax(h),this._scenarioManager.SetFPS(r),e.unsubscribe(this._wuxEventScenarioPlayed),a&&(a.SetLinkedCmd(!0),this._commandManager.Push(a)),s&&s.setTransitionMode(!1),this._scenarioManager._experienceBase.getManager("VCXExperience").getAllActorsReadiness().then(function(){this._bLockEvents||e.publish({event:"VCX_END_TRANSITION",data:this._scenarioForDo}),this._callback&&this._callback(this._parameter)}.bind(this))}.bind(this);this._wuxEventScenarioPlayed=e.subscribe({event:"VCX_END_PLAY_SCENARIO"},function(e){"VCX_Scenario_Transition"===e&&d()})},Undo:function(){},Redo:function(){},SaveContext:function(){this._viewForUndo=this._scenarioManager.CaptureCurrentView()},BuildTransitionTo:function(e){this._scenarioForDo=e,this._scenarioTransition=this.BuildScenarioForTransition(this._scenarioForDo),this._scenarioTransition.SetID("VCX_Scenario_Transition")},BuildScenarioForTransition:function(e){console.time("BuildScenarioForTransition");var t=this._scenarioManager._experienceBase,n=t.Factory.BuildComponent("VCXScenario");n.SetPersistency(2),n.SetApplyNeutralAtGoToScenario(!1),n.SetIsTransition(!0);var i=new o,d={propMapDiffNeutrals:i},u=this._scenarioManager.CaptureCurrentView(d),l=t.getManager("VCXVisuManager");if(l&&(l.CameraControlsViewpoint=!0),_.lockVisibilityOpacity=!0,this._scenarioManager.ApplyView(e),_.lockVisibilityOpacity=!1,e.GetZoomFitAll()){var C=this._scenarioManager._experienceBase.getManager("VCXContextManager");C&&C.zoomFitAll()}l&&(l.CameraControlsViewpoint=!1);var m=new o;for(var p in this._scenarioManager.CaptureDiffOfNeutrals(m,!0),i._map)if(i._map.hasOwnProperty(p)){var v=this._scenarioManager.ModifiableServer.GetModifiableFromHashing(p),f=i.GetPropertySet(p);for(var g in f._map)if(f._map.hasOwnProperty(g)){if(m.GetProperty(p,g))continue;var S=v.GetProperty(g);S&&m.AddOrModifyProperty(p,S)}}_.lockVisibilityOpacity=!0,this._scenarioManager.ApplyView(u),_.lockVisibilityOpacity=!1;var M=n.GetVisibility(),y=!1,b=null;if(l&&(b=l.getActiveViewport()),b){var V=b.QueryInterface("VCXIModifiable"),T=V.GetProperties(!1),D=m.GetPropertySet(V.GetHashing());D&&T&&(T.IsEqualTo(D,{intersection:!0})||(y=!0))}for(var X in m._map)if(m._map.hasOwnProperty(X)){var A=this._scenarioManager.ModifiableServer.GetModifiableFromHashing(X),P=A.GetObject(),k=A.GetRequiredPropertiesForTransition(),I=m.GetPropertySet(X);for(var g in I._map)if(I._map.hasOwnProperty(g)){var G=A.GetProperty(g);if(G){var E=G.GetPropertyValue(),R=I.GetProperty(g).GetPropertyValue();if(!E.IsEqualTo(R)||k&&k.hasOwnProperty(g)){if(!0===E._bUndefined)continue;if((Y=n.GetObjectAnimation(X))||(Y=new s,void 0===X&&(this._scenarioManager.ModifiableServer.AddModifiable(A),console.log("hashing is undefined")),n.AddObjectAnimation(X,Y)),(W=Y.GetTrack(g))||(W=new r,Y.AddTrack(g,W)),(P.IsKindOf("VCXWebComponentCamera")||P.IsKindOf("CXPCameraActor_Spec")||P.IsKindOf("VCXViewport_Spec"))&&y){W.easing=h.easeInOutPower3,(Z=new c).SetFrame(0),Z.SetValue(E),W.AddKey(Z),(H=new c).SetFrame(60),H.SetValue(R),W.AddKey(H)}else{var F=E.GetType();if("VCXPropertyValueLocation"!==F&&"VCXPropertyValueFrame"!==F&&"VCXPropertyValueFloat"!==F&&"VCXPropertyValuePoint2D"!==F&&"VCXPropertyValueVector"!==F||(W.easing=h.easeInOutPower3),(Z=new c).SetFrame(0),Z.SetValue(E),(H=new c).SetValue(R),!P.IsKindOf("CXPCameraActor_Spec"))if(z=A.QueryInterface("VCXIVisibility"))z.GetVisibility()===_.EVisState.Hidden&&Z.SetValue(R);if(N=e.GetVisibility()){var L=N.IsVisibleWithParents(A.GetObject()),x=N.GetMode(),w=0;(1===L||-1===L&&2===x||-1===L&&0===x||0===L&&1===x)&&(w=1),0===w&&H.SetValue(E)}if(y)($=new c).SetFrame(60),$.SetValue(Z.GetValue()),W.AddKey($),H.SetFrame(120);else H.SetFrame(60);W.AddKey(H),W.AddKey(Z)}}}}}var N,q=e;if(q&&(N=q.GetVisibility())){for(var O=t.ComponentsMap.GetComponentFromType("VCXWebComponentOccurrence"),U=(x=N.GetMode(),0);U<O.length;U++){if(j=O[U]){if(0!==j.QueryInterface("VCXIModelNavigable").getChildren().length)continue;var K=1;w=1;if(z=j.QueryInterface("VCXIVisibility")){w=K=z.GetVisibility()!==_.EVisState.Hidden?1:0;L=N.IsVisibleWithParents(j);if(0===x?1===L?w=1:0===L&&(w=0):1===x?w=1===L?1:0:2===x&&(w=0===L?0:1),K!==w){M.AddVisible(j),(J=j.QueryInterface("VCXIModifiable")).GetHashing()||this._scenarioManager.ModifiableServer.AddModifiable(J);var W=new r;null===(Y=n.GetObjectAnimation(J.GetHashing()))&&(Y=new s,n.AddObjectAnimation(J.GetHashing(),Y)),Y.AddTrack("Actor.Visibility.Opacity",W),(Z=new c).SetFrame(0),(E=new a).SetValue(K),Z.SetValue(E),($=new c).SetValue(Z.GetValue());var H=new c;(R=new a).SetValue(w),H.SetValue(R),1===K&&0===w?y?($.SetFrame(60),H.SetFrame(75)):($.SetFrame(0),H.SetFrame(15)):0===K&&1===w?y?($.SetFrame(105),H.SetFrame(120)):($.SetFrame(45),H.SetFrame(60)):($.SetFrame(0),H.SetFrame(135)),W.AddKey(Z),W.AddKey($),W.AddKey(H)}}}}var B=t.getManager("VCXDressupManager").getDressups();for(var Q in B){var j;if(B.hasOwnProperty(Q))if(j=B[Q]){var z;K=1,w=1;if(z=j.QueryInterface("VCXIVisibility"))if(K=z.GetVisibility()!==_.EVisState.Hidden?1:0,N.FindVisibleCollab(j.GetID())>=0?w=1:(q.GetApplyNeutralAtGoToScenario()||q.GetIsTransition()||0===K)&&(w=0),0!==K||0!==w){var J=j.QueryInterface("VCXIModifiable");M.AddVisibleCollab(j);var Y,Z,$;W=new r;null===(Y=n.GetObjectAnimation(J.GetHashing()))&&(Y=new s,n.AddObjectAnimation(J.GetHashing(),Y)),Y.AddTrack("Actor.Visibility.Opacity",W),(Z=new c).SetFrame(0),(E=new a).SetValue(K),Z.SetValue(E),($=new c).SetValue(Z.GetValue());H=new c;(R=new a).SetValue(w),H.SetValue(R),1===K&&0===w?y?($.SetFrame(60),H.SetFrame(75)):($.SetFrame(0),H.SetFrame(15)):0===K&&1===w?y?($.SetFrame(120),H.SetFrame(135)):($.SetFrame(60),H.SetFrame(75)):($.SetFrame(0),H.SetFrame(135)),W.AddKey(Z),W.AddKey($),W.AddKey(H)}}}}return console.timeEnd("BuildScenarioForTransition"),n},SetActiveScenario:function(e){this._bSetActiveScenario=e},SetLockEvents:function(e){this._bLockEvents=e}})}),define("DS/VCXWebKernelCommands/VCXCmdChangePropertyMap",["DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebProperties/VCXProperty","DS/VCXWebProperties/VCXPropertyInfo","DS/VCXWebProperties/VCXPropertySet"],function(e,t,n,i){"use strict";return e.extend({init:function(){this._parent(),this._keysForDo=[],this._keysForUndo=[],this._type="VCXCmdChangePropertyMap"},GetType:function(){return this._type},GetTitle:function(){return"Change property map"},Do:function(){for(var e=0;e<this._keysForDo.length;e++){var o=this._keysForDo[e],a=o.propertyMap.GetPropertySet(o.modifiable.GetHashing());if(a||o.value&&(a=new i,o.propertyMap.AddOrModifyPropertySet(o.modifiable.GetHashing(),a)),a)if(s=a.GetProperty(o.propertyName))o.value?s.SetPropertyValue(o.value.Clone()):(a.RemoveProperty(o.propertyName),0===a.GetPropertyNumber()&&o.propertyMap.RemovePropertySet(o.modifiable.GetHashing()));else if(o.value){var s=new t(new n(o.propertyName),o.value.Clone());o.propertyMap.AddOrModifyProperty(o.modifiable.GetHashing(),s)}}},Invert:function(){var e=this._keysForDo;this._keysForDo=this._keysForUndo,this._keysForUndo=e},SaveContext:function(){for(var e=0;e<this._keysForDo.length;e++){var t=this._keysForDo[e],n=null,i=null,o=t.modifiable.GetHashing();if(o?i=t.propertyMap.GetPropertySet(o):console.log("VCXCmdChangePropertyMap: hashing is empty !"),i){var a=i.GetProperty(t.propertyName);a&&(n=a.GetPropertyValue().Clone())}var s={};s.propertyMap=t.propertyMap,s.modifiable=t.modifiable,s.propertyName=t.propertyName,s.value=n,this._keysForUndo.push(s)}},ChangeProperty:function(e,t,n,i){var o={};o.propertyMap=e,o.modifiable=t,o.propertyName=n,i&&(o.value=i.Clone()),this._keysForDo.push(o)}})}),define("DS/VCXWebKernelCommands/VCXCmdChangeNeutralProperties",["DS/VCXWebKernelCommands/VCXCmdChangePropertyMap"],function(e){"use strict";return e.extend({init:function(e){this.neutrals=e._keyframer._Neutrals,this._parent(),this._type="VCXCmdChangeNeutrals"},GetType:function(){return this._type},GetTitle:function(){return"Change neutral properties"},ChangeProperty:function(e,t,n){this._parent(this.neutrals,e,t,n)},CaptureNeutralProperties:function(e){var t=e.GetProperties();if(t)for(var n in t._map)if(t._map.hasOwnProperty(n)){var i=t.GetProperty(n);i&&this.ChangeProperty(e,n,i.GetPropertyValue())}}})}),define("DS/VCXWebKernelCommands/VCXCmdChangeLinkedProperties",["DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebKernelCommands/VCXCmdChangeNeutralProperties"],function(e,t,n){"use strict";return t.extend({init:function(e,t,n){this._linkedPropertyManager=e,this._scenarioManager=t,this._commandManager=n,this._parent(),this._linksToAdd=[],this._linksToRemove=[],this._type="VCXCmdChangeLinkedProperties"},GetType:function(){return this._type},GetTitle:function(){return"Modify properties links"},Do:function(){if(this._linksToRemove.length>0){for(var t=0;t<this._linksToRemove.length;t++){this._linksToRemove[t].converter=this._linkedPropertyManager.RemoveLink(this._linksToRemove[t].inID,this._linksToRemove[t].inProp,this._linksToRemove[t].outID,this._linksToRemove[t].outProp);var i=this._scenarioManager._keyframer._Neutrals;if(r=this._scenarioManager._experienceBase.ComponentsMap.GetComponentFromID(this._linksToRemove[t].outID))if(c=r.QueryInterface("VCXIModifiable")){var o=i.GetProperty(c.GetHashing(),this._linksToRemove[t].outProp);if(o){var a=o.GetPropertyValue();c.OnChangeProperty(this._linksToRemove[t].outProp,a)}this._scenarioManager.UpdateProperties(c.GetHashing(),this._linksToRemove[t].outProp),c.OnChangePropertiesEnd()}}e.publish({event:"VCX_LINKS_REMOVED"})}if(this._linksToAdd.length>0){var s=new n(this._scenarioManager);for(i=this._scenarioManager._keyframer._Neutrals,t=0;t<this._linksToAdd.length;t++){var r,c;if(this._linkedPropertyManager.AddLink(this._linksToAdd[t].inID,this._linksToAdd[t].inProp,this._linksToAdd[t].outID,this._linksToAdd[t].outProp,this._linksToAdd[t].converter),r=this._scenarioManager._experienceBase.ComponentsMap.GetComponentFromID(this._linksToAdd[t].outID))if(c=r.QueryInterface("VCXIModifiable"))if(i.GetProperty(c.GetHashing(),this._linksToAdd[t].outProp));else{var h=c.GetProperty(this._linksToAdd[t].outProp);h&&s.ChangeProperty(c,this._linksToAdd[t].outProp,h.GetPropertyValue())}}this._commandManager.Push(s),e.publish({event:"VCX_LINKS_ADDED"})}this._linkedPropertyManager.UpdateProperties(),e.publish({event:"VCX_PROPERTIES_CHANGED"})},Invert:function(){var e=this._linksToAdd;this._linksToAdd=this._linksToRemove,this._linksToRemove=e},AddLink:function(e,t,n,i,o){var a={inID:e,inProp:t,outID:n,outProp:i,converter:o};this._linksToAdd.push(a)},RemoveLink:function(e,t,n,i){var o={inID:e,inProp:t,outID:n,outProp:i};this._linksToRemove.push(o)},RemoveLinksFromPropertyName:function(e,t){var n=this._linkedPropertyManager.GetLinksFromPropertyName(e,t);this._linksToRemove=this._linksToRemove.concat(n)},RemoveLinks:function(e){this._linksToRemove=this._linksToRemove.concat(e)}})}),define("DS/VCXWebKernelCommands/VCXCmdReplaceScenario",["DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebProperties/VCXPropertyMap","DS/VCXWebKernelCommands/VCXCmdChangeNeutralProperties","DS/VCXWebExperienceLoader/VCXExperienceSaverBase"],function(e,t,n,i,o){"use strict";return t.extend({init:function(e){this._parent(),this._scenarioManager=e,this._scenarioToModify=null,this._dataForDo={},this._dataForUndo={},this._bLockEvents=!1,this._type="VCXCmdReplaceScenario"},GetType:function(){return this._type},GetTitle:function(){return"Replace scenario"},ReplaceScenario:function(e,t){this._scenarioToModify=e;var n=t.QueryInterface("VCXIModifiable"),i=this._scenarioManager.GetNeutrals(n.GetHashing());this._dataForDo.neutrals=i.Clone(),this._dataForDo.scenario=t.Clone()},Do:function(){var t=this._scenarioToModify.QueryInterface("VCXIModifiable");this._scenarioManager.RemoveNeutrals(t.GetHashing()),this._scenarioManager.AddNeutrals(t,this._dataForDo.neutrals.Clone()),this._dataForDo.scenario.Clone(this._scenarioToModify);var n=this._scenarioManager._experienceBase,a=n.getManager("VCXCAT3DXModelManager"),s=n.getManager("VCXContextManager").IsLocalMode();if(a&&!s){var r=n.getManager("VCXDocManager").actorDocManager.QueryInterface("VCXIModifiable"),c=new i(n.getManager("VCXScenarioManager"));c.CaptureNeutralProperties(r),c.Do();var h=this._scenarioToModify.GetID(),_="",d=n.getManager("VCXSequenceManager").GetSequenceFromScenarioId(h);d&&(_=d.GetID());var u=new o,l=u._ScenarioToJson(n,this._scenarioToModify),C=u._VisibilityToJson(this._scenarioToModify.GetVisibility(),n);l.visibility=C;var m=[];m.push(l);var p={};p.listScenarios=m;var v=JSON.stringify(p,null,4),f={};f.neutrals=u._NeutralsToJson(n);var g=JSON.stringify(f,null,4),S=a.UpdateState(h,_,g,v).then(function(){console.log("--------\x3e vcxCAT3DXModelManager.UpdateState DONE")}),M=this._scenarioToModify.QueryInterface("VCXIReadiness");M&&(M.clearPromises(),M.registerPromise(S),console.log("--------\x3e registerPromise for vcxCAT3DXModelManager.UpdateState................"))}this._bLockEvents||e.publish({event:"VCX_SCENARIO_REPLACED",data:this._scenarioToModify})},SaveContext:function(){var e=this._scenarioToModify.QueryInterface("VCXIModifiable"),t=this._scenarioManager.GetNeutrals(e.GetHashing());this._dataForUndo.neutrals=t.Clone(),this._dataForUndo.scenario=this._scenarioToModify.Clone()},Invert:function(){var e=this._dataForDo;this._dataForDo=this._dataForUndo,this._dataForUndo=e},SetLockEvents:function(e){this._bLockEvents=e}})}),define("DS/VCXWebKernelCommands/VCXCmdChangePropertiesVolatile",["DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebProperties/VCXPropertyMap"],function(e,t,n){"use strict";return t.extend({init:function(){this._parent(),this._propertyMap=new n,this._propertyMapOld=new n,this._mapModifiables={},this._bLockEvents=!1,this._type="VCXCmdChangePropertiesVolatile"},GetType:function(){return this._type},GetTitle:function(){return"Change properties volatile"},ChangeProperties:function(e){for(var t in e._map)if(e._map.hasOwnProperty(t)){var n=this._mapModifiables[t],i=e.GetPropertySet(t);if(i._map.hasOwnProperty("Modifiable.StyleID")){var o=i._map["Modifiable.StyleID"];n.OnChangeProperty("Modifiable.StyleID",o.GetPropertyValue())}for(var a in i._map)if(i._map.hasOwnProperty(a)){if("Modifiable.StyleID"==a)continue;o=i._map[a];n.OnChangeProperty(a,o.GetPropertyValue())}n.OnChangePropertiesEnd()}},Do:function(){this.ChangeProperties(this._propertyMap);this._bLockEvents||e.publish({event:"VCX_PROPERTIES_CHANGED",data:this._propertyMap}),this._callback&&this._callback(this._parameter)},Invert:function(){var e=this._propertyMap;this._propertyMap=this._propertyMapOld,this._propertyMapOld=e},SaveContext:function(){for(var e in this._propertyMap._map)if(this._propertyMap._map.hasOwnProperty(e)){var t=this._mapModifiables[e],n=this._propertyMap.GetPropertySet(e);for(var i in n._map)if(n._map.hasOwnProperty(i)){var o=t.GetProperty(i);this._propertyMapOld.AddOrModifyProperty(e,o)}}},ChangeProperty:function(e,t){var n=e.GetHashing();this._mapModifiables[n]=e,this._propertyMap.AddOrModifyProperty(n,t.Clone())},SetLockEvents:function(e){this._bLockEvents=e}})}),define("DS/VCXWebKernelCommands/VCXCmdChangeScenario",["DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebKernelCommands/VCXCmdChangeModifiable","DS/VCXWebKernelCommands/VCXCmdChangeComponent"],function(e,t,n,i){"use strict";return t.extend({init:function(e,t,n){this._parent(),this._scenarioManager=e,this._commandManager=t,this._ComponentsMap=n,this._scenariosToAdd=[],this._scenariosToRemove=[],this._bLockEvents=!1,this._type="VCXCmdChangeScenario"},GetType:function(){return this._type},GetTitle:function(){return"Change scenario"},AddScenarios:function(e){this._scenariosToAdd=this._scenariosToAdd.concat(e)},RemoveScenarios:function(e){this._scenariosToRemove=this._scenariosToRemove.concat(e)},Do:function(){var t=this,o=new n(this._scenarioManager),a=new i(this._commandManager,this._ComponentsMap);if(this._scenariosToAdd.forEach(function(e){a.AddComponents(e),o.AddModifiables(e.QueryInterface("VCXIModifiable"))}),this._scenariosToRemove.forEach(function(e){a.RemoveComponents(e),o.RemoveModifiables(e.QueryInterface("VCXIModifiable"))}),this._commandManager.Push(a),this._commandManager.Push(o),this._scenariosToAdd.forEach(function(e){t._scenarioManager.AddScenario2(e)}),this._scenariosToRemove.forEach(function(e){t._scenarioManager.RemoveScenario(e.GetID())}),this._bLockEvents);else{var s={arrayToAdd:this._scenariosToAdd,arrayToRemove:this._scenariosToRemove};e.publish({event:"VCX_SCENARIOS_CHANGED",data:s})}},Undo:function(){var t=this;if(this._scenariosToAdd.forEach(function(e){t._scenarioManager.RemoveScenario(e.GetID())}),this._scenariosToRemove.forEach(function(e){t._scenarioManager.AddScenario2(e)}),this._bLockEvents);else{var n={arrayToAdd:this._scenariosToRemove,arrayToRemove:this._scenariosToAdd};e.publish({event:"VCX_SCENARIOS_CHANGED",data:n})}},Redo:function(){var t=this;if(this._scenariosToAdd.forEach(function(e){t._scenarioManager.AddScenario2(e)}),this._scenariosToRemove.forEach(function(e){t._scenarioManager.RemoveScenario(e.GetID())}),this._bLockEvents);else{var n={arrayToAdd:this._scenariosToAdd,arrayToRemove:this._scenariosToRemove};e.publish({event:"VCX_SCENARIOS_CHANGED",data:n})}},SetLockEvents:function(e){this._bLockEvents=e}})}),define("DS/VCXWebKernelCommands/VCXCmdUpdateThumbnail",["DS/VCXWebKernelCommands/VCXCommand"],function(e){"use strict";return e.extend({init:function(e,t,n){this._parent(),this._experienceBase=e,this._scenario=t,this._type="VCXCmdUpdateThumbnail",this._noLatency=n},GetType:function(){return this._type},GetTitle:function(){return"Update Thumbnail"},Do:function(){this._experienceBase&&this._experienceBase.getManager("VCXExperience").UpdateScenarioThumbnail(this._scenario,this._noLatency)}})}),define("DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey",["DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebProperties/VCXPropertyMap","DS/VCXWebKernelCommands/VCXCmdChangePropertiesVolatile","DS/VCXWebKernelCommands/VCXCmdChangeKeys","DS/VCXWebKernelCommands/VCXCmdChangeNeutralProperties","DS/VCXWebKernelCommands/VCXCmdUpdateThumbnail"],function(e,t,n,i,o,a){"use strict";var s=e.extend({init:function(e,n,i){this._parent(),this.ImmediateThumbnail=!1,this._propertyMap=new t,this._scenarioManager=e,this._commandManager=n,this._bForceAutokey=i,this._bLockEvents=!1,this._type="VCXCmdChangePropertiesAutokey",this._bLockUpdateThumbnail=!1},GetType:function(){return this._type},GetTitle:function(){return"Change properties autokey"},Do:function(){var e=this._scenarioManager.GetCurrentFrame(),t=this._scenarioManager.GetAutoKey(),s=this._scenarioManager._keyframer._Neutrals,r=this._scenarioManager.GetCurrentScenario(),c=this._scenarioManager._Scenarios[r],h=new i(this._scenarioManager),_=new n,d=new o(this._scenarioManager);for(var u in this._propertyMap._map)if(this._propertyMap._map.hasOwnProperty(u)){var l=this._scenarioManager.ModifiableServer.GetModifiableFromHashing(u),C=this._propertyMap.GetPropertySet(u);for(var m in C._map)if(C._map.hasOwnProperty(m)){var p=C._map[m],v=p.GetPropertyInfo().GetBehaviorType(),f=p.GetPropertyInfo().IsPersistent();if(f)if(2===v)d.ChangeProperty(l,m,p.GetPropertyValue());else if(s.GetProperty(u,m));else{var g=l.GetProperty(m);g&&d.ChangeProperty(l,m,g.GetPropertyValue())}if(_.ChangeProperty(l,p),f&&2!==v&&(t||this._bForceAutokey)){var S=e;1===v&&(S=0),c&&h.ChangeKey(c,l,m,S,p.GetPropertyValue())}}}if(this._bLockEvents&&(_.SetLockEvents(this._bLockEvents),h.SetLockEvents(this._bLockEvents)),0===e&&(t||this._bForceAutokey)&&this._scenarioManager._experienceBase.getManager("VCXExperience")&&c&&!this._bLockUpdateThumbnail){var M=new a(this._scenarioManager._experienceBase,c,this.ImmediateThumbnail);this._commandManager.Push(M)}if(this._commandManager.Push(_),this._commandManager.Push(h),this._commandManager.Push(d),0===e&&(t||this._bForceAutokey)&&this._scenarioManager._experienceBase.getManager("VCXExperience")&&c&&!this._bLockUpdateThumbnail){M=new a(this._scenarioManager._experienceBase,c,this.ImmediateThumbnail);this._commandManager.Push(M)}},Redo:function(){},Undo:function(){},Invert:function(){},SaveContext:function(){},ChangeProperty:function(e,t){var n=e.GetHashing();n||(this._scenarioManager.ModifiableServer.AddModifiable(e),n=e.GetHashing()),this._propertyMap.AddOrModifyProperty(n,t.Clone())},ChangePropertiesFromMap:function(e){this._propertyMap=e.Clone()},Merge:function(e){if(e){var t=new s(this._scenarioManager,this._commandManager),n=this._propertyMap.Clone(),i=e._propertyMap;return n.Merge(i),t.ChangePropertiesFromMap(n),t}},SetLockEvents:function(e){this._bLockEvents=e},IsMergeable:function(){return!0}});return s}),define("DS/VCXWebKernelCommands/VCXCmdChangePropertiesWithAnimation",["DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebProperties/VCXPropertyMap","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/VCXWebKernelCommands/VCXCmdGoToScenarioWithInterpolation"],function(e,t,n,i,o){"use strict";return t.extend({init:function(e,t,i){this._parent(),this._scenarioManager=e,this._componentsMap=t,this._commandManager=i,this._propertyMap=new n,this._scenarioTarget=null,this.easingFunctions={},this._bLockEvents=!1,this._transitionTime=null,this._type="VCXCmdChangePropertiesWithAnimation"},GetType:function(){return this._type},GetTitle:function(){return"Change properties with animation"},SetTransitionTime:function(e){this._transitionTime=e},Do:function(){var e=this._scenarioManager._experienceBase.getManager("VCXContextManager").getActiveCamera();if(e){var t=e.QueryInterface("VCXIViewpointController");t&&t.fromViewpoint()}this._scenarioTarget=this._scenarioManager.CaptureCurrentView({bIsPartialView:!0}),this._scenarioTarget.SetPropertyMapAtFrame(this._propertyMap,0);var n=new o(this._scenarioManager,this._componentsMap,this._commandManager);n.SetActiveScenario(!1),n.SetCallback(this._callback,this._parameter),n.SetLockEvents(this._bLockEvents),this._transitionTime&&n.SetTransitionTime(this._transitionTime);var a=n.BuildTransitionTo(this._scenarioTarget);if(a){var s=a._animations;for(var r in s)if(s.hasOwnProperty(r)){var c=s[r];if(c)for(var h in c._Tracks)if(c._Tracks.hasOwnProperty(h)){var _=c._Tracks[h],d=this.easingFunctions[r];if(d){var u=d[h];u&&(_.easing=u)}}}}var l=new i(this._scenarioManager,this._commandManager);l.ChangePropertiesFromMap(this._propertyMap),l.SetLockEvents(!0),this._commandManager.Push(l),this._commandManager.Do(n)},Undo:function(){this._bLockEvents||e.publish({event:"VCX_PROPERTIES_CHANGED"})},Redo:function(){this._bLockEvents||e.publish({event:"VCX_PROPERTIES_CHANGED"})},SaveContext:function(){},ChangeProperty:function(e,t,n){var i=e.GetHashing();if(i||(this._scenarioManager.ModifiableServer.AddModifiable(e),i=e.GetHashing()),this._propertyMap.AddOrModifyProperty(i,t.Clone()),n){var o=t.GetPropertyInfo().GetPropertyName(),a=this.easingFunctions[i];a||(a={},this.easingFunctions[i]=a),a[o]=n}},SetLockEvents:function(e){this._bLockEvents=e}})}),define("DS/VCXWebKernelCommands/VCXCmdChangeVisibility",["DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebProperties/VCXPropertyMap","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/VCXWebVisibility/VCXIVisibility"],function(e,t,n,i,o){"use strict";return t.extend({init:function(e,t,i){this._parent(),this._scenarioManager=e,this._componentsMap=t,this._commandManager=i,this._propertyMap=new n,this._listChange=[],this._visibility=o.EVisState.Hidden,this._type="VCXCmdChangeVisibility"},GetType:function(){return this._type},GetTitle:function(){return"Change Visibility"},_switchListChangeVisibilityIfNeeded:function(e,t){var n=t;if("boolean"==typeof t&&(console.warn("There shouldn't be a boolean in argument for this method. Use instead a Number, with 0 for hidden, 1 for visible."),n=t?o.EVisState.Visible:o.EVisState.Hidden),n===e)for(var i=0;i<this._listChange.length;++i){var a=this._listChange[i];if(a){var s=a.QueryInterface("VCXIVisibility");s&&s.SetVisibility(e)}}},Do:function(){if(0!==this._listChange.length){if(this._switchListChangeVisibilityIfNeeded(o.EVisState.Visible,this._visibility),this._switchListChangeVisibilityIfNeeded(o.EVisState.Hidden,this._visibility),this._scenarioManager.GetAutoKey()){var t=this._scenarioManager.GetCurrentScenario(),n=this._scenarioManager._Scenarios[t];this._scenarioManager.CaptureCurrentVisibility(n),this._scenarioManager._experienceBase.getManager("VCXExperience")&&this._scenarioManager._experienceBase.getManager("VCXExperience").UpdateScenarioThumbnail(n)}for(var i,a=0;a<this._listChange.length;++a){var s=this._listChange[a];if(s&&!i){(i=s._experienceBase.getManager("VCXContextManager")).traverseGraphMustBePerformed=!0;break}}this._scenarioManager._experienceBase.getManager("VCXContextManager").getFrameWindow().getContextualUIManager().hideContextualMenus(),this._bLockEvents||e.publish({event:"VCX_VISIBILITY_CHANGED",data:{components:this._listChange.slice(),visibility:this._visibility}})}else console.log("nothing to change visibility on")},Invert:function(){var e=this._visibility===o.EVisState.Hidden;this._visibility=e?o.EVisState.Visible:o.EVisState.Hidden},SaveContext:function(){},ChangeVisibility:function(e,t){for(var n=0;n<e.length;n++){var i=e[n];if(i){var o=i.QueryInterface("VCXIVisibility");o&&o.GetVisibility()!==t&&this._listChange.push(i)}}this._visibility=t},SetLockEvents:function(e){this._bLockEvents=e}})}),define("DS/VCXWebKernelCommands/VCXCmdChangeScenarioSequence",["DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebKernelCommands/VCXCmdChangeScenario","DS/VCXWebExperienceLoader/VCXExperienceSaverBase","DS/VCXWebKernelCommands/VCXCmdChangeNeutralProperties"],function(e,t,n,i,o){"use strict";return t.extend({init:function(e,t,n){this._parent(),this._sequenceManager=e,this._commandManager=t,this._ComponentsMap=n,this._scenarioToAdd=null,this._scenarioToRemove=null,this._sequenceIDForAdd="",this._sequenceIDForRemove="",this._scenarioAddIdx=-1,this._scenarioRemoveIdx=-1,this._bPush=!1,this._bLockEvents=!1,this._bMove=!1,this._bIsLoading=!1},GetType:function(){return"VCXCmdChangeScenarioSequence"},GetTitle:function(){return"Change scenario sequence"},MoveScenario:function(e,t,n){this._bMove=!0;var i=this._ComponentsMap.GetComponentFromID(e);i&&(this.RemoveScenarioFromSequence(i),void 0!==n?this.InsertScenarioInSequence(i,t,n):this.PushScenarioInSequence(i,t))},PushScenarioInSequence:function(e,t){this._bPush=!0,this._scenarioToAdd=e;var n=null,i=this._sequenceManager.GetListSequences();i[0]&&(n=i[0]);var o=this._sequenceManager.GetSequenceFromId(t);if(o)this._sequenceIDForAdd=t;else{if(!n)return;this._sequenceIDForAdd=n.GetID(),o=n}var a=o.GetListScenariosId().length;this._scenarioAddIdx=a},InsertScenarioInSequence:function(e,t,n){this._scenarioToAdd=e,this._sequenceIDForAdd=t,this._scenarioAddIdx=n},RemoveScenarioFromSequence:function(e){this._scenarioToRemove=e},Do:function(){var t={};if(this._scenarioToAdd)if(t={sequenceIdForAdd:this._sequenceIDForAdd,scenarioToAdd:this._scenarioToAdd,bLinked:this._bLinkedCmd,scenarioAddIdx:this._scenarioAddIdx},this._bMove)this._sequenceManager.MoveScenarioInSequence(this._scenarioToAdd.GetID(),this._sequenceIDForAdd,this._scenarioAddIdx);else{(M=new n(this._sequenceManager._scenarioManager,this._commandManager,this._ComponentsMap)).AddScenarios(this._scenarioToAdd),this._commandManager.Push(M);var a=this._scenarioToAdd.GetID();if(this._bPush?this._sequenceManager.PushScenarioInSequence(a,this._sequenceIDForAdd):this._sequenceManager.InsertScenarioAtIndex(a,this._sequenceIDForAdd,this._scenarioAddIdx),!1===this._bIsLoading){var s=this._sequenceManager._experienceBase.getManager("VCXCAT3DXModelManager"),r=this._sequenceManager._experienceBase.getManager("VCXContextManager").IsLocalMode();if(s&&!r){var c=this._sequenceManager._experienceBase.getManager("VCXDocManager").actorDocManager.QueryInterface("VCXIModifiable"),h=new o(this._sequenceManager._experienceBase.getManager("VCXScenarioManager"));h.CaptureNeutralProperties(c),h.Do();var _=a,d=this._sequenceIDForAdd,u=new i,l=u._ScenarioToJson(this._sequenceManager._experienceBase,this._scenarioToAdd),C=u._VisibilityToJson(this._scenarioToAdd.GetVisibility(),this._sequenceManager._experienceBase);l.visibility=C;var m=[];m.push(l);var p={};p.listScenarios=m;var v=JSON.stringify(p,null,4),f={};f.neutrals=u._NeutralsToJson(this._sequenceManager._experienceBase);var g=JSON.stringify(f,null,4);s.CreateState(g,d,_,v)}}}if(this._scenarioToRemove){var S={sequenceIdForRemove:this._sequenceIDForRemove,scenarioToRemove:this._scenarioToRemove,scenarioRemovedIdx:this._scenarioRemoveIdx,bLinked:this._bLinkedCmd};a=this._scenarioToRemove.GetID();if(this._bMove)Object.assign(t,S);else{var M;t=S,(M=new n(this._sequenceManager._scenarioManager,this._commandManager,this._ComponentsMap)).RemoveScenarios(this._scenarioToRemove),this._commandManager.Push(M);var y=this._sequenceManager.GetSequenceFromId(this._sequenceIDForRemove);if(y.RemoveScenario(a),!1===this._bIsLoading){s=this._sequenceManager._experienceBase.getManager("VCXCAT3DXModelManager"),r=this._sequenceManager._experienceBase.getManager("VCXContextManager").IsLocalMode();if(s&&!r){var b=this;s.DeleteState(a,y.GetID()).done(function(){var e=b._sequenceManager._experienceBase.getManager("VCXDocManager").actorDocManager.QueryInterface("VCXIModifiable"),t=new o(b._sequenceManager._experienceBase.getManager("VCXScenarioManager"));t.CaptureNeutralProperties(e),t.Do();var n=new i,a={};a.neutrals=n._NeutralsToJson(b._sequenceManager._experienceBase);var r=JSON.stringify(a,null,4);s.CreateState(r,"","",""),console.log("DeleteState DONE")})}}}}this._bLockEvents||(this._bMove?e.publish({event:"VCX_SCENARIO_MOVED",data:t}):e.publish({event:"VCX_SCENARIO_CHANGED",data:t}))},SaveContext:function(){if(this._scenarioToRemove){var e=this._sequenceManager.GetSequenceFromScenarioId(this._scenarioToRemove.GetID());this._sequenceIDForRemove=e.GetID(),this._scenarioRemoveIdx=e.GetIndexOfScenario(this._scenarioToRemove.GetID())}},Invert:function(){var e=this._scenarioToAdd;this._scenarioToAdd=this._scenarioToRemove,this._scenarioToRemove=e;var t=this._sequenceIDForAdd;this._sequenceIDForAdd=this._sequenceIDForRemove,this._sequenceIDForRemove=t;var n=this._scenarioAddIdx;this._scenarioAddIdx=this._scenarioRemoveIdx,this._scenarioRemoveIdx=n},SetLockEvents:function(e){this._bLockEvents=e}})}),define("DS/VCXWebKernelCommands/VCXCmdChangeSequence",["DS/CoreEvents/Events","DS/VCXWebKernelCommands/VCXCommand","DS/VCXWebKernelCommands/VCXCmdChangeModifiable","DS/VCXWebKernelCommands/VCXCmdChangeComponent","DS/VCXWebKernelCommands/VCXCmdChangeScenarioSequence"],function(e,t,n,i,o){"use strict";return t.extend({init:function(e,t,n){this._parent(),this._sequenceManager=e,this._commandManager=t,this._ComponentsMap=n,this._sequenceToAdd=null,this._sequenceToRemove=null,this._scenariosToRemove=[],this._prevSequence=null,this._bPush=!1,this._bLockEvents=!1,this._bIsLoading=!1},GetType:function(){return"VCXCmdChangeSequence"},GetTitle:function(){return"Change sequence"},PushSequence:function(e){this._bPush=!0,this._sequenceToAdd=e},InsertSequence:function(e,t){this._sequenceToAdd=e,this._prevSequence=t},RemoveSequence:function(e){this._sequenceToRemove=e},Do:function(){var t=new n(this._sequenceManager._scenarioManager),a=new i(this._commandManager,this._ComponentsMap);if(this._sequenceToAdd?(a.AddComponents(this._sequenceToAdd),t.AddModifiables(this._sequenceToAdd.QueryInterface("VCXIModifiable"))):this._sequenceToRemove&&(a.RemoveComponents(this._sequenceToRemove),t.RemoveModifiables(this._sequenceToRemove.QueryInterface("VCXIModifiable"))),this._commandManager.Push(a),this._commandManager.Push(t),this._sequenceToAdd){if(!this._bIsLoading){var s=this._sequenceManager._experienceBase.getManager("VCXCAT3DXModelManager"),r=this._sequenceManager._experienceBase.getManager("VCXContextManager").IsLocalMode();if(s&&!r){var c=this._sequenceToAdd.GetName(),h=this._sequenceToAdd.GetID();s.CreateStateCollection(c,h)}}this._bPush?this._sequenceManager.PushSequence(this._sequenceToAdd):this._sequenceManager.InsertSequenceAfter(this._sequenceToAdd,this._prevSequence);for(var _=0;_<this._scenariosToRemove.length;_++){var d=this._scenariosToRemove[_];(u=new o(this._sequenceManager,this._commandManager,this._ComponentsMap)).PushScenarioInSequence(d,this._sequenceToAdd.GetID()),this._commandManager.Do(u)}}else if(this._sequenceToRemove){for(this._sequenceManager._scenarioManager.GetScenarios(),this._sequenceToRemove.GetListScenariosId(),_=0;_<this._scenariosToRemove.length;_++){var u;d=this._scenariosToRemove[_];(u=new o(this._sequenceManager,this._commandManager,this._ComponentsMap)).RemoveScenarioFromSequence(d,this._sequenceToRemove.GetID()),this._commandManager.Do(u),d=this._scenariosToRemove.pop()}this._sequenceManager.RemoveSequence(this._sequenceToRemove.GetID())}if(this._bLockEvents);else{var l={previousSeqIndex:this._sequenceManager.GetIndexOfSequence(this._prevSequence),sequenceToAdd:this._sequenceToAdd,sequenceToRemove:this._sequenceToRemove};e.publish({event:"VCX_SEQUENCE_CHANGED",data:l})}},SaveContext:function(){var e=this._sequenceManager._scenarioManager.GetScenarios();if(this._sequenceToAdd){if(this._bPush){var t=this._sequenceManager.GetListSequences(),n=t.length-1;this._prevSequence=t[n]}}else if(this._sequenceToRemove){this._prevSequence=this._sequenceManager.GetPreviousSequence(this._sequenceToRemove);for(var i=this._sequenceToRemove.GetListScenariosId(),o=i.length-1;o>=0;o--){var a=e[i[o]];this._scenariosToRemove.push(a)}}},Invert:function(){var e=this._sequenceToAdd;this._sequenceToAdd=this._sequenceToRemove,this._sequenceToRemove=e},SetLockEvents:function(e){this._bLockEvents=e}})});