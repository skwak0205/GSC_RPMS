define("DS/CompareCmd/CompareCmd",["DS/ApplicationFrame/Command","DS/ApplicationFrame/CommandsManager","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleServicesSettings","DS/WAFData/WAFData"],function(e,t,n,r,o){"use strict";var i=function(){};return i("compareCmd module is loading"),e.extend({name:"compare_command",context:null,defaultOptions:{disregardSelectedNodes:!1},init:function(e){if(this.context=e.context,this.runOptions=e.runOptions,this._parent(e,{mode:"exclusive",isAsynchronous:!1}),"CompareJSONHdr"==this._id&&(this.baseEnable=this.enable,this.baseDisable=this.disable,this.enable=function(e){null!=e&&"SnapshotsWidget"==e.by&&this.baseEnable()},this.disable=function(e){null!=e&&"SnapshotsWidget"==e.by&&this.baseDisable()}),null==this.context){var t=this;require(["DS/PADUtils/PADContext"],function(e){var n=e.get();if(null!=n&&(t.context=n,null!=t.context.getPADTreeDocument)){var r=t.context.getPADTreeDocument().getXSO();t._boundCheck=t.checkSelect.bind(t),r.onPostAdd(t._boundCheck),r.onPostRemove(t._boundCheck),t._isEnabled=t.getEnableCmd()}})}this.setCommandAvailability(this.getEnableCmd())},setCommandAvailability:function(e){var n=t.getCommand(this._id,this);n&&(!0===e?n.enable():n.disable())},getEnableCmd:function(){var e=this,t=!1;return r.hasRole(function(n){if(!0===n&&null!=e.context&&(e.context.getPADTreeDocument||"LifecycleWidget"===e.context.widgetType)){var r=0;r=e.context.getPADTreeDocument?e.context.getPADTreeDocument().getXSO().get().length:e.context.getSelectedNodes().length,t=r>0}},["InternalDS","PAR","PAU","CSV"]),t},checkSelect:function(){var e=this.getEnableCmd();this.setCommandAvailability(e)},beginExecute:function(){i("BEGIN EXECUTE of compareCmd")},execute:function(){var e=this.runOptions||{};switch(this._id){case"CompareHdr":return this.execute_CompareHdr(this.context);case"CompareJSONHdr":this.execute_CompareSnapshots();break;case"CompareV1Hdr":e.app="COMPARE",e.version="1";break;case"CompareV2Hdr":e.app="COMPARE",e.version="2";break;case"CompareMergeHdr":e.app="MERGE",e.version="2";break;case"CompareProtoHdr":e.app="COMPARE",e.version="proto";break;default:return this.NLS_showMessage("cmdNotImplented","compare-alert-error"),!1}return this._execute_CompareApp(this.context,e)},endExecute:function(){},getTenant:function(){var e="undefined"!=typeof widget&&widget?widget.getValue("x3dPlatformId"):null;return null!=e&&""!=e||(e="OnPremise"),e},execute_CompareSnapshots:function(){var e=this,t=this.getTenant();return require(["DS/ListSnapshots/CmdCtx"],function(n){if(n){var r=n.ctx;if(null!=r&&null!=r.getCompareIDs&&"function"==typeof r.getCompareIDs)r.getCompareIDs(function(n){e.launchCompare(t,n)},function(e){this.NLS_showMessage("requestError","compare-alert-error")});else if(void 0===r){var o=[],i=e.options.CompareIds;null!=i&&i.forEach(function(e){o.push({ID:e,TYPE:"snapshotID"})}),e.launchCompare(t,o)}}else console.log("invalid prereq on DS/ListSnapshots/CmdCtx")}),!0},execute_CompareHdr:function(e){var t=this,n=this.getTenant(),r=this.getObjSpecArray(e),o=this.getFilterProxy(e);return this.validateInput(n,r,function(){t.launchCompare(n,r,o)})},_execute_CompareApp:function(e,t){t=t||{};var n=this,r=n.getTenant(),o=n.getObjSpecArray(e),i=n.getFilterProxy(e);t.viewDefType=null!=t.viewSetMod&&null!=t.viewSetName?"AS_GIVEN":"LOOKUP";return 1==t.skipValidate?n.launchCompare(r,o,i,t):this.validateInput(r,o,function(){n.launchCompare(r,o,i,t)})},getFilterProxy:function(e){var t=null;null!=e&&void 0!==e._biFilter&&null!==e._biFilter&&void 0!==e._biFilter._biFilter&&null!==e._biFilter._biFilter&&(t={appId:e._biFilter._biFilter._appId,widgetId:e._biFilter._biFilter._widgetId});return t},getObjSpecArray:function(e){var t=[];if(null!=e&&0==this.options.disregardSelectedNodes&&null!=e.getSelectedNodes&&"function"==typeof e.getSelectedNodes){var n=e.getSelectedNodes(),r=e.getSecurityContext().SecurityContext,o=this.getTenant();n.forEach(function(e){var n=e.getID(),i=(e.options||e.object).type;i||"function"!=typeof e.getType||(i=e.getType()),t.push({id:n,objIDType:"modelID",objType:i,contextId:r,objTenant:o})})}else t=this.options.CompareIds;return t},checkFormat_PhysID:function(e){if(null==e||e.constructor!=String||32!=e.length)return!1;for(var t=0;t<32;t++){var n=e.charAt(t);if(0==(n>="a"&&n<="f"||n>="A"&&n<="F"||n>="0"&&n<="9"))return!1}return!0},checkFormat_editCommands:function(e){if(null==e||e.constructor!=Array||0==e.length)return"Empty or missing edit commands";for(var t=0;t<e.length;t++){var n=e[t];if(null==n.op)return"Command is missing operator";switch(n.op){case"INSERT":if(0==this.checkFormat_PhysID(n.inNode))return"Bad or missing inNode in INSERT operation";break;case"REMOVE":if(0==this.checkFormat_PhysID(n.rmNode))return"Bad or missing rmnode in REMOVE operation";break;case"REPLACE":if(0==this.checkFormat_PhysID(n.inNode))return"Bad or missing inNode in REPLACE operation";if(0==this.checkFormat_PhysID(n.rmNode))return"Bad or missing rmnode in REPLACE operation";break;default:return"Unknown op: '"+n.op+"'"}if(0==this.checkFormat_PhysID(n.parent))return"Bad or missing parent"}return 0},validateInput:function(e,t,n){var i=this;if(null==t||t.constructor!=Array||0==t.length)return this.NLS_showMessage("objectNotSelected","compare-alert-error"),!1;if(t.length>5)return this.NLS_showMessage("selectFiveOrFewer","compare-alert-error"),!1;for(var a=[],s=[],c=0;c<t.length;c++){var l=t[c];if(null==l||""==l)return this.NLS_showMessage("objSpec is NULL","compare-alert-error"),!1;var u=null,d=null;if(u=l.constructor==String?l:l.id,null!=l.commands&&(d=l.commands),0==this.checkFormat_PhysID(u)){var p="Invalid root ID: "+u;return null!=l.commands&&(p+=" in objSpec: "+JSON.stringify(l)),this.NLS_showMessage(p,"compare-alert-error"),!1}if(null!=d){var m=this.checkFormat_editCommands(d);if(0!=m)return this.NLS_showMessage(m+" in objSpec: '"+JSON.stringify(l)+"'.","compare-alert-error"),!1}-1==a.indexOf(u)&&a.push(u),l.contextId&&s.push(l.contextId)}var h=a.join(),g=null;g=1==i.options.isODT?"/resources/compare/getObjState?objectIds="+h:r.get3DSpaceWSUrl(e,"/resources/compare/getObjState","objectIds="+h);var f={Accept:"application/json"};s.length&&(f.securityContext=s[0]);try{o.authenticatedRequest(g,{proxy:"passport",timeout:12e4,method:"GET",headers:f,onComplete:function(e){i.checkValidateResults(e,n)}})}catch(e){i.NLS_showMessage("requestError","compare-alert-error")}return!0},checkValidateResults:function(e,t){JSON.parse(e).results.forEach(function(e){if(0==e.exists)return this.NLS_showMessage("OBJ_NOT_FOUND","compare-alert-error"),!1}),t()},launchCompare:function(e,t,r,o){var i=this,a=null;if(o=o||{},null!=t){var s=[];t.forEach(function(t){var n="unknown",r=null,o=null,i=null,a=null,c=null;t.constructor==String?(n="modelID",r=t):(n=null!=t.commands?"IDPlusCommands":null!=t.TYPE?t.TYPE:t.objIDType,r=t.id,i=t.objType,a=t.contextId,o=t.commands,c=t.objTenant);var l=null!=c?c:e;s.push({idType:n,objectId:r,objectType:i,contextId:a,commands:o,envId:l,serviceId:"3DSpace",displayName:"",path:""})}),a={items:s,immediateCompare:u}}var c=widget.getPreference("useIndex"),l=null==c||c.value,u=!0===i.ImmediateCompare,d=n.getCurrentAppName(this.context),p={envId:e,protocol:"3DXContent",version:"1.0",source:d=d||"ENOSTDE_AP",widgetId:widget.id,useIndex:l,biProxyCtx:r,data:a,runOptions:o};if(1==this.options.isODT||1==o.isODT){var m=JSON.stringify(p);require(["DS/CompareWidget/CompareWidget"],function(e){widget.setValue("X3DContentId",m),e.onLoad_forODT()})}else{i=this;require(["UWA/Utils/InterCom"],function(e){var t=new e.Socket("compassPageSocket");t.subscribeServer("com.ds.compass",window.parent),t.dispatchEvent("onSetX3DContent",p,"compassPageSocket"),t.dispatchEvent("onLaunchApp",{appId:"ENOCOMP_AP"},"compassPageSocket")})}},NLS_showMessage:function(e,t){"compare-alert-console"==t?console.error(e):require(["DS/CompareCommon/CompareAlert","i18n!DS/CompareCmd/assets/nls/CompareCmd"],function(n,r){var o=null!=r[e]?r[e]:e;n.doAlert({msg:o,alertStyle:t})},function(n){console.log("%%%% CompareWidget:: Failed to show "+t+": '"+e+"', error:"+n)})}})});