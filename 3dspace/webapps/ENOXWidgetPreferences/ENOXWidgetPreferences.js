define("DS/ENOXWidgetPreferences/js/ENOXWidgetPreferencesConstants",[],function(){"use strict";var e={xWDGT_PREF_CREDENTIAL:"xPref_CREDENTIAL",xWDGT_PREF_SHOW_WORK_UNDER:"xPref_SHOW_WORK_UNDER",xWDGT_PREF_SHOW_PREF_PAGE_AT_START:"xPref_SHOW_PREF_PAGE_AT_START",xWDGT_PREF_3DEXPERIENCE_PLATFORM:"xPref_3DEXPERIENCE_PLATFORM"};return e}),define("DS/ENOXWidgetPreferences/js/ENOXWidgetPreferences",["UWA/Core","UWA/Class","DS/WAFData/WAFData","DS/Controls/Loader","DS/UIKIT/Input/Select","DS/i3DXCompassServices/i3DXCompassServices","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/ENOXWidgetPreferences/js/ENOXWidgetPreferencesConstants","i18n!DS/ENOXWidgetPreferences/assets/nls/ENOXWidgetPreferences"],function(e,t,r,n,a,i,o,l,s){"use strict";var d=function(e){return e&&void 0===e.prefName&&(e.prefName=l.xWDGT_PREF_CREDENTIAL),e&&void 0===e.prefLabel&&(e.prefLabel=s.xWDGT_PREF_CREDENTIAL_LABEL),f(e)},f=function(e){return{name:e.prefName,type:"list",label:e.prefLabel,options:[],value:void 0}},c=function(t,r){if(e.log("Error: "+t),r)throw new Error(t)},g=function(t){e.log("Info: "+t)};return t.singleton({init:function(e){this._parent(e),this._serviceUrl=null,this._serviceUrlBeforeEdit="",this._lastSavedCredentials="",this._lastSavedCredentailsPrefObj={},this._lastSavedPlatformId="",this._currLang=widget&&widget.lang?widget.lang:"en",this._subscribeToWidgetEvents()},getServiceUrl:function(){return this._serviceUrl},getCredentialPreferenceKey:function(){return l.xWDGT_PREF_CREDENTIAL},getPlatformPreferenceKey:function(){return l.xWDGT_PREF_3DEXPERIENCE_PLATFORM},getShowWorkUnderPreferenceKey:function(){return l.xWDGT_PREF_SHOW_WORK_UNDER},getShowPreferencesAtStartPreferenceKey:function(){return l.xWDGT_PREF_SHOW_PREF_PAGE_AT_START},hasCredentialsChanged:function(){return""!==this._lastSavedCredentials&&this._lastSavedCredentials!==widget.getValue(l.xWDGT_PREF_CREDENTIAL)},hasPlatformIdChanged:function(){let e=widget.hasPreference(l.xWDGT_PREF_3DEXPERIENCE_PLATFORM)?widget.getValue(l.xWDGT_PREF_3DEXPERIENCE_PLATFORM):void 0;return""!==this._lastSavedPlatformId&&void 0!==e&&this._lastSavedPlatformId!==e},addCredentialPreferenceToWidget:function(t,r){var n=this,a=t||{};return a=e.merge(a,{availableContexts:void 0,prefName:l.xWDGT_PREF_CREDENTIAL,prefLabel:s.xWDGT_PREF_CREDENTIAL_LABEL}),new e.Promise(function(t,r){e.is(widget)?n._getCredentialPreference(a).then(e=>{var i=n._getAssignedSecurityContextsFromResponse(e);if(i&&i instanceof Array&&i.length>0){let e=d(a),f=[],c=[];for(var o=0,l=i.length;o<l;o++){let e=i[o];e&&"ADMIN"===e.respType?c.push(e):e&&"REGULAR"===e.respType&&f.push(e)}f.length>1&&f.sort(function(e,t){if(void 0!==e&&e.label&&void 0!==t&&t.label)return e.label.localeCompare(t.label,n._currLang,{ignorePunctuation:!0})}),c.length>1&&c.sort(function(e,t){if(void 0!==e&&e.label&&void 0!==t&&t.label)return e.label.localeCompare(t.label,n._currLang,{ignorePunctuation:!0})}),e.options=c.length>0?f.concat(c):f,e.value=e.options.length>0?e.options[0].value:r({type:"error",message:s.ERROR_NO_CREDENTIALS_ASSIGNED_TO_USER}),n._helperAddCredentialPrefToWidget(e),t()}else r({type:"error",message:s.ERROR_NO_CREDENTIALS_ASSIGNED_TO_USER})}).catch(()=>{r({type:"error",message:s.ERROR_COULDNT_ADD_CREDENTIALS})}):r({type:"error",message:s.ERROR_WIDGET_IS_NOT_DEFINED})})},addPlatformSelectionPreferenceToWidget:function(t){var r=this,n=t&&t.roles?t.roles:[],a=!t||void 0===t.mustHaveAll||t.mustHaveAll,i=[];return new Promise(function(t,r){if(n&&n.length>0){let l=n.length;o.getGrantedRoles(function(o){let s={};if((void 0===o||o.length<=0)&&r(new Error("Error, Unable to fetch the granted Roles.")),o.forEach(function(t,r){if(t.id&&n.includes(t.id)&&e.is(t.platforms,"array")&&t.platforms.length>0){var o=[];t.platforms.forEach((e,t)=>{-1===o.indexOf(e)&&o.push(e)}),o.forEach(e=>{if(void 0!==e&&""!==(e=e.trim()))if(void 0===s[e])s[e]=1;else{let t=s[e]+1;s[e]=t}}),Object.keys(s).length>0&&Object.keys(s).forEach(e=>{(!a&&s[e]>0||s[e]===l)&&i.push(e)})}}),!(i.length>0))return e.Promise.reject("As per granted roles and inputs there are no platforms which are allowed for user");t()})}else e.log("Error, either no role or invalid roles supplied, Platform preference wont be added to widget."),r(s.ERROR_NO_OR_INVALID_ROLE)}).then(function(){return new Promise(function(t,r){o.getPlatformServices({onComplete:function(e){var r=[];e.forEach(function(e){i.includes(e.platformId)&&r.push(e)}),t(r)},onFailure:function(t){return e.Promise.reject(t)}})}).then(function(t){if(t&&t.length>0){var n={},a=[];t.forEach(function(e){e&&e.platformId&&(n[e.platformId]=e,a.push({label:e.displayName,value:e.platformId}))});var i=f({prefName:l.xWDGT_PREF_3DEXPERIENCE_PLATFORM,prefLabel:s.xWDGT_PREF_3DEXPERIENCE_PLATFORM});return i.options=a,i.value=widget.getValue("x3dPlatformId"),1===a.length&&(i.disabled=!0),r._helperAddPrefereceToWidget(i,l.xWDGT_PREF_3DEXPERIENCE_PLATFORM,1),e.Promise.resolve("3DEXPERIENCE Platform Preference added to Widget!")}return e.log("Error, unable to get the tenants list, Platform preference wont be added to widget."),e.Promise.resolve("Unable to get tenants list, Platform preference wont be added to widget")})})},addShowWorkUnderPreferenceToWidget:function(e){this._addBooleanPreferenceToWidget({prefName:e&&e.prefName?e.prefName:l.xWDGT_PREF_SHOW_WORK_UNDER,prefLabel:e&&e.prefLabel?e.prefLabel:s.xWDGT_PREF_SHOW_WORK_UNDER_LABEL,prefDefValue:e&&e.prefDefValue?e.prefDefValue:void 0})},addShowPreferencesAtStartPreferenceToWidget:function(e){this._addBooleanPreferenceToWidget({prefName:e&&e.prefName?e.prefName:l.xWDGT_PREF_SHOW_PREF_PAGE_AT_START,prefLabel:e&&e.prefLabel?e.prefLabel:s.xWDGT_PREF_SHOW_PREF_PAGE_AT_START,prefDefValue:e&&e.prefDefValue?e.prefDefValue:void 0})},_subscribeToWidgetEvents:function(){var e=this;widget&&widget.addEvents({onEdit:function(){e._serviceUrlBeforeEdit=e._serviceUrl,e._lastSavedCredentials=window.widget.getValue(l.xWDGT_PREF_CREDENTIAL),e._lastSavedPlatformId=window.widget.getValue("x3dPlatformId"),e._lastSavedCredentailsPrefObj=window.widget.getPreference(l.xWDGT_PREF_CREDENTIAL),e._platformIdDuringEdit=e._lastSavedPlatformId},endEdit:function(){e._updatingCredOnPlatformChange=!1,arguments&&arguments.length>0&&(!1===arguments[0].submitted&&e.hasPlatformIdChanged()?(g("ENOXWidgetPreferences: Restoring preferences to original stage on cancellation of page!!!"),e._resetCredentialsAndPlatformToLastState()):!0===arguments[0].submitted&&e.hasPlatformIdChanged()&&widget.setValue("x3dPlatformId",widget.getValue(l.xWDGT_PREF_3DEXPERIENCE_PLATFORM))),e._platformIdDuringEdit=""},onUpdateValue:function(t){if(t&&t===l.xWDGT_PREF_3DEXPERIENCE_PLATFORM&&!e._updatingCredOnPlatformChange){e._serviceUrlBeforeEdit=e._serviceUrl,e._serviceUrl=null;var r=window.parent.document.getElementsByClassName("moduleEdit");r=r&&r.length>0?r[0]:window.parent.document;let t=widget.getValue(l.xWDGT_PREF_3DEXPERIENCE_PLATFORM);if(e._platformIdDuringEdit!==t&&(e._platformIdDuringEdit=t,widget.hasPreference(l.xWDGT_PREF_CREDENTIAL))){e._updatingCredOnPlatformChange=!0;let i=new n({text:s.MSG_UPDATING_CREDENTIALS,"text-align":"center"}).inject(r);i.elements.container.setStyle("text-align","center"),i.on(),e.addCredentialPreferenceToWidget({platformId:t},2).then(function(){let t=window.parent.document.getElementsByName(l.xWDGT_PREF_CREDENTIAL),r=(t=t&&1===t.length?t[0]:void 0)?t.getParent():null,n=r?r.getParent():null;var o=widget.getPreference(l.xWDGT_PREF_CREDENTIAL);o.placeholder=!1;var s=new a(o);s.onChange=function(){widget.setValue(l.xWDGT_PREF_CREDENTIAL,s.getValue()[0])},n&&s.inject(n),t&&r&&(r.hide(),r.remove()),e._updatingCredOnPlatformChange=!1,i.off()},function(){e._resetCredentialsAndPlatformToLastState(),i.off(),e._updatingCredOnPlatformChange=!1})}}}})},_resetCredentialsAndPlatformToLastState:function(){this._serviceUrl=this._serviceUrlBeforeEdit,widget.addPreference(this._lastSavedCredentailsPrefObj),widget.setValue("x3dPlatformId",this._lastSavedPlatformId),widget.hasPreference(l.xWDGT_PREF_CREDENTIAL)&&widget.setValue(l.xWDGT_PREF_CREDENTIAL,this._lastSavedCredentials)},_getCredentialPreference:function(t){var n=this,a=d(t);return void 0===t||void 0===t.availableContexts||t.availableContexts instanceof Array&&t.availableContexts.length<=0?n._getServiceUrlHandler(t).then(function(){return new e.Promise(function(e,a){var i,o=(new Date).getTime(),l=t&&t.platformId?t.platformId:widget.getValue("x3dPlatformId");i="/resources/modeler/pno/person?current=true&select=collabspaces",i+="&tenant="+(l&&""!==l?l:"OnPremise"),i+="&timestamp="+o;var s={};widget&&widget.lang&&(s["Accept-Language"]=widget.lang),r.authenticatedRequest(n._serviceUrl+i,{method:"GET",type:"json",async:!1,headers:s,onComplete:function(t){e(t)},onFailure:function(){a(),c("Unable to get assigned security context for user!")},timeout:5e3})},function(){c("Unable to get assigned security contexts for user!"),reject()})},function(){c("Unable to get service URL!"),reject("Unable to get service URL!")}):t.availableContexts instanceof Array&&t.availableContexts.length>0?(a.options=t.availableContexts,a):t.availableContexts instanceof Object&&void 0!==t.availableContexts.collabspaces?(a.options=this._getAssignedSecurityContextsFromResponse(t.availableContexts),a):void 0},_getAvailablePlatforms:function(){return new e.Promise(function(t,r){try{o.getPlatformServices({onComplete:function(r){e.log("Fetching platform information successful!"),t(r)},onFailure:function(t){e.log("Error while fetching platform information!"),r(t)},onTimeout:function(t){e.log("Timeout occured while fetching platform information."),r(t)}})}catch(t){e.log("Exception while fetching platform information!")}})},_addBooleanPreferenceToWidget:function(e){widget&&e&&void 0!==e.prefName&&void 0!==e.prefLabel?widget.addPreference({name:e.prefName,type:"boolean",label:e.prefLabel,defaultValue:void 0!==e.prefDefValue&&"boolean"==typeof e.prefDefValue&&e.prefDefValue}):c(" Widget is undefined!",!0)},_getAssignedSecurityContextsFromResponse:function(t){var r=this,n=[];if(t){var a=t.collabspaces||void 0,i=void 0,o=!1;if(a&&e.is(a,"array"))for(var l=0,s=a.length;l<s;l++){var d=a[l];if(e.is(d.couples,"array")){let e=d.couples;for(var f=0,g=e.length;f<g;f++){let t=e[f];if(void 0===i&&(i=t.organization.name),i!==t.organization.name){o=!0;break}}}}a&&e.is(a,"array")?(a.forEach(function(t){e.is(t.couples,"array")?t.couples.forEach(function(e){var a=r._getContextObjectFromCouple(t,e,o);n.push(a)}):c(" Proper collab space information is not available in response!",!0)}),n.sort(function(e,t){if(void 0!==e&&e.label&&void 0!==t&&t.label)return e.label.localeCompare(t.label,r._currLang,{ignorePunctuation:!0})})):c(" Proper collab space information is not available in response!",!0)}else c(" Incorrect/incomplete response for request to fetch security contexts!",!0);return n},_getContextObjectFromCouple:function(e,t,r){var n=void 0===t.role.nls||""===t.role.nls?t.role.name:t.role.nls,a=t.role.name;let i=a.toLowerCase();var o=t.organization?t.organization:void 0,l=o&&o.name?o.name:"",s=o&&o.title?o.title:l,d=e.name,f=e.title?e.title:e.name;return{label:r?f+" ● "+s+" ● "+n:f+" ● "+n,value:a+"."+l+"."+d,respType:i&&(i.contains("3ddrestrictedowner")||i.contains("vplmprojectadministrator")||i.contains("vplmadmin"))?"ADMIN":"REGULAR"}},_validateCredentialObject:function(e){var t=["collabspace","organization","role"],r=!0;if(e)for(var n=0,a=t.length;n<a;n++){var i=t[n];if(!e.hasOwnProperty(i)||void 0===e[i]||""===e[i]){r=!1;break}}return r},_getServiceUrlHandler:function(t){var r=this;return new e.Promise(function(n,a){if(null===r._serviceUrl){var o={serviceName:"3DSpace",platformId:t&&t.platformId?t.platformId:widget.getValue("x3dPlatformId"),async:!1,onComplete:function(t){"string"==typeof t?(r._serviceUrl=t,n()):e.is(t,"array")&&t.length>0?(r._serviceUrl=t[0].url,n()):(c(" Unable to get Service URL!",!1),a("OnComplte: Error while getting service URL"))},onFailure:function(){c(" Unable to get Service URL!",!1),a("Error while getting service URL")}};i.getServiceUrl(o)}else n()})},_helperAddCredentialPrefToWidget:function(t){let r=l.xWDGT_PREF_CREDENTIAL,n=widget.hasPreference(l.xWDGT_PREF_3DEXPERIENCE_PLATFORM)&&"hidden"!==widget.getPreference(l.xWDGT_PREF_3DEXPERIENCE_PLATFORM).type?2:1;if(widget&&e.is(t)){var a=widget.getPreferences(),i=widget.getValue(r);if(void 0===i||""===i)widget.setValue(r,t.value),g("Widget does not have given preference, adding it.");else if(t.value&&i!==t.value){let e=!1;for(let r=0;r<t.options.length;r++){let n=t.options[r];if(n&&n.value&&n.value===i){e=!0;break}}e&&(t.value=i,g("Widget has credentials preference & existing value, using it as current credential value.")),widget.setValue(r,t.value),g("Widget has credentials preference, adding to replace the existing one.")}if(a&&a instanceof Array&&a.length>0){var o=e.is(n,"number")?n-1:0;widget.hasPreference(r)?widget.addPreference(t):(a.splice(o,0,t),widget.setPreferences(a))}else widget.addPreference(t)}else c(" Either widget is not defined or inputs are invalid!",!0)},_helperAddPrefereceToWidget:function(t,r,n){if(!widget||void 0===t&&null===t)c(" Either widget is not defined or inputs are invalid!",!0);else{var a=widget.getPreferences(),i=widget.getValue(r);if(void 0===i||""===i?(widget.setValue(r,t.value),g("Widget does not have given preference, adding it.")):t.value&&i!==t.value&&(widget.setValue(r,t.value),g("Widget has give preference, adding to replace the existing one.")),a&&a instanceof Array&&a.length>0){var o=e.is(n,"number")?n-1:0;widget.hasPreference(r)?widget.addPreference(t):(a.splice(o,0,t),widget.setPreferences(a))}else widget.addPreference(t)}},__onlyForODTSetWAFData:function(e){r=e}})});