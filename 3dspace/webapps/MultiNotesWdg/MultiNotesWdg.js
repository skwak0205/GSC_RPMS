define("DS/MultiNotesWdg/Views/NewNoteItem",["UWA/Core","DS/UIKIT/Input/Button","DS/W3DXComponents/Views/Temp/TempItemView","i18n!DS/MultiNotesWdg/assets/nls/MultiNotes","css!DS/MultiNotesWdg/Views/NewNoteItem"],function(e,t,n,i){"use strict";return n.extend({tagName:"div",className:"new-note-itm",MultiNotes:null,setup:function(e){this.MultiNotes=e.MultiNotes},render:function(){var n,o=this.elements;return o.addNewNoteBtn=n=new t({className:"primary add-note-btn",value:i.addNew,icon:"plus",events:{onClick:this._onAddNewNoteBtnClick.bind(this)}}),this.container.addContent({tag:"div",class:"note-itm-ctn",html:n}),o.dropZone=e.createElement("div",{class:"drop-zone drop-zone-duplicate",text:i.dropDuplicateNote}).inject(document.body),this},onSearch:function(e){this.MultiNotes.isReadOnlyMode()||this.elements.addNewNoteBtn[e?"disable":"enable"]()},onDragOver:function(){this.elements.dropZone.addClassName("hover"),document.body.addClassName("dragging-over-duplicate-zone")},onDragLeave:function(){this.elements.dropZone.removeClassName("hover"),document.body.removeClassName("dragging-over-duplicate-zone")},destroy:function(){this.MultiNotes=null,this._parent.apply(this,arguments)},_onAddNewNoteBtnClick:function(){return this.MultiNotes.addNewNote()}})}),define("DS/MultiNotesWdg/ckeditor/autohyperlink/plugin",["UWA/Utils/Client"],function(e){CKEDITOR.plugins.add("autohyperlink",{exclusion:[37,38,39,40,1114129],moveAfterAnchor:function(e){if(e.data&&-1===this.exclusion.indexOf(e.data.keyCode)){var t=e.editor.getSelection(1),n=t&&t.getRanges();if(n&&1===n.length&&n[0].collapsed){var i=n[0],o=i.startPath().contains("a"),s=i.startContainer;if(o&&s&&(s.type===CKEDITOR.NODE_ELEMENT&&1===i.startOffset||s.type===CKEDITOR.NODE_TEXT&&i.startOffset===s.getLength())){for(var a=s;a&&!a.equals(o);){if(null!=a.getNext())return;a=a.getParent()}i.moveToPosition(o,CKEDITOR.POSITION_AFTER_END),i.select()}}}},autoDetectLink:function(e){var t,n=/\bhttps?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,256}\b([-a-zA-Z0-9@:%_\+.~#?&\/=]*)\b/i,i=e.editor,o=i.getSelection(),s=o?o.getRanges()[0]:null,a=null;if(s&&e)if(t=s.startOffset,e.data&&(13===e.data.keyCode||32===e.data.keyCode||2228237===e.data.keyCode)||"blur"===e.name){if(s.endContainer.$.nodeValue){var r=s.endContainer.$.nodeValue.trim(),l=s.endContainer.$.parentNode,d="";(f=r.slice(0,t).split(" ").pop().trim()).match(n)&&(a=i.getSelection().createBookmarks(!0),t-f.length>0?d=l.innerHTML.match("&nbsp;"+f)?"&nbsp;":" ":l.innerHTML.match("<br>"+f)&&(d="<br>"),l.innerHTML=l.innerHTML.replace(d+f,d+'<a data-type="external" href="'+f+'">'+f+"</a>"),s.moveToBookmark(a[0]),s.select())}}else if("paste"!==e.name||"html"!==e.data.type&&"text"!==e.data.type){if("A"===s.endContainer.$.parentNode.tagName&&-1===this.exclusion.indexOf(e.data.keyCode)){var c=s.endContainer.$.parentNode.innerText,h=e.data.domEvent.$.key,u="";(u=8===e.data.keyCode?c.substr(0,t-1)+c.substr(t):c.substr(0,t)+h+c.substr(t)).match(n)&&(a=i.getSelection().createBookmarks2(!0),s.endContainer.$.parentNode.outerHTML='<a data-type="external" href="'+u+'">'+c+"</a>",s.moveToBookmark(a[0]),s.select())}}else if(s.endContainer.$.parentNode){var f=e.data.dataValue,g=(l=s.endContainer.$.parentNode,f.match(n));g&&0===g.index&&(e.cancel(),i.insertHtml('<a data-type="external" href="'+f+'">'+f+"</a>"))}},init:function(t){var n=this;t.on("key",function(e){n.autoDetectLink(e),n.moveAfterAnchor(e)},null,null,1),t.on("blur",function(e){n.autoDetectLink(e),n.moveAfterAnchor(e)},null,null,1),e.Engine.ie||t.on("paste",function(e){n.autoDetectLink(e),n.moveAfterAnchor(e)})}})}),define("DS/MultiNotesWdg/Models/Note",["UWA/Core","UWA/Class/Model","DS/UWPClientControls/Utils"],function(e,t,n){"use strict";return t.extend({defaults:{id:"",name:"",color:"",createTime:0,updateTime:0,content:""},_versions:{info:1,content:1,lastSaved:{info:1,content:1}},_states:{readOnly:!1,newNote:!1,selected:!1,saveInProgress:!1,filtered:!1,modified:{info:!1,content:!1},modifiedWhileNew:{info:!1,content:!1},conflictEdited:{info:!1,content:!1},conflictDeleted:!1,failToSave:{info:!1,content:!1},addedFromData:!1},_addedFromDataTimeout:null,setup:function(){var t=this;t._versions=e.clone(t._versions),t._states=e.clone(t._states),t._applyUpdateContentThrottled=n.throttle(function(){t.collection&&(t.setModifiedContent(!0),t._applyUpdateContent())},1e3),t.addEvent("onChange",t._onUpdate.bind(t))},sync:function(e){"delete"!==e&&this._parent.apply(this,arguments)},parse:function(e){return this._states.selected=e.states.selected,this._versions.info=e.versions.info,this._versions.lastSaved.info=this._versions.info,this._versions.content=e.versions.content,this._versions.lastSaved.content=this._versions.content,{id:e.id,name:e.name,color:e.color,createTime:e.createTime,updateTime:e.updateTime,content:e.content}},updateInfoFromData:function(e){e=e||{};var t=this.collection.dataManager,n=this.get("id"),i=t.getParsedNoteInfo(n),o=t.getNoteInfoVersion(n);this.set("name",i.name,{silent:!0}),this.set("color",i.color,{silent:!0}),this.set("updateTime",i.updateTime,{silent:!0}),this._versions.info=o,this._versions.lastSaved.info=o,!e.silent&&this._dispatchOnUpdateInfoFromData()},updateContentFromData:function(e){e=e||{};var t=this.collection.dataManager,n=this.get("id"),i=t.getNoteContent(n),o=t.getNoteContentVersion(n);this.set("content",i,{silent:!0}),this._versions.content=o,this._versions.lastSaved.content=o,!e.silent&&this._dispatchOnUpdateContentFromData()},resolveConflictEdited:function(){this.updateInfoFromData({silent:!0}),this.updateContentFromData({silent:!0}),this.setConflictEditedInfo(!1),this.setConflictEditedContent(!1),this.setModifiedInfo(!1),this.setModifiedContent(!1),this._dispatchOnResolveConflictEdited()},getInfoVersion:function(){return this._versions.info},getContentVersion:function(){return this._versions.content},getLastSavedInfoVersion:function(){return this._versions.lastSaved.info},getLastSavedContentVersion:function(){return this._versions.lastSaved.content},setLastSavedInfoVersion:function(e){this._versions.lastSaved.info=e},setLastSavedContentVersion:function(e){this._versions.lastSaved.content=e},setNewNote:function(e){this._states.newNote=e,e||(this._states.modifiedWhileNew.info&&this._onUpdateInfo(),this._states.modifiedWhileNew.content&&this._onUpdateContent({noThrottle:!0}))},setReadOnly:function(e,t){t=t||{},this._states.readOnly!==e&&(this._states.readOnly=e,!t.silent&&this._dispatchOnReadOnly())},setFailToSaveInfo:function(e,t){t=t||{},this._states.failToSave.info!==e&&(this._states.failToSave.info=e,this._onSetFailToSave(e,t))},setFailToSaveContent:function(e,t){t=t||{},this._states.failToSave.content!==e&&(this._states.failToSave.content=e,this._onSetFailToSave(e,t))},setSaveInProgress:function(e,t){t=t||{},this._states.saveInProgress!==e&&(this._states.saveInProgress=e,!t.silent&&this._dispatchOnSaveInProgress())},setModifiedInfo:function(e,t){t=t||{},this._states.modified.info!==e&&(t.statesDependant?this._states.modified.info=e||this._states.failToSave.info||this._states.conflictEdited.info||this._states.conflictDeleted:this._states.modified.info=e,!t.silent&&this._dispatchOnModified())},setModifiedContent:function(e,t){t=t||{},this._states.modified.content!==e&&(t.statesDependant?this._states.modified.content=e||this._states.failToSave.content||this._states.conflictEdited.content||this._states.conflictDeleted:this._states.modified.content=e,!t.silent&&this._dispatchOnModified())},setConflictEditedInfo:function(e,t){t=t||{},this._states.conflictEdited.info!==e&&(this._states.conflictEdited.info=e,this._onSetConflictEdited(e,t))},setConflictEditedContent:function(e,t){t=t||{},this._states.conflictEdited.content!==e&&(this._states.conflictEdited.content=e,this._onSetConflictEdited(e,t))},setConflictDeleted:function(e,t){t=t||{};this._states.conflictDeleted!==e&&(this._states.conflictDeleted=e,!t.silent&&this._dispatchOnConflictDeleted(),this.setReadOnly(e,t),e&&!this._states.selected&&this.isModified()&&!t.silent&&this._dispatchOnConflictDeletedNotSelected(),e&&this._states.addedFromData&&this._clearAddedFromDataTimeout())},setAddedFromData:function(e){this._states.addedFromData=e,this._dispatchOnAddedFromData(),e&&(this._addedFromDataTimeout=setTimeout(this._clearAddedFromDataTimeout.bind(this),6e4))},setFiltered:function(e){this._states.filtered=e},destroy:function(){this._versions=null,this._states=null,this._parent.apply(this,arguments)},setSelected:function(e){this._states.selected=e},isNewNote:function(){return this._states.newNote},isSelected:function(){return this._states.selected},isReadOnly:function(){return this._states.readOnly},isFailToSave:function(){return this._states.failToSave.info||this._states.failToSave.content},isSaveInProgress:function(){return this._states.saveInProgress},isModified:function(){return this._states.modified.info||this._states.modified.content},isConflictEdited:function(){return this._states.conflictEdited.info||this._states.conflictEdited.content},isConflictDeleted:function(){return this._states.conflictDeleted},isAddedFromData:function(){return this._states.addedFromData},isFiltered:function(){return this._states.filtered},retrySave:function(){var e=Promise.resolve(),t=Promise.resolve();return this.set("updateTime",Date.now(),{silent:!0}),this._states.failToSave.info&&(e=this._onUpdateInfo()),this._states.failToSave.content&&(t=this._onUpdateContent({noThrottle:!0})),Promise.all([e,t]).then(function(){})},_clearAddedFromDataTimeout:function(e){e=e||{};clearTimeout(this._addedFromDataTimeout),this.collection&&(this._states.addedFromData=!1,!e.silent&&this._dispatchOnAddedFromData())},_onUpdateContent:function(e){e=e||{};var t;return this.setModifiedContent(!0),this._versions.content=this._versions.lastSaved.content+1,e.noThrottle?t=this._applyUpdateContent():(this._applyUpdateContentThrottled(),t=Promise.resolve()),t},_onUpdateInfo:function(){return this.setModifiedInfo(!0),this._versions.info=this._versions.lastSaved.info+1,this._applyUpdateInfo()},_applyUpdateContent:function(){return Promise.all([this.collection.updateNoteContent(this),this._applyUpdateInfo().catch(function(){})])},_applyUpdateInfo:function(){return this.collection.updateNoteInfo(this)},_applyUpdateContentThrottled:function(){},_onUpdate:function(){this.collection&&!this._states.readOnly&&(this._states.newNote?this.hasChanged("content")?this._states.modifiedWhileNew.content=!0:this._states.modifiedWhileNew.info=!0:(this.set("updateTime",Date.now(),{silent:!0}),this.hasChanged("content")?this._onUpdateContent():this._onUpdateInfo()))},_onSetConflictEdited:function(e,t){!(t=t||{}).silent&&this._dispatchOnConflictEdited(),this.setReadOnly(e,t),!e||this._states.selected||t.silent||this._dispatchOnConflictEditedNotSelected()},_onSetFailToSave:function(e,t){!(t=t||{}).silent&&this._dispatchOnFailToSave(),!e||this._states.selected||t.silent||this._dispatchOnFailToSaveNotSelected()},_dispatchOnFailToSave:function(){this.dispatchEvent("onFailToSave",this)},_dispatchOnSaveInProgress:function(){this.dispatchEvent("onSaveInProgress",this)},_dispatchOnModified:function(){this.dispatchEvent("onModified",this)},_dispatchOnConflictEdited:function(){this.dispatchEvent("onConflictEdited",this)},_dispatchOnConflictDeleted:function(){this.dispatchEvent("onConflictDeleted",this)},_dispatchOnReadOnly:function(){this.dispatchEvent("onReadOnly",this)},_dispatchOnResolveConflictEdited:function(){this.dispatchEvent("onResolveConflictEdited",this)},_dispatchOnConflictDeletedNotSelected:function(){this.dispatchEvent("onConflictDeletedNotSelected",this)},_dispatchOnConflictEditedNotSelected:function(){this.dispatchEvent("onConflictEditedNotSelected",this)},_dispatchOnFailToSaveNotSelected:function(){this.dispatchEvent("onFailToSaveNotSelected",this)},_dispatchOnAddedFromData:function(){this.dispatchEvent("onAddedFromData",this)},_dispatchOnUpdateInfoFromData:function(){this.dispatchEvent("onUpdateInfoFromData",this)},_dispatchOnUpdateContentFromData:function(){this.dispatchEvent("onUpdateContentFromData",this)}})}),define("DS/MultiNotesWdg/Color",["UWA/Core","UWA/Class"],function(e,t){"use strict";function n(e){var t,n,a,l,d,c,h,u,f,g,_,m=[],p=[],v=[];if(e=function(e){return e.replace(/^\s+|\s+$/g,"")}(e.toLowerCase()),t=e.substr(0,1).toUpperCase(),n=e.substr(1),u=1,"R"!==t&&"Y"!==t&&"G"!==t&&"C"!==t&&"B"!==t&&"M"!==t&&"W"!==t||isNaN(n)||(e="ncol("+e+")"),isNaN(e)||(e="ncol("+e+")"),e.indexOf(",")>0&&-1===e.indexOf("(")&&(e="ncol("+e+")"),"rgb"===e.substr(0,3)||"hsl"===e.substr(0,3)||"hwb"===e.substr(0,3)||"ncol"===e.substr(0,4)||"cmyk"===e.substr(0,4)){if("ncol"===e.substr(0,4)?(4===e.split(",").length&&-1===e.indexOf("ncola")&&(e=e.replace("ncol","ncola")),a="ncol",e=e.substr(4)):"cmyk"===e.substr(0,4)?(a="cmyk",e=e.substr(4)):(a=e.substr(0,3),e=e.substr(3)),l=3,c=!1,"a"===e.substr(0,1).toLowerCase()?(l=4,c=!0,e=e.substr(1)):"cmyk"===a&&(l=4,5===e.split(",").length&&(l=5,c=!0)),m=(e=(e=e.replace("(","")).replace(")","")).split(","),"rgb"===a){if(m.length!==l)return{red:0,green:0,blue:0,hue:0,sat:0,lightness:0,whiteness:0,blackness:0,cyan:0,magenta:0,yellow:0,black:0,ncol:"R",opacity:1,valid:!1};for(d=0;d<l;d++){if(""!==m[d]&&" "!==m[d]||(m[d]="0"),m[d].indexOf("%")>-1&&(m[d]=m[d].replace("%",""),m[d]=Number(m[d]/100),d<3&&(m[d]=Math.round(255*m[d]))),isNaN(m[d]))return{red:0,green:0,blue:0,hue:0,sat:0,lightness:0,whiteness:0,blackness:0,cyan:0,magenta:0,yellow:0,black:0,ncol:"R",opacity:1,valid:!1};parseInt(m[d])>255&&(m[d]=255),d<3&&(m[d]=parseInt(m[d])),3===d&&Number(m[d])>1&&(m[d]=1)}_={r:m[0],g:m[1],b:m[2]},!0===c&&(u=Number(m[3]))}if("hsl"===a||"hwb"===a||"ncol"===a){for(;m.length<l;)m.push("0");for("hsl"!==a&&"hwb"!==a||parseInt(m[0])>=360&&(m[0]=0),d=1;d<l;d++){if(m[d].indexOf("%")>-1){if(m[d]=m[d].replace("%",""),m[d]=Number(m[d]),isNaN(m[d]))return{red:0,green:0,blue:0,hue:0,sat:0,lightness:0,whiteness:0,blackness:0,cyan:0,magenta:0,yellow:0,black:0,ncol:"R",opacity:1,valid:!1};m[d]=m[d]/100}else m[d]=Number(m[d]);Number(m[d])>1&&(m[d]=1),Number(m[d])<0&&(m[d]=0)}"hsl"===a&&(_=s(m[0],m[1],m[2]),f=Number(m[0]),g=Number(m[1])),"hwb"===a&&(_=r(m[0],m[1],m[2])),"ncol"===a&&(_=function(e,t,n){var i,o,s;if(s=e,isNaN(e.substr(0,1))){if(i=e.substr(0,1).toUpperCase(),""===(o=e.substr(1))&&(o=0),o=Number(o),isNaN(o))return!1;"R"===i&&(s=0+.6*o),"Y"===i&&(s=60+.6*o),"G"===i&&(s=120+.6*o),"C"===i&&(s=180+.6*o),"B"===i&&(s=240+.6*o),"M"===i&&(s=300+.6*o),"W"===i&&(s=0,t=1-o/100,n=o/100)}return r(s,t,n)}(m[0],m[1],m[2])),!0===c&&(u=Number(m[3]))}if("cmyk"===a){for(;m.length<l;)m.push("0");for(d=0;d<l;d++){if(m[d].indexOf("%")>-1){if(m[d]=m[d].replace("%",""),m[d]=Number(m[d]),isNaN(m[d]))return{red:0,green:0,blue:0,hue:0,sat:0,lightness:0,whiteness:0,blackness:0,cyan:0,magenta:0,yellow:0,black:0,ncol:"R",opacity:1,valid:!1};m[d]=m[d]/100}else m[d]=Number(m[d]);Number(m[d])>1&&(m[d]=1),Number(m[d])<0&&(m[d]=0)}_=function(e,t,n,i){var o,s,a;return o=255-255*Math.min(1,e*(1-i)+i),s=255-255*Math.min(1,t*(1-i)+i),a=255-255*Math.min(1,n*(1-i)+i),{r:o,g:s,b:a}}(m[0],m[1],m[2],m[3]),!0===c&&(u=Number(m[4]))}}else{for(h=!1,p=o("names"),d=0;d<p.length;d++)if(e.toLowerCase()===p[d].toLowerCase()){h=!0,_={r:(v=o("rgbs"))[d][0],g:v[d][1],b:v[d][2]};break}if(!1===h){for(3===(e=e.replace("#","")).length&&(e=e.substr(0,1)+e.substr(0,1)+e.substr(1,1)+e.substr(1,1)+e.substr(2,1)+e.substr(2,1)),m[0]=parseInt(e.substr(0,2),16),m[1]=parseInt(e.substr(2,2),16),m[2]=parseInt(e.substr(4,2),16),d=0;d<3;d++)if(isNaN(m[d]))return{red:0,green:0,blue:0,hue:0,sat:0,lightness:0,whiteness:0,blackness:0,cyan:0,magenta:0,yellow:0,black:0,ncol:"R",opacity:1,valid:!1};_={r:m[0],g:m[1],b:m[2]}}}return i(_,u,f,g)}function i(e,t,n,i){var o,s,a,r,l,d,c,h;return e?(t||(t=1),o=function(e,t,n){var i,o,s,a,r,l,d,c=[];for(c[0]=e/255,c[1]=t/255,c[2]=n/255,i=c[0],o=c[0],l=0,s=0;s<c.length-1;s++)c[s+1]<=i&&(i=c[s+1]),c[s+1]>=o&&(o=c[s+1],l=s+1);0===l&&(d=(c[1]-c[2])/(o-i));1===l&&(d=2+(c[2]-c[0])/(o-i));2===l&&(d=4+(c[0]-c[1])/(o-i));isNaN(d)&&(d=0);(d*=60)<0&&(d+=360);a=(i+o)/2,r=i===o?0:a<.5?(o-i)/(o+i):(o-i)/(2-o-i);return{h:d,s:r,l:a}}(e.r,e.g,e.b),s=function(e,t,n){var i;e/=255,t/=255,n/=255;var o=Math.max(e,t,n),s=Math.min(e,t,n),a=o-s;i=0===a?0:e===o?(t-n)/a%6*360:t===o?((n-e)/a+2)%6*360:((e-t)/a+4)%6*360;return{h:i,w:s,b:n=1-o}}(e.r,e.g,e.b),a=function(e,t,n){var i,o,s,a;e/=255,t/=255,n/=255;var r=Math.max(e,t,n);1==(a=1-r)?(i=0,o=0,s=0):(i=(1-e-a)/(1-a),o=(1-t-a)/(1-a),s=(1-n-a)/(1-a));return{c:i,m:o,y:s,k:a}}(e.r,e.g,e.b),d=n||o.h,c=i||o.s,r=function(e){for(;e>=360;)e-=360;if(e<60)return"R"+e/.6;if(e<120)return"Y"+(e-60)/.6;if(e<180)return"G"+(e-120)/.6;if(e<240)return"C"+(e-180)/.6;if(e<300)return"B"+(e-240)/.6;if(e<360)return"M"+(e-300)/.6}(d),l={red:e.r,green:e.g,blue:e.b,hue:d,sat:c,lightness:o.l,whiteness:s.w,blackness:s.b,cyan:a.c,magenta:a.m,yellow:a.y,black:a.k,ncol:r,opacity:t,valid:!0},(h=l).red=Number(h.red.toFixed(0)),h.green=Number(h.green.toFixed(0)),h.blue=Number(h.blue.toFixed(0)),h.hue=Number(h.hue.toFixed(0)),h.sat=Number(h.sat.toFixed(2)),h.lightness=Number(h.lightness.toFixed(2)),h.whiteness=Number(h.whiteness.toFixed(2)),h.blackness=Number(h.blackness.toFixed(2)),h.cyan=Number(h.cyan.toFixed(2)),h.magenta=Number(h.magenta.toFixed(2)),h.yellow=Number(h.yellow.toFixed(2)),h.black=Number(h.black.toFixed(2)),h.ncol=h.ncol.substr(0,1)+Math.round(Number(h.ncol.substr(1))),h.opacity=Number(h.opacity.toFixed(2)),l=h):{red:0,green:0,blue:0,hue:0,sat:0,lightness:0,whiteness:0,blackness:0,cyan:0,magenta:0,yellow:0,black:0,ncol:"R",opacity:1,valid:!1}}function o(e){return"names"===e?["AliceBlue","AntiqueWhite","Aqua","Aquamarine","Azure","Beige","Bisque","Black","BlanchedAlmond","Blue","BlueViolet","Brown","BurlyWood","CadetBlue","Chartreuse","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","DarkBlue","DarkCyan","DarkGoldenRod","DarkGray","DarkGrey","DarkGreen","DarkKhaki","DarkMagenta","DarkOliveGreen","DarkOrange","DarkOrchid","DarkRed","DarkSalmon","DarkSeaGreen","DarkSlateBlue","DarkSlateGray","DarkSlateGrey","DarkTurquoise","DarkViolet","DeepPink","DeepSkyBlue","DimGray","DimGrey","DodgerBlue","FireBrick","FloralWhite","ForestGreen","Fuchsia","Gainsboro","GhostWhite","Gold","GoldenRod","Gray","Grey","Green","GreenYellow","HoneyDew","HotPink","IndianRed ","Indigo  ","Ivory","Khaki","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenRodYellow","LightGray","LightGrey","LightGreen","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSlateGrey","LightSteelBlue","LightYellow","Lime","LimeGreen","Linen","Magenta","Maroon","MediumAquaMarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MidnightBlue","MintCream","MistyRose","Moccasin","NavajoWhite","Navy","OldLace","Olive","OliveDrab","Orange","OrangeRed","Orchid","PaleGoldenRod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","Pink","Plum","PowderBlue","Purple","RebeccaPurple","Red","RosyBrown","RoyalBlue","SaddleBrown","Salmon","SandyBrown","SeaGreen","SeaShell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","SlateGrey","Snow","SpringGreen","SteelBlue","Tan","Teal","Thistle","Tomato","Turquoise","Violet","Wheat","White","WhiteSmoke","Yellow","YellowGreen"]:"hexs"===e?["f0f8ff","faebd7","00ffff","7fffd4","f0ffff","f5f5dc","ffe4c4","000000","ffebcd","0000ff","8a2be2","a52a2a","deb887","5f9ea0","7fff00","d2691e","ff7f50","6495ed","fff8dc","dc143c","00ffff","00008b","008b8b","b8860b","a9a9a9","a9a9a9","006400","bdb76b","8b008b","556b2f","ff8c00","9932cc","8b0000","e9967a","8fbc8f","483d8b","2f4f4f","2f4f4f","00ced1","9400d3","ff1493","00bfff","696969","696969","1e90ff","b22222","fffaf0","228b22","ff00ff","dcdcdc","f8f8ff","ffd700","daa520","808080","808080","008000","adff2f","f0fff0","ff69b4","cd5c5c","4b0082","fffff0","f0e68c","e6e6fa","fff0f5","7cfc00","fffacd","add8e6","f08080","e0ffff","fafad2","d3d3d3","d3d3d3","90ee90","ffb6c1","ffa07a","20b2aa","87cefa","778899","778899","b0c4de","ffffe0","00ff00","32cd32","faf0e6","ff00ff","800000","66cdaa","0000cd","ba55d3","9370db","3cb371","7b68ee","00fa9a","48d1cc","c71585","191970","f5fffa","ffe4e1","ffe4b5","ffdead","000080","fdf5e6","808000","6b8e23","ffa500","ff4500","da70d6","eee8aa","98fb98","afeeee","db7093","ffefd5","ffdab9","cd853f","ffc0cb","dda0dd","b0e0e6","800080","663399","ff0000","bc8f8f","4169e1","8b4513","fa8072","f4a460","2e8b57","fff5ee","a0522d","c0c0c0","87ceeb","6a5acd","708090","708090","fffafa","00ff7f","4682b4","d2b48c","008080","d8bfd8","ff6347","40e0d0","ee82ee","f5deb3","ffffff","f5f5f5","ffff00","9acd32"]:"rgbs"===e?[[240,248,255],[250,235,215],[0,255,255],[127,255,212],[240,255,255],[245,245,220],[255,228,196],[0,0,0],[255,235,205],[0,0,255],[138,43,226],[165,42,42],[222,184,135],[95,158,160],[127,255,0],[210,105,30],[255,127,80],[100,149,237],[255,248,220],[220,20,60],[0,255,255],[0,0,139],[0,139,139],[184,134,11],[169,169,169],[169,169,169],[0,100,0],[189,183,107],[139,0,139],[85,107,47],[255,140,0],[153,50,204],[139,0,0],[233,150,122],[143,188,143],[72,61,139],[47,79,79],[47,79,79],[0,206,209],[148,0,211],[255,20,147],[0,191,255],[105,105,105],[105,105,105],[30,144,255],[178,34,34],[255,250,240],[34,139,34],[255,0,255],[220,220,220],[248,248,255],[255,215,0],[218,165,32],[128,128,128],[128,128,128],[0,128,0],[173,255,47],[240,255,240],[255,105,180],[205,92,92],[75,0,130],[255,255,240],[240,230,140],[230,230,250],[255,240,245],[124,252,0],[255,250,205],[173,216,230],[240,128,128],[224,255,255],[250,250,210],[211,211,211],[211,211,211],[144,238,144],[255,182,193],[255,160,122],[32,178,170],[135,206,250],[119,136,153],[119,136,153],[176,196,222],[255,255,224],[0,255,0],[50,205,50],[250,240,230],[255,0,255],[128,0,0],[102,205,170],[0,0,205],[186,85,211],[147,112,219],[60,179,113],[123,104,238],[0,250,154],[72,209,204],[199,21,133],[25,25,112],[245,255,250],[255,228,225],[255,228,181],[255,222,173],[0,0,128],[253,245,230],[128,128,0],[107,142,35],[255,165,0],[255,69,0],[218,112,214],[238,232,170],[152,251,152],[175,238,238],[219,112,147],[255,239,213],[255,218,185],[205,133,63],[255,192,203],[221,160,221],[176,224,230],[128,0,128],[102,51,153],[255,0,0],[188,143,143],[65,105,225],[139,69,19],[250,128,114],[244,164,96],[46,139,87],[255,245,238],[160,82,45],[192,192,192],[135,206,235],[106,90,205],[112,128,144],[112,128,144],[255,250,250],[0,255,127],[70,130,180],[210,180,140],[0,128,128],[216,191,216],[255,99,71],[64,224,208],[238,130,238],[245,222,179],[255,255,255],[245,245,245],[255,255,0],[154,205,50]]:void 0}function s(e,t,n){var i,o;return{r:255*a(i=2*n-(o=n<=.5?n*(t+1):n+t-n*t),o,(e/=60)+2),g:255*a(i,o,e),b:255*a(i,o,e-2)}}function a(e,t,n){return n<0&&(n+=6),n>=6&&(n-=6),n<1?(t-e)*n+e:n<3?t:n<4?(t-e)*(4-n)+e:e}function r(e,t,n){var i,o,a=[];for(o=s(e,1,.5),a[0]=o.r/255,a[1]=o.g/255,a[2]=o.b/255,i=0;i<3;i++)a[i]*=1-t-n,a[i]+=t,a[i]=Number(255*a[i]);return{r:a[0],g:a[1],b:a[2]}}function l(e){for(var t=e.toString(16);t.length<2;)t="0"+t;return t}return t.extend({init:function(e,t){var i;t=t||{},(i=n(e)).opacity=t.opacity||1,this.attachValues(i)},toRgbString:function(){return"rgb("+this.red+", "+this.green+", "+this.blue+")"},toRgbaString:function(e){return"rgba("+this.red+", "+this.green+", "+this.blue+", "+(e||this.opacity)+")"},toHwbString:function(){return"hwb("+this.hue+", "+Math.round(100*this.whiteness)+"%, "+Math.round(100*this.blackness)+"%)"},toHwbStringDecimal:function(){return"hwb("+this.hue+", "+this.whiteness+", "+this.blackness+")"},toHwbaString:function(){return"hwba("+this.hue+", "+Math.round(100*this.whiteness)+"%, "+Math.round(100*this.blackness)+"%, "+this.opacity+")"},toHslString:function(){return"hsl("+this.hue+", "+Math.round(100*this.sat)+"%, "+Math.round(100*this.lightness)+"%)"},toHslStringDecimal:function(){return"hsl("+this.hue+", "+this.sat+", "+this.lightness+")"},toHslaString:function(){return"hsla("+this.hue+", "+Math.round(100*this.sat)+"%, "+Math.round(100*this.lightness)+"%, "+this.opacity+")"},toCmykString:function(){return"cmyk("+Math.round(100*this.cyan)+"%, "+Math.round(100*this.magenta)+"%, "+Math.round(100*this.yellow)+"%, "+Math.round(100*this.black)+"%)"},toCmykStringDecimal:function(){return"cmyk("+this.cyan+", "+this.magenta+", "+this.yellow+", "+this.black+")"},toNcolString:function(){return this.ncol+", "+Math.round(100*this.whiteness)+"%, "+Math.round(100*this.blackness)+"%"},toNcolStringDecimal:function(){return this.ncol+", "+this.whiteness+", "+this.blackness},toNcolaString:function(){return this.ncol+", "+Math.round(100*this.whiteness)+"%, "+Math.round(100*this.blackness)+"%, "+this.opacity},toName:function(){var e,t=o("rgbs"),n=t.length;for(e=0;e<n;e++)if(this.red===t[e][0]&&this.green===t[e][1]&&this.blue===t[e][2])return o("names")[e];return""},toHexString:function(){return"#"+l(this.red)+l(this.green)+l(this.blue)},toRgb:function(){return{r:this.red,g:this.green,b:this.blue,a:this.opacity}},toHsl:function(){return{h:this.hue,s:this.sat,l:this.lightness,a:this.opacity}},toHwb:function(){return{h:this.hue,w:this.whiteness,b:this.blackness,a:this.opacity}},toCmyk:function(){return{c:this.cyan,m:this.magenta,y:this.yellow,k:this.black,a:this.opacity}},toNcol:function(){return{ncol:this.ncol,w:this.whiteness,b:this.blackness,a:this.opacity}},isDark:function(){return(299*this.red+587*this.green+114*this.blue)/1e3<128},lighter:function(e){var t,n;t=e/100||.1,this.lightness+=t,this.lightness>1&&(this.lightness=1),n=i(s(this.hue,this.sat,this.lightness),this.opacity,this.hue,this.sat),this.attachValues(n)},darker:function(e){var t,n;t=e/100||.1,this.lightness-=t,this.lightness<0&&(this.lightness=0),n=i(s(this.hue,this.sat,this.lightness),this.opacity,this.hue,this.sat),this.attachValues(n)},attachValues:function(e){this.red=e.red,this.green=e.green,this.blue=e.blue,this.hue=e.hue,this.sat=e.sat,this.lightness=e.lightness,this.whiteness=e.whiteness,this.blackness=e.blackness,this.cyan=e.cyan,this.magenta=e.magenta,this.yellow=e.yellow,this.black=e.black,this.ncol=e.ncol,this.opacity=e.opacity,this.valid=e.valid}})}),define("DS/MultiNotesWdg/Collections/Notes",["UWA/Class/Collection","UWA/Utils","UWA/String","DS/MultiNotesWdg/Models/Note","i18n!DS/MultiNotesWdg/assets/nls/MultiNotes"],function(e,t,n,i,o){"use strict";return e.extend({model:i,MultiNotes:null,dataManager:null,comparator:function(e,t){var n=this.dataManager.getNoteOrderIds();return n.indexOf(e.get("id"))-n.indexOf(t.get("id"))},setup:function(e,t){var n,i=t||{};this.MultiNotes=n=i.MultiNotes,this.dataManager=n.getDataManager()},sync:function(e,t,n){var i=this;return i.dataManager.hasFetchedData().then(function(){i.parse()?n.onComplete&&n.onComplete(i):n.onFailure&&n.onFailure("Error parsing data")}),{cancel:function(){}}},parse:function(){var e=this;return e.dataManager.getNoteIds().map(function(t){return e._parseNote(t)})},getSelected:function(){return this.find(function(e){return e.isSelected()})},onAdd:function(){this.MultiNotes.onEmptyCollection(!1)},onRemove:function(e){return this.MultiNotes.onEmptyCollection(!this.length),this.dataManager.deleteNote(e.get("id"))},addNewNote:function(e){e=e||{};var n,s,a=Date.now();return s={id:t.getUUID(),name:e.name||o.newItemName,color:e.color||"",createTime:a,updateTime:a,content:e.content||""},(n=new i(s)).setNewNote(!0),n.setModifiedInfo(!0),n.setModifiedContent(!0),n=this.add(n,{at:0})},addNote:function(e,t){var n;return n=new i(this._parseNote(e)),n=this.add(n,t)},updateNoteContent:function(e){return this.dataManager.updateNoteContent(e.get("id"))},updateNoteInfo:function(e){return this.dataManager.updateNoteInfo(e.get("id"))},hasFailToSave:function(){return this.some(function(e){return e.isFailToSave()})},hasModified:function(){return this.some(function(e){return e.isModified()})},retrySave:function(){this.forEach(function(e){e.isFailToSave()&&e.retrySave()})},dispatchSelectNote:function(e){this.dispatchEvent("selectNote",e)},dispatchOnPrefFixedToolbarChange:function(e){this.dispatchEvent("onPrefFixedToolbarChange",e)},_parseNote:function(e){var t,i=this.dataManager;try{t=i.getParsedNoteInfo(e)}catch(e){t=null}return t||(t={name:o.newItemName,color:"",createTime:Date.now(),updateTime:Date.now()}),t.id=e,t.content=i.getNoteContent(e),t.name=n.stripTags(t.name),t.versions={info:i.getNoteInfoVersion(e),content:i.getNoteContentVersion(e)},t.states={selected:i.getSelectedNoteId()===e},t}})}),define("DS/MultiNotesWdg/ColorPicker",["UWA/Core","UWA/Class/View","DS/MultiNotesWdg/Color","css!DS/MultiNotesWdg/ColorPicker"],function(e,t,n){"use strict";function i(){}return t.extend({BG_CUSTOM_COLOR_OPACITY:.1,DARK_BG:1,DARK_COLOR:1,ACTIVE_CLASS:"active",tagName:"div",className:"colorpicker-view",colorMatrix:[["#E53F33","#FF4289","#A821BF","#703AC6","#4456C4"],["#6DA3BF","#169EFF","#05C6E2","#1C6821","#54913A"],["#93D149","#D8ED26","#FFFF26","#FFCE05","#FF7C00"],["#FF5E0C","#845B4F","#888888","#333333","reset"]],selectedColor:"",setup:function(t){var n;(t=t||{}).events=n=t.events||{},this.options=t,this.selectedColor=t.selectedColor,!e.is(n.colorChange,"function")&&(n.colorChange=i)},render:function(){var t,i,o,s,a,r=e.createElement,l=this,d=l.ACTIVE_CLASS,c=l.container,h=l.selectedColor,u=l.colorMatrix||[],f=u.length;for("overflow-style"===l.options.style&&c.addClassName("overflow-style"),t=0;t<f;t++){for(s=u[t],a=r("div",{class:"color-line line"+t}),i=0;i<s.length;i++){o=s[i];var g=r("div",{class:"color-ctn"}).inject(a);"reset"!==o?(g.addEvent("click",function(){l._onColorClick(this)}),g.setData("color",o),o===h&&g.addClassName(d),r("div",{class:"color ghost",styles:{background:new n(o).toRgbaString(l.DARK_COLOR)}}).inject(g),r("div",{class:"color alive",styles:{background:new n(o).toRgbaString(o===h?l.DARK_BG:l.DARK_COLOR)}}).setData("color",o).inject(g)):(g.setData("color","#fff"),g.addEvent("click",function(){l._onResetColorClick(this)}),!h&&g.addClassName(d),r("div",{class:"color reset-color",styles:{background:"#fff"}}).inject(g))}a.inject(c)}return l},getSelectedColor:function(){return this.selectedColor},destroy:function(){this._parent.apply(this,arguments)},_unSelectAllBasic:function(){var e=this;e.container.getElements(".color-ctn").forEach(function(t){var i=t.getElement(".color.alive");t.removeClassName(e.ACTIVE_CLASS),i&&i.setStyle("background",new n(t.getData("color")).toRgbaString(e.DARK_COLOR))})},_unSelectCustom:function(){var e=this.elements.customColor;e&&(e.removeClassName(this.ACTIVE_CLASS),e.setStyle("background",null))},_onColorClick:function(e){var t=e.getData("color");this._unSelectAllBasic(),this._unSelectCustom(),e.addClassName(this.ACTIVE_CLASS),e.getElement(".color.alive").setStyle("background",new n(t).toRgbaString(this.DARK_BG)),this._onColorChange(t)},_onColorPickerChange:function(){var e=this.elements,t=e.customColorInput.value,i=e.customColor;this._unSelectAllBasic(),i.addClassName(this.ACTIVE_CLASS),i.setStyle("background",new n(t).toRgbaString(this.BG_CUSTOM_COLOR_OPACITY)),this._onColorChange(t)},_onResetColorClick:function(e){this._unSelectAllBasic(),this._unSelectCustom(),e.addClassName(this.ACTIVE_CLASS),this._onColorChange("")},_onColorChange:function(e){this.selectedColor=e,this.options.events.colorChange(e)}})}),define("DS/MultiNotesWdg/Views/EditNote",["UWA/Core","UWA/String","UWA/Class/View","UWA/Event","UWA/Utils/Client","DS/UIKIT/SuperModal","DS/UIKIT/Tooltip","DS/UIKIT/Alert","DS/UWPClientControls/Utils","DS/MultiNotesWdg/Color","i18n!DS/MultiNotesWdg/assets/nls/MultiNotes","css!DS/MultiNotesWdg/Views/EditNote"],function(e,t,n,i,o,s,a,r,l,d,c){"use strict";var h="editor-toolbar";return n.extend({MAX_LENGTH:5e4,MIN_UI_WIDTH:200,VERY_SMALL_UI_WIDTH:450,SMALL_UI_WIDTH:650,tagName:"div",className:"edit-note-view",MultiNotes:null,_snapshot:"",_isIdCardEditMode:!1,_Editor:null,_isCTRLPressed:!1,_editorConfig:{removePlugins:"sourcearea,resize,elementspath,autogrow,maximize,exportpdf",extraPlugins:"autohyperlink,sharedspace",sharedSpaces:{top:h},removeButtons:"",linkShowAdvancedTab:!1,linkShowTargetTab:!1,title:!1,disableNativeSpellChecker:!1,toolbar_basic:[{name:"clipboard",items:["Undo","Redo"]},{name:"styles",items:["Bold","Italic","Underline","Strike","Subscript","Superscript","-","RemoveFormat"]},{name:"lists",items:["NumberedList","BulletedList","-","Outdent","Indent","-","Blockquote"]},{name:"links",items:["Link","Unlink"]},{name:"insert",items:["Table","HorizontalRule","SpecialChar"]},{name:"styles",items:["Styles","Format"]}],toolbar_smallUI:[{name:"clipboard",items:["Undo","Redo"]},{name:"styles",items:["Bold","Italic","Underline","Strike","-","RemoveFormat"]},{name:"insert",items:["HorizontalRule"]},{name:"styles",items:["Format"]}],toolbar:"basic"},_alert:null,_isTyping:!1,_preventHideToolbarOnScroll:!1,_editorToolbarStyle:{},_editorToolbarVisible:!1,_prefFixedToolbar:!1,_setToolbarPositionThrottled:null,_isDestroy:!1,setup:function(e){var t=e||{};this._setToolbarPositionThrottled=null,this.MultiNotes=t.MultiNotes,this._snapshot=this.model.get("content"),this._prefFixedToolbar=this.MultiNotes.getDataManager().getPrefFixedToolbar(),this._addModelListeners(),this.listenTo(this.MultiNotes.getCollection(),{onPrefFixedToolbarChange:this._onPrefFixedToolbarChange.bind(this)}),this._onKeyUpFn=this._onKeyUp.bind(this),window.addEventListener("keyup",this._onKeyUpFn),this._onKeyDownFn=this._onKeyDown.bind(this),window.addEventListener("keydown",this._onKeyDownFn)},_addModelListeners:function(){var e=this;e.stopListening(),e.listenTo(e.model,{onChange:function(){!e._isReadOnly()&&e._setUpdateTime()},"onChange:color":e._setColor.bind(e),onModified:e._onModified.bind(e),onSaveInProgress:e._onSaveInProgress.bind(e),onReadOnly:e._onReadOnlyChange.bind(e),onFailToSave:e._onFailToSave.bind(e),onConflictEdited:e._onConflictEdited.bind(e),onConflictDeleted:e._onConflictDeleted.bind(e),onUpdateInfoFromData:e._onUpdateInfoFromData.bind(e),onUpdateContentFromData:e._onUpdateContentFromData.bind(e)})},render:function(){var t,n,i,o="div",s=e.createElement,r=this.container,l=this.elements;return l.editorToolbar=s(o,{id:h,class:[h,this._getPrefFixedToolbar()?"":"animate"].join(" ")}).inject(r),l.editorCtn=s(o,{class:"editor-ctn",html:l.textarea=s(o,{class:"note-content"})}).inject(r),l.charCounter=s(o,{class:"charcounter",events:{click:this._hideEditorToolbar.bind(this,{force:!0})}}).inject(r),t=s(o,{class:"time-info",events:{click:this._hideEditorToolbar.bind(this)}}).inject(r),l.updateTime=s(o,{class:"updatetime"}).inject(t),l.createTime=s(o,{class:"createtime"}).inject(t),l.dropZone=s(o,{class:"drop-zone",text:c.dropMergeNote}).inject(r),l.errorIcon=n=s(o,{class:"error-icon-ctn",html:s("span",{class:"icon error-icon fonticon fonticon-alert"}),events:{click:this._onErrorIconClick.bind(this)}}).inject(r),new a({target:n,body:c.failToSaveTooltip}),l.modifiedIcon=i=s(o,{class:"modified-icon-ctn",html:l.modifiedIcon=i=s("span",{class:"icon error-icon fonticon fonticon-record"})}).inject(r),new a({target:i,body:c.modifiedTooltip}),l.goToLink=e.createElement("a",{class:"go-to-link",text:c.goToLink,target:"_blank"}).inject(r),this},onPostInject:function(){var e=(this.elements||{}).textarea,t=this.model,n=this.MultiNotes.getQuerySearch();e&&(this._checkSmallUI(),this._setName(),this._setColor(),this._setUpdateTime(),this._setCreateTime(),this._setContent(),n&&!this._isIdCardEditMode&&this._onFilteringIdCard(n),t.isFailToSave()&&this._onFailToSave(),t.isSaveInProgress()&&this._onSaveInProgress(),t.isModified()&&this._onModified(),t.isConflictEdited()&&this._onConflictEdited(),t.isConflictDeleted()&&this._onConflictDeleted(),this._isReadOnly()?this._switchToReadOnly():this._initEditor())},onDragOver:function(){this._hideEditorToolbar(),this.elements.dropZone.addClassName("hover")},onDragLeave:function(){this.elements.dropZone.removeClassName("hover")},switchToEditMode:function(){var t,n,o=this,s=o._getIdCard();function a(e){var t=s.model;(e=e.trim().stripScripts().escapeHTML())!==t.get("name")&&t.set("name",e)}o._hideEditorToolbar(),s.switchToEditMode(),o._isIdCardEditMode=!0,(t=s.elements.titleSection.getElement('input[type="text"]')).addEvents({blur:function(){o._isIdCardEditMode&&(a(this.value),o._switchToViewMode())},keyup:function(e){if(o._isIdCardEditMode){var t=i.whichKey(e);"return"===t?(a(this.value),o._switchToViewMode(),o.elements.textarea.focus()):"esc"===t&&o._switchToViewMode()}}}),(n=e.createElement("textarea")).setHTML(o.model.get("name")),t.value=n.value,n.destroy(),setTimeout(function(){t&&(t.select(),o._isTouchEvents()&&t.setSelectionRange(0,9999))},100)},_switchToViewMode:function(){var e=this.MultiNotes,t=this._getIdCard(),n=e.getQuerySearch();t.switchToViewMode(),this._isIdCardEditMode=!1,this._setName(),this._addIdCardEvents(),n&&this.onFiltering(n)},_switchToReadOnly:function(){if(this.elements){var e=this._getIdCard(),t=this.MultiNotes.getQuerySearch();this._onEditorBlur(),this._destroyEditor(),this.elements.textarea.removeAttribute("contenteditable"),this.container.addClassName("readonly"),e.getContent().addClassName("readonly-note-idcard"),this._saveContent({silent:!0}),t&&this._onFilteringEditor(t)}},refreshView:function(e,t){if(this.elements){t=t||{};var n=this.MultiNotes.getQuerySearch();this.model=e,this._addModelListeners(this.model),this._setName(),this._setColor(),this._setUpdateTime(),n&&!this._isIdCardEditMode&&this._onFilteringIdCard(n),e.isConflictEdited()||e.isConflictDeleted()||e.isFailToSave()||this._removeAlert(),this._onFailToSave(),this._onSaveInProgress(),this._onModified(),this._onConflictEdited(),this._onConflictDeleted(),t.light||this._setContent()}},mergeNote:function(e){var t="";t=this.elements.textarea.getHTML(),t+="<hr>",t+="<p><strong>"+e.get("name")+"</strong></p>",t+=e.get("content"),this._Editor.setData(t)},onSkeletonSlideEnd:function(){var e=this.model;this.onResize(),this._addIdCardEvents();var t=e.get("createTime");if(new Date-t<3e4&&!e.get("content")&&(this._focusEditor(),!this._isEditorToolbarVisible())){this._setEditorToolbarPosition({top:30})}},onResize:function(){if(this._Editor&&this.elements){var e=this.container.getDimensions().width;e<this.MIN_UI_WIDTH&&this.MultiNotes.getSkeleton().setContractedLayout({animate:!1}),this._checkSmallUI(),this._setUpdateTime(),this._setCreateTime(),(e<this.VERY_SMALL_UI_WIDTH&&"smallUI"!==this._Editor.config.toolbar||e>this.VERY_SMALL_UI_WIDTH&&"smallUI"===this._Editor.config.toolbar)&&this._initEditor(),this._isEditorToolbarVisible()&&this._setEditorToolbarPosition()}},onFiltering:function(e){!this._isIdCardEditMode&&this._onFilteringIdCard(e),this._onFilteringEditor(e)},destroy:function(){this._isDestroy=!0,this.stopListening(),window.removeEventListener("keyup",this._onKeyUpFn),window.removeEventListener("keydown",this._onKeyDownFn),this._removeAlert(),this._destroyEditor(),this._editorConfig=null,this._parent.apply(this,arguments),this.elements=null},_getIdCard:function(){return this.MultiNotes.getSkeleton().getActiveIdCard()},_setName:function(){var e=this._getIdCard();e&&e.elements.titleSection.getElement("h1>span").setHTML(this.model.get("name"))},_setColor:function(t){var n,i=this.container;i&&(t=e.is(t,"string")?t:this.model.get("color")||"",n=new d(t),i&&i.setStyles({background:t?n.toRgbaString(this.MultiNotes.DARK_BG):""}))},_setUpdateTime:function(e){var t,n,i=this.MultiNotes,o=this.elements.updateTime;e=e||this.model.get("updateTime"),n=i.formatUShortDate(e),t=i.formatShortDate(e)+" - "+i.formatTime(e),o.setText(i.replace(c.updatedTime,{date:this._isSmallUI()?n:t})).setAttribute("title",t),o.setData("time",e)},_setCreateTime:function(){var e,t,n=this.model.get("createTime"),i=this.MultiNotes,o=this.elements.createTime;e=i.formatUShortDate(n),t=i.formatShortDate(n),o.setText(i.replace(c.createdTime,{date:this._isSmallUI()?e:t})).setAttribute("title",t+" - "+i.formatTime(n)),o.setData("time",n)},_setContent:function(){var e=(this.elements||{}).textarea,t=this.model.get("content");e&&e.setHTML(this._isReadOnly()?this._addBlankTargetToLink(t):t)},_focusEditor:function(){(this.elements||{}).textarea.focus()},_isSafariOnIos:function(){return!(!o.Platform.ios&&!o.Platform.ipad)&&"safari"===o.Engine.name},_isSmallUI:function(){return this.container.hasClassName("small-ui")},_isEditorToolbarVisible:function(){return this._editorToolbarVisible},_checkSmallUI:function(){var e=this.container;e.toggleClassName("small-ui",e.getDimensions().width<this.SMALL_UI_WIDTH)},_onResolveConflictbyRefresh:function(){var e=this.model;this._removeAlert(),e.isConflictDeleted()?this.MultiNotes.deleteNote(e):e.isConflictEdited()&&e.resolveConflictEdited()},_onResolveConflictbyDuplicate:function(){var e=this.model,t=e.clone();return this._removeAlert(),e.isConflictDeleted()?(e.setSelected(!1),this.MultiNotes.deleteNote(e)):e.isConflictEdited()&&e.resolveConflictEdited(),this.MultiNotes.duplicateNote(t)},_onFilteringEditor:function(e){var n=RegExp(e,"i"),i=t.stripTags(this._snapshot||"").trim(),o=this.elements.textarea;e=e||"",!i||e&&!n.test(i)||(e?this._applyHTMLHighlight(o):this._cleanHTMLHighlight(o))},_onFilteringIdCard:function(e){var t,n,i=this._getIdCard(),o=RegExp(e,"gi");n=(t=i.elements.titleSection).getElement("h1>span").getHTML(),e&&(this._previousTitle=this._previousTitle||n),n=e?n.replace(o,this.MultiNotes.applyHighlight):this._previousTitle||n,t.getElement("h1>span").setHTML(n)},_onEditorInstanceReady:function(e){var t=e.editor,n=this.MultiNotes.getQuerySearch();this._setContent(),this._Editor=t,this._snapshot=t.getSnapshot(),this._hasReachLimit(this._snapshot),this._addEditorEvents(),this.onResize(),n&&this._onFilteringEditor(n)},_onEditorContentChange:function(e){var t;if(t=e.getSnapshot().trim(),this._hasReachLimit(t))return e.loadSnapshot(this._snapshot),this._hasReachLimit(this._snapshot),e.config.Locked=1,void new s({closable:!0,renderTo:this.container}).alert(this.MultiNotes.replace(c.limitReached,{nbCharMax:this.MAX_LENGTH}));e.config.Locked=0,this._snapshot=t,this._saveContent()},_onEditorFocus:function(){},_onEditorBlur:function(){var e=this;setTimeout(function(){e._manageGoToLink(null,{hide:!0})},200)},_onEditorMouseDown:function(){},_onEditorClick:function(e){if(this.elements){var t=this.MultiNotes.getWidget();this._manageGoToLink(e),this._setEditorToolbarPosition({top:this._getPrefFixedToolbar()?0:this._getEditorToolbarPositionOnClick(e)}),this._isTouchEvents()&&"maximized"!==(t._view||{}).type&&t.requestView("maximized")}},_onEditorKeyup:function(e){var t=this;switch(t._preventHideToolbarOnScroll=!0,e.code){case"Escape":t._Editor.ui.contentsElement.$.blur()}t._manageGoToLink(null,{hide:!0}),t._setToolbarPositionThrottled||(t._setToolbarPositionThrottled=l.throttle(function(){t._isDestroy||t._setEditorToolbarPosition({top:t._getPrefFixedToolbar()?0:t._getEditorToolbarPositionOnKeyUp(e)})},500)),t._setToolbarPositionThrottled(e)},_onEditorKeydown:function(e){var t=e.keyCode;if(34===t||33===t)return e.stopPropagation(),void e.preventDefault()},_onEditorScroll:function(){this._manageGoToLink(null,{hide:!0}),this._preventHideToolbarOnScroll?this._preventHideToolbarOnScroll=!1:this._hideEditorToolbar()},_addIdCardEvents:function(){var e=this;e._getIdCard().elements.titleSection.addEvent("click",function(){e._isIdCardEditMode||e._isReadOnly()||e.switchToEditMode()})},_initEditor:function(){var t=this;return t._destroyEditor(),new Promise(function(n,i){var o=t.elements.textarea,s=t._editorConfig;s.allowedContent={$1:{elements:window.CKEDITOR.dtd,attributes:!0,styles:!0,classes:!0}},s.disallowedContent="img",s.on={instanceReady:function(e){t._onEditorInstanceReady(e),t._setColor(),n()}},s.language=t.MultiNotes.getCkeditorLang(),s.toolbar=t.container.getDimensions().width<t.VERY_SMALL_UI_WIDTH?"smallUI":"basic",o.setAttribute("contenteditable",!0);try{window.CKEDITOR.inline(o,s)}catch(t){e.log(t),i(t)}})},_addEditorEvents:function(){var e=this,t=(e.elements||{}).textarea,n=e._Editor,i=n.ui.contentsElement.$;if(t){if(n.on("change",function(){!e._isSilentEditorChange&&e._onEditorContentChange(this),e._isSilentEditorChange=!1},n,null,100),e._isTouchEvents()){let t;i.addEventListener("touchstart",e=>{this._onEditorMouseDown(e),t=e}),i.addEventListener("touchend",function(n){var i,o;i=Math.abs(t.targetTouches[0].clientX-n.changedTouches[0].clientX),o=Math.abs(t.targetTouches[0].clientY-n.changedTouches[0].clientY),i<20&&o<20&&setTimeout(()=>{e._onEditorClick(t)},100)})}else i.addEventListener("mousedown",e._onEditorMouseDown.bind(e)),i.addEventListener("click",e._onEditorClick.bind(e));i.addEventListener("keyup",e._onEditorKeyup.bind(e)),i.addEventListener("keydown",e._onEditorKeydown.bind(e)),i.addEventListener("scroll",e._onEditorScroll.bind(e)),i.addEventListener("focus",e._onEditorFocus.bind(e)),i.addEventListener("blur",e._onEditorBlur.bind(e))}else e._destroyEditor()},_destroyEditor:function(){var e=(this.elements||{}).textarea;if(this._Editor&&(window.CKEDITOR.instances[this._Editor.name].destroy(),this._Editor.destroy(),this._Editor=null),e){for(var t in window.CKEDITOR.instances){var n=window.CKEDITOR.instances[t];n&&n.element.$===e&&n.destroy()}e.removeEvent("focus")}},_hideEditorToolbar:function(e){e=e||{};this._getPrefFixedToolbar()&&!e.force||(this._editorToolbarStyle={opacity:0,transform:"translateX(100vw)"},this.elements.editorToolbar.setStyles(this._editorToolbarStyle),this.elements.textarea.setStyles({"margin-top":null,height:null}),this._editorToolbarVisible=!1)},_getCursorPosition:function(){var e=window.getSelection().focusNode,t=e;return e.nodeType===Node.TEXT_NODE&&(t=e.parentNode),t.getBoundingClientRect()},_getPrefFixedToolbar:function(){return this._prefFixedToolbar},_getEditorToolbarPositionOnClick:function(e){var t,n,i,o,s,a=this.elements,r=a.textarea,l=a.editorToolbar,d=a.goToLink;return t=r.getBoundingClientRect().top,i=(n=(e.clientY||e.touches[0].clientY)-t)-l.clientHeight-25,s=(o={top:this._goToLinkDisplayed?d.getStyle("top"):null}).top?d.clientHeight:0,o.top&&(i-=s-12.5),i<t&&(i=n+25,o.top&&(i+=s-12.5)),i},_getEditorToolbarPositionOnKeyUp:function(){var e,t,n,i,o=this.elements,s=o.textarea,a=o.editorToolbar;return e=window.document.body.clientHeight,n=s.getBoundingClientRect().top,t=a.clientHeight,i=this._getCursorPosition().top<e/2?e-t:n,i-=n},_setEditorToolbarPosition:function(e){e=e||{};var t=this._getPrefFixedToolbar(),n=this.elements,i=n.editorToolbar,o=n.textarea,s=i.clientHeight,a=parseInt(this._editorToolbarStyle.top||0,10),r=e.force,l=t?0:e.top||a;(r||!a||"translateX(0)"!==this._editorToolbarStyle.transform||Math.abs(a-l)>11||t)&&(this._editorToolbarStyle={top:`${l}px`,transform:"translateX(0)",opacity:null},i.setStyles(this._editorToolbarStyle),o.setStyles({"margin-top":t?s:null,height:t?`calc(100% - ${s}px)`:null}),this._editorToolbarVisible=!0)},_setCTRLPressed:function(e){var t=this.container;this._isCTRLPressed=e,e?t.addClassName("ctrl-pressed"):t.removeClassName("ctrl-pressed")},_saveContent:function(t){var n=e.clone(this.elements.textarea);this.MultiNotes.getQuerySearch()&&this._cleanHTMLHighlight(n),this.model.set("content",n.innerHTML,t)},_manageGoToLink:function(e,t){if(t=t||{},!this.elements||!this._Editor)return;var n,i,o,s=this,a=s._Editor,r=s.elements.goToLink;function l(){s._goToLinkDisplayed=!1,r.setStyles({top:"-10000px",left:"-10000px"})}if(t.hide)return void l();try{o=window.CKEDITOR.plugins.link.getSelectedLink(a)||(e.data||{}).element}catch(t){o=(e.data||{}).element}if(!o||!o.is("a"))return void l();if(n=o.$,e.stopPropagation(),s._isCTRLPressed)return l(),s._setCTRLPressed(!1),void window.open(n.href,"_blank");s._isTouchEvents()&&r.addEvent("touchend",function(){this.click()}),i=n.getBoundingClientRect();const d=s.container.getBoundingClientRect(),c=r.clientHeight;let h=i.top-c;const u=i.left-d.left;h<d.top&&(h=i.bottom),h-=d.top,r.setAttributes({href:n.href}),r.setStyles({top:h?`${h}px`:null,left:`${u}px`}),s._goToLinkDisplayed=!0},_isTouchEvents:function(){return this.MultiNotes.isTouchDevice()},_hasReachLimit:function(e){if(!this.elements)return!1;var n,i,o,s,a=this.elements.charCounter,r=this.MAX_LENGTH;return i=r+((o=(e=e.replace(/(\r\n|\n|\r)/gm,"").replace(/&nbsp;/gi," ")).length)-(n=t.stripTags(e).length)),s=r-n,a.setText(s),a.toggleClassName("text-warning",o>=.75*i&&o<=.9*i),a.toggleClassName("text-error",o>.9*i),o>i},_isReadOnly:function(){return this.MultiNotes.isReadOnlyMode()||this.model.isReadOnly()},_onReadOnlyChange:function(e){if((e=e||this.model).isReadOnly())this._switchToReadOnly();else{var t=this._getIdCard();this.container.removeClassName("readonly"),t&&t.getContent().removeClassName("readonly-note-idcard"),this.refreshView(e,{light:!1}),this._initEditor()}},_onFailToSave:function(e){(e=e||this.model).isFailToSave()?(this.container.addClassName("not-saved"),this._showAlert({message:this.MultiNotes.replace(c.failToSaveAlert,{retryClass:this.MultiNotes.RETRY_BTN_CLASS}),type:"error"})):this.container.removeClassName("not-saved")},_onSaveInProgress:function(e){(e=e||this.model).isSaveInProgress()?this.container.addClassName("save-in-progress"):this.container.removeClassName("save-in-progress")},_onModified:function(e){(e=e||this.model).isModified()?this.container.addClassName("modified"):this.container.removeClassName("modified")},_onErrorIconClick:function(){this.MultiNotes.showNotSavedPopover(this.elements.errorIcon,this.model)},_onRetrySave:function(){this._removeAlert(),this.model.collection.retrySave()},_onConflictEdited:function(e){(e=e||this.model).isConflictEdited()?(this.container.addClassName("conflict-edited"),this._showAlert({message:this.MultiNotes.replace(c.noteNotUpToDateMsg,{refreshClass:"refresh-btn",duplicateClass:"duplicate-btn"}),type:"warning",closable:!1,onHide:this._onConflictEdited.bind(this)})):this.container.removeClassName("conflict-edited")},_onConflictDeleted:function(e){if((e=e||this.model).isConflictDeleted()){this.container.addClassName("conflict-deleted");var t=e.isModified()?c.conflictNoteDeletedMsg:c.noteDeletedMsg;this._showAlert({message:this.MultiNotes.replace(t,{refreshClass:"refresh-btn",duplicateClass:"duplicate-btn"}),type:"error",closable:!1,onHide:this._onConflictDeleted.bind(this)})}else this.container.removeClassName("conflict-deleted")},_onUpdateInfoFromData:function(e){this.refreshView(e,{light:!0})},_onUpdateContentFromData:function(e){this.refreshView(e,{light:!1})},_onKeyUp:function(e){switch(e.code){case"ControlLeft":case"ControlRight":this._setCTRLPressed(!1);break;case"Escape":this._hideEditorToolbar({force:!0})}},_onKeyDown:function(e){switch(e.code){case"ControlLeft":case"ControlRight":this._setCTRLPressed(!0),this._hideEditorToolbar()}},_showAlert:function(e){var t,n,i=this,o="alert-edit-note";e=e||{},i._removeAlert(),t="boolean"!=typeof e.closable||e.closable,n=["alert alert-multinotes",o,t?"":"not-closable"].join(" "),i._alert=new r({className:n,closable:t,visible:!0,messages:e.message||c.errorTryLater,messageClassName:e.type||"error",events:{onShow:function(){var e=i.container,t=e.getElement("."+o+" .refresh-btn"),n=e.getElement("."+o+" .duplicate-btn"),s=e.getElement("."+o+" ."+i.MultiNotes.RETRY_BTN_CLASS);t&&t.addEvent("click",i._onResolveConflictbyRefresh.bind(i)),n&&n.addEvent("click",i._onResolveConflictbyDuplicate.bind(i)),s&&s.addEvent("click",i._onRetrySave.bind(i))},onRemoveMessage:function(){setTimeout(function(){e.onHide&&e.onHide()},500)},onShowMessage:function(){setTimeout(function(){if(i._alert&&!t){var e=i._alert.elements.container.getElement(".alert-message");e&&e.addEvent("click",function(e){e.stopPropagation()})}},500)}}}).inject(i.container,"top").show()},_removeAlert:function(){try{this._alert&&this._alert.destroy(),this._alert=null}catch(e){}},_addBlankTargetToLink:function(e){if(!e)return"";var t=document.createElement("p").attachShadow({mode:"open"});return t.innerHTML=e,function e(t){var n,i,o=t.childNodes;for(t.nodeType===t.ELEMENT_NODE&&"A"===t.tagName&&t.setAttribute("target","_blank"),n=0;n<o.length;n++)(i=o[n]).nodeType!==t.TEXT_NODE&&e(i)}(t),t.innerHTML},_applyHTMLHighlight:function(e){var t,n,i,o,s,a=this.MultiNotes,r=e.childNodes;if(e.nodeType===e.TEXT_NODE)return n=RegExp(a.getQuerySearch(),"gi"),o=e.textContent.replace(n,a.applyHighlight),void(e.textContent!==o&&((s=document.createElement("span")).innerHTML=o,s.className="filtered-node",e.parentNode.replaceChild(s,e)));for(t=0;t<r.length;t++)(i=r[t]).textContent&&!i.textContent.trim()||this._applyHTMLHighlight(i)},_cleanHTMLHighlight:function(e){var t,n,i,o,s,a=e.childNodes;for(t=0;t<a.length;t++)if((o=a[t]).nodeType!==o.TEXT_NODE)if(this._cleanHTMLHighlight(o),o.classList.contains("highlight")||o.classList.contains("filtered-node")){for(i=o.parentNode,n=0;n<o.childNodes.length;n++)(s=o.childNodes[n])&&(i.insertBefore(o.removeChild(s),o),s.nodeType===s.TEXT_NODE&&(s.textContent=s.textContent),n--);o.remove(),t--}else;},_onPrefFixedToolbarChange:function(e){var t=this.elements.editorToolbar;this._prefFixedToolbar=e,e?(t.removeClassName("animate"),this._isEditorToolbarVisible()&&this._setEditorToolbarPosition()):(t.addClassName("animate"),this._hideEditorToolbar())}})}),define("DS/MultiNotesWdg/DataManager",["UWA/Core","UWA/Class","UWA/Utils","DS/PlatformAPI/PlatformAPI","DS/MultiNotesWdg/Models/Note","i18n!DS/MultiNotesWdg/assets/nls/MultiNotes"],function(e,t,n,i,o,s){"use strict";var a="getWidgetInstanceFailure";return t.extend({options:{},widget:null,MultiNotes:null,_data:null,_dataFetched:!1,_dataFetching:!1,_shouldFetchData:!0,_timeoutResetShouldFetchData:null,_hasFetchedDataStacks:[],_updateDataCallStacks:[],_editedPrefs:null,_preventOnRefresh:!1,_saveDataInProgress:!1,_pendindPatches:[],_pendingSavingNoteInfoVersion:[],_pendingSavingNoteContentVersion:[],_pendingSavingAddNote:[],_widgetSetValuesPromise:null,_deletedNoteIds:[],_widgetSetValues:null,_widgetDeleteValue:null,_widgetSetValue:null,_jsonPatchEnabled:!0,init:function(e){var t,n=this;n.MultiNotes=e.MultiNotes,n.widget=t=n.MultiNotes.getWidget(),n._widgetSetValues=function(e){Object.keys(e).forEach(function(i){n._widgetSetValue.call(t,i,e[i])})},n._widgetDeleteValue=function(e){n._widgetSetValue.call(t,e)},n._widgetSetValue=t.setValue.bind(t),t.constructor.prototype.setValue=function(e,t){n._editedPrefs=n._editedPrefs||{},n._editedPrefs[e]=t},t.constructor.prototype.setValues=function(e){Object.keys(e).forEach(function(n){t.setValue(n,e[n])})},t.constructor.prototype.deleteValue=function(){},t.addPreference({name:"prefFixedToolbar",type:"boolean",label:s.prefFixedToolbar,defaultValue:!1})},shouldPreventOnRefresh:function(){return this._preventOnRefresh},hasFetchedData:function(){var e=this;return e._dataFetched||e._isPreviewMode()?Promise.resolve():new Promise(function(t,n){e._hasFetchedDataStacks.push({resolve:t,reject:n})})},getCollection:function(){return this.MultiNotes.getCollection()},getWidgetTitle:function(){return this._data.title||""},getPrefFixedToolbar:function(){return this._getData().prefFixedToolbar},getRoute:function(){return this._data.route||""},getNoteIds:function(){var e=this._data;return Object.keys(e).filter(function(t){return 0===t.indexOf("noteContent_")&&"string"==typeof e[t]}).map(function(e){return e.substring("noteContent_".length)})},getNoteOrderIds:function(){return this._data.noteIds||[]},getSelectedNoteId:function(){return this._data.selectedNote},getNoteInfo:function(e){return this._data["noteInfo_"+e]||""},getParsedNoteInfo:function(){return JSON.parse(this.getNoteInfo.apply(this,arguments)||null)},getNoteContent:function(e){return this._data["noteContent_"+e]||""},getNoteInfoVersion:function(e){return this._data["noteInfoVersion_"+e]||1},getNoteContentVersion:function(e){return this._data["noteContentVersion_"+e]||1},setRoute:function(e,t){var n,i,o=this._data.route;return(i=(n=e?e.get("id"):"")?"/notes/"+n+"?f=0&s="+t:"")===o?Promise.resolve():this._updateData({route:i,selectedNoteId:n})},setNoteOrderIds:function(e){return this._updateData({noteOrderIds:e})},addNote:function(e){return this._updateData({addNote:e})},updateNoteInfo:function(e){return this._updateData({updateNoteInfo:e})},updateNoteContent:function(e){return this._updateData({updateNoteContent:e})},deleteNote:function(e){return this._deletedNoteIds.push(e),this._updateData({deleteNote:e})},migrate:function(){return this._migrate15xTo18x()||this._migrate16xTo18x()},onLoad:function(){if(!this.migrate())return this._data={},this._dataFetched=!1,this._dataFetching=!1,this._shouldFetchData=!0,this._updateDataCallStacks=[],this._hasFetchedDataStacks=[],this._editedPrefs=null,this._preventOnRefresh=!1,this._saveDataInProgress=!1,this._pendingSavingNoteInfoVersion=[],this._pendingSavingNoteContentVersion=[],this._pendingSavingAddNote=[],this._pendindPatches=[],this._deletedNoteIds=[],this._isPreviewMode()?Promise.resolve():this._fetchWidgetData().then(function(){});setTimeout(this.MultiNotes.onRefresh.bind(this),2e3)},onShowEditPrefs:function(){this._preventOnRefresh=!0,this._editedPrefs={}},onHideEditPrefs:function(e){var t=(e=e||{}).submitted,n=this;if(!t)return n._editedPrefs={},n._preventOnRefresh=!1,Promise.resolve();var i=Object.keys(n._editedPrefs).map(function(e){if("title"===e){var t=n._editedPrefs.title;return n.MultiNotes.setWidgetTitle(t),n._updateData({widgetTitle:t})}if("prefFixedToolbar"===e){var i=n._editedPrefs.prefFixedToolbar,o=n.getCollection();return o&&o.dispatchOnPrefFixedToolbarChange(i),n._updateData({updatePreferences:{prefFixedToolbar:i}})}if("x3dTitleShowAppName"===e)return n._updateData({updatePreferences:{x3dTitleShowAppName:n._editedPrefs.x3dTitleShowAppName}})});return Promise.all(i).then(function(){setTimeout(function(){n._preventOnRefresh=!1}),n._editedPrefs=null}).catch(function(){n._preventOnRefresh=!1})},onSetValueSuccess:function(){var e=this;return e._onSaveSuccess().finally(function(){e._onSaveFinally(),e._widgetSetValuesPromise&&e._widgetSetValuesPromise.resolve(),e._widgetSetValuesPromise=null})},onSetValueFailure:function(){var e=this;return e._onSaveFailure().finally(function(){e._onSaveFinally(),e._widgetSetValuesPromise&&e._widgetSetValuesPromise.reject({error:"setWidgetInstanceFailure"}),e._widgetSetValuesPromise=null})},onDestroy:function(){clearTimeout(this._timeoutResetShouldFetchData),this.options=null,this.widget=null,this.MultiNotes=null,this._data=null,this._updateDataCallStacks=null,this._hasFetchedDataStacks=null,this._editedPrefs=null,this._pendindPatches=null,this._pendingSavingNoteInfoVersion=null,this._pendingSavingNoteContentVersion=null,this._pendingSavingAddNote=null,this._widgetSetValuesPromise=null,this._deletedNoteIds=null,this._widgetSetValues=null,this._widgetDeleteValue=null,this._widgetSetValue=null},_updateData:function(t){if(t=t||{},this.MultiNotes.isReadOnlyMode())return Promise.resolve();var n=this,i=Promise.resolve();if(!n._dataFetched||n._shouldFetchData||n._saveDataInProgress)return new Promise(function(i,o){var s={options:t,promiseDeferred:{resolve:i,reject:o}};t.updateNoteContent&&(s.updateNoteContent=t.updateNoteContent),t.updateNoteInfo&&(s.updateNoteInfo=t.updateNoteInfo),t.deleteNote&&(s.deleteNote=t.deleteNote),t.addNote&&(s.addNote=t.addNote.get("id")),n._updateDataCallStacks.push(s),n._dataFetching||n._saveDataInProgress||n._unstackUpdateDataCallStack().catch(function(t){e.log(t),n.MultiNotes.showAlert({type:"error"})})});try{var o={preventSave:!0};if(t.updateNoteInfo?o=n._applyUpdateNoteInfo(t.updateNoteInfo):t.updateNoteContent?o=n._applyUpdateNoteContent(t.updateNoteContent):e.is(t.route,"string")?o=n._applyRoute(t.route,t.selectedNoteId):t.deleteNote?o=n._applyDeleteNote(t.deleteNote):t.noteOrderIds?o=n._applyNoteOrderIds(t.noteOrderIds):t.addNote?o=n._applyAddNote(t.addNote):e.is(t.widgetTitle,"string")?o=n._applyWidgetTitle(t.widgetTitle):t.updatePreferences&&(o=n._applyUpdatePreferences(t.updatePreferences)),n._isPreviewMode())return n._saveWidgetDataToBackend(),n._onSaveSuccess().then(n._onSaveFinally.bind(n));if(o.preventSave)return Promise.resolve();if(n._pendindPatches=[].concat(n._pendindPatches,o.patches||[]),0===n._updateDataCallStacks.length)if(n._jsonPatchEnabled){var s=n._pendindPatches.slice();n._pendindPatches=[],i=n._patchBackendData(s)}else i=n._saveWidgetDataToBackend()}catch(t){e.log(t),n.MultiNotes.showAlert({type:"error"})}return i},_applyUpdateNoteInfo:function(e){var t,n,i,o,s=this._getData(),a=this.getCollection(),r=a&&a.get(e),l="noteInfoVersion_"+e,d="noteInfo_"+e;return t=s[d],r&&(t||r.isNewNote())?(s[l]||1)>r.getLastSavedInfoVersion()?(r.setConflictEditedInfo(!0),{preventSave:!0}):(i=JSON.stringify({name:r.get("name"),color:r.get("color"),createTime:r.get("createTime"),updateTime:r.get("updateTime")}),n=r.getInfoVersion(),o=[this._createPatch("set",d,i),this._createPatch("set",l,n)],s[d]=i,this._pendingSavingNoteInfoVersion.push({id:e,version:n}),{patches:o}):(r&&r.setConflictDeleted(!0),{preventSave:!0})},_applyUpdateNoteContent:function(e){var t,n,i,o=this._getData(),s=this.getCollection(),a=s&&s.get(e),r="noteContentVersion_"+e,l="noteContent_"+e;return a&&"string"==typeof o[l]?(o[r]||1)>a.getLastSavedContentVersion()?(a.setConflictEditedContent(!0),{preventSave:!0}):(n=a.get("content"),t=a.getContentVersion(),i=[this._createPatch("set",l,n),this._createPatch("set",r,t)],o[l]=n,this._pendingSavingNoteContentVersion.push({id:e,version:t}),{patches:i}):(a&&a.setConflictDeleted(!0),{preventSave:!0})},_applyAddNote:function(e){var t,n,i,o,s,a=this._getData(),r=e.get("id"),l="noteInfoVersion_"+r,d="noteContentVersion_"+r,c="noteInfo_"+r,h="noteContent_"+r;return t=JSON.stringify({name:e.get("name"),color:e.get("color"),createTime:e.get("createTime"),updateTime:e.get("updateTime")}),1,n=e.get("content"),1,(s=a.noteIds||[]).unshift(r),(o=a.__sanitize||[]).push(h),i=[this._createPatch("set",c,t),this._createPatch("set",h,n),this._createPatch("set",l,1),this._createPatch("set",d,1),this._createPatch("set","noteIds",s),this._createPatch("set","selectedNote",r),this._createPatch("set","__sanitize",o)],a[c]=t,a[h]=n,a[l]=1,a[d]=1,a.noteIds=s,a.selectedNote=r,a.__sanitize=o,this._pendingSavingAddNote.push({id:r}),{patches:i}},_applyRoute:function(e,t){var n,i=this._getData();return n=[this._createPatch("set","route",e),this._createPatch("set","selectedNote",t)],i.route=e,i.selectedNote=t,{patches:n}},_applyNoteOrderIds:function(e){var t,n=this._getData();return t=[this._createPatch("set","noteIds",e)],n.noteIds=e,{patches:t}},_applyDeleteNote:function(e){var t,n,i,o,s,a,r=this._getData(),l="noteInfoVersion_"+e,d="noteContentVersion_"+e,c="noteInfo_"+e,h="noteContent_"+e;return s=!this.getNoteIds().includes(e),i=r.noteIds||[],o=r.__sanitize||[],(a=i.indexOf(e))>-1&&i.splice(a,1),(n=o.indexOf(h))>-1&&o.splice(n,1),t=[this._createPatch("delete",h),this._createPatch("delete",c),this._createPatch("delete",l,i),this._createPatch("delete",d,i),this._createPatch("set","noteIds",i),this._createPatch("set","__sanitize",o),this._createPatch("set","route",""),this._createPatch("set","selectedNote","")],r[h]=null,r[c]=null,r[l]=null,r[d]=null,r.noteIds=i,r.__sanitize=o,r.route="",r.selectedNote="",{preventSave:s,patches:t}},_applyWidgetTitle:function(e){var t,n,i=this._getData();return(n=i.__sanitize||[]).push("title"),t=[this._createPatch("set","title",e),this._createPatch("set","__sanitize",n)],i.title=e,i.__sanitize=n,{patches:t}},_applyUpdatePreferences:function(e){var t=this,n=t._getData(),i=[];return Object.keys(e).forEach(function(o){var s=e[o];i.push(t._createPatch("set",o,s)),n[o]=s}),{patches:i}},_unstackUpdateDataCallStack:function(){var t=this;return!t._updateDataCallStacks.length||t._saveDataInProgress?Promise.resolve():t._fetchWidgetData().then(function(){for(var e=[];t._updateDataCallStacks.length&&!t._saveDataInProgress;){var n=t._updateDataCallStacks.shift();e.push(t._updateData(n.options).then(function(){this.promiseDeferred.resolve()}.bind(n)))}return Promise.all(e)}).catch(function(n){var i;n=n||{},e.log(n),n.error===a&&(i=s.errorOnFetchData),"setWidgetInstanceFailure"!==n.error&&"patchWidgetData"!==n.error||(i=s.errorOnSaveData),t.MultiNotes.showAlert({message:i,type:"error"})})},_saveWidgetDataToBackend:function(){var t,i=this;return i._onBeforeSave(),t=e.clone(i._getData()),i._pendingSavingNoteInfoVersion.forEach(function(e){var n="noteInfoVersion_"+e.id;t[n]=e.version}),i._pendingSavingNoteContentVersion.forEach(function(e){var n="noteContentVersion_"+e.id;t[n]=e.version}),["token","appId","dashboardPlatformEnabled","debug_me","lang","x3dPlatformId","tenantAware"].forEach(function(e){delete t[e]}),t._MNFingerprint=n.getUUID(),i._widgetSetValues(t),new Promise(function(e,t){i._widgetSetValuesPromise={resolve:e,reject:t}})},_patchBackendData:function(e){var t,n=this,o=!1;return(e=(e=e||[]).filter(function(e){return e})).length?(n._onBeforeSave(),i.patchWidgetData({widget:n.widget,patches:e,silentErrorAlert:!0}).then(function(){return n._onSaveSuccess()}).catch(function(){return o=!0,t={error:"patchWidgetData"},n._onSaveFailure()}).finally(function(){return n._onSaveFinally().then(function(){return o?Promise.reject(t):Promise.resolve()})})):Promise.resolve()},_createPatch:function(e,t,n){var i=this._getData();return"set"===e?{op:t in i?"replace":"add",path:"/"+t,value:n}:"delete"===e&&t in i?{op:"remove",path:"/"+t}:null},_onBeforeSave:function(){var e=this.getCollection();this._saveDataInProgress=!0,this.MultiNotes.showLoadingBar(),[].concat(this._pendingSavingNoteInfoVersion,this._pendingSavingNoteContentVersion,this._pendingSavingAddNote).forEach(function(t){var n=e&&e.get(t.id);n&&n.setSaveInProgress(!0)})},_onSaveSuccess:function(){var e=this,t=e.getCollection();return e._pendingSavingNoteInfoVersion.forEach(function(n){var i="noteInfoVersion_"+n.id;e._data[i]=n.version;var o=t&&t.get(n.id);o&&(o.setFailToSaveInfo(!1),o.setLastSavedInfoVersion(n.version))}),e._pendingSavingNoteContentVersion.forEach(function(n){var i="noteContentVersion_"+n.id;e._data[i]=n.version;var o=t&&t.get(n.id);o&&(o.setFailToSaveContent(!1),o.setLastSavedContentVersion(n.version))}),e._pendingSavingAddNote.forEach(function(e){var n=t&&t.get(e.id);n&&(n.setFailToSaveContent(!1),n.setNewNote(!1))}),Promise.resolve()},_onSaveFailure:function(){var e=this.getCollection();return e?(this._pendingSavingNoteInfoVersion.forEach(function(t){var n=e.get(t.id);n&&n.setFailToSaveInfo(!0)}),this._pendingSavingNoteContentVersion.forEach(function(t){var n=e.get(t.id);n&&n.setFailToSaveContent(!0)}),this._pendingSavingAddNote.forEach(function(t){var n=e.get(t.id);n&&(n.setFailToSaveInfo(!0),n.setFailToSaveContent(!0))}),Promise.resolve()):Promise.resolve()},_onSaveFinally:function(){var e=this,t=e.getCollection();t&&t.forEach(function(t){var n,i,o,s,a=t.get("id");n=e._updateDataCallStacks.some(function(e){return e.updateNoteInfo===a}),i=e._updateDataCallStacks.some(function(e){return e.updateNoteContent===a}),o=e._updateDataCallStacks.some(function(e){return e.deleteNote===a}),s=e._updateDataCallStacks.some(function(e){return e.addNote===a})||o,t.setModifiedInfo(s||n,{statesDependant:!0}),t.setModifiedContent(s||i,{statesDependant:!0}),t.setSaveInProgress(!1)}),e._pendingSavingNoteInfoVersion=[],e._pendingSavingNoteContentVersion=[],e._pendingSavingAddNote=[],e._saveDataInProgress=!1,e.MultiNotes.hideLoadingBar();var n=e._getData();return Object.keys(n).forEach(function(e){null===n[e]&&delete n[e]}),e._unstackUpdateDataCallStack()},_resetShouldFetchData:function(){var e=this;e._shouldFetchData=!1,clearTimeout(e._timeoutResetShouldFetchData),e._timeoutResetShouldFetchData=setTimeout(function(){e._shouldFetchData=!0},1e3)},_resolvePendingHasFetchedData:function(){this._hasFetchedDataStacks.forEach(function(e){e.resolve()}),this._hasFetchedDataStacks=[]},_getData:function(){return this._data},_fetchWidgetData:function(){var t=this;if(t._isPreviewMode()){var n=e.clone(t.widget.environment.widget.data);return n.noteIds=n.noteIds||[],n.__sanitize=n.__sanitize||[],t._dataFetched=!0,t._dataFetching=!1,t._shouldFetchData=!1,t._data=n,Promise.resolve(t._data)}return!t._shouldFetchData||t._saveDataInProgress?Promise.resolve(t._data):(t.MultiNotes.showLoadingBar("fetch"),t._dataFetched=!1,t._dataFetching=!0,t._fetchBackendWidgetData().then(function(e){return t.MultiNotes.hideLoadingBar(),t._dataFetched=!0,t._dataFetching=!1,t._saveDataInProgress?(t._shouldFetchData=!0,t._data):(t._shouldFetchData=!1,t._data=e,t._fixNoteOrderIds(),t._data=t._checkDeletedNotes(t._data),t._checkUpdatedNotes(t._data),t._checkAddedNotes(t._data),setTimeout(t._resolvePendingHasFetchedData.bind(t)),t._resetShouldFetchData(),t._data)}).catch(function(e){throw t.MultiNotes.hideLoadingBar(),t._dataFetched=!1,t._dataFetching=!1,t._shouldFetchData=!0,e}))},_fetchBackendWidgetData:function(){var t=this;return new Promise(function(i,o){window.top.require(["DS/UWPClientCode/Data/Widgets","DS/Dashboard/PublicAPI"],function(e,s){var r=t.widget.id;function l(e){o({error:a,e:e})}var d,c,h,u=(d=top.window.location.search||"",h="string"==typeof d?d:top.window.location.search||"",delete(c=n.parseQuery(h))[""],c);u.wii&&(r=u.wii),e.getWidgetInstance({serviceName:s._getServiceName(),id:r,refresh:!0,success:function(e){var t;try{t=JSON.parse(e.data)}catch(e){return l("Fail to parse widget instance data.")}t.noteIds=t.noteIds||[],t.__sanitize=t.__sanitize||[],i(t)},failure:l})},function(t){e.log("Fail to require top modules to fetch backend data:"),e.log(t),o({error:"requireTopModules",e:t})})})},_isPreviewMode:function(){return this.MultiNotes.isPreviewMode()},_fixNoteOrderIds:function(){var e,t=!1,n=this.getNoteIds();e=(e=this.getNoteOrderIds()).filter(function(e){var i=n.includes(e);return i||(t=!0),i}),n.forEach(function(n){e.includes(n)||(e.unshift(n),t=!0)}),t&&(this._data.noteIds=e)},_checkDeletedNotes:function(e){var t=this,n=t.widget.environment.getAllData(),i=t.getCollection(),o=["noteInfo_","noteInfoVersion_","noteContent_","noteContentVersion_"];return Object.keys(n).forEach(function(n){if(o.some(function(e){return 0===n.indexOf(e)})&&!(n in e&&null!==e[n])){e[n]=null;var i=n.substring(n.lastIndexOf("_")+1);t._deletedNoteIds.includes(i)||t._deletedNoteIds.push(i)}}),i&&i.forEach(function(n){if(!n.isNewNote()){var i=n.get("id"),o="noteContent_"+i;o in e&&null!==e[o]||(t._deletedNoteIds.includes(i)||t._deletedNoteIds.push(i),n.setConflictDeleted(!0))}}),e},_checkUpdatedNotes:function(e){var t=this.getCollection();if(t){var n=["noteContentVersion_"];Object.keys(e).forEach(function(i){var o,s;if(n.some(function(t){return e[i]&&0===i.indexOf(t)})&&(o=(s=i.substring(i.lastIndexOf("_")+1))&&t.get(s))&&!o.isSelected()&&!o.isModified()){var a=e["noteInfoVersion_"+s],r=e["noteContentVersion_"+s];o.getLastSavedInfoVersion()<a&&o.updateInfoFromData(),o.getLastSavedContentVersion()<r&&o.updateContentFromData()}})}},_checkAddedNotes:function(e){var t=this,n=t.getCollection();if(n){var i=["noteContent_"];Object.keys(e).forEach(function(o){var s;i.some(function(t){return e[o]&&0===o.indexOf(t)})&&(s=o.substring(o.lastIndexOf("_")+1),t._deletedNoteIds.includes(s)||s&&n.get(s)||n.addNote(s).setAddedFromData(!0))})}},_migrate15xTo18x:function(){var e,t,i,o,a,r=this.widget;if(!(e=r.getValue("text")))return!1;t=Date.now(),e="<p>"+e.replace(/([\n\r]|\$@n)/g,"<br>").replace(/\s/g,"&nbsp;")+"</p>",o={noteIds:[i=n.getUUID()],migrated15xTo18x:!0,__sanitize:["noteContent_"+i]};try{a=JSON.stringify({name:r.getValue("title")||s.newNoteName,createTime:t,updateTime:t})}catch(e){a=JSON.stringify({name:s.newNoteName,createTime:t,updateTime:t})}return o["noteInfo_"+i]=a,o["noteContent_"+i]=e,o["noteInfoVersion_"+i]=1,o["noteContentVersion_"+i]=1,this._widgetSetValues(o),this._widgetDeleteValue("text"),this._widgetDeleteValue("font"),this._widgetDeleteValue("fontSize"),!0},_migrate16xTo18x:function(){var t,i,o,a,r,l=this.widget;if(i=l.getValue("nbNotes"),!e.is(i,"number"))return!1;for(t={migrated16xTo18x:!0,noteIds:[],__sanitize:[]},o=0;o<i;o++){r=n.getUUID(),t.noteIds.push(r),t.__sanitize.push("noteContent_"+r);try{delete(a=JSON.parse(l.getValue("noteInfo_"+o))||{}).type,delete a.icon,delete a.items,a=JSON.stringify(a)}catch(e){a=JSON.stringify({name:s.newNoteName,createTime:Date.now(),updateTime:Date.now()})}t["noteInfo_"+r]=a,t["noteContent_"+r]=l.getValue("noteContent_"+o),t["noteInfoVersion_"+r]=1,t["noteContentVersion_"+r]=1,this._widgetDeleteValue("noteInfo_"+o),this._widgetDeleteValue("noteContent_"+o)}return this._widgetDeleteValue("nbNotes"),this._widgetDeleteValue("migrated15xTo16x"),this._widgetDeleteValue("migrated15xTo16x_2"),this._widgetDeleteValue("migrated15xTo16x_3"),this._widgetSetValues(t),!0}})}),define("DS/MultiNotesWdg/Views/NoteItem",["UWA/Core","UWA/String","UWA/Event","DS/UIKIT/Tooltip","DS/W3DXComponents/Views/Temp/TempItemView","DS/MultiNotesWdg/Color","i18n!DS/MultiNotesWdg/assets/nls/MultiNotes","css!DS/MultiNotesWdg/Views/NoteItem"],function(e,t,n,i,o,s,a){"use strict";return o.extend({tagName:"div",className:"note-itm",elements:{},MultiNotes:null,domEvents:{"click .note-itm-ctn":"_onNoteItemClick"},_isSelected:!1,setup:function(e){var t,n=e||{},i=this,o=i.model;i.MultiNotes=t=n.MultiNotes,i.listenTo(o,{onChange:i._setUpdateTime.bind(i),"onChange:color":i._setColor.bind(i),"onChange:content":function(){var e=t.getQuerySearch();i._setContent(),e&&i.onFiltering(e)},"onChange:name":function(){var e=t.getQuerySearch();i._setName(),e&&i.onFiltering(e)},onReadOnly:i._onReadOnlyChange.bind(i),onFailToSave:i._onFailToSave.bind(i),onSaveInProgress:i._onSaveInProgress.bind(i),onModified:i._onModified.bind(i),onConflictEdited:i._onConflictEdited.bind(i),onConflictDeleted:i._onConflictDeleted.bind(i),onAddedFromData:i._onAddedFromData.bind(i),onUpdateInfoFromData:i._onUpdateInfoFromData.bind(i),onUpdateContentFromData:i._onUpdateContentFromData.bind(i)})},render:function(){var t,o,s,r,l,d,c,h,u,f,g,_,m,p="div",v=this.elements,C=this.container,N=e.createElement,S=this.model;return v.bgColor=N(p,{class:"bg-color"}),v.name=t=N(p,{class:"note-name text-primary"}),v.content=o=N(p,{class:"note-content"}),v.noteColor=s=N(p,{class:"color-ctn",title:a.editColor,events:{click:this._onNoteColorClick.bind(this)}}),v.updateTime=N(p,{class:"note-time"}),r=N(p,{class:"buttons",html:[{tag:p,class:"butn color-btn disp-none",title:a.editColor,html:v.colorIcon=N(p,{class:"color-icon"}),events:{click:this._onEditColorBtnClick.bind(this)}},{tag:"span",class:"butn fonticon fonticon-trash disp-none",title:a.deleteAction,events:{click:this._onDeleteNoteBtnClick.bind(this)}},d=N("span",{class:"butn move-icon fonticon fonticon-list",events:{click:function(e){n.stop(e)}}})]}),this.MultiNotes.isTouchDevice()||new i({target:d,body:a.moveAction}),v.errorIconCtn=c=N(p,{class:"error-icon-ctn",html:v.errorIcon=l=N("span",{class:"icon error-icon fonticon fonticon-alert",events:{click:this._onErrorIconClick.bind(this)}})}),v.errorIconTooltip=new i({target:l}),v.attentionIconCtn=f=N(p,{class:"attention-icon-ctn",html:v.attentionIcon=g=N("span",{class:"icon attention-icon fonticon fonticon-attention"})}),v.attentionIconTooltip=new i({target:g}),v.infoIconCtn=_=N(p,{class:"info-icon-ctn",html:v.infoIcon=m=N("span",{class:"icon info-icon fonticon fonticon-info"})}),v.infoIconTooltip=new i({target:m}),v.modifiedIconCtn=h=N(p,{class:"modified-icon-ctn",html:v.modifiedIcon=u=N("span",{class:"icon error-icon fonticon fonticon-record"})}),new i({target:u,body:a.modifiedTooltip}),C.setContent([v.bgColor,{tag:p,class:"note-itm-ctn",html:[h,c,f,_,r,s,t,o,v.updateTime]}]),this.container.setData("id",S.get("id")),this._setUpdateTime(),this._setContent(),this._setName(),this._setColor(),this._isReadOnly()?this._setReadOnly():this._unsetReadOnly(),S.isSaveInProgress()&&this._onSaveInProgress(),S.isModified()&&this._onModified(),S.isFailToSave()&&this._onFailToSave(),S.isConflictEdited()&&this._onConflictEdited(),S.isConflictDeleted()&&this._onConflictDeleted(),S.isAddedFromData()&&this._onAddedFromData(),this},select:function(){this.container.addClassName("selected"),this.model.setSelected(!0),this._isSelected=!0,this._setColor()},unSelect:function(){this.isDestroyed||(this.container.removeClassName("selected"),this.model.setSelected(!1),this._isSelected=!1,this._setColor())},_setColor:function(){var e,t=this.MultiNotes,n=this.elements||{},i=n.bgColor,o=n.noteColor,a=n.colorIcon,r=this.model.get("color"),l=!!r;switch(this._isNoteSelected()?"dark":"ligth"){case"dark":e=t.DARK_BG;break;case"ligth":e=t.LIGHT_BG}r=new s(r||t.DEFAULT_COLOR),l&&r?(i&&i.setStyles({background:r.toRgbaString(e)}),a&&a.setStyles({background:r.toRgbString()})):(i&&i.setStyles({background:""}),a&&a.setStyles({background:""})),o&&r&&(o.setStyles({background:r.toRgbString()}),o.setData("color",r.toHexString()))},_setUpdateTime:function(){var e=this.MultiNotes,t=this.elements.updateTime,n=this.model.get("updateTime");t.setText(e.replace(a.updatedTime,{date:e.formatShortDate(n)})),t.setData("time",n)},_setContent:function(){var e=this.model.get("content");e=e.replace(/<\/li>/g,"</li> "),e=t.stripTags(e),e=t.cut(e,800,"..."),this.elements.content.setHTML(e||{tag:"span",class:"empty-desc",text:a.empty})},_setName:function(){this.elements.name.setHTML(this.model.get("name"))},_setReadOnly:function(){this.container.addClassName("readonly"),this.elements.noteColor.title=""},_unsetReadOnly:function(){this.container.removeClassName("readonly"),this.elements.noteColor.title=a.editColor},_onNoteItemClick:function(){!this._isNoteSelected()&&this.dispatchEvent("onClick",[this])},onFiltering:function(e){var n,i,o=this.elements,s=this.MultiNotes,a=RegExp(e,"gi");e?(n=o.name.getHTML().replace(a,s.applyHighlight),o.name.setHTML(n),t.stripTags(this.model.get("content"))&&(i=o.content.getHTML().replace(a,s.applyHighlight),o.content.setHTML(i))):(this._setContent(),this._setName())},_isNoteSelected:function(){return this._isSelected},_isReadOnly:function(){return this.MultiNotes.isReadOnlyMode()||this.model.isReadOnly()},_refreshView:function(){this._setName(),this._setContent(),this._setColor(),this._setUpdateTime();var e=this.MultiNotes.getQuerySearch();e&&this.onFiltering(e)},_onReadOnlyChange:function(){this._isReadOnly()?this._setReadOnly():this._unsetReadOnly(),this._refreshView()},_onFailToSave:function(e){e=e||this.model;var t=this.container;e.isFailToSave()?(t.addClassName("not-saved"),e.isConflictDeleted()||this.elements.errorIconTooltip.setBody(a.failToSaveTooltip)):t.removeClassName("not-saved")},_onSaveInProgress:function(e){e=e||this.model;var t=this.container;e.isSaveInProgress()?t.addClassName("save-in-progress"):t.removeClassName("save-in-progress")},_onModified:function(e){e=e||this.model;var t=this.container;e.isModified()?t.addClassName("modified"):t.removeClassName("modified")},_onConflictEdited:function(e){e=e||this.model;var t=this.container;e.isConflictEdited()?(t.addClassName("conflict-edited"),this.elements.attentionIconTooltip.setBody(a.noteNotUpToDateTooltip)):t.removeClassName("conflict-edited")},_onConflictDeleted:function(e){e=e||this.model;var t=this.container;if(e.isConflictDeleted()){t.addClassName("conflict-deleted");var n=e.isModified()?a.conflictNoteDeletedTooltip:a.noteDeletedTooltip;this.elements.errorIconTooltip.setBody(n)}else t.removeClassName("conflict-deleted")},_onAddedFromData:function(e){e=e||this.model;var t=this.container;e.isAddedFromData()?(t.addClassName("added-from-data"),this.elements.infoIconTooltip.setBody(a.newAddedNote)):t.removeClassName("added-from-data")},_onUpdateInfoFromData:function(){this._refreshView()},_onUpdateContentFromData:function(){this._refreshView()},_onErrorIconClick:function(e){n.stop(e),this.model.isFailToSave()&&this.MultiNotes.showNotSavedPopover(this.elements.errorIcon,this.model)},_onNoteColorClick:function(e){if(n.stop(e),!this._isReadOnly()){var t=this.container;return t.addClassName("active"),this.MultiNotes.showColorModal(this.model,function(){t.removeClassName("active")})}this._onNoteItemClick()},_onEditColorBtnClick:function(e){var t=this.container;return n.stop(e),t.addClassName("active"),this.MultiNotes.showColorModal(this.model,function(){t.removeClassName("active")})},_onDeleteNoteBtnClick:function(e){var t=this.MultiNotes;return n.stop(e),t.showDeleteModal(this.model)},destroy:function(){this.stopListening(),this.MultiNotes=null,this._parent.apply(this,arguments)}})}),define("DS/MultiNotesWdg/Views/NoteCollection",["UWA/Core","UWA/String","UWA/Class/View","DS/W3DXComponents/Views/Layout/ListView","DS/W3DXComponents/Views/EmptyView","DS/UWPClientControls/Draggable","DS/MultiNotesWdg/Views/NoteItem","DS/MultiNotesWdg/Views/NewNoteItem","i18n!DS/MultiNotesWdg/assets/nls/MultiNotes","css!DS/MultiNotesWdg/Views/NoteCollection"],function(e,t,n,i,o,s,a,r,l){"use strict";return n.extend({tagName:"div",className:"note-list",elements:{},MultiNotes:null,dataManager:null,collection:null,_previousSelectedNote:null,setup:function(t){var n,s,l,d,c=this.elements,h=t||{};this.MultiNotes=d=h.MultiNotes,this.dataManager=d.getDataManager(),s=d.isReadOnlyMode(),l=this.collection,c.listView=n=new i(e.merge({itemView:a,className:"notes-ctn "+(s?"readonly":""),collection:l,emptyView:o,itemViewOptions:{MultiNotes:d}},h)),c.newNoteView=new r({collection:l,MultiNotes:d}),this.listenTo(n,{onItemViewClick:this.onItemClick}),this.listenTo(l,{onAdd:this._onAddNoteInCollection.bind(this),onSort:this._onSortCollection.bind(this),onConflictDeletedNotSelected:this._onConflictDeletedNotSelected.bind(this),onConflictEditedNotSelected:this._onConflictEditedNotSelected.bind(this),onFailToSaveNotSelected:this._onFailToSaveNotSelected.bind(this),selectNote:this._selectNote.bind(this)})},unSelectAll:function(){var e=this.elements.listView;this._previousSelectedNote=null,e&&e.unSelectAll()},render:function(){var e=this,t=e.elements,n=e.container;return e.MultiNotes.isReadOnlyMode()||t.newNoteView.render().inject(n),t.listView.render().inject(n),t.dragContainer=t.listView.getContent().getElement(".column-layout.grid-container"),e._initReordering(),setTimeout(function(){e.scrollToNote();var t=e.MultiNotes.getQuerySearch();t&&e.onSearch(t)},200),e},_saveReordering:function(){var e,t=this.elements.dragContainer.getElements(".note-itm")||[],n=this.dataManager,i=n.getNoteIds(),o=n.getNoteOrderIds();if(t.length===i.length){if((e=t.map(function(e){return e.getData("id")})).some(function(e,t){return o.indexOf(e)!==t}))return n.setNoteOrderIds(e)}else this.refreshView()},scrollToNote:function(e,t){var n=(this.elements||{}).listView;n&&(e=e||this.collection.getSelected())&&(n.setOption("scrollDuration",0),n.selectItemView(e,{scrollPosition:t||"bottom"}))},_selectNote:function(e){(e=e||this.collection.getSelected())&&(this._previousSelectedNote=e,this.dispatchEvent("onItemViewSelect",["","",e]),this.scrollToNote(e))},refreshView:function(){this.elements.listView.render(),this._selectNote()},onItemClick:function(){this._previousSelectedNote=arguments[1],Array.prototype.unshift.call(arguments,this.elements.listView),this.dispatchEvent("onItemViewSelect",arguments)},onSearch:function(e){var n,i=this.collection,o=this.elements,s=o.listView.nestedView,a=RegExp(e,"i"),r=this.MultiNotes,l=r.getSkeleton(),d=l.getState(),c=[],h=i.getSelected();if(o.listView.container.toggleClassName("filtered",!!e),o.newNoteView.onSearch(e),i.forEach(function(n){var i=s.getChildView(n),o=i.container;e&&(a.test(n.get("name"))||a.test(t.stripTags(n.get("content"))))?(o.addClassName("filtered"),c.push(n),n.setFiltered(!0)):(o.removeClassName("filtered"),n.setFiltered(!1)),r.apply(i.onFiltering,i,[e],!0)}),this._destroyNoResultView(),(n=c.length)?1===n?r.apply(this._selectNote,this,[c[0]],!0):!h||d!==r.SKELETON_STATE_COLLAPSED&&d!==r.SKELETON_STATE_CONTRACTED&&c.includes(h)||(l.setExpandedLayout({animate:!1}).then(function(){r._slideBack()}),h=null):e?(h&&(this._previousSelectedNote=h,l&&l.setRoute("/"+l.rootRendererName)),this._buildNoResultView()):this._previousSelectedNote&&r.apply(this._selectNote,this,[this._previousSelectedNote],!0),h){var u=l?l.getViewAt(1):null;u&&u.onFiltering&&u.onFiltering(e)}},destroy:function(){this.stopListening(),this._parent.apply(this,arguments)},_buildNoResultView:function(){var e=this.elements;e.noResultView=new o({className:"no-result-view",icon:"filter",title:l.noResult}),e.noResultView.render().inject(this.container)},_destroyNoResultView:function(){var e=this.elements;e.noResultView&&(e.noResultView.destroy(),e.noResultView=null)},_onAddNoteInCollection:function(e){var t=this.elements.listView;t&&t.container.isInjected()&&e.isNewNote()&&(t.render(),t.scrollToItemView(e.cid,"start"),this._selectNote(e));var n=this.MultiNotes.getQuerySearch();n&&this.onSearch(n)},_onSortCollection:function(){this.refreshView()},_onConflictDeletedNotSelected:function(e){var t=this.MultiNotes;t.showAlert({message:t.replace(l.conflictNoteDeletedNotSelectedMsg,{name:e.get("name"),goToClass:t.GO_TO_BTN_CLASS}),type:"error",note:e})},_onConflictEditedNotSelected:function(e){var t=this.MultiNotes;t.showAlert({message:t.replace(l.conflictNoteEditedNotSelectedMsg,{name:e.get("name"),goToClass:t.GO_TO_BTN_CLASS}),type:"warning",note:e})},_onFailToSaveNotSelected:function(e){var t=this.MultiNotes;t.showAlert({message:t.replace(l.failToSaveNotSelectedMsg,{name:e.get("name"),goToClass:t.GO_TO_BTN_CLASS,retryClass:t.RETRY_BTN_CLASS}),type:"error",note:e})},_initReordering:function(){var t,n,i,o,a,r,l,d,c,h,u,f,g,_,m,p,v,C=this,N=C.elements,S="reorder";function y(){f=-v.getPosition(document.body).y}function b(){p.addClassName("dragging-over-notes-list")}function T(){p.removeClassName("dragging-over-notes-list")}(t=new s({movePlayer:!1,container:document.body,items:".note-itm .note-itm-ctn .move-icon",limit:!1,textSelection:!1,distance:0,autoscroll:!0,area:30,shouldIgnoreDrag:function(){return C.collection.length.length<=1},beforeStart:function(s,r){var f,y,T,w,D,M;S="reorder",p=N.dragContainer,M=N.listView,v=M.scrollView.scroller,m=N.newNoteView,D=C.MultiNotes.getSkeleton(),u=D.getViewAt(1),y=(f=r.player).getPosition(document.body),T=f.getDimensions(),_=p.getDimensions(),d=M.container.getPosition(document.body),i=f.getParent(".note-itm"),l=p.getChildren().indexOf(i),t.player=i,t.options.movePlayer=!0,w=i.getDimensions(),o=w.height,a=w.width,n=e.createElement("div",{class:"note-itm-placeholder note-itm-i",styles:{height:o}}).inject(i,"after"),i.setStyles({top:y.y-T.innerHeight,width:w.width}),i.addClassName("dragging"),c=v.getInnerElement(),h=c.scrollHeight-c.clientHeight,g=v.elements.container.getPosition(document.body).y,i.inject(document.body),document.body.addClassName("dragging-note"),m.elements.dropZone.setStyles({width:_.width-5,height:d.y-7}),b()},start:function(e,t){r=t.pointer.top-100},drag:function(e,t){var s,l,c,h,f,g,v,C,N,y=t.position,w=y.left,D=y.top,M=t.pointer.top-100;if(r>(f=M)?(C=!0,N=!0):r===f?(C=!1,N=!1):(C=!1,N=!0),N&&w<=_.width-a/2&&D>=d.y){for(S="reorder",v=C?M+1.2*o:M,s=0,l=(g=p.getElements(".note-itm").filter(function(e){return e!==i})).length;s<l;s++)g[s].getPosition().y<=v&&(c=s);(h=g[c])&&h.grab(n,C?"before":"after"),b(),u&&u.onDragLeave(),m.onDragLeave()}else u&&w>_.width-a/2?(S="merge",u.onDragOver(),m.onDragLeave(),T()):w<=_.width-a/2&&D<d.y-o&&(S="duplicate",m.onDragOver(),u&&u.onDragLeave(),T());r=f},stop:function(){var e=C.collection.get(i.getData("id"));function t(){var e,t;e=p,0===l?t="top":l<p.getChildren().length&&(e=p.getChildren()[l-1],t="after"),i.inject(e,t)}document.body.removeClassName("dragging-note"),i.removeClassName("dragging").setStyles({top:"",right:"",bottom:"",left:"",width:"100%"}),"reorder"===S&&(C.MultiNotes.getQuerySearch()?t():(n.grab(i,"after"),C._saveReordering())),n.destroy(),"merge"===S&&u&&(t(),u.mergeNote(e)),"duplicate"===S&&(t(),C.MultiNotes.duplicateNote(e)),m.onDragLeave(),u&&u.onDragLeave()}})).autoscroll=function(e,t){var n=this,i=n.options,o=t.pointer.top,s=n.windowSize.height,a=i.area,r=a+g,l=s-a;function d(e,t,i,o,s,a){var r=Date.now(),l=Math.floor(n._data.position.top),d={};return d.positive=e,d.id=window.setInterval(function(){var c,u,_=Date.now(),m=_-r,p=n._data.pointer.top,C=n._data.position.top;v.isMaxPosition("y",e?1:-1)&&(window.clearInterval(d.id),n._autoscroll=null),c=(o-(e?s-p:p-g))/o,u=2*Math.floor(10*c/2),u=Math.max(u,2),u=Math.floor(u*m/16)*(e?1:-1),i+=u,!e&&i>=h&&(i=h,u=0),v.scrollTo(0,i+f),l!==C?l=C:l+=u,a&&(n._data.pointer.diffTop+=u,a(n._data)),t&&t.setStyle("top",C),r=_},16),d}function c(){window.clearInterval(n._autoscroll.id),y()}if(n._autoscroll=n._autoscroll||{},!p.hasClassName("dragging-over-notes-list"))return c(),void(n._autoscroll=null);o<r?(void 0===n._autoscroll.positive||n._autoscroll.positive)&&(c(),n._autoscroll=d(!1,i.movePlayer&&n.player,0,a,s,i.autoscrollFn)):o>l?n._autoscroll.positive||(c(),n._autoscroll=d(!0,i.movePlayer&&n.player,0,a,s,i.autoscrollFn)):(c(),n._autoscroll=null)}}})}),define("DS/MultiNotesWdg/MultiNotes",["UWA/Core","UWA/Class","UWA/Utils","DS/UIKIT/SuperModal","DS/UIKIT/Modal","DS/UIKIT/Alert","DS/UIKIT/Popover","DS/UIKIT/Tooltip","DS/CKEditor/CKEditor","DS/W3DXComponents/Skeleton","DS/UWPClientControls/Utils","DS/MultiNotesWdg/DataManager","DS/MultiNotesWdg/Collections/Notes","DS/MultiNotesWdg/Views/EditNote","DS/MultiNotesWdg/Views/NoteCollection","DS/MultiNotesWdg/ColorPicker","i18n!DS/MultiNotesWdg/assets/nls/MultiNotes","css!DS/MultiNotesWdg/MultiNotes"],function(e,t,n,i,o,s,a,r,l,d,c,h,u,f,g,_,m){"use strict";function p(e,t){return(e||"").replace(/\{([\w\-]+)\}/g,function(e,n){return void 0!==t[n]?t[n]:""})}function v(t,n,i,o){e.is(t,"function")&&(o?setTimeout(function(){t.apply(n,i)}):t.apply(n,i))}return t.extend({LIGHT_BG:.1,DARK_BG:.2,DEFAULT_COLOR:"#368ec4",GO_TO_BTN_CLASS:"go-to-btn",RETRY_BTN_CLASS:"retry-btn",SKELETON_STATE_CONTRACTED:"contracted",SKELETON_STATE_COLLAPSED:"collapsed",SKELETON_STATE_EXPANDED:"expanded",options:{},widget:null,dataManager:null,skeleton:null,_querySearch:"",_isReadOnlyMode:!1,_isPreviewMode:!1,_onSlideBackPromise:null,_timeoutOnSlide:null,_CKEDITORHasBeenWarmUp:!1,_notSavedPopover:null,_loadingBar:null,_loadingBarTooltip:null,_alert:null,_superModal:null,_modal:null,init:function(t){var i;this.options=e.extend({readOnly:!1},e.clone(t,!1)||{}),n.Client.Platform.ipad&&document.documentElement.addClassName("ipados"),this.widget=i=t.widget,this.skeleton=null,this._isReadOnlyMode=this.options.readOnly,this._isPreviewMode=i.id.indexOf("preview")>=0&&!i.metas.is3DDSWAMode,i.body.addClassName("empty"),this.isReadOnlyMode()&&i.body.addClassName("readonly"),i.setMetas({_preventsSaveOnEditPrefs:!0,_dispatchOnSetValueCallbacks:!0}),this.dataManager=new h({MultiNotes:this}),this._initWidgetEvents(),this._initCkeditorPlugins()},_initCkeditorPlugins:function(){l.disableAutoInline=!0,require(["DS/MultiNotesWdg/ckeditor/autohyperlink/plugin"],function(){l.plugins.addExternal("autohyperlink","../../MultiNotesWdg/ckeditor/autohyperlink/","plugin.js")},function(t){e.log("Fail to init CKEditor plugins:"),e.log(t)})},_initWidgetEvents:function(){var e=this.widget,t=this.dataManager;e.addEvents({onLoad:this._onLoad.bind(this),onRefresh:this.onRefresh.bind(this),onDestroy:this._onDestroy.bind(this),onViewChange:this._onViewChange.bind(this),onResize:c.debounce(this._onResize.bind(this),750),onSortChange:this.onRefresh.bind(this),onSearch:this._onSearch.bind(this),onResetSearch:this._onResetSearch.bind(this),onEdit:t.onShowEditPrefs.bind(t),endEdit:t.onHideEditPrefs.bind(t),onSetValueSuccess:t.onSetValueSuccess.bind(t),onSetValueFailure:t.onSetValueFailure.bind(t)})},replace:p,apply:v,formatUShortDate:function(e){return new Date(e).toLocaleDateString(this.widget.lang||"en",{year:"2-digit",month:"2-digit",day:"2-digit"})},formatShortDate:function(e){return new Date(e).toLocaleDateString(this.widget.lang||"en",{year:"numeric",month:"short",day:"numeric",weekday:"short"})},formatLongDate:function(e){return new Date(e).toLocaleDateString(this.widget.lang||"en",{year:"numeric",month:"long",day:"numeric",weekday:"long"})},formatTime:function(e){return new Date(e).toLocaleTimeString(this.widget.lang||"en",{hour:"numeric",minute:"numeric"})},applyHighlight:function(e){return'<span class="highlight">'+e+"</span>"},getLang:function(){return this.widget.lang||"en"},getCkeditorLang:function(){var e=this.getLang().toLowerCase();return{zh:"zh-cn","zh-tw":"zh"}[e]||e},getQuerySearch:function(){return this._querySearch||""},getWidget:function(){return this.widget},getSkeleton:function(){return this.skeleton},getCollection:function(){var e=this.getSkeleton();return e&&e.getCollectionAt(0)},getDataManager:function(){return this.dataManager},setWidgetTitle:function(e){var t="string"==typeof e?e:this.dataManager.getWidgetTitle();this.widget.setTitle(t)},_buildSkeleton:function(){var e=this,t=e.widget.body,n=e.getSkeleton(),i=e.dataManager.getRoute()||"/notes/";n?e._refreshView():(e.skeleton=n=new d({notes:{collection:u,collectionOptions:{MultiNotes:e},view:g,viewOptions:{MultiNotes:e,useInfiniteScroll:!1,usePullToRefresh:!1,swipe:!1},idCardOptions:{attributesMapping:{title:"name"},facets:function(){return[{text:m.editNoteFacet,icon:"pencil",handler:d.getRendererHandler(f,{viewOptions:{MultiNotes:e}})}]},actions:function(){return e.isReadOnlyMode()?[]:[{text:m.editColor,icon:"palette",handler:function(t){e.showColorModal(t.model)}},{text:m.renameAction,icon:"pencil",handler:function(e){e.switchToEditMode()}},{text:m.deleteAction,icon:"trash",handler:function(t){e.showDeleteModal(t.model)}}]}}}},{root:"notes",startRoute:i,responsiveTrigger:function(){return"maximized"===e.widget.getView().type},rendererOptions:{swipe:!1},events:{onSlide:function(){var t=arguments;clearTimeout(e._timeoutOnSlide),e._timeoutOnSlide=setTimeout(function(){var n=e.getSkeleton(),i=n.getViewAt(1),o=e.getCollection();i&&i.onSkeletonSlideEnd.apply(i,t),e._onSlideBackPromise&&(e._onSlideBackPromise.resolve(),e._onSlideBackPromise=null),o&&e.dataManager.setRoute(o.getSelected(),n.getState())},100)}}}).render(),n.inject(t))},addNewNote:function(e){var t,n=this.getCollection();return n?(t=n.addNewNote(e),this.dataManager.addNote(t)):Promise.reject("Collection is undefined.")},showDeleteModal:function(t){var n=this,i=t.get("name").unescapeHTML();return n.showConfirmModal({title:m.deleteTitle,body:p(m.deleteBody,{name:i})}).then(function(i){return!!i&&n.deleteNote(t).then(function(){return!0}).catch(function(t){return e.log(t),!1})})},deleteNote:function(e){var t=this;return new Promise(function(n){var i=t.getSkeleton(),o=e.isSelected();function s(i){var o;o=i.slideBack?t._slideBack():Promise.resolve(),e.destroy(),o.then(function(){n()})}o&&"collapsed"===i.getState()?i.setExpandedLayout({animate:!1}).then(function(){s({slideBack:!0})}):s({slideBack:o})})},duplicateNote:function(e){return this.addNewNote({name:p(m.copyOf,{noteName:e.get("name")}),color:e.get("color"),content:e.get("content")})},showColorModal:function(t,n){var i,s,a;function r(e){e.isReadOnly()&&i&&i.hide()}return t.listenTo(t,"onReadOnly",r),(a=new _({style:"overflow-style",selectedColor:t.get("color"),events:{colorChange:function(e){t.set("color",e)}}})).DARK_BG=this.DARK_BG,a.DARK_COLOR=.85,a.colorMatrix=[["#E53F33","#FF4289","#703AC6","#4456C4"],["#169EFF","#05C6E2","#1C6821","#93D149"],["#FFFF26","#FFCE05","#FF5E0C","#845B4F"],["#888888","#333333","reset"]],s=e.createElement("div",{class:"color-body-wrapper",html:[{tag:"button",type:"button",class:"close",title:m.close,text:"",events:{click:function(){i&&i.hide()}}},a.render().container]}),this._destroyModal(),this._modal=i=new o({className:"color-modal",closable:!1,body:s,events:{onHide:function(){i&&i.destroy(),t.stopListening(t,"onReadOnly",r),n&&n()},onShow:function(){var e=this.elements.body,t=e.getElement(".color-body-wrapper").remove();e.empty(),e.setHTML(t),e.setStyles({height:"","max-height":"300px"})}}}).inject(document.body).show(),i},showConfirmModal:function(e){var t=this;return new Promise(function(n){t._destroySuperModal(),t._superModal=new i({closable:"boolean"!=typeof e.closable||e.closable}),t._superModal.confirm(e.body||"",e.title,n),e.bodyHTML&&t._superModal.modals.current.elements.body.setHTML(e.bodyHTML)})},showNotSavedPopover:function(t){var n=this,i=n._notSavedPopover;i&&i.destroy(),(i=new a({className:"not-saved-popover",target:t,trigger:"touch",position:"top",title:m.failToSavePopoverTitle,body:e.createElement("div",{html:p(m.failToSavePopoverText,{retryClass:"retry-link"}),events:{click:function(e){if(e.target.classList.contains("retry-link")){var t=n.getCollection();t&&t.retrySave(),n._notSavedPopover.toggle()}}}})})).toggle(),n._notSavedPopover=i},showLoadingBar:function(e){var t=this.widget.body,n=this._loadingBarTooltip;t.addClassName("show-loading-bar"),"fetch"===e?(t.addClassName("reverse-loading-bar"),n.setBody(m.fetchInProgressTooltip)):(t.removeClassName("reverse-loading-bar"),n.setBody(m.saveInProgressTooltip))},hideLoadingBar:function(){var e=this.widget.body;e.removeClassName("show-loading-bar"),e.removeClassName("reverse-loading-bar")},showAlert:function(e){var t=this;e=e||{},t.removeAlert(),t._alert=new s({className:"alert alert-multinotes",closable:!0,visible:!0,messages:e.message||m.errorTryLater,messageClassName:e.type||"error",events:{onShow:function(){var n=document.body,i=n.getElement(".alert-multinotes .go-to-btn"),o=n.getElement(".alert-multinotes .retry-btn");i&&i.addEvent("click",function(){t._openNote(e.note)}),o&&o.addEvent("click",t._onRetrySave.bind(t))}}}).inject(document.body).show()},removeAlert:function(){this._alert&&this._alert.destroy(),this._alert=null},_onLoad:function(){var t=this;return t._buildLoadingBar(),t.dataManager.onLoad().then(t.setWidgetTitle.bind(t)).then(t._buildSkeleton.bind(t)).then(function(){t.widget.setMetas({_readyForSearchEvent:!0}),t.isPreviewMode()&&t.showAlert({message:m.previewModeMsg,type:"info",closable:!1}),setTimeout(function(){!t._CKEDITORHasBeenWarmUp&&t._warmUpCKEditor()})}).catch(function(n){e.log(n),t.showAlert({type:"error"})})},onRefresh:function(){var t=this;if(t.dataManager.shouldPreventOnRefresh())return Promise.resolve();var n=t.getCollection(),i=Promise.resolve(!0);return n&&(n.hasFailToSave()||n.hasModified())&&(i=t.showConfirmModal({title:m.refreshConfirmTitle,bodyHTML:e.createElement("div",{class:"refresh-confirm-body",html:[{tag:"span",class:"fonticon fonticon-attention warn-icon"},{tag:"span",text:m.refreshConfirmText}]})})),i.then(function(e){return e&&(t.removeAlert(),t._destroyModal(),t._destroySuperModal()),e?t._onLoad().then(function(){var e=Promise.resolve(),n=t.getCollection();return n&&!n.getSelected()&&(e=t._slideBack()),e}):null})},_onResize:function(){if(this.widget.body.getDimensions().height){var e=this.getSkeleton(),t=e?e.getViewAt(1):null;t&&t.onResize&&(t.onResize(),e.getViewAt(0).scrollToNote(null,"center"))}},_onViewChange:function(){this.widget.dispatchEvent("onResize")},_onSearch:function(e,t){t=t||{};var n,i=this.getSkeleton(),o=this._querySearch;if(t.force||(e||o)&&e!==o){if(e&&o&&e!==o)return this._onResetSearch(t),void v(this._onSearch,this,[e,t],!0);this._querySearch=e||"",i&&(n=i.getViewAt(0))&&n.onSearch&&n.onSearch(e,t)}},_onResetSearch:function(e){this._onSearch("",e)},onEmptyCollection:function(e){var t=this.widget.body;e?t.addClassName("empty"):t.removeClassName("empty")},_onDestroy:function(){clearTimeout(this._timeoutOnSlide),this._onSlideBackPromise=null,this._destroyAllCkeditorInstances(),this.dataManager.onDestroy(),this.dataManager=null,this.skeleton&&this.skeleton.destroy(),this.skeleton=null,this.removeAlert(),this._destroySuperModal(),this._destroyModal(),this.widget=null,this._notSavedPopover&&this._notSavedPopover.destroy(),this._notSavedPopover=null,this._loadingBar&&this._loadingBar.destroy(),this._loadingBar=null,this._loadingBarTooltip&&this._loadingBarTooltip.destroy(),this._loadingBarTooltip=null},isPreviewMode:function(){return this._isPreviewMode},isReadOnlyMode:function(){return this._isReadOnlyMode},isTouchDevice:function(){return c.hasTouch()},_buildLoadingBar:function(){var t,n=this.widget.body;this._loadingBar||(n.empty(),this._loadingBar=t=e.createElement("div",{class:"loading-bar",html:{tag:"div",class:"loader",html:{tag:"div",class:"loader-bar"}}}).inject(n),this._loadingBarTooltip=new r({target:t}))},_openNote:function(e){var t=this.getCollection();t&&t.dispatchSelectNote(e)},_refreshView:function(){var e=this;return new Promise(function(t){var n=e.getCollection();n&&n.fetch({reset:!0,onComplete:function(n){var i=Promise.resolve(),o=e.getSkeleton().getViewAt(1),s=e.getQuerySearch();if(o){var a=o.model.get("id"),r=n.get(a);r?o.refreshView&&o.refreshView(r):i=e._slideBack()}return n.dispatchSelectNote(),s&&e._onSearch(s,{force:!0}),i.then(t)}})})},_slideBack:function(){var e=this;return new Promise(function(t,n){e._onSlideBackPromise={resolve:t,reject:n},e.getSkeleton().slideBack()})},_warmUpCKEditor:function(){var t,n,i=this;t=e.createElement("div",{class:"warmup-ckeditor-ctn"}).inject(i.widget.body),(n={removePlugins:"exportpdf",language:i.getCkeditorLang()}).on={instanceReady:function(e){e=e||{},setTimeout(function(){e.editor&&(window.CKEDITOR.instances[e.editor.name].destroy(),e.editor.destroy()),t.destroy(),i._CKEDITORHasBeenWarmUp=!0})}},t.setAttribute("contenteditable",!0);try{window.CKEDITOR.replace(t,n)}catch(t){e.log(t)}},_destroySuperModal:function(){var e=this._superModal;e&&e.modals.current&&(e.modals.current.destroy(),e.destroy()),this._superModal=null},_destroyModal:function(){this._modal&&this._modal.destroy(),this._modal=null},_destroyAllCkeditorInstances:function(){for(var e in window.CKEDITOR.instances)window.CKEDITOR.instances[e].destroy()},_onRetrySave:function(){var e=this.getCollection();this.removeAlert(),e&&e.retrySave()}})});