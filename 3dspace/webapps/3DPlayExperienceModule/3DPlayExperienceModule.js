/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/3DPlayUtils/IdentifyPLMType",["UWA/Class","DS/3DPlaySupport/SupportList"],function(e,t){"use strict";return e.extend({init:function(){this._parent()},isKindOfDrawing:function(e,i){t["3DSPACE"].resolveParenting(e,function(e){"drawing"===e.toLowerCase()?i(e):i(!1)})}})}),define("DS/3DPlaySocialPanel/3DPlaySocialPanel",[],function(){}),define("DS/WebViewer2D/CanvasShapes",["UWA/Class","DS/WebUtils/GeometryUtils","DS/WebUtils/Vector2"],function(e,t,i){"use strict";function n(e){var t=e.settings;return{id:Date.now(),type:e.shapeData.type,property:{color:t.getColor(),thickness:t.getThickness()/e.scale},linkID:new Array,data:{}}}function r(e){var t=e.shape.property,i=e.canvas.getContext("2d");return e.lowLightMode?(i.globalAlpha=.8,i.strokeStyle="#D3D3D3",i.fillStyle="#D3D3D3"):(i.strokeStyle=t.color,i.fillStyle=t.color,i.globalAlpha=1,e.alpha&&(i.globalAlpha=e.alpha)),i.lineCap="round",i.lineJoin="round",i.lineWidth=t.thickness*e.scale,i}function o(e,t,i){var n=t.length;e.beginPath(),e.moveTo(t[0].x,t[0].y);for(var r=1;r<n;++r)e.lineTo(t[r].x,t[r].y);i&&e.closePath(),e.stroke()}var s={createunknownOpen:function(e){var t=n(e),i=e.shapeData;return t.data={path:i},t},drawunknownOpen:function(e){for(var t=e.shape,i=r(e),n=t.data.path,s=[],a=n.length,l=0;l<a;++l)s.push({x:n[l].x*e.scale,y:n[l].y*e.scale});return o(i,s,!1),{lastPosition:s[0].x-s[a-1].x>=0?s[0]:s[a-1]}},isIntersectunknownOpen:function(e){for(var i=e.shape,n=i.data.path,r=0;r<n.length-1;++r)if(t._intersect(n[r],n[r+1],e.startPoint,e.endPoint))return i.id;return!1},createline:function(e){var t=n(e),i=e.shapeData,r=[];return r.push({x:i[0].x,y:i[0].y}),r.push({x:i[i.length-1].x,y:i[i.length-1].y}),t.data={path:r},t},drawline:function(e){return s.drawunknownOpen(e)},isIntersectline:function(e){return s.isIntersectunknownOpen(e)},createarrowhead:function(e){var t=n(e),r=e.shapeData.data.vertices,o=e.shapeData.connectionData;if(o){for(var s=o.shape,a=o.pointID,l=o.pointEndID,d=s.data.path,c=function(e,t){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)},u=0,h=0;h<d.length-1;++h)u+=c(d[h+1],d[h]);u*=.15;var p=c(r[1],r[0]),g=c(r[1],r[2]),f=p>=g?p:g;u=f<=u?f:u;var m=new i(d[l].x-d[a].x,d[l].y-d[a].y);(m=m.normalize()).rotateAround({x:0,y:0},.55),r[0].x=m.x*u+d[a].x,r[0].y=m.y*u+d[a].y,r[1].x=d[a].x,r[1].y=d[a].y,m.rotateAround({x:0,y:0},-1.1),r[2].x=m.x*u+d[a].x,r[2].y=m.y*u+d[a].y,s.linkID.push({id:t.id,pointID:a}),t.linkID.push({id:s.id,pointID:1})}return t.data={path:r},t},drawarrowhead:function(e){var t=e.shape,i=r(e),n=[];return n.push({x:t.data.path[0].x*e.scale,y:t.data.path[0].y*e.scale}),n.push({x:t.data.path[1].x*e.scale,y:t.data.path[1].y*e.scale}),n.push({x:t.data.path[2].x*e.scale,y:t.data.path[2].y*e.scale}),o(i,n,!1),{lastPosition:{x:n[1].x,y:n[1].y}}},isIntersectarrowhead:function(e){return s.isIntersectunknownOpen(e)},createcircle:function(e){var t=n(e),i=e.shapeData;return t.data={radius:i.data.radius,centre:{x:i.data.centre.x,y:i.data.centre.y}},t},drawcircle:function(e){var t=e.shape,i=r(e),n=t.data.centre.x*e.scale,o=t.data.centre.y*e.scale,s=t.data.radius*e.scale;return i.beginPath(),i.arc(n,o,s,0,2*Math.PI),i.stroke(),{lastPosition:{x:n,y:o}}},isIntersectcircle:function(e){for(var i=e.shape,n=i.data.radius,r=i.data.centre.x,o=i.data.centre.y,s=2*Math.PI/10,a=[],l=0;l<2*Math.PI;l+=s)a.push({x:r+n*Math.cos(l),y:o+n*Math.sin(l)});for(var d=0;d<a.length-1;++d)if(t._intersect(a[d],a[d+1],e.startPoint,e.endPoint))return i.id;return!1},createellipse:function(e){var t=e.shapeData,i=n(e);return i.data={radiusX:t.data.radius1,radiusY:t.data.radius2,centre:{x:t.data.centre.x,y:t.data.centre.y},angle:t.data.angle},i},drawellipse:function(e){var t=e.shape,i=r(e),n=t.data.centre.x*e.scale,o=t.data.centre.y*e.scale,s=t.data.radiusX*e.scale,a=t.data.radiusY*e.scale,l=t.data.angle*Math.PI/180;return i.save(),i.beginPath(),i.translate(n,o),i.rotate(l),i.translate(-s,-a),i.scale(s,a),i.arc(1,1,1,0,2*Math.PI),i.restore(),i.stroke(),{lastPosition:{x:n,y:o}}},isIntersectellipse:function(e){var n=e.shape,r=n.data.centre.x,o=n.data.centre.y,s=n.data.radiusX,a=n.data.radiusY,l=n.data.angle*Math.PI/180,d=[];d.push(new i(r+s,o+a).rotateAround({x:r,y:o},l)),d.push(new i(r-s,o+a).rotateAround({x:r,y:o},l)),d.push(new i(r-s,o-a).rotateAround({x:r,y:o},l)),d.push(new i(r+s,o-a).rotateAround({x:r,y:o},l));for(var c=0;c<d.length-1;++c)if(t._intersect(d[c],d[c+1],e.startPoint,e.endPoint))return n.id;return!1},createpolygon:function(e){var t=e.shapeData,i=n(e);i.data={},i.data.path=[];for(var r=0;r<t.data.vertices.length;++r)i.data.path.push({x:t.data.vertices[r].x,y:t.data.vertices[r].y});return i},drawpolygon:function(e){for(var t=e.shape,i=r(e),n=null,s=null,a=t.data.path,l=[],d=a.length,c=0;c<d;++c)l.push({x:a[c].x*e.scale,y:a[c].y*e.scale}),(null==n||n<l[c].x)&&(n=l[c].x),(null==s||s>l[c].y)&&(s=l[c].y);return o(i,l,!0),{lastPosition:{x:n,y:s}}},isIntersectpolygon:function(e){return s.isIntersectunknownOpen(e)},createrectangle:function(e){return s.createpolygon(e)},drawrectangle:function(e){return s.drawpolygon(e)},isIntersectrectangle:function(e){return s.isIntersectpolygon(e)},createsquare:function(e){return s.createpolygon(e)},drawsquare:function(e){return s.drawpolygon(e)},isIntersectsquare:function(e){return s.isIntersectpolygon(e)},createtriangle:function(e){return s.createpolygon(e)},drawtriangle:function(e){return s.drawpolygon(e)},isIntersecttriangle:function(e){return s.isIntersectpolygon(e)},createtext:function(e){var t=n(e);return t.data=e.shapeData,t},drawtext:function(e){var t=e.shape.data,i=1+t.point.x*e.scale,n=t.point.y*e.scale,o=r(e),s=Math.ceil(t.fontSize*e.scale)+'px "3ds"';o.font=t.fontWeight+" "+s;for(var a=0;a<t.text.length;++a){var l=n+(t.offsetHeight-4)*e.scale*t.controlScale+a*t.offsetHeight*e.scale*t.controlScale;o.fillText(t.text[a],i,l)}return{lastPosition:{x:i,y:n}}},isIntersecttext:function(e){var i=e.shape.data.point.x,n=e.shape.data.point.y,r=e.shape.data.width,o=e.shape.data.height,s=[];s.push({x:i,y:n}),s.push({x:i,y:n+o}),s.push({x:i+r,y:n+o}),s.push({x:i+r,y:n});for(var a=0;a<s.length-1;++a)if(t._intersect(s[a],s[a+1],e.startPoint,e.endPoint))return e.shape.id;return!1}};return{createShapeFromJSON:function(e){},createShape:function(e){var t=s["create"+e.shapeData.type];return t||(t=s.createunknownOpen),t(e)},drawShape:function(e){var t=s["draw"+e.shape.type];return t||(t=s.drawunknownOpen),t(e)},isIntersectShape:function(e){var t=s["isIntersect"+e.shape.type];t||(t=s.isIntersectunknownOpen);var i=!1,n=t(e);return n&&(i=new Array,function e(t,i,n){if(n.indexOf(t)<0){n.push(t);var r=i[t];if(r)for(var o=r.linkID,s=0;s<o.length;++s)e(o[s].id,i,n)}return n.length>0}(n,e.shapeList,i)),i}}}),define("DS/3DPlayUtils/ContextualBar",["DS/WebInfraUI/ContextualBar"],function(e){"use strict";return console.log("WARNING!!! ContextualBar class has been migrated to new module. Please use 'DS/WebInfraUI/ContextualBar' to access it."),e}),define("DS/3DPlayUtils/NavigationArrows",["DS/WebInfraUI/NavigationArrows"],function(e){"use strict";return console.log("WARNING!!! NavigationArrows class has been migrated to new module. Please use 'DS/WebInfraUI/NavigationArrows' to access it."),e}),define("DS/3DPlaySocialPanel/3DPlaySocialPanelManager",["UWA/Class","DS/Windows/Panel","DS/WebSystem/Settings","DS/WebappsUtils/WebappsUtils"],function(e,t,i,n){"use strict";return e.extend({init:function(e){this._parent(e),this._frameWindow=e.frameWindow,this._buildPanel({assetId:e.assetId,tenantId:e.tenantId,serviceUrl:e.serviceUrl,assetProvider:e.assetProvider,serverToken:e.serverToken,onClickCB:e.onCommentClick})},_buildPanel:function(e){var i=this;require(["DS/SocialToolbar/SocialToolbar"],function(r){var o=new UWA.Element("div",{styles:{"background-color":"white"}}),s=i._frameWindow.getImmersiveFrame(),a=WUXDockAreaEnum.RightDockArea,l=e.serviceUrl,d=e.assetId;!e.assetProvider||"3DDRIVE"!=e.assetProvider&&"3DSPACE"!=e.assetProvider||(l=e.serviceUrl+"/resources",d="3DDRIVE"==e.assetProvider?"driveid:"+d:"pid:"+d),i.commentPanel=new r({subjectURI:d,tenantId:e.tenantId,serviceURL:l,"3DSwymServerToken":e.serverToken,enableShare:!1,commentProxyToken:{header:"X-DS-CSRFTOKEN"},events:{onMediaClick:e.onClickCB}}),i.commentPanel.inject(o),i._dockingElement=s.getDockingElement(a),i.panel=new t({titleBarVisibleFlag:!1,icon:n.getWebappsAssetUrl("3DPlaySpecTree","icons/32/")+"I_3DPlaySpecTree.png",title:"",content:o,immersiveFrame:s,resizableFlag:!0,movableFlag:!1,currentDockArea:a,width:400,verticallyStretchableFlag:!0,usePaddingFlag:!1,closeButtonFlag:!1,floatableFlag:!1,expandedFlag:!0,ensureHeightDefinitionOnHierarchy:!0})},function(e){console.log("Require failed for SocialToolbar")})},hide:function(){return!!this._dockingElement&&(this._dockingElement.visibleDockingZoneFlag=!1,this._dockingElement.collapseDockingZoneFlag=!0,!0)},show:function(){return!!this._dockingElement&&(this._dockingElement.visibleDockingZoneFlag=!0,this._dockingElement.collapseDockingZoneFlag=!1,!0)},postComment:function(e,t){if(this.commentPanel){var i={media:[{type:"annotation",file:t,data:{annotationFile:e}}]};this.commentPanel.setActiveFieldContent(i)}},dispose:function(){this.panel.destroy(),this.panel=void 0}})}),define("DS/WebViewer2D/ViewerDoc",["UWA/Core","UWA/Class","UWA/Element","DS/WebSystem/Environment"],function(e,t,i,n){"use strict";var r={init:function(t){var i,n;if(this.errorThumbnail="../3DPlay2DExperience/assets/images/I_3DSHARELoadFailed.png",this.status={failed:!1,loaded:!1},this.realSizeWidth=t.realSizeWidth,this.realSizeHeight=t.realSizeHeight,this.viewer=t.viewer,this.actionbarHeight=t.actionbarHeight,t.asset&&(n=t.asset.currentSrc||t.asset.baseURI||t.asset),"string"==typeof n&&""!==n){var r=n.split("/");i=r[r.length-1]}this.title=t.defaultTitle||i,this.thumbnail=null;var o={sheet:t.sheet};this.container=new e.Element("div",{data:o,class:"viewer"}).inject(this.viewer)},loadAsset:function(e){e.asset!==this.asset&&(this.asset=e.asset)},_setThumbnail:function(e){this.thumbnail=e},getTitle:function(){return this.title},getCurrentScale:function(){return this.scale},getRealSizeHeight:function(){return this.realSizeHeight},getRealSizeWidth:function(){return this.realSizeWidth},getMargin:function(){return this.margin},getContainer:function(){return this.container},show:function(){this.container.style.top="0px"},hide:function(){this.container.style.top=this.viewer.offsetHeight+"px"},onMouseWheel:function(e){e.preventDefault&&e.preventDefault();var t=window.event||e;this.zoom(t,(t.wheelDelta||-t.detail)>0?1.1:10/11,{x:t.clientX,y:t.clientY})},initMouseMoveZoom:function(e){this.currentZoom=100,this.initialY=e.clientY,this.minZoom=!1,this.viewerCenter={x:this.container.offsetWidth/2,y:this.container.offsetHeight/2},this.currentScale=this.scale},onMouseMoveZoom:function(e){if(n.isSet("3DPlay.DisableViewerCanvas")){var t=e.from&&e.from.length?e.from[0].event:null,i=100+(this.initialY-t.clientY)/2;if(i>0&&(!1===this.minZoom||i>this.currentZoom)&&(this.zoom(t,100/this.currentZoom,{x:this.viewerCenter.x,y:this.viewerCenter.y}),this.currentZoom=i,this.zoom(t,this.currentZoom/100,{x:this.viewerCenter.x,y:this.viewerCenter.y}),this.minZoom=this.scale<.1),!(e.from&&e.from[0]&&e.from[0].event&&e.from[0].event.preventDefault))return!1;e.from[0].event.preventDefault()}else if(e.from&&e.from[0]&&e.from[0].event&&e.from[0].event.preventDefault){e.from[0].event.preventDefault();var r=e.from&&e.from.length?e.from[0].event:null,o=this.initialY-r.clientY;if(Math.abs(o)>this.viewer.offsetHeight/100&&Math.abs(o)<this.viewer.offsetHeight){var s=1+o/this.viewer.offsetHeight*10,a=this.currentScale*s/this.scale;this.zoom(r,a,{x:this.viewerCenter.x,y:this.viewerCenter.y})}}return this.scale},panStart:function(e,t){},pan:function(e,t){return!0},panEnd:function(e,t){},onResize:function(){},fit:function(){},realSize:function(){},reframe:function(){},zoom:function(e,t,i){return!0},focusOn:function(e,t){},getScreenShot:function(e){var t=document.createElement("canvas");t.width=this.viewer.offsetWidth,t.height=this.viewer.offsetHeight;var i=t.getContext("2d");i.beginPath(),i.rect(0,0,t.width,t.height),i.fillStyle="white",i.fill();this.generateScreenshotOfDoc({onSuccess:function(r,o){i.drawImage(r,Math.floor(o.clipX),Math.floor(o.clipY),Math.floor(o.clipWidth),Math.floor(o.clipHeight),Math.floor(o.pastingX),Math.floor(o.pastingY),Math.floor(o.pastingWidth),Math.floor(o.pastingHeight)),n.isSet("ODT_3DPlay_Document2D")?require(["DS/CoreEvents/Events"],function(e){e.publish({event:n.get("ODT_3DPlay_Document2D")})}):e.onSuccess(t.toDataURL("image/png"))},onFail:function(t){e.onFail(t)},width:t.width,height:t.height})},generateScreenshotOfDoc:function(e){},rotate:function(e){},getAnnotationDiv:function(){},loadFailed:function(e){this.status.failed=!0,this.failureID=" failed "},getErrorID:function(){return this.failureID},dispose:function(){this.viewer.removeChild(this.container),this.container=this.viewer=null},setRealDimension:function(e){e&&(this.realSizeWidth=e.realSizeWidth,this.realSizeHeight=e.realSizeHeight)}};return t.extend(r)}),define("DS/3DPlayUtils/ContextualBarManager",["DS/WebInfraUI/ContextualBarManager"],function(e){"use strict";return console.log("WARNING!!! ContextualBarManager class has been migrated to new module. Please use 'DS/WebInfraUI/ContextualBarManager' to access it."),e}),define("DS/3DPlayUtils/ConvertService",["UWA/Class"],function(e){"use strict";return e.extend({init:function(){this.supportedFormats={};var e=0;this.getConversionFormat=function(e){return this.supportedFormats[e]||null},this.clearQueue=function(){e++},this.convert=function(t,i,n,r,o){var s=i.ConversionFeedBack.progress,a=s.registerSubProgress(),l=i.ConversionFeedBack.notifTimeoutID,d=t;!1===Array.isArray(d)&&(d=[d]);for(var c=0,u=0,h=function(t){t.queueIdx===e&&(clearTimeout(l),s.advanceToMax(a),c++,delete t.queueIdx,c+u===d.length?r(t):o?o(t):r(t))},p=function(e,t){clearTimeout(l),s.advanceToMax(a),u++,n(e,t)},g=0;g<d.length;g++)d[g].queueIdx=e,this._convert({asset:d[g],onConvertSuccess:h,onConvertError:p,ConversionOpts:i.ConversionOpts||{}})},this._convert=function(){console.error("PlayWeb - Something is wrong, _convert is not defined.")}}})}),define("DS/3DPlayUtils/FullScreen",["UWA/Class","DS/CoreEvents/Events"],function(e,t){"use strict";return e.extend({init:function(e,i,n,r){this._parent();var o,s,a="none";try{window.getSwymContainer&&(e=window.getSwymContainer())}catch(e){}if(i&&"HTML5"===i.mode){for(var l=!0,d=window,c=document,u=d.parent;d!==u&&l;){var h,p,g=u.document,f=g.getElementsByTagName("iframe");for(h=0;h<f.length;h++)if((p=g.getElementsByTagName("iframe")[h])&&p.contentWindow.document===c){p.getAttribute("allowfullscreen")||(l=!1);break}c=g,u=(d=u).parent}if(l=(l=l&&(e.requestFullscreen||e.mozRequestFullScreen||e.webkitRequestFullscreen||e.msRequestFullscreen))&&(document.cancelFullScreen||document.mozCancelFullScreen||document.webkitCancelFullScreen||document.msCancelFullScreen||document.msFullscreenEnabled)){a="html5",s=function(){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()},o=function(){document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msCancelFullScreen&&document.msCancelFullScreen()};var m=function(t){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement||!n.classList.contains("active")&&!e.classList.contains("PlayWeb-FullScreen")?(n.addClassName("active"),e.classList.add("PlayWeb-FullScreen")):(n.removeClassName("active"),e.classList.remove("PlayWeb-FullScreen"))};document.onfullscreenchange=m,document.onmozfullscreenchange=m,document.onwebkitfullscreenchange=m,document.onmsfullscreenchange=m}}else if(i&&"CUSTOM"===i.mode&&i.onActivate&&i.onDeactivate&&r&&r.getView){a="custom",s=function(){setTimeout(function(){t.publish({event:"3DPLAY/3DPLAYPREVIEW/ENABLE",data:{}})},500)},o=function(){t.publish({event:"3DPLAY/3DPLAYPREVIEW/DISABLE",data:{}})};var v=function(e){r.fullscreen&&t.publish({event:"3DPLAY/PLAYFROMCOMPASS/DISABLE",data:{}})},S=function(e){r.fullscreen&&setTimeout(function(){t.publish({event:"3DPLAY/PLAYFROMCOMPASS/ENABLE",data:{}})},500)};r.addEvent("onHide",v),r.addEvent("onShow",S),r.onViewChange=function(e){"maximized"===e.type||"fullscreen"===e.type?t.publish({event:"3DPLAY/FULLSCREEN/ENABLE",data:{}}):"windowed"!==e.type&&"minimized"!==e.type||t.publish({event:"3DPLAY/FULLSCREEN/DISABLE",data:{}})},i.onViewChange&&i.onViewChange(function(t){!0===t?(n.addClassName("active"),e.classList.add("PlayWeb-FullScreen")):(n.removeClassName("active"),e.classList.remove("PlayWeb-FullScreen"))})}else if(i&&"PLATFORM"===i.mode&&r&&r.getView&&r.requestView){a="platform";var D="none";s=function(){"fullscreen"!==(D=r.getView().type)&&r.requestView({type:"fullscreen"})},o=function(){"fullscreen"!==D&&r.requestView({type:D})};v=function(e){r.fullscreen&&t.publish({event:"3DPLAY/PLAYFROMCOMPASS/DISABLE",data:{}})},S=function(e){r.fullscreen&&setTimeout(function(){t.publish({event:"3DPLAY/PLAYFROMCOMPASS/ENABLE",data:{}})},500)};r.addEvent("onHide",v),r.addEvent("onShow",S),r.onViewChange=function(o){"maximized"===o.type||"fullscreen"===o.type?t.publish({event:"3DPLAY/FULLSCREEN/ENABLE",data:{}}):"windowed"!==o.type&&"minimized"!==o.type||t.publish({event:"3DPLAY/FULLSCREEN/DISABLE",data:{}}),"fullscreen"!==o.type&&n.classList.contains("active")&&(e.classList.remove("PlayWeb-FullScreen"),n.removeClassName("active"),"fullscreen"!==D&&r.requestView({type:D}),i.onDeactivate&&i.onDeactivate())}}t.subscribe({event:"3DPLAY/2D/TEXT_SEARCH/BEGIN"},function(){n.getParent().setStyle("top",n.getParent().offsetTop+50+"px")}),t.subscribe({event:"3DPLAY/2D/TEXT_SEARCH/END"},function(){n.getParent().setStyle("top",n.getParent().offsetTop-50+"px")}),this.getMode=function(){return a},this.toggle=function(){e.classList.contains("PlayWeb-FullScreen")?(o(),n.removeClassName("active"),i&&i.onDeactivate&&i.onDeactivate(),e.classList.remove("PlayWeb-FullScreen")):(s(),e.classList.add("PlayWeb-FullScreen"),i&&i.onActivate&&i.onActivate(),n.addClassName("active"))}}})}),define("DS/3DPlayUtils/UIManager",["UWA/Class","DS/WebUtils/EventDisposer"],function(e,t){"use strict";return e.extend({init:function(e){this.ActionBarEventArray=new Array,this.ResizeEventArray=new Array,this.PanelEventArray=new Array,this.registerEvents(e)},registerEvents:function(e){var i=e.frameWindow,n=e.ctx,r=this,o=i.getActionBar();o&&(o.onActionBarClose(function(e){if(r&&r.ActionBarEventArray)for(var t=0,i=r.ActionBarEventArray.length;t<i;t++){r.ActionBarEventArray[t].addClassName("wux-ui-state-close")}}),o.onActionBarOpen(function(e){if(r&&r.ActionBarEventArray)for(var t=0,i=r.ActionBarEventArray.length;t<i;t++){var n=r.ActionBarEventArray[t];n.removeClassName("wux-ui-state-close"),"none"===n.style.display&&(n.style.display="block")}}));var s=function(e,t){if(r&&r.PanelEventArray)for(var i=0,n=r.PanelEventArray.length;i<n;i++){var o=r.PanelEventArray[i];if("object"==typeof o&&o.customCB){var s=UWA.extend({},e);s.visible=t,o.customCB(s)}else o.style.display=1==t?"none":""}};this.EventDisposer=new t,i&&i.experience?(this.EventDisposer.add(i.experience.subscribe("3DPLAY/RIGHTPANEL/OPEN",function(e){s(e,!0)})),this.EventDisposer.add(i.experience.subscribe("3DPLAY/RIGHTPANEL/CLOSE",function(e){s(e,!0)})),this.EventDisposer.add(i.experience.subscribe("3DPLAY/RIGHTPANEL/SHOW",function(e){s(e,!0)})),this.EventDisposer.add(i.experience.subscribe("3DPLAY/RIGHTPANEL/HIDE",function(e){s(e,!1)}))):(this.EventDisposer.add(WUX.Events.subscribe({event:"/"+n+"3DPLAY/RIGHTPANEL/OPEN"},function(e){s(e,!0)}),WUX.Events),this.EventDisposer.add(WUX.Events.subscribe({event:"/"+n+"3DPLAY/RIGHTPANEL/CLOSE"},function(e){s(e,!0)}),WUX.Events),this.EventDisposer.add(WUX.Events.subscribe({event:"/"+n+"3DPLAY/RIGHTPANEL/SHOW"},function(e){s(e,!0)}),WUX.Events),this.EventDisposer.add(WUX.Events.subscribe({event:"/"+n+"3DPLAY/RIGHTPANEL/HIDE"},function(e){s(e,!1)}),WUX.Events))},dispose:function(){this.ActionBarEventArray=null,this.ResizeEventArray=null,this.PanelEventArray=null,this.EventDisposer.dispose(),this.EventDisposer=null},addToActionBarEvent:function(e){e.addClassName("wux-afr-actionbar"),this.ActionBarEventArray.push(e)},addToResizeEvent:function(e){this.ResizeEventArray.push(e)},addToPanelEvent:function(e,t){var i=void 0!==t?{div:e,customCB:t}:e;this.PanelEventArray.push(i)}})}),define("DS/3DPlayUtils/VisibilityUtils",["DS/WebSystem/Settings","DS/CoreEvents/Events"],function(e,t){"use strict";return{applyVisibilityToAll:function(e,t,i){if(t)for(var n=0;n<t.length;n++)this.applyVisibilityToPath(e,t[n],i)},reallyApplyVisibilityToAll:function(e,t,i){if(t){Array.isArray(t)||(t=[t]);for(var n=0;n<t.length;n++){var r=t[n].getChildrenPathes();0!=r.length?this.reallyApplyVisibilityToAll(e,r,i):this.applyVisibilityToPath(e,t[0],i)}}},applyVisibilityToPath:function(e,t,i,n){null==n&&(n=!0),e.setVisibility(t,i,n)},getTransparencyPercentage:function(){var t=Math.round(e.get("VisibilitySettings.TransparencySetting",11));return(t<0||t>100)&&(t=11),t},setTransparencyPercentage:function(t){t>=0&&t<=100?e.set("VisibilitySettings.TransparencySetting",t):console.error("Error: Visibility Utilities - Transparency settings value out of range")},updateTransparencyofObjects:function(e,t,i){if(1==i)this.removeTransparencyFromObjects(e,t);else{var n=function(t){t.length>0&&t.forEach(function(t){var r=e.getOpacity(t);if(null!=r&&r<1)e.setOpacity(t,i);else{var o=t.getChildrenOccurrencePathes();null!=o&&null!=o&&n(o)}})};n(t)}},removeTransparencyFromObjects:function(e,t){for(var i=0;i<t.length;i++){var n=t[i];e.setOpacity(n,1,!0),e.setPickability(n,"PICKABLE",!0)}},applyTransparencyToObjects:function(e,t,i,n,r){if(1==i)this.removeTransparencyFromObjects(e,t);else{null==r&&(r=!0);for(var o=0;o<t.length;o++)e.setOpacity(t[o],i,r),1!=n&&e.setPickability(t[o],"IGNORED",r)}},getCurrentSceneGraphState:function(e,t,i){return e.sgState||(e.sgState=this.createNewSceneGraphStateHelper(e,t,"VisibilitySG")),e.sgState},createNewSceneGraphStateHelper:function(e,t,i){return e.createSceneGraph(i)},resetCurrentSceneGraphState:function(e){e.sgState=null},setCurrentSceneGraphState:function(e,t){e.sgState=t,e.setCurrentSceneGraphState(e.sgState)},setVisibilityOfAnnotations:function(e,t,i){(i||e.getRootNode()).children.forEach(function(e){"annotGroupNode"==e.name&&e.setVisibility(t)})},setVisibilityOfSectionsAndMeasures:function(e,i,n){n||e.getRootNode();i?t.publish({event:"3DPLAY/EXPLODE/END"}):t.publish({event:"3DPLAY/EXPLODE/START"})}}}),define("DS/3DPlayExperienceModule/SceneGraphNodeServices",["DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e){"use strict";return{is3DXMLNode:function(e){return e?e.productType||void 0!==e.persistentId:null},getName:function(e){return e?this.is3DXMLNode(e)?e.getName():e.title||e.name:null},getId:function(t){if(!t)return null;var i=e.getNodeID(t);return i||(i=t.getId?t.getId():i),i||(i=t.persistentId),i},getType:function(t){if(!t)return null;var i=e.getNodeType(t);return i||(i=t.getType?t.getType():void 0),i||(i=t.productType||t.worktype||t.plmtype),i},isReference:function(t){return t?t.productType?"Reference3D"===t.productType:t.worktype?"Reference3D"===t.worktype:t.plmtype?"Reference3D"===t.plmtype:e.isReference(t):null},isInstance:function(t){return t?t.productType?"Instance3D"===t.productType:t.worktype?"Instance3D"===t.worktype:t.plmtype?"Instance3D"===t.plmtype:e.isInstance(t):null},isRepReference:function(t){return t?t.productType?"ReferenceRep"===t.productType:t.worktype?"ReferenceRep"===t.worktype:t.plmtype?"ReferenceRep"===t.plmtype:e.isRepReference(t):null},isRepInstance:function(t){return t?t.productType?"InstanceRep"===t.productType:t.worktype?"InstanceRep"===t.worktype:t.plmtype?"InstanceRep"===t.plmtype:e.isRepInstance(t):null},is3DLeaf:function(t){return t?this.is3DXMLNode(t)?this.isRepReference(t):e.is3DLeaf(t):null},isPLMNode:function(t){if(!t)return null;if(this.is3DXMLNode(t)){var i=this.getType(t);return null!=i&&""!==i}return e.isPLMNode(t)}}}),define("DS/3DPlayUtils/PublishToSwym",["DS/3DPlay/3DPlay","UWA/Class","DS/WebSystem/Environment","DS/WebSystem/Nls","i18n!DS/3DPlay/assets/nls/3DPlay"],function(e,t,i,n,r){"use strict";return t.extend({init:function(t){var n,o;require(["DS/UIKIT/Modal","DS/SwymPublishForm/script/publish-form-view","css!DS/3DPlayUtils/PublishToSwym"],function(s,a){var l=e.getExperience(t.ctx);l&&l.getScreenShot({onSuccess:function(e){if(i.isSet("ODT_3DPlay_PanelManager"))require(["DS/CoreEvents/Events"],function(e){e.publish({event:i.get("ODT_3DPlay_PanelManager")})});else{var t=l.args.input.tenantID||l.args.input.asset.tenant;if(t)n=t;else try{for(var d=window;!d.ds&&d.parent&&d!==d.parent;)d=d.parent;(n=d.ds.swymTenant)&&(o=!0)}catch(e){}p={title:"title",description:"description",mode:"base64",base64image:e,onCancel:h=function(){u&&u.destroy(),c&&c.destroy()},onContentCreated:h},n&&(p.platformId=n),o&&(p.forcePlatform=!0),u=new a(p),(c=new s({closable:!0,header:r.ShareSwymTitle,body:u.render("publish_to_sywm_wrapper_id"),className:"publishSwymPanel_3DPlay"})).inject(document.body),c.show()}var c,u,h,p},onFail:function(){e.sendEvent(t.ctx,eventType.notif,notification.error,{msg:r.UnableToCreateScreenshot})}})},function(i){if("scripterror"===i.requireType){var n=i.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",n)}else console.error(i);e.sendEvent(t.ctx,eventType.notif,notification.error,{msg:r.ScripNotFoundError})})}})}),define("DS/3DPlayExperienceModule/Tracker_Translation_Experience",[],function(){"use strict";return{experience:{Connector_Require:2,Connector_Finished:3,Experience_Require:4,Viewer_init:5,ActionBar_Ready:6,Experience_Ready:7,WaitAllCommands:8,CSV_Tenant_Init:10},asset:{Connector_Require:2,Connector_Finished:3,Wait_MaterialsCommands:4,XCAD_DownloadExternalDrive:5,XCAD_Authentication:6,XCAD_Preprocess:7,XCAD_Transfer:8,XCAD_Convert:9,Download:10,Load_Infra:11,Load_Session:12,nbMeshOccurrences:13,nbMeshes:14,nbNodeOccurrences:15,nbNodes:16,nbLines:17,nbPoints:18,nbTriangles:19,width:17,height:18,nbPages:19,DownloadSize:20}}}),define("DS/3DPlayUtils/EventDisposer",["DS/WebUtils/EventDisposer"],function(e){"use strict";return console.error("DS/3DPlayUtils/EventDisposer has been moved to DS/WebUtils/EventDisposer of FW WebInfra"),console.error("DS/3DPlayUtils/EventDisposer has been moved to DS/WebUtils/EventDisposer of FW WebInfra"),e}),define("DS/3DPlayUtils/LeftPanel",["UWA/Core","UWA/Class","DS/Panels/SidePanel","css!DS/3DPlayUtils/LeftPanel"],function(e,t,i,n){return t.extend({init:function(t){this.leftPanel=new i({side:"left"}).inject(t.container);for(var n=new e.Element("div",{id:"MAIN_CONTAINER",styles:{height:this.leftPanel.elements.panel.clientHeight+"px","overflow-y":"scroll"}}).inject(this.leftPanel),r=new e.Element("div",{id:"SHEET_LIST_CONTAINER"}).inject(n),o=[],s=function(e){for(var t=0;t<o.length;t++){var i=o[t];i.className.indexOf("selected")>0&&i.removeClassName("selected")}(e.target?e.target:e.srcElement).addClassName("selected")},a=0;a<t.items.length;a++){var l=t.items[a],d="Sheet_"+(a+1),c=new e.Element("div",{id:d,class:"leftpanel-item",events:{click:l.onClickCB}}).inject(r);c.addEvent("click",s),c.appendText(d),o.push(c)}},dispose:function(){}})}),define("DS/3DPlayUtils/SpreadGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var n=i.extend({init:function(){return this._parent("Spread"),this.touches=[],this.fingersVector0_1=new e.Vector2,this.fingersVector1_2=new e.Vector2,this.fingersVector2_0=new e.Vector2,this.latencyTime=30,this.initTime=0,this.distance=null,this.lastDistance=0,this.initDistance=0,this.distanceMin=0,this},detect:function(e){switch(this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE],this.view),3===this.touches.length&&(this.fingersVector0_1.subVectors(this.touches[1].currentPosition,this.touches[0].currentPosition),this.fingersVector1_2.subVectors(this.touches[2].currentPosition,this.touches[1].currentPosition),this.fingersVector2_0.subVectors(this.touches[0].currentPosition,this.touches[2].currentPosition),null===this.distance&&(this.distance=this.fingersVector0_1.length()+this.fingersVector1_2.length()+this.fingersVector2_0.length()),this.lastDistance=this.distance,this.distance=this.fingersVector0_1.length()+this.fingersVector1_2.length()+this.fingersVector2_0.length()),this.state){case i.State.INIT:this.distance=null,3===this.touches.length&&(this.preventDefault(this.touches),this.initTime=(new Date).getTime(),this.initDistance=this.distance,this.changeState(i.State.BEGIN));break;case i.State.BEGIN:case i.State.CHANGE:3===this.touches.length?(this.events=this.touches,this.preventDefault(this.events),this.changeState(i.State.CHANGE)):this.changeState(i.State.KO);break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT),this.touches=[],this.distance=null}},preventDefault:function(e){for(var t=0;t<e.length;t++){var i=e[t].getJSEvent();i.preventDefault&&i.preventDefault()}}});return UWA.namespace("3DPlayModelViewer/SpreadGesture",n)}),define("DS/3DPlayUtils/BrowserSupportList",[],function(){"use strict";return{winphone:{8.1:{ie:{isSupported:function(e){return BrowserSupport.ok}}}},win:{default:{version:{isSupported:function(e){try{var t=parseFloat(e);return 7===t||8===t||t>=10}catch(e){return!1}}},chrome:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}},firefox:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}},opera:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}},ie:{isSupported:function(e){return BrowserSupport.ok}}}},android:{default:{version:{isSupported:function(e){return parseFloat(e)>=5}},chrome:{isSupported:function(e){return BrowserSupport.ok}},firefox:{isSupported:function(e){return BrowserSupport.ok}}},4:{chrome:{isSupported:function(e){return e<25?BrowserSupport.partial:BrowserSupport.ok}},firefox:{isSupported:function(e){return e<25?BrowserSupport.partial:BrowserSupport.ok}}}},macosx:{default:{version:{isSupported:function(e){try{return parseFloat(e)>=10.1}catch(e){return!1}}},safari:{isSupported:function(e){return BrowserSupport.ok}},chrome:{isSupported:function(e){return BrowserSupport.ok}},firefox:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}}},10.9:{safari:{isSupported:function(e){return e<600?BrowserSupport.partial:BrowserSupport.ok}}}},ios:{default:{version:{isSupported:function(e){return e<8?BrowserSupport.partial:BrowserSupport.ok}},safari:{isSupported:function(e){return e<600?BrowserSupport.partial:BrowserSupport.ok}},netscape:{isSupported:function(e){return BrowserSupport.ok}}}}}}),define("DS/WebRunloop/Runloop",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e){this.name=e.name||"Runloop",this.running=!1,this.data=e.data,this.setRunloopCB(e.func),this.onStart=e.onStart,this.onStop=e.onStop,this.onError=e.onError,e.autoStart&&this.start()},setRunloopCB:function(e){if(e){this.func=e;var t=this,i=(new Date).getTime();this.data?this.runloop=function(){t.running&&(t.id=requestAnimationFrame(t.runloop));var e=(new Date).getTime();t.func.apply(t.data,[{time:e-t.starttime,deltaTime:e-i}]),i=e}:this.runloop=function(){t.running&&(t.id=requestAnimationFrame(t.runloop));var e=(new Date).getTime();t.func({time:e-t.starttime,deltaTime:e-i}),i=e}}},start:function(){this.runloop?(this.running=!0,this.id=requestAnimationFrame(this.runloop),this.starttime=(new Date).getTime(),this.onStart&&this.onStart()):(console.error("runloop have not loop function"),this.onError&&this.onError())},stop:function(){this.running=!1,cancelAnimationFrame(this.id),this.onStop&&this.onStop()},dispose:function(){!0===this.running&&this.stop(),this.func=null,this.data=null,this.runloop=null}})}),define("DS/3DPlayUtils/ServiceURL",["UWA/Core","DS/WebUtils/WebServices"],function(e,t){"use strict";return console.error("DS/3DPlayUtils/ServiceURL has been moved to (DS/WebUtils/WebServices).getServiceURL"),t.getServiceUrl}),define("DS/WebViewer2D/ViewerError",["UWA/Core","DS/WebViewer2D/ViewerDoc"],function(e,t){"use strict";return t.extend({init:function(t){this.viewer=t.viewer,this.status={failed:!0,loaded:!1};var i=(t.asset.filename||t.asset).split("/"),n=i[i.length-1];this.container=new e.Element("div",{data:t.data,class:"viewer"}).inject(this.viewer),this.getErrorID=function(){return" error LoadFailed"},this.getTitle=function(){return n}}})});var t=["DS/TagNavigatorProxy/TagNavigatorProxy"];define("DS/3DPlayUtils/PanelManager",["DS/3DPlay/3DPlay","UWA/Core","UWA/Class","UWA/Controls/TabView","DS/TopBarProxy/TopBarProxy","DS/WebSystem/Environment","DS/3DPlayUtils/UIManager","DS/UIKIT/Spinner","DS/WebSystem/DataUrlTools","DS/WebSystem/DetectBrowser","DS/3DPlayUtils/PublishToSwym","DS/WebSystem/Nls","DS/3DPlayUtils/FullScreen","DS/WebUtils/ContextedSingleton","DS/WebSystem/Settings","DS/Utilities/Css","DS/WebSystem/App","DS/WebUtils/Tracker","i18n!DS/3DPlay/assets/nls/3DPlay","DS/WebSystem/SessionManager"].concat(t),function(e,t,i,n,r,o,s,a,l,d,c,u,h,p,g,f,m,v,S,D,w){"use strict";return i.extend({init:function(e){this.showVersion=!0,this.UIManager=new s(e);var t=new Date;this.lastClickTime=t.getTime(),this.panelContent={},this.panelContent.wait=this._generateWaitingUI(),this.experience=e.frameWindow.experience},setTopBarId:function(e){if(void 0===this.generated){if(this.generated=!0,e.topBarId&&(e.topBar={id:e.topBarId},console.error("API Migration : please don t use options.topBarId"),console.error("API Migration : use instead options.topBar.id")),!o.isSet("3DPlay.DisableTagger")&&m.is3DPlay()){var i=window.widget&&window.widget.id;i&&(this.tagger={proxyOptions:{filteringMode:"FilteringOnServer",events:{addFilterChangeListener:function(){this&&this.experience&&this.experience.getInformationsOnAsset()&&v.trackPageEvent("interactions","6wTags",this.experience.getInformationsOnAsset().type),this.tagger.tagger.setTags({"3DPlayAsset":this.currentTag||[]})}.bind(this)},widgetId:i},TagNavigatorProxy:w,experience:this.experience,dispose:function(){this.tagger&&this.tagger.die(),this.tagger=null,this.token&&this.experience.unsubscribe(this.token),this.token=null},activate:function(e){this.tagger&&(void 0===e||!0===e?this.tagger.activate():this.tagger.deactivate())},proxyTag:function(){this.tagger||(this.tagger=this.TagNavigatorProxy.createProxy(this.proxyOptions)),this.token||(this.token=this.experience.addOnLoadingStartedCB(function(e){if(this.experience.args&&this.experience.args.input){var i=this.experience.args.input.asset;if(i&&"FILE"===(this.experience.currentProvider||i.provider)){if(this.currentTag=[],i.swymAttr&&i.swymAttr.tags6w_implicit&&i.swymAttr.tags6w_implicit.length>0){var n=this.currentTag;i.swymAttr.tags6w_implicit.forEach(function(e){n.push({object:e.type,sixw:e.predicate,dispValue:e.tag})})}else i.driveAttr?(i.driveAttr.fullnameowner&&this.currentTag.push({object:i.driveAttr.fullnameowner,sixw:"ds6w:who/ds6w:responsible",dispValue:i.driveAttr.fullnameowner}),i.driveAttr.originator&&this.currentTag.push({object:i.driveAttr.originator,sixw:"ds6w:who/ds6w:responsible/ds6w:originator",dispValue:i.driveAttr.originator}),i.driveAttr.modified&&this.currentTag.push({object:t.Date.strftime(new Date(1e3*i.driveAttr.modified),"%Y/%m/%d"),sixw:"ds6w:when/ds6w:modified",type:"date"}),i.driveAttr.created&&this.currentTag.push({object:t.Date.strftime(new Date(1e3*i.driveAttr.created),"%Y/%m/%d"),sixw:"ds6w:when/ds6w:created",type:"date"}),i.driveAttr.type&&this.currentTag.push({object:i.driveAttr.type,sixw:"ds6w:what/ds6w:type",dispValue:i.driveAttr.type}),i.driveAttr.fileExtension&&this.currentTag.push({object:i.driveAttr.fileExtension,sixw:"ds6w:what/ds6w:docExtension",dispValue:fileExtension}),i.driveAttr.dataSource&&this.currentTag.push({object:i.driveAttr.dataSource,sixw:"ds6w:where/ds6w:source/ds6w:dataSource",dispValue:dataSource})):console.error("not supposed to be here");this.tagger.setTags({"3DPlayAsset":this.currentTag})}}else console.log((new Error).stack)}.bind(this),!1))}})}if(r){var n={};if(e.topBar&&e.topBar.id?n=e.topBar:window.widget&&window.widget.id&&(n.id=window.widget.id),n.id){for(var s=window;!s._swymData43DPlay&&s.parent&&s!==s.parent;)s=s.parent;if(s._swymData43DPlay)try{n.options={rightParentWindow:s.parent}}catch(e){}this.topBarProxy=new r(n),!1!==e.activeState&&"false"!==e.activeState||this.topBarProxy.deactivate()}}}},setVisibility:function(e){this.isTopBarAvailable()?this.topBarProxy&&(!1===e?this.topBarProxy.deactivate():this.topBarProxy.activate()):this.topMenuContainer&&(this.topMenuContainer.style.display=e?"":"none")},dispose:function(){this.UIManager&&(this.UIManager.dispose(),this.UIManager=null),this.panel=null,this.currentPanel=null,this.panelContainer=null,this.topMenuContainer=null,this.experience=null,this.panelClose=null,this.isTopBarAvailable()&&(this.topBarProxy.die(),this.topBarProxy=null),this.tagger&&(this.tagger.dispose(),this.tagger.experience=null,this.tagger=null)},isTopBarAvailable:function(){return void 0!==this.topBarProxy},createTopMenu:function(e){var i=e.container,n=this;if(this.experience=e.experience,this.ctx=e.ctx,this.panel=new t.Element("div",{attributes:{id:"PlayWeb-Panel",class:"SHAREPluginless_noSelect"}}),this.panelClose=new t.Element("span",{class:"CloseBtn"}).addEvent("click",function(){n.panelContainer.style.display="none"}).addEvent("touchstart",function(){n.panelContainer.style.display="none"}),new t.Element("span",{class:"fonticon fonticon-cancel"}).inject(n.panelClose),new t.Element("span",{class:"fonticon fonticon-cancel-circled"}).inject(n.panelClose),this.panel.appendChild(n.panelClose),this.panelContainer=f.verticalAlign(this.panel),this.panelContainer.id="PlayWeb-Panel-CSSV",this.panelContainer.setStyles({position:"absolute","text-align":"center","pointer-events":"none",display:"none","z-index":"10",top:"0px"}),this.panelContainer.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.panelContainer.inject(i),this.isTopBarAvailable()){var r,s=[],a=!1,l=!1;require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(e){e.getPlatformServices({onComplete:function(e){for(var t=0;t<e.length&&(e[t]["3DSwym"]&&""!==e[t]["3DSwym"]&&(l=!0),!0!==l);t++);a=!0},onFailure:function(){console.error(S.PlatformNotFound),a=!0}})},function(e){if("scripterror"===e.requireType){var t=e.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",t)}else console.error(e);console.error(S.ScripNotFoundError),a=!0});var d=0,c=setInterval(function(){11!==++d&&!0!==a||(clearInterval(c),c=void 0,a=!1,(!0===l||o.isSet("ODT_3DPlay_PanelManager"))&&(l=!1,s.push({label:S.Publish_Swym,onExecute:function(){n._publishToSwYm()}})),s.push({label:S.Publish_Print,onExecute:function(){setTimeout(function(){n._printScreenshot()},100)}}),e.skipSave||s.push({label:S.Publish_Save,onExecute:function(){setTimeout(function(){n._saveScreenshot()},100)}}),r={share:[{label:S.Publish_ShareAs,submenu:s}]},e.allowUploadServices&&r.share.push(e.allowUploadServices),o.isSet("3DPlay.Statistics")&&r.share.push({label:"Dump PCS",submenu:[{label:"All times",onExecute:function(){require("DS/WebUtils/ProbesManager").dump("Full")}},{label:"3DPlay Times",onExecute:function(){require("DS/WebUtils/ProbesManager").dump("3DPlay",!0)}}]}),n.topBarProxy&&n.topBarProxy.setContent(r))},100)}else if(!0===e.showBubbleMenu||o.isSet("3DPlay.ShowBubbleMenu")){this.topMenuContainer=new t.Element("div",{id:"PlayWeb-TopMenu",class:"SHAREPluginless_noSelect"}).inject(e.container);var u=new t.Element("span",{id:"PlayWeb-Save-Annotations",class:"PlayWeb-button",events:{click:function(){if(g.get("3DPlay.PersistedAnnotationsEnabled")){var e=p.get(n.ctx,"ANNOTATION_MANAGER");if(e){var t=e.saveAnnotationsToJSON();g.set("3DPlay.AnnotJson",t),alert("Annotations saved !!!")}}}}}).inject(this.topMenuContainer),m=new t.Element("span",{id:"PlayWeb-Create-Saved-Annotations",class:"PlayWeb-button"}).inject(this.topMenuContainer),v=g.get("3DPlay.AnnotJson");v?m.addEvent("click",function(){if(g.get("3DPlay.PersistedAnnotationsEnabled")){var e=[];g.get("3DPlay.UseExplodeCompatibleAnnotationManager")?e.push("DS/3DPlayAnnotation3D/AnnotationExplodeManager"):e.push("DS/3DPlayAnnotation3D/AnnotationManager"),require(e,function(e){var t=p.get(n.ctx,"ANNOTATION_MANAGER");t||(t=new e({frameWindow:n.experience.frmWindow,context:n.ctx}),p.add(n.ctx,"ANNOTATION_MANAGER",t)),t.drawAnnotationsFromJSON(v)})}}):m.style.display="none",this.panelContent.publish=this._generatePublishUI();var D=new t.Element("span",{id:"PlayWeb-Publish",class:"PlayWeb-button"}).inject(this.topMenuContainer);D.addEvent("click",function(){n._togglePanel(n.panelContent.publish)}),D.addEvent("touchend",function(){n._togglePanel(n.panelContent.publish)}),this.helpBtn=new t.Element("span",{id:"PlayWeb-Help",class:"PlayWeb-button"}).inject(this.topMenuContainer),D.setAttribute("title",S.Publish_Title),n.helpBtn.setAttribute("title",S.Help_Title),u.setAttribute("title",S.SaveAnnotation_Title),m.setAttribute("title",S.CreateSavedAnnotation_Title),this.openHelpPanel=function(e){void 0!==e&&n.Tab.selectTab(e),n._togglePanel(n.panelContent.help)},this.UIManager&&this.UIManager.addToPanelEvent(this.topMenuContainer,function(e){this.topMenuContainer&&(e.visible?this.topMenuContainer.style.right="35px":this.topMenuContainer.style.right="0px")})}var w=this.experience&&this.experience.args?this.experience.args:{};if(w.commandFullscreen||w.options.fullscreen){var P=new t.Element("span",{id:"PlayWeb-Fullscreen",class:"PlayWeb-button"}),y=new h(w.container,w.options.fullscreen,P,w.widget||window.widget);"none"!==y.getMode()&&(this.topMenuContainer||(this.topMenuContainer=new t.Element("div",{id:"PlayWeb-TopMenu",class:"SHAREPluginless_noSelect"}).inject(e.container),this.UIManager&&this.UIManager.addToPanelEvent(this.topMenuContainer,function(e){this.topMenuContainer&&(e.visible?this.topMenuContainer.style.right="35px":this.topMenuContainer.style.right="0px")})),P.inject(this.topMenuContainer),P.addEvent("click",function(){y.toggle(P)}),w.options&&w.options.fullscreen&&w.options.fullscreen.activateOnStart&&P.click())}},_togglePanel:function(e){e!==this.currentPanel?(this.currentPanel&&this.panel.removeChild(this.currentPanel),this.panel.appendChild(e),this.currentPanel=e,this.panelContainer.style.display="table",this.currentPanel===this.panelContent.wait?this.panelClose.style.display="none":this.panelClose.style.display=""):"none"===this.panelContainer.style.display?this.panelContainer.style.display="table":this.panelContainer.style.display="none"},_generatePublishUI:function(){var e=new t.Element("ul",{class:"PlayWeb-Menu"}),i=this,n=function(){setTimeout(function(){i._printScreenshot()},100)};new t.Element("li",{id:"Print_Menu_Item",html:S.Publish_Print,class:"PlayWeb-MenuItem"}).inject(e).addEvent("click",n).addEvent("touchstart",n);var r=function(){setTimeout(function(){i._saveScreenshot()},100)};return new t.Element("li",{id:"Save_Menu_Item",html:S.Publish_Save,class:"PlayWeb-MenuItem"}).inject(e).addEvent("click",r).addEvent("touchstart",r),e},_generateWaitingUI:function(){var e=new t.Element("ul",{class:"PlayWeb-Menu"});return new a({className:"large",visible:"true"}).inject(e),e.appendChild(document.createElement("br")),new t.Element("span",{html:S.GeneratingScreenshot}).inject(e),e},createDefaultHelp:function(){var e=[];if(!0===this.experience.args.touch){e.push({id:"Menu_Touch",event:"touchend",array:[["icTouchPan","HelpTouchPan"],["icTouchZoom","HelpTouchZoom"],["icTouchRotate","HelpTouchRotate"],["icTouchReframe","HelpTouchReframe"]]})}e.push({id:"Menu_Mouse",event:"click",array:[["icMouseLeft","HelpRotateBtn"],["icMouseMiddle","HelpZoomBtn"],["icMouseRight","HelpZoomAltBtn"],["icMouseMiddle","HelpDragBtn"]]}),this.setHelpContent(e)},setHelpContent:function(e){this.panelContent.help=this._generateHelphUI(e)},_generateHelphUI:function(e){var i=this,r=[],o=[],s=[];this.maxHeight=0;for(var a=e,l=0;l<a.length;l++)s[l]=a[l].id;this.showVersion&&s.push("Menu_About");for(var d=new t.Element("div"),c=function(e){return function(){var t=new Date;i.currentClickTime=t.getTime(),i.currentClickTime-i.lastClickTime>500&&(i.openHelpPanel(e),i.lastClickTime=i.currentClickTime)}},u=!1,h=!1,p=0;p<s.length;p++)if(p<a.length){var g=a[p].event;if(void 0!==g){"click"===g?u=!0:"touchend"===g&&(h=!0);var f=s[p];i.helpBtn&&i.helpBtn.addEvent(g,c(f))}r.push(new n.Tab({id:s[p],text:S[s[p]]})),o.push(document.createElement("table")),i._fillPanel(d,o[p],a[p].array)}else"Menu_About"===s[p]&&(i.helpBtn&&(!1===u?i.helpBtn.addEvent("click",c("Menu_About")):!1===h&&i.helpBtn.addEvent("touchend",c("Menu_About"))),r.push(new n.Tab({id:s[p],text:S[s[p]]})),o.push(document.createElement("table")),i._fillVersionPanel(o[p]));i.Tab=new n({className:"help",tabs:r,events:{onSelectTab:function(){}}}).inject(d);for(var m=0;m<r.length;m++)r[m].setContent(o[m]);return d},_fillPanel:function(e,t,i){this.maxHeight<i.length&&(this.maxHeight=i.length),e.setStyles({height:66*this.maxHeight+60+"px"});for(var n=[],r=0;r<i.length;r++)n[r]=i[r][1];for(var o=0;o<i.length;o++){var s=document.createElement("tr"),a=document.createElement("td");a.setAttribute("class","ic "+i[o][0]);var l=document.createElement("td");l.appendChild(document.createTextNode(S[n[o]])),l.setAttribute("class","desc"),s.appendChild(a),s.appendChild(l),t.appendChild(s)}},_fillVersionPanel:function(e){var i=document.createElement("tr"),n=document.createElement("td");n.setAttribute("class","logoDS");var r=document.createElement("td");r.appendChild(document.createTextNode(S.Menu_AppName)),r.appendChild(document.createElement("br")),r.appendChild(document.createElement("br"));var o=new t.Element("div",{styles:{"pointer-events":"all"}}).inject(r);new t.Element("a",{html:S.Menu_Documentation,href:"http://www.3ds.com/support/3dplay-app/",target:"_blank",styles:{"pointer-events":"all",color:"#456077"}}).inject(o),r.setAttribute("style","font-size: initial;vertical-align: middle;"),i.appendChild(n),i.appendChild(r),e.appendChild(i),this.maxHeight>0&&(e.style.minHeight=66*this.maxHeight+"px")},_publishToSwYm:function(){this._pictureFlash();var e={ctx:this.ctx};setTimeout(function(){new c(e)},1e3)},_printScreenshotAfterFlash:function(){var e=this,i=new t.Element("iframe",{styles:{position:"fixed",top:"0",left:"100%",width:"100%",height:"100%"}}).inject(document.body);d&&"firefox"===d().browser.name?i.onload=function(){e._printScreenshotAfterFrameLoaded(i)}:e._printScreenshotAfterFrameLoaded(i)},_printScreenshotAfterFrameLoaded:function(i){var n,r=this;if(d&&"ie"===d().browser.name&&void 0!==r.experience.frmWindow._3dViewer&&null!==r.experience.frmWindow._3dViewer&&void 0!==r.experience.frmWindow._3dViewer.getCurrentSheet&&null!==r.experience.frmWindow.getCurrentSheet&&(n=r.experience.frmWindow._3dViewer.getCurrentSheet()),n&&void 0!==n.svg&&null!==n.svg){if(void 0!==n.getSVGCloneNode&&null!==n.getSVGCloneNode){var s=n.getSVGCloneNode();i.contentWindow.document.body.appendChild(s);try{!1===i.contentWindow.document.execCommand("print",!1,null)&&i.contentWindow.print()}catch(e){i.contentWindow.print()}s=null,setTimeout(function(){document.body.removeChild(i),i=null},6e4)}}else r.experience.getScreenShot({onSuccess:function(e){var n,r=new t.Element("img",{src:e,styles:{"max-width":"100%","max-height":"100%"}}).inject(i.contentWindow.document.body);n=setInterval(function(){if(r.offsetHeight||r.height){if(clearInterval(n),o.isSet("ODT_3DPlay_PanelManager"))require(["DS/CoreEvents/Events"],function(e){e.publish({event:o.get("ODT_3DPlay_PanelManager")})});else try{!1===i.contentWindow.document.execCommand("print",!1,null)&&i.contentWindow.print()}catch(e){i.contentWindow.print()}setTimeout(function(){document.body.removeChild(i),i=null},6e4)}},100)},onFail:function(){e.sendEvent(r.ctx,eventType.notif,notification.error,{msg:S.UnableToCreateScreenshot})}});n=null},_printScreenshot:function(){var e=this;this._pictureFlash(function(){e._printScreenshotAfterFlash(),e=void 0})},_saveScreenshotAfterFlash:function(){var i=this;this.experience.getScreenShot({onSuccess:function(e){if(void 0!==window.Windows&&void 0!==window.Windows.Security&&void 0!==window.Windows.Storage){var i=e.replace("data:image/png;base64,",""),n=Windows.Security.Cryptography.CryptographicBuffer.decodeFromBase64String(i),r=new Windows.Storage.Pickers.FileSavePicker;r.suggestedStartLocation=Windows.Storage.Pickers.PickerLocationId.documentsLibrary,r.fileTypeChoices.insert("Picture",[".png"]),r.suggestedFileName="myScreenshot",r.pickSaveFileAsync().then(function(e){if(e)return Windows.Storage.FileIO.writeBufferAsync(e,n)})}else if("download"in document.createElement("a")){var s,a;g.get("3DPlay.PersistedAnnotationsEnabled")?(s=e,a="3DPlay_Screenshot.svg"):(s=l.toBlob(e),a="3DPlay_Screenshot.png");var d=new t.Element("a",{href:s,download:a,styles:{visibility:"hidden"}}).inject(document.body);o.isSet("ODT_3DPlay_PanelManager")?require(["DS/CoreEvents/Events"],function(e){e.publish({event:o.get("ODT_3DPlay_PanelManager")})}):d.click(),document.body.removeChild(d)}else{window.open("about:blank","3DPlay web","width=1024,height=860").document.body.innerHTML='<img style="max-width:100%;max-height:100%" src="'+e+'" />'}},onFail:function(){e.sendEvent(i.ctx,eventType.notif,notification.error,{msg:S.UnableToCreateScreenshot})}})},_saveScreenshot:function(){var e=this;this._pictureFlash(function(){e._saveScreenshotAfterFlash(),e=void 0})},_pictureFlash:function(e){this.panelContainer.style.display="none";var i=this.experience.frmWindow.getViewerFrame(),n=this.experience.frmWindow.getUIFrame(),r=new t.Element("div",{id:"_3DPlay-Flash",styles:{position:"absolute",top:0,left:0,width:i.clientWidth+"px",height:i.clientHeight+"px","background-color":"white"}}).inject(n),o=1,s=function(){o-=.02,r.setStyle("opacity",o),o<0?(n.removeChild(r),"function"==typeof e&&e()):requestAnimationFrame(s)};s()},_shareTo3DComment:function(){var e=this.experience;this._pictureFlash(function(){var t=p.get(e.ctx,"ANNOTATION_MANAGER");if(e&&t){var i=e.frmWindow.getViewer(),n=i&&i.getCurrentState?i.getCurrentState():void 0,r=n?t.saveAnnotationsToJSON(n):JSON.stringify(D.getSession()),o=new Blob([r],{type:"application/json"});e.getScreenShot({width:240,height:180,type:"jpeg",onSuccess:function(t){var i={screenshot:t,annotation:o};e.onAnnotationShared?(console.log("Social: onAnnotationShared found"),e.onAnnotationShared(i)):(console.log("3DPlay: Launching 3DPlay's social panel"),e.publish("3DPLAY/EXP/3DPLAY3DCOMMENT",{data:i})),e=null}})}})},_downloadSourceDocument:function(){!!(this.experience&&this.experience.args&&this.experience.args.input&&this.experience.args.input.asset&&"FILE"===this.experience.args.input.asset.provider&&"pdf"===this.experience.args.input.asset.type)&&window.open(this.experience.args.input.asset.filename,"_blank")}})}),define("DS/3DPlayUtils/XCADSpatialSupport",["DS/3DPlaySupport/XCADSpatialSupportedFormats","UWA/Core","DS/3DPlayUtils/ConvertService","DS/WebSystem/Environment","DS/WebInfraUI/Notification","DS/WebUtils/Logger","DS/WebUtils/WebServices","DS/WebUtils/Network","DS/WebUtils/ProbesManager","DS/WebSystem/Nls","DS/WebSystem/App","DS/WAFData/WAFData","i18n!DS/3DPlay/assets/nls/3DPlay"],function(e,t,i,n,r,o,s,a,l,d,c,u,h){"use strict";var p,g,f,m={},v={};return i.extend({officeTypes:["DOC","DOCX","DOCM","DOT","DOTM","DOTX","RTF","PPT","PPTX","POT","POTM","POTX","PPS","PPSM","PPSX","PPTM","XLS","XLSX","XLSM","XLSB","XLT","XLTM","XLTX","CSV","MSG"],init:function(i){this._parent(),this.logger=o("3DPlay.XCADSpatialSupport","3DPlay.Log.Convert"),this._exp=i,this.connector3DSpace=null,this._counter=0,this.supportedFormats=e,i.extendedXCADSupport&&t.extend(this.supportedFormats,i.extendedXCADSupport,!0),this._convert=function(e){this._computeInfos(e),c.isOnCloud()?this._isOffice(e)?this._isSource3DDrive(e)||this._isSource3DSpace(e)?this._convertDFA(e):this._displayFatal(e):this._isSource3DDrive(e)?"EXTERNAL"!==e.computedInfos.provider.toUpperCase()&&(e.asset.user&&"guest"==e.asset.user?this._convertCO(e):this._convertDFA(e)):this._isSource3DSpace(e)&&this._isAssembly(e)?this._displayFatal(e):this._convertCO(e):this._displayFatal(e)},this._computeInfos=function(e){e.computedInfos=e.asset,e.asset&&e.asset.originalAsset?e.computedInfos=e.asset.originalAsset:this._isSource3DDrive(e)&&(e.computedInfos={type:e.asset.format,provider:e.asset._3DPlayDatas&&!0===e.asset._3DPlayDatas.externalDrive?"EXTERNAL":"3DDRIVE",physicalid:e.asset.physicalid}),("ODT_Tenant"===e.asset.tenant||e.asset.filename&&e.asset.filename.includes("3DPlayExperiencesTest"))&&(window.isCloud=!0,e.computedInfos.provider||(e.asset._3DPlayDatas&&e.asset._3DPlayDatas.externalDrive&&"prt"==e.asset.type&&(this.connector3DSpace={open:function(e,t){t({url:"test_url"})}}),e.computedInfos.provider="EV6"))},this._isAssembly=function(e){return"asm"===e.asset.dataFormat},this._isSource3DDrive=function(e){return c.is3DDrive()||e&&e.computedInfos&&e.computedInfos.provider&&"3DDRIVE"===e.computedInfos.provider.toUpperCase()},this._isSource3DSpace=function(e){return"EV6"===e.computedInfos.provider.toUpperCase()||"3DSPACE"===e.computedInfos.provider.toUpperCase()},this._isOffice=function(e){return this.officeTypes.indexOf(e.asset.type.toUpperCase())>=0},this._displayFatal=function(e){this.logger.error("Conversion error"),this.logger.error(arguments),e.onConvertError({nls:"Convert_ERROR",level:r.fatal},e.asset)},this._convertDFA=function(e){var t=this,i=e.asset;s.getServiceUrl({serviceName:"derivedformataccess",logger:t.logger,platformId:i.tenant,onSuccess:function(n){v[i.tenant]||(v[i.tenant]=n.url),n.platformId!==i.tenant&&t.logger.warn("DerivedFileAccess desired Tenant:",i.tenant,"got ",n.platformId),t.logger.log("DerivedFileAccess : URL found > ",v[i.tenant]),t.profilerLocateOpen=l.createProbe("XCAD_Preprocess"),t.profilerLocateOpen.begin(),t._startLocate(e,!0),t=null},onError:function(i){t.logger.error("Ooops, missing Service : ",i.serviceName,"Reason : ",i.error),t._convertCO(e),t=null}})},this._convertCO=function(e){if(c.isOnCloud()&&this._isOffice(e))return this.logger.error("Conversion error"),this.logger.error(arguments),void e.onConvertError({nls:"LoadingError_FORMAT",level:"fatal"},t);if(p){var t=e.asset;if(!m[t.tenant]){if(!n.isSet("3DPlay.ProtoConvertSpatial")||"true"===n.get("3DPlay.ProtoConvertSpatial")){var i=this;return void s.getServiceUrl({serviceName:"SPAContentOptimizer",logger:i.logger,platformId:t.tenant,onSuccess:function(n){m[t.tenant]||(m[t.tenant]=d(n.url)),n.platformId!==t.tenant&&i.logger.warn("XCADSpatialSupport desired Tenant:",t.tenant,"got ",n.platformId),i.logger.log("XCADSpatialSupport : URL found > ",m[t.tenant]),i._startConvert(e),i=null},onError:function(n){i.logger.error("Ooops, missing Service : ",n.serviceName,"Reason : ",n.error);var o={nls:"Convert_SERVICE_NOT_FOUND",level:r.warning,abort:!0};e.onConvertError(o,t),i=null}})}m[t.tenant]=n.get("3DPlay.ProtoConvertSpatial"),this.logger.log("XCADSpatialSupport (using envar value) : URL found > ",m[t.tenant])}this._startConvert(e)}else{var o=this;require(["DS/CSICommandBinder/CSICommandBinder","DS/SPAContentOptimizer/COptConvertOption","DS/SPAContentOptimizer/coptConvertV1"],function(t,i,n){p=t,g=i,f=n,o._convert(e),o=null})}};var d=function(e){var i=t.Utils.parseUrl(e);return i.authority+i.directoryPath};this._startLocate=function(e,i){var r=this,o=e.asset;this.located=!1,this.logger.log("XCADSpatialSupport._startLocate");var s=e.computedInfos.contextid?e.computedInfos.contextid:e.computedInfos.contextId?e.computedInfos.contextId:"preferred";n.get("PreferredCredentials")&&(s=n.get("PreferredCredentials"));var a="/api/v2/modeler/dsdo/DerivedOutputs/locate?withSyncStatus=yes";"EV6"!==e.computedInfos.provider.toUpperCase()&&"3DSPACE"!==e.computedInfos.provider.toUpperCase()||(a+="&SecurityContext="+encodeURIComponent(s)),"asm"===o.dataFormat&&(o.dataFormat="3dxml");var d=v[o.tenant]+a,c={specificationFilter:[{format:o.dataFormat,filterConversionParams:[{key:"streamId",value:"visualization"}]}],referencedObject:[{source:"EV6"===e.computedInfos.provider.toUpperCase()?"3DSpace":e.computedInfos.provider,id:e.computedInfos.physicalid,type:e.computedInfos.type}]};!0===i&&(c.specificationFilter[0].notifyIfMissing=!0),0==r._counter&&l.begin("XCAD_Convert"),u.authenticatedRequest(d,{method:"POST",headers:{"Content-Type":"application/json",SecurityContext:s},type:"json",data:JSON.stringify(c),onComplete:function(i){if(console.log("onComplete locate"),i.derivedOutputs&&i.derivedOutputs[0]&&i.derivedOutputs[0].derivedOutputFormats&&i.derivedOutputs[0].derivedOutputFormats[0]&&i.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult&&!0===i.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.isSync&&"OK"===i.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.status){r._counter=0;var s=v[o.tenant]+"/api/v2/modeler/dsdo/DerivedOutputs/"+i.derivedOutputs[0].id+"/DerivedOutputFiles/"+i.derivedOutputs[0].derivedOutputFormats[0].id+"/DownloadTicket";l.end("XCAD_Convert");var a=i;u.authenticatedRequest(s,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(i){console.log("onComplete download ticket");var l=i.data[0].dataelements,d=l.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(l.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true",c=t.clone(o);e.onConvertSuccess(t.extend(c,{provider:"FILE",filename:d,proxyurl:"none",requiredAuth:null,serverurl:"",originalType:o.type,mimetype:o.dataFormat||o.mimetype,format:o.dataFormat||o.mimetype,type:o.dataFormat||o.mimetype})),console.log("Loading from DFA : "+d),r.profilerLocateOpen.end(),n.isSet("3DPlay.downloadConvertResult")&&u.authenticatedRequest(s,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(e){console.log("onComplete second download ticket for debug");var t=e.data[0].dataelements,i=t.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(t.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true",n=document.createElement("a");n.download="DFA_Download_File."+o.dataFormat||o.mimetype,n.innerHTML="Download File",n.href=i,n.onclick=function(e){document.body.removeChild(e.target)},n.style.display="none",document.body.appendChild(n),n.click()}}),r._handleCR(a,o)},onFailure:function(e){console.log("onFailure download ticket"),r.profilerLocateOpen.end()}})}else if(i.derivedOutputs&&i.derivedOutputs[0]&&i.derivedOutputs[0].derivedOutputFormats&&i.derivedOutputs[0].derivedOutputFormats[0]&&i.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult&&!0===i.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.isSync&&"KO"===i.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.status)r._handleCR(i,o),!1===i._doFallback||r._isOffice(e)||r._convertCO(e);else if(!r._stop){var d=r._counter++<10?1e3:3e3;console.log(" restart locate in "+d+" ms"),setTimeout(r._startLocate.bind(r,e,!1),d)}},onFailure:function(t){console.log("onFailure locate"),r._counter=0,r._convertCO(e),r.profilerLocateOpen.end(),r.profilerLocateOpen=null}})},this._handleCR=function(e,t){var i=v[t.tenant]+"/api/v2/modeler/dsdo/DerivedOutputs/"+e.derivedOutputs[0].id+"/DerivedOutputFiles/"+e.derivedOutputs[0].derivedOutputFormats[0].id+"/ConversionReport/"+e.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.id+"/DownloadTicket";u.authenticatedRequest(i,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(e){console.log("onComplete report download ticket");var t=e.data[0].dataelements,i=t.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(t.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true";u.authenticatedRequest(i,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(e){if(console.log("onComplete report download"),1==e.reportFileVersion)e.warnings&&e.warnings.length>0&&(e.warnings[0].includes("Error : The input file is saved in Civil3D. Output might be incomplete.")?SHARE.Core.sendEvent(that._exp.args.ctx,eventType.notif,notification.warning,{msg:h.Convert_Civil3D_Warning}):e.warnings[0].includes("Alert ! Text layout could look different as some fonts are not present on the system !")&&SHARE.Core.sendEvent(that._exp.args.ctx,eventType.notif,notification.info,{msg:h.Convert_MissingFonts_Warning}));else if(2==e.reportFileVersion){for(var t=0;t<e.warnings.length;t++)"PartialResult"==e.warnings[t].category&&("IncompleteResultFromCivil3D"==e.warnings[t].id?SHARE.Core.sendEvent(that._exp.args.ctx,eventType.notif,notification.warning,{msg:h.Convert_Civil3D_Warning}):"ConversionWithMissingFonts"==e.warnings[t].id&&SHARE.Core.sendEvent(that._exp.args.ctx,eventType.notif,notification.info,{msg:h.Convert_MissingFonts_Warning}));for(t=0;t<e.errors.length;t++)"UnsupportedInput"==e.errors[t].category&&("UnsupportedFileVersion"!=e.errors[t].id&&"UnsupportedParasolidBareBinary"!=e.errors[t].id||(e._doFallback=!1))}},onFailure:function(e){console.log("onFailure report download")}})},onFailure:function(e){console.log("onFailure report download ticket")}})};var S="Not initialized";this._startConvert=function(e){var t=this;this.connected=!1,this.logger.log("XCADSpatialSupport._startConvert");var i={onHypervisorDisconnect:function(){t.logger.log("XCADSpatialSupport._startConvert: CSIServer Hypervisor Disconnected"),t.connected?t.connected=!1:(t.logger.error("Unable to connect"),e.onConvertError({nls:"Convert_FILE_NOT_LOADED"},e.asset))},onHypervisorConnect:function(){t.connected=!0,t.logger.log("CSIServer Connected")},onDisconnect:function(){t.logger.log("CSIServer Node Disconnected")},authentication:function(e,i,n){t.logger.log("CSIServer authentication");var r=encodeURIComponent(S).replace(/'/g,"%27").replace(/"/g,"%22");a.authenticatedRequest(e.passportURL+"/login?service="+r,{method:"GET",headers:{Accept:"application/json"},onComplete:function(e){try{t.logger.log("CSIServer authentication onComplete");var r=JSON.parse(e).access_token;i(S,r)}catch(i){n("Failed to parse ticket"),t.logger.error("Failed to parse ticket : "+e)}},onFailure:function(e,i){n("Failed to retrieve ticket"),t.logger.log("CSIServer authentication onFailure"),t.logger.error("Failed to retrieve ticket: "+i)}},"XCAD_Authentication")}},n=m[e.asset.tenant];""===n||void 0===n?(i.hypervisorIp=void 0,i.webSocketPort=void 0,this.logger.log("Trying to Connect via IP> "+void 0),S="https://"+i.hypervisorIp+":"+i.hypervisorPort):(i.hypervisorUrl=n,i.ssl=!0,this.logger.log("Trying to Connect via hypervisorUrl : "+n),S="https://"+i.hypervisorUrl);var r=p.getPool("application.webWidget").createNode(i);"prt"===e.asset.type?this._execOpenCmd(e,r):this._execConvertCmd(e,r)}},_execOpenCmd:function(e,t,i){i=t.select("ContentOptimizer"),this.logger.log("_execOpenCmd");var n,r=this,o=!1,s=e.asset,a=function(){e.onConvertError({nls:"Convert_FILE_NOT_LOADED"},s)},d=new p.Response;d.onAnswerDomain("OpenResult",function(){r.logger.log("answerOpenResultCB._execOpenCmd"),n.end(),n=null,setTimeout(function(){if(o&&"prt"===s.type)a();else if(e.asset&&e.computedInfos&&e.computedInfos.provider&&("EV6"===e.computedInfos.provider.toUpperCase()||"3DSPACE"===e.computedInfos.provider)){var n=l.createProbe("3DSpaceDocumentConnector");n.begin();var d=function(o){n&&(n.end(),n=null),e.asset.url=o.url,r._execConvertCmd(e,t,i)};r.connector3DSpace?r.connector3DSpace.open(e.computedInfos,d,a):(r.connector3DSpace="DS/3DSpaceDocumentConnector/3DSpaceDocumentConnector",require([r.connector3DSpace],function(t){r.connector3DSpace=new t,r.connector3DSpace.open(e.computedInfos,d,a)},a))}else r._execConvertCmd(e,t,i)},1)}),d.onAnswerDomain("Info",function(e){var t=e.readUint8("DocumentType");o=2===t||3===t});var c=t.createRequest({destinationNodeId:i,command:"Open",version:1,onComplete:d}),u=new p.Parameters;u.writeString("InputFileName",s.filename||"DummyName."+(s.format||s.mimetype)),u.writeString("InputFileUrl",s.url),(n=l.createProbe("XCAD_Preprocess")).begin(),c.send(null,u,null)},_execConvertCmd:function(e,i,o){this.logger.log("_execConvertCmd");var s=e.asset,d=function(o){var a,d=new f(i);d.onResultFile=function(i,r){if(this.logger.log("launchConvert.onResultFile",i),l.end("Download"),l.end("_execConvertCmd"),!0!==i||(this._exp.loadingAsset.size=r.byteLength,!r))return this.onErrorsVisited||(this.logger.error("Conversion error"),this.logger.error(arguments),e.onConvertError({nls:"Convert_ERROR",level:"fatal"},s)),this.cleanNode(d),!0;var o=new Blob([r]);n.isSet("3DPlay.downloadConvertResult")&&require(["DS/WebSystem/Downloader"],function(e){e("XCAD-Converted-File."+s.dataFormat,o)});var a=t.clone(s);e.onConvertSuccess(t.extend(a,{provider:"FILE",filename:window.URL.createObjectURL(o),proxyurl:"none",requiredAuth:null,serverurl:"",originalType:s.type,mimetype:s.dataFormat||s.mimetype,format:s.dataFormat||s.mimetype,type:s.dataFormat||s.mimetype}))}.bind(this),d.onErrors=function(t){var i;this.logger.error("Conversion error",t);try{i=JSON.parse(t)}catch(e){i=void 0}if(i&&i.errorCode>=500)return this.onErrorsVisited=!0,void("The connection with the server node has been closed before any success or error answer"===i.error&&e.onConvertError({nls:"Convert_ERROR",level:"fatal"},s));if(t&&t[0]&&t[0].split("\n")){var n=t[0].split("\n");"Please check the documentation for supported file versions and resave the file in one of supported versions if possible"===n[2]?(e.onConvertError({nls:"Convert_NOTSUPPORTED_SOLIDWORKS",level:r.fatal},s),this.onErrorsVisited=!0):"InterOp Diagnostic: The input Parasolid file is Bare binary file which is an unsupported format."===n[1]?(e.onConvertError({nls:"Convert_NOTSUPPORTED_BIN",level:r.fatal},s),this.onErrorsVisited=!0):"Translation failed for unknown error."===n[0]?(e.onConvertError({nls:"Convert_ERROR",level:r.fatal},s),this.onErrorsVisited=!0):"Error : The input file is saved in Civil3D. Output might be incomplete."===n[0]?SHARE.Core.sendEvent(this._exp.args.ctx,eventType.notif,notification.warning,{msg:h.Convert_Civil3D_Warning}):(e.onConvertError({nls:"Convert_ERROR",level:r.fatal},s),t[1]&&console.log("Error : "+t[1]),this.onErrorsVisited=!0)}}.bind(this),d.onMissingFiles=function(t){if(this.logger.error("Missing Files domain"),t&&("sldasm"!==s.type||"sldasm"!==s.format||"sldasm"!==s.mimetype)){this.logger.error(t);for(var i=0;i<t.length;i++){var n=t[i],o=Math.max(n.lastIndexOf("/"),n.lastIndexOf("\\"));-1!==o&&(n=n.substring(o+1,o.length));var a={nls:"Convert_MISSING_FILES",level:r.error,text:" "+n};this._exp&&this._exp.onModelLoadingError&&this._exp.onModelLoadingError(a)}e.onConvertError&&e.onConvertError({nls:"Convert_MISSING_FILES"})}return this._exp.getPhaseProgress().setAbsoluteProgress(this.subProgressID,100),this.cleanNode(d),!0}.bind(this),d.onProgress=function(e){this.logger.log("launchConvert.onProgress",e),e<.01?(l.end("XCAD_Transfer"),l.begin("XCAD_Convert")):e>.99&&(l.end("XCAD_Convert"),l.begin("Download")),this._exp&&this._exp.getPhaseProgress()&&this.subProgressID&&e&&this._exp.getPhaseProgress().setAbsoluteProgress(this.subProgressID,e/1*100)}.bind(this),e.ConversionOpts&&(a=new g,Object.keys(e.ConversionOpts).forEach(function(t){void 0!==e.ConversionOpts[t]&&a["Set"+t](e.ConversionOpts[t])})),l.begin("_execConvertCmd"),l.begin("XCAD_Transfer");var c=s.url,u=s.filename;(!c||e.asset._3DPlayDatas&&e.asset._3DPlayDatas.externalDrive&&!0===e.asset._3DPlayDatas.externalDrive)&&(c=u,u="");var p=u||"DummyName."+(s.format||s.mimetype);"asm"===s.dataFormat&&(s.dataFormat="3dxml"),o?(this.logger.log("_execConvertCmd.convert",p,o,s.dataFormat,a),d.convert(p,o,s.dataFormat,a)):(this.logger.log("_execConvertCmd.convertUrl",p,c,s.dataFormat,a),d.convertUrl(p,c,s.dataFormat,a))};if(s._3DPlayDatas&&s._3DPlayDatas.externalDrive){if("asm"===s.dataFormat)return void e.onConvertError({nls:"Convert_FILE_NOT_LOADED"},s);var c=s.requestsOptions||{};c.type="arraybuffer",c.timeout=5e4,l.begin("XCAD_DownloadExternalDrive");var u=this;c.onComplete=function(e){l.end("XCAD_DownloadExternalDrive");var t=new Uint8Array(e);d.apply(u,[t]),u=null},c.onFailure=c.onTimeout=function(t){l.end("XCAD_DownloadExternalDrive"),e.onConvertError({nls:"Convert_FILE_NOT_LOADED"},s),u=null},a.handleRequest(s.filename,c)}else d.apply(this)},cleanNode:function(e){setTimeout(function(){e._node.stop(),e=null},1e3)},dispose:function(){this._exp=null,this._stop=!0,this._counter=0}})}),define("DS/3DPlayExperienceModule/PlayExperience3DScriptingPlugin",["DS/Visualization/PathElement","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/3DPlayUtils/VisibilityUtils","DS/Visualization/ThreeJS_DS","DS/ApplicationFrame/CommandsManager","DS/3DPlaySupport/SupportList","DS/3DPlayExperienceModule/SceneGraphNodeServices"],function(e,t,i,n,r,o,s,a){var l="DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices";require([l],function(e){l=e});var d=function(e){s.CROSSHIGHLIGHT.resolveParenting({type:e},function(t){void 0!==t&&(s.CROSSHIGHLIGHT[t]=1)?s.CROSSHIGHLIGHT[e]=1:s.CROSSHIGHLIGHT[e]=0})},c=function(t){var i=t.getNodes(),n=[];return i.forEach(function(t){var i=new e;i.addElement(t),n.push(i)}),n},u=function(e,t){var i,n=c(t),r=e.split("/"),o=function(e,t){e.length>0&&e.forEach(function(e){var n,r=e.getLastElement();if(void 0!==r.getPersistentId)"Instance3D"!=r.productType&&1!=r.getPersistentId()||(n=r.getPersistentId())==t[0]&&(t.splice(0,1),i=e);else{var l=a.getType(r);null!=l&&(null==s.CROSSHIGHLIGHT[l]&&d(l),1==s.CROSSHIGHLIGHT[l]&&(n=a.getId(r))),null!=n&&n==t[0]&&(t.splice(0,1),i=e)}var c=e.getChildrenOccurrencePathes();null!=c&&t.length>0&&o(c,t)})};return o(n,r),i},h=function(e){for(var t=e.pathElement,i="";null!=t;){var n=t.getLastElement(!0);if(void 0!==n.getPersistentId)"Instance3D"!=n.productType&&1!=n.getPersistentId()||(0!==i.length&&(i="/"+i),i=n.getPersistentId()+i);else{var r,o=a.getType(n);null!=o&&(null==s.CROSSHIGHLIGHT[o]&&d(o),1==s.CROSSHIGHLIGHT[o]&&(r=a.getId(n))),null!=r&&(0!==i.length&&(i="/"+i),i=r+i)}t=t.getParentOccurrencePath()}return i};return function(e,l){l.createPathFromId=function(){console.error("Empty Function")},l.addScriptingFunction("createPathFromId",u.bind(e),"",[e,l]),l.createIdFromPath=function(){console.error("Empty Function")},l.addScriptingFunction("createIdFromPath",h.bind(e),"",[e,l]),l.filterFEM=function(){console.error("Empty Function")},l.addScriptingFunction("filterFEM",function(e){var t=this,i=this.instance.frmWindow.getViewer(),n=c(i),r=function(i){i.length>0&&i.forEach(function(i){var n,o,s=i.getLastElement();a.getId(s)==e&&null!=(n=a.getType(s))&&-1!==n.indexOf("FEM")&&t.hideNode({pathElement:i}),null!=(o=i.getChildrenOccurrencePathes())?r(o):console.log("FINISHED FEM FILTERING")})};r(n)}.bind(e),"",[e,l]),l.addScriptingFunction("checkCustomType",d.bind(e),"",e);l.addScriptingFunction("initCustomTypes",function(){var e=this.instance.frmWindow.getViewer(),t=c(e),i=function(e){e.length>0&&e.forEach(function(e){var t,n,r=e.getLastElement();void 0!==(t=a.getType(r))&&null==s.CROSSHIGHLIGHT[t]&&d(t),null!=(n=e.getChildrenOccurrencePathes())?i(n):console.log("FINISHED CUSTOM TYPES PARSING")})};i(t)}.bind(e),"",e);var p;l.addScriptingFunction("getSceneContent",function(e){var t=this.instance.frmWindow.getViewer(),i=c(t),n=[],r=function(t,i,n){t.length>0&&t.forEach(function(t){var o,l,c,u,h,p=t.getLastElement();o=a.getId(p),l=a.getName(p),null!=(c=a.getType(p))?(null==s.CROSSHIGHLIGHT[c]&&d(c),1==s.CROSSHIGHLIGHT[c]&&(u={name:l,id:o=i+o,type:c},n.push(u))):o=i,null!=(h=t.getChildrenOccurrencePathes())?r(h,o?o+"/":o,u&&e?u.children=[]:n):u&&(u.id=u.slice(0,-1))})};return r(i,"",n),n}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("get3DPlayInstanceId",function(){return null==p&&(p=Date.now()+Math.random()),p}.bind(e),"",e);l.addScriptingFunction("set3DPlayInstanceId",function(e){p=e}.bind(e),"",e);l.addScriptingFunction("selectNode",function(e,n){if(this._check()){var o,s=this.instance.frmWindow.getViewer(),a=[],l=[];Array.isArray(e)?l=e:l.push(e),n&&n.highlightColor&&((o={color:new r.Color(0),outlineColor:new r.Color(0),intensity:n.highlightColor.intensity}).color.set(n.highlightColor.color),o.outlineColor.set(n.highlightColor.outlineColor),s.createHighlightSet(o,!0)),l.forEach(function(e){a.push({pathElement:u(e,s),parameters:{highlightColor:o}})}),t.add(a),i.add(a)}this.instance.frmWindow.getViewer().render()}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("unselectNode",function(e,n){if(this._check()){var r=t.get(),o=[];r.forEach(function(e){o.push(h(e))});var s=[];Array.isArray(e)?s=e:s.push(e);var a=[];s.forEach(function(e){for(var t=0;t<o.length;t++)o[t].indexOf(e)>-1&&a.push(r[t])}),a.forEach(function(e){t.remove(e),i.remove(e)})}this.instance.frmWindow.getViewer().render()}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("selectAll",function(){if(this._check()){var e=this.getSceneContent(),n=[],r=this.instance.frmWindow.getViewer();e.forEach(function(e){n.push({pathElement:u(e.id,r)})}),t.add(n),i.add(n)}}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("emptySelection",function(){this._check()&&(t.empty(),i.empty())}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("getCurrentSelection",function(){if(this._check()){var e=[];return t.get().forEach(function(t){e.push(h(t))}),e}}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("addSelectionCB",function(e){void 0!==e&&(e.onAddToken=t.onAdd(function(t){Array.isArray(t)||(t=[t]);var i=[];t.forEach(function(e){i.push(h(e))}),e("ADD",i)}),e.onRemoveToken=t.onRemove(function(t){Array.isArray(t)||(t=[t]);var i=[];t.forEach(function(e){i.push(h(e))}),e("REMOVE",i)}))}.bind(e),"",e);l.addScriptingFunction("removeSelectionCB",function(e){void 0!==e&&(void 0!==e.onAddToken&&t.unsubscribe(e.onAddToken),void 0!==e.onRemoveToken&&t.unsubscribe(e.onRemoveToken))}.bind(e),"",e);l.addScriptingFunction("hideNode",function(e,t){if(this._check()){var i=this.instance.frmWindow.getViewer(),r=n.getCurrentSceneGraphState(i);Array.isArray(e)?e.forEach(function(e){null!=e.pathElement?n.reallyApplyVisibilityToAll(r,e.pathElement,0):n.reallyApplyVisibilityToAll(r,u(e,i),0)}):null!=e.pathElement?n.reallyApplyVisibilityToAll(r,e.pathElement,0):n.reallyApplyVisibilityToAll(r,u(e,i),0),this.instance.frmWindow.getViewer().render()}}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("showNode",function(e,t){if(this._check()){var i=this.instance.frmWindow.getViewer(),r=n.getCurrentSceneGraphState(this.instance.frmWindow.getViewer());Array.isArray(e)?e.forEach(function(e){n.reallyApplyVisibilityToAll(r,u(e,i),1)}):n.reallyApplyVisibilityToAll(r,u(e,i),1),this.instance.frmWindow.getViewer().render()}}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("hideAll",function(){if(this._check()){var e=this.instance.frmWindow.getViewer(),t=n.getCurrentSceneGraphState(e),i=c(e);n.reallyApplyVisibilityToAll(t,i,0),e.render()}}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("showAll",function(){if(this._check()){var e=this.instance.frmWindow.getViewer(),t=n.getCurrentSceneGraphState(e),i=c(e);n.reallyApplyVisibilityToAll(t,i,1),e.render()}}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("getCurrentHiddenSet",function(){}.bind(e),"",e);l.addScriptingFunction("getCurrentShownSet",function(){}.bind(e),"",e);var g=[];l.addScriptingFunction("addHideShowCB",function(e){void 0!==e&&(g[WUX.Events.subscribe({event:"/"+l.ctx+"/3DPLAY/HIDE/"},function(t){0!=t.data.length&&e("HIDE",[h(t.data[0])])})]=e,g[WUX.Events.subscribe({event:"/"+l.ctx+"/3DPLAY/SHOW_ALL/"},function(t){e("SHOW_ALL")})]=e)}.bind(e),"",e);l.addScriptingFunction("removeHideShowCB",function(e){for(var t=g.indexOf(e);t>-1;)g[t]=void 0,WUX.Events.unsubscribe(t.toString()),t=g.indexOf(e)}.bind(e),"",e);var f=[];l.addScriptingFunction("addViewpointChangeCB",function(e){void 0!==e&&(f[WUX.Events.subscribe({event:"/VISU/"},function(t){if("@onViewpointChange"==t.eventType){var i={position:t.cameraEye.clone(),target:t.cameraTarget.clone(),upDirection:t.cameraUp.clone()};e(i)}})]=e)}.bind(e),"",[l,e],void 0,l.trackScriptingFunction);l.addScriptingFunction("removeViewpointChangeCB",function(e){for(var t=f.indexOf(e);t>-1;)WUX.Events.unsubscribe(t.toString()),f[t]=void 0,t=f.indexOf(e)}.bind(e),"",[l,e]);l.addScriptingFunction("getCurrentViewpoint",function(){var e=this.frmWindow.getViewer().currentViewpoint;return{position:e.getEyePosition().clone(),target:e.getTarget().clone(),upDirection:e.getUpDirection().clone()}}.bind(l),"",[l,e]);l.addScriptingFunction("setCurrentViewpoint",function(e){Array.isArray(e)&&(e=e[0]);var t=this.getCurrentViewpoint();t.position.x=e.position.x,t.position.y=e.position.y,t.position.z=e.position.z,t.target.x=e.target.x,t.target.y=e.target.y,t.target.z=e.target.z,t.upDirection.x=e.upDirection.x,t.upDirection.y=e.upDirection.y,t.upDirection.z=e.upDirection.z;var i=this.frmWindow.getViewer(),n=i.currentViewpoint.camera.matrix.clone(),r=i.currentViewpoint.camera.quaternion.clone();n.lookAt(t.position,t.target,t.upDirection),r.setFromRotationMatrix(n);var o={position:t.position,orientation:r,distanceToTarget:t.target.distanceTo(t.position),duration:void 0!==t.duration?t.duration:1};i.currentViewpoint.getControl().moveTo(o)}.bind(l),"",[l,e]);l.addScriptingFunction("setVisuMode",function(e){var t=function(e,t){return o.getCommand(e,t)||o.getCommand(e)}(e,l.ctx);t&&t.beginExecute()}.bind(e),"",e,void 0,l.trackScriptingFunction);var m=[],v=["VisuNoShadingEdges","VisuShading","VisuShadingEdges","VisuShadingEdgesNoSmoothEdges","VisuShadingEdgesHiddenEdges","VisuShadingMaterial","VisuShadingMaterialEdges","VisuShadingIllustration","VisuOrthographicView","VisuPerspectiveView"];l.addScriptingFunction("addVisuModeCB",function(e){void 0!==e&&v.forEach(function(t){m[WUX.Events.subscribe({event:"/WUX/AFR/CMD/"+l.ctx+"/"+t+"/"},function(i){e("VISU_MODE",[t])})]=e})}.bind(e),"",e);l.addScriptingFunction("removeVisuModeCB",function(e){for(var t=m.indexOf(e);t>-1;)WUX.Events.unsubscribe(t.toString()),m[t]=void 0,t=m.indexOf(e)}.bind(e),"",e);l.addScriptingFunction("setNodeProperties",function(e,t){if(this._check()){var i=this.instance.frmWindow.getViewer();if(e){var r=n.getCurrentSceneGraphState(i);r&&(t.opacity&&r.setOpacity(e,t.opacity),t.color,t.position,void 0!==t.visibility&&t.visibility)}}}.bind(e),"",e,void 0,l.trackScriptingFunction)}}),define("DS/WebViewer2D/ViewerCanvas",["UWA/Core","DS/WebViewer2D/ViewerDoc","DS/UIKIT/Spinner","DS/CoreEvents/Events","DS/WebViewer2D/CanvasShapes","WebappsUtils/WebappsUtils"],function(e,t,i,n,r,o){"use strict";return t.extend({init:function(t){this._parent(t),this.thumbnail=t.thumbnail,this.title=t.title||t.defaultTitle,this.margin=t.margin||10,this.documentContainer=new e.Element("div",{styles:{position:"relative",display:"inline-block","vertical-align":"middle","background-color":"#ffffff","box-shadow":"darkgrey 2px 2px 10px 1px",overflow:"hidden",height:"calc(100% - 10px)","margin-top":"5px","margin-bottom":"5px"}}).inject(this.container),this.canvas=new e.Element("canvas",{id:"ViewerCanvas",styles:{"z-index":"2000","vertical-align":"top",display:"none",height:"100%"}});var i=document.createElement("div");i.setAttribute("class","PlayWeb-Splash"),this.splashImage=document.createElement("img"),this.baseUrl=o.getWebappsBaseUrl(),"/"!==this.baseUrl.charAt(this.baseUrl.length-1)&&(this.baseUrl+="/"),this.splashImage.setAttribute("src",this.baseUrl+"3DPlay2DExperience/assets/images/sheet_loading.gif"),this.splashImage.setAttribute("class","PlayWeb-SplashImage loading"),i.appendChild(this.splashImage);var n=this,r=function(e){"thumb"===e&&(n.splashImage.setAttribute("class","PlayWeb-SplashImage thumb"),n.thumbnail?(n.splashImage.src=n.thumbnail,n.thumbnailImg=new Image,n.thumbnailImg.src=n.thumbnail):e="loading"),"thumb"!==e&&("loading"===e?n.splashImage.src=n.baseUrl+"3DPlay2DExperience/assets/images/sheet_loading.gif":"failed"===e&&(n.splashImage.src=n.baseUrl+"3DPlay2DExperience/assets/images/sheet_failed.png"),n.canvas.width=n.realSizeWidth*n.scale,n.canvas.height=n.realSizeHeight*n.scale,n.canvas.setStyle("display",""),n.splashImage.setAttribute("class","PlayWeb-SplashImage ")),i.style.display=""};this.specialViews={hide:function(){i.style.display="none"},show:{loading:function(){r("loading")},failed:function(){r("failed")},thumbnail:function(){r("thumb")}}},this.documentContainer.appendChild(i),this.canvas.inject(this.documentContainer),this.shapeList={},this._isCentered=!1},updateView:function(e){this.asset=e.asset,this.status=e.status,this.title=e.title,this.shapeList=e.annotations||{},this.scale=e.scale,this.useLOD=e.useLOD,!1===this.status.loaded?(this.specialViews.show.loading(),e.doneCB&&e.doneCB(!0)):!0===this.status.failed?(this.specialViews.show.failed(),e.doneCB&&e.doneCB(!0)):this.scaleAndRender(e.doneCB)},_scaleAndRender:function(){return!1},scaleAndRender:function(e){var t=this;this._scaleAndRender({scale:this.scale||1,asset:this.asset,status:this.status,OnComplete:function(i){for(var n in!0!==i&&(t.canvas.setStyle("display",""),t.specialViews.hide()),t.shapeList)r.drawShape({shape:t.shapeList[n],canvas:t.canvas,scale:t.scale});t=void 0,e&&e()}})},setScale:function(e){if(e!==this.scale){this.scale=e;var t=function(){n.publish({event:"3DPlay.2D.Zoom.Completed",data:{scale:this.scale}})}.bind(this);this.scaleAndRender(t)}},getScale:function(){return this.scale},getScreenShot:function(e){var t,i,n,r,o,s,a,l,d=this.useLOD?this.thumbnailImg:this.canvas,c=(this.useLOD?this.splashImage:this.canvas).getBoundingClientRect(),u=c.top-e.viewerFrameBB.top,h=c.left-e.viewerFrameBB.left,p=c.right-e.viewerFrameBB.left,g=c.bottom-e.viewerFrameBB.top,f=e.containerBB.top-e.viewerFrameBB.top,m=e.containerBB.bottom-e.viewerFrameBB.top,v=e.containerBB.left-e.viewerFrameBB.left,S=e.containerBB.right-e.viewerFrameBB.left;g<=f||u>=m||h>=S||p<=v||(this.useLOD?(t=h>0?0:Math.abs(h)*(this.thumbnailImg.width/c.width),i=u>0?0:Math.abs(u)*(this.thumbnailImg.height/c.height),n=this.thumbnailImg.width-t,r=this.thumbnailImg.height-i,o=h>0?h:0,s=u>0?u:0,a=h>0?c.width:c.width+h,l=u>0?c.height:c.height+u):(h>v?(t=0,o=h):(t=Math.abs(h),o=0),u>f?(i=0,s=u):(i=Math.abs(u),s=0),a=n=h<e.containerBB.left?p>S?e.containerBB.width:c.width+h:p<S?c.width:S-h,l=r=u<f?g>m?e.containerBB.height:c.height+u:g<m?c.height:m-u),e.context.shadowColor="darkgrey",e.context.shadowOffsetX=2,e.context.shadowOffsetY=2,e.context.shadowBlur=10,e.context.fillRect(o,s,a,l),e.context.drawImage(d,t,i,n,r,o,s,a,l))},getAnnotationDiv:function(){return this.document},getContainer:function(){return this.container},getViewerPositionFromMouse:function(e){var t=this.documentContainer.getBoundingClientRect(),i=e.x-t.left,n=e.y-t.top;return i>0&&n>0&&i<this.currentWidth&&n<this.currentHeight&&{x:i/=this.scale,y:n/=this.scale}},getMousePositionFromViewer:function(e){var t=e.x*this.scale,i=e.y*this.scale;return t>0&&i>0&&t<this.currentWidth&&i<this.currentHeight&&{x:t+=this.currentPosH,y:i+=this.currentPosV}},getShapeList:function(){return this.shapeList},createShape:function(e){var t=r.createShape({shapeData:e.shapeData,scale:this.scale,settings:e.settings});return this.shapeList[""+t.id]=t,r.drawShape({shape:t,canvas:this.canvas,scale:this.scale})},getIntersectingShapes:function(e){var t=[];for(var i in this.shapeList){var n=r.isIntersectShape({shape:this.shapeList[i],startPoint:e.startPoint,endPoint:e.endPoint,shapeList:this.shapeList});n&&(t=t.concat(n))}return t},drawShape:function(e){for(var t=e.idList,i=0;i<t.length;++i)r.drawShape({shape:this.shapeList[""+t[i]],canvas:this.canvas,scale:this.scale,lowLightMode:e.lowLightMode})},destroyShape:function(e){for(var t=e.idList,i=0;i<t.length;++i)delete this.shapeList[""+t[i]]},dispose:function(){this._parent(),this.baseUrl=null,this.documentContainer=null,this.canvas=null},_setThumbnail:function(e){this._parent(e),this.useLOD&&this.specialViews.show.thumbnail()}})}),define("DS/WebViewer2D/ViewerSvg",["DS/WebViewer2D/ViewerDoc","DS/WebViewer2D/ViewerCanvas","DS/WebSystem/DetectBrowser","DS/CoreEvents/Events","DS/WebSystem/Environment","DS/WebSystem/Nls","WebappsUtils/WebappsUtils"],function(e,t,i,n,r,o,s){"use strict";return t.extend({init:function(e){this._parent(e),this.margin=e.margin||10,this._isLODActive=!1,this._nextRender=null,this._isRenderInProgress=!1},loadAsset:function(e){var t="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e.asset.asset)));this.asset=e.asset,this.status=e.status,this.useLOD=e.useLOD;var n=new Image;n.width=5*this.asset.width,n.height=5*this.asset.height;var r=this;n.onload=function(){r.asset.image=n,r._scaleAndRender({scale:1,isForThumb:!0,OnComplete:function(){e.doneCB&&("ie"===i().browser.name?e.doneCB(n,t):e.doneCB(n,r.canvas.toDataURL("image/png")))}})},n.onerror=function(){this.specialViews.show.error()}.bind(this),n.src=t},_scaleAndRender:function(e){if(void 0===this.asset||null===this.asset||null==this.asset.image||null==this.asset.image)return this._nextRender=null,this.specialViews.show.failed(),options.OnComplete(!0),!0;var t=this.asset.width*e.scale,i=this.asset.height*e.scale;if(this.useLOD&&!0!==e.isForThumb)this._nextRender=null,this.thumbnail?this.specialViews.show.thumbnail():this.specialViews.show.loading(),e.OnComplete&&e.OnComplete(!0);else if(this.canvas.width=t||this.container.offsetWidth,this.canvas.height=i||this.container.offsetHeight,!1===this._isRenderInProgress){this._isRenderInProgress=!0;var n=this.canvas.getContext("2d");this.asset.image?(!0===e.isForThumb&&(n.fillStyle="#FFFFFF",n.fillRect(0,0,t,i)),n.drawImage(this.asset.image,0,0,t,i)):console.error("No image: render skipped."),this._isRenderInProgress=!1,this._nextRender?(this._scaleAndRender(this._nextRender),this._nextRender=null):e.OnComplete&&e.OnComplete(!1)}else this._nextRender=e;return!0},dispose:function(){}})}),define("DS/3DPlayExperienceModule/3DPlayAbstractExperience",["UWA/Core","DS/WebSystem/Scripting","DS/3DPlay/3DPlay","DS/3DPlayUtils/PanelManager","DS/3DPlayUtils/UIManager","DS/WebSystem/Settings","DS/ApplicationFrame/CommandsManager","DS/WebInfraUI/Notification","DS/WebSystem/Environment","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/WebUtils/EventDisposer","DS/WebSystem/Nls","DS/WebUtils/FunctionDisposer","DS/3DPlayUtils/XCADSpatialSupport","DS/3DPlayConnectors/3DPlayInputPreProcessor","DS/WebUtils/ContextedSingleton","DS/CoreEvents/Events","DS/WebUtils/ProbesManager","DS/WebInfraUI/MobileActionBar","DS/WebUtils/PhaseProgress","DS/WebUtils/Tracker","DS/ENOXTriptych/js/ENOXTriptych","DS/WebSystem/App","i18n!DS/3DPlay/assets/nls/3DPlay"],function(e,t,i,n,r,o,s,a,l,d,c,u,h,p,g,f,m,v,S,D,w,P,y,C,b){"use strict";return t.extend({name:"3DPlayAbstractExperience",getExperienceModule:function(){return this.args.input.experience.filename},init:function(e){this._parent(),this.widgetPreferences={},this.args=e,this._name=e.input.experience.filename||"Default",this.EventDisposer=new u,this.addOnPauseCB(this.onPause),this.addOnPlayCB(this.onPlay),this.addOnStopCB(this.onStop),this.addOnScenarioChangeCB(this.onScenarioChange),this.addOnLoadingFinishedCB(this.onLoadingFinished),this.createScriptingAPI(),this.addScriptingInitCB(),this.disposeFunctions=new p,this.xcadSupport=new g(this),this._isReady=!1,this._enableCMenu=!0,this.playerSplashScreen=void 0,this.showSplashBetweenLoad=!0,this.modelLoadComplete=!1,this.phaseProgress=new w,this.isFromTransition=!1,this.landingPage=e.container.getElementsByClassName("Landing-Page_container")[0];var t=this;this.progress={},this.progress.hide=function(){t.getPhaseProgress()&&t.getPhaseProgress().hideProgressBar()},this.progress.updateProgression=function(e){t.getPhaseProgress()&&(t.getPhaseProgress().setAbsoluteProgress(this.subProgressID,e),t.progress.state.value=e)},this.progress.visible=function(){t.getPhaseProgress()&&(t.getPhaseProgress().showProgressBar(),t.progress.state.visible=!0)},this.progress.state={visible:!1,value:0},this.progress.spinnerContainer={style:{overflow:""}}},acceptSwitch:function(){return!1},acceptRefresh:function(){var e=void 0===this.needToRefresh||this.needToRefresh;return this.needToRefresh=!0,e},resetWidgetPreferences:function(){var e=window.widget;for(var t in e&&C.is3DPlay()&&e.setPreferences([]),this.widgetPreferences)this.widgetPreferences.hasOwnProperty(t)&&(this.widgetPreferences[t].update=null)},refreshFromPreferences:function(e){this.needToRefresh=e},addWidgetPreferences:function(){var e=window.widget,t=this.widgetPreferences;if(e){var i=this,n=function(n){var r=!1;e.addEvent("onUpdateValue",function(e){t[e]&&t[e].update&&t[e].update(this.getValue(e))&&(r=!0)}),e.addEvent("endEdit",function(e){e&&e.submitted&&i.refreshFromPreferences(r)})};for(var r in t)t.hasOwnProperty(r)&&(e.hasPreference(r)||e.addPreference(t[r]));e.addEvent("onEdit",n),this.EventDisposer.add(function(){window.widget.removeEvent("onEdit",n),n=null,i=null})}},registerCollabAction:function(){},isLoadingFinished:function(){return this.modelLoadComplete},isLoadingFInished:function(){return console.error("Wrong function - case error, please use isLoadingFinished"),console.error("Wrong function - case error, please use isLoadingFinished"),this.isLoadingFinished()},createScriptingAPI:function(){var e=this.args.options.helper||m.get(this.args.ctx,"helper"),t=this;t.addScriptingFunction("registerAction",t.addScriptingFunction.bind(t),"",e),t.addScriptingFunction("performAction",t.executeScriptingFunction.bind(t),"",e),t.addScriptingFunction("getAvailableActions",t.getScriptingFunctions.bind(t),"",e),t.addScriptingFunction("isActionSupported",t.hasScriptingFunction.bind(t),"",e),t.addScriptingFunction("unregisterAction",t.removeScriptingFunction.bind(t),"",e),t.addScriptingFunction("unregisterAllActions",t.disposeAllScriptingFunctions.bind(t),"",e),t.addScriptingFunction("notifyAction",t.notifyScriptingFunction.bind(t),"",[e,t]),t.addScriptingFunction("subscribeAction",t.subscribeScriptingFunction.bind(t),"",e),t.addScriptingFunction("unsubscribeAction",t.unsubscribeScriptingFunction.bind(t),"",e),t.addScriptingFunction("subscribeAllActions",t.subscribeAllScriptingFunctions.bind(t),"",e),t.addScriptingFunction("unsubscribeAllActions",t.unsubscribeAllScriptingFunctions.bind(t),"",e);this.trackScriptingFunction=function(e){P.trackPageEvent("commands","scripting",e)},t.addScriptingFunction("getScreenshot",function(e){this._check()&&this.instance.getScreenShot(e)}.bind(e),"",e,void 0,this.trackScriptingFunction);t.addScriptingFunction("getCollabMode",function(){return t.collabMode}.bind(e),"",e);t.addScriptingFunction("setCollabMode",function(e){t.collabMode=e}.bind(e),"",e),this.trackScriptingFunction;var i=[],n=["selectNode","unselectNode","setCurrentViewpoint","hideNode","showNode","showAll","hideAll","setVisuMode"];t.addScriptingFunction("addCollabCB",function(e){void 0!==e&&(i.push(e),e.collabNotif=function(e,i){"ADD"===e?t.notifyScriptingFunction("selectNode",i):"REMOVE"===e?t.notifyScriptingFunction("unselectNode",i):"HIDE"===e?t.notifyScriptingFunction("hideNode",i):"SHOW_ALL"===e?t.notifyScriptingFunction("showAll"):"VISU_MODE"===e?t.notifyScriptingFunction("setVisuMode",i):void 0===i&&t.notifyScriptingFunction("setCurrentViewpoint",[e])},this.addSelectionCB&&this.addSelectionCB(e.collabNotif),this.addViewpointChangeCB&&this.addViewpointChangeCB(e.collabNotif),this.addHideShowCB&&this.addHideShowCB(e.collabNotif),this.addVisuModeCB&&this.addVisuModeCB(e.collabNotif),n.forEach(function(i){t.subscribeScriptingFunction(i,e)}))}.bind(e),"",e);t.addScriptingFunction("removeCollabCB",function(e){if(void 0!==e){for(var t=i.indexOf(e);t>-1;)i[t]=void 0,t=i.indexOf(e);removeSelectionCB(e.sCB),removeViewpointChangeCB(sCB),removeHideShowCB(e.collabNotif),removeVisuModeCB(e.collabNotif)}}.bind(e),"",e);t.addScriptingFunction("registerCollabAction",function(r,o){t.addScriptingFunction(r,o,"",[e,t]),n.push(r),i.forEach(function(e){t.subscribeScriptingFunction(r,e)})}.bind(t),"",[e,t]);t.addScriptingFunction("unRegisterCollabAction",function(e){if(void 0!==n)for(var r=n.indexOf(e);r>-1;)n[r]=void 0,r=n.indexOf(e);t.removeScriptingFunction(e),i.forEach(function(i){t.unSubscribeScriptingFunction(e,i)})}.bind(t),"",[e,t]),t.addScriptingFunction("initCustomTypes",function(){},"",e)},addScriptingInitCB:function(){var e=this.args.options.helper||m.get(this.args.ctx,"helper");e&&this.args.options.collabmode&&e.setCollabMode("true"===this.args.options.collabmode),this.EventDisposer.add(WUX.Events.subscribe({origin:this,event:"/"+this.args.ctx+"/ASSET/LOADINGFINISHED"},function(){e.initCustomTypes()}))},addOnLoadingFinishedCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({origin:this,event:"/"+this.args.ctx+"/ASSET/LOADINGFINISHED"},e))},onLoadingFinished:function(){},addOnLoadingStartedCB:function(e,t){return this.subscribe("ASSET/LOADINGSTARTED",e,t)},addOnPlayCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/EXPERIENCE/PLAY"},e))},onPlay:function(){},addOnPauseCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/EXPERIENCE/PAUSED"},e))},onPause:function(){},addOnStopCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/EXPERIENCE/STOP"},e))},onStop:function(){},addOnScenarioChangeCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/SCENARIO/CHANGE"},e))},onScenarioChange:function(){},dispose:function(e){if(l.isSet("3DPlay.Debug")&&console.log("3DPlay.Debug:3DPlayAbstractExperience.dispose",e),this.stop(),this.notifScreen&&(this.notifScreen.dispose&&this.notifScreen.dispose(),this.notifScreen=null),e=e||{},this.playerSplashScreen&&(this.playerSplashScreen=null),this.notifTimeoutID&&(clearTimeout(this.notifTimeoutID),this.notifTimeoutID=null),this.EventDisposer.dispose(),this.EventDisposer=null,this.resetWidgetPreferences(),this.disposeFunctions.dispose(),this.disposeFunctions=null,i.removeCallbacks(this.args.ctx),void 0===e.disposeFrameWindow||!0===e.disposeFrameWindow)void 0!==this.frmWindow&&null!==this.frmWindow&&(void 0!==this.frmWindow.dispose&&null!==this.frmWindow.dispose&&this.frmWindow.dispose(),this.frmWindow.experience=null,this.frmWindow=null);else{var t=this.args.ctx;s._commandsState[t]={lastCommand:[],currentCommand:null,defaultCommand:null},s.resetDefaultCommand(t),s._isCommandEnding=!1,s._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach(function(e){if(s[e]){var i=s[e][t];i&&Object.keys(i).forEach(function(e){var t=i[e];t&&t._destroy&&t._destroy(),delete i[e]})}})}this.PanelManager&&(this.PanelManager.dispose(),this.PanelManager=null),this.UIManager&&(this.UIManager.dispose&&this.UIManager.dispose(),this.UIManager=null),this.phaseProgress&&(this.phaseProgress.dispose&&this.phaseProgress.dispose(),this.phaseProgress=null),this.xcadSupport&&(this.xcadSupport.dispose&&this.xcadSupport.dispose(),this.xcadSupport=null),this._parent(e),this.args=null,this.actionBarProfile&&(this.actionBarProfile.dispose&&this.actionBarProfile.dispose(),this.actionBarProfile=null),this.mainTrip&&this.mainTrip.remove(),this.triptych&&this.triptych.destroy(),this.mainTrip=null,this.triptych=null},informActiveState:function(e){this.PanelManager.setVisibility(e),e?v.publish({event:"3DPLAY/3DPLAYPREVIEW/ENABLE",data:{}}):v.publish({event:"3DPLAY/3DPLAYPREVIEW/DISABLE",data:{}})},play:function(){if(void 0===this.pausetime&&(this.pausetime=this.first),!0===this.paused||!0===this.stoped){var e=(new Date).getTime()-this.pausetime;this.first+=e,this.paused=this.stoped=!1,this.publish("EXPERIENCE/PLAY",{experience:this,ctx:this.args.ctx})}},pause:function(){!1===this.paused&&(this.pausetime=(new Date).getTime(),this.paused=!0,this.stoped=!1,this.publish("EXPERIENCE/PAUSED",{experience:this,ctx:this.args.ctx}))},stop:function(){this.stoped=!0,this.paused=!1,this.publish("EXPERIENCE/STOP",{experience:this,ctx:this.args.ctx})},_testBrowser:function(){return BrowserSupport.ok},testBrowser:function(){return BrowserSupport.ok},getScreenShot:function(e){},start:function(){this.playerSplashScreen&&this.playerSplashScreen.removeOnClick(),this.args.options.loading===loadingMode.preload?this.isLoaded?this.toggleSplash(!1):this.args.options.splashscreen&&this.args.options.splashscreen.waitloading?this.toggleSplash(!0):this.toggleSplash(!1):this.initExperience()},toggleSplash:function(e){this.landingPage&&(e?this.landingPage.show():this.landingPage.hide()),this.playerSplashScreen&&(e?this.playerSplashScreen.show():this.playerSplashScreen.hide())},initExperience:function(){},fromTransition:function(){return this.isFromTransition},createUIComponents:function(e){var t=this;if(this.paused=!0,e.experience=this,this.UIManager=new r({frameWindow:e,ctx:this.args.ctx}),this.PanelManager=new n({frameWindow:e,ctx:this.args.ctx}),this.PanelManager.setTopBarId(this.args.options),C.is3DPlay()&&this.PanelManager.tagger&&this.PanelManager.tagger.proxyTag(),0==this.getIfToDealyMABCreation()){var i=e.getActionBar();i&&this.mabModel&&(i.MAB&&i.MAB.dispose(),this.tabletMabModel?i.MAB=new D({ctx:this.ctx,frameWnd:e,exp:this,actionBar:i,model:this.mabModel,modelTablet:this.tabletMabModel,panelManager:this.PanelManager,alwaysOn:this._iOS||this._android||window.WinJS&&l.isSet("3DPlay.MabWin10"),ios:this._iOS,pdf:this.isCurrentDocumentPDF}):i.MAB=new D({ctx:this.ctx,frameWnd:e,exp:this,actionBar:i,model:this.mabModel,panelManager:this.PanelManager,alwaysOn:this._iOS||this._android||window.WinJS&&l.isSet("3DPlay.MabWin10"),ios:this._iOS,pdf:this.isCurrentDocumentPDF}))}t.disposeFunctions.add(function(){var e=t.frmWindow.getActionBar();e&&e.MAB&&(!0===e.MAB.state.visible&&e.MAB.hide(),e.MAB.dispose()),t=null}),void 0!==this.notifScreen&&null!==this.notifScreen||(this.notifMsg=d,this.notifScreen=c,c.elements&&c.elements.container.isInjected()||c.inject(e.getUIFrame()),this.args&&(this.args.commandFullscreen||this.args.options.fullscreen)?c.slide({top:60,right:0}):c.slide({top:0,right:0}),c.setNotificationManager(d)),this.manageWorkBenchs({createActionBar:void 0!==this.args.options.pad3DViewer,frameWindow:e,finishCallBack:function(){t.publish("EXPERIENCE/EXPERIENCEREADY",t)}}),this.notifScreen&&this.UIManager.addToPanelEvent(this.notifScreen,function(e){t.notifScreen.slide({top:60,right:0}),e.visible&&t.notifScreen.slide({top:60,right:e.size+10})})},getInformationsOnAsset:function(){var e=this.args.input&&this.args.input.asset;if(Array.isArray(e)&&(e=e[0]),!e)return e;var t=e.provider,i=e.type,n=e.physicalid,r=e.source,o=e.tenant;if(e.originalType&&(i=e.originalType),e.originalAsset&&(t=e.originalAsset.provider||t,i=i||e.originalAsset.format||e.originalAsset.dtype||e.originalAsset.type,n=e.originalAsset.physicalid||n,r=r||e.originalAsset.source,o=o||e.originalAsset.tenant),e.localFile&&(r=o="Desktop"),"FILE"===t&&(C.is3DDrive()?t="3DDRIVE":C.is3DSwym()&&(t="3DSWYM")),"xmlv43"===i&&(i="3DXML"),"EV6"===t)t="3DSpace";else if("3DSWYM"===t&&!n&&e.originalAsset&&null==(n=e.originalAsset.objectId)&&e.filename){var s=e.filename;if(s.search("/id/")>=0){var a=s.search("/id/");a+=4,a=(s=s.slice(a)).search("/"),n=s.slice(0,a)}e.swymAttr&&(n=e.swymAttr.id)}return{id:n,provider:t,type:i,source:r,tenant:o,swymAttr:e.swymAttr,swymServerToken:e.swymServerToken,driveAttr:e.driveAttr,fileAttr:e.localFile}},getIfToDealyMABCreation:function(){return!1},updateConnection:function(e,t){t&&t()},createDom:function(t,i){if(!this.frmWindow){this.args.ui=this.args.ui||{displayTree:!0};var n={context:this.args.ctx,height:"100%",minHeight:void 0!==this.args.minHeight?this.args.minHeight:0,viewerOptions:this.args.viewerOptions||this.args.visu||{},uiOptions:this.args.ui,onModelLoaded:this.onModelLoadingCompleted,language:this.args.lang};if(this.args.workbenchs&&this.args.workbenchs.length>0){this.workbenchIndex=0;var r=this.args.workbenchs[this.workbenchIndex];this.workbenchIndex++,n.ignoreResetCommandManager=!0,n.workbenchModule=r.module,n.workbench=r.name+".xml",n.defaultCommand=void 0!==r.defaultCommand?r.defaultCommand:{ID:"",className:"DS.3DPlayCommands.EmptyCmd"},this.actionBarProfile=S.createProbe("ActionBar_"+r.name),this.actionBarProfile.begin()}if(this.frmWindow=new t(n),C.is3DPlay()){this.mainTrip=e.createElement("div",{class:"3Dplayviewer_mainTriptych",styles:{width:"100%",height:"100%"}}),this.rightTrip=e.createElement("div",{class:"3Dplayviewer_rightTriptych rightSidePanel"});var o={container:this.mainTrip,withtransition:!0,withoverflowhidden:!0,right:{resizable:!0,originalState:"close",overMobile:!0,minWidth:250,withClose:!1}};this.triptych=new y,this.triptych.init(o,void 0,this.frmWindow.getContent(),this.rightTrip);var s=this;require(["DS/PADServices/utils/GlobalModelEvents"],function(e){s.triptych._modelEvents.subscribe({event:"triptych-clicked-overlay"},function(t){e.publish({event:"ENXViews/Triptych/onOverlayClick",data:t})})}),this.triptych.togglePanel=function(e){"left"===e?s.triptych._modelEvents.publish({event:"triptych-toggle-panel",data:"left"}):s.triptych._modelEvents.publish({event:"triptych-toggle-panel",data:"right"})},this.triptych.inject(this.args.container),this.triptych.getMainPanelContainer().style.zIndex="auto";var a=this.frmWindow.getActionBar();a&&a.inject(this.mainTrip)}else this.frmWindow.inject(this.args.container)}i&&i.apply(this)},getPhaseProgress:function(){return this.phaseProgress},load:function(t,n){var r=this;if(r.hasConvertFailed=!1,n&&n.newAsset){if(i.endAllCommands({ctx:this.args.ctx,resetDefaultCmd:!1}),o.get("3DPlay.Video.Enabled")){var s=m.get(this.args.ctx,"3DP_Video_Controls");s&&(s.destroyUI(),m.remove(this.args.ctx,"3DP_Video_Controls")),m.get(this.args.ctx,"3DP_Video_Viewer")&&m.remove(this.args.ctx,"3DP_Video_Viewer")}i.publish(this.args.ctx,"ASSET/CHANGE",{model:"clear",ctx:this.args.ctx})}if(null==n&&(n={}),this.playerSplashScreen){var a=n?n.splashscreen:null;this.playerSplashScreen.refreshOptions(a)}!0!==t.preProcessed&&(console.error("3DPlayWeb: inputs should have been pre processed before call."),console.error("3DPlayWeb: Please consider using 3DPlayHelper or InputPreProcessor."));var l=S.createProbe("PreProcessor");l.begin(),(new f).run(t,function(o){l.end(),l=null;var s=o;if(t=o,r._isReady=!0,!0!==r._isReady)return r.args.input=t,void(r.args.options=n);if(void 0!==r.frmWindow){if(s&&void 0!==s.asset&&!1===Array.isArray(s.asset)&&(s.asset=[s.asset]),s&&void 0!==s.asset&&void 0!==s.asset[0]){var a=!1,d=!0;n&&(a=(void 0===s||void 0===s.asset||void 0===s.asset[0])&&!0===n.clearSceneGraph,void 0!==n.clearSceneGraph&&null!==n.clearSceneGraph&&(d=n.clearSceneGraph)),r.notifTimeoutID&&(clearTimeout(r.notifTimeoutID),r.notifTimeoutID=null),a||d?(r.showSplashBetweenLoad&&r.playerSplashScreen&&(r.playerSplashScreen.showView(r.playerSplashScreen.views.loading),r.toggleSplash(!0)),r.clearView(),r.getPhaseProgress().setIndeterminateState(),r.xcadSupport.clearQueue()):r.autoReframe=!1,a&&r.publish("ASSET/LOADINGFINISHED",{model:"clear",ctx:this.args.ctx});var c=null,u={},h=r.getInformationsOnAsset(),p=function(e){r.onModelLoadingError?r.onModelLoadingError(e):r.onDocumentLoadingError&&r.onDocumentLoadingError(e);var t={};t[e.type]=1,P.trackPageEvent("errors","conversion_error",h.type,0,t),h=null,console.error("Conversion fails, see logs below :"),console.error(e)};if(s.asset.length>1){for(var g=[],m=[],v=0;v<s.asset.length;v++)s.asset[v]&&!1!==s.asset[v].useConvertors&&(n&&n.tenant&&(void 0===s.asset[v].tenant||null===s.asset[v].tenant)&&(s.asset[v].tenant=n.tenant),null!==(c=r.xcadSupport.getConversionFormat(s.asset[v].mimetype||s.asset[v].format))?(s.asset[v].dataFormat=c,g.push(s.asset[v])):m.push(s.asset[v]));g.length>0&&(u.nbAssetToConvert=g.length,u.progress=r.getPhaseProgress(),u.progressDivisions=m.length+g.length);var D=s;D.asset=m;var w=r._loadAssets(D,e.extend(n,{convert:u}));w&&g.length>0&&(this.notifTimeoutID=u.notifTimeoutID=setTimeout(function(){i.sendEvent(r.args.ctx,eventType.notif,notification.info,{msg:b.ConversionNeeded})},6e3),g.length>0&&r.xcadSupport.convert(g,u,function(e,t){p(e),w.addNewFile(t)},function(e,t){r.playerSplashScreen.showView(r.playerSplashScreen.views.loading),w.addNewFile(e)},function(e){w.addNewFile(e)}))}else{if(null===s.asset[0]||void 0===s.asset[0])return void r.loadAsset(void 0,n);n&&n.tenant&&(void 0===s.asset[0].tenant||null===s.asset[0].tenant)&&(s.asset[0].tenant=n.tenant);var y=null;if(!1!==s.asset[0].useConvertors&&null!==r.xcadSupport.getConversionFormat(s.asset[0].mimetype||s.asset[0].format)&&(c=r.xcadSupport.getConversionFormat(s.asset[0].mimetype||s.asset[0].format),y=r.xcadSupport),null===c)s.asset=s.asset[0],window.localStorage["3DPlayHybridApp"]&&window.HybridAppArgs&&window.HybridAppArgs.myAppsUrl?r.updateConnection(s,function(){r.loadAsset(s,n)}):r.loadAsset(s,n);else{r.subProgressID=r.getPhaseProgress().registerSubProgress(),r.getPhaseProgress().showProgressBar(),s.asset[0].dataFormat=c;var C=e.extend(n,{clearSceneGraph:!0,ConversionFeedBack:{progress:r.getPhaseProgress()}});r.notifTimeoutID=C.ConversionFeedBack.notifTimeoutID=setTimeout(function(){i.sendEvent(r.args.ctx,eventType.notif,notification.info,{msg:b.ConversionNeeded})},6e3);var E=S.createProbe("Convert");E.begin(),y.convert(s.asset[0],C,function(e,t){r.args.input.asset=t,r.loadAssetInfo=t,E.end();t&&t.format&&{step:!0,stp:!0}[t.format.toLowerCase()]?(r.playerSplashScreen&&r.playerSplashScreen.showView(r.playerSplashScreen.views.loading),t&&(t.originalAsset?(new f).run({asset:t.originalAsset},function(e){e.asset.serverurl="",e.asset.filename=e.asset.url,r.loadAsset(e,C)}):r._loadAssets({asset:t},C))):p(e)},function(t){r.loadAssetInfo=e.clone(t,!0),s.asset[0].originalAsset?r.loadAssetInfo.originalAsset=e.clone(s.asset[0].originalAsset,!0):r.loadAssetInfo.originalAsset=e.clone(s.asset[0],!0),r.args.input.asset=t,E.end(),r.playerSplashScreen&&r.playerSplashScreen.showView(r.playerSplashScreen.views.loading),r._loadAssets({asset:t},C)})}}}r.args.input.asset=e.clone(s.asset,!0),r.args.input.experience=e.extend(r.args.input.experience,s.experience,!0),r.args.options=e.extend(r.args.options,e.clone(n,!0),!0),r.loadAssetInfo=e.clone(r.args.input.asset,!0)}})},loadAssets:function(e,t){console.error("Function not implemented - loadAsset")},_handleNotification:function(e){e.eventID===a.fatal?i.displayFatalError({ctx:e.ctx,msg:e.msg}):e.eventID===a.warning||e.eventID===a.info||e.eventID===a.success||e.eventID===a.error||e.eventID===a.assistance?(this.notifMsg.addNotif({level:e.eventID,title:e.title,subtitle:e.subtitle,message:e.msg,category:e.category||"3DPlay - "+this.ctx,sticky:!1}),this.publish("EXPERIENCE/NOTIF",{ctx:e.ctx,event:e.eventID,msg:e.msg})):console.error("3DPlay: "+b.IncorectNotif)},setOnLoadedCallback:function(e){console.error("Function not implemented - AbstractExp")},setOnProgressCallback:function(e){console.error("Function not implemented - AbstractExp")},_step:function(){console.error("Function not implemented - AbstractExp")},step:function(){console.error("Function not implemented - AbstractExp")},preRenderCB:function(){console.error("Function not implemented - AbstractExp")},postRenderCB:function(){console.error("Function not implemented - AbstractExp")},preCreate:function(){console.error("Function not implemented - AbstractExp")},postCreate:function(){console.error("Function not implemented - AbstractExp")},onPreCreate:function(){console.error("Function not implemented - AbstractExp")},onPostCreate:function(){console.error("Function not implemented - AbstractExp")},addScenario:function(e){console.error("Function not implemented - AbstractExp")},getScenarioNumber:function(){console.error("Function not implemented - AbstractExp")},getScenario:function(e){console.error("Function not implemented - AbstractExp")},loadWorkbench:function(e,t){console.error("Function not implemented - AbstractExp")},changeScenario:function(e,t){console.error("Function not implemented - AbstractExp")},getDefaultScenario:function(){console.error("Function not implemented - AbstractExp")},manageScenario:function(){console.error("Function not implemented - AbstractExp")},getModelLoader:function(){console.error("Function not implemented - AbstractExp")},getScenarioManager:function(){console.error("Function not implemented - AbstractExp")},clearView:function(){this.notifScreen&&this.notifScreen.removeNotifications(),this.showSplashBetweenLoad&&this.playerSplashScreen&&(this.playerSplashScreen.showView(this.playerSplashScreen.views.loading),this.toggleSplash(!0))},showContextualMenu:function(e){this._enableCMenu=e},addCallbacks:function(e){i.addCallbacks(this.args.ctx,e)},publish:function(e,t){v.publish({event:"/"+this.args.ctx+"/"+e+"/",data:t})},subscribe:function(e,t,i){var n=v.subscribe({event:"/"+this.args.ctx+"/"+e+"/"},t);return i?(this.EventDisposer.add(n),null):n},subscribeOnce:function(e,t){var i=v.subscribe({event:"/"+this.args.ctx+"/"+e+"/"},function(){v.unsubscribe(i),t.apply(void 0,arguments)})},unsubscribe:function(e){return v.unsubscribe(e)}})}),define("DS/3DPlayUtils/TestBrowser",["DS/3DPlayUtils/BrowserSupportList","DS/WebSystem/DetectBrowser"],function(e,t){"use strict";return function(){var i,n=!1,r=document.createElement("canvas");try{(i=r.getContext("webgl"))&&(n=!0)}catch(e){}if(!i)try{(i=r.getContext("experimental-webgl"))&&(console.warn("experimental-webgl"),n=!0)}catch(e){}if(0==n)return BrowserSupport.none;if("undefined"==typeof Worker)return BrowserSupport.none;var o=t(),s=e[o.os.name];if(void 0!==s){var a=s[o.os.version];if(void 0===a&&(void 0===(a=s.default)||void 0!==a.version&&void 0!==a.version.isSupported&&!1!==a.version.isSupported(o.os.version)||(a=void 0)),void 0!==a){var l=a[o.browser.name];if(void 0!==l&&void 0!==l.isSupported)return l.isSupported(o.browser.version)}}return BrowserSupport.partial}}),define("DS/3DPlayExperienceModule/3DPlayExperience",["DS/3DPlay/3DPlay","DS/WebSystem/Environment","UWA/Core","DS/3DPlayExperienceModule/3DPlayAbstractExperience","DS/ApplicationFrame/CommandsManager","DS/3DPlay/3DPlayScenarioManager","DS/WebInfraUI/Notification","DS/WebUtils/StringUtils","DS/WebUtils/ContextedSingleton","DS/3DPlaySupport/SupportList","DS/3DPlaySupport/ExperiencesList","DS/3DPlaySupport/AssetSupport","DS/WebUtils/ProbesManager","DS/WebUtils/Statistics","DS/WebUtils/Tracker","DS/3DPlaySocialPanel/3DPlaySocialPanelManager","DS/WebSystem/App","DS/WebUtils/WebServices","DS/3DPlayExperienceModule/Tracker_Translation_Experience","DS/EditPropWidget/constants/EditPropConstants","i18n!DS/3DPlayExperienceModule/assets/nls/3DPlayExperienceModule","DS/WebSystem/SessionManager"],function(e,t,i,n,r,o,s,a,l,d,c,u,h,p,g,f,m,v,S,D,w,P){"use strict";return n.extend({init:function(i){if(this.detectPlatform(),this._parent(i),P.init({sessionKey:"3DPlay.Session",dataKey:"experience",ToCopy:["VisuViewSettings"],toMigrate:[{src:"3DPlay.scenarioActivated",dst:"Scenario"}]}),m.is3DPlay()&&(this.args.options.propertiesFacet=this.args.options.propertiesFacet||[],this.args.options.propertiesFacet.push(D.FACET_PROPERTIES),this.args.options.propertiesFacet.push(D.FACET_SWYMCOMMENTS),this.args.options.propertiesFacet.push(D.FACET_RELATIONS)),i.options.callback&&this.setOnAnnotationShared(i.options.callback.onAnnotationShared),void 0===i.commandApplication||!0===i.commandApplication){i.workbenchs=i.workbenchs||[],i.workbenchs.unshift({name:"3DPlay",module:"3DPlay"}),t.isSet("3DPlay.Session.AB")&&i.workbenchs.push({name:"3DPlayDebug",module:"3DPlayExperienceModule"});let e=this.useSession&&(m.is3DSwym()||m.is3DDrive()||m.is3DSpace()||m.is3DPlay())&&m.isOnCloud()&&!0!==this.share3DCommentHide;this._iOS?e?i.workbenchs.push({name:"3DPlayShareComment_iOS",module:"3DPlay"}):t.isSet("3DPlay.publishToMakeCmdActivate")?i.workbenchs.push({name:"3DPlayShare_iOSPublishToMake",module:"3DPlay"}):i.workbenchs.push({name:"3DPlayShare_iOS",module:"3DPlay"}):(e?i.workbenchs.push({name:"3DPlayShareComment",module:"3DPlay"}):t.isSet("3DPlay.publishToMakeCmdActivate")?i.workbenchs.push({name:"3DPlaySharePublishToMake",module:"3DPlay"}):i.workbenchs.push({name:"3DPlayShare",module:"3DPlay"}),t.isSet("3DPlay.Session.AB")&&i.workbenchs.push({name:"3DPlayDebug",module:"3DPlayExperienceModule"})),t.isSet("3DPlay.Activate3DComment")&&i.workbenchs.push({name:"3DPlayComment",module:"3DPlay"})}o.loadManager(this),this.ctx=this.args.ctx,this.modelLoadCount=0,this.modelTotalCount=0,this.modelLoadComplete=void 0,this.getPhaseProgress().setIndeterminateState(),this.getPhaseProgress().addProgressBarIntoUI(i.container);var n=this;this.disposeFunctions.add(function(){n=null}),this.onModelLoadingStarted=function(t){n.args.container.classList.toggle("3DPlayPO-Loading-Started");var i=n.args.input.asset;if(!n.onAnnotationShared&&i){var r,o=n.getInformationsOnAsset(i),s=i.serviceURL;"3DSWYM"===o.provider&&(r=i.swymServerToken),null==s?"3DSWYM"===o.provider&&v.getServiceUrl({serviceName:"3DSwym",platformId:o.tenant,onSuccess:function(e){var t=e;t&&(Array.isArray(t)&&(t=t[0]),t.url&&(s=t.url)),o.id&&o.tenant&&s&&n.createSocialPanel(o.id,o.tenant,s,o.provider)},onError:function(){}}):o.id&&o.tenant&&s&&n.createSocialPanel(o.id,o.tenant,s,o.provider,r)}n.modelLoadComplete=!1,n.publish("ASSET/LOADINGSTARTED",{data:n.modelName,ctx:n.args.ctx}),e.endAllCommands({ctx:n.args.ctx,resetDefaultCmd:!1}),!0===(void 0===t||t)&&(n.getPhaseProgress().setIndeterminateState(),n.getPhaseProgress().showProgressBar()),0===n.getPhaseProgress().getSubProgressDivisions()&&(n.subProgressID=n.getPhaseProgress().registerSubProgress()),n.noGeoTimO&&clearTimeout(n.noGeoTimO),n.noGeoInt&&clearInterval(n.noGeoInt)},this.onModelLoadingProgression=function(e){if(n){var t=e.currentProgressID||n.subProgressID;t?n.subProgressID!==t&&(n.subProgressID=t):t=n.subProgressID=n.getPhaseProgress().registerSubProgress(),void 0!==e.loaded&&void 0!==e.total&&0!==e.total&&(n.newPart=!0,n.modelLoadCount=e.loaded,n.modelTotalCount=e.total,n.getPhaseProgress().setAbsoluteProgress(t,Math.round(100*e.loaded/e.total)),n.publish("ASSET/LOADINGPROGRESS",{model:n.modelName,progress:e,ctx:n.ctx}))}},this.onModelLoadingCompleted=function(){if(n){n.args.container.classList.toggle("3DPlayPO-Loading-Complete"),n.args.container.classList.toggle("3DPlayPO-Loading-Started"),n._onModelLoadingCompleted&&n._onModelLoadingCompleted(),n.getPhaseProgress()&&(n.getPhaseProgress().advanceToMax(n.subProgressID),n.getPhaseProgress().resetProgress(),n.getPhaseProgress().hideProgressBar()),n.args.options.loading===loadingMode.preload&&(n.isLoaded=!0),n.toggleSplash(!1),n.modelLoadComplete=!0;var e=0;n.totalLoadingAssetProfiler&&(n.totalLoadingAssetProfiler.end(),e=Math.floor(n.totalLoadingAssetProfiler.getTime())),n.publish("ASSET/LOADINGFINISHED",{model:n.modelName,time:e,ctx:n.args.ctx,loadAssetInfo:n.loadAssetInfo});n.args.input.asset;if(n.stats&&setTimeout(function(){n.stats.UpdateProbes=!0,n.stats.postProcess()},2e3),t.isSet("3DPlay.zzPCS")){var i=window.top.document.createEvent("CustomEvent");i.initCustomEvent("3DPlay.zzPCS",!0,!1,require("DS/WebUtils/ProbesManager").GetProcessedData({topWindow:!0,cleanNames:!0,only3DPlay:!0})),window.top.document.dispatchEvent(i)}if(t.isSet("3DPlay.ConsolePCS")){var r=h.GetProcessedData({topWindow:!0,cleanNames:!0}),o={Timings:{},Memory:{},FIleStats:n.computeViewerStats()};r.sort(function(e,t){var i=e.startTime,n=t.startTime;return i<n?-1:i>n?1:0}),r.forEach(function(e){o.Timings[e.name]={startTime:e.startTime,duration:e.duration}}),require("DS/WebSystem/Downloader")("3DPlay.QAPCS.json",new Blob([JSON.stringify(o)],{type:"text/plain"}))}n.args.input.annotation&&n.loadAnnotations(n.args.input.annotation)}},t.isSet("3DPlay.Statistics")&&(this.stats=new p,this.stats.set({container:this.args.container}))},detectPlatform:function(){this._iOS=Boolean(navigator.platform)&&/iPad|iPhone|iPod/.test(navigator.platform)||Boolean(navigator.userAgent)&&/iPad|iPhone|iPod/.test(navigator.userAgent)||(/iPad|iPhone|iPod/.test(navigator.platform)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1)&&!window.MSStream,this._android=Boolean(navigator.userAgent)&&/Android/.test(navigator.userAgent)},comuteViewerStats:function(){return{}},getExperienceBase:function(){return this.experienceBase},getScenarioManager:function(){return o},loadScenario:function(){console.error("3DPlayExperience : Method Deprecated -> Use getScenarioManager Instead")},dispose:function(e){e&&e.clearSession&&P.clearSession(),this.sessionProbes&&(this.sessionProbes.end(),g.trackPageEvent("infos","3DPlay_session","duration",Math.floor(this.sessionProbes.getTime())/1e3));var t=l.get(this.args.ctx,"ANNOTATION_MANAGER");t&&(t.deleteAllAnnotations(),l.remove(this.args.ctx,"ANNOTATION_MANAGER")),o.dispose(),this.currentLoadingAssetProfiler&&(this.currentLoadingAssetProfiler.dispose&&this.currentLoadingAssetProfiler.dispose(),this.currentLoadingAssetProfiler=null);var i=require("DS/ApplicationFrame/AfrPlayerService");i&&(i._playerView={},i.hidePlayer(),i.registerPlayerContainer(void 0)),this._3dCommentPanel&&this._3dCommentPanel.dispose(),this._3dCommentPanel=void 0,this._parent(e),this.frmWindow&&(this.frmWindow.experience=null,this.frmWindow=null)},setOnLoadedCallback:function(){},setOnProgressCallback:function(){},step:function(){},_step:function(){this.stats&&this.stats.postProcess()},onPreCreate:function(){},onPostCreate:function(){},manageWorkBenchs:function(e){var i,n=e&&e.frameWindow?e.frameWindow:this.frmWindow,o=e.finishCallBack;if(this.actionBarReady=!1,n&&n.getActionBar()){var s=this;i=e.customWorkBench?e.customWorkBench:s.args.workbenchs;var a="none";e&&e.frameWindow&&e.frameWindow.experience&&e.frameWindow.experience.args&&e.frameWindow.experience.args.input&&e.frameWindow.experience.args.input.asset&&e.frameWindow.experience.args.input.asset.provider&&(a=e.frameWindow.experience.args.input.asset.provider);for(var d=i.length;d--;)!t.isSet("3DPlay.publishToMakeCmdActivate")||"FILE"!=a&&"3DDRIVE"!=a&&"3DSWYM"!=a?"3DPlayShare_iOSPublishToMake"==i[d].name?i[d].name="3DPlayShare_iOS":"3DPlaySharePublishToMake"==i[d].name&&(this.args.workbenchs[d].name="3DPlayShare"):s._iOS?"3DPlayShare_iOS"==i[d].name&&(i[d].name="3DPlayShare_iOSPublishToMake"):"3DPlayShare"==i[d].name&&(i[d].name="3DPlaySharePublishToMake");var c=function(t){var a,d;a=function(){var e;if(n&&n.experience&&n.experience.workbenchIndex>0&&s.actionBarProfile&&s.actionBarProfile.end(),void 0===s.workbenchIndex&&(s.workbenchIndex=0),s.workbenchIndex<i.length)e=i[s.workbenchIndex],s.actionBarProfile=h.createProbe("ActionBar_"+e.name),s.actionBarProfile.begin(),s.loadWorkbench(e,0!==s.workbenchIndex),s.workbenchIndex++;else{(e=i[i.length-1])&&e.defaultCommand&&(e.defaultCommand.context=s.args.ctx,r.setDefaultCommand(e.defaultCommand)),s.actionBarReady=!0,h.end("ActionBar_Ready"),void 0!==s.args.ui.onActionBarReady&&s.args.ui.onActionBarReady(),s.args.container.classList.toggle("3DPlayPO-Init-Ready"),s.args.options.helper||l.get(this.args.ctx,"helper");var c=r.getCommands(s.args.ctx);if(c)for(var u in c)c.hasOwnProperty(u)&&s.addScriptingFunction(c[u].getId(),function(e){return function(t){e[t||"begin"]()}}(c[u]),"Command "+c[u].getId(),void 0,void 0,s.trackScriptingFunction);if(c=r.getCommandCheckHeaders(s.args.ctx))for(var u in c)c.hasOwnProperty(u)&&s.addScriptingFunction(c[u]._id,function(e){return function(t){var i="begin"===(t||"begin");e.setState(i)}}(c[u]),"Command "+c[u]._id,void 0,void 0,s.trackScriptingFunction);s.play(),a=null,n._actionBar.removeCallback(d),o&&o(),t()}}.bind(s),d=n.onActionBarReady(a),(e.createActionBar||s.enopadInited)&&a&&a()};this.WKPromise?this.WKPromise.then(function(){s.WKPromise=new Promise(c)}):this.WKPromise=new Promise(c)}},updateMAB:function(e){var t=this.frmWindow.getActionBar();t&&t.MAB&&t.MAB.update(e)},resetScenarioMAB:function(e){var t=(e&&e.frameWindow?e.frameWindow:this.frmWindow).getActionBar();t&&t.MAB&&t.MAB.resetScenario()},loadWorkbench:function(e,t,i){if(this.frmWindow){var n=void 0!==t&&t;if(void 0!==e.name){var r=e.name,o=this.args.ctx;"xml"!==a.getExtension(e.name)&&(r+=".xml");var s=this.frmWindow.getActionBar();s&&(s.loadModel({context:o,file:r,module:e.module,merge:!0===n}),i&&s.MAB&&s.MAB.loadScenarioWb(i,t))}}},preCreate:function(){},postCreate:function(){},_loadAssets:function(e,t){var n=this;if(this.frmWindow&&this.frmWindow.getModelLoader){var r=this.frmWindow.getModelLoader();null!==t.convert&&void 0!==t.convert||(t.convert={});var o=[];if(t.convert.progressArray)o=o.concat(t.convert.progressArray);else{var s=t.convert.progressDivisions||e.asset.length;o=n.getPhaseProgress().registerMultipleSubProgress(s)}var a={modelLoaderonLoadedCB:r.onLoadedCB,proportion:t.convert.progressProportion||1/e.asset.length,array:[].concat(e.asset),experience:this,phaseprogress:t.convert.progress||n.getPhaseProgress(),progressArray:[].concat(o),currentProgressID:void 0,ctx:this.args.ctx,currentmodel:void 0,options:i.extend({},t),nbAssetDelayed:t.convert.nbAssetToConvert||0,isWaiting:!1,addNewFile:function(e){null!==e&&a.array.push(e),a.nbAssetDelayed=a.nbAssetDelayed-1,a.isWaiting&&(a.isWaiting=!1,a.processNextFile())},processNextFile:function(){if(void 0===this.currentmodel?void 0!==this.options.clearSceneGraph&&null!==this.options.clearSceneGraph||(this.options.clearSceneGraph=!0):(this.options.clearSceneGraph=!1,this.array.length),this.array.length>0){this.currentmodel=this.array.shift(),this.currentProgressID=this.progressArray.shift();var e=this.experience;e.updateConnection({asset:this.currentmodel},function(){e.loadAsset({asset:this.currentmodel},this.options,!1,this.profile),e=null}.bind(this))}else 0===a.nbAssetDelayed?(n.setOnLoadedCallback(this.experience.onModelLoadingCompleted),n.setOnProgressCallback(this.experience.onModelLoadingProgression),this.modelLoaderonLoadedCB()):a.isWaiting=!0},progress:function(e){e.currentProgressID=a.currentProgressID,this.experience.onModelLoadingProgression(e)}};return this.setOnLoadedCallback(function(){a.phaseprogress.advanceToMax(a.currentProgressID),a.processNextFile()}),this.setOnProgressCallback(function(e){a.progress(e)}),a.processNextFile(),a}},initExperienceBase:function(e,t){t&&t(0)},disposeExperienceBase:function(e){e&&e(0)},computeViewerStats:function(){return{}},initExperience:function(){if(this.onPreCreate(),this.preCreate(),this._postcreate=function(){this.createUIComponents(this.frmWindow),this.args.helpercb&&this.args.helpercb(this,this.args.ctx);var e=this.args.options.helper;e||(e=l.get(this.args.ctx,"helper")),e&&(e.instance=this,e.loaded=!0,e.SupportList=d,e.ExperiencesList=c,e.AssetSupport=u),this.addWidgetPreferences(),this.postCreate(),this.onPostCreate(),this.first=(new Date).getTime(),this.frmWindow.getActionBar()||this.publish("EXPERIENCE/EXPERIENCEREADY",this),this.fromTransition()||this.args.input&&this.args.input.asset&&(this.args.options.loading===loadingMode.preload||this.args.options.splashscreen&&this.args.options.splashscreen.waitloading||this.toggleSplash(!1),this.totalLoadingAssetProfiler=h.createProbe("_Load_"),this.totalLoadingAssetProfiler.begin(),this.waitingCammandsForLoad=this.waitingCammandsForLoad||[],Promise.all(this.waitingCammandsForLoad).then(function(){this.load(this.args.input,this.args.options)}.bind(this)))},this.frmWindow)this.createDom(void 0,this._postcreate),this._postcreate();else{var e=this,t=this.args.input.experience.filename||this.args.input.experience;this.subscribeOnce("EXPERIENCE/EXPERIENCEREADY",function(){e.sessionProbes=h.createProbe("session_duration"),e.sessionProbes.begin(),setTimeout(function(){var e=h._parse("ExperienceReady");e.end();var i=e.getTime(),n=h.GetSubProbesFrom(e,!1);n.Experience_Ready=i,g.trackPageEvent("experience","ExperienceReady",t,Math.floor(e.getTime()),n,void 0,S.experience)},100),e.stats&&(e.stats.probesDone=!1,e.stats.postProcess()),e=null}),this.subscribe("ASSET/LOADINGFINISHED",function(e){this.args.input&&this.args.input.asset&&"ENOPAD"!==this.currentProvider&&this._sendStats(!0)}.bind(this),!0),this.subscribe("ASSET/LOADINGSTARTED",function(e){e&&!e.refreshed&&(this._sendStats(!1),g.resetCommandCounter())}.bind(this),!0),this.createDom(this.args.FrameWindow,this._postcreate),this.frmWindow&&(this.frmWindow.experience=this)}},_sendStats:function(e){var t=this.getInformationsOnAsset();if(t)if(e)try{var n=h.GetSubProbesFrom(this.totalLoadingAssetProfiler,!1);n=i.extend(n,this.computeViewerStats()),g.trackPageEvent("asset",t.type,t.provider,this.totalLoadingAssetProfiler.getTime(),n,void 0,S.asset)}catch(e){}else g.trackPageEvent("infos","asset_type",t.type),g.trackPageEvent("infos","asset_source",t.provider),g.trackPageEvent("infos","tenant",t.tenant),t.source&&g.trackPageEvent("infos","drop_source",t.source)},loadAnnotations:function(e,t){if(1==this.modelLoadComplete)this._loadAnnotations(e,t);else{var i=this;this.subscribeOnce("ASSET/LOADINGFINISHED/",function(){i._loadAnnotations(e,t)})}},_loadAnnotations:function(e,t){var i=l.get(this.args.ctx,"ANNOTATION_MANAGER");if(i){var n=new FileReader;n.addEventListener("loadend",function(e){var n;try{n=JSON.parse(e.srcElement.result)}catch(e){}n&&n.experience?P.restoreSession(n):i.drawAnnotationsFromJSON(e.srcElement.result,t),null}),n.readAsText(e)}},createSocialPanel:function(e,i,n,r,o){t.isSet("3DPlay.Activate3DComment")&&(this._3dCommentPanel&&this._3dCommentPanel.dispose(),this._3dCommentPanel=void 0,e&&e&&n&&(this._3dCommentPanel=new f({frameWindow:this.frmWindow,assetId:e,tenantId:i,serviceUrl:n,assetProvider:r,serverToken:o,onCommentClick:function(e){e.data&&e.data.annotationFile&&this.loadAnnotations(e.data.annotationFile,!0)}.bind(this)})))},createComment:function(e){return!!this._3dCommentPanel&&(this._3dCommentPanel.postComment(e.annotation,e.screenshot),this._3dCommentPanel.show())},hideSocialPanel:function(){return!!this._3dCommentPanel&&this._3dCommentPanel.hide()},setOnAnnotationShared:function(e){this._3dCommentPanel&&this._3dCommentPanel.dispose(),this._3dCommentPanel=void 0,this.onAnnotationShared=e}})});var enopad=[];"false"!==window.localStorage["3DPlay.pad3DViewer"]&&(enopad.push("DS/ENOPAD3DViewer/PAD3DViewer"),enopad.push("DS/PADUtils/PADUtilsServices")),define("DS/3DPlayExperienceModule/PlayExperience3D",["DS/WebappsUtils/WebappsUtils","DS/3DPlay/3DPlay","DS/WebSystem/Environment","UWA/Core","DS/3DPlayExperienceModule/3DPlayExperience","DS/ApplicationFrame/CommandsManager","DS/WebUtils/Profiler","DS/3DPlayUtils/PanelManager","DS/3DPlayUtils/TestBrowser","DS/Visualization/Node3D","DS/Visualization/WorldOrientation","DS/WebUtils/StringUtils","DS/WebUtils/ContextedSingleton","DS/WebSystem/Nls","DS/Visualization/ModelLoader","DS/Visualization/ThreeJS_DS","DS/WebInfraUI/Notification","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/WebViewer/SceneGraphHelper","css!DS/3DPlayExperienceModule/assets/PlayExperience3D","DS/WebUtils/ProbesManager","i18n!DS/3DPlayHelper/assets/nls/SplashScreen","UWA/Promise","DS/WebRunloop/Runloop","DS/WebUtils/Tracker","DS/WebUtils/Network","DS/VisuTools/StatsComputer","i18n!DS/3DPlayExperienceModule/assets/nls/3DPlayExperienceModule","DS/3DPlayExperienceModule/PlayExperience3DScriptingPlugin","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/Controls/ProgressBar","DS/UIKIT/Tooltip","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","i18n!DS/PADUtils/assets/nls/PADUtils","DS/3DPlaySupport/ExperiencesList","DS/PADUtils/PADSettingsMgt","DS/ApplicationFrame/FrameWindow3D","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/WebSystem/Preference","DS/WebSystem/App","DS/Selection/CSOManager","DS/WebInfraUI/ConfirmBox","i18n!DS/3DPlayCommands/assets/nls/CmdENOPADStream","DS/PADUtils/PADSharedSettings","i18n!DS/3DPlay/assets/nls/3DPlay","DS/WebUtils/Logger","DS/WebSystem/SessionManager","DS/DMU3DPlayAPIWeb/DMUMeasureSectionExportImportAPI"].concat(enopad),function(WebappsUtils,_3DPlay,Environment,UWA,EXPERIENCE,CommandsManager,Profiler,PanelManager,TestBrowser,Node3D,WorldOrientation,StringUtils,ContextedSingleton,NLS,ModelLoader,THREE,Notification,SceneGraphOverrideSet,SceneGraphHelper,Css,ProbesManager,SplashScreenNLS,UWAPromise,Runloop,Tracker,Network,StatsComputer,prefs,PlayExperience3DScriptingPlugin,VisuEventsManager,WUXEvent,WUXProgressBar,Tooltip,NLSPAD3DViewer,NLSPADUtuils,ExperiencesList,PADSettingsMgt,FrameWindow3D,PAD3DViewerModelServices,Preference,App,CSOManager,ConfirmBox,CmdENOPADStreamNLS,PADSharedSettings,NLS3DPlay,Logger,SessionManager,DMUMeasureSectionExportImportAPI,ENOPAD3DViewer,PADUtilsServices){"use strict";var VCXExperienceBase,DMUContextManager,req=["DS/VCXWebExperienceBase/VCXExperienceBase"];req=req.concat(["DS/DMUBaseExperience/DMUContextManager"]);var requirePromise=new UWAPromise(function(e){require(req,function(t,i){VCXExperienceBase=t,DMUContextManager=i,e()})}),logger=Logger("3DPlay.PlayExperience3D"),endEdit,prefName="3DPlay.CGRPolicy",visuModeOptions={MaterialMode:{needCGR:!0,needMaterial:!0},Illustration:{needCGR:!0,needMeshInRam:!0},Edges:{needCGR:!0},AxisFilter:{needCGR:!0},PlanesFilter:{needCGR:!0},LinesFilter:{needCGR:!0},PointsFilter:{needCGR:!0}},ControlerKey="3DPlay.Controller.Configuration",internalLoad=function(e){return Preference.getObject(ControlerKey)},internalSave=function(e,t){var i=internalLoad();i[e]=t,Preference.setObject(ControlerKey,i)},saveControlerConfiguration=function(e,t,i){let n=loadControlerConfiguration(e);t&&Object.keys(t).forEach(e=>{n[e]=void 0!==i?i:t[e]}),internalSave(e,n),logger.log("SaveConfiguration["+e+"]",n)},loadControlerConfiguration=function(e){let t=internalLoad();return t[e]||(t[e]={}),t=t[e],logger.log("LoadConfiguration["+e+"]",t),t};return EXPERIENCE.extend({name:"PlayExperience3D",refresh:function(e){return!this.acceptRefresh()||"ENOPAD"===this.currentProvider&&(this.pad3DViewer&&this.pad3DViewer.getRoots().length>0&&(this._materialModeChanged?(this.pad3DViewer.getController().refreshForMaterials(),this._materialModeChanged=!1):(e||this.changeVisuSettingIfPossible(),this.pad3DViewer.refresh())),!0)},acceptSwitch:function(){var e=!1,t=this.args.input.asset;return Array.isArray(t)&&(t=t[0]),null==t?e=!0:t.provider&&(e="FILE"!==t.provider),e},_onModelLoadingCompleted:function(){this.loadingAsset.Load_Session&&this.loadingAsset.Load_Session.end()},computeViewerStats:function(){var e=new StatsComputer(this.frmWindow.getViewer()),t=e.computeStats();if(t){t.DownloadSize=Math.floor(this.loadingAsset.size/1e3),e.viewer=null,e=null}return t},createScriptingAPI:function(){this._parent();var e=this.args.options.helper||ContextedSingleton.get(this.args.ctx,"helper");e&&PlayExperience3DScriptingPlugin(e,this)},init:function(options){if(options&&options.options&&options.options.NR&&!0===options.options.NR.active){var moduleNR="DS/3DPlayWebNRTools/NRModeManager";require([moduleNR],function(e){logger.log("NRModeManager call completed in DefaultExp"),_this.NRMgr=new e({frmWindow:_this.frmWindow})}),!0===Environment.isSet("3DPlay.NRPrototype.DebugCmd")&&(options.workbenchs=options.workbenchs||[],options.workbenchs.unshift({name:"3DPlayNRExperience",module:"3DPlayNRExperience"}))}var wkbName;(Environment.isSet("3DPlay.publishToMakeCmdTest")&&options&&options.input&&options.input.asset&&options.input.asset.provider&&("FILE"===options.input.asset.provider||"3DDRIVE"===options.input.asset.provider||"3DSWYM"===options.input.asset.provider)?Environment.set("3DPlay.publishToMakeCmdActivate","true"):Environment.remove("3DPlay.publishToMakeCmdActivate"),this.evtTokenMouse=[],void 0===VisuEventsManager._isInit&&VisuEventsManager.init(),this.reframeConfiguration={},this.noGeoTimO="timeout",this.noGeoInt="interval",this.loadingAsset={size:0},this.pad3DViewerTokens=[],options=options||{},this.useExperienceBase=!0,options.input&&options.input.experience&&("DS/VCXWebComposer3DPlayExperience/VCXWebPlayerIn3DPlayExperience"===options.input.experience.filename||"DS/XCT3DPlayIntegratability/XCT3DPlayIntegratability"===options.input.experience.filename)&&(this.useExperienceBase=!1),options.workbenchs=options.workbenchs||[],void 0===options.commandApplication||!0===options.commandApplication)&&(wkbName=this._iOS||this._android?"3DPlayExperience3D_mobile":"3DPlayExperience3D",options.workbenchs.unshift({name:wkbName,module:"3DPlay"}),App.is3DPlay()&&options.workbenchs.push({name:"EnopadRightPanel",module:"3DPlay"}),Environment.isSet("3DPlay.VisuPanel")&&options.workbenchs.push({name:"3DPlayVisuPanel",module:"3DPlayExperienceModule"}));function isLoadAnimationValid(val){return"Full"===val||"None"===val||"Optimized"===val||!isNaN(val)&&eval(val)>=0&&eval(val)%1==0}var EnvLoadAnimation=Environment.get("3DPlay.LoadAnimation");isNaN(EnvLoadAnimation)||(EnvLoadAnimation=eval(EnvLoadAnimation)),isLoadAnimationValid(EnvLoadAnimation)?options.options.loadAnimation=EnvLoadAnimation:!1===isLoadAnimationValid(options.options.loadAnimation)&&(options.options.loadAnimation="Optimized"),this._parent(options),this.modelLoadCount=0,this.modelTotalCount=0,this.modelLoadComplete=void 0,this.showSplashBetweenLoad=!1,NLS.loadNls("Visualization/3DXML_errors");var _this=this,hideRefAxisCount=0;this.hideRefAxis=function(){if(++hideRefAxisCount>0&&_this&&_this.frmWindow){var e=_this.frmWindow.getViewer();e&&e.setReferenceAxisSystem&&(e.setReferenceAxisSystem(!1),e.render())}},this.showRefAxis=function(){if(0===(hideRefAxisCount=Math.max(0,hideRefAxisCount-1))&&_this&&_this.frmWindow){var e=_this.frmWindow.getViewer();e&&e.setReferenceAxisSystem&&(e.setReferenceAxisSystem(!0),e.render())}};var phaseProgress=this.getPhaseProgress(),ctx=_this.args.ctx,viewpoint,viewer,frmWindow;this.onModelLoadingError=function(e){if(_this.hadLoadingError=!0,void 0!==e.rsc)NLS.nls(e.rsc,e.type,function(t){e.text&&(t+=e.text),_3DPlay.sendEvent(ctx,eventType.notif,e.level,{msg:t}),e.abort&&phaseProgress.hideProgressBar()});else if(void 0!==e.nls&&null!==e.nls){"Convert_SERVICE_NOT_FOUND"===e.type&&(_this.hasConvertFailed?e.level=Notification.fatal:_this.hasConvertFailed=!0);var t=NLS3DPlay[e.nls]+(e.text?e.text:"");_3DPlay.sendEvent(ctx,eventType.notif,e.level,{msg:t}),e.abort&&phaseProgress.hideProgressBar()}else NLS.nls("Visualization/3DXML_errors","ERROR_"+e.type,function(t){var i;"FORMAT"===e.type?(i=NLS3DPlay.LoadingError_FORMAT+":"+StringUtils.getExtension(e.url),_this=!1,_3DPlay.displayFatalError({ctx:ctx,msg:i})):"NO_GEOMETRY"===e.type?(_3DPlay.displayNotification({ctx:ctx,msg:t}),phaseProgress.hideProgressBar()):(i=t+" : "+e.url,_3DPlay.sendEvent(ctx,eventType.notif,Notification.error,{msg:t}),phaseProgress.hideProgressBar()),void 0!==i&&logger.error(i)});_this&&_this.publish("ASSET/LOADINGERROR",UWA.extend({ctx:ctx},e))},this.onSelectCallback=function(e){var t=!1,i=CommandsManager.getCommands(_this.frmWindow.experience.ctx);if(i){for(var n=Object.keys(i),r=0;r<n.length;r++){var o=n[r];if("myDefaultCmd"!==o){var s=i[o];if(s&&s.isRunning()){t=!0;break}}}if(!1===t&&_this.frmWindow.getViewerFrame().offsetHeight>240&&_this.frmWindow.getViewerFrame().offsetWidth>240){var a=CSOManager.get(),l=!1;if(1===a.length){var d=a[0].pathElement||a[0];if(d&&d.externalPath)for(r=0;r<d.externalPath.length;r++)if("annotGroupNode"===d.externalPath[r].name){l=!0;break}}if(!0===l){var c=d.externalPath[d.externalPath.length-1].annotID,u=ContextedSingleton.get(_this.frmWindow.experience.ctx,"ANNOTATION_MANAGER");if(u){var h=u.getAnnotationTypeWithID(c),p=_this.frmWindow.getViewer(),g=_this.frmWindow.experience.ctx;if("text"===h)p.shapeEditionData={id:c},CommandsManager.getCommands(g).AnnotationCommand3DText&&CommandsManager.getCommands(g).AnnotationCommand3DText.isEnabled()&&CommandsManager.getCommands(g).AnnotationCommand3DText.begin();else{var f={x:e.event._currentPosition.x,y:e.event._currentPosition.y};p.shapeEditionData={point:f},CommandsManager.getCommands(g).AnnotationCommand3DEditShape&&CommandsManager.getCommands(g).AnnotationCommand3DEditShape.isEnabled()&&CommandsManager.getCommands(g).AnnotationCommand3DEditShape.begin()}}}}}},this.countRender=0,this.countBeforeRender=1,this.modelPrevLoadCount=0,this.renderTime=0,this.postCreate=function(){var e,t=this.args;t&&t.visu&&!0!==t.visu.showReferenceAxisSystem&&hideRefAxisCount++,(viewpoint=this.frmWindow.getViewer().currentViewpoint)&&(viewpoint.control.lockZ=!0,viewpoint.control.setRotationSpeed(3.5)),viewer=this.frmWindow.getViewer();try{e=this.pad3DViewer?this.getRootBag():null}catch(e){}if(frmWindow=this.frmWindow,null===e&&(this.rootbag=new Node3D("RootBag"),viewer.addNode(this.rootbag),e=this.rootbag),this.modelLoader=new ModelLoader({node:e,viewer:viewer}),"DS/3DPlayModelViewer/3DPlayModelViewer"===this.args.input.experience.filneame&&this.modelLoader.setNoMeshInRAM(!0),this.modelLoader.setViewer&&this.modelLoader.setViewer(viewer),t.modelLoader&&void 0!==t.modelLoader.readDecoration&&(this.modelLoader.readDecoration=t.modelLoader.readDecoration),this.modelLoader.setOnProgressCallback(this.onModelLoadingProgression),this.modelLoader.setOnLoadedCallback(this.onModelLoadingCompleted),this.modelLoader.setOnErrorCallback(this.onModelLoadingError),this.token=CSOManager.onAdd(this.onSelectCallback),this.pad3DViewer.getController()._BIProxy.addEvent("ApplyNGFilter",function(){try{Tracker.trackPageEvent("interactions","6wTags",this.experience.getInformationsOnAsset().type)}catch(e){}this.onModelLoadingStarted(!1)},this),this.isFromTransition||(viewer.restoreAmbiance(),viewer.restoreProjectionMode(),this.args.workbenchs&&!this.args.workbenchs.some(function(e){return"3DPlayExperience3D"===e.name})&&(viewer.restoreVisualizationMode({materialMode:!0,renderFaceMode:THREE.ShowAllFaces,renderLineMode:THREE.ShowAllRenderLineMode,displayHiddenEdges:0}),viewer.setMaterialMode(!0),viewer.setRenderMode("BoundaryPoint",!0),viewer.setRenderMode("SharpPoint",!0),viewer.setRenderMode("FreePoint",!0),viewer.setRenderMode("SurfacicPoint",!1),viewer.setRenderMode("@InternalEdge",!0),viewer.setRenderMode("@Edge",!0),viewer.displayPoints(!0))),viewer.getBagNode=function(){return logger.error("Please use 3DPlayExperience.getRootBag() rathen the Viewer.getBagNode()"),this.getRootBag()}.bind(this),viewer.deleteSceneGraphState=function(e){var t=this.getSceneGraphOverrideSetManager();if(t)for(var i=t.getNumberOfSceneGraphOverrideSets();i--;){var n=t.getSceneGraphOverrideSetAt(i);n&&n.privateName===e&&(t.removeSceneGraphOverrideSetAt(i),n.helper&&(n.helper.dispose(),n.helper=null),n.dispose&&n.dispose())}},viewer.getSceneGraph=function(e){var t=this.getSceneGraphOverrideSetManager();if(t)for(var i=t.getNumberOfSceneGraphOverrideSets();i--;){var n=t.getSceneGraphOverrideSetAt(i);if(n&&n.helper&&n.helper.name===e)return n.helper}return null},viewer.createSceneGraph=function(e,t){var i=this.getSceneGraph(e);if(void 0===t&&(t=this.getBagNode()),!i&&t){var n=new SceneGraphOverrideSet(t),r=this.getSceneGraphOverrideSetManager();r&&r.pushSceneGraphOverrideSet(n)&&(i=n.helper=new SceneGraphHelper(n,e))}return i},this.EventDisposer.add(this.subscribe("ASSET/CHANGE",function(e){_this.reframeConfiguration.hasViewpointSet=!1,SessionManager.clearSession()})),this.EventDisposer.add(this.subscribe("ASSET/LOADINGFINISHED",function(t){if(_this&&ExperiencesList.is3DPlay3DExperience(_this)){if(_this.modelFailure){try{var i=_this.getInformationsOnAsset();Tracker.trackPageEvent("errors","no_access",i.type)}catch(e){}_3DPlay.displayNotification({ctx:t.ctx,msg:NLS3DPlay.LoadingDocument404})}else if(0===_this.getRootBag().getBoundingSphere().radius&&"FILE"===_this.currentProvider&&!_this.hadLoadingError){try{i=_this.getInformationsOnAsset();Tracker.trackPageEvent("errors","input_no_geometry",i.type)}catch(e){}_3DPlay.sendEvent(_this.ctx,eventType.notif,Notification.warning,{msg:NLS3DPlay.LoadingError_NO_GEOMETRY})}var n=e.getChildByName("AxisSystems");n&&(void 0===frmWindow.hello?(frmWindow.hello=!0,n.setVisibility(!0)):n.setVisibility(frmWindow.hello));var r=_this.args.input.annotData;r&&Environment.get("3DPlay.PersistedAnnotationsEnabled")&&setTimeout(function(){_this._annotationManager=ContextedSingleton.get(ctx,"ANNOTATION_MANAGER"),_this._annotationManager&&_this._annotationManager.drawAnnotationsFromJSON(r)},200)}})),this.autoReframe=!0,this.useSession){this.reframeConfiguration.viewpointCB=function(e){SessionManager.setSessionEntry("viewpoint",e)},this.waitingCammandsForLoad=this.waitingCammandsForLoad||[],this.waitingCammandsForLoad.push(new Promise(function(e){this.subscribe("COMMAND/READY/ANNONATIONTOUR",e)}.bind(this)));var i=function(){var e=ContextedSingleton.get(this.args.ctx,"ANNOTATION_MANAGER");e&&SessionManager.isReady()&&SessionManager.setSessionEntry("annotations",e.saveAnnotationsToJSON(void 0,!0))}.bind(this);this.subscribe("3DPLAY/ANNONATION/ADD",i,!0),this.subscribe("3DPLAY/ANNONATION/REMOVE",i,!0),this.subscribe("3DPLAY/ANNONATION/NOTINSESSION",function(){SessionManager.setSessionEntry("annotations",void 0)},!0);var n=this;async function r(e){if(SessionManager.isReady()&&(_this&&e&&"DMUSection"===e.dmuObject.getType()||"DMUMeasure"===e.dmuObject.getType()&&!e.dmuObject._isInCreationState)){let e=new DMUMeasureSectionExportImportAPI({ctxViewer:_this.pad3DViewer}),t=await e.exportModel();t?SessionManager.setSessionEntry("DMU",t):console.error("error exportModel NULL")}}this.disposeFunctions.add(function(){n=null}),SessionManager.register({key:"annotations",readCB:function(e,t,i){ContextedSingleton.get(n.args.ctx,"ANNOTATION_MANAGER").drawAnnotationsFromJSON(e,!0),i()}}),Tracker.pause(!0),this.addViewpointChangeCB(this.reframeConfiguration.viewpointCB),Tracker.pause(!1),SessionManager.register({key:"viewpoint",readCB:function(e,t,i){_this.autoReframe=!1,_this.reframeConfiguration.hasViewpointSet=!0,_this.setCurrentViewpoint(e),_this.frmWindow.getViewer().animate(),setTimeout(i,20)}}),SessionManager.register({key:"VisuViewSettings",readCB:function(e,t,i){viewer.applyViewPanelSettings(e),i&&i()}}),SessionManager.register({key:"DMU",readCB:function(e,t,i){new DMUMeasureSectionExportImportAPI({ctxViewer:_this.pad3DViewer}).importModel(e),i&&i()}});var o=DMUContextManager.getEventsController({context:this.pad3DViewer});o&&(this.DMUTokens=[o.addEvent("onDMUObjectInitialized",r)],this.DMUTokens.push(o.addEvent("onDMUObjectDeleted",r)),this.disposeFunctions.add(function(){_this.DMUTokens.forEach(e=>{o.removeEvent(e)}),_this.DMUTokens=[],o=null}))}this.EventDisposer.add(this.subscribe("ASSET/LOADINGSTARTED",function(){_this.hadLoadingError=!1,_this.modelFailure=!1,_this.oldradius=0,_this.autoReframe=!_this.reframeConfiguration.hasViewpointSet,_this.reframeConfiguration.userclicked=!1}));this.addCallbacks({asset:{LoadingFinished:function(){_this.autoReframe&&viewpoint.reframe(void 0,0),viewer.render()}}});var s=function(){_this.autoReframe=!1,_this.reframeConfiguration.userclicked=!0};this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onLeftMouseDown",s)),this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onRightMouseDown",s)),this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onMiddleMouseDown",s)),this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onMouseWheel",s)),this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onTouch",s)),this.PanelManager.createTopMenu({ctx:t.ctx,container:this.frmWindow.getUIFrame(),experience:this,showBubbleMenu:this.args.options.showBubbleMenu}),this.PanelManager.createDefaultHelp(),this.disposeFunctions.add(function(){s=null})},this.disposeFunctions.add(function(){frmWindow=null,viewpoint=null,viewer=null,_this=null})},initExperienceBase:function(e,t){this.frmWindow._experienceBase=e,t&&t(0)},requestNewExperienceBase:function(){this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null),this.experienceBase&&(this.disposeExperienceBase(),this.experienceBase._ManagerSet.unInitialize(),this.experienceBase.Clean(),this.frmWindow._experienceBase=null,this.experienceBase.webApplication=null,this.experienceBase.modelLoader=null,this.experienceBase=null),this.experienceBase=new VCXExperienceBase(null),this.experienceBase.webApplication=this,this.frmWindow._experienceBase=this.experienceBase,this.initExperienceBase(this.experienceBase),this.experienceBase._ManagerSet.initialize();var e=this.experienceBase._ManagerSet.getManager("VCXContextManager");return e&&e.setFrameWindow(this.frmWindow),this.experienceBase._ManagerSet.postInitialize(),e&&e.setRootNode(this.getRootBag()),this.profileFrame=Profiler.start("Runloop"),this.runloop=new Runloop({data:this,func:this.runloopFunc}),this.runloop.start(),this.experienceBase.webApplication=this,this.experienceBase},requestNewExperienceBaseAsync:function(){var e=this,t=UWA.Promise.resolve().then(function(){return e.runloop&&(e.runloop.stop(),e.runloop.dispose(),e.runloop=null),e.experienceBase&&e.disposeExperienceBase()}).then(function(){return e.experienceBase&&e.experienceBase._ManagerSet&&e.experienceBase._ManagerSet.unInitialize(!0)}).then(function(){return e.experienceBase&&(e.experienceBase.Clean(),e.experienceBase.webApplication=null,e.experienceBase=null),e.experienceBase=new VCXExperienceBase(null),e.frmWindow._experienceBase=e.experienceBase,e.experienceBase.requestPromise=t,e.experienceBase.initialize&&e.experienceBase.initialize(e)}).then(function(){return e.experienceBase.webApplication=e,new UWA.Promise(function(t,i){e.initExperienceBase(e.experienceBase,t)})}).then(function(){return e.experienceBase._ManagerSet.initialize(!0)}).then(function(){var t=e.experienceBase._ManagerSet.getManager("VCXContextManager");if(t){t.setFrameWindow(e.frmWindow);var i=e.getRootBag();t.setRootNode(i),e.frmWindow.getViewer().addNode(i)}return e.experienceBase._ManagerSet.postInitialize(!0)}).then(function(){return e.profileFrame=Profiler.start("webApplication::frame"),e.runloop=new Runloop({data:e,func:e.runloopFunc}),e.runloop.start(),e.experienceBase});return t},runloopFunc:function(e){this.profileFrame.start();var t=this.experienceBase._ManagerSet.getManager("VCXContextManager"),i=UWA.extend({viewer:this.frmWindow.getViewer()},e,!0),n=this.profileFrame.addProfile("3DPlay::Step");if(this.skipRender=!1,this._step.apply(this,[arguments[0].time,arguments[0].profiler]),n.stop(),i.profiler=this.profileFrame.addProfile("managerSet::update"),this.experienceBase._ManagerSet.update(i),this.skipRender)this.skipRender=!1;else{var r=this;t.applyToViewers(function(e){e._modelEvent&&!e.registredCBs&&(e.registredCBs={preToken:e._modelEvent.subscribe({event:"PreRender"},function(e){e.profiler=r.profile_animate.addProfile("preRender"),r.experienceBase._ManagerSet.preRender(e),r.profile_render=r.profile_animate.addProfile("render")}),postToken:e._modelEvent.subscribe({event:"PostRender"},function(e){e.renderingTime=r.profile_render.stop(),e.profiler=r.profile_animate.addProfile("postRender"),r.experienceBase._ManagerSet.postRender(e)})},e.defaultAnimationLoop=!1,r.disposeFunctions.add(function(){r=null})),r.profile_animate=r.profileFrame.addProfile("viewer["+e.id+"]::animate"),e.animate(),r.profile_animate.stop()}),this.nbrender=this.nbrender||0,this.nbrender++}i.viewer=this.viewer?t.getMainViewer():null,i.profiler=this.profileFrame.addProfile("managerSet::postUpdate"),this.experienceBase._ManagerSet.postUpdate(i),this.profileFrame.stop()},dispose:function(e){if(this.removeViewpointChangeCB(this.reframeConfiguration.viewpointCB),CSOManager.unsubscribe(this.token),this.token=null,this.evtTokenMouse&&(this.evtTokenMouse.forEach(function(e){VisuEventsManager.removeEventFromToken(e)}),this.evtTokenMouse=void 0),this.noGeoTimO&&clearTimeout(this.noGeoTimO),this.noGeoInt&&clearInterval(this.noGeoInt),endEdit&&App.isInWidget()&&widget.removeEvent("endEdit",endEdit),this.stats&&(this.stats.dispose&&this.stats.dispose(),this.stats=null),_3DPlay.endAllCommands({ctx:this.ctx,resetDefaultCmd:!0}),this.publish("EXPERIENCE/DISPOSE",{exprience:this}),this.intervalTimer&&clearInterval(this.intervalTimer),this.modelLoader.abort(),this.modelLoader.dispose&&this.modelLoader.dispose(),this.modelLoader=null,this.pad3DViewer){this.deletePad3DViewerCBs();var t=!1;if(!0!==(e=e||{}).disposeFrameWindow&&void 0!==e.disposeFrameWindow||(t=!0,e.disposeFrameWindow=!1),!1===e.disposeFrameWindow&&this.experienceBase&&this.experienceBase._ManagerSet){var i=this.experienceBase._ManagerSet.getManager("VCXContextManager");i&&(i._nRootNode=null)}var n=this.frmWindow.getViewer();if(this.viewerVisuModeCB.forEach(e=>{n.unsubscribe(e)}),delete this.viewerVisuModeCB,n.deleteSceneGraphState=null,n.getSceneGraph=null,n.createSceneGraph=null,n.getBagNode=null,this.experienceBase){this.frmWindow._experienceBase=null;var r=this;this.disposeExperienceBase(function(){r.runloop&&(r.runloop.stop(),r.runloop.dispose(),r.runloop=null);var e=r.experienceBase&&r.experienceBase._ManagerSet&&r.experienceBase._ManagerSet.unInitialize();e||(e=new UWAPromise(function(e){e()})),e.then(function(){r.experienceBase._ManagerSet.getManager("VCXContextManager").applyToViewers(function(e){e.registredCBs&&(e.defaultAnimationLoop=!0,e.disposed||(e._modelEvent.unsubscribe(e.registredCBs.preToken),e._modelEvent.unsubscribe(e.registredCBs.postToken)),delete e.registredCBs,e.animate())}),r.experienceBase&&(r.experienceBase.Clean(),r.experienceBase.webApplication=null,r.experienceBase=null),r=null})})}if(this.pad3DViewerConfig.changeVisuModeCmdAvailability&&(this.pad3DViewer.changeVisuModeCmdAvailability=null,this.pad3DViewer.changeVisuModeCmdAvailability=this.pad3DViewerConfig.changeVisuModeCmdAvailability,this.pad3DViewerConfig.changeVisuModeCmdAvailability=null),this._parent(e),t){if(this.pad3DViewer){var o=this.pad3DViewer.getFrameWindow();o&&o.removeReviewModel&&o.removeReviewModel();try{this.pad3DViewer.getController()._BIProxy._biFilter.die()}catch(e){}this.pad3DViewer.destroy(),o._viewpoint=null,o._sceneGraphTree=null,o._private_sceneGraph=null,this.repLoadingStuff&&(this.repLoadingStuff.hide(),this.repLoadingStuff.parentNode.removeChild(this.repLoadingStuff),this.repLoadingStuff=null)}}else{this.resetWidgetPreferences(),n.setPicking(this.pad3DViewerConfig.picking),n.setPrePicking(this.pad3DViewerConfig.pPicking),this.pad3DViewer.getFrameWindow().getViewer().currentViewpoint.setDefaultController(!0,this.pad3DViewerConfig.ControlMode),this.pad3DViewer.setRobotVisibility(this.pad3DViewerConfig.Robot),this.pad3DViewer.setDefaultProgressBarVisibility(this.pad3DViewerConfig.Progress),this.pad3DViewer.setAutomaticReframePolicy(this.pad3DViewerConfig.Reframe),this.pad3DViewer.setDefaultContextualMenuVisibility(this.pad3DViewerConfig.Menu),this.pad3DViewer.setDefaultContextualBarVisibility(this.pad3DViewerConfig.Bar),this.RuntimeMode.dynamicRepLoading&&(this.repLoadingStuff.hide(),this.repLoadingStuff.parentNode.removeChild(this.repLoadingStuff),this.repLoadingStuff=null),this.pad3DViewer.elements.container.addEventListener("dragenter",this.pad3DViewer._dndCB[0]),this.pad3DViewer.elements.container.addEventListener("dragover",this.pad3DViewer._dndCB[0]),this.pad3DViewer.elements.container.addEventListener("dragleave",this.pad3DViewer._dndCB[1]),this.pad3DViewer.elements.container.addEventListener("dragend",this.pad3DViewer._dndCB[1]),this.pad3DViewer.elements.container.addEventListener("drop",this.pad3DViewer._dndCB[2]),this.pad3DViewerConfig.toShow();var s=this.getRootBag();(s&&s.children&&s.children.length>0||this.pad3DViewer.getRoots().length>0)&&this.pad3DViewer._dropZoneContainer.elements.container.hide(),this.pad3DViewer._dropZoneContainer.options.mode=this.pad3DViewerConfig.DropMode}this.pad3DViewerConfig=null,this.pad3DViewer=null}else this._parent(e)},preCreate:function(){var e={visu:{antiAliasing:!0,useShadowMap:!0,infinitePlane:!0,displayGrid:!1,displayLines:!1,debugShadowLight:!1,debugBSphere:!1,debugBBox:!1,picking:!0,displayPicking:!0,prePicking:!1,displayprePicking:!1,highlight:{trapSelection:!1},autoUpdatePlane:!0,useMirror:!0,defaultAnimationLoop:!1,multiViewerFix:!0,useViewPanel:!0,viewPanelConfig:{uiConfig:{useShadingIllustration:!0}}},ui:{displayTree:Environment.isBoolActive("3DPlay.Debug.DisplayTree"),displayActionBar:!0}};Environment.isSet("3DPlay.VisuPanel")&&(e.visu.useViewPanel=!0),window.nearFarBigScale=!0,this.args=UWA.extend(e,this.args,!0),this.args.touch="ontouchstart"in window||navigator.MaxTouchPoints>0||navigator.msMaxTouchPoints>0},_step:function(){if(!1===this.modelLoadComplete){this.skipRender=!0;var e=!1,t=!1,i=this.frmWindow.getViewer();if(this.forceRender)this.forceRender=!1,e=t=!0;else if(this.newPart)if(this.newPart=!1,"Optimized"===this.args.options.loadAnimation){if(this.autoReframe){var n=i.getRootNode().getBoundingSphere().radius;1.3*this.oldradius<n&&(t=!0,e=!0,this.oldradius=n,this.modelPrevLoadCount=this.modelLoadCount)}if(!t){var r=this.modelPrevLoadCount+5;this.modelTotalCount>0&&(r=this.reframeConfiguration.userclicked?this.modelPrevLoadCount+1:this.modelPrevLoadCount+Math.max(1,.08*this.modelTotalCount)),this.modelLoadCount>r&&(this.modelPrevLoadCount=r,t=!0)}}else"Full"===this.args.options.loadAnimation?(e=!0,t=!0):"None"===this.args.options.loadAnimation||this.modelLoadCount>this.modelPrevLoadCount+this.args.options.loadAnimation&&(this.modelPrevLoadCount=this.modelLoadCount,e=!0,t=!0);if(e&&this.autoReframe&&i.currentViewpoint.reframe(),t||this.reframeConfiguration.userclicked)this.skipRender=!1,i.render({updateInfinitePlane:!0});else{var o=i.div.clientWidth||1,s=i.div.clientHeight||1;i.SCREEN_WIDTH===o&&i.SCREEN_HEIGHT===s||(this.skipRender=!1)}}this._parent()},preRenderCB:function(){},postRenderCB:function(){},setOnLoadedCallback:function(e){this.modelLoader&&this.modelLoader.setOnLoadedCallback(e)},setOnProgressCallback:function(e){this.modelLoader&&this.modelLoader.setOnProgressCallback(e)},getModelLoader:function(){return this.modelLoader},getRootBag:function(){if(this.pad3DViewer){var e=this.pad3DViewer.getRootBagPath();if(e)return e.getLastElement()}if(this.rootbag)return this.rootbag;var t=this.frmWindow.getViewer();return t.getBagNode?t.getBagNode():t.getRootNode()},createPad3DViewerCBs:function(){this.subscribeToReloadEvents(),this.configureController=function(e){!1===this.isLoadingFinished()&&this.clearView(),this.pad3DViewer.setDefaultStreamToLoad(e.needCGR||e.haveCGR||"index"!==Preference.get(prefName));var t=this.pad3DViewer.getController();if(e.needMeshInRam)if("ENOPAD"===this.currentProvider){var i=this.pad3DViewer.getRoots()[0];!!i&&t.hasMeshInRAM(PAD3DViewerModelServices.getNodeID(i))||t.lockGlobalMeshInRAM()}else Environment.isSet("3DPlay.noMeshInRam.File")&&this.modelLoader.setNoMeshInRAM(!e.needMeshInRam);else"ENOPAD"===this.currentProvider?t.unlockGlobalMeshInRAM():Environment.isSet("3DPlay.noMeshInRam.File")&&this.modelLoader.setNoMeshInRAM(!e.needMeshInRam)},this.isReloadRequired=function(e){var t=!e||void 0===e.needCGR||e.needCGR,i=!(!e||void 0===e.needMeshInRam)&&e.needMeshInRam,n=!(!e||void 0===e.needMaterial)&&e.needMaterial,r=!0,o=!0,s=!0;if("ENOPAD"===this.currentProvider){var a=this.pad3DViewer.getController();if(r="cgr"===a.getDefaultStreamToLoad(),a.hasMeshInRAM){var l=this.pad3DViewer.getRoots()[0];o=!!l&&a.hasMeshInRAM(PAD3DViewerModelServices.getNodeID(l))}(s=!a.areDataLoadedWithoutMaterial())||0!==this.pad3DViewer.getRoots().length||(s=!0),t&&!r&&this.enopadStatistics&&this.enopadStatistics.nbCgrLoaded>0&&0===this.enopadStatistics.nbThbLoaded&&(r=!0)}else o=!this.modelLoader.getNoMeshInRAM();return{needCGR:t&&!r,needMaterial:n&&!s,needMeshInRam:i&&!o,haveCGR:r}};var e=this,t=window.widget;if(t){t.getValue("appId");if(!App.is3DDrive()&&!App.is3DSwym())for(var i in this.resetWidgetPreferences(),this.RuntimeMode.dynamicRepLoading&&(this.widgetPreferences["3DPlay.displayCandidateQueue"]={name:"3DPlay.displayCandidateQueue",defaultValue:!0,type:"boolean",label:prefs.displayCandidateQueue,update:function(e){return PADSettingsMgt.setSetting("enopad3dviewer_displayCandidateQueue",e?"ALWAYS":"OFF"),this.pad3DViewer.setupLoadingBoxesEngine(),!1}.bind(this)}),this.widgetPreferences[prefName]={name:prefName,defaultValue:"index",type:"list",label:prefs.Label,options:[{label:prefs.index,value:"index"},{label:prefs.base,value:"base"}],update:function(e){return e&&this.configureController&&this.configureController({needCGR:"high"===e||"base"===e,needMeshInRam:"high"===e}),!0}.bind(this)},this.widgetPreferences[prefName].options.push({label:prefs.high,value:"high"}),this.widgetPreferences[prefName+".automaticQualityAdaptation"]={name:prefName+".automaticQualityAdaptation",defaultValue:!1,type:"boolean",label:prefs.automaticQualityAdaptation},"auto"===Preference.get(prefName)&&(Preference.set("3DPlay.CGRPolicy.automaticQualityAdaptation",!0),Preference.set(prefName,"index")),this.widgetPreferences)this.widgetPreferences.hasOwnProperty(i)&&this.widgetPreferences[i].update&&this.widgetPreferences[i].update(Preference.get(i))}this.pad3DViewerTokens=this.pad3DViewerTokens||[];var n=void 0!==this.args.options.callbacks?this.args.options.callbacks.enopad:void 0;if(n)for(var r in n){var o=this.pad3DViewer.subscribe({event:r},n[r]);this.pad3DViewerTokens.push(o)}if(this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLeafReferenceLoaded"},function(){e.modelLoadCount++,e.newPart=!0})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({evnt:"onLeafReferenceUnloaded"},function(){e.newPart=!0})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onUrlLoaded"},function(t){e.enopadStatistics=t})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRootRemoved"},function(){if(e.pad3DViewer._dropZoneContainer){var t=e.pad3DViewer._dropZoneContainer.elements.container;t.isHidden()||t.hide()}})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRootAdded"},function(e){})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLoadingComplete"},function(){e.onLoadingFailure||(e.RuntimeMode.dynamicRepLoading?e.publish("ASSET/PRODUCTSTRUCTURE",{}):e.enopadLoading=!1,e.forceRender=!0,e.onModelLoadingCompleted())})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRepresentationLoaded"},function(t){Environment.isSet("3DPlay.FilterFEMRep")&&e.filterFEM(t)})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRefreshCompleted"},function(){e.publish("ASSET/LOADINGFINISHED",{})})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRefreshBegin"},function(){e.publish("ASSET/LOADINGSTARTED",{refreshed:!0})})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onProgress"},function(t){var i={},n=t.message;try{if(n){var r=n.indexOf("3D: ");if(r>-1){var o=n.indexOf(" part");if(o>-1){var s=(n=n.substring(r+4,o)).split(" of ");s&&2===s.length&&(i.loaded=parseInt(s[0]),i.total=parseInt(s[1]))}}}}catch(e){}void 0===i.loaded&&(i.loaded=t.progression),e.onModelLoadingProgression(i)})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLoadingFailure"},function(t){e.onLoadingFailure=!0;var i="LOAD";if(t&&t.message){var n=t.message.replace(" ","_");"Timeout_raised"===n&&(i=n)}_3DPlay.displayFatalError({ctx:e.args.ctx,msg:NLS3DPlay["LoadingError_"+i]})})),this.RuntimeMode.dynamicRepLoading){this.DynamicProgressUI=new WUXProgressBar({shape:"circular",infiniteFlag:!0,statusFlag:!1});this.DynamicProgressUI.height=40,this.DynamicProgressUI.repLoadingStuff=this.repLoadingStuff=new UWA.Element("div",{id:"PlayWeb-Spinner-DynRepLoading",events:{click:function(){this.repLoadingStuff.isHidden()||(this.DynamicProgressUI.playPause3DloadingFonticon.hasClassName("wux-ui-3ds-pause")?(this.pad3DViewer.getController().pauseProgressiveLoading(),this.DynamicProgressUI.pause()):(this.pad3DViewer.getController().resumeProgressiveLoading(),this.DynamicProgressUI.play()))}.bind(this)}}).inject(this.args.container),this.repLoadingStuff.style["z-index"]=10,this.DynamicProgressUI.inject(this.repLoadingStuff),this.DynamicProgressUI._playPause3DloadingFonticonTooltip=new Tooltip({target:this.DynamicProgressUI.repLoadingStuff,position:"right"}),this.DynamicProgressUI._playPause3DloadingFonticonTooltip.options.target.addEventListener("touchend",this.DynamicProgressUI._playPause3DloadingFonticonTooltip.toggle),this.DynamicProgressUI.playPause3DloadingFonticon=UWA.createElement("span",{class:"wux-ui-3ds wux-ui-3ds-1x",styles:{top:"17px",left:"17px",position:"absolute"}}).inject(this.repLoadingStuff),this.DynamicProgressUI.createAnimation=function(t){return new UWA.Fx(t.container,{duration:t.fadeDuration,transition:"linear",events:{onComplete:function(){e&&("fadeOut"===e.DynamicProgressUI.currentFade&&e.repLoadingStuff.hide(),e.DynamicProgressUI.currentFade="none")}}})},this.DynamicProgressUI._fadeOut=function(e){this.animation||(this.animation=this.createAnimation(e)),"fadeIn"===this.currentFade&&this.animation.stop(),this.animation.start({opacity:[parseFloat(this.repLoadingStuff.style.opacity),0]}),this.currentFade="fadeOut"},this.DynamicProgressUI._fadeIn=function(e){this.animation||(this.animation=this.createAnimation(e)),"fadeOut"===this.currentFade&&this.animation.stop(),this.animation.start({opacity:[parseFloat(this.repLoadingStuff.style.opacity),1]}),this.currentFade="fadeIn"};this.DynamicProgressUI.start=function(){this.repLoadingStuff.show(),this._fadeIn({container:e.repLoadingStuff,fadeDuration:1e3}),this.play()},this.DynamicProgressUI.play=function(){this.paused=!1,this.finishTimeout&&(clearTimeout(this.finishTimeout),this.finishTimeout=null),this.emphasize="info",this.value=30,this.infiniteFlag=!0,this.playPause3DloadingFonticon.style.left="16px",this.playPause3DloadingFonticon.removeClassName("fonticon-check"),this.playPause3DloadingFonticon.removeClassName("wux-ui-3ds-play"),this.playPause3DloadingFonticon.addClassName("wux-ui-3ds-pause"),this._playPause3DloadingFonticonTooltip.setBody(NLSPADUtuils.PADStatusInfos_lock3DLoadingTooltip)},this.DynamicProgressUI.pause=function(e){this.paused=!0,this.infiniteFlag=!1,this.emphasize=e?"err":"info",e?this._playPause3DloadingFonticonTooltip.setBody(NLSPAD3DViewer.progressiveExpandFullMemory):(this.playPause3DloadingFonticon.style.left="17px",this.playPause3DloadingFonticon.removeClassName("fonticon-check"),this.playPause3DloadingFonticon.removeClassName("wux-ui-3ds-pause"),this.playPause3DloadingFonticon.addClassName("wux-ui-3ds-play"),this._playPause3DloadingFonticonTooltip.setBody(NLSPADUtuils.PADStatusInfos_unlock3DLoadingTooltip)),this.value=100},this.DynamicProgressUI.finish=function(){if(!this.paused&&!this.finishTimeout){var t=this;this.finishTimeout=setTimeout(function(){t.finishTimeout=null,t.infiniteFlag=!1,t.emphasize="success",t.value=100,t._playPause3DloadingFonticonTooltip.setBody(NLSPAD3DViewer.PADStatus_loadingComplete),t.playPause3DloadingFonticon.style.left="16px",t.playPause3DloadingFonticon.removeClassName("wux-ui-3ds-play"),t.playPause3DloadingFonticon.removeClassName("wux-ui-3ds-pause"),t.playPause3DloadingFonticon.addClassName("fonticon-check"),e&&t._fadeOut({container:e.repLoadingStuff,fadeDuration:1e3})},1e3)}},this.DynamicProgressUI.inject(this.repLoadingStuff),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onStartProgressiveLoad"},function(){e.DynamicProgressUI.start(),e.enopadLoading=!0})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onEndProgressiveLoad"},function(t){t.memoryFull?e.DynamicProgressUI.pause(!0):e.DynamicProgressUI.finish(),"timeout"===e.noGeoTimO&&(e.noGeoTimO=setTimeout(function(){if(0===e.getRootBag().getBoundingSphere().radius){try{var t=this.getInformationsOnAsset();Tracker.trackPageEvent("errors","input_no_geometry",t.type)}catch(e){}_3DPlay.sendEvent(e.args.ctx,eventType.notif,Notification.warning,{msg:NLS3DPlay.LoadingError_NO_GEOMETRY}),e.noGeoInt=setInterval(function(){e.noGeoTimO="timeout",0!==e.getRootBag().getBoundingSphere().radius&&(e.notifScreen.removeNotifications(),clearInterval(e.noGeoInt))},1e3)}},4e3)),e.enopadLoading=!1})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onStartAsync"},function(){e.frmWindow.getActionBar()._afr.elements.container.removeClassName("enopad3Dviewer_actionbar_disabled")})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLoadingFailure"},function(){e.enopadLoading=!1;var t=arguments[0];t&&t.message&&t.message.startsWith("Failed to retrieve object information.")&&(e.modelFailure=!0),e.onModelLoadingCompleted()})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLoadingCanceled"},function(){e.enopadLoading=!1})),this.disposeFunctions.add(function(){e=null})}},deletePad3DViewerCBs:function(){if(this.pad3DViewerTokens){for(var e=this.pad3DViewerTokens.length;e--;)this.pad3DViewer.unsubscribe(this.pad3DViewerTokens[e]);this.pad3DViewerTokens=[]}},createDom:function(e,t){if(this.args.options.pad3DViewer){this.currentProvider="ENOPAD",this.isFromTransition=!0,this.pad3DViewer=this.args.options.pad3DViewer,this.frmWindow=this.pad3DViewer.getFrameWindow(),this.RuntimeMode={dynamicRepLoading:PADSettingsMgt.getSetting("enopad3dviewer_dynamicRepLoading"),OOC:PADSettingsMgt.getSetting("enopad3dviewer_lightNodeModel")},this.customizePad3DViewer(),this._parent(e);var i=this;requirePromise.then(function(){t.apply(i),i=null})}else if(ENOPAD3DViewer){var n={context:this.args.ctx,height:"100%",minHeight:void 0!==this.args.minHeight?this.args.minHeight:0,viewerOptions:this.args.visu||{},uiOptions:this.args.ui||{},onModelLoaded:this.onModelLoadingCompleted,language:this.args.lang};if(this.RuntimeMode={binaryPrimitives:!1},this.args.workbenchs&&this.args.workbenchs.length>0){this.workbenchIndex=0;var r=this.args.workbenchs[this.workbenchIndex];this.workbenchIndex++,n.ignoreResetCommandManager=!0,n.workbenchModule=r.module,n.workbench=r.name+".xml",n.defaultCommand=void 0!==r.defaultCommand?r.defaultCommand:{ID:"",className:"DS.3DPlayCommands.EmptyCmd"},ProbesManager.begin("ActionBar_Ready"),this.actionBarProfile=ProbesManager.createProbe("ActionBar_"+r.name),this.actionBarProfile.begin()}else n.workbench=!1,n.defaultCommand={ID:"",className:"DS.3DPlayCommands.EmptyCmd"};var o={widget:window.widget?window.widget:n.widget,windowOptions:n};if(this.args.options.enopad&&(o=UWA.extend(o,this.args.options.enopad,!0)),this.args.input&&"guest"===this.args.input.user||App.is3DDrive()||App.is3DSwym())o.offline=!0,this.args.input&&"guest"===this.args.input.user&&(this.args.input.asset.user="guest");else{var s,a=Preference.get("x3dPlatformId"),l=Environment.get("3DPlay.Plateform.3DSpaceUrl");if(l&&a)o.offline=!l.some(function(e){return e.platformId===a&&e.url}),o.offline&&(l.forEach(function(e){!s&&e.url&&(s=e.platformId)}),s?(o.offline=!1,Preference.set("x3dPlatformId",s),s=1):s=0),Tracker.trackPageEvent("infos","tenant_provider",a,void 0===s?2:s)}void 0===o.allowAuthoring&&(o.allowAuthoring=!0,this.RuntimeMode.allowAuthoring=o.allowAuthoring),o.authorizeSet3DStructure=!1,this.args.options.platformServices&&(o.plateformServices=this.args.options.platformServices),o.getPlatformServicesInBackground=!0,void 0===window.HybridApp&&this.args.input&&this.args.input.asset&&(this.args.input.asset.provider&&"EV6"===this.args.input.asset.provider||void 0!==this.args.input.asset.dtype)&&(o.getPlatformServicesInBackground=!1),o.windowOptions.robotVisibility=!1,o.interwidgetComAvailability=!1,o.enableFiltering=!0,o.interwidgetComAvailability=!0,ProbesManager.createProbe("Viewer_init").begin();var d=!1;ExperiencesList.isDynamicRepLoadingCompatibleExperience(this)?(o.dynamicRepLoading=!0,o.windowOptions.supportWorldOrientation=!0,o.windowOptions.defaultStatusBarVisibility=!1,o.binaryPrimitives=!0,d=!0):((Environment.isSet("3DPlay.OOC")||Environment.isSet("3DPlay.dynamicRepLoading"))&&(o.dynamicRepLoading=!0),(Environment.isSet("3DPlay.OOC")||Environment.isSet("3DPlay.binaryPrimitives"))&&(o.binaryPrimitives=!0),Environment.isSet("3DPlay.OOC")&&(d=!0)),Environment.isSet("3DPlay.DisableOOC")&&(d=!1),d&&(this.RuntimeMode.OOC=!0,o.visuProgressiveTileModel=!0),this.RuntimeMode.binaryPrimitives=o.binaryPrimitives,this.RuntimeMode.dynamicRepLoading=o.dynamicRepLoading,this.args.options.propertiesFacet&&this.args.options.propertiesFacet.length&&(o.enableSidePanel=!0),App.isInWidget()&&("ENOENBO_AP"!==App.getEmbeder()&&(o.windowOptions.BIMode="DUAL"),widget.setValue("addPlatformPref",!1)),this.pad3DViewer=new ENOPAD3DViewer(o),this.frmWindow=this.pad3DViewer.getFrameWindow(),this.pad3DViewer.render().inject(this.args.container);var c=this,u=this._parent;c.disposeFunctions.add(function(){c=null}),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onReady"},function(){c.enopadInited||(PADSharedSettings.addSharedSettings(widget,["x3dPlatformId"]),PADSettingsMgt.setSetting("x3dPlatformId",Preference.get("x3dPlatformId")),ProbesManager.end("Viewer_init"),c.enopadInited=!0,u.apply(c,[e]),c.customizePad3DViewer(),requirePromise.then(function(){setTimeout(function(){c.requestNewExperienceBaseAsync().then(function(){t.apply(c)})},500)}),c.subscribeOnce("EXPERIENCE/EXPERIENCEREADY",function(){Tracker.trackPageEvent("infos","loader_config",c.RuntimeMode?c.RuntimeMode.OOC?"OOC":c.RuntimeMode.dynamicRepLoading?"Dynamic":"Basic":"Base"),c=null}),u=null)}))}else this._parent(FrameWindow3D,t)},customizePad3DViewer:function(){PADSettingsMgt.setSetting("enopad3dviewer_autoReloadOnMaterialModeEngaged",!1),this.createPad3DViewerCBs();var e=this.pad3DViewer.getViewer();this.pad3DViewerConfig={picking:UWA.clone(e.picking),pPicking:UWA.clone(e.pPicking),Robot:this.pad3DViewer.isRobotVisible(),Progress:this.pad3DViewer.getDefaultProgressBarVisibility(),Reframe:this.pad3DViewer.getAutomaticReframePolicy(),Menu:this.pad3DViewer.isDefaultContextualMenuVisible(),Bar:this.pad3DViewer.isDefaultContextualBarVisible(),toHide:function(e){e.hide(),this.hideshowElem=this.hideshowElem||[],this.hideshowElem.push(e)},toShow:function(){if(this.hideshowElem){for(var e=0;e<this.hideshowElem.length;e++)this.hideshowElem[e].show();this.hideshowElem=null}}},e.setPicking({activated:this.args.visu.picking,displayHL:this.args.visu.displayPicking,primitive:!1}),e.setPrePicking({activated:this.args.visu.prePicking,displayHL:this.args.visu.displayprePicking}),this.pad3DViewerConfig.changeVisuModeCmdAvailability=this.pad3DViewer.changeVisuModeCmdAvailability,this.pad3DViewer.changeVisuModeCmdAvailability=function(){};var t=this;this.intervalTimer=void 0;var i=function(){try{if(t.pad3DViewer._dropZoneContainer&&t.pad3DViewer._dropZoneContainer.elements.container){t.pad3DViewerConfig.DropMode=t.pad3DViewer._dropZoneContainer.options.mode,t.pad3DViewer._dropZoneContainer.options.mode="none",t.pad3DViewer.elements.container.removeEventListener("dragenter",t.pad3DViewer._dndCB[0]),t.pad3DViewer.elements.container.removeEventListener("dragover",t.pad3DViewer._dndCB[0]),t.pad3DViewer.elements.container.removeEventListener("dragleave",t.pad3DViewer._dndCB[1]),t.pad3DViewer.elements.container.removeEventListener("dragend",t.pad3DViewer._dndCB[1]),t.pad3DViewer.elements.container.removeEventListener("drop",t.pad3DViewer._dndCB[2]);var e=t.pad3DViewer._dropZoneContainer.elements.container;e.isHidden()||t.pad3DViewerConfig.toHide(e),void 0!==t.intervalTimer&&(clearInterval(t.intervalTimer),t=null)}else void 0===t.intervalTimer&&(t.intervalTimer=setInterval(i,2))}catch(e){void 0===t.intervalTimer&&(t.intervalTimer=setInterval(i,2))}};i();var n=window.document.getElementById("BubbleContainer");n&&!n.isHidden()&&this.pad3DViewerConfig.toHide(n);var r=this,o=function(){var e=window.document.getElementsByClassName("pad_status");e&&(e=e[0],r.pad3DViewerConfig&&(e?(r.pad3DViewerConfig.toHide(e),r=null):setTimeout(o,50)))};this.RuntimeMode.dynamicRepLoading||o(),this.pad3DViewer.setRobotVisibility(!1),this.pad3DViewer.setDefaultProgressBarVisibility(!1),this.pad3DViewer.setAutomaticReframePolicy(!1),this.pad3DViewer.setDefaultContextualMenuVisibility(!1),this.pad3DViewer.setDefaultContextualBarVisibility(!1),this.frmWindow=this.pad3DViewer.getFrameWindow()},clearView:function(){var e=this.frmWindow.getViewer();if(this.notifScreen.removeNotifications(),this.autoReframe=!0,this.pad3DViewer&&"ENOPAD"===this.currentProvider&&this.pad3DViewer.getRoots().length>0){var t=PAD3DViewerModelServices.getRoots(this.pad3DViewer),i=[];t.forEach(function(){i.push(PAD3DViewerModelServices.getNodeID(t[0]))}),this.DynamicProgressUI&&this.DynamicProgressUI.finish(),this.pad3DViewer.removeRoots({pids:i})}else{this.xcadmodelLoader&&this.xcadmodelLoader.clear&&(this.xcadmodelLoader.clear(),this.xcadmodelLoader=void 0);var n=this.getRootBag();n&&n.children&&n.children.length>0&&n.removeChildren(),this.modelLoader.setSceneGraph(n),!1===this.modelLoadComplete&&(this.modelLoader.abort(),this.progress.hide())}e.render()},subscribeToReloadEvents:function(){var e=this.pad3DViewer.getViewer();this.viewerVisuModeCB=[];var t=function(e){this.pendingConfiguration=e.configuration,this.pendingCancel=e.onCancel,this.timeoutConfiguration||(this.timeoutConfiguration=setTimeout(function(){this.checkReloadNeeded(this.pendingConfiguration,{onConfirm:function(){saveControlerConfiguration(this.currentProvider,this.pendingConfiguration),delete this.pendingConfiguration}.bind(this),onCancel:this.pendingCancel}),delete this.timeoutConfiguration}.bind(this),100))};this.viewerVisuModeCB.push(e.onVisuShadingFaceModeChange(function(e){"Illustration"===e.value?t.apply(this,[{configuration:visuModeOptions[e.value],onCancel:function(){e.viewer.setVisuShadingEdgeMode("NoEdges"),e.viewer.setVisuShadingFaceMode("Shaded")}.bind(this)}]):saveControlerConfiguration(this.currentProvider,{needMeshInRam:!0},!1)}.bind(this))),this.viewerVisuModeCB.push(e.onMaterialModeChange(function(e){this._materialModeChanged=!0;let t=visuModeOptions.MaterialMode;if(!0===e.value){var i=this.currentProvider;this.checkReloadNeeded(t,{onConfirm:function(){saveControlerConfiguration(i,t)},onCancel:function(){e.viewer.setMaterialMode(!1)}})}else saveControlerConfiguration(this.currentProvider,{needMaterial:!0},!1)}.bind(this))),this.viewerVisuModeCB.push(e.onVisuShadingEdgeModeChange(function(e){"NoEdges"!==e.value&&t.apply(this,[{configuration:visuModeOptions.Edges,onCancel:function(){e.viewer.setVisuShadingEdgeMode("NoEdges"),e.viewer.setVisuShadingMode("Shading")}.bind(this)}])}.bind(this))),this.viewerVisuModeCB.push(e.onAxisFilterChange(function(e){if(!0===e.state){let t=visuModeOptions.AxisFilter,i=this.currentProvider;this.checkReloadNeeded(t,{onConfirm:function(){saveControlerConfiguration(i,t)},onCancel:function(){e.viewer.setAxisFilter(!1)}})}}.bind(this))),this.viewerVisuModeCB.push(e.onPlanesFilterChange(function(e){if(!0===e.state){let t=visuModeOptions.PlanesFilter,i=this.currentProvider;this.checkReloadNeeded(t,{onConfirm:function(){saveControlerConfiguration(i,t)},onCancel:function(){e.viewer.setPlanesFilter(!1)}})}}.bind(this))),this.viewerVisuModeCB.push(e.onLinesFilterChange(function(e){if(!0===e.state){let t=visuModeOptions.LinesFilter,i=this.currentProvider;this.checkReloadNeeded(t,{onConfirm:function(){saveControlerConfiguration(i,t)},onCancel:function(){e.viewer.setLinesFilter(!1)}})}}.bind(this))),this.viewerVisuModeCB.push(e.onPointsFilterChange(function(e){if(!0===e.state){let t=visuModeOptions.PointsFilter,i=this.currentProvider;this.checkReloadNeeded(t,{onConfirm:function(){saveControlerConfiguration(i,t)},onCancel:function(){e.viewer.setPointsFilter(!1)}})}}.bind(this)))},checkReloadNeeded:function(e,t){var i;if(e=e||{needCGR:!0},this.pad3DViewer&&(i=this.pad3DViewer.getFrameWindow()),i){var n=this.isReloadRequired(e);if(n.needCGR||n.needMeshInRam||n.needMaterial){var r=!Preference.get("3DPlay.CGRPolicy.automaticQualityAdaptation");return n.needMeshInRam&&(r="high"!==Preference.get("3DPlay.CGRPolicy")),void(r?this.confirmReloadBoxDisplayed||(this.confirmReloadBoxDisplayed=!0,ConfirmBox({this:this,warning:!1,container:i.getViewerFrame(),caption:CmdENOPADStreamNLS.Title,info:[n.needMeshInRam?CmdENOPADStreamNLS.Specific_Caption_NMIR:CmdENOPADStreamNLS.General_Caption,CmdENOPADStreamNLS.Confirm_General],checkBox:{text:CmdENOPADStreamNLS.CheckBox_Settings,callback:function(e){e&&Tracker.trackPageEvent("commands","enopadstream","automaticQualityAdaptation"),Preference.set("3DPlay.CGRPolicy.automaticQualityAdaptation",e)}},confirm:{callback:function(){this.confirmReloadBoxDisplayed=!1,this.reload(n),t.onConfirm&&t.onConfirm()},text:CmdENOPADStreamNLS.Button_Proceed},cancel:{callback:function(){this.confirmReloadBoxDisplayed=!1,t.onCancel&&t.onCancel()},text:CmdENOPADStreamNLS.Button_Cancel}})):(this.reload(n),t.onConfirm&&t.onConfirm()))}t.onConfirm&&t.onConfirm()}},reload:function(e){Tracker.trackPageEvent("commands","enopadstream","acceptReload",void 0,{needCGR:e.needCGR?1:0,needMeshInRam:e.needMeshInRam?1:0,needMaterial:e.needMaterial?1:0}),this.configureController(e),this.refresh(!0)},fromTransition:function(){return!0===this.isFromTransition&&(this.pad3DViewer.getController().toggleBetweenStandaloneAndSlaveMode("DUAL"),this.pad3DViewer.displayStatusBar(!1),this.modelName=UWA.clone(this.args.input.asset),this.onModelLoadingStarted(),this.isFromTransition=!1,this.onModelLoadingCompleted(),!0)},updateConnection:function(e,t){window.localStorage["3DPlayHybridApp"]&&window.HybridAppArgs&&window.HybridAppArgs.myAppsUrl?this.pad3DViewer.connectToPlatform({readyCB:t,allowAuthoring:!1}):t()},changeVisuSettingIfPossible:function(){if(this.args.workbenchs&&this.args.workbenchs.some(function(e){return"3DPlayExperience3D"===e.name})){var e,t="3DPlay.lastVisuCommand."+this.currentProvider,i=Preference.get(t);if(i){Preference.delete(t),(e={VisuShading:{},VisuShadingEdgesNoSmoothEdges:visuModeOptions.Edges,VisuShadingEdgesHiddenEdges:visuModeOptions.Edges,VisuShadingMaterialEdges:visuModeOptions.MaterialMode,VisuShadingMaterial:visuModeOptions.MaterialMode,VisuShadingIllustration:visuModeOptions.Illustration,VisuNoShadingEdges:visuModeOptions.Wireframe}[i])||(logger.error("ERROR : command not found in VisuCommandMap",i),logger.error("ERROR : command not found in VisuCommandMap",i),e={}),internalSave(this.currentProvider,e)}else e=loadControlerConfiguration(this.currentProvider);var n=!1;if(e.needCGR){let t="FILE"===this.currentProvider||!0===Preference.get(prefName+".automaticQualityAdaptation")||Environment.isSet("3DPlay.Plateform.Cloud",!0)&&!PADSettingsMgt.getSetting("enopad3dviewer_VISnVIOStatus")||"cgr"===this.pad3DViewer.getController().getDefaultStreamToLoad();t&&(n=t,e.needMeshInRam&&(n="FILE"===this.currentProvider||Environment.isSet(prefName,"high")))}if(n)this.configureController(e);else{var r=this.frmWindow.getViewer();"FILE"===this.currentProvider?(r.setMaterialMode(!0),r.setVisuShadingEdgeMode("WithEdges")):(r.setMaterialMode(!1),r.setVisuShadingEdgeMode("NoEdges"),r.setVisuShadingMode("Shading")),internalSave(this.currentProvider,{})}}},loadModel:function(e,t,i){if(!1!==this.modelLoadComplete||"ENOPAD"!==this.currentProvider){var n=this.frmWindow.getViewer();if(t&&!1!==t.resetCameraOrientation&&!this.reframeConfiguration.hasViewpointSet)n.currentViewpoint.resetCameraOrientation();var r=e?e.asset:this.args.input?this.args.input.asset:null,o="",s=r;if("string"==typeof s){if(""===s)return;o=s;var a=StringUtils.getExtension(s);""!==a&&"3dxml"!==(a=a.toLowerCase())&&this.modelLoader.setFileType(a)}else if(void 0===s.provider||null===s.provider||"file"===s.provider.toLowerCase()){o=s.filename;var l=s.serverurl;if(!(null!=l&&""!==l||null!=o&&""!==o))return}var d=this;if(this.disposeFunctions.add(function(){d=null,Network.disableHook()}),this.donwlonadProgress||(this.donwlonadProgress=this.getPhaseProgress().registerSubProgress()),this.oldradius=0,this.pad3DViewer&&s.provider&&"FILE"!==s.provider?this.currentProvider="ENOPAD":this.currentProvider="FILE",this.changeVisuSettingIfPossible(),this.onLoadingFailure=!1,(Environment.isSet("3DPlay.ProtoSMM")||Environment.isSet("3DPlay.ProtoConvertSpatial"))&&"BUFFER"===s.provider)this.modelLoader.setFileType("cgr"),this.modelName="buffer",this.modelLoader.loadModelFromBuffer(s.data);else if("ENOPAD"===this.currentProvider){var c;r=e.asset,this.pad3DViewer._lockCSONotification=!1,this.modelName=r.id=r.physicalid;try{c=PADUtilsServices.get3DSpaceUrl()}catch(e){}if(!c||r.tenant&&r.tenant!==Preference.get("x3dPlatformId"))return Tracker.trackPageEvent("infos","switch_tenant",r.tenant),Preference.set("x3dPlatformId",r.tenant),void this.pad3DViewer.connectToPlatform({readyCB:ProbesManager.createFunctionProbe("Enopad:connectToPlatform",function(){new UWAPromise(function(e){PADUtilsServices.updateWidgetSecPref({tenant:r.tenant,padsecurityctx:r.contextid,resolve:e,withPreference:!1})}).then(function(){PADSettingsMgt.setSetting("x3dPlatformId",r.tenant),d.loadModel(e,t,i),null}).catch(function(){Traker.trackPageEvent("error","switch_tenant",Preference.get("x3dPlatformId")),d.modelFailure=!0,d.onModelLoadingCompleted(),null})}),allowAuthoring:!1});try{this.PanelManager.tagger.activate(!1),this.pad3DViewer.getController()._BIProxy._biFilter.activate(),this.pad3DViewer.getController()._BIProxy.addEvent("ApplyNGFilter",function(){this.onModelLoadingStarted(!1)},this)}catch(e){}this.RuntimeMode.dynamicRepLoading?(!0===this.DynamicProgressUI.paused&&this.pad3DViewer.getController().resumeProgressiveLoading(),this.onModelLoadingStarted(!1)):this.onModelLoadingStarted(),r.Play3DXContent&&r.Play3DXContent.biProxyCtx?this.pad3DViewer.addRootNodesFromContent({json3DXContent:r.Play3DXContent,dispatch:!1}):"ENOStrRefinementSpecification"===r.dtype?this.pad3DViewer.addFilter([{objectId:r.physicalid}]):"R2V_FeatureState"===r.dtype?this.pad3DViewer.addR2Vs({objects:[r],reframe:!1,displayNotif:!1,dispatch:!1}):this.pad3DViewer.addRoots({objects:[r]},!1,!1),this.currentProvider="ENOPAD",this.enopadLoading=!0}else{s.originalType||(this.loadingAsset.size=0);try{this.pad3DViewer.getController()._BIProxy._biFilter.deactivate(),this.PanelManager.tagger.activate()}catch(e){}var u;if(Network.hookNetwork(function(e){var t;return-1===e.indexOf(".js")&&(t={id:"Download",onStatistics:function(e){d.loadingAsset.size=e.DownloadSize},onProgress:function(e){if(0!==e.total){d.loadingAsset.size=e.total;var t=e.loaded/e.total;d.donwlonadProgress&&d.getPhaseProgress().setAbsoluteProgress(d.donwlonadProgress,t/1*100)}},onComplete:function(){d.getPhaseProgress().setAbsoluteProgress(d.donwlonadProgress,100),d.loadingAsset.Load_Session=ProbesManager.createProbe("Load_Session").begin()}}),t}),this.enopadLoading=!1,this.pad3DViewer&&(this.pad3DViewer._lockCSONotification=!1),o.indexOf("blob:")>-1?(this.modelName="blob",this.loadingAsset.Load_Session=ProbesManager.createProbe("Load_Session").begin()):(this.modelName=o.split("/").pop(),this.modelName.length>128&&(this.modelName=this.modelName.substr(this.modelName.length-128,this.modelName.length))),n.setWorldOrientation(WorldOrientation.ZUpYRight),"stpa"===s.format){u=!1;require(["DS/XCADLoader/XCADModelLoader"],function(e){d.xcadmodelLoader=new e(d.frmWindow.getViewer(),d.modelLoader,s.localFile),d.xcadmodelLoader.setOnStartLoadingCB(function(){d.DynamicProgressUI.start()}),d.xcadmodelLoader.setOnEndLoadingCB&&d.xcadmodelLoader.setOnEndLoadingCB(function(e){e.memoryFull?d.DynamicProgressUI.pause(!0):d.DynamicProgressUI.finish(),d.modelLoadComplete=!0}),d.xcadmodelLoader.setObjectLoadedCB&&d.xcadmodelLoader.setObjectLoadedCB(function(){d.newpart=!0})})}else t&&t["3DXMLLoadOpts"]?this.modelLoader.loadModel(s,void 0,void 0,{applicativeContainers:t["3DXMLLoadOpts"]}):this.modelLoader.loadModel(s);this.currentProvider="FILE",this.onModelLoadingStarted(u)}n.render({updateInfinitePlane:!0}),this.forceRender=!0}else this.loadingpending=arguments},loadAsset:function(e,t,i,n){if(this.useExperienceBase?this.requestNewExperienceBaseAsync().then(function(){this.publish("EXPERIENCEBASE/NEW",{data:this.experienceBase}),this.loadModel(e,t,i)}.bind(this)):this.loadModel(e,t,i),this.pad3DViewer&&!this.isFromTransition){var r=this.pad3DViewer.getFrameWindow();r&&r.removeReviewModel&&r.removeReviewModel()}this._parent()},_testBrowser:TestBrowser,getScreenShot:function(e){var t=this.frmWindow.getViewer();t.save&&t.save();var i=t.currentViewpoint,n=window.devicePixelRatio>1?window.devicePixelRatio:1,r={data:null,width:Math.floor(t.SCREEN_WIDTH*n),height:Math.floor(t.SCREEN_HEIGHT*n)},o=document.createElement("canvas");o.width=e.width?e.width:r.width,o.height=e.height?e.height:r.height,i.getControl().update(),t.renderToTarget(r,i);var s=o.getContext("2d"),a=s.getImageData(0,0,o.width,o.height);a.width!==o.width&&e.onError("size error"),a.height!==o.height&&e.onError("size error");var l,d,c,u,h=(r.width-1)/(a.width-1),p=(r.height-1)/(a.height-1),g=r.data,f=a.data;if(1===h&&1===p){var m=a.height,v=4*a.width;for(d=0;d<m;d++)for(c=v*d,u=v*(m-d),l=v;l--;)f[c+l]=g[u+l]}else{var S=function(e,t,i,n,r){return r&&(t=n-t),i*t+e},D=a.height,w=a.width,P=r.height,y=r.width;for(d=0;d<D;d++){var C=Math.floor(p*d);for(l=0;l<w;l++)c=4*S(l,d,w,D),u=4*S(Math.floor(h*l),C,y,P,!0),f[c]=g[u],f[c+1]=g[u+1],f[c+2]=g[u+2],f[c+3]=g[u+3]}}s.putImageData(a,0,0,0,0,o.width,o.height),this._setScreenshotUI(o);var b=e.type?"image/"+e.type:"png";if(Environment.get("3DPlay.PersistedAnnotationsEnabled")){var E=this._getSvgScreenshot(o.toDataURL(b));e.onSuccess(E)}else"jpeg"===e.type?o.toBlob(function(t){e.onSuccess(t)},"image/jpeg"):e.onSuccess(o.toDataURL(b))},_getSvgScreenshot:function(e){this.frmWindow.getViewer().getBagNode();var t=this.frmWindow.getViewerFrame().getDimensions(),i=ContextedSingleton.get(this.ctx,"ANNOTATION_MANAGER"),n="<Model>"+JSON.stringify(this.args.input.asset)+"</Model>",r="<Annotations>"+i.saveAnnotationsToJSON()+"</Annotations>",o="<svg width='"+t.width+"' height='"+t.height+"' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'> <image xlink:href='"+e+"' x='0' y='0' width='100%' height='100%'/>"+n+r+"</svg>",s=new Blob([o],{type:"image/svg+xml;charset=utf-8"});return(self.URL||self.webkitURL||self).createObjectURL(s)},_setScreenshotUI:function(){}})});