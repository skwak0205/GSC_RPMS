/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedDataLauncher/CATRelatedDataController",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/Core/Events","DS/WAFData/WAFData","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADWSAccess","DS/CATRelatedDataUtils/CATRelatedDataTransientWidget","DS/DibWebUtils/DibQueryToolbox","DS/CATWebUXComponents/CATWebUXUtils"],function(e,t,n,i,a,l,r,s,o,c,u,d,h){"use strict";var p=t.extend({init:function(t){var p,f,g=t||{};this._parent(g);var v,m,D,C,b,y,S=t.ctxViewer,w=null,A=[],T=[],k=0,L=new n.Vector3,P=new n.Vector3,E=new n.Matrix4,I=new n.Matrix4,R=null,x=0;function V(e,t,n){t.headers.SecurityContext=r.getSetting("pad_security_ctx");var i=s.get3DSpaceUrl()+e;n&&(i+="?SecurityContext="+r.getSetting("pad_security_ctx")),l.authenticatedRequest(i,t)}function _(e){if(!e)return-1;for(var t=0;t<T.length;t++)if(T[t].isEqual(e))return t;return-1}function F(e){if(w){var t=_(e);-1!==t&&T.splice(t,1);for(var n=A.length-1;n>=0;n--)A[n].selectionPathElement.isEqual(e)&&(w.removeTile(A[n].tile),A.splice(n,1));0===A.length?w.clear():(w.setDataLauncherPosition(A[A.length-1].position),w.update())}}function U(e){if(w&&A.length&&e&&e instanceof Array)for(var t=0;t<e.length;t++)for(var n=0;n<A.length;n++)e[t].isAParentOf(A[n].pathElement)&&F(A[n].pathElement)}function N(t){var n={};n.type=t.type,n.appId="X3DPLAW_AP",n.appIcon=t.appIcon,n.typeIcon=t.typeIcon,n.serviceId=t.serviceId,n.pathElement=t.pathElement,n.dType=t.dType,n.physicalid=t.physicalid,n.title=t.title||D;var i=t.date;return n.modifDate=i?e.String.parseRelativeTime(i):C,n.modifDate||(n.modifDate=i||C),n.urlDerivedOutput=t.streamURL,n.tileId=x.toString(),x++,n}function M(e,t,i){var a;for(a=0;a<A.length;a++)if(A[a].pathElement.isEqual(t))return;for(a=0;a<e.length;a++)w.addTile(e[a])&&(w.update(),k&&(clearTimeout(k),k=0),A.push({tile:e[a],pathElement:t,selectionPathElement:i,position:(new n.Vector3).copy(L),localMatrix:(new n.Matrix4).copy(E),pickPath:m.clone()}))}function W(e){k&&(clearTimeout(k),k=0),w&&w.clear(e),T=[],e&&v&&(v.VISU&&a.unsubscribe(v.VISU),v.onHide&&S.unsubscribe(v.onHide),v.onRootDetached&&S.unsubscribe(v.onRootDetached),v.onRootRemoved&&S.unsubscribe(v.onRootRemoved),v.onBeginReparent&&S.unsubscribe(v.onBeginReparent),v.onAdd&&i.unsubscribe(v.onAdd),v.onRemove&&i.unsubscribe(v.onRemove),v.onEmpty&&i.unsubscribe(v.onEmpty),v.swapVisibleSpace&&S.getViewer()&&S.getViewer().unsubscribe(v.swapVisibleSpace),v=w=null,A=[])}function O(e){if(p&&f){if(!b){var t=e;return void require(["DS/CATRelatedDataLauncher/CATRelatedDataLauncher","i18n!DS/CATRelatedDataLauncher/assets/nls/CATRelatedDataLauncher"],function(e,n){if(b=e,D=n.NameUnknownLbl,C=n.DateUnknownLbl,t&&t.pathElement)for(var a=i.get(),l=0;l<a.length;l++)a[l].pathElement.isEqual(t.pathElement)&&O(t)})}if(!b)return;if(e.event&&e.event.offsetPosition&&0!==e.event.offsetPosition.x&&0!==e.event.offsetPosition.y)return void(w&&w.clear());if(!e.pathElement||e.pathElement.getLastElement(!0)._getExcludeFromCSO&&e.pathElement.getLastElement(!0)._getExcludeFromCSO())W(!1);else{for(var a,l,g,v,A=e.pathElement.clone();A&&(!l&&o.is3DLeaf(A.getLastElement(!0))&&(v=(l=A.clone()).getLastElement(!0)),!a&&o.isReference(A.getLastElement(!0))&&(g=(a=A.clone()).getLastElement(!0)),!l||!a);)A=A.getParentPath();if(!e.event||-1!==_(e.pathElement)||!g&&!v)return;w||(w=new b({viewer:S.getViewer(),window:S.getFrameWindow()})).subscribe("onRelatedDataSelected",function(e){for(var t,n=[],i=0;i<e.length;i++)t={protocol:"3DXContent",version:"0.1",source:"X3DCSMA_AP",data:{items:[]}},e[i].urlDerivedOutput?(t.data.items.push({envId:s.getPlatformId(),contextId:r.getSetting("pad_security_ctx"),serviceId:e[i].serviceId,asset:{filename:e[i].urlDerivedOutput,format:"svg",provider:"FILE"},experience:"3DPlaySVGExperience"}),h._sendUsageProbe("command","RevealDataSVG")):(t.data.items.push({envId:s.getPlatformId(),serviceId:"3DSpace",objectId:e[i].physicalid,objectType:e[i].dType,contextId:r.getSetting("pad_security_ctx")}),h._sendUsageProbe("command","RevealData"+e[i].dType)),n.push({id:e[i].appId,title:e[i].NLSType+" - "+e[i].title,data:{x3dSharedId:window.widget.getValue("x3dSharedId"),x3dPlatformId:window.widget.getValue("x3dPlatformId"),X3DContentId:JSON.stringify(t)}});y||(y=new u),y.showWidget(n)});var x=e.event.currentPosition?e.event.currentPosition:e.event.from?e.event.from[0].currentPosition:new n.Vector2(0,0),F=S.getViewer().getMousePosition(x),U=S.getViewer().pick(F,"mesh",!0);P=(new n.Vector3).copy(U.position?U.position:P);var X=(new n.Matrix4).makeTranslation(P.x,P.y,P.z),B=e.pathElement.getWorldMatrix(S.getViewer());B.getInverse(B),I=(new n.Matrix4).multiplyMatrices(B,X),R=e.pathElement.clone();var H=0,j=0;k&&(clearTimeout(k),k=0),k=setTimeout(function(){w&&w.clearIfWaiting();for(var t=1;t;)-1!==(t=_(e.pathElement))?T.splice(t,1):t=null},15e3),L.copy(P),E.copy(I),m=R.clone(),w.setDataLauncherPosition(L),w.show();var q=function(){if(w&&(w.hideSpinner(),++j===H)){var t=_(e.pathElement);-1!==t&&T.splice(t,1)}},z=v?o.getNodeID(v):null,J=g?o.getNodeID(g):null;z&&(w.displaySpinner(),H++,T.push(e.pathElement.clone()),function(e){for(var t="",n=0;n<e.physicalIDs.length;n++)t+="physicalid:"+e.physicalIDs[n],n!==e.physicalIDs.length-1&&(t+=" OR ");var i={query:t,intent:"stream_2D",order_by:"asc",order_field:"update",nresults:1,tenant:s.getPlatformId(),authored:!0,label:"CATRelatedDataLayoutsNav"},a={data:JSON.stringify(i),method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":r.getSetting("lang")},onComplete:function(t){for(var n={ids:[]},i=JSON.parse(t),a=0;a<i.results.length;a++){for(var l,s,o,c,u=0;u<i.results[a].attributes.length;u++)"physicalid"===i.results[a].attributes[u].name&&(o=i.results[a].attributes[u]),"streamName"===i.results[a].attributes[u].name&&(s=i.results[a].attributes[u]),"streamType"===i.results[a].attributes[u].name&&(l=i.results[a].attributes[u]);l&&-1!==l.value.indexOf("SVG")&&(c=l.value.indexOf("SVG"),n.ids.push({id:o.value,what:{name:"DerivedOutput",data:[{streamType:l.value[c],streamName:s.value[c]}]}}))}n.ids.length&&V("/resources/enopad/navigate/getstreamurl",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":r.getSetting("lang")},data:JSON.stringify(n),onComplete:e.callbacks.onComplete,onFailure:e.callbacks.onFailure})},onCancel:e.callbacks.onFailure,onFailure:e.callbacks.onFailure};V("/resources/enopad/lwc/fetch",a)}({physicalIDs:[z],callbacks:{onComplete:function(t){if(w){var n=JSON.parse(t);n&&n.results&&n.results.length&&n.results[0].what&&n.results[0].what.data&&n.results[0].what.data.length&&n.results[0].what.data[0].streamURL&&c.fetch({enopad_webapis:r.getSetting("enopad_webapis"),pids:[z,J],data:{intent:"explore_2D",select_file:["preview_url","thumbnail_2d","icon"],select_predicate:["ds6w:label","ds6w:modified","ds6w:created"]},onComplete:function(t){if(w){var i=JSON.parse(t),a={};(i&&i.results||[]).forEach(function(e){if(e&&e.attributes){for(var t,n,i={},l=0,r=e.attributes.length;l<r;++l)"resourceid"===(n=e.attributes[l]).name?t=n.value:"assembly_cgr"===n.name?i.cgr=n.value:i[n.name]=n.value;t&&(a[t]=i)}}),a[z]&&a[J]&&M([N({type:"Layout",appIcon:a[z].preview_url||a[z].thumbnail_2d,typeIcon:a[z].type_icon_url,title:a[J]["ds6w:label"],date:a[J]["ds6w:modified"]?a[J]["ds6w:modified"]:a[J]["ds6w:created"],serviceId:"2DLayout",streamURL:n.results[0].what.data[0].streamURL})],l,e.pathElement),q()}},onFailure:q})}},onFailure:q}})),J&&(!function(e){var t={input_physical_ids:e.physicalIDs,primitives:[{navigate_from_rel:{id:1,filter:{rel_type:["XCADBaseDependency"]}},navigate_from_sr:{id:2}}],patterns:{relatedXCADDrw:[{id:1}],relatedDrw:[{id:2}]},patternTypeFilters:{relatedXCADDrw:{typesToNotReturn:["XCADNonPSBaseRepReference"]},relatedDrw:{typesToNotReturn:["PGPRep","VPMPort"]}},version:3,attributes:["ds6w:label","ds6w:modified","ds6w:created","ds6w:type"],fileAttributes:["svg","preview_url","thumbnail_2d","icon"],label:"CATRelatedDataDrawingsNav"};V("/cvservlet/navigate",{data:JSON.stringify(t),timeout:parseInt(r.getSetting("webapi_timeout"),10),method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":r.getSetting("lang")},onComplete:function(t){var n,i,a=[],l=[],o=[],c=JSON.parse(t);if(c&&c.result&&c.result.length)for(n=0;n<c.result.length;n++)if(c.result[n].outputs&&c.result[n].outputs.relatedXCADDrw&&c.result[n].outputs.relatedXCADDrw.length||c.result[n].outputs&&c.result[n].outputs.relatedDrw&&c.result[n].outputs.relatedDrw.length){var u=c.result[n].outputs.relatedXCADDrw?c.result[n].outputs.relatedXCADDrw:c.result[n].outputs.relatedDrw;for(i=0;i<u.length;i++)u[i]&&u[i].physicalid&&(u[i].svg?a.push(u[i]):(l.push(u[i]),o.push(u[i].physicalid)))}l.length?d.getUDLData({objectPhysicalid:o,serverUrl:s.get3DSpaceUrl(),securityContext:r.getSetting("pad_security_ctx"),onComplete:function(t){if(t.results){var r,s=[];for(n=0;n<t.results.length;n++){for(r={},i=0;i<t.results[n].attributes.length;i++)"resourceid"===t.results[n].attributes[i].name?r.physicalid=t.results[n].attributes[i].value:"udl"===t.results[n].attributes[i].name&&(r.hasUDL=!0);r.hasUDL&&s.push(r)}for(n=0;n<s.length;n++)for(i=0;i<l.length;i++)if(l[i].physicalid===s[n].physicalid){a.push(l[i]);break}}e.callbacks.onComplete(a)},onFailure:function(){e.callbacks.onComplete(a)}}):e.callbacks.onComplete(a)},onFailure:e.callbacks.onFailure,onTimeout:e.callbacks.onFailure},!0)}({physicalIDs:[J],callbacks:{onComplete:function(t){if(w){for(var n=[],i=0;i<t.length;i++){var l=t[i];n.push(N({type:"Drawing",dType:l["ds6w:type"],physicalid:l.physicalid,appIcon:l.preview_url||l.thumbnail_2d,typeIcon:l.type_icon_url,title:l["ds6w:label"],date:l["ds6w:modified"]?l["ds6w:modified"]:l["ds6w:created"]}))}M(n,a,e.pathElement),w.hideSpinner(),q()}},onFailure:q}}),T.push(e.pathElement.clone()),w.displaySpinner(),H++)}}}function X(e){p&&f&&(e?e.pathElement&&F(e.pathElement):W(!1))}function B(){if(!v){(v={}).onBeginReparent=S.subscribe({event:"onBeginReparent"},function(e){if(p&&f)for(var t=A.length-1;t>=0;t--)(e.reparentedInstance&&A[t].pathElement.externalPath.some(function(t){return t===e.reparentedInstance})||e.pathToReparent&&e.pathToReparent.isParentOf(A[t].pathElement))&&F(A[t].pathElement)}),v.onRootRemoved=S.subscribe({event:"onRootRemoved"},function(e){p&&f&&U([e.path])}),v.onHide=S.subscribe({event:"onHide"},function(e){if(p&&f){var t=[];e.paths.forEach(function(e){t.push(e)}),U(t)}});var e=null;v.VISU=a.subscribe({event:"/VISU/"},function(t){if(p&&f)if("@onViewpointChange"===t.eventType){if(null===e)return void(e=!0);e&&w&&(w.setVisibleFlag(!1,!0),e=!1)}else"@onViewpointEndMove"===t.eventType&&(!1===e&&w&&w.setVisibleFlag(!0),e=null)}),v.onAdd=i.onAdd(O),v.onRemove=i.onRemove(X),v.onEmpty=i.onEmpty(X),v.swapVisibleSpace=S.getViewer().onSwapVisibleSpace?S.getViewer().onSwapVisibleSpace(function(){p&&f&&W(!1)}):null}}this.setActiveState=function(e){p!==e&&(S?(p=e,f&&(p?B():W(!0))):p=!1)},this.getActiveState=function(){return p},this.clearController=function(){this.setActiveState(!1),y=null,w=A=S=L=E=m=null,P=R=I=f=T=b=null},this.setVisibility=function(e){if(w&&p&&f){var t=null;if(e)for(var i=0;i<A.length;i++){var a=A[i].pickPath.getWorldMatrix(S.getViewer()),l=(new n.Matrix4).multiplyMatrices(a,A[i].localMatrix);t=(new n.Vector3).getPositionFromMatrix(l),A[i].position.copy(t)}w.setDataLauncherPosition(t),w.setVisibleFlag(e)}},this.displayDataLauncher=function(e){f!==e&&((f=e)&&p?B():W(!0))},this.isDisplayed=function(){return f}}}),f=[];return t.singleton({init:function(){},giveDataLauncherController:function(e){if(e&&e.context)for(var t=0;t<f.length;t++)if(f[t].context===e.context)return f[t].dataLauncherController},getDataLauncherController:function(e){var t=this.giveDataLauncherController(e);if(e&&e.context&&!t){var n=new p({ctxViewer:e.context});t=Object.freeze({setActiveState:function(e){if(n)return n.setActiveState(e)},getActiveState:function(){if(n)return n.getActiveState()},clearController:function(){n&&(n.clearController(),n=null)},displayDataLauncher:function(e){if(n)return n.displayDataLauncher(e)},isDisplayed:function(){if(n)return n.isDisplayed()},setVisibility:function(e){if(n)return n.setVisibility(e)}}),f.push({context:e.context,dataLauncherController:t})}return t},unregisterDataLauncherController:function(e){if(e&&e.context)for(var t=0;t<f.length;t++)if(f[t].context===e.context){f[t].dataLauncherController.clearController(),f.splice(t,1);break}}})}),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedDataLauncher/CATRelatedDataLauncher",["UWA/Core","UWA/Class","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","DS/SceneGraphNodes/CSS2DNode","DS/Manipulators/Manipulator","DS/CoreEvents/ModelEvents","UWA/Controls/ThemedScroller","DS/UIKIT/Spinner","DS/Controls/Toggle","DS/CATWebUXComponents/CATWebUXPanel","DS/CATWebUXComponents/CATWebUXThumbnail","DS/VisuEvents/EventsManager","css!DS/UIKIT/UIKIT.css","css!DS/CATRelatedDataLauncher/CATRelatedDataLauncher.css"],function(e,t,n,i,a,l,r,s,o,c,u,d,h,p){"use strict";var f="",g="All",v="",m=[];function D(e){for(var t=0;t<m.length;t++)if(m[t].type===e)return{singleCase:m[t].singleCase,multipleCase:m[t].multipleCase};return{singleCase:"",multipleCase:""}}require(["i18n!DS/CATRelatedDataLauncher/assets/nls/CATRelatedDataLauncher"],function(e){f=e.SelectAllLbl,m.push({type:"Layout",singleCase:e.LayoutPreviewSingleLbl,multipleCase:e.LayoutPreviewMultipleLbl}),m.push({type:"Drawing",singleCase:e.DrawingPreviewSingleLbl,multipleCase:e.DrawingPreviewMultipleLbl}),v=e.RelatedDataLauncherPanelTitle});var C=t.extend({init:function(t){var n=t||{};this._parent(n);var i,a,l,r,s,d,v,m,C,b=this,y=[],S=-1,w=0,A=0,T=!1,k=new c;k.getContent().addClassName("dLSpinner");var L=new o;function P(e){var t,i=e.id,a=e.event.from[0].event.shiftKey,l=e.event.from[0].event.ctrlKey,r=-1,s=null;for(t=0;t<y.length;t++)if(y[t].getData().tileId===i){r=t,s=y[t];break}if(s)if(a||(S=r),l)s.setCheckFlag(!s.isChecked());else if(a)if(-1===S)s.setCheckFlag(!s.isChecked()),S=r;else if(S===r)for(t=0;t<y.length;t++)y[t].setCheckFlag(t===r);else{var o=r>S?S:r,c=r>S?r:S;for(t=0;t<y.length;t++)t<o||t>c?y[t].setCheckFlag(!1):t>=o&&t<=c&&y[t].setCheckFlag(!0)}else S=r,b.getSelectedTilesIDs().length>0&&s.setCheckFlag(!0),n.onTileSelectedCB(i)}function E(e){for(var t=e.id,i=null,a=0;a<y.length;a++)if(y[a].getData().tileId===t){i=y[a].getData().type;break}for(var l=0;l<y.length;l++)y[l].setCheckFlag(y[l].getData().type===i);n.onTileSelectedCB()}function I(){r.hasClassName("dLBulletsActivated")?(r.removeClassName("dLBulletsActivated"),v.setStyle("height","0px")):(r.addClassName("dLBulletsActivated"),v.setStyle("height",w+"px"))}function R(){S=-1;var e,t=T;if("All"===g)for(e=0;e<y.length;e++)y[e].setCheckFlag(t);else if(t)for(e=0;e<y.length;e++)y[e].setCheckFlag(y[e].getData().type===g);else for(e=0;e<y.length;e++)y[e].getData().type===g&&y[e].setCheckFlag(!1)}function x(){T=!T,m.checkFlag=T,R()}function V(){T=!T,R(),setTimeout(function(){m.checkFlag=T},0)}function _(e){var t;if(S=-1,"All"===(g=e.from[0].view.dataLauncherType))for(t=0;t<y.length;t++)y[t].setCheckFlag(!0);else for(t=0;t<y.length;t++)y[t].setCheckFlag(y[t].getData().type===g);s.innerHTML=e.from[0].view.innerHTML,I()}function F(){if("All"!==g||A!==y.length||T){if("All"===g&&A!==y.length&&T)T=!1;else if("All"!==g){T=!0;for(var e=0;e<y.length;e++){if(y[e].getData().type===g&&!y[e].isChecked()){T=!1;break}if(y[e].getData().type!==g&&y[e].isChecked()){T=!1;break}}}}else T=!0;m.checkFlag=T}function U(e){if(e.checkFlag){if(e.event&&!1===e.event.shiftKey)for(var t=0;t<y.length;t++)if(y[t].getData().tileId===e.id){S=t;break}A++}else A--;F(),C.innerHTML=A}L.getInnerElement().parentNode.setStyle("height","100%"),this.build=function(t){var o;if(!i){i=e.createElement("div",{id:"CATRelatedDataLauncherPanelDiv",class:"dLTilePanelDiv dLOpacityTransfo dLTilePanelDivDocked"}),a=e.createElement("div",{id:"CATRelatedDataLauncherPanelScrollTileContainer"}),L.inject(a),l=e.createElement("div",{id:"CATRelatedDataLauncherPanelTileContainer",class:"dLPanelTileContainer"}),L.getInnerElement().setContent(l),d=e.createElement("div",{id:"CATRelatedDataLauncherHeaderContainer",class:"dLHeaderContainer"});var c=e.createElement("div",{id:"headerDiv",class:"dLHeaderDiv"}).inject(d);C=e.createElement("span",{id:"counterSpan",class:"dLCounter"}).inject(c),e.createElement("span",{id:"separator",class:"dLSeparator"}).inject(c).innerHTML="|",(m=new u({checkFlag:T}).inject(c)).elements.container.addClassName("dLHeaderCheck"),m.elements.container.setStyle("display","inline-block"),m.elements.checkSign.addClassName("dLHeaderCheckSign"),s=e.createElement("span",{id:"checkDescSpan",class:"dLClickableText"}).inject(c),r=e.createElement("span",{id:"bulletsSpan",class:"fonticon fonticon-dot-3 dLBullets"}).inject(c),(v=e.createElement("div",{id:"divCheckAll",class:"dLCheckAllDiv"})).setStyle("height","0px"),p.addEvent(s,"onPrimaryPointerClick",x),p.addEvent(r,"onPrimaryPointerClick",I),p.addEvent(m.elements.container,"onPrimaryPointerClick",V),p.addEvent(d,"onPrimaryPointerDoubleClick",n.onPanelSizeChangedCB)}var b=t.length||y.length;if(!b&&t.length===y.length)for(o=0;o<t.length;o++)if(y[o].getData()!==t[o]){b=!0;break}if(b){A=0,S=-1;var R=this.getSelectedTilesIDs();for(o=0;o<y.length;o++)y[o].clear();if(y.splice(0,y.length),t&&t.length){for(o=0;o<t.length;o++){for(var N=!1,M=0;M<R.length;M++)if(t[o].tileId===R[M]){N=!0,A++;break}var W=Object.assign({},t[o]);y.push(new h({id:W.tileId,displayType:1,title:W.NLSType,titleIcon:W.typeIcon,subtitle:W.title,additionalText:W.modifDate,preview:W.appIcon,data:W,checkFlag:N,showCheckBoxOnMouseEvt:!0,checkFlagChangedCB:U,clickCB:P,doubleClickCB:E,isCheckable:t.length>1}))}for(d.parentNode===i&&i.removeChild(d),a.parentNode===i&&i.removeChild(a);l.firstChild;)l.removeChild(l.firstChild);for(t.length>1&&d.inject(i),v.inject(d),a.inject(i),a.setStyles({height:t.length>1?"calc(100% - 45px)":"100%"}),o=0;o<y.length;o++)y[o].inject(l);k.inject(l),function(){for(var t,n,i=[];v.firstChild;)p.removeEvent(v.firstChild,"onPrimaryPointerClick",_),v.removeChild(v.firstChild);for(t=0;t<y.length;t++)-1===i.indexOf(y[t].getData().type)&&i.push(y[t].getData().type);if(i.length>1)for(r.show(),w=30*(i.length+1),(n=e.createElement("div",{class:"dLClickableText dLCheckOptions"}).inject(v)).innerHTML=f,n.dataLauncherType="All",p.addEvent(n,"onPrimaryPointerClick",_),t=0;t<i.length;t++)(n=e.createElement("div",{class:"dLClickableText dLCheckOptions"}).inject(v)).innerHTML=D(i[t]).multipleCase,n.dataLauncherType=i[t],p.addEvent(n,"onPrimaryPointerClick",_);else r.hide(),w=0}(),r.hasClassName("dLBulletsActivated")&&I(),C.innerHTML=A,F(),s.innerHTML="All"===g?f:D(g).multipleCase}}},this.getContent=function(){return i},this.setSpinnerVisibility=function(e){e?k.show():k.hide()},this.getSelectedTilesIDs=function(){for(var e=[],t=0;t<y.length;t++)y[t].isChecked()&&e.push(y[t].getData().tileId);return e},this.clear=function(e){if(i){for(var t=0;t<y.length;t++)y[t].clear();for(;i.firstChild;)i.removeChild(i.firstChild);y.splice(0,y.length),e&&(p.removeEvent(s,"onPrimaryPointerClick",x),p.removeEvent(r,"onPrimaryPointerClick",I),p.removeEvent(m.elements.container,"onPrimaryPointerClick",V),p.removeEvent(d,"onPrimaryPointerDoubleClick",n.onPanelSizeChangedCB),L.destroy(),k.destroy(),i=L=k=null)}},this.setSelectedTilesIDs=function(e){var t,n;if(e){for(t=0;t<y.length;t++)y[t].setCheckFlag(!1);for(t=0;t<e.length;t++)for(n=0;n<y.length;n++)y[n].getData().tileId===e[t]&&y[n].setCheckFlag(!0)}}}});return t.extend({init:function(t){var o=t||{};this._parent(o);var c=!1,u=new n("CATRelatedDataLauncherMainNode");u.setVisibilityInTree(!1),u.exludeFromBounding(!0),u._getExcludeFromCSO=function(){return!0},u.setVisibilityFree(!0),o.viewer.addNode(u,!1);var h,p=null,f=null,m=[],b=[],y=new s,S=new i.Vector3,w=null,A=null,T=!1,k=!1,L=0,P=null,E=null,I="left"===localStorage.getItem("CATRelatedDataLauncherDockPref")||"right"===localStorage.getItem("CATRelatedDataLauncherDockPref");function R(e){for(var t=0;t<m.length;t++)if(e===m[t].tileId)return m[t]}function x(e){for(var t=0;t<e.length;t++)e[t].NLSType||(e[t].NLSType=D(e[t].type).singleCase)}function V(e,t){return"onRelatedDataSelected"===e&&x(t),y.publish({event:e,data:t,context:this})}function _(e){if(c){var t=[];e&&t.push(R(e));var n=[];P&&(n=P.getSelectedTilesIDs()),1===m.length&&(n=[m[0].tileId]);for(var i=0;i<n.length;i++){var a=R(n[i]);-1===t.indexOf(a)&&t.push(a)}I||E.setPanelVisibilityFlag(!1),V("onRelatedDataSelected",t)}}function F(){I&&(305!==E.getWidth()?(h=E.getWidth(),E.setWidth(305)):h&&E.setWidth(h))}function U(){P&&(P.clear(!0),P=null),E&&(E.clean(),E=null),u.setVisibility(!0),I=!1,o.viewer.render()}function N(e){localStorage.setItem("CATRelatedDataLauncherDockPref",e.currentDockArea===WUXDockAreaEnum.LeftDockArea?"left":e.currentDockArea===WUXDockAreaEnum.RightDockArea?"right":"none"),E.setResizableFlag(e.currentDockArea!==WUXDockAreaEnum.NoneDockArea),I=e.currentDockArea!==WUXDockAreaEnum.NoneDockArea,u.setVisibility(!I),E.setMinWidth(I?308:305),o.viewer.render()}function M(){P||(P=new C({onTileSelectedCB:_,onPanelSizeChangedCB:F})),x(m),P.build(m);var e=o.viewer.getViewpoints()[0].project(S),t={at:"top left",offsetX:0,offsetY:0},n=0===m.length||1===m.length?104:2===m.length?244:300;e.x<305?t.offsetX=15:e.x+305>o.viewer.SCREEN_WIDTH?t.offsetX=o.viewer.SCREEN_WIDTH-305-15:t.offsetX=e.x-152.5,e.y<n?t.offsetY=15:e.y+n>o.viewer.SCREEN_HEIGHT?t.offsetY=o.viewer.SCREEN_HEIGHT-n-15:t.offsetY=e.y-(1===m.length?90:130);var i=localStorage.getItem("CATRelatedDataLauncherDockPref"),l="left"===i?WUXDockAreaEnum.LeftDockArea:"right"===i?WUXDockAreaEnum.RightDockArea:WUXDockAreaEnum.NoneDockArea;if(E)I||(E.setPanelPosition(t),E.setMinHeight(n),E.setHeight(n));else{var r={id:"CATRelatedDataLauncherPanel",className:"CATRelatedDataLauncherPanel",title:v,showTitleFlag:!1,icon:a.getWebappsAssetUrl("CATRelatedDataLauncher","icons/32/")+"I_RevealRelatedDataCmd.png",immersiveFrame:o.window.getImmersiveFrame(),viewerFrame:o.window.getViewerFrame(),content:P.getContent(),minWidth:305,width:305,widthStep:296,minHeight:n,height:n,heightStep:94,resizableFlag:!1,closeButtonFlag:!0,autoCloseFlag:!1,closePanelCB:U,onPlaceChangedCB:N,position:t,currentDockArea:l,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea};E=new d(r)}N({currentDockArea:l})}function W(e){for(var t,n=[],i=[],a="boolean"==typeof e&&e,l=0;l<m.length;l++){if(t=!0,m[l].appIcon)t=!1;else for(var r=0;r<b.length;r++)if(b[r].type===m[l].type){m[l].appIcon!==b[r].icon&&(m[l].appIcon=b[r].icon,a=!0),t=!1;break}t?i.push(m[l].type):n.push(m[l])}if(i.length&&window.console.log("No type icon returned by server query"),E){var s=0===n.length||1===n.length?92:2===n.length?220:302;E.setMinHeight(s),E.setHeight(s)}a&&P&&(x(n),P.build(n))}function O(){S&&(k||(c=!1,f.setVisibility(!0),w.addClassName("dLPinAnimation"),setTimeout(function(){w&&w.removeClassName("dLPinAnimation"),c=!0},550),k=!0),f.setMatrix((new i.Matrix4).setPosition(S)))}function X(){S&&(p.setMatrix((new i.Matrix4).setPosition(S)),p.isVisible()||(A.setAttribute("style","animation-iteration-count:infinite;"),p.setVisibility(!0)))}this.show=function(){!function(){if(!p&&!f){A=e.createElement("div",{id:"CATRelatedDataLauncherWaitingDiv",class:"dLWaitingMarker"}),(p=new l({html:A,name:"CATRelatedDataLauncherWaitingNode"}))._getExcludeFromCSO=function(){return!0},p.css2DNode.primitive=!0,p.setVisibilityInTree(!1),p.exludeFromBounding(!0),p.setOffset(new i.Vector2(-20,-12)),p.setVisibility(!1),p.setPickability(!1);var t=a.getWebappsAssetUrl("CATRelatedDataLauncher","textures/I_W3dDataLauncherPin_Over.png"),n=a.getWebappsAssetUrl("CATRelatedDataLauncher","textures/I_W3dDataLauncherPin.png");(w=e.createElement("div",{id:"CATRelatedDataLauncherPinDiv",class:"dLPinMainDiv"})).setStyle("backgroundImage",'url("'+n+'")'),(f=new l({html:w,name:"CATRelatedDataLauncherPinNode"})).setVisibilityInTree(!1),f.exludeFromBounding(!0),f.setOffset(new i.Vector2(-20,-54)),f._getExcludeFromCSO=function(){return!0},f.css2DNode.primitive=!0,f.setNoZ(!0),f.setVisibility(!1);var s=new(r.extend({init:function(e){var t=e||{};this._parent(t),this.setExclusive(!0),this._token=-1},PrimaryPointerClick:function(e,t,n){if(this._parent(e,t,n),-1===this._token){var i=this;this._token=setTimeout(function(){i.publish("Click"),i._token=-1},200)}else clearTimeout(this._token),this._token=-1,this.publish("DblClick")},BeginPreactivate:function(e,t,n){this._parent(e,t,n),this.publish("BeginPreactivate")},EndPreactivate:function(e,t,n){this._parent(e,t,n),this.publish("EndPreactivate")}}))({viewer:o.viewer});s.subscribe("Click",function(){c&&(M(),W(),P?(E.setPanelVisibilityFlag(!0,!0),P.setSpinnerVisibility(L>0)):E.setPanelVisibilityFlag(!1),o.window.getContextualUIManager().hideContextualMenus())}),s.subscribe("DblClick",function(){if(c){if(P){var e,t=[];if("All"===g)for(e=0;e<m.length;e++)t.push(m[e].tileId);else for(e=0;e<m.length;e++)m[e].type===g&&t.push(m[e].tileId);t.length&&(P&&P.setSelectedTilesIDs(t),_())}else V("onRelatedDataSelected",m);o.window.getContextualUIManager().hideContextualMenus()}}),s.subscribe("BeginPreactivate",function(){c&&w.setStyle("backgroundImage",'url("'+t+'")')}),s.subscribe("EndPreactivate",function(){c&&w.setStyle("backgroundImage",'url("'+n+'")')}),s.linkToNode(f),u.addChild(f),u.addChild(p)}}(),m.length?(p&&p.isVisible()&&p.setVisibility(!1),O(),I&&(E||M(),W(),E.setPanelVisibilityFlag(!0))):X(),T=!0,o.viewer.render()},this.clear=function(e){m=[],P&&P.clear(e),E&&E.setPanelVisibilityFlag(!1),f&&f.isVisible()&&f.setVisibility(!1),p&&p.isVisible()&&p.setVisibility(!1),e&&(E&&E.destroy(),o.viewer.removeNode(u,!1),E=u=p=f=m=null,b=y=S=P=w=A=null),T=c=k=!1,o.viewer.render()},this.clearIfWaiting=function(){m.length||this.clear()},this.update=function(){T&&(m.length?(O(),p&&p.isVisible()&&p.setVisibility(!1),I&&(E||M(),W(),E.setPanelVisibilityFlag(!0,!0))):X(),o.viewer.render())},this.displaySpinner=function(){L++,P&&1===L&&P.setSpinnerVisibility(!0)},this.hideSpinner=function(){L--,P&&0===L&&P.setSpinnerVisibility(!1)},this.addTile=function(e){for(var t=!0,n=0;n<m.length;n++)if(m[n].tileId===e.tileId&&m[n].appId===e.appId){t=!1;break}return t&&m.push(e),W(t),t},this.removeTile=function(e){for(var t=!1,n=0;n<m.length;n++)m[n].tileId===e.tileId&&m[n].appId===e.appId&&(m.splice(n,1),t=!0);W(t),E&&0===m.length&&E.setPanelVisibilityFlag(!1)},this.setDataLauncherPosition=function(e){if(e){S.copy(e);var t=(new i.Matrix4).setPosition(e);p&&p.setMatrix(t),f&&f.setMatrix(t)}},this.setVisibleFlag=function(e,t){(!t&&E&&I||t&&E&&!I)&&(e&&m.length||!e)&&E.setPanelVisibilityFlag(e,!0),u&&(e&&!I||!1===e)&&u.setVisibility(e),o.viewer.render()},this.subscribe=function(e,t){if("onRelatedDataSelected"===e)return y.subscribe({event:e},t)},this.unsubscribe=function(e){e&&y&&y.unsubscribe(e)}}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedDataLauncher/CATRevealRelatedDataCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/PADUtils/PADContext"],function(e,t,n){"use strict";return e.extend({init:function(e){this._parent(e,{});var i=this,a=null,l=this.onStateChange(function(){a||(a=n.get()),t.getDataLauncherController({context:a}).displayDataLauncher(i.getState()),localStorage.setItem("CATRevealRelatedDataCmd",i.getState()?"true":"false")}),r=this._destroy;this._destroy=function(){a&&t.unregisterDataLauncherController({context:a}),i._modelEvents.unsubscribe(l),r.call(i)};var s="true"===localStorage.getItem("CATRevealRelatedDataCmd");this.setState(s,!0),s&&require(["DS/CATWebUXComponents/CATWebUXUtils"],function(e){e._sendUsageProbe("commandCheck","RevealRelatedDataOn")})},_destroy:function(){this._parent()}})});