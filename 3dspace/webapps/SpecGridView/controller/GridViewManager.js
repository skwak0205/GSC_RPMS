define("DS/SpecGridView/controller/GridViewManager",["UWA/Core","UWA/Class","DS/DataGridView/DataGridView","DS/XSRCommonComponents/utils/Utils","DS/SpecGridView/controller/GridColumn","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/components/XSpecDnD/DragDropUtil","i18n!DS/SpecGridView/assets/nls/SpecGridView"],function(e,t,n,o,i,l,s,r,a){"use strict";return t.extend({init:function(t){var n=t;this._parent(n),this.appCore=n.appCore,this.itemId=n.itemId;var o=n.container,l=n.columns;this.modelEvents=n.appCore.specViewerModelEvents,this.model=n.model,this.currentTabKey=n.currentTabKey,this.rowDragEnabledFlag=!t.dvgOpts||!1!==t.dvgOpts.rowDragEnabledFlag,this.basicModelEvents=n.appCore.basicModelEvents,this.container=e.createElement("div",{id:"grid-row-view"}).inject(o),this.parentModel=t.parentModel,this.gridColumns=new i,l&&this.initializeColumns(l),this._subscribe()},_subscribe:function(){this.eventList=[]},initializeColumns:function(e){this.columnCharValidationList={},this.exportableColums=[],this.columns=this.gridColumns.process.call(this,e)},addColumn:function(e,t,n){if(!n){let n=[e];this.processedColumns=this.gridColumns.process.call(this,n),this.grid.addColumnOrGroup(this.processedColumns[0],t)}},removeColumn:function(e,t){t&&this.grid.removeColumnOrGroup(e)},setColumns:function(e){this.initializeColumns(e)},drawGrid:function(e,t){var o=this;!function(){o.grid=new n({columns:o.columns,showModelChangesFlag:!0,showTreeIconsFlag:!0,showRowBorderFlag:!0,treeDocument:o.model,showNodeKPIColorFlag:o.model.isColorized,cellSelection:"multiple",rowSelection:"multiple",rowDragEnabledFlag:o.rowDragEnabledFlag,onContextualEvent:function(e,t){if(e&&e.collectionView&&e.cellInfos){e.collectionView.columns.length;var n=e.cellInfos.columnID,i=e.cellInfos.rowID;if(!(n>=0&&i>=0))return e.collectionView.buildDefaultContextualMenu(e,t);e.cellInfos.nodeModel.isSelected()||(e.collectionView.unselectAll(),e.cellInfos.nodeModel.select());var l=o.currentTabKey?s.GRID_CONTEXT_MENU+"-"+o.currentTabKey:s.GRID_CONTEXT_MENU;o.modelEvents&&o.modelEvents.publish({event:l,data:e})}}.bind(this)}),o.grid.inject(o.container),o.grid.layout.cellHeight=24,o.model.setLayoutInstance(o.grid.layout),o.grid.onCustomViewsSave=function(e,t){var n=e;widget.setValue("CustomGridViews"+o.currentTabKey,n),widget.setValue("CurrentCustomViewIndex"+o.currentTabKey,t)};var e,t=widget.getValue("CustomGridViews"+o.currentTabKey),i=widget.getValue("CurrentCustomViewIndex"+o.currentTabKey);e="number"==typeof i?i>=0:i,t&&e&&o.grid.loadCustomViews(t,i),o.rowDragEnabledFlag&&(o.grid.onDragStartRowHeaderDefault=function(e,t){o.model.unselectAll(),t.nodeModel.select();var n=(new r).prepareDragData(o.model.getSelectedNodes());e.dataTransfer.effectAllowed="all",e.dataTransfer.setData("text",n)},o.grid.onDragOverRowHeader=function(){console.log("Drag over ignored to avoid css change in UI")},o.grid.onDragOverCell=function(){console.log("Drag over cell ignored to avoid css change in UI")},o.grid.onDropRowHeader=function(e,t){console.log("Drop ignored")});o.grid.getTypeRepresentationFactory().registerTypeTemplates(JSON.stringify({UWAObjectTemplate:{path:"DS/SpecGridView/utils/UWAObjectTemplate",options:{}}})),o.addEvents();var l={};l[a.label_Yes]=!0,l[a.label_No]=!1;var d={contextMenu:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"chevron-down",fontIconFamily:1}}},quickViewMenu:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"eye",fontIconFamily:1}}},positiveInteger:{stdTemplate:"spinEdit",semantics:{stepValue:1,minValue:1}},UWAObject:{stdTemplate:"UWAObjectTemplate"},DisplayBooleanCombobox:{stdTemplate:"enumCombo",semantics:{possibleValues:l,valueType:"enumCusto"}}};o.grid.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(d))}(),this.model.unselectAll(),t?o.hide():o.show()},addEvents:function(){var t=this;this.grid.getCellsXSO().onPostAdd(function(n){if(n&&e.is(n,"array")&&1==n.length){t.grid.unselectAll(),!n[0].nodeModel._canBeGrouped()?setTimeout(function(){n[0].nodeModel.select()},50):n[0].nodeModel.select()}}),this.grid.addEventListener("click",function(e,n){if(void 0!==n&&-1!==n.rowID){if(!e.target.hasClassName("wux-tweakers-string-icon"))return;var o=e.dsModel.layout.getDataIndexFromColumnIndex(n.columnID);if("Alternate"===o){let e={cellInfo:n,column:o};t.modelEvents&&t.modelEvents.publish({event:s.EVENT_BOM_GRID_ICON_CLICK,data:e})}}}),this.grid.addEventListener("dragstart",function(e,t){o.dragStartedInXSR=!0}),this.grid.addEventListener("dragend",function(e,t){o.dragStartedInXSR=!1}),this.grid.addEventListener("preEdit",function(e,n){t.grid.getTreeDocument().cancelChanges()});var n=function(e){if(e.columnIndex)var n=e.columnIndex;else n=t.grid.layout.getDataIndexFromColumnIndex(e.columnID);var i=e.cellModel,r=e.nodeModel?e.nodeModel.getReferenceValue(n):void 0;r=r&&Array.isArray(r)?r[0]:r;var d="string"==typeof i?i.trim():i;if(d!==r)if(t.columnCharValidationList&&t.columnCharValidationList[n]&&o.hasBadChar(d)){var u=a.replace(a.get("FailedToUpdateCell"),{forbiddenChar:s.FORBIDDEN_CHARS});l.displayNotification({eventID:"error",msg:u}),t.modelEvents&&t.modelEvents.publish({event:"xsr-show-toolbar-reset-command-"+t.currentTabKey})}else t.modelEvents&&(t.modelEvents.publish({event:"xsr-hide-toolbar-reset-command-"+t.currentTabKey}),t.modelEvents.publish({event:"grid-cell-value-update-"+t.currentTabKey,data:{nodeModel:e.nodeModel,newValue:d,oldValue:r,dataIndex:n}}));else t.modelEvents&&t.modelEvents.publish({event:"xsr-hide-toolbar-reset-command-"+t.currentTabKey})};this.grid.addEventListener("postEdit",function(e,o){var i=t.grid.layout.getDataIndexFromColumnIndex(o.columnID);i!==s.COLUMN_QUANTITY&&i!==s.COLUMN_UOM&&n(o)}),this.grid.getTreeDocument().onNodeModelUpdate(function(e){if(e.data.attributes){var t=e.data.attributes;if(t.quantity)(o={}).columnIndex=s.COLUMN_QUANTITY,o.nodeModel=e.target,o.cellModel=t.quantity,n(o);else if(t.asNeeded){(o={columnIndex:"asNeeded"}).nodeModel=e.target,o.cellModel=t.asNeeded,n(o)}else if(t.uom){var o;(o={columnIndex:"uom"}).nodeModel=e.target,o.cellModel=t.uom,n(o)}}}),this.grid.addEventListener("change",function(e,o){void 0===o||"boolean"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"independantBoolean"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"string"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)||n(o)})},highlightCell:function(e,t){if(e&&t){var n=this.grid.layout.getColumnIndex(t),o=this.grid.layout.getCellIDFromCoordinates({rowID:e,columnID:n});o&&this.grid.selectCell(o)}},setColumnVisibilityFlag:function(e,t){this.grid.layout.setColumnVisibleFlag(e,t)},exportCSV:function(e){var t=this.grid.layout.getVisibleOrderedColumnsIndexes(),n=[];if(t&&t.length>0){for(var i=0;i<t.length;i++){var l=t[i],r=this.grid.layout.getDataIndexFromColumnIndex(l);this.exportableColums.indexOf(r)>=0&&n.push(r)}var a=this.grid.getAsCSV({forceQuotes:!1,allColumns:!1,onlySelectedRows:!(!e||!e.onlySelectedRows)&&e.onlySelectedRows,columnKeys:n,columnSeparator:e&&e.columnSeparator?e.columnSeparator:void 0,addLevelInformation:this.currentTabKey===s.BOM_TAB});o.downloadCSV(a,e.fileName)}},personalizeColumns:function(){this.grid.showCustomViewsDialog()},hide:function(){this.container.setStyle("display","none")},show:function(){this.container.setStyle("display","block")},destroy:function(){this.eventList&&this.eventList.length>0&&this.modelEvents.unsubscribeList(this.eventList)}})});