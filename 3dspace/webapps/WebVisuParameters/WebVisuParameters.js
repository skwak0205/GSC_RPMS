define("DS/WebVisuParameters/CSICustomNodeHandler",["UWA/Class","DS/Visualization/Node3D"],function(e,t){"use strict";return e.extend({init:function(){},handleMessage:function(e){return t()},handleUpdateMessage:function(e,t){}})}),define("DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionXSO",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=function(e){this._addedPaths=null,this._keyToPath=null,this._treeKeyToStruct=new Map,this._currentTreeKey=null,this.viewer=e,this._event="",this.highlightColor=null};return i.prototype._setTreeKey=function(e){var t=null;this._currentTreeKey=e,this._treeKeyToStruct.has(e)&&(t=this._treeKeyToStruct.get(e)),t||(t={keyToPath:new Map,addedPaths:new Map},this._treeKeyToStruct.set(e,t)),this._keyToPath=t.keyToPath,this._addedPaths=t.addedPaths},i.prototype.getPathFromKey=function(e){return this._keyToPath.get(e)},i.prototype._add=function(t){e.publish({event:"/VISU/SELECTION/CSI_"+this._event+"_ADD",data:{eventChannel:"/VISU/SELECTION/CSI_"+this._event+"_ADD",eventType:"@CSI_"+this._event+"_ADD",path:t,parameters:{highlightColor:this.highlightColor,viewer:this.viewer}}})},i.prototype.add=function(e){var t=e.hash(),i=this._addedPaths;this._keyToPath.set(t,e),i.has(t)?i.set(t,i.get(t)+1):(i.set(t,1),this._add(e))},i.prototype._remove=function(t){e.publish({event:"/VISU/SELECTION/CSI_"+this._event+"_REMOVE",data:{eventChannel:"/VISU/SELECTION/CSI_"+this._event+"_REMOVE",eventType:"@CSI_"+this._event+"_REMOVE",path:t,parameters:{highlightColor:this.highlightColor,viewer:this.viewer}}})},i.prototype.remove=function(e){var t=e.hash(),i=this._addedPaths;i.has(t)&&(i.set(t,i.get(t)-1),0===i.get(t)&&(i.delete(t),this._keyToPath.delete(t),this._remove(e)))},i.prototype.removeAll=function(){var e=this;this._addedPaths&&this._addedPaths.forEach(function(t,i,r){var a=e.getPathFromKey(i);if(a)for(var n=0;n<t;n++)e.remove(a)})},i}),define("DS/WebVisuParameters/GeometryParameterHelper",["UWA/Class","DS/CSIViewModelWebInterfaces/CSIVMClientGeometryParameter","DS/CSIViewModelWebInterfaces/CSIVMClientDrawGroupParameter","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/GraphicAttributeSet"],function(e,t,i,r,a,n){"use strict";var o=i.prototype.geomTypeValues,s=[0];const l={[o.unknown]:{glType:4,geomType:r.GeomTypeEnum.UNKNOWN},[o.unknown_0D]:{glType:0,geomType:r.GeomTypeEnum.UNKNOWN},[o.unknown_1D]:{glType:1,geomType:r.GeomTypeEnum.UNKNOWN},[o.unknown_2D]:{glType:4,geomType:r.GeomTypeEnum.UNKNOWN},[o.unknown_3D]:{glType:4,geomType:r.GeomTypeEnum.UNKNOWN},[o.edge]:{glType:1,geomType:r.GeomTypeEnum.EDGE},[o.wire_Edge]:{glType:1,geomType:r.GeomTypeEnum.WIRE_EDGE},[o.boundary_Edge]:{glType:1,geomType:r.GeomTypeEnum.BOUNDARY_EDGE},[o.sharp_Edge]:{glType:1,geomType:r.GeomTypeEnum.SHARP_EDGE},[o.smooth_Edge]:{glType:1,geomType:r.GeomTypeEnum.SMOOTH_EDGE},[o.hidden_Seam_Edge]:{glType:1,geomType:r.GeomTypeEnum.HIDDEN_SEAM_EDGE},[o.boundary_Point]:{glType:0,geomType:r.GeomTypeEnum.BOUNDARY_POINT},[o.sharp_Point]:{glType:0,geomType:r.GeomTypeEnum.SHARP_POINT},[o.smooth_Point]:{glType:0,geomType:r.GeomTypeEnum.SMOOTH_POINT},[o.hidden_Seam_Point]:{glType:0,geomType:r.GeomTypeEnum.HIDDEN_SEAM_POINT},[o.surfacic_Point]:{glType:0,geomType:r.GeomTypeEnum.SURFACIC_POINT},[o.free_Point]:{glType:0,geomType:r.GeomTypeEnum.FREE_POINT},[o.infinite_Face]:{glType:4,geomType:r.GeomTypeEnum.INFINITE_FACE},[o.face]:{glType:4,geomType:r.GeomTypeEnum.FACE}};r.MaterialUtils.createShinyFaceMaterial({side:r.DoubleSide,color:new r.Color(16777215)}),r.MaterialUtils.createShinyFaceMaterial({side:r.FrontSide,color:new r.Color(16777215)});var d=new n({colorRGB:new r.Color(16777215),basic:!0}),c=new n({colorRGB:new r.Color(16777215)}),h=new n({colorRGB:new r.Color(0),inheritance:r.GASEnum.RGBA_INHERITANCE_ON});return e.extend({init:function(e,t){this.parameter=e,this.version=t.version,this.hasGeomDecorations=t.hasGeomDecorations},getGeometry:function(e,t){var i=e.getDefaultMaterials(),n=(i.volume,i.surface,i.line,i.point,new r.BufferGeometryDS),u=!1;let g=!1;var p,f=[],v=0;for(var m in this.parameter.bufferPartitionValues){var S=this.parameter.bufferPartitionValues[m],y=this.parameter.getBufferPartition(S);if(y)if(S===this.parameter.bufferPartitionValues.vertexIndexArray){g=4===y.getBytePerElement();const e=y.getByteLength()/y.getBytePerElement();p=g?new Uint32Array(this.parameter.getBuffer(),y.getOffset(),e):new Uint16Array(this.parameter.getBuffer(),y.getOffset(),e),1===this.version&&(n[m]=p)}else if(S===this.parameter.bufferPartitionValues.primitiveDecorationArray)this.hasGeomDecorations&&(n.decorations=new Uint8Array(this.parameter.getBuffer(),y.getOffset(),y.getByteLength()));else{var T=new Float32Array(this.parameter.getBuffer(),y.getOffset(),y.getByteLength()/y.getBytePerElement());if(S===this.parameter.bufferPartitionValues.vertexUv2Array){for(var _=new Float32Array(3*T.length/2),w=0;w<T.length/2;w++)_[3*w]=T[2*w],_[3*w+1]=T[2*w+1],_[3*w+2]=0;T=_}n[m]=T}}var I=new a.SGRep({solid:t}),C=this.parameter.getDrawGroups(),D=[];for(w=0;w<C.length;w++){var E=C[w],P=E.getPrimitives();P=new Uint32Array(this.parameter.getBuffer(),P.getOffset(),P.getByteLength()/P.getBytePerElement());var M=l[E.getGeomType()],A=M.glType,b=M.geomType;E.getGeomType()===o.unknown_2D&&(u=!0);var V=[],O=[],N=new a.DrawingGroup(4===A?u?d:c:h,null,A,2===this.version?v:E.getStart(),E.getCount(),V,void 0,b,0);if(N.geometry=n,n.drawingGroups.push(N),2===this.version)for(var G=1===A&&b!==r.GeomTypeEnum.WIRE_EDGE?1:0,R=4+G+(z=this.hasGeomDecorations?1:0),H=0;H<P.length;H+=R){var L=P[H],B=P[H+1],x=!G||P[H+3+G],F=v;if(x)for(var U=L;U<L+B;U++)f[v]=p[U],f[v]>65535&&(g=!0),v++;else for(U=0;U<B-1;U++)f[v]=L+U,f[v+1]=L+U+1,(f[v]>65535||f[v+1]>65535)&&(g=!0),v+=2;var k=B>0?2*(B-1):0,W=new a.SGPrimitive({start:F,count:x?B:k,cgmId:P[H+2],rep:I,group:N});if(z)4294967294===(j=P[H+3+G+z])?W.decoration=s:4294967295!==j&&(W.decoration=j);V.push(W),O.push(P[H+3]),I._primitives.push(W)}else{var z;for(R=4+(z=this.hasGeomDecorations?1:0),H=0;H<P.length;H+=R){var j;W=new a.SGPrimitive({start:P[H],count:P[H+1],cgmId:P[H+2],rep:I,group:N});if(z)4294967294===(j=P[H+3+z])?W.decoration=s:4294967295!==j&&(W.decoration=j);V.push(W),O.push(P[H+3]),I._primitives.push(W)}}D.push(O)}if(2===this.version&&(n.vertexIndexArray=g?new Uint32Array(f):new Uint16Array(f)),!n.boundingBox){var X=[0,0,0],K=[0,0,0],J=n.vertexPositionArray;if(J){var Y=J.length;if(Y>=3){X=[J[0],J[1],J[2]],K=[J[0],J[1],J[2]];for(var Z=0;Z<Y;Z+=3)J[Z]<X[0]&&(X[0]=J[Z]),J[Z+1]<X[1]&&(X[1]=J[Z+1]),J[Z+2]<X[2]&&(X[2]=J[Z+2]),J[Z]>K[0]&&(K[0]=J[Z]),J[Z+1]>K[1]&&(K[1]=J[Z+1]),J[Z+2]>K[2]&&(K[2]=J[Z+2])}}X=new r.Vector3(X[0],X[1],X[2]),K=new r.Vector3(K[0],K[1],K[2]),n.boundingBox=new r.Box3(X,K),n.boundingSphere=new r.Sphere(K.clone().add(X).multiplyScalar(.5),K.clone().sub(X).multiplyScalar(.5).length())}return{geometry:n,primitiveIDs:D,is2Din3D:u}},updateGeometry:function(e){if(e){var t=e.getPrimitives();if(Array.isArray(t)&&0!==t.length){var i,r={},a=0;t.forEach(function(e){(i=e.getIdentificationObject())&&void 0!==(a=i.getLocalId())&&(r[a]=e)});for(var n=e._occurrences[0].renderable.geometry,o=0;o<n.length;o++)n[o].needsUpdate=!0;var s=n[0],l=s.vertexIndexArray,d=s.vertexPositionArray;if(l&&d){var c,h,u,g={};for(var p in this.parameter.bufferPartitionValues)if(h=this.parameter.bufferPartitionValues[p],(c=this.parameter.getBufferPartition(h))&&h!==this.parameter.bufferPartitionValues.vertexIndexArray){u=new Float32Array(this.parameter.getBuffer(),c.getOffset(),c.getByteLength()/c.getBytePerElement()),g[p]=u;for(o=0;o<n.length;o++){var f=n[o];(d=f.vertexPositionArray)&&!f[p]&&(f[p]=new Float32Array(d.length))}}var v,m=this.parameter.getDrawGroups();if(Array.isArray(m)&&1===m.length&&(v=m[0]),v){var S=v.getPrimitives();if(S){var y,T,_,w,I,C,D,E,P,M;S=new Uint32Array(this.parameter.getBuffer(),S.getOffset(),S.getByteLength()/S.getBytePerElement());for(var A=0;A<S.length;A+=3)if(a=S[A],T=S[A+1],_=S[A+2],(y=r[a])&&y.sgNode){l=(M=y.sgNode.getGroup().geometry).vertexIndexArray,d=M.vertexPositionArray;w=y.sgNode.getStart(),I=y.sgNode.getCount(),E=D=l[w];for(o=1;o<I;++o)(C=l[o+w])<D?D=C:C>E&&(E=C);if(P=3*(E-D+1),_&&_!==d.length||(_=P),P&&P===_)for(var p in g)for(o=0;o<_;++o)M[p][o+3*D]=g[p][o+T]}}}}}}}})}),define("DS/WebVisuParameters/AbstractWebVisuUpdateTransaction",["DS/CSIViewModelWebInterfaces/CSIVMClientTransaction"],function(e){"use strict";var t=function(e,t,i){if(window.newMaterialInheritance=!0,this.clientManager=i,this.viewManager=e,this.treeKeyID=t.getUUID?t.getUUID():null,this.view=null,e)if(t.getViewpointUID&&0!==t.getViewpointUID()){let i=e._viewpointMap.get(t.getViewpointUID());if(i){let t=e.viewer._viewpointManager.getViewpointScenegraph(i);this.view=t?e.addView(this.treeKeyID,t.userRoot):e.getView(this.treeKeyID)}else console.error("no viewpoint correspond to this uid")}else this.view=e.getView(this.treeKeyID)};return(t.prototype=Object.create(e.prototype)).doOperation=function(e){throw"Not implemented"},t.prototype.commit=function(){throw"Not implemented"},t.prototype.abort=function(){throw"Not implemented"},t.prototype.executeEnd=function(){throw"Not implemented"},t.prototype.executeInverse=function(){throw"Not implemented"},t}),define("DS/WebVisuParameters/CustomDataParameterHelper",["UWA/Class","DS/CSIViewModelWebInterfaces/CSIVMClientCustomDataParameter","DS/Visualization/Node3D"],function(e,t,i){"use strict";return e.extend({init:function(e,t){this.parameter=e,this.onFinishedCB=t},getNode:function(){var e=this,t=new i;return require([this.parameter.getModule()],function(i){if(i){var r=(new i).handleMessage(e.parameter.getData());t.addChild(r),e.onFinishedCB&&e.onFinishedCB()}},this.onModuleError),t},modifyNode:function(e){var t=this;require([this.parameter.getModule()],function(i){if(i){var r=new i,a=null;if(e){a=e.children[0];for(var n=e.getChildren(),o=0;o<n.length;o++)if(!n[o].getModelIdentification()){a=n[o];break}}r.handleUpdateMessage(t.parameter.getData(),a),t.onFinishedCB&&t.onFinishedCB()}},this.onModuleError)},onModuleError:function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing.")}})}),define("DS/WebVisuParameters/CSISelectionObject",["DS/CSIViewModelWebInterfaces/CSIVMClientSelectionObject"],function(e){return e}),define("DS/WebVisuParameters/GraphicPropertyParameterHelper",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/MaterialApplication","DS/Visualization/GraphicAttributeSet","DS/VisuLoaders/ThreeDXResourcesLibrary","DS/VisuLoaders/ThreeDXLoader","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/CSIViewModelWebInterfaces/CSIViewModelWebEnv","DS/CSIViewModelWebInterfaces/CSIVMClientDrawGroupParameter","DS/CSIViewModelWebInterfaces/CSIVMClientCustomPropertyParameter","DS/Visualization/PickingMode","DS/Visualization/RenderStyle","DS/Visualization/Filters/GeomTypeFilter","DS/Visualization/Filters/DoNotPickUnderFilter","DS/Visualization/Filters/LookFilter"],function(e,t,i,r,a,n,o,s,l,d,c,h,u,g,p,f,v){"use strict";var m=new n,S=new o,y=-1,T=new Map,_=new Map,w=c.prototype.geomTypeValues,I={};I[w.unknown]=t.GeomTypeEnum.UNKNOWN,void 0!==w.unknown_2D&&(I[w.unknown_2D]=t.GeomTypeEnum.FACE),I[w.edge]=t.GeomTypeEnum.EDGE,I[w.wire_Edge]=t.GeomTypeEnum.WIRE_EDGE,I[w.boundary_Edge]=t.GeomTypeEnum.BOUNDARY_EDGE,I[w.sharp_Edge]=t.GeomTypeEnum.SHARP_EDGE,I[w.smooth_Edge]=t.GeomTypeEnum.SMOOTH_EDGE,I[w.hidden_Seam_Edge]=t.GeomTypeEnum.HIDDEN_SEAM_EDGE,I[w.boundary_Point]=t.GeomTypeEnum.BOUNDARY_POINT,I[w.sharp_Point]=t.GeomTypeEnum.SHARP_POINT,I[w.smooth_Point]=t.GeomTypeEnum.SMOOTH_POINT,I[w.hidden_Seam_Point]=t.GeomTypeEnum.HIDDEN_SEAM_POINT,I[w.surfacic_Point]=t.GeomTypeEnum.SURFACIC_POINT,I[w.free_Point]=t.GeomTypeEnum.FREE_POINT,I[w.infinite_Face]=t.GeomTypeEnum.INFINITE_FACE,I[w.face]=t.GeomTypeEnum.FACE;var C=0,D=1,E=2,P=3,M=4,A=9;const b=function(e){return!e||e<1||e>8?1:e};return e.extend({init:function(e,t){this.clientManager=t,this.parameter=e},applyMatAppsToElt:function(e,t,i,r,a,n){if(e)for(var o=0;o<t.length;o++)this.applyMatAppToElt(e[t[o]],i,r,a,n)},applyMatAppToElt:function(e,t,i,r,a){if(e){var n=e;if(n.isDecal){if(!n.decal)return;var o=n.decal,s=_.get(n.uid);s||(s=new Set,_.set(n.uid,s)),o.__shareAttachementFrom(s),n.apply&&o.applyOn(i),n.attach&&o.attachTo(i)}else t?(a.length>0&&i._setMaterialOnGeomTypes(a,n),Array.isArray(r)&&r.length>0&&i.setMaterial(r,n)):(i.removeMaterialApplication(),i.setMaterialApplication(n))}},applyMaterialToElt:function(e,t,i,a,n,o,s,l){if(e&&e[t]){var d=e[t];if(n){var c=new r({geometricalFaceMaterial:d,layer:i,inheritance:a});l.length>0&&o._setMaterialOnGeomTypes(l,c),Array.isArray(s)&&s.length>0&&o.setMaterial(s,c)}else o.removeMaterialApplication(),o.setMaterialApplication(new r({geometricalFaceMaterial:d,layer:i,inheritance:a}))}},removeTextureFromCache:function(e){m&&m.removeImage(e)},applyGP:function(e,r,n,o){if(void 0!==e&&void 0!==r){var d=this.parameter;if(void 0!==d){var c=this,g=[];Array.isArray(o)&&o.forEach(function(e){g.push(I[e])});var _=Array.isArray(n)&&n.length>0||g.length>0,w=!1,C={},D={},E=d.getCustomProperty(),P=d.getColorAndOpacity();if(void 0!==P){var M=P.getRGBO();void 0!==M&&(w=!0,!0===M.DefaultRGB?(C.colorRGB=null,C.defaultRGB=!0):void 0!==M.R&&void 0!==M.G&&void 0!==M.B&&(C.colorRGB=new t.Color,C.colorRGB.setRGB(M.R/255,M.G/255,M.B/255),C.defaultRGB=!1),!0===M.DefaultO?(C.colorA=1,C.defaultO=!0):void 0!==M.O&&(C.colorA=M.O/255,C.defaultO=!1))}var A=d.getLineicProperty();if(void 0!==A){var V=A.getLineicValues();void 0!==V&&(w=!0,!0===V.DefaultLineType?(C.lineType=i.LinePatternEnum.SOLID,C.defaultLineType=!0):void 0!==V.LineType&&(C.lineType=V.LineType,C.defaultLineType=!1),!0===V.DefaultLineWidth?(C.lineWidth=b(0),C.defaultLineWidth=!0):void 0!==V.LineWidth&&(C.lineWidth=b(V.LineWidth),C.defaultLineWidth=!1),!0===V.DefaultPointType?(C.symbolType=0,C.defaultPointType=!0):void 0!==V.PointType&&(C.symbolType=V.PointType-1,C.defaultPointType=!1))}if(E){var O=E.getValue(h.prototype.propertyTypes.InheritanceMode);void 0!==O&&(C.inheritance=O,w=!0);var N=E.getValue(h.prototype.propertyTypes.Priority);void 0!==N&&(C.priority=N,w=!0);var G=E.getValue(h.prototype.propertyTypes.Highlight);void 0!==G&&(C.highlight=!!G,w=!0);var R=E.getValue(h.prototype.propertyTypes.Lowlight);void 0!==R&&(C.lowlight=!!R,w=!0);var H=E.getValue(h.prototype.propertyTypes.NoPick);void 0!==H&&(_?(w=!0,C.noPick=!!H):D.pick=H?i.PICKTHROUGH:i.PICKABLE);var L=E.getValue(h.prototype.propertyTypes.Dimension);void 0!==L&&(C.type=L,w=!0);var B=E.getValue(h.prototype.propertyTypes.NoShow);void 0!==B&&(_?(C.show=!B,w=!0):D.show=!B);var x=E.getValue(h.prototype.propertyTypes.ShowFree);void 0!==x&&(_?(C.showFree=!!x,w=!0):D.showFree=!!x);E.getValue(h.prototype.propertyTypes.ColorIndex),E.getValue(h.prototype.propertyTypes.Transparent);var F=E.getValue(h.prototype.propertyTypes.ViewMode);void 0!==F&&this.applyRepViewMode(e,r,F)}if(w){var U=new a.IncrementalGraphicAttributeSet(C).usingNREInit(!0);_?r instanceof l?(g.length>0&&r._setGASOnGeomTypes(g,U),Array.isArray(n)&&n.length>0&&r._setGAS(n,U)):n.forEach(function(e){e instanceof s&&e._setGAS(U)}):r._setGAS(U)}var k=d.getMaterial();if(void 0!==k){var W=k.getMaterialDefinition();if(void 0!==W)if(!0===W.DefaultMaterial)_?(g.length>0&&r._setMaterialOnGeomTypes(g,null),Array.isArray(n)&&n.length>0&&r.setMaterial(n,null)):r.removeMaterialApplication();else{e.id!==y&&(y=e.id,T.clear());var z=W.JSON,j=T.get(z),X=W.Buffers,K=W.Layer,J=W.Inherit,Y=[0];if(W.Index?Y=[W.Index]:W.Indices&&(Y=W.Indices),j)j.materialApplications?this.applyMatAppsToElt(j.materialApplications,Y,_,r,n,g):this.applyMaterialToElt(j.materials,Y[0],K,J,_,r,n,g);else{var Z=[];Array.isArray(X)&&X.length>0&&X.forEach(function(e){Z.push({buffer:e.getData()})}),S.load({resourcesLibrary:m,zipped:!1,json:z,chunks:Z,doneCallback:function(e){if(e.materialApplications?(T.set(e.json,{materialApplications:e.materialApplications,materials:null}),c.applyMatAppsToElt(e.materialApplications,Y,_,r,n,g)):(T.set(e.json,{materialApplications:null,materials:e.materials}),c.applyMaterialToElt(e.materials,Y[0],K,J,_,r,n,g)),c.clientManager){var t=m.getRequestedUids();t.length&&c.clientManager.getTexturesFromUids({node:void 0,serverNodeId:void 0,textureUids:t,onAnswer:function(e){for(var t in e.buffers){var i=m.getImageToRequest(parseInt(t)),r="image/"+i.format;"dds"!==i.format&&"hdr"!==i.format&&"basis"!==i.format||(r="arraybuffer");var a=new Blob([e.buffers[t]._data],{type:r});S._loadGenericTexture(i.format,null,window.URL.createObjectURL(a),!0,function(){console.log("texture map updated")},null,i.map),m.removeImageToRequest(parseInt(t))}}})}}})}}}if(!_&&(void 0!==D.pick&&r.setPickable(D.pick),void 0!==D.show&&r.setVisibility(D.show),void 0!==D.showFree&&r.setVisibilityFree(D.showFree),E)){var q=E.getValue(h.prototype.propertyTypes.PickMode);if(void 0!==q)if(0===q)r.setPickingMode(null);else{var Q=new u;Q.applyToAll(i.PICK_VISIBLE),1&q&&(Q.setPickingMode("Face",i.PICK_ALWAYS),Q.setPickingMode("AxisSystem",i.PICK_ALWAYS),Q.setPickingMode("InfiniteFace",i.PICK_ALWAYS)),2&q&&(Q.setPickingMode("InternalSharpEdge",i.PICK_ALWAYS),Q.setPickingMode("InternalSmoothEdge",i.PICK_ALWAYS),Q.setPickingMode("BoundaryEdge",i.PICK_ALWAYS)),4&q&&Q.applyToAll(i.PICK_NEVER),r.setPickingMode(Q)}var $=E.getValue(h.prototype.propertyTypes.StaticPickWithChildrenAsAWhole);if(void 0!==$){var ee=!!$;r.setVisuFilters({doNotPickUnderFilter:new f(ee)})}let a=E.getValue(h.prototype.propertyTypes.IsIn3DBackGround);void 0!==a&&r.setIsInBackground(!!a);var te=E.getValue(h.prototype.propertyTypes.ExcludeFromBounding);"undefined"!=typeof excludeValue&&r.exludeFromBounding(!!te);var ie=E.getValue(h.prototype.propertyTypes.LayerNumber);void 0!==ie&&r.setLayerNumber(ie);var re=E.getValue(h.prototype.propertyTypes.StaticGeomType);if(void 0!==re&&""!==re){var ae=t.GeomTypeEnum[re];if(void 0!==ae){var ne=new p(ae);r.setVisuFilters({_staticGeomTypeFilter:ne}),r.traverse(function(e,t){if(void 0===e)return!0;if("Mesh3D"===e.getNodeType()){var i=e.mesh3js.geometry;if(!(i&&i.length>0))return!0;i[0].drawingGroups.forEach(function(e){e._geomType!==t&&(e._initialGeomType=e._geomType),e._geomType=t})}return!1},ae)}}var oe=E.getValue(h.prototype.propertyTypes.StaticPickPriority);void 0!==oe&&""!==oe&&r.setPickingPriorityId(oe);var se=E.getValue(h.prototype.propertyTypes.StaticMaterial);if(void 0!==se&&""!==se)(ce=e.getStaticMaterial(se))&&r.setVisuFilters({lookFilter:new v(ce)});var le=E.getValue(h.prototype.propertyTypes.StaticLook);if(void 0!==le&&""!==le){var de=e.getStaticLook(le);if(de){var ce=de.material;r.setVisuFilters({lookFilter:new v(ce).usingShadowReceive(de.shadowReceive).usingShadowCast(de.shadowCast)})}}}}}},applyRepViewMode:function(e,i,r){if(t.__tmpIsA2X){var a=e.viewManager.viewer._getCSIOverrideManager(),n=a.getRepViewModeOverride(i),o=!1;if(r===C)o=!0;else{var s=new g({faceMode:null});switch(s._displayNothingRenderMode(),r){case D:s.setRenderMode("Face",!0);break;case E:s.setRenderMode("@Edge",!0);break;case P:s.setRenderMode("Face",!0),s.setRenderMode("@Edge",!0);break;case M:s.setRenderMode("Face",!0);break;case A:break;default:o=!0}o||n.setRenderStyle(s)}o&&a.deleteRepViewModeOverride(i)}}})}),define("DS/WebVisuParameters/BoundingSphereParameterHelper",["DS/CSIViewModelWebInterfaces/CSIVMClientBoundingSphereParameter","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i={getBoundingSphere:function(e){if(!e)return null;var i=e.getRadius(),r=e.getRadiusMM();e.getState()===e.stateValues.infinite&&(i=0,r=0);var a=new t.Sphere(new t.Vector3(e.getCenterX(),e.getCenterY(),e.getCenterZ()),i);return a.pixelRadius=r,a}};return i}),define("DS/WebVisuParameters/CSIModelIdPathParameter",["UWA/Class","DS/CSICommandBinder/CSICommandBinder"],function(e,t){"use strict";var i={labels:{elementsId:"elems_id",elementsNamingContext:"elems_nc",subElements:"subelems_id"},serialize:function(e,t){var r,a,n=[],o=[];for(r=0;r<t.elements.length;r++)a=t.elements[r],n.push(a.id),o.push(a.namingContext);e.writeUint32Array(i.labels.elementsId,n),e.writeUint8Array(i.labels.elementsNamingContext,o),e.writeUint32Array(i.labels.subElements,t.subElements)},unserialize:function(e){var t,r={elements:[],subElements:[]},a=e.readUint32Array(i.labels.elementsId),n=e.readUint8Array(i.labels.elementsNamingContext),o=e.readUint32Array(i.labels.subElements);for(t=0;t<a.length;t++)r.elements.push({id:a[t],namingContext:n[t]});for(t=0;t<o.length;t++)r.subElements.push(o[t]);return r}};return t.declareType({type:"CATModelIdPath",serialize:i.serialize,unserialize:i.unserialize}),i}),define("DS/WebVisuParameters/CSIViewParameterLabels",[],function(){"use strict";return{viewStatus:"viewStatus",idPatterns:"idPatterns",graphicProperties:"GraphicProperties",treeUpdates:"treeUpdates",viewStatusTemporary:"temporary",viewStatusPermanent:"permanent",viewStatusCommit:"commit",viewStatusAbort:"abort",showMode:"ShowMode",staticMaterial:"SetStaticMaterial",staticPickPriority:"SetStaticPickPriority",id:"id",idSpace:"idSpace",idContext:"idContext",shared:"shared",treeKey:"treeKey",tokens:"tokens",appliedGas:"AppliedGraphicProperties",node:"Node",value:"value",localIdInt:"localId_Int",localIdString:"localId_String",idPattern:"idPattern",batchCellIdPattern:"batchCellIdPattern",parent:"parent",batchParent:"batchParent",valueAddNode:"AddNode",valueAddCustomNode:"AddCustomNode",valueModifyCustomNode:"ModifyCustomNode",valueAddExistingNode:"AddExistingNode",valueRemoveExistingNode:"RemoveExistingNode",valueAddBody:"AddBody",valueAddCells:"AddCells",valueRemoveAll:"RemoveAll",valueMesh:"mesh",valueBoundingSphere:"bs",valueBoundingBox:"bbox",valueInitializers:"inits",valueCustomData:"customdata",valueGeometry:"geometry",valueGeometries:"geometries",valueOffset:"offset",valueByteLength:"bytelength",valueBytePerElement:"bpe",valueDrawGroups:"dgs",valueStart:"start",valueCount:"count",valueGeomType:"geomType",valuePrimitives:"primitives",valueBuffer:"buffer",valueBufferPartitions:"bufferPartitions",valueBufferPartition:["vertexPositionArray","vertexIndexArray","vertexColorArray","vertexNormalArray","vertexBinormalArray","vertexTangentArray","vertexUvArray","vertexUv2Array"],valueGeomTypeValue:["EDGE","WIRE_EDGE","BOUNDARY_EDGE","SHARP_EDGE","SMOOTH_EDGE","BOUNDARY_POINT","SHARP_POINT","SMOOTH_POINT","SURFACIC_POINT","FREE_POINT","INFINITE_FACE","FACE"],glTypeFromGeomType:{EDGE:1,WIRE_EDGE:1,BOUNDARY_EDGE:1,SHARP_EDGE:1,SMOOTH_EDGE:1,BOUNDARY_POINT:0,SHARP_POINT:0,SMOOTH_POINT:0,SURFACIC_POINT:0,FREE_POINT:0,INFINITE_FACE:4,FACE:4},valueRadius:"rad",valueState:"state",valueStateValue:["EMPTY","NORMAL","INIFINITE","CONTAIN"],valueX1:"x1",valueY1:"y1",valueZ1:"z1",valueX2:"x2",valueY2:"y2",valueZ2:"z2",shortId:"shortId",idPath:"idPath",valueBinaryFormat:"binaryformat",valueClientModule:"clientmodule",valueData:"Data",valueBinaryFormatValue:["Bin","Cgr"]}}),define("DS/WebVisuParameters/SceneEnvParameterItem",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=function(e){this.container=e};t.prototype={constructor:t,areViewModesManaged:function(){return!1},getViewMode:function(){return null},getViewModeMask:function(){return 0},getViewModeAppearanceStructure:function(e){return null},getCamerasJSON:function(){return null},getCameras2DJSON:function(){return null},getChangeType:function(){return null},getViewpointsInfo:function(){return null},areCamerasManaged:function(){return!1},areLightsManaged:function(){return!1},getLightsJSON:function(){return null},areAmbiancesManaged:function(){return!1},isDefaultAmbiance:function(){return!1},getAmbianceJSON:function(){return null},getAmbianceBuffers:function(){return null},areSupportParametersManaged:function(){return!1},getHighlightRenderingData:function(){return null},getPrehighlightRenderingData:function(){return null},getColorMap:function(){return null},getFog:function(){return!1},getClippingPlane:function(){return null},getBackground3DViewMode:function(){return null},getMainViewpointUID:function(){return null},getViewerType:function(){return null},get2DMode:function(){return null},getPLMViewMode:function(){return null}};var i=function(e){t.call(this,e)};i.prototype=Object.create(t.prototype),Object.assign(i.prototype,{areViewModesManaged:function(){return!!this.getViewMode()},getViewMode:function(){return this.container.getViewmode?this.container.getViewmode():null},getViewModeMask:function(){var e=this.container.getViewmode();return e?e._viewMode:0},getViewModeAppearanceStructure:function(t){if(this.getViewModeMask()&t){var i=this.getViewMode();return{appearanceName:i._appearanceName,customParams:{shininess:i._shininess,opacity:i._opacity,color:(new e.Color).setRGB(i._color[0],i._color[1],i._color[2]),useColorFromGAS:i._useObjectColor}}}return null},getCamerasJSON:function(){var e=this.container.getCamerasJSON();return e?e.getJSON():null},areCamerasManaged:function(){return this.container.AreCamerasManaged&&this.container.AreCamerasManaged()},areLightsManaged:function(){return this.container.AreLightsManaged&&this.container.AreLightsManaged()},getLightsJSON:function(){var e=this.container.getLightsJSON();return e?e.getJSON():null},areAmbiancesManaged:function(){return this.container.AreAmbiancesManaged&&this.container.AreAmbiancesManaged()},isDefaultAmbiance:function(){return this.container.getIsDefaultAmbiance()},getAmbianceJSON:function(){var e=this.container.getAmbianceJSON();return e?e.getJSON():null},getAmbianceBuffers:function(){return this.container.getAmbianceBuffers()}});var r=function(i){e.__tmpIsA2X=!0,t.call(this,i)};return r.prototype=Object.create(t.prototype),Object.assign(r.prototype,{areViewModesManaged:function(){return!!this.getViewMode()},getViewMode:function(){return this.container.getViewMode()},getViewModeMask:function(){var e=this.container.getViewMode();return e?e.getViewMode():0},getViewModeAppearanceStructure:function(t){if(this.getViewModeMask()&t){var i=this.getViewMode(),r=i.getColor();return{appearanceName:i.getAppearance(),customParams:{shininess:i.getShininess(),opacity:i.getOpacity(),color:(new e.Color).setRGB(r[0],r[1],r[2]),useColorFromGAS:i.getUseObjectColor()}}}return null},getViewpoints:function(){return this.container.getViewpoints()},getCameras2DJSON:function(){if(!this.areCamerasManaged())return null;var e=this.getViewpoints().getCameras2DJSON();return e?e.getJSON():null},getCamerasJSON:function(){if(!this.areCamerasManaged())return null;var e=this.getViewpoints().getCamerasJSON();return e?e.getJSON():null},getChangeType:function(){return this.areCamerasManaged()?this.getViewpoints().getChangeType():null},getViewpointsInfo:function(){return this.areCamerasManaged()?this.getViewpoints().getViewpointsInfo():null},areCamerasManaged:function(){return!!this.getViewpoints()},areLightsManaged:function(){return!1},getLightsJSON:function(){return null},getAmbiance:function(){return this.container.getAmbiance()},areAmbiancesManaged:function(){return!!this.getAmbiance()},isDefaultAmbiance:function(){return!this.getAmbianceJSON()},getAmbianceJSON:function(){if(!this.areAmbiancesManaged())return null;var e=this.getAmbiance().getAmbianceJSON();return e?e.getJSON():null},getAmbianceBuffers:function(){return this.areAmbiancesManaged()?this.getAmbiance().getAmbianceBuffers():null},getSupportParameters:function(){return this.container.getSupportParameters()},areSupportParametersManaged:function(){return!!this.getSupportParameters()},getHighlightRenderingData:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getHighlightRenderingData():null},getPrehighlightRenderingData:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getPrehighlightRenderingData():null},getColorMap:function(){return this.areSupportParametersManaged()&&this.getSupportParameters().getColorMap?this.getSupportParameters().getColorMap():null},getFog:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getFog():null},getClippingPlane:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getSupportClippingPlane():null},getBackground3DViewMode:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getBackground3DViewMode():null},getMainViewpointUID:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getMainViewpointUID():null},getViewerType:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getViewerType():null},get2DMode:function(){return this.areSupportParametersManaged()?this.getSupportParameters().get2DMode():null},getPLMViewMode:function(){return this.container&&this.container.getPLMViewMode()}}),{VisuContextData:r,SceneEnvData:i}}),define("DS/WebVisuParameters/WebVisuUpdateTransactionHighlight",["DS/WebVisuParameters/AbstractWebVisuUpdateTransaction","DS/CoreEvents/Events","DS/EKEventsWeb/EKEvents","DS/Visualization/ThreeJS_DS","DS/CSIViewModelWebInterfaces/CSIVMClientCATVizBasePathElementRep","DS/CSIViewModelWebInterfaces/CSIVMClientSelectionObject","DS/CSIViewModelWebInterfaces/CSIVMClientInfiniteDrawGroupParameter"],function(e,t,i,r,a,n,o){"use strict";var s=o.prototype.infiniteGeomTypeValues,l=new Map,d=null,c=function(){this._idObject=null,this._pathes=[],this._order=0};c.prototype.setIdentificationObject=function(e){this._idObject=e},c.prototype.getIdentificationObject=function(){return this._idObject},c.prototype._addPath=function(e,t){this._pathes.push({key:e,slot:t})};var h=function(t,i,r,a,n){e.call(this,t,i,r),this.multiSelection=!!a,this.transactionUtils=n};return(h.prototype=Object.create(e.prototype))._getCSISelection=function(e){this.multiSelection||(e=0);var t=this.viewManager.viewer;(d=l.get(t))||(d=new Map,l.set(t,d)),this._csiXSO=this.transactionUtils.getXSO(e,t,this.treeKeyID)},h.prototype._updateOrder=function(){var e=this;d.forEach(function(t,i,r){if(t.length){t.sort((e,t)=>e.node._order-t.node.order);for(var a=0;a<t.length;a++){var n=t[a].slot;e._getCSISelection(n),(o=e._csiXSO.getPathFromKey(i))&&e._csiXSO._remove(o)}var o,s=t[t.length-1].slot;e._getCSISelection(s),(o=e._csiXSO.getPathFromKey(i))&&e._csiXSO._add(o)}else r.delete(i)})},h.prototype.doOperation=function(e){if(this.transactionUtils){var t=i.Trace.traceStart("techno_webvisu","message_to_highlight"),r=e.getType();switch(r){case e.OperationType.RemoveAll:this.multiSelection?this.transactionUtils.clearMultiHighlightColorSlot(this.treeKeyID):this._csiXSO.removeAll(),d.clear();break;case e.OperationType.CreateRoot:case e.OperationType.AddNode:case e.OperationType.AddBody:var n=new c;e.setCreatedObject(n);break;case e.OperationType.AddCells:if(!(n=e.getOperatedObject()))return;var o=e.getGeometricalData(),l=!!o&&o.hasInfiniteGeometry(),h=o?o.getGeometries():null;if(!l||!h){i.Log.error("Unexpected or missing data in Highlight transaction AddCells");break}for(var u=0;u<h.length;u++){var g=h[u],p=g.getInfiniteDrawGroups();if(p&&p.length){if(p[0].getInfiniteGeomType()===s.path_element){const e=g.getAdditionalDataAsUint8Array(),t=new a(e),i=this.multiSelection?t.multiColorHighlightSlot+1:0;this._getCSISelection(i);const r=t.haveTransient?t.createIteratorOverPathElementsTransient():t.createIteratorOverPathElements();for(const e of r)this._csiXSO.add(e),n._addPath(e.hash(),i),this.multiSelection&&(d.has(e.hash())?d.get(e.hash()).push({slot:i,node:n}):d.set(e.hash(),[{slot:i,node:n}]),this._updateOrder())}}else i.Log.error("Missing getInfiniteDrawGroups in Highlight transaction AddCells")}break;case e.OperationType.RemoveExistingNode:if(!(n=e.getOperandObject()))return;for(u=0;u<n._pathes.length;u++){var f=n._pathes[u];this._getCSISelection(f.slot);var v=this._csiXSO.getPathFromKey(f.key);if(v&&(this._csiXSO.remove(v),d.has(v.hash())&&this.multiSelection)){var m=d.get(v.hash()),S=m.findLastIndex(e=>e.node===n&&e.slot===f.slot);-1!==S&&(m.splice(S,1),this._updateOrder())}}n._pathes=[];break;case e.OperationType.ApplyGP:break;default:i.Log.error("Unexpected operation token in Highlight transaction "+r)}this.viewManager.viewer.render(),t.End()}},h.prototype.commit=function(){},h.prototype.abort=function(){},h.prototype.executeEnd=function(){},h.prototype.executeInverse=function(){},h}),define("DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionPSO",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionXSO"],function(e,t,i){"use strict";var r=new Map,a=function(e){i.call(this,e),r.has(e)||r.set(e,{nonColorParameters:{Basic:{},Halo:{},Politeness:{},AdvancedPoliteness:{}},defaultSlotColorParameters:{Basic:{},Halo:{},Politeness:{},AdvancedPoliteness:{}},currentHighlightType:"AdvancedPoliteness",advanced:!0});var a=r.get(e).currentHighlightType;this.highlightColor=r.get(e).advanced?new t.AdvancedPoliteHighlightData(t.DefaultPreHighlightData.advancedpolite):new t.HaloHighlightData(t.DefaultPreHighlightData.halo),this.highlightColor._setData(r.get(e).defaultSlotColorParameters[a]),this._event="PREHIGHLIGHT",this._setData(this.highlightColor)};(a.prototype=Object.create(i.prototype))._setData=function(i){if(i){var a=this.viewer,n=r.get(a).advanced?new t.AdvancedPoliteHighlightData(this.highlightColor):new t.HaloHighlightData(this.highlightColor);n._setData(i);var o=r.get(a).currentHighlightType;n._setData(r.get(a).nonColorParameters[o]),e.publish({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_PREHIGHLIGHT_UPDATE",eventType:"@CSI_PREHIGHLIGHT_UPDATE",parameters:{newColor:n,viewer:a,advanced:r.get(a).advanced}}}),this.highlightColor=n}};var n=new Map,o=null;return e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_PREHIGHLIGHT_UPDATE"},function(e){var t=e.parameters.viewer;(o=n.get(t))||(o=[new a(t)],n.set(t,o));var i=e.parameters.highlightType,s=r.get(t).currentHighlightType;Object.assign(r.get(t).defaultSlotColorParameters[i],e.parameters.colorParameters),o[0]._setData(r.get(t).defaultSlotColorParameters[s])}),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_PREHIGHLIGHT_NON_COLOR_UPDATE"},function(e){var t=e.parameters.viewer;(o=n.get(t))||(o=[new a(t)],n.set(t,o));var i=e.parameters.highlightType;Object.assign(r.get(t).nonColorParameters[i],e.parameters.nonColorParameters);for(var s=0;s<o.length;s++)o[s]&&o[s]._setData({})}),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_PREHIGHLIGHT_TYPE_UPDATE"},function(e){var t=e.parameters.viewer;(o=n.get(t))||(o=[new a(t)],n.set(t,o));var i=e.parameters.highlightType;"AdvancedPoliteness"===i||"Halo"===i?(r.get(t).currentHighlightType=i,r.get(t).advanced="AdvancedPoliteness"===i):i=r.get(t).currentHighlightType;for(var s=0;s<o.length;s++)o[s]&&o[s]._setData(0===s?r.get(t).defaultSlotColorParameters[i]:{})}),e.subscribe({event:"/VISU/VIEWER/VIEWER_DISPOSED"},function(e){var t=e.parameters.viewer;if(n.has(t))for(var i=n.get(t),a=0;a<i.length;a++)i[a]&&i[a]._treeKeyToStruct.forEach(function(e,t,r){i[a]._setTreeKey(t),i[a].removeAll()});n.delete(t),r.delete(t)}),{getXSO:function(e,t,i){if((o=n.get(t))||(o=[new a(t)],n.set(t,o)),e>o.length||e<0)throw"Invalid slot";var r=o[e];if(!r)throw"Missing slot";return r._setTreeKey(i),r}}}),define("DS/WebVisuParameters/InfiniteGeometryParameterHelper",["UWA/Class","DS/CSIViewModelWebInterfaces/CSIVMClientInfiniteGeometryParameter","DS/CSIViewModelWebInterfaces/CSIVMClientInfiniteDrawGroupParameter","DS/CSIViewModelWebInterfaces/CSIVMClientGraphicPropertyParameter","DS/CSIViewModelWebInterfaces/CSIVMClientImagePixel","DS/SceneGraphNodes/FixedSizeArrowNode","DS/SceneGraphNodes/FixedSizePlaneNode","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/GeometryHelper","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","DS/Visualization/TextNode","DS/SceneGraphNodes/RefPlaneNode","DS/Visualization/GraphicAttributeSet","DS/VisuLoaders/ThreeDXResourcesLibrary","DS/Visualization/FontUtils","DS/Visualization/Filters/GASInheritFilter","DS/WebVisuParameters/GraphicPropertyParameterHelper","DS/CSIViewModelWebInterfaces/CSIVMClientSelectionObject"],function(e,t,i,r,a,n,o,s,l,d,c,h,u,g,p,f,v,m,S,y,T,_,w){"use strict";var I=i.prototype.infiniteGeomTypeValues,C=1/l.getPixelsPerMM(),D=(new m({colorRGB:new l.Color(16777215)}),new m({colorRGB:new l.Color(16777215),inheritance:l.GASEnum.RGBA_INHERITANCE_ON|l.GASEnum.ASMCOLOR_INHERITANCE_ON|l.GASEnum.DIMENSION_INHERITANCE_ON}));let E=new S;var P=new l.Color(0),M=(new l.ParticleBasicMaterial({size:4,color:P,blending:l.NormalBlending,depthTest:!1,sizeAttenuation:!1,transparent:!1,force:!0}),new l.Vector3(1,0,0)),A=new l.Vector3(0,0,1),b=new Map,V=new Map;return e.extend({init:function(e,t){this.parameter=e,this._threeDXLoader=t,this._sagInfos={sag:.2,sagMode:1}},getInfiniteGeometry:function(e,t){var i=this.parameter.getInfiniteDrawGroups(),o=[],d=[],S=this.parameter.getInfiniteGeometryAsFloat32Array();if(!S)return{geometry:[],primitiveIDs:[]};for(var w=this.parameter.getAdditionalDataAsUint8Array(),b=0,V=0,O=0,N=!1,G=0;G<i.length;G++)for(var R=i[G],H=R.getInfiniteGeomType(),L=new Uint32Array(this.parameter.getBuffer(),R.getStart(),3*R.getCount()),B=0;B<R.getCount();++B){b=L[3*B],V=L[3*B+1],O=L[3*B+2];var x=!0;switch(H){case I.origin:var F=[S[V++],S[V++],S[V++]];(K=w[O++])>8&&(K=7);var U={positions:F,number:1,color:P};Ae=new h;var k=s.createPointsNode(U),W=new l.Sphere(new l.Vector3(F[0],F[1],F[2]));W.pixelRadius=1,k.forceBoundingSphere(W),k.setPickParent(!0),Ae.addChild(k),k._setGAS(new m({colorRGB:P,symbolType:K,inheritance:l.GASEnum.COLOR_INHERITANCE_ON|l.GASEnum.SYMBOLTYPE_INHERITANCE_ON})),Ae.traverse(this._CBOnTraversal,l.GeomTypeEnum.FREE_POINT);break;case I.points:for(var z=S[V++],j=[],X=0;X<3*z;++X)j.push(S[V++]);var K;(K=w[O++])>8&&(K=7);U={positions:j,number:z,color:new l.Color("black")};Ae=new h,(k=s.createPointsNode(U)).setPickParent(!0),Ae.addChild(k),k._setGAS(new m({colorRGB:P,symbolType:K,inheritance:l.GASEnum.COLOR_INHERITANCE_ON|l.GASEnum.SYMBOLTYPE_INHERITANCE_ON})),Ae.traverse(this._CBOnTraversal,l.GeomTypeEnum.FREE_POINT);break;case I.axis:var J=S[V++];J*=1/C;F=new l.Vector3(S[V++],S[V++],S[V++]);var Y=new l.Vector3(S[V++],S[V++],S[V++]),Z=S[V++];Z*=1/C;var q=S[V++];(q<0||q>.5*Math.PI)&&(q=.1974);var Q="";if((ye=w[O++])>0){var $=[];for(X=0;X<ye;++X)$.push(String.fromCharCode(w[O++]));Q=$.join("")}Ae=new h;var ee=Math.abs(Y.z)<.999?A:M,te=(new l.Vector3).crossVectors(ee,Y);te.normalize();var ie=(new l.Vector3).crossVectors(Y,te),re=new l.Matrix4;re.makeBasis(te,ie,Y),re.setPosition(F),Ae.setMatrix(re);U={name:"arrow",pickable:!0,color:new l.Color("black"),head:Z>0?n.types.ARROW:n.types.NONE,arrowLength:J,arrowWidth:1,headLength:Z,headWidthToHeightRatio:2*Math.tan(q),globalSelection:!0};var ae=this.getAxisNode(U,{text:Q,length:ye});Ae.addChild(ae.axis),Ae.addChild(ae.label),Ae.traverse(this._CBOnTraversal,l.GeomTypeEnum.AXIS_SYSTEM);break;case I.infinite_plane:var ne=S[V++];ne*=1/C;F=new l.Vector3(S[V++],S[V++],S[V++]);var oe=new l.Vector3(S[V++],S[V++],S[V++]),se=new l.Vector3(S[V++],S[V++],S[V++]);if(w[O++]){(Ae=s.createFixedSizeNode({name:"CSIFixedSizeHalfPlaneNode",ratio:1})).setMatrix((new l.Matrix4).setPosition(F));var le=oe.clone().add(se).normalize().multiplyScalar(1.4142136*ne/2),de=F.clone().add(le),ce=de.clone().add(oe.multiplyScalar(ne/2)),he=de.clone().add(se.multiplyScalar(ne/2)),ue=s.createLineNode({points:[ce,de,he],color:new l.Color("black")});ue.setMaterialMode(!1),ue.setPickParent(!0),ue.setMatrix((new l.Matrix4).setPosition(F.negate())),Ae.addChild(ue)}else{var ge=(new l.Vector3).crossVectors(oe,se);(at=new l.Matrix4).makeBasis(oe,se,ge),at.setPosition(F);U={name:"refPlane",fill:!0,fixedSize:!0,size:new l.Vector2(ne,ne),planeAttributes:{front:{color:new l.Color("#005686"),opacity:.075},back:{color:new l.Color("#a3c8dc"),opacity:.075}},borderAttributes:{front:{color:new l.Color("#005686"),opacity:.8,width:1},back:{color:new l.Color("#a3c8dc"),opacity:.8,width:1}},textAttributes:{fixedSize:!0,front:{data:"",color:new l.Color("#005686"),opacity:1,size:30},back:{data:"",color:new l.Color("#a3c8dc"),opacity:1,size:30}}};x=!1,(Ae=new v(U)).setMatrix(at)}Ae.traverse(this._CBOnTraversal,l.GeomTypeEnum.INFINITE_FACE);break;case I.reference_plane:var pe=S[V++],fe=S[V++],ve=(F=new l.Vector3(S[V++],S[V++],S[V++]),new l.Vector3(S[V++],S[V++],S[V++])),me=new l.Vector3(S[V++],S[V++],S[V++]),Se=1===w[O++];Se&&(pe*=1/C,fe*=1/C);var ye,Te="";if((ye=w[O++])>0){for($=[],X=0;X<ye;++X)$.push(String.fromCharCode(w[O++]));Te=$.join("")}var _e=null,we=w[O++];if(_e={},we)_e=function(e){var t={},i=e[0];return 0==i>>3&&(t._wireframeMode=!!(4&i),t._labelVisibility=!!(2&i),t._orientationVisibility=!!(1&i),t._frontColorR=e[1],t._frontColorG=e[2],t._frontColorB=e[3],t._backColorR=e[4],t._backColorG=e[5],t._backColorB=e[6],t._opacity=e[7]),t}(w.subarray(O,O+=we));Se||1!==w[O++]||(pe*=1.05,fe*=1.05);ge=(new l.Vector3).crossVectors(ve,me);(at=new l.Matrix4).makeBasis(ve,me,ge),at.setPosition(F);var Ie=!_e||!_e._wireframeMode,Ce=!!_e&&_e._orientationVisibility,De=!_e||_e._labelVisibility,Ee=_e?_e._opacity/255:.075,Pe=_e?(new l.Color).setRGB(_e._frontColorR/255,_e._frontColorG/255,_e._frontColorB/255):new l.Color("#005686"),Me=_e?(new l.Color).setRGB(_e._backColorR/255,_e._backColorG/255,_e._backColorB/255):new l.Color("#a3c8dc");U={name:"refPlane",fill:!0,newLook:Ie,orientationArrow:Ce,fixedSize:Se,size:new l.Vector2(pe,fe),planeAttributes:{front:{color:Pe,opacity:Ee},back:{color:Me,opacity:Ee}},borderAttributes:{front:{color:Pe,opacity:.8,width:1},back:{color:Me,opacity:.8,width:1}}};De&&(U.textAttributes={fixedSize:!0,front:{data:Te,color:Pe,opacity:1,size:30},back:{data:Te,color:Me,opacity:1,size:30}}),x=!1;var Ae=new h,be=this.getRefPlaneNode(U);Ae.addChild(be),Ae.setMatrix(at),Ae.traverse(this._CBOnTraversal,l.GeomTypeEnum.INFINITE_FACE),t.addChild(Ae),N=!0,be.cbChange();break;case I.text:F=new l.Vector3(S[V++],S[V++],S[V++]);var Ve=S[V++],Oe=[];for(X=0;X<4;++X)Oe.push(w[O++]);Q="";if((ne=function(e){if(Array.isArray(e)){var t=new ArrayBuffer(e.length),i=new DataView(t);return e.forEach(function(e,t){i.setUint8(t,e)}),i}}(Oe.reverse()).getUint32(0))>0){for($=[],X=0;X<ne;++X)$.push(String.fromCharCode(w[O++]));Q=$.join("")}var Ne=new f("CSIText");Ne.setPrimitivePicking(!1),Ne.textMaterial.side=2,Ne.addText({string:Q,anchor:new l.Vector3(F.x,F.y,0),color:new l.Color(0),size:Ve,lineLength:500,up:new l.Vector3(0,1,0),right:new l.Vector3(1,0,0)}),Ne.setPickParent(!0),(Ae=new h).addChild(Ne);break;case I.light:var Ge=new TextDecoder("utf-8").decode(w),Re={lights:[]};this._threeDXLoader.applyLights({json:JSON.parse(Ge),data:Re,destinationNode:t}),0!==Re.lights.length&&(Ae=Re.lights[0],N=!0);break;case I.canonical_cuboid:var He=[S[V++],S[V++],S[V++]],Le=[S[V++],S[V++],S[V++]],Be=[S[V++],S[V++],S[V++]],xe=S[V++],Fe=c.createCuboidMesh({corner:He,firstAxis:Le,secondAxis:Be,thirdLength:xe},D);x=!1,Ae=new u(Fe);break;case I.canonical_sphere:var Ue=[S[V++],S[V++],S[V++]],ke=S[V++];this._sagInfos.sagMode=w[O++],this._sagInfos.sag=S[V++];Fe=c.createCustomSphereMesh({parallelStart:-Math.PI/2,parallelEnd:Math.PI/2,meridianStart:0,meridianEnd:2*Math.PI,center:Ue,firstAxis:[ke,0,0],secondAxis:[0,1,0],sag:this._sagInfos},D);x=!1,Ae=new u(Fe);break;case I.canonical_partialsphere:Ue=[S[V++],S[V++],S[V++]],Le=[S[V++],S[V++],S[V++]],Be=[S[V++],S[V++],S[V++]];var We=S[V++],ze=S[V++],je=S[V++],Xe=S[V++];this._sagInfos.sagMode=w[O++],this._sagInfos.sag=S[V++];Fe=c.createCustomSphereMesh({parallelStart:je,parallelEnd:Xe,meridianStart:We,meridianEnd:ze,center:Ue,firstAxis:Le,secondAxis:Be,sag:this._sagInfos},D);x=!1,Ae=new u(Fe);break;case I.canonical_cylinder:var Ke=[S[V++],S[V++],S[V++]],Je=[S[V++],S[V++],S[V++]];ke=S[V++];this._sagInfos.sagMode=w[O++],this._sagInfos.sag=S[V++];Fe=c.createCustomCylinderMesh({bottomCenter:Ke,topCenter:Je,bottomRadius:ke,topRadius:ke,sag:this._sagInfos},D);x=!1,Ae=new u(Fe);break;case I.canonical_cone:Ke=[S[V++],S[V++],S[V++]],Je=[S[V++],S[V++],S[V++]];var Ye=S[V++],Ze=S[V++];this._sagInfos.sagMode=w[O++],this._sagInfos.sag=S[V++];Fe=c.createCustomCylinderMesh({bottomCenter:Ke,topCenter:Je,bottomRadius:Ye,topRadius:Ze,sag:this._sagInfos},D);x=!1,Ae=new u(Fe);break;case I.canonical_torus:Ue=[S[V++],S[V++],S[V++]];var qe=[S[V++],S[V++],S[V++]],Qe=S[V++];this._sagInfos.sagMode=w[O++],this._sagInfos.sag=S[V++];Fe=c.createTorusMesh({center:Ue,planeNormal:qe,minorRadius:Qe,sag:this._sagInfos},D);x=!1,Ae=new u(Fe);break;case I.canonical_partialtorus:Ue=[S[V++],S[V++],S[V++]],Le=[S[V++],S[V++],S[V++]],Be=[S[V++],S[V++],S[V++]],Qe=S[V++];var $e=S[V++];this._sagInfos.sagMode=w[O++],this._sagInfos.sag=S[V++];Fe=c.createPartialTorusMesh({center:Ue,firstAxis:Le,secondAxis:Be,minorRadius:Qe,majorAngle:$e,sag:this._sagInfos},D);x=!1,Ae=new u(Fe);break;case I.canonical_curvedpipe:var et=S[V++],tt=[];for(G=0;G<3*et;G++)tt.push(S[V++]);var it=[S[V++],S[V++],S[V++]],rt=[S[V++],S[V++],S[V++]];ke=S[V++];this._sagInfos.sagMode=w[O++],this._sagInfos.sag=S[V++];Fe=c.createCurvedPipeMesh({centers:tt,radius:ke,startN:it,endN:rt,sag:this._sagInfos},D);x=!1,Ae=new u(Fe);break;case I.path_element:break;case I.annotation_text:const i=JSON.parse(new TextDecoder("utf-8").decode(w)),o=i.anchor;if(!i.box)break;const d=i.point,b=i.box.height,R=i.box.width,L=i.box.descent;let B=b,nt=d.x,ot=d.y,st=0,lt=0;void 0!==o&&(o!=l.AnchorPoint.BOTTOM_CENTER&&o!=l.AnchorPoint.BASE_CENTER&&o!=l.AnchorPoint.TOP_CENTER||(st-=.5*R),o!=l.AnchorPoint.BOTTOM_RIGHT&&o!=l.AnchorPoint.BASE_RIGHT&&o!=l.AnchorPoint.TOP_RIGHT||(st-=R),o!=l.AnchorPoint.BOTTOM_LEFT&&o!=l.AnchorPoint.BOTTOM_CENTER&&o!=l.AnchorPoint.BOTTOM_RIGHT||(lt+=L),o!=l.AnchorPoint.TOP_LEFT&&o!=l.AnchorPoint.TOP_CENTER&&o!=l.AnchorPoint.TOP_RIGHT||(lt+=L-b)),nt+=st,ot+=lt-=L;const dt=i.font;let ct,ht=0,ut=!0;dt&&(ht=dt.font),Ae=new h;const gt={type:"Spherical"};(ct=ut?new g({ratio:3.8}):new h).setVisuFilters({gasInheritFilter:(new T).usingColorInherit(null,!1).usingASMColorInherit(null,!1)});let pt=new p(gt);pt.addChild(ct);var at=(new l.Matrix4).setPosition({x:d.x,y:d.y,z:0});pt.setMatrix(at),Ae.addChild(pt);const ft=function(e){for(var t=0;t<e.length;++t){var i=e[t];ct.addChild(i),i.setPickParent(!0)}};let vt=s.createRectangleNode({width:R,height:B,delta:new l.Vector2(st,lt),fill:!0,color:new c.Color(.5,.5,.2,1)});if(i.contour){const t=i.contour1;if(t&&t.set&&t.rgba){let i=new r(t.set,t.rgba),a=s.createLineNode({points:[new l.Vector3(st,lt,0),new l.Vector3(st,lt+B,0),new l.Vector3(st+R,lt+B,0)]});new _(i,e.clientManager).applyGP(this,a),a.setPickParent(!0),ct.addChild(a)}const a=i.contour2;if(a&&a.set&&a.rgba){let t=new r(a.set,a.rgba),i=s.createLineNode({points:[new l.Vector3(st,lt,0),new l.Vector3(st+R,lt,0),new l.Vector3(st+R,lt+B,0)]});new _(t,e.clientManager).applyGP(this,i),i.setPickParent(!0),ct.addChild(i)}}vt.setGAS(new m({basic:!0,colorIndex:l.COLORMAP_INDEX.FOREGROUND,inheritance:l.GASEnum.COLOR_INHERITANCE_ON})),vt.setPickParent(!0),ct.addChild(vt);const mt=3==ht||4==ht,St=2==ht||4==ht;let yt={text:i.text,bbox:[st,st+R,lt,lt+B],fontName:"3ds Regular.ttf",color:{r:0,g:0,b:0},colorIndex:l.COLORMAP_INDEX.BACKGROUND,bold:St,italic:mt,width:R,orientationAngle:0,_noZPriority:4,viewer:e.viewManager.viewer};y.createTexts([yt],{},ft);break;case I.image_pixel:const Tt=new a(w);if(0===Tt.nbImages)break;const _t=new h;Ae=_t;const wt=Tt.point;if(Tt.imageGPInfo){Tt.imageGPInfo.offset,Tt.imageGPInfo.alpha}else if(Tt.annotationGPInfo){Tt.annotationGPInfo.anchor,Tt.annotationGPInfo.isDepthTestEnabled,Tt.annotationGPInfo.contour,Tt.annotationGPInfo.contour1,Tt.annotationGPInfo.contour2}const It=Tt.textureJson,Ct=Tt.imagesBuffer;new Promise((e,t)=>{this._threeDXLoader.load({zipped:!1,json:It,chunks:Ct,destinationNode:_t,doneCallback:e,resourcesLibrary:E,forcePowerOfTwo:!1})}).then(()=>{const e=function(e){var t=l.MaterialUtils.createMatteFaceMaterial({color:16777215,map:e,side:l.DoubleSide,transparent:!0,alphaTest:1e-4});t.force=!0;var i=s.createRectangleNode({width:e.image.width,height:e.image.height,cornerPoint:new l.Vector2(0,-e.image.height),fill:!0,color:new c.Color(.5,.5,.2,1),material:t});i.setRatio(1);var r=(new l.Matrix4).setPosition(wt),a=new p({type:"Spherical"});a.setMatrix(r),a.addChild(i),_t.addChild(a)},t=Object.values(E.refImages)[0].values().next().value;if(t instanceof l.Texture){if(t.loadEndStatus!==l.AssetLoadingStatus.READY)return void t.onLoadCallbacks.push(e);e(t)}})}Ae&&(x&&Ae.setNoZ(!0),N||t.addChild(Ae),d.push(Ae),Ae.persistentId=b,o.push(b))}return{geometry:d,primitiveIDs:o}},_CBOnTraversal:function(e,t){if(void 0===e)return!0;"Mesh3D"===e.getNodeType()&&e.mesh3js.geometry[0].drawingGroups.forEach(function(e){e._geomType=t});return!1},getRefPlaneNode:function(e){var t=e.newLook?"NL_":"";e.orientationArrow&&(t+="OA_"),e.fixedSize&&(t+="FS_"),t+=e.size.x.toFixed(3)+"_",t+=e.size.y.toFixed(3)+"_";var i=e.planeAttributes;i&&(i.front&&(i.front.opacity&&(t+="O_",t+=i.front.opacity.toFixed(3)),i.front.color&&(t+="FC_",t+=i.front.color.getHexString())),i.back&&i.back.color&&(t+="BC_",t+=i.back.color.getHexString())),e.textAttributes&&e.textAttributes.front&&(t+="T_",t+=e.textAttributes.front.data);var r=b.get(t);return r||((r=new v(e)).setPickParent(!0),b.set(t,r)),r},getAxisNode:function(e,t){var i="AL_"+e.arrowLength;i+="HL_"+e.arrowHeadLength,i+="SA_"+e.headWidthToHeightRatio,i+="T_"+t.text;var r=V.get(i);if(!r){var a=new n(e);a.setPickParent(!0);var o=new f("myText",!0,{billboard:!0,billboardAxis:!1,fixedSize:!0,allocSize:t.length});o.setPickParent(!0),o.textMaterial.refreshUniforms=function(e,t,i){this.updatePDSFXUniform("invSize",new l.Vector2(1/e.getViewportSize().width,1/e.getViewportSize().height))},o.addText({string:t.text,anchor:new l.Vector3,offset:new l.Vector3(-5,-5,0),color:new l.Color(16777215),size:20*(l.getDevicePixelRatio()||1),lineLength:500,up:new l.Vector3(0,0,1),right:new l.Vector3(0,1,0)}),o.setPrimitivePicking(!1),o.setRatio(1),o.setFixedSizeCenter(new l.Vector3(0,0,8+e.arrowLength),1),r={axis:a,label:o},V.set(i,r)}return r}})}),define("DS/WebVisuParameters/SceneEnvParameterHelper",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/WebVisuParameters/SceneEnvParameterItem"],function(e,t,i,r){"use strict";var a=r.SceneEnvData,n=(r.VisuContextData,{VIEW_NO_DISPLAY:0,VIEW_MESH:1,VIEW_EDGE:2,VIEW_OUTLINE:4,VIEW_MATERIAL:8,VIEW_HLR:16,VIEW_HRD:32,VIEW_HIDDEN_EDGE:64,VIEW_POLYGON:128,VIEW_ISOPARS:256,VIEW_TOON:512,VIEW_TRANSPARENT:1024,VIEW_REP_OVERLOAD:2048,VIEW_WITH_HALF_SMOOTH_EDGE:4096,VIEW_WITHOUT_SMOOTH_EDGE:8192,VIEW_LINEONLINE:16384,VIEW_WITHOUT_VERTEX:32768,VIEW_COLORED_EDGES_FROM_FACES:65536,VIEW_WITHOUT_WIRES:131072,VIEW_WITHOUT_AXIS:262144,VIEW_WITHOUT_POINTS:524288,VIEW_WITHOUT_CONSTRAINTS:1048576,VIEW_RAYTRACING:2097152,VIEW_WITHOUT_SMALL_CURVATURE_STEP_EDGE:536870912,VIEW_APPEARANCE:1073741824});e.__ViewModeType__=n;var o={Basic:e.DefaultAppearanceMode.BASIC,GASLook:e.DefaultAppearanceMode.GASLOOK,Transparent:e.DefaultAppearanceMode._TRANSPARENT,Clay:e.DefaultAppearanceMode.CLAY,WhiteMatPlaster:e.DefaultAppearanceMode.WHITE_MAT_PLASTER,GreyShinyPlastic:e.DefaultAppearanceMode.GREY_SHINY_PLASTIC,CastAluminum:e.DefaultAppearanceMode.CAST_ALUMINUM,MachinedAluminum:e.DefaultAppearanceMode.MACHINED_ALUMINUM,CastSteel:e.DefaultAppearanceMode.CAST_STEEL,BrushedSteel:e.DefaultAppearanceMode.BRUSHED_STEEL,MachinedStainlessSteel:e.DefaultAppearanceMode.MACHINED_STAINLESS_STEEL,Copper:e.DefaultAppearanceMode.COPPER,Brass:e.DefaultAppearanceMode.BRASS,GenericPlastic:e.DefaultAppearanceMode.GENERIC_PLASTIC,GenericMetal:e.DefaultAppearanceMode.GENERIC_METAL,QAAutomation:null,Count:null};e.__ViewAppearanceMap__=o;var s=new Uint32Array(1),l=new Uint8Array(s.buffer),d=1;function c(t,r,a,n,o){var d=!1,c="Halo",h=t.getHaloData();s[0]=h.color,a.Halo.haloEnabled=!!h.activation,d=d||!!h.activation,a.Halo.haloIntensity=h.intensity,a.Halo.haloThickness=h.size,n.Halo.haloColor=(new e.Color).setRGB(l[3]/255,l[2]/255,l[1]/255);var u=t.getScanData();s[0]=u.color,a.Halo.colorEnabled=!!u.activation,d=d||!!u.activation,a.Halo.intensity=u.intensity,n.Halo.color=(new e.Color).setRGB(l[3]/255,l[2]/255,l[1]/255);var g=t.getOutlineData();s[0]=g.color,a.Halo.outlineEnabled=!!g.activation,d=d||!!g.activation,n.Halo.outlineColor=(new e.Color).setRGB(l[3]/255,l[2]/255,l[1]/255),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",eventType:"@CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",parameters:{viewer:r,highlightType:"Halo",nonColorParameters:a.Halo}}}),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",eventType:"@CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",parameters:{viewer:r,highlightType:"Halo",colorParameters:n.Halo}}}),(t.getStandardActivation()||t.getPolitnessData().activation)&&(c="AdvancedPoliteness",d=!0);var p=t.getAdvancedPolitnessData();return p.activation&&(c="AdvancedPoliteness",d=!0),a.AdvancedPoliteness.haloIntensity=p.haloIntensity,a.AdvancedPoliteness.outlineThickness=p.faceThickness,a.AdvancedPoliteness.visibleAlpha=p.visibleFaceAlpha/255,a.AdvancedPoliteness.occludedAlpha=p.occludedFaceAlpha/255,s[0]=p.color,n.AdvancedPoliteness.color=(new e.Color).setRGB(l[3]/255,l[2]/255,l[1]/255),s[0]=p.haloColor,n.AdvancedPoliteness.haloColor=(new e.Color).setRGB(l[3]/255,l[2]/255,l[1]/255),s[0]=p.outlineColor,n.AdvancedPoliteness.outlineColor=(new e.Color).setRGB(l[3]/255,l[2]/255,l[1]/255),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",eventType:"@CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",parameters:{viewer:r,highlightType:"AdvancedPoliteness",nonColorParameters:a.AdvancedPoliteness}}}),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",eventType:"@CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",parameters:{viewer:r,highlightType:"AdvancedPoliteness",colorParameters:n.AdvancedPoliteness}}}),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_TYPE_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_TYPE_UPDATE",eventType:"@CSI_CONTEXT_"+o+"_TYPE_UPDATE",parameters:{viewer:r,highlightType:c}}}),r.render(),d}var h=function(e,t){this.viewManager=e,this.viewer=this.viewManager?this.viewManager.viewer:null,this.loader=t};return h.prototype={constructor:h,getSceneEnvRootForLights:function(){var e=this.viewManager._sceneEnvRootForLights;return 0===e.parents.length&&this.viewer.addNode(e),e},setViewManager:function(e){this.viewManager=e,this.viewer=this.viewManager?this.viewManager.viewer:null},getSceneEnvRootForAmbiances:function(){var e=this.viewManager._sceneEnvRootForAmbiance;return 0===e.parents.length&&this.viewer.addNode(e),e},tryUpdateAmbiance:function(e){if(!e)return Promise.reject(new Error("Missing data"));if(!e.areAmbiancesManaged())return Promise.resolve(!1);if(this.getSceneEnvRootForAmbiances().removeChildren(),e.isDefaultAmbiance())return this.viewer.removeAmbience(),this.viewer.setVisuEnv("None"),Promise.resolve(!0);var t=e.getAmbianceJSON();if(!t)return Promise.resolve(!1);if(!t.ambiance)return this.viewer.setVisuEnvOCA("Basic"),Promise.resolve(!0);var i=e.getAmbianceBuffers(),r=[];return Array.isArray(i)&&i.length>0&&i.forEach(function(e){r.push({buffer:e.getData()})}),new Promise(function(e){if(this.viewer.removeAmbience(),this.loader.load({zipped:!1,json:t,chunks:r,destinationNode:this.getSceneEnvRootForAmbiances(),doneCallback:e.bind(null,!0)}))return Promise.resolve(!0)}.bind(this))},tryUpdateLights:function(e){if(!e)return Promise.reject(new Error("Missing data"));if(!e.areLightsManaged())return Promise.resolve(!1);var t=e.getLightsJSON();if(!t)return Promise.resolve(!1);this.viewer.useDefaultLights=!1,this.getSceneEnvRootForLights().removeChildren();return this.loader.applyLights({json:t,data:{},destinationNode:this.getSceneEnvRootForLights()}),Promise.resolve(!0)},_mergeCreatedvps(e,t,i){let r=[],a=0,n=0;for(let o=0;o<e.length;o++){let s=e[o];"Main3D"==s.getType()||"3D"==s.getType()?(r.push(t[a]),a++):(r.push(i[n]),n++)}return r},_manageViewpointInfo(e,t){let i=null;var r=this.viewManager._viewpointMap;if(r.has(e.getUID())?i=r.get(e.getUID()):((i=t).createDivCSS(),i.setCsiUID(e.getUID()),r.set(e.getUID(),i),"Main3D"==e.getType()||"Main2D"==e.getType()?null===this.viewer.currentViewpoint.getCsiUID()?(i._setNode(this.viewer.internalSceneGraph.root),this.viewer.selectViewpoint(null,i)):this.viewer._viewpointManager.addMainViewpoint(i,!0):this.viewer._viewpointManager.addViewpoint(i,!1)),"Main3D"!=e.getType()&&"Main2D"!=e.getType()||this.viewer.getVisibleSpace()!=e.isShowSpace()&&this.viewer.swapVisibleSpace(),e.MinZoom,e.MaxZoom,e.AaMode,e.IsStretched,e.Viewport,e.PLMViewMode,e.IsMainDialog,e.IsV3D,"Main3D"==e.getType()||"3D"==e.getType()){let t=e.getViewpoint3DInfo();i.getControl()&&i.getControl().setNativeGravity(t.areGravityMode(),t.getGravityDirection(),t.getGravityLocked()),t.ClippingMode,t.NearValue,t.FarValue}else{let t=e.getViewpoint2DInfo();i.setNative2DClip(t.getClip(),t.getBottomLeft(),t.getTopRight()),i.setNative2DAnchor(t.getAnchor()),t.areTranslationBoundsDefined()&&setNative2DTranslationBounds(t.getBoundsX(),t.getBoundsY()),i.setNative2DDepthMode(t.getDepth())}},tryUpdateCameras:function(e){if(!e)return Promise.reject(new Error("Missing data"));if(!e.areCamerasManaged())return Promise.resolve(!1);var t=e.getCamerasJSON();if(!t)return Promise.resolve(!1);if(e instanceof a)this.loader.applyCamera({json:t,destinationNode:this.viewer.getRootNode()});else{var i=this.viewManager._viewpointMap;let r=t,a=this.loader.retrieveViewpoints({json:r},this.viewer,!0,!0),n=e.getCameras2DJSON(),o=this.loader.retrieveViewpoints({json:n},this.viewer,!0,!0),s=e.getChangeType(),l=e.getViewpointsInfo();a=this._mergeCreatedvps(l,a,o),"ViewpointListChanged"==s&&i.size>l.length&&i.forEach((e,t,i)=>{let r=!1;for(let e=0;e<l.length;e++)if(l[e].getUID()==t){r=!0;break}r||(this.viewer._viewpointManager.removeViewpoint(e),i.delete(t))});for(let e=0;e<l.length;e++){let t=a[e],r=null;this._manageViewpointInfo(l[e],t),t!=(r=i.get(l[e].getUID()))&&(r._nativeTranslationOffset=t._nativeTranslationOffset,r.moveTo({eyePosition:t.position,orientation:t.control.orientation,distanceToTarget:t.control.distanceToTarget}),r.control.update(),r.camera.fov=t.camera.fov,r.setProjectionType(t.getProjectionType(),null,!0),r._nativeZoomType==t._nativeZoomType&&r._nativeZoomRatio==t._nativeZoomRatio||r.setNativeZoom(t._nativeZoomType,t._nativeZoomRatio),r._nativeZoom=t._nativeZoom,t.dispose())}}return Promise.resolve(!0)},tryUpdateViewModes:function(t){if(this.viewer){if(!t)return Promise.reject(new Error("Missing data"));if(!t.areViewModesManaged())return Promise.resolve(!1);var i=t.getViewModeMask(),r="Wireframe";i&n.VIEW_HRD?r="ShadingIllustration":i&n.VIEW_MESH&&(r="Shading",i&n.VIEW_MATERIAL&&(r+="Material"),i&n.VIEW_EDGE&&(r+="Edges",i&n.VIEW_WITHOUT_SMOOTH_EDGE?r+="NoSmoothEdges":i&n.VIEW_WITH_HALF_SMOOTH_EDGE&&(r+="HalfSmoothEdges"),i&n.VIEW_HIDDEN_EDGE&&(r+="HiddenEdges")));var a=i&n.VIEW_REP_OVERLOAD;this.viewer._getCSIOverrideManager().setRepViewMode(a),this.viewer.setVisuShadingMode(r),this.viewer._setVisuOutlineMode((i&n.VIEW_OUTLINE)>0),this.viewer.setLinesFilter(!(i&n.VIEW_WITHOUT_WIRES)),this.viewer.setVerticesFilter(!(i&n.VIEW_WITHOUT_VERTEX)),this.viewer.setPointsFilter(!(i&n.VIEW_WITHOUT_POINTS)),this.viewer.setAxisFilter(!(i&n.VIEW_WITHOUT_AXIS));var s=t.getViewModeAppearanceStructure(n.VIEW_APPEARANCE);if(s){var l=o[s.appearanceName];void 0!==l&&(this.viewer.setVisuAppearanceMode(l),l!==e.DefaultAppearanceMode.GENERIC_PLASTIC&&l!==e.DefaultAppearanceMode.GENERIC_METAL||this.viewer.setCustomMaterialModeParameters(s.customParams))}else this.viewer.setVisuAppearanceMode(o.Basic);return Promise.resolve(!0)}},tryUpdateSupportParameters:function(t,r){var a=Promise.resolve(!0);if(!t)return Promise.reject(new Error("Missing data"));if(!t.areSupportParametersManaged())return Promise.resolve(!1);var n=t.getHighlightRenderingData();n&&function(t,r){for(var a=t.getMultiColorData(),n=a.highlightSlots,o=0;o<n.length;o++){s[0]=n[o];var d=(new e.Color).setRGB(l[3]/255,l[2]/255,l[1]/255);i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_UPDATE",eventType:"@CSI_CONTEXT_MULTI_HIGHLIGHT_UPDATE",parameters:{slot:o,color:d,viewer:r}}})}i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_ACTIVATION",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_ACTIVATION",eventType:"@CSI_CONTEXT_MULTI_HIGHLIGHT_ACTIVATION",parameters:{viewer:r,enabled:!!a.activation}}});var h=c(t,r,{Halo:{colorEnabled:e.DefaultHighlightData.halo.colorEnabled,intensity:e.DefaultHighlightData.halo.intensity,haloEnabled:e.DefaultHighlightData.halo.haloEnabled,haloIntensity:e.DefaultHighlightData.halo.haloIntensity,haloThickness:e.DefaultHighlightData.halo.haloThickness,outlineEnabled:e.DefaultHighlightData.halo.outlineEnabled,outlineAlpha:e.DefaultHighlightData.halo.outlineAlpha,outlineThickness:e.DefaultHighlightData.halo.outlineThickness},AdvancedPoliteness:{colorEnabled:e.DefaultHighlightData.advancedpolite.colorEnabled,visibleAlpha:e.DefaultHighlightData.advancedpolite.visibleAlpha,occludedAlpha:e.DefaultHighlightData.advancedpolite.occludedAlpha,haloEnabled:e.DefaultHighlightData.advancedpolite.haloEnabled,haloIntensity:e.DefaultHighlightData.advancedpolite.haloIntensity,haloThickness:e.DefaultHighlightData.advancedpolite.haloThickness,outlineEnabled:e.DefaultHighlightData.advancedpolite.outlineEnabled,outlineAlpha:e.DefaultHighlightData.advancedpolite.outlineAlpha,outlineThickness:e.DefaultHighlightData.advancedpolite.outlineThickness}},{Halo:{color:e.DefaultHighlightData.halo.color,outlineColor:e.DefaultHighlightData.halo.outlineColor,haloColor:e.DefaultHighlightData.halo.haloColor},AdvancedPoliteness:{color:e.DefaultHighlightData.advancedpolite.color,outlineColor:e.DefaultHighlightData.advancedpolite.outlineColor,haloColor:e.DefaultHighlightData.advancedpolite.haloColor}},"HIGHLIGHT");i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_ACTIVATION",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_ACTIVATION",eventType:"@CSI_CONTEXT_HIGHLIGHT_ACTIVATION",parameters:{viewer:r,enabled:h}}}),r.internalSceneGraph.selectionHL.enable(h)}(n,this.viewer);var o=t.getPrehighlightRenderingData();o&&function(t,i){var r={Halo:{colorEnabled:e.DefaultPreHighlightData.halo.colorEnabled,intensity:e.DefaultPreHighlightData.halo.intensity,haloEnabled:e.DefaultPreHighlightData.halo.haloEnabled,haloIntensity:e.DefaultPreHighlightData.halo.haloIntensity,haloThickness:e.DefaultPreHighlightData.halo.haloThickness,outlineEnabled:e.DefaultPreHighlightData.halo.outlineEnabled,outlineAlpha:e.DefaultPreHighlightData.halo.outlineAlpha,outlineThickness:e.DefaultPreHighlightData.halo.outlineThickness},AdvancedPoliteness:{colorEnabled:e.DefaultPreHighlightData.advancedpolite.colorEnabled,visibleAlpha:e.DefaultPreHighlightData.advancedpolite.visibleAlpha,occludedAlpha:e.DefaultPreHighlightData.advancedpolite.occludedAlpha,haloEnabled:e.DefaultPreHighlightData.advancedpolite.haloEnabled,haloIntensity:e.DefaultPreHighlightData.advancedpolite.haloIntensity,haloThickness:e.DefaultPreHighlightData.advancedpolite.haloThickness,outlineEnabled:e.DefaultPreHighlightData.advancedpolite.outlineEnabled,outlineAlpha:e.DefaultPreHighlightData.advancedpolite.outlineAlpha,outlineThickness:e.DefaultPreHighlightData.advancedpolite.outlineThickness}},a={Halo:{color:e.DefaultPreHighlightData.halo.color,outlineColor:e.DefaultPreHighlightData.halo.outlineColor,haloColor:e.DefaultPreHighlightData.halo.haloColor},AdvancedPoliteness:{color:e.DefaultPreHighlightData.advancedpolite.color,outlineColor:e.DefaultPreHighlightData.advancedpolite.outlineColor,haloColor:e.DefaultPreHighlightData.advancedpolite.haloColor}};i.internalSceneGraph.selectionPreHL.enable(c(t,i,r,a,"PREHIGHLIGHT"))}(o,this.viewer);var d=t.getColorMap();if(d){for(var h=[],u=0;u<d.length;u+=3){var g=(new e.Color).setRGB(d[u],d[u+1],d[u+2]);h.push(g)}i.publish({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",data:{eventChannel:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",eventType:"@COLOR_MAP_UPDATE",parameters:{colorMap:h,viewer:this.viewer}}}),a=this.viewer._refreshPLMViewMode(r),this.viewer.renderer.resetGSSOCache(),this.viewer.render()}const p=t.getBackground3DViewMode();if(null!==p){const t=(1&p)>0,i=(2&p)>0,r=(4&p)>0,a=(8&p)>0,n=(16&p)>0,o=(32&p)>0;this.viewer.setBackgroundViewMode(i?e.BackgroundViewMode.NO_DISPLAY:n?e.BackgroundViewMode.GHOST:t?e.BackgroundViewMode.LOWLIGHT:a?e.BackgroundViewMode.FOG:e.BackgroundViewMode.NORMAL),this.viewer.invertNodeBackgroundView(o),this.viewer.pickNodeBackgroundView(!r),this.viewer.render()}const f=t.get2DMode();if(f){let t,i;if(f._plane){const i=(new e.Vector3).copy(f._plane._firstDirection),r=(new e.Vector3).copy(f._plane._secondDirection),a=i.cross(r);t=new e.Plane(a,-a.dot(f._plane._origin))}switch(f._mode){case 1:i=e.PlaneViewMode.NO_DISPLAY;break;case 2:i=e.PlaneViewMode.LOWLIGHT;break;case 4:i=e.PlaneViewMode.LOWLIGHT_NO_PICK;break;default:i=e.PlaneViewMode.NORMAL}this.viewer.setPlaneViewMode({mode:i,plane:t})}else this.viewer.setPlaneViewMode({mode:e.PlaneViewMode.NORMAL});var v=t.getClippingPlane();v&&this.updateClippingPlane(v);let m=t.getMainViewpointUID();if(null==m);else{let e=this.viewManager._viewpointMap.get(m);e?this.viewer._viewpointManager.setManipulatedViewpoint(e):console.error("no viewpoint with provided UID exists")}return a},tryUpdatePLMViewMode:function(e,t){var i,r=e.getViewpointsInfo();if(r)for(i=0;i<r.length;i++)this.viewer._setViewpointPLMViewMode(r[i]._uid,r[i]._plmViewMode);var a=e.getPLMViewMode();return a?this.viewer._updatePLMViewMode(a,t):Promise.resolve(!0)},updateClippingPlane:function(t){var i,r,a=this.viewer.getRootNode();if(a){var n=a.clippingContext,o=n&&n.planes.concat([]);if(o)for(i=0;i<o.length;i++)a.enableClippingPlane(o[i],!1)}var s,l,c,h=t._normal,u=t._point,g=0;for(i=0;i<t._nbPlanes;i++)(s=new e.Vector3(h[g],h[g+1],h[g+2])).normalize(),l=new e.Vector3(u[g],u[g+1],u[g+2]),(r=new e.Plane).setFromNormalAndCoplanarPoint(s,l),a.enableClippingPlane(r,!0),c=t._flags[i],a.clippingContext.setPlaneParams(r,{capping:!!(c&d)}),g+=3},tryUpdateContextData:function(e){if(!e)return Promise.reject(new Error("Missing data"));var t=e.container&&e.container.getVisContextData&&e.container.getVisContextData();if(!t)return Promise.resolve(!1);if(t.VisuStreaming){this.viewer.setupRemoteRender(),this.streamingInterface&&(this.streamingInterface.destroy(),this.streamingInterface=null);let e=t.VisuStreaming._commonData;t.VisuStreaming._objectsData;if(0==Object.keys(e).length)return Promise.resolve(!0);{let i=this;return new Promise(function(r){require(["DS/VisuStreamingA2X/VisuStreamingInterface"],function(a){i.viewer.setupRemoteRender(!0);i.streamingInterface=new a(t.VisuStreaming,function(t,r,a){if("JPEG"==e.streamProtocol){var n=t.readBuffer("colorImgBuffer"),o=new Uint8Array(n),s=new Blob([o],{type:"image/jpeg"});i.viewer._onRemoteImageReceived({data:s,format:"blob"},a)}else i.viewer.setRemoteVideo(r,a)},function(e){console.log(e)}),r.bind(null,!0)})})}}return Promise.resolve(!1)},tryUpdateSceneEnv:function(e,t){var i=this.tryUpdateAmbiance(e),r=this.tryUpdateLights(e),a=this.tryUpdateCameras(e),n=this.tryUpdateViewModes(e),o=this.tryUpdateSupportParameters(e),s=this.tryUpdatePLMViewMode(e,t),l=this.tryUpdateContextData(e);return Promise.all([i,r,a,n,o,s,l]).then(function(e){return Promise.resolve({ambianceUpdated:e[0],lightsUpdated:e[1],cameraUpdated:e[2],viewModesUpdated:e[3],supportParametersUpdated:e[4]})})}},h}),define("DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionHSO",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionXSO"],function(e,t,i){"use strict";var r=new Map,a=function(e,a){if(i.call(this,a),r.has(a)||r.set(a,{nonColorParameters:{Basic:{},Halo:{},Politeness:{},AdvancedPoliteness:{}},defaultSlotColorParameters:{Basic:{},Halo:{},Politeness:{},AdvancedPoliteness:{}},highlightType:"AdvancedPoliteness",advanced:!0}),this.enabled=!0,this.highlightColor=r.get(a).advanced?new t.AdvancedPoliteHighlightData(t.DefaultHighlightData.advancedpolite):new t.HaloHighlightData(t.DefaultHighlightData.halo),this.highlightColor.priority=8192,e)this.highlightColor._setData(e);else{var n=r.get(a).currentHighlightType;this.highlightColor._setData(r.get(a).defaultSlotColorParameters[n])}this._event="HIGHLIGHT",this._setData(this.highlightColor)};(a.prototype=Object.create(i.prototype))._setData=function(i){if(i){var a=this.viewer,n=r.get(a).advanced?new t.AdvancedPoliteHighlightData(this.highlightColor):new t.HaloHighlightData(this.highlightColor);n._setData(i);var o=r.get(a).currentHighlightType;n._setData(r.get(a).nonColorParameters[o]),e.publish({event:"/VISU/SELECTION/CSI_HIGHLIGHT_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_HIGHLIGHT_UPDATE",eventType:"@CSI_HIGHLIGHT_UPDATE",parameters:{highlightColor:this.highlightColor,newColor:n,viewer:a,advanced:r.get(a).advanced}}}),this.highlightColor=n}};var n=new Map,o=null;return e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_UPDATE"},function(e){var t=e.parameters.slot+1,i=e.parameters.color,r=e.parameters.viewer,s=i,l=i.clone().multiplyScalar(1.142);l.r=Math.max(Math.min(l.r,1),0),l.g=Math.max(Math.min(l.g,1),0),l.b=Math.max(Math.min(l.b,1),0);var d={color:i,haloColor:s,outlineColor:l,priority:4095+t};(o=n.get(r))||(o=[new a(null,r)],n.set(r,o)),o[t]?o[t]._setData(d):o[t]=new a(d,r)}),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_ACTIVATION"},function(e){var t=e.parameters.enabled,i=e.parameters.viewer;(o=n.get(i))||(o=[new a(null,i)],n.set(i,o));for(var s=1;s<o.length;s++){o[s]||(o[s]=new a({},i)),o[s].enabled=t;var l=i._getHighlightSet(o[s].highlightColor,!1,!!r.get(i).advanced);l&&l.enable(t)}}),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_ACTIVATION"},function(e){var t=e.parameters.enabled,i=e.parameters.viewer;(o=n.get(i))||(o=[new a(null,i)],n.set(i,o)),o[0]||(o[0]=new a({},i)),o[0].enabled=t;var s=i._getHighlightSet(o[0].highlightColor,!1,!!r.get(i).advanced);s&&s.enable(t)}),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_HIGHLIGHT_UPDATE"},function(e){var t=e.parameters.viewer;(o=n.get(t))||(o=[new a(null,t)],n.set(t,o));var i=e.parameters.highlightType,s=r.get(t).currentHighlightType;Object.assign(r.get(t).defaultSlotColorParameters[i],e.parameters.colorParameters),o[0]._setData(r.get(t).defaultSlotColorParameters[s])}),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_NON_COLOR_UPDATE"},function(e){var t=e.parameters.viewer;(o=n.get(t))||(o=[new a(null,t)],n.set(t,o));var i=e.parameters.highlightType;Object.assign(r.get(t).nonColorParameters[i],e.parameters.nonColorParameters);for(var s=0;s<o.length;s++)o[s]&&o[s]._setData({})}),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_TYPE_UPDATE"},function(e){var t=e.parameters.viewer;(o=n.get(t))||(o=[new a(null,t)],n.set(t,o));var i=e.parameters.highlightType;"AdvancedPoliteness"===i||"Halo"===i?(r.get(t).currentHighlightType=i,r.get(t).advanced="AdvancedPoliteness"===i):i=r.get(t).currentHighlightType;for(var s=0;s<o.length;s++)o[s]&&o[s]._setData(0===s?r.get(t).defaultSlotColorParameters[i]:{})}),e.subscribe({event:"/VISU/VIEWER/VIEWER_DISPOSED"},function(e){var t=e.parameters.viewer;if(n.has(t))for(var i=n.get(t),a=0;a<i.length;a++){var o=i[a];if(o){o._treeKeyToStruct.forEach(function(e,t,i){o._setTreeKey(t),o.removeAll()});var s=t._getHighlightSet(o.highlightColor,!1,!!r.get(t).advanced);s&&t.removeHighlightSet(s)}}n.delete(t),r.delete(t)}),{getXSO:function(e,t,i){if((o=n.get(t))||(o=[new a(null,t)],n.set(t,o)),e>o.length||e<0)throw"Invalid slot";var s=o[e];if(!s)throw"Missing slot";return t.createHighlightSet(s.highlightColor,!1,!!r.get(t).advanced).enable(s.enabled),s._setTreeKey(i),s},clearMultiHighlightColorSlot:function(e){for(var t=1;t<o.length;t++){var i=o[t];i&&(i._setTreeKey(e),i.removeAll())}}}}),define("DS/WebVisuParameters/WebVisuUpdateTransaction",["DS/WebVisuParameters/AbstractWebVisuUpdateTransaction","DS/CSIViewModelWebInterfaces/CSIVMClientOperation","DS/CSIViewModelWebInterfaces/CSIVMClientVisRepViewModeFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisClippingFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisAnnotation","DS/CSIViewModelWebInterfaces/CSIVMClientVisAnnotationValue","DS/CSIViewModelWebInterfaces/CSIVMClientVisCircularScissorFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisLayerFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisGASInheritFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisPolygonOffsetFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisPolygonalScissorFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisCurveClippingFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisZModeFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisFurtiveFilter","DS/Visualization/MaterialManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","DS/Visualization/CGRNode","DS/Visualization/SceneGraphFactory","DS/Visualization/PathElement","DS/VisuLoaders/ThreeDXLoader","DS/WebVisuParameters/BoundingSphereParameterHelper","DS/WebVisuParameters/CustomDataParameterHelper","DS/WebVisuParameters/GeometryParameterHelper","DS/WebVisuParameters/InfiniteGeometryParameterHelper","DS/WebVisuParameters/GraphicPropertyParameterHelper","DS/WebVisuParameters/SceneEnvParameterHelper","DS/WebVisuParameters/SceneEnvParameterItem","DS/Mesh/MeshUtils","DS/Visualization/GraphicAttributeSet","DS/Visualization/ClippingContext","DS/Visualization/RenderStyle","DS/EKEventsWeb/EKEvents","DS/Visualization/Filters/GeomTypeFilter","DS/Visualization/Filters/GASInheritFilter","DS/Visualization/Filters/PolygonOffsetFilter","DS/Visualization/Filters/ZModeFilter","DS/SceneGraphOverrides/SceneGraphOverrideSet"],function(e,t,i,r,a,n,o,s,l,d,c,h,u,g,p,f,v,m,S,y,T,_,w,I,C,D,E,P,M,A,b,V,O,N,G,R,H,L,B,x,F){"use strict";var U=null,k=null,W={volume:f.MaterialUtils.createShinyFaceMaterial({side:f.FrontSide,color:new f.Color(16777215)}),surface:f.MaterialUtils.createShinyFaceMaterial({side:f.DoubleSide,color:new f.Color(16777215)}),line:new f.LineBasicMaterial({color:new f.Color(0)}),point:new f.ParticleBasicMaterial({size:1,color:new f.Color(0),blending:f.NormalBlending,depthTest:!1,sizeAttenuation:!1,transparent:!1})};W.volume.line=W.line,W.volume.point=W.point,W.surface.line=W.line,W.surface.point=W.point;f.MaterialUtils.createShinyFaceMaterial({side:f.DoubleSide,color:new f.Color(16777215)}),f.MaterialUtils.createShinyFaceMaterial({side:f.FrontSide,color:new f.Color(16777215)}),new O({color:new f.Color(16777215)}),new O({color:new f.Color(0)});var z=new I,j=new A(null,z),X=1,K=2,J=4,Y=8,Z=32,q=64,Q=4096,$=8192,ee=32768,te=131072,ie=262144,re=524288;const ae=536870912,ne=536870913,oe=536870914,se=[0,0],le=[1,1.1],de=[3,2.2];var ce=function(e,t){if(t)for(var i=0;i<e.meshList.length;i++){var r=e.meshList[i]._occurrence.node;if(r&&2===r._bodyDim)return}for(i=0;i<e.drawingGroups.length;i++){var a=e.drawingGroups[i];a.gas,a.material;4===a.glType&&(a.getPrimitivesCount()&&(a.getPrimitiveRep(0).solid=t))}},he=function(e){return e?e.children[0]instanceof m?e.children[0]:e.children[1]:null},ue=function(e){return e?e.children[0]instanceof m?e.children[1]:e.children[0]:null},ge=function(e){var t=null;if(e)switch(e.getType()){case 1:case 2:t=new H(-1);break;case 3:t=new H(f.GeomTypeEnum.AXIS_SYSTEM);break;case 4:t=new H(f.GeomTypeEnum.WIRE_EDGE);break;case 5:t=new H(f.GeomTypeEnum.FREE_POINT);break;default:t=new H(-1)}return t},pe=function(t,i,r){e.call(this,t,i,r),this._dialogBag=null,this._onTopBag=null,this._furtiveBag=null,this._transientBag=null,this.annotationFilters=[],this.nodesToRemove=[],this.nodesToOptimize={},this.inverseAction={adds:[],removes:[],overrides:{}},this.commitAction={adds:[],removes:[]}};(pe.prototype=Object.create(e.prototype)).getParentNode=function(e){var t=e.getOperatedObject();let i=e.getTreeKey();if(!t&&i){switch(i.getView3DType()){case i.View3DType.View3D_Dialog:this._dialogBag||(this._dialogBag=new v,this.view.addChild(this._dialogBag),this._dialogBag.setAsNativeDialog(!0)),t=this._dialogBag;break;case i.View3DType.View3D_OnTop:this._onTopBag||(this._onTopBag=new v,this.view.addChild(this._onTopBag),this._onTopBag.setAsNativeOnTop(!0)),t=this._onTopBag;break;case i.View3DType.View3D_Furtive:this._furtiveBag||(this._furtiveBag=new v,this.view.addChild(this._furtiveBag),this._furtiveBag.setAsNativeFurtive(!0)),t=this._furtiveBag;break;case i.View3DType.View3D_Transient:this._transientBag||(this._transientBag=new v),t=this._transientBag;break;case i.View3DType.View3D_Highlight:case i.View3DType.View3D_MultiColorHighlight:case i.View3DType.View3D_PreHighlight:t=this.view;break;case i.View3DType.View3D_Unknown:case i.View3DType.View3D_Main:default:t=this.view}}return t},pe.prototype.doOperation=function(e){var t=R.Trace.traceStart("techno_webvisu","message_to_scenegraph");this.setDefaultMaterials(this.viewManager.getDefaultMaterials()),k!==this&&(k&&k.executeInverse(),k=this);var i=this,r=e.getType();switch(r){case e.OperationType.RemoveTextureFromCache:var a=e.getTextureUids();if(a.length>0)for(var n=new M(void 0,this.clientManager),o=0;o<a.length;o++)n.removeTextureFromCache(a[o]);break;case e.OperationType.RemoveAll:this.view&&this.view.removeChildren();break;case e.OperationType.AddNode:case e.OperationType.AddBody:case e.OperationType.CreateRoot:var s=null,l=null,d=e.getAttributes(),c=null,h=null,u=(Ve=this.getParentNode(e))instanceof v,g=Ve instanceof THREEDS.Nodes.CGRNode,p=u&&!g,S=e.getGeometricalData(),y=null,_=null;let t=null,R=null,k=null;if(d){let e=d.getISOData();_=d.get2DTo3DData(),e&&(y=e.getDrawLayer()),c=d.getPositionMatrix(),c=this.unstreamMatrix(c),h=d.getFilters&&d.getFilters(),t=d.getFixedSizeData(),R=d.getBillboardData(),l={matrix:c||void 0},k=ge(d.getSemanticData())}if(r===e.OperationType.AddNode||r===e.OperationType.CreateRoot)if(p)s=t?this.nodeFromFixedSizeData(t):_?this.createNodeFromData2Dto3D(_):R?this.nodeFromBillboardData(R):new v,k&&s.setVisuFilters({geomTypeFilter:k});else{s=new V.SGBag(l);var w=g?Ve.internalSceneGraph:Ve;s.parents.push(w),w.children.push(s)}else if(p)S&&S.hasInfiniteGeometry()?s=new v:(!0,(s=new m).setShadow(!0,!0),s.mesh3js.fromLoadedModel=!0,s._occurrences[0].renderable.fromLoadedModel=!0,s.mesh3js.geometry=s._occurrences[0].renderable.geometry);else{s=S&&S.hasInfiniteGeometry()?new V.SGBag(l):new V.SGRep(l);w=g?Ve.internalSceneGraph:Ve;s.parents.push(w),w.children.push(s)}if(!s)return;e.setCreatedObject(s);var I=null;if(p&&(d&&c&&s.setMatrix(c),I=S?C.getBoundingSphere(S.getBoundingSphere()):null,this.applyBEToBody(s,I),null!=y&&s.setAsNativeIsoBag(y),_&&this.apply2DTo3DData(s,_),Ve.addChild(s),h&&this.setFilters(s,h),S&&S.getDimension)){s._bodyDim=S.getDimension();for(var A=0;A<s._occurrences.length;A++){(x=s._occurrences[A].renderable)&&(x._bodyDim=s._bodyDim)}}var O=S?S.getInitializers():null;if(O&&O.length)for(o=0;o<O.length;o++){var N=O[o];if(N instanceof m){if(!N||!N._occurrences[0].renderable){console.warn("Error during initializers of AddBody operation");continue}for(var G=N._occurrences[0].renderable,H=0;H<G.geometry.length;H++){var L=G.geometry[H],B=G.layer?G.layer.getIntervals(L,null,!0):null;for(A=0;A<s._occurrences.length;A++)s._occurrences[A].renderable.addGeometry(L,!I,B);s._bodyDim&&ce(L,3===s._bodyDim)}if(_e=G.selectionGroups)for(A=0;A<s._occurrences.length;A++)for(var x=s._occurrences[A].renderable,F=0;F<_e.length;F++)x.addSelectionGroup(_e[F].clone())}else if(N instanceof v){var U=N.getChildren();for(H=0;H<U.length;H++)s.addChild(U[H])}}if(I)for(A=0;A<s._occurrences.length;A++){var W=s._occurrences[A].renderable;this.applyBEToRenderable(W,s)}this.inverseAction.removes.push({parentNode:Ve,node:s}),s&&d&&d._PLMData&&this.viewManager.viewer._setNodePLMViewMode(s,d._PLMData,e.getTreeKey().getViewpointUID());break;case e.OperationType.AddCustomNode:s=null;if((X=new D(e.getCustomData(),function(){i.viewManager._publishVisuAnswer(!1)}))&&(s=X.getNode()),!s)return;if(e.setCreatedObject(s),d=e.getAttributes()){c=d.getPositionMatrix();(c=this.unstreamMatrix(c))&&s.setMatrix(c)}(Ve=this.getParentNode(e)).addChild(s),this.inverseAction.removes.push({parentNode:Ve,node:s});break;case e.OperationType.ModifyCustomNode:s=e.getOperatedObject();var X=new D(e.getCustomData(),function(){i.viewManager._publishVisuAnswer(!1)});s&&X.modifyNode(s);break;case e.OperationType.AddExistingNode:case e.OperationType.RemoveExistingNode:if(!(s=e.getOperandObject()))return;(g=(Ve=this.getParentNode(e))instanceof THREEDS.Nodes.CGRNode)&&(Ve=Ve.internalSceneGraph);var K=e.getBatchParentObject(),J=e.getBatchParentSharedObject();if(Ve instanceof V.SGBag){if(!K)return;this.addExistingNode(J,K,Ve,s)}else r===e.OperationType.AddExistingNode?Ve.addChild(s):this.nodesToRemove.push({parentNode:Ve,node:s}),r===e.OperationType.AddExistingNode?this.inverseAction.removes.push({parentNode:Ve,node:s}):this.inverseAction.adds.push({parentNode:Ve,node:s});break;case e.OperationType.AddExistingCells:var Y=e.getOperatedObject(),Z=(K=e.getBatchParentObject(),e.getBatchParentCellObject()),q=e._ExistingCells._noContext;if(void 0===e.getOperandSubElements)return;var Q=e.getOperandSubElements(),$=this.addExistingCells(K,Z,q,Y,Q);(Y instanceof m||Y instanceof v)&&$&&Y.show(Q);break;case e.OperationType.RemoveExistingCells:Y=e.getOperatedObject();if(void 0===e.getOperandSubElements)return;Q=e.getOperandSubElements();this.removeExistingCells(Y,Q);break;case e.OperationType.AddCells:s=e.getOperatedObject();var ee=!!(S=e.getGeometricalData())&&S.hasInfiniteGeometry();if(!(s&&s instanceof v))return;if(!(ee||s instanceof m))return;if(this.nodesToOptimize[s.id]=s,Oe=S?S.getGeometries():null)if(ee)for(o=0;o<Oe.length;o++)for(re=(He=new P(Oe[o],z).getInfiniteGeometry(this,s)).geometry,ae=He.primitiveIDs,A=0;A<re.length;A++)e.addCreatedObjectWithID(re[A],ae[A]);else for(var te=3===s._bodyDim,ie={version:S.getVersion(),hasGeomDecorations:S.hasGeomDecorations()},o=0;o<Oe.length;o++){var re=(He=new E(Oe[o],ie).getGeometry(this,te)).geometry,ae=He.primitiveIDs;if(re){for(var A=0;A<s._occurrences.length;A++){if((W=s._occurrences[A].renderable).addGeometry(re,!1),He.is2Din3D&&(W.fromLoadedModel=!1),s.bSphere){var ne=W.geometry;ne.boundingSphere||(ne.boundingSphere=new f.Sphere),ne.boundingSphere.copy(s.bSphere)}}var oe=re.drawingGroups;for(H=0;H<oe.length;H++)for(A=0;A<oe[H].getPrimitivesCount();A++){(Ge=new V.SGPrimitiveHelper).set(oe[H],A),e.addCreatedObjectWithID(Ge,ae[H][A])}}}break;case e.OperationType.ApplyGP:var se=e.getGraphicProperties();if(!se)return;s=e.getOperatedObject(),K=e.getBatchParentObject();if(!s&&!K)return;var le=s&&s instanceof V.SGBag,de=s&&s instanceof V.SGRep,pe=function(e){var t=[];if(e instanceof V.SGRep)return t.push(e),t;for(var i=0;i<e.children.length;i++)for(var r=pe(e.children[i]),a=0;a<r.length;a++)t.push(r[a]);return t};if(!s||(de||le)){var fe=ue(K),ve=he(K),me=e.getOperatedSubElements(),Se=me&&me.length?me.slice():[];if(le){var ye=pe(s);for(o=0;o<ye.length;o++)Se.push(ye[o])}else de&&Se.push(s);var Te=function(e,t){for(var i=e.children.length,r=[],a=[],n=0;n<t.length;n++){var o=t[n];if(o instanceof V.SGPrimitiveHelper)a.push(o);else if(o instanceof V.SGRep){var s,l=o.getIdentificationObject().getLocalId();for(s=0;s<i;s++){var d=e.children[s];if(l===d.persistentId){r.push(d);break}}if(s===i)for(var c=0;c<o.getPrimitivesCount();c++){var h=new V.SGPrimitiveHelper;h.set(o,c),a.push(h)}}}return{finiteSubElements:a,infiniteSubElements:r}}(fe,Se);n=new M(se,this.clientManager);Te.finiteSubElements.length>0&&n.applyGP(this,ve,Te.finiteSubElements,e.getOperatedGeomTypes&&e.getOperatedGeomTypes()),Te.infiniteSubElements.length>0&&n.applyGP(this,fe,Te.infiniteSubElements,e.getOperatedGeomTypes&&e.getOperatedGeomTypes())}else{(n=new M(se,this.clientManager)).applyGP(this,s,e.getOperatedSubElements(),e.getOperatedGeomTypes&&e.getOperatedGeomTypes())}break;case e.OperationType.ApplyAttributes:if(!((s=e.getOperatedObject())&&s instanceof v))return;if(d=e.getAttributes()){let e=d.getISOData();e&&(y=e.getDrawLayer(),s.setAsNativeIsoBag(y)),(c=d.getPositionMatrix())&&(c=this.unstreamMatrix(c))&&s.setMatrix(c);h=d.getFilters&&d.getFilters();this.setFilters(s,h),(_=d.get2DTo3DData())&&this.apply2DTo3DData(s,_),d.getFixedSizeData()&&this.nodeFromFixedSizeData(t,s);const i=d.getBillboardData();i&&this.nodeFromBillboardData(i,s);let r=ge(d.getSemanticData());r&&s.setVisuFilters({geomTypeFilter:r})}break;case e.OperationType.AddGroups:if(!(s=e.getOperatedObject()))return;if(s instanceof T||s instanceof V.SGRep)(K=e.getBatchParentObject())&&2===K.children.length&&(s=he(K));if(!(s instanceof m))return;S=e.getGeometricalData();var _e=e._Groups;for(o=0;o<_e.length;o++){var we=_e[o].getGroupedElements(),Ie=new V.SelectionGroup;for(H=0;H<we.length;H++)Ie.addPrimitive(we[H]);for(H=0;H<s._occurrences.length;H++){(W=s._occurrences[H].renderable).addSelectionGroup(Ie)}}break;case e.OperationType.ModifyBody:if(!((s=e.getOperatedObject())&&s instanceof m))return;if(!(S=e.getGeometricalData()))return;if(!(Oe=S.getGeometries()))return;for(ie={version:S.getVersion()},o=0;o<Oe.length;o++){(Ce=new E(Oe[o],ie)).updateGeometry(s)}break;case e.OperationType.ModifyBatch:if(!((s=e.getOperatedObject())&&s instanceof T))return;if(!(S=e.getGeometricalData()))return;ie={version:Me};if(Oe=S?S.getGeometries():void 0)for(o=0;o<Oe.length;o++){var Ce;L=(Ce=new E(Oe[o],ie)).getGeometry(this,!0);Ce.updateGeometry(he(s))}break;case e.OperationType.AddBatchNode:case e.OperationType.CreateRootBatch:c=null,l=null;if(d=e.getAttributes()){c=d.getPositionMatrix();l={matrix:(c=this.unstreamMatrix(c))||void 0}}var De=new V.SGBag(l);(s=new THREEDS.Nodes.CGRNode(De)).productType="3DSyncBatch";S=e.getGeometricalData();var Ee=e.getInfiniteGeometricalData(),Pe=!!S&&S.hasGeomDecorations(),Me=S?S.getVersion():null,Ae=new m;Ae.setShadow(!0,!0),Ae.mesh3js.fromLoadedModel=!0,Ae._occurrences[0].renderable.fromLoadedModel=!0,Ae.mesh3js.geometry=Ae._occurrences[0].renderable.geometry;I=S?C.getBoundingSphere(S.getBoundingSphere()):null;if(this.applyBEToBody(Ae,I),S&&S.getDimension)Ae._bodyDim=S.getDimension(),(x=Ae._occurrences[0].renderable)&&(x._bodyDim=Ae._bodyDim);var be=new v;d&&c&&s.setMatrix(c),e.setCreatedObject(s);var Ve=this.getParentNode(e),Oe=S?S.getGeometries():void 0,Ne=Ee?Ee.getGeometries():void 0;ie={version:Me,hasGeomDecorations:Pe};if(Oe)for(o=0;o<Oe.length;o++){re=(He=new E(Oe[o],ie).getGeometry(this,!0)).geometry,ae=He.primitiveIDs;(W=Ae._occurrences[0].renderable).addGeometry(re,!1),W.geometry.boundingSphere.copy(re.boundingSphere),W.geometry.boundingBox.copy(re.boundingBox);for(oe=re.drawingGroups,H=0;H<oe.length;H++)for(A=0;A<oe[H].getPrimitivesCount();A++){var Ge;(Ge=new V.SGPrimitiveHelper).set(oe[H],A),e.addCreatedObjectWithID(Ge,ae[H][A])}}if(I){W=Ae._occurrences[0].renderable;this.applyBEToRenderable(W,Ae)}if(Ne){var Re=function(e){var t=[];if(e instanceof m)t=e.getPrimitives();else if(e instanceof v)for(var i=0;i<e.children.length;i++)for(var r=Re(e.children[i]),a=0;a<r.length;a++)t.push(r[a]);return t};for(o=0;o<Ne.length;o++){var He;for(re=(He=new P(Ne[o],z).getInfiniteGeometry(this,be)).geometry,ae=He.primitiveIDs,H=0;H<re.length;H++){for(Q=Re(re[H]),A=0;A<Q.length;A++)Q[A]=Q[A].sgNode._getSGPrimitive(!0);if(Q.length){var Le=new V.SGRep({primitives:Q});for(A=0;A<Q.length;A++)Q[A].rep=Le;e.addCreatedObjectWithID(Le,ae[H])}else{Le=new V.SGRep({});e.addCreatedObjectWithID(Le,ae[H])}}}}s.addChild(Ae),s.addChild(be),Ve.addChild(s),this.inverseAction.removes.push({parentNode:Ve,node:s});break;case e.OperationType.ModifySceneEnv:j.setViewManager(this.viewManager);j.tryUpdateSceneEnv(new b.SceneEnvData(e.getSceneEnvData()),this.clientManager);break;case e.OperationType.VisuContextUpdate:j.setViewManager(this.viewManager);j.tryUpdateSceneEnv(new b.VisuContextData(e.getVisuContext()),this.clientManager)}t.End()},pe.prototype.commit=function(){this.executeInverse({commits:!0,overrides:!0,optimize:!0}),k=null,this.executeEnd()},pe.prototype.abort=function(){this.executeInverse({inverses:!0,overrides:!0}),k=null,this.executeEnd()},pe.prototype.executeEnd=function(){this.setAnnotationFilters(),this.annotationFilters=[];for(var e=0;e<this.nodesToRemove.length;e++){var t=this.nodesToRemove[e];t.parentNode.removeChild(t.node)}this.nodesToRemove=[],this.optimizeMeshes(),this.viewManager._publishVisuAnswer(!0)},pe.prototype.executeInverse=function(e){if(e){if(e.inverses){for(var t=0;t<this.inverseAction.adds.length;t++){(o=this.inverseAction.adds[t]).parentNode.addChild(o.node)}for(t=0;t<this.inverseAction.removes.length;t++){var i=(o=this.inverseAction.removes[t]).parentNode,r=o.node;if(i instanceof v)i.removeChild(r);else{var a=i instanceof T?i.internalSceneGraph:i,n=a.children.indexOf(r);-1!==n&&a.children.splice(n,1)}}}if(e.commits)for(t=0;t<this.commitAction.removes.length;t++){var o;(o=this.commitAction.removes[t]).parentNode.removeChild(o.node)}if(e.optimize&&this.optimizeMeshes(),e.overrides){var s=this.getDefaultMaterials();for(var l in this.inverseAction.overrides){var d=this.inverseAction.overrides[l];d.node.setMaterial(s.face),d.node.setPickable(V.PICKTHROUGH),d.node.setNoZ(!1)}}}},pe.prototype.optimizeMeshes=function(){for(var e in this.nodesToOptimize)this.nodesToOptimize[e];this.nodesToOptimize={}},pe.prototype.applyBEToBody=function(e,t){if(e&&t){var i=e instanceof m;t.radius||t.pixelRadius||(t.radius=1e3,e.exludeFromBounding(!0),i&&e.setFrustumCulled(!1)),e.bSphere.copy(t),e.bBox.copy(e.bSphere.getBoundingBox())}},pe.prototype.applyBEToRenderable=function(e,t){e&&(e.boundingSphere.copy(t.bSphere),e.boundingBox.copy(t.bBox),e.geometry&&(e.geometry.boundingSphere=e.boundingSphere,e.geometry.boundingBox=e.boundingBox))},pe.prototype.unstreamMatrix=function(e){if(!e)return null;var t=e.getArray(1);if(!t)return null;var i=new f.Matrix4;return i.set(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],0,0,0,1),i},pe.prototype.getStaticMaterial=function(e){return this.viewManager?this.viewManager.getStaticMaterial(e):null},pe.prototype.getStaticLook=function(e){return this.viewManager?this.viewManager.getStaticLook(e):null},pe.prototype.setDefaultMaterials=function(e){if(e.surface||e.face){var t=e.surface?e.surface:e.face;W.surface=t}e.volume?W.volume=e.volume:e.face&&(W.volume=e.face),e.line&&(W.line=e.line,W.surface.line=W.surface.line,W.volume.line=W.volume.line),e.point&&(W.point=e.point,W.surface.point=W.surface.point,W.volume.point=W.volume.point)},pe.prototype.getDefaultMaterials=function(){return W},pe.prototype.getMaterialManager=function(){return U||(U=new p),U},pe.prototype.findAssociatedInfiniteNode3D=function(e,t){var i=e.persistentId;if(i&&i===t)return e;for(var r=e.children,a=0;a<r.length;a++){var n=this.findAssociatedInfiniteNode3D(r[a],t);if(n)return n}return null},pe.prototype.addExistingNode=function(e,t,i,r){if(i.children.push(r),r.parents.push(i),!e||t===e)return!0;var a=he(e),n=function(e){var t=[];if(e instanceof V.SGRep){for(var i=0;i<e.getPrimitivesCount();i++){var r=new V.SGPrimitiveHelper;r.set(e,i),t.push(r)}return t}for(i=0;i<e.children.length;i++)for(var a=n(e.children[i]),o=0;o<a.length;o++)t.push(a[o]);return t},o=n(r);this.addPrimitivesToMesh3D(o,a,e)&&a.show(o)},pe.prototype.addExistingCells=function(e,t,i,r,a){if(!r)return!1;if(r instanceof V.SGRep){for(var n=0;n<a.length;n++)if(a[n]instanceof V.SGPrimitiveHelper){var o=a[n]._getSGPrimitive(),s=a[n].index;a[n].container._primitives[s].rep=r,r._primitives.push(o)}if(i)return!0;if(e===t)return!0;r=he(e)}else if(r instanceof V.SGBag){for(n=0;n<a.length;n++){if(a[n]instanceof v&&!i)return console.warn("Primitives can't come from a non batched body"),!1;a[n]instanceof V.SGRep&&(a[n].parents.push(r),r.children.push(a[n]))}if(i)return!0;if(e===t)return!0;var l=ue(e),d=ue(t);for(n=0;n<a.length;n++){null!=(c=this.findAssociatedInfiniteNode3D(d,a[n].modelIdentification.getLocalId()))&&l.addChild(c)}return!0}if(!r.getNodeType||"Mesh3D"!==r.getNodeType()){for(n=0;n<a.length;n++)if(a[n])if(a[n]instanceof v)r.addChild(a[n]);else{var c;d=ue(t);(c=this.findAssociatedInfiniteNode3D(d,a[n].getIdentificationObject().getLocalId()))&&r.addChild(c)}return!1}return this.addPrimitivesToMesh3D(a,r,e)},pe.prototype.addPrimitivesToMesh3D=function(e,t,i){for(var r=[],a=0;a<e.length;a++)e[a]instanceof V.SGPrimitiveHelper&&r.push(e[a]);if(!r.length)return!1;var n={},o=[];for(a=0;a<r.length;a++){var s=r[a].getGroup(),l=s.geometry;if(l){var d=n[l.id];if(d)d.hasFace=d.hasFace||4===s.glType;else{var c={geometry:l,hasFace:4===s.glType};o.push(c),n[l.id]=c}}}this.nodesToOptimize[t.id]=t;for(var h=t._occurrences[0].renderable,u=[],g=0;g<o.length;g++){var p=!0,f=o[g].geometry;for(a=0;a<h.geometry.length;a++)if(f===h.geometry[a]){p=!1;break}p&&u.push(o[g])}var v=3===t._bodyDim;for(a=0;a<u.length;a++)u[a].hasFace&&ce(u[a].geometry,v);if(u.length)for(var m=0;m<t._occurrences.length;m++){(h=t._occurrences[m].renderable).initLayers(1);for(g=0;g<u.length;g++)h.addGeometry(u[g].geometry,!!i),h._initLayersForGeometry(0,u[g].geometry);i&&(t.bSphere.copy(h.geometry.boundingSphere),t.bBox.copy(h.geometry.boundingBox))}return!0},pe.prototype.addExistingCell=function(e,t){if(!e)return!1;if(!t)return!1;if(e instanceof v&&t instanceof v)return e.addChild(t),!1;if(!(e instanceof m&&t instanceof V.SGPrimitiveHelper))return!1;var i=t.getGroup().geometry;if(!i)return!1;this.nodesToOptimize[e.id]=e;for(var r=e._occurrences[0].renderable,a=!0,n=0;n<r.geometry.length;n++)if(i===r.geometry[n]){a=!1;break}if(t.getGroup()&&4===t.getGroup().glType){var o=3===e._bodyDim;ce(i,o)}if(a)for(var s=0;s<e._occurrences.length;s++)(r=e._occurrences[s].renderable).initLayers(1),r.addGeometry(i),r._initLayersForGeometry(0,i);return!0},pe.prototype.removeExistingCells=function(e,t){if(!e)return!1;if("Mesh3D"!==e.getNodeType()){for(var i=0;i<t.length;i++)t[i]&&t[i]instanceof v&&e.removeChild(t[i]);return!1}var r=[];for(i=0;i<t.length;i++)t[i]instanceof V.SGPrimitiveHelper&&r.push(t[i]);if(!r.length)return!1;this.nodesToOptimize[e.id]=e;for(var a=0;a<e._occurrences.length;a++){var n=e._occurrences[a].renderable;n.initLayers(1),n.layer.addPrimitivesToLayers(r,0);for(var o=0;o<r.length;o++)n.removeSelectionGroup(r[o])}return!0},pe.prototype.removeExistingCell=function(e,t){if(!e)return!1;if(!t)return!1;if(e instanceof v&&t instanceof v)return e.removeChild(t),!1;if(!(e instanceof m&&t instanceof V.SGPrimitiveHelper))return!1;this.nodesToOptimize[e.id]=e;for(var i=0;i<e._occurrences.length;i++){var r=e._occurrences[i].renderable;r.initLayers(1),r.layer.addPrimitivesToLayers([t],0),r.removeSelectionGroup(t)}return!0},pe.prototype.nodeFromFixedSizeData=function(e,t=null){const i=this.viewManager.viewer.currentViewpoint.getMMInSupportUnit(),r=.5*(e.getMinSize()+e.getMaxSize())*i,a=e.getInvariantPoint();return t?(t.setRatio&&t.setRatio(r),t.setInvariantPoint&&t.setInvariantPoint(a)):t=new S({ratio:r,invariantPoint:a}),t},pe.prototype.nodeFromBillboardData=function(e,t=null){const i=e.getType(),r=i===e.BillboardTypes.Cylindrical?"Cylindrical":(e.BillboardTypes.Spherical,"Spherical");return t?t.setBillboardType&&t.setBillboardType(r):t=new y({type:r,constraintAxis:new f.Vector3(0,1,0)}),t},pe.prototype.createNodeFromData2Dto3D=function(e){if(e.getStaticMode()){var t=e.getAttachPoint(),i=e.getSphericalMode(),r=new y({type:i?"Spherical":"cylindrical"});if(void 0!==t){var a=(new f.Matrix4).setPosition(t);r.applyMatrix(a)}return r}return new v},pe.prototype.apply2DTo3DData=function(e,t){var i=t.getAdvancedPriority(),r=t.getZDepthMode();i&&e.setAdvancedPriority(i),r&&e.setZDepthMode(r)},pe.prototype.setFilters=function(e,t){if(t){this.removeAllFilters(e);for(var n=0;n<t.length;n++){var p=t[n];if(p instanceof r){var m=p.getClippingPlane(),S=m.getFlags(),y=m.getSectionning(),T=m.getPoint(),_=m.getNormal();this.addClippingPlaneFilter(e,T,_,S,y)}else if(p instanceof i){var w=p.getRepViewMode();this.addViewModeFilter(e,w)}else if(p instanceof a)this.annotationFilters.push({filter:p,node:e});else if(p instanceof o){var I=p.getRadius(),C=p._origin,D=p.getDirectionX(),E=p.getDirectionY(),P=p.getCenter(),A=p.getBoundariesVisible(),b=p.getGas();this.addScissorFilter(e,I,P,C,D,E,A,b)}else if(p instanceof s){p.getLayers();var V=p.getMode();e.setLayerFilter(p._layers,V)}else if(p instanceof l){var O=new L,N=(p.getColorInheritance()&f.GASEnum.COLOR_INHERITANCE_ON)>0||!((p.getColorInheritance()&f.GASEnum.COLOR_INHERITANCE_OFF)>0)&&null,G=(p.getAsmInheritance()&f.GASEnum.ASMCOLOR_INHERITANCE_ON)>0||!((p.getColorInheritance()&f.GASEnum.COLOR_INHERITANCE_OFF)>0)&&null,R=p.getGas(),H=null;if(R){var F=new v;new M(R,this.clientManager).applyGP(this,F),H=F._gas}e.setVisuFilters({gasInheritFilter:O.usingColorInherit(H,N).usingASMColorInherit(H,G)})}else if(p instanceof d){var U=1,k=1;switch(V=p.getPolygonOffsetMode()){case ae:[U,k]=se;break;case ne:[U,k]=le;break;case oe:[U,k]=de;break;default:continue}e.setVisuFilters({polygonOffsetFilter:new B(k,U)})}else p instanceof c?this.addPolygonalScissorFilter(e,p):p instanceof h?this.addCurveClippingFilter(e,p):p instanceof u?e.setVisuFilters({zModeFilter:new x(!!p.getZMode())}):p instanceof g&&(p._skipDrawFurtive?e.setVisuFilters({furtiveFilter:!0}):e.setVisuFilters({furtiveFilter:null}))}}},pe.prototype.removeAllFilters=function(e){e.setVisuFilters({gasInheritFilter:null,polygonOffsetFilter:null,zModeFilter:null,furtiveFilter:null}),this.viewManager.viewer._getCSIOverrideManager().deleteRepViewModeOverride(e),e.setClippingCylinder(null),e.setScissoringPolyLine(null),this.viewManager.viewer._setOutlineNode(e,!1,null),e.setClippingProfile(null);for(var t=0;t<e.children.length;t++){var i=e.children[t];if("__ScissorBoundary__"===i.name){e.removeChild(i);break}}var r=e.getOverrideSetManager();if(r){var a=r.getSceneGraphOverrideSetsByPrefix("__3DSyncFilters__");for(t=0;t<a.length;t++)r.removeSceneGraphOverrideSet(a[t])}},pe.prototype.setAnnotationFilters=function(){if(0!==this.annotationFilters.length)for(var e=0;e<this.annotationFilters.length;e++){var t=this.annotationFilters[e].filter,i=this.annotationFilters[e].node,r=t.getMode(),n=t.getAnnotationPaths();if(n)if(n.length>0)for(var o=0;o<n.length;o++){var s=n[o].getPaths(),l=n[o].getValue(),d=[],c=this;s.forEach(function(e){var t=c.truncatePath(e,i);void 0!==t?d.push(t):console.warn("[Annotation] A path is not valid")}),this.addAnnotationFilter(i,d,l,e,r)}else r!==a.Mode.ModeInvertInvisibilityAndNoPick&&r!==a.Mode.ModeInvertNoPick||this.addAnnotationFilter(i,[],null,e,r)}},pe.prototype.truncatePath=function(e,t){var i=!1,r=[t];if(void 0!==e&&(e.externalPath.forEach(function(e){i&&r.push(e),e===t&&(i=!0)}),1!==r.length))return e.externalPath=r,e},pe.prototype._createOverride=function(e,t,i,r){var n=e.createOverrideSetManager();if(n){var o=null;o=t?"__3DSyncFilters__annot"+i:"__3DSyncFilters__";var s=n.getSceneGraphOverrideSetByName(o);if(!s){var l=null;r&&(r===a.Mode.ModeNormal?l=F.normal:r===a.Mode.ModeForceShow?l=F.forceShow:r===a.Mode.ModeInvertInvisibilityAndNoPick?l=F.invert:r===a.Mode.ModeInvertNoPick&&(l=F.invertPick)),s=n.createSceneGraphOverrideSet({name:o,mode:l,asmInherit:!1,materialModeSensitive:!0}),n.pushSceneGraphOverrideSet(s)}if(t){for(var d=[],c=0;c<t.length;c++){var h=s.createOverride({pathes:[t[c]],depthPriority:!0});d.push(h)}return d}return s.createOverride({pathes:[new w([e])],depthPriority:!0})}},pe.prototype.addAnnotationFilter=function(e,t,i,r,o){var s=this._createOverride(e,t,r,o);if(i){if(i.isRGBOverloaded()){var l=i.GetRGBA(),d=i.getRGBInheritance()===n.InheritanceMode.ModeForceInherit,c=(new f.Color).setRGB(l.R/255,l.G/255,l.B/255);s.forEach(function(e){e.setColor(c,d)})}if(i.isAlphaOverloaded()){l=i.GetRGBA(),d=i.getAlphaInheritance()===n.InheritanceMode.ModeForceInherit;s.forEach(function(e){e.setOpacity(l.A/255,d)})}if(i.isInvisibilityOverloaded()){var h=!i.isInvisible();s.forEach(function(e){e.setVisibility(h)})}else o!==a.Mode.ModeForceShow&&o!==a.Mode.ModeInvertInvisibilityAndNoPick||s.forEach(function(e){e.setVisibility(!0)});if(i.isNoPickOverloaded()){var u=!i.isNotPickable();s.forEach(function(e){e.setPickability(u?"PICKABLE":"IGNORED")})}if(i.isUncutOverloaded()){i.isUncutEnabled(),d=i.getUncutInheritance()===n.InheritanceMode.ModeForceInherit;var g=new N;s.forEach(function(e){e.setClippingContext(g)})}if(i.isViewModeOverloaded()){d=i.getViewModeInheritance()===n.InheritanceMode.ModeForceInherit;var p=new G({combineRenderMode:"REPLACE",faceMode:null});p.setRenderMode("Face",i.isViewMeshEnabled()),p.setRenderMode("@Edge",i.isViewEdgeEnabled()),p.setRenderMode("WireEdge",!i.isViewWithoutWiresEnabled()),p.setRenderMode("AxisSystem",!i.isViewWithoutAxisEnabled());var v=!i.isViewWithoutPointsEnabled();p.setRenderMode("BoundaryPoint",v),p.setRenderMode("SharpPoint",v),p.setRenderMode("SmoothPoint",v),p.setRenderMode("Outline",!i.isViewWithoutOutlineEnabled()),s.forEach(function(e){e.setRenderStyle(p,d)})}if(i.isMaterialOverloaded()&&i.getMaterial()){var m=i.getMaterial(),S=m.getMaterialJSON()._json,y=m.getMaterialBuffers(),T=new I,_=[];Array.isArray(y)&&y.length>0&&y.forEach(function(e){_.push({buffer:e.getData()})}),T.load({json:S,zipped:!1,chunks:_,doneCallback:e=>{var t=e.materialApplications[0];s.forEach(function(e){e.setMaterial(t)})}})}}},pe.prototype.addViewModeFilter=function(e,t){var i=this.viewManager.viewer._getCSIOverrideManager();if(t){var r=i.getRepViewModeOverride(e),a=new G({combineRenderMode:"REPLACE",faceMode:null});a.setFaceMode("COLOR"),a.setMaterialMode(t&Y),a.setRenderMode("Face",t&X),a.setRenderMode("Outline",t&J),t&Z&&(a.setRenderMode("Face",!0),a.setRenderMode("Outline",!0),a.setFaceMode("BACKGROUND")),a.setRenderMode("@Edge",t&K),a.setRenderMode("InternalSmoothEdge",!(t&$)),a.setRenderMode("WireEdge",!(t&te));var n=!(t&ee);a.setRenderMode("BoundaryPoint",n),a.setRenderMode("SharpPoint",n),a.setRenderMode("SmoothPoint",n),a.setRenderMode("FreePoint",!(t&re));var o=t&Q;a.setHalfVisibleSmoothEdges(o?1:0);var s=t&q;a.setHiddenEdges(s?1:0);var l=!(t&ie);a.setRenderMode("AxisSystem",l),a.setRenderMode("InfiniteFace",l),r.setRenderStyle(a,!0)}else i.deleteRepViewModeOverride(e)},pe.prototype.addClippingPlaneFilter=function(e,t,i,r,a){for(var n=this._createOverride(e),o=[],s=0;s<t.length/3;s++){var l=new f.Plane;l.setFromNormalAndCoplanarPoint(new f.Vector3(i[3*s],i[3*s+1],i[3*s+2]),new f.Vector3(t[3*s],t[3*s+1],t[3*s+2])),o.push(l)}var d=new N;d.setPlanes(o);for(s=0;s<o.length;s++)d.setPlaneParams(o[s],{capping:!!(r[s]&fe.fCapping),sectionLines:!!a[s]});n.setClippingContext(d)},pe.prototype.addScissorFilter=function(e,t,i,r,a,n,o,s){var l=new f.Vector3(r.x,r.y,r.z);if(i&&(l.x+=i.x*a.x+i.y*n.x,l.y+=i.x*a.y+i.y*n.y,l.z+=i.x*a.z+i.y*n.z),e.setClippingCylinder({center:l,axisU:new f.Vector3(t*a.x,t*a.y,t*a.z),axisV:new f.Vector3(t*n.x,t*n.y,t*n.z),clipOutside:!0}),o){var d=_.createCircleNode({radius:t,segments:32,fill:!1});d.name="__ScissorBoundary__";var c=new f.Vector3(a.x,a.y,a.z),h=new f.Vector3(n.x,n.y,n.z);c.normalize(),h.normalize();var u=new f.Vector3;u.crossVectors(c,h);var g=(new f.Matrix4).makeBasis(c,h,u);g.setPosition(l),d.setMatrix(g),e.addChild(d),new M(s,this.clientManager).applyGP(this,d)}},pe.prototype.addPolygonalScissorFilter=function(e,t){var i,r=[],a=[],n=t.getNbVertex(),o=t.getVertices();for(i=0;i<n.length;i++)r.push(n[i]);for(i=0;i<o.length;i++)a.push(o[i]);e.setScissoringPolyLine({nbPolygon:t.getNbPolygon(),nbVertices:r,vertices:a,point:new f.Vector3(t.getPoint().x,t.getPoint().y,t.getPoint().z),dirX:new f.Vector3(t.getDirectionX().x,t.getDirectionX().y,t.getDirectionX().z),dirY:new f.Vector3(t.getDirectionY().x,t.getDirectionY().y,t.getDirectionY().z)});var s=null;if(t.getBoundariesVisible()){var l,d,c,h=t.getGas(),u=[],g=0,p=e.clippingContext._scissor.polyLines[0].points3D;for(l=0;l<t.getNbPolygon();l++){for(c=g,d=0;d<r[l]-1;d++)u.push(p[g]),u.push(p[g+1]),g++;u.push(p[g]),u.push(p[c])}var v=(s=_.createLineNode({points:u})).createOverrideSetManager(),m=v.createSceneGraphOverrideSet();v.pushSceneGraphOverrideSet(m);var S=m.createOverride(new w([s])),y=new N([]);y.setUncut(!0),S.setClippingContext(y),s.setNoZ(!0),s.name="outlineNode",new M(h,this.clientManager).applyGP(this,s)}this.viewManager.viewer._setOutlineNode(e,t.getBoundariesVisible(),s)},pe.prototype.addCurveClippingFilter=function(e,t){e.setClippingProfile({csiParams:{curveCount:t.getCurveCount(),vertexCounts:t.getVertexCounts(),vertices:t.getVertices(),normals:t.getNormals(),transform:t.getTransformFromVertices()}})};var fe={fCapping:1,fHiddenElements:4,fPriority:8,fNonZParticipants:16,fFurtive:32,fUncutting:64,fDefault:0};return pe}),define("DS/WebVisuParameters/WebVisuSceneGraphUpdater",["DS/CSIViewModelWebInterfaces/CSIVMClientDelegateInterface","DS/CSIViewModelWebInterfaces/CSIVMClientTreeKey","DS/WebVisuParameters/WebVisuUpdateTransaction","DS/WebVisuParameters/WebVisuUpdateTransactionHighlight","DS/Visualization/ViewManager","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/SubElement","DS/Visualization/CGRNode","DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionHSO","DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionPSO"],function(e,t,i,r,a,n,o,s,l,d,c,h,u){"use strict";var g=function(e){this.viewManager=new a(e)};return(g.prototype=Object.create(e.prototype)).createTransaction=function(e){if(e.getViewType()!=t.prototype.ViewType.View3D)return console.warn("Unsupported view type"),new i(this.viewManager,e,this.getManager&&this.getManager());switch(e.getView3DType()){case t.prototype.View3DType.View3D_Highlight:return new r(this.viewManager,e,this.getManager&&this.getManager(),!1,h);case t.prototype.View3DType.View3D_MultiColorHighlight:return new r(this.viewManager,e,this.getManager&&this.getManager(),!0,h);case t.prototype.View3DType.View3D_PreHighlight:return new r(this.viewManager,e,this.getManager&&this.getManager(),!1,u);default:return new i(this.viewManager,e,this.getManager&&this.getManager())}},g.prototype.createPathElement=function(e){if(!e||!e.length)return null;var t=e[0];if(!(t instanceof o))return null;var i=t,r=!1,a=i instanceof THREEDS.Nodes.CGRNode,c=a?i:void 0;if(i.parents.length>1){for(var h=0;h<i.parents.length;h++)if(!i.parents[h].notAllowedInPathElement)return null;r=!0}var u,g=[i],p=[];if(!r)for(var f=i.parents[0];f&&!(i=f).notAllowedInPathElement;){if(g.unshift(i),i.parents.length>1){for(h=0;h<i.parents.length;h++)if(!i.parents[h].notAllowedInPathElement)return null;break}f=i.parents[0]}var v=null;for(u=1;u<e.length&&((i=e[u])instanceof THREEDS.Nodes.CGRNode&&(a=!0,c=i),i instanceof o);u++)g.push(i),i instanceof s&&(v=i._occurrences[0].renderable);for(var m=u;m<e.length;m++){var S=e[m];if(S instanceof n.SGPrimitiveHelper){var y=S;if(v){var T=v.getSelectionGroup(S);T&&(y=T)}p.push(d.getFromSGNode(y))}else a&&(S instanceof n.SGBag||S instanceof n.SGRep)&&p.push(d.getFromSGNode(S))}if(a&&p.length>0){var _=p[p.length-1].sgNode,w=!1;if(_ instanceof n.SGRep&&(w=!0),_ instanceof n.SGBag){var I=_.children;1===I.length&&I[0]instanceof n.SGRep&&(_=I[0],w=!0)}if(w){var C=function e(t,i){var r,a=t.persistentId;if(a&&a===i&&(r=[t]),!r)for(var n=t.children,o=0;o<n.length;o++){var s=e(n[o],i);if(s){(r=s).unshift(t);break}}return r}(c.children[1]instanceof o?c.children[1]:c.children[0],_.modelIdentification.getLocalId());C&&(g=g.concat(C))}}var D=new l;return D.setFromArray(g,p),D},g.prototype.createIdentifiedObjectsArray=function(e){if(!e)return null;for(var t=[],i=0;i<e.externalPath.length;i++){var r=e.externalPath[i];r&&r.getIdentificationObject()&&t.push(r)}for(i=0;i<e.internalPath.length;i++){var a=e.internalPath[i];a&&a.sgNode&&a.sgNode.getIdentificationObject()&&t.push(a.sgNode)}return t},g});