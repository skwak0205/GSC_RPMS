define("DS/MPFModalConfiguratorComponent/OrderPaymentMethodSection",["UWA/Core","DS/MPFOrderComponent/OrderConfirmationSection","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Select","DS/MPFView/FieldTextInputV2","DS/MPFPaymentCardTokenModel/PaymentCardTokenCollection","DS/MPFBuyer/BuyerType","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFPspModel/PspModel","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFUrl/UrlUtils","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Category","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],(e,t,s,r,n,o,i,a,c,d,h,l,u,p,m,y,C)=>{"use strict";const P={},g={};P.VALID="validSection",P.INVALID="invalidSection",P.NEW_HEIGHT="new-height",P.ON_CHANGE_METHOD_ERROR="onChangeMethodError",g.CB="CB",g.BANK_TRANSFER="bankTransfer",g.COUPON="coupon";const f=t.extend({setup(e){e||(e={}),h.requiredOfPrototype(e.tokenCards,o,"options.tokenCards must be a PaymentCardTokenCollection"),h.requiredOfPrototype(e.cart,a,"options.cart must be a CartModel"),h.requiredOfPrototype(e.cartPsp,d,"options.cartPsp must be a PspModel"),h.requiredOfPrototype(e.buyerType,i,"options.buyerType must be a BuyerType"),this.buyerType=e.buyerType,this.cart=e.cart,this.cartPsp=e.cartPsp,this.service=e.service,this.tokenCards=e.tokenCards,this.bankTransferActive=e.bankTransferActive,this._parent(e),this._initCBOption(),this._initBankTransfertOption(),this.listenTo(this.cartPsp,"onSync",this._updateAvailableTokens.bind(this))},render(){return this._fillBody(),this._parent(),this._displayBTOption(),this.updatePaymentCoupon(),0===this.cart.getGrossAmountTotal()&&this.container.hide(),this},updatePaymentCoupon(){const e=this.service===l.CLICK_AND_BUY,t=this.cart.has(a.Fields.COUPON),s=this.bankTransfToggle&&this.bankTransfToggle.isChecked();if(e)if(t){if(s)return this.cbToggle.setCheck(!0),this._cbOptionSelected().then(()=>{this.bankTransfToggle&&this.bankTransfToggle.hide()});this.bankTransfToggle&&this.bankTransfToggle.hide()}else this.bankTransfToggle&&this.bankTransfToggle.show()},destroy(){this.stopListening(this.purchaseOrderField),this.stopListening(this.expenseFinancialLineField),this.purchaseOrderField&&this.purchaseOrderField.destroy(),this.expenseFinancialLineField&&this.expenseFinancialLineField.destroy(),this.buyerType=null,this.cart=null,this.cartPsp=null,this.service=null,this.tokenCards=null,this._parent()},_fillBody(){const t=e.createElement("div",{class:"mpf-payment-cb",html:this.buyerType===i.INDIVIDUAL?[this.cbToggle,this.selectCB,this.saveCB]:[this.cbToggle,this.selectCB,this.saveCB,this.purchaseOrderField.render(),this.expenseFinancialLineField.render()]}),s=e.createElement("div",{class:"mpf-payment-bank-transfer",html:this.bankTransfToggle});this.body=e.createElement("div",{class:"mpf-payment-method mpf-horizontal",html:[t,s]})},getPaymentMethod(){const e={};if(this.container.isHidden())e.method=g.COUPON;else if(this.cbToggle.isChecked())if(e.method=g.CB,e.value=this.selectCB.getValue()[0],"addCB"===e.value)e.CreditCardTokenMultiUse=this.saveCB.isChecked()?"1":"0";else{const t=this.tokenCards.filter(e=>this.selectCB.getValue()[0]===e.getCardId()).shift();e.CreditCardToken=t}else e.method=g.BANK_TRANSFER;return e},_initCBOption(){const e=this;let t="addCB";const o=this._getCBTokens(),i=this.cart.getPaymentMethod();o.length>0&&(t=o[o.length-1].value),this.cbToggle=new s({value:C.get("cbChoiceLabel"),className:"primary cb",checked:!i||i===a.PaymentMethods.BANK_CARD,events:{onChange:function(){this.isChecked()&&e._cbOptionSelected()}}}),this.saveCB=this._createSaveCbToggle(),this.selectCB=new r({placeholder:C.get("selectCB"),value:t,options:o,disabled:!this.cbToggle.isChecked(),events:{onChange:function(){const t="addCB"===this.getValue()[0];e.dispatchEvent(P.NEW_HEIGHT),e._displayCheckboxSaveCB(t),e._sendTrackerEvent(t?"AddNewCreditCardChosen":"CreditCardSelected"),""!==this.getValue()[0]?e.dispatchEvent(P.VALID):e.dispatchEvent(P.INVALID)},onClick:function(){e.dispatchEvent(P.NEW_HEIGHT,parseInt(this.elements.dropdown.getStyle("height")))}}}),this.purchaseOrderField=this._createBankCardPurchaseOrderField(),this.listenTo(this.purchaseOrderField,n.Events.UPDATE,this._sendTrackerEvent.bind(this,"YourReferenceToMentionOnInvoiceFilled")),this.expenseFinancialLineField=this._createBankCardExpenseFinancialLineField(),this.listenTo(this.expenseFinancialLineField,n.Events.UPDATE,this._sendTrackerEvent.bind(this,"ExpenseFinancialLineFilled")),this._updateBankCardAdditionnalFieldsVisibility(),this._displayCheckboxSaveCB(this.cbToggle.isChecked()&&"addCB"===this.selectCB.getValue()[0])},_createSaveCbToggle(){const e=this;return new s({type:"checkbox",name:"save-CB",value:C.get("saveCB"),className:"primary cb-save",checked:!0,events:{onClick:function(){e._sendTrackerEvent("SaveCardInformationClicked",this.isChecked()?"on":"off")}}})},_createBankCardPurchaseOrderField(){return new n({model:this.cart,fieldName:a.Fields.PURCHASE_ORDER_NUMBER,fieldLabel:C.get("referenceMention"),dynamicValidation:!0,maxlength:30})},_createBankCardExpenseFinancialLineField(){return new n({model:this.cart,fieldName:a.Fields.EXPENSE_FINANCIAL_LINE,fieldLabel:C.get("expenseFinancialLine"),dynamicValidation:!0})},_updateBankCardAdditionnalFieldsVisibility(){this.cbToggle.isChecked()?(this.purchaseOrderField.show(),this.expenseFinancialLineField.show()):(this.purchaseOrderField.hide(),this.expenseFinancialLineField.hide())},_cbOptionSelected(){return e.is(this.bankTransfToggle)&&this.bankTransfToggle.setCheck(!1),this.selectCB.enable(),this._updateBankCardAdditionnalFieldsVisibility(),this._displayCheckboxSaveCB("addCB"===this.selectCB.getValue()[0]),this.dispatchEvent(P.INVALID),this._setPaymentMethodOnCart(a.PaymentMethods.BANK_CARD).then(()=>{const e=""!==this.selectCB.getValue()[0]?P.VALID:P.INVALID;this.dispatchEvent(e)}).catch(this.dispatchEvent.bind(this,P.ON_CHANGE_METHOD_ERROR))},_updateAvailableTokens(){const e=this._getCBTokens();this.selectCB.remove(),this.selectCB.add(e),this.selectCB.setValue(e[e.length-1].value)},_getCBTokens(){const e=this.cartPsp.getPsp(),t=this.cartPsp.getCountryPlatform(),s=e===d.Psp.HIPAY,r=e===d.Psp.STRIPE,n=this.tokenCards.filter(n=>{const o=n.getPsp()===e,i=n.getPlatform()===t;return o&&(s||r&&i)}).map(e=>({value:e.getCardId(),label:"xxxx-xxxx-xxxx-"+e.getCardNumber()+", "+e.getCardExpMonth()+"/"+e.getCardExpYear()}));return n.unshift({value:"addCB",label:C.get("createCB")}),n},_initBankTransfertOption(){const e=this,t=this.buyerType===i.INDIVIDUAL,r=u.from(window.location.href).isEmp(),n=t&&!r,o=this.service===l.IFWELOOP,c=-1!==window.location.href.indexOf("BankTransfer");if(this.bankTransferActive&&!this.cart.isDirectPurchase()&&!n||o||c){const t=this.cartPsp.getPsp()===d.Psp.STRIPE&&this.cartPsp.getCountryPlatform()===d.Platform.STRIPE_US,r=this.service===l.IFWELOOP||this.service===l.CLICK_AND_BUY?C.get("deferredPaymentInvoice"):t?C.get("btChoiceACHLabel"):C.get("btChoiceLabel");this.bankTransfToggle=new s({value:r,className:"primary bank",checked:this.cart.getPaymentMethod()===a.PaymentMethods.DEFERRED_BANK_TRANSFER,events:{onChange:function(){this.isChecked()&&e._bankTransferOptionSelected()}}})}},_bankTransferOptionSelected(){return this.cbToggle.setCheck(!1),this.selectCB.disable(),this._updateBankCardAdditionnalFieldsVisibility(),this._displayCheckboxSaveCB(!1),this.dispatchEvent(P.INVALID),this._setPaymentMethodOnCart(a.PaymentMethods.DEFERRED_BANK_TRANSFER).then(this.dispatchEvent.bind(this,P.VALID)).catch(t=>{const s=e.is(t.response)?t.response:{};this.dispatchEvent(P.ON_CHANGE_METHOD_ERROR,s),e.is(s.errorCode)&&"Error.BankTransferNotAllowed"===s.errorCode&&(this.cbToggle.setCheck(!0),this.bankTransfToggle.setCheck(!1),this.bankTransfToggle.setDisabled(),this._cbOptionSelected())})},_displayBTOption(){if(e.is(this.bankTransfToggle))if(-1!==this.cartPsp.getPaymentMethod().indexOf(d.PaymentMethod.BANK_TRANSFER)||this.service===l.IFWELOOP){const e=this.cartPsp.getPsp()===d.Psp.STRIPE&&this.cartPsp.getCountryPlatform()===d.Platform.STRIPE_US,t=this.service===l.IFWELOOP||this.service===l.CLICK_AND_BUY?C.get("deferredPaymentInvoice"):e?C.get("btChoiceACHLabel"):C.get("btChoiceLabel");this.bankTransfToggle.setValue(t),this.bankTransfToggle.show()}else this.bankTransfToggle.hide()},_displayCheckboxSaveCB(e){e?this.saveCB.show():this.saveCB.hide()},hide(){this.container.hide(),this.dispatchEvent(P.VALID)},show(){this.container.show(),this.dispatchEvent(this.isValid()?P.VALID:P.INVALID)},isValid(){return!!this.container.isHidden()||(e.is(this.bankTransfToggle)?this.bankTransfToggle.isChecked()?this.cart.getPaymentMethod()===a.PaymentMethods.DEFERRED_BANK_TRANSFER:this.cbToggle.isChecked()?""!==this.selectCB.getValue()[0]&&this.cart.getPaymentMethod()===a.PaymentMethods.BANK_CARD:void 0:this.cbToggle.isChecked()&&""!==this.selectCB.getValue()[0]&&this.cart.getPaymentMethod()===a.PaymentMethods.BANK_CARD)},_setPaymentMethodOnCart(e){const t={[a.Fields.PAYMENT_METHOD]:e};return this.cart.savePromise(t,{patch:!0})},_sendTrackerEvent(e,t){const s=p.createEventBuilder({category:y.CHECKOUT,action:e});c.addTrackerInformation(s,this.cart),t&&s.setLabel(t),s.addDimension(m.MARKETPLACE_SERVICE,this.service).send()}});return f.Events=Object.freeze(P),f.PaymentMethod=Object.freeze(g),f}),define("DS/MPFModalConfiguratorComponent/ConfirmMakeBankTransferPage",["UWA/Core","UWA/Promise","UWA/Class/View","DS/PlatformAPI/PlatformAPI","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Button","DS/UIKIT/Alert","DS/UIKIT/Mask","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFPurchaseOrderComponent/PurchaseOrderUploadForm","DS/MPFPurchaseOrderModel/PurchaseOrderModel","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],function(e,t,s,r,n,o,i,a,c,d,h,l,u,p,m,y,C,P){"use strict";var g={CONFIRM_BANK_TRANSFER:"confirmBankTransfer",UPLOAD_PURCHASE_ORDER:"uploadPurchaseOrder"};return s.extend({className:"mpf-confirm-bank-transfer-make",setup:function(e){e||(e={}),c.requiredOfPrototype(e.cart,m,"options.cart must be a CartModel"),c.requiredOfPrototype(e.purchaseOrderDocument,p,"options.purchaseOrderDocument must be a PurchaseOrderDocumentModel"),c.requiredOfPrototype(this.model,u,"this.model must be a PurchaseOrderModel"),this.service=e.service||d.MAKE,this.purchaseOrderDocument=e.purchaseOrderDocument,this.cart=e.cart,this.stateMachine=this._createStateMachine(),this.confirmDeferredPaymentMessage=this._createConfirmDeferredPaymentMessage(),this.learnMoreLink=this._createLearnMoreLink(e.linkToBankTransferFAQ),this.uploadPurchaseOrderButton=this._createUploadPurchaseOrderButton(),this.uploadLaterButton=this._createUploadLaterButton(),this.purchaseOrderUploadForm=new l({service:this.service,model:this.model,purchaseOrderDocument:this.purchaseOrderDocument,cart:this.cart}),this.listenTo(this.purchaseOrderUploadForm,"purchaseOrderUploaded",this._onPurchaseOrderUploaded.bind(this))},render:function(){var e;return this.stateMachine.getState()===g.UPLOAD_PURCHASE_ORDER?this.container.setContent([this.purchaseOrderUploadForm.render()]):(e=[this.confirmDeferredPaymentMessage,this.learnMoreLink,this.uploadPurchaseOrderButton,this.uploadLaterButton],this.container.setContent(e)),this},save:function(){var e;return this.stateMachine.getState()===g.UPLOAD_PURCHASE_ORDER&&(e=this.purchaseOrderUploadForm.save()),t.cast(e)},_createConfirmDeferredPaymentMessage:function(){return e.createElement("p",{text:P.get("confirmDeferredPaymentMessage")})},_createLearnMoreLink:function(t){var s,r;return(r=e.is(t)?t:"/faq/proceed-to-deferred-payment").length>0&&(s=e.createElement("a",{href:r,text:P.get("learnMoreAboutDeferredPayment"),target:"_blank"})),s},_createUploadPurchaseOrderButton:function(){return new o({className:"primary mpf-uploadPurchaseOrderButton",value:P.get("uploadPurchaseOrder"),events:{onClick:this._onUploadPurchaseOrder.bind(this)}})},_onUploadPurchaseOrder:function(){this.stateMachine.changeState(g.UPLOAD_PURCHASE_ORDER),this.dispatchEvent("showSaveButton"),this.render()},_createUploadLaterButton:function(){return new o({className:"primary mpf-uploadLaterButton",value:P.get("uploadPurchaseOrderLater"),events:{onClick:this._onUploadPurchaseOrderLater.bind(this)}})},_onUploadPurchaseOrderLater:function(){var e=this;a.mask(this.container),this._updateCart().then(function(){e.dispatchEvent("endPurchaseOrderStep"),r.publish("MPCartTimeline",{event:"refresh",cartId:e.cart.id})}).catch(function(t){new i({messageClassName:"error",closable:!0,visible:!0,messages:P.get("error")}).inject(e.container,"top")}).finally(function(t){a.unmask(e.container)})},_updateCart:function(){var e={};return e[m.Fields.BLOCKED]="TRUE",this.cart.savePromise(e,{patch:!0,partialRefresh:!0})},_onPurchaseOrderUploaded:function(){this.dispatchEvent("endPurchaseOrderStep")},_createStateMachine:function(){return new h({state:g.CONFIRM_BANK_TRANSFER,states:[g.CONFIRM_BANK_TRANSFER,g.UPLOAD_PURCHASE_ORDER],transitions:[{from:g.CONFIRM_BANK_TRANSFER,to:g.UPLOAD_PURCHASE_ORDER}]})}})}),define("DS/MPFModalConfiguratorComponent/SalesConditionsBuyerPaymentSection",["UWA/Core","UWA/Class/View","UWA/Class/Promise","DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFShopModel/ShopModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFTCContractModel/TCContractModel","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFTcContractComponent/SalesConditionsBuyerPayment","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Category","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,n,o,i,a,c,d,h,l,u,p,m,y){"use strict";const C=Object.freeze({VALID_SECTION:"validSection",INVALID_SECTION:"invalidSection"}),P=t.extend({setup:function(e){e||(e={}),this._checkPrototypes(e),this._parent(e),this.service=e.serviceRequest,this.buyer=e.buyer,this.shopModel=e.shopModel,this.tcDocumentFactory=e.tcDocumentFactory,this.tcContractFactory=e.tcContractFactory,this.cart=e.cart,this.whenReady=this._findContract()},render:function(){const t=this;return this.dispatchEvent(C.INVALID_SECTION),this.whenReady.then(function(){e.is(t.tcContract)&&t.tcContract.getCurrentState()===c.STATUS.draft?(t.checkbox=new l({shopModel:t.shopModel,tcDocumentFactory:t.tcDocumentFactory,tcContract:t.tcContract}),t._initListeners(),t.container.setContent(t.checkbox.render()),t.dispatchEvent(t.isChecked()?C.VALID_SECTION:C.INVALID_SECTION)):t.dispatchEvent(C.VALID_SECTION)}).catch(function(){new r({className:"error",messageClassName:"error",messages:y.get("errorTC"),visible:!0,attributes:{style:"height: 60px"}}).inject(t.container)}),this},isChecked:function(){return!e.is(this.checkbox)||this.checkbox.isChecked()},save:function(){return e.is(this.checkbox)?this.checkbox.signContract():s.resolve()},_initListeners:function(){this.listenTo(this.checkbox,l.Events.CHECKED,function(){this._sendTrackingEvent("SalesConditionsClicked",{label:"on",service:this.service}),this.dispatchEvent(C.VALID_SECTION)}),this.listenTo(this.checkbox,l.Events.UNCHECKED,function(){this._sendTrackingEvent("SalesConditionsClicked",{label:"off",service:this.service}),this.dispatchEvent(C.INVALID_SECTION)})},_sendTrackingEvent:function(e,t){const s=u.createEventBuilder({category:m.CHECKOUT,action:e}).setLabel(t.label);a.addTrackerInformation(s,this.cart),s.addDimension(p.MARKETPLACE_SERVICE,t.service).send()},_findContract:function(){return this._findSpecificTcContract()},_findSpecificTcContract:function(){const e=this,t=e.tcContractFactory.createModel(h.Types.CUSTOM_TC_SELLER);return t.setParentResourceId(this.cart.get("id")),t.fetchPromise().then(function(){return t.isNew()?e._findInConsumedContracts():(e.tcContract=t,s.resolve())})},_findInConsumedContracts:function(){const t=this,r=this.tcContractFactory.createCollection(h.Types.CONSUMED_CONTRACTS);return r.fetchPromise().then(function(){const n=t.shopModel.get("owner").match(/[A-Z0-9]{32}$/)[0];return e.is(r)&&(t.tcContract=r.filter(function(e){return e.getConsumerID()===t.buyer.get("id")&&e.getDocumentType()===c.DOCUMENT_TYPES.DEFAULT_SALES_CONDITIONS&&e.getSupplierID()===n&&e.getCurrentState()!==c.STATUS.archived&&e.getSigningRevision()===e.getActiveRevision()}).shift()),e.is(t.tcContract)?(t.tcContract.dataProxy=t.tcContractFactory.getDataProxy(h.Types.CONTRACTS),s.resolve()):t._createContract(n)})},_createContract:function(t){const r=this.shopModel.getService(this.service)["contract-documents"];return e.is(r)?0===r.length?s.resolve():r.length>0?(this.tcContract=this.tcContractFactory.createModel(h.Types.EXISTING_DOCUMENT,{documentID:r[0].id,supplierID:t,consumerID:this.buyer.get("id"),currentState:c.STATUS.draft}),this.tcContract.savePromise()):void 0:s.reject()},_checkPrototypes:function(e){n.requiredOfPrototype(e.shopModel,o,"options.shopModel must be a ShopModel"),n.requiredOfPrototype(e.tcDocumentFactory,d,"options.tcDocumentFactory must be a TCDocumentFactory"),n.requiredOfPrototype(e.tcContractFactory,h,"options.tcContractFactory must be a TCContractFactory"),n.requiredOfPrototype(e.cart,i,"options.cart must be a CartModel")}});return P.Events=Object.freeze(C),P}),define("DS/MPFModalConfiguratorComponent/PaymentInformationSupportSection",["UWA/Core","DS/MPFView/MPFView","DS/UIKIT/Input/Button","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r){"use strict";return t.extend({className:"mpf-payment-info",setup:function(e){e||(e={}),this._parent(e)},render:function(){return this.container.setContent([e.createElement("div",{class:"mpf-infos",html:[e.createElement("div",{text:r.get("emailLink")}),e.createElement("a",{text:r.get("contactSupport"),href:"mailto:marketplace.make@3ds.com"})]}),e.createElement("div",{class:"mpf-infos",html:[e.createElement("div",{text:r.get("orderDeploy")}),e.createElement("div",{text:r.get("bankTransfer")})]})]),this}})}),define("DS/MPFModalConfiguratorComponent/CompanyInformationSection",["UWA/Core","UWA/Promise","UWA/Class/View","DS/UIKIT/Input/Toggle","DS/MPFServices/ObjectService","DS/MPFCompanyComponent/CompanyNameInput","DS/MPFCompanyComponent/CompanyTaxRegistrationIdInput","DS/MPFCompanyComponent/CompanyRegistrationIdInput","DS/MPFView/FieldSelectInputV2","DS/MPFCountryModel/CountryCollection","DS/MPFCompanyModel/CompanyModel","DS/MPFAddressModel/AddressCollection","DS/MPFServices/MarketplaceServices","DS/MPFUtils/MPFUtils","i18n!DS/MPFCompanyComponent/assets/nls/CompanyComponent"],function(e,t,s,r,n,o,i,a,c,d,h,l,u,p,m){"use strict";return s.extend({className:"mpf-form mpf-company-information mpf-horizontal",setup:function(e){e||(e={}),n.requiredOfPrototype(e.countryCollection,d,"options.countryCollection must be a CountryCollection"),n.requiredOfPrototype(this.model,h,"this.model must be a CompanyModel"),n.requiredOfPrototype(e.addresses,l,"options.addresses must be a AddressCollection"),this._parent(e),this.countryCollection=e.countryCollection,this.addresses=e.addresses,this.companyNameInput=this._createCompanyName(),this.countrySelect=this._createCountrySelect(),this.taxRegistrationInput=this._createTaxRegistrationID(),this.companyRegistrationInput=this._createCompanyRegistrationID()},render:function(){var e;return e=[this.companyNameInput.render(),this.countrySelect.render(),this.taxRegistrationInput.render(),this.companyRegistrationInput.render()],this.container.setContent(e),this},save:function(){var e={},s=null;return this.validate()?(this.model.isNew()||(s=this.model.getPendingChanges(),e.patch=!0),this.model.isNew()||0!==Object.keys(s).length?this.model.savePromise(s,e):t.resolve()):t.reject()},validate:function(){var e=this.companyNameInput.validate().isValid,t=this.countrySelect.validate().isValid,s=this.taxRegistrationInput.validate().isValid,r=this.companyRegistrationInput.validate().isValid;return e&&t&&s&&r},clearForm:function(){this.companyNameInput.resetValue(),this.countrySelect.resetValue(),this.taxRegistrationInput.resetValue(),this.companyRegistrationInput.resetValue()},_createCompanyName:function(){return new o({model:this.model,dynamicValidation:!0,readOnly:!this.model.isNew(),required:!0})},_createCountrySelect:function(){var e=this.model.has(h.Fields.COUNTRY)&&""!==this.model.getCountry();if(!e&&this.addresses.hasBillingAddresses()){var t=this.addresses.find(function(e){return e.isBillTo()}).getCountry();t&&this.model.setCountry(t)}return new c({model:this.model,required:!0,dynamicValidation:!0,silent:!1,fieldName:h.Fields.COUNTRY,fieldLabel:m.get("country"),readOnly:e,placeholder:m.get("selectCountry"),selectableOptions:this._getCountriesOptions()})},_createTaxRegistrationID:function(){var e=!1;return this.model.has(h.Fields.TAX_REGISTRATION_ID)&&""!==this.model.getTaxRegistrationId()&&(e=this.model.validTaxRegID(this.model.getTaxRegistrationId(),this.model.getCountry())),new i({model:this.model,readOnly:e,required:!0})},_createCompanyRegistrationID:function(){var e;return e=this.model.has(h.Fields.REGISTRATION_ID)&&""!==this.model.getRegistrationId(),new a({model:this.model,readOnly:e,required:!1})},_getCountriesOptions:function(){var e=this,t=[];return this.countryCollection.forEach(function(s){var r={value:s.getIso3(),label:s.getName()};r.selected=s.getIso3()===e.model.getCountry(),t.push(r)}),t},destroy:function(){this.model=null,this._parent(),this.container=null}})}),define("DS/MPFModalConfiguratorComponent/OrderInformationSection",["UWA/Core","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,n){"use strict";return t.extend({setup:function(e){e||(e={}),console.warn("The component DS/MPFModalConfiguratorComponent/OrderInformationSection is deprecated. Please use DS/MPFOrderComponent/OrderConfirmationSection directly."),s.requiredOfPrototype(this.model,r,"this.model must be a CartModel"),this._parent(e),this.locale=e.locale||"fr-FR"},render:function(){var t,s;return t=e.createElement("div",{class:"mpf-order-number",html:[e.createElement("span",{text:n.get("order")}),"&nbsp;","# "+this.model.getName()]}),s=e.createElement("div",{class:"mpf-order-total",html:[e.createElement("span",{text:n.get("amount")}),"&nbsp;",this.model.get("GrossAmountTotal").toLocaleString(this.locale,{style:"currency",currency:this.model.getCurrency(),currencyDisplay:"code"}).replace(this.model.getCurrency(),"").trim(),"&nbsp;",this.model.getCurrency()]}),Array.prototype.push.apply(this.body,[t,s]),this._parent(),this}})}),define("DS/MPFModalConfiguratorComponent/CouponSection",["UWA/Core","UWA/Promise","DS/UIKIT/Input/Text","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Value","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],(e,t,s,r,n,o,i,a,c,d,h,l,u,p)=>{"use strict";const m=Object.freeze({NO_COUPON:"noCoupon",COUPON_ADDED:"couponAdded"}),y=Object.freeze({HIDE_PAYMENT_METHOD_SECTION:"hidePaymentMethodSection",SHOW_PAYMENT_METHOD_SECTION:"showPaymentMethodSection",VALID:"valid",INVALID:"invalid",COUPON_ADDED:"couponAdded",COUPON_REMOVED:"couponRemoved"}),C=o.extend({className:"mpf-section mpf-coupon-section",setup(e={}){i.requiredOfPrototype(e.cart,a,"options.cart must be a CartModel"),this.service=e.service,this.cart=e.cart,this.locale=e.locale||"fr-FR",this._parent(e),this.stateMachine=this._createStateMachine(),this.couponInput=this._createInput(),this.iconContainer=this._createIconContainer(),this.button=this._createButton(),this.discountContainer=this._createDiscountContainer(),this.couponInfoContainer=this._createCouponInfoContainer(),this.totalPriceContainer=this._createTotalPriceContainer()},render(){return this.body=[e.createElement("div",{class:"mpf-top-coupon",html:[this._getLeftContainer(),this._getRightContainer()]}),e.createElement("div",{class:"mpf-bottom-coupon",html:[this.couponInfoContainer,this.totalPriceContainer]})],this._updatePaymentMethods(),this._parent(),this.dispatchEvent(this.isValid()?y.VALID:y.INVALID),this},isValid(){return this.stateMachine.getState()===m.NO_COUPON||this._isCouponValid()&&!this._hasCouponExpired()},_isCouponValid(){return!0===this.cart.getCoupon().validity.isValid},_hasCouponExpired(){const e=new Date;return new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds())>new Date(this.cart.getCoupon().endDate)},_getRightContainer(){return e.createElement("div",{class:"mpf-right-coupon",html:[this.iconContainer,this.button,this.discountContainer]})},_getLeftContainer(){const t=e.createElement("label",{html:[e.createElement("span",{text:p.get("couponCode")}),this.couponInput]});return e.createElement("div",{class:"mpf-left-coupon",html:t})},_saveCoupon(){const e={},s=this.stateMachine.getState(),r=this.cart.getCoupon();this.cart.unset(a.Fields.COUPON,{silent:!0});const n=s===m.NO_COUPON?this.couponInput.getValue():"";return e[a.Fields.COUPON]=n,this.cart.savePromise(e,{patch:!0}).catch(e=>(this.cart.set(a.Fields.COUPON,r,{silent:!0}),t.reject(e)))},_updateContainerComponents(){const e=this.stateMachine.getState();e===m.NO_COUPON&&(this.button.setValue(p.get("remove")),this.button.setIcon("trash"),this.iconContainer.removeClassName("fonticon-attention"),this.iconContainer.addClassName("fonticon-status-ok"),this.stateMachine.changeState(m.COUPON_ADDED),this.couponInput.disable()),e===m.COUPON_ADDED&&(this.button.setValue(p.get("add")),this.button.setIcon("plus"),this.iconContainer.removeClassName("fonticon-status-ok"),this.iconContainer.removeClassName("fonticon-attention"),this.stateMachine.changeState(m.NO_COUPON),this.couponInput.enable(),this.couponInput.setValue("")),this.discountContainer=this._createDiscountContainer(),this.couponInfoContainer=this._createCouponInfoContainer(),this.totalPriceContainer=this._createTotalPriceContainer(),this.render()},_updatePaymentMethods(){const e=this.stateMachine.getState()===m.COUPON_ADDED?y.COUPON_ADDED:y.COUPON_REMOVED;this.dispatchEvent(e);const t=this.cart.has(a.Fields.COUPON)&&0===parseFloat(this.cart.getCoupon().totalToPay)&&this.couponInput.getValue()===this.cart.getCoupon().tokenUsed?y.HIDE_PAYMENT_METHOD_SECTION:y.SHOW_PAYMENT_METHOD_SECTION;this.dispatchEvent(t)},_handleNewCoupon(){const e=this.container.getElement(".mpf-body");if(!(this.stateMachine.getState()===m.NO_COUPON&&""===this.couponInput.getValue())){n.mask(e);const t=this.stateMachine.getState()===m.NO_COUPON?y.COUPON_ADDED:y.COUPON_REMOVED,s=h.createEventBuilder({category:"Checkout",action:t}).addDimension(l.MARKETPLACE_SERVICE,this.service);return c.addTrackerInformation(s,this.cart),s.send(),this._saveCoupon().then(this._updateContainerComponents.bind(this)).catch(e=>{const t=e&&e.response;t&&t.errorMsg&&this._displayErrorMessage(t.errorMsg)}).finally(n.unmask.bind(n,e))}this._displayErrorMessage(p.get("enterCoupon"))},_displayErrorMessage(t){this.iconContainer.addClassName("fonticon-attention"),this.discountContainer.setContent(e.createElement("span",{class:"error-coupon",text:t}))},_createStateMachine(){return new d({state:this.cart.has(a.Fields.COUPON)?m.COUPON_ADDED:m.NO_COUPON,states:[m.COUPON_ADDED,m.NO_COUPON],transitions:[{from:m.COUPON_ADDED,to:m.NO_COUPON},{from:m.NO_COUPON,to:m.COUPON_ADDED}]})},_createCouponInfoContainer(){const t=[];if(this.stateMachine.getState()===m.COUPON_ADDED){const s=parseFloat(this.cart.getCoupon().campaignAmount),r=parseFloat(this.cart.getCoupon().amount),n=new Date(this.cart.getCoupon().endDate);t.push(e.createElement("div",{class:"mpf-coupon-info-campaign",text:p.get("commercialCampaign")+": "+this.cart.getCoupon().commercialName+", "+p.get("expiryDate")+": "+n.toLocaleDateString()})),this._hasCouponExpired()?t.push(e.createElement("div",{class:"mpf-coupon-info-value mpf-warning",text:p.get("expiredCoupon")})):this._isCouponValid()?s>r&&t.push(e.createElement("div",{class:"mpf-coupon-info-value",text:p.get("couponValueExceedsOrderValue")})):t.push(e.createElement("div",{class:"mpf-coupon-info-value mpf-warning",text:e.is(this.cart.getCoupon().validity.validation)?this.cart.getCoupon().validity.validation:p.get("invalidCoupon")}))}return e.createElement("div",{class:"mpf-coupon-info",html:t})},_createTotalPriceContainer(){let t;if(this.stateMachine.getState()===m.COUPON_ADDED&&this.isValid()){const s=this.cart.getCurrency(),r=parseFloat(this.cart.getCoupon().totalToPay).toLocaleString(this.locale,{style:"currency",currency:s,currencyDisplay:"code"}).replace(s,"").trim();t=[e.createElement("span",{class:"mpf-coupon-payment-label",text:p.get("totalToPay")}),e.createElement("span",{class:"mpf-coupon-payment-value",text:r+" "+s})]}return e.createElement("div",{class:"mpf-coupon-payment",html:t})},_createDiscountContainer(){const t=[];if(this.stateMachine.getState()===m.COUPON_ADDED){const s=this.cart.getCurrency(),r=this.cart.getCoupon().percentage;if(e.is(r)){const s=e.createElement("div",{text:p.get("percentageTotalOrder",{value:parseInt(r)})});t.push(s)}const n=parseFloat(this.cart.getCoupon().amount).toLocaleString(this.locale,{style:"currency",currency:s,currencyDisplay:"code"}).replace(s,"").trim(),o=e.createElement("div",{text:"- "+n+" "+s});t.push(o)}return e.createElement("div",{class:"mpf-coupon-discount",html:t})},_createIconContainer:()=>e.createElement("span",{class:"fonticon"}),_createButton(){const e=this.stateMachine.getState(),t=e===m.NO_COUPON?p.get("add"):p.get("remove"),s=e===m.NO_COUPON?"plus":"trash";return new r({value:t,icon:s,events:{onClick:this._handleNewCoupon.bind(this)}})},_createInput(){const e=this.stateMachine.getState()===m.COUPON_ADDED;return new s({placeholder:p.get("couponCode"),disabled:e,value:e?this.cart.getCoupon().tokenUsed:""})},destroy(){this.cart=null,this._parent(),this.container=null}});return C.Events=y,C}),define("DS/MPFModalConfiguratorComponent/BuyerCard",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,n,o,i){"use strict";var a={ON_SELECTED:"onSelected"};return t.extend({className:"mpf-buyer-card",domEvents:{click:"cardClicked"},setup:function(e){e||(e={}),this._checkPrototypes(e),this._parent(e),this.buyerType=e.buyerType,this.country=e.country},render:function(){return e.equals(this.buyerType,r.INDIVIDUAL)?this.container.setContent(this._renderPerson()):this.container.setContent(this._renderCompany()),this},_renderCompany:function(){var t,s,r,n;return t=this.model.getName(),n=e.is(this.country)?this.country:this.model.getCountry(),s=e.is(this.model.getTaxRegistrationId())?this.model.getTaxRegistrationId():"",r=e.is(this.model.getRegistrationId())?this.model.getRegistrationId():"",[this._getCompanyLine(i.get("company"),t),this._getCompanyLine(i.get("country"),n),this._getCompanyLine(i.get("taxRegistrationId"),s),this._getCompanyLine(i.get("companyRegistration"),r)]},_getCompanyLine:function(t,s){return e.createElement("div",{class:"mpf-buyer-line",html:[e.createElement("span",{text:t}),e.createElement("span",{text:s})]})},_renderPerson:function(){var t,s;return t=this.model.get("firstName"),s=this.model.get("lastName"),e.createElement("div",{class:"mpf-buyer-line",text:t+" "+s})},_checkPrototypes:function(t){if(!e.is(t.buyerType))throw new Error("options.buyerType is required");if(s.requiredOfPrototype(t.buyerType,r,"options.buyerType must be a BuyerType"),!Object.prototype.isPrototypeOf.call(o.prototype,this.model)&&!Object.prototype.isPrototypeOf.call(n.prototype,this.model))throw new Error("BuyerCard model must be a CompanyModel or a PersonModel")},destroy:function(){this.model=null,this._parent(),this.container=null},cardClicked:function(){this.dispatchEvent(a.ON_SELECTED,this.model)}})}),define("DS/MPFModalConfiguratorComponent/IfweloopBankTransferPage",["UWA/Class/View","UWA/Core","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFPurchaseOrderComponent/PurchaseOrderUploadForm","DS/MPFPurchaseOrderModel/PurchaseOrderModel","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentModel","DS/MPFCartModel/CartModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],function(e,t,s,r,n,o,i,a,c){"use strict";var d,h={},l={};return h.CONFIRM_BANK_TRANSFER="confirmBankTransfer",h.UPLOAD_PURCHASE_ORDER="uploadPurchaseOrder",l.END_PURCHARSE_ORDER_STEP="endPurchaseOrderStep",l.VALID="valid",(d=e.extend({className:"mpf-bank-transfer-ifweloop",setup:function(e){e||(e={}),s.requiredOfPrototype(e.cart,a,"options.cart must be a CartModel"),s.requiredOfPrototype(e.purchaseOrderDocument,i,"options.purchaseOrderDocument must be a PurchaseOrderDocumentModel"),s.requiredOfPrototype(this.model,o,"this.model must be a PurchaseOrderModel"),this.service=e.service||r.IFWELOOP,this.purchaseOrderDocument=e.purchaseOrderDocument,this.cart=e.cart,this.virtualIbans=e.virtualIbans,this.paymentInfoMessage=this._createPaymentInfoMessage(),this.accountInfo=this._createAccountInfoContainer(),this.purchaseOrderUploadForm=this._createPurchaseOrderUploadForm()},render:function(){var e;return e=[this.paymentInfoMessage,this.accountInfo,this.purchaseOrderUploadForm.render()],this.container.setContent(e),this.dispatchEvent(l.VALID),this},save:function(){return this.purchaseOrderUploadForm.save()},_onPurchaseOrderUploaded:function(){this.dispatchEvent(l.END_PURCHARSE_ORDER_STEP)},_createAccountInfoContainer:function(){var e,s,r;return e="3DS-EUR"===(r=(s=this.virtualIbans.first()).getExternalReference())||"3DS-GBP"===r?this._getEuropeanIbanInfo(s):"3DS-AUD"===r||"3DS-JPY"===r?this._getAustralianJapanIbanInfo(s):this._getAmericanIbanInfo(s),t.createElement("div",{class:"mpf-ifweloop-seller",html:e})},_getAustralianJapanIbanInfo:function(e){return[t.createElement("div",{class:"mpf-ifweloop-seller-info",text:"3DS-AUD"===e.getExternalReference()?c.get("accountOwner")+" : DS Australia Pty Ltd":c.get("accountOwner")+" : DS K.K."}),t.createElement("div",{class:"mpf-ifweloop-seller-info",text:c.get("accountNumber")+" : "+e.getAccountNumber()}),t.createElement("div",{class:"mpf-ifweloop-seller-info",text:c.get("swiftbic")+" : "+e.getBic()})]},_getAmericanIbanInfo:function(e){return[t.createElement("div",{class:"mpf-ifweloop-seller-info",text:c.get("accountOwner")+" : Dassault Systemes USA"}),t.createElement("div",{class:"mpf-ifweloop-seller-info",text:c.get("accountNumber")+" : "+e.getAccountNumber()}),t.createElement("div",{class:"mpf-ifweloop-seller-info",text:c.get("routingNumber")+" : "+e.getRoutingNumber()}),t.createElement("div",{class:"mpf-ifweloop-seller-info",text:c.get("swiftbic")+" : "+e.getBic()})]},_getEuropeanIbanInfo:function(e){return[t.createElement("div",{class:"mpf-ifweloop-seller-info",text:c.get("accountOwner")+" : 3DS Store Ltd"}),t.createElement("div",{class:"mpf-ifweloop-seller-info",text:c.get("iban")+" : "+e.getIban()}),t.createElement("div",{class:"mpf-ifweloop-seller-info",text:c.get("swiftbic")+" : "+e.getBic()})]},_createPurchaseOrderUploadForm:function(){var e;return e=new n({service:this.service,model:this.model,purchaseOrderDocument:this.purchaseOrderDocument,cart:this.cart}),this.listenTo(e,n.Events.PURCHASE_ORDER_UPLOADED,this._onPurchaseOrderUploaded.bind(this)),e},_createPaymentInfoMessage:function(){return t.createElement("p",{text:c.get("infoPaymentBankTransferIfweloop")})}})).Events=Object.freeze(l),d}),define("DS/MPFModalConfiguratorComponent/OrderAgreementsSection",["UWA/Core","UWA/Class/View","UWA/String","UWA/Promise","UWA/Utils/Client","DS/MPFServices/MarketplaceServices","DS/MPFServices/ObjectService","DS/UIKIT/Input/Toggle","DS/UIKIT/Alert","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemCollection","DS/MPFTCContractModel/TCContractModel","DS/MPFTCContractModel/TCContractFactory","DS/MPFTCContractModel/SoftwareAgreementModel","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,n,o,i,a,c,d,h,l,u,p,m,y,C){"use strict";var P={ON_RENDER:"onRender",VALID_SECTION:"validSection",INVALID_SECTION:"invalidSection"},g=t.extend({className:"mpf-agreements-order",setup:function(e){e||(e={}),this._parent(e),this._checkPrototypes(e),this.service=e.service||o.IFWELOOP,this.cart=e.cart,this.cartItems=e.cartItems,this.buyer=e.buyer,this.tcContractFactory=e.tcContractFactory,this.softwareAgreement=e.softwareAgreement,this.checkbox=this._createToggle()},render:function(){var e=this;return this._getDocuments().then(function(){e.container.setContent([e.checkbox,e._getLabel()]),e.dispatchEvent(P.ON_RENDER)}).catch(this._displayAlert.bind(this)),this},save:function(){return this._saveClosaContract()},isChecked:function(){return this.checkbox.isChecked()},_saveClosaContract:function(){return this.tcContractFactory.createModel(u.Types.EXISTING_DOCUMENT,{documentID:this.softwareAgreement.get("id"),currentState:l.STATUS.inEffect,consumerID:this.buyer.get("id"),cartItemID:this.cartItems.first().get("id")}).savePromise()},_getDocuments:function(){return this._fetchClosa()},_getLabel:function(){var t;return t=this.service===o.CLICK_AND_BUY?this._getClickAndBuyLabel():this._getIfweloopLabel(),e.createElement("div",{class:"mpf-switch-label",html:t})},_getClickAndBuyLabel:function(){return C.get("agreementsClickAndBuy",{closa:this._getClosaLink().outerHTML})},_getIfweloopLabel:function(){return C.get("agreementsIfweloop",{closa:this._getClosaLink().outerHTML})},_getClosaLink:function(){return e.createElement("a",{target:"_blank",href:this.softwareAgreement.getUrl(),text:C.get("onlineAgreements")})},_fetchClosa:function(){return this.softwareAgreement.fetchPromise({cartId:this.cart.get("id")})},_displayAlert:function(){new c({className:"error",messages:{className:"error",message:C.get("errorLoadingTC")},icon:!0,closable:!0,visible:!0}).inject(this.container.getElement(".mpf-body"),"top")},_createToggle:function(){var e=this;return new a({type:"switch",className:"primary",value:"",events:{onChange:function(){this.isChecked()?e.dispatchEvent(P.VALID_SECTION):e.dispatchEvent(P.INVALID_SECTION)}}})},_checkPrototypes:function(e){if(i.requiredOfPrototype(e.cart,d,"options.cart must be a CartModel"),i.requiredOfPrototype(e.cartItems,h,"options.cartItems must be a CartItemCollection"),i.requiredOfPrototype(e.tcContractFactory,u,"options.tcContractFactory must be a TCContractFactory"),i.requiredOfPrototype(e.softwareAgreement,p,"options.softwareAgreement must be a SoftwareAgreementModel"),!y.prototype.isPrototypeOf(e.buyer)&&!m.prototype.isPrototypeOf(e.buyer))throw new Error("OrderAgreementsSection options.buyer must be a CompanyModel or a PersonModel")}});return g.Events=Object.freeze(P),g}),define("DS/MPFModalConfiguratorComponent/BankAccountInformationSection",["UWA/Core","DS/MPFServices/ObjectService","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFVirtualIbanModel/VirtualIbanModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,n){"use strict";return s.extend({setup:function(e){e||(e={}),this._parent(e),t.requiredOfPrototype(e.virtualIban,r,"options.virtualIban must be a VirtualIbanModel"),this.virtualIban=e.virtualIban},render:function(){return this.body.push(e.createElement("div",{class:"mpf-iban",text:n.get("iban")+" "+this.virtualIban.get("Iban")}),e.createElement("div",{class:"mpf-bic",text:n.get("bic")+" "+this.virtualIban.get("Bic")})),this._parent(),this}})}),define("DS/MPFModalConfiguratorComponent/RecapCBTokenSection",["UWA/Core","UWA/Class/Listener","DS/MPFServices/ObjectService","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFPaymentCardTokenModel/PaymentCardTokenModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,n,o){"use strict";return r.extend({setup:function(e){console.warn("The component DS/MPFModalConfiguratorComponent/RecapCBTokenSection is deprecated since 4.4. Please use DS/MPFOrderComponent/OrderConfirmationSection directly."),s.requiredOfPrototype(e.token,n,"options.token must be a PaymentCardTokenModel"),this._parent(e),this.token=e.token},render:function(){return this.body=[{tag:"table",html:[this._createRow("mpf-cc-owner",o.get("ccOwner"),this.token.getCardName()),this._createRow("mpf-cc-number",o.get("ccNumber"),"xxxx-xxxx-xxxx-"+this.token.getCardNumber()),this._createRow("mpf-cc-expDate",o.get("ccExpDate"),this.token.getCardExpMonth()+"/"+this.token.getCardExpYear()),this._createRow("mpf-cc-type",o.get("ccType"),this.token.getCardType())]}],this._parent(),this},_createRow:function(e,t,s){return{tag:"tr",class:e,html:[{tag:"td",class:"mpf-label",text:t},{tag:"td",class:"mpf-value",text:s}]}}})}),define("DS/MPFModalConfiguratorComponent/OrderSummarySection",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,n){"use strict";return t.extend({className:"mpf-summary-order",setup:function(e){e||(e={}),s.requiredOfPrototype(e.cart,r,"options.cart must be a CartModel"),this._parent(e),this.cart=e.cart,this.locale=e.locale||"fr-FR"},render:function(){return this.container.setContent([this._getDetailAmount(),this._getTotal()]),this},_getTotal:function(){var t=this.cart.getCurrency();return e.createElement("div",{class:"mpf-order-total",html:[e.createElement("div",{text:n.get("orderTotal")}),e.createElement("div",{text:this._getGrossAmountTotal()+" "+t})]})},_getDetailAmount:function(){var t=this.cart.getCurrency();return e.createElement("div",{class:"mpf-order-detail",html:[e.createElement("div",{class:"mpf-order-subtotal",html:[e.createElement("div",{text:n.get("subtotal")}),e.createElement("div",{text:this._getNetAmountTotal()+" "+t})]}),e.createElement("div",{class:"mpf-order-taxes",html:[e.createElement("div",{text:n.get("taxes")}),e.createElement("div",{text:this._getTaxesAmountTotal()+" "+t})]})]})},_getGrossAmountTotal:function(){var e=this.cart.getCurrency();return this.cart.getGrossAmountTotal().toLocaleString(this.locale,{style:"currency",currency:e,currencyDisplay:"code"}).replace(e,"").trim()},_getNetAmountTotal:function(){var e=this.cart.getCurrency();return this.cart.getNetAmountTotal().toLocaleString(this.locale,{style:"currency",currency:e,currencyDisplay:"code"}).replace(e,"").trim()},_getTaxesAmountTotal:function(){var e=this.cart.getCurrency();return this.cart.getTaxesAmountTotal().toLocaleString(this.locale,{style:"currency",currency:e,currencyDisplay:"code"}).replace(e,"").trim()}})}),define("DS/MPFModalConfiguratorComponent/PaymentAgreementsSection",["DS/MPFView/MPFView","DS/UIKIT/Input/Toggle","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s){"use strict";return e.extend({className:"mpf-payment-agreements",setup:function(e){e||(e={}),this._parent(e)},render:function(){var e=this;return this.container.setContent(new t({type:"checkbox",label:s.get("agreeAndProceed"),className:"primary",events:{onChange:function(){this.isChecked()?e.dispatchEvent("validSection"):e.dispatchEvent("invalidSection")}}})),this}})}),define("DS/MPFModalConfiguratorComponent/OrderNumberSection",["UWA/Core","DS/MPFServices/ObjectService","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFCartModel/CartModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,n){"use strict";return s.extend({setup:function(e){this._parent(e),t.requiredOfPrototype(this.model,r,"this.model must be a CartModel")},render:function(){return this.body.push(e.createElement("div",{class:"mpf-order-id",text:this.model.get("name")})),this._parent(),this}})}),define("DS/MPFModalConfiguratorComponent/ThanksPurchasingPage",["UWA/Class/View","UWA/Core","DS/MPFServices/MarketplaceServices","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Category","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],(e,t,s,r,n,o,i)=>{"use strict";const a={},c={};a.ON_RENDER="onRender",c.SUCCESS_PAGE="/checkout/OrderSuccess",c.FAILURE_PAGE="/checkout/OrderFailure";const d=e.extend({className:"mpf-end-purchasing",setup(e){e||(e={}),this.service=t.is(e.service)?e.service:s.MAKE,this.me=e.me,this.paymentOK=!0===e.paymentOK,this.product=e.product,this.isClicknbuyEduOrMakers=!0===e.isClicknbuyEduOrMakers,this.firstNameUser=e.firstNameUser},render(){let e;return this.service!==s.MAKE&&(this.paymentOK?(this.renderSuccess(),e=i.get("purchaseComplete")):(this.renderFailure(),e=i.get("purchaseFailure"))),window.parent.postMessage({isPaymentDone:!0,isPaymentOk:this.paymentOK,headerModalMsg:e},"*"),this.dispatchEvent(a.ON_RENDER),this},setPayment(e){this.paymentOK=e},renderSuccess(){this.container.setContent([this._displayCheckFonticon(),this._displaySuccessInfo()]),this._sendTrackingPage(c.SUCCESS_PAGE)},renderFailure(){this.container.setContent([this._displayWrongFonticon(),this._displayFailureInfo()]),this._sendTrackingPage(c.FAILURE_PAGE)},_displayCheckFonticon:()=>t.createElement("div",{class:"fonticon fonticon-5x fonticon-check"}),_displayWrongFonticon:()=>t.createElement("div",{class:"fonticon fonticon-5x fonticon-wrong"}),_displaySuccessInfo(){return t.createElement("div",{class:"mpf-end-purchase-info",html:this.isClicknbuyEduOrMakers?this._getPersonnalizedMessage():this._getStandardMessage()})},_getPersonnalizedMessage(){return[t.createElement("div",{text:t.is(this.me)?i.get("helloYou",{you:this.me.getFirstName()}):t.is(this.firstNameUser)?i.get("helloYou",{you:this.firstNameUser}):i.get("hello")}),t.createElement("div",{text:i.get("oneClickAway")}),t.createElement("div",{text:i.get("checkInbox")}),t.createElement("div",{text:i.get("bookmarkIt")}),t.createElement("div",{text:i.get("gotIt")})]},_getStandardMessage(){let e;const r=[];e=t.is(this.product)&&"PGB"===this.product?i.get("PGBPurchase"):t.is(this.product)?i.get("LicensesPurchase"):i.get("Purchase");const n=t.createElement("p",{text:i.get("thanksPurchase")}),o=t.createElement("p",{text:e}),a=t.createElement("p",{text:this.service===s.IFWELOOP?i.get("emailSolutionReady"):i.get("emailPurchase")});return r.push(n),this.service!==s.IFWELOOP&&r.push(o),r.push(a),r},_displayFailureInfo(){const e=t.createElement("p",{text:i.get("errorPayment")}),s=t.createElement("p",{text:i.get("supportDS")});return t.createElement("div",{class:"mpf-end-purchase-info",html:[e,s]})},_sendTrackingPage(e){r.createPageBuilder({url:e}).addDimension(n.MARKETPLACE_SERVICE,this.service).send()}});return d.Events=Object.freeze(a),d}),define("DS/MPFModalConfiguratorComponent/BillingAddressFormSection",["UWA/Core","UWA/Promise","DS/MPFServices/ObjectService","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFAddressFormComponent/AddressFormComponentV2","DS/MPFAddressFormComponent/AddressCard","DS/MPFBuyer/BuyerType","DS/MPFCountryModel/CountryCollection","DS/MPFAddressModel/AddressCollection","DS/MPFAddressModel/AddressModel","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyModel/CompanyModel","DS/MPFPersonModel/PersonModel","DS/MPFError/BadArgumentError","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,n,o,i,a,c,d,h,l,u,p,m){"use strict";return r.extend({className:"mpf-billing-address-section",setup:function(e){if(e||(e={}),!Object.prototype.isPrototypeOf.call(l.prototype,e.buyer)&&!Object.prototype.isPrototypeOf.call(u.prototype,e.buyer))throw new p("BillingAddressFormSection options.buyer must be a CompanyModel or a PersonModel");s.requiredOfPrototype(e.buyerType,i,"options.buyerType must be a BuyerType"),s.requiredOfPrototype(e.addresses,c,"options.addresses must be an AddressCollection"),s.requiredOfPrototype(e.addressFactory,h,"options.addressFactory must be an AddressFactory"),s.requiredOfPrototype(e.countries,a,"options.countries must be a CountryCollection"),this._parent(e),this.countries=e.countries,this.buyerType=e.buyerType,this.buyer=e.buyer,this.addresses=e.addresses,this.addressFactory=e.addressFactory,this.addressCards=[],this.billingAddress=this._createBillingAddress(),this.newAddressForm=this._createAddressForm()},render:function(){var e=this;this.body=[],this.addressCards=[];var t=this._filterBillingAddresses(this.addresses);return t.length>0&&!this.forceAddressForm?(t.forEach(function(t){var s=new o({model:t,legalEntity:e.buyer});e.addressCards.push(s.render())}),this.body.push(this.addressCards),this.newAddress=!1):(this.body.push(this.newAddressForm.render()),this.newAddress=!0),this.listenTo(this.buyer,"onChange:"+l.Fields.COUNTRY,this._onBuyerCountryChange.bind(this)),this._parent(),this},save:function(){return this.newAddress?(this.newAddressForm.addressModel.parentResourceId=this.buyer.get("id"),this.newAddressForm.savePromise()):t.resolve()},validate:function(){return!this.newAddress||this.newAddressForm.validate()},getBillingAddressModel:function(){return this.billingAddress},updateCountryAddress:function(){this.newAddressForm.countrySelectComponent.setReadOnly(!1),this.newAddressForm.countrySelectComponent.setValue(this.buyer.get("country")),this.newAddressForm.countrySelectComponent.setReadOnly(!0)},_filterBillingAddresses:function(e){var t=this;return this.buyerType===i.COMPANY&&this.buyer.getCountry()?e.filter(function(e){return e.isBillTo()&&e.getCountry()===t.buyer.getCountry()}):e.filter(function(e){return e.isBillTo()})},_onBuyerCountryChange:function(){this.updateCountryAddress(),this.newAddress||this._switchToAddressForm()},_switchToAddressForm:function(){this.forceAddressForm=!0,this.billingAddress=this._createBillingAddress(),this.render()},_createBillingAddress:function(){var t;return this.buyerType===i.INDIVIDUAL?t=this.addressFactory.createModel(h.Types.ME):this.buyerType===i.COMPANY&&(t=this.addressFactory.createModel(h.Types.COMPANY),e.is(this.buyer.get("country"))&&t.set(d.Fields.COUNTRY,this.buyer.getCountry())),t.set(d.Fields.IS_SHIP_TO,"TRUE"),t.set(d.Fields.IS_BILL_TO,"TRUE"),t},_createAddressForm:function(){return new n({addressModel:this.billingAddress,addressConstraints:this.addressFactory.addressesConstraints,countryReadOnly:this.buyerType===i.COMPANY,countries:this.countries,horizontalLayout:!0})}})}),define("DS/MPFModalConfiguratorComponent/BillingAddressList",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFError/BadArgumentError","DS/MPFAddressModel/AddressCollection","DS/MPFBuyer/BuyerType","DS/MPFCompanyModel/CompanyModel","DS/MPFPersonModel/PersonModel","DS/MPFAddressFormComponent/AddressCard"],function(e,t,s,r,n,o,i,a,c){"use strict";var d,h={};return h.ADD_ADDRESS="addAddress",(d=t.extend({className:"mpf-billing-address-list",setup:function(e){if(s.requiredOfPrototype(e.addresses,n,"options.addresses must be a AddressCollection"),!Object.prototype.isPrototypeOf.call(i.prototype,e.buyer)&&!Object.prototype.isPrototypeOf.call(a.prototype,e.buyer))throw new r("BillingAddressFormSection options.buyer must be a CompanyModel or a PersonModel");this.addresses=e.addresses,this.buyer=e.buyer,this.buyerType=e.buyerType,this.addressCards=[],this.addAddressButton=this._createAddAddressButton()},render:function(){return this._destroyAddressCards(),this.addressCards=this._createAddressCards(),this.container.setContent([this.addressCards.map(function(e){return e.render()}),this.addAddressButton]),this},getSelectedAddress:function(){return this.selectedAddress},destroy:function(){this.stopListening(),this._destroyAddressCards(),this.addresses=null,this.buyer=null,this.buyerType=null,this._parent(),this.container=null},_createAddressCards:function(){var e=this,t=[];return this.addresses.getBillingAddresses({country:this.buyerType===o.COMPANY?this.buyer.getCountry():null}).forEach(function(s,r){var n=new c({model:s,legalEntity:e.buyer});0===r&&(e.selectedAddress=s)&&n.container.addClassName("mpf-selected"),e.listenTo(n,c.Events.ON_SELECTED,e._onSelection.bind(e,s)),t.push(n)}),t},_createAddAddressButton:function(){return e.createElement("div",{class:"mpf-add-address-button",text:"+",html:{tag:"span",class:"fonticon fonticon-plus"},events:{click:this.dispatchEvent.bind(this,h.ADD_ADDRESS)}})},_onSelection:function(e){this.selectedAddress=e,this.addressCards.forEach(function(t){t.model===e?t.container.addClassName("mpf-selected"):t.container.removeClassName("mpf-selected")})},_destroyAddressCards:function(){var e=this;this.addressCards.forEach(function(t){e.stopListening(t),t.destroy()}),this.addressCards=[]}})).Events=Object.freeze(h),d}),define("DS/MPFModalConfiguratorComponent/BillingInformationFormSection",["UWA/Core","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFError/BadArgumentError","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFModalConfiguratorComponent/CompanyInformationSection","DS/MPFPersonComponent/PersonNameForm","DS/MPFBuyer/BuyerType","DS/MPFBuyerAddressComponent/BuyerTypeSelectorInput","DS/MPFCompanyModel/CompanyModel","DS/MPFPersonModel/PersonModel","DS/MPFCountryModel/CountryCollection","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,n,o,i,a,c,d,h,l,u){"use strict";var p,m={};return m.ON_TYPE_CHANGE="onTypeChange",(p=n.extend({setup:function(s){if(s||(s={}),!Object.prototype.isPrototypeOf.call(d.prototype,s.buyer)&&!Object.prototype.isPrototypeOf.call(h.prototype,s.buyer))throw new r("BillingInformationFormSection options.buyer must be a CompanyModel or a PersonModel");var n;t.requiredOfPrototype(s.buyerType,a,"options.buyerType must be a BuyerType"),t.requiredOfPrototype(s.countries,l,"options.countries must be a CountryCollection"),this._parent(s),this.buyer=s.buyer,this.countries=s.countries,this.buyerType=s.buyerType,this.addresses=s.addresses,e.equals(a.COMPANY,this.buyerType)?(this.companyInformationSection=new o({model:this.buyer,countryCollection:this.countries,addresses:this.addresses}),n=!0):(this.personInformationSection=new i({model:this.buyer,readOnly:!0,required:!0,horizontalLayout:!0}),n="none"!==this.buyer.get("buyerType")),n||(this.companyFactory=s.companyFactory,this.company=this.companyFactory.createModel("me"),this.buyerTypeInput=new c({model:this.buyer,readOnly:n}),this.companyInformationSection=new o({model:this.company,countryCollection:this.countries,addresses:this.addresses}),this.listenTo(this.buyerTypeInput,"onChange",this.onBuyerTypeChange))},render:function(){return this.body=[],this.buyerTypeInput&&this.body.push(this.buyerTypeInput.render()),e.equals(a.COMPANY,this.buyerType)?this.body.push(this.companyInformationSection.render()):this.body.push({tag:"div",class:"mpf-person-form",html:this.personInformationSection.render()}),this._parent(),this},validate:function(){return e.equals(a.COMPANY,this.buyerType)?this.companyInformationSection.validate():this.personInformationSection.validate()},save:function(){if(e.equals(a.COMPANY,this.buyerType))return this.companyInformationSection.save()},onBuyerTypeChange:function(e){"company"===e?(this.company.unset(d.Fields.COUNTRY),this.company.unset(d.Fields.TAX_REGISTRATION_ID),this.buyerType=a.COMPANY):(this.buyerType=a.INDIVIDUAL,this.companyInformationSection.clearForm()),this.dispatchEvent(m.ON_TYPE_CHANGE,{buyerType:this.buyerType,company:this.company})}})).Events=Object.freeze(m),p}),define("DS/MPFModalConfiguratorComponent/OrderSummaryDetailsSection",["DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFCartModel/CartItemFactory","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFOrderComponent/OrderConfirmationSectionCommand","DS/MPFModalConfiguratorComponent/OrderSummarySection","DS/MPFOrderComponent/OrderDetailsComponent","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Category","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,n,o,i,a,c,d,h,l,u,p){"use strict";const m=Object.freeze({ORDER_DETAILS_DISPLAYED:"orderDetailsDisplayed",ORDER_DETAILS_NOT_DISPLAYED:"orderDetailsNotDisplayed",LOADING:"loading"}),y=Object.freeze({ON_RENDER:"onRender",ON_RENDER_ERROR:"onRenderError"}),C=o.extend({setup:function(e){e||(e={}),t.requiredOfPrototype(e.cart,s,"options.cart must be a CartModel"),t.requiredOfPrototype(e.cartItemFactory,n,"options.cartItemFactory must be a CartItemFactory"),this._parent(e),this.service=e.service,this.cart=e.cart,this.cartItemFactory=e.cartItemFactory,this.locale=e.locale||"fr-FR",this.orderSummarySection=null,this.orderDetailsSection=null,this.commands=this._createCommands(),this.stateMachine=this._createStateMachine()},render:function(){return this.orderSummarySection=this._createOrderSummarySection(),this.orderDetailsSection=this._createOrderDetailsSection(),this._parent(),this._updateBody(),this},_updateBody:function(){const e=this.stateMachine.getState(),t=this.container.getElement(".mpf-body");this.body=e===m.ORDER_DETAILS_DISPLAYED?this.orderDetailsSection.render():this.orderSummarySection.render(),t.setContent(this.body)},_displayAlert:function(){new e({className:"error",messages:{className:"error",message:p.get("errorCartItems")},icon:!0,closable:!0,visible:!0}).inject(this.container.getElement(".mpf-body"),"top")},_createOrderSummarySection:function(){return new a({cart:this.cart,locale:this.locale})},_createOrderDetailsSection:function(){return new c({service:this.service,cart:this.cart,cartItems:this.cartItemFactory.createCollection("",this.cart.getItems()),locale:this.locale})},_createCommands:function(){const e=this,t="TRUE"===this.cart.get("IsPriceDetailsDisplay"),s=new i({icon:"eye",iconOff:"eye-off",label:p.get("details"),labelOff:p.get("hideDetails")});return this.listenTo(s,i.Events.COMMAND_ON,function(){e.stateMachine.changeState(m.ORDER_DETAILS_DISPLAYED),this._sendTrackerEvent("Billing.DetailsPriceClicked"),e._updateBody()}),this.listenTo(s,i.Events.COMMAND_OFF,function(){e.stateMachine.changeState(m.ORDER_DETAILS_NOT_DISPLAYED),this._sendTrackerEvent("Billing.HideDetailsPriceClicked"),e._updateBody()}),t?[s.render()]:[]},_sendTrackerEvent:function(e){const t=h.createEventBuilder({category:u.CHECKOUT,action:e});r.addTrackerInformation(t,this.cart),t.addDimension(l.MARKETPLACE_SERVICE,this.service).send()},_createStateMachine:function(){return new d({state:m.ORDER_DETAILS_NOT_DISPLAYED,states:[m.ORDER_DETAILS_DISPLAYED,m.ORDER_DETAILS_NOT_DISPLAYED,m.LOADING],transitions:[{from:m.ORDER_DETAILS_DISPLAYED,to:m.ORDER_DETAILS_NOT_DISPLAYED},{from:m.ORDER_DETAILS_NOT_DISPLAYED,to:m.ORDER_DETAILS_DISPLAYED},{from:m.ORDER_DETAILS_DISPLAYED,to:m.LOADING},{from:m.ORDER_DETAILS_NOT_DISPLAYED,to:m.LOADING},{from:m.LOADING,to:m.ORDER_DETAILS_DISPLAYED},{from:m.LOADING,to:m.ORDER_DETAILS_NOT_DISPLAYED}]})}});return C.Events=Object.freeze(y),C}),define("DS/MPFModalConfiguratorComponent/BillingInformationSection",["UWA/Core","UWA/String","DS/MPFServices/ObjectService","DS/MPFUtils/MPFUtils","DS/MPFBuyer/BuyerType","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFOrderComponent/OrderConfirmationSectionCommand","DS/MPFOrderComponent/NoOrderConfirmationSectionCommand","DS/UIKIT/Input/Select","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/MPFAddressFormComponent/AddressCard","DS/MPFModalConfiguratorComponent/BuyerCard","DS/MPFAddressFormComponent/AddressFormComponentV2","DS/MPFCartModel/CartPatchOperation","DS/MPFCartModel/CartPatchArray","DS/MPFAddressModel/AddressCollection","DS/MPFAddressModel/AddressModel","DS/MPFAddressModel/AddressFactory","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","DS/MPFPspModel/PspModel","DS/MPFCountryModel/CountryCollection","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFError/BadArgumentError","DS/MPFView/EmptyView","DS/MPFUrl/UrlUtils","DS/MPFServices/MarketplaceServices","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Category","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","i18n!DS/MPFAddressFormComponent/assets/nls/AddressFormComponent"],(e,t,s,r,n,o,i,a,c,d,h,l,u,p,m,y,C,P,g,f,M,S,D,E,T,A,_,F,O,I,b,v,N,R,k)=>{"use strict";const L=Object.freeze({ADDRESS_SELECTION:"addressSelection",ADDRESS_DETAILS:"addressDetails",NEW_ADDRESS_FORM:"newAddressForm"}),B=Object.freeze({NEW_ADDRESS_FORM:"newAddressForm",EXIT_ADDRESS_FORM:"exitAddressForm",PATCHING_CART:"updatingCart",ERROR_PATCH_CART:"errorPatchCart",VALID:"validSection",INVALID:"invalidSection"}),U=Object.freeze({SAVE:0,ADD:1,DETAILS:2}),w=o.extend({className:"mpf-billing-information-section mpf-section",setup(e={}){this._checkPrototypes(e),this._parent(e),this.cart=e.cart,this.cartPsp=e.cartPsp,this.addressFactory=e.addressFactory,this.addresses=e.addresses,this.buyerType=e.buyerType,this.buyer=e.buyer,this.countries=e.countries,this.service=e.service,this.selectedAddress=null,this.isReadOnly=!0===e.isReadOnly,this.commands=this._getCommands(),this.newAddressForm=this._createAddressForm(),this.selectAddresses=this._getAddressSelect(),this.alert=this._createAlert(),this.stateMachine=this._createStateMachine(),this._initListeners()},render(){return this.commands.forEach(e=>e.render()),this.body=[e.createElement("div",{class:"mpf-billing-infos",html:[this.alert,this.selectAddresses]})],this._parent(),this.commands[U.SAVE].hide(),this},isValid(){return e.is(this.selectedAddress)},_getAddressSelect(){const t=this.cart.getBillingAddress(),s=this.addresses.filter(e=>!!e.isBillTo()&&(this.buyerType!==n.COMPANY||this.buyer.getCountry()===e.getCountry())),o=r.findInArray(s,s=>e.is(t)&&s.get("id")===t.get("id"));if(e.is(o))this.selectedAddress=o;else{if(0===s.length)throw new Error("No billing addresses found !");this.selectedAddress=s[s.length-1],this._updateCart({BillTo:this.selectedAddress.id})}const i=s.map(e=>{const t={value:e.get("id"),label:this._getAddressTitle(e)};return e.id===this.selectedAddress.id&&(t.selected=!0),t});return new c({placeholder:!1,options:i,disabled:this.isReadOnly,events:{onChange:this._onAddressChange.bind(this)}})},_onAddressChange(){const t=this.addresses.find(e=>e.get("id")===this.selectAddresses.getValue()[0],this);e.is(this.selectedAddress)?t.id!==this.selectedAddress.id?(this.selectedAddress=t,this._updateCart({BillTo:this.selectedAddress.id})):this.dispatchEvent(B.VALID):this.dispatchEvent(B.INVALID)},_updateCart(t){if(e.is(this.selectedAddress)){this.dispatchEvent(B.PATCHING_CART);const e=new m(m.Operations.modify,"/",t),s=new y;return s.add(e),this.cart.megaPatch(s).then(this.cartPsp.fetchPromise.bind(this.cartPsp)).then(()=>{if(this.service===I.CLICK_AND_BUY){const e=this.selectedAddress.getCountry(),t=this.countries.find(t=>t.getIso3()===e).getIso2();window.localStorage.setItem(f.LOCAL_STORAGE_KEY_COUNTRY,t)}this.dispatchEvent(B.VALID)}).catch(this._displayAlert.bind(this))}},_displayAlert(){this.dispatchEvent(B.ERROR_PATCH_CART),this.alert.add({className:"error",message:R.get("errorBillingInfo")})},_getAddressTitle(s){let r="";return[P.Fields.LINE1,P.Fields.LINE2,P.Fields.LINE3,P.Fields.LINE4,P.Fields.CITY,P.Fields.COUNTY,P.Fields.STATE,P.Fields.POSTAL_CODE,P.Fields.COUNTRY].map(t=>{if(t===P.Fields.STATE){const r=k[s.getCountry()+s.getState()];return e.is(r)?r:s.get(t)}return s.get(t)}).filter(e=>e&&e.length>0).map(e=>r=r+" "+e+","),t.truncate(r,r.length-1,"")},_getCommands(){return[new i({icon:"floppy",iconOff:"floppy",label:R.get("save"),labelOff:R.get("save")}),O.from(window.location.href).isEmp()||this.service===I.IFWELOOP&&!0!==this.cart.get("isSelfOrder")||this.service===I.SUBSCRIPTIONS||this.isReadOnly?a.getInstance():new i({icon:"plus",iconOff:"view-list",label:R.get("addAddress"),labelOff:R.get("listAddress")}),new i({icon:"eye",iconOff:"eye-off",label:R.get("details"),labelOff:R.get("hideDetails")})]},_saveAddress(){const e=this.container.getElement(".mpf-billing-infos");return this._sendTrackerEvent("Billing.SaveBillingInformationClicked"),this.dispatchEvent(B.INVALID),d.mask(this.container),this.newAddressForm.savePromise().then(t=>{this.dispatchEvent(B.EXIT_ADDRESS_FORM),this.addresses.add(t);const s={value:t.get("id"),label:this._getAddressTitle(t)};this.selectAddresses.add(s),this.selectAddresses.setValue(s),this.newAddressForm=this._createAddressForm(),e.setContent(this.selectAddresses),this.commands[U.SAVE].setOff(),this.commands[U.SAVE].hide(),this.commands[U.ADD].setOff(),this.commands[U.DETAILS].setOff(),this.commands[U.DETAILS].show(),this.stateMachine.changeState(L.ADDRESS_SELECTION),this._sendTrackerEvent("Billing.InformationSent")}).catch(e=>{let t;t=Error.prototype.isPrototypeOf(e)&&e.message.length>0?e.message:R.get("errorBillingInfo"),this.alert.add({className:"error",message:t})}).finally(d.unmask.bind(d,this.container))},_initListeners(){this.listenTo(this.commands[U.SAVE],"commandOn",this._saveAddress.bind(this)),this.listenTo(this.commands[U.SAVE],"commandOff",this._saveAddress.bind(this)),this.listenTo(this.commands[U.ADD],"commandOn",this._addAddress.bind(this)),this.listenTo(this.commands[U.ADD],"commandOff",this.cancelAddAddress.bind(this)),this.listenTo(this.commands[U.DETAILS],"commandOn",this._displayDetails.bind(this)),this.listenTo(this.commands[U.DETAILS],"commandOff",this._displaySelectAddress.bind(this))},_displaySelectAddress(){this.container.getElement(".mpf-billing-infos").setContent(this.selectAddresses),this.stateMachine.changeState(L.ADDRESS_SELECTION)},cancelAddAddress(t){t=t||{},this.container.getElement(".mpf-billing-infos").setContent(this.selectAddresses),this.commands[U.ADD].setOff(),this.commands[U.DETAILS].setOff(),this.commands[U.DETAILS].show(),this.commands[U.SAVE].hide(),e.is(this.newAddressForm)&&this.newAddressForm.clear(),t.silent||this.dispatchEvent(B.EXIT_ADDRESS_FORM),this.stateMachine.changeState(L.ADDRESS_SELECTION),this._sendTrackerEvent("Billing.CancelClicked")},_addAddress(){this.container.getElement(".mpf-billing-infos").setContent([this.alert,this.newAddressForm.render()]),this.commands[U.SAVE].show(),this.commands[U.DETAILS].hide(),this.stateMachine.changeState(L.NEW_ADDRESS_FORM),this._sendTrackerEvent("Billing.AddAddressClicked"),this.dispatchEvent(B.NEW_ADDRESS_FORM)},_displayDetails(){let t;const s=this.container.getElement(".mpf-billing-infos"),r=this.selectedAddress.getCountry();t=r.test(/^[A-Z]{3}$/)?this.countries.filter(e=>e.getIso3()===this.selectedAddress.getCountry()).shift().getName():r,e.is(this.selectedAddress)?s.setContent([new u({model:this.buyer,buyerType:this.buyerType,country:t}).render(),new l({model:this.selectedAddress,legalEntity:this.buyer,country:t}).render()]):s.setContent([new u({model:this.buyer,buyerType:this.buyerType}).render(),this.selectAddresses]),this.stateMachine.changeState(L.ADDRESS_DETAILS),this._sendTrackerEvent("Billing.DetailsAddressClicked")},_createAddressForm(){let t,s;const r={};return r[P.Fields.IS_BILL_TO]="TRUE",r[P.Fields.IS_SHIP_TO]="TRUE",e.equals(this.buyerType,n.INDIVIDUAL)?t=this.addressFactory.createModel("me",r):((t=this.addressFactory.createModel("company",r)).parentResourceId=this.buyer.get("id"),t.set("country",this.buyer.get("country")),s=this.buyer.get("country")&&""!==this.buyer.get("country")),new p({addressModel:t,addressConstraints:this.addressFactory.addressesConstraints,countryReadOnly:s,countries:this.countries,horizontalLayout:!0})},_createAlert:()=>new h({messsageClassName:"error",icon:!0,closable:!0,visible:!0,maximumVisibleMessage:1}),_createStateMachine:()=>new A({state:L.ADDRESS_SELECTION,states:[L.ADDRESS_SELECTION,L.NEW_ADDRESS_FORM,L.ADDRESS_DETAILS],transitions:[{from:L.ADDRESS_SELECTION,to:L.NEW_ADDRESS_FORM},{from:L.ADDRESS_SELECTION,to:L.ADDRESS_DETAILS},{from:L.NEW_ADDRESS_FORM,to:L.ADDRESS_SELECTION},{from:L.ADDRESS_DETAILS,to:L.ADDRESS_SELECTION},{from:L.ADDRESS_DETAILS,to:L.NEW_ADDRESS_FORM}]}),_checkPrototypes(e){if(!D.prototype.isPrototypeOf(e.buyer)&&!S.prototype.isPrototypeOf(e.buyer))throw new _("BillingInformationSection options.buyer must be a CompanyModel or a PersonModel");s.requiredOfPrototype(e.buyerType,n,"options.buyerType must be a BuyerType"),s.requiredOfPrototype(e.addresses,C,"options.addresses must be an AddressCollection"),s.requiredOfPrototype(e.addressFactory,g,"options.addressFactory must be an AddressFactory"),s.requiredOfPrototype(e.cart,f,"options.cart must be a CartModel"),s.requiredOfPrototype(e.cartPsp,E,"options.cartPsp must be a PspModel"),s.requiredOfPrototype(e.countries,T,"options.countries must be a CountryCollection")},_sendTrackerEvent(e){const t=b.createEventBuilder({category:N.CHECKOUT,action:e});M.addTrackerInformation(t,this.cart),t.addDimension(v.MARKETPLACE_SERVICE,this.service).send()}});return w.Events=B,w}),define("DS/MPFModalConfiguratorComponent/SecurePaymentPage",["UWA/Core","UWA/Promise","UWA/Class/View","UWA/String","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","DS/MPFModalConfiguratorComponent/BankAccountInformationSection","DS/MPFModalConfiguratorComponent/OrderNumberSection","DS/MPFModalConfiguratorComponent/PaymentInformationSupportSection","DS/MPFModalConfiguratorComponent/PaymentAgreementsSection","DS/MPFModalConfiguratorComponent/ThanksPurchasingPage","DS/MPFCartModel/CartModel","DS/MPFVirtualIbanModel/VirtualIbanModel","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,n,o,i,a,c,d,h,l,u,p,m,y,C,P){"use strict";return s.extend({className:"mpf-secure-payment-page",setup:function(e){e||(e={}),n.requiredOfPrototype(e.buyerType,o,"options.buyerType must be a BuyerType"),n.requiredOfPrototype(e.cart,p,"options.cart must be a CartModel"),n.requiredOfPrototype(e.virtualIban,m,"options.virtualIban must be a VirtualIbanModel"),this.buyerType=o.prototype.isPrototypeOf(e.buyerType)?e.buyerType:o.INDIVIDUAL,this.cart=e.cart,this.virtualIban=e.virtualIban,this.currency=this.cart.get("currency"),this.product=e.product,this.cartPaid=e.cartPaid},render:function(){return this._initSections(),this.container.setContent([this.sections[0].render(),this.sections[1].render(),this.sections[2].render()]),e.is(this.sections[3])&&(this.container.addContent(this.sections[3].render()),this._initListeners()),this},save:function(){var s,r=this,n=t.deferred(),o=new a("modify","/",{currentState:"PENDING_PAYMENT",VirtualIbanId:this.virtualIban.get("Id")}),c=new i;return s=e.is(this.product)?new u({product:this.product}):new u,c.add(o),this.cart.megaPatch(c).then(function(){s.setPayment(!0),r.container.setContent(s.render()),r.dispatchEvent("IbanOperation","Complete"),n.resolve()}).catch(function(){s.setPayment(!1),r.container.setContent(s.render()),r.dispatchEvent("IbanOperation","Failure"),n.reject()}),n.promise},_initSections:function(){this.sections=[new c({title:r.format(P.get("countdownTransfer"),this.cart.get("GrossAmountTotal")+" "+this.currency),virtualIban:this.virtualIban}),new d({title:P.get("mentionOrderNumber"),model:this.cart}),new h],this.cartPaid||this.sections.push(new l)},_initListeners:function(){var e=this;this.listenTo(this.sections[3],"validSection",function(){e.dispatchEvent("valid")}),this.listenTo(this.sections[3],"invalidSection",function(){e.dispatchEvent("invalid")})}})}),define("DS/MPFModalConfiguratorComponent/BillingAddressFormSectionV2",["UWA/Promise","DS/MPFServices/ObjectService","DS/MPFError/BadArgumentError","DS/MPFBuyer/BuyerType","DS/MPFCountryModel/CountryCollection","DS/MPFAddressModel/AddressCollection","DS/MPFAddressModel/AddressModel","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyModel/CompanyModel","DS/MPFPersonModel/PersonModel","DS/MPFAddressFormComponent/AddressFormComponentV2","DS/MPFModalConfiguratorComponent/BillingAddressList","DS/MPFOrderComponent/OrderConfirmationSection"],function(e,t,s,r,n,o,i,a,c,d,h,l,u){"use strict";var p,m={};return m.SELECTION="addressSelection",m.CREATION="addressCreation",(p=u.extend({className:"mpf-billing-address-form-section-v2",setup:function(e){if(e||(e={}),!Object.prototype.isPrototypeOf.call(c.prototype,e.buyer)&&!Object.prototype.isPrototypeOf.call(d.prototype,e.buyer))throw new s("BillingAddressFormSection options.buyer must be a CompanyModel or a PersonModel");t.requiredOfPrototype(e.buyerType,r,"options.buyerType must be a BuyerType"),t.requiredOfPrototype(e.countries,n,"options.countries must be a CountryCollection"),t.requiredOfPrototype(e.addresses,o,"options.addresses must be an AddressCollection"),t.requiredOfPrototype(e.addressFactory,a,"options.addressFactory must be an AddressFactory"),this.buyer=e.buyer,this.buyerType=e.buyerType,this.countries=e.countries,this.addresses=e.addresses,this.addressFactory=e.addressFactory,this._parent(e),this.addressForm=this._createAddressForm(),this.addressList=this._createAddressList(),this.state=this._getStateFromAddresses(),this.listenTo(this.buyer,"onChange:"+c.Fields.COUNTRY,this._onBuyerCountryChange.bind(this))},render:function(){return this.body=[],this.state===m.CREATION?this.body.push(this.addressForm.render()):this.body.push(this.addressList.render()),this._parent(),this},validate:function(){return this.state===m.CREATION?this.addressForm.validate():!!this.addressList.getSelectedAddress()},save:function(){var t=this;return this.state===m.CREATION?(this.addressForm.addressModel.parentResourceId=this.buyer.get("id"),this.addressForm.savePromise().then(function(e){return t.addresses.add(e),e})):e.resolve(this.addressList.getSelectedAddress())},destroy:function(){this.stopListening(),this.addressForm.destroy(),this.addressList.destroy(),this.countries=null,this.buyerType=null,this.buyer=null,this.addresses=null,this.addressFactory=null,this._parent(),this.container=null},_onBuyerCountryChange:function(){this.addressForm.countrySelectComponent.setReadOnly(!1),this.addressForm.countrySelectComponent.setValue(this.buyer.get("country")),this.addressForm.countrySelectComponent.setReadOnly(!0),this.state=this._getStateFromAddresses(),this.render()},_switchToAddressForm:function(){this.state=m.CREATION,this.render()},_getStateFromAddresses:function(){return this.addresses.getBillingAddresses({country:this.buyerType===r.COMPANY?this.buyer.getCountry():null}).length>0?m.SELECTION:m.CREATION},_createAddressForm:function(){return new h({addressModel:this._createBillingAddress(),addressConstraints:this.addressFactory.addressesConstraints,countryReadOnly:this.buyerType===r.COMPANY,countries:this.countries,horizontalLayout:!0})},_createAddressList:function(){var e=new l({addresses:this.addresses,buyer:this.buyer,buyerType:this.buyerType});return this.listenTo(e,l.Events.ADD_ADDRESS,this._switchToAddressForm.bind(this)),e},_createBillingAddress:function(){var e;if(this.buyerType===r.INDIVIDUAL)e=this.addressFactory.createModel(a.Types.PERSON);else if(this.buyerType===r.COMPANY){e=this.addressFactory.createModel(a.Types.COMPANY);const t=this.buyer.getCountry();t&&e.set(i.Fields.COUNTRY,t)}return e.set(i.Fields.IS_SHIP_TO,"TRUE"),e.set(i.Fields.IS_BILL_TO,"TRUE"),e}})).States=Object.freeze(m),p}),define("DS/MPFModalConfiguratorComponent/BillingInformationFormSectionV2",["UWA/Core","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFModalConfiguratorComponent/CompanyInformationSection","DS/MPFPersonComponent/PersonNameForm","DS/MPFBuyer/BuyerType","DS/MPFBuyerAddressComponent/BuyerTypeSelectorInput","DS/MPFCompanyModel/CompanyFactory","DS/MPFCartModel/CartModel","DS/MPFCompanyModel/CompanyModel","DS/MPFPersonModel/PersonModel","DS/MPFCountryModel/CountryCollection","DS/MPFAddressModel/AddressCollection"],function(e,t,s,r,n,o,i,a,c,d,h,l,u,p){"use strict";const m={ON_TYPE_CHANGE:"onTypeChange"},y=r.extend({setup(e={}){t.requiredOfPrototype(e.cart,d,"options.cart must be a CartModel"),t.requiredOfPrototype(e.person,l,"options.person must be a PersonModel"),t.requiredOfPrototype(e.buyerType,i,"options.buyerType must be a BuyerType"),t.requiredOfPrototype(e.countries,u,"options.countries must be a CountryCollection"),this.cart=e.cart,this.person=e.person,this.company=e.company,this.countries=e.countries,this.buyerType=e.buyerType,this.addresses=e.addresses,this.companyFactory=e.companyFactory,this.service=e.service||s.MAKE,this._parent(e);const r="none"!==this.person.getBuyerType(),n=this.service===s.CLICK_AND_BUY&&this.cart.hasEduItems(),o=this.service===s.CLICK_AND_BUY&&this.cart.hasMakerItems();r&&this.buyerType===i.COMPANY&&t.requiredOfPrototype(e.company,h,"options.company must be a CompanyModel if buyerType is company and has already been saved"),(!r||r&&this.buyerType===i.COMPANY)&&t.requiredOfPrototype(e.addresses,p,"options.addresses must be an AddressCollection"),r||this.company||(t.requiredOfPrototype(e.companyFactory,c,"options.companyFactory must be a CompanyFactory"),this.company=this.companyFactory.createModel(c.Types.ME)),(!r||n||o)&&(this.buyerTypeInput=this._createBuyerTypeSelector({isBuyerTypeDetermined:r})),this.buyerForm=this._createBuyerForm()},render(){return this.body=[],this.buyerTypeInput&&this.body.push(this.buyerTypeInput.render()),this.body.push(this.buyerForm.render()),this._parent(),this},validate(){return this.buyerForm.validate()},save(){if(e.equals(i.COMPANY,this.buyerType))return this.buyerForm.save()},_onBuyerTypeChange(e){"company"===e?(this.company.unset(h.Fields.COUNTRY),this.company.unset(h.Fields.TAX_REGISTRATION_ID),this.buyerType=i.COMPANY):this.buyerType=i.INDIVIDUAL,this.buyerForm.destroy(),this.buyerForm=this._createBuyerForm(),this.dispatchEvent(m.ON_TYPE_CHANGE,{buyerType:this.buyerType,company:this.company})},_createBuyerTypeSelector({isBuyerTypeDetermined:e}){var t=new a({model:this.buyerType===i.COMPANY?this.company:this.person,readOnly:e});return this.listenTo(t,a.Events.ON_CHANGE,this._onBuyerTypeChange.bind(this)),t},_createBuyerForm(){return this.buyerType===i.INDIVIDUAL?this._createPersonForm():this._createCompanyForm()},_createCompanyForm(){return new n({model:this.company,countryCollection:this.countries,addresses:this.addresses})},_createPersonForm(){return new o({model:this.person,readOnly:!0,required:!0,horizontalLayout:!0})}});return y.Events=Object.freeze(m),y}),define("DS/MPFModalConfiguratorComponent/CheckoutHandlerFunctions",["UWA/Core","DS/UIKIT/Modal","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/MPFModalConfiguratorComponent/SecurePaymentPage","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],function(e,t,s,r,n,o){"use strict";return{renderError:function(e){var s;return(s=new t({className:"mpf-configurator-offer",visible:!0,closable:!0,header:{tag:"h4",text:o.get("errorLoading")},body:o.get("noContent")})).inject(e),s},onLoad:function(r,n){var i,a=e.is(n)?n:o.get("loading");return(i=new t({className:"mpf-configurator-offer mpf-configurator-loading",visible:!0,closable:!1,header:{tag:"h4",text:a}})).inject(r),s.mask(i.getBody()),i},displayIbanPaymentRecap:function(e){var s;return(s=new t({className:"mpf-configurator-offer",visible:!0,closable:!0,header:{tag:"h4",text:o.get("checkoutTitle2")},body:new n({cart:e.cart,virtualIban:e.virtualIban,buyerType:e.buyerType,cartPaid:!0}).render()})).setFooter([new r({value:o.get("alreadyPaid"),className:"primary",disabled:!0}),new r({value:o.get("close"),events:{onClick:s.destroy.bind(s)}})]),s.inject(e.container),s}}}),define("DS/MPFModalConfiguratorComponent/BillingInformationPage",["UWA/Core","UWA/Class/View","UWA/Promise","DS/MPFBuyer/BuyerType","DS/MPFModalConfiguratorComponent/BillingInformationFormSectionV2","DS/MPFModalConfiguratorComponent/BillingAddressFormSectionV2","DS/MPFCompanyModel/CompanyModel","DS/MPFCountryModel/CountryCollection","DS/MPFPersonModel/PersonModel","DS/MPFAddressModel/AddressModel","DS/MPFAddressModel/AddressCollection","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFCartModel/CartPatchOperation","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFError/ValidationError","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Category","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,n,o,i,a,c,d,h,l,u,p,m,y,C,P,g,f,M,S,D,E,T,A){"use strict";const _=Object.freeze({INDIVIDUAL_VIEW:"individualView",COMPANY_VIEW:"companyView"}),F=Object.freeze({VALID:"valid",INVALID_PAGE:"invalidPage",PAGE_SAVED:"pageSaved"});const O=t.extend({className:"mpf-billing-info-page",setup(t={}){this._checkPrototypes(t),this.buyerType=Object.prototype.isPrototypeOf.call(r.prototype,t.buyerType)?t.buyerType:r.INDIVIDUAL,this.me=t.me,this.cart=t.cart,this.company=t.company,this.addresses=t.addresses,this.addressFactory=t.addressFactory,this.countries=t.countries,this.service=t.service,this.cartPsp=t.cartPsp,this.companyFactory=t.companyFactory,e.equals(r.COMPANY,this.buyerType)?(this.buyer=this.company,this.stateMachine=this._createStateMachine(_.COMPANY_VIEW)):(this.buyer=this.me,this.stateMachine=this._createStateMachine(_.INDIVIDUAL_VIEW)),this.billingInfoSection=this._createBillingInfoSection(),this.billingAddressSection=this._createBillingAddressSection(),this._sendTrackingPage()},render(){return this.container.setContent([this.billingInfoSection.render(),this.billingAddressSection.render(),this._requiredFieldsLabel()]),this.dispatchEvent(F.VALID),this},save(){let t;const n=this.billingInfoSection.validate(),o=this.billingAddressSection.validate();return this._sendTrackerEvent("Billing.SaveClicked"),n&&o?s.resolve().then(()=>e.equals(this.buyerType,r.COMPANY)?this.billingInfoSection.save().then(this._deleteWrongBillingAddresses.bind(this)).then(this.billingAddressSection.save.bind(this.billingAddressSection)):this.billingAddressSection.save()).then(e=>(t=e,this.cart.setBillingAddress(t),this._updateCartBillingAddress(t))).then(()=>this.cartPsp.fetchPromise()).then(()=>(this._sendTrackerEvent("Billing.SaveSuccess"),this.dispatchEvent(F.PAGE_SAVED),t)):(this.dispatchEvent(F.INVALID_PAGE),s.reject(new f(A.get("errorFieldsInfo"))))},_sendTrackerEvent(e){const t=D.createEventBuilder({category:T.CHECKOUT,action:e});C.addTrackerInformation(t,this.cart),t.addDimension(E.MARKETPLACE_SERVICE,this.service).send()},_deleteWrongBillingAddresses(){const e=this;return Promise.all(this.addresses.filter(t=>t.isBillTo()&&t.getCountry()!==e.buyer.getCountry()).map(e=>{const t={[d.Fields.COUNTRY]:e.getCountry(),[d.Fields.IS_BILL_TO]:"FALSE"};return e.savePromise(t,{method:"PUT"})}))},_createBillingInfoSection(){const e=new n({title:A.get("billInfo"),cart:this.cart,person:this.me,company:this.company,addresses:this.addresses,countries:this.countries,buyerType:this.buyerType,service:this.service,companyFactory:this.companyFactory});return this.listenTo(e,n.Events.ON_TYPE_CHANGE,this._adaptAddressFormToBuyerType.bind(this)),e},_createBillingAddressSection(){return new o({title:A.get("billAddress"),addresses:this.addresses,addressFactory:this.addressFactory,buyer:this.buyer,buyerType:this.buyerType,countries:this.countries})},_adaptAddressFormToBuyerType(t){this.buyerType=t.buyerType,e.equals(this.buyerType,r.COMPANY)?(this.buyer=t.company,this.company=t.company,this.addresses=this.addressFactory.createCollection(l.Types.COMPANY),this.stateMachine.changeState(_.COMPANY_VIEW)):(this.buyer=this.me,this.addresses=this.addressFactory.createCollection(l.Types.ME),this.stateMachine.changeState(_.INDIVIDUAL_VIEW)),this.addresses.parentResourceId=this.buyer.get("id"),this.billingAddressSection=this._createBillingAddressSection(),this.render()},_requiredFieldsLabel:()=>e.createElement("div",{class:"mpf-required-fields",html:[e.createElement("em",{class:"mpf-required",html:"*"}),e.createElement("span",{text:A.get("requiredFields")})]}),_createStateMachine:e=>new g({state:e,states:[_.INDIVIDUAL_VIEW,_.COMPANY_VIEW],transitions:[{from:_.INDIVIDUAL_VIEW,to:_.COMPANY_VIEW},{from:_.COMPANY_VIEW,to:_.INDIVIDUAL_VIEW}]}),_sendTrackingPage(){const e=D.createPageBuilder({url:"/checkout/AddressCreation"});C.addTrackerInformation(e,this.cart),e.addDimension(E.MARKETPLACE_SERVICE,this.service).send()},_updateCartBillingAddress(e){const t={[y.Fields.BILL_TO]:e.get("id")},r=new m,n=new p(p.Operations.modify,"/",t);return r.add(n),this.dispatchEvent(F.PATCHING_CART),this.cart.megaPatch(r).then(()=>this.service===S.ENGINEERING?this.cartPhase.fetchPromise({forceDelegate:!0}):s.resolve()).then(()=>e)},_checkPrototypes(t){M.requiredOfPrototype(t.buyerType,r,"options.buyerType must be a BuyerType"),M.requiredOfPrototype(t.countries,a,"options.countries must be a CountryCollection"),M.requiredOfPrototype(t.me,c,"options.me must be a PersonModel"),M.requiredOfPrototype(t.addresses,h,"options.addresses must be an AddressCollection"),M.requiredOfPrototype(t.addressFactory,l,"options.addressFactory must be an AddressFactory"),M.requiredOfPrototype(t.cart,y,"options.cart must be a CartModel"),M.requiredOfPrototype(t.companyFactory,u,"options.companyFactory must be a CompanyFactory"),e.equals(r.COMPANY,t.buyerType)&&M.requiredOfPrototype(t.company,i,"options.company must be a CompanyModel"),t.service===S.ENGINEERING&&(M.requiredOfPrototype(t.cartPhase,P,"options.cartPhase must be a CartPhaseModel"),this.cartPhase=t.cartPhase)}});return O.Events=F,O.isValid=function(t){M.requiredOfPrototype(t.buyerType,r,"options.buyerType must be a BuyerType"),M.requiredOfPrototype(t.addresses,h,"options.addresses must be an AddressCollection");const s=e.is(t.addresses)&&t.addresses.hasBillingAddresses();if(e.equals(r.COMPANY,t.buyerType)){M.requiredOfPrototype(t.company,i,"options.company must be a CompanyModel");const r=t.company.getName(),n=e.is(r)&&""!==r,o=t.company.getCountry(),a=e.is(o)&&""!==o,c=function(t,s){let r=!0;const n=t.getTaxRegistrationId(),o=t.getCountry(),a=["USA","CAN","JPN"].indexOf(o)>-1,c=s===S.CLICK_AND_BUY,d=s===S.SUBSCRIPTIONS;return r=!(!c&&!d||!a&&!t.hasNoVatId())||e.is(n)&&""!==n&&!t.validate(i.Fields.TAX_REGISTRATION_ID)}(t.company,t.service),d=n&&a&&c;return s&&d}return s},O}),define("DS/MPFModalConfiguratorComponent/CBTokenPaymentConfirmationPage",["UWA/Core","UWA/Promise","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFPaymentCardTokenModel/PaymentCardTokenModel","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFPspModel/PspModel","DS/MPFModalConfiguratorComponent/ThanksPurchasingPage","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],(e,t,s,r,n,o,i,a,c,d,h,l,u,p,m)=>{"use strict";const y={},C={};y.PAYMENT_TOKEN="PaymentTokenOperation",y.VALID="valid",C.COMPLETE="Complete",C.FAILURE="Failure";const P=s.extend({className:"mpf-cbtoken-page",setup(t){t||(t={}),r.requiredOfPrototype(t.me,a,"options.me must be a PersonModel"),r.requiredOfPrototype(t.token,o,"options.token must be a PaymentCardTokenModel"),r.requiredOfPrototype(t.cart,c,"options.cart must be a CartModel"),r.requiredOfPrototype(t.cartPsp,u,"options.cartPsp must be a PspModel"),this.me=t.me,this.cart=t.cart,this.cartPsp=t.cartPsp,this.token=t.token,this.product=t.product,this.waitForPaymentModel=t.waitForPaymentModel,this.locale=t.locale||"fr-FR",this.serviceRequest=e.is(t.serviceRequest)?t.serviceRequest:n.MAKE,this.orderInfoSection=this._createOrderInformationSection(),this.tokenSection=this._createRecapCBTokenSection()},render(){return this.container.setContent([this.orderInfoSection.render(),this.tokenSection.render()]),this.dispatchEvent(y.VALID),this},save(){const e=t.deferred(),s=this.serviceRequest===n.CLICK_AND_BUY&&(this.cart.hasEduItems()||this.cart.hasMakerItems()),r=new p({service:this.serviceRequest,me:this.me,product:this.product,isClicknbuyEduOrMakers:s});return this._payWithToken().then(()=>{this.serviceRequest!==n.MAKE&&(r.setPayment(!0),this.container.setContent(r.render())),this.dispatchEvent(y.PAYMENT_TOKEN,C.COMPLETE),e.resolve()}).catch(t=>{console.error(t),this.serviceRequest!==n.MAKE&&(r.setPayment(!1),this.container.setContent(r.render())),this.dispatchEvent(y.PAYMENT_TOKEN,C.FAILURE),e.resolve()}),e.promise},destroy(){this.orderInfoSection.destroy(),this.tokenSection.destroy(),this.cart=null,this.cartPsp=null,this.token=null,this.product=null,this.container=null},_payWithToken(){return this.cartPsp.getPsp()===u.Psp.STRIPE&&this.cartPsp.isScaEnabled()?this._getStripe().then(this._patchCart.bind(this)).then(this._submitPaymentToStripe.bind(this)).then(function(e){return e.error?t.reject(e.error):t.resolve()}).then(this._waitForPaymentStateUpdate.bind(this)):this._patchCart().then(this._waitForPaymentStateUpdate.bind(this))},_waitForPaymentStateUpdate(){var e=this;return this.waitForPaymentModel?this.waitForPaymentModel.fetchPromise().catch(function(){return t.resolve()}).then(function(){if(e.waitForPaymentModel.getState()===l.States.PAYMENT_REFUSED)return t.reject("payment refused")}):t.resolve()},_submitPaymentToStripe(){const e={};return e.payment_method=this.token.getPaymentMethodId(),this.stripe.handleCardPayment(this.cart.getPaymentIntentSecret(),e)},_patchCart(){const e={currentState:c.States.PENDING_PAYMENT,CreditCardTokenId:this.token.getCardId()},s=this.cart.getState()!==c.States.PAYMENT_INITIATED&&this.cart.getState()!==c.States.PAYMENT_REFUSED,r=new d,n=new h(h.Operations.modify,"/",e);return r.add(n),s?this.cart.megaPatch(r):t.resolve(this.cart)},_getStripe(){var s,r=this,n=t.deferred();return s=e.createElement("script",{src:"https://js.stripe.com/v3/",events:{load:function(){return r.stripe=Stripe(r.cartPsp.getPublicKey()),r.elements=r.stripe.elements(),n.resolve()}}}),"function"==typeof Stripe?(r.stripe=Stripe(r.cartPsp.getPublicKey()),r.elements=r.stripe.elements(),n.resolve()):document.body.appendChild(s),n.promise},_createRecapCBTokenSection(){const e=[{tag:"table",html:[this._createRow("mpf-cc-owner",m.get("ccOwner"),this.token.getCardName()),this._createRow("mpf-cc-number",m.get("ccNumber"),"xxxx-xxxx-xxxx-"+this.token.getCardNumber()),this._createRow("mpf-cc-expDate",m.get("ccExpDate"),this.token.getCardExpMonth()+"/"+this.token.getCardExpYear()),this._createRow("mpf-cc-type",m.get("ccType"),this.token.getCardType())]}];return new i({title:m.get("titleCBToken"),body:e})},_createOrderInformationSection(){let t;t=(t=this.cart.has(c.Fields.COUPON)?parseFloat(this.cart.getCoupon().totalToPay):this.cart.get("GrossAmountTotal")).toLocaleString(this.locale,{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"});const s=e.createElement("table",{html:[this._createRow("mpf-order-number",m.get("order"),"#"+this.cart.getName()),this._createRow("mpf-order-total",m.get("amount"),t)]});return new i({title:m.get("orderInformation"),body:[s]})},_createRow:(e,t,s)=>({tag:"tr",class:e,html:[{tag:"td",class:"mpf-label",text:t},{tag:"td",class:"mpf-value",text:s}]})});return P.Events=Object.freeze(y),P.PaymentStates=Object.freeze(C),P}),define("DS/MPFModalConfiguratorComponent/ModalConfiguratorComponent",["UWA/Core","UWA/Promise","UWA/Class/View","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/UIKIT/Scroller","DS/MPFServices/MarketplaceServices","DS/MPFView/ManuallyClosedModal","DS/MPFOrderComponent/OrderConfirmationPage","DS/MPFModalConfiguratorComponent/ConfirmMakeBankTransferPage","DS/MPFModalConfiguratorComponent/IfweloopBankTransferPage","DS/MPFModalConfiguratorComponent/BillingInformationPage","DS/MPFModalConfiguratorComponent/CBTokenPaymentConfirmationPage","DS/MPFModalConfiguratorComponent/ThanksPurchasingPage","DS/MPFClickAndBuyComponent/checkout/BillingInfoPage","DS/MPFClickAndBuyComponent/checkout/CompanyListPage","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFCartModel/CartItemFactory","DS/MPFAddressModel/AddressCollection","DS/MPFAddressModel/AddressFactory","DS/MPFTCContractModel/SoftwareAgreementModel","DS/MPFTCContractModel/TCContractFactory","DS/MPFPaymentCardTokenModel/PaymentCardTokenCollection","DS/MPFVirtualIbanModel/VirtualIbanFactory","DS/MPFCompanyModel/CompanyModel","DS/MPFCountryModel/CountryCollection","DS/MPFShopModel/ShopModel","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFPaymentCardTokenModel/PaymentCardTokenFactory","DS/MPFCartQuoteModel/CartQuoteModel","DS/MPFPurchaseOrderModel/PurchaseOrderModel","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentModel","DS/MPFPspModel/PspModel","DS/MPFServices/ObjectService","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFError/ValidationError","DS/WebappsUtils/WebappsUtils","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFModalConfiguratorComponent/CheckoutHandlerFunctions","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],function(e,t,s,r,n,o,i,a,c,d,h,l,u,p,m,y,C,P,g,f,M,S,D,E,T,A,_,F,O,I,b,v,N,R,k,L,B,U,w,x,V,Y,q,W,K,H){"use strict";const G={},j={},z={};j.PAYMENT_COMPLETED="paymentCompleted",j.PAYMENT_DECLINED="paymentDeclined",j.PURCHASE_ORDER_UPLOADED="purchaseOrderUploaded",j.MODAL_CLOSED="modalClosed",j.NEXT_PAGE_OPERATIONS_DONE="nextPeageOperationDone",z.USE_PAYMENT_CARD_TOKEN="UsePaymentCardToken",z.USE_BANK_TRANSFER="UseBankTransfer",z.USE_PAYMENT_CARD="UsePaymentCard",z.PAYMENT_COMPLETED="PaymentCompleted",z.PAYMENT_DECLINED="PaymentDeclined",z.CLOSE_CHECKOUT="CloseCheckout",z.QUOTE_DOWNLOADED="QuoteDownloaded",z.PAYMENT_INITIATED="PaymentInitiated",G.PAGE_DISPLAYED="pageDisplayed",G.IFRAME_DISPLAYED="iframeDisplayed",G.SAVING_PAGE="savingPage";const Q=s.extend({setup:function(t){t||(t={}),this._checkPrototypes(t),this._parent(t),this.serviceRequest=e.is(t.serviceRequest)?t.serviceRequest:a.MAKE,this.me=t.me,this.buyerType=t.buyerType,this.cart=t.cart,this.cartQuote=t.cartQuote,this.cartItemFactory=t.cartItemFactory,this.company=t.company,this.companyFactory=t.companyFactory,this.addresses=t.addresses,this.addressFactory=t.addressFactory,this.countries=t.countries,this.tcContractFactory=t.tcContractFactory,this.cardTokens=t.cardTokens,this.virtualIbanFactory=t.virtualIbanFactory,this.paymentCardTokenFactory=t.paymentCardTokenFactory,this.purchaseOrderModel=t.purchaseOrderModel,this.purchaseOrderDocument=t.purchaseOrderDocument,this.periodicitiesAlreadyPurchased=t.periodicitiesAlreadyPurchased,this.cartPsp=t.cartPsp,this.waitForPaymentModel=t.waitForPaymentModel,this.locale=t.locale||"fr-FR",this.linkToBankTransferFAQ=t.linkToBankTransferFAQ,this.bankTransferActive=!e.is(t.bankTransferActive)||t.bankTransferActive,this.buyer=e.equals(P.COMPANY,this.buyerType)?this.company:this.me,this.hasDedicatedPoUploadEvent=!0===t.hasDedicatedPoUploadEvent,this.alert=this._createAlert(),this.stateMachine=this._createStateMachine(),this._sendTrackingPage()},render:function(e){return this._initPages(),this._createModal(),this.modal.inject(e),this.displayNextPage(),this},_initPages:function(){let t;if(this.pages=[],this.titlePages=[],this.labelNextButton=[],this.idxPages={},this.currentPage=-1,this.closingEvent=null,this.stateMachine.getState()!==G.IFRAME_DISPLAYED)return(t=this.serviceRequest===a.IFWELOOP)||this._isBillingInfoValid()?this._initCheckoutPage():this._initBillingInfoPage();this._initIframe(e.createElement("iframe",{src:this._getPaymentUrl(),class:this.cartPsp.getPsp()===U.Psp.STRIPE?"mpf-stripe":""}))},_isBillingInfoValid:function(){const e={};return e.service=this.serviceRequest,e.buyerType=this.buyerType,e.company=this.company,e.addresses=this.addresses,u.isValid(e)},_getPaymentUrl(){if(this.cartPsp.getPsp()===U.Psp.STRIPE){const e=this.cart.dataProxy.connector,t=this.serviceRequest===a.CLICK_AND_BUY&&(this.cart.hasEduItems()||this.cart.hasMakerItems());return Y.getWebappsBaseUrl()+"MPFStripeComponent/StripePaymentPage.html?stripeKey="+this.cartPsp.getPublicKey()+"&isScaEnabled="+this.cartPsp.isScaEnabled()+"&idCart="+this.cart.get("id")+"&service="+this.serviceRequest+"&connectorUrl="+encodeURIComponent(e.rootUrl)+"&connectorPlatformId="+encodeURIComponent(e.platformId)+"&isClicknbuyEduOrMakers="+t+"&firstNameUser="+this.me.getFirstName()}return this.cart.getPaymentUrl()},_paymentByToken(e){const t={serviceRequest:this.serviceRequest,me:this.me,cart:this.cart,locale:this.locale,cartPsp:this.cartPsp,waitForPaymentModel:this.waitForPaymentModel,token:e},s=new p(t);this._unmask(),this.pages.push(s),this.titlePages.push(H.get("checkoutTitle2")),this.labelNextButton.push(H.get("paymentButton")),this.idxPages.cbTokenRecapPage=this.pages.length-1,this._sendTrackingEvent(z.PAYMENT_INITIATED,{token:e,paymentType:z.USE_PAYMENT_CARD_TOKEN}),this.listenTo(s,p.Events.PAYMENT_TOKEN,e=>{this._sendTrackingEvent("Complete"===e?z.PAYMENT_COMPLETED:z.PAYMENT_DECLINED),this.closingEvent="Complete"===e?j.PAYMENT_COMPLETED:j.PAYMENT_DECLINED,this.serviceRequest===a.MAKE?this._closeModal():(this._unmask(),this.nextButton.hide(),this.modal.setHeader({tag:"h4",text:H.get("purchase"+e)}),this._resizeModalAfterPayment())})},_initIframe:function(e){const t=this;function s(e){t.currentPage+=1,t._sendTrackingEvent(e?z.PAYMENT_COMPLETED:z.PAYMENT_DECLINED),t.closingEvent=e?j.PAYMENT_COMPLETED:j.PAYMENT_DECLINED,t.serviceRequest===a.MAKE?t._closeModal():(t.modal.setHeader({tag:"h4",text:e?H.get("purchaseComplete"):H.get("purchaseFailure")}),t.modal.getBody().getElement("iframe").setStyle("height","350px"),t._resizeModalAfterPayment())}this.pages.push(e),this.idxPages.iframe=this.pages.length-1,this.titlePages.push(H.get("checkoutTitle2")),this._sendTrackingEvent(z.PAYMENT_INITIATED,{paymentType:z.USE_PAYMENT_CARD}),e.addEventListener("load",function(){let e;try{e=-1!==this.contentWindow.location.pathname.indexOf("paymentConfirmation.html")}catch(t){e=!1}if(e){const e=-1!==this.contentWindow.location.href.indexOf("state=completed");t.cartPsp.getPsp()===U.Psp.HIPAY&&t.waitForPaymentModel?(t.modal.getBody().getElement("iframe").setStyle("opacity","0"),t._mask(H.get("finalizingPayment")),t.waitForPaymentModel.fetchPromise().finally(function(){t.modal.getBody().getElement("iframe").setStyle("opacity","1"),t._unmask(),s(e)})):s(e)}}),this._onIframeMessageBinded=this._onIframeMessage.bind(this),window.addEventListener("message",this._onIframeMessageBinded)},_onIframeMessage:function(e){const t=window.location.host.replace("-ifwe","-apps"),s=e.origin.contains(t),r=this.serviceRequest!==a.MAKE;s&&e.data.isPaymentDone&&r&&(this._sendTrackingEvent(e.data.isPaymentDone?z.PAYMENT_COMPLETED:z.PAYMENT_DECLINED),this.closingEvent=e.data.isPaymentOk?j.PAYMENT_COMPLETED:j.PAYMENT_DECLINED,this.modal.setHeader({tag:"h4",text:e.data.headerModalMsg}),this.modal.getBody().getElement("iframe").setStyle("height","350px"),this._resizeModalAfterPayment())},_resizeModalAfterPayment:function(){this.modal.elements.content.setStyle("height","490px"),this.cancelButton.setValue(H.get("close")),this.cancelButton.show()},displayNextPage:function(){const t=this.stateMachine.getState();this.currentPage+1<this.pages.length&&(this.currentPage+=1,this.nextButton.load(!1),this._initButtonListeners(this.pages[this.currentPage]),this.modal.setHeader({tag:"h4",text:this.titlePages[this.currentPage]}),this.nextButton.setValue(this.labelNextButton[this.currentPage]),e.is(this.pages[this.currentPage].isValid)&&this.pages[this.currentPage].isValid()?this.nextButton.enable():this.nextButton.disable(),t===G.IFRAME_DISPLAYED?(this._unmask(),this.modal.setBody([this.alert,this.pages[this.currentPage]]),this.nextButton.hide(),this.cancelButton.hide(),this.modal.elements.wrapper.setStyle("height","unset"),this.modal.elements.content.setStyle("max-height","unset")):t===G.PAGE_DISPLAYED&&(this._unmask(),this.modal.setBody([this.alert,e.createElement("div",{class:"mpf-scroll",html:[this.pages[this.currentPage].render()]})]),this.scroller=new i({element:this.modal.getBody().getElement(".mpf-scroll")}),this.scroller.inject(this.modal.getBody()),this.pages[this.currentPage].scroller=this.scroller))},doBankTransfer(e){let t;const s=this.hasDedicatedPoUploadEvent?j.PURCHASE_ORDER_UPLOADED:j.PAYMENT_COMPLETED;this.serviceRequest===a.IFWELOOP||this.serviceRequest===a.CLICK_AND_BUY||this.serviceRequest===a.SUBSCRIPTIONS?(t=new l({service:this.serviceRequest,model:this.purchaseOrderModel,cart:this.cart,purchaseOrderDocument:this.purchaseOrderDocument,virtualIbans:e}),this.labelNextButton.push(H.get("save")),this.listenTo(t,l.Events.END_PURCHARSE_ORDER_STEP,()=>{this._sendTrackingEvent(z.PAYMENT_COMPLETED),this.closingEvent=s,this._initThanksPurchasingPage({paymentOK:!0})})):(t=new h({service:this.serviceRequest,model:this.purchaseOrderModel,cart:this.cart,purchaseOrderDocument:this.purchaseOrderDocument,linkToBankTransferFAQ:this.linkToBankTransferFAQ}),this.nextButton.hide(),this.listenTo(t,"endPurchaseOrderStep",()=>{this.closingEvent=s,this._sendTrackingEvent(z.PAYMENT_COMPLETED),this._closeModal()}),this.listenTo(t,"showSaveButton",()=>{this.nextButton.setValue(H.get("save")),this.nextButton.enable(),this.nextButton.show()})),this._sendTrackingEvent(z.PAYMENT_INITIATED,{paymentType:z.USE_BANK_TRANSFER}),this.pages.push(t),this.titlePages.push(H.get("checkoutTitle2")),this.idxPages.checkoutPage2=this.pages.length-1},_initThanksPurchasingPage(e){const t=new m({service:this.serviceRequest,paymentOK:!0===e.paymentOK,firstNameUser:this.me.getFirstName(),isClicknbuyEduOrMakers:this.serviceRequest===a.CLICK_AND_BUY&&(this.cart.hasEduItems()||this.cart.hasMakerItems())});this.pages.push(t),this.titlePages.push(H.get("purchaseComplete")),this.idxPages.thanksPage=this.pages.length-1,this.nextButton.hide(),this._resizeModalAfterPayment()},_initButtonListeners:function(e){this.listenTo(e,"valid",this.nextButton.enable.bind(this.nextButton)),this.listenTo(e,"invalid",this.nextButton.disable.bind(this.nextButton))},_initBillingInfoPage:function(){const e=this;let t;this.serviceRequest!==a.CLICK_AND_BUY&&this.serviceRequest!==a.SUBSCRIPTIONS||this.cart.hasEduItems()||this.cart.hasMakerItems()?(t=new u({me:this.me,cart:this.cart,buyerType:this.buyerType,company:this.company,addresses:this.addresses,addressFactory:this.addressFactory,countries:this.countries,service:this.serviceRequest,companyFactory:this.companyFactory,cartPsp:this.cartPsp}),this.labelNextButton.push(H.get("saveBillInfo"))):(t=new y({service:this.serviceRequest,cart:this.cart,company:this.company,companyFactory:this.companyFactory,countries:this.countries,addresses:this.addresses,addressFactory:this.addressFactory,cartPsp:this.cartPsp}),this.labelNextButton.push(H.get("next"))),this.pages.push(t),this.titlePages.push(H.get("billingInformationTitle")),this.idxPages.billingInformationPage=this.pages.length-1,this.listenTo(this.pages[this.idxPages.billingInformationPage],u.Events.INVALID_PAGE,function(){e._unmask()})},_initMatchingCompaniesPage:function(){const e=this.companyFactory.createCollection(N.Types.MATCHING_COMPANIES,this.company.getMatchingCompanies(),{parse:!0,addressFactory:this.addressFactory}),t=new C({cart:this.cart,cartPsp:this.cartPsp,company:this.company,address:this.pages[this.idxPages.billingInformationPage].getBillingAddressModel(),matchingCompanies:e,companyFactory:this.companyFactory,addressFactory:this.addressFactory,countries:this.countries});this.pages.push(t),this.titlePages.push(H.get("billingInformationTitle")),this.labelNextButton.push(H.get("next")),this.idxPages.matchingCompaniesPage=this.pages.length-1},_initCheckoutPage:function(){const e=new d({service:this.serviceRequest,me:this.me,buyerType:this.buyerType,cart:this.cart,cartQuote:this.cartQuote,addresses:this.addresses,buyer:this.buyer,addressFactory:this.addressFactory,cartItemFactory:this.cartItemFactory,softwareAgreement:this.softwareAgreement,onlineServiceAgreement:this.onlineServiceAgreement,tcContractFactory:this.tcContractFactory,cardTokens:this.cardTokens,virtualIbanFactory:this.virtualIbanFactory,shop:this.shopModel,tcDocumentFactory:this.tcDocumentFactory,bankTransferActive:this.bankTransferActive,countries:this.countries,periodicitiesAlreadyPurchased:this.periodicitiesAlreadyPurchased,cartPsp:this.cartPsp,locale:this.locale});this.pages.push(e),this.titlePages.push(H.get("checkoutTitle1")),this.labelNextButton.push(H.get("paymentButton")),this.idxPages.checkoutPage1=this.pages.length-1,this._initCheckoutPageListeners()},_initCheckoutPageListeners(){const e=this.pages[this.idxPages.checkoutPage1];this.listenTo(e,d.Events.QUOTE_DOWNLOADED,this._sendTrackingEvent.bind(this,z.QUOTE_DOWNLOADED)),this.listenTo(e,d.Events.BANK_TRANSFER,this.doBankTransfer),this.listenTo(e,d.Events.PAYMENT_TOKEN,this._paymentByToken),this.listenTo(e,d.Events.STATE_CHANGE,t=>{t===d.States.NEW_ADDRESS_FORM?this.nextButton.hide():t===d.States.LOADING?this.nextButton.disable():(this.nextButton.show(),e.isValid()?this.nextButton.enable():this.nextButton.disable())}),this.listenTo(e,d.Events.DISPLAY_IFRAME,e=>{this.stateMachine.changeState(G.IFRAME_DISPLAYED),this._initIframe(e),this.displayNextPage()}),this.listenTo(e,d.Events.PAYMENT_COUPON_DONE,e=>{this.closingEvent=e?j.PAYMENT_COMPLETED:j.PAYMENT_DECLINED,this.serviceRequest===a.MAKE?this._closeModal():this._initThanksPurchasingPage({paymentOK:e})})},_createModal:function(){this.modal=new c({className:"mpf-configurator-offer",visible:!0,closable:!0,footer:this._initFooterModal(),events:{[c.Events.ON_CLOSE]:this._closeModal.bind(this)}})},_closeModal(){return this._mask(),([j.PAYMENT_COMPLETED,j.PURCHASE_ORDER_UPLOADED].includes(this.closingEvent)?t.resolve():this._resetCartState()).then(()=>{this._unmask(),this._destroyModal(),this._sendTrackingEvent("close"),this._dispatchClosingEvent()}).catch(e=>{console.error(e),this._unmask(),this._displayAlertMessage("error",H.get("errorTryLater"))})},_resetCartState(){const e={};let s,r=!1;const n=this.serviceRequest===a.CLICK_AND_BUY;return this.serviceRequest===a.SUBSCRIPTIONS||n||this.cart.isDirectPurchase()?s=f.States.DRAFT:(s=f.States.SUBMITTED,r=!0),this.cart.get(f.Fields.PURCHASE_ORDER_NUMBER)&&(e[f.Fields.PURCHASE_ORDER_NUMBER]=""),this.cart.get(f.Fields.EXPENSE_FINANCIAL_LINE)&&(e[f.Fields.EXPENSE_FINANCIAL_LINE]=""),s&&this.cart.getState()!==s&&(e[f.Fields.STATE]=s),(r?this.cart.fetchPromise({expand:[f.Expands.CART_ITEMS]}):t.resolve()).then(()=>Object.keys(e).length>0?this.cart.savePromise(e,{patch:!0}):t.resolve())},_destroyModal:function(){window.removeEventListener("message",this._onIframeMessageBinded),this.stopListening(),this.modal.hide().destroy(),this.modal=null},_dispatchClosingEvent(){this.closingEvent?this.dispatchEvent(this.closingEvent,{cart:this.cart}):this.dispatchEvent(j.MODAL_CLOSED),this._sendTrackingEvent(z.CLOSE_CHECKOUT)},_initFooterModal:function(){return this.nextButton=new r({value:this.labelNextButton[this.currentPage],className:"primary",disabled:!0,events:{onClick:this._nextButtonHandler.bind(this)}}),this.cancelButton=new r({value:H.get("cancel"),events:{onClick:this._cancelButtonHandler.bind(this)}}),[this.nextButton,this.cancelButton]},_cancelButtonHandler:function(){const e=this.pages[this.idxPages.checkoutPage1];this.currentPage===this.idxPages.checkoutPage1&&e.state===d.States.NEW_ADDRESS_FORM?e.changeState(d.States.PAGE_DISPLAYED):this._closeModal()},_nextButtonHandler:function(){const t=this.currentPage===this.idxPages.cbTokenRecapPage?H.get("paymentInProgress"):null;return this.nextButton.load(),this._mask(t),this.stateMachine.changeState(G.SAVING_PAGE),this.pages[this.currentPage].save().then(this._getNextPage.bind(this)).then(this.displayNextPage.bind(this)).catch(t=>{if(this.nextButton.load(!1),this._unmask(),!V.prototype.isPrototypeOf(t)){let s;const r="string"==typeof t?t:"";s=t&&e.is(t.errorCode)&&"Error.JapanesNotSupported"===t.errorCode?"請求情報は全て英語でご記入ください。":t&&Object.prototype.isPrototypeOf.call(Error.prototype,t)&&t.message?t.message:e.is(H["error"+r])?H.get("error"+r):H.get("error"),this._displayAlertMessage("error",s)}}).finally(()=>{this.dispatchEvent(j.NEXT_PAGE_OPERATIONS_DONE)})},_getNextPage:function(){const e=this.idxPages.matchingCompaniesPage,t=this.idxPages.billingInformationPage;this.currentPage!==t||this.serviceRequest!==a.CLICK_AND_BUY||this.cart.hasEduItems()||this.cart.hasMakerItems()?this.currentPage!==t&&this.currentPage!==e||this._getResourcesCheckoutPage():this._initMatchingCompaniesPage(),this.stateMachine.changeState(G.PAGE_DISPLAYED)},_getResourcesCheckoutPage:function(){this.currentPage===this.idxPages.matchingCompaniesPage?(this.buyer=this.pages[this.idxPages.matchingCompaniesPage].savedModels.company,this.addresses.add(this.pages[this.idxPages.matchingCompaniesPage].savedModels.address)):(this.buyerType=this.pages[this.idxPages.billingInformationPage].buyerType||P.COMPANY,this.buyer=this.pages[this.idxPages.billingInformationPage].buyer||this.pages[this.idxPages.billingInformationPage].company,this.addresses=this.pages[this.idxPages.billingInformationPage].addresses),this._initCheckoutPage()},_createAlert:function(){return new o({messsageClassName:"error",icon:!0,closable:!0,visible:!0,hideDelay:5e3,maximumVisibleMessages:1,autoHide:!0})},_displayAlertMessage:function(e,t){const s=this,r=this.alert.getMessages();r.length>0&&r.forEach(function(e){s.alert.remove(e)}),this.alert.add({className:e,message:t})},_mask(e){n.mask(this.modal.getBody(),e)},_unmask(){n.unmask(this.modal.getBody())},_isCartPaymentUrlAvailable:function(){return!!this.cart.getPaymentUrl()&&(this.cart.getState()===f.STATUS.paymentInitiated||this.cart.getState()===f.STATUS.paymentRefused)},_createStateMachine:function(){const e=this._isCartPaymentUrlAvailable()?G.IFRAME_DISPLAYED:G.PAGE_DISPLAYED;return new x({state:e,states:[G.PAGE_DISPLAYED,G.IFRAME_DISPLAYED,G.SAVING_PAGE],transitions:[{from:G.PAGE_DISPLAYED,to:G.SAVING_PAGE},{from:G.SAVING_PAGE,to:G.PAGE_DISPLAYED},{from:G.SAVING_PAGE,to:G.IFRAME_DISPLAYED},{from:G.IFRAME_DISPLAYED,to:G.SAVING_PAGE}]})},_sendTrackingPage:function(){const e=q.createPageBuilder({url:"/checkout"}).setTitle("Checkout V1");this._setupTrackerParameters(e),e.send()},_sendTrackingEvent:function(e,t){const s=q.createEventBuilder({category:"Checkout",action:e});this._setupTrackerParameters(s,t),s.send()},_setupTrackerParameters:function(e,t={}){M.addTrackerInformation(e,this.cart),e.addDimension(W.MARKETPLACE_SERVICE,this.serviceRequest).addDimension(W.BUYER_ID,this.buyer.id).addDimension(W.BUYER_TYPE,this.buyerType.name).addDimension(W.PSP,this.cartPsp.getPsp()).addDimension(W.PAYMENT_CARD_TOKEN,t.token).addDimension(W.PAYMENT_METHOD,t.paymentType)},_checkPrototypes:function(t){w.requiredOfPrototype(t.buyerType,P,"options.buyerType must be a BuyerType"),w.requiredOfPrototype(t.me,g,"options.me must be a PersonModel"),w.requiredOfPrototype(t.cart,f,"options.cart must be a CartModel"),w.requiredOfPrototype(t.cartQuote,k,"options.cartQuote must be a CartQuoteModel"),w.requiredOfPrototype(t.cartItemFactory,S,"options.cartItemFactory must be a CartItemFactory"),w.requiredOfPrototype(t.addresses,D,"options.addresses must be an AddressCollection"),w.requiredOfPrototype(t.addressFactory,E,"options.addressFactory must be an AddressFactory"),w.requiredOfPrototype(t.tcContractFactory,A,"options.tcContractFactory must be a TCContractFactory"),w.requiredOfPrototype(t.cardTokens,_,"options.cardTokens must be a PaymentCardTokenCollection"),w.requiredOfPrototype(t.paymentCardTokenFactory,R,"options.paymentCardTokenFactory must be a PaymentCardTokenFactory"),w.requiredOfPrototype(t.virtualIbanFactory,F,"options.virtualIbanFactory must be a VirtualIbanFactory"),w.requiredOfPrototype(t.countries,I,"options.countries must be a CountryCollection"),w.requiredOfPrototype(t.purchaseOrderModel,L,"options.purchaseOrderModel must be a PurchaseOrderModel"),w.requiredOfPrototype(t.purchaseOrderDocument,B,"options.purchaseOrderDocument must be a PurchaseOrderDocumentModel"),w.requiredOfPrototype(t.cartPsp,U,"options.cartPsp must be a PspModel"),w.requiredOfPrototype(t.companyFactory,N,"options.companyFactory must be a CompanyFactory"),t.serviceRequest===a.IFWELOOP||t.serviceRequest===a.SUBSCRIPTIONS?(w.requiredOfPrototype(t.softwareAgreement,T,"options.softwareAgreement must be a SoftwareAgreementModel"),this.softwareAgreement=t.softwareAgreement):t.serviceRequest===a.CLICK_AND_BUY?(w.requiredOfPrototype(t.softwareAgreement,T,"options.softwareAgreement must be a SoftwareAgreementModel"),w.requiredOfPrototype(t.tcDocumentFactory,v,"options.tcDocumentFactory must be a TCDocumentFactory"),this.softwareAgreement=t.softwareAgreement,this.tcDocumentFactory=t.tcDocumentFactory):(w.requiredOfPrototype(t.shopModel,b,"options.shopModel must be a ShopModel"),w.requiredOfPrototype(t.tcDocumentFactory,v,"options.tcDocumentFactory must be a TCDocumentFactory"),this.shopModel=t.shopModel,this.tcDocumentFactory=t.tcDocumentFactory),e.equals(t.buyerType,P.COMPANY)&&w.requiredOfPrototype(t.company,O,"options.company must be a CompanyModel")}});return Q.renderError=K.renderError,Q.onLoad=K.onLoad,Q.displayIbanPaymentRecap=K.displayIbanPaymentRecap,Q.Events=Object.freeze(j),Q}),define("DS/MPFModalConfiguratorComponent/CheckoutLauncherFactory",["UWA/Core","UWA/Class","UWA/Promise","UWA/Utils","UWA/Class/Listener","UWA/Class/Events","DS/MPFDataProxy/MarketplaceConnector","DS/MPFServices/MarketplaceServices","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFModalConfiguratorComponent/ModalConfiguratorComponent","DS/MPFPersonModel/PersonFactory","DS/MPFCartModel/CartFactory","DS/MPFCartQuoteModel/CartQuoteFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFCountryModel/CountryFactory","DS/MPFPurchaseOrderModel/PurchaseOrderFactory","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentFactory","DS/MPFPspModel/PspFactory","DS/MPFShopModel/ShopFactory","DS/MPFAddressModel/AddressFactory","DS/MPFPaymentCardTokenModel/PaymentCardTokenFactory","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartModel","DS/MPFShopModel/ShopModel","DS/MPFBuyer/BuyerType","DS/MPFTCContractModel/SoftwareAgreementFactory","DS/MPFCartPaymentModel/WaitForPaymentFactory"],function(e,t,s,r,n,o,i,a,c,d,h,l,u,p,m,y,C,P,g,f,M,S,D,E,T,A,_){"use strict";var F={PAYMENT_COMPLETED:"paymentCompleted",PAYMENT_DECLINED:"paymentDeclined",PURCHASE_ORDER_UPLOADED:"purchaseOrderUploaded",MODAL_CLOSED:"modalClosed"},O=t.extend(n,o,{init:function(t){t=t||{},this.serviceRequest=e.is(t.serviceRequest)?t.serviceRequest:a.MAKE,this.container=t.container||document.body,this.deferred=s.deferred(),this.promise=this.deferred.promise,this.linkToBankTransferFAQ=t.linkToBankTransferFAQ,this.idCart=t.idCart,this.hasDedicatedPoUploadEvent=t.hasDedicatedPoUploadEvent||this.serviceRequest===a.MAKE},whenReady:function(){return this._fetchResources(this.deferred),this.promise},show:function(){this.modal.render(this.container),this.deferred=s.deferred(),this.promise=this.deferred.promise},_fetchResources:function(e){var t=this;return this._getConnector().then(function(e){return t.onLoadModal=d.onLoad(t.container),t._initFactories(e)}).then(this._getResources.bind(this,e)).catch(this._manageError.bind(this,e))},_getConnector:function(){return i.fetchPromise({service:this.serviceRequest})},_initFactories:function(e){var t=this;return this.factoryDispenser=c.getInstance(e),s.all([this.factoryDispenser.getFactory(c.Types.CART),this.factoryDispenser.getFactory(c.Types.CART_ITEM),this.factoryDispenser.getFactory(c.Types.CART_QUOTE),this.factoryDispenser.getFactory(c.Types.PERSON),this.factoryDispenser.getFactory(c.Types.COUNTRY),this.factoryDispenser.getFactory(c.Types.PAYMENT_CARD_TOKEN),this.factoryDispenser.getFactory(c.Types.TC_CONTRACT),this.factoryDispenser.getFactory(c.Types.TC_DOCUMENT),this.factoryDispenser.getFactory(c.Types.SHOP),this.factoryDispenser.getFactory(c.Types.VIRTUAL_IBAN),this.factoryDispenser.getFactory(c.Types.PURCHASE_ORDER),this.factoryDispenser.getFactory(c.Types.PURCHASE_ORDER_DOCUMENT),this.factoryDispenser.getFactory(c.Types.PSP),this.factoryDispenser.getFactory(c.Types.COMPANY),this.factoryDispenser.getFactory(c.Types.ADDRESS),this.factoryDispenser.getFactory(c.Types.SOFTWARE_AGREEMENT),this.factoryDispenser.getFactory(c.Types.WAIT_FOR_PAYMENT)]).then(function(e){return t.cartFactory=e[0],t.cartItemFactory=e[1],t.cartQuoteFactory=e[2],t.personFactory=e[3],t.countryFactory=e[4],t.paymentCardTokenFactory=e[5],t.tcContractFactory=e[6],t.tcDocumentFactory=e[7],t.shopFactory=e[8],t.virtualIbanFactory=e[9],t.purchaseOrderFactory=e[10],t.purchaseOrderDocumentFactory=e[11],t.pspFactory=e[12],t.companyFactory=e[13],t.addressFactory=e[14],t.softwareAgreementFactory=e[15],t.waitForPaymentFactory=e[16],t.companyFactory.addressFactory=t.addressFactory,t.addressFactory.whenReady()}).catch(function(){return s.reject("error init factories")})},_getResources:function(e){return this.me=this.personFactory.createModel(h.Types.ME),this.cart=this.cartFactory.createModel(l.Types.CART,{id:this.idCart}),this.countries=this.countryFactory.createCollection(m.Types.BUYER),this.cartQuote=this.cartQuoteFactory.createModel(u.Types.CART_QUOTE),this.purchaseOrderModel=this.purchaseOrderFactory.createModel(y.Types.CART_PURCHASE_ORDER),this.cartQuote.parentResourceId=this.idCart,this.purchaseOrderModel.parentResourceId=this.idCart,this.purchaseOrderDocument=this.purchaseOrderDocumentFactory.createModel(C.Types.CART_PURCHASE_ORDER_DOCUMENT),this.purchaseOrderDocument.parentResourceId=this.idCart,this.cartPsp=this.pspFactory.createModel(P.Types.CART_PSP),this.cartPsp.setParentResourceId(this.idCart),this.cardTokens=this.paymentCardTokenFactory.createCollection(M.Types.ME),this.waitForPaymentModel=this.waitForPaymentFactory.createModel(_.Types.CART,null,{parentResourceId:this.idCart}),s.all([this.countries.fetchPromise(),this.me.fetchPromise(),this.cartPsp.fetchPromise(),this.cardTokens.fetchPromise(),this.cart.fetchPromise({expand:[D.Expands.CART_ITEMS]})]).then(this._getShop.bind(this)).then(this._getCompanyAndAddresses.bind(this)).then(this._getOnlineAgreements.bind(this)).then(this._getAvailableServiceCountries.bind(this)).then(this._initModal.bind(this,e))},_getAvailableServiceCountries(){if(this.serviceRequest===a.CLICK_AND_BUY){const e=this.countryFactory.createCollection(m.Types.GENERIC_BUSINESS);return e.fetchPromise().then(()=>{const t=e.reduce((e,t)=>(e.push(t.getIso2()),e),[]),s=this.countries.filter(e=>-1!==t.indexOf(e.getIso2()));this.countries=this.countryFactory.createCollection(m.Types.BUYER,s)})}return s.resolve()},_getShop:function(){return this.serviceRequest!==a.IFWELOOP&&this.serviceRequest!==a.CLICK_AND_BUY&&this.serviceRequest!==a.SUBSCRIPTIONS?(this.shopModel=this.shopFactory.createModel(g.Types.SHOP,{id:this.cart.getShopId()}),this.shopModel.fetchPromise({expand:[E.Expands.SHOP_SERVICES]})):s.resolve()},_getCompanyAndAddresses:function(){return(this.serviceRequest===a.CLICK_AND_BUY||this.serviceRequest===a.IFWELOOP||this.serviceRequest===a.SUBSCRIPTIONS?e.is(this.cart.getCompanyID()):e.is(this.me.getCompany()))?(this.buyerType=T.COMPANY,this._getCompany()):this.serviceRequest!==a.CLICK_AND_BUY||this.cart.hasEduItems()||this.cart.hasMakerItems()?(this.buyerType=T.INDIVIDUAL,this.serviceRequest===a.CLICK_AND_BUY&&this.me.set(S.Fields.BUYER_TYPE,this.buyerType),this.addresses=this.addressFactory.createCollection(f.Types.ME),this.addresses.fetchPromise()):(this.buyerType=T.COMPANY,this.company=this.companyFactory.createModel(p.Types.MATCHING_COMPANIES),this.addresses=this.addressFactory.createCollection(f.Types.COMPANY),s.resolve())},_getCompany:function(){var e,t=this;return e=this.serviceRequest===a.CLICK_AND_BUY||this.serviceRequest===a.IFWELOOP||this.serviceRequest===a.SUBSCRIPTIONS?this.cart.getCompanyID():this.me.getCompany().match(/\/([0-9A-F]{32})$/)[1],this.company=this.companyFactory.createModel(p.Types.COMPANY,{id:e}),this.company.fetchPromise().then(function(){t.addresses=t.company.addresses})},_getOnlineAgreements:function(){return this.serviceRequest!==a.IFWELOOP&&this.serviceRequest!==a.CLICK_AND_BUY&&this.serviceRequest!==a.SUBSCRIPTIONS||(this.softwareAgreement=this.softwareAgreementFactory.createModel(A.Types.AGREEMENTS)),s.resolve()},_initModal:function(e){this.onLoadModal.destroy(),this.modal=new d(this._getOptions()),this.listenTo(this.modal,d.Events.PAYMENT_COMPLETED,function(){this.dispatchEvent(F.PAYMENT_COMPLETED,this.cart)}),this.listenTo(this.modal,d.Events.PAYMENT_DECLINED,function(){this.dispatchEvent(F.PAYMENT_DECLINED,this.cart)}),this.listenTo(this.modal,d.Events.PURCHASE_ORDER_UPLOADED,function(){this.dispatchEvent(F.PURCHASE_ORDER_UPLOADED)}),this.listenTo(this.modal,d.Events.MODAL_CLOSED,function(){this.dispatchEvent(F.MODAL_CLOSED)}),e.resolve()},_getOptions:function(){var e={};return e.locale=r.Client.Locale.lang,e.serviceRequest=this.serviceRequest,e.me=this.me,e.cart=this.cart,e.cartQuote=this.cartQuote,e.cartItemFactory=this.cartItemFactory,e.company=this.company,e.addresses=this.addresses,e.addressFactory=this.addressFactory,e.buyerType=this.buyerType,e.countries=this.countries,e.cardTokens=this.cardTokens,e.purchaseOrderModel=this.purchaseOrderModel,e.virtualIbanFactory=this.virtualIbanFactory,e.paymentCardTokenFactory=this.paymentCardTokenFactory,e.tcContractFactory=this.tcContractFactory,e.bankTransferActive=!0,e.shopModel=this.shopModel,e.companyFactory=this.companyFactory,e.tcDocumentFactory=this.tcDocumentFactory,e.purchaseOrderDocument=this.purchaseOrderDocument,e.cartPsp=this.cartPsp,e.linkToBankTransferFAQ=this.linkToBankTransferFAQ,e.softwareAgreement=this.softwareAgreement,e.waitForPaymentModel=this.waitForPaymentModel,e.isIfweloopSubscriptions=this.isIfweloopSubscriptions,e.hasDedicatedPoUploadEvent=this.hasDedicatedPoUploadEvent,e},_manageError:function(e,t){console.error(t),d.renderError(this.container),e.reject()}});return O.Event=Object.freeze(F),O.Events=Object.freeze(F),O}),define("DS/MPFModalConfiguratorComponent/ModaleCheckoutPrintWrapper",["UWA/Class","UWA/Promise","UWA/Class/Listener","UWA/Class/Events","DS/MPFModalConfiguratorComponent/CheckoutLauncherFactory"],function(e,t,s,r,n){"use strict";return e.extend(s,r,{init:function(e){e=e||{},this.container=e.container||document.body,this.deferred=t.deferred(),this.promise=this.deferred.promise,this.idCart=e.idCart},openModal:function(){this.checkout.show()},whenReady:function(){return this.checkout=new n({service:"3DPrint",container:this.container,idCart:this.idCart}),this.listenTo(this.checkout,"paymentCompleted",function(){this.dispatchEvent("paymentCompleted")}),this.listenTo(this.checkout,"paymentDeclined",function(){this.dispatchEvent("paymentDeclined")}),this.checkout.whenReady()}})}),define("DS/MPFModalConfiguratorComponent/ModaleConfiguratorWrapper",["UWA/Core","UWA/Class","DS/MPFDataProxy/MarketplaceConnector","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFDataProxy/AppsConnector","DS/MPFAppsPlatform/PublicPlatformsDataProxy","DS/MPFAppsPlatform/PlatformCollection","DS/MPFAppsPlatform/ServiceEnum","DS/MPFModalConfiguratorComponent/CheckoutLauncherFactory","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,n,o,i,a,c,d){"use strict";return t.extend({init:function(e){e=e||{},this.platform=e.platform,this.product=e.product,this.productName=e.productName,this.container=e.container||document.body},isActivated:function(){return!0},openModal:function(){this.checkout.show()},whenReady:function(){var e=this;return this._isItFirstPurchase().then(function(t){return e.checkout=new c({service:"3DStore",platform:e.platform,product:e.product,productName:e.productName,container:e.container,firstPurchase:t}),e.checkout.whenReady()})},_isItFirstPurchase:function(){var e,t=this;return this._fetchMarketplaceConnector().then(function(e){var t=r.getInstance(e);return t.getFactory(r.Types.SUBSCRIPTION).then(e=>Promise.all([t.getFactory(r.Types.PORTFOLIO),t.getFactory(r.Types.PRODUCT,{subscriptionFactory:e})])).then(([e,s])=>t.getFactory(r.Types.CATALOGUE,{portfolioFactory:e,productFactory:s}))}).then(function(e){return t.catalogueFactory=e,t.catalogue=t.catalogueFactory.createModel("catalogue",{}),t.catalogue.onlineInstanceId=t.platform,t.catalogue.fetchPromise()}).then(function(){return e=t.catalogue.getProducts(),!e.some(function(e){return e.getProductTrigram()===t.product})})},_fetchMarketplaceConnector:function(){var e,t,r;function c(e){return e.services.get(a.MARKETPLACE.name)}return e=window.location.origin.replace("-ifwe","-apps"),t=new n(e+"/enovia/resources/AppsMngt"),r=new o(t),new i([],{dataProxy:r}).fetchPromise().then(function(e){return e.filter(c).pop()}).then(function(e){var t;return t=e.services.get(a.MARKETPLACE.name).getUrl(),new s(t+="/resources",e.id,{service:"3DStore"})})}})});