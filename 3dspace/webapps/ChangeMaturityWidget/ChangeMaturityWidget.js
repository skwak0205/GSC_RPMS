define("DS/ChangeMaturityWidget/ChangeMaturityWidget",["DS/UIKIT/Input/Text","UWA/Controls/Abstract","UWA/Json","DS/UIKIT/Dropdown","DS/UIKIT/Tooltip","DS/WidgetServices/WidgetServices","DS/DataDragAndDrop/DataDragAndDrop","UWA/Class/Promise","DS/LifecycleServices/LifecycleServicesSettings","DS/WAFData/WAFData","DS/LifecycleServices/LifecycleServices","DS/UIKIT/Iconbar","DS/UIKIT/Spinner","DS/UIKIT/Mask","DS/LifecycleCmd/MaturityCmd","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","DS/LifecycleServices/LifecycleAlert","DS/LifecycleCmd/MessageMediator"],function(t,e,i,s,o,n,r,a,c,h,l,u,p,d,m,v,y,g){"use strict";return e.extend({context:null,init:function(t,e,i,s,o){this.widget=t,this.widget.ChangeMaturityWidget=this,this.parentWidget=e;var n=this;void 0!==i.serviceurl&&i.serviceurl?this.serviceurl=i.serviceurl:this.serviceurl=null,void 0!==i.SecurityContext&&i.SecurityContext?this.securityContext=i.SecurityContext:this.securityContext=null,void 0!==i.EnableApproval&&i.EnableApproval?this.EnableApproval=i.EnableApproval:this.EnableApproval=!1,this.pid=s,this.onDone=o,this._parent(i),this.addEvent("onError",function(t){this.displayError(t)},this),this.addEvent("onStateChanged",function(t){var e={created:[],deleted:[],modified:[]};e.context=n,t.data.forEach(function(t){var i={physicalid:t.physicalid,operation:"Promote",state:t.tostate,policy:n.policy};e.modified.push(i)}),g.dispatchEvent("onModification",e)}),this.container=UWA.createElement("div",{class:"container"}),this.elements={},this.elements.container=this.container,this.wrapper=UWA.createElement("div",{class:"wrapper"}),this.wrapper.inject(this.container),this.spinner=(new p).inject(this.wrapper).show(),c.app_initialization(function(){n.tenant=c.getTenant(),console.log(n.tenant);var t=c.getOption("platform_services",null);null!=t&&t.length>0&&l.getSecurityContextPromise(n.tenant).then(function(t){null==n.securityContext&&(n.securityContext=t),n.executeCmd(n.onDone)})})},executeCmd:function(t){var e={data:[{physicalid:this.pid}]};this.addEvent("onComplete",function(){t()}),this._getMaturityState(e,null,null,this.securityContext,!1)},setStateUI:function(t){this.objects={};var e=this;if(0==t.data.policies.length){console.log("ERROR: No policies in json");var i={errorMsg:"Error: No policies in json",type:"error"};e.dispatchEvent("onError",i)}else{this.policies=t.data.policies;for(var s=!1,n=0;n<t.data.objects.length;n++){var r=t.data.objects[n].physicalid;this.phyid=t.data.objects[n].physicalid;var a=t.data.objects[n];if(this.policy=a.policy,this.objects[r]=a,this.objects[r].signatures={},this.objects[r].routes={},this.objects[r].applyTransition=!0,this.currentState=this.objects[r].currentStateUserName,this.current=this.objects[r].current,void 0!==this.objects[r].isSingleIRPCAssembly&&null!==this.objects[r].isSingleIRPCAssembly&&this.objects[r].hasOwnProperty("isSingleIRPCAssembly")&&(s=s||this.objects[r].isSingleIRPCAssembly),this.objects[r].hasOwnProperty("imageUrl")&&void 0!==this.objects[r].imageUrl&&null!==this.objects[r].imageUrl){var h=this.objects[r].imageUrl;h.startsWith("/")&&(this.objects[r].imageUrl=c.get3DSpaceBaseUrl(window.widget.getValue("x3dPlatformId"))+h)}if(this.objects[r].excludeFromPromote=null!=a.isAggregateRep&&a.isAggregateRep,this.objects[r].excludeFromPromote||null!=a.usage&&"3DPart"==a.usage&&null!=a.isOnceInstantiable&&a.isOnceInstantiable&&(this.objects[r].excludeFromPromote=!0),!0!==this.objects[r].excludeFromPromote){var l=0;for(l=0;l<this.policies.length&&this.policies[l].name!==a.policy;l++);var y=this.policies[l].maturityGraph.transitions,g=this.policies[l].maturityGraph.states;this.correctstates={},this.pos={},this.items=[],this.previousstates=[],this.targetstates=[],this.actions={},this.currentsysstatename="",this.activecolor={},this.inactivecolor={},this.tooltipstate={};for(var f=0;f<g.length;f++)!0===g[f].isCurrent&&(this.setAttribute(r,"current",g[f].stateSysName),this.currentsysstatename=g[f].stateSysName),this.activecolor[g[f].stateSysName]={},this.activecolor[g[f].stateSysName]=g[f].activeColor,this.inactivecolor[g[f].stateSysName]={},this.inactivecolor[g[f].stateSysName]=g[f].inactiveColor,this.tooltipstate[g[f].stateSysName]={},this.tooltipstate[g[f].stateSysName]=g[f].tooltip,this.correctstates[g[f].stateSysName]=g[f].stateUserName,this.pos[g[f].stateSysName]=g[f].visuorder,this.pos[g[f].visuorder]=g[f].stateSysName,this.objects[r].signatures[g[f].stateSysName]={},this.objects[r].routes[g[f].stateSysName]={},this.actions[g[f].stateSysName]={};for(var x=0;x<y.length;x++){var b=y[x].sourceState,C=y[x].targetState,S=y[x].signatures;this.objects[r].routes[b][C]=y[x].hasRoute;var w={};if(0===S.length||S[0].username.includes("emxFramework")&&void 0===S[0].name){var A=v.setTo+' "'+this.correctstates[C]+'"';this.actions[b][C]=A,this.actions[b][A]=C;var E=v.setTo+' "'+this.correctstates[b]+'"';this.actions[C][b]=E,this.actions[C][E]=b}else for(var j=0;j<S.length;j++)w[S[j].name]=S[j],S[j].username.includes("emxFramework")||void 0===S[j].username?(this.actions[b][C]=S[j].name,this.actions[b][S[j].name]=C):(this.actions[b][C]=S[j].username,this.actions[b][S[j].username]=C);this.objects[r].signatures[b][C]=w,b===this.current&&(this.pos[this.current]<this.pos[C]?this.targetstates.push(C):this.previousstates.push(C))}if(0===this.previousstates.length&0!=this.pos[this.current]){var D=this.pos[this.current]-1;this.previousstates.push(this.pos[D]),e.demote=!0}this.nextaction=void 0;for(j=0;j<this.targetstates.length;j++){void 0!==(I=this.actions[this.current][this.targetstates[j]])&&(this.setFontIconColor(this.targetstates[j]),this.fonticon="double-chevron-right"+this.fonticon,this.items.push({fonticon:this.fonticon,text:I,selectable:!0}),void 0===this.nextaction?(this.target=this.targetstates[j],this.nextaction=I):this.pos[this.actions[this.current][I]]<this.pos[this.actions[this.current][this.nextaction]]&&(this.target=this.targetstates[j],this.nextaction=I))}for(j=0;j<this.previousstates.length;j++){var I;void 0!==(I=this.actions[this.current][this.previousstates[j]])&&(this.setFontIconColor(this.previousstates[j]),this.fonticon="double-chevron-left"+this.fonticon,this.items.push({fonticon:this.fonticon,text:I,selectable:!0}))}this.items.push({fonticon:"collaborative-lifecycle-management",text:v.maturity,selectable:!0}),e.setColor(),this.activecolor[this.current].includes("emxFramework")?this.color="#757575":this.color=this.activecolor[this.current],this.content=UWA.createElement("div",{class:"lcm-change-maturity-content"}),this.content.inject(this.wrapper),this.s=UWA.createElement("div",{class:"lcm-state-base1 lcm-state-current1 lcm-state-m1",styles:{backgroundColor:this.color}}),this.text=UWA.createElement("span",{class:"lcm-state-text",html:this.currentState}),"#FFFFFF"==this.color&&(this.s.style.border="1px solid #B4B6BA",this.text.style.color="black"),this.text.inject(this.s),this.s.inject(this.content),this.tooltipstate[this.current].includes("emxFramework")?this.tooltiptext=this.currentState:this.tooltiptext=this.tooltipstate[this.current],this.tooltip=new o({position:"bottom right",target:this.s,body:this.tooltiptext}),void 0!==this.nextaction&&(this.next=UWA.createElement("div",{class:"button next-state-button"}),this.text2=UWA.createElement("span",{class:"lcm-state-text",html:this.nextaction}),this.text2.inject(this.next),this.next.inject(this.content),this.tooltip=new o({position:"bottom right",target:this.next,body:this.nextaction}),this.next.hidden=!0),this.iconDropDown=new u({items:[{fonticon:"down-open",text:v.moreOptions,content:{type:"dropdownmenu",options:{items:this.items,events:{onClick:function(t,i){console.log(i),console.log(i.text);document.getElementsByClassName("lcm-state-text");if(i.text===v.maturity){d.mask(e.wrapper);var s={};s.context={context:e.securityContext,securityContext:{SecurityContext:e.securityContext,tenant:e.tenant},getSecurityContext:function(){return this.securityContext}};var o=new m(s),n=[{physicalid:e.pid,serviceurl:e.serviceurl}];o.executeAsync(n).then(function(){var t=(new p).inject(e.wrapper).show();e.wrapper.getElement(" > .lcm-change-maturity-content").destroy(),e.executeCmd(),t.destroy(),console.log("Maturity  updated"),d.unmask(e.wrapper)})}else{var r=e.actions[e.current][i.text];if(!0===e.demote&&e.pos[r]<e.pos[e.current])var a="demote";else a="promote";d.mask(e.wrapper),console.log(r);var c=e.current;n={data:[{physicalid:e.pid,tostate:r,fromstate:c}]};e._changeMaturity(a,n,e.securityContext)}}}}}}]}),this.iconbarContainer=UWA.createElement("div",{class:"button next-state-button1"}),this.iconDropDown.inject(this.iconbarContainer),this.iconbarContainer.inject(this.content),this.iconbarContainer.hidden=!0,null!=this.spinner.elements&&this.spinner.destroy(),this.next.addEventListener("click",function(){d.mask(e.wrapper);var t={data:[{physicalid:e.pid,tostate:e.target,fromstate:e.current}]};e._changeMaturity("promote",t,e.securityContext)});a.policy}}if(this.isSingleIRPCAssembly=s,e.EnableApproval){require(["DS/RouteWebAppUX/RouteApprovalsIDCardUX"],function(t){let i={};i.id=e.pid;t.init(e.content,i,function(){void 0!==e.nextaction&&(e.next.hidden=!1,e.iconbarContainer.hidden=!1)})},function(){e.next.hidden=!1,e.iconbarContainer.hidden=!1})}else e.next.hidden=!1,e.iconbarContainer.hidden=!1}},_changeMaturity:function(t,e,i){var s,o=this,n="null";if(void 0!==this.serviceurl&&this.serviceurl){var r=this.serviceurl+t;s=r+(r.indexOf("?")<0?"?":"&")+"tenant="+o.tenant}else s=c.get3DSpaceWSUrl(o.tenant,"/resources/lifecycle/maturity/"+t,null);var a=c.getHeaders(encodeURIComponent(i));return a["X-Requested-With"]="XMLHttpRequest",console.log(t+":"),console.log(e),h.authenticatedRequest(s,{method:"POST",type:"json",headers:a,timeout:36e5,data:JSON.stringify(e),onComplete:function(e){console.log(t+": COMPLETED"),console.log(e),n=e;for(var i=e.results,s={data:[]},r=0;r<i.length;r++){var a=o.getAttribute(i[r].physicalid,"current");void 0===a&&(a=i[r].current);var c=i[r].current;o.current=i[r].current,o.updateUI(c),o.setAttribute(i[r].physicalid,"current",i[r].current);var h={physicalid:i[r].physicalid,tostate:c,fromstate:a};s.data.push(h),o._showNotification("success",v.maturitySuccess)}var l={};if("failure"===e.status){var u=e.report,p=u.length,d=[];console.log(u);for(r=0;r<p&&r<10;r++)o.objects[u[r].physicalids]&&o.objects[u[r].physicalids].displayName&&!u[r].error.contains(o.objects[u[r].physicalids].displayName)?d.push(o.objects[u[r].physicalids].displayName+": "+u[r].error):d.push(u[r].error);p>10&&d.push(v.replace(v.maturityAdditionalErrorMessage,{maxErrors:10..toString(),lineBreak:"\n",numErrors:(p-10).toString()})),d+="\n"+v.maturityFailure,l.errorMsg=d,l.type="error",o.dispatchEvent("onError",l),s.data.length>0&&o.dispatchEvent("onStateChanged",s)}else s.data.length>0&&o.dispatchEvent("onStateChanged",s);o.dispatchEvent("onComplete")},onFailure:function(e,i){console.log(t+":Failure..."+e);var s={};s.errorMsg=l.parseWebServiceError(e,i),s.type="error",o.dispatchEvent("onError",s),o.dispatchEvent("onComplete")},onTimeout:function(){console.log(t+": A connection timeout occured.");var e={errorMsg:"connection timeout",type:"warning"};o.dispatchEvent("onError",e),o.dispatchEvent("onComplete")}}),n},getAttribute:function(t,e){return void 0!==this.objects[t]?this.objects[t][e]:void 0},setColor:function(){this.color={},"Draft"===this.currentState||"Prepare"===this.currentState||"PRIVATE"===this.current||"Prepare"===this.current||"Create"===this.current?(this.color="#9B2C98",this.tooltiptext="Being prepared by the owner. It is not visible to anyone else"):"In Work"===this.currentState||"IN_WORK"===this.current||"In Work"===this.current||"Assign"===this.current?(this.color="#007DA3",this.tooltiptext="Actively worked on by the assignee"):"In Approval"===this.currentState||"FROZEN"===this.current||"In Approval"===this.current||"Active"===this.current?(this.color="#018308",this.tooltiptext="Being reviewed by the owner"):"Completed"===this.currentState||"RELEASED"===this.current||"Complete"===this.current||"Closed"===this.current?(this.color="#757575",this.tooltiptext="Work is considered finished"):"Approved"===this.current||"Review"===this.current?(this.color="#E03400",this.tooltiptext="Work is approved by the owner"):(this.color="#E03400",this.tooltiptext="Help unavailable")},setFontIconColor:function(t){this.fonticon={},this.fonticon="Draft"===t||"Prepare"===t||"PRIVATE"===t||"Prepare"===t||"Create"===t?" private":"In Work"===t||"IN_WORK"===t||"In Work"===t||"Active"===t?" inwork":"In Approval"===t||"FROZEN"===t||"In Approval"===t||"Review"===t?" frozen":"Completed"===t||"RELEASED"===t||"OBSOLETE"===t||"Complete"===t||"Closed"===t?" released":"Approved"===t||"Review"===t||"Assign"===t?" approved":""},displayError:function(t,e){var i=t;t.hasOwnProperty("errorMsg")&&(i=null!==t.errorMsg?t.errorMsg:t),void 0===e&&t.hasOwnProperty("type")?e=t.type:void 0===e&&(e="warning"),this._showNotification(e,i),d.unmask(this.wrapper)},updateUI:function(t){var e=this;this.targetstates=[],this.previousstates=[];e.getAttributes(e.phyid);var i=0;for(i=0;i<e.policies.length&&e.policies[i].name!==e.objects[e.phyid].policy;i++);var s=e.policies[i].maturityGraph.transitions;this.policies[i].maturityGraph.states;e.currentState=e.correctstates[t];for(var n=0;n<s.length;n++){var r=s[n].sourceState,a=s[n].targetState;r===t&&(this.pos[t]<this.pos[a]?this.targetstates.push(a):this.previousstates.push(a))}if(0===this.previousstates.length&0!=this.pos[t]){var c=this.pos[t]-1;this.previousstates.push(this.pos[c]),this.demote=!0}this.nextaction=void 0,this.items=[];for(var h=0;h<this.targetstates.length;h++){void 0!==(l=this.actions[this.current][this.targetstates[h]])&&(this.setFontIconColor(this.targetstates[h]),this.fonticon="double-chevron-right"+this.fonticon,this.items.push({fonticon:this.fonticon,text:l,selectable:!0}),void 0===this.nextaction?(this.target=this.targetstates[h],this.nextaction=l):this.pos[this.actions[this.current][l]]<this.pos[this.actions[this.current][this.nextaction]]&&(this.target=this.targetstates[h],this.nextaction=l))}for(h=0;h<this.previousstates.length;h++){var l;void 0!==(l=this.actions[this.current][this.previousstates[h]])&&(this.setFontIconColor(this.previousstates[h]),this.fonticon="double-chevron-left"+this.fonticon,this.items.push({fonticon:this.fonticon,text:l,selectable:!0}))}this.items.push({fonticon:"collaborative-lifecycle-management",text:v.maturity,selectable:!0}),e.setColor(),this.activecolor[t].includes("emxFramework")?this.color="#757575":this.color=this.activecolor[t];var p=document.getElementsByClassName("lcm-state-text");if(this.s.setStyle("backgroundColor",this.color),"#FFFFFF"==this.color?(this.s.style.border="1px solid #B4B6BA",this.text.style.color="black"):(this.s.style.border="",this.text.style.color="white"),p[0].innerHTML=e.currentState,void 0!==this.nextaction?(p[1].hidden=!1,p[1].innerHTML=e.nextaction):p[1].hidden=!0,this.iconDropDown.destroy(),this.iconbarContainer.destroy(),this.tooltip.destroy(),this.tooltipstate[t].includes("emxFramework")?this.tooltiptext=t:this.tooltiptext=this.tooltipstate[t],this.tooltip=new o({position:"bottom right",target:this.s,body:this.tooltiptext}),this.iconDropDown=new u({items:[{fonticon:"down-open",text:"more options",content:{type:"dropdownmenu",options:{items:this.items,events:{onClick:function(t,i){console.log(i),console.log(i.text);document.getElementsByClassName("lcm-state-text");if(i.text===v.maturity){d.mask(e.wrapper);var s={};s.context={context:e.securityContext,securityContext:{SecurityContext:e.securityContext,tenant:e.tenant},getSecurityContext:function(){return this.securityContext}};var o=new m(s),n=[{physicalid:e.pid,serviceurl:e.serviceurl}];o.executeAsync(n).then(function(){e.wrapper.getElement(" > .lcm-change-maturity-content").destroy(),e.executeCmd(),console.log("Maturity  updated"),d.unmask(e.wrapper)})}else{var r=e.actions[e.current][i.text];if(!0===e.demote&&e.pos[r]<e.pos[e.current])var a="demote";else a="promote";d.mask(e.wrapper),console.log(r);var c=e.current;n={data:[{physicalid:e.pid,tostate:r,fromstate:c}]};e._changeMaturity(a,n,e.securityContext)}}}}}}]}),this.iconbarContainer=UWA.createElement("div",{class:"button next-state-button1"}),this.iconDropDown.inject(this.iconbarContainer),this.iconbarContainer.inject(this.content),this.next.hidden=!0,this.iconbarContainer.hidden=!0,d.unmask(this.wrapper),e.EnableApproval){require(["DS/RouteWebAppUX/RouteApprovalsIDCardUX"],function(t){let i={};i.id=e.pid;t.init(e.content,i,function(){void 0!==e.nextaction&&(e.next.hidden=!1,e.iconbarContainer.hidden=!1)})},function(){e.next.hidden=!1,e.iconbarContainer.hidden=!1})}else e.next.hidden=!1,e.iconbarContainer.hidden=!1},getAttributes:function(t){return this.objects[t]},_showNotification:function(t,e){var i=this;Array.isArray(e)||"string"!=typeof e||(e=[e]),Array.isArray(e)&&e.length&&e.forEach(function(e){var s={eventID:t,msg:e.split?e.split("\n").join("<br>"):e};null!=i.context&&"function"==typeof i.context.displayNotification?i.context.displayNotification(s):y.displayNotification(s)})},setAttributes:function(t,e){this.objects[t]=e},setAttribute:function(t,e,i){void 0!==this.objects[t]&&(this.objects[t][e]=i)},_getMaturityState:function(t,e,i,s,o){var n,r=this,a=c.getHeaders(encodeURIComponent(s));if(a["X-Requested-With"]="XMLHttpRequest",void 0!==this.serviceurl&&this.serviceurl){var l=this.serviceurl+"getStateGraph";n=l+(l.indexOf("?")<0?"?":"&")+"tenant="+r.tenant}else n=c.get3DSpaceWSUrl(r.tenant,"/resources/lifecycle/maturity/getStateGraph",null);h.authenticatedRequest(n,{method:"POST",type:"json",headers:a,timeout:36e5,data:JSON.stringify(t),onComplete:function(t){console.log("MaturityInfos: COMPLETED"),console.log(t);var e=t.status,i=e.code;e.hasOwnProperty("errorMsg")&&(null!==e.errorMsg?errCb(e.errorMsg):0===i&&(console.log(t),r.setStateUI(t)))},onFailure:function(t,e){console.log("attributes:Failure..."+t)},onTimeout:function(){var t={errorMsg:"timeout",type:"warning"};console.log(t)}})}})});