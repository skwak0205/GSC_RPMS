define("DS/DMUMeasure/DMUMeasureBaseCmd",["DS/DMUBaseCommands/EXPStateCommand","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/EXPUtils","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUMeasurable/DMUMeasurableElementAgent","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUMeasurable/DMUMeasurable","DS/Web3DUXAssistantTools/Web3DUXAssistantTools","DS/DMUPlayMeasure/DMUMeasure","DS/DMUMeasurable/DMUMeasureEnums","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/LevelSelector/LevelSelector","DS/Core/Events","DS/WebappsUtils/WebappsUtils","DS/Mesh/Mesh","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/Mesh/MeshUtils","DS/DMUBaseExperience/DMUContextManager","DS/ApplicationFrame/CommandsManager","UWA/Core","UWA/Utils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/DMUMeasurable/DMUPreVisuNode3D","DS/Selection/CSOManager","DS/DMUBaseExperience/EXPControllerEvents","DS/DMUMeasurable/DMUSwitchRepService","DS/DMUPlayMeasure/DMUMeasureMainValueDisplayUtils","DS/Tree/TreeNodeModel","i18n!DS/DMUMeasure/assets/nls/DMUMeasure"],function(e,t,a,i,r,s,n,l,o,u,c,d,m,p,h,y,_,M,g,v,D,f,b,S,P,T,C,A,I,E,U,w){"use strict";var R,L;return e.extend({init:function(e,t,i){this._parent(e,t,i),this._bEnablePrevisualization=!0,this._keepDefaultController=!0,this._notPickableList=[],this._removePreviousNonPersistent=!0,this._objAction=!1,"ProgressiveVisuLoading"===this._arguments[0].ID&&(this._measureCommandMode="ProgressiveVisuLoading"),"3dPlayProPointPoint"!==this._arguments[0].ID&&"3dPlay"!==this._arguments[0].ID||(this._measureCommandMode="3dPlay"),this._arguments[1]&&"RemoveNonPersistent"===this._arguments[1].ID&&"false"===this._arguments[1].Value&&(this._removePreviousNonPersistent=!1),this._defaultDistanceTypes=[{key:"PointPoint",value:"Distance"},{key:"PointLine",value:"MinimumDistance"},{key:"PointCurve",value:"MinimumDistance"},{key:"PointArc",value:"MinimumDistance"},{key:"PointCircle",value:"Distance"},{key:"PointPlane",value:"Distance"},{key:"PointCylinder",value:"Distance"},{key:"PointCone",value:"Distance"},{key:"PointSphere",value:"Distance"},{key:"PointSurface",value:"MinimumDistance"},{key:"PointProduct",value:"MinimumDistance"},{key:"LineLine",value:"Angle"},{key:"LineLineParallel",value:"Distance"},{key:"LineCurve",value:"MinimumDistance"},{key:"LineArc",value:"MinimumDistance"},{key:"LineCircle",value:"Distance"},{key:"LinePlane",value:"Angle"},{key:"LinePlaneNormalPerpendicular",value:"Distance"},{key:"LineCylinder",value:"Angle"},{key:"LineCylinderParallel",value:"Distance"},{key:"LineCone",value:"Angle"},{key:"LineConeParallel",value:"Distance"},{key:"LineSphere",value:"Distance"},{key:"LineSurface",value:"MinimumDistance"},{key:"LineProduct",value:"MinimumDistance"},{key:"CurveCurve",value:"MinimumDistance"},{key:"CurveArc",value:"MinimumDistance"},{key:"CurveCircle",value:"Distance"},{key:"CurvePlane",value:"MinimumDistance"},{key:"CurveCylinder",value:"Distance"},{key:"CurveCone",value:"Distance"},{key:"CurveSphere",value:"Distance"},{key:"CurveSurface",value:"MinimumDistance"},{key:"CurveProduct",value:"MinimumDistance"},{key:"ArcArc",value:"MinimumDistance"},{key:"ArcCircle",value:"MinimumDistance"},{key:"ArcPlane",value:"MinimumDistance"},{key:"ArcCylinder",value:"MinimumDistance"},{key:"ArcCone",value:"MinimumDistance"},{key:"ArcSphere",value:"MinimumDistance"},{key:"ArcSurface",value:"MinimumDistance"},{key:"ArcProduct",value:"MinimumDistance"},{key:"CircleCircle",value:"Distance"},{key:"CirclePlane",value:"Distance"},{key:"CircleCylinder",value:"Distance"},{key:"CircleCone",value:"Distance"},{key:"CircleSphere",value:"Distance"},{key:"CircleSurface",value:"Distance"},{key:"CircleProduct",value:"Distance"},{key:"PlanePlane",value:"Angle"},{key:"PlanePlaneParallel",value:"Distance"},{key:"PlaneCylinder",value:"Angle"},{key:"PlaneCone",value:"Angle"},{key:"PlaneCylinderParallel",value:"Distance"},{key:"PlaneConeParallel",value:"Distance"},{key:"PlaneSphere",value:"MinimumDistance"},{key:"PlaneSurface",value:"MinimumDistance"},{key:"PlaneProduct",value:"MinimumDistance"},{key:"CylinderCylinder",value:"Angle"},{key:"CylinderCylinderParallel",value:"Distance"},{key:"CylinderCone",value:"Angle"},{key:"CylinderConeParallel",value:"Distance"},{key:"CylinderSphere",value:"Distance"},{key:"CylinderSurface",value:"Distance"},{key:"CylinderProduct",value:"MinimumDistance"},{key:"ConeCone",value:"Angle"},{key:"ConeConeParallel",value:"Distance"},{key:"ConeSphere",value:"Distance"},{key:"ConeSurface",value:"Distance"},{key:"ConeProduct",value:"MinimumDistance"},{key:"SphereSphere",value:"Distance"},{key:"SphereSurface",value:"Distance"},{key:"SphereProduct",value:"Distance"},{key:"SurfaceSurface",value:"MinimumDistance"},{key:"SurfaceProduct",value:"MinimumDistance"},{key:"ProductProduct",value:"MinimumDistance"}];var r=this;r._switchService=new I({viewer:r._viewer}),r._switchRepInfo={clearTimeout:void 0,lockedNodeIds:[]},r._unlockNodes=function(){r._switchService&&r._switchRepInfo&r._switchRepInfo.lockedNodeIds&&r._switchRepInfo.lockedNodeIds.length&&(r._switchService.unlockNodes({nodeIDsToUnlock:r._switchRepInfo.lockedNodeIds,nodeIDsToUnlockMeshInRAM:r._switchRepInfo.lockedNodeIds}),r._switchRepInfo.lockedNodeIds=[])},r._iconDir=y.getWebappsAssetUrl("DMUMeasure","icons/32/"),!r._bEnablePrevisualization&&a.isEnvActivated("measurepreview",!0)&&(r._bEnablePrevisualization=!0);var s={};""!==window.location.search&&(f.extend(s,b.parseQuery(window.location.search)),s.widgetDomain&&f.extend(s,b.parseQuery(s.widgetDomain))),"MPVLOD"in s&&(r._mPVLOD=!0);var n,l,o,u,c,d,m,p,h,_={},M={},g=!1,D=w.preferences.mainValueDisplayPref,P=D.measureTypes,T=E.MeasureTypes,C=Object.keys(T),A="DMUMeasureMainValueDisplay";d=function(e,t){if(-1!==e.rowID||P||T)for(var a=0;a<C.length;a++)P[C[a]]===e.nodeModel.options.label&&(M[C[a]]=t,g=!0,e.nodeModel.options.grid&&e.nodeModel.options.grid.unitDisplay&&(e.nodeModel.options.grid.unitDisplay=t))},c=function(e,t){if(-1!==e.rowID||P||T)for(var a=0;a<C.length;a++)P[C[a]]===e.nodeModel.options.label&&(_[C[a]]=t,g=!0,e.nodeModel.options.grid&&e.nodeModel.options.grid.measureTypes&&(e.nodeModel.options.grid.measureTypes=t))},m=function(e){var t=localStorage.getItem(A);for(t&&t.length&&(t=JSON.parse(t)),n=0;n<C.length;n++)if(T[C[n]].isDisplayedInPref){if(u=C[n],!(o=t&&t[u]?t[u]:null)||"boolean"!=typeof o.measureTypes&&"boolean"!=typeof o.unitDisplay)o||(o={measureTypes:T[C[n]].defaultMainValueDisplay,unitDisplay:T[C[n]].defaultUnitDisplay});else{var a=o.measureTypes,i=o.unitDisplay;o=[],o={measureTypes:E.getPrefVal(a),unitDisplay:E.getPrefVal(i)}}l=new U({label:P[C[n]],grid:{measureTypes:o.measureTypes,unitDisplay:o.unitDisplay}}),e.addRoot(l)}},p=function(e){for(n=0;n<C.length;n++){u=C[n],M[u]!==T[C[n]].defaultUnitDisplay&&(M[u]=T[C[n]].defaultUnitDisplay,g=!0),_[u]!==T[C[n]].defaultMainValueDisplay&&(_[u]=T[C[n]].defaultMainValueDisplay,g=!0);for(var t=0;t<e.length;t++)if(P[u]===e[t].options.label){e[t].updateOptions({grid:{measureTypes:T[C[n]].defaultMainValueDisplay,unitDisplay:T[C[n]].defaultUnitDisplay}});break}}},h=function(){if(g){var e=localStorage.getItem(A);e&&e.length&&(e=JSON.parse(e));var t={};for(n=0;n<C.length;n++){if(u=C[n],(o=e&&e[u]?e[u]:null)&&("boolean"!=typeof o.measureTypes||"boolean"!=typeof o.unitDisplay)){var a=o.measureTypes,i=o.unitDisplay;o={measureTypes:E.isPrefEnabled(a),unitDisplay:E.isPrefEnabled(i)}}o||(o={measureTypes:E.isPrefEnabled(T[C[n]].defaultMainValueDisplay),unitDisplay:E.isPrefEnabled(T[C[n]].defaultUnitDisplay)}),t[C[n]]={measureTypes:_[u]?E.isPrefEnabled(_[u]):o.measureTypes,unitDisplay:M[u]?E.isPrefEnabled(M[u]):o.unitDisplay}}var r=JSON.stringify(t);return r!==JSON.stringify(e)?(localStorage.setItem(A,r),t):void 0}};var k=[];k.push({text:D.measureCol,dataIndex:"tree",editableFlag:!1}),k.push({text:D.measureTypesCol,dataIndex:"measureTypes",editableFlag:!0,editionPolicy:"EditionOnOver",typeRepresentation:"MainValueEnum",setCellValue:c}),k.push({text:D.unitCol,dataIndex:"unitDisplay",editableFlag:!0,editionPolicy:"EditionOnOver",typeRepresentation:"MainValueEnum",setCellValue:d});var N=S.getPreferenceManager({context:r.getFrameWindow()});N&&(N.removePreferences(["MeasurePreferences"]),N.addPreferences([{nls:w.preferences.measureSectionTitle,id:"MeasurePreferences",type:"section",preferences:[{type:"dataGrid",withTitle:!0,gridTitle:D.mainValuelbl,columnInfo:k,id:"DMUMeasureMainValueDisplayList",enumID:"MainValueEnum",enumVal:[D.yesOption,D.noOption],displayHeight:5,dataModel:T,initGridDataCB:m,refreshDefaultValuesCB:p,updateGridValuesCB:h},{nls:w.preferences.RemovePreviousNonPersistentLbl,id:"DMUMeasureRemovePreviousNonPersistent",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("DMUMeasureRemovePreviousNonPersistent")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("DMUMeasureRemovePreviousNonPersistent"))&&localStorage.setItem("DMUMeasureRemovePreviousNonPersistent",e?"true":"false")}}]}])),v.setAuthoringFeatureTypes("Measure");require(["DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADAlert"],function(e,t){R=e,L=t}),this._initPref(),this._partialMeasureDisplay=[null,null],this._firstSelectionLeafNodes=[],this._secondSelectionLeafNodes=[]},_destroy:function(){var e=S?S.givePreferenceManager({context:this.getFrameWindow()}):null;e&&e.removePreferences(["MeasurePreferences"]),S&&S.unreferencePreferenceManager({context:this.getFrameWindow()}),this._filterUI&&this._filterUI.clear(),this._parent()},_initPref:function(){localStorage.getItem("DMUMeasureCircleRadiusPreferences")||localStorage.setItem("DMUMeasureCircleRadiusPreferences","DisplayDiameter"),localStorage.getItem("DMUMeasureRadiusResultDisplayPreferences")||localStorage.setItem("DMUMeasureRadiusResultDisplayPreferences","CENTER"),localStorage.getItem("DMUMeasure3PointsCircleRadiusResultDisplayPreferences")||localStorage.setItem("DMUMeasure3PointsCircleRadiusResultDisplayPreferences","CENTER"),localStorage.getItem("DMUMeasureArcRadiusPreferences")||localStorage.setItem("DMUMeasureArcRadiusPreferences","DisplayRadius");for(var e=0;e<this._defaultDistanceTypes.length;e++)if(!localStorage.getItem("DMUMeasureDistanceType"+this._defaultDistanceTypes[e].key+"Preferences")){var t=this._defaultDistanceTypes[e].value;localStorage.setItem("DMUMeasureDistanceType"+this._defaultDistanceTypes[e].key+"Preferences",t)}localStorage.getItem("DMUMeasProductDisplayPref")||localStorage.setItem("DMUMeasProductDisplayPref","Volume"),localStorage.getItem("DMUMeasSurfaceDisplayCylinderPref")||localStorage.setItem("DMUMeasSurfaceDisplayCylinderPref","Diameter"),localStorage.getItem("DMUMeasSurfaceDisplayConePref")||localStorage.setItem("DMUMeasSurfaceDisplayConePref","HalfAngle"),localStorage.getItem("DMUMeasSurfaceDisplaySpherePref")||localStorage.setItem("DMUMeasSurfaceDisplaySpherePref","Diameter"),localStorage.getItem("DMUMeasure3PointsDisplayPreferences")||localStorage.setItem("DMUMeasure3PointsDisplayPreferences","AngleBy3Points")},_addChild:function(e,t){t.setPickParent(!0),t.setVisibilityInTree(!1),e.addChild(t)},begin:function(){if(!this._isRunning){var e=D.getCommand(D.getCurrentCmdId(this._ctx),this._ctx),t=e&&e.getRequestedCommandMode?e.getRequestedCommandMode({cmd:"Measure"}):"exclusive";this._mode="shared"===t?"shared":"exclusive"}var a=this;this.getMeasureContainer=function(){var e=v.getReviewContext({viewer:a.getFrameWindow().getViewer()}),t=e.getCurrentSessionMarkup();return t&&t.getActiveFlag()&&t.isVisible()&&!t.isReadOnly()&&t.getCurrentSlide()?t:e.getTransientReviewBag()};var i=P.giveSelectionManager({context:v.getContextViewer({viewer:a.getFrameWindow().getViewer()})});i&&i.setActiveState(!1),this._parent.apply(this,arguments)},setCommandMode:function(e){this._measureCommandMode=void 0,"PickingPointOnly"===e?this._measureCommandMode="3dAuthoringPickPoint":"ProgressiveVisuLoading"===e&&(this._measureCommandMode="ProgressiveVisuLoading"),this._filterUI&&(this._filterUI.clear(),this._filterUI=null)},removeMeasureFromSession:function(e){var t=v.getReviewContext({viewer:this.getFrameWindow().getViewer()});if(t){t.getTransientReviewBag().removeDMUObjects([e]);var a=this.getMeasureContainer();a&&a.getCurrentSlide&&a.getCurrentSlide()&&a.getCurrentSlide().removeDMUObject(e);for(var i=this._createdMeasures.length-1;i>=0;i--)this._createdMeasures[i]===e&&this._createdMeasures.splice(i,1);this._viewer.render()}},beginExecute:function(){this._viewer.currentViewpoint.setDefaultController(!1,"FLY_WALK"),this._bKeepall=!0,this._createdMeasures=[],this._treatPrevisualize=!0;var e=v.getContextViewer({viewer:this.getFrameWindow().getViewer()}),t=v.getReviewContext({viewer:this.getFrameWindow().getViewer()});t?(null!==localStorage.getItem("DMUMeasureRemovePreviousNonPersistent")&&("true"===localStorage.getItem("DMUMeasureRemovePreviousNonPersistent")&&!1===this._removePreviousNonPersistent?this._removePreviousNonPersistent=!0:"false"===localStorage.getItem("DMUMeasureRemovePreviousNonPersistent")&&!0===this._removePreviousNonPersistent&&(this._removePreviousNonPersistent=!1)),!0===this._removePreviousNonPersistent&&t.getTransientReviewBag().removeDMUObjects("DMUMeasure")):n.createReviewContext({context:e}),e.getController&&(this._viewerController=e.getController());var i=!1;"3dPlay"!==this._measureCommandMode&&(i=!0),this._pathElementAgentWithCSO=new s({agentId:"_pathElementAgentWithCSO",frameWindow:this._frmWindow,engWithPSOHSO:!0,multiAcquisition:!1,multiAcquisitionCtrl:!1,pickingMode:"primHybrid",prePickingMode:"primHybrid",valuedFromCSO:!0,saveToCSO:!1,activatePrePicking:!0,acceptedGeometries:[],appli:this,checkAppli:this._checkPicking,displayAppli:this._bEnablePrevisualization?this._previsualize:void 0,switchRepOnPreSelection:i,viewerController:this._viewerController}),this._pathElementAgentWithoutCSO=new s({agentId:"_pathElementAgentWithoutCSO",frameWindow:this._frmWindow,engWithPSOHSO:!0,multiAcquisition:!1,multiAcquisitionCtrl:!1,pickingMode:"primHybrid",prePickingMode:"primHybrid",valuedFromCSO:!1,saveToCSO:!1,activatePrePicking:!0,acceptedGeometries:[],appli:this,checkAppli:this._checkPicking,displayAppli:this._bEnablePrevisualization?this._previsualize:void 0,switchRepOnPreSelection:i,viewerController:this._viewerController}),"ontouchstart"in window&&this._viewer.setMagnifier({activated:!0,dim:83,shiftVector:{x:-50,y:120}}),this._measurable=[],this._measure=null,this._repeatType="None",this._lockedNodes=[],this._lockedMeshInRAM=[],this._overrideSet=null;var l=C.get(),o=!1;if("3dPlay"===this._measureCommandMode)l.length>2&&(this.emptyCSO(),this.emptyHSO(),o=!0);else for(var u=l.length-1;u>=0;u--)if(l[u].pathElement.getLastElement().getDMUType)C.remove(l[u]),o=!0;else if("2D"===this._measureOnGeometryType&&u>0&&l[u].pathElement&&l[0].pathElement){var c=l[0].pathElement.externalPath,d=l[u].pathElement.externalPath;if(c&&d&&c.length>2&&d.length>2)if(c[c.length-2]!==d[d.length-2]){this.emptyCSO(),this.emptyHSO(),o=!0;break}}else{var m,p,h=[];if(this._switchService.retriveNodesFromPath(l[u].pathElement,h),p=l[u].pathElement.getLastElement().sgNode,h&&h.length){for(var y=!1,M=0;M<h.length;M++)if(m=h[M],l[u].pathElement&&l[u].pathElement.getLastElement)if(p&&r.getNodeType(m)&&"cgr"!==this._viewerController.getLoadedStream(m))C.remove(l[u]),o=!0;else if(!p&&null!==this._viewerController.getLoadedStream(m)){y=!0;break}p||y||(C.remove(l[u]),o=!0)}}o&&(l=C.get()),l.length>0&&(this._objAction=!0),"3dAuthoringPickPoint"===this._measureCommandMode&&(this._activeFilter="pointOnly"),this._previousLinePickingMode=this._viewer.renderer.renderer.pickLinesMode,this._previousPointPickingMode=this._viewer.renderer.renderer.pickPointsMode,this._previousForcePickingPoints=this._viewer.renderer.renderer.pickPointsMode,this._viewer.setLinePickingMode(_.PICK_ALWAYS),this._viewer.setPointPickingMode(_.PICK_ALWAYS),this._viewer.setForcePickingPoints(!0),this._viewer.render({onlyPostProcess:!1}),a._sendUsageProbe("command","Measure"),this._parent()},pauseExecute:function(){this._preVisuNode&&this._removePreVisuNode()},endExecute:function(){var e=this;if(e._preVisuNode&&e._removePreVisuNode(),e.cleanNotify(),e._treatPrevisualize=!0,e._lockedMeshInRAM){for(var t=0;t<e._lockedMeshInRAM.length;t++)this._viewerController.unlockRepresentationMeshInRAM(e._lockedMeshInRAM[t]);e._lockedMeshInRAM=[]}if(e._lockedNodes&&(this._viewerController.unlockNodes({ids:e._lockedNodes}),e._lockedNodes=[]),e._undisplayPartialLevel(),e.emptyHSO(),e._parent(),e._pathElementAgentWithCSO=null,e._pathElementAgentWithoutCSO=null,e._measurable=null,e._firstSelectionLeafNodes=[],e._secondSelectionLeafNodes=[],"true"===e._bVisibleMagnifier&&e._viewer.setMagnifier({activated:!1}),this._objAction=!1,e._filterUI&&e._filterUI.setVisibleFlag(!1),e._removeAssistantTools(),e._cleanLevelSelector(),e._measure)if(e._measure._bPrevisualized?(e.removeMeasureFromSession(e._measure),e._measure=e._lastMeasure,e._lastMeasure=null):e._bEnablePrevisualization&&e._unprevisualize(),e._measure&&e._measure.isPartialMeasure()&&e._measure.setPartialMeasure("partial"),"3dPlay"!==e._measureCommandMode&&"Geovia"!==e._arguments[0].ID||"MeasureBetween"===e._measure.getAttribute("sType"))if(e._isCanceled){var a=e.getMeasureContainer();a.getDMUObjects&&a.getDMUObjects("DMUMeasure")&&e._createdMeasures&&a.removeDMUObjects(e._createdMeasures)}else{e._measure.setInEdition(!1),v.getReviewContext({viewer:e.getFrameWindow().getViewer()})&&setTimeout(function(){if(e._measure&&e._measure.getNode()){if(e._createdMeasures&&e._createdMeasures.length){for(var t=0;t<e._createdMeasures.length;t++)e._createdMeasures[t].fireEvent("onDMUObjectInitialized",{dmuObject:e._createdMeasures[t]}),e._createdMeasures[t]._isInCreationState&&(e._createdMeasures[t]._isInCreationState=!1),e._createdMeasures[t]&&e._createdMeasures[t]._assistantTool&&(e._createdMeasures[t]._assistantTool=null);e._createdMeasures=null}e._measure._isInCreationState&&(e._measure._isInCreationState=!1),e._measure&&e._measure._assistantTool&&(e._measure._assistantTool=null),e.addInCSO(e._measure),e._measure=null}},10)}else e.removeMeasureFromSession(e._measure),e._measure=null;else if("Multiple"===e._repeatType&&e._isCanceled){var i=e.getMeasureContainer();i.getDMUObjects&&i.getDMUObjects("DMUMeasure")&&e._createdMeasures&&i.removeDMUObjects(e._createdMeasures)}for(var r=0;r<e._notPickableList.length;r++){var s=e._notPickableList[r];s&&s.getNode()&&e._notPickableList[r].getNode().setPickable(g.PICKABLE)}e._viewer.setLinePickingMode(e._previousLinePickingMode),e._viewer.setPointPickingMode(e._previousPointPickingMode),e._viewer.setForcePickingPoints(e._previousForcePickingPoints),e._viewer.render({onlyPostProcess:!1});var n=P.giveSelectionManager({context:v.getContextViewer({viewer:e.getFrameWindow().getViewer()})});n&&n.setActiveState(!0),e._measure&&e._measure._isInCreationState&&(e._measure._isInCreationState=!1),e._measure&&e._measure._assistantTool&&(e._measure._assistantTool=null),e._viewer.currentViewpoint.setDefaultController(!0,"FLY_WALK")},buildGraph:function(){var e=this.createInitialState("initialState");this.setEnterStateAction(e,this._enterInitialCallback),this.setExitStateAction(e,this._exitInitialCallback);var t=this.getFinalState(),a=this.createState("itemState");this.setEnterStateAction(a,this._enterItemCallback),this.setExitStateAction(a,this._exitItemCallback);var i=this.createState("repeatitemState");this.setEnterStateAction(i,this._enterInitialCallback),this.setExitStateAction(i,this._exitInitialCallback);var r=this.createState("betweenState");this.setEnterStateAction(r,this._enterBetweenCallback),this.setExitStateAction(r,this._exitBetweenCallback);var s=this.createState("repeatbetweenState");this.setEnterStateAction(s,this._enterItemCallback),this.setExitStateAction(s,this._exitItemCallback);var n=this.createState("repeatMultipleMeasBetweenState");this.setEnterStateAction(n,this._enterItemCallback),this.setExitStateAction(n,this._exitItemCallback);var l=this.createState("repeatMultipleMeasItemState");this.setEnterStateAction(l,this._enterItemCallback),this.setExitStateAction(l,this._exitItemCallback);var o=this.createState("threepointsState");this.setEnterStateAction(o,this._enterThreepointsCallback),this.setExitStateAction(o,this._exitThreepointsCallback);var u=this._pathElementAgentWithCSO.cso,c=u._items.length;if(c>1&&this._objAction){var d=!1;if(3===c)for(var m=0;m<c;m++)if(u._items[m].pathElement.getLastElement().sgNode){if(0!==u._items[m].pathElement.getLastElement().sgNode.container.glType){d=!1;break}d=!0}if(d){var p={iEvent:this._pathElementAgentWithCSO,iInitialState:e,iFinalState:t,iAction:this._computeThreepointsCallback};this.addTransition(p)}else if(2===c){var h={iEvent:this._pathElementAgentWithCSO,iInitialState:e,iFinalState:"3dPlay"===this._measureCommandMode?t:r,iAction:this._computeBetweenCallback};this.addTransition(h)}else{var y={iEvent:this._pathElementAgentWithCSO,iInitialState:e,iFinalState:s,iAction:this._computeBetweenCallback};this.addTransition(y)}}var _={iEvent:this._pathElementAgentWithCSO,iInitialState:e,iFinalState:a,iAction:this._computeItemCallback};this.addTransition(_);var M={iSender:this,iEvent:"failure",iInitialState:e,iFinalState:t};if(this.addTransition(M),"3dPlay"===this._measureCommandMode||"Geovia"===this._arguments[0].ID){var g={iEvent:this._pathElementAgentWithoutCSO,iInitialState:a,iFinalState:t,iAction:this._computeBetweenCallback};this.addTransition(g)}else if("Thickness"!==this._arguments[0].ID){var v={iEvent:this._pathElementAgentWithoutCSO,iInitialState:a,iFinalState:r,iAction:this._computeBetweenCallback,iCondition:this._checkForSelection};this.addTransition(v);var D={iEvent:this._pathElementAgentWithoutCSO,iInitialState:l,iFinalState:n,iAction:this._computeItemCallback,iCondition:this._checkForSelection};this.addTransition(D);var f={iEvent:this._pathElementAgentWithoutCSO,iInitialState:n,iFinalState:l,iAction:this._computeBetweenCallback,iCondition:this._checkForSelection};this.addTransition(f)}var b={iSender:this,iEvent:"OK",iInitialState:l,iFinalState:t};this.addTransition(b),this.addEmptySelectionTransition(l,t);var S={iSender:this,iEvent:"failure",iInitialState:l,iFinalState:t};this.addTransition(S);var P={iSender:this,iEvent:"OK",iInitialState:n,iFinalState:t};this.addTransition(P),this.addEmptySelectionTransition(n,t);var T={iSender:this,iEvent:"failure",iInitialState:n,iFinalState:t};this.addTransition(T);var C={iSender:this,iEvent:"OK",iInitialState:a,iFinalState:t};this.addTransition(C);var A={iSender:this,iEvent:"failure",iInitialState:a,iFinalState:t};this.addTransition(A),"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID&&this.addEmptySelectionTransition(a,t);var I={iSender:this,iEvent:"repeatitem",iInitialState:a,iFinalState:i};this.addTransition(I);var E={iSender:this,iEvent:"OK",iInitialState:r,iFinalState:t};this.addTransition(E);var U={iSender:this,iEvent:"failure",iInitialState:r,iFinalState:t};this.addTransition(U),this.addEmptySelectionTransition(r,t);var w={iSender:this,iEvent:"repeatbetween",iInitialState:r,iFinalState:s};this.addTransition(w);var R={iSender:this,iEvent:"repeatbetweenMultiple",iInitialState:r,iFinalState:l};this.addTransition(R);var L={iSender:this,iEvent:"threepoints",iInitialState:r,iFinalState:o};this.addTransition(L);var k={iEvent:this._pathElementAgentWithoutCSO,iInitialState:i,iFinalState:i,iAction:this._computeItemCallback};this.addTransition(k);var N={iSender:this,iEvent:"OK",iInitialState:i,iFinalState:t};this.addTransition(N),this.addEmptySelectionTransition(i,t);var F={iEvent:this._pathElementAgentWithoutCSO,iInitialState:s,iFinalState:s,iAction:this._computeBetweenCallback,iCondition:this._checkForSelection};this.addTransition(F);var O={iSender:this,iEvent:"OK",iInitialState:s,iFinalState:t};this.addTransition(O),this.addEmptySelectionTransition(s,t);var G={iEvent:this._pathElementAgentWithoutCSO,iInitialState:o,iFinalState:o,iAction:this._computeThreepointsCallback};this.addTransition(G);var x={iSender:this,iEvent:"OK",iInitialState:o,iFinalState:t};this.addTransition(x),this.addEmptySelectionTransition(o,t)},_checkPicking:function(e,t){var a=!1;return void 0!==e&&(a=t._isItMeasurable(e)),a},_createMeasurables:function(e){if(e||e.data||e.data.length)for(var t=0;t<e.data.length;t++){var a;e.data[t]&&e.data[t].pathElement&&(a=e.data[t].pathElement.getLastElement().sgNode?new l({primitive:e.data[t].pathElement.getLastElement().sgNode,pathElement:e.data[t].pathElement,selpoint:e.data[t].position,selnormal:e.data[t].normal}):new l({canonic:{type:r.isOOCTileSetNodeInPath(e.data[t].pathElement)?i.GeometryType.PICKINGPT:i.GeometryType.PRODUCT,position:e.data[t].position},pathElement:e.data[t].pathElement,selpoint:e.data[t].position,selnormal:e.data[t].normal}))&&(this._measurable[t]=a)}},_treatSelection:function(e){var t,a=this,s=e&&e.data&&e.data.length?e.data[0]:null;if(s&&s.pathElement){var n=e.callback,o=s.pathElement.getLastElement().sgNode;if(void 0!==o&&function(){var e=!0;if(null!==a._getViewerLoadingMode()){var t=r.getLastRepReference(s.pathElement);if(t){var i=t.getLastElement();r.getNodeType(i)&&"cgr"!==a._viewerController.getLoadedStream(i)&&(e=!1)}}return e}()||e.load&&this._objAction)void 0!==o?this._objAction?(a._createMeasurables(e),a._measurable&&(t=a._measurable[0])):t=new l({primitive:o,pathElement:s.pathElement,selpoint:s.position,selnormal:s.normal}):this._objAction&&(a._createMeasurables(e),a._measurable&&(t=a._measurable[0])),n&&n(t);else if("ProgressiveVisuLoading"===this._measureCommandMode||this._mPVLOD||null!==this._getViewerLoadingMode()){var u=r.isOOCTileSetNodeInPath(s.pathElement);if(!0!==e.load||u)if(s.position){var c=s.position.clone();if(s.pathElement.getWorldMatrix()){var m=(new d.Matrix4).getInverse(s.pathElement.getWorldMatrix());c=c.applyMatrix4(m);var p=i.GeometryType.POINT;"productOnly"===a._activeFilter&&(p=i.GeometryType.PRODUCT),r.isOOCTileSetNodeInPath(s.pathElement)&&(p=i.GeometryType.PICKINGPT),t=new l({canonic:{type:p,position:c},pathElement:s.pathElement,selpoint:s.position,selnormal:s.normal,isApprox:u})}n&&a._viewerController&&n(t)}else n&&n();else if(this._viewerController){var h=[],y=[],_=null,M=r.getLastRepReference(s.pathElement);if(M&&0===M.externalPath.length||!M){_=r.getLastReference(s.pathElement).getLastElement();var g=function(e){if(e)if(r.isRepReference(e))y.push(e);else{var t=[];(t=e.getChildren()).length>0&&t.forEach(function(e){g(e)})}};g(_)}else{_=r.getLastReference(s.pathElement).getLastElement();var v=M.getLastElement();y.push(v)}y.forEach(function(e){h.push({node:e,stream:"cgr"})}),this._switchNodeVisu({nodes_cgr:y,onComplete:function(e){var t=function(){var e=a._viewer.castRay(s.ray,_,"prim"),t=!1;if(e&&e.length>0&&(t=a._pathElementAgentWithCSO._filter(e[0].pathElement)),!0===t){var i=[{pathElement:e[0].pathElement,normal:e[0].normal,position:e[0].point}];a._treatSelection({data:i,load:!1,callback:n})}else if("pointOnly"===a._activeFilter||"productOnly"===a._activeFilter){var r=[];r.push(s),a._treatSelection({data:r,load:!1,callback:n})}},i=[];y.forEach(function(e){i.push(r.getNodeID(e))}),0===a._firstSelectionLeafNodes.length?a._firstSelectionLeafNodes=i.slice():0===a._secondSelectionLeafNodes.length&&(a._secondSelectionLeafNodes=i.slice()),e?a._viewerController.refreshGeometry({ids:i,noMeshInRAM:!1,onComplete:function(){t()},onFailure:function(){if("pointOnly"===a._activeFilter){var e=[];e.push(s),a._treatSelection({data:e,load:!1,callback:n})}}}):t()},onFailure:function(e){if("fullMemory"===e){var t=w.notifyFullMemoryFailure;a._measurable&&a._measurable[0]&&(a._measurable[1]?a._measurable[2]||(t=w.notifyMeasureFailure):t=w.notifyMinDistanceFullMemoryFailure),L&&L.displayNotification({eventID:"error",msg:t}),a.publish({event:"failure",data:null})}else if("pointOnly"===a._activeFilter){var i=[];i.push(s),a._treatSelection({data:i,load:!1,callback:n})}}})}}else{var D=s.position.clone(),f=i.GeometryType.POINT;"productOnly"===a._activeFilter&&(f=i.GeometryType.PRODUCT),r.isOOCTileSetNodeInPath(s.pathElement)&&(f=i.GeometryType.PICKINGPT),t=new l({canonic:{type:f,position:D},pathElement:s.pathElement,selpoint:s.position,selnormal:s.normal}),n&&n(t)}this._objAction=!1}},_selectBestType:function(e,t){var a,i=e.retrievePossibleSelectedType(t);if(this._objAction)a="3dPlay"===e._measureCommandMode?c.ViewedType.POINT:i[0];else if("pointOnly"===e._activeFilter)a=c.ViewedType.POINT;else if("productOnly"===e._activeFilter)a=c.ViewedType.PRODUCT;else{a=i[0];for(var r=!1,s=i.length,n=0;!r&&n<s;n++)for(var l=e._filteredGeometries?e._filteredGeometries.viewedGeometries.length:0,o=0;!r&&o<l;o++)e._filteredGeometries.viewedGeometries[o]===i[n]&&(a=i[n],r=!0)}return a},_removePreVisuNode:function(){this._preVisuNode&&(r.getSceneRoot(this._viewer).remove(this._preVisuNode),this._viewer.render(),this._preVisuNode.removeChildren(),this._preVisuNode.remove(),this._preVisuNode=void 0)},_preVisualizeMeasure:function(e,t){var a=this;e&&e.pathElement?t._treatSelection({data:[e],load:!1,callback:function(e){if(e){var i=t._selectBestType(t,e);e.resultType=t.retrieveItemResultType(e.getType(),i),e.drawMode="Measure","2D"===a._measureOnGeometryType&&(e.scale2D=1),a._preVisuNode?a._preVisuNode.buildPreVisuNode({data:e}):(a._preVisuNode=new T(a._viewer),a._preVisuNode.buildPreVisuNode({data:e}),a._preVisuNode.setNoZ(!0),a._preVisuNode.setPickable(g.PICKTHROUGH),a._viewer&&(r.getSceneRoot(a._viewer).add(a._preVisuNode),a._viewer.render())),a._preVisuNode.setVisibility(a._viewer.getVisibleSpace())}return!0}}):a._preVisuNode&&a._removePreVisuNode()},_previsualize:function(e,t){if("Thickness"!==t._arguments[0].ID)return t._preVisualizeMeasure(e,t);t._bStartPrevisualize&&(t._bStartPrevisualize=!1),t._measure?"initialState"!==t._stateId&&"repeatitemState"!==t._stateId||t._treatPrevisualize&&e.pathElement&&(t._treatPrevisualize=!1,t._treatSelection({data:[e],load:!0,callback:function(e){if(e){var a=t._selectBestType(t,e);if(t._measure.setMeasurable(1,e),t._measure.setAttribute("sSelectedType1",a),t._measure.setAttribute("sResultingType1",t.retrieveItemResultType(t._measure.getMeasurable(1).getType(),a)),t._measure.update(),"MeasureThickness"===t._measure._sType){var i=t._measure.getMeasurable(1),r=t._measure.getMeasurable(2);if(i&&r){var s=r.getPrimitive();if(s){for(var n=new m,l=[],o=THREEDS.SubElement.getFromSGNode(s);null!==o;)l.unshift(o),o=o.getParent();n.setFromArray(i.getPathElement().externalPath,l),t.addInHSO({path:n},!1)}}}t._measure.getNode()&&t._measure.getNode().setPickable(g.PICKTHROUGH),t._notPickableList.push(t._measure)}return t._treatPrevisualize=!0,!0}})):t._treatPrevisualize&&e.pathElement&&(t._treatPrevisualize=!1,t._treatSelection({data:[e],load:!0,callback:function(e){if(e){t._measurable[0]=e;var a=t._selectBestType(t,t._measurable[0]);t._createMeasure(a),t._measure._bPrevisualized=!0,t._measure.getNode().update(!0,!0),t._measure.getNode().setPickable(g.PICKTHROUGH),t._notPickableList.push(t._measure)}return t._treatPrevisualize=!0,!0}}))},_unprevisualize:function(){"Thickness"===this._arguments[0].ID&&this._measure.getNode().setPickable(g.PICKABLE)},_enterInitialCallback:function(){var e=w.notifyinitial;"2D"===this._measureOnGeometryType&&(e=w.notifyinitial2D),"3dPlay"===this._measureCommandMode||"Geovia"===this._arguments[0].ID?e=w.notifyinitialpt:"Thickness"===this._arguments[0].ID?e=w.notifythickness:"3dAuthoringPickPoint"===this._measureCommandMode&&(e=w.notifyinitialptauth),"Item"===this._repeatType&&(e=w.notifyrepeatitem,"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID||(e=w.notifyrepeatitempt),this._createAssistantTools({bOK:"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID,bKeeponlylast:"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID}),"productOnly"===this._activeFilter&&"ProgressiveVisuLoading"!==this._measureCommandMode&&this._createLevelSelector(!0)),this.sendNotify("info",e),this._filterUI&&"3dPlay"!==this._measureCommandMode&&"Thickness"!==this._arguments[0].ID&&"Geovia"!==this._arguments[0].ID&&"3dAuthoringPickPoint"!==this._measureCommandMode&&this._filterUI.setVisibleFlag(!0),this._bStartPrevisualize=this._bEnablePrevisualization},_exitInitialCallback:function(){this.cleanNotify(),"Item"===this._repeatType&&(this._removeAssistantTools(),this._cleanLevelSelector()),this._filterUI&&this._filterUI.setVisibleFlag(!1)},_computeItemCallback:function(e,t){this._measure&&this._measure._bPrevisualized&&(this.removeMeasureFromSession(this._measure),this._measure=void 0),this._removePreVisuNode(),"Item"!==this._repeatType&&"Multiple"!==this._repeatType||this._measure&&(this._measure.setInEdition(!1),this._bKeepall||this.removeMeasureFromSession(this._measure),this._measure=void 0);var a=this,i=function(){a._treatSelection({data:t,load:!0,callback:function(t){if(t){a._measurable[0]=t;var i=a._selectBestType(a,a._measurable[0]);"Multiple"===a._repeatType&&(a._measurable[0]&&a._measurable[0].setTypeWithSelFilter&&a._measurable[0].setTypeWithSelFilter(i),a._measurable[1]&&a._measurable.splice(1,a._measurable.length-1)),"Geovia"===a._arguments[0].ID&&(a._measurable[0]=a._transformMeasureToPoint(a._measurable[0]));var s=[],n=[],l=!0,o=[],u=r.getLastRepReference(a._measurable[0].getPathElement());null!==u&&0!==u.getLength()||(u=r.getLastReference(t.getPathElement()));var c=!1;if("2D"!==a._measureOnGeometryType&&(c=!0,u&&u.getLastElement()&&u.getLastElement().getUserData)){let e=u.getLastElement().getUserData();e&&"DesignSight"===e.type&&(c=!1)}if(c&&u&&l)if("DynamicRep"===a._getViewerLoadingMode()){if(l=a._lockNodes(u.getLastElement(!0),s,a._measurable[0].getPathElement().getParentPath()),s.lentgh)for(var d=0;d<s.length;d++)n.push(r.getNodeID(s[d].getLastElement(!0)))}else"ProgressiveFull"!==a._getViewerLoadingMode()&&"ProgressiveLarge"!==a._getViewerLoadingMode()||(l=a._getNodesToSwitchInRAM(u.getLastElement(!0),[],o,n));var m=function(t){!a._measure&&t&&a._createMeasure(i),a._measure&&!l&&a._measure.setPartialMeasure("partialCmd"),a._lockNodeFromMeasurable(a._measurable[0]),"3dPlay"!==a._measureCommandMode&&"Geovia"!==a._arguments[0].ID||(a._measure.setAttribute("bCollapsedDisplay",!0),a._measure.isMeasureDisplayed()&&a._measure.refreshNode()),a._viewer.render(),a.assistantTools&&a._measure&&a.assistantTools.updatePosition(a._measure.getAttribute("vFirstExtensionPoint3D")),a._bStartPrevisualize=a._bEnablePrevisualization,e(),a.emptyHSO(),a._measurable&&a._addElementToHSO(a._measurable[0])};if(l||"ProgressiveFull"!==a._getViewerLoadingMode()&&"ProgressiveLarge"!==a._getViewerLoadingMode()){var p=o.concat(n);if(p.length>0){var h=function(){for(var e=0;e<p.length;e++)-1===a._lockedMeshInRAM.indexOf(p[e])&&(a._viewerController.lockRepresentationMeshInRAM(p[e]),a._lockedMeshInRAM.push(p[e])),-1===a._lockedNodes.indexOf(p[e])&&(a._viewerController.lockNodes({ids:[p[e]]}),a._lockedNodes.push(p[e]))};if(0===o.length)h(),"Multiple"===a._repeatType?m(!1):m(!0);else{var y=0,_=v.getContextViewer({viewer:a.getFrameWindow().getViewer()}),M=_.subscribe({event:"onRepresentationLoaded"},function(e){-1!==o.indexOf(e)&&y++,y===o.length&&(_.unsubscribe(M),setTimeout("Multiple"===a._repeatType?m(!1):m(!0),0))});h()}}else"Multiple"===a._repeatType?m(!1):m(!0)}else m(!1)}}})};if(a._objAction){for(var s=[],n=0;n<t.length;n++){if(t[n].pathElement)if(!t[n].pathElement.getLastElement().sgNode){var l=[];a._switchService.retriveNodesFromPath(t[n].pathElement,l),l.forEach(function(e){e&&"thumbnail"===a._viewerController.getLoadedStream(e)&&s.push(e)})}}s.length?a._switchService.switchToAV1({nodes:s,lockNodesAfterSwitch:!0,lockMeshInRAMAfterSwitch:!0,onCompleteCB:function(e){a._switchRepInfo.clearTimeout=void 0;var t=e.nodeIDsOfLockedNodes;t&&t.length>0&&(a._switchRepInfo.lockedNodeIds||(a._switchRepInfo.lockedNodeIds=[]),t.forEach(function(e){-1===a._switchRepInfo.lockedNodeIds.indexOf(e)&&a._switchRepInfo.lockedNodeIds.push(e)})),i()},onFailureCB:function(){a._switchRepInfo.clearTimeout=void 0}}):i()}else i()},_createMeasure:function(e){var t=this.getMeasureContainer(),a=this._arguments[0].ID;this._measure=new u(this._viewer,t,a),this._measure._isInCreationState=!0,this._measure._assistantTool=null,this._createdMeasures.push(this._measure),"Thickness"===this._arguments[0].ID?(this._measure.setAttribute("sType","MeasureThickness"),this._measure.setAttribute("sName",t.computeNewName({object:this._measure,prefix:w.measurethicknessname}))):(this._measure.setAttribute("sType","MeasureItem"),this._measure.setAttribute("sName",t.computeNewName({object:this._measure,prefix:w.measureitemname})),this._measureOnGeometryType&&(this._measure.setAttribute("sMeasureOnGeometryType",this._measureOnGeometryType),"Extended"===localStorage.getItem("DMUMeasureDisplayPreference")&&this._measure.setAttribute("bShortDisplay",!1))),this._measure.setAttribute("iExtensionLinesManipulable",1),this._measure.setAttribute("sID",t.computeNewID()),this._measure.setAttribute("sUuid",b.getUUID()),this._measure.setInEdition(!0),this._measure.setAttribute("sSelectedType1",e),this._measureItem(),this._measure.setAttributes([{name:"sLeaderStylePattern",value:"1"},{name:"fLeaderStyleThicknessIndex",value:0},{name:"cLeaderStyleColor",value:new d.Color("#3d3d3d")}]),this._measure.fireEvent("onDMUObjectInitialized",{dmuObject:this._measure}),t.addDMUObject?t.addDMUObject(this._measure):t.getCurrentSlide&&t.getCurrentSlide()&&t.getCurrentSlide().addDMUObject(this._measure),this._measure.isMeasureDisplayed()&&this._measure.refreshNode(),this._measure.setInEdition(!1)},_transformMeasureToPoint:function(e){var t,a=e,r=e.getType();if(r===i.GeometryType.CYLINDER||r===i.GeometryType.CONE){var s=e.getSelPoint(),n=e.getPoints(),o=e.getAxis(),u=M.computePointLineDistance(s.toArray(),n.beginPoint.toArray(),o.toArray()).aPosition;t={type:i.GeometryType.POINT,position:new d.Vector3(u[0],u[1],u[2])},a=new l({canonic:t,pathElement:e.getPathElement()})}else r!==i.GeometryType.CIRCLE&&r!==i.GeometryType.SPHERE||(t={type:i.GeometryType.POINT,position:e.getCenter()},a=new l({canonic:t,pathElement:e.getPathElement()}));return a},_enterItemCallback:function(){var e=w.notifyitem;"3dPlay"===this._measureCommandMode||"Geovia"===this._arguments[0].ID?e=w.notifyitempt:"3dAuthoringPickPoint"===this._measureCommandMode&&(e=w.notifyrepeatbetweenpt),"None"!==this._repeatType&&(e="3dPlay"===this._measureCommandMode||"Geovia"===this._arguments[0].ID?w.notifyrepeatbetweenpt:"Multiple"===this._repeatType?this._measure&&"MeasureBetween"===this._measure.getMeasureType()?w.notifyrepeatbtwnmultimeasfirstsel:w.notifyrepeatbtwmultimeassecondsel:w.notifyrepeatbetween),this.sendNotify("info",e);var t="DMUMeasure";this._measure&&this._measure.getMeasureType&&(t=this._measure.getMeasureType());var i=!0;"Multiple"!==this._repeatType||"DMUMeasure"!==t&&"MeasureItem"!==t||(i=!1,this._measurable[0]&&(this._vAssistantPosition=this._measurable[0].getSelPoint().clone(),this._measure&&this._measure.movePosDownByPixels&&(this._vAssistantPosition=this._measure.movePosDownByPixels({position:this._measurable[0].getSelPoint().clone(),pixels:45})))),this._createAssistantTools({bOK:"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID,bRepeatitem:"None"===this._repeatType&&"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID,bKeeponlylast:"None"!==this._repeatType&&"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID&&i}),"productOnly"===this._activeFilter&&"ProgressiveVisuLoading"!==this._measureCommandMode&&this._createLevelSelector(!0),this._filterUI&&"3dPlay"!==this._measureCommandMode&&"Thickness"!==this._arguments[0].ID&&"Geovia"!==this._arguments[0].ID&&"3dAuthoringPickPoint"!==this._measureCommandMode&&this._filterUI.setVisibleFlag(!0),a.isEnvActivated("measurecsomanagement",!0)||this.addInCSO(this._measure)},_exitItemCallback:function(){this.cleanNotify(),this._cleanLevelSelector(),this._measure&&this._measure._bPrevisualized&&(this.removeMeasureFromSession(this._measure),this._measure=this._lastMeasure,this._lastMeasure=null),this._filterUI&&this._filterUI.setVisibleFlag(!1),this._removeAssistantTools()},_computeBetweenCallback:function(e,t){var a=this.getMeasureContainer(),s=this;s._removePreVisuNode(),this._lastMeasure&&(this.removeMeasureFromSession(this._lastMeasure),this._measure._bPrevisualized=!1),"Multiple"!==this._repeatType&&"Chain"!==this._repeatType&&"Fan"!==this._repeatType||(this._measure&&this._measure.setInEdition(!1),this._bKeepall&&"Multiple"!==this._repeatType||this.removeMeasureFromSession(this._measure),this._duplicateMeasureForRepeat(this._repeatType));var n=function(){s._treatSelection({data:t,load:!0,callback:function(n){if(s._unlockNodes(),n){s._objAction||(s._measurable[1]=n),"productOnly"!==s._activeFilter||"Multiple"!==s._repeatType&&"Chain"!==s._repeatType&&"Fan"!==s._repeatType||s._createLevelSelector(!1),"Geovia"===s._arguments[0].ID&&(s._measurable[1]=s._transformMeasureToPoint(s._measurable[1]));var l=function(){if(s._objAction){for(var r=0;r<t.length-1;r++){var n=s.getMeasureContainer(),l=s._arguments[0].ID;s._measure=new u(s._viewer,n,l),s._measure._isInCreationState=!0,s._createdMeasures.push(s._measure),s._measure.setMeasurable(1,s._measurable[r+0]),s._measure.setAttribute("sResultingType1",s.retrieveItemResultType(s._measure.getMeasurable(1).getType(),s._measure.getAttribute("sSelectedType1"))),s._measure.setAttribute("sSelectedType1",s._selectBestType(s,s._measurable[r+0])),s._measure.fireEvent("onDMUObjectInitialized",{dmuObject:s._measure}),n.addDMUObject?n.addDMUObject(s._measure):n.getCurrentSlide&&n.getCurrentSlide()&&n.getCurrentSlide().addDMUObject(s._measure),s._measure.isMeasureDisplayed()&&s._measure.refreshNode(),s._measure.setAttribute("sType","MeasureBetween"),s._measure.setAttribute("sName",a.computeNewName({object:s._measure,prefix:w.measurebetweenname})),s._measure.setAttribute("iExtensionLinesManipulable",r+1),s._measure.setAttribute("sSelectedType2",s._selectBestType(s,s._measurable[r+1])),"3dPlay"!==s._measureCommandMode&&"Geovia"!==s._arguments[0].ID||s._measure.setAttribute("bCollapsedDisplay",!1),s._measure.setMeasurable(2,s._measurable[r+1]),s._measureOnGeometryType?s._measure.setAttribute("sMeasureOnGeometryType",s._measureOnGeometryType):(s._measurable[r]._type!==i.GeometryType.CYLINDER&&s._measurable[r]._type!==i.GeometryType.CONE||s._measure.setAttribute("sSelectedType1",c.ViewedType.AXIS),s._measurable[r+1]._type!==i.GeometryType.CYLINDER&&s._measurable[r+1]._type!==i.GeometryType.CONE||s._measure.setAttribute("sSelectedType2",c.ViewedType.AXIS)),s._measureBetween()}var o=s._measurable.length;o>2&&(s._measurable.splice(0,o-2),s._repeatType="Chain")}else s._measure.setAttribute("sType","MeasureBetween"),s._measure.setAttribute("sName",a.computeNewName({object:s._measure,prefix:w.measurebetweenname})),s._measure.setAttribute("iExtensionLinesManipulable",1),s._measureOnGeometryType&&s._measure.setAttribute("sMeasureOnGeometryType",s._measureOnGeometryType),s._measure.setAttribute("sSelectedType2",s._selectBestType(s,s._measurable[1])),"3dPlay"!==s._measureCommandMode&&"Geovia"!==s._arguments[0].ID||s._measure.setAttribute("bCollapsedDisplay",!1),s._measureBetween();void 0!==s._measure.getAttribute("fDistance")||void 0!==s._measure.getAttribute("fAngle")?(s._lockNodeFromMeasurable(s._measurable[1]),s.assistantTools&&s.assistantTools.updatePosition(s._vAssistantPosition),"partialCmd"===s._measure.isPartialMeasure()&&s._displayPartialLevel(),e(),s.emptyHSO(),s._measurable&&(s._addElementToHSO(s._measurable[0]),s._addElementToHSO(s._measurable[1]))):(L&&L.displayNotification({eventID:"error",msg:w.notifyMinDistanceFailure}),s.removeMeasureFromSession(s._measure),s.publish({event:"failure",data:null}))};if("ProgressiveFull"!==s._getViewerLoadingMode()&&"ProgressiveLarge"!==s._getViewerLoadingMode()||!s._measurable[0].isPartial()||r.isOOCTileSetNodeInPath(t[0].pathElement))s._measurable[0].setPartial(!1),l();else{var o=s._firstSelectionLeafNodes.concat(s._secondSelectionLeafNodes);if(s._lockedMeshInRAM){var d=[];s._lockedMeshInRAM.forEach(function(e){-1===o.indexOf(e)?s._viewerController.unlockRepresentationMeshInRAM(e):d.push(e)}),s._lockedMeshInRAM=[],s._lockedMeshInRAM=d.slice()}if(s._lockedNodes){var m=[],p=[];s._lockedNodes.forEach(function(e){-1===o.indexOf(e)?p.push(e):m.push(e)}),s._viewerController.unlockNodes({ids:p}),s._lockedNodes=[],s._lockedNodes=m.slice()}s._callMinMaxIndexService({onComplete:function(){s._measure.setPartialMeasure(!1),l()},onFailure:function(e){if("fullMemory"===e.cause)if(e.setALoadedState&&e.setBLoadedState){if("partial"===e.setALoadedState){var t=s._measurable[0].getPathElement(),a=s._measurable[0].getLevel();a&&(t=r.truncatePathElement(t,a)),s._partialMeasureDisplay[0]={path:t,lockedNodes:[],opacity:1}}if("partial"===e.setBLoadedState){var i=s._measurable[1].getPathElement(),n=s._measurable[1].getLevel();n&&(i=r.truncatePathElement(i,n)),s._partialMeasureDisplay[1]={path:i,lockedNodes:[],opacity:1}}s._measure.setPartialMeasure("partialCmd"),s._measurable[0].setLevel(null),s._measurable[0].setPartial(!1),s._measurable[1].setLevel(null),s._measurable[1].setPartial(!1),l(),L&&L.displayNotification({eventID:"error",msg:w.notifyRequestedMinDistanceFullMemoryFailure})}else L&&L.displayNotification({eventID:"error",msg:w.notifyMinDistanceFullMemoryFailure}),s.removeMeasureFromSession(s._measure),s.publish({event:"failure",data:null});else L&&L.displayNotification({eventID:"error",msg:w.notifyMinDistanceFailure}),s.removeMeasureFromSession(s._measure),s.publish({event:"failure",data:null})}})}}}})};if(s._objAction){for(var l=[],o=0;o<t.length;o++){if(t[o].pathElement)if(!t[o].pathElement.getLastElement().sgNode){var d=[];s._switchService.retriveNodesFromPath(t[o].pathElement,d),d.forEach(function(e){e&&"thumbnail"===s._viewerController.getLoadedStream(e)&&l.push(e)})}}l.length?s._switchService.switchToAV1({nodes:l,lockNodesAfterSwitch:!0,lockMeshInRAMAfterSwitch:!0,onCompleteCB:function(e){s._switchRepInfo.clearTimeout=void 0;var t=e.nodeIDsOfLockedNodes;t&&t.length>0&&(s._switchRepInfo.lockedNodeIds||(s._switchRepInfo.lockedNodeIds=[]),t.forEach(function(e){-1===s._switchRepInfo.lockedNodeIds.indexOf(e)&&s._switchRepInfo.lockedNodeIds.push(e)})),n()},onFailureCB:function(){s._switchRepInfo.clearTimeout=void 0}}):n()}else n()},_duplicateMeasureForRepeat:function(e){var t;"Chain"===e?(this._measurable[0]=this._measurable[1].clone(),t=this._measure.getAttribute("sSelectedType2")):"Fan"===e?(this._measurable[0]=this._measurable[0].clone(),t=this._measure.getAttribute("sSelectedType1")):"Multiple"===e&&this._measurable[0]&&this._measurable[0].getTypeWithSelFilter&&(t=this._measurable[0].getTypeWithSelFilter()),this._createMeasure(t)},_enterBetweenCallback:function(){this.sendNotify("info",w.notifybetween);var e=this._measure.getAttribute("sSelectedType1")===c.ViewedType.POINT&&this._measure.getAttribute("sSelectedType2")===c.ViewedType.POINT,t=!0,i=this._pathElementAgentWithCSO.cso;this._objAction&&i._items.length>2&&(t=!1),this._createAssistantTools({bOK:!0,bRepeatbetweenMultipleMeas:t&&"Multiple"!==this._repeatType&&"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID,bRepeatbetweenChain:t&&"Chain"!==this._repeatType&&"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID,bRepeatbetweenFan:t&&"Fan"!==this._repeatType&&"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID,bThreepoints:e&&"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID}),"productOnly"===this._activeFilter&&"ProgressiveVisuLoading"!==this._measureCommandMode&&this._createLevelSelector(!1),a.isEnvActivated("measurecsomanagement",!0)||this.addInCSO(this._measure)},_exitBetweenCallback:function(){this.cleanNotify(),this._cleanLevelSelector(),this._removeAssistantTools()},_enterThreepointsCallback:function(){var e="Angle"===this._threepoints?w.notify3pointsangle:"Angle"===this._threepoints?w.notify3pointscircle:w.notify3points;this.sendNotify("info",e)},_exitThreepointsCallback:function(){this.cleanNotify()},_computeThreepointsCallback:function(e,t){var i=this;i._removePreVisuNode(),this._treatSelection({data:t,load:!0,callback:function(t){if(t){if(i._objAction){var a=i.getMeasureContainer(),r=i._arguments[0].ID;i._measure=new u(i._viewer,a,r),i._measure._isInCreationState=!0,i._createdMeasures.push(i._measure),i._measure.setMeasurable(1,i._measurable[0]),i._measure.setAttribute("sResultingType1",i.retrieveItemResultType(i._measure.getMeasurable(1).getType(),i._measure.getAttribute("sSelectedType1"))),i._measure.setAttribute("sSelectedType1",i._selectBestType(i,i._measurable[0])),i._measure.fireEvent("onDMUObjectInitialized",{dmuObject:i._measure}),a.addDMUObject?a.addDMUObject(i._measure):a.getCurrentSlide&&a.getCurrentSlide()&&a.getCurrentSlide().addDMUObject(i._measure),i._measure.isMeasureDisplayed()&&i._measure.refreshNode(),i._measure.setMeasurable(2,i._measurable[1])}else i._measurable[2]=t;var s=i.getMeasureContainer();s&&(i._measure.setAttribute("sType","AngleBy3Points"===localStorage.getItem("DMUMeasure3PointsDisplayPreferences")?"Measure3PointsAngle":"Measure3PointsCircle"),i._measure.setAttribute("sName",s.computeNewName({object:i._measure,prefix:w.measurethreepointsname})),i._measure.setAttribute("iExtensionLinesManipulable",1),i._measureOnGeometryType&&i._measure.setAttribute("sMeasureOnGeometryType",i._measureOnGeometryType)),i._createAssistantTools({bOK:!0}),i._measureThreePoints(),i._lockNodeFromMeasurable(i._measurable[2]),e()}}}),a.isEnvActivated("measurecsomanagement",!0)||i.addInCSO(i._measure)},_createLevelSelector:function(e){var a,i=this,s=e?0:1;this.dataLevels=[],this._getLevels=function(e){i.dataLevels=[];for(var t=i._measurable[s].getPathElement(),a=r.getLastReference(t),n=[],l=a.externalPath.length,o=0;o<l;++o){var u=a.getLastElement(!0);r.isReference(u)&&(i.dataLevels.push({pathElement:a.clone(),name:u.name,internalLevel:l-o}),n.push(u)),a=a.getParentPath()}var c=v.getContextViewer({reviewContext:v.getReviewContext({viewer:i.getFrameWindow().getViewer()})});return r.getName(n,function(t){for(var a=t.length,r=0;r<a;++r)i.dataLevels[r].name=t[r];e()},c,""),{currentLevel:0,levels:i.dataLevels}},this._onLevelHover=function(e){e&&i.addInPSO({path:e.pathElement},!1)},this._onLevelSelect=function(t){for(var a=0,n=0;0===a&&n<i.dataLevels.length;++n)i.dataLevels[n].pathElement.getLength()===t.pathElement.getLength()&&(a=i.dataLevels[n].internalLevel);var l=!1;a===2*i.dataLevels.length&&(l=!0);var o=[],u=[],d=!0,m=[],p=[],h=r.getLastRepReference(t.pathElement);null!==h&&0!==h.getLength()||(h=r.getLastReference(t.pathElement)),"ProgressiveLarge"===i._getViewerLoadingMode()&&(a&&!l?(d=!1,i._measurable[s].setPartial(!0),L&&L.displayNotification({eventID:"error",msg:w.notifyPartialStructureFailure})):i._measurable[s].setPartial(!1)),d&&("DynamicRep"===i._getViewerLoadingMode()?d=i._lockNodes(h.getLastElement(!0),o,t.pathElement.getParentPath()):"ProgressiveFull"===i._getViewerLoadingMode()&&(a&&!l?(d=i._getNodesToSwitchInRAM(h.getLastElement(!0),p,m,u),i._measurable[s].setPartial(!0)):i._measurable[s].setPartial(!1)));var y=function(a){a?(i._measure&&(i._undisplayPartialLevel(),"errorBtw"===a?i._displayPartialLevel():d?(i._partialMeasureDisplay[s]=null,s>0?(i._partialMeasureDisplay[0]=null,"partialCmd"===i._measure.isPartialMeasure()&&i._displayPartialLevel(),i._partialMeasureDisplay[0]||i._measure.setPartialMeasure(!1)):i._measure.setPartialMeasure(!1)):(i._partialMeasureDisplay[s]={path:t.pathElement,lockedNodes:o},s>0&&i._displayPartialLevel(),i._measure.setPartialMeasure("partialCmd"))),i._measure&&(e?(i._measure.setAttribute("sSelectedType1",c.ViewedType.PRODUCT),i._measureItem()):(i._measure.setAttribute("sSelectedType2",c.ViewedType.PRODUCT),i._measureBetween()))):0===s&&i._measure&&i._measure.setPartialMeasure("partialCmd"),i.emptyHSO(),i._measurable&&(i._addElementToHSO(i._measurable[0]),s>0&&i._addElementToHSO(i._measurable[1])),i.assistantTools.updatePosition(i._vAssistantPosition),i._measure&&i._measure.isMeasureDisplayed()&&i._measure.refreshNode(),i._viewer.render()};i._measurable[s].setLevel(a);var _=function(){for(var e=0;e<u.length;e++)-1===i._lockedMeshInRAM.indexOf(u[e])&&(i._viewerController.lockRepresentationMeshInRAM(u[e]),i._lockedMeshInRAM.push(u[e])),-1===i._lockedNodes.indexOf(u[e])&&(i._viewerController.lockNodes({ids:[u[e]]}),i._lockedNodes.push(u[e]));"DynamicRep"===i._getViewerLoadingMode()?y(!0):p.length>0||m.length>0?i._switchNodeVisu({nodes_cgr:p,nodes_MIR:m,onComplete:function(){y(!0)},onFailure:function(e){"fullMemory"===e&&(L&&L.displayNotification({eventID:"error",msg:w.notifyFullMemoryFailure}),y(!1))}}):y(!0)};if("ProgressiveFull"===i._getViewerLoadingMode()||"ProgressiveLarge"===i._getViewerLoadingMode())if(i._measurable[1])if(i._measurable[0].isPartial()||i._measurable[1].isPartial()){var M=i._firstSelectionLeafNodes.concat(i._secondSelectionLeafNodes);if(i._lockedMeshInRAM){var g=[];i._lockedMeshInRAM.forEach(function(e){-1===M.indexOf(e)?i._viewerController.unlockRepresentationMeshInRAM(e):g.push(e)}),i._lockedMeshInRAM=[],i._lockedMeshInRAM=g.slice()}if(i._lockedNodes){var v=[],D=[];i._lockedNodes.forEach(function(e){-1===M.indexOf(e)?D.push(e):v.push(e)}),i._viewerController.unlockNodes({ids:D}),i._lockedNodes=[],i._lockedNodes=v.slice()}i._callMinMaxIndexService({onComplete:function(){d=!0,y(!0)},onFailure:function(e){if("fullMemory"===e.cause)if(e.setALoadedState&&e.setBLoadedState){if("partial"===e.setALoadedState){var t=i._measurable[0].getPathElement(),a=i._measurable[0].getLevel();a&&(t=r.truncatePathElement(t,a)),i._partialMeasureDisplay[0]={path:t,lockedNodes:[],opacity:1}}if("partial"===e.setBLoadedState){var s=i._measurable[1].getPathElement(),n=i._measurable[1].getLevel();n&&(s=r.truncatePathElement(s,n)),i._partialMeasureDisplay[1]={path:s,lockedNodes:[],opacity:1}}i._measure.setPartialMeasure("partialCmd"),i._measurable[0].setLevel(null),i._measurable[0].setPartial(!1),i._measurable[1].setLevel(null),i._measurable[1].setPartial(!1),y("errorBtw"),L&&L.displayNotification({eventID:"error",msg:w.notifyRequestedMinDistanceFullMemoryFailure})}else L&&L.displayNotification({eventID:"error",msg:w.notifyMinDistanceFullMemoryFailure}),i.removeMeasureFromSession(i._measure),i.publish({event:"failure",data:null});else L&&L.displayNotification({eventID:"error",msg:w.notifyMinDistanceFailure}),i.removeMeasureFromSession(i._measure),i.publish({event:"failure",data:null})}})}else d?(i._measure.setPartialMeasure(!1),_()):y(!1);else d?_():y(!1);else d?_():i._measure&&(s>0?y(!0):(i._partialMeasureDisplay[s]={path:t.pathElement,lockedNodes:o},i._measure.setPartialMeasure("partialCmd")),i._viewer.render())},this._measure?a=this._measure.getAttribute("vLeaderBreakPoint3D"):this._measurable[0]&&(a=this._measurable[0].getSelPoint().clone());var n=t.getWindowPositionFromPoint(this._viewer,a,this._frmWindow),l={positionX:n.left,positionY:n.top-110,uiFrame:this._frmWindow.getUIFrame(),selectedPath:this._getLevels,getLevels:this._getLevels,onHover:this._onLevelHover,onSelect:this._onLevelSelect};this._cleanLevelSelector(),p.createView(l)},_cleanLevelSelector:function(){var e=p._noAnim;p._noAnim=!0,p.destroyView(),p._noAnim=e},_measureItem:function(){if(this._measure.setMeasurable(1,this._measurable[0]),this._measure.setAttribute("sResultingType1",this.retrieveItemResultType(this._measure.getMeasurable(1).getType(),this._measure.getAttribute("sSelectedType1"))),"2D"===this._measureOnGeometryType){var e=this._measure.getMeasurable(1);this._measure.getAttribute("sSelectedType1")===c.ViewedType.POINT&&e.getType()!==i.GeometryType.POINT&&e.setType(i.GeometryType.POINT)}var a,r=this._measure.getAttribute("sResultingType1");if(r===c.ResultType.CIRCLE){var s=0;"TANGENT"===localStorage.getItem("DMUMeasureRadiusResultDisplayPreferences")&&(s=1),this._measure.getAttribute("iRadiusResultDisplayType")!==s&&this._measure.setAttribute("iRadiusResultDisplayType",s),a="DisplayRadius"===localStorage.getItem("DMUMeasureCircleRadiusPreferences"),Math.abs(2*Math.PI-this._measurable[0]._arcAngle)>.001&&("DisplayArcLength"===localStorage.getItem("DMUMeasureArcRadiusPreferences")?this._measure.setAttribute("bArcLengthDisplay",!0):(this._measure.setAttribute("bArcLengthDisplay",!1),a="DisplayRadius"===localStorage.getItem("DMUMeasureArcRadiusPreferences"))),this._measure.getAttribute("bRadiusDisplay")!==a&&this._measure.setAttribute("bRadiusDisplay",a)}else if(r===c.ResultType.CYLINDER){var n=localStorage.getItem("DMUMeasSurfaceDisplayCylinderPref");this._measure.setAttribute("sSurfaceDisplayType",n)}else if(r===c.ResultType.CONE){var l=this._measurable[0].getApex(),o=this._measurable[0].getPoints(),u=localStorage.getItem("DMUMeasSurfaceDisplayConePref");("MinimumRadius"===u||"MinimumDiameter"===u)&&l&&(Math.abs(l.x-o.beginPoint.x)<.001&&Math.abs(l.y-o.beginPoint.y)<.001&&Math.abs(l.z-o.beginPoint.z)<.001||Math.abs(l.x-o.endPoint.x)<.001&&Math.abs(l.y-o.endPoint.y)<.001&&Math.abs(l.z-o.endPoint.z)<.001)?(u="HalfAngle",this._measure.updateFeatureAndSurfaceDisplayTypePreference(u)):this._measure.setAttribute("sSurfaceDisplayType",u)}else if(r===c.ResultType.SPHERE){var d=localStorage.getItem("DMUMeasSurfaceDisplaySpherePref");this._measure.setAttribute("sSurfaceDisplayType",d)}else if(r===c.ResultType.PRODUCT){var m=localStorage.getItem("DMUMeasProductDisplayPref");this._measure.setAttribute("sProductDisplayType",m)}switch(this._measure.update(),this._measure.getAttribute("sResultingType1")){case c.ResultType.POINT:case c.ResultType.PICKINGPT:case c.ResultType.CENTER:case c.ResultType.PLANE:case c.ResultType.CURVE:case c.ResultType.SURFACE:this._vAssistantPosition=this._measure.getAttribute("vFirstExtensionPoint3D").clone();break;case c.ResultType.LINE:this._vAssistantPosition=this._measure.getAttribute("vFirstExtensionPoint3D").clone().add(this._measure.getAttribute("vSecondExtensionPoint3D")).multiplyScalar(.5);break;case c.ResultType.AXIS:this._vAssistantPosition=this._measure.getAttribute("vLeaderPointingPoint3D").clone();break;case c.ResultType.CIRCLE:var p=t.getViewpointInfo(this._viewer.currentViewpoint),h=Math.abs(this._measure.getAttribute("vNormal").angleTo(p.sight)-Math.PI/2)<Math.PI/10;this._vAssistantPosition=h?this._measure.getAttribute("vCenter").clone():this._measure.getAttribute("vLeaderPointingPoint3D").clone();break;case c.ResultType.CYLINDER:a="DisplayRadius"===localStorage.getItem("DMUMeasureCylinderRadiusPreferences"),this._vAssistantPosition=this._measure.getAttribute("vPoint1").clone().add(this._measure.getAttribute("vPoint2")).multiplyScalar(.5),this._measure.getAttribute("bRadiusDisplay")!==a&&this._measure.setAttribute("bRadiusDisplay",a);break;case c.ResultType.CONE:this._vAssistantPosition=this._measure.getAttribute("vPoint2").clone();break;case c.ResultType.SPHERE:a="DisplayRadius"===localStorage.getItem("DMUMeasureSphereRadiusPreferences"),this._vAssistantPosition=this._measure.getAttribute("vCenter").clone(),this._measure.getAttribute("bRadiusDisplay")!==a&&this._measure.setAttribute("bRadiusDisplay",a);break;case c.ResultType.PRODUCT:this._vAssistantPosition=this._measure.getAttribute("vLeaderPointingPoint3D").clone()}this._vAssistantPosition=this._measure.movePosDownByPixels({position:this._vAssistantPosition.clone(),pixels:45})},_measureBetween:function(){if(this._measure._objAction=this._objAction,this._objAction||this._measure.setMeasurable(2,this._measurable[1]),this._measure.setAttribute("sResultingType1",this.retrieveBetweenResultType(this._measure.getAttribute("sSelectedType1"),this._measure.getAttribute("sSelectedType2"),this._measurable[0])),this._measure.setAttribute("sResultingType2",this.retrieveBetweenResultType(this._measure.getAttribute("sSelectedType2"),this._measure.getAttribute("sSelectedType1"),this._measurable[1])),"2D"===this._measureOnGeometryType){var e=this._measure.getMeasurable(1),t=this._measure.getMeasurable(2);if(this._measure.getAttribute("sSelectedType1")===c.ViewedType.POINT&&e.getType()!==i.GeometryType.POINT&&e.setType(i.GeometryType.POINT),this._measure.getAttribute("sSelectedType2")===c.ViewedType.POINT&&e.getType()!==i.GeometryType.POINT&&t.setType(i.GeometryType.POINT),this._retrieveDistanceTypeFor2DMeasures){var a=this._retrieveDistanceTypeFor2DMeasures();this._measure.setAttribute("sDistanceType",a.distanceType),this._measure._local2DDistancePref=a.localprefName}}this._measure.setDistanceType(),this._measure.update(),void 0===this._measure.getAttribute("fDistance")&&void 0===this._measure.getAttribute("fAngle")||(this._vAssistantPosition=this._measure.movePosDownByPixels({position:this._measure.getAttribute("vSecondExtensionPoint3D").clone(),pixels:45}))},_measureThreePoints:function(){if(this._measure.setMeasurable(3,this._measurable[2]),"Measure3PointsCircle"===this._measure.getAttribute("sType")){this._measure.setAttribute("sDistanceType","none");var e=0;"TANGENT"===localStorage.getItem("DMUMeasure3PointsCircleRadiusResultDisplayPreferences")&&(e=1),this._measure.getAttribute("iRadiusResultDisplayType")!==e&&this._measure.setAttribute("iRadiusResultDisplayType",e)}else"Measure3PointsAngle"===this._measure.getAttribute("sType")&&this._measure.setAttribute("sDistanceType","Angle");this._measure.update()},retrievePossibleSelectedType:function(e){var t=[],a=e.getType();return a===i.GeometryType.POINT||a===i.GeometryType.PICKINGPT?t.push(c.ViewedType.POINT):a===i.GeometryType.PLANE?(t.push(c.ViewedType.INFPLANE),t.push(c.ViewedType.POINT),t.push(c.ViewedType.SURFACE)):a===i.GeometryType.CYLINDER?(t.push(c.ViewedType.CYCOSP),t.push(c.ViewedType.AXIS),t.push(c.ViewedType.POINT),t.push(c.ViewedType.SURFACE)):a===i.GeometryType.CONE?(t.push(c.ViewedType.CYCOSP),t.push(c.ViewedType.AXIS),t.push(c.ViewedType.POINT),t.push(c.ViewedType.SURFACE)):a===i.GeometryType.SPHERE?(t.push(c.ViewedType.CYCOSP),t.push(c.ViewedType.CENTER),t.push(c.ViewedType.POINT),t.push(c.ViewedType.SURFACE)):a===i.GeometryType.LINE?(t.push(c.ViewedType.CURVE),t.push(c.ViewedType.AXIS),t.push(c.ViewedType.POINT)):a===i.GeometryType.CIRCLE?(t.push(c.ViewedType.CIRCLE),t.push(c.ViewedType.CENTER),t.push(c.ViewedType.POINT),t.push(c.ViewedType.CURVE)):a===i.GeometryType.CURVE?(t.push(c.ViewedType.CURVE),t.push(c.ViewedType.POINT)):a===i.GeometryType.SURFACE&&(t.push(c.ViewedType.SURFACE),t.push(c.ViewedType.POINT)),t.push(c.ViewedType.PRODUCT),t},retrieveItemResultType:function(e,t){var a=c.ResultType.POINT;if(t===c.ViewedType.POINT)a=c.ResultType.POINT;else if(t===c.ViewedType.PRODUCT)a=c.ResultType.PRODUCT;else switch(e){case i.GeometryType.POINT:case i.GeometryType.PICKINGPT:a=c.ResultType.POINT;break;case i.GeometryType.LINE:a=this._objAction?c.ResultType.LINE:t===c.ViewedType.AXIS?c.ResultType.AXIS:c.ResultType.LINE;break;case i.GeometryType.CIRCLE:a=this._objAction?c.ResultType.CIRCLE:t===c.ViewedType.CENTER?c.ResultType.CENTER:t===c.ViewedType.CURVE?c.ResultType.CURVE:c.ResultType.CIRCLE;break;case i.GeometryType.CURVE:a=c.ResultType.CURVE;break;case i.GeometryType.PLANE:a=this._objAction?c.ResultType.PLANE:t===c.ViewedType.SURFACE?c.ResultType.SURFACE:c.ResultType.PLANE;break;case i.GeometryType.CYLINDER:a=this._objAction?c.ResultType.CYLINDER:t===c.ViewedType.AXIS?c.ResultType.AXIS:t===c.ViewedType.SURFACE?c.ResultType.SURFACE:c.ResultType.CYLINDER;break;case i.GeometryType.CONE:a=this._objAction?c.ResultType.CONE:t===c.ViewedType.AXIS?c.ResultType.AXIS:t===c.ViewedType.SURFACE?c.ResultType.SURFACE:c.ResultType.CONE;break;case i.GeometryType.SPHERE:a=this._objAction?c.ResultType.SPHERE:t===c.ViewedType.CENTER?c.ResultType.CENTER:t===c.ViewedType.SURFACE?c.ResultType.SURFACE:c.ResultType.SPHERE;break;case i.GeometryType.SURFACE:a=c.ResultType.SURFACE}return a},retrieveBetweenResultType:function(e,t){var a=c.ResultType.POINT;switch(e){case c.ViewedType.POINT:case c.ViewedType.CENTER:a=c.ResultType.POINT;break;case c.ViewedType.AXIS:a=t===c.ViewedType.POINT||t===c.ViewedType.CENTER||t===c.ViewedType.AXIS||t===c.ViewedType.INFPLANE?c.ResultType.AXIS:c.ResultType.CURVE;break;case c.ViewedType.CURVE:a=c.ResultType.CURVE;break;case c.ViewedType.INFPLANE:a=t===c.ViewedType.POINT||t===c.ViewedType.CENTER||t===c.ViewedType.AXIS||t===c.ViewedType.INFPLANE?c.ResultType.PLANE:c.ResultType.SURFACE;break;case c.ViewedType.SURFACE:a=c.ResultType.SURFACE;break;case c.ViewedType.PRODUCT:a=c.ResultType.PRODUCT;break;case c.ViewedType.CIRCLE:a=c.ResultType.CURVE;break;case c.ViewedType.CYCOSP:a=c.ResultType.SURFACE}return a},_createAssistantTools:function(e){var t=w.multipleMeas,a=w.chainMeas,i=w.stackMeas,r=this;var s=[];void 0!==e.bOK&&e.bOK&&s.push({nls:w.ok,url:this._iconDir+"I_Validate.png",id:"OK",callback:function(){r.publish({event:"OK",data:null})},bstateActif:!1}),void 0!==e.bRepeatitem&&e.bRepeatitem&&s.push({nls:w.repeatitem,url:this._iconDir+"I_Repeat.png",id:"Repeat",callback:function(){r._repeatType="Item",r.publish({event:"repeatitem",data:null})},bstateActif:!1}),void 0!==e.bRepeatbetweenMultipleMeas&&e.bRepeatbetweenMultipleMeas&&s.push({nls:t,url:this._iconDir+"I_MultipleMeasure.png",id:"Multiple",callback:function(){r._repeatType="Multiple",r.publish({event:"repeatbetweenMultiple",data:null})}}),void 0!==e.bRepeatbetweenChain&&e.bRepeatbetweenChain&&s.push({nls:a,url:this._iconDir+"I_ChainedMeasure.png",id:"Chain",callback:function(){r._repeatType="Chain",r.publish({event:"repeatbetween",data:null})}}),void 0!==e.bRepeatbetweenFan&&e.bRepeatbetweenFan&&s.push({nls:i,url:this._iconDir+"I_FanMeasure.png",id:"Fan",callback:function(){r._repeatType="Fan",r.publish({event:"repeatbetween",data:null})}}),void 0!==e.bKeeponlylast&&e.bKeeponlylast&&s.push({nls:w.keepprevious,url:this._iconDir+"I_KeepOnlyLast.png",id:"Keep",callback:function(){r._bKeepall=!r._bKeepall},bstateActif:this._bKeepall}),void 0!==e.bAnglethreepoints&&e.bAnglethreepoints&&s.push({nls:w.anglethreepoints,url:this._iconDir+"I_MeasureAngle3Points.png",id:"Angle3Points",callback:function(){r._threepoints="Angle",r.publish({event:"threepoints",data:null})}}),void 0!==e.bCirclethreepoints&&e.bCirclethreepoints&&s.push({nls:w.circlethreepoints,url:this._iconDir+"I_MeasureArc3Points.png",id:"Arc3Points",callback:function(){r._threepoints="Circle",r.publish({event:"threepoints",data:null})}}),void 0!==e.bThreepoints&&e.bThreepoints&&s.push({nls:w.threepoints,url:this._iconDir+"I_Measure3Points.png",id:"3Points",callback:function(){r._threepoints="Threepoints",r.publish({event:"threepoints",data:null})}});var n=this._vAssistantPosition;this._measure&&this._measure._vAssistantPosition&&(n=this._measure._vAssistantPosition),this._removeAssistantTools(),this.assistantTools=new o({body:this._frmWindow.getUIFrame(),viewer:this._viewer,frmWindow:this._frmWindow,title:"Assistant tools Control",position:n,mode:"curve",dir:"bottom",lJsonElement:s}),this.assistantTools.build(),this._measure&&(this._measure._assistantTool=this.assistantTools)},_removeAssistantTools:function(){this.assistantTools&&(this.assistantTools.clear(),this.assistantTools=void 0),this._tokenVISUEvent&&(h.unsubscribe(this._tokenVISUEvent),this._tokenVISUEvent=null)},_isItMeasurable:function(e){var t=!1;if(void 0!==e){if("Thickness"===this._arguments[0].ID&&r.isOOCTileSetNodeInPath(e))return!1;if(r.getFirstReference(e).externalPath.length>0)t=!0;else t=v.getReviewContext({viewer:this.getFrameWindow().getViewer()}).getDMUObjectFromPathElement(e)&&!0===e.getLastElement(!0).measurable;t||(!this._activeFilter||"pointOnly"===this._activeFilter||"SeveralGeometries"===this._activeFilter&&this._filterUI&&!this._filterUI.getActiveState("center"))&&(t=r.isOOCTileSetNodeInPath(e))}return t},_lockNodeFromMeasurable:function(e){if("ProgressiveVisuLoading"===this._measureCommandMode&&this._viewerController&&e){var t=r.getLastRepReference(e.getPathElement());if(null===t&&(t=r.getLastReference(e.getPathElement())),t){var a=t.getLastElement(!0);if(a&&r.isPLMNode(a)){var i=r.getNodeID(a);this._measure.isNodeLocked(i)||(this._viewerController.lockNodes({ids:[i]}),this._measure.addLockedNode(i))}}}},_lockNodes:function(e,t,a){var i=!0,s=null;if(a&&(s=a.clone()).addElement(e),this._viewerController&&e)if(r.isRepReference(e)&&r.isPLMNode(e)){var n=r.getNodeID(e),l=this._viewerController.isReferenceComplete(n);!0===l||null===l?(-1===this._lockedNodes.indexOf(n)&&(this._viewerController.lockNodes({ids:[n]}),this._lockedNodes.push(n)),t.push(s)):i=!1}else{var o=e.getChildren();if(o)for(var u=0;u<o.length;u++){var c=this._lockNodes(o[u],t,s);i&&!c&&(i=!1)}}return i},_displayPartialLevel:function(){var e=this;this._overrideSet||(this._overrideSet=r.createSceneGraphOverrideSet(this._viewer)),this._overrideSet&&this._partialMeasureDisplay.forEach(function(t){if(t){for(var a=null,i=0;i<t.lockedNodes.length;i++)t.lockedNodes[i]&&(null===(a=e._overrideSet.getUniqueOverrideFromPathElement(t.lockedNodes[i]))&&(a=e._overrideSet.createOverride(t.lockedNodes[i])),a.setOpacity(1,!0));if(null===(a=e._overrideSet.getUniqueOverrideFromPathElement(t.path))&&(a=e._overrideSet.createOverride(t.path)),a){a.setColor(16744448,!1),a.setOpacity(t.opacity?t.opacity:.3,!1)}}})},_undisplayPartialLevel:function(){this._overrideSet&&(r.removeSceneGraphOverrideSet(this._viewer,this._overrideSet),this._overrideSet=null)},_getNodesToSwitchInRAM:function(e,t,a,i){var s=!0,n=this;if(this._viewerController&&e&&a){var l=r.getNodeID(e),o=this._viewerController.createReferenceIterator(l);if(o){var u=function(e,t,a,i){if(e){var l=e.getChildren();if(l&&l.length>0){for(var o=0;o<l.length;o++)if(u(l[o].getReferenceIterator(),t,a,i),!s){a=[],a=[];break}}else{var c=e.getNode();if(c){var d=r.getNodeID(c),m=n._viewerController.isReferenceComplete(d);if(!0===m||null===m){var p=!0;"cgr"!==n._viewerController.getLoadedStream(c)&&-1===t.indexOf(c)&&(t.push(c),p=!1),!1===n._viewerController.hasMeshInRAM(d)?-1===a.indexOf(d)&&a.push(d):!0===m&&!0===p&&i.push(d)}else s=!1}else e._reference&&e._reference.userData&&"3DShape"===e._reference.userData.type&&(s=!1)}}};u(o,t,a,i)}}return s},_checkForSelection:function(){return!0},_addElementToHSO:function(e){if(e){var t,a=new m,i=[],s=e.getPathElement(),n=e.getLevel();if(n)t=r.truncatePathElement(s,n);else{t=s;var l=e.getPrimitive();if(l)for(var o=THREEDS.SubElement.getFromSGNode(l);null!==o;)i.unshift(o),o=o.getParent()}a.setFromArray(t.externalPath,i),this.addInHSO({path:a},!0)}},_getViewerLoadingMode:function(){var e=null;return R.getSetting("enopad3dviewer_lightNodeModel")?this._viewerController&&(e=this._viewerController.isLargeSession()?"ProgressiveLarge":"ProgressiveFull"):R.getSetting("enopad3dviewer_dynamicRepLoading")&&(e="DynamicRep"),e},_callMinMaxIndexService:function(e){var t=this,a=r.getFirstReference(t._measurable[0].getPathElement()).getLastElement();if(a===r.getFirstReference(t._measurable[1].getPathElement()).getLastElement()){var i=r.getNodeID(a),s=t._measurable[0].getPathElement(),n=t._measurable[0].getLevel();n&&(s=r.truncatePathElement(s,n));var l=t._measurable[1].getPathElement(),o=t._measurable[1].getLevel();o&&(l=r.truncatePathElement(l,o));var u=t._viewerController.buildArrayFromPath(s),c=t._viewerController.buildArrayFromPath(l),d=[],m=[],p=[],h=[],y=v.giveEventsController({viewer:this._viewer}),_=v.getContextViewer({viewer:t.getFrameWindow().getViewer()}),M=null,g=null,D=!1;y&&(M=y.addEvent(A.Events.EXPEndProgressiveLoad,function(a){if(a.memoryFull){var i,s;D=!0,_.unsubscribe(g),y.removeEvent(M);var n,l=0,o=0,u=0,c=0;if(d.length>0){for(var v=0;v<d.length;v++)(n=d[v].getLastElement(!0))&&"cgr"===t._viewerController.getLoadedStream(n)&&t._viewerController.hasMeshInRAM(r.getNodeID(n))&&(l++,-1!==t._firstSelectionLeafNodes.indexOf(r.getNodeID(n))&&u++);l===d.length?i="full":t._firstSelectionLeafNodes.length===u&&(i="partial")}else p.length>0&&(p.forEach(function(e){var a=t._viewerController.buildPathFromArray(e);a&&(n=a.getLastElement(!0))&&"cgr"===t._viewerController.getLoadedStream(n)&&t._viewerController.hasMeshInRAM(e[e.length-1])&&(l++,-1!==t._firstSelectionLeafNodes.indexOf(e[e.length-1])&&u++)}),l===p.length?i="full":t._firstSelectionLeafNodes.length===u&&(i="partial"));if(m.length>0){for(var f=0;f<m.length;f++)(n=m[f].getLastElement(!0))&&"cgr"===t._viewerController.getLoadedStream(n)&&t._viewerController.hasMeshInRAM(r.getNodeID(n))&&(o++,-1!==t._secondSelectionLeafNodes.indexOf(r.getNodeID(n))&&c++);o===m.length?s="full":t._secondSelectionLeafNodes.length===c&&(s="partial")}else h.length>0&&(h.forEach(function(e){var a=t._viewerController.buildPathFromArray(e);a&&(n=a.getLastElement(!0))&&"cgr"===t._viewerController.getLoadedStream(n)&&t._viewerController.hasMeshInRAM(e[e.length-1])&&(o++,-1!==t._secondSelectionLeafNodes.indexOf(e[e.length-1])&&c++)}),o===h.length?s="full":t._secondSelectionLeafNodes.length===c&&(s="partial"));e.onFailure({cause:"fullMemory",setALoadedState:i,setBLoadedState:s}),window.console.log("MCmd (full mem): MinMax fails ("+i+","+s+")")}})),t._viewerController.completeSessionWithMinMaxMeasureCandidates({rootPhID:i,mode:"min",sets:[{id:"A",paths:[u]},{id:"B",paths:[c]}],stream:"cgr",meshInRAM:!0}).then(function(a){if(a.selectedPaths.length>0&&a.sortedPaths.A.length>0&&a.sortedPaths.B.length>0){p=a.sortedPaths.A,h=a.sortedPaths.B;for(var i=[],s=0;s<a.selectedPaths.length;s++){t._viewerController.buildPathFromArray(a.selectedPaths[s])?t._viewerController.hasMeshInRAM(a.selectedPaths[s][a.selectedPaths[s].length-1])||-1!==i.indexOf(a.selectedPaths[s][a.selectedPaths[s].length-1])||i.push(a.selectedPaths[s][a.selectedPaths[s].length-1]):-1===i.indexOf(a.selectedPaths[s][a.selectedPaths[s].length-1])&&i.push(a.selectedPaths[s][a.selectedPaths[s].length-1])}var n=function(){var s=[],n=0;g=_.subscribe({event:"onRepresentationLoaded"},function(a){if(t._viewerController.hasMeshInRAM(a)){for(var i=0;i<s.length;i++)if(-1!==s[i].indexOf(a)){n++;break}n===s.length&&(_.unsubscribe(g),g=null,y.removeEvent(M),M=null,e.onComplete())}});var l,o=function(e){e.forEach(function(e){var a=e.getLastElement(!0);if(a){var i=r.getNodeID(a);-1===t._lockedNodes.indexOf(i)&&(t._viewerController.lockNodes({ids:[i]}),t._lockedNodes.push(i))}})};i.length&&t._viewerController.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!1}})});for(var u=0;u<a.sortedPaths.A.length;u++)(l=t._viewerController.buildPathFromArray(a.sortedPaths.A[u]))&&d.push(l);o(d),r.isPLMNode(t._measurable[0].getPathElement().getLastElement(!0))&&(t._measurable[0].setPartial(!0),t._measurable[0].setPartialPathElements(d));for(var c=0;c<a.sortedPaths.B.length;c++)(l=t._viewerController.buildPathFromArray(a.sortedPaths.B[c]))&&m.push(l);o(m),r.isPLMNode(t._measurable[1].getPathElement().getLastElement(!0))&&(t._measurable[1].setPartial(!0),t._measurable[1].setPartialPathElements(m)),d.length===a.sortedPaths.A.length&&m.length===a.sortedPaths.B.length&&a.selectedPaths.forEach(function(e){var a=e[e.length-1];t._lockedMeshInRAM.push(a),t._viewerController.hasMeshInRAM(a)||-1===s.indexOf(a)&&s.push(a)}),0===s.length&&(_.unsubscribe(g),g=null,y.removeEvent(M),M=null,e.onComplete())};i.length?t._viewerController.forceReferencesLoad({ids:i,callback:function(){D||n()}}):D||n()}else D||(window.console.log("MCmd: MinMax fails (no candidates)"),y.removeEvent(M),M=null,e.onFailure({cause:"noresult"}))},function(){window.console.log("MCmd: MinMax fails (reject)"),y.removeEvent(M),M=null,e.onFailure({cause:"index"})})}else window.console.log("MCmd: MinMax fails (roots)"),e.onFailure({cause:"roots"})},_switchNodeVisu:function(e){var t=this,a=[],i=[],s=!1;if(e.nodes_cgr&&e.nodes_cgr.length>0||e.nodes_MIR&&e.nodes_MIR.length>0){var n=null,l=null,o=!1,u=v.getContextViewer({viewer:t.getFrameWindow().getViewer()}),c=v.giveEventsController({viewer:t.getFrameWindow().getViewer()});c&&(l=c.addEvent(A.Events.EXPEndProgressiveLoad,function(a){a.memoryFull&&!s&&(o||(s=!0,t._viewerController.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!1}})}),u.unsubscribe(n),window.console.log("MCmd (full mem): rep loading fails"),c.removeEvent(l),e.onFailure("fullMemory")))}));var d=function(a){o=!1;var r=a.length,d=[],m=0;n=u.subscribe({event:"onRepresentationLoaded"},function(a){-1!==d.indexOf(a)&&t._viewerController.hasMeshInRAM(a)&&(s?(c.removeEvent(l),u.unsubscribe(n)):++m===d.length&&(t._viewerController.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!1}})}),c.removeEvent(l),u.unsubscribe(n),o=!0,setTimeout(e.onComplete(),0)))});for(var p=0;p<r;p++)-1===t._lockedNodes.indexOf(a[p])&&(t._viewerController.lockNodes({ids:[a[p]]}),t._lockedNodes.push(a[p])),-1===t._lockedMeshInRAM.indexOf(a[p])&&(t._viewerController.lockRepresentationMeshInRAM(a[p]),t._lockedMeshInRAM.push(a[p]),t._viewerController.hasMeshInRAM(a[p])||d.push(a[p]));0===d.length&&(t._viewerController.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!1}})}),u.unsubscribe(n),c.removeEvent(l),e.onComplete())};e.nodes_cgr.length>0?(e.nodes_cgr.forEach(function(e){a.push({node:e,stream:"cgr"}),-1!==i.indexOf(r.getNodeID(e))&&i.push(r.getNodeID(e))}),this._viewerController.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!0}}),callback:function(){t._viewerController.switchNodeVisuStreamOnDemand({data:a,callbacks:{onComplete:function(){if(o=!0,"ProgressiveFull"===t._getViewerLoadingMode()||"ProgressiveLarge"===t._getViewerLoadingMode()){var a=[];e.nodes_cgr.forEach(function(e){var t=r.getNodeID(e);-1===a.indexOf(t)&&a.push(t)}),e.nodes_MIR&&e.nodes_MIR.forEach(function(e){-1===a.indexOf(e)&&a.push(e)}),d(a)}else c.removeEvent(l),e.onComplete(!0)},onFailure:function(){window.console.log("MCmd: switchNode fails"),t._viewerController.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!1}})}),c.removeEvent(l),e.onFailure()}}})}})):e.nodes_MIR.length>0&&d(e.nodes_MIR)}else e.onFailure()}})}),define("DS/DMUMeasure/DMUMeasureProperties",["UWA/Core","UWA/Class","DS/Controls/Toggle","i18n!DS/DMUMeasure/assets/nls/DMUMeasure"],function(e,t,a,i){"use strict";return t.extend({init:function(t){var r,s=t._viewer,n=null,l=null,o=null,u=null,c=null,d=null,m=null;this.getPropertiesDisplay=function(t,p){if(n=null,l=null,o=null,t){for(r=0;r<t.length;r++){var h=t[r].getAttribute("bShortDisplay");null===n?n=h:h!==n&&(n=void 0),h=t[r].getAttribute("bDisplayMeasureType"),null===l?l=h:h!==l&&(l=void 0),h=t[r].getAttribute("bDisplayUnit"),null===o?o=h:h!==o&&(o=void 0)}var y=!1,_=!1,M=!1,g=!1,v=!1,D=!1;void 0===n?g=!0:y=n,void 0===l?v=!0:_=l,void 0===o?D=!0:M=o,u=new a({label:i.properties.mainValue,value:"DMUMainValue",type:"radio",checkFlag:y,mixedState:g}).inject(p);var f=e.createElement("div",{styles:{"margin-left":"25px"}}).inject(p);f&&(c=new a({label:i.properties.measureType,value:"DMUMeasureTypeValue",type:"checkbox",checkFlag:_,mixedState:v}).inject(f),d=new a({label:i.properties.unit,value:"DMUMainValue",type:"checkbox",checkFlag:M,mixedState:D}).inject(f),y||(d.disabled=!0,c.disabled=!0)),m=new a({label:i.properties.extendedDisplay,value:"DMUExtendedDisplayValue",type:"radio",checkFlag:!y,mixedState:g}).inject(p)}u.addEventListener("buttonclick",function(){d.disabled=!1,c.disabled=!1}),m.addEventListener("buttonclick",function(){d.disabled=!0,c.disabled=!0}),this.getPropertiesToSet=function(){var e=[],t=u.checkFlag;return t!==n&&(e.push({name:"bShortDisplay",value:t}),n=t),(t=c.checkFlag)!==l&&(e.push({name:"bDisplayMeasureType",value:t}),l=t),(t=d.checkFlag)!==o&&(e.push({name:"bDisplayUnit",value:t}),o=t),e},this.afterSetProperties=function(e,t){if(e&&t)for(r=0;r<e.length;r++)e[r].getAttribute("bShortDisplay")?localStorage.setItem("DMUMeasureDisplayPreference","Short"):localStorage.setItem("DMUMeasureDisplayPreference","Extended"),e[r].refreshNode(),s&&s.render&&s.render()}}}})}),define("DS/DMUMeasure/DMUMeasureArcDisplayTypeCmd",["DS/ApplicationFrame/Command","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager"],function(e,t,a){"use strict";return e.extend({init:function(e){this._parent(e);var i=this;this.beginExecute=function(){var e=t.getReviewContext({viewer:i.getFrameWindow().getViewer()});if(e){var r=a.get();if(r.length>0){for(var s=0;s<r.length;s++){var n=e.getDMUObjectFromPathElement(r[s].pathElement);if(n){var l;switch(this._id){case"DMUMeasureArcCenterDisplayHdr":l=0;break;case"DMUMeasureArcTangentDisplayHdr":l=1}void 0!==l&&(n.setAttribute("iRadiusResultDisplayType",l),n.updateGlobalRadiusResultDisplayPreference(l),n.refreshNode())}}a.empty(),i.getFrameWindow().getViewer().render()}}i.end()}}})}),define("DS/DMUMeasure/DMUMeasureExport",["require","exports","DS/DMUBaseExperience/EXPUtils"],function(e,t,a){"use strict";return class{static getObjectDefinition(e){let t={measurables:[]};for(let i=1;i<=3;i++)e.getMeasurable(i)&&t.measurables.push(e.getMeasurable(i).exportData(a.typeToStr));return t}}}),define("DS/DMUMeasure/DMUMeasureContextualBar",["DS/DMUBaseUI/DMUContextualBarAdapter","DS/DMUBaseExperience/DMUContextManager","DS/DMUMeasurable/DMUMeasureEnums","DS/Visualization/ThreeJS_DS","DS/ApplicationFrame/CommandsManager","DS/DMUBaseExperience/EXPUtils","DS/DMUMeasurable/DMUGeometryEnums"],function(e,t,a,i,r,s,n){"use strict";return e.extend({getSharedContextualCommandList:function(e){var t=[];return e&&e.length&&e.forEach(function(e){-1===t.indexOf(e.getType())&&t.push(e.getType())}),1===t.length&&-1!==t[0].indexOf("DMUMeasure")?this.getContextualCommandList():[]},getCmdHdrsFor2DGeometries:function(){var e,t,i,r=[];if("MeasureBetween"===this._sType){switch(e="DMUMeasureMinDistanceHdr",this.getAttribute("sDistanceType")){case"Distance":e="DMUMeasureDistanceHdr";break;case"Angle":e="DMUMeasureAngleHdr";break;case"MaximumDistance":e="DMUMeasureMaxDistanceHdr";break;case"LocalMinimumDistance":e="DMUMeasureLocalMinDistanceHdr";break;case"LocalMaximumDistance":e="DMUMeasureLocalMaxDistanceHdr"}t=this._sMeasurable1.getType(),i=this._sMeasurable2.getType();var s=this.getAttribute("sSelectedType1"),l=this.getAttribute("sSelectedType2"),o=!this._objAction&&(s===a.ViewedType.POINT||s===a.ViewedType.CENTER)||t===n.GeometryType.POINT,u=!this._objAction&&(l===a.ViewedType.POINT||l===a.ViewedType.CENTER)||i===n.GeometryType.POINT;if(o&&u);else if(o&&(i===n.GeometryType.LINE||i===n.GeometryType.CURVE||i===n.GeometryType.SURFACE||i===n.GeometryType.PRODUCT)||(t===n.GeometryType.LINE||t===n.GeometryType.CURVE||t===n.GeometryType.SURFACE||t===n.GeometryType.PRODUCT)&&u)r=[{name:"DMUMeasureDistanceHdrStr",line:1,hdr_list:["DMUMeasureMinDistanceHdr","DMUMeasureMaxDistanceHdr"],selectedHdr:e}];else if(o&&(i===n.GeometryType.CIRCLE||i===n.GeometryType.PLANE||i===n.GeometryType.CYLINDER||i===n.GeometryType.CONE||i===n.GeometryType.SPHERE)||(t===n.GeometryType.CIRCLE||t===n.GeometryType.PLANE||t===n.GeometryType.CYLINDER||t===n.GeometryType.CONE||t===n.GeometryType.SPHERE)&&u)r=[{name:"DMUMeasureDistanceHdrStr",line:1,hdr_list:["DMUMeasureDistanceHdr","DMUMeasureMinDistanceHdr","DMUMeasureMaxDistanceHdr"],selectedHdr:e}];else if(t===n.GeometryType.CIRCLE||i===n.GeometryType.CIRCLE)r=[{name:"DMUMeasureDistanceHdrStr",line:1,hdr_list:["DMUMeasureDistanceHdr","DMUMeasureMinDistanceHdr","DMUMeasureMaxDistanceHdr"],selectedHdr:e}];else if(t===n.GeometryType.POINT&&i===n.GeometryType.POINT)r=[{name:"DMUMeasureDistanceHdrStr",line:1,hdr_list:["DMUMeasureDistanceHdr"]}];else if(t===n.GeometryType.PRODUCT&&(i===n.GeometryType.PRODUCT||i===n.GeometryType.SURFACE||i===n.GeometryType.PLANE||i===n.GeometryType.CURVE||i===n.GeometryType.LINE||i===n.GeometryType.CYLINDER||i===n.GeometryType.CONE||u)||(t===n.GeometryType.SURFACE||t===n.GeometryType.PLANE||t===n.GeometryType.CURVE||t===n.GeometryType.LINE||t===n.GeometryType.CYLINDER||t===n.GeometryType.CONE||o)&&i===n.GeometryType.PRODUCT||t===n.GeometryType.SURFACE&&(i===n.GeometryType.SURFACE||i===n.GeometryType.PLANE||i===n.GeometryType.CURVE||i===n.GeometryType.LINE||u)||(t===n.GeometryType.PLANE||t===n.GeometryType.CURVE||t===n.GeometryType.LINE||o)&&i===n.GeometryType.SURFACE||t===n.GeometryType.PLANE&&i===n.GeometryType.CURVE||t===n.GeometryType.CURVE&&(i===n.GeometryType.CURVE||i===n.GeometryType.PLANE||i===n.GeometryType.LINE||u)||t===n.GeometryType.LINE&&u||o&&i===n.GeometryType.LINE)r=[{name:"DMUMeasureDistanceHdrStr",line:1,hdr_list:["DMUMeasureMinDistanceHdr","DMUMeasureMaxDistanceHdr"],selectedHdr:e}];else{var c=!1;this.getAttribute("fAngle")>0&&(c=!0),r=c?[{name:"DMUMeasureDistanceHdrStr",line:1,hdr_list:["DMUMeasureAngleHdr","DMUMeasureMinDistanceHdr","DMUMeasureMaxDistanceHdr"],selectedHdr:e}]:[{name:"DMUMeasureDistanceHdrStr",line:1,hdr_list:["DMUMeasureDistanceHdr","DMUMeasureMinDistanceHdr","DMUMeasureMaxDistanceHdr"],selectedHdr:e}]}r.length>0&&r[0].hdr_list&&this._sMeasurable1.extraPolateGeom&&(r[0].hdr_list.push("DMUMeasureLocalMinDistanceHdr"),r[0].hdr_list.push("DMUMeasureLocalMaxDistanceHdr"))}else if("MeasureItem"===this._sType){var d;if(this.getAttribute("sResultingType1")!==a.ResultType.POINT)if((t=this._sMeasurable1.getType())===n.GeometryType.CIRCLE)d=this.compareAttributes([{name:"bRadiusDisplay",value:!0}])?"DMUMeasureRadiusHdr":"DMUMeasureDiameterHdr",Math.abs(2*Math.PI-this.getMeasurable(1)._arcAngle)>.001?(this.getAttribute("bArcLengthDisplay")&&(d="DMUMeasureArcLengthHdr"),r=[{name:"DMUMeasureRadiusHdrStr",line:1,hdr_list:["DMUMeasureDiameterHdr","DMUMeasureRadiusHdr","DMUMeasureArcLengthHdr"],selectedHdr:d}]):r=[{name:"DMUMeasureRadiusHdrStr",line:1,hdr_list:["DMUMeasureDiameterHdr","DMUMeasureRadiusHdr"],selectedHdr:d}];else if(t===n.GeometryType.CYLINDER)r=[{name:"DMUMeasureCylHdrStr",line:1,hdr_list:["DMUMeasureSurfaceDiameterHdr","DMUMeasureSurfaceRadiusHdr","DMUMeasureSurfaceLengthHdr","DMUMeasureSurfaceAreaHdr"],selectedHdr:d="DMUMeasureSurface"+this.getAttribute("sSurfaceDisplayType")+"Hdr"}];else if(t===n.GeometryType.CONE){d="DMUMeasureSurface"+this.getAttribute("sSurfaceDisplayType")+"Hdr";var m=["DMUMeasureSurfaceHalfAngleHdr","DMUMeasureSurfaceAngleHdr","DMUMeasureSurfaceLengthHdr","DMUMeasureSurfaceMaximumDiameterHdr","DMUMeasureSurfaceMaximumRadiusHdr"],p=this.getAttribute("vApex"),h=this._sMeasurable1.getPoints();p&&(Math.abs(p.x-h.beginPoint.x)<.001&&Math.abs(p.y-h.beginPoint.y)<.001&&Math.abs(p.z-h.beginPoint.z)<.001||Math.abs(p.x-h.endPoint.x)<.001&&Math.abs(p.y-h.endPoint.y)<.001&&Math.abs(p.z-h.endPoint.z)<.001)?m.push("DMUMeasureSurfaceAreaHdr"):(m.push("DMUMeasureSurfaceMinimumDiameterHdr"),m.push("DMUMeasureSurfaceMinimumRadiusHdr"),m.push("DMUMeasureSurfaceAreaHdr")),r=[{name:"DMUMeasureConeHdrStr",line:1,hdr_list:m,selectedHdr:d}]}else if(t===n.GeometryType.SPHERE)r=[{name:"DMUMeasureSphereHdrStr",line:1,hdr_list:["DMUMeasureSurfaceDiameterHdr","DMUMeasureSurfaceRadiusHdr","DMUMeasureSurfaceAreaHdr"],selectedHdr:d="DMUMeasureSurface"+this.getAttribute("sSurfaceDisplayType")+"Hdr"}];else if(t===n.GeometryType.PRODUCT){d="DMUMeasureProduct"+this.getAttribute("sProductDisplayType")+"Hdr";var y=[];this.getAttribute("fVolume")>0&&y.push("DMUMeasureProductVolumeHdr"),y.push("DMUMeasureProductAreaHdr"),r=[{name:"DMUMeasurePrdHdrStr",line:1,hdr_list:y,selectedHdr:d}]}}else"Measure3PointsCircle"!==this._sType&&"Measure3PointsAngle"!==this._sType||(e="DMUMeasureAngleHdr",r=[{name:"DMUMeasure3PointsHdrStr",line:1,hdr_list:["DMUMeasureAngleHdr","DMUMeasureDiameterHdr","DMUMeasureRadiusHdr"],selectedHdr:e="Measure3PointsAngle"===this._sType&&this.getAttribute("fAngle")>0?"DMUMeasureAngleHdr":this.compareAttributes([{name:"bRadiusDisplay",value:!0}])?"DMUMeasureRadiusHdr":"DMUMeasureDiameterHdr"}]);return r},getContextualCommandList:function(){var e=null;if(!this.isReadOnly()&&this.isInEdition()){if(this._isInCreationState&&("3dPlay"===this._typeApps||"3dPlayProPointPoint"===this._typeApps))return;if("3dPlay"===this._typeApps||"Geovia"===this._typeApps)return[{name:"DMUMeasureDeleteStr",line:1,hdr_list:["DMUMeasureDeleteHdr"]}];var r="Measure_DMUDefaultStyleHdr";this.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new i.Color("#000000")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new i.Color("#ffffff")},{name:"bIsFilled",value:!1},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new i.Color("#3d3d3d")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new i.Color("#3d3d3d")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Measure_DMULightStyleHdr":this.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new i.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new i.Color("#368ec4")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new i.Color("#3d3d3d")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new i.Color("#3d3d3d")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Measure_DMUMeasureStyleHdr":this.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new i.Color("#000000")},{name:"sFontStyle",value:"italic"},{name:"cFillStyleColor",value:new i.Color("#fee000")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new i.Color("#ff8a2e")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new i.Color("#ff8a2e")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Measure_DMUPostitStyleHdr":this.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new i.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new i.Color("#57b847")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new i.Color("#477738")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new i.Color("#477738")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Measure_DMUValidateStyleHdr":this.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new i.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new i.Color("#ff8a2e")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new i.Color("#8f4c00")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new i.Color("#8f4c00")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Measure_DMUWarningStyleHdr":this.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new i.Color("#ffffff")},{name:"sFontStyle",value:"bold"},{name:"cFillStyleColor",value:new i.Color("#cc092f")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new i.Color("#6d2828")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new i.Color("#6d2828")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))&&(r="Measure_DMUCautionStyleHdr");var n,l=[],o=[];if(s.isEnvActivated("measuredetaildisplay",!0)&&"2D"!==this.getAttribute("sMeasureOnGeometryType")&&(o=[{name:"DMUMeasureDisplayStr",line:1,hdr_list:["DMUMeasureDisplayHdr"]}]),this._isInCreationState)l=this.getCmdHdrsFor2DGeometries(),n=[{name:"Measure_DMUStylesStr",line:1,hdr_list:["Measure_DMUDefaultStyleHdr","Measure_DMULightStyleHdr","Measure_DMUMeasureStyleHdr","Measure_DMUPostitStyleHdr","Measure_DMUValidateStyleHdr","Measure_DMUWarningStyleHdr","Measure_DMUCautionStyleHdr"],selectedHdr:r},{name:"Measure_DMUIncreaseFontSizeStr",line:1,hdr_list:["Measure_DMUIncreaseFontSizeHdr"]},{name:"Measure_DMUDecreaseFontSizeStr",line:1,hdr_list:["Measure_DMUDecreaseFontSizeHdr"]}],o.length>0&&(n=o.concat(n));else{n=[{name:"Measure_DMUStylesStr",line:1,hdr_list:["Measure_DMUDefaultStyleHdr","Measure_DMULightStyleHdr","Measure_DMUMeasureStyleHdr","Measure_DMUPostitStyleHdr","Measure_DMUValidateStyleHdr","Measure_DMUWarningStyleHdr","Measure_DMUCautionStyleHdr"],selectedHdr:r},{name:"Measure_DMUIncreaseFontSizeStr",line:1,hdr_list:["Measure_DMUIncreaseFontSizeHdr"]},{name:"Measure_DMUDecreaseFontSizeStr",line:1,hdr_list:["Measure_DMUDecreaseFontSizeHdr"]},{name:"DMUGraphicPropertiesPanelHdr",line:1,hdr_list:["DMUGraphicPropertiesPanelHdr"]}],o.length>0&&(n=o.concat(n));for(var u=t.getReviewContext({viewer:this._viewer}).getUIManager().getSelectedObjects(),c=!1,d=0;d<u.length;d++)if("Measure3PointsCircle"===u[d]._sType||"MeasureItem"===u[d]._sType&&(u[d]._sResultingType1===a.ResultType.CIRCLE||u[d]._sResultingType1===a.ResultType.CYLINDER||u[d]._sResultingType1===a.ResultType.SPHERE)){if(u[d]._sResultingType1===a.ResultType.CYLINDER||u[d]._sResultingType1===a.ResultType.SPHERE){var m=this.getAttribute("sSurfaceDisplayType");if("Radius"===m||"Diameter"===m||"MinimumRadius"===m||"MinimumDiameter"===m||"MaximumRadius"===m||"MaximumDiameter"===m){c=!0;break}}else c=!0;break}if(c){var p=this.compareAttributes([{name:"bRadiusDisplay",value:!0}])?"DMUMeasureRadiusHdr":"DMUMeasureDiameterHdr";Math.abs(2*Math.PI-this.getMeasurable(1)._arcAngle)>.001&&this.getAttribute("bArcLengthDisplay")||l.push({name:"DMUMeasureDiameterOrRadiusStr",line:1,hdr_list:["DMUMeasureDiameterHdr","DMUMeasureRadiusHdr"],selectedHdr:p})}}e=l.length>0?l.concat(n):n,"DMUTemporaryBag"===this.getParent().getType()&&(this._isInCreationState||(e=e.concat([{name:"DMUMeasureDeleteStr",line:1,hdr_list:["DMUMeasureDeleteHdr"]}])))}return e},getSharedHeaderTypes:function(){var e=!1,t=!1,a=!1;return this.getAttribute("sLeaderEndType")&&(e=!0),this.getAttribute("sPointType")&&(t=!0),this.getAttribute("sExtremityType")&&(a=!0),{fontProperties:!0,leaderProperties:e,hideShowLeaderProperties:!1,pointTypeProperties:t,extremityTypeProperties:a}},getSharedContextualMenuCommandList:function(e){var t=[];e&&e.length&&e.forEach(function(e){-1===t.indexOf(e.getType())&&t.push(e.getType())});var i,r=!1,n=!0,l=!1,o=!1,u=!1,c=!0,d=!0,m=!0;this.cmdHdrState_list=[];for(var p=0;p<e.length;p++){if(e[p].getSharedHeaderTypes){var h=e[p].getSharedHeaderTypes();h?(h.leaderProperties?(r=!0,h.hideShowLeaderProperties&&(l=!0)):n=!1,h.pointTypeProperties&&(o=!0),h.extremityTypeProperties&&(u=!0)):(r=!1,o=!1,u=!1)}!n||e[0].getAttribute("sLeaderEndType")===e[p].getAttribute("sLeaderEndType")&&e[0].getAttribute("bHasALeader")===e[p].getAttribute("bHasALeader")||(n=!1),c&&e[0].getAttribute("sPointType")!==e[p].getAttribute("sPointType")&&(c=!1),d&&e[0].getAttribute("sExtremityType")!==e[p].getAttribute("sExtremityType")&&(d=!1),m&&e[0].getAttribute("bShortDisplay")!==e[p].getAttribute("bShortDisplay")&&(m=!1)}if(r&&(i={line:1,name:"DMULeaderStr",hdr_list:["DMUArrowLeaderHdr","DMUBubbleLeaderHdr","DMUCrossLeaderHdr","DMUSquareLeaderHdr","DMUNoEndLeaderHdr"],resourceFile:"DMUBaseCtxCommands/DMUBaseCtxCommands"},l&&i.hdr_list.push("DMUNoLeaderHdr"),e.length>0)){var y=!1,_=!1,M=!1,g=!1,v=!1,D=!1;if(n){var f=e[0].getAttribute("sLeaderEndType");switch(e[0].getAttribute("bHasALeader")||(f="None"),f){case"Arrow":y=!0;break;case"Bubble":_=!0;break;case"Cross":M=!0;break;case"Square":g=!0;break;case"No end":v=!0;break;case"None":D=!0}}for(var b=[{name:"DMUArrowLeaderHdr",state:y},{name:"DMUBubbleLeaderHdr",state:_},{name:"DMUCrossLeaderHdr",state:M},{name:"DMUSquareLeaderHdr",state:g},{name:"DMUNoEndLeaderHdr",state:v},{name:"DMUNoLeaderHdr",state:D}],S=0;S<b.length;S++)this.cmdHdrState_list.push(b[S])}if(o){var P=!1,T=!1,C=!1,A=!1,I=!1,E=!1,U=!1,w=!1,R=!1,L=!1,k=e[0].getAttribute("sPointType");if(c)switch(k){case"Cross":P=!0;break;case"Plus":T=!0;break;case"Concentric":C=!0;break;case"Coincident":A=!0;break;case"FullCircle":I=!0;break;case"FullSquare":E=!0;break;case"Star":U=!0;break;case"Dot":w=!0;break;case"SmallDot":R=!0;break;case"None":L=!0}for(var N=[{name:"DMUCrossPointTypeHdr",state:P},{name:"DMUPlusPointTypeHdr",state:T},{name:"DMUConcentricPointTypeHdr",state:C},{name:"DMUCoincidentPointTypeHdr",state:A},{name:"DMUFullCirclePointTypeHdr",state:I},{name:"DMUFullSquarePointTypeHdr",state:E},{name:"DMUStarPointTypeHdr",state:U},{name:"DMUDotPointTypeHdr",state:w},{name:"DMUSmallDotPointTypeHdr",state:R},{name:"DMUNonePointTypeHdr",state:L}],F=0;F<N.length;F++)this.cmdHdrState_list.push(N[F])}if(u){var O=e[0].getAttribute("sExtremityType"),G=!1,x=!1,H=!1,V=!1,B=!1,W=!1,j=!1,z=!1,K=!1,X=!1;if(d)switch(O){case"Cross":G=!0;break;case"Plus":x=!0;break;case"Concentric":H=!0;break;case"Coincident":V=!0;break;case"FullCircle":B=!0;break;case"FullSquare":W=!0;break;case"Star":j=!0;break;case"Dot":z=!0;break;case"SmallDot":K=!0;break;case"None":X=!0}for(var Y=[{name:"DMUCrossExtremityTypeHdr",state:G},{name:"DMUPlusExtremityTypeHdr",state:x},{name:"DMUConcentricExtremityTypeHdr",state:H},{name:"DMUCoincidentExtremityTypeHdr",state:V},{name:"DMUFullCircleExtremityTypeHdr",state:B},{name:"DMUFullSquareExtremityTypeHdr",state:W},{name:"DMUStarExtremityTypeHdr",state:j},{name:"DMUDotExtremityTypeHdr",state:z},{name:"DMUSmallDotExtremityTypeHdr",state:K},{name:"DMUNoneExtremityTypeHdr",state:X}],q=0;q<Y.length;q++)this.cmdHdrState_list.push(Y[q])}var J=[],Q=s.isEnvActivated("measuredetaildisplay",!0);if(Q||J.push({line:1,name:"DMUPropertiesStr",hdr_list:["DMUPropertiesHdr"]}),1===t.length&&-1!==t[0].indexOf("DMUMeasure")){if("DMUTemporaryBag"===this.getParent().getType()){if("2D"!==this.getAttribute("sMeasureOnGeometryType")||!this._isInCreationState&&"2D"===this.getAttribute("sMeasureOnGeometryType")){var Z=this.getParent().getDMUObjects("DMUMeasure");Z&&Z.length>1&&J.push({line:1,name:"DMUMeasureRemoveAllNonPersistentStr",hdr_list:["DMUMeasureRemoveAllNonPersistentHdr"]})}}else{if(this.isEditable()){this._isInCreationState||(J.push({line:1,name:"DMUCutStr",hdr_list:["DMUCutHdr"]}),J.push({line:1,name:"DMUCopyStr",hdr_list:["DMUCopyHdr"]}),J.push({line:1,name:"DMUHideShowStr",hdr_list:["DMUHideShowHdr"]}));var $=!0;if(void 0!==e&&e.length>0)for(var ee=0;ee<e.length;ee++){if(e[ee].getAttribute("sResultingType1")!==a.ResultType.CIRCLE&&"Measure3PointsCircle"!==e[ee].getAttribute("sType")){$=!1;break}"2D"===e[ee].getAttribute("sMeasureOnGeometryType")&&e[ee].getAttribute("bArcLengthDisplay")&&($=!1);break}$&&J.push({line:1,name:"DMUMeasureDimensionRepresentationHdr",hdr_list:["DMUMeasureArcCenterDisplayHdr","DMUMeasureArcTangentDisplayHdr"],resourceFile:"DMUMeasure/DMUMeasure"})}this._isInCreationState||J.push({line:1,name:"DMUDeleteStr",hdr_list:["DMUDeleteHdr"]})}this.isEditable()&&(r&&J.push(i),o&&this.getPointTypeHdr&&J.push(this.getPointTypeHdr()),u&&this.getExtremityTypeHdr&&J.push(this.getExtremityTypeHdr()),"2D"===this.getAttribute("sMeasureOnGeometryType")&&Q&&(J.push({name:"DMUMeasure2DDisplayStr",line:1,hdr_list:["DMUMeasure2DDisplayHdr"]}),m&&this.cmdHdrState_list.push({name:"DMUMeasure2DDisplayHdr",state:!e[0].getAttribute("bShortDisplay")})))}return J},register:function(e){this._parent({frmWindow:e.frmWindow,contextualBar:{type:"DMUMeasure",module:"DMUMeasure",workbenchName:"DMUMeasure"},contextualMenu:{type:"DMUMeasure",module:"DMUMeasure",workbenchName:"DMUMeasure"}})},unregister:function(e){this._parent({frmWindow:e.frmWindow,contextualBar:{type:"DMUMeasure",module:"DMUMeasure",workbenchName:"DMUMeasure"},contextualMenu:{type:"DMUMeasure",module:"DMUMeasure",workbenchName:"DMUMeasure"}})},applyStateToContextHdr:function(e){if(e.length>0)for(var t=0;t<e.length;t++){var a=r.getCommand(e[t].name,"Default");a&&a.setState&&a.setState(e[t].state)}},getPointTypeHdr:function(){return{line:1,name:"DMUPointTypeStr",hdr_list:["DMUCrossPointTypeHdr","DMUPlusPointTypeHdr","DMUConcentricPointTypeHdr","DMUCoincidentPointTypeHdr","DMUFullCirclePointTypeHdr","DMUFullSquarePointTypeHdr","DMUStarPointTypeHdr","DMUDotPointTypeHdr","DMUSmallDotPointTypeHdr","DMUNonePointTypeHdr"],resourceFile:"DMUBaseCtxCommands/DMUBaseCtxCommands"}},getExtremityTypeHdr:function(){return{line:1,name:"DMUExtremityTypeStr",hdr_list:["DMUCrossExtremityTypeHdr","DMUPlusExtremityTypeHdr","DMUConcentricExtremityTypeHdr","DMUCoincidentExtremityTypeHdr","DMUFullCircleExtremityTypeHdr","DMUFullSquareExtremityTypeHdr","DMUStarExtremityTypeHdr","DMUDotExtremityTypeHdr","DMUSmallDotExtremityTypeHdr","DMUNoneExtremityTypeHdr"],resourceFile:"DMUBaseCtxCommands/DMUBaseCtxCommands"}},setCheckCmdHdrState:function(e){this.applyStateToContextHdr&&e.length>0&&this.applyStateToContextHdr(e)}})}),define("DS/DMUMeasure/DMUMeasureContextCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/DMUBaseExperience/DMUContextManager"],function(e,t,a){"use strict";return e.extend({init:function(e){var i=e||{};i.mode="DMUMeasureDeleteHdr"!==i.ID?"shared":"exclusive",this._parent(i),this._bCmdState=!1;var r=function(e,t,a){e.setAttribute("bRadiusDisplay",a),"Measure3PointsAngle"===e.getAttribute("sType")&&(e.setAttribute("sType","Measure3PointsCircle"),e.setAttribute("sDistanceType","none"),localStorage.setItem("DMUMeasure3PointsDisplayPreferences","CircleBy3Points"),e.update()),e._sMeasurable1&&e._sMeasurable1.getArcAngle&&Math.abs(2*Math.PI-e._sMeasurable1.getArcAngle())>.001&&localStorage.setItem("DMUMeasureArcRadiusPreferences",t),e.updateGlobalRadiusPreference(a),e.getAttribute("bArcLengthDisplay")&&e.setAttribute("bArcLengthDisplay",!1),e.update2DArcDisplay(),e.updateMainValueDisplayAsPerPref()},s=function(e){e.getParent().removeDMUObjects?e.getParent().removeDMUObjects([e]):e.getParent().getCurrentSlide().removeDMUObject(e)},n=function(e){"Measure3PointsCircle"===e.getAttribute("sType")?(e.setAttribute("sType","Measure3PointsAngle"),e.setAttribute("sDistanceType","Angle"),localStorage.setItem("DMUMeasure3PointsDisplayPreferences","AngleBy3Points")):e.updateFeatureAndDistanceTypePreference("Angle"),e.update()},l=function(e){e.setAttribute("bShortDisplay",!e.getAttribute("bShortDisplay")),e.getAttribute("bShortDisplay")?localStorage.setItem("DMUMeasureDisplayPreference","Short"):localStorage.setItem("DMUMeasureDisplayPreference","Extended")};this.beginExecute=function(){var e,i=this,o=t.get();o.length>0&&(e=a.getReviewContext({viewer:i.getFrameWindow().getViewer()}))&&(!function(){for(var t=0;t<o.length;t++){var a=e.getDMUObjectFromPathElement(o[t].pathElement);if(a){switch(i._id){case"DMUMeasureArcLengthHdr":a.setAttribute("bArcLengthDisplay",!0),localStorage.setItem("DMUMeasureArcRadiusPreferences","DisplayArcLength"),a.update2DArcDisplay(),a.updateMainValueDisplayAsPerPref();break;case"DMUMeasureDiameterHdr":r(a,"DisplayDiameter",!1);break;case"DMUMeasureRadiusHdr":r(a,"DisplayRadius",!0);break;case"DMUMeasure2DDisplayHdr":l(a);break;case"DMUMeasureDisplayHdr":a.setAttribute("bShortDisplay",!a.getAttribute("bShortDisplay"));break;case"DMUMeasureAngleHdr":n(a);break;case"DMUMeasureDistanceHdr":a.updateFeatureAndDistanceTypePreference("Distance"),a.update();break;case"DMUMeasureMinDistanceHdr":a.updateFeatureAndDistanceTypePreference("MinimumDistance"),a.update();break;case"DMUMeasureLocalMinDistanceHdr":a.updateFeatureAndDistanceTypePreference("LocalMinimumDistance"),a.update();break;case"DMUMeasureMaxDistanceHdr":a.updateFeatureAndDistanceTypePreference("MaximumDistance"),a.update();break;case"DMUMeasureLocalMaxDistanceHdr":a.updateFeatureAndDistanceTypePreference("LocalMaximumDistance"),a.update();break;case"DMUMeasureSurfaceRadiusHdr":a.setAttribute("bRadiusDisplay",!0),a.updateFeatureAndSurfaceDisplayTypePreference("Radius"),a.update();break;case"DMUMeasureSurfaceDiameterHdr":a.setAttribute("bRadiusDisplay",!1),a.updateFeatureAndSurfaceDisplayTypePreference("Diameter"),a.update();break;case"DMUMeasureSurfaceMaximumRadiusHdr":a.setAttribute("bRadiusDisplay",!0),a.updateFeatureAndSurfaceDisplayTypePreference("MaximumRadius"),a.update();break;case"DMUMeasureSurfaceMaximumDiameterHdr":a.setAttribute("bRadiusDisplay",!1),a.updateFeatureAndSurfaceDisplayTypePreference("MaximumDiameter"),a.update();break;case"DMUMeasureSurfaceMinimumRadiusHdr":a.setAttribute("bRadiusDisplay",!0),a.updateFeatureAndSurfaceDisplayTypePreference("MinimumRadius"),a.update();break;case"DMUMeasureSurfaceMinimumDiameterHdr":a.setAttribute("bRadiusDisplay",!1),a.updateFeatureAndSurfaceDisplayTypePreference("MinimumDiameter"),a.update();break;case"DMUMeasureSurfaceLengthHdr":a.updateFeatureAndSurfaceDisplayTypePreference("Length"),a.update();break;case"DMUMeasureSurfaceAreaHdr":a.updateFeatureAndSurfaceDisplayTypePreference("Area"),a.update();break;case"DMUMeasureSurfaceAngleHdr":a.updateFeatureAndSurfaceDisplayTypePreference("Angle"),a.update();break;case"DMUMeasureSurfaceHalfAngleHdr":a.updateFeatureAndSurfaceDisplayTypePreference("HalfAngle"),a.update();break;case"DMUMeasureProductAreaHdr":a.updateFeatureAndProductDisplayTypePreference("Area"),a.update();break;case"DMUMeasureProductVolumeHdr":a.updateFeatureAndProductDisplayTypePreference("Volume"),a.update();break;case"DMUMeasureDeleteHdr":s(a),t--}a.refreshNode()}}}(),i.getFrameWindow().getViewer().render(),e.getCurrentSessionMarkup()&&e.getCurrentSessionMarkup().isVisible()&&e.getCurrentSessionMarkup().getCurrentSlide()&&e.getCurrentSessionMarkup().getCurrentSlide().fireEvent("onSlidePreviewRefreshRequired",{dmuObject:e.getCurrentSessionMarkup().getCurrentSlide()}))}},getState:function(){return this._bCmdState},setState:function(e){this._bCmdState=e}})}),define("DS/DMUMeasure/DMUMeasureRemoveAllNonPersistentCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/DMUBaseExperience/DMUContextManager","DS/DMUControls/DMUWarningPanel","i18n!DS/DMUMeasure/assets/nls/DMUMeasure"],function(e,t,a,i,r){"use strict";var s;return e.extend({init:function(e){e.mode="shared",this._parent(e)},beginExecute:function(){var e=this;if(s)e.end();else{s=new i({title:r.removeAllNonPersistentWarningPanel.title,message:r.removeAllNonPersistentWarningPanel.message,frmWindow:this.getFrameWindow(),callbacks:{onValidateCB:function(){!function(){if(t.get().length>0){var i=a.getReviewContext({viewer:e.getFrameWindow().getViewer()});if(i){var r=i.getTransientReviewBag();if(r){var s=r.getDMUObjects("DMUMeasure");r.removeDMUObjects&&r.removeDMUObjects(s)}}}}(),s=null},onCancelCB:function(){e.end(),s=null},onCloseCB:function(){e.end(),s=null}}})}},destroy:function(){s&&s.destroy(),this._parent()}})}),define("DS/DMUMeasure/DMUCreateMeasureCmd",["DS/DMUMeasure/DMUMeasureBaseCmd","DS/Web3DUXFilterBar/Web3DUXFilterBar","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUMeasureEnums","DS/DMUBaseExperience/EXPUtils","i18n!DS/DMUMeasure/assets/nls/DMUMeasure"],function(e,t,a,i,r,s){"use strict";return e.extend({init:function(e){this._parent(e,"exclusive",!0)},_initPref:function(){localStorage.getItem("DMUMeasureCylinderRadiusPreferences")||localStorage.setItem("DMUMeasureCylinderRadiusPreferences","DisplayDiameter"),localStorage.getItem("DMUMeasureSphereRadiusPreferences")||localStorage.setItem("DMUMeasureSphereRadiusPreferences","DisplayDiameter"),this._parent()},_updateFilter:function(e){var t={acceptedGeometries:[],viewedGeometries:[]};return e.getActiveState("pickpoint")?t.viewedGeometries.push(i.ViewedType.POINT):e.getActiveState("product")?t.viewedGeometries.push(i.ViewedType.PRODUCT):(e.getActiveState("center")&&(t.acceptedGeometries.push(a.GeometryType.CIRCLE),t.acceptedGeometries.push(a.GeometryType.SPHERE),t.viewedGeometries.push(i.ViewedType.CENTER)),e.getActiveState("linecurve")&&(t.acceptedGeometries.push(a.GeometryType.LINE),t.acceptedGeometries.push(a.GeometryType.CIRCLE),t.acceptedGeometries.push(a.GeometryType.CURVE),t.viewedGeometries.push(i.ViewedType.CURVE)),e.getActiveState("axis")&&(t.acceptedGeometries.push(a.GeometryType.LINE),t.acceptedGeometries.push(a.GeometryType.CYLINDER),t.acceptedGeometries.push(a.GeometryType.CONE),t.viewedGeometries.push(i.ViewedType.AXIS)),e.getActiveState("circle")&&(t.acceptedGeometries.push(a.GeometryType.CIRCLE),t.viewedGeometries.push(i.ViewedType.CIRCLE)),e.getActiveState("surface")&&(t.acceptedGeometries.push(a.GeometryType.CYLINDER),t.acceptedGeometries.push(a.GeometryType.CONE),t.acceptedGeometries.push(a.GeometryType.SPHERE),t.acceptedGeometries.push(a.GeometryType.PLANE),t.acceptedGeometries.push(a.GeometryType.SURFACE),t.viewedGeometries.push(i.ViewedType.SURFACE)),e.getActiveState("plane")&&(t.acceptedGeometries.push(a.GeometryType.PLANE),t.viewedGeometries.push(i.ViewedType.INFPLANE)),e.getActiveState("cylinder")&&(t.acceptedGeometries.push(a.GeometryType.CYLINDER),t.acceptedGeometries.push(a.GeometryType.CONE),t.acceptedGeometries.push(a.GeometryType.SPHERE),t.viewedGeometries.push(i.ViewedType.CYCOSP)),e.getActiveState("allCanonicGeom")&&(t.acceptedGeometries.push(a.GeometryType.POINT),t.acceptedGeometries.push(a.GeometryType.LINE),t.acceptedGeometries.push(a.GeometryType.CIRCLE),t.acceptedGeometries.push(a.GeometryType.PLANE),t.acceptedGeometries.push(a.GeometryType.CYLINDER),t.acceptedGeometries.push(a.GeometryType.CONE),t.acceptedGeometries.push(a.GeometryType.SPHERE),t.viewedGeometries.push(i.ViewedType.POINT),t.viewedGeometries.push(i.ViewedType.CURVE),t.viewedGeometries.push(i.ViewedType.CIRCLE),t.viewedGeometries.push(i.ViewedType.INFPLANE),t.viewedGeometries.push(i.ViewedType.SURFACE),t.viewedGeometries.push(i.ViewedType.CYCOSP))),this._pathElementAgentWithCSO.options.acceptedGeometries=t.acceptedGeometries,this._pathElementAgentWithCSO.options.viewedGeometries=t.viewedGeometries,this._pathElementAgentWithoutCSO.options.acceptedGeometries=t.acceptedGeometries,this._pathElementAgentWithoutCSO.options.viewedGeometries=t.viewedGeometries,t},_createFilter:function(){var e=this,a=[];a=r.isEnvActivated("measure_OldSelectionFilter",!0)?[{nls:s.point,url:this._iconDir+"I_Meas_Point.png",id:"pickpoint",type:"element",callback:function(){e._filterUI.getActiveState("pickpoint")?e._activeFilter="pointOnly":e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!0,bstateActif:"3dPlay"===this._measureCommandMode||"Geovia"===this._arguments[0].ID},{type:"separator"},{nls:s.center+"/"+s.point,url:this._iconDir+"I_Meas_PointCircle.png",id:"center",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!1,bstateActif:!1},{nls:s.line+"/"+s.curve,url:this._iconDir+"I_Meas_LineCurve.png",id:"linecurve",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!1,bstateActif:!1},{nls:s.axis+"/"+s.infiniteline,url:this._iconDir+"I_Meas_AxisInfiniteLine.png",id:"axis",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!1,bstateActif:!1},{nls:s.circle,url:this._iconDir+"I_Meas_Circle.png",id:"circle",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!1,bstateActif:!1},{nls:s.surface,url:this._iconDir+"I_Meas_Surface.png",id:"surface",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!1,bstateActif:"Thickness"===this._arguments[0].ID},{nls:s.plane,url:this._iconDir+"I_Meas_Plane.png",id:"plane",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!1,bstateActif:!1},{nls:s.cylinder+"/"+s.cone+"/"+s.sphere,url:this._iconDir+"I_Meas_Cylinder.png",id:"cylinder",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!1,bstateActif:!1},{type:"separator"},{nls:s.product,url:this._iconDir+"I_Meas_Product.png",id:"product",type:"element",callback:function(){e._filterUI.getActiveState("product")?e._activeFilter="productOnly":e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!0,bstateActif:!1}]:[{nls:s.point,url:this._iconDir+"I_Meas_Point.png",id:"pickpoint",type:"element",callback:function(){e._filterUI.getActiveState("pickpoint")?e._activeFilter="pointOnly":e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!0,bstateActif:"3dPlay"===this._measureCommandMode||"Geovia"===this._arguments[0].ID,bManageOpacity:!1},{type:"separator"},{nls:s.centerpoint,url:this._iconDir+"I_Meas_PointCircle.png",id:"center",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!0,bstateActif:!1},{type:"separator"},{nls:s.canonicGeometries,url:this._iconDir+"I_Meas_AllGeom.png",id:"allCanonicGeom",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!0,bstateActif:!1},{type:"separator"},{nls:s.product,url:this._iconDir+"I_Meas_Product.png",id:"product",type:"element",callback:function(){e._filterUI.getActiveState("product")?e._activeFilter="productOnly":e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!0,bstateActif:!1}],this._filterUI=new t({body:this._frmWindow.getUIFrame(),frmWindow:this._frmWindow,title:"Filter Control",typeSeparator:"bubble",actionBar:this._frmWindow.getActionBar(),lJsonElement:a}),this._filterUI.build()},beginExecute:function(){this._parent(),this._filterUI||this._createFilter(),this._objAction||(this._filteredGeometries=this._updateFilter(this._filterUI)),"3dPlay"!==this._measureCommandMode&&"Thickness"!==this._arguments[0].ID&&"Geovia"!==this._arguments[0].ID&&"3dAuthoringPickPoint"!==this._measureCommandMode&&"ProgressiveVisuLoading"!==this._measureCommandMode||this._filterUI.setVisibleFlag(!1)}})}),define("DS/DMUMeasure/DMUCreateMeasure2DCmd",["DS/DMUMeasure/DMUMeasureBaseCmd","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUMeasureEnums","DS/Selection/HSOManager"],function(e,t,a,i){"use strict";return e.extend({init:function(e){this._measureOnGeometryType="2D",this._parent(e,"exclusive",!0)},_initPref:function(){localStorage.getItem("DMUMeasBetween2CirclesDistancePref")||localStorage.setItem("DMUMeasBetween2CirclesDistancePref","Distance"),localStorage.getItem("DMUMeasBetweenCircleArcDistancePref")||localStorage.setItem("DMUMeasBetweenCircleArcDistancePref","Distance"),localStorage.getItem("DMUMeasBetweenCircleAnygeomDistancePref")||localStorage.setItem("DMUMeasBetweenCircleAnygeomDistancePref","Distance"),localStorage.getItem("DMUMeasBetween2ArcsDistancePref")||localStorage.setItem("DMUMeasBetween2ArcsDistancePref","MinimumDistance"),localStorage.getItem("DMUMeasBetweenArcAnygeomDistancePref")||localStorage.setItem("DMUMeasBetweenArcAnygeomDistancePref","MinimumDistance"),localStorage.getItem("DMUMeasBetween2ParallelLinesDistancePref")||localStorage.setItem("DMUMeasBetween2ParallelLinesDistancePref","Distance"),localStorage.getItem("DMUMeasBetween2LinesDistancePref")||localStorage.setItem("DMUMeasBetween2LinesDistancePref","Angle"),localStorage.getItem("DMUMeasBetween2AnyGeomsDistancePref")||localStorage.setItem("DMUMeasBetween2AnyGeomsDistancePref","MinimumDistance"),localStorage.getItem("DMUMeasureDisplayPreference")||localStorage.setItem("DMUMeasureDisplayPreference","Short"),this._parent()},_selectBestType:function(e,t){var a,i=e.retrievePossibleSelectedType(t);return i.length&&(a=i[0]),a},retrieveBetweenResultType:function(e,t,a){return this.retrieveItemResultType(a._type,e)},retrievePossibleSelectedType:function(e){var i=[],r=e.getType();return r===t.GeometryType.LINE||r===t.GeometryType.CURVE?i.push(a.ViewedType.CURVE):r===t.GeometryType.CIRCLE?i.push(a.ViewedType.CIRCLE):i.push(a.ViewedType.POINT),i},_checkForSelection:function(e){var t=!0;if(this._measurable&&this._measurable.length&&this._measurable[0]&&this._measurable[0]._pathElement&&this._measurable[0]._pathElement.externalPath&&e&&e[0]&&e[0].pathElement&&e[0].pathElement.externalPath){var a=this._measurable[this._measurable.length-1],r=a._pathElement.externalPath,s=e[0].pathElement.externalPath;if(r&&s&&r.length>2&&s.length>2)r[r.length-2]!==s[s.length-2]&&(t=!1,i.remove(e[0]),i.add({pathElement:a._pathElement}))}return t},_retrieveDistanceTypeFor2DMeasures:function(){var e,a,i={},r="MinimumDistance",s=this._measurable[0],n=this._measurable[1];if(s._type!==t.GeometryType.CIRCLE&&n._type!==t.GeometryType.CIRCLE||(Math.abs(2*Math.PI-s._arcAngle)>.001&&(e=!0),Math.abs(2*Math.PI-n._arcAngle)>.001&&(a=!0)),e&&a)localStorage.getItem("DMUMeasBetween2ArcsDistancePref")&&(r=localStorage.getItem("DMUMeasBetween2ArcsDistancePref"),i.localprefName="DMUMeasBetween2ArcsDistancePref");else if(e&&n._type===t.GeometryType.CIRCLE||a&&s._type===t.GeometryType.CIRCLE)localStorage.getItem("DMUMeasBetweenCircleArcDistancePref")&&(r=localStorage.getItem("DMUMeasBetweenCircleArcDistancePref"),i.localprefName="DMUMeasBetweenCircleArcDistancePref");else if(e&&n._type!==t.GeometryType.CIRCLE||a&&s._type!==t.GeometryType.CIRCLE)localStorage.getItem("DMUMeasBetweenArcAnygeomDistancePref")&&(r=localStorage.getItem("DMUMeasBetweenArcAnygeomDistancePref"),i.localprefName="DMUMeasBetweenArcAnygeomDistancePref");else if(s._type===t.GeometryType.CIRCLE&&n._type===t.GeometryType.CIRCLE)localStorage.getItem("DMUMeasBetween2CirclesDistancePref")&&(r=localStorage.getItem("DMUMeasBetween2CirclesDistancePref"),i.localprefName="DMUMeasBetween2CirclesDistancePref");else if(s._type===t.GeometryType.CIRCLE&&n._type!==t.GeometryType.CIRCLE||n._type===t.GeometryType.CIRCLE&&n._type!==t.GeometryType.CIRCLE)localStorage.getItem("DMUMeasBetweenCircleAnygeomDistancePref")&&(r=localStorage.getItem("DMUMeasBetweenCircleAnygeomDistancePref"),i.localprefName="DMUMeasBetweenCircleAnygeomDistancePref");else if(s._type===t.GeometryType.LINE&&n._type===t.GeometryType.LINE){var l=s.getPoints().endPoint.clone().sub(s.getPoints().beginPoint),o=n.getPoints().endPoint.clone().sub(n.getPoints().beginPoint),u=l.normalize().dot(o.normalize());1===Math.abs(u)?localStorage.getItem("DMUMeasBetween2ParallelLinesDistancePref")&&(r=localStorage.getItem("DMUMeasBetween2ParallelLinesDistancePref"),i.localprefName="DMUMeasBetween2ParallelLinesDistancePref"):localStorage.getItem("DMUMeasBetween2LinesDistancePref")&&(r=localStorage.getItem("DMUMeasBetween2LinesDistancePref"),i.localprefName="DMUMeasBetween2LinesDistancePref")}else localStorage.getItem("DMUMeasBetween2AnyGeomsDistancePref")&&(r=localStorage.getItem("DMUMeasBetween2AnyGeomsDistancePref"),i.localprefName="DMUMeasBetween2AnyGeomsDistancePref");return i.distanceType=r,i}})});