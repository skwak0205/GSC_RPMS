var VCXGlobalDiggerCompare=function(e,i){return e.key-i.key},VCXGlobalDiggerCompareOpposite=function(e,i){return i.key-e.key};define("DS/VCXWebDiggerKernel/VCXDiggerKernel",["DS/Core/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/WebRBTree/WebRBTree","DS/WebRBTree/WebRBIterator","DS/VCXWebExperienceBase/VCXOverridesChangeServices","DS/VCXWebExperienceBase/VCXSceneGraphOverridesServices","DS/VCXWebVisibility/VCXIVisibility"],function(e,i,t,n,r,o,s,a,h){"use strict";var c=i.extend({init:function(){this._depth=0,this._zoomFactor=.5,this._zoomNavigation=0,this._mode=c.EMode.Zoom,this._attach=!0,this._attachP=null,this._lockViewpoint=!1,this._lockPlanes=!1,this._target=null,this._position=null,this._lockSynchronizeDiggerViewpoint=!1,this._previousVPTarget=new t.Vector3(0,0,0),this._previousVPOrientation=new t.Quaternion(0,0,0,0),this._lockCenter=!1,this._sphereCenter=null,this._doubleDirection=!1,this._lockPickability=!1,this._lockOpacity=!1,this._diggMode=c.EDigMode.Linear,this.distanceType=c.EDigDistance.Plan,this.boundingType=c.EDigBounding.Box,this._invertDirection=!1,this._lockUpdateDigger=!1,this.resetArray(),this._positionPx=null,this._radiusPx=null,this._torchFilter=!0,this._experienceBase=null,this._viewer=null,this._SceneGraphOverrideSet=null,this._SortTimer=null,this._updatePickabilityTimer=null;var e=this;this.onChangeViewpoint=function(i){if("@onViewpointChange"===i.eventType){if(!e.isFullViewer())return;if(e._lockSynchronizeDiggerViewpoint)return;if(!(e._viewer&&e._viewer.currentViewpoint&&e._viewer.currentViewpoint.getControl()&&i.viewpoint))return;if(e._diggMode!==c.EDigMode.Linear)return;if(e.getLockViewpoint())return;var t=e._viewer.currentViewpoint.target,n=e._viewer.currentViewpoint.getControl().orientation;if(n.equals(e._previousVPOrientation)&&t.equals(e._previousVPTarget))return;if(e._previousVPTarget.copy(t),e._previousVPOrientation.copy(n),e._mode!==c.EMode.Onion&&e._mode!==c.EMode.XRay)return;if(e.getLockPlanes())return;if(e._lockUpdateDigger)return;e._lockPickability=!0,e.updateDigger(),e._updatePickabilityTimer&&(window.clearTimeout(e._updatePickabilityTimer),e._updatePickabilityTimer=null),e._updatePickabilityTimer=window.setTimeout(function(){window.clearTimeout(e._updatePickabilityTimer),e._updatePickabilityTimer=null,e._lockPickability=!1,e._lockOpacity=!0,e.updateDiggerContent(),e._lockOpacity=!1},500)}},this.onPropertiesChanged=function(i){if(null!=i){var t=!1,n=i;for(var r in n._map)if(n._map.hasOwnProperty(r)){var o=n.GetPropertySet(r);for(var s in o._map){if(o._map.hasOwnProperty(s))"Actor.Opacity"===o._map[s]&&(t=!0)}}t&&(e._opacityObj=[])}},this.onScenarioChanged=function(){void 0!==e._viewer&&null!==e._viewer&&(e.resetArray(),e._SceneGraphOverrideSet&&(e.removeOverrides(),e._SceneGraphOverrideSet=a.createAndPushSceneGraphOverrideSet(e._experienceBase,e._viewer)),e.updateDigger())},this._tokenChangeViewpoint=n.subscribe({event:"/VISU/"},this.onChangeViewpoint),this._tokenPropertiesChanged=n.subscribe({event:"VCX_PROPERTIES_CHANGED"},this.onPropertiesChanged),this._tokenScenarioChanged=n.subscribe({event:"VCX_CURRENT_SCENARIO_CHANGED"},this.onScenarioChanged),this._tokenSelectionAdd=n.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_ADD"},function(){e.onChangeCSO()}),this._tokenSelectionRemove=n.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_REMOVE"},function(){e.onChangeCSO()})},resetTorchInfo:function(){this._torchInfo={},this._torchInfo._isInTorchArray=[],this._torchInfo._pathElementArray=[],this._torchInfo._nbModifiableInTorch=0},resetArray:function(e){void 0===e&&(e=!0),this._zOrder=[],this._zOppositeOrder=[],e&&(this._opacityObj=[],this._modifiableBBoxInWCS=[]),this._modifiableProjectMinMax={},this.resetTorchInfo()},dispose:function(){null!==this._tokenChangeViewpoint&&(n.unsubscribe(this._tokenChangeViewpoint),this._tokenChangeViewpoint=null),null!==this._tokenPropertiesChanged&&(n.unsubscribe(this._tokenPropertiesChanged),this._tokenPropertiesChanged=null),null!==this._tokenScenarioChanged&&(n.unsubscribe(this._tokenScenarioChanged),this._tokenScenarioChanged=null),this._tokenSelectionAdd&&(n.unsubscribe(this._tokenSelectionAdd),this._tokenSelectionAdd=null),this._tokenSelectionRemove&&(n.unsubscribe(this._tokenSelectionRemove),this._tokenSelectionRemove=null),this.resetArray()},isFullViewer:function(){return null===this._radiusPx},setMode:function(e){this._mode=e},getMode:function(){return this._mode},setAttach:function(e){this._attach=e},getAttach:function(){return this._attach},lockViewpoint:function(e){this._lockViewpoint=e},getLockViewpoint:function(){return this._lockViewpoint},lockPlanes:function(e){this._lockPlanes=e},getLockPlanes:function(){return this._lockPlanes},invertDirection:function(e){this._invertDirection=e},getInvertDirection:function(){return this._invertDirection},setDepth:function(e){this._depth=e},getDepth:function(){return this._depth},resetDepth:function(){this._depth=0},resetZoom:function(){this._zoomFactor=0},setZoom:function(e){this._zoomFactor=e},getZoom:function(){return this._zoomFactor},setDepthZoom:function(e){this._zoomNavigation=e},getDepthZoom:function(){return this._zoomNavigation},onChangeCSO:function(e){this._diggMode!==c.EDigMode.Spherical||this._lockCenter||(this.sortFrontToBack(),this.updateDiggerContent(!0))},getPositionPx:function(){return this._positionPx},getRadiusPx:function(){return this._radiusPx},setTorchFilter:function(e){this._torchFilter=e},getTorchFilter:function(){return this._torchFilter},removeOverrides:function(){this._SceneGraphOverrideSet&&(a.removeSceneGraphOverrideSet(this._experienceBase,this._SceneGraphOverrideSet,this._viewer),this._SceneGraphOverrideSet=null)},getBBoxInWCS:function(e){var i=e.getBoundingBox(null,this._viewer);return i.min.x===1/0||i.min.y===1/0||i.min.z===1/0||i.max.x===-1/0||i.max.y===-1/0||i.max.z===-1/0?null:(i.applyMatrix4(e.getWorldMatrix(this._viewer)),i)},projectBBox:function(e){},calcSphereCenterSelection:function(){var i=e.Selection.CSOManager.get();return this.calcSphereCenterArray(i)},calcSphereCenterArray:function(e){var i=null;if(e&&e.length){for(var t=0,n=0;n<e.length;n++){var r=e[n];if(r){var o=r.pathElement;if(o){var s=this.getBBoxInWCS(o);s&&(i?i.add(s.center()):i=s.center(),t++)}}}t>1&&i.divideScalar(t)}if(null===i){var a=this._experienceBase.getManager("VCXContextManager");if(a){var h=a.getRootPathElement();if(h)i=h.getBoundingBox(null,this._viewer).center()}}return i},calcProjection:function(e,i){var n=null,r=this._experienceBase.getManager("VCXContextManager").getMainViewer();if(r&&(n=r.currentViewpoint),null===n)return!1;this.getRadiusPx();for(var o=new t.Vector2,s=new t.Vector2,a=0;a<i.length;a++){var h=i[a],c=n.project(h);0==a?(o.x=c.x,o.y=c.y,s.x=c.x,s.y=c.y):(o.x=Math.min(o.x,c.x),o.y=Math.min(o.y,c.y),s.x=Math.max(s.x,c.x),s.y=Math.max(s.y,c.y))}var l=e.QueryInterface("VCXIModifiable");return l&&(this._modifiableProjectMinMax[l.GetHashing()]={pntMin:o,pntMax:s}),!0},isInTorch:function(e){var i;if(!(e in this._modifiableProjectMinMax))return!1;var t=(i=this._modifiableProjectMinMax[e]).pntMin.clone(),n=i.pntMax.clone();if(this._attach){var r=this._attachP;r&&(t.x-=r.x,t.y-=r.y,n.x-=r.x,n.y-=r.y)}else{var o=this.getPositionPx();o&&(t.x-=o.x,t.y-=o.y,n.x-=o.x,n.y-=o.y)}var s=this.getRadiusPx();return t.x<=s&&n.x>=-s&&t.y<=s&&n.y>=-s},GetListComponent:function(){for(var e=this._experienceBase.ComponentsMap.GetComponentFromType("VCXWebComponentOccurrence"),i=[],t=0;t<e.length;t++){((o=e[t]).IsKindOf(["VCXComponentPoint","VCXComponentCurveWire","VCXComponentCompositePmi"])||o.IsMesh&&o.IsMesh())&&i.push(o)}var n=this._experienceBase.ComponentsMap.GetComponentFromType("VCXDressup_Spec"),r=[];for(t=0;t<n.length;t++){var o;if(!(o=n[t]).IsKindOf(["VCXDigger_Spec","VCXViewport_Spec","CXPCameraActor_Spec"]))if(o.QueryInterface("W3AISGNodeHolder")){var s=1,a=o.QueryInterface("VCXIVisibility");a&&(s=a.GetVisibility()),s!==h.EVisState.Hidden&&r.push(o)}}return i.concat(r)},calcDistanceMinMax:function(e,i,n,r,o,s){var a=0;if(this._diggMode===c.EDigMode.Linear){if(this.distanceType===c.EDigDistance.Plan){var h=(new t.Vector3).subVectors(e,this._position);a=i.dot(h)}else if(this.distanceType===c.EDigDistance.Object){h=(new t.Vector3).subVectors(e,this._position);a=i.dot(h)>0?h.length():-h.length()}}else this._diggMode===c.EDigMode.Spherical&&(a=this._sphereCenter.distanceTo(e));r&&(s.zmin||(s.zmin=a),s.zmin=Math.min(a,s.zmin),this._diggMode===c.EDigMode.Spherical&&this.getInvertDirection()&&n.containsPoint(this._sphereCenter)&&(s.zmin=0)),o&&(s.zmax||(s.zmax=a),s.zmax=Math.max(a,s.zmax))},pushZOrder:function(e,i,t){var n={};n.key=i;var r=e.findIter(n);if(r){n=null;var o=r.data();void 0===o.list&&(o.list=[]),o.list.push(t)}else n.value=t,e.insert(n)},RBTreeToArray:function(e,i){for(var t=new o(e),n=t.next();null!==n;)i.push(n.value),n.list&&n.list.forEach(function(e){i.push(e)}),n=t.next()},RBTreeDataToArray:function(e,i,t){e.hasOwnProperty(i.value._ID)||(e[i.value._ID]=1,t.push(i.value)),i.list&&i.list.forEach(function(i){e.hasOwnProperty(i._ID)||(e[i._ID]=1,t.push(i))})},needForwardOrder:function(){return this._diggMode===c.EDigMode.Linear&&!this.getInvertDirection()||this._diggMode===c.EDigMode.Spherical&&this.getInvertDirection()},needBackwardOrder:function(){return this._diggMode===c.EDigMode.Spherical&&!this.getInvertDirection()||this._diggMode===c.EDigMode.Linear&&this.getInvertDirection()},computeInTorchInfo:function(e,i){for(var t={_isInTorchArray:[],_pathElementArray:[],_nbModifiableInTorch:0},n=0;n<e.length;n++){var r=e[n],o=r.QueryInterface("VCXIModifiable");if(o&&(t._isInTorchArray[n]=this.isInTorch(o.GetHashing()),t._isInTorchArray[n]&&(t._nbModifiableInTorch++,i))){var s=r.QueryInterface("W3AISGNodeHolder").getPathElement();s&&t._pathElementArray.push(s)}}return t},sortMapDistance:function(e,i){this._zOrder=[];(new Date).getTime();if(this._doubleDirection)for(var t={},n=new o(e),r=new o(i),s=n.next(),a=r.next();null!==s&&null!==a;)this.RBTreeDataToArray(t,s,this._zOrder),this.RBTreeDataToArray(t,a,this._zOrder),s=n.next(),a=r.next();else this.needForwardOrder()?this.RBTreeToArray(e,this._zOrder):this.RBTreeToArray(i,this._zOrder)},sortFrontToBack:function(){if(this._mode===c.EMode.XRay||this._mode===c.EMode.Onion){(new Date).getTime();this._zOrder=[],this._zOppositeOrder=[],this._opacityObj=[];var e=new r(VCXGlobalDiggerCompare),i=new r(VCXGlobalDiggerCompareOpposite);if(null!=this._experienceBase&&null!=this._viewer.currentViewpoint){if(!this.getLockPlanes()||!this._target||!this._position){var n=this._viewer.currentViewpoint.target;this._target=new t.Vector3(n.x,n.y,n.z);var o=this._viewer.currentViewpoint.position;this._position=new t.Vector3(o.x,o.y,o.z)}this._diggMode===c.EDigMode.Spherical&&(this._lockCenter&&this._sphereCenter||(this._sphereCenter=this.calcSphereCenterSelection()));this.isFullViewer()||!this.getTorchFilter();var s=this._doubleDirection||this.needForwardOrder(),a=this._doubleDirection||this.needBackwardOrder(),l=(new t.Vector3).subVectors(this._target,this._position);l.normalize();for(var u=this.GetListComponent(),_=0;_<u.length;_++){var d=u[_],p=d.QueryInterface("VCXIVisibility");if(!p||p.GetVisibility()!==h.EVisState.Hidden){var g=d.QueryInterface("W3AISGNodeHolder").getPathElement();if(g){var f=g;if(void 0===this._modifiableBBoxInWCS[_]){var v=f.getBoundingBox(null,this._viewer);if(v.min.x===1/0||v.min.y===1/0||v.min.z===1/0||v.max.x===-1/0||v.max.y===-1/0||v.max.z===-1/0)this._modifiableBBoxInWCS[_]=1/0;else{var m,y=f.getWorldMatrix(this._viewer);(m=v.clone()).applyMatrix4(y),this._modifiableBBoxInWCS[_]=m}}if((m=this._modifiableBBoxInWCS[_])===1/0);else{var C=m.min,S=m.max,x=[];x.push(C),x.push(new t.Vector3(S.x,C.y,C.z)),x.push(new t.Vector3(S.x,S.y,C.z)),x.push(new t.Vector3(C.x,S.y,C.z)),x.push(S),x.push(new t.Vector3(C.x,S.y,S.z)),x.push(new t.Vector3(C.x,C.y,S.z)),x.push(new t.Vector3(S.x,C.y,S.z));var V=null;this._diggMode===c.EDigMode.Spherical&&this.getInvertDirection()&&(V=m.center(),x.push(V)),this.calcProjection(d,x);for(var D={zmin:null,zmax:null},w=0;w<x.length;w++)this.calcDistanceMinMax(x[w],l,m,s,a,D);s&&this.pushZOrder(e,D.zmin,d),a&&this.pushZOrder(i,D.zmax,d)}}}}this.sortMapDistance(e,i)}}else console.log("sortFrontToBack call not wanted!")},_updateDiggerXRayContent:function(e){if(0!==e.length&&(this._SceneGraphOverrideSet||(this._SceneGraphOverrideSet=a.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer),this._SceneGraphOverrideSet))){var i,t=e.length;!this.isFullViewer()&&this.getTorchFilter()&&void 0===this._torchInfo._isInTorchArray[0]&&(this._torchInfo=this.computeInTorchInfo(e)),i=this.isFullViewer()||!this.getTorchFilter()?t:this._torchInfo._nbModifiableInTorch;for(var n=0,r=this._depth*i,o=0;o<t;o++){var h=this.isFullViewer()||!this.getTorchFilter()||this._torchInfo._isInTorchArray[o];h&&n++;var l=e[o];if(l){var u=l.QueryInterface("W3AISGNodeHolder").getPathElement();if(u){if(!this._lockPickability){var _=!(h&&n<r);s.Ghost(this._SceneGraphOverrideSet,u,!1,null,_?1:2)}if(!this._lockOpacity){var d=1;if(h&&n<r)if(this._mode===c.EMode.XRay){var p=n/r;d=.125*(p*=p)}else this._mode===c.EMode.Onion&&(d=0);if(void 0===this._opacityObj[o]||this._opacityObj[o]!==d){var g=null;if(u){var f=l.QueryInterface("VCXIModifiable");if(f&&null==(g=l.globalAlpha)){var v=f.GetProperty("Actor.Opacity");v&&(g=v.GetPropertyValue().Value)}}g&&(d*=g),s.Ghost(this._SceneGraphOverrideSet,u,!0,d,0),this._opacityObj[o]=d}}}else console.log("_updateDiggerXRayContent: pathElement null")}else console.log("_updateDiggerXRayContent: component null")}}},updateDigger:function(){if(this._mode===c.EMode.XRay||this._mode===c.EMode.Onion){this.sortFrontToBack(),this.updateDiggerContent()}},updateDiggerContent:function(e){if(this._mode===c.EMode.XRay||this._mode===c.EMode.Onion){(new Date).getTime();0===this._zOrder.length&&this.sortFrontToBack(),this._updateDiggerXRayContent(this._zOrder)}e&&this._viewer.render()}});return c.EMode={Zoom:0,Onion:1,XRay:2,Detail:3},c.EDigMode={Linear:0,Cylindrical:1,Spherical:2},c.EDigDistance={Object:0,Plan:1},c.EDigBounding={Box:0,Sphere:1},c});