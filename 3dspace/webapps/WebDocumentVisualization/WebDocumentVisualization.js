define("DS/WebDocumentVisualization/WebDocumentVisualizationServices",["require","exports","DS/SceneGraphNodes/CSS3DNode","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Visualization/Node3D","DS/VENWebHtml2Canvas/Html2Canvas","DS/Visualization/PathElement","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/Selection/CSOManager","DS/Selection/PSOManager","UWA/Core","DS/Controls/ProgressBar","css!./WebDocumentVisualization.css"],function(e,t,n,o,i,r,a,l,s,c,d,u,m,g,f){"use strict";let p,h,v;const E=2,y=4,b=0,P=96/72,w=1,D=210,x=25.4,C={left:x-8,top:5,bottom:3},S=["iframe.css","standalone.css","patch.css","UIKIT.css","wux.css","fonticons.css","Menu.css","views.css","views_default.css","WebDocumentVisualization.css","bundle-min.css"];let k,M,I,A=[];function T(e){let t=document.createElement("textarea");return t.innerHTML=e,t.value}class V{static getMMPerPixelRatio(e){if(e){let t=e.currentViewpoint;return(t.camera.top-t.camera.bottom)/e.SCREEN_HEIGHT}return 25.4/96}static getRequirementElements(e){return h=b,v=w,A.length=0,new Promise(function(t){(async()=>{var n,o,i,r,a;let s=new Map,m=0,p=V.getMMPerPixelRatio();A.length=0;const h=function(){if(this.canvas){let e=V.getMMPerPixelRatio(),t=this.canvas.getContext("2d");if(t){t.fillStyle="white",t.fillRect(0,0,(x-5)/e,this.height/e),this.selected?t.fillStyle="#368ec4":this.hovered?t.fillStyle="#77797c":t.fillStyle="#f1f1f1";let n=this.id===A[0]?(x+C.top)/e:C.top/e,o=this.id===A[A.length-1]?(x+C.bottom)/e:C.bottom/e;t.fillRect(C.left/e,n,5,this.height/e-n-o)}}this.canvasTexture.needsUpdate=!0},v=function(){u.empty(),this.selected=!0,this.pathElement&&u.add({pathElement:this.pathElement})};for(let t=0;t<e.length;t++){let n=e[t];if(void 0!==n.content){let o,i=g.createElement("div",{id:"WebDocReqElem-"+n.phyId,class:"WebDocRequirementsMainDiv"}),r=g.createElement("div",{class:"WebDocRequirementsMainContainer",styles:{width:D/p+"px","padding-top":0===s.size?x/p+"px":0,"padding-right":x/p+"px","padding-bottom":t===e.length-1?x/p+"px":0,"padding-left":x/p+"px"}}).inject(i);if("Chapter"===n.type){let e=g.createElement("div",{class:"WebDocRequirementChapterMainDiv",html:n.chapterLevelTag+" - "+n.content,styles:{"font-size":n.fontSize+"px"}});r.appendChild(e)}else if("Comment"===n.type){let e=g.createElement("div",{class:"WebDocRequirementCommentMainDiv"}),t=g.createElement("div",{class:"WebDocRequirementCommentHeaderDiv"}).inject(e);g.createElement("span",{class:"WebDocRequirementChapterIndex",text:n.chapterLevelTag+" - "}).inject(t),g.createElement("span",{class:"WebDocRequirementCommentIndex",text:n.subLevelTag}).inject(t),n.typeIconUrl&&(o=g.createElement("img",{class:"WebDocRequirementCommentHeaderIconDiv",src:n.typeIconUrl,events:{error:function(){o.remove()}}}).inject(t)),g.createElement("div",{class:"WebDocRequirementCommentHeaderTitleDiv",text:n.title}).inject(t),g.createElement("div",{class:"WebDocRequirementCommentContentDiv",html:n.content?T(n.content):""}).inject(e),r.appendChild(e)}else if("Requirement"===n.type){let e=g.createElement("div",{class:"WebDocRequirementMainDiv"}),t=g.createElement("div",{class:"WebDocRequirementHeaderDiv"}).inject(e);g.createElement("span",{class:"WebDocRequirementChapterIndex",text:n.chapterLevelTag+" - "}).inject(t),g.createElement("span",{class:"WebDocRequirementIndex",text:n.subLevelTag}).inject(t),n.typeIconUrl&&(o=g.createElement("img",{class:"WebDocRequirementHeaderIconDiv",src:n.typeIconUrl,events:{error:function(){o.remove()}}}).inject(t)),g.createElement("div",{class:"WebDocRequirementHeaderTitleDiv",text:n.title}).inject(t),g.createElement("div",{class:"WebDocRequirementContentDiv",html:n.content?T(n.content):""}).inject(e),r.appendChild(e)}const a=i.querySelectorAll("img:not(.WebDocRequirementHeaderIconDiv)");a.length&&await new Promise(e=>{let o=0;const i=r=>{if(r instanceof ErrorEvent&&window.console.error(`Some images on element: ${t+1}, type: ${n.type} were not correctly loaded`),++o===a.length){for(let e=0;e<a.length;e++){const t=a[e];t.removeEventListener("load",i),t.removeEventListener("error",i)}e()}};for(let e=0;e<a.length;e++){const t=a[e];t.complete?i():(t.addEventListener("load",i),t.addEventListener("error",i))}}),document.body.appendChild(i);let l=i.firstChild.getSize().height*p;document.body.removeChild(i);let E=m;m-=l;let y=i.cloneNode(!0);y.id=y.id+"Clone";let b=new f({infiniteFlag:!0,displayStyle:"lite",shape:"circular",height:30,emphasize:"info"});A.push(n.phyId);let P={id:n.phyId,type:"requirement",relType:n.type,html:i,title:n.title?T(n.title):"",content:y,height:l,selected:!1,hovered:!1,marginTop:0===s.size?x:0,marginBottom:t===e.length-1?x:0,progressBar:b,width:D,scale:0,coordinates:{top:E,bottom:E-l,left:-D/2,right:D/2},setAsCurrent:v,updateSelectionStatus:h};s.set(n.phyId,P);let w=g.createElement("div",{class:"WebDocRequirementsStatusDiv",styles:{left:C.left/p+"px",top:0===s.size?(x+C.top)/p+"px":C.top/p+"px",bottom:t===e.length-1?(x+C.bottom)/p+"px":C.bottom/p+"px"}}).inject(i);w.setAttribute("data-html2canvas-ignore","true"),w.setAttribute("draggable","true"),w.ondragstart=(e=>{P.pathElement&&!u.isIn({pathElement:P.pathElement})&&(e.ctrlKey||u.empty(),u.add({pathElement:P.pathElement}));let t=u.get(),o=[];for(let e=0;e<t.length;e++){let n=t[e].pathElement.getLastElement(!0);if(n.getReqInfo){let{id:e,type:t}=n.getReqInfo();o.push({envId:c.getPlatformId(),serviceId:"3DSpace",contextId:d.getSetting("pad_security_ctx"),objectId:e,objectType:t})}}if(e.dataTransfer&&(e.dataTransfer.setData("text",JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:o},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0})),n.typeIconUrl)){const t=new Image;t.src=n.typeIconUrl,e.dataTransfer.setDragImage(t,10,10)}});let S=g.createElement("div",{class:"WebDocPageLoadingProgressBar"}).inject(i);S.setAttribute("data-html2canvas-ignore",!0),b.inject(S)}}if(M||(M=new l),k)t(s);else{k=document.createElement("iframe"),document.body.appendChild(k),null===(n=k.contentWindow)||void 0===n||n.document.open(),null===(o=k.contentWindow)||void 0===o||o.document.write("<body></body>"),null===(i=k.contentWindow)||void 0===i||i.document.close(),k.style.position="fixed",k.style.top="0px",k.style.left="-100000px";let e=0,l=!1,c=function(){e--,l&&0===e&&t(s)};for(let t=0;t<document.styleSheets.length;t++){if(!document.styleSheets[t].href)continue;let n=null===(r=document.styleSheets[t].href)||void 0===r?void 0:r.split("/");if((n=n?n[n.length-1].split("?"):void 0)&&S.includes(n[0])){e++;let n=document.createElement("link");n.rel="stylesheet",n.href=document.styleSheets[t].href||"",n.onload=c,n.onerror=c,null===(a=k.contentWindow)||void 0===a||a.document.head.appendChild(n)}}l=!0}})()})}static getRequirementBookmarks(e){const t=[],n={1:t};return e.forEach(e=>{if(e.level>0){let t={pointedId:e.phyId,title:e.title?T(e.title):"",iconUrl:e.typeIconUrl,items:[]};n[e.level].push(t),n[e.level+1]=t.items}}),t}static renderElement(e,t,a){var l,s,c;if(e&&e.content&&M){let d=V.getMMPerPixelRatio();if(e.isRendering)return e.needsUpdate=!0,void t();if(e.isRendering=!0,e.canvas||(e.canvas=g.createElement("canvas")),e.canvas.height=e.height/d*e.scale,e.canvas.width=e.width/d*e.scale,!e.node){e.canvasTexture=new i.Texture(e.canvas),e.canvasTexture.needsUpdate=!0,e.canvasMaterial=new i.MeshBasicMaterial({force:!0,transparent:!0,map:e.canvasTexture}),e.node=o.createRectangleNode({width:e.width,height:e.height,fill:!0,noEdge:!0,material:e.canvasMaterial}),e.node.setName("WebDocElementNode"),e.node.getReqInfo=function(){return{id:e.id,type:e.relType}},e.node.excludeFromHighlight(!0,!0);let t=new n(e.html,d,"WebDocRequirementContentNode");t.setPickability(!0),t.setPickable(r.PICKTHROUGH),t.setMatrix((new i.Matrix4).makeTranslation(e.width/2,e.height/2,0)),e.node.setMatrix((new i.Matrix4).makeTranslation(-e.width/2,e.coordinates.top-e.height,0)),e.node.addChild(t)}null===(l=null==k?void 0:k.contentWindow)||void 0===l||l.document.body.appendChild(e.content),null===(s=e.html.firstElementChild)||void 0===s||s.classList.remove("loaded");let u=this;M.htmlToCanvas(e.content,{canvas:e.canvas,scale:e.scale,logging:!1,useCORS:!0,imageTimeout:0,width:e.canvas.width,height:e.canvas.height,windowWidth:e.canvas.width,windowHeight:e.canvas.height}).then(function(){var n;e&&e.canvasTexture&&e.updateSelectionStatus(),null===(n=e.html.firstElementChild)||void 0===n||n.classList.add("loaded"),e.isRendering=!1,e.onError=!1,e.needsUpdate?(e.needsUpdate=!1,u.renderElement(e,t,a)):t()},function(){e.isRendering=!1,e.needsUpdate=!1,e.onError?a&&a():(e.onError=!0,u.renderElement(e,t,a))}),null===(c=null==k?void 0:k.contentWindow)||void 0===c||c.document.body.removeChild(e.content)}}static renderDocumentElements(e){if(!(e&&e.elements&&e.currentElement&&e.viewpoint&&e.onComplete))return e.onFailure?e.onFailure():void 0;let t=e.scale||1,n=e.currentElement,o=e.viewpoint.getEyePosition().y+e.viewpoint.getCamera().bottom,i=0,r=0,a=this,l=0,s=function(){0===--l&&e.onComplete()};!function c(){if(n===e.elements.size+1&&(r++,n=e.currentElement-r,i=v),n<1||n>e.elements.size)return;let d=!1,u=A[n-1],m=e.elements.get(u);m&&(m.node||(d=!0),(!m.scale||Math.abs(m.scale-t)>.15)&&(d=!0,m.scale=t),m.visible=n>=e.currentElement,m.toLoad=!0,d&&(l++,"requirement"===m.type?a.renderElement(m,s,e.onFailure):a.renderPage(m,s,e.onFailure)),o>m.coordinates.top&&(m.visible=!1,i++),i<v?(n++,c()):r<v&&(m.visible=!1,r++,n=e.currentElement-r,c()))}(),0===l&&e.onComplete()}static computeCurrentElement(e,t,n,o=!1){let i=n||1;if(e&&t&&t.size&&i){let n=h||2e-4,r=e.getEyePosition().y+e.getCamera().top,a=!1,l=t.get(A[i-1]);if(l){if(r-l.coordinates.top>n/2)a=!0;else if(r-l.coordinates.bottom>n/2)return i>1&&o?this.computeCurrentElement(e,t,i-1,o):i;for(let e=a?i-2:i;a?e>=0:e<A.length;a?e--:e++)if(A[e]){let o=t.get(A[e]);if(o&&o.coordinates&&r-o.coordinates.bottom>n/2&&r-o.coordinates.top<=n/2)return e+1}}}return i||1}static updateElementsToLoad(e,t,n){if(!e||!n)return;let o=n.getEyePosition().y+n.getCamera().bottom,i=0,r=e.values();for(let n=0;n<e.size;n++){let e=r.next().value;e.selected?e.toLoad=!0:n+1<t-v?e.toLoad=!1:o>e.coordinates.top?(i++,e.toLoad=i<=v):e.toLoad=!0}}static cleanRequirementElements(e){var t;let n=e.values();for(let o=0;o<e.size;o++){let e=n.next().value;e&&e.canvas&&(null===(t=e.canvas)||void 0===t||t.destroy(),e.html&&e.html.destroy(),e.canvasTexture&&e.canvasTexture.dispose(),e.canvasMaterial&&e.canvasMaterial.dispose(),e.progressBar&&e.progressBar.destroy(),e.node&&e.node.removeChildren())}e.clear(),k&&(k.remove(),k=null),A.length=0,M=null}static getZoomLevel(e){let t=V.getMMPerPixelRatio(e);return parseInt((V.getMMPerPixelRatio()/t*100).toFixed(0))}static updateNodesInSession(e,t,n=!1){if(!e||!t||!t.size)return;let o=t.values();for(let i=0;i<t.size;i++){let i=o.next().value;if(i.node)if(n&&!i.toLoad&&i.loaded)i.loaded=!1,i.visible=!1,e.removeChild(i.node),"requirement"===i.type&&i.html.removeEvents();else if(i.toLoad&&!i.loaded&&(i.loaded=!0,e.addChild(i.node),"requirement"===i.type)){if(!i.pathElement){let e=[],t=i.node;for(;t&&!t.notAllowedInPathElement;)e.unshift(t),t=t.parents[0];i.pathElement=new s(e)}i.html.addEvents({mouseover:()=>{"requirement"!==i.type||m.isIn({pathElement:i.pathElement})||(m.empty(),m.add({pathElement:i.pathElement}))},click:e=>{if("requirement"===i.type){if(e.shiftKey&&I){let e=A.indexOf(i.id),n=A.indexOf(I);if(-1!==e&&-1!==n){let o=[];for(let i=Math.min(e,n);i<=Math.max(e,n);i++){let e=t.get(A[i]);e&&"requirement"===e.type&&o.push({pathElement:e.pathElement})}u.add(o)}}I=i.selected?i.id:null}}}),i.selected&&u.add({pathElement:i.pathElement})}}}static getElementIdAtIndex(e){return A[e]}static getPdfDocument(e){e&&e.dataBuffer&&e.onComplete||!e.onFailure?(window.PDFJS_VERSION="2.13.216",window.require(["DS/PDFjs/PDFjs"],t=>{h=y,v=E,(p=t).getDocument({data:e.dataBuffer,password:e.password}).promise.then(function(t){t?e.onComplete(t):e.onFailure&&e.onFailure()},function(t){"PasswordException"===t.name?t.code!==p.PasswordResponses.NEED_PASSWORD&&t.code!==p.PasswordResponses.INCORRECT_PASSWORD||!e.onIncorrectPassword?e.onFailure&&e.onFailure(t):e.onIncorrectPassword():e.onFailure&&e.onFailure(t)})})):e.onFailure()}static getPdfPages(e,t){return new Promise(function(n,o){e||o(new Error("The PDF Document is undefined"));let i=new Map,r=0,a=function(t){e.getPage(t.number).then(function(a){if(a){t.pageObj=a;let o=t.pageObj.getViewport({scale:P}),l=V.getMMPerPixelRatio(),s=o.width/2*l,c=i.get((t.number-1).toString()),d=t.number>1&&c?c.coordinates.bottom-h:0;t.coordinates.top=d,t.coordinates.bottom=d-o.height*l,t.coordinates.left=-s,t.coordinates.right=s,t.height=t.coordinates.top-t.coordinates.bottom,t.width=t.coordinates.right-t.coordinates.left,t.pageLayer=g.createElement("div",{id:"WebDocPageLayerPage"+t.number,class:"WebDocPageLayer"}),++r===e.numPages&&n(i)}else o(new Error("Page "+t.number+" not finded"))},o)};A.length=0;for(let n=0;n<e.numPages;n++){let e=n+1,o={type:"page",number:e,scale:t,rotationAngle:0,height:0,width:0,coordinates:{top:0,bottom:0,right:0,left:0}};A.push(e.toString()),i.set(e.toString(),o),a(o)}})}static getPdfCommentsFromPages(e){return new Promise(function(t,n){e||n(new Error("Pages are Undefined"));let o=[];e.size||t(o);let r=0;e.forEach(function(n){n.pageObj&&n.pageObj.getAnnotations().then(function(a){if(n.pageObj){let e=null,t=null,r=n.pageObj.getViewport({scale:n.scale*P});for(let l=0;l<a.length;l++)if("Popup"!==a[l].subtype)e=a[l].id,t=a[l].rect;else if(a[l].contentsObj&&a[l].contentsObj.str&&a[l].parentId&&a[l].parentId===e&&t){let s=null,c=V.getMMPerPixelRatio(),d=new i.Vector3(c*t[0]*P,c*-(r.viewBox[3]-t[3])*P,0);t&&t.length&&(s={position:d,width:c*(t[2]-t[0])*P,height:c*(t[3]-t[1])*P}),o.push({owner:{name:a[l].titleObj.str},content:a[l].contentsObj.str.split(/(?:\r\n|\r|\n)/g),isReadOnly:!0,pointedPage:n.number,pointedPosition:d,rect:s}),e=null,t=null}}++r===e.size&&t(o)})})})}static getPdfLinksFromPages(e,t){return new Promise(function(n,o){t||o(new Error("Pages are Undefined"));let r=[];t.size||n(r);let a=0;t.forEach(function(o){o.pageObj&&o.pageObj.getAnnotations().then(function(l){let s=l.filter(function(e){return"Link"===e.subtype});if(s&&s.length&&o.pageObj){let t=o.pageObj.getViewport({scale:o.scale*P}),n=g.createElement("div",{id:"WebDocAnnotationLayerPage"+o.number,class:"WebDocAnnotationLayer"}).inject(o.pageLayer);o.updateAnnotationScale=function(e){n.setStyle("transform","scale("+e/t.scale*P+")")},s.forEach(function(o){let a=g.createElement("section",{class:"WebDocLinkAnnotation"}).inject(n);a.setStyle("transform","scale("+t.scale+")");let l,s=o.rect;if(a.setStyles({"transform-origin":-s[0]+"px "+-(t.viewBox[3]-s[3])+"px 0px",left:s[0]+"px",top:t.viewBox[3]-s[3]+"px",width:s[2]-s[0]+"px",height:s[3]-s[1]+"px"}),o.url||o.unsafeUrl)l=g.createElement("a",{href:o.url?o.url:o.unsafeUrl}).inject(a),r.push({div:l,content:g.createElement("p",{text:o.url||o.unsafeUrl,styles:{margin:"2px",padding:0,userSelect:"text"}})});else if(o.dest){let t,n,s,c,d,u,m,f;l=g.createElement("a").inject(a);let p=V.getMMPerPixelRatio();Array.isArray(o.dest)?(u="object"==typeof o.dest[1]?o.dest[1].name:null,m=o.dest[2]?p*o.dest[2]*P:null,f=o.dest[3]?p*o.dest[3]*P:null,s="FitH"===u,c="FitV"===u||"Fit"===u,d=o.dest[4]||null,n=null!==m&&null!==f?new i.Vector3(m||0,f||0,0):null,"number"==typeof o.dest[0]?t=o.dest[0]+1:"object"==typeof o.dest[0]&&e.getPageIndex(o.dest[0]).then(function(e){t=e+1})):"string"==typeof o.dest&&e.getDestination(o.dest).then(function(o){o&&o.length&&(u="object"==typeof o[1]?o[1].name:null,m=o[2]?p*o[2]*P:null,f=o[3]?p*o[3]*P:null,s="FitH"===u,c="FitV"===u||"Fit"===u,d=o[4]||null,n=null!==m&&null!==f?new i.Vector3(m||0,f||0,0):null,e.getPageIndex(o[0]).then(function(e){t=e+1}))}),r.push({addClickListener:function(e){l.addEvent("click",function(){e({pointedPosition:n,pointedPage:t,fitAllIn:c,fitWidth:s,scale:d})})},remove:function(){l.removeEvents(),a.remove()}})}})}++a===t.size&&n(r)})})})}static getPdfBookmarks(e){return new Promise(function(t,n){e||n(new Error("The PDF Document is undefined")),e.getOutline().then(function(o){let r=[],a=0;if(o&&o.length){let l=function(){0===--a&&t(r)},s=function(t){let o=[];if(t&&t.length){let r=function(e,t){let n="object"==typeof t[1]?t[1].name:null,o=V.getMMPerPixelRatio(),r=t[2]?o*t[2]*P:null,a=t[3]?o*t[3]*P:null;e.fitWidth="FitH"===n,e.fitAllIn="FitV"===n||"Fit"===n,e.pointedPosition=null!==r&&null!==a?new i.Vector3(r||0,a||0,0):null};t.forEach(function(t){let i={title:unescape(t.title),bold:t.bold,italic:t.italic,items:s(t.items)};Array.isArray(t.dest)?(r(i,t.dest),"number"==typeof t.dest[0]?i.pointedPage=t.dest[0]+1:t.dest[0]&&"object"==typeof t.dest[0]&&(a++,e.getPageIndex(t.dest[0]).then(function(e){i.pointedPage=e+1,l()}).catch(()=>{i.pointedPage=void 0,l()}))):"string"==typeof t.dest&&(a++,e.getDestination(t.dest).then(function(t){t&&t.length&&(r(i,t),"number"==typeof t[0]?(i.pointedPage=t[0]+1,l()):e.getPageIndex(t[0]).then(function(e){i.pointedPage=e+1,l()}).catch(()=>{i.pointedPage=void 0,l()}))},n)),o.push(i)})}return o};r=s(o),0===a&&t(r)}else t(r)},n)})}static getMaxWidth(e,t){let n=e.values().next().value,o=n.coordinates.right-n.coordinates.left;for(let i=t;i<e.size&&(n=e.get((i+1).toString())).visible;i++)o=Math.max(o,n.coordinates.right-n.coordinates.left);return o}static renderPage(e,t,l){let s=this;if(p&&e&&e.pageObj){if(e.isRendering)return e.needsUpdate=!0,void t();e.isRendering=!0;let c=e.pageObj.getViewport({scale:e.scale*P});e.canvas||(e.canvas=g.createElement("canvas"),e.canvas.id="PDFcanvasPage"+e.number),e.canvas.height=c.height,e.canvas.width=c.width;let d=e.canvas.getContext("2d");if(d&&(d.fillStyle="white",d.fillRect(0,0,e.canvas.width,e.canvas.height)),!e.node){let t=e.width,l=e.height,s=e.coordinates.bottom;e.canvasTexture=new i.Texture(e.canvas),e.canvasTexture.needsUpdate=!0,e.canvasMaterial=new i.MeshBasicMaterial({force:!0,transparent:!0,map:e.canvasTexture});let d=o.createRectangleNode({width:t,height:l,fill:!0,noEdge:!0,material:e.canvasMaterial});d.setName("WebDocMeshPage"+e.number),d.setPickable(r.PICKTHROUGH),e.node=new a("WebDocNodePage"+e.number),e.node.addChild(d);let u=g.createElement("div",{id:"WebDocTextLayerPage"+e.number,class:"WebDocTextLayer"}).inject(e.pageLayer),m=new n(e.pageLayer,V.getMMPerPixelRatio()/e.scale,"WebDocLayerNodePage"+e.number);e.updateAnnotationScale&&e.updateAnnotationScale(e.scale),m.setPickability(!0),m.setMatrix((new i.Matrix4).makeTranslation(.5*t,.5*l,0)),m.setPickable(r.PICKTHROUGH),e.node.addChild(m);let h=(new i.Matrix4).makeRotationZ(e.rotationAngle),v=Math.abs(e.height*Math.cos(e.rotationAngle)-e.width*Math.sin(e.rotationAngle)),E=Math.abs(e.height*Math.sin(e.rotationAngle)+e.width*Math.cos(e.rotationAngle)),y=new i.Vector3(-e.width/2,-e.height/2,0).applyMatrix4(h);y.add(new i.Vector3(e.coordinates.left+E/2,s+v/2,0)),e.node.setMatrix((new i.Matrix4).setPosition(y).multiply(h));let b=g.createElement("div",{class:"WebDocPageLoadingProgressBar"}).inject(e.pageLayer),P=new f({infiniteFlag:!0,displayStyle:"lite",shape:"circular",height:80,emphasize:"info"}).inject(b);e.cssNode=m,e.destroyProgressBar=function(){var t;b.setStyle("display","none"),P.destroy(),null===(t=e.pageLayer)||void 0===t||t.removeChild(b)},e.pageObj.getTextContent().then(function(t){p.renderTextLayer({textContent:t,container:u,viewport:c,enhanceTextSelection:!0}),e.pageLayer&&e.canvas&&(e.pageLayer.style.left=e.canvas.offsetLeft+"px",e.pageLayer.style.top=e.canvas.offsetTop+"px",e.pageLayer.style.height=e.canvas.height+"px",e.pageLayer.style.width=e.canvas.width+"px")})}if(d){e.pageObj.render({canvasContext:d,viewport:c,enableWebGL:!0}).promise.then(function(){e&&e.canvasTexture&&(e.canvasTexture.needsUpdate=!0),e.destroyProgressBar&&(e.destroyProgressBar(),e.destroyProgressBar=null),e.isRendering=!1,e.needsUpdate?(e.needsUpdate=!1,s.renderPage(e,t,l)):t()},function(){l&&l()})}}}static cleanPdfPages(e){var t;let n=e.values();for(let o=0;o<e.size;o++){let e=n.next().value;e&&e.canvas&&(null===(t=e.canvas)||void 0===t||t.destroy(),e.canvasTexture&&e.canvasTexture.dispose(),e.canvasMaterial&&e.canvasMaterial.dispose(),e.progressBar&&e.progressBar.destroy(),e.node&&e.node.removeChildren())}e.clear(),A.length=0}}return V}),define("DS/WebDocumentVisualization/WebDocumentVisualizationController",["require","exports","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/WebDocumentVisualization/WebDocumentVisualizationServices","DS/CoreEvents/ModelEvents"],function(e,t,n,o,i,r,a,l,s){"use strict";class c{constructor(e){let t,c,d,u,m,g,f,p,h,v,E,y,b,P,w,D,x,C,S,k,M,I,A=this,T=null,V=e.context.getViewer(),W=e.context.getViewpoint(),R=e.context.getFrameWindow(),L=!0,z=!0,F=!1,B=!1,q=!0,O=!1,U=0,j=!0,N=new s,H=[],Z=[];const _=9.1,G=500;function K(e,t){N.publish({event:e,data:t})}function X(){let e=S?S.pages:E;l.updateElementsToLoad(e,y,W),l.updateNodesInSession(T,e,!0),V.render()}function J(e){if(e.from[0].event instanceof TouchEvent&&!F&&q&&"Touch"===e.from[0].type)if("touchstart"===e.from[0].event.type||"begin"===e.state)V.divCssElement.setStyle("display","none"),V.manipulatorManager.setActivate(!1),V.setDefaultPicking(!1),x=W.getEyePosition(),D=e.from[0].getCurrentPosition(V.canvas),C=l.getMMPerPixelRatio(V);else if("touchmove"===e.from[0].event.type){let t=D.clone().sub(e.from[0].getCurrentPosition(V.canvas));W.moveTo({eyePosition:new i.Vector3(x.x+t.x*C,x.y-t.y*C,x.z),duration:0})}else"touchend"!==e.from[0].event.type&&"end"!==e.state||(V.manipulatorManager.setActivate(!0),V.setDefaultPicking(!0),V.divCssElement.setStyle("display","block"))}function $(e){let t=W.getEyePosition(),n=0,o=0;e.from[0].event.shiftKey?n=25*e.gesture.delta:o=25*e.gesture.delta,W.moveTo({eyePosition:new i.Vector3(t.x-n,t.y+o,t.z),duration:0})}function Y(){if(O||!S&&!E)return;let e=W.getCamera(),t=l.getMMPerPixelRatio(V),n=v&&v.left?v.left*t:0,o=v&&v.right?v.right*t:0,r=v&&v.bottom?v.bottom*t:0,a=e.top,s=e.bottom+r,c=e.left+n,d=e.right-o,u=(o-n)/2,g=W.getEyePosition(),f=S?l.getMaxWidth(S.pages,y-1):E.values().next().value.width,p=g.x,h=g.y,b=g.z;g.x!==u&&(d-c>f?p=u:g.x+d>f/2?p=f/2-d:g.x+c<-f/2&&(p=-f/2-c));let P=S?S.pages:E,w=P.size;if(F){let e=l.getElementIdAtIndex(y-1),t=P.get(e);t&&(m||(m=t.coordinates.top-(g.y+a)),Math.abs(t.coordinates.top-(g.y+a)-m)>1e-5&&(h=t.coordinates.top-a-m))}let D=P.get(l.getElementIdAtIndex(w-1)),x=P.get(l.getElementIdAtIndex(0));D&&x&&(a-s>x.coordinates.top-D.coordinates.bottom?h=D.coordinates.bottom/2:h+a>0?h=-a:h+s<D.coordinates.bottom&&(h=D.coordinates.bottom-s));let C=l.getZoomLevel(V),k=W.getTargetDistance();C>G?(b+=k*C/G-k,W.setTargetDistance(k*C/G)):C<_&&(b+=k*C/_-k,W.setTargetDistance(k*C/_)),p===g.x&&h===g.y&&b===g.z||W.setEyePosition(new i.Vector3(p,h,b))}function Q(){if(!R)return;v||(v={left:0,right:0,bottom:0});let e=R.getImmersiveFrame(),t=0,n=0,o=e.getDockingElement(WUXDockAreaEnum.RightDockArea),i=e.getDockingElement(WUXDockAreaEnum.LeftDockArea),r=o.getContainedWindows(),a=i.getContainedWindows();if(r&&r.length&&(r[0].isAWindowGroup()&&r[0].getEmbeddedWindows().length||!r[0].isAWindowGroup())){let e=r[0].getEmbeddedWindows?r[0].getEmbeddedWindows():r,n=!1;for(let t=0;t<e.length;t++)e[t].visibleFlag&&(n=!0);t=n&&!o.collapseDockingZoneFlag?o.dockingZoneSize+o._collapserSize:o._collapserSize}else o.interactiveDockAreaVisibleFlag&&(t=o.dockingZoneSize+o._collapserSize);if(a&&a.length&&(a[0].isAWindowGroup()&&a[0].getEmbeddedWindows().length||!a[0].isAWindowGroup())){let e=a[0].getEmbeddedWindows?a[0].getEmbeddedWindows():a,t=!1;for(let n=0;n<e.length;n++)e[n].visibleFlag&&(t=!0);n=t&&!i.collapseDockingZoneFlag?i.dockingZoneSize+i._collapserSize:i._collapserSize}else i.interactiveDockAreaVisibleFlag&&(n=i.dockingZoneSize+i._collapserSize);v.right=t,v.left=n,v.bottom=0,Y()}function ee(){if(!S)return;let e,t=W.getCamera(),n=l.getMMPerPixelRatio(V),o=v?v.left*n:0,r=v?v.right*n:0,a=v?v.bottom*n:0,s=(t.top,t.bottom,t.left+o),c=t.right-r-s,d=0,u=[],m=function(e){return(d+=e)===e||(d+=4,!!(M&&u.length<2&&d<c)||(d-=e+4,!1))},g=0,f=0,p=0,h=S.pages,E=h.get("1");if(E){let t=(new i.Matrix4).makeRotationZ(E.rotationAngle),n=h.values();for(let o=0;o<h.size;o++){let r=n.next().value,a=r.coordinates.right-r.coordinates.left;if(m(a))p=Math.max(p,r.coordinates.top-r.coordinates.bottom),u.push(o);else{g-=p,f=-d/2;for(let n=0;n<u.length;n++){let o=h.get((u[n]+1).toString());if(o){let n=o.coordinates.top-o.coordinates.bottom,r=o.coordinates.right-o.coordinates.left;o.coordinates.bottom=g+(p-n)/2,o.coordinates.top=o.coordinates.bottom+n,o.coordinates.left=f,o.coordinates.right=o.coordinates.left+r,o.node&&((e=new i.Vector3(-o.width/2,-o.height/2,0).applyMatrix4(t)).add(new i.Vector3(f+r/2,g+p/2,0)),o.node.setMatrix((new i.Matrix4).setPosition(e).multiply(t))),f+=r+4}}g-=4,u.length=0,u.push(o),d=a,p=r.coordinates.top-r.coordinates.bottom}}if(u.length){g-=p,f=-d/2;for(let n=0;n<u.length;n++){let o=h.get((u[n]+1).toString());o&&(o.coordinates.top=g+o.coordinates.top-o.coordinates.bottom,o.coordinates.right=f+o.coordinates.right-o.coordinates.left,o.coordinates.bottom=g,o.coordinates.left=f,o.node&&((e=new i.Vector3(-o.width/2,-o.height/2,0).applyMatrix4(t)).add(new i.Vector3(f+(o.coordinates.right-o.coordinates.left)/2,g+p/2,0)),o.node.setMatrix((new i.Matrix4).setPosition(e).multiply(t))),f+=o.coordinates.right-o.coordinates.left+4)}}}}function te(){if(!E&&!S)return;let e=S?S.pages:E,t=l.computeCurrentElement(W,e,y,Boolean(S&&M));l.renderDocumentElements({elements:e,currentElement:t,viewpoint:W,scale:l.getZoomLevel(V)/100,onComplete:function(){V&&V.render()}}),t!==y&&K("onCurrentElementChange",{value:y=t}),l.updateNodesInSession(T,e)}function ne(e){if(!E&&!S)return;let t=e.eventType||e.event;"@onViewpointBeginMove"===t?(B=!0,K("onScrollChange",{type:"start"})):"@onViewpointChange"===t&&B?(u.z!==e.viewpoint.position.z?F?(M&&ee(),K("onZoomChange",{type:"change",value:l.getZoomLevel(V)})):(A.enableTextSelection(!1),K("onZoomChange",{type:"start",value:l.getZoomLevel(V)}),F=!0):te(),Y(),K("onScrollChange",{type:"change"})):"@onViewpointEndMove"===t?(B=!1,F&&(M&&ee(),u=W.getEyePosition(),K("onZoomChange",{type:"end",value:l.getZoomLevel(V)}),F=!1,m=null,A.enableTextSelection(!0)),O=!1,Y(),te(),K("onScrollChange",{type:"end"}),K("onCurrentElementChange",{value:y,endMove:!0}),"requestIdleCallback"in window?(P&&(window.cancelIdleCallback(P),P=null),P=window.requestIdleCallback(X)):(b&&(clearTimeout(b),b=null),setTimeout(X,3e3))):"onSwapVisibleSpace"===t&&A.enableTextSelection(Boolean(V.getVisibleSpace()))}function oe(e){let t,n=e.target;!S&&!E||n&&("P"===n.tagName||"textarea"===n.type||"input"===n.type)||("End"===e.key||35===e.keyCode?A.setCurrentElement({elementID:S?S.document.numPages:l.getElementIdAtIndex(E.size-1)}):"Home"===e.key||36===e.keyCode?A.setCurrentElement({elementID:S?1:l.getElementIdAtIndex(0)}):M||("ArrowUp"===e.key||38===e.keyCode?(t=W.getEyePosition(),W.moveTo({eyePosition:new i.Vector3(t.x,t.y+20,t.z),duration:100})):"ArrowDown"===e.key||40===e.keyCode?(t=W.getEyePosition(),W.moveTo({eyePosition:new i.Vector3(t.x,t.y-20,t.z),duration:100})):e.ctrlKey||"ArrowRight"!==e.key&&39!==e.keyCode?e.ctrlKey||"ArrowLeft"!==e.key&&37!==e.keyCode?"PageUp"===e.key||33===e.keyCode?(t=W.getEyePosition(),W.moveTo({eyePosition:new i.Vector3(t.x,t.y+150,t.z),duration:200})):"PageDown"!==e.key&&34!==e.keyCode||(t=W.getEyePosition(),W.moveTo({eyePosition:new i.Vector3(t.x,t.y-150,t.z),duration:200})):A.centerViewpointAtNextOrPreviousElement(!1):A.centerViewpointAtNextOrPreviousElement(!0)))}function ie(e){var t;L&&z||(e.preventDefault(),null===(t=window.getSelection())||void 0===t||t.removeAllRanges())}function re(e){V.getDefaultPicking()&&("@onPrimaryPointerDownUniqueEvent"===e.eventType&&e.from[0].view.id&&e.from[0].view.id.includes("WebDocPageLayer")||e.from[0].view===V.canvas?V.setPicking({showDivTrap:!0}):"@onPrimaryPointerUpUniqueEvent"===e.eventType&&V.setPicking({showDivTrap:!1}))}function ae(){V.set2DMode(!0,"CATIA"),t=V.antiAliasing,V.setAntiAliasing("NoAA"),c={showDivTrap:V.picking.showDivTrap},V.setPicking({showDivTrap:!1}),W.setEyePosition(new i.Vector3(0,0,100)),W.setTargetDistance(100),u=W.getEyePosition()}function le(e){if(!e.target.hasClassName||!e.target.hasClassName("WebDocRequirementsStatusDiv"))return e.preventDefault&&e.preventDefault(),e.returnValue=!1,!1}function se(e){return e.preventDefault&&e.preventDefault(),e.returnValue=!1,!1}function ce(e){if(e&&e.pointedPage&&L&&j&&S){if(e.scale){let t=l.getZoomLevel(V)/100,n=W.getTargetDistance(),o=W.getEyePosition(),r=n*t/e.scale-n;W.setTargetDistance(n*t/e.scale),W.setEyePosition(new i.Vector3(o.x,o.y,o.z+r))}if(e.pointedPosition){let t=S.pages.get(e.pointedPage.toString());if(t){let n=t.coordinates;A.centerViewpointAtElementPosition({elementID:e.pointedPage,position:new i.Vector3(e.pointedPosition.x,e.pointedPosition.y-(n.top-n.bottom),0),duration:0,centerAtTopLeft:!0})}}else A.setCurrentElement({elementID:e.pointedPage});(e.fitAllIn||e.fitWidth)&&setTimeout(function(){A.fitCurrentElement(e.fitWidth)})}}function de(){var e,t;!function(){let e=W.getEyePosition();W.setEyePosition(new i.Vector3(e.x,0,e.z)),W.onCenterCamera(()=>{}),g=o.subscribe({event:"/VISU/"},ne),document.addEventListener("selectionchange",ie),document.addEventListener("selectstart",ie),document.addEventListener("keyup",oe),V.divCssElement.addEventListener("dragstart",le),V.divCssElement.addEventListener("contextmenu",se),n.addEvent(V.divCssElement,"onMouseWheel",$),n.addEvent(V.canvas,"onMouseWheel",$),n.addEvent(V.divCssElement,"onPrimaryPointerDownUnique",re),n.addEvent(V.canvas,"onPrimaryPointerDownUnique",re),n.addEvent(V.divCssElement,"onPrimaryPointerUpUnique",re),n.addEvent(V.canvas,"onPrimaryPointerUpUnique",re),n.addEvent(V.divCssElement,"onSwipe",J),n.addEvent(V.canvas,"onSwipe",J),R.getImmersiveFrame().addEventListener("freeZoneResize",Q),h=V.onSwapVisibleSpace(function(){ne({eventType:"onSwapVisibleSpace"})}),A.setTextSelectionFlag(!0),Q(),Y(),"requestIdleCallback"in window?(P&&(window.cancelIdleCallback(P),P=null),P=window.requestIdleCallback(X)):(b&&(clearTimeout(b),b=null),setTimeout(X,3e3))}(),te();let r=W.getCamera(),a=l.getMMPerPixelRatio(V),s=v?v.left*a:0,c=v?v.right*a:0,d=v?v.bottom*a:0,u=(r.top,r.bottom,r.left+s),m=r.right-c,f=W.getEyePosition(),p=(S?null===(e=S.pages.get("1"))||void 0===e?void 0:e.width:null===(t=E.get(l.getElementIdAtIndex(0)))||void 0===t?void 0:t.width)||0;p*=2,W.moveTo({eyePosition:new i.Vector3((c-s)/2,0,f.z*p/(m-u)),distanceToTarget:W.getTargetDistance()*p/(m-u),duration:0}),U--}this.loadDocumentStream=function(t){if("Requirement"===t.type){if(!t.elementsToLoad||!t.elementsToLoad.length)return t.onFailure(new Error("No elements to load"));if(f="Requirement",d=t.phyId,U++,ae(),!I){const t=()=>{let e=r.get(),t=H.slice();H.length=0,t.forEach(e=>{let t=E.get(e);t&&(t.hovered=!1,t.updateSelectionStatus())});for(let t=0;t<e.length;t++){let n=e[t].pathElement.getLastElement(!0);if(n.getReqInfo){let{id:e}=n.getReqInfo(),t=E.get(e);t&&(t.hovered=!0,H.push(e),t.updateSelectionStatus())}}V.render()};let n=!1;const o=()=>{n=!1;let t=a.get(),o=Z.slice();Z.length=0,o.forEach(e=>{let t=E.get(e);t&&(t.selected=!1,t.updateSelectionStatus())});let i=!1;for(let e=0;e<t.length;e++){let o,r=t[e].pathElement.getLastElement(!0);if(r.getReqInfo){let{id:e}=r.getReqInfo();o=E.get(e)}else if(1===E.size){let e=E.values().next().value;e.node&&r===e.node.getParents()[0]&&(o=e,n=!0)}o&&(Z.push(o.id),o.selected=!0,o.updateSelectionStatus(),o.loaded||(o.toLoad=!0,i=!0))}!n&&Z.length&&(e.context.lockSelectionBroadcast(!0),K("onElementSelection",Z[Z.length-1])),i&&l.updateNodesInSession(T,E),V.render()};I={onPSOEmpty:r.onEmpty(t),onPSORemove:r.onRemove(t),onPSOAdd:r.onAdd(t),onCSOEmpty:a.onEmpty(o),onCSORemove:a.onRemove(o),onCSOAdd:a.onAdd(o)}}l.getRequirementElements(t.elementsToLoad).then(function(e){t.elementsToLoad&&(E=e,w=l.getRequirementBookmarks(t.elementsToLoad),y=1,T=t.fatherNode,l.renderDocumentElements({elements:E,currentElement:y,viewpoint:W,scale:l.getZoomLevel(V)/100,onFailure:t.onFailure,onComplete:function(){de(),t.onComplete()}}),l.updateNodesInSession(T,E),V.render())})}else"Document"===t.type&&t.dataBuffer?(f="Document",d=t.phyId,U++,ae(),l.getPdfDocument({dataBuffer:t.dataBuffer,password:t.password,onComplete:function(e){if(t.password&&t.onPasswordOk&&t.onPasswordOk(),e){l.getMMPerPixelRatio();let n=l.getMMPerPixelRatio()/l.getMMPerPixelRatio(V);l.getPdfPages(e,n).then(function(n){T=t.fatherNode,y=1,l.renderDocumentElements({elements:n,currentElement:y,viewpoint:W,scale:l.getZoomLevel(V)/100,onFailure:t.onFailure,onComplete:function(){Promise.all([l.getPdfCommentsFromPages(n),l.getPdfLinksFromPages(e,n),l.getPdfBookmarks(e)]).then(function(o){!S&&t.dataBuffer&&(S={buffer:t.dataBuffer,document:e,pages:n,externalComments:o[0],links:o[1],bookmarks:o[2]}),S&&S.links&&S.links.length&&S.links.forEach(function(e){e.addClickListener&&e.addClickListener(ce)}),de(),t.onComplete()},function(e){window.console.error(e),U--,d=null,t.onFailure()})}}),l.updateNodesInSession(T,n),V.render()},function(e){window.console.error(e),U--,d=null,t.onFailure(e)})}else U--,d=null,t.onFailure()},onIncorrectPassword:function(){U--,d=null,t.onIncorrectPassword?t.onIncorrectPassword():t.onFailure()},onFailure:function(e){U--,d=null,t.onFailure(e)}})):t.onFailure(new Error("Data type not supported"))},this.isLoading=function(){return U>0},this.removeDocument=function(){P&&(window.cancelIdleCallback(P),P=null),b&&(clearTimeout(b),b=null),document.removeEventListener("selectstart",ie),document.removeEventListener("selectionchange",ie),document.removeEventListener("keyup",oe),V.divCssElement.removeEventListener("dragstart",le),V.divCssElement.removeEventListener("contextmenu",se),n.removeEvent(V.divCssElement,"onMouseWheel",$),n.removeEvent(V.canvas,"onMouseWheel",$),n.removeEvent(V.divCssElement,"onPrimaryPointerDownUnique",re),n.removeEvent(V.canvas,"onPrimaryPointerDownUnique",re),n.removeEvent(V.divCssElement,"onPrimaryPointerUpUnique",re),n.removeEvent(V.canvas,"onPrimaryPointerUpUnique",re),h&&(V.unsubscribe(h),h=null),n.removeEvent(V.divCssElement,"onSwipe",J),n.removeEvent(V.canvas,"onSwipe",J),R.getImmersiveFrame().removeEventListener("freeZoneResize",Q),c&&V.setPicking(c),t&&V.antiAliasing!==t&&"MSAA"===V.antiAliasing&&V.setAntiAliasing(t),V.get2DMode()&&V.set2DMode(!1),W.onCenterCamera(null),V.render(),g&&o.unsubscribe(g),I&&(r.unsubscribe(I.onPSOEmpty),r.unsubscribe(I.onPSORemove),r.unsubscribe(I.onPSOAdd),a.unsubscribe(I.onCSOEmpty),a.unsubscribe(I.onCSORemove),a.unsubscribe(I.onCSOAdd),I=void 0),E&&l.cleanRequirementElements(E),S&&(S.links&&S.links.length&&S.links.forEach(function(e){e.remove&&e.remove()}),l.cleanPdfPages(S.pages)),T&&T.removeChildren(),U=0,F=!1,B=!1,q=!1,L=!0,z=!0,T=t=w=D=u=c=null,m=g=x=S=d=null},this.clean=function(){A.removeDocument(),V=W=R=null},this.isADocumentDisplayed=function(){return Boolean("Requirement"===f&&E&&E.size||"Document"===f&&S&&S.pages.size)},this.getDocumentRotationAngle=function(){if(S&&S.pages){let e=S.pages.get("1");return e?e.rotationAngle:0}},this.getDocumentType=function(){return f},this.getDocumentBuffer=function(){if(S)return S.buffer},this.getDocumentLoadedID=function(){return d||void 0},this.getExternalComments=function(){if(S)return S.externalComments},this.getPDFHyperlinks=function(){if(S&&S.links)return S.links.filter(function(e){return e.div&&e.content})},this.setTouchPanActive=function(e){q=e},this.getTouchPanActive=function(){return q},this.forceElementsLoad=function(e){if(!e||!E)return;let t=!1;e.forEach(e=>{let n=E.get(e);n&&(t=!0,n.node||l.renderElement(n,()=>{}),n.pathElement&&n.loaded||(n.toLoad=!0))}),t&&l.updateNodesInSession(T,E)},this.getElementsVisualizationData=function(){let e=S?S.pages:E,t=e.get(l.getElementIdAtIndex(0)),n={visibleElements:[],current:y,elementLength:e.size,type:t?t.type:"page"},o=e.values();for(let t=y-1;t<e.size;t++){let e=o.next().value;e.visible&&n.visibleElements.push({number:e.number,title:e.title})}return n},this.setMultiPageVisibility=function(e){e!==M&&(M=e,Q(),ee(),A.setCurrentElement({elementID:y}))},this.getMultiPageVisibility=function(){return M},this.getElementInfo=function(e){if(!e||!E)return;let t=E.values();for(let n=0;n<E.size;n++){const o=t.next().value;if(o.id===e)return{title:o.title,index:n+1,pathElement:o.pathElement}}},this.getElementMatrix=function(e){if(!E&&!S||!e)return null;if("string"==typeof e&&E){let t=E.get(e);if(t){let e=new i.Vector3(t.coordinates.left,t.marginTop?t.coordinates.top-t.marginTop:t.coordinates.top,0);return(new i.Matrix4).setPosition(e)}}else if("number"==typeof e&&S&&S.pages&&e>=1&&e<=S.document.numPages){let t=S.pages.get(e.toString());if(t){let e=Math.abs(t.height*Math.cos(t.rotationAngle)-t.width*Math.sin(t.rotationAngle)),n=Math.abs(t.height*Math.sin(t.rotationAngle)+t.width*Math.cos(t.rotationAngle)),o=(new i.Matrix4).makeRotationZ(t.rotationAngle),r=new i.Vector3(-t.width/2,t.height/2,0).applyMatrix4(o);return r.add(new i.Vector3(t.coordinates.left+n/2,t.coordinates.top-e/2,0)),(new i.Matrix4).setPosition(r).multiply(o)}}return null},this.getPageRotation=function(e){if(!S||!S.pages||!e||e<1||e>S.document.numPages)return;let t=S.pages.get(e.toString());return t?t.rotationAngle:void 0},this.getPointedElemIDAtPosition=function(e){if(!E&&!S||!e)return;let t=S?S.pages:E,n=1,o=t.size;for(;n<=o;){let i=Math.floor((n+o)/2),r=l.getElementIdAtIndex(i-1),a=t.get(r);if(!a)break;{let t=a.coordinates;if(t.top>e.y&&t.bottom<e.y)return t.left<e.x&&t.right>e.x?S?i:r:void 0;t.top<e.y?o=i-1:n=i+1}}},this.enableTextSelection=function(e){z!==e&&(V.divCssElement.setStyle("display",e?"block":"none"),z=e)},this.setTextSelectionFlag=function(e){if(L!==e){if(L=e,e){let e=".WebDocTextLayer > span:not(.WebDocPageLoadingProgressBar):hover{ cursor: text}",t=document.createElement("style");t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),p=t}else p&&document.getElementsByTagName("head")[0].removeChild(p);A.setLinkActivationFlag(e)}},this.setLinkActivationFlag=function(e){if(j!==e)if(j=e,e)k&&document.getElementsByTagName("head")[0].removeChild(k);else{let e=".WebDocLinkAnnotation { display: none }",t=document.createElement("style");t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),k=t}},this.centerViewpointAtElementPosition=function(e){if(!S&&!E||!e.position)return;let t=e.offsetYPix||0,n=W,o=n.getEyePosition(),r=A.getElementMatrix(e.elementID);if(r){let a=(new i.Vector3).getPositionFromMatrix(r),s=new i.Vector3(e.position.x,e.position.y,0).applyMatrix4(r.setPosition(new i.Vector3)),c=n.getCamera(),d=l.getMMPerPixelRatio(V),u={left:v?v.left*d:0,right:v?v.right*d:0,bottom:v?(v.bottom-t)*d:0},m=s.x+a.x+(u.right-u.left)/(e.centerAtTopLeft?1:2),g=s.y+a.y+u.bottom;e.centerAtTopLeft&&(m+=c.right,g+=c.bottom),n.moveTo({eyePosition:new i.Vector3(m,g,o.z),duration:void 0===e.duration?200:e.duration})}},this.centerViewpointAtNextOrPreviousElement=function(e){if(!S&&!E)return;let t=1,n=S?S.pages:E;if(M&&S&&y<n.size){let e=n.get(l.getElementIdAtIndex(y-1)),o=n.get(l.getElementIdAtIndex(y));if(e&&o){let n=e.coordinates,i=o.coordinates;Math.abs(n.top-i.top)<1e-5&&t++}}let o=y+(e?t:-t);o=o<1?1:o<=n.size?o:n.size;let i=l.getElementIdAtIndex(o-1);A.setCurrentElement({elementID:S?o:i,duration:100})},this.getCurrentElementId=function(){return S?y:l.getElementIdAtIndex(y-1)},this.getElementCoordinates=function(e){if("number"==typeof e){let t=S&&S.pages.get(e.toString());return t?t.coordinates:void 0}if("string"==typeof e){let t=E.get(e);return t?t.coordinates:void 0}},this.setCurrentElement=function(e){let t,n=W.getEyePosition();if("number"==typeof e.elementID&&e.elementID>=1&&S){let o=S&&S.pages.get(e.elementID.toString());o&&(t=new i.Vector3(n.x,o.coordinates.top-W.getCamera().top,n.z))}else if("string"==typeof e.elementID){let o=E.get(e.elementID);if(!o)return;t=new i.Vector3(n.x,o.coordinates.top-W.getCamera().top,n.z),o&&o.setAsCurrent()}W.moveTo({eyePosition:t,duration:e.duration||0})},this.reframeOnElements=function(e){if(!S&&!E)return;let t=W.getCamera(),n=W.getEyePosition(),o=l.getMMPerPixelRatio(V),r=v?v.left*o:0,a=v?v.right*o:0,s=v?v.bottom*o:0,c=t.top,d=t.bottom+s,u=t.left+r,m=t.right-a,g=-1/0,f=1/0,p=1/0,h=-1/0,y=!1;if(e.forEach(e=>{var t,n;let o=S?null===(t=S.pages.get(e))||void 0===t?void 0:t.coordinates:null===(n=E.get(e))||void 0===n?void 0:n.coordinates;o&&(y=!0,g=Math.max(g,o.top),f=Math.min(f,o.bottom),p=Math.min(p,o.left),h=Math.max(h,o.right))}),y){let e,t,o,l=(a-r)/2;Math.abs((m-u)/(h-p))<Math.abs((c-d)/(g-f))?(t=g-(c-d)/2*((h-p)/(m-u)),e=n.z*(h-p)/(m-u),o=W.getTargetDistance()*(h-p)/(m-u)):(t=(g+f)/2,e=n.z*(g-f)/(c-d),o=W.getTargetDistance()*(g-f)/(c-d)),O=!0,W.moveTo({eyePosition:new i.Vector3(l,t,e),distanceToTarget:o,duration:400})}},this.fitCurrentElement=function(e=!1){var t;if(S||E)if(e){let e=W.getCamera(),n=l.getMMPerPixelRatio(V),o={left:v?v.left*n:0,right:v?v.right*n:0,bottom:v?v.bottom*n:0},r={top:e.top,bottom:e.bottom+o.bottom,left:e.left+o.left,right:e.right-o.right},a=W.getEyePosition(),s=(S?l.getMaxWidth(S.pages,y-1):null===(t=E.get(l.getElementIdAtIndex(0)))||void 0===t?void 0:t.width)||0;W.moveTo({eyePosition:new i.Vector3((o.right-o.left)/2,a.y,a.z*s/(r.right-r.left)),distanceToTarget:W.getTargetDistance()*s/(r.right-r.left),duration:400})}else{let e=l.getElementIdAtIndex(y-1);A.reframeOnElements([e])}},this.setDocumentRotationAngle=function(e){if(!S||!S.pages)return;let t=(new i.Matrix4).makeRotationZ(e),n=0;S.pages.forEach(function(o){o.rotationAngle=e;let r=Math.abs(o.height*Math.cos(e)-o.width*Math.sin(e)),a=Math.abs(o.height*Math.sin(e)+o.width*Math.cos(e));if(o.coordinates.top=n,o.coordinates.bottom=n-r,o.coordinates.right=a/2,o.coordinates.left=-a/2,n-=r+4,o.node){let e=new i.Vector3(-o.width/2,-o.height/2,0).applyMatrix4(t);e.add(new i.Vector3(0,o.coordinates.bottom+r/2,0)),o.node.setMatrix((new i.Matrix4).setPosition(e).multiply(t))}}),V.render(),A.setCurrentElement({elementID:y}),K("onDocumentRotationAngleChange",{rotationAngle:e})},this.getDocumentBookmarks=function(){return(S?S.bookmarks:w)||[]},this.getDocumentLength=function(){return S?S.document.numPages:E?E.size:0},this.subscribe=function(e,t){return e&&t?N.subscribe({event:e},t):""},this.unsubscribe=function(e){null!=e&&N.unsubscribe(e)}}}let d=[];return class{static getWebDocumentVisualizationController(e={context:null}){let t;for(let n=0;n<d.length;n++)if(d[n].context===e.context)return t=d[n].controller,d[n].count++,t;let n=new c(e);return(t=Object.freeze({isLoading:()=>!!n&&n.isLoading(),loadDocumentStream:e=>{if(n)return n.loadDocumentStream(e)},enableTextSelection:e=>{if(n)return n.enableTextSelection(e)},forceElementsLoad:e=>{n&&n.forceElementsLoad(e)},getDocumentType:()=>n?n.getDocumentType():null,getElementInfo:e=>{if(n)return n.getElementInfo(e)},getElementMatrix:e=>{if(n)return n.getElementMatrix(e)},getPageRotation:e=>{if(n)return n.getPageRotation(e)},getPointedElemIDAtPosition:e=>{if(n)return n.getPointedElemIDAtPosition(e)},getDocumentLoadedID:()=>{if(n)return n.getDocumentLoadedID()},getElementsVisualizationData:()=>{if(n)return n.getElementsVisualizationData()},getDocumentBookmarks:()=>{if(n)return n.getDocumentBookmarks()},getDocumentRotationAngle:()=>{if(n)return n.getDocumentRotationAngle()},getExternalComments:()=>{if(n)return n.getExternalComments()},getPDFHyperlinks:()=>{if(n)return n.getPDFHyperlinks()},getTouchPanActive:()=>{if(n)return n.getTouchPanActive()},setTouchPanActive:e=>{if(n)return n.setTouchPanActive(e)},setDocumentRotationAngle:e=>{if(n)return n.setDocumentRotationAngle(e)},getMultiPageVisibility:()=>{if(n)return n.getMultiPageVisibility()},setMultiPageVisibility:e=>{if(n)return n.setMultiPageVisibility(e)},getCurrentElementId:()=>{if(n)return n.getCurrentElementId()},getElementCoordinates:e=>{if(n)return n.getElementCoordinates(e)},setCurrentElement:e=>{if(n)return n.setCurrentElement(e)},setTextSelectionFlag:e=>{if(n)return n.setTextSelectionFlag(e)},setLinkActivationFlag:e=>{if(n)return n.setLinkActivationFlag(e)},isADocumentDisplayed:()=>!!n&&n.isADocumentDisplayed(),getDocumentBuffer:()=>{if(n)return n.getDocumentBuffer()},getDocumentLength:()=>{if(n)return n.getDocumentLength()},centerViewpointAtElementPosition:e=>{if(n)return n.centerViewpointAtElementPosition(e)},centerViewpointAtNextOrPreviousElement:e=>{if(n)return n.centerViewpointAtNextOrPreviousElement(e)},fitCurrentElement:e=>{if(n)return n.fitCurrentElement(e)},reframeOnElements:e=>{if(n)return n.reframeOnElements(e)},subscribe:(e,t)=>n?n.subscribe(e,t):"",unsubscribe:e=>{if(n)return n.unsubscribe(e)},removeDocument:()=>{if(n)return n.removeDocument()},clean:()=>{n&&(n.clean(),n=null)}}))&&d.push({context:e.context,controller:t,count:1}),t}static giveWebDocumentVisualizationController(e){if(e&&e.context)for(let t=0;t<d.length;t++)if(d[t].context===e.context)return d[t].controller}static unreferenceWebDocumentVisualizationController(e){if(e&&e.context)for(let t=0;t<d.length;t++)if(d[t].context===e.context){d[t].count--,0===d[t].count&&(d[t].controller.clean(),d.splice(t,1));break}}}}),define("DS/WebDocumentVisualization/WebDocumentBookmarksController",["require","exports","DS/CATWebUXComponents/CATWebUXPanel","DS/Visualization/ThreeJS_DS","DS/WebDocumentVisualizationUI/WebDocumentBookmarksPanel","DS/WebDocumentVisualization/WebDocumentVisualizationController"],function(e,t,n,o,i,r){"use strict";class a{constructor(e){let t,a,l,s,c,d=e.context;function u(){let e=r.giveWebDocumentVisualizationController({context:d});if(e&&t&&!l){let n=e.getCurrentElementId();if("number"==typeof n){let o=e.getElementCoordinates(n);o&&t.highlightBookmark({pageNumber:n,yCoordinate:d.getViewpoint().getEyePosition().y+d.getViewpoint().getCamera().top-o.bottom})}else"string"==typeof n&&t.highlightBookmark({elementId:n})}}this.displayBookmarksPanel=function(){let e=r.giveWebDocumentVisualizationController({context:d});if(e){if(c=e.subscribe("onScrollChange",function(e){"start"!==e.type&&(u(),"end"===e.type&&(l=!1))}),t||(t=new i,a||(a={onBookmarkSelected:t.subscribe("onBookmarkSelected",function(t){if(t&&t.target&&e){if(l=!0,t.target.pointedPosition){let n=e.getElementCoordinates(t.target.pointedPage);n&&e.centerViewpointAtElementPosition({elementID:t.target.pointedPage,position:new o.Vector3(t.target.pointedPosition.x,t.target.pointedPosition.y-(n.top-n.bottom),0),duration:0,centerAtTopLeft:!0})}else e.setCurrentElement({elementID:t.target.pointedPage||t.target.pointedId});(t.target.fitAllIn||t.target.fitWidth)&&setTimeout(function(){l=!0,e&&e.fitCurrentElement(t.target.fitWidth)}),s.isSmallWidth()&&s.collapsePanel()}}),onBookmarkExpanded:t.subscribe("onBookmarkExpanded",u)})),!s){let o=e.getDocumentBookmarks();if(o){let e=t.buildPanel(o);const i=300,r=160,a=250;(s=new n({id:"WebDocBookmarksPanel",className:"WebDocBookmarksPanel",showTitleFlag:!1,autoCloseFlag:!1,closeButtonFlag:!1,icon:"fonticon wux-ui-3ds-bookmark",immersiveFrame:d.getFrameWindow().getImmersiveFrame(),viewerFrame:d.getFrameWindow().getViewerFrame(),content:e,minWidth:a,width:i,minHeight:r,height:r,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea})).ensureVisible()}}u()}},this.setPanelVisibilityFlag=function(e){s&&e!==s.getPanelVisibilityFlag()&&s.setPanelVisibilityFlag(e)},this.destroyBookmarksPanel=function(){if(c){let e=r.giveWebDocumentVisualizationController({context:d});e&&e.unsubscribe(c)}if(t&&a){Object.keys(a).forEach(function(e){t&&a&&t.unsubscribe(a[e])}),t.cleanPanel()}s&&(s.setPanelVisibilityFlag(!1),s.clean()),t=s=a=c=null},this.clean=function(){this.destroyBookmarksPanel(),d=null}}}let l=[];return class{static getWebDocumentBookmarksController(e){let t;for(let n=0;n<l.length;n++)if(l[n].context===e.context)return t=l[n].controller,l[n].count++,t;let n=new a(e);return t=Object.freeze({displayBookmarksPanel:()=>{n&&n.displayBookmarksPanel()},setPanelVisibilityFlag:e=>{n&&n.setPanelVisibilityFlag(e)},destroyBookmarksPanel:()=>{n&&n.destroyBookmarksPanel()},clean:()=>{n&&(n.clean(),n=null)}}),l.push({context:e.context,controller:t,count:1}),t}static giveWebDocumentBookmarksController(e){let t;if(e&&e.context)for(let n=0;n<l.length;n++)if(l[n].context===e.context)return t=l[n].controller}static unreferenceWebDocumentBookmarksController(e){if(e&&e.context)for(let t=0;t<l.length;t++)l[t].context===e.context&&(l[t].count--,0===l[t].count&&(l[t].controller.clean(),l.splice(t,1)))}}});