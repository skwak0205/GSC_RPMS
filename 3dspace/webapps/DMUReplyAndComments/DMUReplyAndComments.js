define("DS/DMUReplyAndComments/DMUCreateSlideReplyCmd",["UWA/Utils","DS/ApplicationFrame/Command","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUI/DMUToolsUsers","DS/DMUReviewPersistence/DMUAuthReviewPersistenceServices","i18n!DS/DMUReplyAndComments/assets/nls/DMUReplyAndComments"],function(e,t,n,i,r,a,o,s){"use strict";return t.extend({init:function(t){t.mode="shared",t.repeatMode=!1,t.isAsynchronous=!0,this._parent(t);let l=this;this.beginExecute=function(){require(["DS/DMUBaseExperience/EXPUtils"],function(e){e._sendUsageProbe("command","CreateSlideReply")});let t=l.getFrameWindow(),u=n.getReviewContext({viewer:t.getViewer()}),m=u?u.getValidation():null,d=m?m.getCurrentMarkup():null;if(m&&d){let n=r.giveDMUSlidesController({context:t}),g=n.getRepliedSlide(),D=u.getCurrentSessionMarkup();if(D&&g){let r=a.getUserLogin(),c=g.getAttribute("sParentSlideID");c||(c=g.getAttribute("sUuid"));let U=g.getAttribute("sName");U&&(U=U.replace(s.replyTo,""));var p=[{name:"sID",value:D.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sOwner",value:a.getUserLogin()},{name:"fCreationDate",value:Date.now()},{name:"sName",value:D.computeNewName({object:g,prefix:U,noSuffixIfPossible:!0,separator:"parenthesis"})},{name:"sParentSlideID",value:c}];let M=d;for(;M&&"Markup"!==M.getValType();)M=M.getParentRepRef().getParent();let f=function(){let e=i.getManager({name:"DMUUserExperienceManager",context:t});e?e.duplicateDMUElements({elements:[g],parent:u.getCurrentSessionMarkup(),attributes:[p],cb:function(e){if(e&&e.duplicatedElements&&1===e.duplicatedElements.length){let t=g.getEnvironmentOverload(),i=u.getEnvironment().getEnvironmentInfo();i.sFocusProperty=t.state.sFocusProperty,e.duplicatedElements[0].updateEnvironmentOverload({target:u.getEnvironment(),state:i}),n.setActiveSlide(e.duplicatedElements[0],{duration:0})}l.end()}}):l.end()};if(M){let e=function(){o.addReply({markupRef:M,viewer:t.getViewer(),validation:m,onReplyCreationCompleted:function(e){m.setCurrentMarkup(e.replyRepRef),f()},onReplyCreationFailed:function(){l.end()}})},n=M.getReplies(),i=!1;n.some(e=>(e.isWebMarkup&&e.isWebMarkup()&&(e.getOwner&&e.getOwner()===r||e.getRepRef()&&e.getRepRef().getOwner&&e.getRepRef().getOwner()===r)&&(m.setCurrentMarkup(e),f(),i=!0),i)),i||e()}else l.end()}}}}})}),define("DS/DMUReplyAndComments/DMUCommentReplyCreateCmd",["UWA/Utils","DS/ApplicationFrame/Command","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUPlayComment/DMUComment","DS/DMUBaseUI/DMUToolsUsers","DS/DMUReviewPersistence/DMUAuthReviewPersistenceServices","DS/Selection/CSOManager","i18n!DS/DMUReplyAndComments/assets/nls/DMUReplyAndComments"],function(e,t,n,i,r,a,o,s,l){"use strict";return t.extend({init:function(t){t.mode="shared",this._parent(t);var u=this;function m(t,n){let i=new r(u.getFrameWindow().getViewer(),t),o=[{name:"sID",value:t.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:t.computeNewName({object:i,prefix:l.commentPrefix})},{name:"sOwner",value:a.getUserLogin()},{name:"sTextContents",value:[""]},{name:"fCreationDate",value:Date.now()},{name:"fLastModificationDate",value:Date.now()}];return n&&o.push({name:"sParentCommentId",value:n.getAttribute("sUuid")}),i.setAttributes(o),i}this._parentBeginExecute=this.beginExecute,this.beginExecute=function(){this._parentBeginExecute();var e=n.getReviewContext({viewer:this.getFrameWindow().getViewer()}),t=e?e.getCurrentSessionMarkup():null;if(!t)return void u.end();var r=s.get();if(!r||1!==r.length)return void u.end();var l=i.giveDMUCommentsController({context:u.getFrameWindow()}).getDMUObjectFromPathElement(r[0].pathElement);if(!l)return void u.end();let d=e?e.getValidation():null,p=d?d.getCurrentMarkup():null;if(d&&p){let e=p;for(;e&&"Markup"!==e.getValType();)e=e.getParentRepRef().getParent();if(e){let t=function(e){let t=e.getMarkupContent(),n=m(t,l);t.addComment(n),n.fireEvent("onDMUObjectInitialized",{dmuObject:n,parentObject:l}),n.fireEvent("onDMUCommentEditionRequired",{dmuObject:n,parentObject:l})},n=function(){o.addReply({markupRef:e,viewer:u.getFrameWindow().getViewer(),validation:d,onReplyCreationCompleted:function(e){t(e.replyRepRef)},onReplyCreationFailed:function(){u.end()}})},i=e.getReplies(),r=a.getUserLogin();i.some(e=>{if(e.isWebMarkup&&e.isWebMarkup()&&(e.getOwner&&e.getOwner()===r||e.getRepRef()&&e.getRepRef().getOwner&&e.getRepRef().getOwner()===r))return t(e.getRepRef()),!0})||n()}else u.end()}else{var g=r[0].pathElement.getSubPath(function(e){return e.getDMUType&&"DMUComment"!==e.getDMUType()}),D=t.getDMUObjectFromPathElement(g);let e=D.getDMUComments().indexOf(l);if(e>=0){let n=m(t);D.addDMUComment(n,e+1),n.fireEvent("onDMUObjectInitialized",{dmuObject:n}),n.fireEvent("onDMUCommentEditionRequired",{dmuObject:n})}}u.end()}}})}),define("DS/DMUReplyAndComments/DMUReplyAndComments",[],function(){});