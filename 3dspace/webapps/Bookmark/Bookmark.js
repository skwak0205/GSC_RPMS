define("DS/Bookmark/script/Model/BaseModel",["UWA/Core","UWA/Json","UWA/Utils","UWA/Class/Model","DS/Logger/Logger","DS/WAFData/WAFData"],function(e,t,o,n,i,s){"use strict";function r(e){return e.contains("?")?e.endsWith("?")?"":"&":"?"}return n.extend({_getResponseHeader:function(t,o){var n=null,i=t.request;return e.is(i&&i.getResponseHeader,"function")?n=i.getResponseHeader(o):e.is(i&&i.xhr&&i.xhr.getResponseHeader,"function")?n=i.xhr.getResponseHeader(o):t.responseHeaders&&(n=t.responseHeaders[o]),n},sync:function(n,a,l){var c,u,d,h=l||{},m=this,p=h.onComplete,f=h.onFailure,k=e.is(this.getSubject,"function")?this.getSubject():this;h.ajax=s.authenticatedRequest,h.headers=h.headers||{},e.is(h.data,"object")&&("read"===n||h.method&&"get"===h.method.toLowerCase())?(h.url+=r(h.url)+o.toQueryString(h.data),h.data=null):h.headers["Content-Type"]||(h.headers["Content-Type"]="application/json;charset=utf-8"),h.url||(h.url=(u="url",d=void 0,(c=a)&&(d=c[u],e.is(d,"function")&&(d=d.call(c))),d)),h.url&&-1===h.url.indexOf("tenant=")&&(e.is(k.getSharedOptions,"function")?h.url+=r(h.url)+"tenant="+k.getSharedOptions().getOption("tenantId"):i.warn("Tenant Id is missing")),p&&(h.onComplete=function(o,n){var i=e.is(o,"string")?t.decode(o):o;return m._totalRecords=e.is(i&&i.totalRecords)?i.totalRecords:0,p.call(this,e.is(i&&i.result)?i.result:i,n)}),f&&(h.onFailure=function(o,n,i){var s=e.is(n,"string")?t.decode(n):n;return f.call(this,o,e.is(s&&s.result)?s.result:s,i)}),this._parent.call(this,n,a,h)}})}),define("DS/Bookmark/script/Request/BookmarkRequest",["UWA/Core","UWA/Class"],function(e,t){"use strict";return t.singleton({_serviceUrl:null,_csrfToken:null,setConfig:function(e){e.serviceUrl?this._serviceUrl=e.serviceUrl:console.error("Option serviceUrl must be send to initialize Bookmark requests"),e.csrfToken?this._csrfToken=e.csrfToken:console.error("Option csrfToken must be send to initialize Bookmark requests")},updateRequest:function(t,o,n){return e.merge(n,{headers:{}}),this._serviceUrl&&(n.url=this._serviceUrl+n.url),this._csrfToken&&(n.headers={"X-DS-CSRFTOKEN":this._csrfToken}),t&&o&&("update"!==t&&"delete"!==t||(n.url+="/"+o.get("id")),"read"===t&&o.get("subjectUri")&&(n.url+="/subjects/"+o.get("subjectUri"))),n}})}),define("DS/Bookmark/script/Model/BookmarkModel",["UWA/Core","UWA/Promise","DS/Bookmark/script/Model/BaseModel","DS/Bookmark/script/Request/BookmarkRequest"],function(e,t,o,n){"use strict";return o.extend({name:"bookmark",url:"/api/bookmarks/me",defaults:{subjectUri:null,title:null,serviceName:null,linkServiceName:null,linkUri:null},_thumbnailUrl:null,sync:function(e,t,o){return o.url=this.url,o=n.updateRequest(e,t,o),this._parent.apply(this,arguments)},getThumbnailUrl:function(){return this._thumbnailUrl},getModelName:function(){return this.name},_setThumbnailUrl:function(e){var o=this;return o.platformId=e.hasOwnProperty("platformId")&&e.platformId,new t(function(e,t){require(["DS/BookmarkCustomization/script/source/"+o.get("serviceName")],function(t){t.getThumbnailUrlFromContentUri(o.toJSON(),o.platformId,function(t){o._thumbnailUrl=t,e()})},function(){console.error("No customization module for this serviceName: "+o.get("serviceName"))})})}})}),define("DS/Bookmark/script/Collection/BaseCollection",["UWA/Core","UWA/Json","DS/WebAppsFoundations/Collections/PageableCollection","UWA/Class/Model","DS/Bookmark/script/Model/BaseModel"],function(e,t,o,n,i){"use strict";return o.extend({_mainRangeName:null,_stateModel:null,_fetched:!1,_beingFetched:!1,ranges:null,defaultOptions:{stateParseMode:"headers",state:{baseOffset:0,firstPage:0,currentPage:0},queryParams:{currentPage:"page_number",pageSize:"page_size"}},_executePostInitInstructions:function(){var e=this,t=function(e,t){if("function"==typeof e)return o=null,n=null,i=t||30,s=null,r=function(){e.apply(n,o)},function(){n=this,o=arguments,s&&clearTimeout(s),s=setTimeout(r,i)};throw new Error("First argument is supposed to be a function");var o,n,i,s,r}(function(){var t=[];arguments.length>=2&&(t=[].concat(arguments).slice(arguments.length-2)),e.dispatchEvent("onCollectionChange",t)});this.addEventOnce("onSync",function(e){e===this&&(this._fetched=!0)}),this.addEvents({onAdd:t,onRemove:t,onSort:t,onReset:t,onRequest:function(e){this===e&&(this._beingFetched=!0)},onSync:function(e){this===e&&(this._beingFetched=!1)},onError:function(e){this===e&&(this._beingFetched=!1)}})},_computeTotalPages:function(e,t){return this.state&&this.state.baseOffset>0&&e>=this.state.baseOffset?Math.ceil((e-this.state.baseOffset)/t):this._parent.apply(this,arguments)},_getPageValueConsistentWithCurrentState:function(t){t||(t={});var o=this.state||{},n=e.is(t.totalRecords,"number")?t.totalRecords:o.totalRecords,i=e.is(t.collectionSize,"number")?t.collectionSize:this.length;return this._computeTotalPages(n,o.pageSize)?Math.max(o.firstPage,Math.ceil((i-this.state.baseOffset)/o.pageSize)-(0===o.firstPage?1:0)):o.firstPage},_updateCurrentPageState:function(){this.state=this._checkState(e.extend(this.state||{},{currentPage:this._getPageValueConsistentWithCurrentState()}))},_updateStateModel:function(){this._stateModel||(this._stateModel=new n,this.listenTo(this._stateModel,{onAnyEvent:function(e,t,o,n){this.dispatchEvent(e+"State",[t,o,n])}})),this._stateModel.set(this.state)},_checkState:function(){var e=this._parent.apply(this,arguments);return setTimeout(this._updateStateModel,0),e},_getResponseHeader:function(t,o){var n=null;return e.is(t.request&&t.request.getResponseHeader,"function")?n=t.request.getResponseHeader(o):t.responseHeaders&&(n=t.responseHeaders[o]),n},init:function(){this.ranges={},this._updateStateModel=this._updateStateModel.bind(this),this._parent.apply(this,arguments),this._executePostInitInstructions()},parseRanges:function(e,t){return{}},parseHeadersForStateUpdate:function(t,o,n,i){return e.extend(this.ranges,this.parseRanges(t,i)),{}},setTotalRecords:function(e){return this._totalRecords=e,this},getTotalRecords:function(){return this._totalRecords},sync:function(e,t,o){return i.prototype.sync.apply(this,arguments)},hasBeenFetched:function(){return this._fetched},isBeingFetched:function(){return this._beingFetched},onAdd:function(){this._updateCurrentPageState()},onRemove:function(){this._updateCurrentPageState()},onReset:function(){this._updateCurrentPageState()},onCollectionChange:function(e,t){this._beingFetched||this.state.totalRecords&&!(this.length>this.state.totalRecords)||this.setTotalRecords(this.length)},clean:function(){this.reset([])}})}),define("DS/Bookmark/script/Collection/BookmarkCollection",["UWA/Core","DS/Logger/Logger","DS/Bookmark/script/Collection/BaseCollection","DS/Bookmark/script/Model/BookmarkModel","DS/Bookmark/script/Request/BookmarkRequest"],function(e,t,o,n,i){"use strict";return o.extend({name:"bookmark-collection",url:"/api/bookmarks/me",model:n,defaultOptions:{state:{pageSize:10}},_executePostInitInstructions:function(){},parseRecords:function(e,t){return e},setup:function(e){return this._parent.apply(this,arguments)},fetch:function(e){var o=e||{};return o.onFailure||(o.onFailure=function(){t.error("Failed to retrieve bookmarks")}),o.url=this.url,e.service_name&&(o.url=o.url+"/"+e.service_name),o=i.updateRequest(null,null,o),this._parent.call(this,o)},hasNext:function(){return parseInt(this._totalRecords)!==parseInt(this.length)}})}),define("DS/Bookmark/script/BookmarkManager",["UWA/Core","UWA/Class","UWA/Promise","DS/Bookmark/script/Model/BookmarkModel","DS/Bookmark/script/Collection/BookmarkCollection","DS/Bookmark/script/Request/BookmarkRequest","DS/WAFData/WAFData","DS/UWPClientControls/PlatformNotify","UWA/Class/Events","i18n!DS/Bookmark/assets/nls/bookmark-manager","DS/Logger/Logger"],function(e,t,o,n,i,s,r,a,l,c,u){"use strict";return l.singleton({_serviceUrl:null,_csrfToken:null,_isReady:!1,_isFailed:!1,_getThumbnails:function(e,t){var n=[],i=this.platformId?{platformId:this.platformId}:{};e.map(function(e){n.push(e._setThumbnailUrl(i))}),o.all(n).then(function(){t&&t(e)},function(){u.log("getThumbnail failed",arguments)})},init:function(e){this.setConfig(e)},setConfig:function(e){var t=this;t._isReady=!1,e&&e.hasOwnProperty("csrfToken")&&e.hasOwnProperty("serviceUrl")?(s.init({csrfToken:e.csrfToken,serviceUrl:t.serviceUrl}),t.dispatchEvent("onReady")):(t.platformId=e&&e.platformId,require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(e){e.getServiceUrl({platformId:t.platformId,serviceName:"comment",onComplete:function(e){t._serviceUrl=e,r.authenticatedRequest(t._serviceUrl+"/api/session/info",{method:"GET",type:"json",headers:{Accept:"application/json;charset=UTF-8","Content-Type":"application/json;charset=UTF-8"},onComplete:function(e,o,n){t._csrfToken=e.csrfToken,t._isReady=!0,s.setConfig({csrfToken:t._csrfToken,serviceUrl:t._serviceUrl}),t.dispatchEvent("onReady")},onFailure:function(){t._isFailed=!0,t.dispatchEvent("onFailure"),console.error("Failed to get CSRF token from comment service")}})},onFailure:function(){t._isFailed=!0,t.dispatchEvent("onFailure"),console.error("Failed to get bookmark (comment) service url")}})}))},get:function(t,o){var n=this;n._isReady?new i([],{state:{currentPage:t.page_number?t.page_number:0,pageSize:t.page_size?t.page_size:25},serviceName:t.service_name?t.service_name:null}).fetch(e.extend(t,{onComplete:function(e){n._getThumbnails(e,o)}})):n._waitInitialization(n.get,arguments)},getNextPage:function(e,t){var o=this;o._isReady&&e&&e.getNextPage({add:!0,remove:!1,reset:!1,onComplete:function(e){o._getThumbnails(e,t)}})},add:function(e){var t,o=this,i=o.platformId?{platformId:o.platformId}:{};o._isReady?(t=new n).save(e,{onComplete:function(){t._setThumbnailUrl(i).then(function(){o.dispatchEvent("onBookmarkAdded",t),a.success(c.SuccessfullyAddedToYourBookmarks)})}}):o._waitInitialization(o.add,arguments)},remove:function(e){var t=this;e.destroy({onComplete:function(){t.dispatchEvent("onBookmarkRemoved",e),a.success(c.SuccessfullyRemovedFromYourBookmarks)}})},update:function(e,t){var o=this;e.save(t,{onComplete:function(e){o.dispatchEvent("onBookmarkUpdated",e),a.success(c.BookmarkSuccessfullyUpdated)}})},isContentBookmarked:function(e,t){this._isReady?new n({subjectUri:e}).fetch({onComplete:function(e,o){var i;o.length>0?(i=new n(o[0]),t(i)):t(!1)},onFailure:function(e){u.log(e),t(new Error("Bookmark service down"))}}):this._waitInitialization(this.isContentBookmarked,arguments)},_waitInitialization:function(e,t){var o=this;o._isFailed?t.hasOwnProperty("1")&&"function"==typeof t[1]&&t[1](new Error("Failed to reach Bookmark service")):(o.addEventOnce("onReady",function(){e.apply(o,t)}),o.addEventOnce("onFailure",function(){t.hasOwnProperty("1")&&"function"==typeof t[1]&&t[1](new Error("Failed to reach Bookmark service"))}))}})}),define("DS/Bookmark/script/View/BookmarkItemView",["UWA/Core","UWA/Class/View","UWA/String","UWA/Event","DS/UIKIT/SuperModal","DS/Bookmark/script/BookmarkManager","DS/UIKIT/DropdownMenu","DS/UIKIT/Input/Text","DS/UIKIT/Tooltip","i18n!DS/Bookmark/assets/nls/View/bookmark-item-view"],function(e,t,o,n,i,s,r,a,l,c){"use strict";return t.extend({className:"bookmark-item-view",_superModal:null,_editMode:!1,_actionTooltip:null,_cancelTooltip:null,setup:function(){this.clickCallback=this.options.clickCallback,this.listenTo(this.model,"onChange",this.render)},render:function(){var t,u=this;return t=window.ds&&"3DD"!==ds.env?window.document&&window.document.body:window.widget&&window.widget.body,this.editInput=new a({placeholder:c.BookmarkTitle+"...",value:this.model.get("title")?o.unescapeHTML(this.model.get("title")):"",className:"bookmark-title-input",events:{onKeyDown:function(e){var t=n.whichKey(e);"return"===t?(this.getValue()!==u.model.get("title")&&""!==this.getValue()&&s.update(u.model,{title:this.getValue()}),u._closeEditMode()):"esc"===t&&(this.setValue(u.model.get("title")),u._closeEditMode())}}}).hide(),this.titleElt=e.createElement("h4",{class:"card-title",text:this.model.get("title")?o.unescapeHTML(this.model.get("title",{escapeHTML:!0})):""}),this.cancelElt=e.createElement("span",{class:"bookmark-edit-cancel fonticon fonticon-2x fonticon-wrong",events:{click:function(){u.editInput.setValue(u.model.get("title")?o.unescapeHTML(u.model.get("title")):""),u._closeEditMode()}}}).hide(),this._superModal=new i({renderTo:t}),this.actionsElt=e.createElement("div",{tag:"div",class:"bookmark-available-actions",html:{tag:"span",class:"fonticon fonticon-2x fonticon-down-open"}}),this._actionTooltip=new l({target:this.actionsElt,body:c.Menu}),this._cancelTooltip=new l({target:this.cancelElt,body:c.Cancel}),this._actionMenu=new r({target:this.actionsElt,position:"bottom left",items:[{name:"edit",fonticon:"pencil",text:c.EditTitle,handler:function(e){e.stopPropagation(),u._editTitle()}},{name:"remove",fonticon:"bookmark-delete",text:c.Remove,handler:function(){u._deleteBookmark()}}],className:"bookmark-contextual-actions"}),this.container.setContent({tag:"div",class:"bookmark-card",events:{click:function(e){e.target===u.actionsElt.firstChild||e.target===u.actionsElt||e.target===u.cancelElt||u._editMode||u.clickCallback(u.model)}},html:[{tag:"img",class:"bookmark-card-img",src:this.model.getThumbnailUrl().small},{tag:"div",class:"bookmark-card-block",html:[this.titleElt,this.editInput]},this.actionsElt,this.cancelElt]}),this},_deleteBookmark:function(){var e=this;this._superModal.confirm({title:c.RemoveBookmark,message:c.DoYouReallyWantToRemoveThisContentFromYourBookmarks,callback:function(t){!0===t&&(s.remove(e.model),e.container.addClassName("fadeout"),setTimeout(function(){e.destroy()},500))}})},_editTitle:function(){this.titleElt.hide(),this.actionsElt.hide(),this.editInput.show(),this.cancelElt.show(),this._editMode=!0,this.container.addClassName("edit-mode"),this.editInput.focus(),this._listenClickOutsideBound=this._listenClickOutside.bind(this),window.addEventListener("click",this._listenClickOutsideBound)},_closeEditMode:function(){this.titleElt.show(),this.actionsElt.show(),this.editInput.hide(),this.cancelElt.hide(),this._editMode=!1,this.container.removeClassName("edit-mode")},_listenClickOutside:function(e){this.editInput.elements.container.contains(e.target)||""!==this.editInput.getValue()&&(this.editInput.getValue()!==this.model.get("title")&&s.update(this.model,{title:this.editInput.getValue()}),this._closeEditMode(),window.removeEventListener("click",this._listenClickOutsideBound))},destroy:function(){return this._cancelTooltip.destroy(),this._actionTooltip.destroy(),this._actionMenu.destroy(),this._parent.apply(this,arguments)}})}),define("DS/Bookmark/script/View/BookmarkCollectionView",["UWA/Core","UWA/Class/View","DS/Bookmark/script/BookmarkManager","DS/Bookmark/script/View/BookmarkItemView","css!DS/UIKIT/UIKIT","css!DS/Bookmark/Bookmark"],function(e,t,o,n){"use strict";return t.extend({className:"bookmark-collection-view",_collection:null,setup:function(e,t,n){var i=this;return o.get({service_name:e.serviceName?e.serviceName:"",page_size:e.pageSize?e.pageSize:20,page_number:e.pageNumber?e.pageNumber:0},function(e){i._collection=e,i.render(),n(i._collection)}),o.addEvent("onBookmarkAdded",function(e){i._collection.unshift(e),i._collection.setTotalRecords(parseInt(i._collection.getTotalRecords())+1),i.render(),n(i._collection)}),o.addEvent("onBookmarkRemoved",function(e){i._collection.get(e)&&i._collection.remove(e),i._collection.setTotalRecords(parseInt(i._collection.getTotalRecords())-1),i.render(),n(i._collection)}),this.itemClick=t,this._parent.apply(this,arguments),this.render()},render:function(){var e=this;return e._collection&&(e._collection.length>0?(e.container.setContent(),e._collection.map(function(t){e.container.addContent(new n({model:t,clickCallback:e.itemClick}).render())})):e.container.setContent({tag:"div",class:"dsi-noresult",styles:{margin:"10% 0","text-align":"center",width:"100%"},html:[{class:"fonticon fonticon-5x fonticon-bookmark"},{html:"You don't have any bookmark"}]})),this},onInfiniteScroll:function(e){var t=this;o.getNextPage(this._collection,function(o){t._collection=o,t.render(),e&&e(o)})}})});