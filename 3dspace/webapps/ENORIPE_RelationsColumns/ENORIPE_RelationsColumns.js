/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/ENORIPE_RelationsColumns/WSRelations",["DS/WAFData/WAFData","DS/PADServices/utils/GlobalUtils","DS/PADServices/utils/PlatformURL","DS/PADServices/utils/PCSTracker"],function(e,t,n,i){"use strict";function o(){return"object"==typeof o.instance?o.instance:(o.instance=this,this)}return o.prototype.executeRequest=function(t,n,o,s){var a=i.networkprobe({url:t,request_options:n});return e.authenticatedRequest(t,a)},o.prototype.getCount=function(e){return n.retrievePlatformUrl({addDefaults:!0,initWSAcess:!0}),new Promise(function(i,o){var s=n.get3DSpaceURL(),a={onComplete:i,onFailure:o};s=s+"/resources/enorelnav/navigate/getrelationcount?tenant="+n.getPlatformId(),a.method="POST",a.headers={Accept:"application/json","Content-Type":"application/json"},a.data=JSON.stringify({widgetId:"DGV-RelationColumns-"+t.getWidgetId()+"-"+Date.now(),ids:e.ids,relations:e.relations,countmanagement:!0,trueREST:!0}),this.executeRequest(s,a)}.bind(this))},o.prototype.setPreferences=function(e){return new Promise(function(i,o){var s=n.get3DSpaceURL(),a={onComplete:i,onFailure:o};s=s+"/resources/enorelnav/navigate/setpreferences?tenant="+n.getPlatformId(),a.method="POST",a.headers={Accept:"application/json","Content-Type":"application/json"},a.data=JSON.stringify({widgetId:"DGV-RelationColumns-"+t.getWidgetId()+"-"+Date.now(),relations:e.relations,attributes_for_detailview:e.attributes,countmanagement:!0}),this.executeRequest(s,a)}.bind(this))},o.prototype.getDetail=function(e){return new Promise(function(i,o){var s=n.get3DSpaceURL(),a={onComplete:i,onFailure:o};s=s+"/resources/enorelnav/navigate/getecosystem?tenant="+n.getPlatformId(),a.method="POST",a.headers={Accept:"application/json","Content-Type":"application/json"},a.data={widgetId:"DGV-RelationColumns-"+t.getWidgetId()+"-"+Date.now(),debug:!1,countmanagement:!0,ecoSystemWithDetail:!0},a.data=Object.assign(a.data,e),a.data=JSON.stringify(a.data),this.executeRequest(s,a)}.bind(this))},new o}),define("DS/ENORIPE_RelationsColumns/utils/NavWSProxy",["UWA/Core","DS/WAFData/WAFData","DS/PADUtils/PADUtilsServices","DS/PADServices/utils/GlobalUtils","UWA/Promise","DS/ENORIPE_Relations/RelationsTabSettings"],function(e,t,n,i,o,s){var a=function(e,n,i){return new o(function(o,s){n.onComplete=function(e){var t=function(e){return"string"==typeof e?JSON.parse(e):e}(e),n=t;i&&(n=i(t)),o(n)},n.onFailure=function(e){s(e)},n.data&&(n.data=JSON.stringify(n.data)),function(e,n,i){t.authenticatedRequest(e,n)}(e,n)})};return{getrelationprofiles:function(e,t){var i=n.get3DSpaceUrl(),o={};return i=i+"/resources/enorelnav/navigate/getProfiles?tenant="+n.getPlatformId(),o.method="POST",o.headers={Accept:"application/json","Content-Type":"application/json"},o.data={widgetId:n.getWidgetId(),roles:e,profileVersion:2},a(i,o,!1)},getRelationSettings:function(e,t){var i=n.get3DSpaceUrl(),o={};return i=i+"/resources/enorelcc/cc_services/getrelsettings?tenant="+n.getPlatformId(),o.method="GET",o.headers={Accept:"application/json","Content-Type":"application/json"},a(i,o,!1)},setpreferences:function(e){var t=n.get3DSpaceUrl(),i={};t=t+"/resources/enorelnav/navigate/setpreferences?tenant="+n.getPlatformId(),i.method="POST",i.headers={Accept:"application/json","Content-Type":"application/json"};var o=[];return o=(o=(o=o.concat(s.getOption("displayNameAttributes"))).concat(s.getOption("detailAttributesLevel1"))).concat(s.getOption("detailAttributesLevel2")),i.data={widgetId:n.getWidgetId(),relations:e,attributes_for_detailview:o,countmanagement:!0},a(t,i)},getDetail:function(e){var t=n.get3DSpaceUrl(),i={};t=t+"/resources/enorelnav/navigate/getecosystem?tenant="+n.getPlatformId(),i.method="POST",i.headers={Accept:"application/json","Content-Type":"application/json"};var o=n.getWidgetId();return i.data={widgetId:o,ids:e,debug:!1},a(t,i)},getRelationCount:function(e){var t=n.get3DSpaceUrl(),i={};t=t+"/resources/enorelnav/navigate/getrelationcount?tenant="+n.getPlatformId(),i.method="POST",i.headers={Accept:"application/json","Content-Type":"application/json"};var o=n.getWidgetId();return i.data={widgetId:o,ids:e.ids,relations:e.relations},a(t,i)},getMergedProfiles:function(e,t,n){var i=this,s=!1;return new o(function(o,a){t.relation_sets&&t.relation_sets.length||o(e);e.profiles.map(function(e){return e.name});for(var r=0;r<t.relation_sets.length;r++){for(var l=t.relation_sets[r].roles,d=t.relation_sets[r].userGroups,u=!1,c=0;c<l.length;c++)if(n.indexOf(l[c])>-1){u=!0;break}if(d.length>0&&!u){s=!0;break}}s?i._getGrantedUsrGrp().then(function(s){s=i._parseUserGroups(s),e=i._filterRelSets(e,t,s,n),o(e)}):(e=i._filterRelSets(e,t,[],n),o(e))})},getAllProfilesAndSettings:function(e){var t=this,n=this.getrelationprofiles(e),i=this.getRelationSettings();return new o(function(s,a){o.all([n,i]).then(function(n){var i=n[0],o=n[1];t._parseSettings(o).then(function(n){t.getMergedProfiles(i,n,e).then(function(e){s([e,n])})}).catch(()=>{s()})}).catch(()=>{s()})})},getAppId:function(){return n.getAppId()},getUserID:function(){return n.getUserLogin()},_parseSettings:function(e){var t=this;return new o(function(n,i){e.notexist||void 0===e.relation_apps?t._getResetRelApps().then(function(t){n(e=t)}):n(e)})},_getResetRelApps:function(){var e=n.get3DSpaceUrl(),t={};return e=e+"/resources/enorelcc/cc_services/getrelappsinit?tenant="+n.getPlatformId(),t.method="GET",t.headers={Accept:"application/json","Content-Type":"application/json"},a(e,t,!1)},_getGrantedUsrGrp:function(){var e=n.get3DSearchUrl()+"/search",t={},i=n.getUserLogin()||"";return t.method="POST",t.headers={Accept:"application/json","Content-Type":"application/json"},t.data={label:"ENORIPE_"+i+"_"+Date.now(),select_predicate:["ds6w:label"],query:"[ds6w:type]:GROUP AND "+i,tenant:n.getPlatformId(),nresults:100,with_synthesis_attribute:!1,with_synthesis:!1},a(e,t,!1)},_parseUserGroups:function(e){var t=[];if(e&&e.results)for(var n=0;n<e.results.length;n++){var i=e.results[n];if(i.attributes){for(var o={},s=0;s<i.attributes.length;s++)"resourceid"===i.attributes[s].name&&(o.resourceid=i.attributes[s].value),"ds6w:label"===i.attributes[s].name&&(o.label=i.attributes[s].value);void 0!==o.resourceid&&t.push(o)}}return t},_filterRelSets:function(e,t,n,i){for(var o=e.profiles.map(function(e){return e.name}),s=(n=n.map(function(e){return e.resourceid}),0);s<t.relation_sets.length;s++){var a=t.relation_sets[s].roles,r=t.relation_sets[s].userGroups,l=!1;a&&a.length>0&&(a=a.map(function(e){return e.name})),r&&r.length>0&&(r=r.map(function(e){return e.name}));for(var d=0;d<a.length;d++)if(i.indexOf(a[d])>-1){l=!0;break}if(!l)for(d=0;d<r.length;d++)if(n.indexOf(r[d])>-1){l=!0;break}var u=o.indexOf(t.relation_sets[s].name);l?-1===u?e.profiles.push(t.relation_sets[s]):e.profiles.splice(u,1,t.relation_sets[s]):-1!==u&&e.profiles.splice(u,1)}return e}}}),define("DS/ENORIPE_RelationsColumns/utils/RelationProfiles",["DS/ENORIPE_RelationsColumns/utils/NavWSProxy","DS/CoreEvents/ModelEvents","DS/PlatformAPI/PlatformAPI","i18n!DS/ENORIPE_Relations/assets/nls/Relations"],function(e,t,n,o){return{fetchandStoreProfiles:function(t,n){var i=this;e.getAllProfilesAndSettings(t).then(function(e){if(Array.isArray(e)&&2===e.length){var o=e[0];i._settings=e[1];var s=i._getRelationsSet();if(s)for(var a=0;a<s.length;a++)o.profiles.splice(a+1,0,s[a]);o=i._filterRelSets(o,t),i.storeProfiles(o.profiles)}"function"==typeof n&&n()})},_filterRelSets:function(t,n){for(var i=t.profiles.map(function(e){return e.name}),o=e.getAppId(),s=0;s<this._settings.relation_sets.length;s++){var a=this._settings.relation_sets[s].roles,r=this._settings.relation_sets[s].userGroups,l=this._settings.relation_sets[s].applications||[],d=!1;a&&a.length>0&&(a=a.map(function(e){return e.name})),r&&r.length>0&&(r=r.map(function(e){return e.name}));for(var u=0;u<a.length;u++)if(n.indexOf(a[u])>-1){d=!0;break}var c=i.indexOf(this._settings.relation_sets[s].name);if(d){if(-1===c?t.profiles.push(this._settings.relation_sets[s]):t.profiles.splice(c,1,this._settings.relation_sets[s]),l.length>0&&(l=l.map(function(e){return e.name})).indexOf(o)<0){c=i.indexOf(this._settings.relation_sets[s].name);t.profiles.splice(c,1)}}else-1!==c&&t.profiles.splice(c,1)}return t},storeProfiles:function(t){var n="In_App_Product_Relations",o={name:"AutoModeProfile"},s=e.getAppId();if(o.relations=[],t.unshift(o),this._settings&&this._settings.relation_apps&&this._settings.relation_apps[s]&&(n=this._settings.relation_apps[s]),this._profiles=t,this._profileNames=this._profiles.map(function(e){return e.name}),this._profileNames.length>0){var a=!1;for(i=0;i<this._profileNames.length;i++)if(this._profileNames[i]===n){this.setCurrentProfile(this._profileNames[i]),a=!0;break}!1===a&&this.setCurrentProfile(this._profileNames[0])}},getProfileNames:function(){return this._profileNames},getNlsForProfileNames:function(e){for(var t=[],n=0;this._profileNames&&n<this._profileNames.length;n++){var i=this._profileNames[n],s=o[i]||i;t.push({name:i,nls:s})}return t},getNlsForMenu:function(){return o["Manage-Relations"]},setCurrentProfile:function(e){this._currentProfile===e&&void 0!==this._currentProfile||(this._currentProfile=e,this.publish("CurrentProfileChanged"))},getCurrentProfile:function(){return this._currentProfile},getCurrentProfileNls:function(){return o[this._currentProfile]||this._currentProfile},getCurrentProfileRelations:function(){relations=[];for(var e=this._getCurrentProfileData(),t=0;e&&t<e.relations.length;t++){var n=e.relations[t];relations.push(n.name)}return relations},getRelationsInSettings:function(e){var t=[];if(this._settings&&this._settings.relation_apps[e])for(var n=0;this._profiles&&n<this._profiles.length;n++){let s=this._profiles[n];if(s.name===this._settings.relation_apps[e])for(var i=0;s&&i<s.relations.length;i++){var o=s.relations[i];t.push(o.name)}}return t},publish:function(e){this._ensureModelEvents(),this._modelEvents.publish({event:e})},subscribe:function(e,t){return this._ensureModelEvents(),this._modelEvents.subscribe({event:e},t)},_getCurrentProfileData:function(){for(var e=0;this._profiles&&e<this._profiles.length;e++){var t=this._profiles[e];if(t.name===this._currentProfile)return t}return null},_ensureModelEvents:function(){this._modelEvents||(this._modelEvents=new t)},_getRelationsSet:function(){var e=localStorage.getItem(this.getUserID()+"_ENORIPE_CustomRelationsSet");if(e)return JSON.parse(e)},getUserID:function(){return e.getUserID()||""},_fetchLastStoredProfile:function(){var t,n="LastUsedProfile-"+e.getAppId();return"undefined"!=typeof widget&&null!==widget&&(t=widget.getValue(n)),t||(t=localStorage.getItem(n)),t}}}),define("DS/ENORIPE_RelationsColumns/RelationsColumns",["UWA/Core","text!DS/ENORIPE_RelationsColumns/assets/ColumnsDefinition.json","i18n!DS/ENORIPE_RelationsColumns/assets/nls/ENORIPE_Columns","DS/SNNavigationMap/utils/NlsManager","DS/ENORIPE_RelationsColumns/WSRelations","DS/PADUtils/PADContext","DS/PADUtils/PADUtilsServices","DS/ENORIPE_RelationsColumns/utils/RelationProfiles","DS/ENORIPE_Relations/RelationsTabSettings","DS/PADServices/utils/AttributesMgtV2","DS/PADServices/utils/DictionaryAccess","DS/CoreEvents/ModelEvents","DS/PADServices/utils/GlobalUtils"],function(e,t,n,i,o,s,a,r,l,d,u,c,p){"use strict";var g=new c;function f(){if("object"==typeof f.instance)return f.instance;f.instance=this,this.relationColumnsDef=JSON.parse(t),this.alwaysUpdate=!1,this.dataIndexes=[],this._afterRefresh=!1,e.merge(n,i.getNls()),g.subscribe({event:"ENXRelationsCol/AddGroupingNodes"},this._addGroupingNodes.bind(this)),g.subscribe({event:"ENXRelationsCol/ShowGroupingNodes"},this._showGroupingNodes.bind(this)),g.subscribe({event:"ENXRelationsCol/HideGroupingNodes"},this._hideGroupingNodes.bind(this)),r.subscribe("CurrentProfileChanged",function(e){})}function h(e,t,n,i){var o=new e.options.nodeModelClass(n);o.isRelationsObjectNode=!0;var s,a=t.getRoot().getID(),r=t.getState(),l=t.getChildren();return l&&l.length?!0===l[0].isRelationsObjectGroupingNode?(l[0].addChild(o),s=l[0]):((s=m({treeDoc:e,parentId:t.getID()})).addChild(o),t.insertBefore(s,l[0])):((s=m({treeDoc:e,parentId:t.getID()})).addChild(o),t.addChild(s)),!0===f.groupingNodeHidden&&s.hide(),g.publish({event:"ENXRelationsCol/AddGroupingNodes",data:{groupingNode:s,rootId:a}}),!0===i&&s.setState({state:"expanded"}),"noChildren"===r?t.setState({state:"expanded"}):"collapsed"===r&&t.childComputed&&t.getReferenceValue("ds6w:kind")&&-1!==t.getReferenceValue("ds6w:kind").indexOf("3DPart")?t.setState({state:"expanded"}):"collapsed"===r&&!1===t.childComputed?t.setState({state:"expanded"}):t.setState({state:r}),o}function m(e){var t={resourceid:"fakeNode-"+e.parentId,label:n.fakeGroupingNode.label,childComputed:!0,icons:[{iconName:"object-related",fontIconFamily:1}],thumbnail:{iconName:"object-related",fontIconFamily:1},grid:{},children:[]},i=new e.treeDoc.options.nodeModelClass(t);return i.isRelationsObjectNode=!0,i.isRelationsObjectGroupingNode=!0,i.childComputed=!0,i}return f.prototype.setupCallback=function(e){e.treeDocModelEvents&&e.treeDocModelEvents.subscribe({event:"preRemoveChild"},this._cleanupGroupingNodes.bind(this)),e.globalModelEvents&&e.globalModelEvents.subscribe({event:"ENXModel/UpdateAdditionalColumns"},this._forceUpdateAttributes.bind(this))},f.groupingNodeHidden=!localStorage.getItem("enx-relation-groupingNode-hide_"+p.getAppId())||"true"===localStorage.getItem("enx-relation-groupingNode-hide_"+p.getAppId()),f.prototype.isAdditionalColumnsAvailable=function(e){if("function"!=typeof e)throw new Error("A callback function should be defined");var t={getPlatformID:function(){return a.getPlatformId()},getServiceID:function(){return"3DSpace"}};l.isAvailable(t,{isDraggable:!0}).then(function(t){"object"==typeof t?a.app_initialization(function(){r.fetchandStoreProfiles(t.roles,function(){e(!0)})}):e(!1)},function(){e(!1)})},f.prototype.getName=function(){return"RelationsColumns"},f.prototype.getManagedColumnNames=function(){return this.dataIndexes=this.columnsPreference.availableDataIndexes,this.dataIndexes},f.prototype.setPreferenceProxy=function(){e.merge(n,i.getNls());var t=r.getRelationsInSettings(p.getAppId());t&&t.length>this.relationColumnsDef.patternsLimit&&(t=t.slice(0,this.relationColumnsDef.patternsLimit)),this.alwaysUpdate=!f.groupingNodeHidden,f.prototype.relationsColumnsList=t,this._buildDefaultConfiguration(this.relationsColumnsList)},f.prototype.setupDGVManipulation=function(e){f.prototype.addColumns=e.onAddColumn,f.prototype.removeColumns=e.onRemoveColumn},f.prototype.toBeUpdated=function(e,t){if("SyncModelRefresh"===t&&(this._afterRefresh=!0),"SyncModelRefresh"===t||"SyncModelNodes"===t||"OnSyncModel"===t)return!0;for(var n=!1,i=Object.keys(e),o=0;o<i.length&&!1===n;o++)""!==e[i[o]]&&void 0!==e[i[o]]||(n=!0);return n},f.prototype._forceUpdateAttributes=function(e){this.updateAttributes(e.nodesToUpdate,e.callback,e.treedocument)},f.prototype.updateAttributes=function(e,t,n){var i={pids:{},relids:{}},s=this,a=[];e.pids.forEach(function(e){n.getNodesById(e).forEach(function(t){if(s._afterRefresh&&(t.alreadyGetCount=!1,t.alreadyGetFakeNode=!1),!t.alreadyGetCount&&(t.alreadyGetCount=!0,a.indexOf(e)<0)){a.push(e),i.pids[e]||(i.pids[e]={});for(var n=0;n<s.dataIndexes.length;n++)i.pids[e][s.dataIndexes[n]]=void 0}})}),s._afterRefresh=!1;var r=[];if(a.length>0){var l=new Promise(function(e){o.getCount({ids:a,relations:s.dataIndexes}).then(function(e){a.forEach(function(e){for(var t=0;t<s.dataIndexes.length;t++)i.pids[e][s.dataIndexes[t]]=0});for(var t=(e="string"==typeof e?JSON.parse(e):e).New.Counts,n=0;n<t.length;n++)i.pids[t[n].source][t[n].name]=parseInt(t[n].count)}).finally(e)});r.push(l)}r.push(new Promise(function(t){l?l.then(function(){s._autoAddInView({pids:e.pids,updatedAttributes:i,treedocument:n}).then(t)}):s._autoAddInView({pids:e.pids,updatedAttributes:i,treedocument:n}).then(t)})),Promise.all(r).then(function(){"function"==typeof t&&t(i)})},f.prototype.getAdditionalColumnsUXDGV=function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i].dataIndex);0===this.dataIndexes.length&&this.getManagedColumnNames();for(var o=0;o<this.dataIndexes.length;o++){var s=this.dataIndexes[o],a=this._buildDGVColumn(this.dataIndexes[o]),r=t.indexOf(s);-1===r?(a.text=n.get(this.dataIndexes[o]),e.push(a)):(e[r]=UWA.extend(e[r],a,!0),e[r].text=n.get(this.dataIndexes[o]))}},f.prototype.provideDisplayTooltip=function(e){var t=null;return e.nodeModel&&-1!==this.dataIndexes.indexOf(e.dataIndex)&&(t=e.nodeModel.options.grid[e.dataIndex]),t},f.prototype.getTypeRepresentations=function(){return{relColNone:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"",fontIconFamily:WUXManagedFontIcons.Font3DS}}},relColLoading:{stdTemplate:"functionIcon",semantics:{className:"relationRefresh",icon:{iconName:"reload wux-ui-3ds-spin",fontIconFamily:WUXManagedFontIcons.Font3DS}}},relCheck:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"check",fontIconFamily:WUXManagedFontIcons.Font3DS}}}}},f.prototype.getOnCellClickCB=function(e){if(console.log(e),-1!==this.dataIndexes.indexOf(e))return function(t){t.nodeModel&&(t.nodeModel.options.grid[e]>0&&require(["DS/ApplicationFrame/CommandsManager"],function(t){var i=t.getCommandCheckHeader("RightSidePanel");i&&(!1===i.getState()&&i.setState(!0,!1),i._propertiesWdg.selectFacet("relations"),l.expandRelations([n.get(e)]))}))}},f.prototype.getAdditionalCtxMenu=function(e){var t,i=!1;"datagridview"===e.view&&(i=-1===e.ctxParams.cellInfos.rowID,t=e.ctxParams.collectionView.getColumnOrGroup(e.ctxParams.cellInfos.columnID).dataIndex);var o=[];"tree"===t&&!0===i?(f.groupingNodeHidden?o.push({type:"PushItem",fonticon:{family:"DSFontIcon",content:"wux-ui-3ds wux-ui-3ds-eye"},title:n.ctxCommands.showRelated,action:{callback:function(){g.publish({event:"ENXRelationsCol/ShowGroupingNodes",data:{treeDoc:e.treeDocument}}),f.groupingNodeHidden=!1,e.ctxParams.collectionView.requestDelayedModelData("OnSyncModel"),localStorage.setItem("enx-relation-groupingNode-hide_"+p.getAppId(),"false")}}}):o.push({type:"PushItem",fonticon:{family:"DSFontIcon",content:"wux-ui-3ds wux-ui-3ds-eye-off"},title:n.ctxCommands.hideRelated,action:{callback:function(t){g.publish({event:"ENXRelationsCol/HideGroupingNodes",data:{treeDoc:e.treeDocument}}),f.groupingNodeHidden=!0,localStorage.setItem("enx-relation-groupingNode-hide_"+p.getAppId(),"true")}}}),e.callback(this.getName(),o)):e.callback(null)},f.prototype._buildDGVColumn=function(e){var t={dataIndex:e,alignment:"center",editableFlag:!1,sortableFlag:!1,width:50,minWidth:50,visibleFlag:!1,isAdditionalColumn:!0,getCellTypeRepresentation:function(t){if(t.nodeModel){var n=t.nodeModel.options.grid[e];return!0===t.nodeModel.isRelationsObjectNode?"relColNone":void 0!==n&&""!==n?n>0?"relCheck":"relColNone":"relColLoading"}},getCellSemantics:function(t){if(t.nodeModel){var n=t.nodeModel.options.grid[e];if(void 0===n||""===n||0===n)return{disabled:!0}}},customisation:{dataIndex:e,exportable:{lock:!1,value:!1},layout:{removable:!1}}};return t=UWA.extend(t,{}),UWA.clone(t)},f.prototype._autoAddInView=function(e){var t=this;return new Promise(function(n){if(f.groupingNodeHidden)n();else{var i,s=[],a=[],r=t.columnsPreference.availableDataIndexes,l=e.treedocument,c=d.createOutputsRequest("fetch");for(i=0;i<e.pids.length;i++){l.getNodesById(e.pids[i]).forEach(function(t){if(!0!==t.isRelationsObjectNode&&!t.alreadyGetFakeNode){var n=t.options.icons;n[0].badges||(n[0].badges={}),n[0].badges.topRight={iconName:"reload wux-ui-3ds-spin",fontIconSize:"1x",className:"dgv-badge-top"},t.updateOptions({icons:n}),t.alreadyGetFakeNode=!0,s.push(e.pids[i])}})}s.length>0?o.getDetail({ids:s,relations:r,attributes_for_detailview:c.select_predicate?c.select_predicate:c.select_object}).then(function(e){e="string"==typeof e?JSON.parse(e):e,l.withTransactionUpdate(function(){for(i=0;i<r.length;i++){var o=r[i],d=e.newstructure[o];if(d)for(var c=0;c<d.length;c++){var p=d[c],g=p.relation.substring(0,p.relation.indexOf("_"));-1===a.indexOf(g)&&a.push(g);for(var f=l.getNodesById(g),m=0;m<f.length;m++){var v=f[m];if(!0!==v.isRelationsObjectNode){v.getNodesById(p.id);var _=t._buildNode(p),b=h(l,v,_);u.updateNLS(b);var C=UWA.clone(v.options.icons);C[0].badges&&(C[0].badges.topRight=null),v.updateOptions({icons:C})}}}}for(i=0;i<s.length;i++){if(-1===a.indexOf(s[i]))(f=l.getNodesById(s[i])).forEach(function(e){var t=UWA.clone(e.options.icons);t[0].badges&&(t[0].badges.topRight=null),e.updateOptions({icons:t})})}n()})}).catch(function(e){console.warn("Retrieve the pattern fails:"+JSON.stringify(e)),n()}):n()}})},f.prototype._buildDefaultConfiguration=function(e){this.columnsPreference={},this.columnsPreference.availableDataIndexes=e,this.dataIndexes=[]},f.prototype._buildNode=function(e){for(var t=d.createOutputsRequest("fetch"),n={resourceid:e.id,relationid:e.relation,label:e["ds6w:label"],icons:[{iconPath:"url("+e.icon_url+")",className:"dgv-icons"}],type:e["ds6w:type"],thumbnail:e.thumbnail,relationOrder:-2,grid:{thumbnail:e.thumbnail},children:null},i=t.select_predicate?t.select_predicate:t.select_object,o=0;o<i.length;o++)"ds6w:label"!==i[o]&&(n.grid[i[o]]=e[i[o]]);return n},f.prototype.hasHiddenGroupingNodes=function(){return this._hiddenGroupingNodes&&this._hiddenGroupingNodes.length},f.prototype._addGroupingNodes=function(e){var t=e.groupingNode,n=e.rootId;t&&n&&(this._groupingNodes||(this._groupingNodes={}),this._groupingNodes[n]||(this._groupingNodes[n]=[]),this._groupingNodes[n].push(t))},f.prototype._showGroupingNodes=function(e){if(this._groupingNodes){var t=this;e.treeDoc.withTransactionUpdate(function(){for(var e=Object.keys(t._groupingNodes),n=0;n<e.length;n++)for(var i=t._groupingNodes[e[n]],o=0;o<i.length;o++){i[o].show();i[o]._parentNode}})}f.groupingNodeHidden=!1,this.alwaysUpdate=!0},f.prototype._hideGroupingNodes=function(e){if(this._groupingNodes){var t=this;e.treeDoc.withTransactionUpdate(function(){for(var e=Object.keys(t._groupingNodes),n=0;n<e.length;n++)for(var i=t._groupingNodes[e[n]],o=0;o<i.length;o++){i[o].hide();var s=i[o]._parentNode;s&&s.getChildren()&&1===s.getChildren().length&&s.setState({state:"collapsed"})}})}f.groupingNodeHidden=!0,this.alwaysUpdate=!1},f.prototype._cleanupGroupingNodes=function(e){if(this._groupingNodes){var t=null,n=e.data.nodeModel;n&&n.isRoot()?(t=n,this._groupingNodes[n.getID()]&&delete this._groupingNodes[n.getID()]):(t=n.getRoot())&&this._groupingNodes[t.getID()]&&(this._groupingNodes[t.getID()]=this._groupingNodes[t.getID()].filter(function(e){return-1!==e.getOccurencePath().indexOf(n.getID())})),this._afterRefresh=!0}},new f}),define("DS/ENORIPE_RelationsColumns/RelationsColumnsCmd",["DS/ENORIPE_RelationsColumns/RelationsColumns","DS/ApplicationFrame/Command","css!DS/ENORIPE_RelationsColumns/ENORIPE_Columns","i18n!DS/ENORIPE_RelationsColumns/assets/nls/ENORIPE_Columns","DS/Controls/Button","DS/Controls/Accordeon","DS/Controls/Toggle","DS/PADUtils/PADContext"],function(e,t,n,i,o,s,a,r){"use strict";return t.extend({init:function(e){this._parent(e)},execute:function(){},_buildContent:function(){return new Promise(function(t){this.elements.container=document.createElement("div"),this.elements.container.classList.add("enx-relmgt-container");var n=e.relationColumnsDef;this.columnsPreference.addAutoPatterns||(this.columnsPreference.addAutoPatterns=[]);var o=e.relationsColumnsList,r=this,l=function(t){var n=document.createElement("div");n.classList.add("enx-relmgt-expander"),n.classList.add(t);var o=-1!==e.dataIndexes.indexOf(t),s=new a({type:"switch",label:i.relationsColumnsMgt.columnAvailable,value:t,checkFlag:o,touchMode:!0});n.appendChild(s.getContent()),s.addEventListener("change",r._colAvailablityMgt.bind(r));var l=-1!==r.columnsPreference.addAutoPatterns.indexOf(t),d=new a({type:"switch",label:i.relationsColumnsMgt.autoAdd,value:t,checkFlag:l,touchMode:!0});n.appendChild(d.getContent());var u=document.createElement("div");return u.classList.add("enx-relmgt-autoAddInfo"),u.classList.add(t),u.innerText=i.relationsColumnsMgt.autoAddInfo,!0===l?u.removeAttribute("hidden"):u.setAttribute("hidden",""),n.appendChild(u),d.addEventListener("change",r._autoAddMgt.bind(r)),n};if(1===o.length){this.elements.container.classList.add("enx-relmgt-single-pattern");var d=n.patterns[o[0]],u=require(d.nlsPatternAMD),c=document.createElement("div");c.classList.add("enx-relmgt-title-pattern"),c.innerText=u[o[0]],this.elements.container.appendChild(c);var p=l(o[0]);this.elements.container.appendChild(p)}else if(o.length>1){var g=this.elements.accordion=new s({style:"filled-separate",exclusive:!1});this.elements.container.appendChild(g.getContent());for(var f=0;f<o.length;f++){p=l(o[f]),d=n.patterns[o[f]],u=require(d.nlsPatternAMD);g.addItem({header:u[o[f]],body:p,expandedFlag:!0})}}t()}.bind(this))},_buildFooter:function(){var t=this,n=UWA.createElement("div",{class:"footerModal"}),s=new o({label:i.relationsColumnsMgt.save,emphasize:"primary",touchMode:!0});s.addEventListener("click",function(){e.updateConfiguration(t.changes),t.elements.floatingpanel.destroy()}),s.inject(n);var a=new o({label:i.relationsColumnsMgt.reset,emphasize:"secondary",touchMode:!0});a.addEventListener("click",function(){e.resetConfiguration(),t.elements.floatingpanel.destroy()}),a.inject(n);var r=new o({label:i.relationsColumnsMgt.cancel,emphasize:"secondary",touchMode:!0});return r.addEventListener("click",function(){t.elements.floatingpanel.destroy()}),r.inject(n),n},_colAvailablityMgt:function(e){this.changes[e.dsModel.value]||(this.changes[e.dsModel.value]={}),this.changes[e.dsModel.value].dgvColumnAvailable=e.dsModel.checkFlag},_autoAddMgt:function(e){this.changes[e.dsModel.value]||(this.changes[e.dsModel.value]={}),this.changes[e.dsModel.value].autoAdd=e.dsModel.checkFlag;var t=this.elements.container.getElementsByClassName("enx-relmgt-autoAddInfo "+e.dsModel.value);1===t.length&&(!0===e.dsModel.checkFlag?(this.elements.container.classList.add("withAutoAddInfo"),t[0].removeAttribute("hidden")):(this.elements.container.classList.remove("withAutoAddInfo"),t[0].setAttribute("hidden","")),this.elements.floatingpanel.onResize())},_checkIfTreeview:function(){switch(r.get().getCurrentView()){case"datagridview":this.enable();break;default:this.disable()}}})});