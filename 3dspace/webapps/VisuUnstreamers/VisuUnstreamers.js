define("DS/VisuUnstreamers/CGRUnstreamTask",["UWA/Class","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/VisuLoaders/CGRReader"],function(e,a,t,r){"use strict";var i=null,s=0,n=[],l=[],o=e.extend({init:function(e,a){return this.streamObject=e,this.targetNode=a,this.contextID=s++,n[this.contextID]={so:this.streamObject,target:this.targetNode},this},run:function(e,a,t,s){n[this.contextID].cbProgress=e,n[this.contextID].cbError=t,n[this.contextID].cbDone=a,n[this.contextID].options=s,n[this.contextID].modelLoaded=!1;if(this.targetNode){l[this.contextID]={launched:!1},null===i&&(i=new r),i&&this.internalLoad()}else console.error("CGRUnstreamTask execution failed : target node undefined !")},internalLoad:function(){for(var e in l)!1===l[e].launched&&(l[e].launched=!0,this.loadCGR(e))},loadCGR:function(e){var a=n[e].so,t=n[e].options;t.isBuffer=!0;var r={readyCallback:n[this.contextID].cbProgress,errorCallback:n[this.contextID].cbError,doneCallback:n[this.contextID].cbDone};a.open(),a.readAsArrayBuffer(function(e){i.load(e,r,t)})}});return UWA.namespace("THREEDS/CGRUnstreamTask",o)}),define("VisuUnstreamers/CGRUnstreamTask",["DS/VisuUnstreamers/CGRUnstreamTask","DS/DSMigration/DSMigration"],function(e,a){return a.deprecateModule("VisuUnstreamers/CGRUnstreamTask"),e}),define("DS/VisuUnstreamers/UnstreamTaskDriver",["UWA/Class"],function(e){"use strict";var a=e.singleton({init:function(){return this},getTask:function(e,a,t,r){require(["DS/VisuUnstreamers/"+e+"UnstreamTask"],function(e){var i=new e(a,t);r&&r(i)})}});return UWA.namespace("THREEDS/UnstreamTaskDriver",a)}),define("VisuUnstreamers/UnstreamTaskDriver",["DS/VisuUnstreamers/UnstreamTaskDriver","DS/DSMigration/DSMigration"],function(e,a){return a.deprecateModule("VisuUnstreamers/UnstreamTaskDriver"),e}),define("DS/VisuUnstreamers/StreamObject",["UWA/Class"],function(e){"use strict";var a=e.extend({init:function(e,a){return this.blob=e,this.filename=a,this.blob&&!this.blob.userData&&(this.blob.userData={}),this},open:function(){},close:function(){},getUserData:function(){return this.blob?this.blob.userData:null},readAsArrayBuffer:function(){},readAsBlob:function(){},readAsText:function(){},readAsXML:function(){}});return UWA.namespace("THREEDS/StreamObject",a)}),define("VisuUnstreamers/StreamObject",["DS/VisuUnstreamers/StreamObject","DS/DSMigration/DSMigration"],function(e,a){return a.deprecateModule("VisuUnstreamers/StreamObject"),e}),define("DS/VisuUnstreamers/FileInZipStreamObject",["DS/VisuUnstreamers/StreamObject","WebappsUtils/WebappsUtils","DS/ZipJS2/ZipJS2"],function(e,a,t){"use strict";var r=0,i=[],s=e.extend({init:function(e,a){return this._parent(e,a),this},open:function(){},close:function(){},read:function(e,a){var r=this,i=function(){r.blob.waitingEntries||(r.blob.waitingEntries=[]),r.blob.waitingEntries.push({cb:e,type:a,context:r})};if(void 0===this.blob.zipEntries){this.blob.zipEntries="Loading",i();var s=new t.fs.FS;s.importBlob(this.blob).then(()=>{r.blob.zipEntries=s;for(var e=0;e<r.blob.waitingEntries.length;e++){var a=r.blob.waitingEntries[e];a.context.read(a.cb,a.type)}})}else if("Loading"===this.blob.zipEntries)i();else{var n=this.blob.zipEntries.find(this.filename);n?this._unzipData(n,a,e):(console.warn({msg:"Missing "+this.filename+" in the zip.",zip:this.blob.zipEntries}),e&&e(null))}},readAsArrayBuffer:function(e){this.read(e,"arraybuffer")},readAsBlob:function(e){this.read(e,"blob")},readAsText:function(e){this.read(e,"text")},readAsXML:function(e){this.read(e,"xml")},_unzipData:function(e,a,t){if(r<2){r++;const i=e=>{this._popUnzipItem(),t&&t(e)},s=e=>{this._popUnzipItem(),t&&t((new DOMParser).parseFromString(e,"text/xml"))};"text"===a?e.getText().then(i):"xml"===a?e.getText().then(s):"blob"===a?e.getBlob("text/plain").then(i):"arraybuffer"===a?e.getUint8Array().then(i):console.error("Unknown type to read : "+a)}else i.push({entry:e,type:a,onsuccess:t})},_popUnzipItem:function(){if(r--,i.length>0){var e=i[0];this._unzipData(e.entry,e.type,e.onsuccess),i.splice(0,1)}}});return UWA.namespace("THREEDS/FileInZipStreamObject",s)}),define("VisuUnstreamers/FileInZipStreamObject",["DS/VisuUnstreamers/FileInZipStreamObject","DS/DSMigration/DSMigration"],function(e,a){return a.deprecateModule("VisuUnstreamers/FileInZipStreamObject"),e}),define("DS/VisuUnstreamers/BufferStreamObject",["UWA/Class","DS/VisuUnstreamers/StreamObject"],function(e,a){"use strict";var t=a.extend({init:function(e,a){return this._parent(e,a),this},open:function(){},close:function(){},readAsArrayBuffer:function(e){var a,t=new FileReader;t.onload=function(){a=this.result,e&&e(a)},t.readAsArrayBuffer(this.blob)}});return UWA.namespace("THREEDS/BufferStreamObject",t)}),define("VisuUnstreamers/BufferStreamObject",["DS/VisuUnstreamers/BufferStreamObject","DS/DSMigration/DSMigration"],function(e,a){return a.deprecateModule("VisuUnstreamers/BufferStreamObject"),e}),define("DS/VisuUnstreamers/XMLMeshUnstreamTask",["UWA/Class","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/VisuUnstreamers/UnstreamTaskDriver","DS/VisuUnstreamers/FileInZipStreamObject","DS/Mesh/MeshUtils","DS/Visualization/MaterialManager","DS/Visualization/Mesh3D"],function(e,a,t,r,i,s,n){"use strict";var l=null,o=!1,c=0,u=[],m=[],f=!1,d=e.extend({init:function(e,a){return this.streamObject=e,this.targetNode=a,this.contextID=c++,u[this.contextID]={so:this.streamObject,target:this.targetNode},this},run:function(e,c,d){u[this.contextID].cbSuccess=c,u[this.contextID].cbError=d,u[this.contextID].cbProgress=e,u[this.contextID].nbMaterials=0,u[this.contextID].remainingMaterials=0,u[this.contextID].modelLoaded=!1,console.log("running XMLMeshUnstreamTask");var p=this;if(this.targetNode){if(m[this.contextID]={launched:!1},null!==l||f)o&&this.internalLoad();else{f=!0;var h=t.matchUrl(a.getWebappsBaseUrl(),window.location)?null:"Passport",b=[{provider:"FILE",filename:"AmdLoader.js",serverurl:a.getWebappsBaseUrl()+"AmdLoader/",requiredAuth:h},{provider:"FILE",filename:"EasySax.js",serverurl:a.getWebappsBaseUrl()+"EasySax/",requiredAuth:h},{provider:"FILE",filename:"ThreeJS_Base.js",serverurl:a.getWebappsBaseUrl()+"Mesh/",requiredAuth:h},{provider:"FILE",filename:"Mesh.js",serverurl:a.getWebappsBaseUrl()+"Mesh/",requiredAuth:h},{provider:"FILE",filename:"XMLV43Worker.js",serverurl:a.getWebappsBaseUrl()+"Workers/",requiredAuth:h}];r.getWorkerFromSpecs(b,function(e){(l=e).onmessage=function(e){var a=e.data;if(a.loaded)o||(o=!0,p.internalLoad());else{var t=a.contextID,r=null;if(a.rep.length>0){for(var l=[],c=0;c<a.rep.length;c++)for(var f=a.rep[c],d=0;d<f.drawingGroups.length;d++){var h=f.drawingGroups[d].material;null!==h&&""!==h.file&&l.push({dg:f.drawingGroups[d],name:h.file})}u[t].nbMaterials=l.length,u[t].remainingMaterials=l.length;for(c=0;c<l.length;c++){var b=l[c],g=new s(u[t].so.blob,b.name);i.getTask("XMLMaterial",g,null,function(e){return function(a){a.materialRefId=e.material.id,a.run(null,function(a){e.material=a;var i=u[t];i.remainingMaterials--,i.cbProgress&&i.cbProgress({material:a,loaded:i.nbMaterials-i.remainingMaterials,total:i.nbMaterials}),!i.remainingMaterials&&i.modelLoaded&&i.cbSuccess&&i.cbSuccess(r,!0)})}}(b.dg))}r=n.convertTo3js(a.rep)}else r=n.createEmptyMesh();u[t].target.add(r),u[t].so.close(),u[t].cbSuccess&&(u[t].modelLoaded=!0),delete m[t],p.internalLoad()}}})}}else console.error("XMLMeshUnstreamTask execution failed : target node undefined !")},internalLoad:function(){for(var e in m)!1===m[e].launched&&(m[e].launched=!0,this.workerLoaded(e))},workerLoaded:function(e){var a=u[e].so;a.open(),a.readAsText(function(a){l.postMessage({path:a,contextID:e})})}});return UWA.namespace("THREEDS/XMLMeshUnstreamTask",d)}),define("VisuUnstreamers/XMLMeshUnstreamTask",["DS/VisuUnstreamers/XMLMeshUnstreamTask","DS/DSMigration/DSMigration"],function(e,a){return a.deprecateModule("VisuUnstreamers/XMLMeshUnstreamTask"),e}),define("DS/VisuUnstreamers/XMLMaterialUnstreamTask",["UWA/Class","WebappsUtils/WebappsUtils","DS/VisuUnstreamers/FileInZipStreamObject","DS/Mesh/MeshUtils","DS/Visualization/MaterialManager"],function(e,a,t,r,i){"use strict";var s=0,n=e.extend({init:function(e,a){this.id=s++,this.streamObject=e,this.materialLibrary=a,this.materialRefId=-1;var t=this.streamObject?this.streamObject.getUserData():null;return t&&!t.materialLibraryFiles&&(t.materialLibraryFiles={},t.graphicMaterialFiles={},t.imageLibraryFiles={},t.imageFiles={}),this},run:function(e,a,t){if(-1!==this.materialRefId){0;var r=this,i=this.streamObject.getUserData(),s=i.materialLibraryFiles[this.streamObject.filename];s?"pending"===s.state?s.tasks.push({task:this,cb:this.loadGraphicMaterial,args:[e,a]}):this.loadGraphicMaterial(e,a):(i.materialLibraryFiles[this.streamObject.filename]={state:"pending",tasks:[]},this.streamObject.open(),this.streamObject.readAsXML(function(t){r.streamObject.close();var s=i.materialLibraryFiles[r.streamObject.filename];i.materialLibraryFiles[r.streamObject.filename]=r.parseMaterialReference(t);for(var n=0;n<s.tasks.length;n++){var l=s.tasks[n];0,l.cb.apply(l.task,l.args)}r.loadGraphicMaterial(e,a)}))}},parseMaterialReference:function(e){var a={},t=e.firstChild;if("Model_3dxml"===t.nodeName){for(var r=0;r<t.childNodes.length;r++){var i=t.childNodes[r];if("CATMaterialRef"==i.nodeName)for(var s=0;s<i.childNodes.length;s++){var n=i.childNodes[s];if("CATMatReference"===n.nodeName||"MaterialDomainInstance"===n.nodeName||"MaterialDomain"===n.nodeName){var l=n.getAttribute("id"),o=n.getAttribute("name");switch(n.nodeName){case"CATMatReference":void 0!==a[l]?a[l].name=o:a[l]={name:o};break;case"MaterialDomainInstance":for(var c=0,u=0,m=0;m<n.childNodes.length;m++){var f=n.childNodes[m];"IsAggregatedBy"==f.nodeName?c=f.textContent:"IsInstanceOf"==f.nodeName&&(u=f.textContent)}a[l]={parent:c,instance:u},void 0!==a[c]?a[c].instance=l:a[c]={instance:l};break;case"MaterialDomain":var d,p=n.getAttribute("associatedFile");d=p.split("urn:3DXML:"),p=d[1],void 0!==a[l]?a[l].filename=p:a[l]={filename:p}}}}}return a}},loadGraphicMaterial:function(e,a){var r=this,i=this.streamObject.getUserData(),s=i.materialLibraryFiles[this.streamObject.filename],n=s[this.materialRefId];if(void 0===n)return null;var l=s[n.instance];if(void 0===l)return null;var o=s[l.instance];if(void 0===o)return null;if(o.filename){var c=i.graphicMaterialFiles[o.filename];if(c)"pending"===c.state?c.tasks.push({task:this,cb:this.loadRepresentationImage,args:[o.filename,e,a]}):this.loadRepresentationImage(o.filename,e,a);else{i.graphicMaterialFiles[o.filename]={state:"pending",tasks:[]};var u=new t(this.streamObject.blob,o.filename);u.open(),u.readAsXML(function(t){u.close();var s=i.graphicMaterialFiles[o.filename];i.graphicMaterialFiles[o.filename]=r.parseGraphicMaterial(t);for(var n=0;n<s.tasks.length;n++){var l=s.tasks[n];0,l.cb.apply(l.task,l.args)}r.loadRepresentationImage(o.filename,e,a)})}}},parseGraphicMaterial:function(e){var a={type:"material3DXML",shading:"Phong",DiffuseMapWrap:[],DiffuseMapRepeat:[0,0]},t=e.firstChild;if("Osm"===t.nodeName){for(var r=0;r<t.childNodes.length;r++){var i=t.childNodes[r];if("Feature"==i.nodeName&&"RenderingFeature"==i.getAttribute("Alias"))for(var s=0;s<i.childNodes.length;s++){var n=i.childNodes[s];if("Attr"==n.nodeName){var l=n.getAttribute("Type"),o=n.getAttribute("Value"),c=n.getAttribute("Name");switch(l){case"int":switch(o=parseInt(o,10),a[c]=o,c){case"WrappingModeU":o&&(a.DiffuseMapWrap[0]="repeat",a.DiffuseMapRepeat[0]=1);break;case"WrappingModeV":o&&(a.DiffuseMapWrap[1]="repeat",a.DiffuseMapRepeat[1]=1);break;case"PreviewType":switch(parseInt(o)){case 0:a.mappingFunction="SPHERICAL_ENV_MAP";break;case 2:a.mappingFunction="USER_MAPPING"}}break;case"double":switch(c){case"DiffuseColor":a.colorDiffuse=this.getColor(o);break;case"SpecularColor":a.colorSpecular=this.getColor(o);break;case"AmbientColor":a.colorAmbient=this.getColor(o);break;case"SpecularExponent":a.shininess=128*parseFloat(o);break;case"SpecularCoef":a.specularCoef=parseFloat(o);break;case"Reflectivity":a.reflectivityCoef=parseFloat(o);break;case"Transparency":a.transparency=parseFloat(o),a.transparent=a.transparency>0}break;case"boolean":switch(o="true"===o,c){case"AlphaTest":a.alphaTest=o?.5:0;break;default:a[c]=o}break;case"external":var u=[];u=o.split("urn:3DXML:"),u=(o=u[1]).split("#"),o=u[0];var m=u[1];"TextureImage"==c&&(a.DiffuseMap={imageLib:o,id:m})}}}}return a}},loadRepresentationImage:function(e,a,r){var s=this,n=this.streamObject.getUserData(),l=new i,o=n.graphicMaterialFiles[e],c=o.DiffuseMap;if(c&&c.imageLib){var u=n.imageLibraryFiles[c.imageLib];if(u)"pending"===u.state?u.tasks.push({task:this,cb:this.loadImage,args:[e,a,r]}):this.loadImage(e,a,r);else{n.imageLibraryFiles[c.imageLib]={state:"pending",tasks:[]};var m=new t(this.streamObject.blob,c.imageLib);m.open(),m.readAsXML(function(t){m.close();var i=n.imageLibraryFiles[m.filename];n.imageLibraryFiles[m.filename]=s.parseRepresentationImage(t);for(var l=0;l<i.tasks.length;l++){var o=i.tasks[l];0,o.cb.apply(o.task,o.args)}s.loadImage(e,a,r)})}}else{var f=l.getMaterial3DXML(o,"/","XMLV43");r&&r(f)}},parseRepresentationImage:function(e){var a={},t=e.firstChild;if("Model_3dxml"===t.nodeName){for(var r=0;r<t.childNodes.length;r++){var i=t.childNodes[r];if("CATRepImage"==i.nodeName)for(var s=0;s<i.childNodes.length;s++){var n=i.childNodes[s];if("CATRepresentationImage"==n.nodeName){var l=n.getAttribute("id"),o=(n.getAttribute("name"),n.getAttribute("format"),n.getAttribute("associatedFile").split("urn:3DXML:"));a[l]=o[1]}}}return a}},loadImage:function(e,a,r){var i=this,s=this.streamObject.getUserData(),n=s.graphicMaterialFiles[e],l=n.DiffuseMap,o=s.imageLibraryFiles[l.imageLib][l.id],c=s.imageFiles[o];if(c)"pending"===c.state?c.tasks.push({task:this,cb:this.createMaterial,args:[e,o,a,r]}):this.createMaterial(e,o,a,r);else{s.imageFiles[o]={state:"pending",tasks:[]};var u=new t(this.streamObject.blob,o);u.open();"dds"==/(?:\.([^.]+))?$/.exec(o)[1]?u.readAsArrayBuffer(function(t){u.close();var l=s.imageFiles[o];s.imageFiles[o]=t;for(var c=0;c<l.tasks.length;c++){var m=l.tasks[c];0,m.cb.apply(m.task,m.args)}n.DiffuseMap={filename:o,buffer:s.imageFiles[o]},i.createMaterial(e,a,r)}):u.readAsBlob(function(t){u.close();var n=s.imageFiles[o];s.imageFiles[o]=t;for(var l=0;l<n.tasks.length;l++){var c=n.tasks[l];0,c.cb.apply(c.task,c.args)}i.createMaterial(e,o,a,r)})}},createMaterial:function(e,a,t,r){var s=new i,n=this.streamObject.getUserData(),l=n.graphicMaterialFiles[e];l.DiffuseMap={filename:a,buffer:n.imageFiles[a]};var o=s.getMaterial3DXML(l,"/","XMLV43",null,r);t&&o.map&&t(o)},getColor:function(e){var a=[],t=new RegExp(/\[([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*))\]/),r=t.exec(e);return null!=r?(a[0]=parseFloat(RegExp.$1),a[1]=parseFloat(RegExp.$2),a[2]=parseFloat(RegExp.$3)):null!=(r=(t=new RegExp(/\[([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*)),([0,1]|(?:[0,1]?\.[0-9]*))\]/)).exec(e))&&(a[0]=parseFloat(RegExp.$1),a[1]=parseFloat(RegExp.$2),a[2]=parseFloat(RegExp.$3),a[3]=parseFloat(RegExp.$4)),a}});return UWA.namespace("THREEDS/XMLMaterialUnstreamTask",n)}),define("VisuUnstreamers/XMLMaterialUnstreamTask",["DS/VisuUnstreamers/XMLMaterialUnstreamTask","DS/DSMigration/DSMigration"],function(e,a){return a.deprecateModule("VisuUnstreamers/XMLMaterialUnstreamTask"),e});