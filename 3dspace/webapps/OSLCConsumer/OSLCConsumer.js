define("DS/OSLCConsumer/facets/ProxyFacet",["UWA/Core","UWA/Controls/Web","DS/EditPropWidget/facets/Common/FacetsBase","DS/EditPropWidget/constants/EditPropConstants","DS/WAFData/WAFData","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleServicesSettings","DS/UIKIT/Mask","DS/LifecycleServices/XMLDocHelper","UWA/Array","DS/LifecycleServices/OSLCServicesHelper"],function(e,t,o,i,n,s,r,c,l,a,d){"use strict";return o.extend({init:function(){this._parent.apply(this,arguments),this.elements.container||(this.elements.container=e.createElement("div",{styles:{height:"100%"},class:"proxy_container"}),this.elements.myControl=new e.Controls.Web({url:"",height:"100%"}),this.elements.myControl.setIFrameHeight("100%"),this.elements.myControl.elements.container.style.height="100%",this.elements.myControl.inject(this.elements.container))},onError:function(e){console.log(e)},updateFacet:function(){var e,t=this;c.mask(this.elements.container),r.app_initialization(function(){(e=t.getModel())&&s.getOslcConfigPromise().then(function(o){var i="/resources/v1/modeler/e6wproxy/"+e._attributes.objectId;s.get(e._attributes.tenant,i,{},function(i){var n=a.detect(o.repositories,function(e){return e.id===i.data[0].dataelements.Proxy_Service}),r=i.data[0].dataelements.Proxy_URL,u=i.data[0].dataelements.Proxy_Modified,p=i.data[0].type;n&&r&&(c.unmask(t.elements.container),d.getProxyObjectExternalDetails({tenantId:e._attributes.tenant,proxyService:n.id,OSLCResource:n.rootUrl+r,proxyType:p,repositoryRootURL:n.rootUrl,onSuccess:function(o){var i=new Date(u),c=new Date(o.dataelements.Proxy_Modified);i.setMilliseconds(0),c.setMilliseconds(0),i.getTime()<c.getTime()&&d.updateProxyObject({tenantId:e._attributes.tenant,data:{data:[o]},onSuccess:function(e){widget.dispatchEvent("onRefresh")},onError:t.onError}),s.oslcRequest(e._attributes.tenant,n.id,n.rootUrl+r,{method:"GET",headers:{Accept:"application/x-oslc-compact+xml"},onSuccess:function(o){if("string"==typeof o){var i=l.loadXMLDoc(o);if("object"==typeof i){var r=l.filterDescendants([i],{tag:"oslc:largePreview"});if(!r.length&&(r=l.filterDescendants([i],{tag:"oslc:smallPreview"})),1===r.length){var c=l.filterDescendants(r,{tag:"oslc:document"});if(1===c.length){var a=l.getNodeInfo(c[0]).attrList["rdf:resource"];"string"==typeof a&&s.oslcRequest(e._attributes.tenant,n.id,a,{method:"GET",headers:{Accept:"text/html,text/*"},timeout:864e5,onSuccess:function(e){t.elements.myControl.getIFrame().contentDocument.open(),t.elements.myControl.getIFrame().contentDocument.write(e),t.elements.myControl.getIFrame().contentDocument.close()},onError:t.onError,onTimeout:function(e){console.log(e)}})}}}}},onError:t.onError})},onError:t.onError}))},t.onError)},t.onError)})},destroyComponent:function(){e.is(this.destroy,"function")&&this.destroy()}})}),define("DS/OSLCConsumer/OSLCConsumer",["UWA/Core","css!DS/OSLCConsumer/OSLCConsumer","UWA/Controls/Abstract","UWA/Controls/Web","i18n!DS/OSLCConsumer/assets/nls/OSLCConsumerNls","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","DS/LifecycleServices/LifecycleServices","i18n!DS/LifecycleServices/assets/nls/LifecycleServicesNls","DS/LifecycleServices/LifecycleServicesSettings","DS/LifecycleServices/OSLCServicesHelper","DS/LifecycleServices/XMLDocHelper","DS/WAFData/WAFData","DS/LifecycleControls/CommandDialog","DS/Controls/ComboBox","DS/UIKIT/SuperModal","DS/UIKIT/Mask","DS/UIKIT/Scroller"],function(e,t,o,i,n,s,r,c,l,a,d,u,p,h,m,f,v){"use strict";return h.implement({_showPopup:function(){this._previous(),this.elements.popup.elements.container.addClassName("oslc-combobox-popup")}}),o.extend({iframeContainer:{},context:null,oslc_repository_combo:null,oslc_repository_list:null,oslc_provider_combo:null,oslc_provider_list:null,init_options:null,init:function(e){this.init_options=e,console.log("this.init_options:"),console.log(this.init_options),this._parent(e),this.oslc_repository_list=[],this.oslc_provider_list=[]},executeCmd:function(e,t,o){var i=this;this.context=t.context,this.addEvent("onReady",function(){f.unmask(document.body),this._showCommandUI(e)},this),this.addEvent("onComplete",function(){i._removeOslcEventListener(),o()}),f.mask(document.body),this._addOslcEventListener(),this._loadOslcData()},_onComplete:function(){this.dispatchEvent("onComplete",{})},_destroyDialog:function(){this.cmdDlg.destroy(),this._onComplete(),this.dispatchEvent("onClose")},_addOslcEventListener:function(){var e=this;this.onOslcResultsMessage=function(t){if(t.data.startsWith("oslc-response:")){var o=JSON.parse(t.data.substring("oslc-response:".length))["oslc:results"];console.log(o),e._processOslcResults(o)}},window.addEventListener("message",this.onOslcResultsMessage,!1)},_removeOslcEventListener:function(){window.removeEventListener("message",this.onOslcResultsMessage,!1)},_showCommandUI:function(){var t=this;this.content=document.createElement("div"),this.content.className="oslc_popup";var o=this;this.cmdDlg=new p;var i=e.createElement("div",{styles:{width:"100%",height:"100%",overflow:"auto"}});this.dlg=this.cmdDlg.create(i,{title:this.init_options.title,closeButton:!0,resizable:!0,buttonStyle:this.cmdDlg.buttonStyle.none,onClose:function(){o._onComplete(),"function"==typeof t.init_options.notification&&t.init_options.notification({objects:[]})},events:{onShow:function(){e.extendElement(t.content).inject(i)}}}),this._createDropdownLists(),this.iframeContainer=e.createElement("div",{class:"oslc-iframe"}),this.iframeContainer.inject(this.content),this.dlg.inject(document.body);var n=this._computeDialogSize();this.dlg.setNewSize(n),e.extendElement(this.content).setStyle("height",n.bodyHeight.toString()+"px"),this.oslc_provider_list.length>0&&(this.displayContentFromUrl(t.oslc_provider_combo.currentValue.url+"#oslc-core-postMessage-1.0",function(){f.unmask(t.iframeContainer)}),f.mask(this.iframeContainer))},_loadOslcData:function(){var e=this;r.getOslcConfigPromise().then(function(t){e.oslc_repository_list.length=0,t.repositories.forEach(function(t){t.domain===e.init_options.providerFilter&&e.oslc_repository_list.push({labelItem:t.title,valueItem:t})});var o=function(){e.dispatchEvent("onReady",{})};e.oslc_repository_list.length>0?e._loadProviders(e.oslc_repository_list[0].valueItem,o):o()},function(t){f.unmask(document.body),e.showError(t),e._onComplete(),"function"==typeof e.init_options.notification&&e.init_options.notification({objects:[],error:t})})},_loadProviders:function(e,t){var o=this;this.oslc_provider_list.length=0;var i={Accept:"application/rdf+xml"};if(e["OSLC-Core-Version"]&&(i["OSLC-Core-Version"]=e["OSLC-Core-Version"]),""!==e.catalogUrl)r.oslcRequest(this.init_options.tenantId,e.id,e.catalogUrl,{method:"GET",headers:i,onSuccess:function(i){var n=new a.ProjectAreaCatalog(i);o._loadProviderDetails(e,n.serviceProviderList,0,t)},onError:function(e){e===c.authorizationRequired?f.isMasked(document.body)&&f.unmask(document.body):o.showError(e)}});else if(""!==e.serviceUrl){var n=[{url:e.serviceUrl,details:"/",title:e.title}];o._loadProviderDetails(e,n,0,t)}else t()},_loadProviderDetails:function(e,t,o,i){var n=this;if(o!==t.length){var s={Accept:"application/rdf+xml"};e["OSLC-Core-Version"]&&(s["OSLC-Core-Version"]=e["OSLC-Core-Version"]);var c=t[o];r.oslcRequest(n.init_options.tenantId,e.id,c.url,{method:"GET",headers:s,onSuccess:function(s){var r,l=new a.ServiceProvider(s),d=c.details.substring(c.details.lastIndexOf("/")+1);if("creationDialog"===n.init_options.operation)r=l.operationTypes.CREATION_DIALOG;else{if("selectionDialog"!==n.init_options.operation)throw Error("OSLCConsumer._loadProviderDetails: Unexpected OSLC operation input parameter: "+n.init_options.operation);r=l.operationTypes.SELECTION_DIALOG}var u=e.defaultServices;!0===n.init_options.defaultServices&&(u=!0);var p=l.getServiceDetails(d,r,n.init_options.resourceType,u);if(p.length>0){var h=p[0];if("oslc:dialog"in h){var m=h["oslc:dialog"].attrList["rdf:resource"],f=h["oslc:hintHeight"].text,v=h["oslc:hintWidth"].text;n.oslc_provider_list.push({labelItem:c.title,valueItem:{url:m,height:f,width:v}})}}p.length,n._loadProviderDetails(e,t,++o,i)},onError:function(e){n.showError(e)}})}else i()},_computeDialogSize:function(){var e=0,t=0;this.oslc_provider_list.length>0&&this.oslc_provider_list.forEach(function(o){var i=parseInt(o.valueItem.height,10),n=parseInt(o.valueItem.width,10);i>e&&(e=i),n>t&&(t=n)});var o=Math.max(e+54,120);return{height:o+54,width:Math.max(t+30,400),bodyHeight:o}},_createDropdownLists:function(){var t=this,o=e.createElement("div").inject(this.content);e.createElement("label",{class:"oslc-dropdown-list-label",text:n.selectRepository}).inject(o),this.oslc_repository_combo=new h({elementsList:this.oslc_repository_list,selectedIndex:0}).inject(o),this.oslc_repository_combo.addEventListener("change",function(){f.mask(t.dlg.elements.body),t._loadProviders(t.oslc_repository_combo.currentValue,function(){if(t._createProviderComboBox(),t.oslc_provider_list.length>0){var o=t._computeDialogSize();t.dlg.setNewSize(o),e.extendElement(t.content).setStyle("height",o.bodyHeight.toString()+"px"),t.dlg.centerIt(),t.displayContentFromUrl(t.oslc_provider_combo.currentValue.url+"#oslc-core-postMessage-1.0",function(){f.unmask(t.dlg.elements.body)})}else t.iframeContainer.empty(),f.unmask(t.dlg.elements.body)})}),this.providerDropdownListRow=e.createElement("div").inject(this.content),e.createElement("label",{class:"oslc-dropdown-list-label",text:n.selectProvider}).inject(this.providerDropdownListRow),this._createProviderComboBox()},_createProviderComboBox:function(){var e=this;this.oslc_provider_combo&&this.oslc_provider_combo.destroy(),this.oslc_provider_combo=new h({elementsList:this.oslc_provider_list,selectedIndex:0}).inject(this.providerDropdownListRow),this.oslc_provider_combo.addEventListener("change",function(){e.displayContentFromUrl(e.oslc_provider_combo.currentValue.url+"#oslc-core-postMessage-1.0",function(){f.unmask(e.iframeContainer)}),f.mask(e.iframeContainer)})},_processOslcResults:function(e){if(0===e.length)return this._destroyDialog(),void("function"==typeof this.init_options.notification&&this.init_options.notification({objects:[]}));if(this.init_options.singleObject&&e.length>1){new m({className:"oslc-supermodal",renderTo:document.body}).alert(n.selectSingleObject)}else{f.mask(this.dlg.elements.body,n.processing),this._loadOslcResultDetails({data:[]},e,0)}},_loadOslcResultDetails:function(e,t,o,i){var n=this;if(o!==t.length){var s=i;"object"!=typeof s&&(s=this.oslc_repository_combo.currentValue);var r=s.id,c=t[o],l=this.init_options.tenantId,d=this.init_options.proxyType;a.getProxyObjectExternalDetails({tenantId:l,proxyService:r,proxyType:d,OSLCResource:c["rdf:resource"],repositoryRootURL:s.rootUrl,onSuccess:function(i){e.data.push(i),n._loadOslcResultDetails(e,t,++o,s)},onError:n.showError})}else this._updateProxyObject(e)},_updateProxyObject:function(e){var t=this,o=function(){f.unmask(t.dlg.elements.body),t._destroyDialog()};a.updateProxyObject({tenantId:this.init_options.tenantId,data:e,onSuccess:function(e){console.log("proxyServiceRequest: COMPLETED"),console.log(e),o();var i={objects:[]};e.data.forEach(function(e){i.objects.push({oslc:"oslc RDF+XML",proxy:e})}),"function"==typeof t.init_options.notification&&t.init_options.notification(i)},onError:function(e,i){o();var n=r.parseWebServiceError(e,i);t.showError(n),console.log("Failed to retrieve data from the server"),"function"==typeof t.init_options.notification&&t.init_options.notification({objects:[],error:n})}})},displayContentFromUrl:function(e,t){this.iframeContainer.empty(),new i({url:e,className:"oslc-web-control",events:{onLoad:function(){t()}}}).inject(this.iframeContainer)},showNotification:function(e,t){if("function"==typeof this.context.displayNotification){var o={eventID:"string"==typeof t?t:"primary",msg:e};this.context.displayNotification(o)}else alert(e)},showError:function(e){if("function"==typeof this.context.displayNotification){var t={eventID:"warning",msg:e};this.context.displayNotification(t)}else alert(e)}})});