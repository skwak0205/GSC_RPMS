define("DS/EditPropExtensions/WebServices/WebServices",["UWA/Class","DS/WAFData/WAFData","i18n!DS/EditPropExtensions/assets/nls/AddExtensionsNLS"],function(e,t,n){"use strict";return e.singleton({init:function(){this._parent({})},getUrl:function(e){return url},getClassInterfaces:function(e,s,a,i,o,r,l){if(console.log("getClassInterfaces"),"bus"==o)var c={classes:i};else if("connection"==o)c={relationclass:i};var u={Accept:"application/json","Content-Type":"application/json","Accept-Language":widget.lang};e&&(u.SecurityContext=e.SecurityContext);this.options;var h=this.get3DSpaceWSUrl(this.tenant,a,"/resources/dictionary/interfaces","customerOnly=true&displayAttributes=true&noDeprecated=true&noAbstract=true");t.authenticatedRequest(h,{method:"POST",headers:u,timeout:864e5,data:JSON.stringify(c),type:"json",onComplete:function(e){console.log("getClassInterfaces:onComplete"),r(e)},onFailure:function(e,t,s){console.log("fail"),console.log(this);var a=e;t&&"object"==typeof t?(t.error&&t.error.Message?a=t.error.Message:t.message&&(a=t.message),console.log(t)):"object"==typeof e&&(e.message.startsWith("NetworkError:")?a=e.message.endsWith('return ResponseCode with value "0"')?n.noConnection:e.message.endsWith('return ResponseCode with value "401"')||e.message.endsWith('return ResponseCode with value "403"')?n.webServiceUnauthorized:n.webServiceError:"null"===e&&(a=n.webServiceError)),l(a)},onTimeout:function(){l("timeout")}})},getObjectInterfaces:function(e,s,a,i,o,r,l){if(console.log("getObjectInterfaces"),"bus"==o)var c={objects:i},u="/resources/dictionary/object/interfaces";else if("connection"==o)c={connections:i},u="/resources/dictionary/relation/interfaces";var h={Accept:"application/json","Content-Type":"application/json","Accept-Language":widget.lang};e&&(h.SecurityContext=e.SecurityContext);this.options;var d=this.get3DSpaceWSUrl(this.tenant,a,u,"customerOnly=true&isRoleChecked=true");t.authenticatedRequest(d,{method:"POST",headers:h,timeout:864e5,data:JSON.stringify(c),type:"json",onComplete:function(e){console.log("getObjectInterfaces:onComplete"),r(e)},onFailure:function(e,t,s){console.log("fail"),console.log(this);var a=e;t&&"object"==typeof t?(t.error&&t.error.Message?a=t.error.Message:t.message&&(a=t.message),console.log(t)):"object"==typeof e&&(e.message.startsWith("NetworkError:")?a=e.message.endsWith('return ResponseCode with value "0"')?n.noConnection:e.message.endsWith('return ResponseCode with value "401"')||e.message.endsWith('return ResponseCode with value "403"')?n.webServiceUnauthorized:n.webServiceError:"null"===e&&(a=n.webServiceError)),l(a,t)},onTimeout:function(){console.log("timeout")}})},addInterfaces:function(e,s,a,i,o,r,l){if(console.log("addInterfaces"),"bus"===o)var c="/resources/dictionary/object/addInterfaces";else if("connection"===o)c="/resources/dictionary/relation/addInterfaces";var u={Accept:"application/json","Content-Type":"application/json","Accept-Language":widget.lang};if(i)for(var h in i)u[h]=i[h];e&&(u.SecurityContext=e.SecurityContext);this.options;var d=this.get3DSpaceWSUrl(this.tenant,s,c);t.authenticatedRequest(d,{method:"POST",headers:u,timeout:864e5,data:JSON.stringify(a),type:"json",onComplete:function(e){console.log("addInterfaces:onComplete"),r()},onFailure:function(e,t,s){console.log("fail"),console.log(this);var a=e;t&&"object"==typeof t?(t.error&&t.error.Message?a=t.error.Message:t.message&&(a=t.message),console.log(t)):"object"==typeof e&&(e.message.startsWith("NetworkError:")?a=e.message.endsWith('return ResponseCode with value "0"')?n.noConnection:e.message.endsWith('return ResponseCode with value "401"')||e.message.endsWith('return ResponseCode with value "403"')?n.webServiceUnauthorized:n.webServiceError:"null"===e&&(a=n.webServiceError)),l(a)},onTimeout:function(e){console.log("timeout"),l(e)}})},removeInterfaces:function(e,s,a,i,o,r,l){if(console.log("removeInterfaces"),"bus"===o)var c="/resources/dictionary/object/removeInterfaces";else if("connection"===o)c="/resources/dictionary/relation/removeInterfaces";var u={Accept:"application/json","Content-Type":"application/json","Accept-Language":widget.lang};if(e&&(u.SecurityContext=e.SecurityContext),i)for(var h in i)u[h]=i[h];this.options;var d=this.get3DSpaceWSUrl(this.tenant,s,c);t.authenticatedRequest(d,{method:"POST",headers:u,timeout:864e5,data:JSON.stringify(a),type:"json",onComplete:function(e){console.log("removeInterfaces:onComplete"),r(e)},onFailure:function(e,t,s){console.log("fail"),console.log(this);var a=e;t&&"object"==typeof t?(t.error&&t.error.Message?a=t.error.Message:t.message&&(a=t.message),console.log(t)):"object"==typeof e&&(e.message.startsWith("NetworkError:")?a=e.message.endsWith('return ResponseCode with value "0"')?n.noConnection:e.message.endsWith('return ResponseCode with value "401"')||e.message.endsWith('return ResponseCode with value "403"')?n.webServiceUnauthorized:n.webServiceError:"null"===e&&(a=n.webServiceError)),l(a)},onTimeout:function(e){console.log("timeout")}})},get3DSpaceUrl:function(e){var t=location.protocol+"//"+location.hostname;return e&&(e.serverUrl=t,e.serverUri="3DSpace"),t+"/3DSpace"},get3DSpaceBaseUrl:function(e){this.options,this.options.platform_services;if(!UWA.is(this.getOption("platform_services"),"array"))throw new Error("Platform services not initialize yet");var t;try{for(var n=0;n<this.getOption("platform_services").length;n++)if(this.getOption("platform_services")[n].platformId==e){t=this.getOption("platform_services")[n]["3DSpace"];break}}catch(e){t=this.get3DSpaceUrl()}return t},get3DSpaceWSUrl:function(e,t,n,s){null!=e&&null!=e&&""!=e||(e="OnPremise");var a=t+n+"?tenant="+e;return null!=s&&null!=s&&(a=a+"&"+s),a},checkChange:function(e){console.log("checkChange");require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"],function(t){console.log("cfgConfigAuthoring"),t.get2(function(t){console.log("cfgConfigAuthoring.get2");var n=null;t&&t.AuthoringContextHeader&&Object.keys(t.AuthoringContextHeader).length>0&&(n=t.AuthoringContextHeader),t.errorMessage&&console.log("Change : "+t.errorMessage),e.call(null,n)})})}})}),define("DS/EditPropExtensions/UI/AddExtensionsWidget",["UWA/Controls/Abstract","UWA/Core","DS/UIKIT/SuperModal","DS/UIKIT/Autocomplete","DS/UIKIT/Accordion","DS/UIKIT/Form","DS/EditPropExtensions/WebServices/WebServices","DS/UIKIT/Input/Button","DS/UIKIT/Scroller","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","i18n!DS/EditPropExtensions/assets/nls/AddExtensionsNLS","i18n!DS/UIKIT/assets/nls/UIKIT"],function(e,t,n,s,a,i,o,r,l,c,u,h){"use strict";var d="en",g=function(e){if(this.interfaces=[],null!==e){var t=e.results;if(1===t.length)this.interfaces=t[0].interfaces;else{for(var n=t[0].interfaces,s=1;s<t.length;s++)n=v(n,t[s].interfaces);this.interfaces=n}if(this.allAttachedInterfaces)for(var a=0;a<this.interfaces.length;){for(s=0;s<this.allAttachedInterfaces.length;s++)if(this.allAttachedInterfaces[s].name===this.interfaces[a].name){this.interfaces.splice(a,1),a--;break}a++}}return this.interfaces},m=function(e){if(this.attachedInterfaces=[],null!==e){var t=e.results;if(1===t.length)this.attachedInterfaces=t[0].interfaces;else{for(var n=t[0].interfaces,s=1;s<t.length;s++)n=v(n,t[s].interfaces);this.attachedInterfaces=n}}return this.attachedInterfaces},f=function(e){if(this.allAttachedInterfaces=[],null!==e)if(1==(t=e.results).length)this.allAttachedInterfaces=t[0].interfaces;else for(var t=e.results,n=0;n<t.length;n++)for(var s=t[n].interfaces,a=0;a<s.length;a++)this.allAttachedInterfaces.push(s[a]);return this.allAttachedInterfaces},v=function(e,t){for(var n=[],s=0;s<e.length;s++)for(var a=e[s].name,i=0;i<t.length;i++)a!==t[i].name||n.push(e[s]);return n},p=e.extend({context:null,init:function(e,s,a,i,r,l,h){console.log("init");d=e.lang,this._parent(a),this.elements.SC=i;var v=[],p=r.getTenant();this.tenant=p,this.elements.myObject=r,this.setInterfaces=g.bind(this),this.setAttachedInterfaces=m.bind(this),this.setAllAttachedInterfaces=f.bind(this),this.buildUI=function(){this._buildUI()}.bind(this);var S="";if(this.metatype=r.get("metatype"),"bus"===r.get("metatype")?S="_DS_ATTR_type":"connection"===r.get("metatype")&&(S="_DS_ATTR_label"),r._innerModels){var b=r._innerModels;for(var D in b){var I=b[D].get("objectId"),y=b[D].get(S);y?v.push(y.valueDB):v[0]=r.get(S).valueDB,this.setObject(I)}}else{I=r.get("objectId");var C=r.get(S).valueDB;v[0]="string"==typeof C?C:C[0],this.setObject(I)}c.getServiceUrl({serviceName:"3DSpace",onComplete:function(s){s.forEach(function(e){void 0===e.url?t.log("url is undefined, skipping "+e.platformId):p===e.platformId&&(this.URL=e.url)}.bind(this)),o.getObjectInterfaces(i,this.tenant,this.URL,this.models,this.metatype,function(t){this.attachedInterfaces=this.setAttachedInterfaces(t),this.allAttachedInterfaces=this.setAllAttachedInterfaces(t),o.getClassInterfaces(i,this.tenant,this.URL,v,this.metatype,function(t){this.interfaces=this.setInterfaces(t),this.buildUI(),console.log("init:onComplete"),this.showDialog(e,l,h)}.bind(this),function(e){var t=u.failMessage+e;h(t)})}.bind(this),function(e,t){e=u.failMessage+e;t&&"object"==typeof t&&t.error&&"1002"===t.error.code?new n({closable:!0,className:"Modals",events:{onHide:function(){l()}}}).alert(u.roleNotAllowed):h(e)})}.bind(this),onFailure:function(e){t.log(e),h(u.urlNotFound)}}),this.context=a.context},setObject:function(e){this.models||(this.models=[]),this.models.push(e)},showDialog:function(e,t,s){console.log("EditPropExtensions:showDialog");document.getElementsByClassName("EPP_PopupDial");var a=new n({closable:!0,className:"Modals",events:{onHide:function(){t()}}}),i=u.ok,r=u.cancel,l=this.elements.myContainer;a.dialog({body:l,title:u.title,buttons:[{className:"primary",value:i,action:function(e){var t=this.autoComplete.getSelection(),n=this.attributesForm,a={},i={},r={},l={},c={};for(var u in n){l={};var h=n[u],d=h.getChangedValues();for(var g in d){var m=h.get(g).get("valueDB");"boolean"==h.get(g).get("type")&&(m=String(m)),""!==h.get(g).get("dimension")&&(c[g]=h.get(g).get("dimension")),l[g]=m}l.__dimensions=c,i[u]=l}a.interfaces=i,a.phyIDS=this.models,r.interfaces=this.extensionsToDelete,r.phyIDS=this.models,o.checkChange(function(n){console.log("checkChange :"+n),t.length>0?o.addInterfaces(this.elements.SC,this.URL,a,n,this.metatype,function(){this.extensionsToDelete.length>0?o.removeInterfaces(this.elements.SC,this.URL,r,n,this.metatype,function(){e.hide()},function(t){e.hide(),s(t)}):e.hide()}.bind(this),function(t){e.hide(),s(t)}):this.extensionsToDelete.length>0&&o.removeInterfaces(this.elements.SC,this.URL,r,n,this.metatype,function(){e.hide()},function(t){e.hide(),s(t)})}.bind(this))}.bind(this)},{value:r,action:function(e){e.hide()}}]}),this.mySuperModal=a,document.getElementsByName("autoCompleteExtensions")[0].focus()},changeClass:function(e,t){var n=e.getParent().getParent();if("warning"!=n.className){n.className="warning",e.className="fonticon fonticon-2x fonticon-reset",e.title=u.get("cancelRemove");var s=e.getAttribute("id");t.push(s)}else{n.className="",e.className="fonticon fonticon-2x fonticon-exchange-delete",e.title=u.get("removeExt");s=e.getAttribute("id");var a=t.indexOf(s);a>-1&&t.splice(a,1)}},_buildUI:function(){console.log("buildUI");var e=this,n=[],i=(this.interfaces,this.attachedInterfaces);this.allAttachedInterfaces;this.extensionsToDelete=[];var o=t.createElement("div",{id:"main-body",styles:{position:"relative",height:"100%",overflow:"visible"}}),r=t.createElement("div",{id:"autoComplete",styles:{overflow:"visible"}}).inject(o),l=t.createElement("div",{id:"newExtDiv",styles:{position:"relative",height:"100%","max-height":"400px",overflow:"auto"}}).inject(o),c=t.createElement("div",{id:"attachedExtDiv"}).inject(o),h=(t.createElement("div",{id:"toScroll"}),t.createElement("div",{id:"tableDiv",styles:{height:"100%","max-height":"110px",overflow:"auto"}})),d=t.createElement("table",{class:"table table-hover",width:"100%"}).inject(h),g=t.createElement("tbody").inject(d),m=0;for(m=0;m<i.length;m++){var f=t.createElement("tr").inject(g),v=i[m];t.createElement("p",{title:v.name,text:v.nameNLS}).inject(t.createElement("td",{align:"left",width:"80%"}).inject(f));var p=t.createElement("span",{styles:{cursor:"pointer;"},id:v.name,title:u.get("removeExt")});p.className="fonticon fonticon-2x fonticon-exchange-delete",p.inject(t.createElement("td",{align:"center",width:"20%"}).inject(f)),p.onclick=function(t){var n=t.target;e.changeClass(n,e.extensionsToDelete)}}this.interfaces.forEach(function(e){n.push({value:e.name,label:e.nlsName,name:e.name})});var S={name:"extensions",items:n},b=new s({name:"autoCompleteExtensions",showSuggestsOnFocus:!0,multiSelect:!0,placeholder:u.autoCompPlaceHolder,autofocus:"autofocus",events:{onSelect:function(t,n){e.updateAttUI(t,!0)},onUnselect:function(t,n,s){e.updateAttUI(t,!1)}},style:{width:"100%",overflow:"visible"}}).inject(r);b.addDataset(S);var D=new a({className:"divided",exclusive:!1,items:[]}).inject(l);this.elements.accordion=D;new a({className:"filled",exclusive:!1,items:[{title:u.get("attachedExtension"),content:h,name:"atExt"}]}).inject(c);var I=b.getItems();I[0],I[1],b.currentSuggestions,b.datasets;return this.autoComplete=b,this.elements.tableExtensions=d,this.elements.myContainer=o,o},convertDateToStandard:function(e){var n,s,a,i,o,r,l,c=d;return e?(n=t.is(e,"date")?t.clone(e):new Date,s=e.getUTCFullYear(),(a=e.getUTCMonth()+1)<10&&(a="0"+a),(i=e.getUTCDate())<10&&(i="0"+i),(o=e.getUTCHours())<10&&(o="0"+o),(r=e.getUTCMinutes())<10&&(r="0"+r),(l=e.getUTCSeconds())<10&&(l="0"+l),n.setYear(s),n.setMonth(e.getMonth()),n.setDate(i),n.setHours(o),n.setMinutes(r),n.setSeconds(l),{value:e.toLocaleString(c),valueDB:s+"/"+a+"/"+i+"@"+o+":"+r+":"+l+":GMT"}):{value:"",valueDB:""}},updateAttUI:function(e,t){var n=this.elements.accordion,s=this.interfaces,a=this,i=[];this.attributesForm||(this.attributesForm={});var o=this.attributesForm,r=e.name;t?s.forEach(function(t){t.name===e.name&&(i=t.attributes,require(["DS/EditPropWidget/facets/Properties/Properties","DS/EditPropWidget/models/EditPropAttributeModel","DS/EditPropWidget/models/EditPropModel"],function(t,s,l){var c,u={editMode:!0,setCloseButton:!1,scroller:!1},h=new t(u),d={};i.forEach(function(e){if("Date"===e.Primitive){var t=e.default,n=new Date(1e3*t),i=a.convertDateToStandard(n);if((c=new s).set("type","timestamp"),c.set("masked",!1),c.set("label",e.nlsName),c.set("name",e.name),c.set("path",e.path),c.set("select","attribute["+e.path+"]"),c.set("multivalue",e.multiValue),c.set("multiline",e.multiLine),c.set("readOnly",!1),0!==e.maxLength?c.set("maxlength",e.maxLength):c.set("maxlength",0),null!=e.default&&null!=e.default&&""!=e.default&&(c.set("value",i.value),c.set("valueDB",i.valueDB)),e.hasRange){for(var o=[],r=0;r<e.ranges.length;r++)o[r]=a.convertDateToStandard(new Date(1e3*e.ranges[r])).valueDB;c.set("authorizedValues",o),c.set("authorizedValuesNLS",o),""===c.get("value")&&""===c.get("valueDB")&&(c.set("value",[]),c.set("valueDB",[]))}d[c.getIdentifier()]=c}else"Double"===e.Primitive?((c=new s).set("type","real"),c.set("masked",!1),c.set("label",e.nlsName),c.set("name",e.name),c.set("path",e.path),c.set("select","attribute["+e.path+"]"),c.set("readOnly",!1),c.set("multivalue",e.multiValue),c.set("multiline",e.multiLine),c.set("dimensionType",e.DimensionType),c.set("dimension",e.Dimension),c.set("unitName",e.UnitName),null!=e.default&&null!=e.default&&(c.set("value",e.default),c.set("valueDB",e.default)),c.get("multivalue")&&""===c.get("value")&&""===c.get("valueDB")&&(c.set("value",[]),c.set("valueDB",[])),-1!==e.maxLength?c.set("maxlength",e.maxLength):c.set("maxlength",0),e.hasRange&&(c.set("authorizedValues",e.ranges),c.set("authorizedValuesNLS",e.rangesNLS?e.rangesNLS:e.ranges),""===c.get("value")&&""===c.get("valueDB")&&(c.set("value",[]),c.set("valueDB",[]))),d[c.getIdentifier()]=c):"Integer"===e.Primitive?((c=new s).set("type","integer"),c.set("masked",!1),c.set("label",e.nlsName),c.set("name",e.name),c.set("path",e.path),c.set("select","attribute["+e.path+"]"),c.set("readOnly",!1),c.set("multivalue",e.multiValue),c.set("multiline",e.multiLine),0!==e.maxLength?c.set("maxlength",e.maxLength):c.set("maxlength",0),null!=e.default&&null!=e.default&&(c.set("value",e.default),c.set("valueDB",e.default)),e.hasRange&&(c.set("authorizedValues",e.ranges),c.set("authorizedValuesNLS",e.rangesNls),""===c.get("value")&&""===c.get("valueDB")&&(c.set("value",[]),c.set("valueDB",[]))),d[c.getIdentifier()]=c):"Boolean"===e.Primitive?((c=new s).set("type","boolean"),c.set("masked",!1),c.set("label",e.nlsName),c.set("name",e.name),c.set("path",e.path),c.set("select","attribute["+e.path+"]"),c.set("multivalue",e.multiValue),c.set("multiline",e.multiLine),c.set("readOnly",!1),0!==e.maxLength?c.set("maxlength",e.maxLength):c.set("maxlength",0),null!=e.default&&null!=e.default&&(c.set("value",e.default),c.set("valueDB",e.default)),e.hasRange&&(c.set("authorizedValues",e.ranges),c.set("authorizedValuesNLS",e.rangesNls),""===c.get("value")&&""===c.get("valueDB")&&(c.set("value",[]),c.set("valueDB",[]))),d[c.getIdentifier()]=c):"String"===e.Primitive?((c=new s).set("type","string"),c.set("masked",!1),c.set("label",e.nlsName),c.set("name",e.name),c.set("path",e.path),c.set("select","attribute["+e.path+"]"),c.set("readOnly",!1),c.set("multiline",e.multiLine),c.set("multivalue",e.multiValue),0!==e.maxLength?c.set("maxlength",e.maxLength):c.set("maxlength",0),null!=e.default&&null!=e.default&&(c.set("value",e.default),c.set("valueDB",e.default)),e.hasRange&&(c.set("authorizedValues",e.ranges),c.set("authorizedValuesNLS",e.rangesNls),""===c.get("value")&&""===c.get("valueDB")&&(c.set("value",[]),c.set("valueDB",[]))),d[c.getIdentifier()]=c):(c=new s({path:e.name,label:e.nlsName,valueDB:e.default,name:e.name,readOnly:!1}),d[c.getIdentifier()]=c)});var g=new l;g.set(d),g.saveInitialValues(),h.initData([g]),h.elements.container.setStyle("height","100%"),o[r]=g,n.addItem({title:e.label,content:h,selected:!0,name:e.name})}))}):(n.removeItem(e.name),delete this.attributesForm[r]);n.getSelectedItems(),n.getUnselectedItems()}});return p.setInterfaces=g,p.setAttachedInterfaces=m,p.setAllAttachedInterfaces=f,p});