define("DS/ENODOManagementCmds/commands/GenericDOGenerationCmd",["UWA/Core","UWA/Controls/Abstract","DS/PlatformAPI/PlatformAPI","i18n!DS/ENODOManagementCmds/assets/nls/DOGeneratorCmd","DS/ENODOUtilsServices/DOServices","text!DS/ENODOUtilsServices/assets/enodo_webservices.json"],function(e,t,r,i,o,a){"use strict";var n=JSON.parse(a);let s=["CATPart","SLDPRT","PRT","IPT"],l=["DWG","SLDDRW","CATDrawing"];return t.extend({jsonObjects:[],init:function(e){if(this._parent(e),UWA.is(e.data.context)&&(this.context=e.data.context),UWA.is(e.data)&&UWA.is(e.data.selections||0===e.data.selections.length)){this.selectionMessage=e.data.selections,this.leaves=e.data.leaves;var t=UWA.is(e.data.filter)?e.data.filter:null;this._initializeFormatList(t)}else o._displayNotification("error",i.error.title,i.error.noSelection),this.destroy()},_buildModel:function(e,t){this.model={format:e,rules:t,selection:[],updateSelection:function(e){e.length<=this.format.length&&(this.selection=e)},updateFormatList:function(e){this.format=e,this.selection=[]},getSelectedFormats:function(){for(var e=[],r=0;r<this.selection.length;r++){var i=this.selection[r];if(i<t.length){var o=t[i];e.push(o)}}return e}}},_initializeFormatList:function(e){var t=this,r={data:{ruleType:"ONDEMAND"},webService:{url:n.retrieveFormats.url,verb:n.retrieveFormats.verb},callback:{onComplete:function(r){var a=UWA.is(r,"string")?JSON.parse(r):r;if(UWA.is(a.derivedOutputRules)&&0!==a.derivedOutputRules.length){for(var n=[],d=[],c=0;c<a.derivedOutputRules.length;c++){var u=a.derivedOutputRules[c];if(u.hasOwnProperty("target")&&u.hasOwnProperty("category")&&u.hasOwnProperty("source")&&u.hasOwnProperty("parameters")){var p=!1;if(null!==e&&(e.hasOwnProperty("CADMaster")&&e.CADMaster.length>0&&e.CADMaster.toLowerCase()!==u.category.toLowerCase()&&(p=!0),e.hasOwnProperty("type")&&e.type.length>0&&("Drawing"===e.type&&-1===l.indexOf(u.source)||"Part"===e.type&&-1===s.indexOf(u.source))&&(p=!0)),!p){for(var f="",v=u.parameters,m=0;m<v.length;m++){var h=v[m];if(h.hasOwnProperty("name")&&h.hasOwnProperty("value"))f+=(h.hasOwnProperty("displayName")?h.displayName:h.name)+" = "+(h.hasOwnProperty("displayValue")?h.displayValue:h.value)+", "}f.length>0&&(f=f.substring(0,f.length-2));var y=u.hasOwnProperty("converter")?u.converter:"",g=u.source,O=g;u.hasOwnProperty("sourceToDisplay")?O=u.sourceToDisplay:i.type.hasOwnProperty(g.toLowerCase())&&(O=i.type[g.toLowerCase()]);var w=u.hasOwnProperty("outputStreamId")?u.outputStreamId:D,D=u.target;u.hasOwnProperty("targetToDisplay")&&(D=u.targetToDisplay);var S=u.hasOwnProperty("activation")?u.activation:"defaultinactive",C={format:D,connector:u.category,type:O,parameter:f,converter:y,activationType:S,outputStreamId:w};n.push(C),d.push(u)}}}0===n.length?(o._displayNotification("error",i.error.title,i.warning.noFormat),t._destroyCmd()):(t._buildModel(n,d),t._createView())}else 0===a.derivedOutputRules.length&&o._displayNotification("error",i.error.title,i.warning.noFormat),t._destroyCmd()},onFailure:function(e){o._displayNotification("error",i.error.title,i.replace(i.error.jobFailed,{oMsg:e})),t._destroyCmd()}}};o.SendServerRequest(r)},_createView:function(){var e=this;require(["DS/ENODOManagementCmds/views/_DOGeneratorView"],function(t){var r=new t({_command_id:e.options.ID,model:e.model,controller:e});e.view=r})},_generateDO:function(){var e=this;UWA.is(this.view)&&this.view.destroy();var t={data:{selections:e.selectionMessage,formatList:this.model.getSelectedFormats(),context:this.context},webService:{url:n.navigateAndGenerateJobs.url,verb:n.navigateAndGenerateJobs.verb},callback:{onComplete:function(t){var a=UWA.is(t,"string")?JSON.parse(t):t;if(UWA.is(a.jobsCreated)){var n=a.jobsCreated;if(0===n?o._displayNotification("info",i.info.title,i.info.noJobCreated):1===n?o._displayNotification("info",i.info.title,i.info.jobCreated):o._displayNotification("info",i.info.title,i.replace(i.info.jobsCreated,{oJobs:n})),"ENOWSES_AP"===e.context){var s={operation:"OnDemandDOGeneration",content:a};r.publish("webinwin:web:notification",JSON.stringify(s))}}e._destroyCmd()},onTimeout:function(e){o._displayNotification("warning",i.warning.title,i.error.doCreationTimeout)},onFailure:function(t){var r;if(t.message&&t.message.indexOf("Error:")&&t.message.indexOf("ResponseCode")){var a=t.message.substring(t.message.indexOf("ResponseCode")).split('"')[1];r="500"===a?"ENOWSES_AP"===e.context?i.error.wrongSelection:i.error.expandIssue:"400"===a?i.error.code400:"401"===a?i.error.code401:null==a?"Gateway Timeout error":"Error processing request"}o._displayNotification("error",i.error.title,i.replace(i.error.jobFailed,{oMsg:r})),e._destroyCmd()}}};o.SendServerRequest(t)},_destroyCmd:function(){UWA.is(this.view)&&this.view.destroy(),this.destroy()}})});