define("DS/SUI/ARNodeManager",["UWA/Core","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/WebappsUtils/WebappsUtils","DS/Visualization/SceneGraphFactory"],function(e,t,i,n,o){"use strict";return e.Class.extend({init:function(e){this._viewer=e,this._planeBag=new i,e.addNode(this._planeBag),this._imageBag=new i,e.addNode(this._imageBag),this._pointBag=new i,e.addNode(this._pointBag)},addPlane:function(e){var t=e.anchor.getName(),n=new i(t);this._planeBag.addChild(n),n.setMatrix(e.anchor.getVirtualGlobalMatrix());var o=new i(t+"_center");this._planeBag.addChild(o),o.setMatrix(e.center.getVirtualGlobalMatrix())},getAnchorPlaneNode:function(e){return this._planeBag.getChildByName(e)},getCenterPlaneNode:function(e){return this._planeBag.getChildByName(e+"_center")},updatePlane:function(e){var t=this.getAnchorPlaneNode(e.anchor.getName());t&&t.setMatrix(e.anchor.getVirtualGlobalMatrix());var i=this.getCenterPlaneNode(e.anchor.getName());i&&i.setMatrix(e.center.getVirtualGlobalMatrix())},removePlane:function(e){var t=this.getAnchorPlaneNode(e);this._planeBag.removeChild(t);var i=this.getCenterPlaneNode(e);this._planeBag.removeChild(i)},addImage:function(e){var t=e.anchor.getName(),n=new i(t);this._imageBag.addChild(n),n.setMatrix(e.anchor.getVirtualGlobalMatrix())},getAnchorImageNode:function(e){return this._imageBag.getChildByName(e)},updateImage:function(e){var t=this.getAnchorImageNode(e.anchor.getName());t&&t.setMatrix(e.anchor.getVirtualGlobalMatrix())},removeImage:function(e){var t=this.getAnchorImageNode(e);this._imageBag.removeChild(t)},addPoint:function(e){var t=e.getName(),n=new i(t);this._pointBag.addChild(n),n.setMatrix(e.getVirtualGlobalMatrix())},getAnchorPointNode:function(e){return this._pointBag.getChildByName(e)},updatePoint:function(e){var t=this.getAnchorPointNode(e.getName());t&&t.setMatrix(e.getVirtualGlobalMatrix())},changePointIdentifier:function(e,t){this.getAnchorPointNode(e).setName(t)},removeAnchorPoint:function(e){var t=this.getAnchorPointNode(e);this._pointBag.removeChild(t)},getRoot:function(){var e=new i;return e.addChild(this._planeBag),e.addChild(this._imageBag),e.addChild(this._pointBag),e},clearAll:function(){this._viewer.removeNode(this._planeBag),this._planeBag=new i,this._viewer.addNode(this._planeBag),this._viewer.removeNode(this._imageBag),this._imageBag=new i,this.viewer.addNode(this._imageBag),this._viewer.removeNode(this._pointBag),this._pointBag=new i,this.viewer.addNode(this._pointBag)}})}),define("DS/SUI/Context",["UWA/Core","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return e.Class.extend({init:function(){this.users=[],this._position=new t.Vector3,this._orientation=new t.Quaternion,this._scale=new t.Vector3(1,1,1)},getName:function(){return"context"},getMatrix:function(){return(new t.Matrix4).compose(this._position,this._orientation,this._scale)},getUser:function(e){e=e||0;return this.users[e]},getPosition:function(){return(new t.Vector3).copy(this._position)},getOrientation:function(){return(new t.Quaternion).copy(this._orientation)},getScale:function(){return(new t.Vector3).copy(this._scale)},setPosition:function(e){this._position.copy(e)},setPositionX:function(e){this._position.x=e},setPositionY:function(e){this._position.y=e},setPositionZ:function(e){this._position.z=e},setOrientation:function(e){this._orientation.copy(e)},setScale:function(e){e<=0||this._scale.set(e,e,e)},translate:function(e){this._position.add(e)},multiplyQuaternion:function(e){this._orientation.multiply(e)}})}),define("DS/SUI/Element",["UWA/Core","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return e.Class.extend({init:function(e,i){this._name=e,this._suiParent=i,this._position=new t.Vector3,this._orientation=new t.Quaternion,this._scale=new t.Vector3(1,1,1),this._virtualMapping=new t.Matrix4},getName:function(){return this._name},getParent:function(){return this._suiParent},getPosition:function(){return(new t.Vector3).copy(this._position)},getOrientation:function(){return(new t.Quaternion).copy(this._orientation)},getScale:function(){return(new t.Vector3).copy(this._scale)},getVirtualMapping:function(){return(new t.Matrix4).copy(this._virtualMapping)},getPhysicalLocalMatrix:function(){return(new t.Matrix4).compose(this._position,this._orientation,this._scale)},getPhysicalGlobalMatrix:function(){var e=this.getPhysicalLocalMatrix().clone();if("getPhysicalGlobalMatrix"in this._suiParent){var t=this._suiParent.getPhysicalGlobalMatrix();e.multiplyMatrices(t,e)}return e},getVirtualGlobalMatrix:function(){var e=new t.Matrix4;if("getVirtualGlobalMatrix"in this._suiParent){var i=this.getPhysicalLocalMatrix(),n=this._virtualMapping;e.multiplyMatrices(n,i);var o=this._suiParent.getVirtualGlobalMatrix();e.multiplyMatrices(o,e)}else if("context"===this._suiParent.getName()&&"getMatrix"in this._suiParent){i=this.getPhysicalLocalMatrix();e.multiplyMatrices(this._suiParent.getMatrix(),i)}return e},setParent:function(e){if(this===e)throw new Error("cannot set parent to self");this._suiParent!==e&&(this._suiParent=e)},setName:function(e){""!==e&&(this._name=e)},setPosition:function(e){this._position.copy(e)},setPositionX:function(e){this._position.x=e},setPositionY:function(e){this._position.y=e},setPositionZ:function(e){this._position.z=e},setOrientation:function(e){this._orientation.copy(e)}})}),define("DS/SUI/SUIFactory",["UWA/Core","DS/SUI/Context","DS/SUI/Element","DS/Visualization/ThreeJS_DS"],function(e,t,i,n){"use strict";return e.Class.singleton({createSUIModel:function(){var e=new t;e.environment=new i("environment",e);var n=new i("user",e);return n.head=new i("head",n),n.rightHand=new i("rightHand",n),n.leftHand=new i("leftHand",n),e.users.push(n),e},configureContextHead:function(e,t){if(e&&t){var o=e.getUser().head;o.centerEye=new i("centerEye",o),o.leftEye=new i("leftEye",o),o.rightEye=new i("rightEye",o);var a=new n.Vector3(-32,0,0),r=t.getEyeParameters("left");r&&r.offset&&(a.x=1e3*r.offset[0],a.y=1e3*r.offset[1],a.z=1e3*r.offset[2]),o.leftEye.setPosition(a);var s=new n.Vector3(32,0,0),d=t.getEyeParameters("right");d&&d.offset&&(s.x=1e3*d.offset[0],s.y=1e3*d.offset[1],s.z=1e3*d.offset[2]),o.rightEye.setPosition(s),o.ipd=s.x-a.x}},createPlane:function(e,t){e.planeBag||(e.planeBag={});var o=e.planeBag,a=new i(t.identifier,e),r=t.alignement,s=new i(t.identifier+"_center",a),d=new n.Vector3,h=t.boundaryVertexCount,c=new Array,l=new Array,_=t.vertexCount,u=new Array,w=t.triangleCount,g=new Array,p=t.textureCoordinateCount;t.vertices&&t.vertexCount&&t.triangleCount&&t.triangleIndices&&t.textureCoordinateCount&&t.textureCoordinates,o[t.identifier]={anchor:a,alignement:r,center:s,extent:d,boundaryVertexCount:h,boundaryVertices:c,vertices:l,vertexCount:_,triangleIndices:u,triangleCount:w,textureCoordinates:g,textureCoordinateCount:p}},createImageAnchor:function(e,t){e.imageBag||(e.imageBag={}),e.imageBag[t.identifier]={anchor:new i(t.identifier,e),imageName:t.name,physicalWidth:t.imageWidth,physicalHeight:t.imageHeight}},createPointAnchor:function(e,t){e.pointBag||(e.pointBag={}),e.pointBag[t.identifier]=new i(t.identifier,e)}})}),define("DS/SUI/ARScenario",["UWA/Core","DS/SUI/SUIFactory","DS/SUI/Element","DS/SUI/ARNodeManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/Visualization/Node3D","DS/WebappsUtils/WebappsUtils","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/CoreEvents/Events"],function(e,t,i,n,o,a,r,s,d,h,c){"use strict";const l=new o.Vector3(1,0,0),_=(new o.Quaternion).setFromAxisAngle(l,Math.PI/2),u=(new o.Quaternion).setFromAxisAngle(l,-Math.PI/2),w=(new o.Matrix4).makeRotationFromQuaternion(_),g=(new o.Matrix4).makeRotationFromQuaternion(u),p=new o.Quaternion,v=new o.Quaternion,f=new o.Matrix4,m=new o.Matrix4,x=new o.Matrix4,P=e=>{if(e&&3===e.length)return[e[1],e[2]]=[e[2],e[1]],e},V=e=>{if(e&&3===e.length)return[e[1],e[2]]=[-e[2],e[1]],e},M=e=>{if(e&&4===e.length)return p.set(e[0],e[1],e[2],e[3]),v.multiplyQuaternions(_,p),v.multiply(u),Object.assign(e,[v.x,v.y,v.z,v.w]),e},C=e=>{e&&(V(e.pointPosition),M(e.pointOrientation))},I=e=>{if(e){if(e.planePosition&&V(e.planePosition),e.planeOrientation&&M(e.planeOrientation),e.center&&V(e.center),e.extent&&P(e.extent),e.boundaryVertices&&e.boundaryVertexCount)for(let t=0;t<e.boundaryVertexCount;t++)V(e.boundaryVertices[t]);if(e.vertices&&e.vertexCount&&e.triangleCount&&e.triangleIndices&&e.textureCoordinateCount&&e.textureCoordinates)for(let t=0;t<e.vertexCount;t++)V(e.vertices[t])}},b=e=>{e&&V(e.imagePosition)},S=e=>{e&&(e instanceof Object||"object"==typeof e)&&(e.anchorforHit&&("anchorPosition"in e.anchorforHit&&V(e.anchorforHit.anchorPosition),"anchorOrientation"in e.anchorforHit&&M(e.anchorforHit.anchorOrientation)),"worldPosition"in e&&V(e.worldPosition),"worldOrientation"in e&&M(e.worldOrientation))};return e.Class.extend({init:function(e){if(e.transparentCSS){var t=document.getElementsByClassName("windowed-view"),i=document.getElementsByClassName("wux-afr-framewindow");t.length>=2&&i.length>=1&&(t[0].style="background-color: transparent;",t[1].style="background-color: transparent;",i[0].style="background: transparent;")}if(this._headTracking=!0,this._odt=e.odt||!1,this._viewer=e.viewer,this._optionSaved={},this._trackingViewpoint=null,this._trackingViewpointIdx=-1,this._onSessionStateChanged=null,this._onViewpointUpdated=null,this._onPlaneAdded=null,this._onPlaneUpdated=null,this._onPlaneRemoved=null,this._onImageAdded=null,this._onImageUpdated=null,this._onImageRemoved=null,this._onAnchorAdded=null,this._onAnchorUpdated=null,this._onAnchorRemoved=null,this._onReceiveHitTestResult=null,this._onReceiveCenterHitTestResult=null,this._onReceiveWorldMap=null,this._resizeEvent=null,this.anchorsIdCounter_=0,this._drawPlanes=!1,this._drawPlaneBoundaries=!1,this._drawPlaneMeshes=!1,e.drawPlanes&&(this._drawPlanes=!!e.drawPlanes.planes,this._drawPlaneBoundaries=!!e.drawPlanes.boundaries,this._drawPlaneMeshes=!!e.drawPlanes.mesh),e.detectPlane){var n=e.detectPlane;n.activated?this._detectionMode={Horizontal:n.horizontal,Vertical:n.vertical,BoundaryMesh:n.boundary,Mesh:n.mesh}:this._detectionMode={Horizontal:!1,Vertical:!1,BoundaryMesh:!1,Mesh:!1}}else this._detectionMode={Horizontal:!0,Vertical:!0,BoundaryMesh:!1,Mesh:!1};if(this._detectionImageData={external:!1,imagesPath:""},e.imageData){var a=e.imageData.external&&e.imageData.imagesArray;(a=a||!e.imageData.external&&e.imageData.imagesPath)&&(this._detectionImageData=e.imageData)}this.planeMaterial=new o.MeshPhongMaterial({color:"red"}),this.planeMaterial.line=new o.LineBasicMaterial({color:0,linewidth:2,opacity:1}),this.planeMaterial.side=o.DoubleSide,this.planeMaterial.depthWrite=!0,this.planeMaterial.opacity=.05,this.planeMaterial.transparent=!0,this.planeMaterial.force=!0,this.planeMaterial.receiveShadow=!0,this.planeMaterial.castShadow=!1,this.boundaryMaterial=new o.LineBasicMaterial({color:"green",linewidth:25e3,opacity:1,polygonBorderMode:!0,linejoin:"miter"});var r=s.getWebappsAssetUrl("SUI","textures/WebPointCircle.png"),d=o.ImageUtils.loadTexture(r,void 0,void 0,void 0,!0);this.pointCloudMaterial=new o.ParticleBasicMaterial({force:!0,map:d,sizeAttenuation:!1,size:50,blending:o.AdditiveBlending,depthTest:!0,transparent:!0,opacity:.3}),this._initValues();c.publish({event:"/AR/onScenarioReady",data:this})},_initValues:function(){this._context=null,this._videoRatio=16/9,this._cloudPoints={},this._showPointCloud=!1,this.SUIHeadOrientation=new o.Quaternion,this.SUIHeadPosition=new o.Vector3,this.planeOrientation=new o.Quaternion,this.planePosition=new o.Vector3,this.planePositionCenter=new o.Vector3,this._loadWorldMap=!1,this._worldMappingStatus="Not available"},isARCompatible:function(){return!!window.nsWebViewInterface},_configureSUI:function(){this._viewer.currentViewpoint;this._context.setPosition(new o.Vector3(0,0,0))},_setContextUp:function(e){var t=new o.Vector3(0,0,1).applyQuaternion(e),i=new o.Vector3(0,0,1),n=i.angleTo(t);if(0!==n){var a=(new o.Vector3).crossVectors(i,t).normalize(),r=(new o.Quaternion).setFromAxisAngle(a,-n);r.multiply(e),this._context.setOrientation(r)}else this._context.setOrientation(e)},_saveViewerOptions:function(){this._optionSaved.backgroundColor=this._viewer.ambience.getBackgroundColor(),this._optionSaved.displayPoints=this._viewer.renderer.renderPoints,this._optionSaved.grid=this._viewer.getGrid(),this._optionSaved.defaultAnimationLoop=this._viewer.defaultAnimationLoop},_restoreViewerOptions:function(e){if(e&&e.retrieveNodeManager&&e.rootAnchor){this.moveContext({rootAnchor:e.rootAnchor});var t=this._viewer.getRootNode(),i=this._getRootNodeManager();t.addChild(i)}this._viewer.ambience.setBackgroundColor(this._optionSaved.backgroundColor),this._viewer.setBackgroundColor(this._optionSaved.backgroundColor,"1"),this._viewer.displayPoints(this._optionSaved.displayPoints),this._viewer.setGrid(this._optionSaved.grid),this._viewer.defaultAnimationLoop=this._optionSaved.defaultAnimationLoop},_configureViewer:function(){this._saveViewerOptions(),this._viewer.setBackgroundColor("rgb(0,0,0)","0"),this._trackingViewpoint=new a({viewer:this._viewer}),this._trackingViewpoint.near=10,this._trackingViewpoint.far=1e5,this._nodeManager=new n(this._viewer),this._viewer.addViewpoint(this._trackingViewpoint),this._trackingViewpointIdx=this._viewer.getViewpoints().length-1,this._trackingViewpointIdx&&this._viewer.selectViewpoint(this._trackingViewpointIdx),this._viewer.currentViewpoint=this._trackingViewpoint;var e={viewpoint:!1};this._trackingViewpoint.getControl().setActive(e),this._odt||(this._viewer.defaultAnimationLoop=!1)},_restoreViewer:function(e){this._restoreViewerOptions(e),this._nodeManager instanceof n&&(this._nodeManager=null),this._viewer.selectViewpoint(0),this._viewer.removeViewpoint(this._trackingViewpointIdx),this._trackingViewpointIdx=-1,this._trackingViewpoint=null,this._viewer._modelEvent.unsubscribe(this.onPostRenderToken),this.onPostRenderToken=null;e={viewpoint:!0};this._viewer.currentViewpoint.getControl().setActive(e),this._viewer.render({updateInfinitePlane:!0}),window.requestAnimationFrame(this._viewer.animate)},_updateSUIHead:function(e){this.SUIHeadOrientation.x=e.orientation[0],this.SUIHeadOrientation.y=e.orientation[1],this.SUIHeadOrientation.z=e.orientation[2],this.SUIHeadOrientation.w=e.orientation[3],this.SUIHeadPosition.x=e.position[0],this.SUIHeadPosition.y=e.position[1],this.SUIHeadPosition.z=e.position[2],this._context.getUser().head.setOrientation(this.SUIHeadOrientation),this._context.getUser().head.setPosition(this.SUIHeadPosition)},_updateTrackingViewpoint:function(e){if(void 0!==this._trackingViewpoint){this._trackingViewpoint.camera.fov=e.fov,this._trackingViewpoint.camera.offsetX=e.projection[4]/2,this._trackingViewpoint.camera.offsetY=e.projection[5]/2,this._trackingViewpoint.camera.updateProjectionMatrix();var t=this._context.getUser().head.getVirtualGlobalMatrix().decompose();if(this._trackingViewpoint.moveTo({eyePosition:t[0],orientation:t[1]}),this._videoRatio=e.videoRatio,e.worldMappingStatus)switch(e.worldMappingStatus){case 0:this._worldMappingStatus="Not available";break;case 1:this._worldMappingStatus="Limited";break;case 2:this._worldMappingStatus="Extending";break;case 3:this._worldMappingStatus="Mapped"}}},_updatePlaneList:function(e){for(var i=0;i<e.length;++i){var n,o=e[i];this._context.planeBag&&o.identifier in this._context.planeBag?(n=this._updateSUIPlane(o),this._nodeManager.updatePlane(n),this._onPlaneUpdated&&this._onPlaneUpdated(n,o.identifier)):(t.createPlane(this._context,o),n=this._updateSUIPlane(o),this._nodeManager.addPlane(n),(this._drawPlanes||this._drawPlaneBoundaries||this._drawPlaneMeshes)&&this._updatePlaneModel(n),this._onPlaneAdded&&this._onPlaneAdded(n,o.identifier))}},_updateSUIPlane:function(e){var t=this._context.planeBag[e.identifier];e.planeOrientation&&(this.planeOrientation.x=e.planeOrientation[0],this.planeOrientation.y=e.planeOrientation[1],this.planeOrientation.z=e.planeOrientation[2],this.planeOrientation.w=e.planeOrientation[3],t.anchor.setOrientation(this.planeOrientation)),e.planePosition&&(this.planePosition.x=e.planePosition[0],this.planePosition.y=e.planePosition[1],this.planePosition.z=e.planePosition[2],t.anchor.setPosition(this.planePosition)),e.center&&(this.planePositionCenter.x=e.center[0],this.planePositionCenter.y=e.center[1],this.planePositionCenter.z=e.center[2],t.center.setPosition(this.planePositionCenter));var i=!1;if(e.extent&&(i=t.extent.x!=e.extent[0]||t.extent.y!=e.extent[1]||t.extent.z!=e.extent[2],t.extent.x=e.extent[0],t.extent.y=e.extent[1],t.extent.z=e.extent[2]),e.boundaryVertices&&e.boundaryVertexCount){t.boundaryVertexCount=e.boundaryVertexCount,t.boundaryVertices=[];for(var n=0;n<e.boundaryVertexCount;++n){var a=new o.Vector3;a.x=e.boundaryVertices[n][0],a.y=e.boundaryVertices[n][1],a.z=e.boundaryVertices[n][2],t.boundaryVertices.push(a)}}if(e.vertices&&e.vertexCount&&e.triangleCount&&e.triangleIndices&&e.textureCoordinateCount&&e.textureCoordinates){t.vertexCount=e.vertexCount,t.vertices=[];for(n=0;n<e.vertexCount;++n)t.vertices.push(e.vertices[n][0]),t.vertices.push(e.vertices[n][1]),t.vertices.push(e.vertices[n][2]);t.triangleCount=e.triangleCount,t.triangleIndices=[];for(n=0;n<3*e.triangleCount;++n)t.triangleIndices.push(e.triangleIndices[n][0]);t.textureCoordinateCount=e.textureCoordinateCount,t.textureCoordinates=[];for(n=0;n<e.textureCoordinateCount;++n)t.textureCoordinates.push(e.textureCoordinates[n][0]),t.textureCoordinates.push(e.textureCoordinates[n][1]),t.textureCoordinates.push(e.textureCoordinates[n][2])}return(this._drawPlanes||this._drawPlaneBoundaries||this._drawPlaneMeshes)&&i&&this._updatePlaneModel(t),t},_updatePlaneModel:function(e){var t=this._nodeManager.getCenterPlaneNode(e.anchor.getName()),i=this._nodeManager.getAnchorPlaneNode(e.anchor.getName());if(t&&i){var n=t.getChildByName("planeModel");n&&t.removeChild(n);var a=i.getChildByName("boundaryModel");a&&i.removeChild(a);var r=i.getChildByName("meshModel");if(r&&i.removeChild(r),this._drawPlanes){var s=d.createRectangleNode({width:e.extent.x,height:e.extent.y,fill:!0,color:"red"});s.setPickable(h.NOPICKABLE),s.setName("planeModel"),s.material=this.planeMaterial;var c=new o.Matrix4;c.setPosition(new o.Vector3(-e.extent.x/2,-e.extent.y/2,0)),s.setMatrix(c),t.addChild(s)}if(this._drawPlaneBoundaries&&"undefined"!=e.boundaryVertices&&e.boundaryVertices.length>0){var l=d.createLineNode({points:e.boundaryVertices,material:this.boundaryMaterial});l.setName("boundaryModel");var _=(new o.Matrix4).setPosition(new o.Vector3(0,0,0));l.setMatrix(_),i.addChild(l)}if(this._drawPlaneMeshes&&"undefined"!=e.vertices&&e.vertices.length>0){var u=d.createSimpleMeshNode({bufferPosition:e.vertices,bufferIndex:e.triangleIndices,bufferUV:e.textureCoordinates,glType:h.ConnectivityTypeEnum.TRIANGLES,color:new h.Color(.5,.2,.4,1)});u.setPickable(h.NOPICKABLE),u.setName("meshModel");var w=(new o.Matrix4).setPosition(new o.Vector3(0,0,0));u.setMatrix(w),i.addChild(u)}}},_removeFromPlaneList:function(e){for(var t=0;t<e.length;++t){var i=e[t];delete this._context.planeBag[i.identifier],this._nodeManager.removePlane(i.identifier),this._onPlaneRemoved&&this._onPlaneRemoved(i.identifier)}},_updateImageList:function(e){for(var i=0;i<e.length;++i){var n,o=e[i];this._context.imageBag&&o.identifier in this._context.imageBag?(n=this._updateSUIImage(o),this._nodeManager.updateImage(n),this._onImageUpdated&&this._onImageUpdated(n)):(t.createImageAnchor(this._context,o),n=this._updateSUIImage(o),this._nodeManager.addImage(n),this._onImageAdded&&this._onImageAdded(n))}},_updateSUIImage:function(e){var t=this._context.imageBag[e.identifier];if(e.imagePosition){var i=new o.Vector3;i.x=e.imagePosition[0],i.y=e.imagePosition[1],i.z=e.imagePosition[2],t.anchor.setPosition(i)}if(e.imageOrientation){var n=new o.Quaternion;n.x=e.imageOrientation[0],n.y=e.imageOrientation[1],n.z=e.imageOrientation[2],n.w=e.imageOrientation[3],t.anchor.setOrientation(n)}return t},_removeFromImageList:function(e){for(var t=0;t<e.length;++t){var i=e[t];delete this._context.imageBag[i.identifier],this._nodeManager.removeAnchorImage(i.identifier),this._onImageRemoved&&this._onImageRemoved()}},_updateAnchorList:function(e){for(var i=0;i<e.length;++i){var n=e[i];if(this._context.pointBag&&n.identifier in this._context.pointBag){o=this._updateSUIPointAnchor(n);this._nodeManager.updatePoint(o),this._onAnchorUpdated&&this._onAnchorUpdated(o)}else{if(n.JSidentifier in this._context.pointBag){var o=this._context.pointBag[n.JSidentifier];delete this._context.pointBag[n.JSidentifier],o.setName(n.identifier),this._context.pointBag[n.identifier]=o,this._updateSUIPointAnchor(n),this._nodeManager.changePointIdentifier(n.JSidentifier,n.identifier),this._nodeManager.updatePoint(o)}else{t.createPointAnchor(this._context,{identifier:n.identifier});var o=this._updateSUIPointAnchor(n);this._nodeManager.addPoint(o)}this._onAnchorAdded&&this._onAnchorAdded(o)}}},_updateSUIPointAnchor:function(e){var t=this._context.pointBag[e.identifier];if(e.pointPosition){var i=new o.Vector3;i.x=e.pointPosition[0],i.y=e.pointPosition[1],i.z=e.pointPosition[2],t.setPosition(i)}if(e.pointOrientation){var n=new o.Quaternion;n.x=e.pointOrientation[0],n.y=e.pointOrientation[1],n.z=e.pointOrientation[2],n.w=e.pointOrientation[3],t.setOrientation(n)}return t},_removeFromAnchorList:function(e){for(var t=0;t<e.length;++t){var i=e[t];this._context.pointBag[i.identifier]&&delete this._context.pointBag[i.identifier],this._nodeManager.removeAnchorPoint(i.identifier),this._onAnchorRemoved&&this._onAnchorRemoved()}},_updatePointCloud:function(e){if(this._showPointCloud){var t,i=this._viewer.getRootNode().getChildByName("PointCloudBag");null===i?((i=new r).setName("PointCloudBag"),i.setMatrix(this._context.getMatrix()),this._viewer.addNode(i)):i.children.length>3&&i.removeChild(i.children[0],!1);for(var n=0,a=[],s=0;s<e.length;++s)t=e[s].identifier,this._cloudPoints.hasOwnProperty(t)||(this._cloudPoints[t]=new o.Vector3),this._cloudPoints[t].x=e[s].pointPosition[0],this._cloudPoints[t].y=e[s].pointPosition[1],this._cloudPoints[t].z=e[s].pointPosition[2],a[n++]=e[s].pointPosition[0],a[n++]=e[s].pointPosition[1],a[n++]=e[s].pointPosition[2];var h=d.createPointsNode({positions:a,material:this.pointCloudMaterial});i.addChild(h)}},_unconfigureEventListeners:function(){window.nsWebViewInterface&&(window.nsWebViewInterface.off("VIEWPOINT_UPDATED"),window.nsWebViewInterface.off("IMAGE_ANCHOR_UPDATED"),window.nsWebViewInterface.off("IMAGE_ANCHOR_REMOVED"),window.nsWebViewInterface.off("PLANE_ANCHOR_UPDATED"),window.nsWebViewInterface.off("PLANE_ANCHOR_REMOVED"),window.nsWebViewInterface.off("POINT_ANCHOR_UPDATED"),window.nsWebViewInterface.off("POINT_ANCHOR_REMOVED"),window.nsWebViewInterface.off("TRACKINGSTATE_UPDATED"),window.nsWebViewInterface.off("HITTEST_RESULTS"),window.nsWebViewInterface.off("CENTER_HITTEST_RESULTS"),window.nsWebViewInterface.off("WORLD_MAP_INFOS"),window.nsWebViewInterface.off("TRACKING_OBJECT_UPDATED"),window.nsWebViewInterface.off("RESET"))},_configureEventListeners:function(){var e=this;window.nsWebViewInterface&&(window.nsWebViewInterface.on("VIEWPOINT_UPDATED",function(t){V(t.position),(e=>{if(e&&4===e.length)p.set(e[0],e[1],e[2],e[3]),v.multiplyQuaternions(_,p),Object.assign(e,[v.x,v.y,v.z,v.w])})(t.orientation),(e=>{if(e&&16===e.length)f.elements=Array.from(e),m.multiplyMatrices(w,f),m.elements[12]*=1e3,m.elements[13]*=1e3,m.elements[14]*=1e3,Object.assign(e,m.elements)})(t.transform),(e=>{if(e&&16===e.length)x.elements=Array.from(e),x.multiply(g),Object.assign(e,x.elements)})(t.projection),e._updateSUIHead(t),e._headTracking&&e._updateTrackingViewpoint(t),e._viewer.render(),window.requestAnimationFrame(e._viewer.animate),e._onViewpointUpdated&&e._onViewpointUpdated(t),c.publish({event:"/AR/onCameraUpdated",data:{viewpoint:t}})}),window.nsWebViewInterface.on("IMAGE_ANCHOR_UPDATED",function(t){var i=t;for(var n in i)b(i[n]);e._updateImageList(i),c.publish({event:"/AR/onImageAdded",data:{image:t}})}),window.nsWebViewInterface.on("IMAGE_ANCHOR_REMOVED",function(t){var i=t;e._removeFromImageList(i),c.publish({event:"/AR/onImageRemoved",data:{image:t}})}),window.nsWebViewInterface.on("PLANE_ANCHOR_UPDATED",function(t){var i=t;for(var n in i)I(i[n]);e._updatePlaneList(i),c.publish({event:"/AR/onPlaneAnchorUpdated",data:{planes:t}})}),window.nsWebViewInterface.on("PLANE_ANCHOR_REMOVED",function(t){var i=t;e._removeFromPlaneList(i),c.publish({event:"/AR/onPlaneAnchorRemoved",data:{planes:t}})}),window.nsWebViewInterface.on("POINT_ANCHOR_UPDATED",function(t){var i=t;for(var n in i)C(i[n]);e._updateAnchorList(i),c.publish({event:"/AR/onPointAnchorUpdated",data:{point:t}})}),window.nsWebViewInterface.on("POINT_ANCHOR_REMOVED",function(t){var i=t;e._removeFromAnchorList(i),c.publish({event:"/AR/onPointAnchorRemoved",data:{point:t}})}),window.nsWebViewInterface.on("POINT_CLOUD_UPDATED",function(t){var i=t;for(var n in i)V(i[n].pointPosition);e._updatePointCloud(i),c.publish({event:"/AR/onPointCloudUpdated",data:{pointCloud:i}})}),window.nsWebViewInterface.on("TRACKINGSTATE_UPDATED",function(t){var i,n;switch(t.trackingReason){case 0:n="NONE";break;case 1:n="NOT_READY";break;case 2:n="NOT_READY_RELOCALIZATION";break;case 3:n="EXCESSIVE_MOTION";break;case 4:n="INSUFFICIENT_FEATURES";break;case 5:n="INSUFFICIENT_LIGHT"}switch(t.trackingState){case 0:i="NOT_AVAILABLE";break;case 1:i="LIMITED";break;case 2:i="NORMAL"}var o={trackingState:i,trackingReason:n};e._onSessionStateChanged&&e._onSessionStateChanged(o),c.publish({event:"/AR/onTrackingStateUpdated",data:{trackingState:o}})}),window.nsWebViewInterface.on("HITTEST_RESULTS",function(t){for(var i in t)S(t[i]);e._onReceiveHitTestResult&&e._onReceiveHitTestResult(t),c.publish({event:"/AR/onHitTestResultReceived",data:{hitTest:t}})}),window.nsWebViewInterface.on("CENTER_HITTEST_RESULTS",function(t){for(var i in t)S(t[i]);e._onReceiveCenterHitTestResult&&e._onReceiveCenterHitTestResult(t),c.publish({event:"/AR/onCenterHitTestResultReceived",data:{hitTest:t}})}),window.nsWebViewInterface.on("WORLD_MAP_INFOS",function(t){var i=t;if("planeAnchors"in i)for(var n in i.planeAnchors)I(i.planeAnchors[n]);if("imageAnchors"in i)for(var o in i.imageAnchors)b(i.imageAnchors[o]);if("pointAnchors"in i)for(var a in i.pointAnchors)C(i.pointAnchors[a]);V(i.center),P(i.extent),e._onReceiveWorldMap&&e._onReceiveWorldMap(i),c.publish({event:"/AR/onWorldMapReceived",data:{hitTest:i}}),e._loadWorldMap&&(i.planeAnchors&&e._updatePlaneList(i.planeAnchors),i.imageAnchors&&e._updateImageList(i.imageAnchors),i.pointAnchors&&e._updateAnchorList(i.pointAnchors),e._loadWorldMap=!1)}),window.nsWebViewInterface.on("TRACKING_OBJECT_UPDATED",function(e){c.publish({event:"/AR/onTrackingObjectUpdated",data:{object:e}})}),window.nsWebViewInterface.on("RESET",function(e){this._nodeManager.clearAll(),c.publish({event:"/AR/onScenarioReset",data:{object:e}})}))},_planeIsHit:function(e,t,i){var n=(new o.Vector3).copy(t.origin),a=(new o.Vector3).copy(t.direction),r=e.center.getVirtualGlobalMatrix(),s=new o.Vector3(0,0,0).applyMatrix4(r),d=r.decompose(),h=new o.Vector3(0,0,1).applyQuaternion(d[1]);h.normalize();var c=Math.abs(a.x*h.x+a.y*h.y+a.z*h.z),l=(new o.Vector3).subVectors(s,n),_=-(l.x*h.x+l.y*h.y+l.z*h.z)/c;if(_>0){var u=(new o.Vector3).copy(n);u.add(a.multiplyScalar(_));var w=this._context.getMatrix(),g=(new o.Matrix4).getInverse(w),p=(new o.Vector3).copy(u).applyMatrix4(g);if(i)return{hit:!0,distance:_,intersection:p};var v=(new o.Matrix4).getInverse(r),f=(new o.Vector3).copy(u);if(f.applyMatrix4(v),f.x<.5*e.extent.x&&f.x>-.5*e.extent.x&&f.y<.5*e.extent.y&&f.y>-.5*e.extent.y)return{hit:!0,distance:_,intersection:p,localIntersection:f}}return{hit:!1}},activate:function(){if(this.isARCompatible()){this._context=t.createSUIModel(),this._configureSUI(),this._configureViewer(),this._configureEventListeners();this._viewer.canvas;if(!this._odt){var e={detectHorizontal:this._detectionMode.Horizontal,detectVertical:this._detectionMode.Vertical,BoundaryMesh:this._detectionMode.BoundaryMesh,Mesh:this._detectionMode.Mesh},i=this;window.nsWebViewInterface.on("executeResponse",function(e){window.nsWebViewInterface.off("executeResponse");var t=function(){let e=i._viewer.canvas.width/window.devicePixelRatio,t=i._viewer.canvas.height/window.devicePixelRatio;window.nsWebViewInterface.emit("canvasModified",{x:0,y:0,width:e,height:t})};i._resizeEvent=i._viewer.onViewerResize(t),t(),c.publish({event:"/AR/onScenarioStarted",data:{}})}),window.nsWebViewInterface.emit("executeOnNative",{action:"start",data:e})}}},suspend:function(){this._restoreViewer(),this._unconfigureEventListeners(),window.nsWebViewInterface&&window.nsWebViewInterface.emit("sendToNative",{suspendARSession:!0})},resume:function(){this._configureViewer(),this._configureEventListeners();window.nsWebViewInterface&&(window.nsWebViewInterface.on("executeResponse",function(e){window.nsWebViewInterface.off("executeResponse"),c.publish({event:"/AR/onScenarioResumed",data:{}})}),window.nsWebViewInterface.emit("executeOnNative",{action:"resumeARSession",data:!0}))},deactivate:function(e){this._resizeEvent&&this._viewer.unsubscribe(this._resizeEvent),this._restoreViewer(e),window.nsWebViewInterface&&window.nsWebViewInterface.emit("sendToNative",{stopARSession:!0}),this._unconfigureEventListeners(),this._initValues()},setCallback:function(e,t){switch(String(e)){case"TrackingSessionStateChanged":this._onSessionStateChanged=t;break;case"ViewpointUpdated":this._onViewpointUpdated=t;break;case"PlaneAdded":this._onPlaneAdded=t;break;case"PlaneUpdated":this._onPlaneUpdated=t;break;case"PlaneRemoved":this._onPlaneRemoved=t;break;case"AnchorAdded":this._onAnchorAdded=t;break;case"AnchorUpdated":this._onAnchorUpdated=t;break;case"AnchorRemoved":this._onAnchorRemoved=t;break;case"ImageAdded":this._onImageAdded=t;break;case"ImageUpdated":this._onImageUpdated=t;break;case"ImageRemoved":this._onImageRemoved=t;break;case"HitTestResultsReceived":this._onReceiveHitTestResult=t;break;case"CenterHitTestResultsReceived":this._onReceiveCenterHitTestResult=t;break;case"WorldMapReceived":this._onReceiveWorldMap=t;break;default:console.log("error")}},setDrawPlanes:function(e){if(this._drawPlanes=e.plane,this._drawPlaneBoundaries=e.planeBoundary,this._drawPlaneMeshes=e.planeMesh,this._context){var t=this._context.planeBag;if(t){for(var i in t){var n=t[i];if(this._drawPlanes||this._drawPlaneBoundaries||this._drawPlaneMeshes)this._updatePlaneModel(n);else{var o=this._nodeManager.getCenterPlaneNode(n.anchor.getName()),a=this._nodeManager.getAnchorPlaneNode(n.anchor.getName()),r=o.getChildByName("planeModel");r&&o.removeChild(r);var s=a.getChildByName("boundaryModel");s&&a.removeChild(s),a.getChildByName("meshModel")&&a.removeChild("meshModel")}}0==this._drawPlanes&&0==this._drawPlaneBoundaries&&0==this._drawPlaneMeshes?this._nodeManager._planeBag.setVisibility(!1):this._nodeManager._planeBag.setVisibility(!0)}}},setPlaneDetection:function(e){this._detectionMode={Horizontal:e.Horizontal,Vertical:e.Vertical,BoundaryMesh:e.BoundaryMesh,Mesh:e.Mesh},window.nsWebViewInterface&&window.nsWebViewInterface.emit("sendToNative",{setPlaneDetection:e})},setImageDetection:function(e){if(e.imageData){var t=e.imageData.external&&e.imageData.imagesArray;(t=t||!e.imageData.external&&e.imageData.imagesPath)&&(this._detectionImageData=e.imageData)}this._detectionPlane={Horizontal:e.Horizontal,Vertical:e.Vertical,BoundaryMesh:e.BoundaryMesh,Mesh:e.Mesh},window.nsWebViewInterface&&window.nsWebViewInterface.emit("sendToNative",{setImageDetection:{imageDectionData:this._detectionImageData}})},setPointCloudVisibility:function(e){if(window.nsWebViewInterface&&this._showPointCloud!=e){if(this._showPointCloud=e,this._viewer.displayPoints(e),!1===this._showPointCloud){var t=this._viewer.getRootNode(),i=t.getChildByName("PointCloudBag");null!==i&&t.removeChild(i)}window.nsWebViewInterface.emit("sendToNative",{setPointCloudVisibility:e})}},hitTest:function(e){var t={x:e.point2D.x,y:e.point2D.y};if(e.positionInPixel){var i=(this._viewer.canvas.height*this._videoRatio-this._viewer.canvas.width)/2;t.x=(e.point2D.x*window.devicePixelRatio+i)/(this._viewer.canvas.height*this._videoRatio),t.y=e.point2D.y*window.devicePixelRatio/this._viewer.canvas.height}null!=window.nsWebViewInterface&&window.nsWebViewInterface.emit("sendToNative",{hitTest:{x:t.x,y:t.y,IsHitFeaturePoint:e.IsHitFeaturePoint,IsHitEstimatedHorPlane:e.IsHitEstimatedHorPlane,IsHitEstimatedVerPlane:e.IsHitEstimatedVerPlane,IsHitExistingPlane:e.IsHitExistingPlane,IsHitExistingPlaneUsingExtent:e.IsHitExistingPlaneUsingExtent,IsHitExistingPlaneUsingGeometry:e.IsHitExistingPlaneUsingGeometry}})},activateHitTestCenterScreen:function(e){null!=window.nsWebViewInterface&&window.nsWebViewInterface.emit("sendToNative",{activateCenterHitTest:{target:e.target,alignment:e.alignment}})},deactivateHitTestCenterScreen:function(){null!=window.nsWebViewInterface&&window.nsWebViewInterface.emit("sendToNative",{deactivateCenterHitTest:!0})},addAnchor:function(e){var i="ID-"+this.anchorsIdCounter_++,n=e.decompose(),o=[n[0].x,n[0].y,n[0].z],a=[n[1].x,n[1].y,n[1].z,n[1].w];t.createPointAnchor(this._context,{identifier:i});var r=this._updateSUIPointAnchor({identifier:i,pointPosition:o,pointOrientation:a});if(this._nodeManager.addPoint(r),null==window.nsWebViewInterface)return r;var s=Array.from(e.elements);return(e=>{if(e&&16===e.length)f.elements=Array.from(e),m.multiplyMatrices(g,f),m.multiply(w),m.elements[12]*=.001,m.elements[13]*=.001,m.elements[14]*=.001,Object.assign(e,m.elements)})(s),window.nsWebViewInterface.emit("sendToNative",{addAnchor:{id:i,matrix:s}}),r},removeAnchor:function(e){null!=window.nsWebViewInterface&&window.nsWebViewInterface.emit("sendToNative",{removeAnchor:{id:e}})},hitJSPlane:function(e){var t=this._trackingViewpoint.create3DRayFrom2DPoint(e.point2D);t.direction.normalize();var i=[],n=this._context.planeBag;for(var o in n){var a=n[o],r=this._planeIsHit(a,t,e.infinitePlane);if(r.hit){var s=0;if(i.length>0)for(s=0;s<i.length&&!(r.intersection.z>i[s].info.intersection.z);++s);i.splice(s,0,{suiPlane:a,info:r})}}return i},requestCameraOnNextFrame:function(){null!=window.nsWebViewInterface&&window.nsWebViewInterface.emit("sendToNative",{requestCameraNextFrame:!0})},getNodeManager:function(){return this._nodeManager},_getRootNodeManager:function(e){if(this._nodeManager)return this._nodeManager.getRoot()},getContext:function(){return this._context},updateNodeManagerData:function(){if(this._nodeManager){if(this._context.planeBag)for(var e in this._context.planeBag){var t=this._context.planeBag[e];this._nodeManager.updatePlane(t)}if(this._context.pointBag)for(var i in this._context.pointBag){var n=this._context.pointBag[i];this._nodeManager.updatePoint(n)}if(this._context.imageBag)for(var o in this._context.imageBag){var a=this._context.imageBag[o];this._nodeManager.updateImage(a)}}},moveContext:function(e){if(this._context){if(e.matrix instanceof o.Matrix4){var t=e.matrix.decompose();this._context.setPosition(t[0]),this._context.setOrientation(t[1])}else if(e.position instanceof o.Vector3&&e.orientation instanceof o.Quaternion)this._context.setPosition(e.position),this._context.setOrientation(e.orientation);else if(e.rootAnchor&&e.rootAnchor.getPhysicalLocalMatrix){var i=e.rootAnchor.getPhysicalLocalMatrix();i.getInverse(i);t=i.decompose();this._context.setPosition(t[0]),this._context.setOrientation(t[1])}this.updateNodeManagerData()}},resetContextAndUser:function(){var e=new o.Vector3,t=new o.Quaternion;this._context.setPosition(e),this._context.setOrientation(t),this._context.getUser().setPosition(e),this._context.getUser().setOrientation(t),this.updateNodeManagerData()},updateViewer:function(e){for(var t in e&&(this._viewer=e),this._configureViewer(),this._nodeManager=new n(this._viewer),this._context.planeBag){var i=this._context.planeBag[t];this._nodeManager.addPlane(i)}for(var o in this._context.pointBag){var a=this._context.pointBag[o];this._nodeManager.addPoint(a)}},saveWorldMap:function(){"Mapped"===this._worldMappingStatus&&window.nsWebViewInterface?window.nsWebViewInterface.emit("sendToNative",{saveWorldMap:!0}):console.log("world mapping status is "+this._worldMappingStatus)},loadWorldMap:function(){this._loadWorldMap=!0,null!=window.nsWebViewInterface&&window.nsWebViewInterface.emit("sendToNative",{loadWorldMap:!0})},getWorldMap:function(){null!=window.nsWebViewInterface&&window.nsWebViewInterface.emit("sendToNative",{getWorldMap:!0})},setFrameImageCaptureParameter:function(e){null!=window.nsWebViewInterface&&window.nsWebViewInterface.emit("sendToNative",{setFrameImageCaptureParameter:{compressionFactor:e.compressionFactor,scaleFactor:e.scaleFactor}})},pauseTracking:function(){this._headTracking=!1},resumeTracking:function(){this._headTracking=!0}})}),define("DS/SUI/HMDScenario",["UWA/Core","DS/Devices/DeviceFactory","DS/Devices/XRDevice","DS/SUI/SUIFactory","DS/SUI/Element","DS/Visualization/ThreeJS_DS","DS/Visualization/WebGLV6Viewer","DS/Visualization/Viewpoint","DS/Visualization/CameraSystem","DS/Visualization/Node3D","DS/VRModels/ControllerModel","DS/IVBehaviours/TeleportBehaviour","DS/CoreEvents/Events","DS/Visualization/WebGLV6Viewer","DS/IVBehaviours/PanelBehaviour","DS/IVBehaviours/ControllerManager","DS/3DXMTiles/OOCManager","DS/Selection/HSOManager","DS/Selection/CSOManager"],function(e,t,i,n,o,a,r,s,d,h,c,l,_,u,w,g,p,v,f){"use strict";return e.Class.extend({init:function(e,t){this._viewer=e,t&&!1!==t.useAccelerationStructure&&(this._oocManager=this._viewer._getOOCManager(),null===this._oocManager&&(this._oocManager=new p(this._viewer,{fullOOC:!1}))),this._controllerRetrieved=!1,this._vrNode=new h,this._viewer.renderer.gl.makeXRCompatible&&this._viewer.renderer.gl.makeXRCompatible();var i=this._viewer.renderer.gl.getContextAttributes();this._mirrorAttributesOn=i.antialias||i.preserveDrawingBuffer,this._context=n.createSUIModel(!0),this._device=null,this._controllers=[],this._trackingViewpoint=null,this._mirroring=!0,this._standingMode=!1,this._noFrameCount=0,this.onPreRender=function(){},this.sceneMin=null,this._cameraSystem=null,this._trackPosition=!0,this._oldProjectionType=null,this._oldAxisSystem=null,this._controllerModel=null,this._onControllerModelLoaded=null,this._controllerBehaviour=null,this._behaviourList=[],this._currentBhvIdx=-1,this._mirrorDiv=document.createElement("div");var o=document.createTextNode('View VR content in SteamVR option "Display VR View"');this._mirrorDiv.appendChild(o),this._mirrorDiv.style="background-color: rgb(0,0,0);background-color: rgba(0,0,0, 0.4);color: white;font-weight: bold;position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);z-index: 2;width: 80%;padding: 20px;text-align: center;",this._odt=!1,t&&t.odt&&(this._odt=t.odt),this._blurView=!1,this._multiviewer=!1,this.controllerManager=new g(this),_.publish({event:"/VR/onInitialized"})},getViewer:function(){return this._viewer},getContext:function(){return this._context},getControllers:function(){return this._controllers},setOnControllerModelLoaded:function(e){this._onControllerModelLoaded=e},setMirroring:function(e){this._mirroring=e,this._device&&(this._device._mirroring=e)},setSceneMin:function(e){this.sceneMin=e},setStanding:function(e){var t=this._device.hasStandingMatrix();e=e&&t,this._standingMode!==e&&this._updateSUIUser(e),this._standingMode=e},addHook:function(e){if(e.position&&orientation){var t=new a.Vector3(1,1,1),i=(new a.Matrix4).compose(position,orientation,t);return this._hooks.push(i),this._hooks.length-1}return e.pose?(this._hooks.push(e.pose),this._hooks.length-1):-1},goToHook:function(e){this.getContext();var t=this._hooks[e].decompose();this._context.setPosition(t[0]),this._setContextUp(t[1])},enterVRMode:function(){if(this._device){this._standingMode&&this._setStandingContext();var e=this._viewer.canvas;if(e){window.devicePixelRatio=1;var t=this._device.width,i=this._device.height;t&&i&&(e.width=t,e.height=i);return this._device.beginRender([{source:e,leftBounds:[0,0,.5,1],rightBound:[.5,0,0,1]}])}}},_configureContext:function(){if(this._viewer){var e=this._viewer.currentViewpoint,t=e.getEyePosition();t.z=0,this._context.setPosition(t);var i=(new a.Quaternion).copy(e.getControl().orientation);this._setContextUp(i)}},_setStandingContext:function(){this._context.setPositionZ(this.sceneMin)},_setContextUp:function(e){var t=new a.Vector3(0,1,0).applyQuaternion(e),i=new a.Vector3(0,0,1),n=i.angleTo(t),o=(new a.Vector3).crossVectors(i,t).normalize(),r=(new a.Quaternion).setFromAxisAngle(o,-n);r.multiply(e),this._context.setOrientation(r)},_updateSUIUser:function(e,t,i){var n=this._context.getUser();if(e){var o=this._device.getSittingToStanding().decompose();o[0].multiplyScalar(1e3),n.setPosition(o[0]),n.setOrientation(o[1])}else!e&&t&&i?(n.setPosition(t),n.setOrientation(i)):(n.setPosition(new a.Vector3),n.setOrientation(new a.Quaternion))},_animate:function(){this.onPreRender(),this._viewer.render(),this._viewer.animate(),this._device?this._device instanceof i&&window.requestAnimationFrame(this._xrAnimate.bind(this)):window.requestAnimationFrame(this._animate.bind(this))},_xrAnimate:function(e,t){if(this._lastAnimationFrameTreated=e,this._device)if((t||this._odt)&&this._xrUpdate(t),this.onPreRender(),this._viewer.render(),this._viewer.animate(),this._device._isImmersive&&!t){var i=this._viewer.renderer.gl||this._viewer.canvas.getContext("webgl",{xrCompatible:!0});i.clear(i.DEPTH_BUFFER_BIT|i.COLOR_BUFFER_BIT|i.STENCIL_BUFFER_BIT);var n=new XRWebGLLayer(this._device._session,i);this._device._session.updateRenderState({baseLayer:n}),this._device._session.requestAnimationFrame(this._xrAnimate.bind(this))}else if(this._device._isImmersive&&t){this._device._session.requestAnimationFrame(this._xrAnimate.bind(this)),this._device._frameData=t,this._animationFrameTreated=!1}else window.requestAnimationFrame(this._xrAnimate.bind(this))},_xrComputeStereoCameras:function(e,t,i){if(null!==this._device){t=Math.min(100,t),i=Math.max(1e5,i);var n=e.camera.clone(),o=e.camera.clone(),a=this._context.getUser(),r=a.head.leftEye,s=a.head.rightEye,d=r.getVirtualGlobalMatrix().decompose(),h=s.getVirtualGlobalMatrix().decompose();if(n.position.copy(d[0]),o.position.copy(h[0]),n.quaternion.copy(d[1]),o.quaternion.copy(h[1]),n.updateMatrixWorld(),o.updateMatrixWorld(),n.near=t,n.far=i,o.near=t,o.far=i,!this._device._isImmersive||!this._device._pose)return[n,o];var c=this._device._pose;for(var l of c.views)if("left"===l.eye){for(var _=0;_<16;++_)n.projectionMatrix.elements[_]=10===_?-(i+t)/(i-t):14===_?-2*i*t/(i-t):l.projectionMatrix[_];n.externalProjectionMatrix=!0}else if("right"===l.eye){for(_=0;_<16;++_)o.projectionMatrix.elements[_]=10===_?-(i+t)/(i-t):14===_?-2*i*t/(i-t):l.projectionMatrix[_];o.externalProjectionMatrix=!0}}return[n,o]},_configureViewer:function(e){if(!0===this._viewer.multiViewer){this._normalViewer=this._viewer;var t=document.createElement("div");this._normalViewer.div.parentNode.appendChild(t);var n={div:t,multiViewer:!0,antiAliasing:!0,useShadowMap:!0,infinitePlane:!0,displayGrid:!0,master:this._normalViewer};this._viewer=new u(n);var o=new s(this._viewer);this._viewer.addViewpoint(o),this._viewer.internalSceneGraph=this._normalViewer.internalSceneGraph;var a=this;this._viewer.onPostRender(function(){a._normalViewer.render()}),o.reframe(),this._multiviewer=!0}if(this._viewer.defaultAnimationLoop=!1,this._viewer.useOffscreenCanvas=!0,this._viewer.setReferenceAxisSystem(!1),this._oocManager&&this._oocManager.setUsePickingAccelerationStructure(!0),e){if(v._items)for(;v._items.length>0;)v.remove(v._items[0]);if(f._items)for(;f._items.length>0;)f.remove(f._items[0])}(window.requestAnimationFrame(this._animate.bind(this)),this._trackingViewpoint=new s({viewer:this._viewer,projectionType:s.PERSPECTIVE}),this._viewer.setTrackingViewpoint(this._trackingViewpoint),this._oldProjectionType=this._viewer.currentViewpoint.getProjectionType(),this._oldAxisSystem=this._viewer.getReferenceAxisSystemNode().isVisible(),this._viewer.currentViewpoint.setProjectionType(s.PERSPECTIVE),this._viewer)&&(this._viewer.currentViewpoint.onMove(null),this._cameraSystem=new d,this._device instanceof i&&this._cameraSystem.setComputeCameraArrayCB(this._xrComputeStereoCameras.bind(this),!0),this._cameraSystem.setUsePredefinedCombineShader("leftRight"),this._viewer.setCameraSystem(this._cameraSystem))},_configureController:function(){this._controllerBehaviour&&this._controllerBehaviour.activate(this),this.reportConnectedControllers()},reportConnectedControllers:function(){for(var e in this._controllers){var t=this._controllers[e];_.publish({event:"/VR/onControllerConnect",data:t})}},restoreViewer:function(){if(this._viewer){if(this._blurView&&!this._multiviewer&&!window.skipBlurForEmulator)this._viewer.canvas.style.filter="",this._mirrorDiv.parentNode&&this._mirrorDiv.parentNode.removeChild(this._mirrorDiv),this._blurView=!1;if(!this._viewer.getViewpoints().length)return;if(this._viewer.currentViewpoint.onMove(this._viewer.render),this._cameraSystem.setExternalFrameBuffer(null),this._viewer.setCameraSystem(null),this._viewer.setTrackingViewpoint(null),this._viewer.currentViewpoint.setProjectionType(this._oldProjectionType),this._viewer.setReferenceAxisSystem(this._oldAxisSystem),this._viewer._updateShadowMaps(),this._viewer.defaultAnimationLoop=!0,this._multiviewer){var e=this._viewer.div;e.parentNode.removeChild(e),this._viewer=this._normalViewer,this._multiviewer=!1}else window.requestAnimationFrame(this._viewer.animate)}},_xrUpdate:function(e){var t=this._device._session.renderState.baseLayer;if(t&&null===this._cameraSystem._extFrameBuffer){var i=t.framebuffer;if(this._cameraSystem.setExternalFrameBuffer(i),!this._blurView&&!this._multiviewer&&!window.skipBlurForEmulator)(o=this._viewer.canvas).style.filter="blur(10px)",o.parentNode.appendChild(this._mirrorDiv),this._blurView=!0}if(e){var n=e.getViewerPose(this._device._refSpace);if(n){var o,a=0,r=0;for(var s of n.views){var d=t.getViewport(s);a+=d.width,r=d.height}if(!(o=this._viewer.canvas))return;window.devicePixelRatio=1,o.width=a,o.height=r}var h=e.session;this._parseControllers(h.inputSources,e),this._device.update(this._trackPosition,n)}else this._odt&&this._parseControllers(navigator.getGamepads());this._updateSUIHead(),this._updateTrackingViewpoint()},_parseControllers:function(e,i){var n=0;for(var o of e)if(o&&o.gamepad){if(++n>this._controllers.length){1===n?o.gamepad.hand="left":2===n&&(o.gamepad.hand="right");var a=t.createController(o.gamepad,n-1);if(a){this._controllers.push(a),this._controllerModel||(this._controllerModel=new c({controllerType:o.profiles[0],callback:this._onControllerModelLoaded}));var r=a.getNode();r.getChildByName("ControllerModel")||(r.addChild(this._controllerModel.getNode()),this._vrNode.addChild(r))}_.publish({event:"/VR/onControllerConnect",data:a})}var s,d=this._controllers[n-1];s=this._odt?o.gamepad.pose:i.getPose(o.targetRaySpace,this._device._refSpace),d.update(o.gamepad,s),this._updateSUIHand(d)}if(n<this._controllers.length)for(var h=this._controllers.length-1;h>=n;--h){var l=this._controllers[h].getNode();this._vrNode.removeChild(l),this._controllers.splice(h,1),_.publish({event:"/VR/onControllerDisconnect"})}},_updateSUIHead:function(){var e=this._context.getUser().head;e.setPosition(this._device.getPosition()),e.setOrientation(this._device.getOrientation())},_updateSUIHand:function(e){var t,i=this._context.getUser();if("left"===e._hand?t=i.leftHand:"right"===e._hand&&(t=i.rightHand),t){t.setPosition(e._position),t.setOrientation(e._orientation);var n=e.getNode();n&&n.setMatrix(t.getVirtualGlobalMatrix())}},_updateTrackingViewpoint:function(){var e=this._context.getUser().head.getVirtualGlobalMatrix().decompose();this._trackingViewpoint.moveTo({eyePosition:e[0],orientation:e[1]})},activate:function(e){e&&e.activateTeleport?this._controllerBehaviour=new l:e&&e.defaultBehaviour&&(this._controllerBehaviour=e.defaultBehaviour),this._viewer.addNode(this._vrNode);var i=this;return t.createHMD(this._odt).then(function(t){var o;(i._device=t,n.configureContextHead(i._context,t),i._configureContext(),e&&(e.hookPose||e.hookPosition&&e.hookOrientation))&&(e.hookPose?o=this.addHook({pose:e.hookPose}):e.hookPosition&&e.hookOrientation&&(o=this.addHook({position:e.hookPosition,orientation:e.hookOrientation})),-1!==o&&this.goToHook(o));e&&e.clearSelection?i._configureViewer(e.clearSelection):i._configureViewer(),i._configureController(),_.publish({event:"/VR/onHMDActivate"})},function(e){_.publish({event:"/VR/onHMDConnectionError",data:e}),i.deactivate()})},deactivate:function(){_.publish({event:"/VR/preHMDDeactivate"}),this._viewer.removeNode(this._vrNode);var e=this;this._device.endRender().then(function(){e._lastAnimationFrameTreated=null;for(var t=e._controllers.length,i=0;i<t;++i){var n=e._controllers[i],o=n.getNode();e._vrNode.removeChild(o),n=null}e._controllers=[],e._standingMode=!1,e._mirroring=!0,e.restoreViewer(),e._device=null,_.publish({event:"/VR/onHMDDeactivate"})})},resetHMD:function(){this._standingMode||this._updateSUIUser(!1,this._device.getPosition().negate(),this._device.getOrientation().inverse())},setOnPreRender:function(e){this.onPreRender=e},setPositionTracking:function(e){this._trackPosition=e}})});