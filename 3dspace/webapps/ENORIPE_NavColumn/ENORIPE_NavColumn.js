/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/ENORIPE_NavColumn/NavWSProxy",["UWA/Core","DS/WAFData/WAFData","DS/PADUtils/PADUtilsServices","UWA/Promise","DS/ENORIPE_Relations/RelationsTabSettings"],function(e,t,n,i,o){var r=function(e,n,o){return new i(function(i,r){n.onComplete=function(e){var t=function(e){return"string"==typeof e?JSON.parse(e):e}(e),n=t;o&&(n=o(t)),i(n)},n.onFailure=function(e){r(e)},n.data&&(n.data=JSON.stringify(n.data)),function(e,n,i){t.authenticatedRequest(e,n)}(e,n)})};return{getrelationprofiles:function(e,t){var i=n.get3DSpaceUrl(),o={};return i=i+"/resources/enorelnav/navigate/getProfiles?tenant="+n.getPlatformId(),o.method="POST",o.headers={Accept:"application/json","Content-Type":"application/json"},o.data={widgetId:n.getWidgetId(),roles:e,profileVersion:2},r(i,o,!1)},getRelationSettings:function(e,t){var i=n.get3DSpaceUrl(),o={};return i=i+"/resources/enorelcc/cc_services/getrelsettings?tenant="+n.getPlatformId(),o.method="GET",o.headers={Accept:"application/json","Content-Type":"application/json"},r(i,o,!1)},setpreferences:function(e){var t=n.get3DSpaceUrl(),i={};t=t+"/resources/enorelnav/navigate/setpreferences?tenant="+n.getPlatformId(),i.method="POST",i.headers={Accept:"application/json","Content-Type":"application/json"};var a=[];return a=(a=(a=a.concat(o.getOption("displayNameAttributes"))).concat(o.getOption("detailAttributesLevel1"))).concat(o.getOption("detailAttributesLevel2")),i.data={widgetId:n.getWidgetId(),relations:e,attributes_for_detailview:a,countmanagement:!0},r(t,i)},getDetail:function(e){var t=n.get3DSpaceUrl(),i={};t=t+"/resources/enorelnav/navigate/getecosystem?tenant="+n.getPlatformId(),i.method="POST",i.headers={Accept:"application/json","Content-Type":"application/json"};var o=n.getWidgetId();return i.data={widgetId:o,ids:e,debug:!1},r(t,i)},getRelationCount:function(e){var t=n.get3DSpaceUrl(),i={};t=t+"/resources/enorelnav/navigate/getrelationcount?tenant="+n.getPlatformId(),i.method="POST",i.headers={Accept:"application/json","Content-Type":"application/json"};var o=n.getWidgetId();return i.data={widgetId:o,ids:e.ids,relations:e.relations},r(t,i)},getMergedProfiles:function(e,t,n){var o=this,r=!1;return new i(function(i,a){t.relation_sets&&t.relation_sets.length||i(e);e.profiles.map(function(e){return e.name});for(var s=0;s<t.relation_sets.length;s++){for(var l=t.relation_sets[s].roles,u=t.relation_sets[s].userGroups,c=!1,d=0;d<l.length;d++)if(n.indexOf(l[d])>-1){c=!0;break}if(u.length>0&&!c){r=!0;break}}r?o._getGrantedUsrGrp().then(function(r){r=o._parseUserGroups(r),e=o._filterRelSets(e,t,r,n),i(e)}):(e=o._filterRelSets(e,t,[],n),i(e))})},getAllProfilesAndSettings:function(e){var t=this,n=this.getrelationprofiles(e),o=this.getRelationSettings();return new i(function(r,a){i.all([n,o]).then(function(n){var i=n[0],o=n[1];t._parseSettings(o).then(function(n){t.getMergedProfiles(i,n,e).then(function(e){r([e,n])})}).catch(()=>{r()})}).catch(()=>{r()})})},getAppId:function(){return n.getAppId()},getUserID:function(){return n.getUserLogin()},_parseSettings:function(e){var t=this;return new i(function(n,i){e.notexist||void 0===e.relation_apps?t._getResetRelApps().then(function(t){n(e=t)}):n(e)})},_getResetRelApps:function(){var e=n.get3DSpaceUrl(),t={};return e=e+"/resources/enorelcc/cc_services/getrelappsinit?tenant="+n.getPlatformId(),t.method="GET",t.headers={Accept:"application/json","Content-Type":"application/json"},r(e,t,!1)},_getGrantedUsrGrp:function(){var e=n.get3DSearchUrl()+"/search",t={},i=n.getUserLogin()||"";return t.method="POST",t.headers={Accept:"application/json","Content-Type":"application/json"},t.data={label:"ENORIPE_"+i+"_"+Date.now(),select_predicate:["ds6w:label"],query:"[ds6w:type]:GROUP AND "+i,tenant:n.getPlatformId(),nresults:100,with_synthesis_attribute:!1,with_synthesis:!1},r(e,t,!1)},_parseUserGroups:function(e){var t=[];if(e&&e.results)for(var n=0;n<e.results.length;n++){var i=e.results[n];if(i.attributes){for(var o={},r=0;r<i.attributes.length;r++)"resourceid"===i.attributes[r].name&&(o.resourceid=i.attributes[r].value),"ds6w:label"===i.attributes[r].name&&(o.label=i.attributes[r].value);void 0!==o.resourceid&&t.push(o)}}return t},_filterRelSets:function(e,t,n,i){for(var o=e.profiles.map(function(e){return e.name}),r=(n=n.map(function(e){return e.resourceid}),0);r<t.relation_sets.length;r++){var a=t.relation_sets[r].roles,s=t.relation_sets[r].userGroups,l=!1;a&&a.length>0&&(a=a.map(function(e){return e.name})),s&&s.length>0&&(s=s.map(function(e){return e.name}));for(var u=0;u<a.length;u++)if(i.indexOf(a[u])>-1){l=!0;break}if(!l)for(u=0;u<s.length;u++)if(n.indexOf(s[u])>-1){l=!0;break}var c=o.indexOf(t.relation_sets[r].name);l?-1===c?e.profiles.push(t.relation_sets[r]):e.profiles.splice(c,1,t.relation_sets[r]):-1!==c&&e.profiles.splice(c,1)}return e}}}),define("DS/ENORIPE_NavColumn/RelationProfiles",["DS/ENORIPE_NavColumn/NavWSProxy","DS/CoreEvents/ModelEvents","DS/PlatformAPI/PlatformAPI","i18n!DS/ENORIPE_Relations/assets/nls/Relations"],function(e,t,n,i){return{fetchandStoreProfiles:function(t,n){var i=this;e.getAllProfilesAndSettings(t).then(function(e){if(Array.isArray(e)&&2===e.length){var t=e[0];i._settings=e[1];var o=i._getRelationsSet();if(o)for(var r=0;r<o.length;r++)t.profiles.splice(r+1,0,o[r]);i.storeProfiles(t.profiles)}"function"==typeof n&&n()})},storeProfiles:function(t){var n=this._fetchLastStoredProfile(),o="Designer",r={name:"AutoModeProfile"},a=e.getAppId();r.relations=[],t.unshift(r),this._settings&&this._settings.relation_apps&&this._settings.relation_apps[a]&&(o=this._settings.relation_apps[a]),this._profiles=t,this._profileNames=[];for(var s=!1,l=0;l<this._profiles.length;l++){var u=this._profiles[l];n&&n===u.name&&(this.setCurrentProfile(u.name),s=!0),this._profileNames.push(u.name),u.nlsLabel&&(i[u.name]=u.nlsLabel)}if(!s&&this._profileNames.length){var c=!1;for(l=0;l<this._profileNames.length;l++)if(this._profileNames[l]===o){this.setCurrentProfile(this._profileNames[l]),c=!0;break}!1===c&&this.setCurrentProfile(this._profileNames[0])}},getProfileNames:function(){return this._profileNames},getNlsForProfileNames:function(e){for(var t=[],n=0;this._profileNames&&n<this._profileNames.length;n++){var o=this._profileNames[n],r=i[o]||o;t.push({name:o,nls:r})}return t},getNlsForMenu:function(){return i["Manage-Relations"]},setCurrentProfile:function(e){this._currentProfile===e&&void 0!==this._currentProfile||(this._currentProfile=e,this.publish("CurrentProfileChanged"))},getCurrentProfile:function(){return this._currentProfile},getCurrentProfileNls:function(){return i[this._currentProfile]||this._currentProfile},getCurrentProfileRelations:function(){relations=[];for(var e=this._getCurrentProfileData(),t=0;e&&t<e.relations.length;t++){var n=e.relations[t];relations.push(n.name)}return relations},publish:function(e){this._ensureModelEvents(),this._modelEvents.publish({event:e})},subscribe:function(e,t){return this._ensureModelEvents(),this._modelEvents.subscribe({event:e},t)},_getCurrentProfileData:function(){for(var e=0;this._profiles&&e<this._profiles.length;e++){var t=this._profiles[e];if(t.name===this._currentProfile)return t}return null},_ensureModelEvents:function(){this._modelEvents||(this._modelEvents=new t)},_getRelationsSet:function(){var e=localStorage.getItem(this.getUserID()+"_ENORIPE_CustomRelationsSet");if(e)return JSON.parse(e)},getUserID:function(){return e.getUserID()||""},_fetchLastStoredProfile:function(){var t,n="LastUsedProfile-"+e.getAppId();return"undefined"!=typeof widget&&null!==widget&&(t=widget.getValue(n)),t||(t=localStorage.getItem(n)),t}}}),define("DS/ENORIPE_NavColumn/AdditionalColumns",["css!DS/ENORIPE_NavColumn/ENORIPE_NavColumn","i18n!DS/ENORIPE_NavColumn/assets/nls/ENORIPE_NavColumn.json","UWA/Core","UWA/Class","DS/PADUtils/PADContext","DS/ENORIPE_NavColumn/RelationProfiles","DS/ENORIPE_NavColumn/NavWSProxy","DS/Utilities/Dom","DS/ENORIPE_Relations/RelationsTabSettings","DS/PADUtils/PADUtilsServices"],function(e,t,n,i,o,r,a,s,l,u){"use strict";function c(e,t,n){e[t]?e[t].hasNONPS+=n:e[t]={hasNONPS:n}}return i.singleton({_columnDataIndex:["hasNONPS"],_columnDef:{hasNONPS:{dataIndex:"hasNONPS",text:t.hasNONPS,isDraggable:!0,width:50,minWidth:50,isHidden:!0,onCellRequest:function(e){if(!1===e.manager.getColumnOptions("hasNONPS").isHidden)if(e.isHeader){var n=t.hasNONPS+"["+r.getCurrentProfileNls()+"]";e.model.setCellContent(n),e.cellView.getContent().setHTML(n),e.cellView._updateToolTip()}else{var i=e.nodeModel.options.grid.hasNONPS;if(void 0!==i&&""!==i){i>0?e.cellView.reuseCellContent("padCheck"):e.cellView.getContent().setContent(" ")}else e.cellView.reuseCellContent("padLoaderCol")}},xnav_options:{dataIndex:"hasNONPS",exportable:{lock:!1,value:!0},layout:{hidden:!0,width:50}}}},_columnDefDGV:{hasNONPS:{dataIndex:"hasNONPS",alignmentValue:"center",editableFlag:!1,sortableFlag:!1,width:50,minWidth:50,visibleFlag:!1,isAdditionalColumn:!0,getCellTypeRepresentation:function(e){if(e.nodeModel){if(!0===e.nodeModel.isRelationsObjectNode)return"relationNone";var t=e.nodeModel.options.grid.hasNONPS;return void 0!==t&&""!==t?t>0?"relationCheck":"relationNone":"relationLoading"}},getCellSemantics:function(e){if(e.nodeModel){var t=e.nodeModel.options.grid.hasNONPS;if(void 0===t||""===t||0===t)return{disabled:!0}}},getCellValueForExport:function(e){var n="";return-1===e.rowID?n=t.hasNONPS+"["+r.getCurrentProfileNls()+"]":e&&e.nodeModel&&e.nodeModel.options.grid&&e.nodeModel.options.grid.hasNONPS&&(n=""+e.nodeModel.options.grid.hasNONPS),n},customisation:{dataIndex:"hasNONPS",exportable:{lock:!1,value:!1},layout:{removable:!1}}}},init:function(e){this._parent(e);r.subscribe("CurrentProfileChanged",function(e){function n(e){e.options&&e.options.grid&&(e.options.grid.hasNONPS=0)}var i=o.get();if(i){for(var a=i.getPADTreeDocument().getRoots(),s=0;s<a.length;s++){var u=a[s];n(u),u.processDescendants({processNode:n})}var c=i.getPADTreeListView();if(c&&c._datagrid){var d=c.getManager();d.isColumnHidden("hasNONPS")||(d.hideColumn("hasNONPS"),d.showColumn("hasNONPS"))}else{var f=i.options.views?i.options.views.datagridview:void 0;f&&(f.isColumnHidden("hasNONPS")||(f.changeColumnTitle("hasNONPS",t.hasNONPS+"["+r.getCurrentProfileNls()+"]"),f.hideColumn("hasNONPS"),f.showColumn("hasNONPS")))}l.setProfile(r.getCurrentProfile())}else l.setInitProfile(r.getCurrentProfile())})},isAdditionalColumnsAvailable:function(e){if("function"!=typeof e)throw new Error("A callback function should be defined");var t={getPlatformID:function(){return u.getPlatformId()},getServiceID:function(){return"3DSpace"}};l.isAvailable(t,{isDraggable:!0}).then(function(t){"object"==typeof t?u.app_initialization(function(){r.fetchandStoreProfiles(t.roles,function(){e(!0)})}):e(!1)},function(){e(!1)})},getName:function(){return"ENORIPE_NavColumn"},_getColumnName:function(){return t.hasNONPS+"["+r.getCurrentProfileNls()+"]"},getManagedColumnNames:function(){return this._columnDataIndex},toBeUpdated:function(e){return!0},updateAttributes:function(e,t){if("object"!=typeof e)throw new Error("The object ids to modify must be specify");if("function"!=typeof t)throw new Error("A callback function should be defined");var n={pids:{},relids:{}};e.pids.forEach(function(e){n.pids[e]={hasNONPS:void 0}});var i=r.getCurrentProfileRelations();a.getRelationCount({relations:i,ids:e.pids}).then(function(i){e.pids.forEach(function(e){n.pids[e]={hasNONPS:0}});for(var o=i.New&&i.New.Counts?i.New.Counts:[],r=0;r<o.length;r++){var a=o[r];-1!==e.pids.indexOf(a.source)&&c(n.pids,a.source,parseInt(a.count))}t(n)}).catch(function(i){console.error(i),e.pids.forEach(function(e){n.pids[e]={hasNONPS:0}}),t(n)})},getAdditionalColumnsUX:function(e){for(var i=[],o=0;o<e.length;o++)i.push(e[o].dataIndex);for(var r=0;r<this._columnDataIndex.length;r++){var a=this._columnDataIndex[r],s=n.clone(this._columnDef[a]),l=i.indexOf(a);-1===l?e.push(s):(e[l]=n.extend(s,e[l],!0),e[l].text=t[e[l].dataIndex])}},getAdditionalColumnsUXDGV:function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i].dataIndex);for(var o=0;o<this._columnDataIndex.length;o++){var r=this._columnDataIndex[o],a=n.clone(this._columnDefDGV[r]),s=t.indexOf(r);-1===s?(a.text=this._getColumnName(),e.push(a)):(e[s]=n.extend(e[s],a,!0),e[s].text=this._getColumnName())}},provideDisplayTooltip:function(e){var t=null;return e.nodeModel&&"hasNONPS"===e.dataIndex&&(t=e.nodeModel.options.grid.hasNONPS),t},registerReusableCellContent:function(e){e.getManager().registerReusableCellContent({id:"padCheck",buildContent:function(){return s.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-check"})}}),e.getManager().registerReusableCellContent({id:"padLoaderCol",buildContent:function(){return s.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-reload wux-ui-3ds-spin"})}})},getTypeRepresentations:function(){return{relationCheck:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"check",fontIconFamily:WUXManagedFontIcons.Font3DS}}},relationNone:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"",fontIconFamily:WUXManagedFontIcons.Font3DS}}},relationLoading:{stdTemplate:"functionIcon",semantics:{className:"relationRefresh",icon:{iconName:"reload wux-ui-3ds-spin",fontIconFamily:WUXManagedFontIcons.Font3DS}}}}},getOnCellClickCB:function(e){if(0===this._columnDataIndex.indexOf(e))return function(e){e.nodeModel&&(e.nodeModel.options.grid.hasNONPS>0&&require(["DS/ApplicationFrame/CommandsManager"],function(e){var t=e.getCommandCheckHeader("RightSidePanel");t&&(!1===t.getState()&&t.setState(!0,!1),t._propertiesWdg.selectFacet("relations"))}))}},getAdditionalCtxMenu:function(e){var t,n=!1;e.ctxParams.treeview?(n=e.ctxParams.treeview.isHeader,t=e.ctxParams.treeview.dataIndex):"datagridview"===e.view&&(n=-1===e.ctxParams.cellInfos.rowID,t=e.ctxParams.collectionView.getColumnOrGroup(e.ctxParams.cellInfos.columnID).dataIndex);var i=[];if(!0===n&&"hasNONPS"===t){i={type:"PushItem",title:r.getNlsForMenu(),fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-object-related-cog",family:WUXManagedFontIcons.Font3DS},submenu:[]};for(var o=r.getNlsForProfileNames(),a=0;a<o.length;a++){var s=o[a];i.submenu.push({type:"RadioItem",title:s.nls,state:r.getCurrentProfile()===s.name?"selected":"",action:{context:s.name,callback:function(e){r.setCurrentProfile(e.context)}}})}e.callback(r.getNlsForMenu(),i)}else e.callback(null)}})});