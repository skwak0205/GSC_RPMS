define("DS/VCXWebModifiablesServices/VCXModifiablesServices",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/VCXWebProperties/VCXProperty","DS/VCXWebProperties/VCXPropertyInfo","DS/VCXWebProperties/VCXPropertyValueLocation","DS/VCXWebProperties/VCXPropertyValueFrame","DS/VCXWebVisibility/VCXIVisibility"],function(e,t,r,a,n,o,i){"use strict";var l=e.singleton({init:function(){},isModifiable:function(e){var t=e.QueryInterface?e.QueryInterface("VCXIModifiable"):null;return e===t},buildPropertyLocationWithTranslationInWCS:function(e,r,a=null){if(this.isModifiable(e)&&r instanceof t.Vector3){var n,o=e.GetProperty("Actor.Position").GetPropertyValue(),i=e.QueryInterface("W3AISGNodeHolder").getPathElement().getParentPath().getWorldMatrix(e.GetObject()._experienceBase.getManager("VCXContextManager").getMainViewer()),l=(new t.Matrix4).getInverse(i);if(null==a)n=o.GetPivot().GetValue();else if(a instanceof t.Vector3){var s=(new t.Matrix4).setPosition(a);n=(new t.Matrix4).copy(l).multiply(s)}else a instanceof t.Matrix4?n=(new t.Matrix4).copy(l).multiply(a):(console.warn("Pivot specified not compatible, using modifiable's pivot as rotation pivot"),n=o.GetPivot().GetValue());for(var u=o.GetFrame().GetValue(),c=o.GetPivot().GetValue(),p=0;p<=11;++p)u.elements[p]=parseFloat(u.elements[p]);null!=a&&(c=n.clone());var f=(new t.Matrix4).extractRotation(l),P=(new t.Vector3).copy(r).applyMatrix4(f),y=(new t.Vector3).getPositionFromMatrix(u).add(P),d=(new t.Matrix4).copy(u).setPosition(y),V=(new t.Vector3).getPositionFromMatrix(c).add(P),g=(new t.Matrix4).copy(c).setPosition(V);return this.buildPropertyLocationWithFramePivot(d,g)}console.error("A VCXModifiable and a THREE.Vector3 objects are needed !")},buildPropertyLocationWithRotationInWCS:function(e,r,a){if(this.isModifiable(e)&&r instanceof t.Matrix4){var n,o=e.GetProperty("Actor.Position").GetPropertyValue(),i=e.QueryInterface("W3AISGNodeHolder").getPathElement().getParentPath().getWorldMatrix(e.GetObject()._experienceBase.getManager("VCXContextManager").getMainViewer()),l=(new t.Matrix4).getInverse(i);if(null==a)n=o.GetPivot().GetValue();else if(a instanceof t.Vector3){var s=(new t.Matrix4).setPosition(a);n=(new t.Matrix4).copy(l).multiply(s)}else a instanceof t.Matrix4?n=(new t.Matrix4).copy(l).multiply(a):(console.warn("Pivot specified not compatible, using modifiable's pivot as rotation pivot"),n=o.GetPivot().GetValue());var u=(new t.Matrix4).getInverse(n),c=(new t.Matrix4).copy(u).multiply(l),p=(new t.Matrix4).extractRotation(c),f=(new t.Matrix4).getInverse(p),P=o.GetFrame().GetValue(),y=o.GetPivot().GetValue();null!=a&&(y=n.clone());var d=(new t.Matrix4).copy(p).multiply(r).multiply(f),V=(new t.Matrix4).copy(n).multiply(d).multiply(u),g=(new t.Matrix4).copy(V).multiply(P),m=(new t.Matrix4).copy(V).multiply(y);return this.buildPropertyLocationWithFramePivot(g,m)}console.error("At least a VCXModifiableOccurrence and a THREE.Matrix4 objects are needed !")},buildPropertyLocationWithFramePivot:function(e,i){if(e instanceof t.Matrix4&&i instanceof t.Matrix4){var l=new o;l.SetValue(e);var s=new o;s.SetValue(i);var u=new n;return u.SetFrame(l),u.SetPivot(s),new r(new a("Actor.Position",0),u)}console.error("2 THREE.Matrix4 objects are needed as arguments..")},GetFrameInWCSAtTime:function(e,r,a,n,o){var i=r.GetObjectAnimation(a.GetHashing()),l=null,s=e.GetNeutrals(a.GetHashing());if(s)if(i&&i._Tracks&&i._Tracks["Actor.Position"]){var u=a.GetInterpolator("Actor.Position");null==u&&(u=e.GetDefaultInterpolator("Actor.Position")),l=u.GetInterpolatedValue(s,"Actor.Position",n,i._Tracks).GetFrame().GetValue()}else{var c=s.GetProperty("Actor.Position");l=c&&c.GetPropertyValue().GetFrame().GetValue()}l||(l=a.GetProperty("Actor.Position").GetPropertyValue().GetFrame().GetValue());var p=a.GetObject().QueryInterface("VCXIModelNavigable").getParent(),f=null;if(p&&(f=p.GetObject()),f){var P=f.QueryInterface("VCXIModifiable"),y=this.GetFrameInWCSAtTime(e,r,P,n);return(new t.Matrix4).copy(y).multiply(l)}return l},getDisplayPriority:function(e){var t=e.QueryInterface("VCXIVisibility");if(t&&t.GetVisibility()===i.EVisState.Hidden)return-10;if(e.GetObject().IsKindOf("VCXComponentHotspot")){var r=e.GetProperty("Actor.Enable");return r&&r.GetPropertyValue()&&r.GetPropertyValue().Value?10:-10}var a=e.GetProperty("Actor.Opacity");if(a&&a.GetPropertyValue()&&0===a.GetPropertyValue().Value)return-9;if(e.GetObject().IsDressup)return e.GetPropertyValue("Collab.3D.Paper.Positioning.Type")<=1e3?e.GetPropertyValue("Collab.3D.Paper.Is.Background")?1e-5*e.GetPropertyValue("Collab.3D.Paper.Depth")-5:7+1e-5*e.GetPropertyValue("Collab.3D.Paper.Depth"):e.GetPropertyValue("Actor.IsAlwaysOnTop")?5:0;var n=e.GetProperty("Actor.Priority");return n&&n.GetPropertyValue()?n.GetPropertyValue().Value:0},sortListDisplayPriority:function(e,t){return t.sort(function(t,r){var a=e.ComponentsMap.GetComponentFromID(t),n=e.ComponentsMap.GetComponentFromID(r);if(a&&n){var o=a.QueryInterface("VCXIModifiable"),i=n.QueryInterface("VCXIModifiable");if(o&&i){var s=l.getDisplayPriority(o);return l.getDisplayPriority(i)-s}}}),t},isModifiableUnderMouse:function(e,t){var r=e.GetObject()._experienceBase.getManager("VCXContextManager").getMainViewer(),a=e.GetProperty("Collab.3D.Paper.Positioning.Type");if(a&&a.GetPropertyValue().Value<=1e3){t.vcxPaperPos||(t.vcxPaperPos=e.GetObject()._experienceBase.getManager("VCXPaperManager").PixelToMM2(null,t.from[0].getCurrentPosition(r.canvas)));var n=e.GetObject().shapeInfo;if(n&&n.center&&Math.abs(e.GetPropertyValue("Collab.3D.Paper.Paper.Position.X")+n.center.x-t.vcxPaperPos.x)<.5*n.size.x&&Math.abs(e.GetPropertyValue("Collab.3D.Paper.Paper.Position.Y")+n.center.y-t.vcxPaperPos.y)<.5*n.size.y)return!0}return!1},hasVisibleProperties:function(e){var t=e.QueryInterface("VCXIModifiableView");if(t){var r=t.getPropertyGroups();for(var a in r||console.log("No propertyGroups found for component "+e.GetObject().GetType()+"."),r)if(r.hasOwnProperty(a))for(var n=r[a].getPropertiesIDsOrderedArray(),o=0;o<n.length;++o){var i=n[o];if(e.GetProperty(i).GetPropertyInfo().IsVisible())return!0}return!1}var l=e.GetObject().GetType();console.log("Component of type "+l+" doesn't have a modifiableView.")},filterChildrenOfModsFromArray:function(e){return Array.isArray(e)&&0!==e.length?e[0].QueryInterface("VCXIModifiable")!==e[0]?e:this.filterChildrenOfCompsFromArray(e):e},filterChildrenOfCompsFromArray:function(e){if(!Array.isArray(e)||0===e.length)return e;for(var t=e,r=t.map(function(e){var t=e.QueryInterface("W3AISGNodeHolder");return t&&t.getPathElement()}),a=0;a<r.length;++a){var n=r[a];if(n)for(var o=a+1;o<r.length;++o){var i=r[o];if(i)if(n.isAParentOf(i))r[o]=null,t[o]=null;else if(i.isAParentOf(n)){r[a]=null,t[a]=null;break}}}return t.filter(function(e){return null!==e})},getBBoxInWorldFromComponents:function(e){if(Array.isArray(e)&&0!==e.length){var r=e[0]._experienceBase.getManager("VCXContextManager"),a=r&&r.getMainViewer();if(a){for(var n=new t.Box3,o=0;o<e.length;++o){var i=e[o].QueryInterface("W3AISGNodeHolder"),l=i.getPathElement().getBoundingBox(null,a);l.isNaN()?console.log("VCXModifiablesServices#getBBoxInWorldFromComponents: The pathElement associated to component "+e[o].GetID()+" has an empty BoundingBox.\n It won't be considered in the requested union of bounding boxes."):(l.applyMatrix4(i.getWorldMatrix(a)),n.union(l))}return n}}}});return l}),define("DS/VCXWebModifiablesServices/VCXModifiablesAccess",["DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement"],function(e,t){"use strict";var r={getBestIdxElementCandidate:function(e){for(var t=e.length-1;t>0;t--)if(e[t].productType||e[t].worktype){if(e[t].productType&&("Instance3D"===e[t].productType||"VPMInstance"===e[t].productType)||e[t].worktype&&"VPMInstance"===e[t].worktype)return t+1}else if(e[t]._isDressupNode)return t+1},CleanPathElement:function(e){var t=[];if(e){for(var r=[],a=(t=e.externalPath).length,n=0;n<a;n++)r[n]=t[n];var o=this.getBestIdxElementCandidate(r);return null!==o&&o<r.length&&r.splice(o,r.length-o),r}console.log("Missing pathElement !")},BuildCleanedPathElement:function(e){return new t(this.CleanPathElement(e))},GetModifiableFromPathElement:function(e,t){if(!e||!e.externalPath||!e.externalPath.length)return null;var r,a=null;if(e.externalPath[0].handle)r=e.externalPath[0].handle&&e.externalPath[0].handle.manipulator&&e.externalPath[0].handle.manipulator.interactor&&e.externalPath[0].handle.manipulator.interactor.component;else if(e.getLastElement(!0).magnet){var n=e.getLastElement(!0).magnet;r=n&&n.measurable&&n.measurable.getHolder()&&n.measurable.getHolder().GetObject()}else{var o=this.CleanPathElement(e);r=t.ComponentsMap.GetComponentFromExternalPath(o)}if(r&&(a=r.QueryInterface("VCXIModifiable")),!a){var i=t.getManager("VCXContextManager");i&&i.getUrlVars().debug&&console.log("Can't find modifiable associated to path: ",e)}return a},ValuateLinkedProperties:function(e,t,r,a,n){for(var o=e,i="",l=/([^$]|^)\$\(([0-9a-z.|_-\s]*)#([0-9]*)#([0-9a-z._-]*)\)/i,s=o.match(l);s;){var u=s[0],c=s.index,p=u.length;c>0&&(i+=o.substring(0,c+1)),i+=s[1];var f=s[2];""===f&&(f=r),""!==f&&"0"!==f||(f=a);var P=parseInt(s[3]),y=s[4],d=t.ComponentsMap.GetComponentFromID(f);if(d){for(;P>0;){var V=d.QueryInterface("VCXIModelNavigable").getParent().GetObject();V?d=V:console.log("/! ValuateLinkedProperties: bad parent level"),P--}var g=d.QueryInterface("VCXIModifiable");if(g){var m=g.GetProperty(y);if(m){var b="";b=n?n(m,t):m.GetPropertyValue().ToString(),i+=b=this.ValuateLinkedProperties(b,t,f,a,n)}}}for(o=o.substring(c+p);o&&"\n"===o[0];)o=o.substring(1),i+="\n";s=o.match(l)}return i+=o},GetPathElementFromEvent:function(e,t){var r=t.getManager("VCXContextManager").getMainViewer();if(!r.canvas)return null;var a=r.getMousePosition(e.from[0].getCurrentPosition(r.canvas)),n=r.pick(a,"mesh",!1),o=null;return n&&n.path&&n.path.length>0&&(o=n.path[0].clone()),o},GetModifiableFromEvent:function(e,t){var a=this.GetPathElementFromEvent(e,t);return a&&r.GetModifiableFromPathElement(a,t)}};return r}),define("DS/VCXWebModifiablesServices/VCXModifiablesChangeServices",["DS/VCXWebModifiablesServices/VCXModifiablesAccess","DS/VCXWebComponents/VCXWebComponentOccurrence","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/VCXWebProperties/VCXProperty","DS/VCXWebProperties/VCXPropertyInfo","DS/VCXWebProperties/VCXPropertyValueString","i18n!DS/VCXWebModifiables/assets/nls/VCXWebModifiables"],function(e,t,r,a,n,o,i){"use strict";return{Ghost:function(r,a,n,o){var i=e.GetModifiableFromPathElement(a,r);if(!i)return!1;var l=1;return n?(l=.1,i.GetObject().setOpacity(l,!0),i.GetObject().setMaterial(null,!0)):(i.GetObject().setOpacity(null,!0),i.GetObject().setMaterial(null,!0),i.GetObject().setDirtyFlag(t.FDirty.Alpha),i.GetObject().setDirtyFlag(t.FDirty.Material)),n?i.GetObject().setPickability("IGNORED"):i.GetObject().setPickability("PICKABLE"),!0},RemoveStyleFromCurrentSelection:function(e,t,l){var s=e.getManager("VCXSelectionManager").GetComponentsFromCurrentSelection().map(function(e){return e.QueryInterface("VCXIModifiable")}),u=e.getManager("VCXLinkedPropertyManager");if(e.getManager("VCXStylesManager")){for(var c=new r(e.getManager("VCXScenarioManager"),e.getManager("VCXCommandManager"),!1),p=0;p<s.length;p++){var f=new o;f.SetValue("");var P=new n("Modifiable.StyleID",n.EBehaviorType.NotAnimable,!0,i),y=new a(P,f);if(!u||!l||u.IsLinkedAndNotInFollow(s[p].GetObject().GetID(),l)){if(t){var d=s[p].GetProperties(!0);for(var V in d._map)if(d._map.hasOwnProperty(V)&&u&&u.IsLinkedAndNotInFollow(s[p].GetObject().GetID(),V)){var g=d._map[V];c.ChangeProperty(s[p],g)}}c.ChangeProperty(s[p],y)}}e.getManager("VCXCommandManager").Push(c)}}}});