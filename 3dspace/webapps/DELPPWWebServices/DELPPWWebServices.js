define("DS/DELPPWWebServices/CommonService",["UWA/Core","UWA/Class","DS/WebappsUtils/WebappsUtils","DS/DELPPWModelServices/ModelUtils","DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/DELPPWLoggerModel/LoggerUtils"],function(e,i,t,r,s,n,o){"use strict";return i.extend({name:"CommonService",_servicesURL:{},_platformId:{},_3DSpaceServiceName:"3DSpace",_AppCloudServiceName:"3dmfgitemsmgt",_3DSearchServiceName:"3DSearch",_defaultSecurityContext:"ctx::FakeDefaultRole.FakeDefaultOrga.FakeDefaultCommonSpace",_CSRFToken:{},init:function(i){i=i||{},e.is(i.cloudServiceName)?this._AppCloudServiceName=i.cloudServiceName:o.debug(this.name,"ERROR: Cloud Service name is not proivided"),this._servicesURL[this._3DSpaceServiceName]="NOT_DEFINED",this._servicesURL[this._AppCloudServiceName]="NOT_DEFINED",this._servicesURL[this._3DSearchServiceName]="NOT_DEFINED",this._platformId[this._3DSpaceServiceName]="NOT_DEFINED",this._platformId[this._AppCloudServiceName]="NOT_DEFINED",this._platformId[this._3DSearchServiceName]="NOT_DEFINED",this._CSRFToken[this._3DSpaceServiceName]=null,this._CSRFToken[this._AppCloudServiceName]=null,this._CSRFToken[this._3DSearchServiceName]=null,o.debug(this.name,"initialized")},getDefault3DSpaceBaseURL:function(i){var r=!!e.is(i,"string")&&i.length>0,s=(r?r?i:"":t.getWebappsBaseUrl()).match(/^(https?:\/\/)?([\da-z\.-]+)(:[0-9]{2,5})?([\/\w \.-]*3DDashboard\/)*/),n="";return e.is(s)&&e.is(s,"array")&&(n=(e.is(s[1])?s[1]:"")+s[2]+(e.is(s[4])?"":s[3])+(e.is(s[4])?s[4].replace(/3DDashboard\/?/,"3DSpace/"):"/3DSpace/")),n},getPlatformID:function(i){var t=null;return i=i||{serviceId:this._3DSpaceServiceName},e.is(i.serviceId,"string")?t=this._platformId[i.serviceId]:o.debug(this.name,"ERROR: Couldn't retrieve the platform ID"),t},get3DSpaceServiceName:function(){return this._3DSpaceServiceName},get3DSpaceUrl:function(){return"NOT_DEFINED"===this._servicesURL[this._3DSpaceServiceName]&&(this._servicesURL[this._3DSpaceServiceName]=this.getDefault3DSpaceBaseURL()),this._servicesURL[this._3DSpaceServiceName]},getServiceUrl:function(e){var i=null;return-1!==Object.keys(this._servicesURL).indexOf(e)&&(i=this._servicesURL[e]),i},setSecurityContext:function(i){o.debug("setDefaultSecurityContext: "+e.Json.encode(i)),this._defaultSecurityContext=e.is(i)?i:""},getSecurityContext:function(){return this._defaultSecurityContext},setCSRFToken:function(i,t){e.is(t,"string")&&t.length>0&&e.is(i)&&(this._CSRFToken[t]=e.is(i.eno_csrf_token)?{eno_csrf_token:i.eno_csrf_token}:null)},getCSRFToken:function(i){var t="";return e.is(i,"string")&&this._CSRFToken[i]&&(t=this._CSRFToken[i].eno_csrf_token),t},getHeaders:function(i){var t=i||{},r=!!e.is(t.isJsonOnly)&&t.isJsonOnly,s=!!e.is(t.isAuthoringCtx)&&t.isAuthoringCtx,n=e.is(t.minorVersion)?t.minorVersion:"",o=e.is(t.serviceName)?t.serviceName:"3DSpace",a=this._getAuthoringContextHdr(),c={"Accept-Language":e.is(widget)&&e.is(widget.lang,"string")?widget.lang:"en",SecurityContext:this.getSecurityContext()};return r?(c.Accept="application/json",c["Content-Type"]="application/json"):(c.Accept="application/json,text/javascript,*/*",c["Content-Type"]="application/ds-json"),e.is(s)&&(c=e.extend(c,a)),e.is(n,"string")&&n.length>0&&(c["DS-API-Version"]=n),e.is(o,"string")&&o.length>0&&e.is(this._CSRFToken[o])&&(c=e.extend(c,this._CSRFToken[o])),c},_getAuthoringContextHdr:function(){var i=s.get();return e.is(i)&&e.is(i.AuthoringContextHeader)?i.AuthoringContextHeader:{}},getRetrieveServiceURLPromise:function(i){var t=this;return new Promise(function(r,s){var a=e.is(widget)?e.is(widget.getValue,"function")?widget.getValue("x3dPlatformId"):"noWidgetGetValue":"noWidget";e.is(a,"string")&&0<a.length||(a="OnPremise",o.warn("getRetrieveServiceURLPromise, platformId set by default !!!")),o.debug("getRetrieveServiceURLPromise: "+a),n.getServiceUrl({serviceName:i,platformId:a,onComplete:function(n){var o="";e.is(n,"array")&&0<n.length&&e.is(n[0].url,"string")?(t._servicesURL[i]=n[0].url+(i===t._3DSpaceServiceName||i===t._AppCloudServiceName?"/":""),t._platformId[i]=n[0].platformId,r("iServiceInfoArray Array (ServiceName, ServiceURL, ServicePlatformID): "+i+", "+t._servicesURL[i]+", "+t._platformId[i])):e.is(n,"string")?(t._servicesURL[i]=n+(i===t._3DSpaceServiceName||i===t._AppCloudServiceName?"/":""),t._platformId[i]=a,r("iServiceInfoArray String (ServiceName, ServiceURL, ServicePlatformID): "+i+", "+t._servicesURL[i]+", "+t._platformId[i])):e.is(t._servicesURL[i],"string")&&"NOT_DEFINED"!==t._servicesURL[i]?r("Warning (ServiceName, iServiceInfo, Default URL): "+i+", "+n+", "+t._servicesURL[i]):(o=e.is(n)?e.Json.encode(n):"No Object found",s("Error in getRetrieveServiceURLPromise (ServiceName, iServiceInfo): "+i+", "+o))},onFailure:function(e){s("i3DXCompassPlatformServices.getServiceUrl call failed: "+e)}})})},getAvailableRolesPromise:function(){return new Promise(function(e){var i=[];n.getGrantedRoles(function(t){t.forEach(function(e){i.push(e.id)}),e("userGrantedRoles: "+i)}),r._userGrantedRoles=i})}})}),define("DS/DELPPWWebServices/WebService",["UWA/Core","UWA/Date","DS/WAFData/WAFData","DS/DELPPWModelServices/ModelUtils","DS/DELPPWWebServices/CommonService","DS/DELPPWLoggerModel/LoggerUtils","DS/DELPPWModelServices/BehaviorUtil"],function(e,i,t,r,s,n,o){"use strict";return s.extend({name:"WebService",_webServicesCount:1,init:function(e){this._parent(e)},getServiceUrlPromises:function(){var e=[this.getRetrieveServiceURLPromise(this._3DSpaceServiceName)];return o.isCloud()&&e.push(this.getRetrieveServiceURLPromise(this._AppCloudServiceName)),e.push(this.getAvailableRolesPromise()),Promise.all(e)},webServiceRequest:function(s){var o,a,c,l,u,m,d,S,v,g,h,f,p,D,_,C,b,P,R,N,y,L=this;e.is(s)?e.is(s.url,"string")?e.is(s.method,"string")?(o=e.is(s.serviceName)?s.serviceName:"3DSpace",a=/^https?:\/\//i.test(s.url)?s.url:L.getServiceUrl(o)+"resources/"+s.url,c=e.is(s.type)?s.type:"json",l=e.is(s.data)?s.data:null,u=e.is(s.headers)?s.headers:L.getHeaders({serviceName:o}),m=!e.is(s.async)||s.async,d=e.is(s.context)?s.context:this,S=e.is(s.noProxy)?null:"passport",v=!e.is(s.authenticated)||s.authenticated,g=r.getTimeoutPreference(),document.body.style.cursor="wait",b=i.now(),P=L._webServicesCount+"-START- "+s.url+" request / Time: "+new i(b).toISOString(),R=L._webServicesCount+"-END- "+s.url+" request",N=L._webServicesCount+"-FAIL- "+s.url+" request",y=L._webServicesCount+"-TIME OUT- "+s.url+" request",f=function(t,r){document.body.style.cursor="default",_=i.now(),C=R+" / Duration: "+(_-b)+" ms",n.debug(C),e.is(s.onComplete)&&s.onComplete.call(d,t,r),e.is(s.logMessage)&&n.debug(s.logMessage)},p=function(i,t,r){document.body.style.cursor="default",n.warn(N),n.warn(i),n.warn(JSON.stringify(t)),e.is(s.onFailure)&&s.onFailure.call(d,i,t,r),e.is(s.logMessage)&&n.debug(s.logMessage+t)},D=function(i){document.body.style.cursor="default",n.warn(y),n.warn(i),e.is(s.onTimeout)&&s.onTimeout.call(d,i),e.is(s.logMessage)&&n.debug(s.logMessage)},n.debug(P),h={headers:u,method:s.method,type:c,onComplete:f,data:l,onFailure:p,onTimeout:D,async:m},s.noProxy||(h.proxy=S),e.is(g)&&(h.timeout=g),e.is(s.logMessage)&&n.debug(s.logMessage),v?(n.debug("Call to WAFData.authenticatedRequest(URL, options): ",a+", "+e.Json.encode(h)),t.authenticatedRequest(a,h)):(n.debug("Call to WAFData.proxifiedRequest(URL, options): ",a+", "+e.Json.encode(h)),t.proxifiedRequest(a,h)),L._webServicesCount++):n.debug(this.name,"iOptions.method must be be defined in Webservice.webServiceRequest call."):n.debug(this.name,"iOptions.url must be a string in Webservice.webServiceRequest call."):n.debug(this.name,"iOptions must exist in Webservice.webServiceRequest call.")},fireGETWSInChunkIfTooBig:function(i){var t,r=this,s=0,o=null,a=[],c=[],l=null,u=null,m=null;if(e.is(i))if(e.is(i.url,"string")&&0!==i.url.length)if(e.is(i.data,"array")&&0!==i.data.length)if(t=JSON.stringify(i.data),u=e.is(i.chunk,"number")&&u>0?i.chunk:5,i.url.length+t.length>2048){for(s=0;s<i.data.length;s+=u)o=i.data.slice(s,s+u),l=new Promise(function(e,t){var s={url:i.url,method:"GET",data:{payload:JSON.stringify(o)},type:i.type,async:i.async,context:i.context,headers:i.headers,noProxy:i.noProxy,authenticated:i.authenticated,onComplete:e,onFailure:t,onTimeout:t};r.webServiceRequest(s)}),c.push(l);Promise.all(c).then(function(t){e.is(t,"array")?(a=t.flat(),e.is(i.onComplete,"function")&&i.onComplete(a)):e.is(i.onComplete,"function")&&i.onComplete()},function(t){e.is(i.onFailure,"function")&&i.onFailure(t)})}else m={url:i.url,method:"GET",data:{payload:t},type:i.type,async:i.async,context:i.context,headers:i.headers,noProxy:i.noProxy,authenticated:i.authenticated,onComplete:i.onComplete,onFailure:i.onFailure,onTimeout:i.onTimeout},r.webServiceRequest(m);else n.debug(r.name,"iOptions.data must be an array in Webservice.splitGETWebService call.");else n.debug(r.name,"iOptions.url must be a string in Webservice.splitGETWebService call.");else n.debug(r.name,"iOptions must exist in Webservice.splitGETWebService call.")}})}),define("DS/DELPPWWebServices/WebserviceUtils",["UWA/Core","UWA/Class","DS/DELPPWModelServices/ModelUtils","DS/DELPPWWebServices/WebService","DS/DELPPWModelServices/BehaviorUtil","DS/DELPPWLoggerModel/LoggerUtils"],function(e,i,t,r,s,n){"use strict";return i.singleton({name:"WebServiceUtils",_xmlCache:null,_xmlConfiguration:null,_custoParamSetPID:null,init:function(e){var s=this;e=e||{},this.options=e,t.isStandAlone()?require(["DS/DELPPWWebServicesTst/StandaloneService"],function(t){i.implement.call(s,new t),e.resolve()}):(i.implement.call(s,new r({cloudServiceName:e.cloudServiceName})),s.getServiceUrlPromises().then(e.resolve,e.reject))},getTenant:function(){return this.getPlatformID()},getWebServicesURL:function(){return this.get3DSpaceUrl()+"resources/dsmfg/private/V0/MfgElement"},setXMLConfiguration:function(e,i){this._xmlCache={},this._xmlConfiguration=e,this._custoParamSetPID=i},fetchXMLValues:function(i,t,r){var o,a,c,l=this,u=e.is(this._custoParamSetPID,"string")&&this._custoParamSetPID.length>0,m=s.isCacheFullyOptimized(),d=u?m?"&custoParamSetPID="+this._custoParamSetPID:"&custoParamSetPID="+this._custoParamSetPID+"&v="+Date.now():"",S=function(r){n.debug(l.name,"WebserviceUtil._fetchXMLValues(), REQUEST: "+i),e.is(r)?(l._xmlCache[i]=r.fileContent,e.is(t)&&t(l._xmlCache[i]),n.debug(l.name,l._xmlCache[i])):n.debug(l.name,"configurationXML response data is undefined for requested  XML Key : "+i)},v=function(t){n.debug(l.name,"!!! WebserviceUtil._fetchXMLValues(), ERROR: "+i),n.debug(t),e.is(r)&&r(t)},g=function(e){u&&s.isCloud()?l.webServiceRequest({url:"dsmfg/private/V0/ApplicationConfiguration?frameworkName="+o[0]+"&fileName="+o[1]+".xml",method:"GET",serviceName:l._AppCloudServiceName,onComplete:S,onFailure:v}):v(e)};e.is(this._xmlConfiguration[i])?(o=this._xmlConfiguration[i],a=u?"dsmfg/private/V0/invoke/configurationXML":"dsmfg/private/V0/ApplicationConfiguration",c=s.isCloud()&&!u?l._AppCloudServiceName:l._3DSpaceServiceName,o=o.split("/"),e.is(o,"array")&&2===o.length?l.webServiceRequest({url:a+"?frameworkName="+o[0]+"&fileName="+o[1]+".xml"+d,method:"GET",serviceName:c,onComplete:S,onFailure:g}):g("xmlPath is not correctly defined in configurationXML  : "+i)):v("xmlKey is not defined in configurationXML  : "+i)},getXMLValues:function(i,t,r){var s,n={dataCache:[],convert:function(i,t){var r,s=i.split("."),n=this;if(!e.is(this.dataCache[t])){for(r=0;r<s.length;++r){if(!e.is(n[s[r]])){n=null;break}n=n[s[r]]}if(e.is(n))for("array"!==e.typeOf(n)&&(n=[n]),this.dataCache[t]={},r=0;r<n.length;++r)this.dataCache[t][n[r][t]]=n[r],delete this.dataCache[t][n[r][t]][t]}return this.dataCache[t]}};return e.is(this._xmlCache[i])?(s=e.merge(this._xmlCache[i],n),e.is(t,"function")&&t(e.clone(s))):e.is(r,"function")&&r("xmlKey is not defined in configurationXML  : "+i),e.clone(s)}})});