define("DS/RTAPIManager/RTAPIuserModel",["UWA/Class","UWA/Class/Model","DS/PlatformAPI/PlatformAPI","UWA/Data"],function(e,t,n,s){"use strict";var i={offline:"#d1d4d4",online:"#57B847",busy:"#EA4F37",away:"#E87B00"};return e.extend(t,{defaults:{id:null,login:null,username:null,isCallable:!0,presence:null,tenant:null,phone:UWA.Utils.getQueryString(document.URL,"phone3DIM"),hasAvatar:!1,swymUrl:null,color:i.offline,avatarUrl:window.dsDefaultWebappsBaseUrl+"./RTAPIManager/assets/avatarDefault.png"},setup:function(e){return e?e.login?(this.id=e.login,this.set({id:e.login}),this.addEvent("onChange:presence",this.onPresence),this.addEvent("onChange:swymUrl",this.setAvatarUrl),e.presence&&this.set("color",i[e.presence.toLowerCase()]),!this.get("swymUrl")&&e.swymUrl&&this.set({swymUrl:e.swymUrl}),this.get("swymUrl")&&this.setAvatarUrl(),void(!e.phone&&e.uri&&this.set({phone:e.uri}))):console.error("RTAPIuserModel needs login"):console.error("RTAPIuserModel needs params")},setAvatarUrl:function(){var e=this.get("swymUrl")+"/api/user/getpicture/login/"+this.get("login")+"/format";window.ds&&"MOBILE"===window.ds.env&&s&&s.proxifyUrl&&(e=s.proxifyUrl(e,{proxy:"passport"})),this.set({avatarUrl:e})},onPresence:function(){var e=this.get("presence");this.set("color",i[e.toLowerCase()]),this.updateCallability(e),e&&this.publishPresence(e)},publishPresence:function(e){var t=this.get("color"),s=this.get("login");n.publish(s,{login:s,action:"setStatus",status:e,presence:e,color:t})},updateCallability:function(e){e&&"busy"==e.toLowerCase()?this.set({isCallable:!1}):this.set({isCallable:!0})},set:function(e,t){return e.status&&this._parent("presence",e.status),this._parent(e,t)},isPhoneCallable:function(){return!!this.get("phone")}})}),define("DS/RTAPIManager/RTAPImanagerModel",["UWA/Class","UWA/Class/Model","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(e,t,n){"use strict";return e.extend(t,{defaults:{isConnected:!1,tenant:null,swymUrls:{},swymUrl:null},_setSwymURL:function(e,t){var n={};n[t]=e,this.set({swymUrls:Object.assign({},this.get("swymUrls"),n)}),this.set({swymUrl:e})},getSwymURL:function(e){var t;return this.get("swymUrls")[e]||n.getServiceUrl({serviceName:"3DSwym",platformId:e||this.get("tenant"),onComplete:(t=this,function(n){n&&t._setSwymURL(n,e.toLowerCase()),!n&&e.toUpperCase()!=e&&t.getSwymURL(e.toUpperCase())}),onFailure:function(e){console.error("RTAPIManager failed to retrieved 3DSwym url via i3DXCompassPlatformServices.getServiceUrl")}}),this}})}),define("DS/RTAPIManager/RTAPIconvModel",["UWA/Class","UWA/Class/Model","DS/PlatformAPI/PlatformAPI"],function(e,t,n){"use strict";return e.extend(t,{defaults:{id:null,channel:null,dmId:null,logins:[],users:[],isCallable:!0,isJoinable:!1,type:null},setup:function(e){if(!e)return console.error("RTAPIconvModel needs params");for(var t in this.id=e.id,this.set({id:e.id}),this.get("users"))this.listenTo(this.get("users")[t],"onChange:isCallable",this.updateCallability);var s,i="towidgetim.dmId:"+e.dmId;this.set({channel:i}),e.dmId&&n.subscribe(i,(s=this,function(e){return s.platformListener(e)}))},platformListener:function(e){return"CallInfo"!=e.evenement||(e.data&&e.data.callState?(this.set({isJoinable:"onCall"===e.data.callState}),void this.set({type:e.type||e.data&&e.data.type||"audio"})):console.error("no callState"))},updateCallability:function(e,t){var n=t,s=this.get("users");if(!n)for(var i in s)if(s[i].get("isCallable")){n=!0;break}this.set("isCallable",n)},destroy:function(){return this.stopListening(),this._parent()}})}),define("DS/RTAPIManager/RTAPIuserCollection",["DS/PlatformAPI/PlatformAPI","UWA/Class","UWA/Class/Collection","DS/RTAPIManager/RTAPIuserModel","DS/RTAPIManager/RTAPImanagerModel","DS/RTAPIManager/RTAPIconvModel"],function(e,t,n,s,i,r){"use strict";var o;return document.devenv3DIM&&window.top.document.PlatformAPI&&(e=window.top.document.PlatformAPI),t.extend(n,{model:s,setup:function(t,s){var a;this.tenant=s&&s.tenantId,o=this.tenant,this.manager=new i({tenant:this.tenant}),this.manager.addEvents({"onChange:isConnected":this._onConnectionChange,"onChange:swymUrl":this._onSwymUrl},this),this.conversations=new n([],{model:r}),this.conversations.addEvents({onAdd:this._onConvAdd},this),this.addEvents({onAdd:this._onAdd},this),e.subscribe("towidgetim.ds.com",(a=this,function(e){return a._platformListener(e)})),e.publish("fromwidgetim.ds.com",{evenement:"GETLOGINOKDATA"})},_platformListener:function(e){"CONNECTED"==e.evenement?this.manager.set({isConnected:!0}):"ONPRESENCERECEIVED"==e.evenement||"setStatus"==e.action?this.setUser(e.data||e,!0):"DISCONNECTED"!=e.evenement&&"logout"!=e.action||this.manager.set({isConnected:!1})},_onSwymUrl:function(e,t){t&&this.invoke("set","swymUrl",t)},_onConnectionChange:function(){this.manager.get("isConnected")?(this._fetchAllStatus(),this._fetchAllConvInfo()):this._setAllStatus("Unknown")},_sanitizeProperties:function(e,t){if(!e)return console.error("RTAPIManager setUser needs argument");var n=e;return n.login=n.login||n.userId,n.login&&"string"==typeof n.login?(n.login=n.login.toLowerCase(),t?n.presence=n.presence||n.status:(delete n.status,delete n.presence),n):console.error("RTAPIManager setUser needs string login")},getUsers:function(e){var t,n=[];for(t=0;t<e.length;t++)n.push(this.getUser(e[t]));return n},getUser:function(e,t){if(!e||"string"!=typeof e)return console.error("RTAPIManager getUser arg must be a string");t&&this.loadSwymURL(t);var n=this.manager.get("swymUrl");return this.setUser({login:e,tenant:t,swymUrl:n})},setUser:function(e,t){var n=this._sanitizeProperties(e,t);if(!n)return null;n.uri&&!n.phone&&(n.phone=n.uri);var s=this.get(n.login);return s?s.set(n):s=this.add(n),s},_onAdd:function(e,t,n){!e.get("presence")&&this.manager.get("isConnected")&&this._fetchSpecificStatus(e)},_setAllStatus:function(e){this.forEach(function(t){t.set({presence:e})})},_fetchAllStatus:function(){var t=this.map(e=>({login:e.get("login"),tenant:e.get("tenant")||o}));e.publish("im.ds.com",{users:t,action:"getAllStatus"})},_fetchSpecificStatus:function(t){e.publish("im.ds.com",{login:t.get("login"),tenant:t.get("tenant")||o,action:"getStatus"})},_onConvAdd:function(e,t,n){this.manager.get("isConnected")&&this._fetchSpecificConvInfo(e)},_fetchAllConvInfo:function(){this.conversations.forEach(this._fetchSpecificConvInfo)},_fetchSpecificConvInfo:function(t){t.get("dmId")&&e.publish("fromwidgetim.ds.com",{evenement:"getCallInfo",data:{dmId:t.get("dmId")}})},getConv:function(e,t){var n,s;return"string"==typeof e&&(e=[e]),n=!t&&e?e.toString():t||"noDMid",(s=this.conversations.get(n))||(s=this.conversations.add({id:n,dmId:t,logins:e,users:e&&this.getUsers(e)})),s},loadSwymURL:function(e){return this.manager.getSwymURL(e)}})}),define("DS/RTAPIManager/RTAPIManager",["DS/RTAPIManager/RTAPIuserCollection"],function(e){"use strict";return document.RTAPIManager=document.RTAPIManager||new e,!document.RTAPIManager instanceof e&&console.error("RTAPIManager is not a RTAPIuserCollection"),document.RTAPIManager});