define("DS/InstantMessagingWebRTC/js/model/NoiseMaker",["UWA/Class/Model"],function(e){"use strict";return document.noiseMaker||(document.noiseMaker=new(e.extend({defaults:{ringtone:"./resources/en/1/webapps/InstantMessagingWebRTC/assets/ringtone.wav",userin:"./resources/en/1/webapps/InstantMessagingWebRTC/assets/userin.wav",userout:"./resources/en/1/webapps/InstantMessagingWebRTC/assets/userout.wav"},setup:function(e){this.timeouts={},this.audios={}},preload:function(){var e,t,n,i=this.pairs();for(e in i){t=i[e][0],n=i[e][1];try{this.audios[t]=new Audio(n)}catch(e){console.error("NoiseMaker unable to load sound "+t+" :"+e)}}},start:function(e,t){if(!e)e="ringtone";var n,i=this.audios[e];if(!i)return console.error("NoiseMaker start failed : tone not loaded "+e);i.loop=!!t;try{var o=i.play();void 0!==o&&o.then(function(){UWA.log("NoiseMaker play "+e)},function(t){console.error("NoiseMaker failed to play "+e+" : "+t)})}catch(t){console.error("NoiseMaker failed to play "+e+" : "+t)}t&&"number"==typeof t&&(this.timeouts[e]=setTimeout((n=this,function(){n.stop(e)}),t))},stop:function(e){if(!e)e="ringtone";try{clearTimeout(this.timeouts[e]);var t=this.audios[e];if(!t)return console.error("NoiseMaker stop failed : tone not loaded "+e);t.pause(),t.currentTime=0,UWA.log("NoiseMaker stop "+e)}catch(e){console.error("NoiseMaker failed to stop tone "+e)}}}))),document.noiseMaker}),define("DS/InstantMessagingWebRTC/js/model/RTCallingComponentModel",["UWA/Class","UWA/Class/Model","UWA/Class/Timed","DS/RTProxyDriver/RTLogger","i18n!DS/InstantMessagingWebRTC/assets/nls/feed"],function(e,t,n,i,o){"use strict";var a=e.extend(n,{increment:function(){this.set({callDuration:this.get("callDuration")+1})},run:function(e){this.setPeriodical("second",this.increment,1e3,!0,e)},stop:function(){this.clearPeriodical("second")}});return t.extend({defaults:{type:"video",devEnv:!1,avatarUrl:"./resources/en/1/webapps/InstantMessaging/assets/avatarDefault.png",username:"John Smith",title:o.calling||"Calling...",subtitle:null,login:"pne1",state:"calling",room_id:void 0,localVideo:!0,localAudio:!0,callDuration:0,linkToOrder:!1,IamTheCaller:!1,nway:!1,accepted:!1,streamReceived:!1,dmId:null,phone:null,sip:null,bandwidth:500,constraintsAudio:{},constraintsVideo:{}},setup:function(e){e.devEnv&&this.set({avatarUrl:"./assets/avatarDefault.png"}),e.state&&"calling"!==e.state&&this.set({title:o["incoming"==e.state?e.state+this.get("type"):e.state]||e.state}),this.chrono=new a,e.orderId&&this.set({subtitle:(o.Order||"Order")+" #"+e.orderId}),!e.phone&&e.uri&&this.set({phone:e.uri}),this.get("phone")&&this.get("sip")&&this.set({subtitle:(o.ExternalCall||"External call")+" "+this.get("phone")})},setTitleToNLS:function(e){if(!e)return i.error("setTitleToNLS no NLSkey provided");o[e]||"callaudio"!=e&&"callvideo"!=e||(e="Call"),this.set({title:o[e]||e})},setState:function(e){if(!e)return i.error("setState no newState provided");var t="call"==e?e+this.get("type"):e;this.set({state:t}),i.WebRTC("RTCallingComponentModel setState to "+t),this.setTitleToNLS(t)},startCallDuration:function(){this.set({callDuration:0}),this.chrono.run(this)},stopCallDuration:function(){this.set({callDuration:0}),this.chrono.stop()}})}),define("DS/InstantMessagingWebRTC/js/model/RTCallingTracker",["UWA/Class","UWA/Class/Model","UWA/Class/Collection","DS/RTProxyDriver/RTLogger","i18n!DS/InstantMessagingWebRTC/assets/nls/feed","DS/WAFData/WAFData","DS/Usage/TrackerAPI","DS/RTProxyDriver/RTProxyDriver"],function(e,t,n,i,o,a,s,r){"use strict";i.addLevel("WebRTCtracker","magenta");const l=t.extend({defaults:{login:null,isCaller:!1,date_accept:0,date_end:0,reason:null,date_stream_ok:0},toJSON:function(){var e=this._parent();for(let t in e)e[t]||delete e[t];return e}}),c=n.extend({model:l});var d=null;var h=function(e,t,n){var o=UWA.clone(e);if(!o)return i.WebRTCtracker("swymSender missing report");if(!t)return i.WebRTCtracker("swymSender missing webservice url");if(!n)return i.WebRTCtracker("swymSender missing base url");var s=JSON.stringify(o);i.WebRTCtracker("Swym Report : "+s+" to "+t),function(e,t){if(d)return t(d);a.authenticatedRequest(e+"/api/index/tk",{method:"GET",type:"json",onComplete:function(e){try{d=e.result.ServerToken,t(d)}catch(e){i.WebRTCtracker("Failed to resolve CSRF Token "+e)}},onFailure:function(e){i.WebRTCtracker("Failed to get CSRF Token "+e)}})}(n,function(e){if(!e)return i.WebRTCtracker("Cannot send swym message without csrf token");a.authenticatedRequest(t,{method:"POST",type:"json",data:s,headers:{"Content-Type":"application/json","X-DS-SWYM-CSRFTOKEN":e},onComplete:function(e){i.WebRTCtracker("Swym report sent.")},onFailure:function(e){i.WebRTCtracker("Swym request failed : "+e)}})})};return t.extend({defaults:{date_start:0,response_time:0,date_end:0,caller:null,logins:null,dmId:null,swymBaseUrl:null,swymWebservice:null},setup:function(e){for(var t of(this.get("swymBaseUrl")&&this.get("dmId")&&this.set("swymWebservice",this.get("swymBaseUrl")+"/api/directmessages/logavcall/"+this.get("dmId")),this.set("date_start",Date.now()),this.UsersStatus=new c,this.addUser({login:this.get("caller"),isCaller:!0,date_accept:this.get("date_start")}),this.get("logins")))this.addUser({login:t});this.listenTo(this.UsersStatus,"onChange",function(e){i.WebRTCtracker("Status changed for "+e.id+" : "+JSON.stringify(e._changed))}),this.listenTo(this.UsersStatus,"onAdd",function(e){i.WebRTCtracker("New user : "+e.get("login"))}),i.WebRTCtracker("startTracking "+JSON.stringify(this))},addUser:function(e){this.getByLogin(e.login)&&this.UsersStatus.remove(this.getByLogin(e.login)),this.UsersStatus.add(Object.assign({},e,{id:e.login}))},destroy:function(){this.stopListening(),this.UsersStatus.stopListening(),this.UsersStatus=null,this._parent()},getCaller:function(){return this.getByLogin(this.get("caller"))},getByLogin:function(e){return e?this.UsersStatus.get(e)?this.UsersStatus.get(e):(this.UsersStatus.add({id:e,login:e}),this.getByLogin(e)):(i.WebRTCtracker("missing login "+e),new l({login:"unknown"}))},logAccepted:function(e){this.getByLogin(e).set("date_accept",Date.now())},logEnded:function(e,t){this.getByLogin(e).set("date_end",Date.now()),this.getByLogin(e).set("reason",t)},logStream:function(e){var t=this.getByLogin(e);t.get("date_stream_ok")||t.set("date_stream_ok",Date.now())},logInviteSent:function(){this.set("response_time",Date.now()-this.get("date_start"))},logEvent:function(e,t){switch(e){case"callEnded":this.logEnded(t.login,t.reason);break;case"callAccepted":this.logAccepted(t.login);break;case"streamReceived":this.logStream(t.login);break;case"inviteSent":this.logInviteSent();break;default:i.WebRTCtracker("eventAction unknown : "+e)}},findMainEndReason:function(e){return"user_hangup"==this.getCaller().get("reason")&&1===e.accepters.length?"caller refused":"user_hangup"==this.getCaller().get("reason")&&e.accepters.length>1?"caller hang up":e.hangupers.length&&e.hangupers.length==e.accepters.length-1?"all callees hang up":"offline"==this.getCaller().get("reason")?"caller offline":e.missers.length&&e.missers.length==e.callables.length?"all callees missed":e.refusers.length&&e.refusers.length==e.callables.length?"all callees refused":e.callables.length?e.unexpectedReasons.length>=e.callables.length?"all streams failed":e.accepters.length?null:"nobody accepted the call":"all callees busy"},endCall:function(e,t){this.set("date_end",Date.now());var n={type:this.get("type")||"none",caller:this.get("caller"),callees:this.get("logins"),logins:this.UsersStatus.pluck("login"),date_start:this.get("date_start"),response_time:this.get("response_time"),date_end:this.get("date_end"),duration:this.get("date_end")-this.get("date_start"),usersDetails:this.UsersStatus.toJSON(),callables:UWA.Array.invoke(this.UsersStatus.filter(function(e){return!e.get("isCaller")&&"Busy"!=e.get("reason")}),"get","login"),accepters:UWA.Array.invoke(this.UsersStatus.filter(function(e){return 0!=e.get("date_accept")}),"get","login"),streamers:UWA.Array.invoke(this.UsersStatus.filter(function(e){return 0!=e.get("date_stream_ok")}),"get","login"),missers:UWA.Array.invoke(this.UsersStatus.filter(function(e){return"callMissed"==e.get("reason")||"callTimeout"==e.get("reason")}),"get","login"),refusers:UWA.Array.invoke(this.UsersStatus.filter(function(e){return!e.get("isCaller")&&"user_hangup"==e.get("reason")&&!e.get("date_accept")}),"get","login"),hangupers:UWA.Array.invoke(this.UsersStatus.filter(function(e){return!e.get("isCaller")&&"user_hangup"==e.get("reason")&&e.get("date_accept")}),"get","login"),allReasons:UWA.Array.invoke(this.UsersStatus.filter(function(e){return e.get("reason")}),"get","reason"),calleesReasons:UWA.Array.invoke(this.UsersStatus.filter(function(e){return!e.get("isCaller")&&e.get("reason")}),"get","reason"),unexpectedReasons:UWA.Array.invoke(this.UsersStatus.filter(function(e){return!(!e.get("reason")||-1!=["user_hangup","callTimeout","callMissed","Busy"].indexOf(e.get("reason")))}),"get","reason"),dmId:this.get("dmId")};n.mainEndReason=this.findMainEndReason(n),i.WebRTCtracker(n),e||this.gen3DSwymReport(n),!0!==t&&this.gen3DAnalyticsReport(n),this.gen3DMessagingReport(n)},gen3DSwymReport:function(e){return h({users:e.accepters,type:e.type,usersDetails:e.usersDetails,date_start:e.date_start,date_end:e.date_end},this.get("swymWebservice"),this.get("swymBaseUrl"))},gen3DMessagingReport:function(e){return function(e){var t=UWA.clone(e);r.dispatch("callEventFromView",{action:"reporting",report:t})}({type:e.type,duration:e.duration,mainEndReason:e.mainEndReason,users:e.usersDetails})},gen3DAnalyticsReport:function(e){var t={appID:"X3DIMSG_AP",eventCategory:"call",eventAction:"end",eventLabel:"3DMessaging call report",eventValue:e.duration,persDim:{pd1:e.type,pd2:e.mainEndReason},persVal:{pv1:e.logins.length,pv2:e.accepters.length-1,pv3:e.streamers.length,pv4:e.missers.length,pv5:e.refusers.length,pv6:e.unexpectedReasons.length,pv7:e.response_time,pv8:e.callables.length,pv9:e.hangupers.length}},n=2;for(var o of e.allReasons)t.persDim["pd"+ ++n]=o;return function(e){var t=UWA.clone(e);try{i.WebRTCtracker("Analytics report : "+JSON.stringify(t)),t.callback=function(e){i.WebRTCtracker("Analytics report sent.")},s.trackPageEvent(t)}catch(e){i.WebRTCtracker("Analytics request failed : "+e)}}(t)}})}),define("DS/InstantMessagingWebRTC/js/view/RTCallingComponentView",["UWA/Class","UWA/Class/View","DS/RTProxyDriver/RTLogger","i18n!DS/InstantMessagingWebRTC/assets/nls/feed","DS/InstantMessagingWebRTC/assets/svg_icons","DS/UIKIT/Tooltip","DS/UIKIT/Spinner","DS/InstantMessagingWebRTC/js/model/NoiseMaker","DS/RTDriver/RTDetectClient","css!DS/InstantMessagingWebRTC/InstantMessagingWebRTC.css"],function(e,t,n,i,o,a,s,r,l){"use strict";return t.extend({tagName:"div",id:"RTCallingComponent",className:"RTCallingComponent",setup:function(e){this.nwayActivated=e.nwayActivated,this.listenTo(this.model,"onChange:title",this.changeTitle),this.listenTo(this.model,"onChange:callDuration",this.changeCallDuration),this.listenTo(this.model,"onChange:username",this.changeUsername),this.listenTo(this.model,"onChange:nway",this.nway),this.listenTo(this.model,"onChange:state",this.stateChanged),this.model.get("IamTheCaller")||e.noRingtone||e.newuser||this.startRingtone()},stateChanged:function(){"callvideo"==this.model.get("state")?this.hideInfos():"callaudio"==this.model.get("state")&&this.showInfos()},nway:function(){if(this.hideButtons(),this.hideIcons(),this.showUsername(),this.container.addClassName("nway"),!this.nwayActivated)return!0;this.hideCallDuree(),this.hideCallDureeVid()},startNewusertone:function(){r.start("userin")},startRingtone:function(){r.start("ringtone",3e4)},stopRingtone:function(){r.stop("ringtone")},changeTitle:function(e,t){this.container&&this.container.children&&this.container.children.RTCallingComponent_title&&(this.container.children.RTCallingComponent_title.innerText=e.get("title"))},changeUsername:function(e,t){this.container.children.RTCallingComponent_infos.children.RTCallingComponent_username.innerText=e.get("username")},displayError:function(e){this.model.set({state:"error"}),this.maximize(),this.showAvatar(),this.hideVideo(),this.hideButtons(),this.hideIcons(),this.model.set({title:i[e]||e}),this.hideCallDuree(),this.hideCallDureeVid(),this.showTitle(),this.container&&this.container.children&&this.container.children.RTCallingComponent_title&&this.container.children.RTCallingComponent_title.classList&&this.container.children.RTCallingComponent_title.classList.add("errorTitle"),this.container.removeClassName("nwayvideo")},changeCallDuration:function(e,t){var n=e.get("callDuration"),i=Math.floor(n/3600),o=(n-=3600*i)%60;o<10&&(o="0"+o);var a=Math.floor(n/60);a<10&&(a="0"+a);var s=(i?i+":":"")+a+":"+o;try{this.container.children.RTCallingComponent_infos.children.RTCallingComponent_callDuration.innerText=s,this.container.children.RTCallingComponent_callDuration_video.innerText=s}catch(e){console.error(e)}},removeIconsButHangUp:function(e){"calling"!==e&&(this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_phone.addClassName("hidden"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_phone_linked.addClassName("hidden"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_video.addClassName("rigthSide"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_mic.addClassName("rigthSide"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_phoneOFF.addClassName("rigthSide"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_mic.removeClassName("hidden"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_video.removeClassName("hidden"))},showAllIcons:function(){return-1!=this.model.get("state").indexOf("incoming")?this.showIncomingIcons():this.showOnCallIcons()},showOnCallIcons:function(){this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_phone.addClassName("hidden"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_phone_linked.addClassName("hidden"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_video.removeClassName("rigthSide"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_mic.removeClassName("rigthSide"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_phoneOFF.removeClassName("rigthSide"),this.addTooltip(this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_mic,i.muteAudio||"Mute"),this.addTooltip(this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_video,i.muteVideo||"Hide camera")},showIncomingIcons:function(){this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_phone.removeClassName("hidden"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_phone_linked.removeClassName("hidden"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_video.addClassName("hidden"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_mic.addClassName("hidden"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_phoneOFF.removeClassName("rigthSide")},setSizeButtonFull:function(e){var t=this.buttons;if(!t)return!1;t.removeClassName("fonticon-resize-small"),t.addClassName("fonticon-resize-full")},setSizeButtonSmall:function(){var e=this.buttons;if(!e)return!1;e.addClassName("fonticon-resize-small"),e.removeClassName("fonticon-resize-full")},hideButtons:function(){this.buttons.addClassName("hidden")},showButtons:function(){this.buttons.removeClassName("hidden")},hideIcons:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_icons&&this.container.children.RTCallingComponent_icons.addClassName("hidden")},showIcons:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_icons&&this.container.children.RTCallingComponent_icons.removeClassName("hidden")},hideInfos:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_infos&&this.container.children.RTCallingComponent_infos.addClassName("hidden")},showInfos:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_infos&&this.container.children.RTCallingComponent_infos.removeClassName("hidden")},hideTitle:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_title&&this.container.children.RTCallingComponent_title.addClassName("hidden")},showTitle:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_title&&this.container.children.RTCallingComponent_title.removeClassName("hidden")},hideUsername:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_infos&&this.container.children.RTCallingComponent_infos.children.RTCallingComponent_username.addClassName("hidden")},showUsername:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_infos&&this.container.children.RTCallingComponent_infos.children.RTCallingComponent_username.removeClassName("hidden")},hideCallDuree:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_infos&&this.container.children.RTCallingComponent_infos.children.RTCallingComponent_callDuration.addClassName("hidden")},showCallDuration:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_infos&&this.container.children.RTCallingComponent_infos.children.RTCallingComponent_callDuration.removeClassName("hidden")},hideCallDureeVid:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_callDuration_video&&this.container.children.RTCallingComponent_callDuration_video.addClassName("hidden")},showCallDurationVid:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_callDuration_video&&this.container.children.RTCallingComponent_callDuration_video.removeClassName("hidden")},hideSubtitle:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_infos&&this.container.children.RTCallingComponent_infos.children.RTCallingComponent_subtitle.addClassName("hidden")},showSubtitle:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_infos&&this.container.children.RTCallingComponent_infos.children.RTCallingComponent_subtitle.removeClassName("hidden")},hideAvatar:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_avatar&&this.container.children.RTCallingComponent_avatar.addClassName("hidden")},showAvatar:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_avatar&&this.container.children.RTCallingComponent_avatar.removeClassName("hidden")},hideVideo:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_video&&this.container.children.RTCallingComponent_video.addClassName("hidden")},showVideo:function(){this.container&&this.container.children&&this.container.children.RTCallingComponent_video&&this.container.children.RTCallingComponent_video.removeClassName("hidden")},hideSelfVideo:function(){this.localDivVideo.addClassName("hidden")},showSelfVideo:function(){this.localDivVideo.removeClassName("hidden")},fullScreen:function(){this.container.addClassName("fullScreen")},normalScreen:function(){this.container.removeClassName("fullScreen")},showAudioIcon:function(){this.container&&this.container.children&&this.container.children.RTwebrtc_icon_audio&&this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_audio.removeClassName("hidden")},showMicIcon:function(){this.container&&this.container.children&&this.container.children.RTwebrtc_icon_mic&&this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_mic.removeClassName("hidden")},showVideoIcon:function(){this.container&&this.container.children&&this.container.children.RTwebrtc_icon_video&&this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_video.removeClassName("hidden")},hideVideoNull:function(){},showVideoNull:function(){},forcePosition:function(){this.container.style.left="",this.container.style.top=""},pauseLocalVideo:function(){},playLocalVideo:function(){this.localDivVideo.play(),this.localDivVideo.muted=!0},showLocalStream:function(e,t){if(!e)return n.error("showLocalStream needs a stream");var i=this.localDivVideo;try{try{i.src=window.URL.createObjectURL(e)}catch(t){i.srcObject=e}i.autoplay=!0,l.isIphone()&&(i.onloadeddata=function(){this.play()}),i.load(),i.muted=!0}catch(e){n.error("RTCallingComponentView unable to showLocalStream "+e)}this.dispatchEvent("localStreamLoad"),e.getTracks().length>=2?(this.displayNormalCameraIcon(),i.removeClassName("hidden"),this.showVideo()):(this.displayMutedCameraIcon(),this.hideVideo()),this.addMuteListener(e.getTracks())},addMuteListener:function(e){var t=function(e){console.log(e)};for(var n in e)e[n].onmute=t},showDistantExtStream:function(e){if(!e)return n.error("showDistantExtStream needs a MediaSource");var t=this.container.children.RTCallingComponent_video.children.RTCallingComponent_video_distant;try{t.src=window.URL.createObjectURL(e),t.onloadeddata=function(){t.play()}}catch(e){n.error("RTCallingComponentView unable to showDistantExtStream "+e)}},showDistantStream:function(e){if(!e)return n.error("showDistantStream needs a stream");var t=this.container.children.RTCallingComponent_video.children.RTCallingComponent_video_distant;try{try{t.src=window.URL.createObjectURL(e)}catch(n){t.srcObject=e}t.autoplay=!0,l.isIphone()&&(t.onloadeddata=function(){this.play()}),t.load()}catch(e){n.error("RTCallingComponentView unable to showDistantStream "+e)}var i=e.getTracks();(i.length>=2||"video"==i[0].kind)&&(this.hideVideoNull(),this.showVideo(),this.hideAvatar(),this.hasReceivedVideo=!0),this.addMuteListener(e.getTracks())},detectDoubleTapOn:function(e,t,n){this.coeffClick=0;var i,o,a=(i=this,o=null,function(){if(null==o)o=setTimeout(function(){o=null},t||500);else{if(clearTimeout(o),o=null,n&&i.coeffClick<n)return++i.coeffClick;i.coeffClick=0,i.dispatchEvent("doubleClick")}});e.addEventListener("touchstart",a),e.addEventListener("click",a)},detectDoubleTapOnVideoAndAvatar:function(e){this.detectDoubleTapOn(this.container.children.RTCallingComponent_video.children.RTCallingComponent_video_distant),this.detectDoubleTapOn(this.container.children.RTCallingComponent_avatar)},remove:function(){var e;this.container.style.transform="scale(0)",setTimeout((e=this,function(){e.container.remove(),e.destroy()}),500)},minimizeForAudio:function(){this.showAvatar(),this.showCallDuration(),this.removeIconsButHangUp()},minimizeForVideo:function(){},minimize:function(){this.addTooltip(this.container.parentElement?this.container.parentElement.children.RTCallingComponent_buttons:this.container.children.RTCallingComponent_buttons,i.maximize||"Maximize"),this.removeIconsButHangUp(),this.setSizeButtonFull(),this.hideTitle(),this.forcePosition(),this.container.addClassName("minimized"),this.hideUsername(),this.normalScreen(),this.showButtons(),-1===navigator.platform.indexOf("iPhone")&&-1===navigator.platform.indexOf("iPod")&&-1===navigator.platform.indexOf("iPad")&&0===navigator.maxTouchPoints&&this.setDraggable(this.container.parentElement),"video"==this.model.get("type")?this.minimizeForVideo():"audio"==this.model.get("type")&&this.minimizeForAudio(),this.model.get("nway")&&this.nway()},showOnlyUsername:function(){this.showInfos(),this.hideSubtitle(),this.hideCallDuree(),this.showUsername()},setDraggable:function(e){var t,i,o,a,s,r=e||this.container;r.draggable=!0;var l=function(e){s&&(s.hide(),s.destroy()),r.style.zIndex=""},c=function(e){if(void 0===e)e=window.event;t=e.clientX,i=e.clientY},d=function(e){if(document.addEventListener("dragover",c),s=UWA.createElement("div",{id:"IamAMaskToHelpDragDropOverIframe",class:"ImustDisappearAfterDrop",styles:{position:"absolute",height:"1000%",width:"1000%",top:"0",bottom:"0",right:"0",left:"0",margin:"0 auto",zIndex:5e3}}),r.style.zIndex=5001,s.inject(document.body),n.WebRTC("CallingComponent Drag Start"),void 0===e)e=window.event;var t=window.getComputedStyle(e.target,null),i=parseInt(t.getPropertyValue("left"),10)-e.clientX+","+(parseInt(t.getPropertyValue("top"),10)-e.clientY);e&&e.dataTransfer&&e.dataTransfer.setData&&e.dataTransfer.setData("text/plain",i),r.offset_data=i},h=function(e){if(n.WebRTC("CallingComponent Drag End"),void 0===e)e=window.event;e.target.style.left=t-o+"px",e.target.style.top=i-a+"px",e.target.style.bottom="auto",e.target.classList.remove("initialPosition"),e.preventDefault(),document.removeEventListener("dragover",c),r.onmousemove="",setTimeout(l,100)};r.ondragstart=d,r.ondragend=h,r.ontouchstart=d,r.ontouchend=h,r.onmousemove=function(e){void 0===e&&(e=window.event);o=e.offsetX,a=e.offsetY}},maximize:function(){if(this.addTooltip(this.container.parentElement?this.container.parentElement.children.RTCallingComponent_buttons:this.container.children.RTCallingComponent_buttons,i.minimize||"Minimize"),this.model.get("nway"))return"callvideo"==this.model.get("state")&&this.maximizeForVideo(),!0;this.setSizeButtonSmall(),this.showAllIcons(),this.showTitle(),this.showButtons(),this.forcePosition(),this.container.removeClassName("minimized"),this.normalScreen(),this.showUsername(),"calling"==this.model.get("state")?this.hideButtons():"callvideo"==this.model.get("state")?this.maximizeForVideo():"callaudio"==this.model.get("state")&&this.maximizeForAudio()},maximizeForVideo:function(){if(this.model.get("nway"))return this.container.addClassName("nwayvideo"),!0;this.showVideo(),this.hideAvatar(),this.hideTitle(),this.showInfos(),this.showButtons(),this.hideCallDuree(),this.showCallDurationVid(),this.showSubtitle(),this.fullScreen()},maximizeForAudio:function(){this.hideTitle(),this.removeIconsButHangUp(),this.showMicIcon(),this.showVideoIcon(),this.showSubtitle(),this.showCallDuration(),this.hideCallDureeVid()},endCall:function(){var e;this.showAvatar(),this.hideIcons(),this.hideButtons(),this.hideVideo(),this.showSubtitle(),this.hideCallDuree(),this.hideCallDureeVid(),this.showUsername(),this.showInfos(),this.stopRingtone(),this.container.children&&this.container.children.RTCallingComponent_title&&this.container.children.RTCallingComponent_title.classList&&this.container.children.RTCallingComponent_title.classList.remove("errorTitle"),this.container.removeClassName("nwayvideo"),this.showTitle(),setTimeout((e=this,function(){e.remove()}),2e3)},toggleAudio:function(e){this.model.get("localAudio")?(this.dispatchEvent("stopDistantAudio"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_audio.innerHTML=o.RTwebrtc_icon_audio_muted):(this.dispatchEvent("startDistantAudio"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_audio.innerHTML=o.RTwebrtc_icon_audio)},toggleVideo:function(e){"audio"==this.model.get("isMyVideoOn")?this.switchFromAudioToVideo():this.model.get("localVideo")?(this.dispatchEvent("stopLocalVideo"),this.displayMutedCameraIcon()):(this.dispatchEvent("startLocalVideo"),this.displayNormalCameraIcon())},displayNormalCameraIcon:function(){this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_video.addClassName("fonticon-videocamera"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_video.removeClassName("fonticon-videocamera-off"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_video.innerHTML=o.RTwebrtc_icon_video,this.addTooltip(this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_video,i.muteVideo||"Hide camera")},displayMutedCameraIcon:function(){this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_video.removeClassName("fonticon-videocamera"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_video.addClassName("fonticon-videocamera-off"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_video.innerHTML=o.RTwebrtc_icon_video_muted,this.addTooltip(this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_video,i.unmuteVideo||"Show camera")},toggleMic:function(e){this.model.get("localAudio")&&!e?(this.dispatchEvent("stopLocalAudio"),this.displayMutedMicIcon()):(this.dispatchEvent("startLocalAudio"),this.displayNormalMicIcon())},displayNormalMicIcon:function(){try{this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_mic.removeClassName("fonticon-microphone-off"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_mic.addClassName("fonticon-microphone"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_mic.innerHTML=o.RTwebrtc_icon_mic,this.addTooltip(this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_mic,i.muteAudio||"Mute")}catch(e){}},displayMutedMicIcon:function(){this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_mic.addClassName("fonticon-microphone-off"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_mic.removeClassName("fonticon-microphone"),this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_mic.innerHTML=o.RTwebrtc_icon_mic_muted,this.addTooltip(this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_mic,i.unmuteAudio||"Unmute")},switchFromAudioToVideo:function(){n.WebRTC("RTCallingComponentView switchFromAudioToVideo"),this.dispatchEvent("switchToVideo"),this.showVideo(),this.hideVideoNull()},onClickListeners:{RTwebrtc_icon_mic:function(e,t){"callvideo"!=t.model.get("state")&&"callaudio"!=t.model.get("state")||t.toggleMic()},RTwebrtc_icon_audio:function(e,t){"callvideo"!=t.model.get("state")&&"callaudio"!=t.model.get("state")||t.toggleAudio()},RTwebrtc_icon_video:function(e,t){t.model.get("isMyVideoOn")?t.toggleVideo():t.switchFromAudioToVideo()},RTwebrtc_icon_phone_linked:function(e,t){t.dispatchEvent("acceptCall",{room_id:t.model.get("room_id")}),t.minimize(),t.model.set({linkToOrder:!0})},RTwebrtc_icon_phone:function(e,t){t.dispatchEvent("acceptCall",{room_id:t.model.get("room_id")}),t.maximize(),t.removeIconsButHangUp(),t.stopRingtone(),t.tooltips.RTwebrtc_icon_phone.destroy()},RTwebrtc_icon_phoneOFF:function(e,t){t.dispatchEvent("endCall"),t.stopRingtone()},RTCallingComponent_buttons:function(e,t){e.target.classList.contains("fonticon-resize-small")?t.minimize():t.maximize()}},getOnClickListener:function(e){var t,i=this.onClickListeners[e];return i?(t=this,function(e){return i(e,t)}):n.error("getOnClickListener id does not exist : "+e)},addTooltip:function(e,t,i){if(!e||!e.id||!t)return n.error("addTooltip missing args");this.tooltips||(this.tooltips={}),this.tooltips[e.id]&&this.tooltips[e.id].destroy&&(this.tooltips[e.id].destroy(),delete this.tooltips[e.id]),this.tooltips[e.id]=new a({target:e,body:t,position:i||"left"}),this.tooltips[e.id].getContent().style.zIndex=1403},removeTooltip:function(e){if(!e||!this.tooltips)return n.error("removeTooltip missing args");this.tooltips[e.id]&&this.tooltips[e.id].destroy&&(this.tooltips[e.id].destroy(),delete this.tooltips[e.id])},render:function(){return this.container.setContent([{id:"RTCallingComponent_avatar",tag:"div",html:[{tag:"img",src:this.model.get("avatarUrl")}]},{id:"RTCallingComponent_video",tag:"div",class:"hidden",html:[{id:"RTCallingComponent_video_local",tag:"video",playsinline:"playsinline",muted:"true",autoplay:"true",class:"RTCallingComponent_video_local hidden"},{id:"RTCallingComponent_video_distant",tag:"video",playsinline:"playsinline"},{id:"RTCallingComponent_video_null",tag:"span",class:"fonticon fonticon-videocamera-off hidden"}]},{id:"RTCallingComponent_infos",tag:"div",html:[{id:"RTCallingComponent_username",tag:"span",text:this.model.get("username")},{id:"RTCallingComponent_subtitle",tag:"span",text:this.model.get("subtitle")?this.model.get("subtitle"):""},{id:"RTCallingComponent_callDuration",tag:"span",class:"hidden",text:"00:00"}]},{id:"RTCallingComponent_title",tag:"div",text:this.model.get("title")},{id:"RTCallingComponent_callDuration_video",tag:"span",class:"hidden",text:"00:00"},{id:"RTCallingComponent_icons",tag:"div",class:"RTCallingComponent_icons_calling",html:[{id:"RTwebrtc_icon_audio",tag:"span",class:"RTwebrtc_icon RTwebrtc_icon_audio fonticon fonticon-audio handler hidden",html:o.RTwebrtc_icon_audio,events:{click:this.getOnClickListener("RTwebrtc_icon_audio")}},{id:"RTwebrtc_icon_mic",tag:"span",class:"RTwebrtc_icon fonticon fonticon-microphone  handler hidden",html:o.RTwebrtc_icon_mic,events:{click:this.getOnClickListener("RTwebrtc_icon_mic")}},{id:"RTwebrtc_icon_video",tag:"span",class:"RTwebrtc_icon fonticon fonticon-videocamera handler hidden",html:o.RTwebrtc_icon_video,events:{click:this.getOnClickListener("RTwebrtc_icon_video")}},{id:"RTwebrtc_icon_phone_linked",tag:"span",class:"RTwebrtc_icon RTwebrtc_icon_phoneON fonticon fonticon-phone handler",html:o.RTwebrtc_icon_phone_linked,events:{click:this.getOnClickListener("RTwebrtc_icon_phone_linked")}},{id:"RTwebrtc_icon_phone",tag:"span",class:"RTwebrtc_icon RTwebrtc_icon_phoneON fonticon fonticon-phone handler",html:o.RTwebrtc_icon_phone,events:{click:this.getOnClickListener("RTwebrtc_icon_phone")}},{id:"RTwebrtc_icon_phoneOFF",tag:"span",class:"RTwebrtc_icon fonticon fonticon-phone hangup handler",html:o.RTwebrtc_icon_phoneOFF,events:{click:this.getOnClickListener("RTwebrtc_icon_phoneOFF")}}]},{id:"RTCallingComponent_buttons",tag:"div",class:"RTwebrtc_start_buttons fonticon fonticon-resize-small handler",events:{click:this.getOnClickListener("RTCallingComponent_buttons")}}]),this.buttons=this.container.children.RTCallingComponent_buttons,this.localDivVideo=this.container.children.RTCallingComponent_video.children.RTCallingComponent_video_local,this.addTooltip(this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_phone,i.acceptCall||"Answer"),this.addTooltip(this.container.children.RTCallingComponent_icons.children.RTwebrtc_icon_phoneOFF,i.refuseCall||"Hang up"),-1==this.model.get("state").indexOf("incoming")&&this.showOnCallIcons(),"calling"==this.model.get("state")&&this.removeIconsButHangUp(this.model.get("state")),this.hideButtons(),this.detectDoubleTapOnVideoAndAvatar(),this},destroy:function(){try{for(var e in this.tooltips)this.tooltips[e].destroy()}catch(e){}this._parent()},displaySpinner:function(){this.spinner?this.spinner.show():this.spinner=(new s).inject(this.container.children.RTCallingComponent_title).show(),this.showTitle()},hideSpinner:function(){this.spinner&&this.spinner.hide(),this.hideTitle()}})}),define("DS/InstantMessagingWebRTC/js/controller/RTCallingComponent",["UWA/Class","UWA/Class/Events","UWA/Class/Model","UWA/Class/Debug","UWA/Class/View","DS/RTProxyDriver/RTLogger","DS/PlatformAPI/PlatformAPI","DS/RTProxyDriver/RTProxyDriver","DS/RTDriver/RTDetectClient","i18n!DS/InstantMessagingWebRTC/assets/nls/feed","DS/InstantMessagingWebRTC/js/model/RTCallingComponentModel","DS/InstantMessagingWebRTC/js/view/RTCallingComponentView","DS/InstantMessagingWebRTC/js/model/NoiseMaker"],function(e,t,n,i,o,a,s,r,l,c,d,h,u){"use strict";var m=function(e,t){return e};return e.extend(t,{init:function(e){if(!e)return a.error("no arg provided");this.nwayActivated=e.nwayActivated,this.user=e.user,a.WebRTC("RTCallingComponent init for user "+this.user.login);var t,n=Object.assign(e.user,e,{sip:e.options&&e.options.sip});this.callingmodel=new d(n),this.callingview=new h({model:this.callingmodel,nwayActivated:this.nwayActivated,newuser:e.youHaveToAccept}),this.callingview.render(),this.callingview.inject(e.container||document.body),this.type=n.type,this.room_id=n.room_id,this.IamTheCaller=n.IamTheCaller,this.IacceptedCallOnRoom=n.IacceptedCallOnRoom,this.endCall=function(e,t){r.dispatch("endCall",[{IamTheCaller:this.IamTheCaller,room_id:this.room_id,reason:t,login:this.user.login,user_id:this.user.user_id,dontEndCallOnRoom:e}])},this.addEventToView=function(e,t){var n;this.callingview.addEvent(e,(n=this,function(e){t(e,n)}))},this.addEventToView("endCall",function(e,t){t.endCall(!1,"user_hangup")}),this.acceptCall=function(e,t){this.IacceptedCallOnRoom=this.room_id,r.dispatch("acceptCall",[{room_id:this.room_id,type:this.type,user_id:this.user.user_id,autoAccept:e&&e.autoAccept}]),clearTimeout(this.callMissed)},this.addEventToView("acceptCall",function(e,t){t.acceptCall()}),this.stopLocalVideo=function(e,t){this.callingmodel.set({localVideo:!1}),this.stopLocalVideoTrack()},this.addEventToView("stopLocalVideo",function(e,t){t.stopLocalVideo()}),this.startLocalVideo=function(e,t){this.callingmodel.set({localVideo:!0}),this.startLocalVideoTrack()},this.addEventToView("startLocalVideo",function(e,t){t.startLocalVideo()}),this.stopLocalAudio=function(e,t){this.stopLocalAudioTrack(),this.callingmodel.set({localAudio:!1})},this.addEventToView("stopLocalAudio",function(e,t){t.stopLocalAudio()}),this.startLocalAudio=function(e,t){this.startLocalAudioTrack(),this.callingmodel.set({localAudio:!0})},this.addEventToView("startLocalAudio",function(e,t){t.startLocalAudio()}),this.switchToVideo=function(e,t){this.type="video",this.callingmodel.setState("callvideo"),this.callingmodel.set("type","video");t=this;this.getLocalMedia(function(e,n){if(e)return null;t.createPeer(!0),t.peer3?t.peer3.addStreamOrTracks(n):t.peer2.addStreamOrTracks(n),a.WebRTC("Local Media Stream added to RTCPeerConnection"),t.renegotiating=!0,t.sendOffer(t.room_id,!0,null!=t.peer3)},!0,!0,!1,!0)},this.addEventToView("switchToVideo",function(e,t){t.switchToVideo()}),this.callMissed=setTimeout((t=this,function(){a.WebRTC("RTCallingComponent call timeout"),t.IamTheCaller?t.displayErrorAndEndCall("callTimeout",1e4,!0):t.displayErrorAndEndCall("callMissed",1e4)}),3e4)},updateUsername:function(e){if(!e||"string"!=typeof e)return a.error("RTCallingComponent updateUsername bad arg");a.WebRTC("RTCallingComponent updateUsername from "+this.user.username+" to "+e),this.user.username=e,this.callingmodel.set({username:e})},setVarOrDefault:function(e,t){return void 0===t?e:t},getLocalMedia:function(e,t,n,i,o){var s=this.setVarOrDefault(!0,t),r=this.setVarOrDefault(!0,n);s&&this.callingmodel.set("isMyVideoOn",!0);var l,c=(l=this,function(t){l.localStream=t,a.WebRTC("RTCallingComponent getLocalMedia got stream "+t.id),!e&&l.peer&&l.peer.addStreamOrTracks(t),e(null,l.localStream)}),d=function(t){return function(n){a.error(n);var i={NotFoundError:"localMediaError_NotFoundError",SecurityError:"localMediaError_SecurityError",AbortError:"localMediaError_AbortError",NotAllowedError:"localMediaError_NotAllowedError",NotReadableError:"localMediaError_NotReadableError",OverConstrainedError:"localMediaError_OverConstrainedError",TypeError:"localMediaError_TypeError",TrackStartError:"localMediaError_NotReadableError",PermissionDeniedError:"localMediaError_NotAllowedError",InvalidStateError:"localMediaError_NotReadableError",DevicesNotFoundError:"localMediaError_NotFoundError",ConstraintNotSatisfiedError:"localMediaError_OverConstrainedError",MediaDeviceFailedDueToShutdown:"localMediaError_NotReadableError",MediaDeviceKillSwitchOn:"localMediaError_NotReadableError",InternalError:"localMediaError_NotReadableError",NotSupportedError:"localMediaError_TypeError"}[n.name]||n.name;t.displayErrorAndEndCall(i),e(n)}}(this),h=t?2:1;navigator.getUserMedia||(navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia),this.localStream&&!o?c(this.localStream):this.dispatchEvent("getLocalMediaNway",{failCallback:d,successCallback:c,isVideo:s,isAudio:r,streamLengthAsked:h,constraintsVideo:this.callingmodel.get("constraintsVideo"),constraintsAudio:this.callingmodel.get("constraintsAudio")})},callEnded:function(e){if(e&&e.user&&e.user.user_id==this.user.user_id&&u.start("userout"),clearTimeout(this.callMissed),this.callingmodel.setState("ended"),this.callingmodel.stopCallDuration(),e&&"callMissed"==e.reason&&this.IamTheCaller&&(e.reason="callTimeout"),e&&"user_hangup"==e.reason&&(e.reason=null),this.displayErrorAndEndCall(e?e.reason:null,void 0,!0,!0),this.isStarted=!1,this.callingmodel.get("sip"))return this.mediaRecorder&&this.mediaRecorder.stop();this.peer?(this.peer.close(),delete this.peer,this.peer=null):a.WebRTC("callEnded but no peer"),this.peer2?(this.peer2.close(),delete this.peer2,this.peer2=null):a.WebRTC("callEnded no second peer to close"),this.peer3?(this.peer3.close(),delete this.peer3,this.peer3=null):a.WebRTC("callEnded no third peer to close")},mediaSourceReady:function(e){this.callingview.showDistantExtStream(e.mediaSource||document.mediaSource)},forEachLocalTrack:function(e){if(!e)return!1;if(!this.peer&&!this.peer2&&!this.peer3)return null;var t,n,i,o,a=[];for(n in(a=this.peer.getLocalStreams?this.peer.getLocalStreams():[this.localStream]).length||(a=[this.localStream]),this.peer2&&(a=a.concat(this.peer2.getLocalStreams())),this.peer3&&(a=a.concat(this.peer3.getLocalStreams())),a)if((o=a[n])&&"function"==typeof o.getTracks)for(t in i=o.getTracks())if(e(i[t]))break},logLocalTracks:function(){return this.forEachLocalTrack(a.WebRTC)},stopLocalTracks:function(){return this.forEachLocalTrack(function(e){e.stop()})},enableLocalTracks:function(){return this.forEachLocalTrack(function(e){e.enabled=!0})},stopLocalVideoTrack:function(){return a.WebRTC("stopLocalVideoTrack"),this.forEachLocalTrack(function(e){return"video"===e.kind&&(e.enabled=!1,!0)})},stopLocalAudioTrack:function(){return a.WebRTC("stopLocalAudioTrack"),this.forEachLocalTrack(function(e){return"audio"===e.kind&&(e.enabled=!1,!0)})},startLocalVideoTrack:function(){return a.WebRTC("startLocalVideoTrack"),this.forEachLocalTrack(function(e){return"video"===e.kind&&(e.enabled=!0,!0)})},startLocalAudioTrack:function(){return a.WebRTC("startLocalAudioTrack"),this.forEachLocalTrack(function(e){return"audio"===e.kind&&(e.enabled=!0,!0)})},muteLocalAudioTrack:function(){return this.forEachLocalTrack(function(e){return"audio"===e.kind&&(e.muted=!0),!1})},onSDP:function(e){if(e.user.login!=this.user.login)return a.error("onSDP received from "+e.user.login+" instead of "+this.user.login);e.isCaller?this.onOffer(e):this.onAnswer(e)},onAnswer:function(e){var t=this.peer3||this.peer2||this.peer,n=this.peer2,i=this.peer3;t=e.secondSwitch?this.peer3:e.renegotiating?this.peer2:this.peer,a.WebRTC("onAnswer "+t.signalingState),t.setRemoteDescription(new RTCSessionDescription(e.sdp)).catch(function(o){if(a.WebRTC("onAnswer setRemoteDescription failed, trying on other peer"),"peer2"==t.RTCidentifier)t=i;else{if("peer3"!=t.RTCidentifier)return a.error(o);t=n}t.setRemoteDescription(new RTCSessionDescription(e.sdp)).catch(function(e){a.error("onAnswer failed to setRemoteDescription "+e)})})},onOffer:function(e){a.WebRTC("onOffer ");var t,n=function(e,t){t()};e.secondSwitch?(this.peer3||this.createPeer(!0),t=this.peer3):e.renegotiating?(this.peer2||this.createPeer(!0),t=this.peer2):(this.peer||this.createPeer(!1),t=this.peer,n=function(e,n){e.getLocalMedia(function(e,i){if(e)return null;t.addStreamOrTracks(i),a.WebRTC("Local Media Stream added to RTCPeerConnection"),n()},"video"===e.type)});var i=this,o=this.callingmodel.get("bandwidth");t.setRemoteDescription(new RTCSessionDescription(e.sdp)).then(function(){a.WebRTC("onOffer setRemoteDescription success"),n(i,function(){t.createAnswer({mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0,offerToReceiveAudio:!0,offerToReceiveVideo:!0}}).then(function(n){o&&(n.sdp=m(n.sdp)),t.setLocalDescription(n).then(function(){a.WebRTC("onOffer setLocalDescription success"),r.dispatch("SDP",[{room_id:e.room_id,user_id:i.user.user_id,sdp:n,isCaller:!1,renegotiating:e.renegotiating,secondSwitch:e.secondSwitch}])}).catch()}).catch(function(e){})})}).catch(function(e){a.error("onOffer failed to setRemoteDescription "+e)})},sendOffer:function(e,t,n){if(!e)return a.error("RTCallingComponent sendOffer arg room_id needed");var i;i=n?this.peer3:t?this.peer2:this.peer,a.WebRTC("createOffer on peer "+i.RTCidentifier+" and send it to "+this.user.login+" on room "+e);var o=this,s=this.callingmodel.get("bandwidth");"audio"==this.type&&i.addTransceiver("video",{direction:"recvonly"}),i.createOffer({mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0,offerToReceiveAudio:!0,offerToReceiveVideo:!0}}).then(function(e){return s&&(e.sdp=m(e.sdp)),i.setLocalDescription(e)}).then(function(){r.dispatch("SDP",[{room_id:e,user_id:o.user.user_id,sdp:i.localDescription,isCaller:!0,renegotiating:t,secondSwitch:n}])}).catch(function(e){a.error("sendOffer failed to createOffer "+e)})},handleNegotiationNeededEvent:function(e){return function(){return a.WebRTC("handleNegotiationNeededEvent "+e.isCaller),!0}},callAccepted:function(e){if(this.callingmodel.startCallDuration(),clearTimeout(this.callMissed),this.room_id=e.room_id,!this.IacceptedCallOnRoom||this.IacceptedCallOnRoom!=e.room_id)return this.callEnded(),a.WebRTC("callAccepted on other device");if(this.type=e.autoAccepted&&!e.isCaller||!e.type?this.type||"audio":e.type,this.webrtcConfig=e.webrtcConfig,this.isCaller=e.isCaller,this.callingmodel.setState("call"),this.isStarted=!0,a.WebRTC("callAccepted of type "+e.type+" in room "+e.room_id+" isCaller : "+e.isCaller),a.table(e.webrtcConfig.iceServers),e&&e.options&&e.options.sip?(this.callingview.hideSpinner(),this.callingview.showCallDuration()):this.callingview.displaySpinner(),!this.callingmodel.get("sip")){if(!this.isCaller)return!0;this.createPeer(),this.peer.onnegotiationneeded=this.handleNegotiationNeededEvent(this),a.WebRTC("callAccepted RTCPeerConnection created. Getting local media...")}var t;return this.getLocalMedia((t=this,function(e,n){return a.WebRTC("callAccepted getLocalMedia done."),e?null:t.callingmodel.get("sip")?t.recordStream(n):(t.peer.addStreamOrTracks(n),a.WebRTC("Local Media Stream added to RTCPeerConnection"),void(t.isCaller&&t.sendOffer(t.room_id)))}),"video"===this.type),!0},recordStream:function(e){a.WebRTC("recordStream");this.mediaRecorder=new MediaRecorder(e,{audioBitsPerSecond:24e3}),this.mediaRecorder.ondataavailable=this.sendRecord,this.mediaRecorder.start(20)},sendRecord:function(e){r.dispatch("sipEvent",{action:"web-stream",data:e.data})},createPeer:function(e){if(this.peer&&!e)return a.error("RTCallingComponent can not createPeer that already exists");if(!this.webrtcConfig||!this.webrtcConfig.iceServers)return a.error("RTCallingComponent failed to createPeer without webrtcConfig.iceServers");var t,n,i=this.callingmodel.get("bandwidth");try{t=new RTCPeerConnection(this.webrtcConfig),e?this.peer2?(this.peer3=t,this.peer3.RTCidentifier="peer3"):(this.peer2=t,this.peer2.RTCidentifier="peer2"):(this.peer=t,this.peer.RTCidentifier="peer1")}catch(e){return this.displayErrorAndEndCall("localMediaError_TypeError"),a.error("RTCallingComponent failed to createPeer : RTCPeerConnection is undefined")}a.WebRTC("RTCallingComponent createPeer RTCPeerConnection done"),t.onnegotiationneeded=this.handleNegotiationNeededEvent(this),t.addStreamOrTracks=function(e){if(!e)return a.error("RTCallingComponent addStreamOrTracks called without stream "+t.RTCidentifier);if(a.WebRTC("addStreamOrTracks"),this.addTrack)try{var n,i=e.getTracks();for(n=0;n<i.length;n++)this.addTrack(i[n],e)}catch(e){a.error(e)}else if(this.addStream)try{this.addStream(e)}catch(e){a.error("RTCallingComponent addStreamOrTracks failed to addStream")}else a.error("RTCallingComponent addStreamOrTracks called but addTrack & addStream unexist "+t.RTCidentifier)},t.ontrack=(n=this,function(e){var i=e.stream||e.streams[0];if(!i)return a.error("ontrack raised but stream not found "+t.RTCidentifier);a.WebRTC("Remote stream received !"),n.callingmodel.set({streamReceived:!0}),n.dispatchEvent("streamReceived",{login:n.user&&n.user.login});var o=i.getTracks();(o.length>=2||"video"==o[0].kind)&&(n.callingmodel.setState("callvideo"),n.callingmodel.set({type:"video"})),n.callingview.showDistantStream(i),n.callingview.hideSpinner(),n.callingview.showCallDuration(),n.logLocalTracks(),n.distantStream=i}),t.onaddstream=t.ontrack,t.onicecandidate=function(t){return function(n){a.WebRTC("onicecandidate"),t.renegotiating||n.candidate&&r.dispatch("webrtcIceCandidate",[{room_id:t.room_id,user_id:t.user.user_id,candidate:n.candidate,renegotiating:e}])}}(this),t.onsignalingstatechange=function(e){return function(n){if(!t)return a.WebRTC("onsignalingstatechange changed but RTCPeerConnection is null");a.WebRTC("ICE Signaling state changed to "+t.signalingState),"stable"==t.signalingState?e.renegotiating=!1:"have-remote-offer"==t.signalingState&&(e.renegotiating=!0)}}(this),t.onicegatheringstatechange=function(e){t&&a.WebRTC("ICE Gathering state changed to "+t.iceGatheringState+" "+t.RTCidentifier)},t.oniceconnectionstatechange=function(e){return function(n){if(!t)return a.WebRTC("ICE Connection state changed but no peer "+t.RTCidentifier);var o=t.iceConnectionState;if(a.WebRTC("ICE Connection state changed to "+o+" "+t.RTCidentifier),"failed"==o)return e.displayErrorAndEndCall("ICEfailed");"connected"==o&&function(e,t){if(!e||!t)return a.WebRTC("updateSenderBandwidth bad params");if(!window.RTCRtpSender||!window.RTCRtpSender.prototype.setParameters)return a.WebRTC("updateSenderBandwidth no compatiblity");var n=function(){a.WebRTC("updateSenderBandwidth success setParameters")},i=function(e){a.WebRTC("updateSenderBandwidth error"+e)};try{var o=function(e){var o=e.getParameters();o.encodings||(o.encodings=[{}]),o.encodings[0]||(o.encodings[0]={}),o.encodings[0].maxBitrate=1e3*t,a.WebRTC("updateSenderBandwidth setting maxBitrate "+t+"kbps on sender "+e),e.setParameters(o).then(n,i)},s=e.getSenders();s[0]&&s[0].track&&"video"==s[0].track.kind?o(e.getSenders()[0]):s[1]&&s[1].track&&"video"==s[1].track.kind&&o(e.getSenders()[1])}catch(e){console.error(e)}}(t,i)}}(this)},displayErrorAndEndCall:function(e,t,n,i,o){var s,r=t||1e4;return this.callingview?this.room_id?(e&&this.callingview.displayError(e),i?e?setTimeout((s=this,function(){s.callingview.endCall(),s.callingmodel.setState("ended"),setTimeout(function(){s.callingview&&s.callingview.remove&&s.callingview.remove()},1e4)}),r):this.callingview.endCall():this.endCall(n,e,o),void a.WebRTC("displayErrorAndEndCall "+e)):a.error("RTCallingComponent displayErrorAndEndCall but no room_id "):a.error("RTCallingComponent displayErrorAndEndCall but no callingview ")},addCachedIceCandidates:function(){var e,t;for(t in this.peer&&"stable"==this.peer.signalingState&&"complete"==this.peer.iceGatheringState||a.error("addCachedIceCandidates unavailable "+(this.peer?this.peer.signalingState+this.peer.iceConnectionState+this.peer.iceGatheringState:"")),this.iceCandidates)e=this.iceCandidates[t],this.onWebRTCIceCandidate({candidate:e},!0)},onWebRTCIceCandidate:function(e,t){if(!this.peer)return a.error("Received an ICE candidate but no peer. Storing it for later"),this.iceCandidates||(this.iceCandidates=[]),this.iceCandidates.push(e.candidate);var n=this.peer3||this.peer2||this.peer,i=this.peer2,o=this.peer3;a.WebRTC("onWebRTCIceCandidate "+(t?"cached":"")+this.peer.signalingState+this.peer.iceConnectionState+this.peer.iceGatheringState),n.addIceCandidate(new RTCIceCandidate(e.candidate),function(){a.WebRTC("onWebRTCIceCandidate success")},function(t){if(a.WebRTC("onWebRTCIceCandidate addIceCandidate failed, trying on other peer. "+t),"peer2"==n.RTCidentifier)n=o;else{if("peer3"!=n.RTCidentifier)return a.error(t);n=i}n.addIceCandidate(new RTCIceCandidate(e.candidate),function(){a.WebRTC("onWebRTCIceCandidate success")},a.error)})},onCallEvent:function(e){"mute"==e.action?a.WebRTC("track of type "+e.type+" has been muted by "+e.login):a.WebRTC("onCallEvent "+JSON.stringify(e))},nway:function(){this.callingmodel.set({nway:!0}),this.callingview.container.draggable=!1}})}),define("DS/InstantMessagingWebRTC/js/view/RTCallingComponentViewNway",["UWA/Class","DS/InstantMessagingWebRTC/js/view/RTCallingComponentView"],function(e,t){"use strict";return t.extend({init:function(e){e.noRingtone=!0,this._parent(e),this.normalCameraIcon=!0,this.normalMicIcon=!0},displayMutedCameraIcon:function(e){this._parent(e),this.normalCameraIcon=!1},displayNormalCameraIcon:function(e){this._parent(e),this.normalCameraIcon=!0},toggleVideo:function(){this.normalCameraIcon?this.displayMutedCameraIcon():this.displayNormalCameraIcon()},displayMutedMicIcon:function(e){this._parent(e),this.normalMicIcon=!1},displayNormalMicIcon:function(e){this._parent(e),this.normalMicIcon=!0},toggleAudio:function(){this.normalMicIcon?this.displayMutedMicIcon():this.displayNormalMicIcon()},setTypeTo:function(e){"video"===e&&this.displayNormalCameraIcon(),"audio"===e&&this.displayMutedCameraIcon()},onClickListeners:{RTwebrtc_icon_mic:function(e,t){t.toggleAudio(),t.dispatchEvent("RTwebrtc_icon_mic",{enabled:t.normalMicIcon})},RTwebrtc_icon_audio:function(e,t){t.dispatchEvent("RTwebrtc_icon_audio")},RTwebrtc_icon_video:function(e,t){t.toggleVideo(),t.dispatchEvent("RTwebrtc_icon_video",{enabled:t.normalCameraIcon})},RTwebrtc_icon_phoneOFF:function(e,t){t.dispatchEvent("RTwebrtc_icon_phoneOFF")},RTCallingComponent_buttons:function(e,t){t.container.parentElement.hasClassName("minimized")?t.maximize():t.minimize()}},minimize:function(){this.container.parentElement.addClassName("minimized"),this.setSizeButtonFull(),this.removeIconsButHangUp(),this.dispatchEvent("minimizeNWAY"),this.hideCallDureeVid(),-1===navigator.platform.indexOf("iPhone")&&-1===navigator.platform.indexOf("iPod")&&-1===navigator.platform.indexOf("iPad")&&0===navigator.maxTouchPoints&&this.setDraggable(this.container.parentElement)},maximize:function(){this.container.parentElement.style.top="",this.container.parentElement.style.left="",this.container.parentElement.style.bottom="",this.container.parentElement.removeClassName("minimized"),this.setSizeButtonSmall(),this.showOnCallIcons(),this.dispatchEvent("maximizeNWAY")},render:function(e){this._parent(e),this.container.addClassName("nwaycontainer"),this.hideAvatar(),this.hideTitle(),this.hideInfos(),this.showOnCallIcons(),e.container&&this.container.children.RTCallingComponent_buttons.inject(e.container);try{this.detectDoubleTapOn(this.container.children.RTCallingComponent_video.children.RTCallingComponent_video_local,200,3)}catch(e){}},endCall:function(){logger.error("no way to get here")}})}),define("DS/InstantMessagingWebRTC/js/controller/RTCallingComponentNway",["UWA/Class","UWA/Class/Events","UWA/Class/Model","UWA/Class/Debug","UWA/Class/View","UWA/Class/Collection","DS/RTProxyDriver/RTLogger","DS/PlatformAPI/PlatformAPI","DS/RTProxyDriver/RTProxyDriver","i18n!DS/InstantMessagingWebRTC/assets/nls/feed","DS/InstantMessagingWebRTC/js/model/RTCallingComponentModel","DS/InstantMessagingWebRTC/js/view/RTCallingComponentViewNway"],function(e,t,n,i,o,a,s,r,l,c,d,h){"use strict";return e.extend(t,{init:function(e){if(!e)return s.error("no arg provided");this.nwayActivated=e.nwayActivated,s.WebRTC("RTCallingComponentNway init"),this.failCallbacks=[],this.successCallbacks=[],this.onCallComponentsView=UWA.createElement("div",{id:"RTOnCallComponents",draggable:"true"}),this.onCallComponentsView.inject(e.container||document.body),this.onCallComponentsView.hide(),this.callingmodel=new d(e),this.callingmodel.setState("callvideo"),this.callingview=new h({model:this.callingmodel}),this.callingview.render({container:this.onCallComponentsView}),this.callingview.hide(),this.callingComponents=[],this.addEventToView=function(e,t){var n;this.callingview.addEvent(e,(n=this,function(e){t(e,n)}))};var t=["RTwebrtc_icon_phoneOFF","RTwebrtc_icon_mic","RTwebrtc_icon_audio","RTwebrtc_icon_video"];for(var n in t)!function(e,t){t.addEventToView(e,function(n,i){var o;for(var a in t.callingComponents)(o=t.callingComponents[a]).callingview.onClickListeners[e](null,o.callingview)})}(t[n],this);this.addEventToView("RTwebrtc_icon_phoneOFF",function(e,t){t.remove()}),this.addEventToView("RTwebrtc_icon_mic",function(e,t){e.type="audio",e.action="mute",e.room_id=t.room_id,l.dispatch("callEventFromView",e)}),this.addEventToView("RTwebrtc_icon_video",function(e,t){e.type="video",e.action="mute",e.room_id=t.room_id,l.dispatch("callEventFromView",e)}),this.addEventToView("minimizeNWAY",function(e,t){t.isMaximized=!1,t.onCallComponentsView.draggable=!0,t.nwayActivated?t.isNway()&&t.callViewMethodOfAllComponents("hideAvatar"):t.callViewMethodOfAllComponents("minimize")}),this.addEventToView("maximizeNWAY",function(e,t){t.isMaximized=!0,t.onCallComponentsView.draggable=!1,t.nwayActivated?t.isNway()&&t.callViewMethodOfAllComponents("showAvatar"):t.callViewMethodOfAllComponents("maximize")}),this.addEventToView("doubleClick",function(e,t){try{var n=document.getElementsByClassName("compass-small")[0];n.isHidden()&&(n=document.getElementsByClassName("topbar-logo")[0]),n.transformed=!n.transformed,n.addClassName("IM-rotation"),n.removeClassName("rotationUp"),n.removeClassName("rotationDown"),n.addClassName("rotation"+(n.transformed?"Up":"Down"))}catch(e){}})},remove:function(){var e;this.onCallComponentsView.style.transform="scale(0)",this.callingview.hide(),this.hideAfterRemove=setTimeout((e=this,function(){e.onCallComponentsView.hide()}),500)},updateComponentsClassName:function(){var e,t=this.callingComponents.length,n=0;for(var i in this.fulledCC&&(n=-1),this.callingComponents)(e=this.callingComponents[i])!==this.fulledCC&&(e.callingview.container.removeClassName("qty"+(t>10?"Infinite":t-1+n)),e.callingview.container.removeClassName("qty"+(t>10?"Infinite":t+1+n)),e.callingview.container.addClassName("qty"+(t>10?"Infinite":t+n)))},removeClassFromAllComponents:function(e){for(var t in this.callingComponents)this.callingComponents[t].callingview.container.removeClassName(e)},callViewMethodOfAllComponents:function(e,t){for(var n in this.callingComponents)this.callingComponents[n].callingview[e](t)},addComponent:function(e){if(!e)return s.error("addComponent bad arg");if(-1!=this.callingComponents.indexOf(e))return s.WebRTC("cc already injected");var t;for(var n in clearTimeout(this.hideAfterRemove),this.room_id=e.room_id,this.show(),e.callingview.inject(this.onCallComponentsView),this.callingComponents.push(e),this.callingview.setTypeTo(e.type),this.callingview.displayNormalMicIcon(),this.callingview.displayNormalCameraIcon(),this.callViewMethodOfAllComponents("toggleMic",!0),e.nway(),this.nwayActivated&&(this.isMaximized?this.callingview.dispatchEvent("maximizeNWAY"):this.callingview.dispatchEvent("minimizeNWAY")),e.addEventToView("doubleClick",(t=this,function(e,n){t.removeClassFromAllComponents("fulled"),t.fulledCC!=n?(n.callingview.container.addClassName("fulled"),t.fulledCC=n):t.fulledCC=null,t.updateComponentsClassName()})),this.callingview.show(),this.onCallComponentsView.addClassName("nway"),this.callingview.inject(this.onCallComponentsView),this.callingview.showButtons(),this.updateComponentsClassName(),this.isNway()||this.callingview.minimize(),this.callingComponents)this.callingComponents[n]&&this.callingComponents[n].isStarted&&this.callingComponents[n].callingview&&this.callingComponents[n].callingview.container&&this.callingComponents[n].nway();this.addEventToCC(e,"getLocalMediaNway",function(e,t){t.getLocalMedia(e)}),this.addEventToCC(e,"streamReceived",function(e,t){t.dispatchEvent("streamReceived",e)})},addEventToCCView:function(e,t,n){var i;e.callingview.addEvent(t,(i=this,function(e){n(e,i)}))},addEventToCC:function(e,t,n){var i;e.addEvent(t,(i=this,function(e){n(e,i)}))},getLocalMedia:function(e){this.failCallbacks.push(e.failCallback),this.successCallbacks.push(e.successCallback);var t,n=e.isVideo,i=e.isAudio,o=e.streamLengthAsked,a=(t=this,function(e){for(var n in t.localStream=e,s.WebRTC("RTCallingComponentNway getLocalMedia ending with stream "+e.id),t.successCallbacks)t.successCallbacks[n](e),delete t.successCallbacks[n],delete t.failCallbacks[n],t.mutexGetLocalMedia=!1;t.callingview.showLocalStream(e)}),r=function(e){return function(t){for(var n in e.failCallbacks)e.failCallbacks[n](t),delete e.failCallbacks[n],delete e.successCallbacks[n],e.mutexGetLocalMedia=!1}}(this);if(this.localStream&&this.localStream.active&&this.localStream.getTracks().length>=o)return a(this.localStream);if(this.localStream=null,this.mutexGetLocalMedia)return s.WebRTC("RTCallingComponentNway getLocalMedia waiting");this.mutexGetLocalMedia=!0,s.WebRTC("RTCallingComponentNway getLocalMedia starting");var l,c,d=e.constraintsVideo,h=e.constraintsAudio;try{l=navigator.mediaDevices.getSupportedConstraints()}catch(e){l=null}if(l){for(c in d)l[c]||delete d[c];for(c in h)l[c]||delete h[c]}else d=null,h=null;d&&d!={}||h&&h!={}?(s.WebRTC("video constraints to apply : "+JSON.stringify(d)),s.WebRTC("audio constraints to apply : "+JSON.stringify(h))):s.WebRTC("no constraints to apply"),navigator.getUserMedia||(navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia),navigator.mediaDevices?navigator.mediaDevices.getUserMedia({video:n&&d,audio:i&&h,googTypingNoiseDetection:!1,googEchoCancellation:!0,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1}).then(a,r):navigator.getUserMedia?navigator.getUserMedia({video:n&&d,audio:i&&h,googTypingNoiseDetection:!1,googEchoCancellation:!0,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1},a,r):(s.WebRTC("no navigator getLocalMedia method found"),r({name:"NotReadableError"}))},updateLocalVideo:function(e){this.callingview.localDivVideo.src=e||this.callingComponents[0].callingview.localDivVideo.src,this.callingview.localDivVideo.load(),this.callingview.localDivVideo.muted=!0,this.callingview.hideVideoNull(),this.callViewMethodOfAllComponents("pauseLocalVideo")},removeComponent:function(e,t){return e&&-1!=this.callingComponents.indexOf(e)?(s.WebRTC("removeComponent "+e.room_id+e.user.login),this.callingComponents.splice(this.callingComponents.indexOf(e),1),this.updateComponentsClassName()):s.WebRTC("removeComponent bug, update container anyway"),0==this.callingComponents.length?(this.removeCCtimeout=setTimeout((n=this,function(){n.stopLocalTracks(),n.remove()}),t?1e4:1e3),!1):(s.WebRTC("there is still at least one another CC "+this.callingComponents.length),!0);var n},stopLocalTracks:function(){var e=this.localStream;if(!e)return!0;var t=e.getTracks();for(var n in t)t[n].stop()},show:function(){this.callingview.show(),this.onCallComponentsView.show(),this.onCallComponentsView.style.transform="",this.removeCCtimeout&&(clearTimeout(this.removeCCtimeout),this.removeCCtimeout=null)},isNway:function(e){return this.callingComponents.length>1}})}),define("DS/InstantMessagingWebRTC/InstantMessagingWebRTC",["UWA/Class","UWA/Class/Events","UWA/Class/Options","DS/WAFData/WAFData","DS/UWPClientCode/PublicAPI","DS/RTProxyDriver/RTLogger","DS/RTProxyDriver/RTProxyDriver","i18n!DS/InstantMessagingWebRTC/assets/nls/feed","DS/PlatformAPI/PlatformAPI","DS/RTColors/RTColors","DS/InstantMessagingWebRTC/js/controller/RTCallingComponent","DS/InstantMessagingWebRTC/js/controller/RTCallingComponentNway","DS/InstantMessagingWebRTC/js/model/RTCallingTracker","DS/UIKIT/Alert","DS/InstantMessagingWebRTC/js/model/NoiseMaker"],function(e,t,n,i,o,a,s,r,l,c,d,h,u,m,C){"use strict";return a.addLevel("WebRTC","purple"),a.WebRTC("InstantMessagingWebRTC load 04/18/2019"),e.extend(t,n,{init:function(e){if(!e)return a.WebRTC("InstantMessagingWebRTC needs params");var t=e.audiovideoV2;if(t)return InstantMessagingCall.init({audiovideoV2:t,base_url:e.url,platformId:e.platformId}),a.WebRTC("v1 init bypassed");if(this.setOptions(e),!e.url)return a.WebRTC("InstantMessagingWebRTC needs url");this.url=e.url,this.is=window.ds&&"MOBILE"==window.ds.env||window.top&&window.top.ds&&"MOBILE"==window.top.ds.env,this.baseurl=e.url.replace(":5281","").replace(":443","").replace(":3480","").replace("/rest","/"),this.platformId=e.platformId,this.login=e.login;var n=l.getUser();n&&(this.username=n.firstName+" "+n.lastName),this.jid=this.login+"@"+this.platformId.toLowerCase()+".im.3ds.com",this.nwayActivated=!0,this.credential=e.credential,this.devEnv=e.devEnv,this.container=e.container,this.swymUrl=e.swymUrl,this.passportUrl=e.passportUrl,this.doLogRTC=e.doLogRTC,this.ringtoneURL=e.ringtoneURL,this.callingComponents={},this.callingComponentsView=UWA.createElement("div",{id:"RTCallingComponents"}),this.callingComponentsView.inject(document.body),this.onCallComponents=new h({nwayActivated:this.nwayActivated}),e.doLogRTC?C.set("ringtone","../../resources/en/1/webapps/InstantMessagingWebRTC/assets/ringtone.wav"):this.ringtoneURL&&C.set("ringtone",this.ringtoneURL),C.preload(),this.setStatus=function(e){s.dispatch(s.eventName.SETSTATUS,{myStatus:e,statusMsg:e})},this.logIntoRTC=function(e){var t=e.passportUrl,n={nameApp:"3DIM",driverName:"NODE",url:e.url,domaineName:e.platformId,username:e.username,passportUrl:t,credentials:{jid:e.jid,user:e.login,password:null}};s.dispatch(s.eventName.SETDRIVER,[n])},this.doLogRTC&&this.logIntoRTC(this),this.presenceListener=function(e){if(!(e&&e.status&&e.status.toLowerCase&&e.userId))return a.WebRTC("ONPRESENCERECEIVED bad params");var t=e.userId.split("@"),n=c[e.status.toLowerCase()];l.publish(e.userId,{login:t[0],action:"setStatus",status:e.status,presence:e.status,color:n})};var i;this.platformId;return this.platformListener=(i=this,function(e){switch(e.action){case"getStatus":var n={userName:e.username,login:e.login,userId:e.login};s.dispatch(s.eventName.GETSTATUS,[n]);break;case"startCall":if(t)a.WebRTC("v1 bypassed");else{if(i.onCallComponents&&i.onCallComponents.callingComponents&&i.onCallComponents.callingComponents.length&&!o.getApplicationConfiguration("app.rtc.callAlwaysAvailable")&&i.onCallComponents.callingComponents[0].isStarted)return i.displayAlreadyCallingAlert();if(e.isJoinable||i.startTracking(e),!i.isConnected&&!i.isMobile)return i.callTracker.logEnded(i.login||l.getUser().login,"offline"),i.stopTracking(!0),i.displayDiscoAlert()}s.dispatch("startCall",[{login:e.login,logins:e.logins,username:e.username,type:e.type,options:{sip:e.sip||e.options&&e.options.sip,uri:e.uri,orderId:e.orderId,dmId:e.dmId,swymUrl:e.swymUrl||e.options&&e.options.swymUrl||i.swymUrl}}]);break;case"whoami":l.publish("im.ds.com",{action:"youare",login:i.login,userId:i.login,username:i.username})}}),l.subscribe("im.ds.com",this.platformListener),this.connectedListener=function(e){return function(t){e.user_id=t.user_id,e.clientDevice=t.clientDevice,e.isConnected=!0,e.displayConnectedAlert()}}(this),this.disconnectedListener=function(e){return function(){for(var t in e.isConnected=!1,e.callingComponents)e.callingComponents[t]&&e.callingComponents[t].callingview&&e.callingComponents[t].callingview.container&&e.callingComponents[t].callingview.container.hide()}}(this),this.findCallingComponent=function(e){this.user_id||a.WebRTC("findCallingComponent called but no user_id loaded !!");var t=(e.room_id||e.room&&e.room.room_id)+(e.user_id||e.user.user_id);return{key:t,callingComponent:this.callingComponents?this.callingComponents[t]:null}},this.findAllCCOfRoom=function(e){if(!e)return a.error("IMWebRTC findAllCCOfRoom called without room_id");var t={};for(var n in this.callingComponents)-1!=n.indexOf(e)&&(t[n]=this.callingComponents[n]);return t},this.sendBrowserNotif=function(e){l.publish("3dnotifinterne",{username:e.user.username,login:e.user.login,type:e.type,tenant:this.platformId,textNotif:"You are being "+e.type+" called by "+e.user.username,titleNotif:"Call incoming",action:"notifyBrowser"})},this.spawnCallingComponent=function(e){var t=e;e.clientDevice=this.clientDevice,t.room_id=e.room.room_id,t.devEnv=this.devEnv,t.sip=e.sip,t.nwayActivated=this.nwayActivated,this.swymUrl=e.swymUrl||e.options&&e.options.swymUrl||this.swymUrl,t.avatarUrl=this.swymUrl?this.swymUrl+"/api/user/getpicture/login/"+e.user.login+"/format":void 0,t.orderId=e.orderId||(e.options?e.options.orderId:null),t.IamTheCaller=e.IamTheCaller,this.IamTheCaller=e.IamTheCaller,t.container=this.callingComponentsView;var n=this.findCallingComponent(e).callingComponent;if(n&&n.callEnded(),this.callingComponents[this.findCallingComponent(e).key]=new d(t),(n=this.findCallingComponent(e).callingComponent).callingmodel.get("sip")&&s.addEvent("mediaSourceReady",n.mediaSourceReady.bind(n)),e.youHaveToAccept){if(!this.checkIfIAlreadyAcceptedTheCall(e.room.room_id)&&this.IacceptedCallOnRoom!=e.room.room_id)return a.error("Spawning a CallingComponent with auto accept, but I didn't accept the call !!!");a.WebRTC("auto accept the call"),n.acceptCall({autoAccept:!0},n),n.nway()}return e.error?n.displayErrorAndEndCall(e.error,void 0,!0,!0):e.clientDevice&&!e.clientDevice.WebRTCCompatible?n.displayErrorAndEndCall("localMediaError_TypeError",void 0,!1,!1,"noCompatibleBrowser"):(n.sentPresenceListener=function(t){if(!(t&&t.status&&t.status.toLowerCase&&t.userId))return a.WebRTC("ONPRESENCERECEIVED bad params");var i=t.userId.split("@")[0];e.user.login==i&&("Offline"==t.status&&(a.WebRTC(i+" goes offline then endCall"),n.displayErrorAndEndCall("ICEdisconnected",void 0,!0)),t.username&&t.username!=t.login&&t.username!=n.user.username&&n.updateUsername(t.username))},n)},this.spawnSentCallingComponent=function(e){return function(n){if(t)return a.WebRTC("v1 bypassed");if(n.IamTheCaller=!0,n.IacceptedCallOnRoom=n.room_id||n.room.room_id,e.IacceptedCallOnRoom=n.IacceptedCallOnRoom,e.callTracker&&e.callTracker.logInviteSent(n),n.error&&"noConnectedClient"==n.error)return a.WebRTC("The user "+n.user.login+" is offline.");var i=e.spawnCallingComponent(n);e.onCallComponents.addComponent(i)}}(this),this.spawnReceivedCallingComponent=function(e){return function(n){return t?a.WebRTC("v1 bypassed"):(n.IamTheCaller=!1,n.state="incoming",n.youHaveToAccept&&!e.checkIfIAlreadyAcceptedTheCall(n.room.room_id)&&e.IacceptedCallOnRoom!=n.room.room_id?a.WebRTC("User joined my call of another device"):(n.youHaveToAccept&&e.IacceptedCallOnRoom&&C.start("userin"),e.spawnCallingComponent(n),void e.sendBrowserNotif(n)))}}(this),this.checkIfIAlreadyAcceptedTheCall=function(e){var t=this.findAllCCOfRoom(e);for(var n in t)if(t[n]&&t[n].isStarted)return!0;return!1},this.endAllCalls=function(e){return function(n){if(t)return a.WebRTC("v1 bypassed");for(var i in a.WebRTC("endAllCalls "),e.callingComponents)e.callingComponents[i].endCall(!1,n)}}(this),this.callEndedListener=function(e){return function(n){if(t)return a.WebRTC("v1 bypassed");var i,o={};n.user_id&&n.user_id!=e.user_id?(a.WebRTC("end call with "+n.user_id+" on the room "+n.room_id),o[(d=e.findCallingComponent({room_id:n.room_id,user_id:n.user_id})).key]=d.callingComponent):(a.WebRTC("end call with everybody on the room "+n.room_id),o=e.findAllCCOfRoom(n.room_id||n.room.room_id));for(var r in e.callTracker&&n.user&&n.user.login&&e.callTracker.logEnded(n.user.login,n.reason),o){(i=e.callingComponents[r])?(i.callEnded(n),s.removeEvent(s.eventName.ONPRESENCERECEIVED,i.sentPresenceListener),s.removeEvent("mediaSourceReady",i.mediaSourceReady),delete e.callingComponents[r]):a.WebRTC("callingComponent of the room "+(n.room_id||n.room.room_id)+" does not exist anymore !");var l=e.onCallComponents.removeComponent(i,n.reason),c=l;if(!c)for(var d in e.callingComponents){c=!0;break}l||(e.setStatus("Online"),e.IacceptedCallOnRoom=null),c||(e.stopTracking(),e.IacceptedCallOnRoom=null)}i||a.WebRTC("A call has been ended on another device.")}}(this),this.webrtcIceCandidateReceivedListener=function(e){return function(n){if(t)return a.WebRTC("v1 bypassed");var i=e.findCallingComponent(n).callingComponent;if(!i)return a.WebRTC("webrtcIceCandidateReceived on another device or for another user of the room");i.onWebRTCIceCandidate(n)}}(this),this.beforeUnload=function(e){return function(){if(t)return a.WebRTC("v1 bypassed");e.setStatus("Online"),e.endAllCalls("ICEdisconnected")}}(this),this.callAcceptedListener=function(n){return function(i){if(!i||!i.webrtcConfig||!i.webrtcConfig.iceServers)return a.error("callAccepted without webrtcConfig.iceServers");if(t)return a.WebRTC("v1 bypassed");for(var o=n.findCallingComponent(i),r=n.callingComponents[o.key],l=o.key,c=0;c<i.webrtcConfig.iceServers.length;c++)i.webrtcConfig.iceServers[c].urls=i.webrtcConfig.iceServers[c].url.replace("REPLACEMEWITHRTCDNS:3478",n.baseurl+"/coturn"),i.webrtcConfig.iceServers[c].url=i.webrtcConfig.iceServers[c].url.replace("REPLACEMEWITHRTCDNS:3478",n.baseurl+"/coturn");if(a.WebRTC("callAccepted callingComponent id searched and "+(r?"":"not")+" found : "+n.findCallingComponent(i).key),r&&!r.isStarted){if(r.callingview.show(),n.onCallComponents.addComponent(r),r.callAccepted(i)?i.autoAccepted||i.user.user_id==n.user_id||C.start("userin"):(n.callingComponents[l]=null,n.onCallComponents.removeComponent(r)),!n.nwayActivated)for(var d in n.callingComponents)d!=l&&(n.callingComponents[d].displayErrorAndEndCall(null),n.callingComponents[d].callEnded())}else{if(!i.nway)return a.WebRTC("A call has been received on another device.");if(!n.checkIfIAlreadyAcceptedTheCall(i.room_id))return a.WebRTC("A call has been accepted by another user in the room, but I still don't have answered the call, then do nothing.");if(n.findCallingComponent(i).callingComponent)return a.WebRTC("A call has been accepted by another user in the room and I already am in call with him, then do nothing.");a.WebRTC("A call has been accepted by another user in the room, we need to create a new CallingComponent with him"),s.dispatch("startCall",[{login:i.user.login,type:i.type,alreadyStarted:!0,room_id:i.room_id}])}e.doLogRTC,n.callTracker&&n.callTracker.logAccepted(i.user.login),n.setStatus("Busy")}}(this),this.SDPreceivedListener=function(e){return function(n){if(t)return a.WebRTC("v1 bypassed");var i=e.findCallingComponent(n).callingComponent;if(!i)return a.WebRTC("SDPreceived on another device or for another user of the room");i.onSDP(n)}}(this),this.callEventListener=function(e){return function(n){if(t)return a.WebRTC("v1 bypassed");if("notCallable"==n.action){if(!n.data||!n.data.uncallableUsers||!n.data.uncallableUsers.length)return a.error("callEventListener notCallable bad params");var i;if(e.callTracker){for(var o in n.data.uncallableUsers)i=n.data.uncallableUsers[o],e.callTracker.logEnded(i.login,"Busy");n.data.uncallableUsers.length==e.callTracker.UsersStatus.length-1&&e.stopTracking(!0)}e.addAlert(((n.data.uncallableUsers.length>1?r.callUnavailablePlurial:r.callUnavailableSingular)||"{0}/{1} callees are not callable").replace("{0}",n.data.uncallableUsers.length).replace("{1}",n.data.callableLogins.length+n.data.uncallableUsers.length-1),"warning")}else{var s=e.findCallingComponent(n).callingComponent;if(!s)return a.WebRTC("callEvent on another device or for another user of the room");s.onCallEvent(n)}}}(this),s.addEvent("CONNECTED",this.connectedListener),s.addEvent("DISCONNECTED",this.disconnectedListener),s.addEvent(s.eventName.ONPRESENCERECEIVED,this.presenceListener),s.addEvent("inviteSent",this.spawnSentCallingComponent),s.addEvent("inviteToCall",this.spawnReceivedCallingComponent),s.addEvent("callEnded",this.callEndedListener),s.addEvent("callAccepted",this.callAcceptedListener),s.addEvent("webrtcIceCandidateReceived",this.webrtcIceCandidateReceivedListener),s.addEvent("SDPreceived",this.SDPreceivedListener),s.addEvent("callEvent",this.callEventListener),l.publish("fromwidgetim.ds.com",{evenement:"GETLOGINOKDATA"}),!0},stopTracking:function(e){this.callTracker?(this.IamTheCaller&&this.callTracker.endCall(e),this.callTracker.destroy(),this.callTracker=null):a.WebRTC("callTracker does not exist")},startTracking:function(e){var t;this.callTracker=new u(Object.assign({},e,{logins:e.logins||e.login,caller:this.login,swymBaseUrl:e.swymUrl||e.options&&e.options.swymUrl||("none"!=this.swymUrl?this.swymUrl:null)})),this.onCallComponents.addEvent("streamReceived",(t=this,function(e){t.callTracker&&t.callTracker.logStream(e.login)}))},displayAlreadyCallingAlert:function(){this.displayAlert(r.alreadyOnCall||"You are already on a call.","warning")},displayDiscoAlert:function(){this.displayAlert(r.startCallAbortedBecauseOffline||"Connexion lost, please try again later."),this.alertMessage.connexionLost=!0},displayConnectedAlert:function(){if(!this.alertMessage||!this.alertMessage.connexionLost)return!0;this.displayAlert(r.connexionRetrieved||"Connexion retrieved.","success"),this.alertMessage.connexionLost=!1},displayAlert:function(e,t){if(!e)return a.WebRTC("can not displayAlert without errorMessage");this.alertMessage&&this.alertMessage.destroy(),this.alertMessage=new m({autoHide:!0,hideDelay:1e4,visible:!0,fullWidth:!1,renderTo:document.body}),this.alertMessage.elements.container.setStyles({position:"absolute",top:"50px",margin:"auto 0",right:"0",left:"0"}),this.alertMessage.show(),this.alertMessage.add({className:t||"error",message:e})},addAlert:function(e,t){if(!e)return a.WebRTC("can not addAlert without errorMessage");this.alertMessageStackable||(this.alertMessageStackable=new m({autoHide:!0,hideDelay:5e3,visible:!0,fullWidth:!1,renderTo:document.body})),this.alertMessageStackable.elements.container.setStyles({position:"absolute",top:"50px",margin:"auto 0",right:"0",left:"0"}),this.alertMessageStackable.show(),this.alertMessageStackable.add({className:t||"error",message:e})}})});