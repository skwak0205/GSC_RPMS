define("DS/MSFDocumentManagement/MSFDocumentClient",["UWA/Core","UWA/Utils/InterCom"],function(e,t){"use strict";var n=!1,o={},i=void 0,s={MSF_NOT_AVAILABLE_RESPONSE:7,MSF_CALL_SUCCESS_RESPONSE:1,isMSFDocServerInitialized:!1,msfLocalCacheCollection:{},MSFResponse:void 0,MSFDocumentServer:null,onConnectWithMSF:function(t,n,o,i,s,a){var l=this;e.Utils.Client.Platform.windows&&require(["DS/MSFDocumentManagement/MSFDocumentServer"],function(e){try{e&&(l.isMSFDocServerInitialized=!0,l.MSFDocumentServer=e,l.MSFDocumentServer.onConnectWithMSF(t,n,o,i,s,a))}catch(e){console.log(e)}})},isConnectedToMSFClient:function(){return this.MSFDocumentServer.isConnectedWithMSF()},initializeMSFInterComClient:function(){(o=new t.Socket("SocketClient")).subscribeServer("uwa.embedded"),o.addListener("getResponse",this.getMSFResponse.bind(this)),n=!0},downloadDocumentFromMSF:function(t,n,o,i){var s=this,a=i.onComplete,l=i.onFailure,r=e.clone(i||{},!1);r.documentId=t,r.fileId=n,r.Checkout=o,r.onComplete=function(t){t.onComplete=a,t.onFailure=l,s.MSFResponse.MSFResult===s.MSF_CALL_SUCCESS_RESPONSE?e.is(t.onComplete,"function")&&t.onComplete(t):""!==s.MSFResponse.ErrorMessage&&e.is(t.onFailure,"function")&&t.onFailure(s.MSFResponse.ErrorMessage),this.MSFResponse=void 0},!1===o?s.downloadDocument(r):s.checkoutDocument(r)},downloadDocumentsFromMSF:function(e,t){for(var n=0;n<e.length;n++)this.downloadDocumentFromMSF(e[n],void 0,!1,t)},creatDocumentFromMSF:function(t,n){var o=this,i=n.onComplete,s=n.onFailure,a=e.clone(n||{},!1);a.onComplete=function(t){t.onComplete=i,t.onFailure=s,o.MSFResponse&&(o.MSFResponse.MSFResult===o.MSF_CALL_SUCCESS_RESPONSE?e.is(t.onComplete,"function")&&t.onComplete(t):""!==o.MSFResponse.ErrorMessage&&e.is(t.onFailure,"function")&&t.onFailure(o.MSFResponse.ErrorMessage)),o.MSFResponse=void 0},t.id?t.fileInfo&&t.fileInfo.file&&(t.fileInfo.fileId||!t.fileInfo.newFile?o.checkIn(t,a):o.addFiles(t,a)):!t.fileInfo||t.fileInfo.file instanceof window.File||!t.fileInfo.file.FileToUpload||o.createNew(t,a)},MSFUploadObjectList:function(t,n){var o=this,i=n._options;i.onComplete=function(i){s.MSFResponse.MSFResult===o.MSF_CALL_SUCCESS_RESPONSE?n.model.add(t,s.MSFResponse.RequestData.MSFFileFormatDetails,i):5===s.MSFResponse.MSFResult?s.MSFResponse=void 0:""!==s.MSFResponse.ErrorMessage&&e.is(i.onFailure,"function")&&i.onFailure(s.MSFResponse.ErrorMessage)},this.selectFiles(i)},MSFCallCheckout:function(e,t,n,o,i,s,a,l){var r,c,d=JSON.parse("{}");d.RequestType=e,d.DocumentID=t,d.PartId=n,d.DocumentType=o,d.parentOID=i,r=s?s.split(","):t.split(",");for(var S=0;S<r.length;S++)0===S&&(c=JSON.parse('{"MSFFileFormatDetails":[{"FileName": "", "Format" : "", "VersionId": ""}]}')),a&&(c.MSFFileFormatDetails[S].FileName=a,c.MSFFileFormatDetails[S].Format=l),r[S]&&(0===S?c.MSFFileFormatDetails[S].VersionId=r[S]:c.MSFFileFormatDetails.push({FileName:a,Format:l,VersionId:r[S]}));d.MSFFileFormatDetails=c.MSFFileFormatDetails,this.sendMessage(d)},getMSFResponse:function(t){var n,o=t.RequestData?t.RequestData.RequestId:t.RequestId,i=o?this.msfLocalCacheCollection[o]:null;if(void 0!==t.ResultData&&""!==t.ResultData&&(n=JSON.parse(t.ResultData),i.data=n.data),o&&delete this.msfLocalCacheCollection[o],i)if(window.widget)this.MSFResponse=t,e.is(i.onComplete,"function")&&i.onComplete(i);else try{t.MSFResult!==this.MSF_CALL_SUCCESS_RESPONSE||"checkout"!==t.RequestData.RequestType&&"CheckIn"!==t.RequestData.RequestType&&"AddFiles"!==t.RequestData.RequestType||this.refreshFrameWindow(i.Window)}catch(e){console.log("inside getMSFResponse: "+e)}},refreshFrameWindow:function(e){if(null==window.__karma__){var t=findFrame(e,"detailsDisplay");null!=(t=null==(t=null==t?findFrame(e,"listDisplay"):t)?findFrame(e,"content"):t)?t.location.href=t.location.href:e.location.href=e.location.href}},downloadDocument:function(e){var t=JSON.parse("{}");t.RequestType="download",this.processDownload(e,t)},checkoutDocument:function(e){var t=JSON.parse("{}");t.RequestType="checkout",this.processDownload(e,t)},viewDocument:function(e){var t=JSON.parse("{}");t.RequestType="view",this.processDownload(e,t)},processDownload:function(e,t){t.DocumentID=e.documentId,t.Options=e,this.sendMessage(t)},checkIn:function(e,t){var n=JSON.parse("{}");t.DocumentInfo=e,n.RequestType="CheckIn",n.DocumentID=e.id?e.id:"";var o=[];o.push({FileName:e.fileInfo.file.name,Format:"",VersionId:""}),n.MSFFileFormatDetails=o,n.Options=t,this.sendMessage(n)},createNew:function(e,t){var n=JSON.parse("{}");t.DocumentInfo=e,n.RequestType="CreateNew",n.DocumentType=e.type?e.type:"Document",n.RelName=e.relInfo?e.relInfo.parentRelName:null,n.parentId=e.relInfo?e.relInfo.parentId:null,n.CollabSpace=e.collabspace?e.collabspace:"",n.Options=t,n.MSFFileFormatDetails=[e.fileInfo.file],this.sendMessage(n)},selectFiles:function(e){var t=JSON.parse("{}");t.RequestType="SelectFiles",t.Options=e,this.sendMessage(t)},addFiles:function(e,t){var n=JSON.parse("{}");t.DocumentInfo=e,n.RequestType="AddFiles",n.DocumentType=e.type?e.type:"Document",n.RelName=e.relInfo?e.relInfo.parentRelName:"Reference Document",n.DocumentID=e.id?e.id:"",n.Options=t,this.sendMessage(n)},generateNewGuid:function(){var e=new Date;return Math.random()+"."+e.getFullYear()+"."+e.getMonth()+"."+e.getDate()+"."+e.getHours()+"."+e.getSeconds()+"."+e.getMilliseconds()},isConnectedWithMSF:function(){return sessionStorage.msfConnection?String("true"==sessionStorage.msfConnection):"false"},sendMessage:function(t){if(!1===this.isMSFDocServerInitialized){var s=t.Options;if(s&&(this.MSFResponse={},this.MSFResponse.MSFResult=this.MSF_NOT_AVAILABLE_RESPONSE,e.is(s.onComplete,"function")))return void s.onComplete(s)}if(t.RequestId=this.generateNewGuid(),window.widget&&window.widget.id)!1===n?(this.initializeMSFInterComClient(),sessionStorage.MSFWidget=window.widget.id):!0===n&&sessionStorage.MSFWidget&&sessionStorage.MSFWidget!==window.widget.id&&(this.initializeMSFInterComClient(),sessionStorage.MSFWidget=window.widget.id),this.msfLocalCacheCollection[t.RequestId]=t.Options,o.dispatchEvent("MSFProcessMessage",t);else{var a=this;try{for(i=getTopWindow();i&&i.opener&&-1==i.location.href.indexOf("emxNavigator.jsp");)i=i.opener.getTopWindow()}catch(e){console.log("inside sendMessage: "+e)}var l={};l.Window=window,this.msfLocalCacheCollection[t.RequestId]=l,require(["UWA/Utils/InterCom"],function(e){(o=new e.Socket("MSFIntercomClientSocket")).subscribeServer("enovia.bus.server",i),o.addListener("getResponse",a.getMSFResponse.bind(a)),o.dispatchEvent("MSFProcessMessage",t)})}}};return s}),define("DS/MSFDocumentManagement/MSFDocumentServer",["UWA/Core","DS/i3DXCompass/Data","DS/PlatformAPI/PlatformAPI","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","UWA/Utils/InterCom","DS/WAFData/WAFData"],function(e,t,n,o,i,s){"use strict";var a,l={},r=void 0;return{isConnectedWithMSF:function(){try{window.widget||(a=top.window.msfWebSocket)}catch(e){return!1}return null!=a&&1===a.readyState},initializeMSFInterCom:function(){l=new i.Socket("MSFIntercomServerSocket"),window.widget?l.subscribeServer("uwa.embedded"):l.subscribeServer("enovia.bus.server",getTopWindow()),l.addListener("MSFProcessMessage",this.sendMessage.bind(this))},onConnectWithMSF:function(t,i,a,l,r,c){if(!this.isConnectedWithMSF()){this.initializeMSFInterCom(),null==sessionStorage.ClientId&&(sessionStorage.ClientId=this.generateNewGuid()),window.widget&&(t=n.getUser().login);var d=this;o.getPlatformServices({onComplete:function(n){var o=void 0;if(void 0!==n){if(1==n.length)o=n[0];else if(n.length>1){var r=window.tenantId;for(var c in window.widget&&(r=window.widget.data.x3dPlatformId),n)if(n[c].platformId==r){o=n[c];break}}else console.log("---may return wrong tenant information---"),o=n[0];i=e.is(o["3DSpace"],"string")?o["3DSpace"]:"",a=e.is(o.platformId,"string")?o.platformId:"",l=e.is(o["3DPassport"],"string")?o["3DPassport"]:""}if(l&&""!==l){"/"!=(l=l.replace("/cas","")).substr(-1)&&(l+="/");var S=e.Utils.buildUrl(l,"api/authenticated/cas/transient");s.authenticatedRequest(S,{method:"GET",type:"json",onComplete:function(e){e&&(e.access_token?d.connectWithMSF('{"ClientId": "'+sessionStorage.ClientId+'", "UserName": "'+t+'", "ServerUrl": "'+i+'", "TenantId": "'+a+'", "TransientURL": "'+e.x3ds_reauth_url+'"}'):d.connectWithMSF('{"ClientId": "'+sessionStorage.ClientId+'", "UserName": "'+t+'", "ServerUrl": "'+i+'", "TenantId": "'+a+'"}'))},onFailure:function(){console.error("failed to get transient token")}})}else d.connectWithMSF('{"ClientId": "'+sessionStorage.ClientId+'", "UserName": "'+t+'", "ServerUrl": "'+i+'", "TenantId": "'+a+'"}')},onFailure:function(){console.error("Fail to connect to MSF")}})}},generateNewGuid:function(){var e=new Date;return Math.random()+"."+e.getFullYear()+"."+e.getMonth()+"."+e.getDate()+"."+e.getHours()+"."+e.getSeconds()+"."+e.getMilliseconds()},connectWithMSF:function(e){if(e){var t=decodeURIComponent(e);e=JSON.parse(e),r="ws://localhost:2012/MSFServiceSocket?MSFClientInfo="+t,sessionStorage.ClientId=e.ClientId}this.initSocket(r)},initSocket:function(e){var t=this;a=new WebSocket(e),window.widget||(top.window.msfWebSocket=a),a.onerror=function(){},a.onopen=function(){t.isConnectedWithMSF()&&(sessionStorage.msfConnection=!0)},a.onmessage=function(e){var n=JSON.parse(e.data);t.getMSFResponse(n)},a.onclose=function(t){a=1005!==t.code&&1006!==t.code&&1e3!==t.code?new WebSocket(e):null,sessionStorage.msfConnection=!1}},getMSFResponse:function(e){"Connect"===e.RequestType&&"True"===e.Connection?(!0,sessionStorage.msfConnection=!0):"False"===e.Connection&&(a=null,sessionStorage.msfConnection=!1),l.dispatchEvent("getResponse",e)},sendMessage:function(e){this.isConnectedWithMSF()?void 0!==e&&e.RequestType&&(e.ClientId=sessionStorage.ClientId,a.send(JSON.stringify(e))):(e.MSFResult=7,l.dispatchEvent("getResponse",e))}}}),define("DS/MSFDocumentManagement/WidgetIntegration",["UWA/Core","UWA/Json","DS/WAFData/WAFData","DS/i3DXCompass/Data","DS/PlatformAPI/PlatformAPI","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(e,t,n,o,i,s){"use strict";return{MSF_NOT_AVAILABLE_RESPONSE:7,MSF_CALL_SUCCESS_RESPONSE:1,Operations:{View:"view",Download:"download",CheckOut:"checkout",CreateNew:"CreateNew",SelectFiles:"SelectFiles",CheckIn:"CheckIn",AddFiles:"AddFiles",GetAttributeDefinitions:"GetAttributeDefinitions",Connect:"Connect"},msfRequestCache:{},clientId:null,msfWebSocket:null,isMSFClientSignedIn:!1,ConnectWidgetWithMSF:function(){!this.isConnectedWithMSF()&&e.Utils.Client.Platform.windows&&(null==sessionStorage.MSFSessionId&&(sessionStorage.MSFSessionId=this.generateUniqueID()),this.clientId=sessionStorage.MSFSessionId+"."+i.getUser().login+"."+window.widget.id,this.prepareWebsocketUrlAndConnect(this.clientId))},IsConnectedToMSFClient:function(){return this.isConnectedWithMSF()&&this.isMSFClientSignedIn},DownloadViaMSF:function(t,n){var o=this;this.isConnectedWithMSF()?t.forEach(function(t){var i=n.onComplete,s=n.onFailure,a=e.clone(n||{},!1);if(t.id){a.onMSFComplete=function(t){t.onComplete=i,t.onFailure=s,t.MSFResponse.MSFResult===o.MSF_CALL_SUCCESS_RESPONSE?e.is(t.onComplete,"function")&&t.onComplete(t):""!==t.MSFResponse.ErrorMessage&&e.is(t.onFailure,"function")&&t.onFailure(t.MSFResponse.ErrorMessage)},a.documentId=t.id,a.fileId=t.fileid;var l=o.Operations.Download;!0===t.checkout?l=o.Operations.CheckOut:!0===t.open&&(l=o.Operations.View);var r=[];a.fileNameForMSF&&(r=[{FileName:a.fileNameForMSF}]);var c={DocumentID:t.id,Options:a,RequestType:l,MSFFileFormatDetails:r};o.sendMessageAcrossWebsocket(c)}else s("document.id is invalid")}):n.onFailure("Widget is not connected to MSF Client")},UploadViaMSF:function(t,n){var o=this;this.isConnectedWithMSF()?t.forEach(function(t){var i=n.onComplete,s=n.onFailure,a=e.clone(n||{},!1);if(t.id){a.onMSFComplete=function(t){t.onComplete=i,t.onFailure=s,t.MSFResponse.MSFResult===o.MSF_CALL_SUCCESS_RESPONSE?e.is(t.onComplete,"function")&&t.onComplete(t):""!==t.MSFResponse.ErrorMessage&&e.is(t.onFailure,"function")&&t.onFailure(t.MSFResponse.ErrorMessage)};var l={RequestType:o.Operations.SelectFiles,MSFFileFormatDetails:[],Options:a};a.DocumentInfo=t,l.DocumentID=t.id?t.id:"",t.fileInfo?t.fileInfo.checkIn||t.fileInfo.addFile?t.fileInfo.checkIn?(l.RequestType=o.Operations.CheckIn,t.fileInfo.file&&t.fileInfo.file.FileName&&(l.MSFFileFormatDetails=[t.fileInfo.file])):t.fileInfo.addFile&&(l.RequestType=o.Operations.AddFiles,t.fileInfo.file&&t.fileInfo.file.FileToUpload&&(l.MSFFileFormatDetails=[t.fileInfo.file])):console.warn("documentForUpload.fileInfo.(checkIn or addFile or createNew) is missing, reverting to SelectFiles Instead of Upload"):console.warn("documentForUpload.fileInfo is missing, reverting to SelectFiles Instead of Upload"),o.sendMessageAcrossWebsocket(l)}else s("document.id is invalid")}):n.onFailure("Widget is not connected to MSF Client")},CreateViaMSF:function(t,n){var o=this;if(this.isConnectedWithMSF()){var i=t.onComplete,s=t.onFailure,a=e.clone(t||{},!1);a.onMSFComplete=function(t){t.onComplete=i,t.onFailure=s,t.MSFResponse.MSFResult===o.MSF_CALL_SUCCESS_RESPONSE?e.is(t.onComplete,"function")&&t.onComplete(t):""!==t.MSFResponse.ErrorMessage&&e.is(t.onFailure,"function")&&t.onFailure(t.MSFResponse.ErrorMessage)};var l={RequestType:o.Operations.SelectFiles,Options:a};n&&(l.RequestType=o.Operations.AddFiles,a.DocumentInfo=n,l.DocumentID=n.id?n.id:"",!n.fileInfo||!n.fileInfo.createNew||n.fileInfo.file instanceof window.File||(l.RequestType=o.Operations.CreateNew,l.DocumentType=n.type?n.type:"Document",l.RelName=n.relInfo?n.relInfo.parentRelName:null,l.parentId=n.relInfo?n.relInfo.parentId:null,l.CollabSpace=n.collabspace?n.collabspace:"",n.fileInfo.file&&n.fileInfo.file.FileToUpload&&(l.MSFFileFormatDetails=[n.fileInfo.file]))),o.sendMessageAcrossWebsocket(l)}else t.onFailure("Widget is not connected to MSF Client")},prepareWebsocketUrlAndConnect:function(e){if(e){var t="ws://localhost:2012/MSFServiceSocket?ClientId="+encodeURIComponent(e);this.initWebsocket(t)}},initWebsocket:function(e){var t=this;t.msfWebSocket=new WebSocket(e),t.msfWebSocket.onerror=function(){},t.msfWebSocket.onopen=function(){console.log("Connected to MSFClient, Waiting for MSFClient to Sign In")},t.msfWebSocket.onmessage=function(e){if(""!==e.data){var n=JSON.parse(e.data);t.receiveMsgAcrossWebsocket(n)}},t.msfWebSocket.onclose=function(n){1005!==n.code&&1006!==n.code&&1e3!==n.code?t.msfWebSocket=new WebSocket(e):t.msfWebSocket=null}},isConnectedWithMSF:function(){return null!=this.msfWebSocket&&1===this.msfWebSocket.readyState},sendCredentialMessage:function(e){e.RequestType=this.Operations.Connect,this.sendMessageAcrossWebsocket(e)},sendCredentials:function(t){var o,a,l,r=this,c=i.getUser().login;s.getPlatformServices({onComplete:function(i){var s;if(void 0!==i){if(1==i.length)s=i[0];else if(i.length>1){var d=window.tenantId;for(var S in d=window.widget.data.x3dPlatformId,i)if(i[S].platformId==d){s=i[S];break}}else console.log("---may return wrong tenant information---"),s=i[0];o=e.is(s["3DSpace"],"string")?s["3DSpace"]:"",a=e.is(s.platformId,"string")?s.platformId:"",l=e.is(s["3DPassport"],"string")?s["3DPassport"]:""}if(l&&""!==l)if("/"!=(l=l.replace("/cas","")).substr(-1)&&(l+="/"),t){var u=e.Utils.buildUrl(l,"api/authenticated/cas/transient");n.authenticatedRequest(u,{method:"GET",type:"json",onComplete:function(e){e&&(e.access_token?r.sendCredentialMessage({ClientId:r.clientId,UserName:c,ServerUrl:o,TenantId:a,TransientURL:e.x3ds_reauth_url}):r.sendCredentialMessage({ClientId:r.clientId,UserName:c,ServerUrl:o,TenantId:a}))},onFailure:function(){console.error("failed to get transient token")}})}else r.sendCredentialMessage({ClientId:r.clientId,UserName:c,ServerUrl:o,TenantId:a,IsDelayedCASTGC:!0});else r.sendCredentialMessage({ClientId:r.clientId,UserName:c,ServerUrl:o,TenantId:a})},onFailure:function(){console.error("Fail to connect to MSF")}})},receiveMsgAcrossWebsocket:function(t){if(t.RequestType===this.Operations.Connect&&"True"===t.Connection)this.isMSFClientSignedIn=!0,console.log("MSFClient Signed In");else if(t.RequestType===this.Operations.Connect&&"False"===t.Connection)this.isMSFClientSignedIn=!1,this.msfWebSocket=null,console.log("MSFClient SignIn Failed");else{if(t.RequestType===this.Operations.Connect&&"GetCASTGC"===t.Connection)return this.isMSFClientSignedIn=!1,void this.sendCredentials(!0);if(t.RequestType===this.Operations.Connect&&"GetCredentials"===t.Connection)return this.isMSFClientSignedIn=!1,void this.sendCredentials(!1);if(null!=t.RequestData&&t.RequestData.RequestType===this.Operations.Connect&&"Connected"===t.ResultData)this.isMSFClientSignedIn=!0,console.log("MSFClient Signed In");else if(null!=t.RequestData&&t.RequestData.RequestType===this.Operations.Connect&&"Cancelled"===t.ResultData)this.isMSFClientSignedIn=!1,this.msfWebSocket=null,console.log("MSFClient SignIn Failed");else if(null!=t.RequestData&&t.RequestData.RequestType===this.Operations.Connect&&"GetCASTGC"===t.ResultData)return this.isMSFClientSignedIn=!1,void this.sendCredentials(!0)}var n=t.RequestData?t.RequestData.RequestId:t.RequestId,o=n?this.msfRequestCache[n]:null;if(null!=o){var i;if(void 0!==t.ResultData&&""!==t.ResultData&&o)try{i=JSON.parse(t.ResultData),o.data=i.data}catch(e){i=t.ResultData}n&&delete this.msfRequestCache[n],o&&(o.MSFResponse=t,e.is(o.onMSFComplete,"function")&&o.onMSFComplete(o))}else console.log("Not Found RequestId: "+n)},sendMessageAcrossWebsocket:function(n){if(n.RequestType!==this.Operations.Connect&&!this.isConnectedWithMSF()){var o=n.Options;if(o&&e.is(o.onMSFComplete,"function"))return void o.onMSFComplete(o)}n.RequestId=this.generateUniqueID(),this.msfRequestCache[n.RequestId]=n.Options,this.isConnectedWithMSF()?void 0!==n&&n.RequestType&&(n.ClientId=this.clientId,this.msfWebSocket.send(JSON.stringify(t.prune(n)))):n.RequestType===this.Operations.Connect&&null!=this.msfWebSocket&&1===this.msfWebSocket.readyState?(n.ClientId=this.clientId,this.msfWebSocket.send(JSON.stringify(t.prune(n)))):(n.MSFResult=this.MSF_NOT_AVAILABLE_RESPONSE,this.receiveMsgAcrossWebsocket(n))},generateUniqueID:function(){var e=new Date;return Math.random()+"."+e.getFullYear()+"."+e.getMonth()+"."+e.getDate()+"."+e.getHours()+"."+e.getSeconds()+"."+e.getMilliseconds()}}});