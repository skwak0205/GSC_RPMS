/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/ENORIPE_Relations/RelationsTabSettings",["UWA/Class","UWA/Core","UWA/Class/Options","UWA/Promise","UWA/Class/Events","DS/PlatformAPI/PlatformAPI","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","text!DS/SNNavigationMap/assets/SNNavigationMap.settings.json","DS/SNNavigationMap/utils/SNNavigationServices","DS/SNNavigationMap/utils/NlsManager","i18n!DS/ENORIPE_Relations/assets/nls/Relations","css!DS/ENORIPE_Relations/ENORIPE_Relations"],function(e,t,i,n,s,o,a,r,l,c,d){"use strict";return e.singleton(i,s,{name:"relations_tab_settings",_localKey:null,init:function(){try{t.merge(d,c.getNls());var e=JSON.parse(r);this.setOptions(e),this.setOptions("user_granted_roles",""),this.setOption("isDraggable",!0),this.setOption("isProfilesVisible",!0),this._localKey="RelationsTab","undefined"!=typeof widget&&null!==widget&&(void 0!==widget.getValue("x3dSharedId")?this._localKey="/"+widget.getValue("x3dSharedId"):void 0!==widget.getValue("x3dAppId")?this._localKey="/"+widget.getValue("x3dAppId"):void 0!==widget.getValue("appId")&&(this._localKey="/"+widget.getValue("appId")+"_"+widget.id))}catch(e){console.error(e)}},isAvailable:function(e,t){var i={},s=this;if(i.isAvailable=!1,i.roles=[],t&&t.addinmode&&this.setOption("addinmode",t.addinmode),t&&t.lockedApp&&this.setOption("lockedapp",t.lockedApp),t&&t.hasOwnProperty("isProfilesVisible")&&this.setOption("isProfilesVisible",t.isProfilesVisible),t&&t.hasOwnProperty("publicationsMode")&&this.setOption("publicationsMode",t.publicationsMode),t){if(t.appID){var o=t.appID;this.setOption("appID",o),"X3DSEAR_AP"===o&&this.setOption("automode",!0)}t.isExternal&&this.setOption("isExternal",t.isExternal),void 0!==t.noContextualMenu&&t.noContextualMenu&&this.setOption("noContextualMenu",t.noContextualMenu)}return this.getOption("userId")||this.setUser(e),this.getOption("myappsurl")||this.setMyAppsUrl(),new n(function(n,o){s.getOption("user_granted_roles")?(i=s.parseRoles(s.getOption("user_granted_roles"),e),n(i)):a.getGrantedRoles(function(a){if(a){s.setOption("user_granted_roles",a),i=s.parseRoles(a,e);var r=!0;t&&t.isDraggable&&(r=t.isDraggable),s.setOption("isDraggable",r),n(i)}else o()})})},setUser:function(e){var t=this,i=e&&e.getPlatformID?e.getPlatformID():"OnPremise";try{a.getUser({platformId:i,onComplete:function(e){e&&e.id&&t.setOption("userId",e.id)},onFailure:function(e){console.log(e)}})}catch(e){console.log(e)}},setMyAppsUrl:function(){var e=this;this.getOption("myappsurl")||window&&window.dscef&&window.dscef.getMyAppsURL&&window.dscef.getMyAppsURL().then(function(t){e.setOption("myappsurl",t)})},getMyAppsUrl:function(){return this.getOption("myappsurl")?this.getOption("myappsurl"):""},getAppID:function(){var e=this.getOption("appID");return e||"undefined"==typeof widget||null===widget||(e=widget.getValue("x3dAppId")||widget.getValue("appId")),e||"defaultID"},parseRoles:function(e,i){var n,s=[],o={},a=!1,r=!1,l=i&&i.getPlatformID?i.getPlatformID():"OnPremise";if(o.roles=[],o.isAvailable=!1,e){if("string"!=typeof e||"{"!==e[0]&&"["!==e[0]||(e=JSON.parse(e)),t.is(e,"array"))for(var c=0;c<e.length;c++)if("InternalDS"===e[c].id&&(a=!0,s.push(e[c].id)),i){if(e[c].platforms)for(var p=0;p<e[c].platforms.length;p++)if(l===e[c].platforms[p]){if(-1!==s.indexOf(e[c].id))break;s.push(e[c].id)}}else s.push(e[c].id);o.roles=s,n=i&&i.getServiceID&&i.getServiceID()||"3DSpace",(s.indexOf("CSV")>-1||s.indexOf("InternalDS")>-1)&&(a=!0),"3DSpace"===n&&(r=!0),a&&r&&(o.isAvailable=!0,o.facetInfo={supportMerge:!0,require:"DS/ENORIPE_Relations/views/RelationsTab",facet:{name:"relations",text:d.get("relations_tab"),icon:"object-related"},alwaysVisible:!1})}return o},getLang:function(){var e;if(widget&&widget.lang)return widget.lang;window&&window.dsLang?e=window.dsLang:e=(window&&window.clntlang?window.clntlang:navigator&&navigator.languages&&t.is(navigator.languages,"array")&&navigator.languages.length>0?navigator.languages[0]:navigator?navigator.language||navigator.systemLanguage:"en").toLowerCase().split("-")[0];return e},setInitProfile:function(e){this.saveValuesForProfile("LastUsedProfile",e),void 0===this.getOption("initProfile")&&this.setOption("initProfileDone",!0)},setProfile:function(e){var t=this;this.saveValuesForProfile("LastUsedProfile",e),void 0===this.getOption("initProfile")&&this.setOption("initProfileDone",!0),require(["DS/PlatformAPI/PlatformAPI"],function(i){var n=t.getLocalKey()+"/setProfile",s={profile:e};i.publish(n,s)})},updatePublicationsMode:function(e){var t=this;require(["DS/PlatformAPI/PlatformAPI"],function(i){var n=t.getLocalKey()+"/updatePublicationsMode",s={publicationsMode:e};i.publish(n,s)})},expandRelations:function(e){var t=this;this.setOption("expandRelations",e),require(["DS/PlatformAPI/PlatformAPI"],function(i){var n=t.getLocalKey()+"/expandRelations",s={relationsNames:e};i.publish(n,s)})},getLocalKey:function(){return this._localKey},getRoles:function(){var e=this.getOption("user_granted_roles"),i=[];if(e&&("string"!=typeof e||"{"!==e[0]&&"["!==e[0]||(e=JSON.parse(e)),t.is(e,"array")))for(var n=0;n<e.length;n++)i.push(e[n].id);return i},getUserID:function(){if(this.getOption("userId"))return this.getOption("userId");var e=o.getUser();return null!=e&&void 0!==e.login?o.getUser().login:""},saveValuesForProfile:function(e,t){e&&(e=e+"-"+this.getAppID()),e&&t&&(widget&&widget.setValue(e,t),localStorage.setItem(e,t))},getValuesForProfile:function(e){var t;if(e)return e=e+"-"+this.getAppID(),widget&&(t=widget.getValue(e)),!t&&l.isWebInWin()&&(t=localStorage.getItem(e)),t}})}),define("DS/ENORIPE_Relations/utils/CommonUtils",["UWA/Class","DS/WAFData/WAFData","DS/FedDictionaryAccess/FedDictionaryAccessAPI"],function(e,t,i){"use strict";return e.extend({_currentRequest:null,init:function(e){this._3dSpaceUrl=e._3dSpaceUrl,this._tenant=e.tenant,this._lang=e.lang,this._userID=e.userID,this._isWebInWin=e.isWebInWin,this._myappsurl=e.myappsurl},_createPromise:function(i){i.params.label="ENORIPE_Relations";var n=JSON.stringify(i.params);return new e.Promise(function(e,s){t.authenticatedRequest(i.url,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",data:n,timeout:6e3,onComplete:e,onFailure:function(e){console.log(e),s(e)},onTimeout:function(e){console.log(e),s(e)}})})},fetchThumbNails:function(t){var i=this,n={ids:t,attrs:["preview_url"]};return new e.Promise(function(e,t){i._fetchCall(n).then(function(t){e(t)},function(){t()})})},fetchAttributes:function(t){var i=this,n=t.type;return void 0!==t.typeAttrs[n]?t.attributes=t.typeAttrs[n].attributes:t.attributes=t.typeAttrs.AllTypes.attributes,t.attrs=t.attributes.map(function(e){return e.uri}),new e.Promise(function(e,n){i._fetchCall(t).then(i._processData.bind(i,t)).then(function(t){e(t)},function(){n()})})},_fetchCall:function(e){return this._createPromise({url:this._3dSpaceUrl+"/cvservlet/fetch/v2?tenant="+this._tenant,params:{physicalid:e.ids,select_predicate:e.attrs},timeout:6e4})},_processData:function(t,i){var n=this;if(i){i=JSON.parse(i);for(var s={},o=0;o<i.results.length;o++)for(var a=i.results[o].attributes,r=0;r<a.length;r++)(a[r].name.contains("ds6w")||a[r].name.contains("ds6wg"))&&(s[a[r].name]?-1===s[a[r].name].indexOf(a[r].value)&&s[a[r].name].push(a[r].value):s[a[r].name]=[a[r].value])}return new e.Promise(function(e,o){i&&i.results&&i.results.length>0?n._getNls(s).then(function(s){t=n._processFetchData(t,i),t=n._processNlsData(t,s),e(t)}):(console.log("no results in fetch service for tooltip"),e(t))})},_getNls:function(t){var n=this;return new e.Promise(function(e,s){if(n._isWebInWin){var o={myAppsBaseUrl:n._myappsurl,userId:n._userID,lang:n._lang};i.setConfigForMyApps(o)}i.getNlsOfPropertiesValues(JSON.stringify(t),{tenantId:n._tenant,lang:n._lang,apiVersion:"R2019x",onComplete:function(t){e(t)},onFailure:function(t){console.log("Error in fetching NLS data from FedDictionaryAccessAPI.getNlsOfPropertiesValues, the response received is ::"+t),e()}})})},_processFetchData:function(e,t){if(t)for(var i=t.results,n=null,s=e.attrs,o=0;o<i.length;o++)if(i[o].attributes&&i[o].attributes.length>0)for(var a=0;a<i[o].attributes.length;a++){var r=i[o].attributes[a];if("resourceid"===r.name){(n=this._getAttrForIds(r.value,i[o].attributes,s))&&(e.nlsObj||(e.nlsObj={}),e.nlsObj[r.value]=n);break}}return e},_getAttrForIds:function(e,t,i){if(e&&t){for(var n={},s=0;s<t.length;s++)-1!==i.indexOf(t[s].name)&&(n[t[s].name]=t[s].value);if(Object.keys(n).length>0)return n}return null},_processNlsData:function(e,t){if(t){var i=e.nlsObj;for(var n in i)if(i.hasOwnProperty(n)){var s=i[n];for(var o in s)if(s.hasOwnProperty(o)&&void 0!==t[o]){s[o];void 0!==t[o][s[o]]&&(e.nlsObj[n][o]=t[o][s[o]])}}}return e}})}),define("DS/ENORIPE_Relations/views/RelationsView",["UWA/Core","UWA/Class/View","UWA/Class","DS/WAFData/WAFData","DS/TransientWidget/TransientWidget","DS/SNNavigationMap/MapSettings","DS/SNNavigationMap/utils/ProbesUtils","DS/CollectionView/ResponsiveLargeTilesCollectionView","DS/TreeModel/TreeDocument","DS/Tree/TreeNodeModel","DS/Controls/ComboBox","DS/Controls/TooltipModel","UWA/Class/Model","UWA/Date","UWA/Utils/InterCom","DS/SNNavigationMap/utils/SNNavigationServices","DS/i3DXCompassPlatformServices/OpenWith","DS/i3DXCompassServices/i3DXCompassPubSub","DS/FedDictionaryAccess/FedDictionaryAccessAPI","i18n!DS/ENORIPE_Relations/assets/nls/Relations","DS/UIKIT/Mask","DS/PlatformAPI/PlatformAPI","DS/WebappsUtils/WebappsUtils","DS/Controls/TileView","DS/UIKIT/DropdownMenu","DS/UIKIT/Accordion","DS/UIKIT/Scroller","DS/UIKIT/Iconbar","DS/Controls/Button"],function(e,t,i,n,s,o,a,r,l,c,d,p,u,h,f,g,m,_,v,I,b,P,S,w,y,D,O,A,R){"use strict";return t.extend({name:"list-view",isInitialized:!1,_currentRequest:null,sourceModels:{},models:{},nodeModels:{},responsiveTiles:[],inAppSpecificSection:!1,_selectedModels:[],tiles:[],isSetTypesCallbackSubscribed:!1,_isWebInWin:g.isWebInWin(),_compassSocket:{},_platformId:"",_serviceName:"",_separator:"",_attributes:{},noContextualMenu:!1,_selectUuid:e.Utils.getUUID(),_accordionOpenedItem:[],_linkDirectionItemsMapping:{},_propertiesCommandRequire:"DS/ENOCollabSharingCmds/commands/EditPropCmd/EditPropCmdBase",className:function(){return this.getClassNames("-container multisel-off")},setup:function(e){this._widgetId=e.widgetId||null,this.appId=e.appId,this._tenant=e.tenant||"OnPremise",this._3dSpaceUrl=e.serviceURL,this._url=e.serviceURL+"/resources/enorelnav/v2/navigate/getEcosystem?tenant="+this._tenant,this.isDraggable=e.isDraggable||!0,this.isProfilesVisible=!e.hasOwnProperty("isProfilesVisible")||e.isProfilesVisible,this.currentProfile=e.currentProfile,this._separator=e.separator,this._lang=e.lang,this._userID=e.userID,this._autoNavMode=e.autoNavMode||!1,this._addinMode=e.addinmode,this._lockedApp=e.lockedApp,this._attributes=e.attrs,this._myappsurl=e.myappsurl,this.localKey=e.localKey,this.noContextualMenu=e.noContextualMenu,this.expandRelationsName=e.expandRelations;var t="com.ds."+this._widgetId;this._compassSocket=new f.Socket(t);this._compassSocket.subscribeServer("com.ds.compass",window.parent),this.isSetTypesCallbackSubscribed||(_.subscribe("setTypesCallback",this._setTypesCallback.bind(this)),this.isSetTypesCallbackSubscribed=!0),this._initializeView(e)},_initializeView:function(t){if(this.header=new e.createElement("div",{class:"relations-header"}).inject(this.container),this.isProfilesVisible){this._setUpComboBox(t);var i=e.createElement("div",{class:"comboBox-component"}).inject(this.header);this._profileCombobox.inject(i),this._isWebInWin||void 0!==window.dscef||this._setUpOpenRelationInNewWindow()}this.container.addEventListener("contextmenu",function(e){return e.preventDefault(),!1}),this.relationBody=e.createElement("div",{class:"relations-body"}).inject(this.container),this.scroller=new O({element:this.relationBody}).inject(this.container)},setModel:function(e){this._currentRequest&&this._currentRequest.cancel(),this.sourceModels=this.sourceModels===e?this.sourceModels:e,this._platformId=e.get("platformId")||"OnPremise",this._serviceName=e.get("serviceName")||"3DSpace",this._getDetail(this.sourceModels.get("id"))},_getDetail:function(e){var t=this,i={widgetId:this._widgetId,responseMode:"objectsByPatterns",label:o.getLabelAPI()};Array.isArray(e)?i.ids=e:i.ids=[e],this._url&&(this._currentRequest=n.authenticatedRequest(t._url,{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:o.getXPrefCredential()},method:"POST",data:JSON.stringify(i),timeout:2*o.getTimeout(),onComplete:function(e){t._currentRequest=null,t._getNlsData(JSON.parse(e)).then(function(e){t.render(e)})},onFailure:function(e){console.log(e);var i={};i.message=I.get("generic"),t.dispatchEvent("ENORIPERelations_handleErrorMsgs",[i]),t.removeLoader(),t.hidePanel()},onTimeout:function(e){console.log(e);var i={};i.message=I.get("timeout"),i.subtitle=I.get("verifyConnection"),t.dispatchEvent("ENORIPERelations_handleErrorMsgs",[i]),t.removeLoader(),t.hidePanel()}}))},_getNlsData:function(e){var t=this,n={},s={},o=null;for(var a in e)if(e.hasOwnProperty(a))for(var r in e[a])if(e[a].hasOwnProperty(r))for(var l=0;l<e[a][r].length;l++)for(var c in o=e[a][r][l])o.hasOwnProperty(c)&&c.contains("ds6w")&&(n[c]?-1===n[c].indexOf(o[c])&&n[c].push(o[c]):n[c]=[o[c]]);return new i.Promise(function(i,o){if(t._isWebInWin){var a={myAppsBaseUrl:t._myappsurl,userId:t._userID,lang:t._lang};v.setConfigForMyApps(a)}v.getNlsOfPropertiesValues(JSON.stringify(n),{tenantId:t._tenant,lang:t._lang,apiVersion:"R2019x",onComplete:function(n){s=t._convertToNls(e,n),i(s)},onFailure:function(t){console.log("Error in fetching NLS data from FedDictionaryAccessAPI.getNlsOfPropertiesValues, the error is ::"+t),i(e)}})})},_convertToNls:function(e,t){if(t){var i=null,n=null;for(var s in e)if(e.hasOwnProperty(s))for(var o in e[s])if(e[s].hasOwnProperty(o))for(var a=0;a<e[s][o].length;a++)for(var r in i=e[s][o][a])i.hasOwnProperty(r)&&r.contains("ds6w")&&t[r]&&t[r].hasOwnProperty(i[r])&&(n=t[r][i[r]],i[r]=n)}return e},_setUpComboBox:function(e){this.profileArray=e.profileArray;var t,i,n=e.currentProfile,s=160,o=0,a=0,r=[],u=e.lang||null,h=!1;this.profileArray=this.profileArray.sort(function(e,t){return e.isAppSpecific===t.isAppSpecific?0:e.isAppSpecific?-1:1});for(var f=0;f<this.profileArray.length;f++)"custom"===this.profileArray[f].type?(i=this.profileArray[f].nls||I.get(this.profileArray[f].name),I[this.profileArray[f].name]=i):i=I.get(this.profileArray[f].name),r[f]=i,t=u&&"ja"===u?14:7,s=s<r[f].length*t?r[f].length*t:s;null!==n&&""!==n&&void 0!==n&&(this._autoNavMode="AutoModeProfile"===n),this.profileTreeDocument=new l({shouldBeSelected:function(e){return"section"!==e.options.comboBoxSemantics}}),this.profileArray[0].isAppSpecific&&(this.profileTreeDocument.addRoot(new c({label:I.get("AppDedicatedRS"),comboBoxSemantics:"section"})),this.inAppSpecificSection=!0);for(var g=0;g<r.length;g++){h||this.profileArray[g].isAppSpecific||(h=!0,this.profileTreeDocument.addRoot(new c({label:I.get("AllRS"),comboBoxSemantics:"section"}))),null!==n&&""!==n&&void 0!==n&&this.profileArray[g].name===n&&(o=!this.inAppSpecificSection||this.inAppSpecificSection&&!h?g+1:g+2,a=g);var m={label:r[g],data:{name:this.profileArray[g].name}};this.profileArray[g].type&&(m.data.type=this.profileArray[g].type);var _=new c(m);this.profileTreeDocument.addRoot(_)}this.comboOptions={elementsTree:this.profileTreeDocument,nbDisplayedElements:r.length,enableSearchFlag:!1,actionOnClickFlag:!1,selectedIndex:o,touchMode:!0},this._profileCombobox=new d(this.comboOptions),this._profileCombobox.addEventListener("change",this._handleProfileChange.bind(this)),this.currentProfile=this.profileArray[a].name,this._profileCombobox.tooltipInfos=new p({shortHelp:I.get("Profiles")})},_setUpOpenRelationInNewWindow:function(){let e=this;var t={iconName:"open-in-a-new-window",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"2x"},i=new R({icon:t,displayStyle:"lite"});i.tooltipInfos=new p({shortHelp:I.get("relations_tab"),longHelp:I.get("openRelationInNewWindow"),mouseRelativePosition:!1}),i.addEventListener("click",function(){let t=[],i=[],n=e.mapAccordion.getSelectedItems().map(t=>e.mapAccordion.getItem(t.id).name),s=[];n.forEach(t=>{s.push(...e._linkDirectionItemsMapping[t].map(e=>e.id))}),Array.isArray(e.sourceModels.get("id"))?(s.push(...e.sourceModels.get("id")),t.push(...e.sourceModels.get("id"))):(s.push(e.sourceModels.get("id")),t.push(e.sourceModels.get("id"))),t.push(...e._selectedModels.map(e=>e.id).filter(e=>s.includes(e))),i=s.map(t=>({envId:e._platformId,serviceId:e._serviceName,contextId:"",objectId:t}));let o=e.appId,a={protocol:"3DXContent",version:"1.1",source:o,widgetId:e._widgetId,profile:e.currentProfile,preSelectedObjectIds:t,data:{items:i}};_.publish("setX3DContent",a),e.trackPopOutCommandUsage(o),_.publish("launchApp",{appId:"ENORIPE_AP"})}),i.inject(this.header)},_renderComboBox:function(){},render:function(t){if(this.clearPanel(),t&&t.status&&"KO"===t.status){var i={};return i.message=I.get("generic"),this.dispatchEvent("ENORIPERelations_handleErrorMsgs",[i]),this.removeLoader(),this.hidePanel(),this}var n,s,o,a,l=0,d=this,h=[],f=[],g=this._attributes.AllTypes.attributes,_={height:"inherit",displayTitleTooltip:!0,displayedOptionalCellProperties:["description","contextualMenu"],useDragAndDrop:this.isDraggable},v=[],b=[],w=!0;for(var O in this._addinMode&&this._lockedApp&&("catiav5"!==this._addinMode||"true"!==this._lockedApp&&!0!==this._lockedApp||(w=!1)),this.noContextualMenu&&(w=!1),this.responsiveTiles=[],this._selectedModels=[],this.mapAccordion=new D({className:"relations-accordion",items:[],exclusive:!1}),this.isDraggable&&(_.onDragStartCell=this._onDragStart.bind(this)),t)if(t.hasOwnProperty(O)){if(0===Object.keys(t[O]).length&&t[O].constructor===Object)return this.removeLoader(),this.renderError(),P.publish("ENORIPE_Relations_ViewReady",[]),this;for(var A in t[O]=Object.keys(t[O]).sort(function(e,t){return I.get(e).localeCompare(I.get(t))}).reduce(function(e,i){return e[i]=t[O][i],e},{}),t[O])if((-1!==this.availableRelations.indexOf(A)||this._autoNavMode)&&t[O].hasOwnProperty(A)&&(l=t[O][A].length)>0){v=[],this._linkDirectionItemsMapping[I.get(A)]=t[O][A];for(var R=0;R<t[O][A].length;R++){n=t[O][A][R],s=new u({id:n.id,modelType:"node",columnID:0,focus:!1,isAnchor:!1,name:n.name,type:n.type,revision:n.revision});var M=(g=void 0!==this._attributes[n.type]?this._attributes[n.type].attributes:this._attributes.AllTypes.attributes).map(function(e){return e.uri});this.models[n.id]=s,f.push(s),new Date(n["ds6w:modified"]).toLocaleString(this._lang);var E=this._getLabels(n,M.slice(0,3)),N=this._getLabels(n,M.slice(3,6)),C=n.preview_url?n.preview_url:S.getWebappsAssetUrl("SNNavigationMap","icons/thumbnailLargeDefault.png"),x={label:E,icons:[n.icon_url],subLabel:N,thumbnail:C,customTooltip:new p({shortHelp:E,longHelp:this._getLongHelp(n,g)}),data:{id:n.id,type:n.type,element:n,relName:A,uniqueId:A+"-id-"+n.id}};if(n.preview_url||b.push(n.id),w)if(this._isWebInWin)"ENORIPE_AP"===this.appId&&(x.contextualMenu="A");else if("ENORIPE_AP"===this.appId||"X3DSEAR_AP"!=this.appId||n.type&&n.type.contains("Document"))x.contextualMenu="A";else if(!this.ODT_MODE){let e=new y({items:[]});var U=this._getContentForOpenWith(n);(new m).set3DXContent(U).render(e),0!==e.items.length&&(x.contextualMenu="A"),e.destroy(),e=null}n.instances&&n.instances.length>0&&(x.description=n.instances.length+" ",n.instances.length>1?x.description+=I.get("instances"):x.description+=I.get("instance"),l+=n.instances.length-1);var T=new c(x);v.push(T),this.nodeModels[n.id]=T}v.sort(function(e,t){return e.getAttributeValue("label").localeCompare(t.getAttributeValue("label"))}),(o=new r(_)).selectionBehavior={unselectAllOnEmptyArea:!0,toggle:!0,canMultiSelect:!0,canInteractiveMultiselectWithCheckboxClick:!0,enableShiftSelection:!0,enableFeedbackForActiveCell:!1},w&&(o.onContextualEvent={this:d,callback:function(e){d._handleMenuClick(e),e.data.event.stopPropagation()}}),o.model=v,a=e.createElement("div",{class:"list-tiles-container"});var V=80*o.model.length+30;a.setStyle("height",V),o.getContent().inject(a),this.responsiveTiles.push(o),h.push({title:I.get(A)+" ("+l+")",content:a,name:I.get(A)})}l=0,""}this.mapAccordion.addItem(h),this.mapAccordion.inject(this.scroller.getInnerElement()),this._accordionOpenedItem.forEach(function(e){this.mapAccordion.selectItem(e)}.bind(this)),0===f.length?this.renderError():this.showPanel(),this.responsiveTiles.length>0&&this.responsiveTiles.forEach(this._setUpEvents.bind(this)),b.length>0&&this.dispatchEvent("ENORIPE_UpdateThumbnail",[b]),this.removeLoader();var L={};return this.responsiveTiles.forEach(function(e){e.TreedocModel.getRoots().forEach(function(e){L[e._options.data.uniqueId]=e}),e.onReady(function(){e.getVisibleCellsInViewport();var t=e.getContent().getParent(),i=e.getContent().getElement(".wux-layouts-gridengine-poolcontainer-rel").getBoundingClientRect().height;t.setStyle("height",i+5)}.bind(this))}),this.expandRelationsName&&this.expandRelationsName.length>0&&this.expandRelations(this.expandRelationsName),this.dispatchEvent("ENORIPE_selectInfo",[L]),P.publish("ENORIPE_Relations_ViewReady",Object.keys(L)),this},expandRelations:function(e){if(e)for(var t=0;t<e.length;t++){this.mapAccordion.getItem(e[t])&&this.mapAccordion.selectItem(e[t])}},updateAttributes:function(e){var t,i,n,s,o=e.nlsObj;this._attributes=e.typeAttrs;var a=e.attrs;for(var r in o)o.hasOwnProperty(r)&&(t=o[r],(i=this.nodeModels[r])&&(n=this._getLabels(t,a.slice(0,3)),s=this._getLabels(t,a.slice(3,6)),i.setLabel(n),i._options.subLabel=s,i._options.customTooltip=new p({shortHelp:n,longHelp:this._getLongHelp(t,e.attributes)}),i.updateOptions()))},_updateThumbnails:function(e){if(e&&e.results){for(var t,i=this,n=[],s=0;s<e.results.length;s++){var o=e.results[s].attributes,a={};o.forEach(function(e){"resourceid"===e.name&&(a.id=e.value),"preview_url"===e.name&&(a.thumbnail=e.value)}),n.push(a)}n.forEach(function(e){(t=i.nodeModels[e.id])._options.thumbnail=e.thumbnail,t.updateOptions()})}},_getLongHelp:function(e,t){var i="",n="";if(e)for(var s=0;s<t.length;s++)if(void 0!==(n=e[t[s].uri])){var o=t[s].label;if(t[s].uri.contains("modified"))if(""!==n)n=new Date(n).toLocaleString(this._lang);i=i+o+" : "+n+"\n"}return i},_getSelectedProfile:function(){var e=this.profileTreeDocument.getRoots()[this._profileCombobox.selectedIndex];if(e)return e},_handleProfileChange:function(){this.currentProfile=this._getSelectedProfile().options.data.name,"AutoModeProfile"===this.currentProfile?this._autoNav=!0:this._autoNav=!1,this.dispatchEvent("ENORIPE_updateRelations",[this.currentProfile])},changeComboboxProfile:function(e){var t=0;if(this._profileCombobox&&this.profileArray)for(var i=0;i<this.profileArray.length;i++)if(e===this.profileArray[i].name&&this._profileCombobox.selectedIndex!==i){t=!this.inAppSpecificSection||this.inAppSpecificSection&&this.profileArray[i].isAppSpecific?i+1:i+2,this._profileCombobox.selectedIndex=t,this._profileCombobox._applySelectedIndex();break}},_handleMenuClick:function(e){var t;e&&e.infos&&e.infos.target?t=e.infos.target:e&&e.data&&e.data.target&&(t=e.data.target);var i=null;if(e.cellInfos&&e.cellInfos.cellModel?i=e.cellInfos.cellModel._options.data.element:e.context&&e.context.cellInfos&&e.context.cellInfos.cellModel&&(i=e.context.cellInfos.cellModel._options.data.element),i){var n,s="event"in window?event:window.event;if(s)s.clientX&&(n={x:s.clientX,y:s.clientY},t||(t=s.target));else if(e&&e.data&&e.data.windowPosition&&e.data.windowPosition.x&&e.data.windowPosition.y){var o=e.data.windowPosition;n={x:o.x,y:o.y}}var a={contextual:!0,target:t,items:[],events:{onClick:function(e){e.stopPropagation()},onClickOutside:function(){this.destroy()}}};if(this.dropDownMenu&&(this.dropDownMenu.destroy(),this.dropDownMenu=null),this.dropDownMenu=new y(a),this._isWebInWin)"ENORIPE_AP"===this.appId&&(this.dropDownMenu.addItem({text:I.get("AddInGraph"),name:"addInGraph",fonticon:"flow-branch-add",handler:function(){this.dispatchEvent("ENORIPERelations_addInGraph",[this._selectedModels])}.bind(this)}),i.type&&i.type.contains("Document")&&this.dropDownMenu.addItem({text:I.get("Download"),fonticon:"download",handler:function(){this.dispatchEvent("ENORIPE_DownloadDocument",[i.id,i.name])}.bind(this)}));else if("ENORIPE_AP"===this.appId&&this.dropDownMenu.addItem({text:I.get("AddInGraph"),name:"addInGraph",fonticon:"flow-branch-add",handler:function(){this.dispatchEvent("ENORIPERelations_addInGraph",[this._selectedModels])}.bind(this)}),"X3DSEAR_AP"!=this.appId&&this.dropDownMenu.addItem({text:I.get("Properties"),name:"properties",fonticon:"attributes",handler:function(){this._manageEditProp([i])}.bind(this)}),i.type&&i.type.contains("Document")&&this.dropDownMenu.addItem({text:I.get("Download"),fonticon:"download",handler:function(){this.dispatchEvent("ENORIPE_DownloadDocument",[i.id,i.name])}.bind(this)}),!this.ODT_MODE&&this.dropDownMenu){var r=this._getContentForOpenWith(i);(new m).set3DXContent(r).render(this.dropDownMenu)}var l=void 0;n&&(l={pageX:n.x,pageY:n.y}),0!==this.dropDownMenu.items.length&&(l?this.dropDownMenu.show(!0,l):this.dropDownMenu.show())}},_getContentForOpenWith:function(e){if(e){var t={data:{items:[{serviceId:this._serviceName,envId:this._platformId||"OnPremise",objectId:e.id,objectType:e.type}]}};if(e.relTypesTaxonomies&&e.relTypesTaxonomies.length>0){var i=this._getTaxonomies(e.relTypesTaxonomies);i&&i.length>0&&(t.data.items[0].objectTaxonomies=i)}else"3DShape"===e.type&&(t.data.items[0].objectTaxonomies=["PLMEntity","PLMReference","PLMCoreRepReference","LPAbstractRepReference","LPAbstract3DRepReference","PHYSICALAbstract3DRepReference","VPMRepReference","3DShape"]);return t}},_getTaxonomies:function(e){if(e&&e.length>0){for(var t=e.split(","),i=0;i<t.length;i++)if(t[i].contains("types")){t=t[i];break}var n=t.split("/");return n.length>1?(n.splice(0,1),n):[]}},_getLabels:function(e,t){if(t){for(var i="",n=0,s="",o=0;o<t.length;o++){if(s="",e.hasOwnProperty(t[o]))if(s=e[t[o]],t[o].contains("modified"))if(""!==s)s=new Date(s).toLocaleString(this._lang);if(s&&s.length>0&&(i=i.length>0?i+this._separator+s:s,n++),3===n)break}return i}},updateHeader:function(){this.isProfilesVisible&&this.header.getChildren()[0].setHTML(I.get(this.currentProfile))},_onDragStart:function(e,t){var i={protocol:"3DXContent",version:"1.0",source:"ENORIPE_AP",action:"extract",data:{sourceIds:Array.isArray(this.sourceModels.get("id"))?this.sourceModels.get("id"):[this.sourceModels.get("id")],items:this.getSelectedItems({serviceId:this._serviceName,objectId:t.cellModel._options.data.id,objectType:t.cellModel._options.data.type,displayName:t.cellModel._options.label}),widgetSessionId:this._widgetId}};try{e.dataTransfer.setData("text/searchitems",JSON.stringify(i)),e.dataTransfer.setData("text",JSON.stringify(i))}catch(t){console.log(t),e.dataTransfer.setData("text",JSON.stringify(i))}s.closeWidget()},_setUpEvents:function(e){var t=this;e.TreedocModel.getXSO().onChange(function(e){var i=e._options.data.id,n=e.isSelected()?"add":"remove",s=t.models[i];if("add"===n&&-1===t._selectedModels.indexOf(s))t._selectedModels.push(s);else if("remove"===n&&-1!==t._selectedModels.indexOf(s)){var o=t._selectedModels.indexOf(s);t._selectedModels.splice(o,1)}t._syncObjectToCompass()})},renderError:function(){var t=this,i=this.isProfilesVisible?"link":"";this.errorDiv=new e.createElement("div",{class:"empty-relation-div"}),this.iconEmptyListP=new e.createElement("p",{class:"icon-empty-list",html:'<i class= "wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-object-related-cog" ></i>'}).inject(this.errorDiv),this.textEmptyRelationP=new e.createElement("p",{class:"empty-relation-para",html:I.get("NoResultFound")}).inject(this.errorDiv),this.errorSpan=new e.createElement("span",{class:"empty-relation-span "+i,html:I.get(t.currentProfile)}).inject(this.textEmptyRelationP),this.errorDiv.inject(this.scroller.getInnerElement()),this.isProfilesVisible&&t.errorSpan.addEvent("click",function(){t._profileCombobox._showPopup()})},_manageEditProp:function(e){try{require([this._propertiesCommandRequire],function(e){var t=this,i={getSelectedNodes:function(){var e=[];return t._selectedModels.forEach(function(i){var n={id:i.id,tenant:t._tenant,source:"3DSpace",getID:function(){return i.id},getRelationID:function(){return i.id}};e.push(n)}),e}};(new e).launchProperties(i)}.bind(this))}catch(e){console.error(e)}},_syncObjectToCompass:function(){var e=this._selectedModels;if(0===e.length)this.updateSelection(null),_.publish("resetTypes");else{var t={widgetId:this._widgetId};_.publish("setTypes",t)}1===e.length&&this.updateSelection(e[0]);var i=this._buildCompassData({widgetId:this._widgetId,envId:this._platformId,selectedModels:e});this._compassSocket.dispatchEvent("onSetX3DContent",i),widget.getValue("x3dAppId"),this._publishSelectionEvent(e)},_publishSelectionEvent:function(t){var i={metadata:{uid:e.Utils.getUUID(),originUid:this._selectUuid,timestamp:Date.now(),appid:"/no_private_channel",originWidgetId:widget.id,ignoreFromSameWidgetId:!0,origin:"ENORIPE_Relations"},data:{tenant:this._tenant,version:"1.1"}};"undefined"!=typeof widget&&null!==widget&&(void 0!==widget.getValue("x3dSharedId")?i.metadata.appid="/"+widget.getValue("x3dSharedId"):void 0!==widget.getValue("x3dAppId")?i.metadata.appid="/"+widget.getValue("x3dAppId"):void 0!==widget.getValue("appId")&&(i.metadata.appid="/"+widget.getValue("appId")+"_"+widget.id)),i.data.paths=[],i.data.attrData=[];for(var n=0;n<t.length;n++)i.data.paths[n]=[t[n].get("id")],i.data.attrData[n]=this.models[t[n].get("id")]._attributes;try{require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"],function(e){i.data.changeControl=e.get()})}catch(e){console.warn("No Change")}P.publish("DS/PADUtils/PADCommandProxy/select",i);var s=this.localKey+"/ENORIPE_selection";P.publish(s,i)},updateSelection:function(e){if(null===e){var t={objectId:"",envId:this._platformId,contextId:"",serviceId:this._serviceName||"3DSpace"};return this._compassSocket.dispatchEvent("onSetObject",t),void this._compassSocket.dispatchEvent("onResetX3DContent",{})}var i={objectId:e.get("id"),envId:this._platformId,contextId:"",serviceId:this._serviceName||"3DSpace"};if(this._compassSocket.dispatchEvent){this._compassSocket.dispatchEvent("onSetObject",i);var n={widgetId:this._widgetId};_.publish("setTypes",n)}},_buildCompassData:function(t){var i=this,n={};if(e.is(t)){var s=t.selectedModels;if(e.is(s,"array")){n={protocol:"3DXContent",version:"1.1",source:"ENORIPE_AP",widgetId:t.widgetId,profile:this.currentProfile,data:{items:[]}};var o=[];s.forEach(function(e){var n={envId:t.envId,serviceId:i._serviceName,contextId:"",objectId:e.id,objectType:e.get("type"),displayName:e.get("name"),displayType:e.get("type")};o.push(n)}),n.data.items=o}}return n},_setTypesCallback:function(e){if(e.widgetId===this._widgetId){var t={appId:e.appId,widgetId:e.widgetId};if(this._selectedModels.length>0){var i=this.buildSelectionForNativeApps();t.fileName="-file",t.fileContent=i}_.publish("launchApp",t)}},buildSelectionForNativeApps:function(){for(var e,t={version:"2.1",results:[],structures:[{structure:[]}]},i=0;i<this._selectedModels.length;i++)e=JSON.stringify(i+1),t.results.push({id:e,phid:this._selectedModels[i].id}),t.structures[0].structure.push({id:e,show:!0,select:!0,children:[]});return JSON.stringify(t)},getSelectedItems:function(e){var t=[],i=this,n=this._platformId,s=null;e.envId=n,t.push(e);for(var o=0;o<this.responsiveTiles.length;o++)(s=this.responsiveTiles[o].TreedocModel.getSelectedNodes())&&s.length>0&&s.forEach(function(s){s._options.data.id!==e.objectId&&t.push({envId:n,serviceId:i._serviceName,objectId:s._options.data.id,objectType:s._options.data.type,displayName:s._options.label})});return t},hidePanel:function(){this.container.hide()},showPanel:function(){this.container.show()},trackPopOutCommandUsage:function(e){a.trackUsage("PopOut","SourceApp-"+e)},removeLoader:function(e){b.unmask(this.getOption("forMaskManagement"))},clearPanel:function(){if(this.mapAccordion){var e=this.mapAccordion.getUnselectedItems().map(function(e){return this.mapAccordion.getItem(e.id).name}.bind(this));this._accordionOpenedItem=this._accordionOpenedItem.filter(function(t){return e.indexOf(t)<0}),this.mapAccordion.getSelectedItems().forEach(function(e){this._accordionOpenedItem.indexOf(this.mapAccordion.getItem(e.id).name)<0&&this._accordionOpenedItem.push(this.mapAccordion.getItem(e.id).name)}.bind(this))}this.scroller.getInnerElement().empty(),this._selectedModels=[]},destroy:function(){this.clearPanel(),this._parent(),this.container=null}})}),define("DS/ENORIPE_Relations/views/RelationsTab",["UWA/Core","UWA/Class","UWA/Promise","DS/ENORIPE_Relations/RelationsTabSettings","DS/SNNavigationMap/MapSettings","DS/SNNavigationMap/utils/ProbesUtils","DS/ENORIPE_Relations/utils/CommonUtils","DS/EditPropWidget/facets/Common/FacetsBase","DS/EditPropWidget/constants/EditPropConstants","UWA/Class/Model","DS/WAFData/WAFData","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/UIKIT/Popover","DS/Controls/Toggle","DS/Controls/Button","DS/SNNavigationMap/utils/SNNavigationServices","DS/SNNavigationMap/utils/RelationsServices","DS/PADServices/utils/PADTrackerManager","i18n!DS/ENORIPE_Relations/assets/nls/Relations","DS/PlatformAPI/PlatformAPI"],function(e,t,i,n,s,o,a,r,l,c,d,p,u,h,f,g,m,_,v,I,b,P){"use strict";var S,w;return r.extend({_widgetID:(S=new Date,w=S.getDay()+S.getMonth()+S.getFullYear()+"-"+S.getHours()+":"+S.getMinutes()+":"+S.getSeconds(),"ENORIPE_Relations_Preview_"+Math.floor(1e4*Math.random())+"_"+w),_appID:n.getAppID(),_3dSpaceUrl:null,_availableRelations:[],_profileInfo:null,profilePopover:null,_toggles:[],_tenant:null,_subscriptions:[],_autoNavMode:n.getOption("automode"),init:function(t){var i=this;this._parent.apply(this,arguments),this.elements.container||(this.elements.container=e.createElement("div",{styles:{height:"100%"}})),void 0===n.getOption("initProfileDone")&&t&&t.defaultProfile&&e.is(t.defaultProfile,"string")&&n.saveValuesForProfile("LastUsedProfile",t.defaultProfile);var s=n.getLocalKey()+"/setProfile",o=n.getLocalKey()+"/updateAttributes",a=n.getLocalKey()+"/updatePublicationsMode",r=n.getLocalKey()+"/expandRelations",l=P.subscribe(s,function(e){i.setProfile(e.profile)});P.subscribe(o,function(e){i._setAttributes(e.attrs),i.updateAttributes()}),P.subscribe(a,function(e){i.updatePublicationsMode(e.publicationsMode)}),r=P.subscribe(r,function(e){i.expandRelations(e.relationsNames)});this._subscriptions.push(l),!0!==n.getOption("isExternal")&&"true"!==n.getOption("isExternal")||(this.getModel=function(){return i._internalModel})},updateFacet:function(){var e=this,i=e.getModel();if(null!==i){var o="relationship"===i.get("metatype");return!o||o&&void 0!==i.get("selReferenceID")?(this._tenant=i.get("tenant"),this.setDefaultPredicates(),this.addLoader(),new t.Promise(function(t,o){null===e._3dSpaceUrl?s.appInitializationPromised(null,e._tenant).then(function(){p.getServiceUrl({serviceName:i.get("source"),platformId:i.get("tenant")?i.get("tenant"):"OnPremise",onComplete:function(i){e._3dSpaceUrl=i,s._getListOfSecurityContext().then(function(i){s.setXPrefCredential(i[0].value),n.isAvailable().then(e._getSettingsAndRelSets.bind(e)).then(e._mergeSettings.bind(e)).then(e._parseRelations.bind(e)).then(e._setPreferences.bind(e)).then(function(){e._renderListView(),e.trackUsage(),t()})})},onFailure:function(t){console.log(t),e.removeLoader(),o()}})}):void 0!==e.currentProfile&&e._setPreferences().then(function(){e._renderListView(),e.trackUsage(),t()})})):void 0}},updateFacetExternal:function(e){var i=this;if(null!==e){var o,a="relationship"===e.get("metatype");return a?a&&void 0!==e.get("selReferenceID")&&(o=e.get("selReferenceID")):o=e.get("objectId"),void 0!==o?(e.set("id",o),this.setModel(e),this._tenant=e.get("tenant"),this.setDefaultPredicates(),this.addLoader(),new t.Promise(function(t,o){null===i._3dSpaceUrl?s.appInitializationPromised().then(function(){p.getServiceUrl({serviceName:e.get("source"),platformId:e.get("tenant")?e.get("tenant"):"OnPremise",onComplete:function(e){i._3dSpaceUrl=e,s._getListOfSecurityContext().then(function(e){s.setXPrefCredential(e[0].value),n.isAvailable().then(i._getSettingsAndRelSets.bind(i)).then(i._mergeSettings.bind(i)).then(i._parseRelations.bind(i)).then(i._setPreferences.bind(i)).then(function(){i._renderListView(),t()})})},onFailure:function(e){console.log(e),i.removeLoader(),o()}})}):void 0!==i.currentProfile&&i._setPreferences().then(function(){i._renderListView(),t()})})):void 0}},_getSettingsAndRelSets:function(e){var t=this._getRelSettings(),n=this._getProfiles(e);return i.all([t,n])},_getRelSettings:function(){var e=this;return{widgetId:e._widgetId},new i(function(t,i){var n=e._3dSpaceUrl+"/resources/enorelcc/cc_services/getrelsettings?tenant="+e._tenant;d.authenticatedRequest(n,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"GET",timeout:s.getTimeout(),onComplete:function(i){e._parseSettings(JSON.parse(i)).then(function(){t()})},onFailure:function(e){i(e),console.log(e)},onTimeout:function(e){i(e),console.log(e)}})})},_parseSettings:function(e){var t=this;return new i(function(i,n){e.notexist||void 0===e.relation_apps?t._getResetRelApps().then(function(e){t._settings=e,i()}):(t._settings=e,i())})},_getResetRelApps:function(){var e=this;return{widgetId:e._widgetId},new i(function(t,i){if(void 0===e._resetSettingsFromServer){var n=e._3dSpaceUrl+"/resources/enorelcc/cc_services/getrelappsinit?tenant="+e._tenant;d.authenticatedRequest(n,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"GET",timeout:s.getTimeout(),onComplete:function(i){e._resetSettingsFromServer=JSON.parse(i),t(e._resetSettingsFromServer)},onFailure:function(e){i(e),console.log(e)},onTimeout:function(e){i(e),console.log(e)}})}else t(e._resetSettingsFromServer)})},trackUsage:function(){o.trackPerformance("relationsTabUsage","relationsTabUsage",{CurrentProfile:this.currentProfile,AppID:this._appID})},_renderListView:function(){var e,t=this,i=[],s=!1;if(t.elements&&t.elements.container){var o=t.getModel();if(!o)return!1;if(e=!!o.isMergedModel&&o.isMergedModel(),"relationship"===o.get("metatype")&&void 0!==o.get("selReferenceID")&&(s=!0),t.listView){t.listView.availableRelations=t._availableRelations,t.listView._attributes=n.getOption("typeattributes");var a=e?o.getMergedModelIds():s?o.get("selReferenceID"):o.get("objectId");t.listView.setModel(new c({id:a,serviceName:o.get("source")||"3DSpace",platformId:o.get("tenant")||"OnPremise"}))}else{for(var r=0;r<t._profileInfo.length;r++)t._profileInfo[r].type?i[r]={name:t._profileInfo[r].name,type:t._profileInfo[r].type}:i[r]={name:t._profileInfo[r].name},t._profileInfo[r].custom&&(i[r].type="custom"),t._profileInfo[r].applications&&t._profileInfo[r].applications.length>0&&(i[r].isAppSpecific=!0),t._profileInfo[r].nlsLabel&&(i[r].nls=t._profileInfo[r].nlsLabel);require(["DS/ENORIPE_Relations/views/RelationsView"],function(a){t.listView=new a({fireEventOnSlide:!0,widgetId:t._widgetID,appId:t._appID,localKey:n.getLocalKey(),debugMode:!0,serviceURL:t._3dSpaceUrl,currentProfile:t.currentProfile,profileArray:i,tenant:t._tenant,separator:n.getOption("displayNameSeparator"),attrs:n.getOption("typeattributes"),lang:n.getLang(),userID:"",isDraggable:n.getOption("isDraggable"),isProfilesVisible:n.getOption("isProfilesVisible"),noContextualMenu:n.getOption("noContextualMenu"),autoNavMode:t._autoNavMode,forMaskManagement:t.elements.container,addinmode:n.getOption("addinmode"),lockedApp:n.getOption("lockedapp"),myappsurl:_.isWebInWin()?n.getMyAppsUrl():null,expandRelations:n.getOption("expandRelations")}),t.listView.inject(t.elements.container),t.listView.availableRelations=t._availableRelations;var r=e?o.getMergedModelIds():s?o.get("selReferenceID"):o.get("objectId");t.listView.setModel(new c({id:r,serviceName:o.get("source")||"3DSpace",platformId:o.get("tenant")||"OnPremise"})),t.listView.addEvent("ENORIPERelations_handleErrorMsgs",t._showNotif,t),t.listView.addEvent("ENORIPE_updateRelations",t._updateRelations,t),t.listView.addEvent("ENORIPERelations_addInGraph",function(e){var i=n.getLocalKey()+"/addInGraph",s={models:e,widgetSessionId:t._widgetID};P.publish(i,s)}),t.listView.addEvent("ENORIPE_DownloadDocument",function(e,i){var s=n.getLocalKey()+"/downloadDocument",o={modelId:e,modelName:i,widgetSessionId:t._widgetID};P.publish(s,o)}),t.listView.addEvent("ENORIPE_selectInfo",function(e){t._selectInfo=e}),n.getOption("Fetch_Thumbnails")&&t.listView.addEvent("ENORIPE_UpdateThumbnail",t._updateThumbnails,t)})}}},_updateRelations:function(e){if(e){this.addLoader(),this.setProfile(e)}},_updateThumbnails:function(e){var t=this;void 0===this._commonUtils&&(this._commonUtils=new a({_3dSpaceUrl:this._3dSpaceUrl,myappsurl:_.isWebInWin()?n.getMyAppsUrl():null,tenant:this._tenant,isWebInWin:_.isWebInWin(),lang:n.getLang(),userID:n.getUserID()}));try{this._commonUtils.fetchThumbNails(e).then(function(e){e&&t.listView._updateThumbnails(JSON.parse(e))},function(e){console.log(e)})}catch(e){console.log("err while fetching tooltip")}},selectNodes:function(e){var t=this;e.forEach(function(e){t._selectInfo[e]&&t._selectInfo[e].select()})},unselectNodes:function(e){var t=this;e.forEach(function(e){t._selectInfo[e]&&t._selectInfo[e].unselect()})},updateAttributes:function(){void 0===this._commonUtils&&(this._commonUtils=new a({_3dSpaceUrl:this._3dSpaceUrl,myappsurl:_.isWebInWin()?n.getMyAppsUrl():null,tenant:this._tenant,isWebInWin:_.isWebInWin(),lang:n.getLang(),userID:n.getUserID()}));var e=Object.keys(this.listView.models);if(e&&e.length>0)for(var t=0;t<e.length;t++){var i=this.listView.models[e[t]].get("type");this._fetchAndSetAttributes(e[t],i)}},updatePublicationsMode:function(e){n.setOption("publicationsMode",e)},expandRelations:function(e){this.listView&&this.listView.expandRelations(e)},_fetchAndSetAttributes:function(e,t){var i=this,s={ids:[e],typeAttrs:n.getOption("typeattributes"),type:t};try{i._commonUtils.fetchAttributes(s).then(function(e){e&&e.nlsObj&&Object.keys(e.nlsObj).length>0&&i.listView.updateAttributes(e)},function(e){console.log(e)})}catch(e){console.log("err while fetching tooltip")}},createPromise:function(e){var i=JSON.stringify(e.params),n=this;return new t.Promise(function(t,o){d.authenticatedRequest(e.url,{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:s.getXPrefCredential()},method:"POST",data:i,timeout:s.getTimeout(),onComplete:t,onFailure:function(e){console.log(e),n._showNotif({message:b.get("generic")}),n.removeLoader(),o(e)},onTimeout:function(e){console.log(e),n._showNotif({message:b.get("timeout"),subtitle:b.get("verifyConnection")}),n.removeLoader(),o(e)}})})},setModel:function(e){this._internalModel=e},_getProfiles:function(e){return this.createPromise({url:this._3dSpaceUrl+"/resources/enorelnav/navigate/getProfiles?tenant="+this._tenant,params:{widgetId:this._widgetID,roles:e.roles,profileVersion:2}})},_mergeSettings:function(e){if(e&&e.length>0){var t=JSON.parse(e[1]),s=n.getRoles(),o=this,a=!1;return new i(function(e,i){o._settings.relation_sets||e(t),0===Object.keys(o._settings.relation_sets).length&&e(t);t.profiles.map(function(e){return e.name});for(var n=0;n<o._settings.relation_sets.length;n++){for(var r=o._settings.relation_sets[n].roles,l=o._settings.relation_sets[n].userGroups,c=!1,d=0;d<r.length;d++)if(s.indexOf(r[d])>-1){c=!0;break}if(l.length>0&&!c){a=!0;break}}a?o._getGrantedUsrGrp().then(function(i){t=o._filterRelSets(t,i),e(t)}):(t=o._filterRelSets(t,[]),e(t))}.bind(this))}},_filterRelSets:function(e,t){for(var i=n.getRoles(),s=e.profiles.map(function(e){return e.name}),o=(t=t.map(function(e){return e.resourceid}),0);o<this._settings.relation_sets.length;o++){var a=this._settings.relation_sets[o].roles,r=this._settings.relation_sets[o].userGroups,l=this._settings.relation_sets[o].applications||[],c=!1;a&&a.length>0&&(a=a.map(function(e){return e.name})),r&&r.length>0&&(r=r.map(function(e){return e.name}));for(var d=0;d<a.length;d++)if(i.indexOf(a[d])>-1){c=!0;break}if(!c)for(d=0;d<r.length;d++)if(t.indexOf(r[d])>-1){c=!0;break}var p=s.indexOf(this._settings.relation_sets[o].name);if(c){if(-1===p?e.profiles.push(this._settings.relation_sets[o]):e.profiles.splice(p,1,this._settings.relation_sets[o]),l.length>0&&(l=l.map(function(e){return e.name})).indexOf(this._appID)<0){p=s.indexOf(this._settings.relation_sets[o].name);e.profiles.splice(p,1)}}else-1!==p&&e.profiles.splice(p,1)}return e},_getGrantedUsrGrp:function(){var e=this;return new i(function(t,i){if(void 0===typeof s||!s)var s=e.getModel();n.getOption("user_granted_groups")?t(n.getOption("user_granted_groups")):p.getServiceUrl({serviceName:"3DSearch",platformId:s.get("tenant")?s.get("tenant"):"OnPremise",onComplete:function(i){var s={},o=i+"/search",a=n.getUserID();s.label="ENORIPE_"+a+"_"+Date.now(),s.select_predicate=["ds6w:label"],s.query="[ds6w:type]:GROUP AND "+a,s.tenant=e._tenant,s.nresults=100,s.with_synthesis_attribute=!1,s.with_synthesis=!1,s=JSON.stringify(s),d.authenticatedRequest(o,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",data:s,onComplete:function(i){var s=e._parseUserGroups(JSON.parse(i));n.setOption("user_granted_groups",s),t(s)},onFailure:function(e){console.log("failed in fetching granted usrgrps"+e),t([])},onTimeout:function(e){console.log("failed in fetching granted usrgrps"+e),t([])}})},onFailure:function(t){console.log(t),e.removeLoader(),i()}})})},_parseUserGroups:function(e){var t=[];if(e.results)for(var i=0;i<e.results.length;i++){var n=e.results[i];if(n.attributes){for(var s={},o=0;o<n.attributes.length;o++)"resourceid"===n.attributes[o].name&&(s.resourceid=n.attributes[o].value),"ds6w:label"===n.attributes[o].name&&(s.label=n.attributes[o].value);void 0!==s.resourceid&&t.push(s)}}return t},_parseRelations:function(e){if(this._availableRelations=[],e){var t,s=this,o=e.profiles[0],a={name:"AutoModeProfile"},r=n.getValuesForProfile("LastUsedProfile");a.relations=[],e.profiles.unshift(a);var l=this._getRelationsSet();if(l)for(var c=0;c<l.length;c++)e.profiles.splice(c+1,0,l[c]);this._profileInfo=e.profiles,t=null!==r&&""!==r&&void 0!==r?r:"defaultID"===this._appID?e.profiles[0].name:this._settings.relation_apps[this._appID],this.currentProfile=e.profiles[0].name;for(var d=0;d<e.profiles.length;d++)if(t===e.profiles[d].name){o=e.profiles[d],this.currentProfile=e.profiles[d].name;break}"AutoModeProfile"===this.currentProfile?this._autoNavMode=!0:this._autoNavMode=!1;for(var p=0;p<this._profileInfo.length;p++);}return new i(function(e,t){if(o){for(var i=o.relations,n=0;n<i.length;n++)s._availableRelations.push(i[n].name);e()}else t()})},_setPreferences:function(){var e,t=this._getAttrForTypes();return e=!!n.getOption("publicationsMode"),n.saveValuesForProfile("LastUsedProfile",this.currentProfile),this.createPromise({url:this._3dSpaceUrl+"/resources/enorelnav/v2/navigate/setPreferences?tenant="+this._tenant,params:{widgetId:this._widgetID,relations:this._autoNavMode?["use-auto-by-type-relations"]:this._availableRelations,allRelationsMode:this._autoNavMode,publicationsMode:e,computeWithInstances:!0,attributesForView:t,label:s.getLabelAPI(),lang:s.getLang()||"en",ghostMode:s.getGhostMode()}})},_getAttrForTypes:function(){var e=n.getOption("typeattributes"),t=[];for(var i in e){if(e.hasOwnProperty(i))e[i].attributes.map(function(e){return e.uri}).forEach(function(e){-1===t.indexOf(e)&&t.push(e)})}return t},setDefaultPredicates:function(){var e=n.getUserID()+"_ENORIPE_Type_Attrs",t=localStorage.getItem(e),i=[];if(t)t=JSON.parse(t);else{for(var s,o,a=n.getOption("attributes"),r=0;r<a.length;r++)o=-1!==(s=a[r]).indexOf(":")?b.get(s.substr(s.indexOf(":")+1)):b.get(s),i.push({uri:s,label:o});t={AllTypes:{name:"AllTypes",nlsLabel:b.get("AllTypes"),attributes:i}}}this._setAttributes(t)},_setAttributes:function(e){n.setOption("typeattributes"),n.setOption("typeattributes",e)},_getRelationsSet:function(){var e=localStorage.getItem(n.getUserID()+"_ENORIPE_CustomRelationsSet");if(e)return JSON.parse(e)},_showNotif:function(e){this.alert&&this.alert.destroy(),this.alert=new h({visible:!0,autoHide:!0,hideDelay:3e3,animate:!0}).inject(this.elements.container),this.alert.add({className:"error",message:e.subtitle?e.subtitle+" "+e.message:e.message})},addLoader:function(){u.mask(this.elements.container)},removeLoader:function(e){u.unmask(this.elements.container)},getProfilesAndRelations:function(){return this._profileInfo},getCurrentProfile:function(){return this.currentProfile?this.currentProfile:n.getValuesForProfile("LastUsedProfile")},getProfiles:function(){var e=[];return this._profileInfo&&this._profileInfo.length>0&&this._profileInfo.forEach(function(t){e.push(t.name)}),e},setProfile:function(e){if(""!==e&&null!=e){for(var i=this,n=!1,s=0;s<this._profileInfo.length;s++)if(this._profileInfo[s].name===e&&this.currentProfile!==e){n=!0,this.currentProfile=this._profileInfo[s].name;var o=this._profileInfo[s].relations;this._availableRelations=[],"AutoModeProfile"===e?(this._autoNavMode=!0,this.listView._autoNavMode=!0):(this._autoNavMode=!1,this.listView._autoNavMode=!1);for(var a=0;a<o.length;a++)this._availableRelations.push(o[a].name);this.listView.availableRelations=this._availableRelations;break}return new t.Promise(function(t,s){n?(i.listView&&i.listView.changeComboboxProfile(e),i._setPreferences().then(function(){i._renderListView(),i.trackUsage(),t()},function(){s()})):t()})}console.log("Invalid profile name")},destroyComponent:function(){e.is(this.destroy,"function")&&this.destroy()}})});