/*!  Copyright 2019 Dassault Systemes. All rights reserved. */
define("DS/CATWebUXTIC/CATWebUXTICCmdAdapt",["DS/ApplicationFrame/Command","DS/PlatformAPI/PlatformAPI"],function(e,t){"use strict";var n,i,s,r,o,a,c,u,l,d,p;function f(e){if(c)u.getSecurityContext=function(){return require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx").replace("ctx::","")},u.getTenant=function(){return require("DS/PADUtils/PADUtilsServices").getPlatformId()},e();else{require(["DS/IssueManagementWebInWin/ENOIssueGenerationWebPanel","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","DS/IssueServices/services/IssueServices"],function(t,n,i,s){a=t,u=i,l=s,(c=n).add("widget",window.widget),u.getSecurityContext=function(){return require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx").replace("ctx::","")},u.getTenant=function(){return require("DS/PADUtils/PADUtilsServices").getPlatformId()},u.initPlatformServices().then(function(){e()})})}}return require(["i18n!DS/CATWebUXTIC/assets/nls/CATWebUXTICCmdAdapt"],function(e){n=e.caOK,i=e.caKO,s=e.caAttached,r=e.caNotAttached}),e.extend({init:function(e){var c=this,u="CATWebUXGenerateIssueHdr"===e.ID?"Issue":"CA",g=null,m=null,D=e.pad3DViewer;function S(e){!function e(t){o?(!d.setTenant&&window.enoviaServerCAWidget&&(window.enoviaServerCAWidget.tenant=require("DS/PADUtils/PADUtilsServices").getPlatformId()),t()):require(["DS/WAFData/WAFData","DS/ENOChgActionCMDs/scripts/CAActionBarController","DS/ENOChangeActionUX/scripts/CreateCAForm"],function(n,i,s){o=n,d=i,p=s,e(t)})}(function(){if(e.status&&"ticCancel"===e.status&&c.end(),c.isRunning()){var t=e.fromIssue;delete e.fromIssue,d.clearObjects(),d.addTitle(e.title),d.addDescription(e.description),d.addContext(e.contexts),d.addReferential(e.attachments),d.setTenant&&d.setTenant(require("DS/PADUtils/PADUtilsServices").getPlatformId()),d.setSecurityContext&&d.setSecurityContext(require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx")),new Promise(function(n){t?f(function(){l.issues.retrieve({data:{objects:[{physicalId:t}]}}).then(function(e){n(),(e=e.results)&&1===e.length&&e[0]&&e[0].body&&(d.addProposed((e[0].body.reportedAgainst||[]).map(function(e){return e.physicalId})),d.addFollower([e[0].body.owner.user]),d.addAssignee((e[0].body.assignees||[]).map(function(e){return e.user})))})}):(d.addProposed(e.reportedAgainst),e.assignees&&d.addAssignee(e.assignees),n())}).then(function(){p.createCAFromActionBar(d.getJSON(),u,a).then(function(){(m=p.CACreateModal).options.escapeToClose=!1})})}function a(){e.onCancel&&e.onCancel(),c.end()}function u(a){if(D.displayNotification({msg:a.changeaction?n:i,eventID:a.changeaction?"success":"error"}),a.changeaction){var u=a.changeaction.id.replace("pid:","");e.onComplete&&e.onComplete({attachmentIDs:e.attachments,name:e.title,ticID:u}),new Promise(function(n){if(t)n([t]);else{var i=require("DS/PADUtils/PADUtilsServices").get3DSpaceUrl()+"/cvservlet/navigate",s=require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx"),r="&tenant="+require("DS/PADUtils/PADUtilsServices").getPlatformId();o.authenticatedRequest(i+"?SecurityContext="+s+r,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:s},data:JSON.stringify({input_physical_ids:e.attachments,label:"ParentIssue"+Date.now(),primitives:[{navigate_from_rel:{id:1,filter:{bo_type:["Issue"]}}}],patterns:{issue:[{id:1}]},fileAttributes:[],attributes:[],version:3}),onComplete:function(e){var t=e?JSON.parse(e):null;if(t&&t.result&&t.result.length){var i=[];t.result.forEach(function(e){if(e.outputs&&e.outputs.issue&&1===e.outputs.issue.length){var t=e.outputs.issue[0].physicalid;-1===i.indexOf(t)&&i.push(t)}}),n(i)}else n()},onFailure:n,onTimeout:n})}}).then(function(e){e&&0!==e.length&&f(function(){l.related.update({data:{objects:e.map(function(e){return{physicalId:e,resolvedBy:[{physicalId:u}]}})},onComplete:function(){D.displayNotification({msg:s,eventID:"success"})},onFailure:function(){D.displayNotification({msg:r,eventID:"error"})}})})})}c.end()}})}delete e.pad3DViewer,e.mode="exclusive",e.isAsynchronous=!0,this._parent(e),this.getParameters=function(e){e.onFailure("Must be implemented by children")},this.execute=function(){c.getParameters({cmdType:u,onComplete:function(e){require(["DS/CATWebUXComponents/CATWebUXUtils"],function(e){e._sendUsageProbe("command","Issue"===u?"GenerateIssue":"GenerateCA")}),("Issue"===u?function(e){f(function(){e.assignees=void 0,delete e.fromIssue,e.status&&"ticCancel"===e.status&&c.end(),c.isRunning()&&(g=new a({data:e,htmlContainer:window.widget.body,onClose:()=>{e.onCancel&&e.onCancel(),c.end()}}))})}:S)(e),c.platFormIssueSubscription=t.subscribe("DS/Object/create",function(t){e.onComplete&&e.onComplete({attachmentIDs:e.attachments,name:e.title,ticID:t.data.paths[0][0]})})},onCancel:c.end.bind(c),onFailure:function(e){window.console.error(e)}})},this.pauseExecute=function(){c.end()},this.endExecute=function(){g&&(g.destroy(),g=null),m&&m.hide(),c.platFormIssueSubscription&&t.unsubscribe(c.platFormIssueSubscription)},this._destroy=function(){c=D=null;var e=Object.getPrototypeOf(this);e._destroy&&e._destroy.apply(this,arguments)},this.onClose=function(){g=null,c.end()},this.disable()}})});