/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CATWebUXSlideShow/CATWebUXSlideShowController",["UWA/Core","UWA/Class","DS/CATWebUXComponents/CATWebUXNotification","DS/WebappsUtils/WebappsUtils","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Utilities/TouchUtils","DS/ApplicationFrame/CommandsManager","i18n!DS/CATWebUXSlideShow/assets/nls/CATWebUXSlideShow","css!DS/CATWebUXSlideShow/CATWebUXSlideShow.css"],function(e,t,i,n,o,r,l,a,s,d,c,S){"use strict";var u=t.extend({init:function(t){this._parent(t);var u,v,h,C,f=t||{},m=!1,w=this,b=new l,g=f.context,A=g.getViewer(),y={},p={},U={},x={},T={},W="windowed",P=g.getUIFrame(),E=[],k=f.params&&f.params.activateRotation;let X=null,D=!1;function M(e,t){b.publish({event:e,data:t,context:w})}function I(e){e.ctrlKey||"ArrowLeft"!==e.key&&37!==e.keyCode&&"ArrowUp"!==e.key&&38!==e.keyCode&&"PageUp"!==e.key&&33!==e.keyCode?e.ctrlKey||"ArrowRight"!==e.key&&39!==e.keyCode&&"ArrowDown"!==e.key&&40!==e.keyCode&&"PageDown"!==e.key&&34!==e.keyCode?"Escape"===e.key||27===e.keyCode?(W="noViewRequested",w.setActiveState(!1)):"Home"===e.key||36===e.keyCode?M("onFirstSlideCB"):"End"!==e.key&&35!==e.keyCode||M("onLastSlideCB"):M("onNextSlideCB"):M("onPreviousSlideCB")}function _(){v&&(clearTimeout(v),v=0),p.left.setStyles({opacity:null}),p.right.setStyles({opacity:null}),p.exitSlideShow.setStyles({opacity:null}),d.getTouchMode()||(v=setTimeout(function(){p.left.setStyles({opacity:0}),p.right.setStyles({opacity:0}),p.exitSlideShow.setStyles({opacity:0})},2e3))}function B(){A.currentViewpoint.getControl()._changeState(5)}function N(){A.currentViewpoint.getControl()._changeState(-1)}function H(e){if(e&&e.getId){var t=e.getId();if(-1!==E.indexOf(t))return;"CATWebUXSlideShowPreviousHdr"!==t&&"CATWebUXSlideShowNextHdr"!==t&&"CATWebUXSlideShowExitHdr"!==t?w.setActiveState(!1):e.ControllerID=f.id}}this.getID=function(){return f.id},this.setListOfCommandsAllowed=function(e){e&&e.length&&(E=e)},this.setActiveState=function(t){var i=0;if(m!==t)if(m=t)M("onActiveStateModified",{state:m,onBeginSlideShow:function(t){if(t){var i=g.getActionBar();C=i.options.context,a.empty(),s.empty(),U.left=function(){M("onPreviousSlideCB"),_()},p.left=e.createElement("div",{class:"CATWebUXSlideShowDiv",id:"CATWebUXSlideShowLeftArrowMainDiv"}).inject(P),o.addEvent(p.left,"onPrimaryPointerClick",U.left),y.left=e.createElement("div",{class:"CATWebUXSlideShowMainDiv"}).inject(p.left),y.left.setStyles({background:'url("'+n.getWebappsAssetUrl("CATWebUXSlideShow","textures/")+'I_PreviousSlideText.png")',backgroundSize:"contain",left:"30px"}),y.left.title=S.previousSlide,U.right=function(){M("onNextSlideCB"),_()},p.right=e.createElement("div",{class:"CATWebUXSlideShowDiv",id:"CATWebUXSlideShowRightArrowMainDiv"}).inject(P),o.addEvent(p.right,"onPrimaryPointerClick",U.right),y.right=e.createElement("div",{class:"CATWebUXSlideShowMainDiv"}).inject(p.right),y.right.setStyles({background:'url("'+n.getWebappsAssetUrl("CATWebUXSlideShow","textures/")+'I_NextSlideText.png")',backgroundSize:"contain",right:"30px"}),y.right.title=S.nextSlide,p.exitSlideShow=e.createElement("div",{class:"CATWebUXSlideShowDiv",id:"CATWebUXSlideShowExitDiv"}).inject(P),p.exitSlideShow.setStyles({background:'url("'+n.getWebappsAssetUrl("CATWebUXSlideShow","textures/")+'I_ExitSlideShowText.png")',backgroundSize:"contain"}),U.cross=function(){w.setActiveState(!1)},o.addEvent(p.exitSlideShow,"onPrimaryPointerClick",U.cross),p.exitSlideShow.title=S.exitSlideShow,document.addEventListener("keyup",I),o.addEvent(A.canvas,"onPrimaryPointerMoveUnique",_),o.addEvent(A.canvas,"onMouseMove",_),o.addEvent(A.canvas,"onPrimaryPointerClick",_),o.addEvent(A.divCssElement,"onPrimaryPointerMoveUnique",_),o.addEvent(A.divCssElement,"onMouseMove",_),o.addEvent(A.divCssElement,"onPrimaryPointerClick",_),o.addEvent(A.canvas,"onPrimaryPointerDownUnique",B),o.addEvent(A.canvas,"onPrimaryPointerUpUnique",N),_(),"displayed"===localStorage.getItem("CATWebUXSlideShowABPreferences")?i.open():i.close(),g.getContextualUIManager().register({subscriberId:"CATWebUXSlideShow",workbenchName:"CATWebUXSlideShowWkb",module:"CATWebUXSlideShow",context:C,cmdPrefix:"",merge:!0,fileName:"CATWebUXSlideShowWkb.xml",onContextualMenuReady:function(){return{cmdList:[{name:"CATWebUXSlideShowPreviousStr",line:1,hdr_list:["CATWebUXSlideShowPreviousHdr"]},{name:"CATWebUXSlideShowNextStr",line:1,hdr_list:["CATWebUXSlideShowNextHdr"]},{name:"CATWebUXSlideShowExitStr",line:1,hdr_list:["CATWebUXSlideShowExitHdr"]}]}}}),x.onActionBarOpen=i.onActionBarOpen(function(){localStorage.setItem("CATWebUXSlideShowABPreferences","displayed")}),x.onActionBarClose=i.onActionBarClose(function(){localStorage.setItem("CATWebUXSlideShowABPreferences","closed")}),T.cmds=c.onCommandStart(H,C),(W=window&&window.widget?window.widget.getView().type:null)&&"fullscreen"!==W&&window.widget.requestView({type:"fullscreen"}),k||A.get2DMode()||(A.currentViewpoint.control.setMouseRotationActive(!m),A.currentViewpoint.control.setTouchRotationActive(!m)),h={activated:A.picking.activated,trapSelection:A.picking.trapSelection},A.setPicking({activated:!1,trapSelection:!1});let t=c.getCommandCheckHeader("FlyWalkCmd",C);t&&(t.getState()&&(D=!0,t.setState(!1)),X=t.onStateChange(function(){D=!1,w.setActiveState(!1)}))}else m=!1,w.displaySlideInformation({type:"error",message:S.slideShowCannotBeLaunched,notificationType:"BasicNotification"}),M("onSlideShowAborted"),M("onActiveStateModified",{state:m})}});else{if(X){let e=c.getCommandCheckHeader("FlyWalkCmd",C);e&&(e._modelEvents.unsubscribe(X),D&&e.setState(!0))}D=!1,X=null,v&&(clearTimeout(v),v=0),p.left&&(o.removeEvent(p.left,"onPrimaryPointerClick",U.left),P.removeChild(p.left),p.left.destroy(),p.left=null),p.right&&(o.removeEvent(p.right,"onPrimaryPointerClick",U.right),P.removeChild(p.right),p.right.destroy(),p.right=null),p.exitSlideShow&&(o.removeEvent(p.exitSlideShow,"onPrimaryPointerClick",U.cross),P.removeChild(p.exitSlideShow),p.exitSlideShow.destroy(),p.exitSlideShow=null),document.removeEventListener("keyup",I),o.removeEvent(A.canvas,"onPrimaryPointerMoveUnique",_),o.removeEvent(A.canvas,"onMouseMove",_),o.removeEvent(A.canvas,"onPrimaryPointerClick",_),o.removeEvent(A.divCssElement,"onPrimaryPointerMoveUnique",_),o.removeEvent(A.divCssElement,"onMouseMove",_),o.removeEvent(A.divCssElement,"onPrimaryPointerClick",_),o.removeEvent(A.canvas,"onPrimaryPointerDownUnique",B),o.removeEvent(A.canvas,"onPrimaryPointerUpUnique",N),g.getContextualUIManager().unregister("CATWebUXSlideShow"),T.cmds&&r.unsubscribe(T.cmds),W&&"noViewRequested"!==W&&window.widget.requestView({type:W});var l=Object.keys(x),d=g.getActionBar();for(i=0;i<l.length;i++)d.removeCallback(x[l[i]]);d.open(),u&&u.destroy();var f=c._commands._cmdContext;if(f){["CATWebUXSlideShowPreviousHdr","CATWebUXSlideShowNextHdr","CATWebUXSlideShowExitHdr"].forEach(function(e){f[e]&&(f[e]._destroy&&f[e]._destroy(),delete f[e])})}W="windowed",v=u=null,y={},p={},U={},x={},T={},k||A.get2DMode()||(A.currentViewpoint.control.setMouseRotationActive(!m),A.currentViewpoint.control.setTouchRotationActive(!m)),h&&A.setPicking(h),h=null,M("onActiveStateModified",{state:m})}},this.getActiveState=function(){return m},this.subscribe=function(e,t){return e&&t?b.subscribe({event:e},t):void 0},this.unsubscribe=function(e){b&&e&&b.unsubscribe(e)},this.displaySlideInformation=function(e){u||(u=new i),u.build({notificationType:e.notificationType||"CustomNotification",body:P,frmWindow:g,duration:2e3,message:e.message?e.message:e.primary,secondary:e.secondary,hidden:e.hidden,icon:e.icon,fontIcon:e.fontIcon})},this.activatePreviousSlide=function(){M("onPreviousSlideCB")},this.activateNextSlide=function(){M("onNextSlideCB")},this.clearController=function(){this.setActiveState(!1),u&&u.destroy(),g=u=b=P=null}}}),v=[];return t.singleton({init:function(){},giveSlideShowController:function(e){var t;if(e&&e.context&&e.id)for(var i=0;i<v.length;i++)v[i].context===e.context&&v[i].id===e.id&&(t=v[i].controller);return t},getSlideShowController:function(e){var t;if(e&&e.context&&e.id){if(t=this.giveSlideShowController(e))return t;var i=new u(e);t=Object.freeze({getID:function(){if(i)return i.getID()},setActiveState:function(e){i&&i.setActiveState(e)},getActiveState:function(){return i?i.getActiveState():null},setListOfCommandsAllowed:function(e){i&&i.setListOfCommandsAllowed(e)},displaySlideInformation:function(e){i&&i.displaySlideInformation(e)},clearController:function(){i&&(i.clearController(),i=null)},activateNextSlide:function(){i&&i.activateNextSlide()},activatePreviousSlide:function(){i&&i.activatePreviousSlide()},subscribe:function(e,t){return i?i.subscribe(e,t):null},unsubscribe:function(e){i&&i.unsubscribe(e)}}),v.push({context:e.context,controller:t,id:e.id})}return t},unreferenceSlideShowController:function(e){if(e&&e.context&&e.id)for(var t=0;t<v.length;t++)if(v[t].context===e.context&&v[t].id===e.id){v[t].controller.clearController(),v.splice(t,1);break}}})}),define("DS/CATWebUXSlideShow/CATWebUXSlideShowCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/CATWebUXSlideShow/CATWebUXSlideShowController"],function(e,t){"use strict";return e.extend({init:function(e){this._parent(e,{});for(var i=this,n="",o=0;o<e.arguments.length;o++)"ControllerID"===e.arguments[o].ID&&(n=e.arguments[o].Value);var r=this.onStateChange(function(){var e=t.giveSlideShowController({context:i.getFrameWindow(),id:n});if(e&&e.getActiveState()!==i.getState()){var o=e.subscribe("onActiveStateModified",function(t){setTimeout(function(){!t.state&&i.getState()&&(e.unsubscribe(o),i.setState(!1))})}),r=e.subscribe("onSlideShowAborted",function(){setTimeout(function(){i.getState()&&(e.unsubscribe(r),i.setState(!1))})});e.setActiveState(i.getState()),i.getState()&&require(["DS/CATWebUXComponents/CATWebUXUtils"],function(e){e._sendUsageProbe("command","PresentationMode")})}}),l=this._destroy;this._destroy=function(){i._modelEvents.unsubscribe(r),l.call(i)}},_destroy:function(){this._parent()}})}),define("DS/CATWebUXSlideShow/CATWebUXSlideShowNavigationCmd",["DS/ApplicationFrame/Command","DS/CATWebUXSlideShow/CATWebUXSlideShowController"],function(e,t){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0})},beginExecute:function(){var e=t.giveSlideShowController({context:this.getFrameWindow(),id:this.ControllerID});if(e)switch(this.options.ID){case"CATWebUXSlideShowPreviousHdr":e.activatePreviousSlide();break;case"CATWebUXSlideShowNextHdr":e.activateNextSlide();break;case"CATWebUXSlideShowExitHdr":e.setActiveState(!1)}this.end()}})});