define("DS/NewBranchWidget/NewBranchWidget",["UWA/Controls/Abstract","DS/ENO6WPlugins/jQuery","DS/LifecycleServices/LifecycleCommandManager","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleServicesSettings","DS/LifecycleControls/CredentialList","DS/LifecycleControls/DelayedMask","DS/LifecycleServices/DefaultCredential","DS/LifecycleServices/HTMLTemplating","DS/WAFData/WAFData","DS/WebToWinInfra/WebToWinCom","DS/WebInWinHelper/WebInWinHelper","DS/UIKIT/Input/Button","DS/Controls/ComboBox","DS/Controls/Editor","DS/Controls/LineEditor","DS/LifecycleControls/CommandDialog","DS/LifecycleControls/DataGridViewContainer","DS/LifecycleControls/InputValidation","DS/LifecycleCmd/MessageMediator","DS/WidgetServices/WidgetServices","DS/LifecycleServices/NewBranchObjectProp","DS/LifecycleServices/LifecycleAlert","DS/ErrorWidget/ErrorWidget","DS/Windows/ImmersiveFrame","DS/DuplicateWidget/AdvancedDuplicateTree","DS/DuplicateWidget/ExpandReqBuilder","DS/DuplicateWidget/expandTree/expand","css!DS/NewBranchWidget/NewBranchWidget","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","i18n!DS/NewBranchWidget/assets/nls/NewBranchWidgetNls","i18n!DS/LifecycleServices/assets/nls/LifecycleServicesNls","i18n!DS/WidgetServicesUI/assets/nls/i18nWidgetService"],function(e,t,i,n,s,o,a,r,l,c,d,h,u,p,m,f,g,v,_,b,y,w,S,C,A,E,L,D,P,I,j,W,x){"use strict";return e.extend({init:function(e,t,n){this.odtmode=!1,this.wintop=!1,this.auto_execute=!1,this.force_multiple_selection_ui=!1,this.without_cred=!1,this.dup_string="",this.selectionList=[],this.objectsList=[],this.intentsList=[],this.isThereLinearData=!1,this.nbDisplayedObjects=0,this.context={},this.tenant=null,this.folderId=null,this.wintop_ChangeActionId=null,this.initBL_already_called=!1,this.objectsListTable=null,this.objectProp=null,this.intentsListSel=null,this.dupStringDiv=null,this.dupStringInput=null,this.commentInput=null,this._parent(n),this.commandManager=new i,this.content=UWA.createElement("div",{class:"newbranch_content dlg_cmd_content"}),this.container=UWA.createElement("div",{class:"newbranch_container"}),this.content.inject(this.container),this.useAdvancedBranch=!1,this.roots=[],this.providerIdSet=new Set,n&&n.odtmode&&(this.odtmode=!0),n&&n.without_cred&&(this.without_cred=!0),n&&n.wintop&&(this.wintop=!0,this.without_cred=!0,h.initTenant(this),h.getServices(this),this.webToWinCom_Socket=d.createSocket({socket_id:"WebInWin_NewBranchWidget_Socket_"+Math.floor(1e5*Math.random()+1)}),void 0!==this.options.serverUrl&&this.options.serverUrl.length>0&&(void 0!==this.options.serverUrl[0].platformId&&(this.tenant=this.options.serverUrl[0].platformId),s.setTenant(this.tenant)),n.hasOwnProperty("ChangeActionId")&&(this.wintop_ChangeActionId=n.ChangeActionId),n.hasOwnProperty("ENOVIA_ForceNewBranchMultiple")&&"TRUE"===n.ENOVIA_ForceNewBranchMultiple&&(this.force_multiple_selection_ui=!0),n&&n.auto_execute&&"TRUE"===n.auto_execute&&(this.auto_execute=!0),n.hasOwnProperty("dup_string")&&(this.dup_string=n.dup_string),this.footerDiv=UWA.createElement("div",{class:"newbranch_footer modal-footer"}),this.footerDiv.inject(this.container),this.container.addClassName("column_flex_container"),this.container.addClassName("webinwin_lc_command_dialog"))},initDatafromWin:function(e){var t=[];e.forEach(function(e){var i=e.physicalId,n=e.name,s={physicalid:i,name:n,displayName:n};t.push(s)}),console.log("initDatafromWin / selection size: "+e.length),console.log("initDatafromWin / tenant: "+this.tenant),this.executeCmd(t)},onRefresh:function(){console.log("onRefresh called from win")},onResize:function(){console.log("onResize called from win")},_CloseWebInWinPanel:function(){this.wintop&&this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"ClosePanel",notif_parameters:"ClosePanel"},"lf_web_in_win")},_setWaitingResponse:function(){void 0!==this.widget&&null!==this.widget?this.widget.body.style.cursor="wait":document.body.style.cursor="wait"},_setEndWaitingResponse:function(){void 0!==this.widget&&null!==this.widget?this.widget.body.style.cursor="default":document.body.style.cursor="default"},_onComplete:function(){},_onCompleteWithoutClose:function(){},_onOk:function(){},_onCancel:function(){},_getUniqueListBy:function(e,t){return[...new Map(e.map(e=>[e[t],e])).values()]},_isMIB:function(e){return!!e&&(!(!e.physicalid||!e.physicalid.startsWith("cid:"))||!(!e.module&&!e.contenturl))},_displayAsMultiSelPanel:function(){return this.nbDisplayedObjects>1||this.force_multiple_selection_ui},_WafDataPromise:function(e,t,i){var o=i||this._securityContext;return new Promise((i,a)=>{var r=s.get3DSpaceWSUrl(this.tenant,e,null);c.authenticatedRequest(r,{method:"POST",type:"json",headers:s.getHeaders(o),timeout:6e5,data:JSON.stringify(t),onComplete:function(e){i(e)},onFailure:function(e,t){console.log("PREPARE BRANCH Failure..."+e),a(n.parseWebServiceError(e,t))},ontimeout:function(){console.log("PREPARE BRANCH A connection timeout occured."),a(I.timeout)}})})},_NewBranchWafDataPromise:function(e,t,i){return new Promise((n,s)=>{this._WafDataPromise("/resources/lifecycle/newbranch/"+e,t,i).then(e=>{if("failure"===e.status&&e.hasOwnProperty("report")){var t=e.report;t.length>0&&t[0].hasOwnProperty("message")?s(t[0].message):s()}else n(e)}).catch(e=>{console.log("PREPARE BRANCH Failure..."+object),s(e)})})},executeCmd:function(e,t,i){null==t&&(t={}),null==i&&(i=function(){});var n=this;this._onComplete=function(){i(),this.wintop&&this._CloseWebInWinPanel()},this._onCompleteWithoutClose=function(){i()},t.hasOwnProperty("context")&&(this.context=t.context),console.log("executeCmd / tenant: "+this.tenant);try{if(0===(e=this._getUniqueListBy(e,"physicalid")).length)throw I.noObject;e.forEach(function(e){if(!(e.objectId||e.physicalid))throw I.epmtyPhysicalId;null===n.tenant&&(console.log("executeCmd / setting tenant from selection: "+e.tenant),n.tenant=e.tenant,n.commandManager.setTenant(n.tenant))}),this.selectionList=e}catch(e){throw console.log("executeCmd / "+e),e}this.folderId=t.targetFolderId;try{if(void 0!==s.getActiveFolder){var a=s.getActiveFolder();void 0!==a.id&&null!==a.id&&""!==a.id&&(this.folderId=a.id,require(["DS/PlatformAPI/PlatformAPI"],function(e){e.publish("FolderEditor.ActiveFolderCallBack",{id:a.id,label:a.label})}))}}catch(e){this.folderId=t.targetFolderId}var l=r.loadDefaultContexCredential({tenant:this.tenant,context:this.context}),c=new Promise((e,t)=>{o.loadCredentials(n.tenant).then(t=>{o.filterCredentials(n.tenant,t,"branch").then(i=>{if(i.length>0){let n=i.map(e=>{let i=t.filter(t=>t.ctx===e);return{displayName:i?i[0].displayName:e,ctx:e}});n=n.sort((e,t)=>e.displayName.localeCompare(t.displayName,void 0,{numeric:!0,sensitivity:"base"})),e(n)}else e([])}).catch(t=>{console.error("Failed to call credential filter svc, error:",t),e()})})});UWA.Promise.all([l,c]).then(([e,t])=>{n._securityContext=e||"",console.log("executeCmd / security context: "+n._securityContext),UWA.is(t,"array")?n._userCredentials=t:(n._userCredentials=[],console.error("Missing credentials"),n.showError(j.errCredFilterSvc)),n._verifyAndSetObjects()}).catch(e=>{throw console.log("executeCmd / "+e),e})},executeOk:function(){this._onOk()},cancel:function(){this._onCancel()},_verifyAndSetObjects:function(){var e=this;console.log("before PREPARE BRANCH"),this._setWaitingResponse(),this._NewBranchWafDataPromise("prepare_newbranch_completesel",{data:e.selectionList}).then(t=>{var i=t.results;if(!Array.isArray(i)||0===i.length)throw I.objectNotFound;if(e.nbDisplayedObjects=0,i.forEach(function(t){if(!(t.objectId||t.physicalid))throw I.epmtyPhysicalId;1==t.visible&&e.nbDisplayedObjects++}),e.nbDisplayedObjects<=0)throw I.objectNotFound;e.objectsList=i,this._computeRoots(),e.objectsList.forEach(t=>{t.isRoot&&e.roots.push(t.physicalid)}),e.roots.length<1&&e.selectionList.forEach(function(t){e.roots.push(t.physicalid)})}).then(()=>{var t=[];return e.objectsList.forEach(function(e){var i=e.objectId||e.physicalid;t.push(i)}),console.log("executeCmd / pids size: "+t.length),Promise.all([n.getAllowedSemanticsPromise(t,e.context,{nlsintents:!0}),this._NewBranchWafDataPromise("prepare_newbranch_checkavailability",{data:e.objectsList})])}).then(([t,i])=>{if(console.log("executeCmd / getAllowedSemanticsPromise done"),n.isBaselineMode(void 0,t)&&"ConfiguredBaseline"!==e.selectionList[0].type){if(e.selectionList.length>1)throw e._setEndWaitingResponse(),I.multipleSelectionObjectsNotSupported;e._setEndWaitingResponse(),require(["DS/HistoryExplorer/HistoryDialog"],function(i){(new i).executeCmd(e.selectionList,{getAllowedSemanticsResponse:t,context:e.context,name:"history_command"},()=>{e._onComplete()})})}else{var s=t.allowedSemantics;if(!Array.isArray(s)||0==s.length)throw I.objectNotFound;var o=["PS","S","F","D"];s.forEach(e=>{if(!Array.isArray(e.semantic))throw I.objectNotFound;var t=[];o.forEach(i=>{e.semantic.includes(i)&&t.push(i)}),o=t});var a=t.intents;if(!Array.isArray(a)||0==a.length)throw I.objectNotFound;var r=new Map;a.forEach(e=>{r.set(e.short,e)});var l=[];o.forEach(e=>{var t=r.get(e);t&&l.push({operation:t.id,nls:t.title})}),e.intentsList=l;var c=new Map;s.forEach(e=>{c.set(e.id,e)});var d=i.results;if(!Array.isArray(d)||0==d.length)throw I.objectNotFound;e.isThereLinearData=!1;var h=!0;if(d.forEach(t=>{var i=t.objectId||t.physicalid;if(!i)throw I.epmtyPhysicalId;var n=c.get(i);if(!n)throw I.objectNotFound;var s=n.semantic;Array.isArray(s)&&(t.availableSemantic=s);var o=n.mode;t.nlvCompatible=!0,Array.isArray(o)&&o.includes("linear")&&(t.nlvCompatible=!1,e.isThereLinearData=!0),t.nlvCompatible||"Yes"===t.EvolutionAvailability||(console.log("type "+t.type+" is not valid for New Branch"),h=!1)}),!h)throw 1==d.length?I.evolutionAvailabilityFalseMonoSelection:I.evolutionAvailabilityFalseMultiSelection;e.objectsList=d,e._prepareDataForDisplay()}}).catch(t=>{e._setEndWaitingResponse(),console.log("executeCmd / prepare new branch error "+t),e.showError(t),e._onComplete()})},_prepareDataForDisplay:function(){var e=this;s.get3DSpaceBaseUrl(this.tenant);this._NewBranchWafDataPromise("prepare_attributeslist",{data:this.objectsList,attributes:["type","current","branch.current","name","attribute[PLMEntity.V_Name]","Title","attribute[Title]","attribute[PLMReference.V_versionComment]","branch.description","type.kindof[PLMReference]","imageUrl"]}).then(e=>{var t=e.results;if(!Array.isArray(t)||0===t.length)throw I.objectNotFound;return t.forEach(function(e){e.hasOwnProperty("attribute[PLMEntity.V_Name]")&&!e["attribute[PLMEntity.V_Name]"]&&delete e["attribute[PLMEntity.V_Name]"],e.hasOwnProperty("Title")&&!e.Title&&delete e.Title,e.hasOwnProperty("attribute[Title]")&&!e["attribute[Title]"]&&delete e["attribute[Title]"]}),this.objectsList=t,this._displayAsMultiSelPanel()||this._isMIB(this.objectsList[0])?void 0:(this.initBL_already_called=!0,this._WafDataPromise("/resources/lifecycle/duplicate/initialize_objects",{data:this.objectsList,operationDetail:"NewEvolution"}))}).then(e=>{var t=new Map;e&&Array.isArray(e.results)&&e.results.forEach(e=>{e.objectId&&Array.isArray(e.attrs)&&e.attrs.length>0&&t.set(e.objectId,e.attrs)}),this.objectsList.forEach(e=>{var i=e.objectId||e.physicalid,n=t.get(i);Array.isArray(n)&&n.length>0&&(e.modifiedAttributes||(e.modifiedAttributes={}),n.forEach(t=>{t.name&&t.value&&(e.modifiedAttributes[t.name]=t.value)}))});var i=[];return this.objectsList.forEach(function(e){var t=e.objectId||e.physicalid;i.push(t)}),this._displayAsMultiSelPanel()?void 0:n.getVersionNumberProposalPromise(i,this.intentsList.length>0?this.intentsList[0].operation:"",null,this.context)}).then(e=>{var t=new Map;return e&&Array.isArray(e.addRequests)&&e.addRequests.forEach(e=>{t.set(e.copyId,e.code)}),this.objectsList.forEach(e=>{var i=e.objectId||e.physicalid,n=t.get(i);n&&(e.proposedRevision=n)}),this._displayAsMultiSelPanel()?{results:this.objectsList}:this._NewBranchWafDataPromise("prepare_newbranch_maskattributes",{data:this.objectsList})}).then(t=>{var i=t.results;if(!Array.isArray(i)||0===i.length)throw I.objectNotFound;if(e.objectsList=i,i.some(t=>e._isMIB(t))||e.wintop)return t;var n=[];return e.roots.forEach(function(e){n.push({physicalid:e})}),this._WafDataPromise("/resources/lifecycle/duplicate/capabilites",{data:n,enableProto:!0,command:"branch"})}).then(t=>{t.providers&&(e.providerIdSet=new Set([].concat(...t.providers.filter(e=>e.capabilities.find(e=>"84a058e4-4e05-4fc3-8c2f-ed137631d5ae"==e.id)).map(e=>e.objectIds)))),e._setEndWaitingResponse(),console.log("PREPARE BRANCH finished"),e._showCommandUI()}).catch(e=>{this._setEndWaitingResponse(),console.log("PREPARE BRANCH Failure..."+e),e&&this.showError(e),this._onComplete()})},_computeRoots:function(){var e=this.objectsList,t=this,i=[],n=[],s=!1;if(!this.wintop&&this.context&&"function"==typeof this.context.getSelectedNodes){var o=this.context.getSelectedNodes(),a=function(e){if("function"!=typeof e.getID)return!1;var t=!1;return o.forEach(function(i){"function"==typeof i.getID&&e.getID()==i.getID()&&(t=!0)}),t},r=function(e){if(null==e||null==e)return e;if("function"!=typeof e.getParent)return e;if(n.hasOwnProperty(e.getID()))return n[e.getID()];var t=e.getParent();if(null==t||null==t||"function"!=typeof t.getID)return n[e.getID()]=e,e;if(a(t)){var i=r(t);return n[e.getID()]=i,i}return n[e.getID()]=e,e};s=!0,e.length<=1&&(s=!1),0==o.length&&(s=!1),o.forEach(function(t){if(s)if(null!=t&&null!=t)if("function"==typeof t.getID){var o=t.getID(),l=!1;if(e.forEach(function(e){o==e.physicalid&&(l=!0)}),l){!function(e){if(null==e||null==e)return!1;if("function"!=typeof e.getParent)return!0;var t=e.getParent();return!a(t)}(t)?i[t.getID()]=!1:i[t.getID()]=!0;var c=r(t);n[t.getID()]=c}else s=!1}else s=!1;else s=!1})}e.forEach(function(e){if(s)e.physicalid&&!0===i[e.physicalid]?e.isRoot=!0:e.isRoot=!1,e.physicalid&&n[e.physicalid]&&(e.rootid=n[e.physicalid].getID()),e.parentid&&n[e.parentid]&&(e.rootid=n[e.parentid].getID());else if(e.physicalid){var o=!1;t.selectionList.forEach(function(t){e.physicalid==t.physicalid&&(o=!0)}),o&&!e.parentid?e.isRoot=!0:e.isRoot=!1}else e.isRoot=!1})},_showCommandUI:function(){var e=this,t=this.content,i="";if(this._displayAsMultiSelPanel())this.objectsList.forEach(e=>{e["attribute[PLMEntity.V_Name]"]&&(e.name=e["attribute[PLMEntity.V_Name]"]),e["attribute[Title]"]&&(e.name=e["attribute[Title]"]),e.Title&&(e.name=e.Title)}),this.content.classList.add("css_grid_container"),this.dgvContainer=new v({idName:"dgvContainer",clickToShowDGV:!1},e.objectsList),this.dgvContainer.inject(t,"top"),i=" - "+this.nbDisplayedObjects+" "+I.multipleSelectionObjects,this.container&&this.container.addClassName("multiSel");else{var n=!1;this.objectsList.forEach(t=>{var i=this._isMIB(t),s="",o="",a="",r=!0;t["attribute[PLMEntity.V_Name]"]&&(s="attribute[PLMEntity.V_Name]"),t["attribute[PLMEntity.V_Name]"]&&(o="PLMEntity.V_Name"),t["attribute[PLMEntity.V_Name]"]&&(a=t["attribute[PLMEntity.V_Name]"]),t.Title&&(s="Title"),t.Title&&(o="Title"),t.Title&&(a=t.Title),t.computedLabel&&t.computedLabel.selectable&&(s=t.computedLabel.selectable),t.computedLabel&&t.computedLabel.path&&(o=t.computedLabel.path),t.computedLabel&&t.computedLabel.value&&t.computedLabel.value.length>=1&&(a=t.computedLabel.value[0]);var l=[];if(t.hasOwnProperty("attributes_mask")&&(l=t.attributes_mask),l.forEach(function(e){e.selectable==s&&!0===e.readOnly&&(r=!1)}),!i&&s&&(n=!0),console.log("showTitle: "+n),n&&(console.log("title selectable: "+s),console.log("title path: "+o),console.log("title value: "+a),console.log("title editable: "+r)),t.modifiedAttributes||(t.modifiedAttributes={}),t.volatileAttributes||(t.volatileAttributes={}),n&&r&&o&&!t.modifiedAttributes.hasOwnProperty(o)&&e.dup_string&&(t.modifiedAttributes[o]=e.dup_string+a),t.hasOwnProperty("attributes_mask")||(t.attributes_mask=[]),"TRUE"!==t["type.kindof[PLMReference]"]||i||t.attributes_mask.push({selectable:"attribute[PLMReference.V_versionComment]",path:"PLMReference.V_versionComment",readOnly:!1,maxlength:256,multiline:!0,nls:W.LifecycleObjectList_versionComment}),i&&t.attributes_mask.push({selectable:"description",path:"description",readOnly:!1,maxlength:256,multiline:!0,nls:W.LifecycleObjectList_versionComment}),!e.without_cred){var c=["noCredentials"],d=[j.noCredentials];e._userCredentials&&e._userCredentials.length>0&&(c=e._userCredentials.map(e=>e.ctx),d=e._userCredentials.map(e=>e.displayName));var h=c[0];c.indexOf(e._securityContext)>=0&&(h=e._securityContext),t.attributes_mask.push({selectable:"credentials",path:"credentials",readOnly:!1,value:h,nls:j.credentials,authorizedValues:c,authorizedValuesNLS:d,onAttributeValueChanged:function(){e._onCredentialSeletionChangedMonoSel()},volatile:!0}),t.volatileAttributes.credentials=h}});var s={className:"newbranch_prop is-mobile simpbranch-option",data_rec_id:"newbranch_prop_rec-id",showTitle:n,showProposedRevision:!0,editable:!0};if(this.objectProp=new w(s),this.objectProp.inject(t),!this.wintop&&this.intentsList.length<=1&&this.providerIdSet.size>0){let i=new UWA.createElement("div",{id:"advbranch-content",class:"advanced-content"});i.setStyle("height","100%"),i.setStyle("display","none"),i.inject(t);let n=new UWA.createElement("div",{text:j.NewBranchAdvanced,id:"expander",class:"advbranch-expander"});n.addEventListener("click",function(){e.useAdvancedBranch=!0,e._openAdvancedBranchTree()}),n.inject(t)}if(this.objectProp.setObject(this.objectsList[0],this.intentsList.length>1||!this.isThereLinearData?this.intentsList:null,null),this.objectProp.addEvent("onAttributeValidationError",e=>{e.forEach(e=>{this.showNotificationInDialog(e)})}),this.objectProp.addEvent("onIntentChanged",function(){e._onItentSeletionChangedMonoSel()}),Array.isArray(this.selectionList)&&this.selectionList.length&&this.selectionList[0].name){let e=this.selectionList[0].revision?" "+this.selectionList[0].revision:"";i=" - "+this.selectionList[0].name+e}}var o=!0,a=!1,r=!1;this.objectsList.forEach(e=>{e.physicalid&&!e.physicalid.startsWith("cid:")&&(o=!1),e.physicalid&&e.physicalid.startsWith("cid:")&&(a=!0),(e.module||e.contenturl)&&(a=!0),"TRUE"===e["type.kindof[PLMReference]"]&&(r=!0)});var c=!1;if(this._displayAsMultiSelPanel()&&(r||a)){UWA.createElement("div",{class:"comment_label simpbranch-option",text:W.LifecycleObjectList_versionComment}).inject(t),this.commentInput=(t=>{let i=new m({placeholder:x["Enter a text"],widthInCharNumber:45,newLineMode:"enter"});return i.addEventListener("change",function(){t.forEach(function(e){e.modifiedAttributes||(e.modifiedAttributes={}),e.modifiedAttributes["PLMReference.V_versionComment"]=i.value}),i.getContent().setAttribute("title",i.value)}),i.addEventListener("uncommittedChange",function(){i.getContent().setAttribute("title",i.valueToCommit);var t=e._checkVersionCommentValue(i.valueToCommit);t&&e.showNotificationInDialog(t)}),i.getContent().addClassName("comment_input simpbranch-option"),i})(e.objectsList),this.commentInput.inject(t),c=!0}var d=!1;if(this._displayAsMultiSelPanel()&&this.isThereLinearData&&!o){new UWA.Element("text",{text:j.Prefix,class:"newbranch_dupstring_title simpbranch-option"}).inject(t);var h=UWA.createElement("div",{class:"newbranch_dupstring_input simpbranch-option"});h.inject(t),this.dupStringInput=new f({class:"newbranch_dupstring_input_ed"}),this.dupStringInput.inject(h),""!==this.dup_string&&(this.dupStringInput.value=this.dup_string),d=!0}var _=!1;if(this._displayAsMultiSelPanel()&&(this.intentsList.length>1||!this.isThereLinearData)){new UWA.Element("div",{class:"newbranch_intentslist_text",text:j.IntentSelection}).inject(t);var y=[];this.intentsList.forEach(function(e){y.push({labelItem:e.nls,valueItem:e.operation})}),this.intentsListSel=new p({elementsList:y,selectedIndex:0,enableSearchFlag:!1}),this.intentsListSel.inject(t),this.intentsListSel.addEventListener("change",function(){e.dispatchEvent("onIntentChangedForODT")}),_=!0}if(this.wintop){var S=new u({value:j.BtnOK,name:"NewBranchButtonOk",className:"default medium primary"}),A=new u({value:j.BtnCancel,name:"NewBracnButtonCancel",className:"default medium"});S.inject(this.footerDiv),A.inject(this.footerDiv),this._onOkPromise=function(){return new Promise(t=>{var i=e._checkBeforeExecute();null!=i&&i.length>0&&(e.showNotificationInDialog(i[0]),t()),S.setDisabled(),A.setDisabled(),this._setWaitingResponse(),e._executeNewBranch().then(i=>{i.messageToDisplay=I.newBranchSuccessfulWin,e._setEndWaitingResponse(),t(i)},i=>{e._setEndWaitingResponse(),t(i)})})},this._onOkPromiseFromWin=function(){return new Promise(e=>{this._onOkPromise().then(t=>{var i=JSON.stringify(t);e(i),this._onCompleteWithoutClose()})})},this._onOk=function(){S.setDisabled(),A.setDisabled(),e.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"dispatchWinAction",notif_parameters:{action:"WebToWinAction_OnOKButton",data:{ExecuteSync:"_onOkPromiseFromWin",timeout:1e6}}},"lf_web_in_win")},this._onCancel=function(){S.setDisabled(),A.setDisabled(),e._onComplete()},S.addEvents({onClick:function(){e._onOk()}}),A.addEvents({onClick:function(){e._onCancel()}}),setTimeout(()=>{t.style.minHeight="127px";let i=t.querySelector(".EditProp_MainContain");i&&(i.style.minHeight=""),this.auto_execute?(console.log("launching automatically execution of the command"),S.dispatchEvent("onClick")):e.dispatchEvent("onReady")},10)}else{var E=new g;this._onOk=function(){if(!this.useAdvancedBranch){var t=e._checkBeforeExecute();if(null!=t&&t.length>0)return e.showNotificationInDialog(t[0]),E._okButton&&E._okButton.setDisabled(!1),E._cancelButton&&E._cancelButton.setDisabled(!1),void(E._closeButton&&(E._closeButton.disabled=!1))}this._setWaitingResponse(),e._executeNewBranch().then(t=>{b.dispatchEvent("onModification",t),e._setEndWaitingResponse(),e._onComplete(),E.destroy()},()=>{e._setEndWaitingResponse(),e._onComplete(),E.destroy()})},this._onCancel=function(){e._onComplete(),E.destroy()};var L=E.create(t,{title:j.CommandDialogTitle+i,OKBtnText:j.BtnOK,closeButton:!0,resizable:!0,powerMaximize:!0,imageUrl:this.selectionList[0].imageUrl||"",onOk:function(){e._onOk()},onClose:function(){e._onCancel()}});this.dialog=L,this.commandDialog=E,this.commandDialog.addEvent("widget-maxmized-changed",function(t){t&&e.useAdvancedBranch&&e.commandDialog.maximize(!0)}),this.commandDialog&&this.commandDialog.setPowermaximizeVisibility(!1),this._displayAsMultiSelPanel()&&L.elements.container.addClassName("multiSel"),this.without_cred||this._userCredentials&&0!=this._userCredentials.length||E._okButton&&E._okButton.setDisabled(),L.inject(widget.body);var D=L.getContent();D||(D=widget.body),this.errorOverlay=new C(this,D,{className:"newbranch_errorManager"});var P=this._displayAsMultiSelPanel(),N=0;l.isTouchMode()&&(N+=P?70:40);var B=P?600:530,R=300+(c?41:0)+(d?29:0)+(_?29:0)+24*(this.nbDisplayedObjects-2)+N;!P&&this.objectProp&&(R=this.objectProp.getComputedMinHeight()+110+28+N);var T=R;L.setNewSize({width:B,height:R}),setTimeout(()=>{let i=t.querySelector(".EditProp_MainContain");if(i&&(i.style.minHeight=""),L.setMinSize(530,T),!this.without_cred&&this._displayAsMultiSelPanel()&&(this.credCombo=this._createCredentialSelector({widget:this,dialog:L,isMultisel:!0}),this.intentsList.length<=1&&!this.objectsList.some(t=>e._isMIB(t)))){let i=new UWA.createElement("div",{id:"advbranch-content",class:"advanced-content"});i.setStyle("height","100%"),i.setStyle("display","none"),i.inject(t);let n=new UWA.createElement("div",{text:j.NewBranchAdvanced,class:"advbranch-expander advanced_multisel",id:"expander"});n.addEventListener("click",function(){e.useAdvancedBranch=!0,e._openAdvancedBranchTree()}),n.inject(t)}e.dispatchEvent("onReady")},10)}},_checkTitleValue:function(){var e=this.objectsList.map(e=>e.name).reduce(function(e,t){return e.length>t.length?e:t});if((this.dupStringInput._myInput.value+e).length>100){var t=require("i18n!DS/EditPropWidget/assets/nls/langEditProp"),i="Title error";return t&&(i=t.replace(t.get("MaxLengthAttribute"),{label:W.LifecycleObjectList_title,value:100})),{code:"ERROR",eventID:"warning",message:i}}return null},_openAdvancedBranchTree:function(){var e=this,i=UWA.extendElement(this.content.querySelector("#advbranch-content"));this.immersiveFrame=this.immersiveFrame||this._createImmersiveFrame(i);var n=UWA.extendElement(this.content.querySelector(".immersive-frame-parent"));this.treeInputValidation&&this.treeInputValidation.inputValidator.updateValidation(),this.treeInputValidation=this.treeInputValidation||this._createTreeInputValidator(this.dialog),this.expandReqBuilder=this.expandReqBuilder||new L(this.context,"branch"),this._delayedMask||(this._delayedMask=new a(n,1e3,j.loadingText)),this.advBranchTreeLoader=this.advBranchTreeLoader||new D({roots:this.roots,securityContext:this._securityContext,tenant:this.tenant,providerIdSet:this.providerIdSet,objectsList:this.objectsList,expandReqBuilder:this.expandReqBuilder,getAuthoringMode:this._getAuthoringMode.bind(this)}),this.advancedBranchTree=this.advancedBranchTree||this._createAdvancedBranchTree(i);var s=UWA.extendElement(e.content.querySelector("#collapser"));s||((s=new UWA.createElement("div",{text:j.NewBranchBasic,id:"collapser",class:"advbranch-expander"})).setStyle("display","none"),s.addEventListener("click",function(){e.useAdvancedBranch=!1,e._closeAdvancedBranchTree(e.dialog)}),s.inject(i)),this.dialog.elements.container.classList.add("advanced-mode"),t(this.dialog.elements.container).find(".simpbranch-option").slideUp(150),t(this.dialog.elements.container).find("#dgvContainer").slideUp(150);var o=UWA.extendElement(e.content.querySelector("#expander"));i.setStyle("display","block"),o.setStyle("display","none"),s.setStyle("display","block"),"function"==typeof this.dialog._handleWidgetResize&&this.dialog._handleWidgetResize(),this._adjustDialogSizeLarge(this.dialog),this.dialog.centerIt()},_closeAdvancedBranchTree:function(){this.dialog.elements.container.classList.remove("advanced-mode"),t(this.dialog.elements.container).find(".simpbranch-option").slideDown(150),t(this.dialog.elements.container).find("#dgvContainer").slideDown(150),UWA.extendElement(this.content.querySelector("#advbranch-content")).setStyle("display","none"),UWA.extendElement(this.content.querySelector("#expander")).setStyle("display","block"),this._adjustDialogSizeSmall(this.dialog),this.dialog.centerIt();var e=this.dialog.elements.footer.querySelector(".btn-primary");e&&(e.disabled=!1)},_createImmersiveFrame:function(e){if(this.immersiveFrame)return this.immersiveFrame;var t=new A({identifier:"4046f1f2-6823-11e9-a923-1681be663d3e"});t.dockingElements.forEach(function(e){e._properties.side.value===WUXDockAreaEnum.TopDockArea||e._properties.side.value==WUXDockAreaEnum.BottomDockArea?e._properties.dockingZoneSize.value=120:e._properties.side.value!==WUXDockAreaEnum.LeftDockArea&&e._properties.side.value!=WUXDockAreaEnum.RightDockArea||(e._properties.dockingZoneSize.value=230)});var i=UWA.createElement("div",{class:"immersive-frame-parent"});return i.inject(e),t.inject(i),t},_createAdvancedBranchTree:function(e){var t=this,i=new E({inputValidator:this.treeInputValidation,tenant:this.tenant,showError:this.showError.bind(this),identifier:"branch"});return i.addEvent("expandingStructure",function(e){var i=t.dialog.elements.footer.querySelector(".btn-primary");i&&(i.disabled=!0)}),i.loadUI({parentElement:e,immersiveFrame:this.immersiveFrame,securityContext:this._securityContext,treeLoader:this.advBranchTreeLoader}),i.addEvent("onTreeListCreated",function(e){t._delayedMask&&t._delayedMask.unmask(),i.treeList.onInitialUpdateView().then(function(){t.treeInputValidation.inputValidator.updateValidation(),t.dispatchEvent("AdvancedUICreated",i)}),i.translationService.translationFailure&&t.showNotification("Translation failed")}),i},_createTreeInputValidator:function(){var e={inputValidator:new _,validators:this._getInputValidators()};e.inputValidator.setCustomCSS({inputCSS:"tree-invalid-input",infoIconCSS:"tree-info-icon-invalid-input"}),e.haveIllegalChars=(()=>{});var t=this.dialog.getContainer?this.dialog.getContainer():this.dialog.elements?this.dialog.elements.container:null;return this.okBtn=t.querySelector(".btn-primary"),this.okBtn&&e.inputValidator.addSubmitElement(this.okBtn),e},_getInputValidators:function(){return[{name:"maxChars",validate:function(e){return e.length<=100},getErrorInfo:function(e){return j.branchTooLongTitle}}]},_getAuthoringMode:function(){if(this.context&&"function"==typeof this.context.isIndexMode)return UWA,Promise.resolve(!this.context.isIndexMode());var e=this;return new UWA.Class.Promise(function(t,i){widget&&n.isInPSEditorWidget(widget)?e._getPADSession().then(function(e){var i=!0;e&&(i=e.determineAuthoredFlag()),t(i)}):t(!0)})},_getPADSession:function(){return this.hasRequestedPADSession?UWA.Class.Promise.resolve(this.PADSession):this.getPADSessionPromise()},getPADSessionPromise:function(){var e=this;return new UWA.Class.Promise(function(t,i){require(["DS/PADUtils/PADSession"],function(i){e.hasRequestedPADSession=!0,e.PADSession=i,t(e.PADSession)},function(i){e.hasRequestedPADSession=!0,e.PADSession=null,t(e.PADSession)})})},_adjustDialogSizeLarge:function(e){if(!this.dialog.isMaximized){var t=this._loadSize("advBranchLarge"),i=this._getCurrentSize(e);this._storeSize("advBranchSmall",i),e.setNewSize(t?{width:t.width,height:t.height}:{width:2*i.width,height:480}),this.commandDialog&&this.commandDialog.isWidgetMaximized()&&this.commandDialog.maximize(!0)}},_adjustDialogSizeSmall:function(e){if(!this.dialog.isMaximized){var t=this._loadSize("advBranchSmall"),i=this._getCurrentSize(e);this._storeSize("advBranchLarge",i),e.setNewSize(i?{width:t.width,height:t.height}:{})}},_getCurrentSize:function(e){var t=e.getModalBodySize();return t.height=e.getContainerHeight(),t},_loadSize:function(e){var t=widget.getValue(e);return t?JSON.parse(t):null},_storeSize:function(e,t){widget.getValue(e)||widget.addPreference({name:e,type:"hidden",defaultValue:"{}"}),widget.setValue(e,JSON.stringify(t))},_getSelectedSecurityContext:function(){return this.credCombo?this.credCombo.value:this.objectsList.length>=1&&this.objectsList[0].volatileAttributes&&this.objectsList[0].volatileAttributes.credentials?this.objectsList[0].volatileAttributes.credentials:this.without_cred?this._securityContext:"noCredentials"},_createCredentialSelector:({widget:e,dialog:t,isMultisel:i})=>{var n=t.elements.footer.querySelector(".btn-primary");n&&(n.disabled=!0);let s=t.elements.body.querySelector(".newbranch_grid_container");s||(s=t.elements.body.querySelector(".newbranch_content"));let o=UWA.createElement("div",{class:"newbranch_credsel_container is-mobile"});i||o.addClassName("newbranch_single_sel"),UWA.createElement("div",{class:"newbranch_credsel_label simpbranch-option",text:j.credentials}).inject(s);let a=new p({elementsList:[j.loadingText],enableSearchFlag:void 0,actionOnClickFlag:void 0,displayStyle:void 0});a.getContent().addClassName("newbranch_credsel_combo simpbranch-option"),i||a.getContent().addClassName("newbranch_single_sel"),a.inject(s);var r=e;if(!!(r._userCredentials&&r._userCredentials.length>0)){var c=r._userCredentials.map(e=>({labelItem:e.displayName,valueItem:e.ctx}));a.elementsList=c,a.value=r._securityContext,n.disabled=!1}else{let e=[{labelItem:j.noCredentials}];a.elementsList=e,a.value=e[0].labelItem}return l._setTouchAttribute(t.elements.body),e.dispatchEvent("CredentialUiCreated",a),a},_onCredentialSeletionChangedMonoSel:function(){console.log("Credential changed callback"),this._setWaitingResponse();var e=this,t=this.objectsList[0].volatileAttributes.credentials;Promise.resolve().then(()=>this.initBL_already_called?this._WafDataPromise("/resources/lifecycle/duplicate/initialize_objects",{data:this.objectsList,operationDetail:"NewEvolution"},t):void 0).then(t=>{e._setEndWaitingResponse();var i=new Map;if(t&&Array.isArray(t.results)&&t.results.forEach(e=>{e.objectId&&Array.isArray(e.attrs)&&e.attrs.length>0&&i.set(e.objectId,e.attrs)}),this.objectsList.forEach(e=>{var t=e.objectId||e.physicalid,n=i.get(t);Array.isArray(n)&&n.length>0&&(e.modifiedAttributes||(e.modifiedAttributes={}),n.forEach(t=>{t.name&&t.value&&(e.modifiedAttributes[t.name]=t.value)}))}),null!==e.objectProp){var n=e.objectProp.getIntent();e.objectProp.setObject(e.objectsList[0],e.intentsList.length>1||!e.isThereLinearData?e.intentsList:null,n)}console.log("Credential changed done")}).catch(t=>{e._setEndWaitingResponse(),console.log("Credential changed Failure..."+t),e.showError(t),e._onComplete()})},_onItentSeletionChangedMonoSel:function(){console.log("Branch intent changed callback"),this._setWaitingResponse();var e=this,t=[];this.objectsList.forEach(function(e){var i=e.objectId||e.physicalid;t.push(i)});var i="";null!==this.objectProp&&(i=this.objectProp.getIntent()),n.getVersionNumberProposalPromise(t,i,null,this.context).then(t=>{e._setEndWaitingResponse();var i=new Map;if(!t.addRequests||!Array.isArray(t.addRequests))throw I.objectNotFound;if(t.addRequests.forEach(e=>{i.set(e.copyId,e.code)}),e.objectsList.forEach(e=>{var t="";e.physicalid&&(t=e.physicalid),e.objectId&&(t=e.objectId);var n=i.get(t);n&&(e.proposedRevision=n)}),null!==e.objectProp){var n=e.objectProp.getIntent();e.objectProp.setObject(e.objectsList[0],e.intentsList.length>1||!e.isThereLinearData?e.intentsList:null,n)}console.log("Branch intent changed callback done"),e.dispatchEvent("onIntentChangedForODT")}).catch(t=>{e._setEndWaitingResponse(),console.log("Branch intent changed Failure..."+t),e.showError(t),e._onComplete()})},_checkVersionCommentValue:function(e){if(e&&e.length>256){var t=require("i18n!DS/EditPropWidget/assets/nls/langEditProp"),i="checkVersionCommentValue error";return t&&(i=t.replace(t.get("MaxLengthAttribute"),{label:W.LifecycleObjectList_versionComment,value:256})),{code:"ERROR",eventID:"warning",message:i}}return null},_checkBeforeExecute:function(){var e=this,t=[];if(null!=this.objectProp&&(t=this.objectProp.getErrors()),this._displayAsMultiSelPanel()&&this.dupStringInput&&this.dupStringInput.value&&this.dupStringInput.value.length>0){var i=e._checkTitleValue();i&&t.push(i)}return this.objectsList.forEach(function(i){if(i.modifiedAttributes&&i.modifiedAttributes["PLMReference.V_versionComment"]){var n=e._checkVersionCommentValue(i.modifiedAttributes["PLMReference.V_versionComment"]);n&&t.push(n)}}),t},_computeRequest:function(){return this.useAdvancedBranch?this._computeAdvRequest():this._computeBasicRequest()},_computeBasicRequest:function(){var e={data:[]};return this.objectsList.forEach(function(t){var i={physicalid:t.physicalid};t.modifiedAttributes&&Object.getOwnPropertyNames(t.modifiedAttributes).length&&(i.modifiedAttributes=t.modifiedAttributes),e.data.push(i)}),null===this.objectProp||this._displayAsMultiSelPanel()?(null!==this.intentsListSel&&(e.intent=this.intentsListSel.currentValue),null!==this.dupStringInput&&(e.prefix=this.dupStringInput.value)):(e.intent=this.objectProp.getIntent(),e.prefix=""),null!==this.folderId&&(e.folderid=this.folderId),"OnPremise"===this.tenant||this.wintop||(e.checkReusable=!1),this.initBL_already_called&&(e.initBL_already_called=!0),e},_computeAdvRequest:function(){var e={},t=this.advBranchTreeLoader.nodeToRoot;for(var i of(e.data=this.advancedBranchTree.getTreeData(),e.usingAdvanced=!0,null!==this.folderId&&(e.folderid=this.folderId),e.data))if(i.isRootNode){var n=this.expandReqBuilder.getFilterSpec(i.physicalid);n.hasFilter&&(i.filterSpec=JSON.stringify(n.filterSpec))}else t.has(i.physicalid)&&(i.rootid=t.get(i.physicalid));return e},showNotificationInDialog:function(e){this.wintop?this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onDisplayErrorMessage",notif_parameters:{severity:"warning",message:e.message}},"lf_web_in_win"):"ERROR"===e.code?null!=this.errorOverlay?this.errorOverlay.addError(e.message,e.customClass):this.showError(e.message):null!=this.errorOverlay?this.errorOverlay.addWarning(e.message,e.customClass):this.showNotification(e.message)},showNotification:function(e,t){if(t||(t={}),this.wintop)this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onDisplayErrorMessage",notif_parameters:{severity:"warning",message:e}},"lf_web_in_win");else{var i={eventID:"primary",msg:e,sticky:t.sticky||!1};S.displayNotification(i),console.log(e)}},showSuccess:function(e){if(this.wintop)this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onDisplayErrorMessage",notif_parameters:{severity:"warning",message:e}},"lf_web_in_win");else{var t={eventID:"success",msg:e};S.displayNotification(t),console.log(e)}},showError:function(e){if(this.wintop)this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onDisplayErrorMessage",notif_parameters:{severity:"error",message:e}},"lf_web_in_win");else{var t={eventID:"error",msg:e};S.displayNotification(t),console.log(e)}},_executeNewBranch:function(){var e=this;return new Promise((t,i)=>{var o=this._computeRequest();o.notificationTimeout=600;JSON.stringify(o);console.log("before NEW BRANCH");var a=JSON.stringify(o),r=s.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/newbranch/execute_newbranch",null),l=this._getSelectedSecurityContext();c.authenticatedRequest(r,{method:"POST",headers:function(t){var i=s.getHeaders(t);return e.wintop&&e.wintop_ChangeActionId&&(i["DS-Change-Authoring-Context"]="pid:"+e.wintop_ChangeActionId),i}(l),timeout:6e5,onComplete:function(n){if(console.log("NEW BRANCH: COMPLETED"),n&&"failure"===n.status&&n.report){var s=[];if(n.report.length>0){var o=[];e.selectionList.forEach(function(e){o[e.physicalid]=e.displayName}),n.report.forEach(function(e){if(e.hasOwnProperty("physicalids")){for(var t="",i=0;i<e.physicalids.length;i++){var n=e.physicalids[i];o.hasOwnProperty(n)&&(t+=o[n],i===e.physicalids.length-1?t+=":\n":t+=",\n")}t+=e.error,s.push({severity:"error",message:t})}else s.push({severity:"error",message:e.error})})}else s.push({severity:"error",message:I.newBranchFailed});return s.forEach(t=>{console.log(t.message),e.wintop||e.showError(t.message)}),void i({errors:s})}console.log(I.newBranchSuccessful),e.wintop||e.showSuccess(I.newBranchSuccessful);var a=[];n.report&&n.report.length>0&&n.report.forEach(e=>{e.warning&&a.push({severity:"warning",message:e.warning})}),a.forEach(t=>{console.log(t.message),e.wintop||e.showNotification(t.message)});var r={created:[],deleted:[],modified:[]};r.context=e.context,r.warnings=a;var l=[];e.objectsList.forEach(function(e){e.hasOwnProperty("isRoot")&&!e.isRoot||(l[e.physicalid]=!0)}),n.results.forEach(function(t){var i=null;if(t.hasOwnProperty("derivedfromphysicalid")&&(i=t.derivedfromphysicalid),l.hasOwnProperty(i)){var n={physicalid:t.physicalid,sourceObjectId:i,operation:"Branch"},s=[e.folderId];n.folders=s,r.refreshFolder=!0,r.created.push(n)}}),t(r)},data:a,onTimeout:function(t){e.wintop||e.showNotification(j.notificationTimeoutInfo,{sticky:!0}),console.log("Timeout error"),i({errors:[{severity:"error",message:j.notificationTimeoutInfo}]})},onFailure:function(t,s){n.showWebServiceError(t,s,function(n,s){s?(e.wintop||e.showNotification(j.notificationTimeoutInfo,{sticky:!0}),console.log(j.notificationTimeoutInfo),console.log(t),i({errors:[{severity:"error",message:j.notificationTimeoutInfo}]})):(e.wintop||e.showError(j.NewBranchFailed+"<br>"+n),console.log("Failed to retrieve data from the server"),console.log(t),i({errors:[{severity:"error",message:j.NewBranchFailed+"\n"+n}]}))},!0)},type:"json"})})}})});