define("DS/ENOAttachmentsWebInWin/Attachments",["DS/ENOXAttachmentsAndSpecificationsUX/AttachmentsAndSpecifications","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/EditPropWidget/EditPropWidget","DS/EditPropWidget/constants/EditPropConstants","DS/EditPropWidget/models/EditPropModel","DS/WAFData/WAFData","css!DS/ENOAttachmentsWebInWin/assets/css/ENOAttachmentsWebInWin.css"],function(e,t,n,a,c,i){"use strict";var s=null,o=function(e){1!=e.data.length||e.PLMDMTDocumentTypes&&(!e.PLMDMTDocumentTypes||e.PLMDMTDocumentTypes.includes(e.data[0].type))||e.contextMenu.addItem({title:"Preview",name:"Preview",text:"Preview",fonticon:"eye",handler:function(){var t=[];e.data.forEach(e=>{e.relateddata&&e.relateddata.files&&e.relateddata.files.length>0?e.relateddata.files.forEach(e=>{t.push({docId:e.id,docType:"DOCUMENTS",docName:e.dataelements.title})}):t.push({docId:e.id,docType:"DOCUMENTS",docName:e.dataelements.name})}),r(t)}})},r=function(e){var t="";e.forEach(e=>{t+=e.docId+"&name="+e.docName+"&documentType="+e.docType+";"}),dscef.sendString("ObjectSelect="+t)},d={modelEvents:null,attachmentsAndSpecifications:null,InitWebInWin:function(t){var c=this;s=t.user;var i={};d._getWebInWinParameters(function(s){i=s||null,c.hideAttachments="true"===t.hideAttachments,c.hideSpecifications="true"===t.hideSpecifications,d._populate3DSpaceURL(i).then(function(t){var i=UWA.createElement("div",{id:"AttachmentsWebInWinProperty"});i.inject(widget.body);var s={className:"editTaskProperties",setEditButton:!1,readOnly:!0,typeOfDisplay:a.ONLY_IDENTITY_CARD,multiselection:!1,collapseTabs:!1,context:widget,actions:[]};c.prop=new n(s),c.prop.elements.container.inject(i);var o=t;if(1==t.length)o=t[0];else for(var r=d._getTenantId(),l=0;l<t.length;l++)if(r==t[l].platformId){o=t[l];break}var p=o&&o["3DSpace"]?o["3DSpace"]:"",f=(o&&o["3DDashboard"]&&o["3DDashboard"],o&&o.platformId?o.platformId:"");widget.data.x3dPlatformId=f,c.getSecurityContexts(p,f).then(function(t){var n={connectorOptions:{fetchSecurityContext:function(){return t.securityContext},platformUrls:o,getWorkUnderHeaders:function(){return console.log("Before SetChangeActionID"),dscef.sendString("FetchChangeActionID =1"),console.log("After SetChangeActionID"),null!=c.changeID&&""!=c.changeID?{"DS-Change-Authoring-Context":"pid:"+c.changeID}:{}}},webinwin:!0};c.hideAttachments&&(n.hideAttachments=c.hideAttachments),c.hideSpecifications&&(n.hideSpecifications=c.hideSpecifications),c.attachmentsAndSpecifications=new e(n),c.hideAttachments||(c.attachmentsModelEvents=c.attachmentsAndSpecifications.attachmentsPane.modelEvents),c.hideSpecifications||(c.specificationsModelEvents=c.attachmentsAndSpecifications.specificationsPane.modelEvents),c.subscribeToTasks();var a=UWA.createElement("div",{id:"AttachmentsWebInWin"});a.inject(widget.body),c.attachmentsAndSpecifications.inject(a),dscef.sendString("FetchChangeActionID=1"),dscef.sendString("SetInitialParentObjectID=1")})},function(e){return console.log("Populate 3DSpace URL failed"),Promise.reject(e)})})},_getTenantId:function(){return dscef.getEnv("MX_ONLINE_INSTANCE")},_getWebInWinParameters:function(e){window.COMPASS_CONFIG&&window.COMPASS_CONFIG.myAppsBaseUrl?e(window.COMPASS_CONFIG):d._getAppsUrl(function(t){window.COMPASS_CONFIG||(window.COMPASS_CONFIG={}),t&&(window.COMPASS_CONFIG.myAppsBaseUrl=t,window.COMPASS_CONFIG.userId||(window.COMPASS_CONFIG.userId=s),window.COMPASS_CONFIG.lang||(window.COMPASS_CONFIG.lang=widget.lang)),e(window.COMPASS_CONFIG)})},_getAppsUrl:function(e){"function"==typeof dscef.getMyAppsURL?dscef.getMyAppsURL().then(function(t){console.log("MyApps URL",t),e(t)}).catch(function(t){console.error("Failed to fetch MyApps URL: "+t),e(null)}):e(null,null)},_populate3DSpaceURL:function(e){return new Promise(function(n,a){var c=null;e&&((c={}).myAppsBaseUrl=e.myAppsBaseUrl,c.userId=e.userId,c.lang=e.lang),t.getPlatformServices({config:c,platformId:dscef.getEnv("MX_ONLINE_INSTANCE"),onComplete:function(e){n(e)},onFailure:a})})},subscribeToTasks:function(){var e=this;e.attachmentsModelEvents&&(e.attachmentsModelEvents.subscribe({event:"open-3dsearch-for-add-existing"},function(t){e.SearchOpenedFrom="attachments",dscef.sendString("SelectFromSearch="+t.precond)}),e.attachmentsModelEvents.subscribe({event:"context-menu-requested"},o),e.attachmentsModelEvents.subscribe({event:"attach-attachment-complete"},function(e){dscef.sendString("RefDocAttachComplete="+e.parentObject.parentId+":"+e.document.id)}),e.attachmentsModelEvents.subscribe({event:"upload-attachment-complete"},function(e){for(var t="",n=0;n<e.documents.length;n++)t=t+e.documents[n].id+",";dscef.sendString("RefDocUploadComplete="+e.parentObject.parentId+":"+t)}),e.attachmentsModelEvents.subscribe({event:"detach-attachment-complete"},function(e){dscef.sendString("RefDocDetachComplete="+e.parentObject.parentId+":"+e.id)})),e.specificationsModelEvents&&(e.specificationsModelEvents.subscribe({event:"open-3dsearch-for-add-existing"},function(t){e.SearchOpenedFrom="specifications",dscef.sendString("SelectFromSearch="+t.precond)}),e.specificationsModelEvents.subscribe({event:"context-menu-requested"},o),e.specificationsModelEvents.subscribe({event:"attach-attachment-complete"},function(e){dscef.sendString("SpecDocAttachComplete="+e.parentObject.parentId+":"+e.document.id)}),e.specificationsModelEvents.subscribe({event:"upload-attachment-complete"},function(e){for(var t="",n=0;n<e.documents.length;n++)t=t+e.documents[n].id+",";dscef.sendString("SpecDocUploadComplete="+e.parentObject.parentId+":"+t)}),e.specificationsModelEvents.subscribe({event:"detach-attachment-complete"},function(e){dscef.sendString("SpecDocDetachComplete="+e.parentObject.parentId+":"+e.id)}))},SelectFrom3DDone:function(e){if("undefined"!==e){this.attachmentsAndSpecifications.setParentObject({parentId:e});var t=[new c({metatype:"Task",objectId:e})];this.prop.initDatas(t)}else this.attachmentsAndSpecifications.setParentObject(),this.prop.initDatas([])},SelectFromSearchDone:function(e){for(var t=e.split(","),n=[],a=0;a<t.length;a++)n.push(t[a]);"attachments"==this.SearchOpenedFrom?this.attachmentsAndSpecifications.attachmentsPane.attachAttachments(n):"specifications"==this.SearchOpenedFrom&&this.attachmentsAndSpecifications.specificationsPane.attachSpecifications(n)},SetChangeActionID:function(e){this.changeID=e,console.log("SetChangeActionID "+e)},SetInitialParentID:function(e){this.SelectFrom3DDone(e),console.log("SetInitialParentID "+e)},getSecurityContexts:function(e,t){var n={method:"GET"};return n.headers={Accept:"application/json","Content-Type":"application/json","Accept-Language":widget.lang?widget.lang:widget.getValue("lang")},n.cache=-1,new Promise(function(a,c){n.onComplete=function(e){a(JSON.parse(e))},n.onFailure=function(e,t){var n=null;try{n=JSON.parse(t)}catch(e){}null===n&&(n=t),c(n)};var s=t;i.authenticatedRequest(e+"/resources/modeler/pno/person?tenant="+s+"&current=true&select=preferredcredentials&select=collabspaces",n)}).then(function(e){var t=function(e,t,n){return"ctx::"+n+"."+t+"."+e},n=function(e,t,n){return""===t?e+" ● "+n:e+" ● "+t+" ● "+n},a=function(e){var t="",n="",a="";for(var c in e)if(e.hasOwnProperty(c)){var i=e[c];switch(c){case"organization":t=i.name;break;case"role":n=i.name,a=i.nls?i.nls:n}}return{org:t,role:n,roleNls:a}},c="ctx:",i=e.pid,s=[],o="",r="",d="";for(var l in e.preferredcredentials)if(e.preferredcredentials.hasOwnProperty(l)){var p=e.preferredcredentials[l];switch(l){case"collabspace":o=p.name;break;case"organization":r=p.name;break;case"role":d=p.name}}c=t(o,r,d);var f=[];for(var u in e.collabspaces)if(e.collabspaces.hasOwnProperty(u))for(var h=e.collabspaces[u],m=0;m<h.couples.length;m++){var S=a(h.couples[m]);f.push(S.org)}var g=f.every(function(e,t,n){return e===n[f.length-1]});for(var v in e.collabspaces)if(e.collabspaces.hasOwnProperty(v))for(var A=e.collabspaces[v],I=0;I<A.couples.length;I++){var b=a(A.couples[I]),D=t(A.name,b.org,b.role),O=A.title?A.title:A.name,C={csName:O,label:n(O,g?"":b.org,b.roleNls),value:D};c===D&&(C.isDefault=!0),s.push(C)}return""!==o&&""!==r&&""!==d||s.length>0&&(c=s[0].value),widget.addPreference({name:"credentials",defaultValue:c,type:"list",label:"Credentials",options:s}),{userId:i,securityContext:c,cspaces:s}})}};return d});