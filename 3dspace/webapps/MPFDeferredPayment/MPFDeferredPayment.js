define("DS/MPFDeferredPayment/DeferredPaymentNoticeHelper",["DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartPaymentModel/CartPaymentModel"],function(e,t){"use strict";var r={isPhaseWaitingForPurchaseOrder:function(e,r){var a,n,s;return a="buyer"===r,n=!!e.getPurchaseOrderId(),s=e.getState()===t.States.PENDING_PAYMENT,a&&!n&&s},isPhaseWaitingForInvoice:function(t,r,a){var n,s,i,o;return n="seller"===a,s=!!r.getBuyerInvoiceNumber(),i=(o=t.getState())===e.States.READY||o===e.SHIPPED||o===e.States.DELIVERED,n&&!s&&i},isPhaseWaitingForProceedToPayement:function(e,r){var a,n;return a="buyer"===r,n=!!e.getBuyerInvoiceNumber(),a&&n&&e.getState()!==t.States.PAYMENT_COMPLETE}};return r}),define("DS/MPFDeferredPayment/DeferredPaymentNotices",["UWA/Core","UWA/Promise","UWA/Class/View","DS/UIKIT/Mask","DS/PlatformAPI/PlatformAPI","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFDeferredPayment/DeferredPaymentNoticeHelper","DS/MPFPurchaseOrderModel/PurchaseOrderFactory","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentFactory","DS/MPFPurchaseOrderComponent/PurchaseOrderUploadNoticeComponent","DS/MPFInvoiceModel/InvoiceDocumentFactory","DS/MPFInvoiceComponent/InvoiceUploadNoticeComponent","DS/MPFInvoiceComponent/ProceedToPaymentNoticeComponent","DS/MPFServices/ObjectService"],function(e,t,r,a,n,s,i,o,c,h,P,u,d,m,D,y,p,O){"use strict";var l,E={},C={};return E.HIDDEN="hidden",E.UPLOAD_PURCHASE_ORDER="uploadPurchaseOrder",E.UPLOAD_INVOICE="UPLOAD_INVOICE",E.PROCEED_TO_PAYMENT="PROCEED_TO_PAYMENT",C.PURCHASE_ORDER_UPLOADED="purchaseOrderUploaded",(l=r.extend({className:"mpf-deferred-payment-notices",setup:function(e){e||(e={}),this.isPaymentPerPhase=e.isPaymentPerPhase,O.requiredOfPrototype(this.model,i,"options.model must be a CartModel"),this.cart=this.model,this.isPaymentPerPhase?(this.cartPhases=e.cartPhases,this.cartPhase=e.cartPhase,this.cartPayment=e.cartPayment):this.listenTo(this.cart,"onChange",this.update),O.requiredOfPrototype(e.purchaseOrderFactory,u,"options.purchaseOrderFactory must be a PurchaseOrderFactory"),O.requiredOfPrototype(e.purchaseOrderDocumentFactory,d,"options.purchaseOrderDocumentFactory must be a PurchaseOrderDocumentFactory"),O.requiredOfPrototype(e.invoiceDocumentFactory,D,"options.invoiceDocumentFactory must be a InvoiceDocumentFactory"),this.userRole=e.userRole,this.showExplanationLink=e.showExplanationLink,this.stateMachine=this._createStateMachine(),this.uploadPurchaseOrderComponent=null,this.uploadInvoiceComponent=null,this.proceedToPaymentComponent=null,this.purchaseOrderFactory=e.purchaseOrderFactory,this.purchaseOrderDocumentFactory=e.purchaseOrderDocumentFactory,this.invoiceDocumentFactory=e.invoiceDocumentFactory,this.update(),n.subscribe("MPFDeferredPaymentNotices",this._onMessage.bind(this))},render:function(){var e;return(e=this.stateMachine.getState())===E.HIDDEN&&this.container.setContent(),e===E.UPLOAD_PURCHASE_ORDER?this.container.setContent(this.uploadPurchaseOrderComponent.render()):e===E.UPLOAD_INVOICE?this.container.setContent(this.uploadInvoiceComponent.render()):e===E.PROCEED_TO_PAYMENT&&this.container.setContent(this.proceedToPaymentComponent.render()),this},destroy:function(){this.stopListening(),n.unsubscribe("MPFDeferredPaymentNotices"),this.cart=null,this.cartPhase=null,this.cartPayment=null},update:function(){var e,r,a,n;return"DBT"===(this.isPaymentPerPhase?this.cartPayment&&this.cartPayment.getPaymentMethod():this.cart.getPaymentMethod())?(this.isPaymentPerPhase&&!this.cartPhase||(r=this._isWaitingForInvoice(),a=this._isWaitingForPurchaseOrder(),n=this._isWaitingForProceedToPayement()),r?e=this._toUploadInvoiceState():a?e=this._toUploadPurchaseOrderState():n?e=this._toProceedToPaymentState():this.stateMachine.changeState(E.HIDDEN)):this.stateMachine.changeState(E.HIDDEN),t.cast(e).then(this.render.bind(this))},_onMessage:function(e){var r=this;return e&&"update"===e.event&&this.isPaymentPerPhase?(a.mask(this.container),this.cartPhases.fetchPromise().then(function(){if(r.cartPhase=r.cartPhases.getActivePhase(),r.cartPhase)return r.cartPayment.setParentResourceId(r.cartPhase.id),r.cartPayment.fetchPromise()}).then(this.update.bind(this)).finally(function(){a.unmask(r.container)})):t.resolve()},_onPurchaseOrderUploaded:function(){var e=this;this._onMessage({event:"update"}).then(function(){e.dispatchEvent(C.PURCHASE_ORDER_UPLOADED),n.publish("MPPurchaseOrderUploaded",{event:"refresh"})})},_isWaitingForInvoice:function(){return this.isPaymentPerPhase?P.isPhaseWaitingForInvoice(this.cartPhase,this.cartPayment,this.userRole):o.isWaitingForInvoice(this.cart,this.userRole)},_isWaitingForPurchaseOrder:function(){return this.isPaymentPerPhase?P.isPhaseWaitingForPurchaseOrder(this.cartPayment,this.userRole):o.isWaitingForPurchaseOrder(this.cart,this.userRole)},_isWaitingForProceedToPayement:function(){return this.isPaymentPerPhase?P.isPhaseWaitingForProceedToPayement(this.cartPayment,this.userRole):o.isWaitingForProceedToPayement(this.cart,this.userRole)},_createStateMachine:function(){return new s({state:E.HIDDEN,states:[E.HIDDEN,E.UPLOAD_PURCHASE_ORDER,E.UPLOAD_INVOICE,E.PROCEED_TO_PAYMENT],transitions:[{from:E.HIDDEN,to:E.UPLOAD_PURCHASE_ORDER},{from:E.UPLOAD_PURCHASE_ORDER,to:E.HIDDEN},{from:E.HIDDEN,to:E.UPLOAD_INVOICE},{from:E.UPLOAD_INVOICE,to:E.HIDDEN},{from:E.HIDDEN,to:E.PROCEED_TO_PAYMENT},{from:E.PROCEED_TO_PAYMENT,to:E.HIDDEN}]})},_getPurchaseOrder:function(){var e;return this.isPaymentPerPhase?(this.purchaseOrder=this.purchaseOrderFactory.createModel(u.Types.PAYMENT_PURCHASE_ORDER,{}),this.purchaseOrder.setParentResourceId(this.cartPayment.id)):(this.purchaseOrder=this.purchaseOrderFactory.createModel(u.Types.CART_PURCHASE_ORDER,{}),(e=this.cart.getPurchaseOrderId())&&this.purchaseOrder.set("id",e),this.purchaseOrder.setParentResourceId(this.cart.id)),this.purchaseOrder.fetchPromise()},_createPurchaseOrderDocument:function(){return this.isPaymentPerPhase?(this.purchaseOrderDocument=this.purchaseOrderDocumentFactory.createModel(d.Types.PAYMENT_PURCHASE_ORDER_DOCUMENT),this.purchaseOrderDocument.setParentResourceId(this.cartPayment.id)):(this.purchaseOrderDocument=this.purchaseOrderDocumentFactory.createModel(d.Types.CART_PURCHASE_ORDER_DOCUMENT),this.purchaseOrderDocument.setParentResourceId(this.cart.id)),this.purchaseOrderDocument},_toUploadPurchaseOrderState:function(){var e=this;return this._getPurchaseOrder().then(function(){e.uploadPurchaseOrderComponent||(e.purchaseOrderDocument||e._createPurchaseOrderDocument(),e.uploadPurchaseOrderComponent=new m({model:e.purchaseOrder,purchaseOrderDocument:e.purchaseOrderDocument,cart:e.cart,cartPayment:e.cartPayment,showExplanationLink:e.showExplanationLink,isPaymentPerPhase:e.isPaymentPerPhase}),e.listenTo(e.uploadPurchaseOrderComponent,m.Events.PURCHASE_ORDER_UPLOADED,e._onPurchaseOrderUploaded.bind(e))),e.stateMachine.changeState(E.UPLOAD_PURCHASE_ORDER)})},_createInvoiceDocument:function(){this.isPaymentPerPhase?(this.invoiceDocument=this.invoiceDocumentFactory.createModel(D.Types.PAYMENT_INVOICE_DOCUMENT),this.invoiceDocument.parentResourceId=this.cartPayment.id):(this.invoiceDocument=this.invoiceDocumentFactory.createModel(D.Types.CART_INVOICE_DOCUMENT),this.invoiceDocument.parentResourceId=this.cart.id)},_toUploadInvoiceState:function(){var e=this;return this._getPurchaseOrder().then(function(){e.uploadInvoiceComponent||(e.invoiceDocument||e._createInvoiceDocument(),e.uploadInvoiceComponent=new y({model:e.cart,cartPayment:e.cartPayment,invoiceDocument:e.invoiceDocument,purchaseOrder:e.purchaseOrder,showExplanationLink:e.showExplanationLink,isPaymentPerPhase:e.isPaymentPerPhase})),e.stateMachine.changeState(E.UPLOAD_INVOICE),e.listenTo(e.uploadInvoiceComponent,y.Events.INVOICE_UPLOADED,e._onMessage.bind(e,{event:"update"}))})},_toProceedToPaymentState:function(){this.proceedToPaymentComponent||(this.proceedToPaymentComponent=new p({showExplanationLink:this.showExplanationLink})),this.stateMachine.changeState(E.PROCEED_TO_PAYMENT)}})).Events=Object.freeze(C),l}),define("DS/MPFDeferredPayment/DeferredPaymentNoticesFactory",["UWA/Class","UWA/Promise","DS/MPFServices/ObjectService","DS/MPFConnector/MarketplaceConnector","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFCartModel/CartFactory","DS/MPFCartPhaseModel/CartPhaseFactory","DS/MPFCartPaymentModel/CartPaymentFactory","DS/MPFCartModel/CartModel","DS/MPFDeferredPayment/DeferredPaymentNotices"],function(e,t,r,a,n,s,i,o,c,h){"use strict";var P;return(P=e.extend({init:function(e){this.options=e||{},r.requiredOfType(this.options.cartId,"string","options.cartId must a string"),r.requiredOfType(this.options.userRole,"string","options.userRole must a string"),this.cartId=this.options.cartId,this.userRole=this.options.userRole,this.showExplanationLink=this.options.showExplanationLink,this.isPaymentPerPhase=!0===this.options.isPaymentPerPhase,this.connector=this.options.connector,this.purchaseOrderFactory=null,this.purchaseOrderDocumentFactory=null,this.invoiceDocumentFactory=null,this.cartFactory=null,this.cartPhaseFactory=null,this.cartPaymentFactory=null,this.cart=null,this.cartPhase=null,this.cartPayment=null},_getConnector:function(){var e=this;return(this.connector?t.resolve(this.connector):a.fetchPromise(this.options)).then(function(t){e.connector=t})},_getFactories:function(){var e=this;return n.getInstance(this.connector).getFactories([n.Types.PURCHASE_ORDER,n.Types.PURCHASE_ORDER_DOCUMENT,n.Types.INVOICE_DOCUMENT,n.Types.CART,n.Types.CART_PHASE,n.Types.CART_PAYMENT]).then(function(t){e.purchaseOrderFactory=t[0],e.purchaseOrderDocumentFactory=t[1],e.invoiceDocumentFactory=t[2],e.cartFactory=t[3],e.cartPhaseFactory=t[4],e.cartPaymentFactory=t[5]})},_getModels:function(){return this.isPaymentPerPhase?t.all([this._getCart(),this._getCartPhases()]).then(this._getCartPayment.bind(this)):this._getCart()},_getCart:function(){var e=this;return this.cart=this.cartFactory.createModel(s.Types.CART),this.cart.set("id",this.cartId),this.cart.fetchPromise({expand:[c.Expands.CART_ITEMS]}).then(function(t){e.cart=t})},_getCartPhases:function(){var e,t=this;return(e=this.cartPhaseFactory.createCollection(i.Types.CART_CART_PHASE)).setParentResourceId(this.cartId),e.fetchPromise().then(function(e){t.cartPhases=e})},_getCartPayment:function(){var e,r;return this.cartPayment=this.cartPaymentFactory.createModel(o.Types.CART_PHASE_CART_PAYMENT),(r=this.cartPhases.getActivePhase())?(this.cartPayment.setParentResourceId(r.id),e=this.cartPayment.fetchPromise()):e=t.resolve(),e},_getConfig:function(){var e;return e={purchaseOrderFactory:this.purchaseOrderFactory,purchaseOrderDocumentFactory:this.purchaseOrderDocumentFactory,invoiceDocumentFactory:this.invoiceDocumentFactory,userRole:this.userRole,showExplanationLink:this.showExplanationLink,isPaymentPerPhase:this.isPaymentPerPhase},this.isPaymentPerPhase&&(e.cartPhases=this.cartPhases,e.cartPhase=this.cartPhases.getActivePhase(),e.cartPayment=this.cartPayment),e.model=this.cart,e},getOptions:function(){return this._getConnector().then(this._getFactories.bind(this)).then(this._getModels.bind(this)).then(this._getConfig.bind(this))},build:function(){return this.getOptions().then(function(e){return new h(e)})}})).fromCart=function(e){return new P(e).build()},P.fromCartOptions=function(e){return new P(e).getOptions()},P});