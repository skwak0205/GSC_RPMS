define("DS/InstantMessagingCall/store/modules/messages",["i18n!DS/InstantMessagingCall/assets/nls/feed"],function(e){"use strict";const t=e;return{state:(()=>({NLS:t,connexionLost:!1,bodyAlerts:{connexionLost:{text:t.startCallAbortedBecauseOffline,type:"warning",timeout:3e3,visible:!1},connexionRetrieved:{text:t.connexionRetrieved,type:"success",timeout:3e3,visible:!1},reconnectOngoing:{text:t.reconnectOngoing,type:"warning",timeout:3e3,visible:!1},connexionNetworkLost:{text:t.connexionNetworkLost,type:"error",timeout:0,visible:!1},callUnavailablePlurial:{text:t.callUnavailablePlurial,type:"warning",timeout:3e3,visible:!1},callUnavailableSingular:{text:t.callUnavailableSingular,type:"warning",timeout:3e3,visible:!1},publishDocument:{text:t.publishDocument,type:"success",timeout:3e3,visible:!1},publishDocumentError:{text:t.publishDocumentError,type:"error",timeout:3e3,visible:!1},audiomuted:{text:t.audiomuted,type:"warning",timeout:3e3,visible:!1},mediaDeviceNotFound:{text:t.localMediaError_NotFoundError,type:"warning",timeout:3e3,visible:!1},mediaDeviceAccessDisabled:{text:t.localMediaError_SecurityError,type:"warning",timeout:3e3,visible:!1},mediaDeviceAccessAborted:{text:t.localMediaError_AbortError,type:"warning",timeout:3e3,visible:!1},mediaAccessNotAllowed:{text:t.localMediaError_NotAllowedError,type:"warning",timeout:3e3,visible:!1},mediaDeviceAccessFailed:{text:t.localMediaError_OverConstrainedError,type:"warning",timeout:3e3,visible:!1},mediaDeviceNotSupported:{text:t.localMediaError_NotReadableError,type:"warning",timeout:3e3,visible:!1},browserNotCompatible:{text:t.localMediaError_TypeError,type:"warning",timeout:3e3,visible:!1}}}))(),getters:{nls:e=>t=>e.NLS[t],bodyAlerts:e=>e.bodyAlerts},mutations:{bodyAlertVisible:(e,{key:t,visible:r})=>{e.bodyAlerts[t]?e.bodyAlerts[t].visible=r:console.error("bodyAlert not found "+t)},connexionLost:(e,t)=>{e.connexionLost=t},bodyAlertText:(e,{key:t,text:r})=>{e.bodyAlerts[t]?e.bodyAlerts[t].text=r:console.error("bodyAlert not found "+t)}},actions:{hide_bodyAlert({commit:e},t){e("bodyAlertVisible",{key:t,visible:!1})},show_bodyAlert({commit:e},t){e("bodyAlertVisible",{key:t,visible:!0})},alert_connexionLost({dispatch:e,commit:t}){t("connexionLost",!0),e("hide_bodyAlert","connexionRetrieved"),e("show_bodyAlert","connexionLost")},alert_connexionRetrieved({state:e,dispatch:t,commit:r}){e.connexionLost&&(t("hide_bodyAlert","connexionLost"),t("hide_bodyAlert","connexionNetworkLost"),t("show_bodyAlert","connexionRetrieved"),r("connexionLost",!1))},alert_reconnectOngoing({dispatch:e}){e("hide_bodyAlert","connexionLost"),e("hide_bodyAlert","connexionRetrieved"),e("hide_bodyAlert","connexionNetworkLost"),e("show_bodyAlert","reconnectOngoing")},alert_connexionNetworkLost({dispatch:e}){e("hide_bodyAlert","connexionLost"),e("hide_bodyAlert","connexionRetrieved"),e("hide_bodyAlert","reconnectOngoing"),e("show_bodyAlert","connexionNetworkLost")},alert_uncallableUsers({getters:e,dispatch:t,commit:r},{uncallableUsers:i,calledUsers:s}){var a=i.length,o=a>1?"callUnavailablePlurial":"callUnavailableSingular";r("bodyAlertText",{text:e.nls(o).replace("{0}",a).replace("{1}",s.length+a),key:o}),t("show_bodyAlert",o)},alert_publishDocument({dispatch:e}){e("show_bodyAlert","publishDocument")},alert_publishDocumentError({dispatch:e}){e("show_bodyAlert","publishDocumentError")},alert_audiomuted({dispatch:e}){e("show_bodyAlert","audiomuted")},alert_browserNotCompatible({dispatch:e}){e("show_bodyAlert","browserNotCompatible")},alert_getLocalMediaError({dispatch:e},t){switch(t.name){case"NotFoundError":case"DevicesNotFoundError":e("show_bodyAlert","mediaDeviceNotFound");break;case"SecurityError":e("show_bodyAlert","mediaDeviceAccessDisabled");break;case"AbortError":e("show_bodyAlert","mediaDeviceAccessAborted");break;case"NotAllowedError":case"PermissionDeniedError":e("show_bodyAlert","mediaAccessNotAllowed");break;case"NotReadableError":case"TrackStartError":case"InvalidStateError":case"MediaDeviceFailedDueToShutdown":case"MediaDeviceKillSwitchOn":case"InternalError":e("show_bodyAlert","mediaDeviceAccessFailed");break;case"OverConstrainedError":case"ConstraintNotSatisfiedError":e("show_bodyAlert","mediaDeviceNotSupported");break;case"TypeError":case"NotSupportedError":e("show_bodyAlert","browserNotCompatible");break;default:console.error(t)}}}}}),define("DS/InstantMessagingCall/components/ActionBarItem/ActionBarItem",["text!DS/InstantMessagingCall/components/ActionBarItem/ActionBarItem.html"],function(e){"use strict";return{props:["label","rightTooltip"],template:e}}),define("DS/InstantMessagingCall/components/CollabOfficeDocument/CollabOfficeDocument",["text!DS/InstantMessagingCall/components/CollabOfficeDocument/CollabOfficeDocument.html","DS/UIKIT/Input/Button","DS/UIKIT/Mask"],function(e,t,r){"use strict";var i=void 0;return{props:["featureData","featureId","active"],computed:{title(){var e=this.featureData;if(!e||!e.title||!this.featureId)return this.publishButton&&this.publishButton.destroy(),this.$refs.OdeContainer&&this.$refs.OdeContainer.children[0]&&"function"==typeof this.$refs.OdeContainer.children[0].destroy&&this.$refs.OdeContainer.children[0].destroy(),i&&(i=void 0),null;if(e&&e.title&&e.ext&&e.url&&this.featureId){var s=this.$store.getters.swymUrl,a=this.$store.getters.accepted_room&&this.$store.getters.accepted_room.options&&this.$store.getters.accepted_room.options.dmId,o=this;this.publishButton=((e,r)=>{var i=document.getElementById("im-call-lightbox");if(i)var s=i.getElementsByClassName("lightbox-bar__menu");var a=s[0].getElementsByClassName("bt_publish");a[0]&&"function"==typeof a[0].destroy&&a[0].destroy();var o=new t({value:e,className:"primary bt_publish",id:"bt_publish",events:{onClick:r}});return o.getContent().style.margin="5px",s[0].insertBefore(o.getContent(),s[0].firstChild),o})(this.$store.getters.nls("publish"),()=>{r.mask(o.publishButton.getContent(),""),((e,t,r,s)=>{var a={community_id:t,id_media:r};i.save({callbackUrl:e+"/api/media/editmedia",params:a,headers:{"X-DS-SWYM-CSRFTOKEN":"ode:{csrfToken}"},filenameForUpload:"userFile",firstCallUrl:e+"/api/session/info"}).then(function(e){s()},function(e){switch(e){case i.ERROR.NO_DOCUMENT_URL_PROVIDED:console.error("ODE Collab : NO_DOCUMENT_URL_PROVIDED");break;case i.ERROR.SERVICE_NOT_FOUND:console.error("ODE Collab : SERVICE_NOT_FOUND");break;default:console.error("ODE Collab : "+e)}s(e)})})(s,a,e.mediaId,function(e){r.unmask(o.publishButton.getContent()),e?o.$store.dispatch("alert_publishDocumentError"):o.$store.dispatch("alert_publishDocument")})}),(({title:e,ext:t,url:r},s,a,o)=>{if(!(e&&t&&r&&s))return console.error("loadODE missing params");a.children[0]&&"function"==typeof a.children[0].destroy&&a.children[0].destroy(),require("DS/TopFrame/TopFrame")._loadModules(["DS/OfficeDocumentEditorClient/Editor"]).then(function(n){if(i=n[0]){var l=UWA.extendElement(a);i.init({title:e,ext:t,url:r,readOnly:!1,docKeyToUse:"featureId"+s,useIframe:!0,rootElem:l,platformId:o}).then(function(e){},function(e){switch(e){case i.ERROR.NO_DOCUMENT_URL_PROVIDED:console.error("ODE Collab : NO_DOCUMENT_URL_PROVIDED");break;case i.ERROR.SERVICE_NOT_FOUND:console.error("ODE Collab : SERVICE_NOT_FOUND");break;default:console.error("ODE Collab : "+e)}})}})})(e,this.featureId,this.$refs.OdeContainer,this.$store.getters.tenant)}return e.title}},template:e}}),define("DS/InstantMessagingCall/store/modules/noises",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingWebRTC/js/model/NoiseMaker"],function(e,t){"use strict";return{state:(()=>({noiseMaker:t}))(),mutations:{noiseURL(e,{noisename:t,url:r}){e.noiseMaker.set(t,r)},startRingtone(e){e.noiseMaker.start("ringtone",3e4)},startRingbacktone(e){e.noiseMaker.start("ringbacktone",3e4)},stopTones(e){e.noiseMaker.stop("ringtone"),e.noiseMaker.stop("ringbacktone")},userIn(e){e.noiseMaker.start("userin")},userOut(e){e.noiseMaker.start("userout")}},actions:{noises({commit:t},{action:r}){switch(r){case"userIn":t("userIn");break;case"userOut":t("userOut");break;case"startRingtone":t("startRingtone");break;case"startRingbacktone":t("startRingbacktone");break;case"stopTones":t("stopTones");break;default:e.error("unknown noises action "+r)}},preloadNoises({state:e,commit:t,getters:r}){const i=r.assets_url;t("noiseURL",{noisename:"ringtone",url:i+"ringtone.wav"}),t("noiseURL",{noisename:"ringbacktone",url:i+"ringbacktone.wav"}),t("noiseURL",{noisename:"userin",url:i+"userin.wav"}),t("noiseURL",{noisename:"userout",url:i+"userout.wav"}),e.noiseMaker.preload()}}}}),define("DS/InstantMessagingCall/components/PanelTimeline/PanelTimeline",["text!DS/InstantMessagingCall/components/PanelTimeline/PanelTimeline.html"],function(e){"use strict";var t,r;return{computed:{dmId(){if(this.$store.getters.accepted_room&&this.$store.getters.accepted_room.options){this.$refs.TimelineContainer.children[0]&&this.$refs.TimelineContainer.children[0].destroy();var e=this.$store.getters.accepted_room.options.dmId;e&&((e,i,s)=>{if(t=t||require("DS/i3DXCompass/i3DXCompass"),r=r||require("UWA/Core"),!t||!r)return console.error("PanelTimeline prereqs not available");var a=UWA.extendElement(e);a.getParent().style.height="100%";i=i;var o=s.toUpperCase();t.getAppInfo({appId:"X3DMCTY_AP",onComplete:function(e){if(e){var t,s,n,l={communityType:"dm",community:i,x3dPlatformId:o,leftPanelState:"closed"},c=JSON.stringify(l),d={el:a,parent:!1,preview:!1,appId:"X3DMCTY_AP",data:c,header:!1};if(!e||!(e.checksum&&e.launchInfos||e.platforms))return console.error("Could not get valid Config from MyApps for the App "+d.appId);if(e.platformId&&e.platformId.toLowerCase()===o.toLowerCase())t=e.launchInfos,s=e.isolationLevel,n=e.checksum;else{var u=e.platforms.find(e=>e.id.toLowerCase()===o.toLowerCase());if(!u)return console.error("Could not get valid Config from MyApps for the App "+d.appId);t=u.launchInfos,s=u.isolationLevel,n=u.checksum}d=r.extend(d,{widgetId:t,isolationLevel:s,token:n}),require("DS/TopFrame/TopFrame")._loadModules(["DS/UWPClientCode/WidgetFactory","DS/TopFrame/Environment"]).then(function(e){var t=e[0],r=e[1];t.load(d,function(e){},r)})}}})})(this.$refs.TimelineContainer,e,this.$store.getters.tenant)}return this.$store.getters.accepted_room&&this.$store.getters.accepted_room.options&&this.$store.getters.accepted_room.options.dmId}},template:e}}),define("DS/InstantMessagingCall/components/Collab3DPlay/Collab3DPlay",["DS/3DPlayHelper/3DPlayHelper","UWA/Data","text!DS/InstantMessagingCall/components/Collab3DPlay/Collab3DPlay.html"],function(e,t,r){"use strict";var i;return{props:["featureData","featureId","masterUser","active","feature"],computed:{title(){if(!this.active)return null;var t=this.featureData;return t?(i&&i.isReady&&i.isReady()?console.log("Collab 3DPLay player already running"):((t,r,s,a)=>{if(!t||!r)return console.error("load3DPlay missing params");if(!t.mime)return console.error("load3DPlay missing mime");if(!t.fileName)return console.error("load3DPlay missing fileName");if(!t.path)return console.error("load3DPlay missing path");r.children[0]&&"function"==typeof r.children[0].destroy&&r.children[0].destroy();const o={collabmode:!0,container:r,input:{asset:{filename:t.path,provider:"FILE",format:t.mime,type:t.mime}},options:{loading:"autoplay",callbacks:{experience:{ExperienceReady:()=>{s&&(i.setCollabMode(!0),"function"==typeof a&&i.addCollabCB((e,t)=>{a({arg1:e,arg2:t})}))}},asset:{LoadingFinished:()=>{console.log("Collab 3DPlay LoadingFinished")}}}}};o.input.asset.originalAsset=JSON.parse(JSON.stringify(o.input.asset)),i&&"function"==typeof i.dispose&&i.dispose(),i=new e(o)})(t,this.$refs.TroisDPlayContainer,this.IAmMaster,this.collabCallback),t.title):null},IAmMaster(){return this.masterUser&&this.masterUser.login==this.$store.getters.myself.login},masterLogin(){if(!this.active||!this.masterUser)return null;var e=this.masterUser.login;return console.log("Collab 3DPLay master changed "+e),e},actions(){if(this.IAmMaster||!this.active||!this.feature||!this.feature.featureData)return null;var e=this.feature.featureData.actions;return e&&this.onCoreviewAction(e),e}},methods:{collabCallback({arg1:e,arg2:t}){this.$store.dispatch("send_3DPlay_data",{room_id:this.feature.room_id,featureId:this.featureId,featureData:this.featureData,actions:{arg1:e,arg2:t}})},onCoreviewAction({arg1:e,arg2:t}){if(i&&"function"==typeof i.isReady&&i.isReady()&&"function"==typeof i.performAction)try{i.performAction(e,t)}catch(e){console.error(e)}}},template:r}}),define("DS/InstantMessagingCall/api/senders",["DS/RTProxyDriver/RTProxyDriver","DS/PlatformAPI/PlatformAPI"],function(e,t){"use strict";const r=["startCall","endCall","acceptCall","webrtcIceCandidate","SDP","callEventFromView"],i={};for(let t of r)i[t]=function(t){return function(r){return e.dispatch(t,[r]),!0}}(t);return i.presence=(t=>{e.dispatch("SETSTATUS",[{myStatus:t,statusMsg:t}])}),i.ToSwym=(e=>{t.publish("toswym.im.ds.com",e)}),i}),define("DS/InstantMessagingCall/components/CollabWhiteBoard/CollabWhiteBoard",["text!DS/InstantMessagingCall/components/CollabWhiteBoard/CollabWhiteBoard.html"],function(e){"use strict";return{props:["featureData","featureId","masterUser","active"],data:()=>({sketchObj:null,isLoaded:!1}),computed:{title(){if(!this.active)return this.callInactive&&this.cleanWhiteboard(),null;var e=this.featureData;return e?(!this.isLoaded&&this.loadWhiteboard(),e.title):null},masterLogin(){if(!this.active||!this.masterUser)return null;var e=this.masterUser.login,t=e==this.$store.getters.myself.login;return this.sketchObj&&"function"==typeof this.sketchObj.onChangeCollabMaster&&this.sketchObj.onChangeCollabMaster({login:e,IAmMaster:t}),e},callInactive(){return this.$store.getters.isInitial||this.$store.getters.isEnded}},methods:{loadWhiteboard(){this.isLoaded=!0;var e=this.featureData,t=this.$refs.WhiteboardContainer;if(!e||!t)return console.error("loadWhiteboard missing params");t.children[0]&&"function"==typeof t.children[0].destroy&&t.children[0].destroy(),require("DS/TopFrame/TopFrame")._loadModules(["DS/CAT3DSKBootstrap/CAT3DSketchBootstrap"]).then((r=>(function(i){var s=i[0];s?(r.sketchObj=new s,r.sketchObj.create(t,e)):this.isLoaded=!1}))(this))},cleanWhiteboard(){this.sketchObj&&"function"==typeof this.sketchObj.destroy&&(this.sketchObj.destroy(),this.sketchObj=null,this.isLoaded=!1)}},template:e}}),define("DS/InstantMessagingCall/store/modules/telephony",["DS/RTProxyDriver/RTLogger","DS/DSNodeSocketioClient_4.4.1/DSNodeSocketioClient_4.4.1"],function(e,t){"use strict";return{state:{mediaSource:null,telwebsocket:null,mediaRecorder:null,sourceBuffer:null,streamTel:null},mutations:{resetTelephonyState(e){Object.assign(e,{mediaSource:null,telwebsocket:null,mediaRecorder:null,sourceBuffer:null,streamTel:null})},telwebsocket:(e,t)=>{e.telwebsocket=t},mediaRecorder:(e,t)=>{e.mediaRecorder=t},mediaSource:(e,t)=>{e.mediaSource=t},streamTel:(e,t)=>{e.streamTel=t},sourceBuffer:(e,t)=>{e.sourceBuffer=t}},getters:{mediasource:e=>e.mediaSource,mediaSource:e=>e.mediaSource,mediaRecorder:e=>e.mediaRecorder,sourceBuffer:e=>e.sourceBuffer,streamTel:e=>e.streamTel,telwebsocket:e=>e.telwebsocket},actions:{recordStream:({dispatch:t},{audioBitsPerSecond:r})=>(e.Call("Telephony recordStream"),navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>t("onMediaDeviceStream",{stream:e,audioBitsPerSecond:r})).catch(function(t){e.Call("Fail to record, error in getUserMedia "+t)})),onMediaDeviceStream:({commit:t,getters:r,dispatch:i},{stream:s,audioBitsPerSecond:a})=>(e.Call("Telephony onMediaDeviceStream"),s?(t("streamTel",s),t("mediaRecorder",new MediaRecorder(r.streamTel,{audioBitsPerSecond:a||24e3})),r.mediaRecorder?(r.mediaRecorder.ondataavailable=(e=>i("sendStreamWebTel",e.data)),void r.mediaRecorder.start(20)):console.error("Telephony failed to create MediaRecorder")):e.Call("Telephony onMediaDeviceStream no stream")),sendStreamWebTel({getters:e},t){e.telwebsocket&&e.telwebsocket.emit("web-stream",t)||console.error("cant sendStreamWebTel : missing telwebsocket")},initMediaSource({commit:t,getters:r,dispatch:i}){if(e.Call("Telephony initMediaSource"),t("mediaSource",new MediaSource),!r.mediaSource)return console.error("Telephony failed to create MediaSource");r.mediaSource.addEventListener("sourceopen",t=>{e.Call("Telephony initMediaSource sourceopen"),i("onMediaSourceOpen",t)})},onMediaSourceOpen({getters:t,commit:r,dispatch:i}){if(e.Call("Telephony onMediaSourceOpen"),!t.mediaSource)return console.error("Telephony onMediaSourceOpen no mediaSource");r("sourceBuffer",t.mediaSource.addSourceBuffer("audio/mpeg")),i("received_track_audio",{user_id:t.accepters[0]},{root:!0})},stopSourceBuffer({getters:t}){e.Call("Telephony stopSourceBuffer");try{return t.sourceBuffer.abort()}catch(t){e.Call("Telephony stopSourceBuffer failed "+t)}},stopMediaSource({getters:t}){if(e.Call("Telephony stopMediaSource"),!t.mediaSource)return!0;try{if(t.mediaSource.onsourceopen=null,"open"!=t.mediaSource.readyState)return!0;t.mediaSource.endOfStream(),t.mediaSource.removeSourceBuffer(t.sourceBuffer)}catch(t){e.Call("Telephony stopMediaSource failed "+t)}},activeTelTrack({getters:t}){e.Call("Telephony activeTelTrack");try{return t.mediaRecorder.resume()}catch(t){e.Call("Telephony activeTelTrack failed "+t)}},muteTelTrack({getters:t}){e.Call("Telephony muteTelTrack");try{return t.mediaRecorder.pause()}catch(t){e.Call("Telephony muteTelTrack failed "+t)}},stopTelTrack({getters:t}){e.Call("Telephony stopTelTrack");try{return t.mediaRecorder.ondataavailable=null,"inactive"==t.mediaRecorder.state||t.mediaRecorder.stop()}catch(t){e.Call("Telephony stopTelTrack failed "+t)}},stopTelStream({getters:t}){e.Call("Telephony stopTelStream");try{return t.streamTel.getTracks().forEach(e=>e&&e.stop&&e.stop())}catch(t){e.Call("Telephony stopTelStream failed "+t)}},disconnectTelWS({getters:t}){e.Call("Telephony disconnectTelWS");try{return!(t.telwebsocket&&!t.telwebsocket.disconnected)||t.telwebsocket.io.disconnect()}catch(t){e.Call("Telephony disconnectTelWS failed "+t)}},connectTelWS:({commit:r,dispatch:i,getters:s},{connectionParams:a,call_id:o,url:n,cookie:l})=>a?n?o?(l||e.Call("WARNING - TelWS will be randomly chosen without cookie"),s.telwebsocket?e.Call("TelWS already exists "+(s.telwebsocket.call_id&&s.telwebsocket.call_id==o)&&"for same call"):(e.Call("connectTelWS "+n+" for call "+o),cookieStore.set({name:"TELSERVERID",value:l,path:"/",domain:"3ds.com"}),r("telwebsocket",t.connect(n,Object.assign({},a,{reconnection:!1,path:a&&a.socketioPath||"/socketio.tel"}))),s.telwebsocket?(s.telwebsocket.call_id=o,s.telwebsocket.cookie=l,s.telwebsocket.on("connect",e=>{i("onConnect",e)}),s.telwebsocket.on("connection_ok",e=>{i("onConnectionOK",e)}),s.telwebsocket.on("start-streaming",e=>{i("onStartStream",e)}),s.telwebsocket.on("pstn-stream",e=>{i("onPstnStream",e)}),void s.telwebsocket.on("disconnect",e=>{i("onDisconnect",e)})):e.Call("connectTelWS failed"))):e.Call("cant connectTelWS without call_id"):e.Call("cant connectTelWS without url"):e.Call("cant connectTelWS without params"),onDisconnect({dispatch:t},r){e.Call("Telephony close-ws "+r&&r.call_id),t("cleanTelephony")},onPstnStream({getters:t},r){try{if(!t.sourceBuffer)throw"no sourceBuffer.";if(!t.mediaSource||"open"!=t.mediaSource.readyState)throw"mediaSource not ready";if(t.sourceBuffer.updating)return e.Call("Telephony onPstnStream sourceBuffer is already processing another chunk");t.sourceBuffer.appendBuffer(r)}catch(t){e.Call("Telephony onPstnStream Error : "+t)}},onStartStream({dispatch:t},r){e.Call("Telephony start-streaming."),t("recordStream",r)},onConnectionOK({getters:t,dispatch:r},i){e.Call("Telephony connection_ok"),r("initMediaSource"),t.telwebsocket.emit("init_call",{call_id:t.telwebsocket.call_id,cookie:t.telwebsocket.cookie,allCookie:document.cookie})},onConnect({},t){e.Call("Telephony connected")},cleanTelephony({getters:t,commit:r,dispatch:i},s){i("stopTelTrack").then(()=>i("stopTelStream")).then(()=>i("disconnectTelWS")).then(()=>i("stopMediaSource")).then(()=>i("stopSourceBuffer")).then(()=>r("resetTelephonyState")).catch(t=>{e.Call("Telephony cleanTelephony failed "+t),r("resetTelephonyState")})}}}}),define("DS/InstantMessagingCall/store/modules/usergroup",["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/PlatformAPI/PlatformAPI","DS/WAFData/WAFData","DS/RTProxyDriver/RTLogger"],function(e,t,r,i){"use strict";return{state:Object.assign({odeFeature:!0,whiteboardFeature:!0,telephonyFeature:!1,troisdplayFeature:!1},{}),getters:{odeFeature:e=>e.odeFeature,whiteboardFeature:e=>e.whiteboardFeature,telephonyFeature:e=>e.telephonyFeature,troisdplayFeature:e=>e.troisdplayFeature},mutations:{changeOdeFeature(e,t){e.odeFeature=t},changeWhiteboardFeature(e,t){e.whiteboardFeature=t},changeTelephonyFeature(e,t){e.telephonyFeature=t},change3DPlayFeature(e,t){e.troisdplayFeature=t}},actions:{getCollaborationFeatures({dispatch:e,getters:t,commit:r}){e("getCollaborationFeature",{feature:"whiteboard",mutationMethod:"changeWhiteboardFeature",uwp:"app.swymfeature.activateWBCollab"}),e("getCollaborationFeature",{feature:"telephony",mutationMethod:"changeTelephonyFeature",uwp:"app.swymfeature.activatePhoneCall"}),e("getCollaborationFeature",{feature:"3dplay",mutationMethod:"change3DPlayFeature",uwp:"app.swymfeature.activate3DPlay"}),e("getCollaborationFeature",{feature:"ode",mutationMethod:"changeOdeFeature",uwp:"app.swymfeature.activateODECollab"}).then(()=>{t.odeFeature&&require("DS/TopFrame/TopFrame")._loadModules(["DS/OfficeDocumentEditorClient/Editor"]).then(function(e){var s=e[0];s&&"function"==typeof s.isGranted&&s.isGranted({platformId:t.tenant}).then(()=>{i.Call("Editor activated and granted")}).catch(e=>{i.Call("Editor activated but not granted "+e),r("changeOdeFeature",!1)})})})},getCollaborationFeature({getters:e,dispatch:r,commit:s},{feature:a,mutationMethod:o,uwp:n}){if(UWA&&UWA.Utils&&UWA.Utils.getQueryString(document.URL,"activateCollab")||location&&location.href&&location.href.contains("activateCollab"))return s(o,!0);if("3dprint"==e.appName)return s(o,!1);const l=t.getApplicationConfiguration(n);return""===l||"true"===l||!0===l?s(o,!0):"false"===l?s(o,!1):void 0!==l?r("isUserInUserGroup",l).then(()=>{i.Call("Usergroup activation of feature "+a),s(o,!0)}).catch(e=>{i.Call("Usergroup deactivation of feature "+a+" : "+e),s(o,!1)}):void 0},isUserInUserGroup({getters:t},s){const a=t.tenant.toUpperCase(),o=t.myself.username;return new Promise((t,n)=>{e.getServiceUrl({serviceName:"3DSearch",platformId:a,onComplete:function(e){if(!e)return i.Call("Can't check usergroup without searchUrl"),n();r.authenticatedRequest(e+"/search",{method:"POST",type:"json",headers:{"Content-Type":"application/json"},data:JSON.stringify({with_synthesis_hierarchical:!1,with_synthesis:!1,with_synthesis_attribute:!1,source:["usersgroup"],query:'[ds6w:label]:"'+s+'"',select_predicate:["ds6w:hasMember","ds6w:responsible"],label:"bot",tenant:a}),onComplete:function(e){var r=[];return e&&e.results?(e.results.forEach(function(e){r=r.concat(e.attributes)}),r.filter(function(e){return"ds6w:hasMember"===e.name&&e.value===o||"ds6w:responsible"===e.name&&e.value===o}).length>0?t():n("not in usergroup")):n()},onFailure:function(t){return i.Call("AuthenticatedRequest on "+e+"/search failed : "+t),n("request to "+e+" failed")}})},onFailure:function(){return n("request to i3DXCompassPlatformServices failed")}})})}}}}),define("DS/InstantMessagingCall/components/TelephonyItem/TelephonyItem",["text!DS/InstantMessagingCall/components/TelephonyItem/TelephonyItem.html"],function(e){"use strict";return{props:[],data:()=>({srcObject:null}),methods:{onloadeddata(e){this.play()}},computed:{src(){var e=this.$store.getters.mediaSource;if(!e)return null;try{return window.URL.createObjectURL(e)}catch(e){return console.error("TelephonyItem unable to compute src from stream "+e),null}}},template:e}}),define("DS/InstantMessagingCall/components/VideoItem/VideoItem",["text!DS/InstantMessagingCall/components/VideoItem/VideoItem.html"],function(e){"use strict";return{props:["stream","user_id","isSpeakerView","isAudioMuted","isVideoMuted","track_id","muted","isSelfView"],data:()=>({srcObject:null}),computed:{video_track_id(){var e=this.stream&&this.stream.getVideoTracks();if(e&&e.length)return this.stream.getVideoTracks()[0].id},src(){try{try{return window.URL.createObjectURL(this.stream)}catch(e){return this.srcObject=this.stream,null}}catch(e){return console.error("VideoItem unable to compute src from stream "+e),null}}},methods:{toggleSpeaker(){if(!this.$store.getters.clickOnVideo)return!0;this.isSpeakerView?this.$store.dispatch("removeSpeaker",{user_id:this.user_id}):this.$store.dispatch("setAsSpeaker",{user_id:this.user_id,track_id:this.video_track_id})}},template:e}}),define("DS/InstantMessagingCall/components/CustomType/CustomType",["text!DS/InstantMessagingCall/components/CustomType/CustomType.html"],function(e){"use strict";return{props:["logins","isVideoMinimizeView"],computed:{users(){return this.logins&&0!=this.logins.length?this.logins.length>4?this.logins.slice(0,3):this.logins:[]},notDisplayed(){return this.logins&&0!=this.logins.length?this.logins.length<=4?0:this.logins.length-3:0}},template:e}}),define("DS/InstantMessagingCall/components/SpeakerName/SpeakerName",["text!DS/InstantMessagingCall/components/SpeakerName/SpeakerName.html"],function(e){"use strict";return{props:["user_id"],computed:{username(){return this.$store.getters.user(this.user_id).username}},template:e}}),define("DS/InstantMessagingCall/components/CollabConfetti/CollabConfetti",["text!DS/InstantMessagingCall/components/CollabConfetti/CollabConfetti.html"],function(e){"use strict";return{props:["featureData","masterUser","feature","active"],computed:{masterUsername(){return this.active?this.masterUser&&this.masterUser.username:null},IAmMaster(){return!!this.active&&(this.masterUser&&this.masterUser.login==this.$store.getters.myself.login)}},methods:{genId:function(e,t){return"confetti"+e+"-"+t},sendConfetti:function(e,t){this.IAmMaster&&!this.feature.featureData.confettis[this.genId(e,t)]&&this.$store.dispatch("send_confetti",{spanId:this.genId(e,t),feature:this.feature})}},template:e}}),define("DS/InstantMessagingCall/components/MemberItem/MemberItem",["text!DS/InstantMessagingCall/components/MemberItem/MemberItem.html"],function(e){"use strict";return{props:["user","hasJoined"],computed:{username(){return this.user.username},login(){return this.user.login},isAudioStreamer(){return this.user.stream_info.isAudioStreamer},isVideoStreamer(){return this.user.stream_info.isVideoStreamer},isAudioMuted(){return this.user.stream_info.isAudioStreamerMuted},isVideoMuted(){return this.user.stream_info.isVideoStreamerMuted},isScreenStreamer(){return this.user.stream_info.isScreenStreamer},mustBeVisible(){return this.hasJoined?(console.log("USER",this.user),this.user.user_id==this.$store.getters.myself.user_id||this.$store.getters.accepters.indexOf(this.user.user_id)>-1):this.user.user_id!=this.$store.getters.myself.user_id&&!(this.$store.getters.accepters.indexOf(this.user.user_id)>-1)}},template:e}}),require.config({paths:{vuejs:window.dsDefaultWebappsBaseUrl+"vuejs/2.6.10/vue.min",vuex:window.dsDefaultWebappsBaseUrl+"vuex/3.1.1/vuex.min","vu-kit":window.dsDefaultWebappsBaseUrl+"vuekit/vu-kit.umd.min"}}),define("DS/InstantMessagingCall/InstantMessagingCall",["vuejs","vu-kit","vuex","DS/RTVueUserPresenceAPI/RTVueUserPresenceAPI","DS/RTDialer/RTDialer","css!vuekit/vu-kit"],function(e,t,r,i,s){"use strict";return e.use(t),e.use(r),{init(e){require(["DS/InstantMessagingCall/main"],function(t){t.init(e)})}}}),define("DS/InstantMessagingCall/store/modules/tracker",["DS/RTProxyDriver/RTLogger","DS/Usage/TrackerAPI","DS/InstantMessagingWebRTC/js/model/RTCallingTracker"],function(e,t,r){"use strict";const i={NotFoundError:"localMediaError_NotFoundError",SecurityError:"localMediaError_SecurityError",AbortError:"localMediaError_AbortError",NotAllowedError:"localMediaError_NotAllowedError",NotReadableError:"localMediaError_NotReadableError",OverConstrainedError:"localMediaError_OverConstrainedError",TypeError:"localMediaError_TypeError",TrackStartError:"localMediaError_NotReadableError",PermissionDeniedError:"localMediaError_NotAllowedError",InvalidStateError:"localMediaError_NotReadableError",DevicesNotFoundError:"localMediaError_NotFoundError",ConstraintNotSatisfiedError:"localMediaError_OverConstrainedError",MediaDeviceFailedDueToShutdown:"localMediaError_NotReadableError",MediaDeviceKillSwitchOn:"localMediaError_NotReadableError",InternalError:"localMediaError_NotReadableError",NotSupportedError:"localMediaError_TypeError"};return{state:{callTracker:null,date_start:0},getters:{callTracker:e=>e.callTracker},mutations:{newTracker(e,{logins:t,caller:i,swymUrl:s,type:a,dmId:o}){e.callTracker&&e.callTracker.destroy(),e.callTracker=new r({caller:i,logins:t,swymBaseUrl:s,type:a,dmId:o})},destroyTracker(e){e.callTracker&&e.callTracker.destroy(),e.callTracker=null}},actions:{offlineStartCallTracking({dispatch:e,getters:t},{logins:r,login:i,dmId:s}){e("startTracking",{logins:r||i,dmId:s}),e("tracking",{action:"ended",login:t.myself.login,reason:"offline"}),e("stopTracking",{dontSendSwymReport:!0})},startTracking({commit:e,getters:t},{logins:r,type:i,dmId:s}){if(!r&&!t.accepted_room)return console.error("Can not start Call Analytics without callees");e("newTracker",{caller:t.myself.login,logins:r||t.accepted_room.calledUsers,swymUrl:t.swymUrl,type:i,dmId:s})},stopTracking({getters:e,commit:t},{dontSendSwymReport:r}){e.callTracker&&e.callTracker.endCall(r),t("destroyTracker")},tracking({getters:t},{action:r,login:s,user_id:a,reason:o,kind:n}){if(!t.callTracker)return!0;if(!s&&a)s=t.user(a).login;switch(r){case"ended":t.callTracker.logEnded(s,o);break;case"getLocalMediaFailed":t.callTracker.logEnded(s,i[o]||o);break;case"stream":t.callTracker.logStream(s);break;case"inviteSent":t.callTracker.logInviteSent();break;case"accepted":t.callTracker.logAccepted(s);break;default:e.error("unknown tracking action "+r)}},track_event({getters:r},{action:i,eventValue:s,dimensions:a,values:o}){if(!i)return e.Call("track_event called without action");if(r.isDevEnv)return e.Call("track_event "+i+" bypassed");const n=r.myself.user_id,l=r.accepted_room&&r.accepted_room.room_id||[],c=r.accepted_room&&r.accepted_room.calledUsers||[],d=r.accepters||[],u=r.refusers||[];var m={appID:"X3DIMSG_AP",eventCategory:"collabexperience",eventAction:i,eventLabel:"3DMessaging collab event "+i,eventValue:"number"==typeof s?s:null,persDim:{pd1:n,pd2:l},persVal:{pv1:c.length,pv2:d.length,pv3:u.length},callback:t=>{e.Call("Analytics event sent. "+(t||""))}};if(a){var p=Object.keys(m.persDim).length;const e="string"==typeof a?[a]:a;for(let t of e)"string"==typeof t&&(m.persDim["pd"+ ++p]=t.toLowerCase())}if(o){var h=Object.keys(m.persVal).length;const e="number"==typeof o?[o]:o;for(let t of e)"number"==typeof t&&(m.persVal["pv"+ ++h]=t)}try{e.Call("Analytics event : "+JSON.stringify(m)),t.trackPageEvent(m)}catch(t){e.error("Analytics event request failed : "+t)}}}}}),define("DS/InstantMessagingCall/components/UserItem/UserItem",["text!DS/InstantMessagingCall/components/UserItem/UserItem.html","DS/InstantMessagingCall/components/VideoItem/VideoItem","DS/InstantMessagingCall/components/TelephonyItem/TelephonyItem"],function(e,t,r){"use strict";return{components:{"im-call-video-item":t,"im-tel-video-item":r},props:["user_id","track_id","isSpeakerView","room","minimized"],data:()=>({streams:[],isScreen:!1,isAudio:!1}),computed:{isSip(){return this.$store.getters.sip},asMediasource(){return!!this.$store.getters.mediasource},user(){return this.$store.getters.user(this.user_id)},isSpeaker(){return this.$store.getters.speaker_id==this.user_id},isNotLarge(){return this.$store.getters.isAvatarNotLarge},isVideo(){var e=this.user.stream_info.isVideoStreamer,t=this.user.stream_info.isAudioStreamer,r=this.user.stream_info.isScreenStreamer,i=(e||t||r)&&this.$store.getters.streams(this.user_id,this.track_id);if(e&&r&&!this.track_id&&this.isSpeaker){var s=(a=i[0]).getVideoTracks();if(s&&s.length&&1!=s.length){var a=new MediaStream,o=i[0].getAudioTracks(),n=o&&o[0];n&&a.addTrack(n);for(let e of s)if("text"!==e.contentHint){a.addTrack(e);break}i=[a]}else i=[a]}else(e||r)&&this.track_id&&this.room&&(i[0].oninactive=(()=>{this.$store.dispatch("stopTrack",{kind:"screen",room_id:this.room.room_id})}));return this.streams=i,this.isScreen=r,this.isAudio=t,e},isVideoMuted(){return this.user.stream_info.isVideoStreamerMuted},isAudioMuted(){return this.user.stream_info.isAudioStreamerMuted},hasCollabExperience(){return this.$store.getters.hasFeature},showVideo(){return(this.isVideo&&!this.isVideoMuted||this.isScreen)&&(!!this.track_id||!this.track_id&&(!this.isSpeaker||this.isSpeaker&&this.isScreen&&this.isVideo&&!this.isVideoMuted))}},methods:{unlargeAvatar(){var e=this.$refs.userItemContainer,t=e&&e.offsetHeight<240;this.$store.commit("avatarNotLarge",t)}},updated(){this.unlargeAvatar()},created(){window.addEventListener("resize",this.unlargeAvatar)},destroyed(){window.removeEventListener("resize",this.unlargeAvatar)},template:e}}),define("DS/InstantMessagingCall/components/SelfView/SelfView",["text!DS/InstantMessagingCall/components/SelfView/SelfView.html","DS/InstantMessagingCall/components/VideoItem/VideoItem"],function(e,t){"use strict";return{props:["showSelfView","isInUserList"],components:{"im-call-video-item":t},data:()=>({streams:null,isSpeaker:!1}),computed:{isVideo(){var e=this.$store.getters.local_stream_info("video"),t=e&&"muted"!=e;if(this.streams)return t;var r=this.$store.getters.isLocalSpeaker,i=(t||r!=this.isSpeaker)&&this.$store.getters.local_track_of_kind("video");if(i){var s=new MediaStream;s.addTrack(i),this.streams=[s]}return this.isSpeaker=r,t},isLocalVideoMuted(){return"muted"==this.$store.getters.local_stream_info("video")},isLocalAudioMuted(){return"muted"==this.$store.getters.local_stream_info("audio")},user_id(){return this.$store.getters.myself.user_id},username(){return this.$store.getters.myself.username}},methods:{minimize(){this.$store.commit("hideSelfView")}},destroyed(){this.streams=null},deactivated(){this.streams=null},mounted(){var e=this,t=document.getElementById("im-call-lightbox");new MutationObserver(function(){if("none"==t.style.display&&!e.$store.getters.isAccepted){if(!e.streams)return;for(let t=0;t<e.streams.length;t++)e.streams[t].getTracks().forEach(e=>e.stop());e.streams=null}}).observe(t,{attributes:!0,childList:!0})},template:e}}),define("DS/InstantMessagingCall/components/VideoMinimize/VideoMinimize",["text!DS/InstantMessagingCall/components/VideoMinimize/VideoMinimize.html","DS/InstantMessagingCall/components/CustomType/CustomType"],function(e,t){"use strict";return{props:["logins"],components:{"im-call-custom-type":t},template:e}}),define("DS/InstantMessagingCall/components/ActionBar/ActionBar",["text!DS/InstantMessagingCall/components/ActionBar/ActionBar.html","DS/InstantMessagingCall/components/ActionBarItem/ActionBarItem","DS/WAFData/WAFData","DS/UIKIT/SuperModal","DS/InstantMessagingCall/assets/CollabOfficeTemplates"],function(e,t,r,i,s){"use strict";return{components:{"im-call-bar-item":t},props:["room","showSelfView","showUserList","hasFeature","hasSpeaker","isWhiteboard","isODE","isTelephonySupported","isConfetti","is3DPlay"],data(){return{document:document,durationInterval:null,duration:0,ODEitems:[{text:this.$store.getters.nls("createDocument"),fonticon:"doc-text",handler:e=>this.activeODE("docx")},{text:this.$store.getters.nls("createPresentation"),fonticon:"presentation-slide-layout",handler:e=>this.activeODE("pptx")},{text:this.$store.getters.nls("createSpreadsheet"),fonticon:"table",handler:e=>this.activeODE("xlsx")}],window:window}},computed:{isConfettiSupported(){return!this.isSip&&this.$store.state.call.confettiAvailable},isODESupported(){return!this.isSip&&this.$store.getters.isAccepted&&this.$store.getters.odeFeature},isWhiteboardSupported(){return!this.isSip&&this.$store.getters.whiteboardFeature},is3DPlaySupported(){return!this.isSip&&this.$store.getters.troisdplayFeature},isSpeaker(){return!!this.$store.getters.speaker_id},isLocalVideo(){return!!this.$store.getters.local_stream_info("video")},isLocalVideoMuted(){return"muted"==this.$store.getters.local_stream_info("video")},isLocalAudio(){return!!this.$store.getters.local_stream_info("audio")},isLocalAudioMuted(){return"muted"==this.$store.getters.local_stream_info("audio")},isLocalScreen(){return!!this.$store.getters.local_stream_info("screen")},isLocalScreenMuted(){return"muted"==this.$store.getters.local_stream_info("screen")},isSip(){return!!this.$store.getters.sip},date_start(){var e=this.$store.getters.date_start;return e?this.durationInterval=setInterval(()=>{this.duration=Date.now()-e},1e3):this.durationInterval&&(clearInterval(this.durationInterval),this.durationInterval=null),e},durationString(){var e=Math.floor(this.duration/1e3),t=Math.floor(e/3600),r=(e-=3600*t)%60;r<10&&(r="0"+r);var i=Math.floor(e/60);return i<10&&(i="0"+i),(t?t+":":"")+i+":"+r},isLocalScreenDisplayed(){return this.isLocalScreen&&!this.isLocalScreenMuted},isScreenDisplayed(){return this.hasSpeaker&&this.runningScreenSharingFeature&&"screen"===this.$store.getters.speaker_kind},screenSharingDisabled(){return!this.$store.getters.screenSharingAvailable||this.hasFeature},collabDisabled(){return this.isSpeaker||this.hasFeature||this.isLocalScreenDisplayed},isDialerON(){return!!this.$store.getters.showDialer},runningConfettiFeature(){return this.$store.getters.getFeatureOfKind("confetti")},running3DPlayFeature(){return this.$store.getters.getFeatureOfKind("3dplay")},runningWhiteboardFeature(){return this.$store.getters.getFeatureOfKind("whiteboard")},runningODEFeature(){return this.$store.getters.getFeatureOfKind("ode")},runningScreenSharingFeature(){return"screen"===this.$store.getters.call_speaker_kind}},methods:{endCall(){this.isLocalScreenDisplayed&&this.stopTrack("screen"),this.track_event(["handset",this.$store.getters.isAccepted],0),this.$store.dispatch("endCall",this.room)},acceptCall(){this.track_event(["handset"],1),this.$store.dispatch("acceptCall",this.room)},activeTrack(e){this.$store.dispatch("activeTrack",{kind:e,room_id:this.room.room_id}),this.track_event(["track",e],1)},muteTrack(e){this.$store.dispatch("muteTrack",{kind:e,room_id:this.room.room_id}),this.track_event(["track",e],0)},stopTrack(e){this.$store.dispatch("stopTrack",{kind:e,room_id:this.room.room_id}),this.track_event(["track",e],0)},volumeOFF(e){this.$store.commit("volume",!e),this.track_event(["track","volume"],e?0:1)},displayDialer(){this.$store.commit("showDialer")},hideDialer(){this.$store.commit("hideDialer")},stopFeatures(e){this.$store.dispatch("stopFeatures",{room_id:this.room.room_id}),this.track_event(["feature",e],0)},activeODE(e){if(this.runningODEFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.runningODEFeature});if(e){var t=this;new i({closable:!0,renderTo:this.document.body}).prompt({title:this.$store.getters.nls("new"+s.extensionsFormat[e].name),message:this.$store.getters.nls("enterAFileName"),required:!0,placeholder:this.$store.getters.nls("fileName"),callback:function(r){r?t.onConfirm(r,e):console.log("Prompt dismissed")}})}},onConfirm(e,t){if(e&&t){var r=e,i=this.$store.getters.accepted_room&&this.$store.getters.accepted_room.options&&this.$store.getters.accepted_room.options.dmId,s=e+"."+t,a=this;this.addmedia(i,r,s,t,function(i,s){i&&s?(console.log("Add OK : mediaId: "+i+", title: "+e),a.$store.dispatch("newODE",{room_id:a.room.room_id,title:r,ext:t,media_id:i,url:s})):console.log("Error no mediaId or url define")}),this.track_event(["feature","ode",t],1)}},addmedia(e,t,i,a,o){if((n=this.$store.getters.swymUrl)&&e&&t&&i&&a&&o){var n=this.$store.getters.swymUrl,l=this.$store.getters.tenant,c=this;require("DS/TopFrame/TopFrame")._loadModules(["DS/OfficeDocumentEditorClient/Editor"]).then(function(d){var u=d[0];u&&u.getDocumentTemplatesURL({platformId:l}).then(l=>{if(l&&l[a]){var d=l[a];if(!d)return console.log("Failed to get ODE template"),o();r.request(d,{responseType:"blob",onComplete:function(l){if(!l)return console.log("Failed to get ODE template"),o();!function(e,t,r){if(s.extensionsFormat[e]){var i=new Blob([t],{type:s.extensionsFormat[e].format});i&&r(i)}else console.error("Error loading CollabOfficeTemplates of extension "+e)}(a,l,function(s){var a=new FormData;a.append("is_illustration",!1),a.append("community_id",e),a.append("title",t),a.append("media_type","document"),a.append("published",!0),a.append("fileName",i),a.append("userFile",s,i),c.getCSRFswym(function(e){e&&r.authenticatedRequest(n+"/api/media/addmedia",{method:"POST",headers:{"X-DS-SWYM-CSRFTOKEN":e},data:a,onComplete:function(e){if(e)try{var t=(e=JSON.parse(e)).result.id_media;o(t,d)}catch(e){console.log("Failed to add media"),o()}},onFailure:function(e){console.log("Failed to add media"),o()}})})})},onFailure:function(e){console.log("Failed to get template"),o()}})}else console.log("Failed to get template")})})}},getMedia(e,t,i){var s=this.$store.getters.swymUrl,a={params:{id_media:e,detailedInfos:!0}};r.authenticatedRequest(s+"/api/media/getmedia",{method:"POST",type:"json",headers:{"Content-Type":"application/json","X-DS-SWYM-CSRFTOKEN":t},data:JSON.stringify(a),onComplete:function(e){e&&e.result&&e.result.play&&e.result.play.download_original_url&&e.result.play.download_original_url.transient_url_as_attachment||i();var t=e.result.play.download_original_url.transient_url_as_attachment;i(t)},onFailure:function(e){console.log("Failed to get media"),i()}})},getCSRFswym(e){var t=this.$store.getters.swymUrl;r.authenticatedRequest(t+"/api/index/tk",{method:"GET",type:"json",onComplete:function(t){t||e();try{var r=t.result.ServerToken;e(r)}catch(t){console.log("Failed to resolve CSRF Token "+t),e()}},onFailure:function(t){console.log("Failed to get CSRF Token "+t),e()}})},joinODE(){if(this.runningODEFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.runningODEFeature});console.error("Can not join unexisting ODE")},activeWhiteboard(){if(this.runningWhiteboardFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.runningWhiteboardFeature});this.$store.dispatch("newWhiteboard",{room_id:this.room.room_id}),this.track_event(["feature","whiteboard"],1)},activeConfetti(){if(this.runningConfettiFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.runningConfettiFeature});this.$store.dispatch("newConfetti",{room_id:this.room.room_id})},active3DPlay(){if(this.running3DPlayFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.running3DPlayFeature});this.$store.dispatch("new3DPlay",{room_id:this.room.room_id})},track_event(e,t){this.$store.dispatch("track_event",{action:"actionBar",dimensions:e,eventValue:t})},removeSpeaker(){this.$store.dispatch("removeSpeaker",{user_id:this.$store.getters.speaker_id})},switchToCallSpeaker(){this.$store.dispatch("switchToCallSpeaker")}},template:e}}),define("DS/InstantMessagingCall/store/modules/feature",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingCall/api/senders","DS/SwymUICore/script/feature/community/media/model/media-model","vuejs"],function(e,t,r,i){"use strict";return{state:Object.assign({},{currentFeatureId:null,features:{}}),mutations:{resetFeatureState(e){Object.assign(e,{currentFeatureId:null,features:{}})},setMaster(e,{featureId:t,user_id:r}){e.features[t]&&i.set(e.features[t],"master",r)},featureMembers(e,{featureId:t,featureMembers:r}){e.features[t]&&i.set(e.features[t],"members",r)},featureEnded(e,{featureId:t}){},feature(e,{featureKind:t,room_id:r,featureId:s,featureData:a,master:o}){e.features[s]||i.set(e.features,s,{featureKind:t,featureId:s,featureData:a,room_id:r,master:o})},currentFeatureId(e,t){e.currentFeatureId=t},confetti:(e,{spanId:t,user_id:r,featureId:s})=>{i.set(e.features[s].featureData.confettis,t,r)},coreview_3DPlay_data:(e,{actions:t,featureId:r})=>{if(!e.features[r])return console.error("Received 3DPlay coreview data but the feature is not loaded "+r);i.set(e.features[r].featureData,"actions",t)}},getters:{hasFeature:e=>!!e.currentFeatureId,feature:e=>t=>e.features[t],currentFeatureId:e=>e.currentFeatureId,currentFeature:(e,t)=>!!t.currentFeatureId&&t.feature(t.currentFeatureId),isODE:e=>e=>"ode"==e.featureKind,isWhiteboard:e=>e=>"whiteboard"==e.featureKind,isConfetti:e=>e=>"confetti"==e.featureKind,is3DPlay:e=>e=>"3dplay"==e.featureKind,isMaster:(e,t)=>e=>e.master==t.myself.user_id,getFeatureOfKind:(e,t)=>r=>{for(let i in e.features){let s=e.features[i];if(s.featureKind==r&&t.is_accepted_room(s.room_id))return s}return null}},actions:{activateFeature({commit:t,dispatch:r,getters:i},s){if(!s.featureKind||!s.featureId||!s.featureData)return e.error("Can not init feature "+JSON.stringify(s));s.master=i.myself.user_id,t("feature",s),r("switchToFeature",{room_id:s.room_id,featureInfo:s}),r("sendCurrentFeature")},stopFeatures({dispatch:e},{room_id:t}){e("switchToFeature",{room_id:t})},newODE({dispatch:e,getters:t},{room_id:r,title:i,ext:s,media_id:a,url:o}){e("activateFeature",{room_id:r,featureKind:"ode",featureId:Date.now(),featureData:{mediaId:a,title:i,ext:s,url:o}})},newConfetti({dispatch:e},{room_id:t}){e("activateFeature",{room_id:t,featureKind:"confetti",featureId:Date.now(),featureData:{confettis:{}}})},new3DPlay({dispatch:e,getters:t},{room_id:r}){e("activateFeature",{room_id:r,featureKind:"3dplay",featureId:Date.now(),featureData:{fileName:"RadialEngine.3dxml",mime:"3dxml",path:t.assets_url+"RadialEngine.3dxml",actions:{}}})},newWhiteboard({dispatch:t,getters:i},{room_id:s}){var a=i.accepted_room&&i.accepted_room.options&&i.accepted_room.options.dmId;if(a){var o=new r;o.set("play",{}),o.set("community",{community_type:"dm",id:a}),t("activateFeature",{room_id:s,featureKind:"whiteboard",featureId:Date.now(),featureData:{model:o,whiteboard:!0,title:"New whiteboard",coreview:{action:"initCoreview",room_id:s,noCall:!0,collabExperienceOrigin:!0,logins:i.called_users_logins,threadType:"dm",threadId:a,data:{communityId:a,logins:i.called_users_logins,mediaId:"0000",room_id:s}}}})}else e.error("New whiteboard dmId is undefined")},sendCurrentFeature({dispatch:e,getters:t}){var r=t.currentFeature;r&&e("sendFeature",r)},switchToFeature({getters:e,commit:r},{featureInfo:i,room_id:s}){r("currentFeatureId",i&&i.featureId);var a=s||i&&i.room_id;t.callEventFromView({action:"switchToFeature",room_id:a,user_id:e.myself.user_id,featureInfo:i,featureId:i&&i.featureId})},sendFeature({getters:r},i){i?t.callEventFromView({action:"feature",room_id:i.room_id,user_id:r.myself.user_id,featureInfo:i}):e.error("no featureInfo in sendFeature")},setMaster({getters:e,commit:r},i){r("setMaster",{user_id:user_id,featureId:i.featureId}),t.callEventFromView({action:"masterChanged",room_id:i.room_id,user_id:e.myself.user_id,featureInfo:i,featureId:i.featureId})},received_feature({commit:e,getters:t,dispatch:r},{user_id:i,featureInfo:s,room_id:a,type:o}){s.room_id=a,s.master=i,s.featureData.coreview&&(s.featureData.coreview.action="acceptCoreview",s.featureData.coreview.room_id=a),s.featureData.coreviewData,e("feature",s),!t.hasFeature&&t.is_accepted_room(a)&&r("switchToFeature",{featureInfo:s,room_id:a})},invited_feature({dispatch:e},{type:t,featureData:r,room_id:i}){"3dplay"==t&&(r.fileName="Collab3DPlay",r.mime=r.fileExt,r.path=r.fileUrl,r.actions={}),e("activateFeature",{featureData:r,featureId:Date.now(),featureKind:"ode"==t||"whiteboard"==t||"3dplay"==t?t:null,room_id:i})},masterChanged({commit:e},{user_id:t,featureId:r}){e("setMaster",{user_id:t,featureId:r})},featureMembers({commit:e},{user_id:t,featureId:r,featureMembers:i}){e("featureMembers",{user_id:t,featureId:r,featureMembers:i})},featureEnded({commit:e},{user_id:t,featureId:r}){e("featureMembers",{user_id:t,featureId:r,featureMembers:null}),e("featureEnded",{user_id:t,featureId:r})},received_confetti({commit:e},{featureData:t,featureId:r,user_id:i,room_id:s}){e("confetti",{spanId:t.spanId,user_id:i,featureId:r})},send_confetti({getters:e,commit:r},{spanId:i,feature:s}){r("confetti",{spanId:i,user_id:e.myself.user_id,featureId:s.featureId}),t.callEventFromView({action:"confetti",room_id:s.room_id,user_id:e.myself.user_id,featureId:s.featureId,featureData:{spanId:i}}),t.callEventFromView({action:"nextMaster",room_id:s.room_id,user_id:e.myself.user_id,featureId:s.featureId})},received_3DPlay_data({getters:e,commit:t},{room_id:r,actions:i,featureData:s,featureId:a}){t("coreview_3DPlay_data",{featureId:a,actions:i})},send_3DPlay_data({getters:e,commit:r},{room_id:i,actions:s,featureData:a,featureId:o}){t.callEventFromView({action:"3DPlayData",room_id:i,user_id:e.myself.user_id,featureId:o,featureData:a,actions:s})}}}}),define("DS/InstantMessagingCall/store/modules/users",["DS/RTProxyDriver/RTLogger","vuejs","DS/InstantMessagingCall/api/senders"],function(e,t,r){"use strict";return{state:{users:{},accepters:[],refusers:[],video_streamers:[],screen_streamers:[],audio_streamers:[],speaker:null,speaker_track_id:null,speaker_kind:null,call_speaker:null,call_speaker_kind:null,call_speaker_track_id:null,isLocalSpeaker:!1,media_id:null,local_audio:!1,local_video:!1,local_screen:!1,avatarNotLarge:!1,showUserList:!0},getters:{isAvatarNotLarge:e=>e.avatarNotLarge,isTheSpeaker:e=>t=>e.call_speaker==t,accepters:e=>e.accepters,refusers:e=>e.refusers,accepters_name:e=>{var t=[];for(let r of e.accepters)t.push(e.users[r].username);return t},user:e=>t=>e.users[t],speaker_id:e=>e.speaker,speaker_track_id:e=>e.speaker_track_id,speaker_kind:e=>e.speaker_kind,call_speaker_id:e=>e.call_speaker,call_speaker_kind:e=>e.call_speaker_kind,call_speaker_track_id:e=>e.call_speaker_track_id,local_stream_info:e=>t=>e["local_"+t],called_users:(e,t)=>{var r=[];if(!t.accepted_room||!t.accepted_room.calledUsers||!t.accepted_room.calledUsers.length)return r;for(let e of t.accepted_room.calledUsers)r.push(t.user(e.user_id));return r},called_users_logins:(e,t)=>{var r=[];return t.called_users.forEach(e=>e&&e.login&&r.push(e.login)),r},isLocalSpeaker:e=>e.isLocalSpeaker,login:e=>t=>e.users[t]&&e.users[t].login,logins_except_myself:(e,t)=>{var r=[];for(let e of t.called_users)e.user_id!=t.myself.user_id&&r.push(e.login);return r},showUserList:e=>e.showUserList},mutations:{avatarNotLarge(e,t){e.avatarNotLarge=t},resetUsersState(e){Object.assign(e,{users:{},accepters:[],refusers:[],video_streamers:[],screen_streamers:[],audio_streamers:[],speaker:null,speaker_track_id:null,speaker_kind:null,call_speaker:null,call_speaker_kind:null,call_speaker_track_id:null,isLocalSpeaker:!1,media_id:null,local_audio:!1,local_video:!1,local_screen:!1,avatarNotLarge:!1,showUserList:!0})},isLocalSpeaker(e,t){e.isLocalSpeaker=t},user(e,r){e.users[r.user_id]||(e.users[r.user_id]=r,e.users[r.user_id].stream_info=t.observable({isAudioStreamer:!1,isAudioStreamerMuted:!1,isVideoStreamer:!1,isVideoStreamerMuted:!1,isScreenStreamer:!1,track_id_screen:null,track_id_audio:null,track_id_video:null}))},accepter(e,t){var r=e.refusers.indexOf(t);-1!=r&&e.refusers.splice(r,1),-1==e.accepters.indexOf(t)&&e.accepters.push(t)},refuser(e,t){var r=e.accepters.indexOf(t);-1!=r&&e.accepters.splice(r,1),-1==e.refusers.indexOf(t)&&e.refusers.push(t)},received_track_video(e,{user_id:t,track_id:r}){e.users[t].stream_info.isVideoStreamer=!1,e.users[t].stream_info.isVideoStreamer=!0,e.users[t].stream_info.track_id_video=r,-1==e.video_streamers.indexOf(t)&&e.video_streamers.push(t)},received_track_screen(e,{user_id:t}){e.users[t].stream_info.isScreenStreamer=!0,-1==e.screen_streamers.indexOf(t)&&e.screen_streamers.push(t)},remove_track_screen(e,{user_id:t}){e.users[t].stream_info.isScreenStreamer=!1;var r=e.screen_streamers.indexOf(t);-1!=r&&e.screen_streamers.splice(r,1)},received_track_audio(e,{user_id:t,track_id:r}){e.users[t].stream_info.isAudioStreamer=!1,e.users[t].stream_info.isAudioStreamer=!0,e.users[t].stream_info.track_id_audio=r,-1==e.audio_streamers.indexOf(t)&&e.audio_streamers.push(t)},remove_track_audio(e,{user_id:t}){e.users[t].stream_info.isAudioStreamer=!1;var r=e.audio_streamers.indexOf(t);-1!=r&&e.audio_streamers.splice(r,1)},remove_track_video(e,{user_id:t}){e.users[t].stream_info.isVideoStreamer=!1;var r=e.video_streamers.indexOf(t);-1!=r&&e.video_streamers.splice(r,1)},local_stream_info(e,{kind:t,muted:r,loaded:i,user_id:s}){e["local_"+t]=r?"muted":i,"audio"==t?e.users[s].stream_info.isAudioStreamerMuted=!1!==r:"video"==t&&(e.users[s].stream_info.isVideoStreamerMuted=!1!==r)},stream_muted(e,{kind:t,user_id:r,muted:i}){"audio"==t?e.users[r].stream_info.isAudioStreamerMuted=i:"video"==t&&(e.users[r].stream_info.isVideoStreamerMuted=i)},call_speaker(e,{user_id:t,speaker_track_id:r,kind:i}){e.call_speaker=t,e.call_speaker_kind=i,e.call_speaker_track_id=r},speaker(e,{user_id:t,speaker_track_id:r,kind:i}){e.speaker_track_id=r,e.speaker=t,e.speaker_kind=i},track_stopped(t,{user_id:r,track_id:i,kind:s}){switch(s){case"screen":t.users[r].stream_info.isScreenStreamer=!1,t.showUserList=!0,t.speaker==r&&(t.speaker=null,t.speaker_track_id=null,t.speaker_kind=null),t.call_speaker==r&&(t.call_speaker=null,t.call_speaker_id=null,t.call_speaker_kind=null);break;default:e.Call("stop track "+s+" but feature not implemented")}},showUserList:(e,t)=>{e.showUserList=t}},actions:{setPresence({dispatch:e},t){r.presence(t)},setAsSpeaker({commit:e,getters:t},{user_id:r,track_id:i,firstSpeaker:s,kind:a}){e("speaker",{user_id:r,speaker_track_id:i,kind:a})},switchToCallSpeaker({dispatch:e,getters:t}){e("setAsSpeaker",{user_id:t.call_speaker_id,track_id:t.call_speaker_track_id,kind:t.call_speaker_kind})},removeSpeaker({commit:e,getters:t},{user_id:r}){e("speaker",{user_id:null,speaker_track_id:null}),r==t.myself.user_id&&e("isLocalSpeaker",!1)}}}}),define("DS/InstantMessagingCall/components/UserCircleList/UserCircleList",["text!DS/InstantMessagingCall/components/UserCircleList/UserCircleList.html","DS/InstantMessagingCall/components/VideoMinimize/VideoMinimize"],function(e,t){"use strict";return{components:{"im-call-video-minimize":t},props:["users","myLogin","showSelfView"],computed:{},methods:{displaySelfView(){this.$store.commit("showSelfView")}},template:e}}),define("DS/InstantMessagingCall/components/UserVideoList/UserVideoList",["text!DS/InstantMessagingCall/components/UserVideoList/UserVideoList.html","DS/InstantMessagingCall/components/UserItem/UserItem"],function(e,t){"use strict";return{data:()=>({startIndex:0}),components:{"im-call-user-item":t},props:["users","videoDisplayNumber"],computed:{maxVideoNumber(){return this.videoDisplayNumber||6},endIndex(){return this.startIndex+this.maxVideoNumber},isScrollable(){return this.users.length>this.maxVideoNumber},isScrollableUp(){return this.isScrollable&&this.startIndex>0},isScrollableDown(){return this.isScrollable&&this.endIndex<this.users.length}},methods:{scrollUp(){this.startIndex=this.startIndex-1>0?this.startIndex-1:0},scrollDown(){this.startIndex=this.endIndex<this.users.length?this.startIndex+1:this.startIndex},isVisible(e){return this.startIndex<=e&&e<this.endIndex}},template:e}}),define("DS/InstantMessagingCall/components/UserList/UserList",["text!DS/InstantMessagingCall/components/UserList/UserList.html","DS/InstantMessagingCall/components/UserItem/UserItem","DS/InstantMessagingCall/components/SelfView/SelfView","DS/UIKIT/Scroller"],function(e,t,r,i){"use strict";return{data:()=>({startIndex:0}),components:{"im-call-user-item":t,"im-call-self":r},props:["hasSpeaker","showSelfView","minimized"],computed:{users(){return this.$store.getters.accepters},isScrollable(){return this.users&&this.users.length>6},isScrollableUp(){return this.isScrollable&&this.startIndex>0},isScrollableDown(){return this.isScrollable&&this.startIndex<this.users.length-6},isLightboxMinimized(){return this.sizeWH(),this.minimized}},methods:{scrollUp(){this.startIndex=0>this.startIndex-6?0:this.startIndex-6},scrollDown(){this.startIndex=this.users.length-6<this.startIndex+6?this.users.length-6:this.startIndex+6},canBeShown(e){return this.startIndex<=e&&e<this.startIndex+6},minimize(){this.$store.commit("showUserList",!1)},sizeWH(){var e,t,r,i,s,a,o=this.$refs["useritems-container"],n=o.offsetHeight,l=o.offsetWidth,c=o.childElementCount;if(this.hasSpeaker)t=1,i=l,a=r=(n-88)/(e=6),s=r*(16/9);else{switch(!0){case 1==c:t=1,e=1;break;case 2==c:t=2,e=1;break;case c<4||4==c:t=2,e=2;break;case c<6||6==c:t=3,e=2;break;case c<9||9==c:e=3,t=3;break;case c<12||12==c:t=4,e=3;break;case c<16||16==c:e=4,t=4}a=(s=(i=l/t)/(16/9)>(r=n/e)?r*(16/9):i)/(16/9)}for(var d=0;d<o.children.length;d++)o.children[d].style.height=a-5+"px",o.children[d].style.width=s-5+"px"}},updated(){this.sizeWH()},created(){window.addEventListener("resize",this.sizeWH)},destroyed(){window.removeEventListener("resize",this.sizeWH)},template:e}}),define("DS/InstantMessagingCall/components/MemberList/MemberList",["text!DS/InstantMessagingCall/components/MemberList/MemberList.html","DS/InstantMessagingCall/components/MemberItem/MemberItem"],function(e,t){"use strict";return{props:["members"],components:{"im-call-member-item":t},computed:{},methods:{},template:e}}),define("DS/InstantMessagingCall/components/PanelUsers/PanelUsers",["text!DS/InstantMessagingCall/components/PanelUsers/PanelUsers.html","DS/InstantMessagingCall/components/UserVideoList/UserVideoList","DS/InstantMessagingCall/components/UserCircleList/UserCircleList","DS/InstantMessagingCall/components/SelfView/SelfView"],function(e,t,r,i){"use strict";return{components:{"im-call-user-video-list":t,"im-call-user-circle-list":r,"im-call-self":i},props:["showSelfView","myLogin"],computed:{users(){return this.$store.getters.accepters.map(e=>this.$store.getters.user(e))},videoUserList(){return this.$store.getters.accepters.map(e=>this.$store.getters.user(e)).filter(e=>e.stream_info.isVideoStreamer&&!e.stream_info.isVideoStreamerMuted)},audioUserList(){return this.$store.getters.accepters.map(e=>this.$store.getters.user(e)).filter(e=>!e.stream_info.isVideoStreamer||e.stream_info.isVideoStreamerMuted)}},methods:{minimize(){this.$store.commit("showUserList",!1)}},template:e}}),define("DS/InstantMessagingCall/store/modules/p2p",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingCall/api/senders"],function(e,t){"use strict";var r=window.navigator.userAgent,i=!!r.match(/iPad/i)||!!r.match(/iPhone/i)||!!r.match(/iPadPro/i),s=!!r.match(/WebKit/i),a=i&&s&&!r.match(/CriOS/i);window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;const o={googTypingNoiseDetection:!1,googEchoCancellation:!0,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1},n={cursor:!0,logicalSurface:!0},l={mandatory:{OfferToReceiveAudio:!0,offerToReceiveAudio:!0,OfferToReceiveVideo:!0,offerToReceiveVideo:!0}},c=({room_id:t,user_id:r})=>t&&r&&"string"==typeof t&&"string"==typeof r?t+r:e.error("p2p protocol error p2pKey "+JSON.stringify(arguments[0])),d=t=>(t&&t.getVideoTracks().forEach(t=>{t.contentHint="text","contentHint"in t?"text"!==t.contentHint&&console.error("Invalid video track contentHint: text"):e.error("MediaStreamTrack contentHint attribute not supported")}),t),u=e=>"contentHint"in e&&"text"==e.contentHint,m=(e,t)=>!!e&&!!(e.kind==t&&("audio"==t||"video"==t&&!u(e))||"screen"==t&&u(e)),p=e=>{var t=e.getTracks(),r={isAudio:!1,isVideo:!1,isScreen:!1};for(let e of t)"audio"==e.kind?(r.isAudio=!0,r.isAudioMuted=!e.enabled,r.track_id_audio=e.id):"video"==e.kind&&(u(e)||r.isVideo?(r.isScreen=!0,r.isScreenMuted=!e.enabled,r.track_id_screen=e.id):(r.isVideo=!0,r.isVideoMuted=!e.enabled,r.track_id_video=e.id));return r},h=(e,t)=>{var r=e.getSenders();for(let e of r)if(e.track&&e.track.id==t)return!0;return!1},_=function(t,r){var i=t.getParameters();i.encodings||(i.encodings=[{}]),i.encodings[0]||(i.encodings[0]={}),i.encodings[0].maxBitrate=1e3*r,t.setParameters(i).then(()=>{e.Call("setBandwidth success to "+r+" kbps")},t=>{e.Call("setBandwidth failed "+t)})};var f=[];return{state:{peer_connections:{},local_stream:null,mutex_local_media:!1,remote_streams:{},video_activated:!1,audio_activated:!1,screen_activated:!1,bandwidth:500,constraintsVideo:{},constraintsAudio:{},forceTURN:!1},getters:{pc:e=>t=>e.peer_connections[c(t)],isTrackId:e=>(t,r)=>{var i=e.remote_streams[t];return!!i&&!!i.getTrackById(r)},streams:(e,t)=>(r,i,s)=>{if((s=s||e.remote_streams[r])||r!=t.myself.user_id||(s=e.local_stream),!s)return console.error("can't find stream of user "+r);if(i){var a=new MediaStream,o=s.getTrackById(i);if(o)a.addTrack(o);else{var n=s.getVideoTracks(),l=void 0;n.forEach(e=>{e.contentHint&&"text"==e.contentHint&&(l=e)}),l?n&&n.length&&a.addTrack(l):n&&n.length&&a.addTrack(n[n.length-1])}return[a]}return[s]},self_stream:(e,t)=>e=>t.streams(t.myself.user_id),mutex_local_media:e=>e.mutex_local_media,local_track_of_kind:e=>t=>{if(!e.local_stream)return null;for(let r of e.local_stream.getTracks())if(m(r,t))return r;return null},bandwidth:e=>e.bandwidth,constraintsVideo:e=>e.constraintsVideo,constraintsAudio:e=>e.constraintsAudio},mutations:{resetP2PState(e){Object.assign(e,{peer_connections:{},local_stream:null,mutex_local_media:!1,remote_streams:{},video_activated:!1,audio_activated:!1,screen_activated:!1,bandwidth:500,constraintsVideo:{},constraintsAudio:{},forceTURN:!1})},pc(t,{user_id:r,room_id:i,webrtcConfig:s,p2pTentatives:a}){var o={user_id:r,room_id:i},n=c(o);if(t.peer_connections[n])return e.Call("p2p bypass PC creation : PC already exists "+r);var l=t.forceTURN?Object.assign({},s,{iceTransportPolicy:"relay"}):s;t.peer_connections[n]=Object.assign(new RTCPeerConnection(l),o),t.peer_connections[n].key=n,t.peer_connections[n].p2pTentatives=a||0},mutex_local_media(e,t){e.mutex_local_media=t},local_stream(e,t){if(e.local_stream)for(let r of t.getTracks())e.local_stream.addTrack(r);else e.local_stream=t},remote_stream(e,{stream:t,pc:r}){let i=r.user_id;e.remote_streams[i]=t},polite(t,{user_id:r,room_id:i}){var s=c({user_id:r,room_id:i});t.peer_connections[s]?t.peer_connections[s].polite=!0:e.error("polite: pc not found "+r)},stopLocalTrack(e,{kind:t}){if(!e.local_stream)return!0;for(let r of e.local_stream.getTracks())if(m(r,t)){r.stop(),e.local_stream.removeTrack(r);break}},deleteLocalStream(e){if(!e.local_stream)return!0;for(let t of e.local_stream.getTracks())t.stop();delete e.local_stream},deleteP2P(t,r){var i=t.peer_connections[r];if(!i)return e.error("failed to retrieve PC "+r);i.close(),delete t.peer_connections[r]},activated(e,{kind:t}){"video"==t?e.video_activated=!0:"screen"==t?e.screen_activated=!0:"audio"==t&&(e.audio_activated=!0)},deactivated(e,{kind:t}){"video"==t?e.video_activated=!1:"screen"==t?e.screen_activated=!1:"audio"==t&&(e.audio_activated=!1)},constraints(e,{bandwidth:t,constraintsVideo:r,constraintsAudio:i}){t&&(e.bandwidth=t),r&&r!={}&&(e.constraintsVideo=r),i&&i!={}&&(e.constraintsAudio=i)},forceTURN(e,t){e.forceTURN=t}},actions:{initP2P({commit:t,rootState:r,state:i,dispatch:s,getters:o},n){if(e.Call("iOSSafari : "+a),o.pc(n))return e.Call("p2p already exists");t("pc",Object.assign({},n,{webrtcConfig:r.webrtcConfig}));var l=o.pc(n);l.ontrack=(e=>{s("ontrack",{data:e,pc:l})}),l.onicecandidate=(e=>{s("onicecandidate",{data:e,pc:l})}),l.onnegotiationneeded=(t=>{if("stable"!=l.signalingState)return e.Call("onnegotiationneeded ignored "+l.user_id);e.Call("onnegotiationneeded "+l.user_id),s("createOffer",{data:t,pc:l})}),l.oniceconnectionstatechange=(e=>{s("oniceconnectionstatechange",{data:e,pc:l})}),l.onsignalingstatechange=(e=>{s("onsignalingstatechange",{data:e,pc:l})}),l.onicegatheringstatechange=(e=>{s("onicegatheringstatechange",{data:e,pc:l})})},sendStream({dispatch:r,getters:i},s){e.Call("sendStream to "+s.user_id),r("getLocalMedia",s).then(()=>{r("addLocalStream",i.pc(s))}).catch(e=>{console.error(e),r("alert_getLocalMediaError",e);var a=i.pc(s);t.callEventFromView({action:"reporting",reason:e,room_id:s.room_id,pcStates:a&&[a.polite,a.signalingState,a.iceConnectionState],step:"sendStream"})})},cleanAllP2P({state:e,commit:t,dispatch:r}){for(let t in e.peer_connections)r("cleanP2P",{key:t});t("deleteLocalStream")},cleanP2P({commit:t},{key:r,room_id:i,user_id:s}){e.Call("cleanP2P of "+(r||s)),t("deleteP2P",r||c({room_id:i,user_id:s}))},getLocalMedia:({state:r,commit:i,dispatch:s,getters:a},{user_id:l,type:c})=>new Promise((c,u)=>{var m,h,_,g,v,S=r.screen_activated,C=r.video_activated;if(r.local_stream){var k=p(r.local_stream);if(_=!k.isAudio,h=C&&!k.isVideo,m=S&&!k.isScreen,!_&&!h&&!m)return c()}else _=!0,h=C,m=S;if(r.mutex_local_media)return f.push(t=>{e.Call("Concurrent getLocalMedia finished, use same media for "+l),t&&u(t)||c()}),e.Call("Waiting for a concurrent getLocalMedia to finish before sending my stream to "+l);i("mutex_local_media",!0);var b=Object.assign({},a.constraintsVideo),y=Object.assign({},a.constraintsAudio);try{g=navigator.mediaDevices.getSupportedConstraints()}catch(e){g=null}if(g){for(v in b)g[v]||delete b[v];for(v in y)g[v]||delete y[v]}else b=null,y=null;b&&b!={}||y&&y!={}?(e.Call("getLocalMedia video constraints to apply : "+JSON.stringify(b)),e.Call("getLocalMedia audio constraints to apply : "+JSON.stringify(y))):e.Call("getLocalMedia no constraints to apply");var I=Object.assign({},o,{audio:_&&y,video:h&&b}),D=e=>{for(var t of(e&&i("local_stream",e),s("local_stream_info"),c(),f))t();f.length=0,i("mutex_local_media",!1)},w=e=>{for(var r of(u(e),f))r(e);f.length=0,i("mutex_local_media",!1),s("tracking",{action:"getLocalMediaFailed",reason:e,user_id:l}),s("track_event",{action:"getLocalMediaResult",dimensions:e.toString()}),t.callEventFromView({action:"reporting",reason:e,step:"getLocalMedia"})};const T=[...m?["screen"]:[],..._?["audio"]:[],...h?["video"]:[]];s("track_event",{action:"getLocalMedia",dimensions:T,eventValue:T.length}),new Promise((e,t)=>{if(!m)return e();navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia(n).then(e).catch(t):navigator.getDisplayMedia(n).then(e).catch(t)}).then(t=>{I.audio||I.video?(t&&i("local_stream",d(t)),navigator.mediaDevices?navigator.mediaDevices.getUserMedia(I).then(D,w):navigator.getUserMedia?navigator.getUserMedia(I,D,w):(e.Call("no navigator getLocalMedia method found"),w("NotReadableError"))):D(d(t))}).catch(e=>{w(e)})}),removeLocalTrackFromPC({},{pc:e,kind:t}){var r=e.getSenders();if(!r)return!0;r.forEach(r=>{m(r.track,t)&&e.removeTrack(r)})},addLocalStream({state:r,getters:i,dispatch:s},a){var o=r.local_stream;if(!o)return e.Call("no local stream");if(a.addTrack)try{var n,l=o.getTracks(),c=-1;for(n=0;n<l.length;n++)h(a,l[n].id)||(l[n].contentHint&&"text"==l[n].contentHint?c=n:a.addTrack(l[n],o));c>-1&&a.addTrack(l[c],o)}catch(r){e.error(r),t.callEventFromView({action:"reporting",reason:r,room_id:a.room_id,pcStates:[a.polite,a.signalingState,a.iceConnectionState],step:"addTrack"})}else{if(!a.addStream)return e.error("addLocalStream called but addTrack & addStream unexist");try{a.addStream(o)}catch(r){e.error("addLocalStream failed to addStream "+r),t.callEventFromView({action:"reporting",reason:r,room_id:a.room_id,pcStates:[a.polite,a.signalingState,a.iceConnectionState],step:"addStream"})}}var d=i.local_track_of_kind("screen");d&&t.callEventFromView({action:"speaker",room_id:a.room_id,user_id:i.myself.user_id,track_id:d.id,type:"screen"})&&s("setAsSpeaker",{user_id:i.myself.user_id,track_id:d.id,firstSpeaker:!0});var u=i.local_track_of_kind("video");u&&t.callEventFromView({action:"mute",type:"video",muted:"muted"==i.local_stream_info("video"),room_id:a.room_id,track_id:u.id});var m=i.local_track_of_kind("audio");m&&t.callEventFromView({action:"mute",type:"audio",muted:"muted"==i.local_stream_info("audio"),room_id:a.room_id,track_id:m.id})},local_stream_info({state:e,dispatch:t}){e.local_stream&&t("local_stream_changed",p(e.local_stream),{root:!0})},createOffer({dispatch:r},{pc:i}){i.makingOffer=!0,e.Call("CreateOffer"),i.createOffer(l).then(e=>i.setLocalDescription(e)).then(()=>{t.SDP({room_id:i.room_id,user_id:i.user_id,sdp:i.localDescription,isCaller:!0}),i.makingOffer=!1}).catch(s=>{e.error("failed to createOffer "+s),i.makingOffer=!1,r("track_event",{action:"webrtcIssue",dimensions:["createOffer",JSON.stringify(s),i.polite,i.signalingState,i.iceConnectionState]}),t.callEventFromView({action:"reporting",reason:s,room_id:i.room_id,pcStates:[i.polite,i.signalingState,i.iceConnectionState],step:"createOffer"})})},onAnswer({dispatch:r},{data:i,pc:s}){s.isSettingRemoteAnswerPending=!0,s.setRemoteDescription(new RTCSessionDescription(i.sdp)).then(()=>{e.Call("onAnswer setRemoteDescription success"),s.isSettingRemoteAnswerPending=!1}).catch(i=>{e.error("onAnswer failed "+i),s.isSettingRemoteAnswerPending=!1,r("track_event",{action:"webrtcIssue",dimensions:["onAnswer",JSON.stringify(i),s.polite,s.signalingState,s.iceConnectionState]}),t.callEventFromView({action:"reporting",reason:i,room_id:s.room_id,pcStates:[s.polite,s.signalingState,s.iceConnectionState],step:"onAnswer"})})},onOffer({dispatch:r,commit:i},{data:s,pc:o}){var n=!o.makingOffer&&("stable"==o.signalingState||o.isSettingRemoteAnswerPending);if(o.ignoreOffer=!o.polite&&!n,o.ignoreOffer)return e.Call("Ignoring SDP offer to avoid collision");o.setRemoteDescription(new RTCSessionDescription(s.sdp)).then(()=>(e.Call("onOffer setRemoteDescription success"),r("getLocalMedia",s))).then(()=>(e.Call("onOffer getLocalMedia resolved"),r("addLocalStream",o))).then(()=>(e.Call("onOffer localStream added"),o.createAnswer(l))).then(t=>(e.Call("onOffer answer created"),o.setLocalDescription(t))).then(()=>{e.Call("onOffer setLocalDescription success"),t.SDP({room_id:o.room_id,user_id:o.user_id,sdp:o.localDescription,isCaller:!1})}).catch(i=>{e.error("onOffer failed (polite  : "+o.polite+", iOSSafari: "+a+", signalingState : "+o.signalingState+"). Error: "+i),r("track_event",{action:"webrtcIssue",dimensions:["onOffer",JSON.stringify(i),o.polite,o.signalingState,o.iceConnectionState]}),t.callEventFromView({action:"reporting",reason:i,room_id:o.room_id,pcStates:[o.polite,o.signalingState,o.iceConnectionState],step:"onOffer"}),r("initRetryProcess",{pc:o})})},ontrack({dispatch:t,commit:r,getters:i},{data:s,pc:a}){var o=s.stream||s.streams[0],n=o.getVideoTracks();n&&i.speaker_id&&a.user_id==i.speaker_id&&1==n.length&&(n[0].contentHint="text",r("speaker",{user_id:a.user_id,speaker_track_id:n[0].id,kind:"screen"}));var l=p(o);e.Call("Track of "+a.user_id+" received "+JSON.stringify(l)),r("remote_stream",{stream:o,pc:a,info:l}),t("update_received_stream",{user_id:a.user_id,pc:a})},update_received_stream({dispatch:e,state:t},{user_id:r,pc:i}){var s=t.remote_streams[r];if(!s)return!0;var a=p(s);a.isAudio?e("received_track_audio",{user_id:i.user_id},{root:!0}):e("remove_track_audio",{user_id:i.user_id},{root:!0}),a.isVideo?e("received_track_video",{user_id:i.user_id},{root:!0}):e("remove_track_video",{user_id:i.user_id},{root:!0}),a.isScreen?e("received_track_screen",{user_id:i.user_id},{root:!0}):e("remove_track_screen",{user_id:i.user_id},{root:!0})},onicecandidate({},{data:r,pc:i}){if(!r.candidate)return e.Call("ignoring candidate "+JSON.stringify(r));t.webrtcIceCandidate({room_id:i.room_id,user_id:i.user_id,candidate:r.candidate})},oniceconnectionstatechange({getters:t},{data:r,pc:i}){e.Call("oniceconnectionstatechange : "+i.iceConnectionState),"failed"===i.iceConnectionState&&"function"==typeof i.restartIce&&i.restartIce(),"failed"===i.iceConnectionState||"disconnected"===i.iceConnectionState||"closed"===i.iceConnectionState||"connected"==i.iceConnectionState&&function(t,r){if(!t||!r)return e.error("updateSenderBandwidth bad params");if(!window.RTCRtpSender||!window.RTCRtpSender.prototype.setParameters)return e.Call("updateSenderBandwidth no compatiblity");try{var i=t.getSenders();for(let e of i)e.track&&"video"==e.track.kind&&_(e,r)}catch(e){console.error(e)}}(i,t.bandwidth)},onsignalingstatechange({dispatch:t},{data:r,pc:i}){e.Call("onsignalingstatechange : "+i.signalingState),"stable"==i.signalingState&&t("update_received_stream",{user_id:i.user_id,pc:i})},onicegatheringstatechange({},{data:t,pc:r}){let i="Unknown";switch(r.iceGatheringState){case"new":case"complete":i="Idle";break;case"gathering":i="Determining route"}e.Call("ICE status : "+r.iceGatheringState)},SDP({dispatch:t,getters:r,commit:i},s){if(!s.sdp)return e.error("failed to find sdp in "+JSON.stringify(s));if(r.refusers.indexOf(s.user_id)>-1)return e.Call("SDP sender already left the call");var a=r.pc(s);if(!a){if(!r.accepted_room||s.room_id!=r.accepted_room.room_id)return e.Call("SDP received for another device");if(e.Call("SDP initP2P for mobile retrocompatibility"),i("accepter",s.user_id),t("initP2P",s),t("autoEndTimeoutOFF",{room_id:s.room_id}),!(a=r.pc(s)))return e.error("SDP failed to create pc "+JSON.stringify(s))}s.isCaller?t("onOffer",{data:s,pc:a}):t("onAnswer",{data:s,pc:a})},webrtcIceCandidate({getters:r,dispatch:i},s){if(!s.candidate)return e.Call("error no candidate in "+JSON.stringify(s));var a=r.pc(s);if(!a)return e.error("webrtcIceCandidate failed to find pc "+JSON.stringify(s));a.addIceCandidate(new RTCIceCandidate(s.candidate)).then(()=>{e.Call("addIceCandidate success")}).catch(r=>{a.ignoreOffer||(e.error("addIceCandidate failed "+r),i("track_event",{action:"webrtcIssue",dimensions:["webrtcIceCandidate",JSON.stringify(r),a.polite,a.signalingState,a.iceConnectionState]}),t.callEventFromView({action:"reporting",reason:r,room_id:a.room_id,pcStates:[a.polite,a.signalingState,a.iceConnectionState],step:"webrtcIceCandidate"}))})},activeTrack({state:e,dispatch:r,getters:i,commit:s},{kind:a,room_id:o}){s("activated",{kind:a}),i.local_track_of_kind(a)?r("muteTrack",{kind:a,room_id:o,unmute:!0}):r("getLocalMedia",{type:a,room_id:o}).then(()=>{for(let t in e.peer_connections)r("addLocalStream",e.peer_connections[t]);t.callEventFromView({type:a,action:"mute",muted:!1,room_id:o})}).catch(e=>{s("deactivated",{kind:a}),t.callEventFromView({action:"reporting",reason:e,room_id:o,step:"activeTrack"})}),i.sip&&r("activeTelTrack")},muteTrack({getters:e,dispatch:r,commit:i},{kind:s,room_id:a,unmute:o}){e.local_track_of_kind(s).enabled=!!o,r("local_stream_info"),"video"==s&&i("showSelfView"),t.callEventFromView({type:s,action:"mute",muted:!o,room_id:a}),e.sip&&r("muteTelTrack")},stopTrack({state:r,dispatch:i,commit:s,getters:a},{kind:o,room_id:n}){var l=a.local_track_of_kind(o);if(!l)return console.error("Can not find track of kind "+o);var c=l.id;e.Call("stopTrack "+o+" "+c);for(let e in r.peer_connections)i("removeLocalTrackFromPC",{pc:r.peer_connections[e],kind:o});s("stopLocalTrack",{kind:o}),i("local_stream_info"),s("deactivated",{kind:o}),t.callEventFromView({type:o,action:"stopTrack",track_id:c,room_id:n||a.accepted_room&&a.accepted_room.room_id})},restartAllP2P({dispatch:e,state:t}){for(let r in t.peer_connections)e("initRetryProcess",{pc:t.peer_connections[r]})},initRetryProcess({dispatch:r,getters:i,rootState:s},{pc:a}){if(e.Call("initRetryProcess with "+a.user_id),"number"==typeof a.p2pTentatives?a.p2pTentatives++:a.p2pTentatives=1,r("track_event",{action:"retryP2P",dimensions:"init",eventValue:a.p2pTentatives}),a.p2pTentatives>s.max_p2pTentatives)return e.Call("initRetryProcess aborted : reached max_p2pTentatives");t.callEventFromView({action:"restartP2P",user_id:i.myself.user_id,user_id_to:a.user_id,room_id:a.room_id,p2pTentatives:a.p2pTentatives})},restartP2P({rootState:r,dispatch:i,getters:s,commit:a},{user_id:o,room_id:n,p2pTentatives:l}){var c={user_id:o,room_id:n,webrtcConfig:r.webrtcConfig,p2pTentatives:l};e.Call("restartP2P asked by "+c.user_id),i("resetPC",c).then(()=>(a("polite",c),t.callEventFromView({action:"p2pRestarted",user_id:s.myself.user_id,user_id_to:c.user_id,room_id:c.room_id,p2pTentatives:l}))).catch(r=>{e.error("restartP2P failed "+r),t.callEventFromView({action:"reporting",reason:r,room_id:n,p2pTentatives:l,step:"restartP2P"})})},p2pRestarted({dispatch:r,rootState:i},{user_id:s,room_id:a,p2pTentatives:o}){var n={user_id:s,room_id:a,webrtcConfig:i.webrtcConfig,p2pTentatives:o};e.Call("p2pRestarted "+n.user_id),r("resetPC",n).then(()=>r("sendStream",{user_id:n.user_id,room_id:n.room_id})).catch(r=>{e.error("p2pRestarted failed "+r),t.callEventFromView({action:"reporting",reason:r,room_id:a,p2pTentatives:o,step:"p2pRestarted"})})},resetPC:({commit:e,dispatch:t},r)=>(e("remove_track_audio",{user_id:r.user_id}),e("remove_track_video",{user_id:r.user_id}),e("remove_track_screen",{user_id:r.user_id}),t("cleanP2P",r).then(()=>t("initP2P",r))),getStats:({state:e},{selector:t,allStats:r})=>new Promise((i,s)=>{var a=[],o=[];for(let r in e.peer_connections)a.push(e.peer_connections[r].getStats(t)),o.push(r);Promise.all(a).then(e=>{var t={},s=0;return e.forEach(e=>{t[o[s]]=[],e.forEach(e=>{("outbound-rtp"==e.type||"inbound-rtp"==e.type||r)&&t[o[s]].push(e)}),s++}),i(t)}).catch(s)})}}}),define("DS/InstantMessagingCall/components/PanelMembers/PanelMembers",["text!DS/InstantMessagingCall/components/PanelMembers/PanelMembers.html","DS/InstantMessagingCall/components/MemberList/MemberList"],function(e,t){"use strict";return{components:{"im-call-member-list":t},computed:{called_users(){return this.$store.getters.called_users}},template:e}}),define("DS/InstantMessagingCall/store/modules/call",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingCall/api/senders","DS/InstantMessagingCall/store/modules/users","DS/InstantMessagingCall/store/modules/p2p"],function(e,t,r,i){"use strict";const s={initial:"initial",invited:"invited",accepted:"accepted",ended:"ended"},a=()=>({callStatus:s.initial,rooms:{},room_id_accepted:null,room_id_invitations:[],isVolumeOFF:!1,displayActionBar:!0,minimized:!1,date_start:0,showSelfView:!0,currentPanel:null,sip:!1,showInvite:!0,showDialer:!1});return{modules:{users:r,p2p:i},state:Object.assign({startMinimized:!1,timelineAvailable:!0,screenSharingAvailable:!0,confettiAvailable:!1},a()),getters:{screenSharingAvailable:e=>e.screenSharingAvailable,timelineAvailable:e=>e.timelineAvailable,isInitial:e=>e.callStatus==s.initial,isAccepted:e=>e.callStatus==s.accepted,isInvited:e=>e.callStatus==s.invited,isEnded:e=>e.callStatus==s.ended,invitations:e=>e.room_id_invitations,room:e=>t=>e.rooms[t],accepted_room:e=>e.rooms[e.room_id_accepted],is_accepted_room:e=>t=>!!e.room_id_accepted&&e.room_id_accepted==t,called_users_name:e=>t=>{var r=[];if(!e.rooms[t]||!e.rooms[t].calledUsers)return r;for(let i of e.rooms[t].calledUsers)r.push(i.username);return r},isVolumeOFF:e=>e.isVolumeOFF,displayActionBar:e=>e.displayActionBar,minimized:e=>e.minimized,date_start:e=>e.date_start,const_timeout_ms:e=>3e4,timeout_date_start:e=>t=>e.rooms[t].timeout_date_start,showSelfView:e=>e.showSelfView,currentPanel:e=>e.currentPanel,dmId:e=>e.accepted_room&&e.accepted_room.options&&e.accepted_room.options.dmId,sip:e=>e.sip,roomName:e=>e=>e.topic||e.options&&e.options.topic||e.orderId||e.options&&e.options.orderId,showInvite:e=>e.showInvite,showDialer:e=>e.showDialer},mutations:{resetCallState(e){Object.assign(e,a())},status(t,r){let i;if(r){if(!s[r])return e.Call("error callStatus unknown : "+r);i=s[r]}else switch(t.callStatus){case s.initial:i=s.invited;break;case s.invited:i=s.accepted;break;case s.accepted:i=s.ended;break;case s.ended:i=s.initial;break;default:i=s.initial}return i==t.callStatus||(i==s.invited&&t.callStatus!=s.initial&&t.callStatus!=s.ended||i==s.accepted&&t.callStatus!=s.invited||i==s.ended&&t.callStatus!=s.invited&&t.callStatus!=s.accepted?e.Call("Can not set "+i+" after "+t.callStatus):(i==s.accepted&&t.startMinimized&&(t.minimized=!0),i==s.accepted&&(t.date_start=Date.now()),e.Call("nextStatus: "+i),void(t.callStatus=i)))},room_accepted(e,t){e.room_id_accepted=t},room(e,t){e.rooms[t.room_id]||(e.rooms[t.room_id]=t)},invitation_del(e,t){let r=e.room_id_invitations.indexOf(t);-1!=r&&e.room_id_invitations.splice(r,1)},invitation_del_all(e){e.room_id_invitations.length=0},invitation(e,t){-1==e.room_id_invitations.indexOf(t)&&e.room_id_invitations.push(t)},volume:(e,t)=>{e.isVolumeOFF=!t},closeActionBar:e=>{e.displayActionBar=!1},openActionBar:e=>{e.displayActionBar=!0},minimize:(e,t)=>{e.minimized=t},timeout_started:(e,{room_id:t})=>{e.rooms[t].timeout_date_start=Date.now()},timeout_stopped:(e,{room_id:t})=>{e.rooms[t].timeout_date_start=0},showSelfView:e=>{e.showSelfView=!0},hideSelfView:e=>{e.showSelfView=!1},currentPanel:(e,t)=>{e.currentPanel=t},screenSharingAvailable:(e,t)=>{e.screenSharingAvailable=t},sipState:(e,t)=>{e.sip=!!(t&&t.options&&t.options.sip)&&!!t.options.sip},showInvite:e=>{e.showInvite=!0},hideInvite:e=>{e.showInvite=!1},showDialer:e=>{e.showDialer=!0},hideDialer:e=>{e.showDialer=!1}},actions:{nextStatus({commit:e}){e("status")},endCurrentCall({dispatch:e,getters:t}){t.accepted_room&&e("endCall",t.accepted_room)},endCall({dispatch:e},r){t.endCall({reason:"user_hangup",IamTheCaller:r.IamTheCaller,dontEndCallOnRoom:!1,room_id:r.room_id}),e("stopFeatures",{room_id:r.room_id}),e("autoEndTimeoutOFF",{room_id:r.room_id})},endAllInvitations({getters:e,dispatch:r}){for(let i of e.invitations)t.endCall({reason:"user_hangup",IamTheCaller:!1,dontEndCallOnRoom:!1,room_id:i}),r("autoEndTimeoutOFF",{room_id:i})},endCallMissed({dispatch:e},{room_id:r,IamTheCaller:i}){t.endCall({reason:i?"callTimeout":"callMissed",IamTheCaller:i,dontEndCallOnRoom:i,room_id:r})},endCallFailure({dispatch:e},{room_id:r,reason:i,IamTheCaller:s}){t.endCall({reason:i,IamTheCaller:s,dontEndCallOnRoom:!1,room_id:r}),e("autoEndTimeoutOFF",{room_id:r})},acceptCall({commit:e,getters:r,dispatch:i},{room_id:s,type:a}){e("room_accepted",s),i("autoEndTimeoutOFF",{room_id:s}),e("status","accepted"),e("invitation_del",s),i("endAllInvitations");a=a||r.room(s).type;t.acceptCall({room_id:s,type:a}),i("getLocalMedia",{type:null,user_id:r.myself.user_id}).catch(e=>{i("alert_getLocalMediaError",e),i("endCallFailure",{room_id:s,IamTheCaller:!1,reason:e})})},inviteSent({commit:e,dispatch:t,getters:r},i){if(e("status","invited"),i.IamTheCaller=!0,e("sipState",i),e("room",i),e("user",r.myself),t("tracking",{action:"inviteSent"}),i.calledUsers)for(let t of i.calledUsers)e("user",t);r.accepted_room||(e("activated",{kind:i.type}),t("autoEndTimeoutON",{room_id:i.room_id,IamTheCaller:!0}),t("noises",{action:"startRingbacktone"})),i.options&&i.options.featureData&&t("invited_feature",{type:i.type,room_id:i.room_id,featureData:i.options.featureData}),e("room_accepted",i.room_id),e("invitation",i.room_id),e("constraints",i),t("getLocalMedia",i).catch(e=>{t("alert_getLocalMediaError",e),t("endCallFailure",{room_id:i.room_id,IamTheCaller:!0,reason:e})})},inviteReceived({commit:r,state:i,getters:s,dispatch:a},o){if(o.youHaveToAccept){if(o.room_id!=i.room_id_accepted)return e.Call("Invitation protocol error : while on "+i.room_id_accepted+", received invitation from "+o.login+" on "+o.room_id);r("user",o.user),r("accepter",o.user_id),a("initP2P",o),r("polite",o),a("sendStream",o),t.acceptCall({user_id:o.user_id,room_id:o.room_id,type:"audio",autoAccept:!0})}else if(s.isAccepted)e.Call("Invitation protocol error "+JSON.stringify(o));else{r("sipState",o),a("noises",{action:"startRingtone"}),r("user",s.myself);for(let e of o.calledUsers)r("user",e);"screen"==o.type&&(o.type="audio"),r("room",o),r("invitation",o.room_id),r("constraints",o),r("status","invited"),a("autoEndTimeoutON",{room_id:o.room_id,IamTheCaller:!1})}},accepted({commit:r,state:i,dispatch:s,getters:a},o){if(!i.rooms[o.room_id])return e.Call("error room unknown "+o.room_id);if(i.room_id_accepted!=o.room_id&&o.user_id!=a.myself.user_id)return e.Call("someone else accepted the call and I still don't");if(s("noises",{action:"stopTones"}),e.Call("Someone joined the call "+o.user.login),r("invitation_del",o.room_id),r("user",o.user),s("autoEndTimeoutOFF",{room_id:o.room_id}),o.user_id!=a.myself.user_id)r("sipState",a.room(o.room_id)),s("noises",{action:"userIn"}),s("initP2P",o),r("status","accepted"),r("accepter",o.user_id),s("sendCurrentFeature"),o.autoAccepted?(e.Call("Another accepter's p2p is ready, send my stream"),s("sendStream",o)):(e.Call("Another user joined, tell him to start p2p with me"),(!o.clientDevice||!o.clientDevice.callVersion||o.clientDevice.platform&&"ios"==o.clientDevice.platform.toLowerCase())&&r("polite",o),t.startCall({login:o.user.login,alreadyStarted:!0,room_id:o.room_id}),s("tracking",{login:o.user.login,action:"accepted"}));else if(o.room_id==i.room_id_accepted){e.Call("I accepted the call on current device, initP2P with the caller (mobile retrocompat), waiting for other users to start P2P");var n=a.accepted_room.user.user_id;r("accepter",n),s("initP2P",Object.assign({},o,{user_id:n}))}else e.Call("I accepted the call on another device whereas I am in the room on current device"),a.invitations.length||r("status","initial")},cleanEverything({commit:e,dispatch:t}){t("cleanAllP2P"),t("cleanTelephony"),e("status","ended"),e("resetUsersState"),e("resetP2PState"),e("resetFeatureState"),e("resetCallState")},callEnded({commit:t,state:r,dispatch:i,getters:s},{room_id:a,user_id:o,login:n,reason:l}){var c=o==s.myself.user_id,d=s.room(a)&&s.room(a).user.user_id==o,u=s.room(a)&&s.room(a).IamTheCaller;return i("tracking",{reason:l,login:n,action:"ended"}),i("noises",{action:"stopTones"}),a==r.room_id_accepted?(t("refuser",o),c?(e.Call("I left the call "+a),i("stopTracking",{dontSendSwymReport:!1}),i("cleanEverything")):(i("noises",{action:"userOut"}),s.called_users.length-1==s.refusers.length||d&&!s.accepters.length&&!u?(e.Call("I am the last one of the call "+a+(d?" and the caller left ":"")),i("stopTracking",{dontSendSwymReport:!1}),i("cleanEverything")):(i("cleanP2P",{room_id:a,user_id:o}),e.Call("Someone left the call "+a)))):(-1!=s.invitations.indexOf(a)&&(c||d?(e.Call((c?"I refused the invitation":"The caller stopped the invitation")+" on "+a),t("invitation_del",a),s.invitations.length||r.room_id_accepted||i("cleanEverything")):e.Call("Someone refused/left the call I am invited on "+a)),e.error("Received an unwanted endCall "+a))},callEvent({commit:t,getters:r,dispatch:i},{room_id:s,action:a,type:o,user_id:n,track_id:l,muted:c,data:d,featureData:u,featureMembers:m,featureInfo:p,featureId:h,user_id_to:_,p2pTentatives:f,actions:g}){if(!r.isAccepted&&"notCallable"!=a)return e.Call("ignoring callEvent "+a);switch(a){case"mute":t("stream_muted",{kind:o,user_id:n,muted:c});break;case"speaker":t("call_speaker",{user_id:n,speaker_track_id:l,kind:o}),!r.currentFeature&&t("speaker",{user_id:n,speaker_track_id:l,kind:o});break;case"feature":i("received_feature",{user_id:n,room_id:s,featureInfo:p});break;case"confetti":i("received_confetti",{user_id:n,room_id:s,featureData:u,featureId:h});break;case"3DPlayData":i("received_3DPlay_data",{user_id:n,room_id:s,featureData:u,featureId:h,actions:g});break;case"masterChanged":i("masterChanged",{user_id:n,featureId:h});break;case"featureEnded":i("featureEnded",{user_id:n,featureId:h});break;case"featureMembers":i("featureMembers",{user_id:n,featureId:h,featureMembers:m});break;case"stopTrack":t("track_stopped",{user_id:n,track_id:l,kind:o});break;case"notCallable":for(let e in d.uncallableUsers)i("callEnded",{login:d.uncallableUsers[e].login,user_id:d.uncallableUsers[e].user_id,room_id:s,reason:"Busy"});i("alert_uncallableUsers",{calledUsers:d.callableLogins,uncallableUsers:d.uncallableUsers});break;case"restartP2P":r.is_accepted_room(s)&&_==r.myself.user_id?i("restartP2P",{room_id:s,user_id:n,p2pTentatives:f}):e.Call("ignore callEvent restartP2P from "+n+" to "+_);break;case"p2pRestarted":r.is_accepted_room(s)&&_==r.myself.user_id?i("p2pRestarted",{room_id:s,user_id:n,p2pTentatives:f}):e.Call("ignore callEvent p2pRestarted from "+n+" to "+_);break;default:e.Call("unknown callEvent "+a)}},received_track_video({commit:e,dispatch:t},{user_id:r,track_id:i}){e("received_track_video",{user_id:r,track_id:i}),t("tracking",{user_id:r,kind:"video",action:"stream"})},received_track_screen({commit:e,dispatch:t},{user_id:r}){e("received_track_screen",{user_id:r}),t("tracking",{user_id:r,kind:"screen",action:"stream"})},received_track_audio({commit:e,dispatch:t},{user_id:r,track_id:i}){e("received_track_audio",{user_id:r,track_id:i}),t("tracking",{user_id:r,kind:"audio",action:"stream"})},remove_track_screen({commit:e},{user_id:t}){e("remove_track_screen",{user_id:t})},remove_track_video({commit:e},{user_id:t}){e("remove_track_video",{user_id:t})},remove_track_audio({commit:e},{user_id:t}){e("remove_track_audio",{user_id:t})},local_stream_changed({commit:e,getters:t},r){r.isAudio&&e("received_track_audio",{user_id:t.myself.user_id,track_id:r.track_id_audio}),r.isVideo&&e("received_track_video",{user_id:t.myself.user_id,track_id:r.track_id_video}),r.isScreen?e("received_track_screen",{user_id:t.myself.user_id,track_id:r.track_id_screen}):(e("remove_track_screen",{user_id:t.myself.user_id}),e("track_stopped",{user_id:t.myself.user_id,track_id:r.track_id_screen,kind:"screen"})),e("local_stream_info",{kind:"audio",muted:r.isAudioMuted,loaded:r.isAudio,user_id:t.myself.user_id}),e("local_stream_info",{kind:"video",muted:r.isVideoMuted,loaded:r.isVideo,user_id:t.myself.user_id}),e("local_stream_info",{kind:"screen",muted:r.isScreenMuted,loaded:r.isScreen,user_id:t.myself.user_id})},autoEndTimeoutON({commit:e,getters:t,dispatch:r},{room_id:i,IamTheCaller:s}){t.room(i)&&!t.room(i).callMissed&&(e("timeout_started",{room_id:i}),t.room(i).callMissed=setTimeout(()=>{r("endCallMissed",{room_id:i,IamTheCaller:s})},3e4))},autoEndTimeoutOFF({commit:e,getters:t},{room_id:r}){e("timeout_stopped",{room_id:r}),clearTimeout(t.room(r).callMissed)},offlineStartCall({dispatch:e},t){e("offlineStartCallTracking",t),e("alert_connexionLost")}}}}),define("DS/InstantMessagingCall/store/index",["vuejs","vuex","DS/InstantMessagingCall/store/modules/call","DS/InstantMessagingCall/store/modules/tracker","DS/InstantMessagingCall/store/modules/messages","DS/InstantMessagingCall/store/modules/noises","DS/InstantMessagingCall/store/modules/feature","DS/InstantMessagingCall/store/modules/usergroup","DS/InstantMessagingCall/store/modules/telephony"],function(e,t,r,i,s,a,o,n,l){"use strict";return new t.Store({state:{tenant:"GLOBAL",webrtcConfig:null,user_id_myself:null,login_myself:null,username_myself:null,appName:null,rtcUrl:null,swymUrl:null,isConnected:!1,clientDevice:null,isIOS:!1,isMac:!1,isDesktopApp:!1,backgroundImage:!0,clickOnVideo:!1,selfViewInUserList:!0,assets_url:void 0,max_p2pTentatives:15},modules:{call:r,tracker:i,messages:s,noises:a,Feature:o,usergroup:n,Telephony:l},getters:{rtcUrl:e=>e.rtcUrl,swymUrl:e=>e.swymUrl,tenant:e=>e.tenant,myself:e=>({user_id:e.user_id_myself,login:e.login_myself,username:e.username_myself}),isConnected:e=>e.isConnected,isIOS:e=>e.isIOS,isMac:e=>e.isMac,isDesktopApp:e=>e.isDesktopApp,isDevEnv:e=>"devenv"==e.appName,selfViewInUserList:e=>e.selfViewInUserList,assets_url:e=>e.assets_url,backgroundImage:e=>e.backgroundImage,clickOnVideo:e=>e.clickOnVideo},mutations:{tenant(e,t){e.tenant=t},user_id_myself(e,t){e.user_id_myself=t},login_myself(e,t){e.login_myself=t},username_myself(e,t){e.username_myself=t},webrtcConfig(e,t){e.webrtcConfig=t},appName(e,t){e.appName=t,"devenv"!=e.appName&&"3dprint"!=e.appName&&"ElectronCallWebview"!=e.appName||(e.call.timelineAvailable=!1),"devenv"==e.appName&&(e.call.confettiAvailable=!0),e.assets_url="devenv"==e.appName?"../../../InstantMessaging/InstantMessagingCall.mweb/src/assets/":window.dsDefaultWebappsBaseUrl+"InstantMessagingCall/assets/"},swymUrl(e,t){e.swymUrl=t},rtcUrl(e,t){e.rtcUrl=t},isConnected(e,t){e.isConnected=t},clientDevice(e,t){e.clientDevice=t},isIOS(e,t){e.isIOS=t},isMac(e,t){e.isMac=t},isDesktopApp:(e,t)=>{e.isDesktopApp=t},selfViewInUserList(e,t){e.selfViewInUserList=t}},actions:{connected({getters:e,commit:t,dispatch:r},{clientDevice:i,tenant:s,user_id_myself:a,login_myself:o,username_myself:n,appName:l}){r("alert_connexionRetrieved"),t("isConnected",!0),i&&r("clientDevice",i),s&&t("tenant",s),a&&t("user_id_myself",a),o&&t("login_myself",o),n&&t("username_myself",n),l&&t("appName",l)},disconnected({commit:e}){e("isConnected",!1)},clientDevice({commit:e},t){e("clientDevice",t),void 0===t.ScreenSharingCompatible||t.ScreenSharingCompatible||e("screenSharingAvailable",!1),void 0!==t.isIOS&&e("isIOS",t.isIOS),void 0!==t.isMac&&e("isMac",t.isMac)}}})}),define("DS/InstantMessagingCall/components/Collab/Collab",["text!DS/InstantMessagingCall/components/Collab/Collab.html","DS/InstantMessagingCall/components/CollabOfficeDocument/CollabOfficeDocument","DS/InstantMessagingCall/components/CollabWhiteBoard/CollabWhiteBoard","DS/InstantMessagingCall/components/CollabConfetti/CollabConfetti","DS/InstantMessagingCall/components/Collab3DPlay/Collab3DPlay"],function(e,t,r,i,s,a){"use strict";return{components:{"im-call-ode":t,"im-call-whiteboard":r,"im-call-confetti":i,"im-call-3dplay":s},props:["feature","feature_id","isODE","isWhiteboard","isConfetti","is3DPlay","isScreenShare"],computed:{featureData(){return this.feature&&this.feature.featureData},masterUser(){return this.feature&&this.feature.master&&this.$store.getters.user(this.feature.master)}},template:e}}),define("DS/InstantMessagingCall/api/desktop/watchers",["DS/InstantMessagingCall/store/index","DS/PlatformAPI/PlatformAPI"],function(e,t){"use strict";const r=["invitation","invitation_del","room_accepted","status","minimize"],i=["inviteReceived","inviteSent","accepted","callEnded","cleanEverything"];var s;return{init:function(t){this.unsubscribe=e.subscribe(this.mutationsOccured,{prepend:!0}),this.unsubscribeAction=e.subscribeAction(this.actionsOccured,{prepend:!0}),s=t},destroy:function(){this.unsubscribe(),this.unsubscribeAction()},actionsOccured:function(e,r){-1!=i.indexOf(e.type)&&(console.log("To Electron : "+JSON.stringify(e)),t.publish(s,{data:e,state:{}}))},mutationsOccured:function(e,i){-1!=r.indexOf(e.type)&&(console.log("To Electron : "+JSON.stringify(e)),t.publish(s,e))}}}),define("DS/InstantMessagingCall/api/desktop/listeners_papi",["DS/InstantMessagingCall/store/index"],function(e){"use strict";const t={},r=["setPresence","endCurrentCall","endCall","acceptCall"],i=["showInvite","hideInvite","minimize"];for(let r of i)t[r]=(t=>{e.commit(r,t)});for(let i of r)t[i]=(t=>{e.dispatch(i,t)});return e=>{if(e.evenement&&t[e.evenement]||e.action&&t[e.action])return console.log("From Electron : "+JSON.stringify(e)),t[e.evenement||e.action](e&&e.data)}}),define("DS/InstantMessagingCall/api/listeners_papi",["DS/InstantMessagingCall/store/index","DS/InstantMessagingCall/api/senders"],function(e,t){"use strict";const r={CONNECTED(t){e.dispatch("connected",{clientDevice:t.data.clientDevice,tenant:t.data.data.tenant,user_id_myself:t.data.user_id,login_myself:t.data.userId,username_myself:t.data.username,appName:t.data.appName})},startCall:r=>e.getters.isConnected?"screen"!=r.type||e.getters.screenSharingAvailable?(r.isJoinable||e.dispatch("startTracking",{logins:r.logins||r.login||r.phone,type:r.type,dmId:r.dmId}),e.dispatch("track_event",{action:r.isJoinable?"joinCall":"startCall",dimensions:[r.type,r.dmId||r.orderId],eventValue:(r.logins||[r.login]).length}),void t.startCall({login:r.login,logins:r.logins,username:r.username,type:r.type,options:{sip:r.sip||r.options&&r.options.sip,uri:r.uri||r.phone,orderId:r.orderId,topic:r.topic,dmId:r.dmId,swymUrl:r.swymUrl||r.options&&r.options.swymUrl,featureData:r.data}})):e.dispatch("alert_browserNotCompatible"):e.dispatch("offlineStartCall",r)};return e=>{if(e.evenement&&r[e.evenement]||e.action&&r[e.action])return r[e.evenement||e.action](e)}}),define("DS/InstantMessagingCall/components/LightboxContent/LightboxContent",["text!DS/InstantMessagingCall/components/LightboxContent/LightboxContent.html","DS/InstantMessagingCall/components/ActionBar/ActionBar","DS/InstantMessagingCall/components/UserList/UserList","DS/InstantMessagingCall/components/SelfView/SelfView","DS/InstantMessagingCall/components/UserItem/UserItem","DS/InstantMessagingCall/components/SpeakerName/SpeakerName","DS/InstantMessagingCall/components/Collab/Collab","DS/InstantMessagingCall/components/ActionBarItem/ActionBarItem","DS/InstantMessagingCall/components/VideoMinimize/VideoMinimize","DS/InstantMessagingCall/components/PanelUsers/PanelUsers"],function(e,t,r,i,s,a,o,n,l,c){"use strict";return{components:{"im-call-bar":t,"im-call-user-list":r,"im-call-self":i,"im-call-user-item":s,"im-call-speaker-name":a,"im-call-collaboration":o,"im-call-bar-item":n,"im-call-video-minimize":l,"im-call-panel-users":c},props:["room","isRightPanel","showUserList","userlist_at_top","showSelfView","backgroundImage","minimized"],data:function(){return{timeoutInterval:null,secondsLeftBeforeTimeout:0,timeoutMessageVisible:!1}},computed:{login_myself(){return this.$store.getters.myself.login},logins(){return this.$store.getters.logins_except_myself},speaker_id(){return this.$store.getters.speaker_id},feature_id(){return this.$store.getters.currentFeatureId},feature(){return!!this.feature_id&&this.$store.getters.feature(this.feature_id)},isODE(){return!!this.feature&&this.$store.getters.isODE(this.feature)},is3DPlay(){return!!this.feature&&this.$store.getters.is3DPlay(this.feature)},isWhiteboard(){return!!this.feature&&this.$store.getters.isWhiteboard(this.feature)},isConfetti(){return!!this.feature&&this.$store.getters.isConfetti(this.feature)},hasFeature(){return!!this.feature_id},hasSpeaker(){return!!this.speaker_id||!!this.feature_id},speaker_track_id(){return this.$store.getters.speaker_track_id},displayActionBar(){return this.$store.getters.displayActionBar},isDialerON(){return!!this.$store.getters.showDialer},isTelephonySupported(){return this.$store.getters.telephonyFeature}},methods:{toggleActionBar(){this.displayActionBar?this.$store.commit("closeActionBar"):this.$store.commit("openActionBar")},displaySelfView(){this.$store.commit("showSelfView"),this.$store.getters.selfViewInUserList&&this.displayUserList()},displayUserList(){this.$store.commit("showUserList",!0)},sendNbr(e){console.log("DIALER ",e)}},template:e}}),define("DS/InstantMessagingCall/api/desktop/interface",["DS/InstantMessagingCall/api/desktop/listeners_papi","DS/InstantMessagingCall/api/desktop/watchers","DS/InstantMessagingCall/store/index","DS/PlatformAPI/PlatformAPI"],function(e,t,r,i){"use strict";return{init:function(s){return r.commit("hideInvite"),i.subscribe("fromDesktopApp.ds.com",e),t.init("toDesktopApp.ds.com"),this}}}),define("DS/InstantMessagingCall/components/BaseLightbox/BaseLightbox",["text!DS/InstantMessagingCall/components/BaseLightbox/BaseLightbox.html","DS/InstantMessagingCall/components/LightboxContent/LightboxContent","DS/InstantMessagingCall/components/PanelMembers/PanelMembers","DS/InstantMessagingCall/components/PanelTimeline/PanelTimeline","DS/InstantMessagingCall/components/CustomType/CustomType"],function(e,t,r,i,s){"use strict";return{components:{"im-call-content":t,"im-call-members":r,"im-call-timeline":i,"im-call-type":s},data(){return{currentListPosition:"right",previousPanel:null,currentPanelComponent:null,sideActions:[{name:"minimize",fonticon:"resize-small",hidden:!1}],panel:{name:"right",show:!!this.currentPanel,fonticon:"users",showClose:!0,title:null},actions:{display_action_bar:{name:"display_action_bar",fonticon:"bottom-panel",label:this.$store.getters.nls("displayActionBar"),hidden:!0},members:{name:"members",fonticon:"users",label:this.$store.getters.nls("members")},timeline:{name:"timeline",fonticon:"chat-alt",label:this.$store.getters.nls("timeline"),hidden:!this.$store.state.call.timelineAvailable},list_at_top:{name:"list_at_top",fonticon:"table-row-column",label:this.$store.getters.nls("displayListTop"),hidden:!0,isUserListAction:!0},list_at_right:{name:"list_at_right",fonticon:"table-row-column",label:this.$store.getters.nls("displayListRight"),hidden:!0,isUserListAction:!0},add_list:{name:"add_list",fonticon:"table-column-add ",label:this.$store.getters.nls("addList"),hidden:!0,isUserListAction:!0},remove_list:{name:"remove_list",fonticon:"table-column-delete",label:this.$store.getters.nls("removeList"),hidden:!0,isUserListAction:!0},remove_list_from_top:{name:"remove_list",fonticon:"table-row-delete",label:this.$store.getters.nls("removeListTop"),hidden:!0,isUserListAction:!0},add_list_at_top:{name:"add_list_at_top",fonticon:"table-row-add",label:this.$store.getters.nls("addListTop"),hidden:!0,isUserListAction:!0}}}},computed:{hasSpeaker(){var e=!!this.$store.getters.speaker_id;return e||this.displayUserList(),e},backgroundImage(){return this.$store.getters.backgroundImage},actions_array(){var e=[];for(let t in this.actions)e.push(this.actions[t]);return e},room(){return this.$store.getters.accepted_room},showUserList(){return this.$store.getters.showUserList},showSelfView(){return this.$store.getters.showSelfView},labelArray(){return this.room&&this.$store.getters.roomName(this.room)?[this.$store.getters.roomName(this.room)]:this.room&&this.$store.getters.called_users_name(this.room.room_id)||this.$store.getters.accepters_name},displayActionBar(){return this.$store.getters.displayActionBar},minimized(){return this.$store.getters.minimized},logins(){return this.$store.getters.logins_except_myself},currentPanel(){var e=this.$store.getters.currentPanel;return e?(this.previousPanel&&e!=this.previousPanel&&(this.actions[this.previousPanel].selected=!1),this.actions[e].selected=!0,this.previousPanel=e,this.panel.show=!0,this.panel.title=this.$store.getters.nls(e),this.currentPanelComponent="im-call-"+e):(this.panel.show=!1,this.currentPanelComponent=null,this.previousPanel&&(this.actions[this.previousPanel].selected=!1),this.previousPanel=null),e}},methods:{endCall(){this.room&&this.$store.dispatch("endCall",this.room),this.track_event("close")},confirmEndCall(){return this.$confirm(this.$store.getters.nls("confirmEndCall"),this.$store.getters.nls("refuseCall"),{okLabel:this.$store.getters.nls("confirm"),cancelLabel:this.$store.getters.nls("cancel")})},beforeWindowUnload(){this.endCall()},closePanel(){this.$store.commit("currentPanel",null)},togglePanel(e){var t=e==this.previousPanel?null:e;this.$store.commit("currentPanel",t),t&&this.track_event(["togglePanel",e],1)},removeUserListAction(){for(let e in this.actions)this.actions[e].isUserListAction&&(this.actions[e].hidden=!0);return!0},addUserListAction(e){return this.removeUserListAction(),this.actions[e].hidden=!1,!0},userListAction(e){switch(e){case"add_list_at_top":this.displayUserList(),this.currentListPosition="top";break;case"remove_list":case"remove_list_from_top":this.hideUserList(),this.currentListPosition="hidden";break;case"add_list":this.displayUserList(),this.currentListPosition="right";break;case"list_at_top":this.currentListPosition="top";break;default:this.removeUserListAction(),this.displayUserList()}},hideUserList(){this.$store.commit("showUserList",!1)},displayUserList(){this.$store.commit("showUserList",!0)},chooseUserAction(e){e?this.showUserList?this.currentPanel?"right"==this.currentListPosition&&this.addUserListAction("remove_list")||this.addUserListAction("remove_list_from_top"):"right"==this.currentListPosition||"hidden"==this.currentListPosition?this.addUserListAction("list_at_top"):this.addUserListAction("remove_list_from_top"):!this.currentPanel&&this.addUserListAction("add_list")||this.addUserListAction("add_list_at_top"):this.removeUserListAction()},openActionBar(){this.$store.commit("openActionBar")},minimize(e,t){this.$store.commit("minimize",e),this.track_event("minimize",1)},track_event(e,t){this.$store.dispatch("track_event",{action:"topBar",dimensions:e,eventValue:t})}},created(){window.addEventListener("beforeunload",this.beforeWindowUnload)},beforeDestroy(){window.removeEventListener("beforeunload",this.beforeWindowUnload)},template:e}}),define("DS/InstantMessagingCall/components/InvitationItem/InvitationItem",["text!DS/InstantMessagingCall/components/InvitationItem/InvitationItem.html","DS/InstantMessagingCall/components/ActionBar/ActionBar"],function(e,t){"use strict";return{components:{"im-call-bar":t},props:["room_id"],computed:{room(){return this.$store.getters.room(this.room_id)},isCaller(){return this.room.IamTheCaller},isMinimizedCall(){return this.$store.getters.isAccepted},labelArray(){if(this.room){if(this.$store.getters.roomName(this.room))return[this.$store.getters.roomName(this.room)];if(!this.room.IamTheCaller&&this.room.user&&this.room.user.username)return[this.room.user.username]}return this.$store.getters.called_users_name(this.room_id)},label(){return this.labelArray&&this.labelArray.toString().replaceAll(",",", ")},callerLogin(){return this.room&&this.room.user.login},subtitle(){return this.isMinimizedCall&&this.$store.getters.nls("ongoing")||this.isCaller&&this.$store.getters.nls("calling")||this.$store.getters.nls("incoming")}},methods:{maximize(){this.$store.commit("minimize",!1),this.track_event("minimize",0)},track_event(e,t){this.$store.dispatch("track_event",{action:"topBar",dimensions:e,eventValue:t})}},template:e}}),define("DS/InstantMessagingCall/api/listeners_server",["DS/InstantMessagingCall/store/index"],function(e){"use strict";const t=function(e){return Object.assign({},e,{room_id:e.room_id||e.room&&e.room.room_id||e.data&&e.data.room_id,user_id:e.user_id||e.user&&e.user.user_id,login:e.login||e.user&&e.user.login})},r=["inviteSent","inviteReceived","callEnded","webrtcIceCandidate","SDP","callEvent","disconnected","connectTelWS"],i={base_url:null,connected(t={}){this.base_url=t.options.url,e.dispatch("connected",{clientDevice:t.clientDevice,devEnv:t.options.devEnv,tenant:t.options.platformId,user_id_myself:t.user_id,login_myself:t.userId,username_myself:t.username,appName:t.appName})},callAccepted(r){e.commit("webrtcConfig",function(e,t){if(e.webrtcConfig&&e.webrtcConfig.iceServers)for(var r=0;r<e.webrtcConfig.iceServers.length;r++)e.webrtcConfig.iceServers[r].urls=e.webrtcConfig.iceServers[r].url.replace("REPLACEMEWITHRTCDNS:3478",t+"/coturn"),e.webrtcConfig.iceServers[r].url=e.webrtcConfig.iceServers[r].url.replace("REPLACEMEWITHRTCDNS:3478",t+"/coturn");return e.webrtcConfig}(r,this.base_url)),e.commit("forceTURN",r.forceTURN),e.dispatch("accepted",t(r))}};for(let s of r)i[s]=function(r){return function(i){e.dispatch(r,t(i))}}(s);return i}),define("DS/InstantMessagingCall/components/InvitationList/InvitationList",["text!DS/InstantMessagingCall/components/InvitationList/InvitationList.html","DS/InstantMessagingCall/components/InvitationItem/InvitationItem"],function(e,t){"use strict";return{components:{"im-call-invitation-item":t},props:["rooms_id"],template:e}}),define("DS/InstantMessagingCall/api/interface",["DS/RTProxyDriver/RTProxyDriver","DS/InstantMessagingCall/api/listeners_server","DS/InstantMessagingCall/api/listeners_papi","DS/InstantMessagingCall/api/senders","DS/PlatformAPI/PlatformAPI","DS/InstantMessagingCall/store/index","DS/InstantMessagingCall/api/desktop/interface"],function(e,t,r,i,s,a,o){"use strict";return{audiovideoV2:!1,init:function(i){return this.audiovideoV2=i.audiovideoV2,this.PlatformAPI=s,t.base_url=i.base_url,e.addEvent("CONNECTED",t.connected),e.addEvent("DISCONNECTED",t.disconnected),e.addEvent("inviteSent",t.inviteSent),e.addEvent("inviteToCall",t.inviteReceived),e.addEvent("callAccepted",t.callAccepted),e.addEvent("callEnded",t.callEnded),e.addEvent("webrtcIceCandidateReceived",t.webrtcIceCandidate),e.addEvent("SDPreceived",t.SDP),e.addEvent("callEvent",t.callEvent),e.addEvent("connectTelWS",t.connectTelWS),s.subscribe("towidgetim.ds.com",r),s.subscribe("im.ds.com",r),(a.getters.isDesktopApp||a.getters.isDevEnv)&&o.init(),s.publish("fromwidgetim.ds.com",{evenement:"GETLOGINOKDATA"}),this}}}),define("DS/InstantMessagingCall/components/Base/Base",["text!DS/InstantMessagingCall/components/Base/Base.html","DS/InstantMessagingCall/components/BaseLightbox/BaseLightbox","DS/InstantMessagingCall/components/InvitationList/InvitationList"],function(e,t,r){"use strict";return{components:{"im-call-base-lightbox":t,"im-call-base-invite":r},computed:{bodyAlerts(){return this.$store.getters.bodyAlerts},isEnded(){return this.$store.getters.isEnded},isInvited(){return this.$store.getters.isInvited},isAccepted(){return this.$store.getters.isAccepted},showInvite(){return this.$store.getters.showInvite},currentBaseComponent(){return this.isAccepted&&(this.$store.getters.minimized?"im-call-base-minimized":"im-call-base-lightbox")||this.isInvited&&"im-call-base-invite"}},template:e}}),define("DS/InstantMessagingCall/main",["DS/RTProxyDriver/RTLogger","vuejs","DS/InstantMessagingCall/components/Base/Base","DS/InstantMessagingCall/store/index","DS/InstantMessagingCall/api/interface","css!DS/InstantMessagingCall/InstantMessagingCall.css"],function(e,t,r,i,s){"use strict";e.addLevel("Call","purple"),e.Call("InstantMessagingCall load 01/2023 23xFD01 service 2.10.4");const a={divID:"vue-im-call",addDiv:function(t){return document.getElementById(this.divID)?e.Call("InstantMessagingCall div already injected"):t?(this.divCall=document.createElement("div"),this.divCall.id=this.divID,void t.appendChild(this.divCall)):e.Call("InstantMessagingCall needs a div container")},initVm:function(s={}){if(this.vmCall)return e.Call("InstantMessagingCall initVm already done");this.vmCall=new t({el:"#"+this.divID,data:()=>s,components:{"im-call-base":r},store:i,template:"<im-call-base id="+this.divID+" />"})},initTransport:function(e){this.interface=s.init(e)},initStore:function(e){i.commit("tenant",e.platformId),i.commit("appName",e.appName),i.commit("swymUrl",e.swymUrl),i.dispatch("preloadNoises"),i.dispatch("getCollaborationFeatures")}};return{init:function(e){return a.initStore(e),a.addDiv(e.callContainer||document.body),a.initVm(e),a.initTransport(e),document.IMCall=document.IMCall||a,document.IMCall}}});