/*!  COPYRIGHT DASSAULT SYSTEMES 2021   */
define("DS/ENOXInterWdgCom/utils/linkOriginListenerHack",[],function(){"use strict";function t(){}let i;return t.prototype.initializeHooks=function(){if("undefined"!=typeof widget){widget.__isLinkOrigin=!1;let t=top.document.getElementById("m_"+widget.id).getElementsByClassName("widget-menu-icon ifwe-action-icon fonticon fonticon-down-open clickable")[0];if(t){let i=function(t){var i=top.document.getElementById("linkWithWidgets");let e=function(){widget.__isLinkOrigin=!0,setTimeout(function(){top.document.getElementsByClassName("cancel-btn btn-default btn btn-root")[0].addEventListener("click",function(){widget.__isLinkOrigin=!1},{once:!0})},250)};i&&(console.log("SUB LINK WITH NO TIMEOUT"),i.addEventListener("click",e,{once:!0})),setTimeout(function(){(i=top.document.getElementById("linkWithWidgets"))&&(console.log("SUB LINK TIMEOUT"),i.addEventListener("click",e,{once:!0}))},100),setTimeout(function(){(i=top.document.getElementById("linkWithWidgets"))&&(console.log("SUB LINK TIMEOUT"),i.addEventListener("click",e,{once:!0}))},300)};t.addEventListener("click",i)}}},i||(i=new t)}),define("DS/ENOXInterWdgCom/LinkManager",["text!DS/ENOXInterWdgCom/assets/init/ENOWidgetLinkEvents.json","DS/PADServices/utils/PADTrackerManager","DS/PlatformAPI/PlatformAPI","DS/PADUtils/PADContext","DS/PADServices/utils/GlobalModelEvents","DS/ENOXInterWdgCom/utils/linkOriginListenerHack"],function(t,i,e,n,s,d){"use strict";var o=JSON.parse(t),r=!1;function a(){this._widgetLink=null,this._biFilterReady=!1,this._attemptedSubscriptions=new Map,this._otherWidgetID=null,this._isSynchronizing=!1,this._matchingFeatures=[],this._isInitiator=!1,this._initiatorHasBeenSet=!1}let h;return a.prototype.initializeWidgetLink=function(t,i){const n=parent.require;return new Promise((o,r)=>{window.__karma__?(console.warn("We are in karma test environment, thus preventing the use of WidgetLink."),o()):n(["DS/WidgetLink/WidgetLink"],function(n){if(this._widgetLink=n.get(t),t){this._widgetLink.setLinkability(i),this._setMatchingFeatures(this._widgetLink.getLinked()),d.initializeHooks(),this.addWidgetLinkHit("initialize",t.data.appId),this._linkViewAllSync=this._widgetLink.createView(t=>t.matchLinkability().matchingImplements.includes("ENXContentSync2D")||t.matchLinkability().matchingImplements.includes("ENXContentSync3D")),s.subscribe({event:"ENXModel/Root/FBIProxy"},()=>{this._biFilterReady=!0,this.checkLinkActive(),this._linkBIProxyOfLinks(this._widgetLink.getLinked())}),this._nbReadyForSync=0;e.subscribe("DS/ExternalWdgtCom/ReadyForSync",function(){let i=this._widgetLink.getLinked();this._nbReadyForSync++,this._nbReadyForSync==i.length+1&&(t.__isLinkOrigin&&!this.isWidgetSynchronizing()?(this._isInitiator=!0,this._initSourceWidgetId(),this._onSync(i),this._nbReadyForSync=0):(t.__isLinkOrigin=!1,this._isInitiator=!1,this._initSourceWidgetId()))}.bind(this));this._widgetLink.subscribe("DS/InternalWdgtCom/InitiatorSet",function(){this._initiatorHasBeenSet=!0,this._initSourceWidgetId()}.bind(this)),this._widgetLink.subscribe("DS/InternalWdgtCom/WidgetLinkInitialized",function(){this._setInitiatorOnLoad()}.bind(this)),this._widgetLink.addEventListener("link",this._onLink.bind(this)),this._widgetLink.addEventListener("unlink",this._onUnLink.bind(this)),this._partnerAppView=this._widgetLink.createView(function(i){return i.x3dSharedId===t.getValue("x3dSharedId")}),this._partnerAppView.publish("DS/InternalWdgtCom/WidgetLinkInitialized")}o()}.bind(this))})},a.prototype._setInitiatorOnLoad=function(){let t=widget.getValue("x3dSharedId");this.isLinkedWithPartnerApp(t)&&!this._initiatorHasBeenSet&&(this._isInitiator=!0,this._initiatorHasBeenSet=!0,this._initSourceWidgetId(),this._partnerAppView.publish("DS/InternalWdgtCom/InitiatorSet"))},a.prototype._setMatchingFeatures=function(t){let i=[];t.forEach(t=>{let e=t.matchLinkability().matchingFeatures;e.length>0&&i.push(e.filter(function(t,i){return e.indexOf(t)==i}))}),i.length>1?this._matchingFeatures=i.shift().filter(function(t){return i.every(function(i){return-1!==i.indexOf(t)})}):1==i.length?this._matchingFeatures=i[0]:this._matchingFeatures=[]},a.prototype._onLink=function(t){this.setWidgetSynchronizing(!1),this._nbReadyForSync=0;let i=this._widgetLink.getLinked(),s=t.link,d=(s.x3dAppId,s.appId);this._setMatchingFeatures(i),this._subscribeAfterLink(),this.addWidgetLinkHit("link",d),this.checkLinkActive(),this._initiatorHasBeenSet||("ENOSC2D_AP"==widget.getValue("appId")?this._isInitiator=!0:this._isInitiator=!1,this._initiatorHasBeenSet=!0,this._initSourceWidgetId()),n.get()&&e.publish("DS/ExternalWdgtCom/ReadyForSync")},a.prototype._onUnLink=function(t){let i=t.link;i&&(widget.isLinkOrigin=!1,this._setMatchingFeatures(this._widgetLink.getLinked()),this._subscribeAfterLink(),this._biFilterReady?(this._unLinkBIProxy(i.id),this._resetSourceWidgetId()):s.subscribe({event:"ENXModel/Root/FBIProxy"},()=>{this._unLinkBIProxy(i.id),this._resetSourceWidgetId()}),this.addWidgetLinkHit("unlink",i.appId)),this.checkLinkActive()},a.prototype.addWidgetLinkHit=function(t,e){var n=i.getPADTracker({eventCategory:"widgetlink",eventAction:t});n.setEventData({eventLabel:e}),n.trackPageEvent()},a.prototype.updateLinkability=function(t){this._widgetLink?this._widgetLink.setLinkability(t):this._handleNoWidgetLink()},a.prototype.createView=function(t){if(this._widgetLink)return this._widgetLink.createView(t);this._handleNoWidgetLink()},a.prototype.getOtherWidgetID=function(){return this._otherWidgetID},a.prototype.setOtherWidgetID=function(t){this._otherWidgetID=t},a.prototype.subscribe=function(t,i){if(this._widgetLink){let e=t.split("/"),n=e[e.length-1],s=o[n];if(s){let e=s.feature,n=this._attemptedSubscriptions.get(t)||[];if(n.push(i),this._attemptedSubscriptions.set(t,n),this._matchingFeatures.includes(e))return this._widgetLink.subscribe(t,i);if("ENXContentSync"===e&&(this._matchingFeatures.includes("ENXContentSync2D")||this._matchingFeatures.includes("ENXContentSync3D")))return this._widgetLink.subscribe(t,i);if("ENXContent"===e&&this._matchingFeatures.includes("ENXOpen"))return this._widgetLink.subscribe(t,i)}}else this._handleNoWidgetLink()},a.prototype._reSubscribe=function(t,i){let e=t.split("/"),n=e[e.length-1],s=o[n];if(s){let e=s.feature;if(this._matchingFeatures.includes(e))return this._widgetLink.subscribe(t,i);if("ENXContentSync"===e&&(this._matchingFeatures.includes("ENXContentSync2D")||this._matchingFeatures.includes("ENXContentSync3D")))return this._widgetLink.subscribe(t,i);if("ENXContent"===e&&this._matchingFeatures.includes("ENXOpen"))return this._widgetLink.subscribe(t,i)}},a.prototype._subscribeAfterLink=function(){for(const[t,i]of this._attemptedSubscriptions){this.unsubscribe(t);for(let e=0;e<i.length;e++)this._reSubscribe(t,i[e])}},a.prototype.unsubscribe=function(t){this._widgetLink?this._widgetLink.unsubscribe(t):this._handleNoWidgetLink()},a.prototype.publish=function(t,i){this._widgetLink?this._widgetLink.getLinked().length>0&&this._widgetLink.publish(t,i):this._handleNoWidgetLink()},a.prototype.getLinkedWithAppId=function(t){return this.getLinked().filter(i=>i.appId===t)},a.prototype.checkLinkActive=function(){var t=this.getLinked();let i=widget.getValue("x3dSharedId");if(this.setOtherWidgetID(void 0),this.isLinkedWithPartnerApp(i)){var e=t.filter(t=>t.x3dSharedId===i);if(e&&e.length>=1){let t=e[0];this.setOtherWidgetID(t.id)}}},a.prototype._initSourceWidgetId=function(){var t=this.getLinked();let i=widget.getValue("x3dSharedId");if(this.isLinkedWithPartnerApp(i)){var e=t.filter(t=>t.x3dSharedId===i);if(e&&e.length>=1){let t=e[0];this._isInitiator?this._linkSrcWdgtID=widget.id:this._linkSrcWdgtID=t.id}}},a.prototype.setSourceWidgetId=function(t){this._linkSrcWdgtID=t},a.prototype.getSourceWidgetId=function(){return this._linkSrcWdgtID},a.prototype._resetSourceWidgetId=function(){this._linkSrcWdgtID=widget.id},a.prototype._linkBIProxyOfLinks=function(t){try{t.forEach(t=>{n.get()._linkBIProxy(this._linkSrcWdgtID)})}catch(t){console.log(t),console.error("Something went wrong with WidgetLink BIProxy")}},a.prototype.getLinked=function(){return this._widgetLink?this._widgetLink.getLinked():void this._handleNoWidgetLink()},a.prototype.setLinked=function(t){this._widgetLink?"undefined"!=typeof widget&&widget.id&&top.require("DS/Dashboard/WidgetLinkManager").setLinked(widget.id,t):this._handleNoWidgetLink()},a.prototype._handleNoWidgetLink=function(){r||(console.error("Widget Link is not initialized, further calls to Widget Link will be ignored"),r=!0)},a.prototype._onSync=function(t){let i=t.filter(t=>t.matchLinkability().matchingImplements.includes("ENXContentSync2D")||t.matchLinkability().matchingImplements.includes("ENXContentSync3D"));if(i.length>0){this.setWidgetSynchronizing(!0);let t=n.get()._onGetContentForSync();this._linkViewAllSync.publish("DS/ExternalWdgtCom/GetInfosForSync");let s=0,d=[],o=e.subscribe("DS/ExternalWdgtCom/GetInfosForSync",n=>{s++,d.push({id:n.id,sharedID:n.sharedID,isLinkedWithPartnerApp:n.isLinkedWithPartnerApp}),s==i.length&&(this._processSyncInfos(d,t),e.unsubscribe(o))})}},a.prototype._processSyncInfos=function(t,i){let e=t.length+1,n=(t=this._addFlagForLinkedMultiWdgtApps(t)).filter(t=>t.onlyRemove).map(t=>t.id);e>1&&this._launchSync({widgetsOnlyRemove:n,rootsToSync:i,nbWdgtsToSync:e})},a.prototype._launchSync=function(t){var i=this;let s,d,o={srcWidgetID:widget.id,widgetsOnlyRemove:t.widgetsOnlyRemove,rootsToSync:t.rootsToSync,nbWdgtsToSync:t.nbWdgtsToSync},r=0;var a=function(o){++r>=t.nbWdgtsToSync&&(n.get()._endSync(),i._linkViewAllSync.publish("DS/ExternalWdgtCom/EndSync"),this._widgetLink.unsubscribe(s),e.unsubscribe(d))}.bind(this);s=this._widgetLink.subscribe("DS/ExternalWdgtCom/FinishedSync",a),d=e.subscribe("DS/ExternalWdgtCom/FinishedSync",a),n.get()._onSyncContent(o),this._linkViewAllSync.publish("DS/ExternalWdgtCom/SyncContent",o)},a.prototype._addFlagForLinkedMultiWdgtApps=function(t){let i=t.filter(t=>t.sharedID&&void 0!==t.sharedID),e=[...new Set(i.map(t=>t.sharedID))],n=new Map;for(let t=0;t<e.length;t++){let s=e[t];i.forEach(t=>{t.sharedID===s&&(n.has(s)?n.get(s).push(t):n.set(s,[t]))})}let s=[];for(const[t,i]of n)2==i.length?(i[0].onlyRemove=!0,i[0].isLinkedWithPartnerApp&&i[1].isLinkedWithPartnerApp&&(i[0].sharedID!=widget.getValue("x3dSharedId")&&i[1].sharedID!=widget.getValue("x3dSharedId")||(i[0].onlyRemove=!1,i[1].onlyRemove=!1)),s.push(i[0],i[1])):1==i.length&&s.push(i[0]);return s},a.prototype._waitForSync=function(t,i){let e={nonMultiWdgsIDs:t,multiWdgsIDs:i};n.get()._waitForSync(e),this._linkViewAllSync.publish("DS/ExternalWdgtCom/WaitForSync",e)},a.prototype.isLinkedWithPartnerApp=function(t){return this.getLinked().filter(i=>i.x3dSharedId===t).length>0},a.prototype._unLinkBIProxy=function(t){let i=this._isInitiator?widget.id:t,e=widget.id;n.get()._unLinkBIProxy(i,e),this._isInitiator=!1,widget.__isLinkOrigin=!1,delete this._linkSrcWdgtID},a.prototype.isWidgetSynchronizing=function(){return this._isSynchronizing},a.prototype.setWidgetSynchronizing=function(t){this._isSynchronizing=t},h||(h=new a)}),define("DS/ENOXInterWdgCom/Proxy",["i18n!DS/PADUtils/assets/nls/PADUtils.json","text!ENOXInterWdgCom/assets/conf/InterCommWdg.json","DS/PlatformAPI/PlatformAPI","DS/ENOXInterWdgCom/LinkManager","DS/Utilities/UUID","DS/PADUtils/PADSettingsMgt"],function(t,i,e,n,s,d){"use strict";var o=JSON.parse(i),r={};for(var a in o.events)if(void 0!==o.events[a]){var h=c(a);o.events[a].callback=h,r[h]=a}function c(t){return"on"+t.charAt(0).toUpperCase()+t.slice(1)}function g(t,i,e){var n=i+t;return e&&void 0!==o.events[t]&&!0===o.events[t].private&&(n+=e),n}function l(t){for(var i in t)void 0!==t[i]&&void 0===_.prototype[i]&&(_.prototype[i]=function(t){return function(i){this.__publish(t,i)}}(i))}function u(t,i,e){return{metadata:{uid:s.v4(),originUid:t,timestamp:Date.now(),appid:(n="/no_private_channel","undefined"!=typeof widget&&null!==widget&&(void 0!==widget.getValue("x3dSharedId")?n="/"+widget.getValue("x3dSharedId"):void 0!==widget.getValue("x3dAppId")?n="/"+widget.getValue("x3dAppId"):void 0!==widget.getValue("appId")&&(n="/"+widget.getValue("appId")+"_"+widget.id)),n),xappid:"undefined"!=typeof widget&&null!==widget&&widget.getValue("x3dAppId")?widget.getValue("x3dAppId"):"default-app-id",originWidgetId:void 0!==e?e:"undefined"!=typeof widget&&null!==widget?widget.id:"default-widget-id"},data:i};var n}function p(t,i,e,n,s){this.ownerProxyUid=t,this.eventHandlingFunction=i,this.ignoreMyEvents=e,this.lastConsumeEvent=void 0,this.topic=n,this.isPrivate=s,s&&(this.topic=this.topic.substr(0,this.topic.lastIndexOf("/")))}function _(t){if(this._uid=s.v4(),this._commands=t.commands,this._subs=[],this._widgetLinkSubs=[],this._debugAppId="unknown","undefined"!=typeof widget&&null!==widget&&(void 0!==widget.data.appId&&null!==widget.data.appId?this._debugAppId=widget.data.appId:void 0!==widget.data.x3dAppId&&null!==widget.data.x3dAppId&&(this._debugAppId=widget.data.x3dAppId)),t.commands){for(var i in t.commands)if(void 0!==t.commands[i]&&void 0===o.events[i]){o.events[i]=Object.assign(t.commands[i],{undefinedDefaultEvent:!0});var e=c(i);o.events[i].callback=e,r[e]=i}l(t.commands),this._cmds=t.commands}this._otherPrefix=t.prefix,this._privateChannel=t.privateChannel,this._widgetLinkProxyActive=d.getSetting("activateWidgetLinkInterCom"),this.addProxyEvents(t)}return l(o.events),p.prototype.handleEvent=function(t){if(!(!0===this.ignoreMyEvents&&t.metadata.originUid===this.ownerProxyUid||!0===t.metadata.ignoreFromSameWidgetId&&t.metadata.originWidgetId===("undefined"!=typeof widget&&null!==widget?widget.id:"")))try{if(this.lastConsumeEvent!==t.metadata.uid){this.lastConsumeEvent=t.metadata.uid;let i="unknown";"undefined"!=typeof widget&&null!==widget&&(void 0!==widget.data.appId&&null!==widget.data.appId?i=widget.data.appId:void 0!==widget.data.x3dAppId&&null!==widget.data.x3dAppId&&(i=widget.data.x3dAppId)),this.eventHandlingFunction(t.data,t.metadata)}}catch(i){console.error("Error while handling event %o",t),console.error(i)}},_.prototype.destroy=function(){this._subs&&(this._subs.forEach(function(t){e.unsubscribe(t)}),delete this._subs),this._widgetLinkSubs&&(this._widgetLinkSubs.forEach(function(t){n.unsubscribe(t)}),delete this._widgetLinkSubs),this.destroyed=!0},_.prototype.addProxyEvents=function(t){let i=t.prefix?t.prefix:this._otherPrefix,s=t.privateChannel?t.privateChannel:this._privateChannel,d=t.events;if(d)for(var a in d){var h=r[a];if(h){var c=d[a];if("function"==typeof c||Array.isArray(c)&&c.length>0&&"function"==typeof c[0]){var l,u=!0;"function"==typeof c?l=c:(l=c[0],u=c.length<2||!1!==c[1]);var _=g(h,o.prefix,s),f=g(h,o.prefix);let t=!!this._commands[h]&&this._commands[h].private,d=!!this._commands[h]&&this._commands[h].isWidgetLink,r=!!this._commands[h]&&this._commands[h].isPlatformAPI;var k=new p(this._uid,l,u,_,t);let a=this._widgetLinkProxyActive&&d&&"undefined"!=typeof widget&&null!==widget&&widget.data&&void 0===window.__karma__;a&&(n.subscribe(f,k.handleEvent.bind(k)),this._widgetLinkSubs.push(f)),!r&&this._widgetLinkProxyActive||this._subs.push(e.subscribe(_,k.handleEvent.bind(k))),i&&this._cmds[h]&&(_=g(h,i,s),f=g(h,i),a&&(n.subscribe(f,k.handleEvent.bind(k)),this._widgetLinkSubs.push(f)),!r&&this._widgetLinkProxyActive||this._subs.push(e.subscribe(_,k.handleEvent.bind(k))))}else console.warn("Input [events.%s] is not a function",a)}else console.info("Input [events.%s] is not a known event",a)}},_.prototype.__publish=function(t,i){if(!0===this.destroyed)throw new Error("This proxy has been destroyed");var s=g(t,o.prefix,this._privateChannel),d=g(t,o.prefix);!!this._commands[t]&&this._commands[t].private;let r=!!this._commands[t]&&this._commands[t].isWidgetLink,a=!!this._commands[t]&&this._commands[t].isPlatformAPI;var h=u(this._uid,i,this.odtWidgetId);let c=this._widgetLinkProxyActive&&r&&"undefined"!=typeof widget&&null!==widget&&widget.data&&void 0===window.__karma__;c?n.publish(d,h):!a&&this._widgetLinkProxyActive||e.publish(s,h,["web","web-in-win"]),this._otherPrefix&&(s=g(t,this._otherPrefix,this._privateChannel),d=g(t,this._otherPrefix),c&&n.publish(d,h),!a&&this._widgetLinkProxyActive||e.publish(s,h,["web","web-in-win"]))},_});