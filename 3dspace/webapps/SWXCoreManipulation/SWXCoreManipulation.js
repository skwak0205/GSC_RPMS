define("DS/SWXCoreManipulation/xAppControlPreferencesPanel",["UWA/Core","UWA/Class","i18n!SWXCoreManipulation/assets/nls/xAppControlPreferencesPanel","css!SWXCoreManipulation/xAppControlPreferencesPanel"],function(t,e,i){"use strict";var o=e.extend({_profile:0,_resources:i.get("MouseControlPreferences"),init:function(){Object.defineProperty(this,"profile",{get(){return this._profile},set(t){this._profile=t}}),Object.defineProperty(this,"resources",{get(){return this._resources}})},_cleanup:function(){this._dialog&&(this._dialog.immersiveFrame.destroy(),this._dialog.destroy()),this._dialog=null},show:function(){if(this._dialog)return Promise.reject(new Error("xAppMouseControlPreferences.show() - Dialog already displayed."));var e=this;return new Promise(i=>{require(["DS/Windows/ImmersiveFrame","DS/Windows/Dialog","DS/Controls/Toggle","DS/Controls/ButtonGroup","DS/Controls/Button","DS/Controls/Popup"],function(o,n,r,s,a,l){let h=new o({});h.inject(document.body);let c=t.createElement("div",{class:"visu-preferences-dialog-content"}),u=t.createElement("div",{class:"visu-preferences-profiles-title"}).inject(c);t.createElement("h5").inject(u).innerText=e.resources.Profiles.Title;let p=new l({target:t.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-info help-icon"}).inject(u),trigger:"hover",arrowBoxFlag:!0,position:"bottom",alignment:"center",offset:{x:0,y:3}}),d=t.createElement("div",{class:"visu-preferences-popup-content"});t.createElement("p",{class:"visu-preferences-profiles-information"}).inject(d).innerText=e.resources.Information.Description,p.setBody(d),t.createElement("p",{class:"visu-preferences-profiles-description"}).inject(c).innerText=e.resources.Profiles.Description_part_1;let g=new s({id:"GroupButtonMouseProfile",type:"radio"});["3DEXPERIENCE","CATIA","SOLIDWORKS"].forEach((t,i)=>g.addChild(new r({type:"radio",label:e.resources.Profiles[t],value:i}))),g.selectValue(e.profile),g.inject(c),t.createElement("p",{class:"visu-preferences-profiles-description"}).inject(c).innerText=e.resources.Profiles.Description_part_2,t.createElement("p",{class:"visu-preferences-profiles-description"}).inject(c).innerText=e.resources.Profiles.Description_part_3,e._dialog=new n({immersiveFrame:h,modalFlag:!0,title:e.resources.Title,content:c,closeButtonFlag:!0,minWidth:285,width:285,visibleFlag:!0,buttons:{Ok:new a({onClick:async()=>{e._validated=!0,e.profile="array"===t.typeOf(g.value)?g.value[0]:g.value,e._dialog.close()}})}}),e._dialog.addEventListener("close",()=>{e._cleanup(),i(e._validated?e.profile:-1)})})})},close:function(){this._dialog&&this._dialog.close()}});return t.namespace("DS/SWXCoreManipulation/xAppControlPreferencesPanel",o)}),define("DS/SWXCoreManipulation/SWXCoreViewManipulation",["UWA/Core","UWA/Class","UWA/Utils/Client","DS/VisuEvents/EventsManager","DS/Visualization/TrackballControls","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Visualization/Viewpoint","DS/Mesh/MeshUtils","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/PathElement","DS/Visualization/SceneGraphFactory","DS/Visualization/SubElement","DS/Visualization/GeometryHelper","DS/Visualization/Node3D","DS/SceneGraphNodes/BillBoardNode3D","DS/Utilities/TouchUtils"],function(t,e,i,o,n,r,s,a,l,h,c,u,p,d,g,v,m,f){"use strict";const w=e.extend({addVisuEvent:function(t,e,i){for(var n=0;n<this._eventCallbacks.length;n++){var r=this._eventCallbacks[n];if(r.view===t&&r.action===e&&r.callback===i)return void++this._eventCallbacks[n].count}var s={view:t,action:e,callback:i,count:1};o.addEvent(t,e,i),this._eventCallbacks.push(s)},removeVisuEvent:function(t,e,i){let n=-1;for(var r=0;r<this._eventCallbacks.length&&-1===n;r++){const o=this._eventCallbacks[r];o.view===t&&o.action===e&&o.callback===i&&(n=r)}if(-1!==n&&(--this._eventCallbacks[n].count,0===this._eventCallbacks[n].count)){var s=this._eventCallbacks[n];o.removeEvent(s.view,s.action,s.callback),this._eventCallbacks.splice(n,1)}},init:function(){this.scrollZoomCb=this.scrollZoom.bind(this),this.leftMouseDownCb=this.leftMouseDown.bind(this),this.leftMouseMoveCb=this.leftMouseMove.bind(this),this.leftMouseUpCb=this.leftMouseUp.bind(this),this.middleMouseDownCb=this.middleMouseDown.bind(this),this.middleMouseMoveCb=this.middleMouseMove.bind(this),this.middleMouseUpCb=this.middleMouseUp.bind(this),this.rightMouseDownCb=this.rightMouseDown.bind(this),this.rightMouseMoveCb=this.rightMouseMove.bind(this),this.alwaysonMouseOutCb=this.alwaysonMouseOut.bind(this),this.rightMouseUpCb=this.rightMouseUp.bind(this),this.keyDownCb=this.keyDown.bind(this),this.keyUpCb=this.keyUp.bind(this),this.alwaysOnMouseMoveCb=this.alwaysOnMouseMove.bind(this),this.alwaysOnLeftUpCb=this.alwaysOnLeftUp.bind(this),this.windowWheelEventCB=this.windowWheelEvent.bind(this),this.enableViewerCallbacks=!1,this._eventCallbacks=[]},setup:function(t){this.options=t||{},this.isMacOS=Boolean(this.options.IsMacOS||i.Platform.macintel),this.isSafari=Boolean(this.options.IsSafari||i.Engine.safari),this.isTouch=Boolean(this.options.IsTouch||i.Features.touch),this.setupTouchEvents(),this.viewer=t.viewer,this.viewPoint=this.viewer.currentViewpoint,this.control=this.viewPoint.control,this.rotateCenterOfModel=new r.Vector3(0,0,0),this.lastCursor=null,this.originalCursor=null,this.isEscapable=!1,this.isRotating=!1,this.isPanning=!1,this.isZooming=!1,this.isAnimating=!1,this.isShiftPinchTriggered=!1,this.zoomToCenterDeltaY=0,this.customMouseMoveHandler=null,t.customMouseMoveHandler&&(this.customMouseMoveHandler=t.customMouseMoveHandler),this.customPrepareForRotationHandler=null,t.customPrepareForRotationHandler&&(this.customPrepareForRotationHandler=t.customPrepareForRotationHandler),this._origCenterMouseUpCB=this.viewer.centerMouseUpCB},enable:function(){if(!this._enabled){if(this._enabled=!0,this._controlsConfigEventToken=s.subscribe({event:"/SWXVisu/ControlsConfig"},t=>{this.enableViewerCallbacks=t.viewerCallbacks}),void 0===o._isInit&&o.init(),this.addVisuEvent(this.viewer.canvas,"onLeftMouseDown",this.leftMouseDownCb),this.addVisuEvent(this.viewer.canvas,"onMiddleMouseDown",this.middleMouseDownCb),this.isMacOS&&this.isSafari||this.addVisuEvent(this.viewer.canvas,"onRightMouseDown",this.rightMouseDownCb),this.addVisuEvent(this.viewer.canvas,"onKeyDown",this.keyDownCb),this.addVisuEvent(this.viewer.canvas,"onKeyUp",this.keyUpCb),this.addVisuEvent(this.viewer.canvas,"onMouseMove",this.alwaysOnMouseMoveCb),this.addVisuEvent(this.viewer.canvas,"onLeftMouseUp",this.alwaysOnLeftUpCb),this.isMacOS){this.addBrowserEvent(window,"wheel",this.windowWheelEventCB,{passive:!1});for(var t=0;t<window.length;t++)1===t&&(this.addBrowserEvent(window[t],"gesturestart",this.windowGestureStartEvent.bind(this,t)),this.addBrowserEvent(window[t],"gesturechange",this.windowGestureChangeEvent.bind(this,t)),this.addBrowserEvent(window[t],"gestureend",this.windowGestureEndEvent.bind(this,t)))}else this.addVisuEvent(this.viewer.canvas,"onMouseWheel",this.scrollZoomCb);this._origControlLockMouse=this.control.lockMouse,this.control.setMouseActive(!1),this.setupRotationHelpers()}},addBrowserEvent:function(t,e,i,o){this._browserEvents||(this._browserEvents=[]),t.addEventListener(e,i,o),this._browserEvents.push({target:t,name:e,cb:i})},disable:function(){this._enabled&&(this._enabled=!1,this.control.setMouseActive(!this._origControlLockMouse),this._controlsConfigEventToken&&(s.unsubscribe(this._controlsConfigEventToken),this._controlsConfigEventToken=null),this._eventCallbacks.forEach(t=>{o.removeEvent(t.view,t.action,t.callback)}),this._eventCallbacks=[],this._browserEvents&&(this._browserEvents.forEach(t=>{t.target.removeEventListener(t.name,t.cb)}),this._browserEvents=[]),this.viewer&&(this.viewer.centerMouseUpCB=this._origCenterMouseUpCB))},setupTouchEvents:function(){if(this.isTouch){void 0===o._isInit&&o.init();var t=function(t){this.endRotation(null),window.visualViewport&&window.visualViewport.scale>1?(this._touchEventsUnsubscribedOnBrowserZoomLevel||(o._detachTouchEvents(),this._touchEventsUnsubscribedOnBrowserZoomLevel=!0),t.stopPropagation()):this._touchEventsUnsubscribedOnBrowserZoomLevel&&!t.touches.length&&(this._touchEventsUnsubscribedOnBrowserZoomLevel=!1,o._attachTouchEvents())};document.addEventListener("touchend",t.bind(this),{capture:!0,passive:!1}),document.addEventListener("touchcancel",t.bind(this),{capture:!0,passive:!1});var e=function(t){this._touchEventsUnsubscribedOnBrowserZoomLevel&&t.stopPropagation()};document.addEventListener("touchstart",e.bind(this),{capture:!0,passive:!1}),document.addEventListener("touchmove",e.bind(this),{capture:!0,passive:!1})}},windowWheelEvent:function(t){if(t){if(this.viewer.canvas!==t.target){let e=t.target,i=Math.abs(t.deltaY)>Math.abs(t.deltaX);for(;!i&&e&&e!==document.body;){let o=window.getComputedStyle(e);(i=("auto"===o.getPropertyValue("overflow-x")||"scroll"===o.getPropertyValue("overflow-x"))&&e.scrollWidth>e.offsetWidth)&&(0===e.scrollLeft&&t.deltaX<0||e.scrollLeft>=e.scrollWidth-e.offsetWidth&&t.deltaX>0)&&(i=!1),e=e.parentElement}return void(i||t.preventDefault())}t.preventDefault()}if(t&&t.target&&!this._rightMouseDown){var e;if(0===t.deltaX&&Math.trunc(t.deltaY)-t.deltaY!=0)return this.scrollZoom(t);try{e=this.viewer.canvas.getBoundingClientRect()}catch(t){e={left:0,top:0}}var i=new r.Vector2(t.clientX-e.left,t.clientY-e.top);if(this.wheelLastPosition&&this.wheelLastPosition.x===i.x&&this.wheelLastPosition.x===i.y||(this.wheelLastPosition=i.clone(),void 0===this._zoomFactor&&(this._zoomFactor=0)),this.isCtrlPressed(t)){var o=t.deltaY<0,s=this.control._zoomType,a=this._zoomFactor;if(a+=o?-1:1,Math.abs(t.deltaY)>1&&a<100){var l=this.wheelLastPosition;this.setCursor("Zoom"),s===n.ZoomType.ZOOM_FOV_CHANGE?this.control._zoomFOVChange(l,o,o?.95:1.05):this.control._zoomSimple(l,o,o?.95:1.05),this.control.update(),this._zoomFactor=a,this.resetCursorWithTimeout()}}else{var h=i.clone();if(h.x-=2*t.deltaX,h.y-=2*t.deltaY,t.altKey)this.setCursor("Pan"),this.doPan(h,this.wheelLastPosition),this.resetCursorWithTimeout();else{t.shiftKey&&this.isZooming&&(this.isRotating=!1,this.isPanning=!1,this.isZooming=!1,this.restoreOriginalCursor(),this.isShiftPinchTriggered=!1),t.currentPosition=h,null===this.rotationOriginVisuHelper.originVisu&&(!1===this.rotationOriginVisuHelper.rotationCursor&&(this.saveOriginalCursor(),this.rotationOriginVisuHelper.rotationCursor=!0,this.prepareForRotation(t)),this.setCursor("Rotate")),this.doRotate(h,this.wheelLastPosition),this.rotationOriginVisuHelper.wheeling&&(clearTimeout(this.rotationOriginVisuHelper.wheeling),this.rotationOriginVisuHelper.wheeling=null);let e=Number(this.options.RotationTrackpadTimeout||250);this.rotationOriginVisuHelper.wheeling=setTimeout(()=>{clearTimeout(this.rotationOriginVisuHelper.wheeling),this.rotationOriginVisuHelper.wheeling=null,this.restoreOriginalCursor(),this.rotationOriginVisuHelper.rotationCursor=!1,this.endRotation(t)},e)}}}},resetCursorWithTimeout:function(){this.wheelGestureTimeout&&(clearTimeout(this.wheelGestureTimeout),this.wheelGestureTimeout=null);let t=this.options.RotationTrackpadTimeout||250;this.wheelGestureTimeout=setTimeout(()=>{clearTimeout(this.wheelGestureTimeout),this.wheelGestureTimeout=null,this.setCursor("auto")},t)},windowGestureStartEvent:function(t,e){var i;e.preventDefault();try{i=this.viewer.canvas.getBoundingClientRect()}catch(t){i={left:0,top:0}}this.rotation=0,this.scale=0,this.position=new r.Vector2(e.clientX-i.left,e.clientY-i.top)},windowGestureChangeEvent:function(t,e){if(e&&e.preventDefault(),!this._rightMouseDown){var i;try{i=this.viewer.canvas.getBoundingClientRect()}catch(t){i={left:0,top:0}}var o=new r.Vector2(e.clientX-i.left,e.clientY-i.top),s=-2.5*e.rotation,a=e.scale;if(Math.abs(a-this.scale)>.01&&a>.01&&a<4){var l=a-this.scale>0,h=o;this.control._zoomType===n.ZoomType.ZOOM_FOV_CHANGE?this.control._zoomFOVChange(h,l,l?.95:1.05):this.control._zoomSimple(h,l,l?.95:1.05),this.control.update(),this.scale=a}var c=s-this.rotation;if(this.rotation=s,Math.abs(c)>1){var u=new r.Vector2(c,0),p=new r.Vector2(0,0);this.doRotate(u,p,!0)}}},windowGestureEndEvent:function(t,e){e.preventDefault()},alwaysOnMouseMove:function(t){var e=t.from&&t.from.length?t.from[0]:null;null!==e&&(t.from.length<=1&&(this.rotationOriginVisuHelper.rmbRotationOn&&this.rightMouseUp(t),this.rotationOriginVisuHelper.mmbRotationOn&&this.middleMouseUp(t)),this.enableViewerCallbacks&&(this.control._publishWUXEvent("PrimaryPointerMove",t,!0),this.control._pickingCB&&this.viewer&&this.viewer.mouseMoveCB&&this.viewer.mouseMoveCB(e,this.control)))},alwaysOnLeftUp:function(t){var e=t.from&&t.from.length?t.from[0]:null;null!==e&&this.enableViewerCallbacks&&(this.control._publishWUXEvent("PrimaryPointerUp",t,!1),this.control._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(e,this.control))},leftMouseDown:function(t){this.rotationOriginVisuHelper.rmbRotationOn&&this.rightMouseUp(t),this.rotationOriginVisuHelper.mmbRotationOn&&this.middleMouseUp(t);var e=t.from&&t.from.length?t.from[0]:null;if(null!==e){var i=this.control._forcePan||this.control._forceRotate||this.control._forceZoom;if(this.enableViewerCallbacks&&(this.control._publishWUXEvent("PrimaryPointerDown",t,!1),this.control.startLeftClick(),this.control._pickingCB&&this.viewer&&this.viewer.leftMouseDownCB&&(this.viewer.leftMouseDownCB(e,this.control),this.viewer.trapSelection&&i&&this.viewer.trapSelection.interrupt())),i){this.saveOriginalCursor();var o=this.getModelBoundingBox();o&&!o.isNaN()?this.rotateCenterOfModel.copy(o.center()):this.rotateCenterOfModel.set(0,0,0),this.addVisuEvent(document,"onLeftMouseUp",this.leftMouseUpCb),this.addVisuEvent(document,"onMouseMove",this.leftMouseMoveCb),this.control._changeState(n.State.NONE),this.control.setMouseActive(!0),!1===this.isPanning&&!1===this.isZooming&&this.control._onLeftMouseDown(t),this.control.setMouseActive(!1)}}},leftMouseMove:function(t){var e=t.gesture.currentEvent[0],i=this.control.getManipulationState();i===n.State.ZOOM||i===n.State.FORCE_ZOOM?(this.isRotating=!1,this.isPanning=!1,this.isZooming=!0,this.setCursor("Zoom"),this.doZoom(e.currentPosition,e.lastPosition)):i===n.State.PAN||i===n.State.FORCE_PAN?(this.isRotating=!1,this.isPanning=!0,this.isZooming=!1,this.setCursor("Pan"),this.doPan(e.currentPosition,e.lastPosition)):i!==n.State.ROTATE&&i!==n.State.FORCE_ROTATE||(this.isRotating=!0,this.isPanning=!1,this.isZooming=!1,this.setCursor("Rotate"),this.doRotate(e.currentPosition,e.lastPosition,!1))},leftMouseUp:function(t){this.control.setMouseActive(!0),!1===this.isPanning&&!1===this.isZooming&&this.control._onLeftMouseUp(t),this.control.setMouseActive(!1),this.removeVisuEvent(document,"onLeftMouseUp",this.leftMouseUpCb),this.removeVisuEvent(document,"onMouseMove",this.leftMouseMoveCb),this.restoreOriginalCursor(),this.isRotating=!1,this.isPanning=!1,this.isZooming=!1},setControllerMouseWheelState:function(){let t=this.viewer.currentViewpoint.getControl();t&&(t._wheelMoving=!0,t._wheelTimer&&clearTimeout(this._wheelTimer),t._wheelTimer=setTimeout(function(){t._wheelMoving=!1,clearTimeout(t._wheelTimer),t._wheelTimer=null},300))},scrollZoom:function(e){var i=0,o=new r.Vector2(0,0);if(e.gesture&&e.gesture.currentEvent){var s=e.gesture.currentEvent[0];i=t.Event.wheelDelta(s.getJSEvent()),o=s.currentPosition,s.event.preventDefault()}else{var a;i=e.deltaY;try{a=this.viewer.canvas.getBoundingClientRect()}catch(t){a={left:0,top:0}}o.x=e.clientX-a.left,o.y=e.clientY-a.top,e.preventDefault()}var l=new r.Vector2(this.control.domElement.clientWidth/2,this.control.domElement.clientHeight/2),h=!1;widget&&widget.getPreference("ReverseZoom")&&(h="Reverse"===widget.getPreference("ReverseZoom").value),this.setControllerMouseWheelState();var c=h?i>0:i<0,u=this.control._zoomType,p=l.clone();if(e.shiftKey||e&&e.from&&e.from[0]&&e.from[0].getJSEvent()&&e.from[0].getJSEvent().shiftKey){if(!this.isShiftPinchTriggered){this.saveOriginalCursor();var d=.25*(this.control.domElement.clientWidth+this.control.domElement.clientHeight);this.zoomToCenterDeltaY=.028/(.5/d),this.isShiftPinchTriggered=!0,this.lastCursor=null}this.isRotating=!1,this.isPanning=!1,this.isZooming=!0,this.setCursor("Zoom")}let g=new URLSearchParams(window.location.search).has("zoomMode")?o:l;c?this.isShiftPinchTriggered?(p.y+=this.zoomToCenterDeltaY,this.doZoom(l,p)):u===n.ZoomType.ZOOM_FOV_CHANGE?this.control._zoomFOVChange(o,c):this.isMacOS&&e.ctrlKey?this.control._zoomSimple(o,c,.95):this.control._zoomSimple(o,c):this.isShiftPinchTriggered?(p.y-=this.zoomToCenterDeltaY,this.doZoom(l,p)):u===n.ZoomType.ZOOM_FOV_CHANGE?this.control._zoomFOVChange(g,c):this.isMacOS&&e.ctrlKey?this.control._zoomSimple(g,c,1.05):this.control._zoomSimple(g,c),this.control.update()},middleMouseDown:function(t){if(!(this.control._forcePan||this.control._forceRotate||this.control._forceZoom)&&!0!==this.control._2DMode){this.isRotating&&(this.rotationOriginVisuHelper.rmbRotationOn||this.rotationOriginVisuHelper.mmbRotationOn)&&(this.endRotation(null),this.rotationOriginVisuHelper.rmbRotationOn=!1,this.rotationOriginVisuHelper.mmbRotationOn=!1,this.restoreOriginalCursor()),this.saveOriginalCursor();var e=t.from[0].getJSEvent(),i=t.from[0].getCurrentPosition(this.viewer.canvas),o=this.viewer.getMousePosition(i),s=this.viewer.pick(o,"mesh",!0);if(this.rotaxData=e&&e.shiftKey&&(this.isCtrlPressed(e)||e.metaKey)?this.viewer.pick(o,"prim",!0):null,this.rotaxData){var a=this.getModelBoundingBox();if(a&&!a.isNaN()){var l=s&&s.path&&s.path.length>0,h=new r.Vector3,c=this.viewPoint.getUpDirection().clone();l?this.rotaxData&&!this.getRollAxisFromSelection(this.rotaxData)&&this.rotaxData.position?this.rotateCenterOfModel.copy(this.rotaxData.position):(h.crossVectors(this.viewPoint.getSightDirection(),this.viewPoint.getUpDirection()),h.normalize(),h.multiplyScalar(a.getBoundingSphere().radius),h.add(this.control.target),c.normalize(),c.multiplyScalar(a.getBoundingSphere().radius),c.add(this.control.target),this.rotaxData&&this.rotaxData.position?this.rotateCenterOfModel.copy(this.rotaxData.position):this.viewPoint.project(h).x>this.viewer.SCREEN_WIDTH&&this.viewPoint.project(c).y<0?this.rotateCenterOfModel.copy(s.position):this.rotateCenterOfModel.copy(a.center())):this.rotateCenterOfModel.copy(a.center())}else this.rotateCenterOfModel.set(0,0,0)}else this.rotationOriginVisuHelper.mmbRotationOn=!0,this.prepareForRotation(t);this.viewer.centerMouseUpCB=null,this.control._changeState(n.State.STOP),this.viewer.currentViewpoint._isMoving=!0,e.shiftKey?this.setCursor("Zoom"):this.isCtrlPressed(e)||e.metaKey?this.setCursor("Pan"):this.setCursor("Rotate"),this.addVisuEvent(document,"onMiddleMouseUp",this.middleMouseUpCb),this.addVisuEvent(document,"onMouseMove",this.middleMouseMoveCb),this.addVisuEvent(this.viewer.canvas,"onMouseOut",this.alwaysonMouseOutCb)}},stopMiddleMouseRotation:function(){this.removeVisuEvent(document,"onMiddleMouseUp",this.middleMouseUpCb),this.removeVisuEvent(document,"onMouseMove",this.middleMouseMoveCb),this.removeVisuEvent(this.viewer.canvas,"onMouseOut",this.alwaysonMouseOutCb),this.isRotating=!1,this.isPanning=!1,this.isZooming=!1,this.control._changeState(n.State.NONE),this.viewer.currentViewpoint._isMoving=!1,this.restoreOriginalCursor()},middleMouseMove:function(t){if(!0===this.control._2DMode)return;var e=t.from[0].getJSEvent(),i=t.gesture.currentEvent[0];if(!e.buttons)return void this.stopMiddleMouseRotation();let o=!1;if(t.from.forEach(t=>{t&&t.view&&"IFRAME"!==t.view.tagName&&t.button&&-1!==t.button&&(o=!0)}),this.rotaxData=e.shiftKey&&this.isCtrlPressed(e)?this.rotaxData:null)this.isRotating=!0,this.isPanning=!1,this.isZooming=!1,this.setCursor("Rotate"),o?this.doRotate(i.currentPosition,i.lastPosition):this.middleMouseUp(t);else if(e.shiftKey)this.isRotating=!1,this.isPanning=!1,this.isZooming=!0,this.setCursor("Zoom"),this.doZoom(i.currentPosition,i.lastPosition);else if(this.isCtrlPressed(e)||e.metaKey)if(this.isRotating=!1,this.isPanning=!0,this.isZooming=!1,this.setCursor("Pan"),this.control.lockPan)this.doPan(i.currentPosition,i.lastPosition);else{var n={gesture:t.gesture,defaultBehavior:!0};this.control._modelEvent.publish({event:"Pan",data:n,context:this.control}),n.defaultBehavior&&this.doPan(i.currentPosition,i.lastPosition)}else this.isRotating=!0,this.isPanning=!1,this.isZooming=!1,this.setCursor("Rotate"),o?this.doRotate(i.currentPosition,i.lastPosition,e.altKey):this.middleMouseUp(t);e&&e.preventDefault()},middleMouseUp:function(t){!0!==this.control._2DMode&&(this.rotationOriginVisuHelper.mmbRotationOn&&this.endRotation(t),this.stopMiddleMouseRotation())},rightMouseDown:function(t){if(!0!==this.control._2DMode&&(this._rightMouseDown=!0,!(this.control._forcePan||this.control._forceRotate||this.control._forceZoom))){(this.rotationOriginVisuHelper.wheeling||this.isRotating&&(this.rotationOriginVisuHelper.mmbRotationOn||this.rotationOriginVisuHelper.rmbRotationOn))&&(this.rotationOriginVisuHelper.mmbRotationOn=!1,this.rotationOriginVisuHelper.rmbRotationOn=!1,this.restoreOriginalCursor(),this.endRotation(null)),this.saveOriginalCursor();var e=t.from[0].getJSEvent();if(!e.shiftKey&&!this.isCtrlPressed(e)&&!e.metaKey){let i=!0;this.customPrepareForRotationHandler&&(i=this.customPrepareForRotationHandler(e)),i&&(this.rotationOriginVisuHelper.rmbRotationOn=!0,this.prepareForRotation(t))}this.viewer.centerMouseUpCB=null,this.control._changeState(n.State.STOP),this.isEscapable=!0,this.addVisuEvent(document,"onRightMouseUp",this.rightMouseUpCb),this.addVisuEvent(document,"onMouseMove",this.rightMouseMoveCb),this.addVisuEvent(this.viewer.canvas,"onMouseOut",this.alwaysonMouseOutCb)}},rightMouseMove:function(t){if(!0!==this.control._2DMode){var e=t.from[0].getJSEvent(),i=t.gesture.currentEvent[0];if(this.viewer.currentViewpoint._isMoving=!0,e.shiftKey)this.isRotating=!1,this.isPanning=!1,this.isZooming=!0,this.setCursor("Zoom"),this.doZoom(i.currentPosition,i.lastPosition);else if(this.isCtrlPressed(e)||e.metaKey)this.isRotating=!1,this.isPanning=!0,this.isZooming=!1,this.setCursor("Pan"),this.doPan(i.currentPosition,i.lastPosition);else{let o=!1;t.from.forEach(t=>{t&&t.view&&"IFRAME"!==t.view.tagName&&t.button&&-1!==t.button&&(o=!0)}),o?(this.isRotating=!0,this.isPanning=!1,this.isZooming=!1,this.customMouseMoveHandler?this.customMouseMoveHandler(this,i,e):(this.setCursor("Rotate"),this.doRotate(i.currentPosition,i.lastPosition,e.altKey))):this.rightMouseUp(t)}}},alwaysonMouseOut:function(t){t&&t.from&&t.from[0]&&(this.rotationOriginVisuHelper.rmbRotationOn||this.rotationOriginVisuHelper.mmbRotationOn)&&(this.endRotation(t),delete this._rightMouseDown,this.endMouseManipulation(),this.stopMiddleMouseRotation())},rightMouseUp:function(t){if(!0!==this.control._2DMode){if(t&&t.from&&t.from[0]){var e=t.from[0].getJSEvent();e.shiftKey||this.isCtrlPressed(e)||e.metaKey||!this.rotationOriginVisuHelper.rmbRotationOn||this.endRotation(t)}delete this._rightMouseDown,this.endMouseManipulation()}},endMouseManipulation:function(){this.removeVisuEvent(document,"onRightMouseUp",this.rightMouseUpCb),this.removeVisuEvent(document,"onMouseMove",this.rightMouseMoveCb),this.removeVisuEvent(this.viewer.canvas,"onMouseOut",this.alwaysonMouseOutCb),this.isEscapable=!1,this.isRotating=!1,this.isPanning=!1,this.isZooming=!1,this.control._changeState(n.State.NONE),this.viewer.currentViewpoint._isMoving=!1,this.restoreOriginalCursor()},setCursor:function(t){t!==this.lastCursor&&("Rotate"===t&&this.options.rotateAroundTargetUrl&&this.rotationOriginVisuHelper&&this.rotationOriginVisuHelper.origin?this.viewer.setCursor(this.options.rotateAroundTargetUrl,0,!0):this.viewer.setCursor(t),this.lastCursor=t)},saveOriginalCursor:function(){this.originalCursor=this.viewer.canvas.style.cursor},restoreOriginalCursor:function(){null!==this.originalCursor?this.viewer.canvas.style.cursor=this.originalCursor:this.viewer.setCursor("auto"),this.originalCursor=null,this.lastCursor=null},doPan:function(t,e){this.control._pan(t,e),this.control.update()},doZoom:function(t,e){this.control._zoom(t,e),this.control.update()},doRotate:function(t,e,i,o){if(!0===this.control._2DMode)return;var n,a,l,h,c,u=t.x-e.x,p=t.y-e.y,d=new r.Vector3,g=this.control.orientation.clone(),v=this.control.target.clone(),m=(new r.Vector3).subVectors(v,this.rotateCenterOfModel);if(v.sub(this.rotateCenterOfModel),0===u&&0===p)return;u/=3,p/=3;var f=this.rotaxData&&(this.rotaxData.tangent||this.rotaxData.normal);if("CATXGDWebLocalApp"==window.widget.getValue("appId"))this.control.lockZ=!0;else{let t=window.widget.getValue("Rotation");this.control.lockZ="Gravity"==t}if(this.control.lockZ){var w=this.control.viewpoint._worldOrientation.upAttribute,M=this.control.camera.getLookAt()[w];0===(M=+M)||isNaN(M)?this.control.rotateDirection=M:this.control.rotateDirection=-1,u*=3,p*=3,g=this.control.viewpoint._worldOrientation.getOrientationForLockedRotation(-this.control.rotateDirection*u*this.control.lockZRotationSpeed,p*this.control.lockZRotationSpeed,this.control.orientation)}else f?(n=Math.abs(u)>Math.abs(p)?r.Math.degToRad(u):r.Math.degToRad(p),a=(new r.Quaternion).setFromAxisAngle(f,n),v.applyQuaternion(a),g.multiplyQuaternions(a,g)):i?0!==u&&(n=r.Math.degToRad(u),a=(new r.Quaternion).setFromAxisAngle(this.viewPoint.getSightDirection(),n),v.applyQuaternion(a),g.multiplyQuaternions(a,g)):(0!==u&&(n=r.Math.degToRad(-u),a=(new r.Quaternion).setFromAxisAngle(this.viewPoint.getUpDirection(),n),v.applyQuaternion(a),g.multiplyQuaternions(a,g)),0!==p&&(l=r.Math.degToRad(-p),d.crossVectors(this.viewPoint.getSightDirection(),this.viewPoint.getUpDirection()),h=(new r.Quaternion).setFromAxisAngle(d,l),v.applyQuaternion(h),g.multiplyQuaternions(h,g)));if(g.normalize(),o){this.isAnimating=!0;var C=this,b=s.subscribe({event:"/VISU/"},function(t){"@onViewpointEndMove"===t.eventType&&(C.isAnimating=!1,s.unsubscribe(b))});this.viewPoint.moveTo({orientation:g,duration:500})}else this.control.target.sub(m),this.control.target.add(v),this.control.orientation.copy(g),c=this.control.update(),i&&!c&&(this.viewer.render({updateInfinitePlane:!0}),widget.fpsStats&&widget.stats.update())},_getKeyboardEvent:function(t){if(t.gesture&&t.gesture.currentEvent&&t.gesture.currentEvent.length>0){var e=t.gesture.currentEvent[0];if(e.event)return e.event}return null},_validElement:function(t){if(t&&["arrowup","up","arrowdown","down","arrowright","right","arrowleft","left"].find(e=>e===t.toLowerCase())&&document.activeElement&&(document.activeElement.closest("[swx-feature-id]")||document.activeElement.closest(".swx-modebar")||document.activeElement!==document.querySelector(".wux-applicationframe-execution-context")&&!document.activeElement.querySelector(".wux-applicationframe-execution-context")))return!1;var e=document.activeElement.tagName?document.activeElement.tagName.toLowerCase():document.activeElement.tagName;return-1===["input","textarea"].indexOf(e)},keyDown:function(t,e){if(e||(this._keyPressed=!0),!this._keyPressed)return;var i=null,o=45,n={x:0,y:0},s=this._getKeyboardEvent(t);if(s&&s.key&&this._validElement(s.key)){var l=new r.Vector2(this.control.domElement.clientWidth/2,this.control.domElement.clientHeight/2);switch(s.key.toLowerCase()){case"t":case"†":s.altKey&&(s.preventDefault(),this.isAnimating||(this.viewPoint.getProjectionType()===a.ORTHOGRAPHIC?this.viewPoint.setProjectionType(a.PERSPECTIVE):this.viewPoint.setProjectionType(a.ORTHOGRAPHIC),this.options.logClientEvent&&this.options.logClientEvent("menuEvent",1===this.viewPoint.getProjectionType()?"SWXWebParallel":"SWXWebPerspective","sKey")));break;case"z":this.isCtrlPressed(s)||s.metaKey||(s.preventDefault(),this.isAnimating||(this.setControllerMouseWheelState(),this.control._zoomSimple(l,s.shiftKey)));break;case"alt":delete this._zoomFactor;break;case"escape":case"esc":if(this.endRotation(null),this.isEscapable)return void this.endMouseManipulation(t);break;case"arrowup":case"up":i={y:-1,x:0};break;case"arrowdown":case"down":i={y:1,x:0};break;case"arrowleft":case"left":i={y:0,x:-1};break;case"arrowright":case"right":i={y:0,x:1};break;default:this.rotationOriginVisuHelper.rmbRotationOn&&this.rightMouseUp(t),this.rotationOriginVisuHelper.mmbRotationOn&&this.middleMouseUp(t)}if(i){if(s.preventDefault(),this.isAnimating)return;s.altKey?(s.shiftKey&&(o*=6),0!==i.x?i.x*=-o:i.x=o,i.y=0,this.doRotate(i,n,!0,s.shiftKey)):s.shiftKey?(i.x*=6*o,i.y*=6*o,this.doRotate(i,n,!1,!0)):this.isCtrlPressed(s)||s.metaKey?this.control._doPan(140*i.x,140*i.y):this.isRotating?this.control._doPan(140*i.x,140*i.y):(i.x*=o,i.y*=o,this.doRotate(i,n,!1))}}let h=e?100:600;setTimeout(function(){return this.keyDown(t,!0)}.bind(this),h)},keyUp:function(t){this._keyPressed=!1;var e=this._getKeyboardEvent(t);if(e&&e.key&&this._validElement())switch(e.key.toLowerCase()){case"shift":this.isZooming&&(this.isRotating=!1,this.isPanning=!1,this.isZooming=!1,this.restoreOriginalCursor(),this.isShiftPinchTriggered=!1)}},getRollAxisFromSelection:function(t){if(this.options.getRollAxisFromSelection)return this.options.getRollAxisFromSelection(t)},setupRotationHelpers:function(){this.rotationOriginVisuHelper={origin:null,originVisu:null,boundaryPreview:null,highlightInfo:null,color:null,lastPSOItem:null,centerPt:null,pinchpanrotateTimer:null,wheeling:null,rotationCursor:!1,mmbRotationOn:!1,rmbRotationOn:!1},t.Utils.Client.Platform.ios||t.Utils.Client.Platform.android||t.Utils.Client.Platform.ipad?(this.control.onRotate(t=>{t&&t.gesture&&"Swipe"===t.gesture.name&&(t.defaultBehavior=!1)}),this.addVisuEvent(this.viewer.canvas,"onPinchPanRotate",t=>{t&&"end"==t.state&&(this.rotationOriginVisuHelper.pinchpanrotateTimer&&(clearTimeout(this.rotationOriginVisuHelper.pinchpanrotateTimer),this.rotationOriginVisuHelper.pinchpanrotateTimer=null),this.rotationOriginVisuHelper.pinchpanrotateTimer=setTimeout(()=>{clearTimeout(this.rotationOriginVisuHelper.pinchpanrotateTimer),this.rotationOriginVisuHelper.pinchpanrotateTimer=null},750))}),this.addVisuEvent(this.viewer.canvas,"onSwipe",t=>{if(this.control.getManipulationState()!==n.State.STOP&&this.control.getManipulationState()!==n.State.HOLD){if(this.control.lockRotation||this.control.lockTouchRotation||this.rotationOriginVisuHelper.pinchpanrotateTimer)return this.endRotation(t),this.rotationOriginVisuHelper.origin=null,void(this.rotationOriginVisuHelper.highlightInfo=null);if(t&&t.from&&t.from.length&&t.from[0]&&t.from[0].view===this.viewer.canvas){let e=t.from[0];e&&("begin"===t.state?this.prepareForRotation(t):"end"==t.state?(this.endRotation(t),this.viewer.currentViewpoint&&(this.rotationOriginVisuHelper.viewpointInfo={target:this.viewer.currentViewpoint.getTarget().clone(),targetDistance:this.viewer.currentViewpoint.getTargetDistance(),upDir:this.viewer.currentViewpoint.getUpDirection().clone(),sightDir:this.viewer.currentViewpoint.getSightDirection().clone()})):(this.isRotating=!0,this.isPanning=!1,this.isZooming=!1,this.setCursor("Rotate"),this.doRotate(e.currentPosition,e.lastPosition,t.altKey)))}}else this.endRotation(t)})):c.onAdd(t=>{t&&t.pathElement&&("Tree"===t.pathElement.src?this.rotationOriginVisuHelper.lastPSOItem=null:this.rotationOriginVisuHelper.lastPSOItem=t)})},prepareForRotation:function(e){if(e&&(e.from&&e.from.length&&e.from[0]||e.currentPosition)){let s=this.getTempGraphicsNode(),a=!0;if(this.rotationOriginVisuHelper&&this.rotationOriginVisuHelper.origin&&this.rotationOriginVisuHelper.viewpointInfo&&this.viewer&&this.viewer.currentViewpoint){let t=1e-5,e=!0,i=this.viewer.currentViewpoint.getTargetDistance();Math.abs(i-this.rotationOriginVisuHelper.viewpointInfo.targetDistance)<t&&(e=!1);let o=!1,n=this.viewer.currentViewpoint.getTarget(),r=this.viewer.currentViewpoint.getUpDirection(),s=this.viewer.currentViewpoint.getSightDirection();n&&r&&s&&this.rotationOriginVisuHelper.viewpointInfo.target&&this.rotationOriginVisuHelper.viewpointInfo.upDir&&this.rotationOriginVisuHelper.viewpointInfo.sightDir&&n.distanceTo(this.rotationOriginVisuHelper.viewpointInfo.target)>t&&r.distanceTo(this.rotationOriginVisuHelper.viewpointInfo.upDir)<t&&s.distanceTo(this.rotationOriginVisuHelper.viewpointInfo.sightDir)<t&&(o=!0),e||o||(a=!1)}let l=this.viewer.getSceneGraphOverrideSetManager(),c=!!(l&&this.rotationOriginVisuHelper.highlightInfo&&this.rotationOriginVisuHelper.highlightInfo.pathElement)&&l.getCurrentVisibility(this.rotationOriginVisuHelper.highlightInfo.pathElement),u=this.options.isSmallViewport&&this.options.isSmallViewport()&&f.getTouchMode();if(!1===c||a||!u){this.rotationOriginVisuHelper.highlightInfo&&(h.remove(this.rotationOriginVisuHelper.highlightInfo),this.unregisterColor(this.rotationOriginVisuHelper.color),this.viewer.render()),this.rotationOriginVisuHelper.origin=null,this.rotationOriginVisuHelper.highlightInfo=null;var i=e.currentPosition?e.currentPosition:e.from[0].getCurrentPosition(this.viewer.canvas),o=this.viewer.getMousePosition(i),n=this.getModelBoundingBox();if(n&&!n.isNaN())if(s){let t=Number(this.options.RelGeomDetectionTol||.035),e=Number(this.options.MaxGeomDetectionTol||50),i=Math.max(window.screen.width,window.screen.height)*t>e?e:Math.max(window.screen.width,window.screen.height)*t,s=this.getSelectedEntityInfo(o,i);if(s&&s.point&&s.object){let t=s.point.clone();this.rotationOriginVisuHelper.origin=t.clone();let e=this.getEntityPathElt(s);if(this.rotationOriginVisuHelper.highlightInfo=null,e){let t=Number(this.options.RotationEntityColor||13501183);this.rotationOriginVisuHelper.color=this.generateSelectionColor(new r.Color(t)),this.registerColor(this.viewer,this.rotationOriginVisuHelper.color,{attachToHSO:!0,persistable:!0}),this.rotationOriginVisuHelper.highlightInfo={pathElement:e,event:null,parameters:{highlightColor:this.rotationOriginVisuHelper.color}}}}else this.rotateCenterOfModel.copy(n.center())}else this.rotateCenterOfModel.copy(n.center());else this.rotateCenterOfModel.set(0,0,0)}if(this.rotationOriginVisuHelper.origin&&s){this.rotationOriginVisuHelper.centerPt=this.rotateCenterOfModel.clone(),this.rotateCenterOfModel.copy(this.rotationOriginVisuHelper.origin.clone());let i=(new r.Matrix4).getInverse(this.getActiveOccurrencePosition(e).clone()),o=!!(t.Utils.Client.Platform.ios||t.Utils.Client.Platform.android||t.Utils.Client.Platform.ipad),n=!1;s&&this.rotationOriginVisuHelper.boundaryPreview&&(s.remove(this.rotationOriginVisuHelper.boundaryPreview),this.rotationOriginVisuHelper.boundaryPreview=null,n=!0),s&&this.rotationOriginVisuHelper.originVisu&&(s.remove(this.rotationOriginVisuHelper.originVisu),this.rotationOriginVisuHelper.originVisu=null,n=!0),n&&this.viewer.render(),this.rotationOriginVisuHelper.originVisu=this.createRotationOriginBlob(this.rotationOriginVisuHelper.origin.clone().applyMatrix4(i),3.2,o,e),this.rotationOriginVisuHelper.originVisu&&s.add(this.rotationOriginVisuHelper.originVisu),this.rotationOriginVisuHelper.highlightInfo&&this.createBoundaryPreview(i,e),this.options.highlightFace&&h.add(this.rotationOriginVisuHelper.highlightInfo),this.viewer.render()}}},createBoundaryPreview:function(t,e){if(!this.options.getMaterial||!this.options.getBoudaryCurves||!this.options.highlightFace)return;let i=this.getTempGraphicsNode(),o=this.options.getBoudaryCurves(this.rotationOriginVisuHelper.highlightInfo.pathElement);if(i&&Array.isArray(o)&&o.length>0){var n=this.options.getMaterial(h,this.rotationOriginVisuHelper.highlightInfo);let s=new v("boundaryPreview"),a=new r.Matrix4,c=this.rotationOriginVisuHelper.highlightInfo.pathElement;c&&c.getWorldMatrix&&c.getWorldMatrix(this.viewer)&&(a=a.multiplyMatrices(t,c.getWorldMatrix(this.viewer).clone())),o.forEach(t=>{let e=t.map(t=>t.applyMatrix4(a));!0===t.closed&&t.length>0&&e.push(e[0]);let i=null;if(2==e.length&&e[0].distanceTo(e[1])<1.25){var o=.5*r.getDevicePixelRatio(),h=p.createRectangleNode({width:o,height:o,cornerPoint:new r.Vector2(-.5*o,-.5*o),fill:!1,fillColor:n.color,material:n});h&&(h.setNoZ(!0),(i=p.createFixedSizeNode())&&(i.addChild(h),i.applyMatrix((new r.Matrix4).makeTranslation(e[0].x,e[0].y,e[0].z))))}else(i=p.createLineNode({points:e,color:n.color,material:n})).setNoZ(!0);i&&(i.setPickable(l.PICKTHROUGH),s.addChild(i))}),s.applyMatrix(this.getActiveOccurrencePosition(e)),i.addChild(s),this.rotationOriginVisuHelper.boundaryPreview=s,this.rotationOriginVisuHelper.highlightInfo.pathElement=new u([this.rotationOriginVisuHelper.boundaryPreview])}},endRotation:function(e){let i=this.getTempGraphicsNode();if(this.viewer&&this.rotationOriginVisuHelper){i&&this.rotationOriginVisuHelper.originVisu&&i.remove(this.rotationOriginVisuHelper.originVisu),i&&this.rotationOriginVisuHelper.boundaryPreview&&i.remove(this.rotationOriginVisuHelper.boundaryPreview),this.rotationOriginVisuHelper.highlightInfo&&(this.options.highlightFace&&h.remove(this.rotationOriginVisuHelper.highlightInfo),this.unregisterColor(this.rotationOriginVisuHelper.color)),this.viewer.render(),this.rotationOriginVisuHelper.centerPt&&this.rotateCenterOfModel.copy(this.rotationOriginVisuHelper.centerPt),!!!(t.Utils.Client.Platform.ios||t.Utils.Client.Platform.android||t.Utils.Client.Platform.ipad)&&this.viewer.currentViewpoint&&(this.rotationOriginVisuHelper.viewpointInfo={target:this.viewer.currentViewpoint.getTarget().clone(),targetDistance:this.viewer.currentViewpoint.getTargetDistance(),upDir:this.viewer.currentViewpoint.getUpDirection().clone(),sightDir:this.viewer.currentViewpoint.getSightDirection().clone()}),this.rotationOriginVisuHelper.originVisu=null,this.rotationOriginVisuHelper.boundaryPreview=null,this.rotationOriginVisuHelper.centerPt=null,this.rotationOriginVisuHelper.pinchpanrotateTimer=null,this.rotationOriginVisuHelper.wheeling=null,this.rotationOriginVisuHelper.rotationCursor=!1,this.rotationOriginVisuHelper.mmbRotationOn=!1,this.rotationOriginVisuHelper.rmbRotationOn=!1}},doMouseToRay:function(t){var e=r.getDevicePixelRatio()||1,i=new r.Vector2(t.xPix/e,t.yPix/e),o=i.x/this.viewer.canvas.offsetWidth*2-1,n=-i.y/this.viewer.canvas.offsetHeight*2+1,s=new r.Projector,a=new r.Vector3(o,n,-1);s.unprojectVector(a,this.viewer.currentViewpoint.camera);var l=new r.Vector3(o,n,1);s.unprojectVector(l,this.viewer.currentViewpoint.camera);var h=(new r.Vector3).copy(l).sub(a);return h.normalize(),{origin:a,direction:h,dc:{xPix:t.xPix,yPix:t.yPix}}},getSelectedEntityInfo:function(t,e){let i=null;if(this.viewer&&t){let o=this.doMouseToRay(t);if(o){let t=this.viewer?this.viewer.getSceneGraphOverrideSetManager():null,n=new r.Ray(o.origin,o.direction),s=new r.Projector,a=new r.Vector3(n.origin.x,n.origin.y,n.origin.z);s.projectVector(a,this.viewer.currentViewpoint.camera);let h=!0,c=!0,u=!0,p=[];if(this.rotationOriginVisuHelper.lastPSOItem&&this.rotationOriginVisuHelper.lastPSOItem.pathElement&&Array.isArray(this.rotationOriginVisuHelper.lastPSOItem.pathElement.externalPath)&&(null==t||t&&t.getCurrentVisibility(this.rotationOriginVisuHelper.lastPSOItem.pathElement))){let t=this.rotationOriginVisuHelper.lastPSOItem.pathElement.externalPath.find(t=>!!t.mesh3js);if(t&&t.mesh3js){let e=this.GetSceneGraphType(this.rotationOriginVisuHelper.lastPSOItem.pathElement);if("Edge"===e){let t=this.rotationOriginVisuHelper.lastPSOItem.pathElement.getLastElement();if(t){let i=t.sgNode;i&&i instanceof l.SGPrimitiveHelper&&i.container&&1===i.container.getPrimitiveCount(i.index)&&(e="Point")}}p=n.intersectMeshInstances({object:t.mesh3js},this.viewer.currentViewpoint.camera,a,"Face"===e,"Edge"===e,"Point"===e,this.viewer.renderer.deviceWidth,this.viewer.renderer.deviceHeight,5)}}if((0===p.length||p.length>0&&!p[0].point)&&(p=[],this.viewer.internalSceneGraph&&this.viewer.internalSceneGraph.scene)){let t=[this.viewer.internalSceneGraph.scene],i=function(t,e){let i=!0;return t&&e&&(i=e===t.infPlane||e===t.infPlaneSmall||e===t.grid),i},o={objects:[],notPickable:[],init:function(t,e,o){if(t){let e=t.getWebGLObjects("main",0);Array.isArray(e)&&e.length>0&&(this.objects=e.filter(t=>t&&t.object&&!1===t.object.pickable&&t.object.visible&&!i(this.viewer,t.object)))}if(e){let t=[],i=[e],o=i.length;for(let e=0;e<o;++e)i[e]&&i[e].mesh3js&&i[e].mesh3js.visible&&t.push(i[e].mesh3js),Array.isArray(i[e].children)&&i[e].children.length>0&&(o=(i=i.concat(i[e].children)).length);t.length>0&&(this.objects=this.objects.concat(t.map(t=>({object:t}))))}this.objects.forEach(t=>{t&&t.object&&!1===t.object.pickable&&(t.object.pickable=!0,this.notPickable.push(t.object))})},getWebGLObjects:function(t,e){return"main"===t?this.objects:[]},restorePickability:function(){this.notPickable.forEach(t=>{t.pickable=!1})}};o.init(this.viewer.internalSceneGraph.scene,this.getTempGraphicsNode(),this.viewer),t.push(o),t.forEach(t=>{let o=n.intersectMeshInstances({object:t},this.viewer.currentViewpoint.camera,a,h,c,u,this.viewer.renderer.deviceWidth,this.viewer.renderer.deviceHeight,e);Array.isArray(o)&&o.length>0&&o[0].point&&(p=p.concat(o.filter(t=>t&&t.object&&!i(this.viewer,t.object))))}),o.restorePickability()}if(Array.isArray(p)&&p.length>0&&p[0].point){let e=-1,o=(Number.MAX_VALUE,Number.MAX_VALUE,1e-6),r=[];for(let t=0;t<p.length;++t)p[t].object&&p[t].primitive&&p[t].point&&r.push({distToRay:n.distanceToPoint(p[t].point),distToCamera:n.origin.distanceTo(p[t].point),entIdx:t});r.sort((t,e)=>Math.abs(t.distToRay-e.distToRay)<o?Math.abs(t.distToCamera-e.distToCamera)<o?0:t.distToCamera<e.distToCamera?-1:1:t.distToRay<e.distToRay?-1:1);let s=r.find(e=>{let i=p[e.entIdx],o=!1,n=this.getEntityPathElt(i);if(null===n)o=!0;else if(n&&n.externalPath&&n.externalPath.length>0&&!(o=void 0!==n.externalPath.find(t=>{let e="rulerMainNode"===t.name||"Active Sketch"===t.name&&!1===i.object.pickable;if(!1===e&&!0===t.fixedSize){var o=n.getLastElement();o.getGeometricType&&"INFINITE_FACE"===o.getGeometricType()&&i&&i.primitive&&i.primitive.container&&i.primitive.container.glType<2&&(e=!0)}return e}))&&t){let e=t.computeInheritedOpacity(n),i=t.computeInheritedVisibility(n);(null!=e&&e<.01||null!=i&&!1===i)&&(o=!0)}return!o});void 0!==s&&(e=s.entIdx),-1!=e&&(this.adjustSelectedEntityInfo(n,p[e]),i=p[e])}}}return i},adjustSelectedEntityInfo(t,e){if(e&&e.object&&e.point&&e.primitive&&e.primitive instanceof l.SGPrimitiveHelper&&(0===e.primitive.container.glType||1===e.primitive.container.glType)){let o=e.point,n=e.primitive,s=n.container.getPrimitiveStart(n.index),a=n.container.getPrimitiveCount(n.index),l=[],h=e.object.matrixWorld.clone();if(n.container&&n.container.geometry&&n.container.geometry.vertexIndexArray)for(let t=s;t<s+a;++t){var i=new r.Vector3;n.container.geometry.getVertexPosition(n.container.geometry.vertexIndexArray[t],i),l.push(i.applyMatrix4(h))}if(l.length>0)if(1==l.length)o.distanceTo(l[0])>.001&&(e.point=l[0]);else{let i=!0;if(o.distanceTo(l[0])>.001)for(let t=0;t<l.length-1;++t){let e=l[t],n=l[t+1];if(!(o.distanceTo(n)>.001)){i=!1;break}{let t=n.clone().sub(e).normalize(),r=o.clone().sub(e).dot(t),s=e.clone().add(t.clone().multiplyScalar(r));if(s.distanceTo(o)<.001){if(s.clone().sub(e).normalize().dot(t)>0&&e.distanceTo(s)<e.distanceTo(n)){i=!1;break}}}}else i=!1;if(i){let i=l[0],o=t.distanceToPoint(i);for(let e=1;e<l.length;++e){let n=t.distanceToPoint(l[e]);if(n<o&&(i=l[e],(o=n)<.001))break}e.point=i}}}},createRotationOriginBlob:function(t,e,i,o){let n=null;if(this.viewer&&this.viewer.currentViewpoint&&this.viewer.currentViewpoint.camera&&t&&this.options.highlightFace){let i=new v("rotationBlob"),c=new v("rotationBlobBroder");var s=new r.ImageUtils._loadTextureVisu("Robot","models/textures/Point.png",void 0,null,null,r.ImageUtils.crossOriginPolicy),a=new r.ImageUtils._loadTextureVisu("SWXCoreManipulation","icons/Point.png",void 0,null,null,r.ImageUtils.crossOriginPolicy);s.flipY=!1,s.minFilter=r.LinearMipMapLinearFilter,i.pointMat=new r.MeshBasicMaterial({map:s,side:r.DoubleSide,transparent:!0,alphaTest:.05,enableClipPlanes:!1,opacity:.7}),i.pointMat.force=!0,a.flipY=!1,a.minFilter=r.LinearMipMapLinearFilter,c.pointMat=new r.MeshBasicMaterial({map:a,side:r.DoubleSide,transparent:!0,alphaTest:.05,enableClipPlanes:!1}),c.pointMat.force=!0;var l=(new g).createRectangle({width:4,height:4,fill:!0,fillColor:null,noEdge:!0});let u=p.createMeshNode(l,i.pointMat);u.setShadow(!1),u.setFrustumCulled(!1),u.name="diskNode",u.excludeFromCSO(!0),u.excludeFromHighlight(!0,!0),u.setMatrix((new r.Matrix4).setPosition(new r.Vector3(-2,-2,0)));let d=p.createMeshNode(l,c.pointMat);d.setShadow(!1),d.setFrustumCulled(!1),d.name="diskNodeBorder",d.excludeFromCSO(!0),d.excludeFromHighlight(!0,!0),d.setMatrix((new r.Matrix4).setPosition(new r.Vector3(-2,-2,0)));var h={position:t,name:"billBoard1",type:"Spherical"};i.billBoardNode=new m(h),c.billBoardNode=new m(h),i.billBoardNode.addChild(u),c.billBoardNode.addChild(d),i.addChild(i.billBoardNode),c.addChild(c.billBoardNode);let f=p.createFixedSizeNode();i&&c&&f&&(i.pickable=!1,i.excludeFromCSO(!0),i.excludeFromHighlight(!0,!1),i.applyMatrix((new r.Matrix4).makeScale(e,e,e)),c.pickable=!1,c.excludeFromCSO(!0),c.excludeFromHighlight(!0,!1),c.applyMatrix((new r.Matrix4).makeScale(e,e,e)),f.addChild(i),f.addChild(c),f.applyMatrix((new r.Matrix4).makeTranslation(t.x,t.y,t.z)),f.pickable=!1,f.excludeFromCSO(!0),f.excludeFromHighlight(!0,!1),f.setVisibilityInTree(!1),f.setRenderPasses(["robot"]),f.applyMatrix(this.getActiveOccurrencePosition(o)),n=f)}return n},getEntityPathElt:function(t){let e=null;if(t&&t.object&&t.primitive){var i=new u;i.setFromOccurrence(t.object._occurrence,d.getFromSGNode(t.primitive)),Array.isArray(i.externalPath)&&i.externalPath.length>0&&(e=i)}return e},getTempGraphicsNode:function(){return this.options.getTempGraphicsNode?this.options.getTempGraphicsNode():(this._tempGraphicsNode||(this._tempGraphicsNode=new v,this._tempGraphicsNode.name="TempGraphicsFallback",this._tempGraphicsNode.setVisibilityInTree(!1),this.options.viewer.getRootNode().addChild(this._tempGraphicsNode)),this._tempGraphicsNode)},getActiveOccurrencePosition:function(t){if(this.options.getActiveOccurrencePosition)return this.options.getActiveOccurrencePosition().clone();if(t&&t.from&&t.from.length>0){const o=t.from[0].getCurrentPosition(this.viewer.canvas);if(o){const t=this.viewer.getMousePosition(o);if(t){var e=this.viewer.pick(t,"mesh",!0);if(e&&e.path&&e.path.length>0){var i=e.path[0].getWorldMatrix();return i?i.clone():new r.Matrix4}}}}return new r.Matrix4},isCtrlPressed:function(t){return navigator.platform.toLowerCase().indexOf("mac")>-1&&t.metaKey||t.ctrlKey},GetSceneGraphType:function(t){if(this.options.GetSceneGraphType)return this.options.GetSceneGraphType(t)},generateSelectionColor:function(t,e){if(this.options.generateSelectionColor)return this.options.generateSelectionColor(t,e)},registerColor:function(t,e,i){this.options.registerColor&&this.options.registerColor(t,e,i)},unregisterColor:function(t,e){this.options.unregisterColor&&this.options.unregisterColor(t,e)},getModelBoundingBox:function(){return this.options.getModelBoundingBox?this.options.getModelBoundingBox():this.viewer.getSceneBoundingBox("visibleSpace")}});return t.namespace("DS/SWXCoreManipulation/SWXCoreViewManipulation",w)});