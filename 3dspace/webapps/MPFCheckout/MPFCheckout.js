define("DS/MPFCheckout/PhaseSummarySectionBody",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r){"use strict";return e.extend({className:"mpf-summary-order",setup:function(t){t||(t={}),a.requiredOfPrototype(t.cart,s,"options.cart must be a CartModel"),a.requiredOfPrototype(t.cartPhase,n,"options.cartPhase must be a CartPhaseModel"),this._parent(t),this.cart=t.cart,this.cartPhase=t.cartPhase,this.locale=t.locale||"fr-FR"},render:function(){return this.container.setContent([this._getDetailAmount(),this._getTotal()]),this},_getTotal:function(){const e=this.cart.getCurrency();return t.createElement("div",{class:"mpf-order-total",html:[t.createElement("div",{text:r.get("orderTotal")}),t.createElement("div",{text:this._getGrossAmountTotal()+" "+e})]})},_getDetailAmount:function(){const e=this.cart.getCurrency();return t.createElement("div",{class:"mpf-order-detail",html:[t.createElement("div",{class:"mpf-order-subtotal",html:[t.createElement("div",{text:r.get("subtotal")}),t.createElement("div",{text:this._getNetAmountTotal()+" "+e})]}),t.createElement("div",{class:"mpf-order-taxes",html:[t.createElement("div",{text:r.get("taxes")}),t.createElement("div",{text:this._getTaxesAmountTotal()+" "+e})]})]})},_getGrossAmountTotal:function(){const t=this.cart.getCurrency();return parseFloat(this.cartPhase.getTotalGrossAmount()).toLocaleString(this.locale,{style:"currency",currency:t,currencyDisplay:"code"}).replace(t,"").trim()},_getNetAmountTotal:function(){const t=this.cart.getCurrency();return parseFloat(this.cartPhase.getTotalNetAmount()).toLocaleString(this.locale,{style:"currency",currency:t,currencyDisplay:"code"}).replace(t,"").trim()},_getTaxesAmountTotal:function(){const t=this.cart.getCurrency();return parseFloat(this.cartPhase.getTotalTaxesAmount()).toLocaleString(this.locale,{style:"currency",currency:t,currencyDisplay:"code"}).replace(t,"").trim()},destroy:function(){this._parent(),this.container=null}})}),define("DS/MPFCheckout/TokenPaymentPage",["UWA/Core","UWA/Promise","UWA/Class/View","DS/UIKIT/Mask","DS/MPFServices/ObjectService","DS/MPFPaymentCardTokenModel/PaymentCardTokenModel","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFPspModel/PspModel","DS/MPFOrderComponent/OrderConfirmationSection","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r,i,o,c,h,d){"use strict";const l=Object.freeze({PAYMENT_DONE:"paymentDone"}),u=a.extend({className:"mpf-cbtoken-page",setup:function(t){t||(t={}),n.requiredOfPrototype(t.token,r,"options.token must be a PaymentCardTokenModel"),n.requiredOfPrototype(t.cartPhase,i,"options.cartPhase must be a CartPhaseModel"),n.requiredOfPrototype(t.cartPayment,o,"options.cartPayment must be a CartPaymentModel"),n.requiredOfPrototype(t.cartPsp,c,"options.cartPsp must be a PspModel"),this.token=t.token,this.cart=t.cart,this.cartPhase=t.cartPhase,this.cartPayment=t.cartPayment,this.cartPsp=t.cartPsp,this.waitForPaymentModel=t.waitForPaymentModel,this.locale=t.locale||"fr-FR",this.phaseInfoSection=this._createPhaseInfoSection(),this.tokenSection=this._createTokenSection()},render:function(){return this.container.setContent([this.phaseInfoSection.render(),this.tokenSection.render()]),this},save:function(){const t=this;return s.mask(this.container,d.get("paymentInProgress")),this._payWithToken().then(function(){t.dispatchEvent(l.PAYMENT_DONE,{isPaymentOK:!0})}).catch(function(){t.dispatchEvent(l.PAYMENT_DONE,{isPaymentOK:!1})}).finally(s.unmask.bind(s,this.container))},_payWithToken:function(){return this.cartPsp.getPsp()===c.Psp.STRIPE&&this.cartPsp.isScaEnabled()?this._getStripe().then(this._updateCartPayment.bind(this)).then(this._submitPaymentToStripe.bind(this)).then(function(t){return t.error?e.reject(t.error):e.resolve()}).then(this._waitForPaymentStateUpdate.bind(this)):this._updateCartPayment().then(this._waitForPaymentStateUpdate.bind(this))},_submitPaymentToStripe:function(){const t={payment_method:this.token.getPaymentMethodId()};return this.stripe.handleCardPayment(this.cartPayment.getPaymentIntentSecret(),t)},_waitForPaymentStateUpdate:function(){const t=this;return this.waitForPaymentModel?this.waitForPaymentModel.fetchPromise().catch(function(){return e.resolve()}).then(function(){if(t.waitForPaymentModel.getState()===o.States.PAYMENT_REFUSED)return e.reject("payment refused")}):e.resolve()},_updateCartPayment:function(){const t={[o.Fields.STATE]:o.States.PENDING_PAYMENT,CreditCardTokenId:this.token.getCardId()};return this.cartPayment.savePromise(t,{patch:!0})},_getStripe:function(){const a=this,s=e.deferred(),n=t.createElement("script",{src:"https://js.stripe.com/v3/",events:{load:function(){return a.stripe=Stripe(a.cartPsp.getPublicKey()),a.elements=a.stripe.elements(),s.resolve()}}});return"function"==typeof Stripe?(a.stripe=Stripe(a.cartPsp.getPublicKey()),a.elements=a.stripe.elements(),s.resolve()):document.body.appendChild(n),s.promise},_createTokenSection:function(){const t=[{tag:"table",html:[this._createRow("mpf-cc-owner",d.get("ccOwner"),this.token.getCardName()),this._createRow("mpf-cc-number",d.get("ccNumber"),"xxxx-xxxx-xxxx-"+this.token.getCardNumber()),this._createRow("mpf-cc-expDate",d.get("ccExpDate"),this.token.getCardExpMonth()+"/"+this.token.getCardExpYear()),this._createRow("mpf-cc-type",d.get("ccType"),this.token.getCardType())]}];return new h({title:d.get("titleCBToken"),body:t})},_createPhaseInfoSection:function(){const t=[{tag:"table",html:[this._createRow("mpf-phase-number",d.get("phaseNumber"),this.cartPhase.getNumber()),this._createRow("mpf-phase-start-date",d.get("startDate"),this.cartPhase.getStartDate()),this._createRow("mpf-phase-end-date",d.get("endDate"),this.cartPhase.getEndDate()),this._createRow("mpf-phase-description",d.get("description"),this.cartPhase.getDescription()),this._createRow("mpf-phase-total",d.get("amount"),parseFloat(this.cartPhase.getTotalGrossAmount()).toLocaleString(this.locale,{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"}))]}];return new h({title:d.get("phaseInfo"),body:t})},_createRow:function(t,e,a){return{tag:"tr",class:t,html:[{tag:"td",class:"mpf-label",text:e},{tag:"td",class:"mpf-value",text:a}]}},destroy:function(){this.phaseInfoSection.destroy(),this.tokenSection.destroy(),this.token=null,this.cart=null,this.cartPhase=null,this.cartPayment=null,this.cartPsp=null,this.waitForPaymentModel=null,this.container=null}});return u.Events=Object.freeze(l),u}),define("DS/MPFCheckout/HipayPaymentPage",["UWA/Class/View","UWA/Core","DS/MPFServices/ObjectService","DS/MPFCartPaymentModel/CartPaymentModel","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n){"use strict";return t.extend({setup:function(t){t||(t={}),a.requiredOfPrototype(t.cartPayment,s,"options.cartPayment must be a CartPaymentModel"),this.cartPayment=t.cartPayment,this.iframe=this._createIframe()},render:function(){return this.container.setContent(this.iframe),this},_createIframe:function(){return e.createElement("iframe",{src:this.cartPayment.getPaymentUrl()})}})}),define("DS/MPFCheckout/PhaseSummarySectionBodyDetails",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r){"use strict";return e.extend({className:"mpf-order-details table-responsive",setup:function(t){t||(t={}),a.requiredOfPrototype(t.cart,s,"options.cart must be a CartModel"),a.requiredOfPrototype(t.cartPhase,n,"options.cartPhase must be a CartPhaseModel"),this._parent(t),this.cart=t.cart,this.cartPhase=t.cartPhase,this.locale=t.locale||"fr-FR"},render:function(){return this.container.setContent(this._createTable()),this},_createTable:function(){const e=parseFloat(this.cartPhase.getTotalGrossAmount()).toLocaleString(this.locale,{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"}).replace(this.cart.getCurrency(),"").trim();return t.createElement("table",{class:"table table-condensed",html:[this._createTableHeader(),this._createTableBody(),this._createTableFooter(e)]})},_createPhaseItemEntry:function(e){const a=this.cart.getCurrency(),s=parseFloat(e.getUnitNetAmount()).toLocaleString(this.locale,{style:"currency",currency:a,currencyDisplay:"code"}).replace(a,"").trim(),n=parseFloat(e.getUnitTaxesAmount()).toLocaleString(this.locale,{style:"currency",currency:a,currencyDisplay:"code"}).replace(a,"").trim(),i=parseFloat(e.getTotalGrossAmount()).toLocaleString(this.locale,{style:"currency",currency:a,currencyDisplay:"code"}).replace(a,"").trim();return t.createElement("tr",{html:[t.createElement("td",{class:"mpf-body-item",text:r.get("phase")}),t.createElement("td",{class:"mpf-body-quantity",text:parseInt(e.getPhaseNumber())}),t.createElement("td",{text:s}),t.createElement("td",{text:n}),t.createElement("td",{text:i+" "+a})]})},_createTableBody:function(){return t.createElement("tbody",{html:this._createPhaseItemEntry(this.cartPhase)})},_createTableHeader:function(){return t.createElement("thead",{html:t.createElement("tr",{html:[{tag:"th",text:r.get("item"),class:"mpf-header-item"},{tag:"th",text:r.get("number"),class:"mpf-header-quantity"},{tag:"th",text:r.get("unitPrice")},{tag:"th",text:r.get("taxes")},{tag:"th",text:r.get("totalAmountWithTaxes")}]})})},_createTableFooter:function(e){return t.createElement("tfoot",{html:t.createElement("tr",{html:[t.createElement("td"),t.createElement("td"),t.createElement("td"),t.createElement("td",{text:r.get("total")}),t.createElement("td",{text:e+" "+this.cart.getCurrency()})]})})},destroy:function(){this.cart=null,this.cartPhase=null,this.locale=null,this.table=null,this._parent(),this.container=null}})}),define("DS/MPFCheckout/PhasePaymentMethodSection",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Select","DS/UIKIT/Mask","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFView/FieldTextInputV2","DS/MPFPspModel/PspModel","DS/MPFBuyer/BuyerType","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r,i,o,c,h){"use strict";const d=Object.freeze({PAYMENT_CARD_SELECTED:"paymentCardSelected",VALID_SECTION:"validSection",INVALID_SECTION:"invalidSection"}),l=Object.freeze({ADD_NEW_CARD:"addNewCard",USE_CARD_TOKEN:"useCardToken",USE_BANK_TRANSFER:"useBankTransfer"}),u=e.extend({className:"mpf-phase-payment-method-section mpf-section mpf-horizontal",setup:function(t){this.cart=t.cart,this.cartPhase=t.cartPhase,this.cartPayment=t.cartPayment,this.cartPsp=t.cartPsp,this.paymentCardTokens=t.paymentCardTokens,this.buyerType=t.buyerType,this.paymentCardOption=this._createPaymentCardOption(),this.paymentCardSelector=this._createPaymentCardSelector(),this.paymentCardSave=this._createPaymentCardSave(),this.bankTransferOption=this._createBankTransferOption(),this.purchaseOrderField=this._createPurchaseOrderField(),this.expenseFinancialLineField=this._createExpenseFinancialLineField()},render:function(){const t=[{tag:"h5",class:"mpf-title",text:h.get("paymentMethod")},{tag:"div",class:"mpf-body",html:[{tag:"div",class:"mpf-payment-cb",html:[this.paymentCardOption,this.paymentCardSelector,this.paymentCardSave,this.purchaseOrderField.render(),this.expenseFinancialLineField.render()]},this._isBankTransferEnabled()&&this.bankTransferOption]}];return this._updatePaymentMethodDetails(),this.container.setContent(t),this},validate:function(){const t=this.bankTransferOption.isChecked(),e=this.paymentCardOption.isChecked(),a=""!==this.paymentCardSelector.getValue()[0];return t||e&&a},getSelection:function(){const t={};if(this.paymentCardOption.isChecked()){const e=this.paymentCardSelector.getValue()[0];e===l.ADD_NEW_CARD?(t.action=l.ADD_NEW_CARD,t.save=this.paymentCardSave.isChecked()?"1":"0"):(t.action=l.USE_CARD_TOKEN,t.token=this.paymentCardTokens.find(function(t){return e===t.getCardId()}))}else t.action=l.USE_BANK_TRANSFER;return t},onPaymentMethodSelection:function(){this.paymentCardOption.isChecked()?(this.onTokenSelection(),this.cartPayment.setPaymentMethod(r.PaymentMethods.BANK_CARD)):(this.cartPayment.setPaymentMethod(r.PaymentMethods.DEFERRED_BANK_TRANSFER),this.dispatchEvent(d.VALID_SECTION)),this.render()},_updatePaymentMethodDetails:function(){this.paymentCardOption.isChecked()?(this.paymentCardSelector.enable(),this.purchaseOrderField.container.show(),this.expenseFinancialLineField.container.show(),this._updateTokenMethodDetails()):(this.paymentCardSelector.disable(),this.purchaseOrderField.container.hide(),this.expenseFinancialLineField.container.hide(),this.paymentCardSave.hide())},_updateTokenMethodDetails:function(){this.paymentCardSelector.getValue()[0]===l.ADD_NEW_CARD?this.paymentCardSave.show():this.paymentCardSave.hide()},_createPaymentCardSave:function(){return new a({type:"checkbox",name:"save-CB",value:h.get("saveCB"),className:"primary cb-save",checked:!0})},_createPaymentCardOption:function(){const t=this.cartPayment.getPaymentMethod();return new a({name:"mpfCheckoutV2PaymentMethod",value:h.get("paymentCard"),className:"primary cb",checked:!t||"CC"===t,events:{onChange:this.onPaymentMethodSelection.bind(this)}})},_createPaymentCardSelector:function(){return new s({placeholder:h.get("selectPaymentCard"),options:this._createPaymentCardOptions(),events:{onChange:this.onTokenSelection.bind(this)}})},onTokenSelection:function(){""===this.paymentCardSelector.getValue()[0]?this.dispatchEvent(d.INVALID_SECTION):this.dispatchEvent(d.VALID_SECTION),this.render()},_createPaymentCardOptions:function(){const t=this.cartPsp.getPsp(),e=this.cartPsp.getCountryPlatform(),a=t===o.Psp.HIPAY,s=t===o.Psp.STRIPE,n=this.paymentCardTokens.filter(function(n){return n.getPsp()===t&&(a||s&&n.getPlatform()===e)}).map(function(t){return{value:t.getCardId(),label:"xxxx-xxxx-xxxx-"+t.getCardNumber()+", "+t.getCardExpMonth()+"/"+t.getCardExpYear()}});return n.unshift({value:l.ADD_NEW_CARD,label:h.get("newPaymentCard")}),n[n.length-1].selected=!0,n},_createBankTransferOption:function(){const t=this.cartPsp.getPsp()===o.Psp.STRIPE&&this.cartPsp.getCountryPlatform()===o.Platform.STRIPE_US;let e;if(this._isBankTransferEnabled()){const s=t?h.get("achBankTransfer"):h.get("bankTransfer");e=new a({name:"mpfCheckoutV2PaymentMethod",value:s,className:"primary bank",checked:"DBT"===this.cartPayment.getPaymentMethod(),events:{onChange:this.onPaymentMethodSelection.bind(this)}})}else e={isChecked:function(){}};return e},_createPurchaseOrderField:function(){return new i({model:this.cartPayment,fieldName:r.Fields.PURCHASE_ORDER_NUMBER,fieldLabel:h.get("referenceToMention"),dynamicValidation:!0,maxlength:30})},_createExpenseFinancialLineField:function(){return new i({model:this.cartPayment,fieldName:r.Fields.FINANCIAL_LINE,fieldLabel:h.get("expenseFinancialLine"),dynamicValidation:!0})},_createTitle:function(){return t.createElement("h5",{class:"mpf-title",text:h.get("paymentMethod")})},_createBody:function(){return t.createElement("div",{class:"mpf-body"})},_isBankTransferEnabled:function(){return this.buyerType===c.COMPANY&&this.cartPsp.isBankTransferEnabled()},updatePaymentMethods:function(){this.bankTransferOption=this._createBankTransferOption(),this.render()},destroy:function(){this.purchaseOrderField.destroy(),this.expenseFinancialLineField.destroy(),this.stopListening(this.cartPsp),this.cart=null,this.cartPhase=null,this.cartPayment=null,this.cartPsp=null,this.paymentCardTokens=null,this.buyerType=null,this._parent(),this.container=null}});return u.Events=Object.freeze(d),u.Actions=Object.freeze(l),u}),define("DS/MPFCheckout/ConfirmationPaymentPage",["DS/MPFModalConfiguratorComponent/ThanksPurchasingPage"],function(t){"use strict";return t}),define("DS/MPFCheckout/BillingAddressCreationPage",["DS/MPFModalConfiguratorComponent/BillingInformationPage"],function(t){"use strict";return t}),define("DS/MPFCheckout/BankTransferPaymentPage",["UWA/Core","UWA/Promise","UWA/Class/View","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFPurchaseOrderComponent/CartPhasePurchaseOrderForm","DS/MPFPurchaseOrderModel/PurchaseOrderFactory","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentFactory","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Alert","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r,i,o,c,h,d,l){"use strict";const u=Object.freeze({CONFIRM_BANK_TRANSFER:"confirmBankTransfer",UPLOAD_PURCHASE_ORDER:"uploadPurchaseOrder"}),P=Object.freeze({UPLOAD_PURCHASE_ORDER_LATER:"uploadPurchaseOrderLater",UPLOAD_PURCHASE_ORDER_NOW:"uploadPurchaseOrderNow",PURCHASE_ORDER_SAVED:"purchaseOrderSaved"}),m=a.extend({className:"mpf-bank-transfer-payment-page",setup:function(t){this.cartPhase=t.cartPhase,this.cartPayment=t.cartPayment,this.purchaseOrderFactory=t.purchaseOrderFactory,this.purchaseOrderDocumentFactory=t.purchaseOrderDocumentFactory,this.stateMachine=this._createStateMachine(),this.confirmBankTransfer=this._createConfirmBankTransfer(),this.purchaseOrderForm=this._createPurchaseOrderForm(),this.listenTo(this.purchaseOrderForm,r.Events.PURCHASE_ORDER_UPLOADED,this._onPurchaseOrderSaved.bind(this))},render:function(){switch(this.stateMachine.getState()){case u.CONFIRM_BANK_TRANSFER:this.container.setContent([this.confirmBankTransfer]);break;case u.UPLOAD_PURCHASE_ORDER:this.container.setContent([this.purchaseOrderForm.render()])}return this},save:function(){let t;return t=this.stateMachine.getState()===u.UPLOAD_PURCHASE_ORDER?this.purchaseOrderForm.save():e.reject()},destroy:function(){this.cartPhase=null,this._parent()},_createStateMachine:function(){return new s({state:u.CONFIRM_BANK_TRANSFER,states:[u.CONFIRM_BANK_TRANSFER,u.UPLOAD_PURCHASE_ORDER],transitions:[{from:u.CONFIRM_BANK_TRANSFER,to:u.UPLOAD_PURCHASE_ORDER}]})},_createPurchaseOrderForm:function(){return this.purchaseOrder=this.purchaseOrderFactory.createModel(i.Types.PAYMENT_PURCHASE_ORDER),this.purchaseOrder.setParentResourceId(this.cartPayment.id),this.purchaseOrderDocument=this.purchaseOrderDocumentFactory.createModel(o.Types.PAYMENT_PURCHASE_ORDER_DOCUMENT),this.purchaseOrderDocument.setParentResourceId(this.cartPayment.id),new r({cartPayment:this.cartPayment,purchaseOrder:this.purchaseOrder,purchaseOrderDocument:this.purchaseOrderDocument})},_createConfirmBankTransfer:function(){const e=this._createUploadPurchaseOrderNowButton(),a=this._createUploadPurchaseOrderLaterButton();return t.createElement("div",{html:[{tag:"p",class:"mpf-message",text:l.get("confirmDeferredPaymentMessage")},e,a]})},_createUploadPurchaseOrderNowButton:function(){return new c({className:"primary mpf-uploadPurchaseOrderButton",value:l.get("uploadPurchaseOrder"),events:{onClick:this._onSelectUploadPurchaseOrderNow.bind(this)}})},_onSelectUploadPurchaseOrderNow:function(){this.dispatchEvent(P.UPLOAD_PURCHASE_ORDER_NOW),this.stateMachine.changeState(u.UPLOAD_PURCHASE_ORDER),this.render()},_createUploadPurchaseOrderLaterButton:function(){return new c({className:"primary mpf-uploadLaterButton",value:l.get("uploadPurchaseOrderLater"),events:{onClick:this._onUploadPurchaseOrderLater.bind(this)}})},_onUploadPurchaseOrderLater:function(){const t=this,e={[n.Fields.STATE]:n.States.PENDING_PAYMENT};h.mask(this.container),this.cartPayment.savePromise(e,{patch:!0}).then(function(){h.unmask(t.container),t.dispatchEvent(P.UPLOAD_PURCHASE_ORDER_LATER)}).catch(function(){h.unmask(t.container),new d({messageClassName:"error",closable:!0,visible:!0,messages:l.get("errorUnableToUpdatePayment")}).inject(t.container,"top")})},_onPurchaseOrderSaved:function(){this.dispatchEvent(P.PURCHASE_ORDER_SAVED)}});return m.Events=P,m}),define("DS/MPFCheckout/BillingInformationSection",["DS/MPFModalConfiguratorComponent/BillingInformationSection"],function(t){"use strict";return t}),define("DS/MPFCheckout/PhaseInfoSection",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCartPhaseModel/CartPhaseModel","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n){"use strict";return e.extend({className:"mpf-order-number",setup:function(t={}){a.requiredOfPrototype(t.cartPhase,s,"options.cartPhase must be a CartPhaseModel"),this.cartPhase=t.cartPhase,this.locale=t.locale||"fr-FR",this.title=this._createTitle(),this.body=this._createBody()},render:function(){return this.container.setContent([this.title,this.body]),this},_createBody:function(){const e=[t.createElement("div",{html:[t.createElement("span",{text:n.get("phaseNumber")})," "+this.cartPhase.getNumber()]}),t.createElement("div",{html:[t.createElement("span",{text:n.get("startDate")})," "+this.cartPhase.getStartDate()]}),t.createElement("div",{html:[t.createElement("span",{text:n.get("endDate")})," "+this.cartPhase.getEndDate()]}),t.createElement("div",{html:[t.createElement("span",{text:n.get("description")})," "+this.cartPhase.getDescription()]}),t.createElement("div",{html:[t.createElement("span",{text:n.get("amount")})," "+this.cartPhase.getTotalGrossAmount()]})];return t.createElement("div",{class:"mpf-body",html:e})},_createTitle:function(){return t.createElement("h5",{text:n.get("phaseInfo")})}})}),define("DS/MPFCheckout/TermsAndConditionsSection",["DS/MPFModalConfiguratorComponent/SalesConditionsBuyerPaymentSection"],function(t){"use strict";return t}),define("DS/MPFCheckout/StripePaymentFrame",["UWA/Class/View","UWA/Core","DS/WebappsUtils/WebappsUtils","DS/MPFServices/MarketplaceServices","DS/MPFServices/ObjectService","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFPspModel/PspModel","DS/MPFCartModel/CartModel","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r,i,o,c){"use strict";return t.extend({className:"mpf-stripe-page",setup:function(t){t||(t={}),n.requiredOfPrototype(t.cart,o,"options.cart must be a CartModel"),n.requiredOfPrototype(t.cartPhase,r,"options.cartPhase must be a CartPhaseModel"),n.requiredOfPrototype(t.cartPsp,i,"options.cartPsp must be a PspModel"),this.cart=t.cart,this.cartPhase=t.cartPhase,this.cartPsp=t.cartPsp,this.saveCardInfo=t.saveCardInfo||"0",this.iframe=this._createIframe()},render:function(){return this.container.setContent(this.iframe),this},_createIframe:function(){const t=a.getWebappsBaseUrl()+"MPFStripeComponent/StripePhasePaymentPage.html?stripeKey="+this.cartPsp.getPublicKey()+"&isScaEnabled="+this.cartPsp.isScaEnabled()+"&phaseCartId="+this.cartPhase.get("id")+"&phaseNumber="+this.cartPhase.getPhaseNumber()+"&phaseAmount="+this.cartPhase.getTotalGrossAmount()+"&cartName="+this.cart.getName()+"&currency="+this.cart.getCurrency()+"&CreditCardTokenMultiUse="+this.saveCardInfo+"&service="+s.ENGINEERING;return e.createElement("iframe",{class:"mpf-stripe",src:t})}})}),define("DS/MPFCheckout/PhaseSummarySection",["DS/MPFServices/ObjectService","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFOrderComponent/OrderConfirmationSectionCommand","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCheckout/PhaseSummarySectionBody","DS/MPFCheckout/PhaseSummarySectionBodyDetails","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r,i,o,c){"use strict";const h=Object.freeze({PHASE_DETAILS_DISPLAYED:"orderDetailsDisplayed",PHASE_DETAILS_NOT_DISPLAYED:"orderDetailsNotDisplayed"});return e.extend({setup:function(e){e||(e={}),t.requiredOfPrototype(e.cart,n,"options.cart must be a CartModel"),t.requiredOfPrototype(e.cartPhase,r,"options.cartPhase must be a CartPhaseModel"),this._parent(e),this.cart=e.cart,this.cartPhase=e.cartPhase,this.locale=e.locale||"fr-FR",this.title=c.get("phaseSummary"),this.commands=this._initCommands(),this.stateMachine=this._createStateMachine(),this.bodySummary=this._createBodySummary(),this.bodyDetails=this._createBodyDetails(),this._initListeners(),this._updateBody()},_updateBody:function(){this.stateMachine.getState()===h.PHASE_DETAILS_NOT_DISPLAYED&&(this.body=this.bodySummary.render()),this.stateMachine.getState()===h.PHASE_DETAILS_DISPLAYED&&(this.body=this.bodyDetails.render()),this.render()},_displayDetails:function(){this.stateMachine.changeState(h.PHASE_DETAILS_DISPLAYED),this._updateBody()},_displaySummary:function(){this.stateMachine.changeState(h.PHASE_DETAILS_NOT_DISPLAYED),this._updateBody()},_initListeners:function(){this.listenTo(this.commands[0],"commandOn",this._displayDetails.bind(this)),this.listenTo(this.commands[0],"commandOff",this._displaySummary.bind(this)),this.listenTo(this.cart,"onSync",this._onCartUpdated.bind(this)),this.listenTo(this.cartPhase,"onSync",this._onPhaseUpdated.bind(this))},_onCartUpdated:function(){this.cartPhase.fetchPromise({forceDelegate:!0})},_onPhaseUpdated:function(){this._updateBody()},_createBodyDetails:function(){return new o({cart:this.cart,cartPhase:this.cartPhase})},_createBodySummary:function(){return new i({cart:this.cart,cartPhase:this.cartPhase})},_initCommands:function(){return[new a({icon:"eye",iconOff:"eye-off",label:c.get("details"),labelOff:c.get("hideDetails")}).render()]},_createStateMachine:function(){return new s({state:h.PHASE_DETAILS_NOT_DISPLAYED,states:[h.PHASE_DETAILS_NOT_DISPLAYED,h.PHASE_DETAILS_DISPLAYED],transitions:[{from:h.PHASE_DETAILS_DISPLAYED,to:h.PHASE_DETAILS_NOT_DISPLAYED},{from:h.PHASE_DETAILS_NOT_DISPLAYED,to:h.PHASE_DETAILS_DISPLAYED}]})},destroy:function(){this.stopListening(),this.bodySummary.destroy(),this.bodyDetails.destroy(),this.cart=null,this.cartPhase=null,this._parent(),this.container=null}})}),define("DS/MPFCheckout/CardPaymentPage",["UWA/Class/View","UWA/Promise","UWA/Utils","DS/UIKIT/Mask","DS/WebappsUtils/WebappsUtils","DS/MPFPspModel/PspModel","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFStripeComponent/StripePhasePaymentPage","DS/MPFCheckout/HipayPaymentPage","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r,i,o,c,h){"use strict";const d=Object.freeze({RESIZE_MODAL:"resizeModal",PAYMENT_SUCCESS:"onPaymentSuccess",PAYMENT_FAILURE:"onPaymentFailure"}),l=t.extend({className:"mpf-card-payment-page",setup:function(t={}){this.me=t.me,this.service=t.service,this.locale=t.locale,this.cart=t.cart,this.cartPayment=t.cartPayment,this.cartPsp=t.cartPsp,this.cartPhase=t.cartPhase,this.saveCardInfo=t.saveCardInfo,this.waitForPaymentModel=t.waitForPaymentModel,this._createCardPaymentPage()},render:function(){return this.whenReady.then(()=>{this.container.setContent(this.page.render()),this.cartPsp.getPsp()===r.Psp.STRIPE&&this.page.whenReadyToMount().then(()=>{this.page.mountStripeInputs()})}),this},destroy:function(){this.cartPsp=null,this.page.destroy(),this._parent()},_createHipayPaymentPage:function(){const t=this,a=this.cartPayment.getState();return(a===i.States.PAYMENT_REFUSED||a===i.States.PAYMENT_INITIATED?e.resolve():this._patchCartPaymentState()).then(function(){t.page=new c({cartPayment:t.cartPayment}),t._addListenerForResizingModal()})},_patchCartPaymentState:function(){const t={currentState:i.States.PENDING_PAYMENT,cartContextUrl:a.isAbsoluteUrl(n.getWebappsAssetUrl("MPFModalConfiguratorComponent",""))?n.getWebappsAssetUrl("MPFModalConfiguratorComponent",""):window.location.origin+n.getWebappsAssetUrl("MPFModalConfiguratorComponent","")};return"1"===this.saveCardInfo&&(t.CreditCardTokenMultiUse="1"),this.cartPayment.savePromise(t,{patch:!0})},_createCardPaymentPage:function(){this.cartPsp.getPsp()===r.Psp.HIPAY?this.whenReady=this._createHipayPaymentPage():(this.page=new o({me:this.me,cart:this.cart,cartPhase:this.cartPhase,cartPsp:this.cartPsp,cartPayment:this.cartPayment,creditCardTokenMultiUse:this.saveCardInfo,waitForPaymentModel:this.waitForPaymentModel,locale:this.locale,service:this.service}),this.listenTo(this.page,o.Events.PAYMENT_SUCCESS,this.dispatchEvent.bind(this,d.RESIZE_MODAL,{isPaymentOK:!0})),this.listenTo(this.page,o.Events.PAYMENT_FAILURE,this.dispatchEvent.bind(this,d.RESIZE_MODAL,{isPaymentOK:!1})),this.whenReady=e.resolve())},_addListenerForResizingModal:function(){const t=this;window.addEventListener("message",function(e){const a=window.location.host.replace("-ifwe","-apps");e.origin.contains(a)&&e.data.isPaymentDone&&(t.cartPsp.getPsp()===r.Psp.HIPAY&&t.waitForPaymentModel?(s.mask(t.container,h.get("finalizingPayment")),t.waitForPaymentModel.fetchPromise().finally(function(){s.unmask(t.container),t.dispatchEvent(d.RESIZE_MODAL,e.data)})):t.dispatchEvent(d.RESIZE_MODAL,e.data))})}});return l.Events=d,l}),define("DS/MPFCheckout/PhaseSummaryPage",["UWA/Class/View","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/MPFBuyer/BuyerType","DS/MPFCartQuoteModel/CartQuoteModel","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFView/EmptyView","DS/MPFCartQuoteComponent/CartQuoteDownloadLink","DS/MPFCheckout/PhaseSummarySection","DS/MPFCheckout/PhasePaymentMethodSection","DS/MPFCheckout/BillingInformationSection","DS/MPFCheckout/TermsAndConditionsSection","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r,i,o,c,h,d,l,u){"use strict";const P=Object.freeze({ALL_SECTIONS_DISPLAYED:"allSectionsDisplayed",CREATE_BILLING_ADDRESS:"createBillingAddress"}),m=Object.freeze({PAYMENT_BY_TOKEN:"paymentByToken",PAYMENT_BY_CARD:"paymentByCard",PAYMENT_BY_BANK_TRANSFER:"paymentByBankTransfer",VALID_PAGE:"validPage",INVALID_PAGE:"invalidPage",DISPLAY_MASK:"displayMask",REMOVE_MASK:"removeMask",BILLING_ADDRESS_CREATION:"billingAddressCreation",EXIT_BILLING_ADDRESS_CREATION:"exitBillingAddressCreation"}),y=t.extend({className:"mpf-phase-summary-page mpf-checkout-v2-page mpf-order-confirmation-page",setup:function(t){this.service=t.service,this.buyer=t.buyer,this.cart=t.cart,this.cartPhase=t.cartPhase,this.cartPayment=t.cartPayment,this.cartPsp=t.cartPsp,this.cartQuote=t.cartQuote,this.cartFactory=t.cartFactory,this.cartItemFactory=t.cartItemFactory,this.paymentCardTokens=t.paymentCardTokens,this.addresses=t.addresses,this.addressFactory=t.addressFactory,this.countries=t.countries,this.tcContractFactory=t.tcContractFactory,this.tcDocumentFactory=t.tcDocumentFactory,this.shop=t.shop,this.isItFirstPayment=!0===t.isItFirstPayment,this.alert=this._createAlert(),this.cartQuoteLink=this._createCartQuoteLink(),this.summarySection=this._createSummarySection(),this.payementMethodSection=this._createPaymentMethodSection(),this.billingInformationSection=this._createBillingInformationSection(),this.termsAndConditionsSection=this._createTermsAndConditionsSection(),this.stateMachine=this._createStateMachine(),this._initListeners()},render:function(){const t=[this.alert,this.cartQuoteLink.render(),this.summarySection.render(),this.billingInformationSection.render(),this.payementMethodSection.render(),this.termsAndConditionsSection.render()];return this.container.setContent(t),this.termsAndConditionsSection.whenReady.then(this.validate.bind(this)),this},_updateContent:function(){let t;switch(this.stateMachine.getState()){case P.ALL_SECTIONS_DISPLAYED:t=[this.cartQuoteLink,this.summarySection,this.billingInformationSection,this.payementMethodSection,this.termsAndConditionsSection];break;case P.CREATE_BILLING_ADDRESS:t=this.billingInformationSection;break;default:t=i.getInstance().render()}return this.container.setContent(t),this},validate:function(){const t=this.payementMethodSection.validate(),e=this.termsAndConditionsSection.isChecked(),a=t&&e;return a?this.dispatchEvent(m.VALID_PAGE):this.dispatchEvent(m.INVALID_PAGE),a},save:function(){const t=this,a=this.payementMethodSection.getSelection();return e.mask(this.container),this.cartPayment.savePromise(this.cartPayment.getPendingChanges(),{patch:!0}).then(this.termsAndConditionsSection.save.bind(this.termsAndConditionsSection)).then(this._acceptQuote.bind(this)).then(function(){let s;const n={};a.action===h.Actions.ADD_NEW_CARD?(s=m.PAYMENT_BY_CARD,n.saveCardInfo=a.save):a.action===h.Actions.USE_CARD_TOKEN?(s=m.PAYMENT_BY_TOKEN,n.token=a.token):a.action===h.Actions.USE_BANK_TRANSFER&&(s=m.PAYMENT_BY_BANK_TRANSFER),e.unmask(t.container),t.dispatchEvent(s,n)})},getState:function(){return this.stateMachine.getState()},exitBillingAddressCreationMode:function(){return this.billingInformationSection.cancelAddAddress()},_initListeners:function(){const t=this;this.listenTo(this.billingInformationSection,d.Events.NEW_ADDRESS_FORM,function(){t._changeState(P.CREATE_BILLING_ADDRESS),t.dispatchEvent(m.BILLING_ADDRESS_CREATION)}),this.listenTo(this.billingInformationSection,d.Events.EXIT_ADDRESS_FORM,function(){t._changeState(P.ALL_SECTIONS_DISPLAYED),t.dispatchEvent(m.EXIT_BILLING_ADDRESS_CREATION)}),this.listenTo(this.billingInformationSection,d.Events.PATCHING_CART,this.dispatchEvent.bind(this,m.DISPLAY_MASK)),this.listenTo(this.billingInformationSection,d.Events.ERROR_PATCH_CART,this.dispatchEvent.bind(this,m.REMOVE_MASK)),this.listenTo(this.billingInformationSection,d.Events.VALID,function(){t.payementMethodSection.updatePaymentMethods(),t.dispatchEvent(m.REMOVE_MASK)}),this.listenTo(this.payementMethodSection,h.Events.VALID_SECTION,this.validate.bind(this)),this.listenTo(this.payementMethodSection,h.Events.INVALID_SECTION,this.validate.bind(this)),this.listenTo(this.termsAndConditionsSection,l.Events.VALID_SECTION,this.validate.bind(this)),this.listenTo(this.termsAndConditionsSection,l.Events.INVALID_SECTION,this.validate.bind(this))},_updatePayment(){return this.cartPayment.hasPendingChanges()?this.cartPayment.savePromise(this.cartPayment.getPendingChanges(),{patch:!0}):Promise.resolve()},_changeState:function(t){this.stateMachine.changeState(t),this._updateContent()},_acceptQuote:function(){const t=this;return this.cartQuote.fetchPromise().then(function(){const e={[n.Fields.STATE]:"ACCEPTED"};t.cartQuote.savePromise(e,{patch:!0})})},_createAlert:()=>new a({closable:!0,visible:!1}),_createSummarySection:function(){return new c({cart:this.cart,cartPhase:this.cartPhase})},_createCartQuoteLink:function(){const t=new o({quote:this.cartQuote,paymentUpdateCb:this._updatePayment.bind(this)});return this.listenTo(t,o.Events.ERROR,()=>{this.alert.add({className:"error",message:u.get("failedDownloadQuote")}).show()}),t},_createPaymentMethodSection:function(){return new h({cart:this.cart,cartPhase:this.cartPhase,cartPayment:this.cartPayment,cartPsp:this.cartPsp,paymentCardTokens:this.paymentCardTokens,buyerType:s.fromModel(this.buyer)})},_createBillingInformationSection:function(){return new d({title:u.get("billingInformation"),buyer:this.buyer,buyerType:s.fromModel(this.buyer),addresses:this.addresses,addressFactory:this.addressFactory,cart:this.cart,cartPsp:this.cartPsp,cartFactory:this.cartFactory,countries:this.countries,isReadOnly:!this.isItFirstPayment})},_createTermsAndConditionsSection:function(){return new l({serviceRequest:this.service,buyer:this.buyer,cart:this.cart,tcContractFactory:this.tcContractFactory,tcDocumentFactory:this.tcDocumentFactory,shopModel:this.shop})},_createStateMachine:function(){return new r({state:P.ALL_SECTIONS_DISPLAYED,states:[P.ALL_SECTIONS_DISPLAYED,P.CREATE_BILLING_ADDRESS],transitions:[{from:P.ALL_SECTIONS_DISPLAYED,to:P.CREATE_BILLING_ADDRESS},{from:P.CREATE_BILLING_ADDRESS,to:P.ALL_SECTIONS_DISPLAYED}]})},destroy:function(){this.stopListening(),this.summarySection.destroy(),this.cartQuoteLink.destroy(),this.payementMethodSection.destroy(),this.billingInformationSection.destroy(),this.termsAndConditionsSection.destroy(),this.service=null,this.buyer=null,this.cart=null,this.cartPhase=null,this.cartPayment=null,this.cartPsp=null,this.cartQuote=null,this.cartFactory=null,this.cartItemFactory=null,this.paymentCardTokens=null,this.addresses=null,this.addressFactory=null,this.countries=null,this.tcContractFactory=null,this.tcDocumentFactory=null,this.shop=null,this._parent(),this.container=null}});return y.Events=m,y.States=P,y}),define("DS/MPFCheckout/CheckoutV2",["UWA/Class/View","UWA/Core","UWA/Promise","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/UIKIT/Scroller","DS/UIKIT/Alert","DS/MPFBuyer/BuyerType","DS/MPFShopModel/ShopModel","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFCartQuoteModel/CartQuoteModel","DS/MPFPspModel/PspModel","DS/MPFAddressModel/AddressCollection","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFCartModel/CartItemFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFCheckout/BillingAddressCreationPage","DS/MPFCheckout/PhaseSummaryPage","DS/MPFCheckout/TokenPaymentPage","DS/MPFCheckout/BankTransferPaymentPage","DS/MPFCheckout/CardPaymentPage","DS/MPFCheckout/ConfirmationPaymentPage","DS/MPFView/EmptyView","DS/MPFView/ManuallyClosedModal","DS/MPFServices/ObjectService","i18n!DS/MPFCheckout/assets/nls/CheckoutV2","css!DS/MPFCheckout/MPFCheckout","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],function(t,e,a,s,n,r,i,o,c,h,d,l,u,P,m,y,p,S,C,_,E,M,A,f,D,F,T,g,I,R,N){"use strict";const O=Object.freeze({CREATE_BILLING_ADDRESS:"createBillingAddress",PHASE_SUMMARY:"phaseSummary",CREDIT_CARD_TOKEN_PAYMENT:"creditCardTokenPayment",BANK_TRANSFER_PAYMENT:"bankTransferPayment",CARD_PAYMENT:"cardPayment",CONFIRMATION_PAYMENT:"confirmationPayment",HIPAY_THANKS_FOR_PURCHASE:"cardThankForPurchase"}),b=Object.freeze({PAYMENT_DONE:"payementDone"}),k=t.extend({className:"mpf-checkout-v2 mpf-configurator-offer",setup:function(t){R.requiredOfPrototype(t.cart,h,"options.cart must be a CartModel"),R.requiredOfPrototype(t.cartPhase,d,"options.cartPhase must be a CartPhaseModel"),R.requiredOfPrototype(t.cartPayment,l,"options.cartPayment must be a CartPaymentModel"),R.requiredOfPrototype(t.cartQuote,u,"options.cartQuote must be a CartQuoteModel"),R.requiredOfPrototype(t.cartPsp,P,"options.cartPsp must be a PspModel"),R.requiredOfPrototype(t.addresses,m,"options.addresses must be an AddressCollection"),R.requiredOfPrototype(t.addressFactory,y,"options.addressFactory must be an AddressFactory"),R.requiredOfPrototype(t.companyFactory,p,"options.companyFactory must be a CompanyFactory"),R.requiredOfPrototype(t.tcDocumentFactory,_,"options.tcDocumentFactory must be a TCDocumentFactory"),R.requiredOfPrototype(t.tcContractFactory,C,"options.tcContractFactory must be a TCContractFactory"),R.requiredOfPrototype(t.cartItemFactory,S,"options.cartItemFactory murt be a CartItemFactory"),R.requiredOfPrototype(t.shop,c,"options.shop must be a ShopModel"),this.service=t.service,this.me=t.me,this.cart=t.cart,this.cartPhase=t.cartPhase,this.cartPayment=t.cartPayment,this.cartQuote=t.cartQuote,this.cartFactory=t.cartFactory,this.cartItemFactory=t.cartItemFactory,this.companyFactory=t.companyFactory,this.buyer=t.buyer,this.addresses=t.addresses,this.addressFactory=t.addressFactory,this.countries=t.countries,this.cartPsp=t.cartPsp,this.paymentCardTokens=t.paymentCardTokens,this.tcContractFactory=t.tcContractFactory,this.tcDocumentFactory=t.tcDocumentFactory,this.shop=t.shop,this.purchaseOrderFactory=t.purchaseOrderFactory,this.purchaseOrderDocumentFactory=t.purchaseOrderDocumentFactory,this.waitForPaymentModel=t.waitForPaymentModel,this.isItFirstPayment=!0===t.isItFirstPayment,this.stateMachine=this._createStateMachine(),this.alert=this._createAlert(),this.nextButton=this._createNextButton(),this.cancelButton=this._createCancelButton(),this.modal=this._createModal()},render:function(t={}){let e;switch(this.stopListening(this.page),!0!==t.keepPage&&this.page&&this.page.destroy(),this.stateMachine.getState()){case O.CREATE_BILLING_ADDRESS:this._createBillingAddressPage(),this.nextButton.setValue(N.get("saveBillingInfo")),this.nextButton.enable(),e=N.get("enterBillingInfo");break;case O.PHASE_SUMMARY:this._createPhaseSummaryPage(),this.nextButton.setValue(N.get("confirmPhase")),e=N.get("checkout1of2");break;case O.CREDIT_CARD_TOKEN_PAYMENT:this._createTokenPaymentPage(t),this.nextButton.enable(),e=N.get("checkout2of2");break;case O.BANK_TRANSFER_PAYMENT:this._createBankTransferPaymentPage(t),this.nextButton.hide(),e=N.get("checkout2of2");break;case O.CARD_PAYMENT:this._createCardPaymentPage(t),this.nextButton.hide(),this.cancelButton.hide(),e=N.get("checkout2of2");break;case O.CONFIRMATION_PAYMENT:this._createConfirmationPaymentPage(t),this.nextButton.hide(),this.cancelButton.show(),this.cancelButton.setValue(N.get("close")),e=this._getPaymentConfirmationTitle(t),this._resizeModal(),this.dispatchEvent(b.PAYMENT_DONE,t);break;case O.HIPAY_THANKS_FOR_PURCHASE:this.cancelButton.show(),this.cancelButton.setValue(N.get("close")),e=this._getPaymentConfirmationTitle(t),this._resizeModal(),this.dispatchEvent(b.PAYMENT_DONE);break;default:this.page=g.getInstance()}return!0!==t.keepPage&&(this.alert.inject(this.modal.getBody()),this._wrapInScroller(this.page.render()).inject(this.modal.getBody()),this.container.setContent(this.modal)),e&&this.setTitle(e),this},save:function(){return s.mask(this.page.container),this.nextButton.disable(),this.page.save().finally(()=>{this.page&&e.is(this.page.container)&&(s.unmask(this.page.container),this.nextButton.enable())})},setTitle(t){this.modal.getHeader().getElement(".mpf-title").setText(t)},show(){this.modal.show()},hide:function(){this.modal.hide(),this.destroy()},_changeState:function(t,e){this.stateMachine.getState()===O.CREATE_BILLING_ADDRESS&&(this.buyerType=this.page.buyerType,this.buyer=this.page.buyer,this.addresses=this.page.addresses),this.stateMachine.changeState(t),this.render(e)},_createStateMachine:function(){let t=this.addresses.hasBillingAddresses()?O.PHASE_SUMMARY:O.CREATE_BILLING_ADDRESS;const e=this.cartPayment.getPaymentMethod()===l.PaymentMethods.BANK_CARD,a=this.cartPayment.getState(),s=e&&a===l.States.PAYMENT_INITIATED,n=e&&a===l.States.PAYMENT_REFUSED;return(s||n)&&(t=O.CARD_PAYMENT),new E({state:t,states:[O.CREATE_BILLING_ADDRESS,O.PHASE_SUMMARY,O.CREDIT_CARD_TOKEN_PAYMENT,O.BANK_TRANSFER_PAYMENT,O.CARD_PAYMENT,O.CONFIRMATION_PAYMENT,O.HIPAY_THANKS_FOR_PURCHASE],transitions:[{from:O.CREATE_BILLING_ADDRESS,to:O.PHASE_SUMMARY},{from:O.PHASE_SUMMARY,to:O.CREDIT_CARD_TOKEN_PAYMENT},{from:O.PHASE_SUMMARY,to:O.BANK_TRANSFER_PAYMENT},{from:O.PHASE_SUMMARY,to:O.CARD_PAYMENT},{from:O.CREDIT_CARD_TOKEN_PAYMENT,to:O.CONFIRMATION_PAYMENT},{from:O.CARD_PAYMENT,to:O.HIPAY_THANKS_FOR_PURCHASE},{from:O.CARD_PAYMENT,to:O.CONFIRMATION_PAYMENT}]})},_resizeModal:function(){const t=this.modal.elements.body.getElement("iframe");e.is(t)&&t.setAttribute("style","height:350px!important;min-height: unset;"),this.modal.elements.content.setStyle("height","490px"),this.cancelButton.setValue(N.get("close"))},_getPaymentConfirmationTitle:function(t){let a;return e.is(t.headerModalMsg,"string")&&t.headerModalMsg.length>0?a=t.headerModalMsg:!0===t.isPaymentOK?a=N.get("purchaseComplete"):!1===t.isPaymentOK&&(a=N.get("purchaseFailure")),a},_createNextButton(){return new n({className:"primary",value:N.get("next"),disabled:!0,events:{onClick:this.save.bind(this)}})},_createCancelButton(){return new n({value:N.get("cancel"),events:{onClick:this._onCancel.bind(this)}})},_wrapInScroller(t){return this.container.getElements(".mpf-scroll").forEach(t=>{t.destroy()}),new r({element:e.createElement("div",{class:"mpf-scroll",html:[t]})})},_createModal:function(){return new I({header:e.createElement("h4",{class:"mpf-title",text:N.get("checkout1of2")}),visible:!1,footer:[this.nextButton,this.cancelButton],events:{[I.Events.ON_CLOSE]:this._onCancel.bind(this)}})},_createAlert:function(){return new i({visible:!0})},_onCancel:function(){const t=this;if(this.stateMachine.getState()!==O.PHASE_SUMMARY||this.page.getState()!==A.States.CREATE_BILLING_ADDRESS)return s.mask(this.page.container),this.cartPayment.fetchPromise().then(this._resetPaymentState.bind(this)).then(function(){t.hide()}).catch(function(){t.alert.add({className:"error",message:N.get("errorUnableToUpdatePayment")})}).finally(s.unmask.bind(s,this.page.container));this.page.exitBillingAddressCreationMode()},_resetPaymentState:function(){const t=this.stateMachine.getState(),e=this.cartPayment.getState(),s=e===l.States.PAYMENT_INITIATED||e===l.States.PENDING_PAYMENT;let n;return t===O.CARD_PAYMENT&&s&&this.cartPayment.setState(l.States.DRAFT),this.cartPayment.hasPendingChanges()||t===O.CREDIT_CARD_TOKEN_PAYMENT?(this.cartPayment.set(l.Fields.PURCHASE_ORDER_NUMBER,""),this.cartPayment.set(l.Fields.FINANCIAL_LINE,""),n=this.cartPayment.savePromise(this.cartPayment.getPendingChanges(),{patch:!0})):n=a.resolve(),n},_paymentDone:function(){this.dispatchEvent(b.PAYMENT_DONE),this.hide()},_createBankTransferPaymentPage:function(t){const e=this;this.page=new D({cartPhase:this.cartPhase,cartPayment:this.cartPayment,purchaseOrderFactory:this.purchaseOrderFactory,purchaseOrderDocumentFactory:this.purchaseOrderDocumentFactory}),this.listenTo(this.page,D.Events.UPLOAD_PURCHASE_ORDER_LATER,this._paymentDone.bind(this)),this.listenTo(this.page,D.Events.PURCHASE_ORDER_SAVED,this._paymentDone.bind(this)),this.listenTo(this.page,D.Events.UPLOAD_PURCHASE_ORDER_NOW,function(){e.nextButton.setValue(N.get("save")),e.nextButton.setDisabled(!1),e.nextButton.show()})},_createConfirmationPaymentPage:function(t){this.page=new T({service:this.service}),this.page.setPayment(t.isPaymentOK)},_createCardPaymentPage:function(t={}){this.page=new F({me:this.me,cart:this.cart,cartPsp:this.cartPsp,cartPayment:this.cartPayment,cartPhase:this.cartPhase,saveCardInfo:t.saveCardInfo,waitForPaymentModel:this.waitForPaymentModel,service:this.service,locale:this.locale}),this.listenTo(this.page,F.Events.RESIZE_MODAL,(t={})=>{this.cartPsp.getPsp()===P.Psp.HIPAY?(t.keepPage=!0,this._changeState(O.HIPAY_THANKS_FOR_PURCHASE,t)):this._changeState(O.CONFIRMATION_PAYMENT,t)})},_createTokenPaymentPage:function(t){this.page=new f({token:t.token,cart:this.cart,cartPhase:this.cartPhase,cartPayment:this.cartPayment,cartPsp:this.cartPsp,waitForPaymentModel:this.waitForPaymentModel}),this.listenTo(this.page,f.Events.PAYMENT_DONE,t=>{this._changeState(O.CONFIRMATION_PAYMENT,t)})},_createBillingAddressPage:function(){this.page=new M({service:this.service,me:this.me,cart:this.cart,cartPhase:this.cartPhase,company:o.fromModel(this.buyer)===o.COMPANY?this.buyer:void 0,companyFactory:this.companyFactory,buyerType:o.fromModel(this.buyer),addresses:this.addresses,addressFactory:this.addressFactory,countries:this.countries,cartPsp:this.cartPsp}),this.listenTo(this.page,M.Events.PAGE_SAVED,this._changeState.bind(this,O.PHASE_SUMMARY))},_createPhaseSummaryPage:function(){this.page=new A({service:this.service,buyer:this.buyer,cart:this.cart,cartPhase:this.cartPhase,cartPayment:this.cartPayment,cartPsp:this.cartPsp,cartQuote:this.cartQuote,cartFactory:this.cartFactory,paymentCardTokens:this.paymentCardTokens,addresses:this.addresses,addressFactory:this.addressFactory,countries:this.countries,tcDocumentFactory:this.tcDocumentFactory,tcContractFactory:this.tcContractFactory,shop:this.shop,cartItemFactory:this.cartItemFactory,isItFirstPayment:this.isItFirstPayment}),this.listenTo(this.page,A.Events.PAYMENT_BY_CARD,this._changeState.bind(this,O.CARD_PAYMENT)),this.listenTo(this.page,A.Events.PAYMENT_BY_TOKEN,this._changeState.bind(this,O.CREDIT_CARD_TOKEN_PAYMENT)),this.listenTo(this.page,A.Events.PAYMENT_BY_BANK_TRANSFER,this._changeState.bind(this,O.BANK_TRANSFER_PAYMENT)),this.listenTo(this.page,A.Events.VALID_PAGE,this.nextButton.enable.bind(this.nextButton)),this.listenTo(this.page,A.Events.INVALID_PAGE,this.nextButton.disable.bind(this.nextButton)),this.listenTo(this.page,A.Events.DISPLAY_MASK,s.mask.bind(s,this.modal.getBody())),this.listenTo(this.page,A.Events.REMOVE_MASK,s.unmask.bind(s,this.modal.getBody())),this.listenTo(this.page,A.Events.BILLING_ADDRESS_CREATION,this.nextButton.hide.bind(this.nextButton)),this.listenTo(this.page,A.Events.EXIT_BILLING_ADDRESS_CREATION,this.nextButton.show.bind(this.nextButton))},destroy:function(){this.stopListening(),this.page&&this.page.destroy(),this.modal&&this.modal.destroy(),this.page=null,this.modal=null,this.me=null,this.cart=null,this.cartPhase=null,this.cartPayment=null,this.cartFactory=null,this.cartItemFactory=null,this.companyFactory=null,this.buyer=null,this.addresses=null,this.addressFactory=null,this.countries=null,this.cartPsp=null,this.paymentCardTokens=null,this.waitForPaymentModel=null,this.tcContractFactory=null,this.tcDocumentFactory=null,this.shop=null,this.stateMachine=null,this._parent(),this.container=null}});return k.Events=Object.freeze(b),k.States=Object.freeze(O),k}),define("DS/MPFCheckout/CheckoutV2Factory",["UWA/Class","UWA/Promise","DS/MPFConnector/MarketplaceConnector","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFPersonModel/PersonFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFAddressModel/AddressFactory","DS/MPFCartModel/CartFactory","DS/MPFCountryModel/CountryFactory","DS/MPFCartPhaseModel/CartPhaseFactory","DS/MPFCartPaymentModel/CartPaymentFactory","DS/MPFCartQuoteModel/CartQuoteFactory","DS/MPFPspModel/PspFactory","DS/MPFPaymentCardTokenModel/PaymentCardTokenFactory","DS/MPFCartPaymentModel/WaitForPaymentFactory","DS/MPFShopModel/ShopFactory","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFBuyer/Buyer","DS/MPFBuyer/BuyerType","DS/MPFCheckout/CheckoutV2"],function(t,e,a,s,n,r,i,o,c,h,d,l,u,P,m,y,p,S,C,_){"use strict";const E=t.extend({init:function(t){this.cartId=t.cartId,this.phaseId=t.phaseId,this.service=t.service},createComponent:function(){return a.fetchPromise({service:this.service}).then(this._getFactories.bind(this)).then(this._getCartAndPhases.bind(this)).then(this._createQuote.bind(this)).then(this._getPsp.bind(this)).then(this._getPhaseAndPayment.bind(this)).then(this._getBuyer.bind(this)).then(this._getPaymentCardTokens.bind(this)).then(this._getCountries.bind(this)).then(this._getAddresses.bind(this)).then(this._getShop.bind(this)).then(this._createCheckoutV2.bind(this))},_getFactories:function(t){const a=this,n=s.getInstance(t);return e.all([n.getFactory(s.Types.CART),n.getFactory(s.Types.PERSON),n.getFactory(s.Types.COMPANY),n.getFactory(s.Types.ADDRESS),n.getFactory(s.Types.COUNTRY),n.getFactory(s.Types.CART_PHASE),n.getFactory(s.Types.CART_PAYMENT),n.getFactory(s.Types.PSP),n.getFactory(s.Types.PAYMENT_CARD_TOKEN),n.getFactory(s.Types.TC_DOCUMENT),n.getFactory(s.Types.TC_CONTRACT),n.getFactory(s.Types.SHOP),n.getFactory(s.Types.CART_ITEM),n.getFactory(s.Types.PURCHASE_ORDER),n.getFactory(s.Types.PURCHASE_ORDER_DOCUMENT),n.getFactory(s.Types.CART_QUOTE),n.getFactory(s.Types.WAIT_FOR_PAYMENT)]).then(function(t){return a.cartFactory=t[0],a.personFactory=t[1],a.companyFactory=t[2],a.addressFactory=t[3],a.countryFactory=t[4],a.cartPhaseFactory=t[5],a.cartPaymentFactory=t[6],a.pspFactory=t[7],a.paymentCardTokenFactory=t[8],a.tcDocumentFactory=t[9],a.tcContractFactory=t[10],a.shopFactory=t[11],a.cartItemFactory=t[12],a.purchaseOrderFactory=t[13],a.purchaseOrderDocumentFactory=t[14],a.cartQuoteFactory=t[15],a.waitForPaymentFactory=t[16],a.companyFactory.addressFactory=a.addressFactory,a.addressFactory.whenReady()})},_getCartAndPhases:function(){return this.cart=this.cartFactory.createModel(o.Types.CART),this.cart.set("id",this.cartId),this.cartPhases=this.cartPhaseFactory.createCollection(h.Types.CART_CART_PHASE),this.cartPhases.setParentResourceId(this.cartId),e.all([this.cart.fetchPromise({expand:["cart-items"]}),this.cartPhases.fetchPromise()])},_getPsp:function(){return this.cartPsp=this.pspFactory.createModel(u.Types.CART_PSP),this.cartPsp.setParentResourceId(this.cart.id),this.cartPsp.fetchPromise()},_getPhaseAndPayment:function(){const t=this;return this.cartPhase=this.cartPhases.get(this.phaseId),this.cartPhase||(this.cartPhase=this.cartPhases.find(function(t){const e=t.getState();return e===p.States.ACCEPTED||e===p.States.PAYMENT_REFUSED})),this.cartPayment=this.cartPaymentFactory.createModel(d.Types.CART_PHASE_CART_PAYMENT),this.cartPayment.setParentResourceId(this.cartPhase.id),this.cartPayment.fetchPromise().then(function(){t.waitForPaymentModel=t.waitForPaymentFactory.createModel(m.Types.PAYMENT),t.waitForPaymentModel.setParentResourceId(t.cartPayment.get("id"))})},_getBuyer:function(){const t=this;return this.me=this.personFactory.createModel(n.Types.ME),this.me.fetchPromise().then(S.fromPerson).then(function(e){t.buyer=e.model})},_getPaymentCardTokens:function(){return this.paymentCardTokens=this.paymentCardTokenFactory.createCollection(P.Types.ME),this.paymentCardTokens.fetchPromise()},_getCountries:function(){return this.countries=this.countryFactory.createCollection(c.Types.BUYER),this.countries.fetchPromise()},_getAddresses:function(){const t=C.fromModel(this.buyer);return t===C.COMPANY?(this.addresses=this.buyer.addresses,this.addresses.setParentResourceId(this.buyer.id),e.resolve(this.addresses)):t===C.INDIVIDUAL?(this.addresses=this.addressFactory.createCollection(i.Types.PERSON),this.addresses.setParentResourceId(this.buyer.id),this.addresses.fetchPromise()):void 0},_getShop:function(){return this.shop=this.shopFactory.createModel(y.Types.SHOP,{id:this.cart.getShopID()}),this.shop.fetchPromise()},_createQuote:function(){this.cartQuote=this.cartQuoteFactory.createModel(l.Types.CART_QUOTE),this.cartQuote.setParentResourceId(this.cart.id)},_isItFirstPayment:function(){const t=this;let e=!0;return this.cartPhases.forEach(function(a){a.getPhaseNumber()<t.cartPhase.getPhaseNumber()&&(e=e&&a.getState()===p.States.DELETED)}),e},_createCheckoutV2:function(){return new _({service:this.service,me:this.me,cart:this.cart,cartPhase:this.cartPhase,cartPayment:this.cartPayment,cartQuote:this.cartQuote,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,companyFactory:this.companyFactory,buyer:this.buyer,addresses:this.addresses,addressFactory:this.addressFactory,countries:this.countries,cartPsp:this.cartPsp,paymentCardTokens:this.paymentCardTokens,tcDocumentFactory:this.tcDocumentFactory,tcContractFactory:this.tcContractFactory,shop:this.shop,purchaseOrderFactory:this.purchaseOrderFactory,purchaseOrderDocumentFactory:this.purchaseOrderDocumentFactory,waitForPaymentModel:this.waitForPaymentModel,isItFirstPayment:this._isItFirstPayment()})}});return E.from=function(t){return new E(t).createComponent()},E});