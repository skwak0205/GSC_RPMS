define("DS/DMUPlaySection/DMUSectionImport",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e){this.importData=function(t,i,n){t&&i&&e&&(i.fillObjectAttributes(e,t,n),i.registerForPostImport(e))},this.afterImport=function(){e&&e.fireEvent("onDMUObjectInitialized",{dmuObject:e})}}})}),define("DS/DMUPlaySection/DMUSectionRobotWithRuler",["UWA/Class","DS/DMUMeasurable/DMUManipulablePlane","DS/DMUMeasurable/DMUToolsMaths","DS/Visualization/ThreeJS_DS","DS/CATWebUXRobotWithRuler/CATWebUXRobotWithRuler","DS/Web3DUXFilterBar/Web3DUXFilterBar","DS/WebappsUtils/WebappsUtils","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/EXPUnitManagement","DS/DMUBaseExperience/EXPUtils","DS/DMUMeasurable/DMUMeasurable","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUSwitchRepService","DS/DMUMeasurable/DMUSectionPosService","i18n!DS/DMUPlayMeasure/assets/nls/DMUPlayMeasure","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/PathElement","DS/Ruler/Ruler","DS/Ruler/AngularRuler","DS/Robot/LineTranslationNode","DS/DMUMeasurable/DMUToolsSceneGraph","DS/SceneGraphNodes/FixedSizeNode3D","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/DMUMeasurable/DMUPreVisuNode3D","DS/DMUMeasurable/DMUMeasureEnums"],function(e,t,i,n,a,o,r,l,s,c,u,d,p,g,v,f,m,S,h,M,b,y,w,P,C,_,V,D){"use strict";return e.extend({init:function(e,x){this._parent();var A,N,R,O,E=e,T=E._frameWindow,I=T.getViewer(),U=m,B=S,L=h,k=E._appType,F=new g({viewer:I}),z=!1,W=!1,G={clearTimeout:void 0,lockedNodeIds:[]};function X(){G&&G.clearTimeout&&(G.clearTimeout(),G.clearTimeout=void 0)}function j(){F&&G&&(F.unlockNodes({nodeIDsToUnlock:G.lockedNodeIds,nodeIDsToUnlockMeshInRAM:G.lockedNodeIds}),G.lockedNodeIds=[])}var Y,H,J,Z,q,Q,K,$,ee,te=this,ie=!1,ne=[],ae=[],oe={origin:new n.Vector3,initOrigin:new n.Vector3,direction:null,initValue:null,value:null,origin3D:null},re={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null},le=function(){var e=(new n.Vector3).copy(E._getUDirection()),t=(new n.Vector3).copy(E._getVDirection()),i=(new n.Vector3).copy(E._getNormal()),a=(new n.Matrix4).makeBasis(e,t,i.negate()),o=(new n.Vector3).copy(E._getCenter());return a.setPosition(o),a},se=function(e){ee=null;var t=new n.Vector3,i=new n.Vector3,a=new n.Vector3;return e.extractBasis(t,i,a),a.x>.9995||-a.x>.9995||a.y>.9995||-a.y>.9995||a.z>.9995||-a.z>.9995?(ee=new n.Vector3(0,0,0),$=ee.clone()):(ee=(new n.Vector3).getPositionFromMatrix(e),$=ee.clone()),ee};x?($=x,ee=x):se(le()),this._getRulerOriginPos=function(){return $?$.clone():$};var ce=function(e){var t=e.viewer.pick(e.viewer.getMousePosition(e.event.from[0].getCurrentPosition(e.viewer.canvas)),"mesh",!1);if(0!==t.path.length&&t.path[0]){var i,a=t.path[0];return(i=a&&a.getWorldMatrix?(new n.Vector3).getPositionFromMatrix(a.getWorldMatrix()):new n.Vector3(0,0,0))&&(oe.origin3D=i.clone(),$=i.clone(),ee=i.clone()),a?{origin3D:i}:void 0}},ue=function(e,t){if(H&&e&&(e.axis||e.manipulator.axis)){var i=(new n.Vector3).copy(e.axis?e.axis:e.manipulator.axis);re.direction=i;var a=t?E._getVDirection():E._getUDirection();!function(e,t){if(H){var i=(new n.Vector3).copy(e);H.direction=i.negate(),H.setValue(0),H.initValue=H.value,H.origin=(new n.Vector3).copy(E._getCenter()),H.originVector=(new n.Vector3).copy(t),H.display()}}(e.axis?e.axis:e.manipulator.axis,a)}};this.buildRobot=function(){var e=I.picking.primitive,s=I.pPicking.primitive,g={},m={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,surface:0,product:0};function S(e){return!(1!==m.product||0!==m.point||0!==m.center||0!==m.axisSystem||0!==m.line||0!==m.plane||0!==m.cylinder||!e&&0!==m.surface)}var h=function(e){var t,i,a,o,r,l,s=e.clone();return t=(s=s.negate()).x,i=s.y,a=s.z,o=Math.abs(t),r=Math.abs(i),l=Math.abs(a),o>=r&&o>=l?t>0?new n.Vector3(1,0,0):new n.Vector3(-1,0,0):r>o&&r>=l?i>0?new n.Vector3(0,1,0):new n.Vector3(0,-1,0):l>o&&l>r?a>0?new n.Vector3(0,0,1):new n.Vector3(0,0,-1):s};A=new a({frameWindow:T,lightDisplay:"3dPlay"===k});var M=le();A.setPosition({robotMatrix:M,translationRulerOrigin:se(M)}),oe.origin3D=ee;var b=E._getCenter();oe.origin=b.clone(),oe.initOrigin=b.clone(),oe.baseOrigin=b.clone(),A.setVisibility(!0),A.robotOrigin3DCompute=ce,A.moveRulerOrigin=function(){E._setPlaneVisibility(!1),E._CBManipulationInformation({action:t.ManipulationAction.DO,type:t.ManipulationType.CENTER})},A.moveRulerOriginEnd=function(){E._setPlaneVisibility(!0)};var y=function(e){e&&(e.drawMode="Section",te._preVisuNode?te._preVisuNode.buildPreVisuNode({data:e}):(te._preVisuNode=new V(I),te._preVisuNode.buildPreVisuNode({data:e}),te._preVisuNode.setNoZ(!0),te._preVisuNode.setPickable(C.PICKTHROUGH),I&&(w.getSceneRoot(I).add(te._preVisuNode),I.render())),te._preVisuNode.setVisibility(I.getVisibleSpace()))},P=function(){te._preVisuNode&&(w.getSceneRoot(I).remove(te._preVisuNode),I.render(),te._preVisuNode.removeChildren(),te._preVisuNode.remove(),te._preVisuNode=void 0)};A.robotMatrixCompute=function(e){X(),W=!0;var t=l.getViewpointInfo(I.currentViewpoint),i=e.viewer.pick(e.viewer.getMousePosition(e.event.from[0].getCurrentPosition(e.viewer.canvas)),"primHybrid",!0);if(i.path.length>0&&i.path[0]&&F&&(m.none||!(S(!0)||0===m.point&&0===m.center&&0===m.axisSystem&&0===m.line&&0===m.plane&&0===m.cylinder&&1===m.surface))){var a=F.switchToAV1({path:i.path[0],lockNodesAfterSwitch:!0,lockMeshInRAMAfterSwitch:!0,onCompleteCB:function(e){G.clearTimeout=void 0;var t=e.nodeIDsOfLockedNodes;t&&t.length>0&&(G.lockedNodeIds||(G.lockedNodeIds=[]),t.forEach(function(e){-1===G.lockedNodeIds.indexOf(e)&&G.lockedNodeIds.push(e)}))},onFailureCB:function(){G.clearTimeout=void 0}});if(a&&a.clearTimeout&&(G.clearTimeout=a.clearTimeout),a&&a.nodeIDsOfAlreadyLoadedNode&&a.nodeIDsOfAlreadyLoadedNode.length){var o=[];a.nodeIDsOfAlreadyLoadedNode.forEach(function(e){-1===G.lockedNodeIds.indexOf(e)&&(o.push(e),G.lockedNodeIds.push(e)),o&&o.length&&(F.lockNodes({nodeIDsTolock:o,nodeIDsTolockMeshInRAM:o}),o=[])})}}if(0!==i.path.length&&i.path[0]&&i.position){g.axisX=void 0,g.axisY=void 0,g.axisZ=void 0,g.position=void 0;var r,s,c=i.path[0];i.normal&&(r=i.normal),i.position&&(s=i.position);var v=!1,f={};if(m.none||m.axisSystem||S()){var M=c,b=function(e){if(!e||!e.externalPath)return!1;for(var t=e.externalPath.length-1;t>=0;--t){var i=e.externalPath[t];if(w.isPLMNode(i))break;if("AxisSystems"===i.name)return t}return 0}(M);if(b||S()){if(t&&t.sight){var C;if(m.none||m.axisSystem){M&&M.getWorldMatrix?C=M.getWorldMatrix():(C=(new n.Matrix4).makeBasis(new n.Vector3(1,0,0),new n.Vector3(0,1,0),new n.Vector3(0,0,1))).setPosition(new n.Vector3(0,0,0));var _=M.externalPath[b+1];if(Boolean(_)&&Boolean(_.getMatrixWorld())){var V=_.getMatrixWorld();V&&(C=V)}for(var x=[],A=0;A<b+2;A++){var N=M.externalPath[A];x.push(N)}x.length&&(R=new L(x),U.add({pathElement:R}))}else{var E=c;C=E.getWorldMatrix(),S()&&(C=(E=function(e){var t=e;return e.pathElement=new L,t.externalPath.some(function(t){return e.pathElement.addElement(t),t&&w.is3DLeaf(t)}),t.internalPath.length>0&&(e.originalPathElement=t),e}(c)).getWorldMatrix())}var T=C.clone(),k=new n.Vector3,j=new n.Vector3,Y=new n.Vector3;if(T.extractBasis(k,j,Y),s=(new n.Vector3).getPositionFromMatrix(T),(r=function(e,t,i,n){if(e||t&&i&&n){var a,o=t,r=void 0,l=e.clone();return l=l.negate(),t&&(r=a=l.angleTo(t),o=t),i&&(a=l.angleTo(i))<r&&(r=a,o=i),n&&(a=l.angleTo(n))<r&&(r=a,o=n),o}}(t.sight,k,j,Y))&&(r.equals(k.clone())||r.equals(k.clone().negate())?(f.axis1=j,f.axis2=Y):r.equals(j.clone())||r.equals(j.clone().negate())?(f.axis1=k,f.axis2=Y):(r.equals(Y.clone())||r.equals(Y.clone().negate()))&&(f.axis1=j,f.axis2=k)),S()){var H=[],J=(new n.Matrix4).makeBasis(f.axis1,f.axis2,r);J.setPosition(s),H.worldMatrix=J,H.resultType=D.ResultType.PRODUCT,y(H)}v=!0}v||(r=void 0,s=void 0,v=!0)}}var Z,q,Q=w.isOOCTileSetNodeInPath(c);if(c&&!v&&(c.getLastElement().sgNode||Q)){var K;if(Q){var $=(new n.Matrix4).getInverse(c.getWorldMatrix()),ee=i.position,ie=ee.clone().applyMatrix4($);K=new u({canonic:{type:p.GeometryType.POINT,position:ie},pathElement:c,selpoint:ee})}else K=new u({primitive:c.getLastElement().sgNode,pathElement:c,selpoint:i.position});var ne=K.getType();switch(te._preVisuNode&&O!==ne&&P(),ne){case p.GeometryType.POINT:W=!1,m.none||m.point?(y(K),t&&t.sight&&(r=h(t.sight))):(r=void 0,s=void 0);break;case p.GeometryType.LINE:if(W=!1,m.none||m.line){if(y(K),t&&t.sight){var ae=K.getPoints(),oe=new n.Vector3;oe.subVectors(ae.beginPoint,ae.endPoint).normalize();var re=oe.dot(t.sight);r=oe.multiplyScalar(re>0?1:-1).negate(),s=i.position}}else r=void 0,s=void 0;break;case p.GeometryType.CIRCLE:W=!1,m.none||m.center?(y(K),t&&t.sight&&(r=h(t.sight)),s=K.getCenter()):(r=void 0,s=void 0);break;case p.GeometryType.SPHERE:case p.GeometryType.SURFACE:case p.GeometryType.PLANE:if(ne===p.GeometryType.SPHERE&&!m.surface)break;if(m.none||m.plane||m.surface){if(m.none&&ne===p.GeometryType.SURFACE||m.surface&&(!m.plane||ne===p.GeometryType.SURFACE))K.normal=i.normal,K.resultType=D.ResultType.SURFACE,z=!1,O===ne&&(z=!0),O=ne,K.onlyUpdatePos=z;else if(m.plane&&!m.surface&&ne!==p.GeometryType.PLANE){r=void 0,s=void 0;break}y(K),r=i.normal}else r=void 0,s=void 0;break;case p.GeometryType.CYLINDER:case p.GeometryType.CONE:if(m.none||m.cylinder){y(K),r=i.normal;var le=K.getPoints(),se=i.position.toArray(),ce=le.beginPoint.toArray(),ue=K.getAxis().toArray(),de=r.toArray(),pe=d.computeTwoLinesDistance(se,de,ce,ue).aPosition2;s=new n.Vector3(pe[0],pe[1],pe[2])}else m.surface?(z=!1,O===ne&&(z=!0),O=ne,K.onlyUpdatePos=z,K.resultType=D.ResultType.SURFACE,K.normal=i.normal,y(K),s=i.position,r=i.normal):(r=void 0,s=void 0);break;default:r=void 0,s=void 0}}else if(m.surface||m.none){var ge=[];ge.normal=i.normal;var ve=i.position;ge.getSelPoint=function(){return ve},ge.resultType=D.ResultType.SURFACE,z=!1,O===D.ResultType.SURFACE&&(z=!0),O=D.ResultType.SURFACE,ge.onlyUpdatePos=z,y(ge)}if(!r||!s)return I.setPicking({displayHL:!1}),I.setPrePicking({displayHL:!1}),void(c&&(U.empty(),B.empty()));if(I.setPicking({displayHL:!0}),I.setPrePicking({displayHL:!0}),r.negate(),r.normalize(),v&&f&&f.axis1&&f.axis2)Z=f.axis1,q=f.axis2;else{var fe=w.getXYAxisDirFromZ(r.clone());fe.xDir&&fe.yDir&&(Z=fe.xDir,q=fe.yDir)}g.axisX=Z.clone(),g.axisY=q.clone(),g.axisZ=r.clone(),g.position=s.clone();var me=(new n.Matrix4).makeBasis(Z,q,r.negate()),Se=(new n.Vector3).copy(s);return me.setPosition(Se),{robotMatrix:me}}te._preVisuNode&&P()};var _=function(e){var t=(new n.Matrix4).copy(Z),i=(new n.Matrix4).setPosition((new n.Vector3).getPositionFromMatrix(q)),a=(new n.Matrix4).getInverse(i).multiply(t),o=(new n.Matrix4).copy(e).multiply(a),r=(new n.Matrix4).copy(i).multiply(o);E._CBSetGeometry({referential:r})};!function(){A.moveBegin=function(e){te.clearRulers(),ie=!0,"translation"===e.kind?function(e){if(E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){N&&N.setVisibleFlag(!0);var i=E._CBGetGeometry();Z=(new n.Matrix4).copy(i.referential),q=e.robotMatrix,E._CBManipulationInformation({action:t.ManipulationAction.BEGIN,type:t.ManipulationType.TRANSLATION,evt:e.event})}}(e):function(e){if(N&&N.setVisibleFlag(!0),E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var i=E._CBGetGeometry();Z=(new n.Matrix4).copy(i.referential),q=e.robotMatrix,E._CBManipulationInformation({action:t.ManipulationAction.BEGIN,type:t.ManipulationType.ROTATION,evt:e.event})}}(e)},A.move=function(e){e&&("ruler"===e.from?"translation"===e.kind?function(e){if(E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){var i=E._getCenter(),n=E._CBGetGeometry().referential;n.setPosition(i.clone().add(e.translationVector)),E._CBSetGeometry({referential:n}),E._CBManipulationInformation({action:t.ManipulationAction.BEGIN,type:t.ManipulationType.TRANSLATION,evt:e.event})}}(e):function(e){if(E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var n,a=e.axis.clone().dot(E._getUDirection()),o=e.axis.clone().dot(E._getVDirection());i.areEqual(Math.abs(o),1,"float")?(n=i.isLessOrEqual(o,0)?-e.rotationAngle:e.rotationAngle,E._CBSetGeometry({referential:Z.rotateY(n)})):(n=i.isLessOrEqual(a,0)?-e.rotationAngle:e.rotationAngle,E._CBSetGeometry({referential:Z.rotateX(n)})),E._CBManipulationInformation({action:t.ManipulationAction.BEGIN,type:t.ManipulationType.ROTATION,evt:e.event})}}(e):"robot"===e.from&&("translation"===e.kind?function(e){if(E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){var i=(new n.Matrix4).makeTranslation(e.translationVector.x,e.translationVector.y,e.translationVector.z);_(i),E._CBManipulationInformation({action:t.ManipulationAction.DO,type:t.ManipulationType.TRANSLATION,evt:e.event})}}(e):function(e){if(E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var i=e.axis,a=e.rotationAngle,o=(new n.Matrix4).makeRotationAxis(i,a);_(o),E._CBManipulationInformation({action:t.ManipulationAction.BEGIN,type:t.ManipulationType.ROTATION,evt:e.event})}}(e)))},A.moveEnd=function(e){ie=!1,"translation"===e.kind?function(e){E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})&&(Z=void 0,q=void 0),E._CBManipulationInformation({action:t.ManipulationAction.END,type:t.ManipulationType.TRANSLATION,evt:e.event})}(e):function(e){E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})&&(Z=void 0,q=void 0);var i=le();A.setPosition({robotMatrix:i,translationRulerOrigin:se(i),doNotResetRuler:1}),oe.origin3D=ee,E._CBManipulationInformation({action:t.ManipulationAction.END,type:t.ManipulationType.ROTATION,evt:e.event})}(e)};A.moveRobotBegin=function(i){X(),te.clearRulers(),E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.CENTER,evt:i.event})&&(S()||(e=I.picking.primitive,s=I.pPicking.primitive,1!==e&&I.setPicking({primitive:1}),1!==s&&I.setPrePicking({primitive:1})),E._setPlaneVisibility(!1),E._CBManipulationInformation({action:t.ManipulationAction.BEGIN,type:t.ManipulationType.CENTER,evt:i.event}))},A.moveRobot=function(e){E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.CENTER,evt:e.event})&&(E._setPlaneVisibility(!1),E._CBManipulationInformation({action:t.ManipulationAction.BEGIN,type:t.ManipulationType.CENTER,evt:e.event}))},A.moveRobotEnd=function(i){if(E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.CENTER})){te._preVisuNode&&P(),E._setPlaneVisibility(!0);var a,o,r=E._CBGetGeometry().referential;if(g.axisX&&g.axisY&&g.axisZ&&g.position){if(r.makeBasis(g.axisX,g.axisY,g.axisZ),r.setPosition(g.position),!c.isEnvActivated("oldSectionPlaneDim",!0)){var l=(new n.Plane).setFromNormalAndCoplanarPoint(g.axisZ.clone(),g.position.clone()),u=w.computeBoundingBox(I);if(W&&u&&u.center){var d=u.center();if(d){var p=l.projectPoint(d);u.containsPoint(p)&&(g.position=p.clone()),r.setPosition(g.position)}}var f=v.computePlaneDim(u,r,W);f&&(f.fPlaneSizeV&&f.fPlaneSizeU&&(a=f.fPlaneSizeU,o=f.fPlaneSizeV),f.plane&&((r=f.plane).extractBasis(g.axisX,g.axisY,g.axisZ),g.position=(new n.Vector3).getPositionFromMatrix(r)))}E._CBSetGeometry({referential:r,uSize:a,vSize:o,uStep:a?a/20:void 0,vStep:o?o/20:void 0});var m=(new n.Matrix4).makeBasis(g.axisX,g.axisY,g.axisZ.clone().negate()),h=(new n.Vector3).copy(g.position);m.setPosition(h),A.setPosition({robotMatrix:m,translationRulerOrigin:se(m)});var M=(new n.Vector3).getPositionFromMatrix(m);oe.origin=M.clone(),oe.initOrigin=M.clone(),oe.baseOrigin=M.clone(),oe.origin3D=ee}}S()||(I.setPicking({primitive:e}),I.setPrePicking({primitive:s})),E._CBManipulationInformation({action:t.ManipulationAction.END,type:t.ManipulationType.CENTER,evt:i.event}),X(),j(),O=void 0,z=!1}}(),function(){var e=localStorage.getItem("SectionSelectionFilter");e&&12===e.length&&e.startsWith("0-")&&(m.point="1"===e.charAt(2)?1:0,m.center="1"===e.charAt(3)?1:0,m.axisSystem="1"===e.charAt(4)?1:0,m.line="1"===e.charAt(5)?1:0,m.plane="1"===e.charAt(6)?1:0,m.cylinder="1"===e.charAt(7)?1:0,m.surface="1"===e.charAt(8)?1:0,m.product="1"===e.charAt(9)?1:0,0===m.point&&0===m.center&&0===m.axisSystem&&0===m.line&&0===m.plane&&0===m.cylinder&&0===m.surface&0===m.product?m.none=1:m.none=0);var t=function(){if(N){m={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,surface:0,product:0},N.getActiveState("point")&&(m.none=0,m.point=1),N.getActiveState("center")&&(m.none=0,m.center=1),N.getActiveState("axisSystem")&&(m.none=0,m.axisSystem=1),N.getActiveState("line")&&(m.none=0,m.line=1),N.getActiveState("plane")&&(m.none=0,m.plane=1),N.getActiveState("cylinder")&&(m.none=0,m.cylinder=1),N.getActiveState("surface")&&(m.none=0,m.surface=1),N.getActiveState("product")&&(m.none=0,m.product=1);var e="0-"+m.point+m.center+m.axisSystem+m.line+m.plane+m.cylinder+m.surface+m.product+"-1";localStorage.setItem("SectionSelectionFilter",e)}};if(!N){var i={};i.point=f.point,i.center=f.center,i.axisSystem=f.axisSystem,i.line=f.line,i.plane=f.plane,i.cylinder=f.cylinder,i.surface=f.surface,i.product=f.product;var n=r.getWebappsAssetUrl("DMUMeasure","icons/32/");(N=new o({body:T.getUIFrame(),frmWindow:T,Idpanel:"SectionSelectionFilter",classpanel:"SectionSelectionFilter",typeSeparator:"bubble",lJsonElement:[{type:"element",id:"point",nls:i.point,url:n+"I_Meas_Point.png",callback:t,bexclude:!1,bstateActif:m.point},{type:"element",id:"center",nls:i.center,url:n+"I_Meas_PointCircle.png",callback:t,bexclude:!1,bstateActif:m.center},{type:"element",id:"axisSystem",nls:i.axisSystem,url:n+"I_Meas_Axis.png",callback:t,bexclude:!1,bstateActif:m.axisSystem},{type:"element",id:"line",nls:i.line,url:n+"I_Meas_Line.png",callback:t,bexclude:!1,bstateActif:m.line},{type:"element",id:"plane",nls:i.plane,url:n+"I_Meas_Plane.png",callback:t,bexclude:!1,bstateActif:m.plane},{type:"element",id:"cylinder",nls:i.cylinder,url:n+"I_Meas_Cylinder.png",callback:t,bexclude:!1,bstateActif:m.cylinder},{type:"element",id:"surface",nls:i.surface,url:n+"I_Meas_Surface.png",callback:t,bexclude:!1,bstateActif:m.surface},{type:"element",id:"product",nls:i.product,url:n+"I_Meas_Product.png",callback:t,bexclude:!1,bstateActif:m.product}]}))&&(N.build(),N.setVisibleFlag(!0))}}()};var de=function(){(Y=new M(T,{displayOrigin:!1,offset:20,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!1,lightDisplay:"3dPlay"===k})).setVisibilityFree(!0);var e,i,n;(ae=[]).push(Y.subscribe("OriginManipulateBegin",function(){e=Y.displayOrigin,i=(Y.origin3DPos||Y.origin).clone()})),Y.onOriginManipulator=function(a){if(n=null,ce){var o=ce({event:a.event,viewer:I});(n=o&&o.origin3D)&&E._CBManipulationInformation({action:t.ManipulationAction.DO,type:t.ManipulationType.CENTER})}return Y.displayOrigin=e,n?(Y.displayOrigin=!0,E&&E._setPlaneVisibility(!1),n.clone()):i},ae.push(Y.subscribe("OriginManipulateEnd",function(){A&&A.setPosition({translationRulerOrigin:n?n.clone():n}),oe.origin3D=n?n.clone():n,E&&E._setPlaneVisibility(!0)})),ae.push(Y.subscribe("RulerManipulateBegin",function(e){var i;i=e,E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:i.event})&&(te._robot&&te._robot.setVisibility(!1),E._CBManipulationInformation({action:t.ManipulationAction.BEGIN,type:t.ManipulationType.TRANSLATION,evt:i.event}))})),ae.push(Y.subscribe("RulerManipulate",function(e){!function(e){if(E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){var i=E._getCenter(),n=E._CBGetGeometry().referential;n.setPosition(i.clone().add(e.translationVector)),E._CBSetGeometry({referential:n}),E._CBManipulationInformation({action:t.ManipulationAction.BEGIN,type:t.ManipulationType.TRANSLATION,evt:e.event})}te.updateRobotPos()}(e)})),ae.push(Y.subscribe("RulerManipulateEnd",function(e){var i;i=e,E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:i.event})&&te._robot&&te._robot.setVisibility(!0),E._CBManipulationInformation({action:t.ManipulationAction.END,type:t.ManipulationType.TRANSLATION,evt:i.event}),te.updateRobotPos()}))},pe=function(){(H=new b(T,{radius:150,mainGrad:10,nbSecondaryGrads:4,displayUnit:!0,lightDisplay:"3dPlay"===k})).setVisibilityFree(!0);(ne=[]).push(H.subscribe("AngularRulerManipulateBegin",function(e){!function(e){if(E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var i=E._CBGetGeometry();Z=(new n.Matrix4).copy(i.referential),te._robot&&(q=(new n.Matrix4).copy(te._robot.getMatrix()),te._robot.setVisibility(!1)),E._CBManipulationInformation({action:t.ManipulationAction.BEGIN,type:t.ManipulationType.ROTATION,evt:e.event})}}(e)})),ne.push(H.subscribe("AngularRulerManipulate",function(e){!function(e){if(E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var n,a=e.direction.clone().dot(E._getUDirection()),o=e.direction.clone().dot(E._getVDirection());i.areEqual(Math.abs(o),1,"float")?(n=i.isLessOrEqual(o,0)?-e.diffAngle:e.diffAngle,E._CBSetGeometry({referential:Z.rotateY(n*Math.PI/180)})):(n=i.isLessOrEqual(a,0)?-e.diffAngle:e.diffAngle,E._CBSetGeometry({referential:Z.rotateX(n*Math.PI/180)})),E._CBManipulationInformation({action:t.ManipulationAction.BEGIN,type:t.ManipulationType.ROTATION,evt:e.event})}te.updateRobotPos(!1,!0)}(e)})),ne.push(H.subscribe("AngularRulerManipulateEnd",function(e){var i;i=e,E._CBManipulationInformation({action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:i.event})&&(Z=void 0,te._robot&&te._robot.setVisibility(!1)),E._CBManipulationInformation({action:t.ManipulationAction.END,type:t.ManipulationType.ROTATION,evt:i.event}),te.updateRobotPos(!1,!0)}))};return this.clean=function(){A&&(A.destroy(),A=null),N&&(N.clear(),N=null),Q&&(I.removeNode(Q),Q.removeChildren(),Q.remove(),Q=void 0),Y&&ae&&ae.length>0&&(ae.forEach(function(e){Y.unsubscribe(e)}),ae=[]),H&&ne&&ne.length>0&&(ne.forEach(function(e){H.unsubscribe(e)}),ne=[]),X(),j(),this.clearRulers()},this.update=function(e){void 0!==e&&"boolean"==typeof e&&(Boolean(A)&&!ie&&A.setVisibility(!e),N&&N.setVisibleFlag(!e))},this.updateRobotPos=function(e,t){if(A){var i=!1;I.getVisibleSpace()||(i=!0),te.update(i);var n=le();if(t?A.setPosition({robotMatrix:n,translationRulerOrigin:se(n)}):A.setPosition({robotMatrix:n}),t){var a=E._getCenter();oe.origin=a.clone(),oe.initOrigin=a.clone(),oe.baseOrigin=a.clone(),oe.origin3D=ee}}e&&te.clearRulers()},this.updateOnTranslationBegin=function(e){if(J=e.intersection.position,this.clearAngularRuler(),Y||de(),!Q){Q=new _;var t={position:new n.Vector3(0,0,0),touchMode:!1},i=new P({name:"fixedSizeNode3D",ratio:7}),a=new y(t);a.name="arrowTranslationNode",a.mat.color=new n.Color("#1B6E9C"),a.mat.opacity=1,a.setNoZ(!0),i.addChild(a),I&&Q&&(Q.addChild(i),I.addNode(Q),I.render())}Q&&(Q.setMatrix(le().setPosition(J.clone())),Q.setVisibilityInTree(!1),Q.setVisibility(I.getVisibleSpace()),Q.setPickable(C.PICKTHROUGH));var o=(new n.Vector3).copy(e.manipulator.axis).negate(),r=E._getCenter().clone(),l=(new n.Vector3).copy(o).multiplyScalar((new n.Vector3).copy(oe.baseOrigin).sub(r).dot(o));oe.initOrigin=(new n.Vector3).copy(r).add(l);var c=(new n.Vector3).copy(oe.initOrigin);oe.origin3D&&(c=new n.Line3(oe.initOrigin,(new n.Vector3).copy(oe.initOrigin).add(o)).closestPointToPoint(oe.origin3D,!1));oe.origin=c;var u=(new n.Vector3).copy(oe.origin).sub(r).dot(o);if(oe.direction=o,oe.value=c.distanceTo(r)*(u>0?-1:1),oe.initValue=oe.value,Y){var d=o.clone().negate().normalize().multiplyScalar(oe.value);Y.origin=J.clone().add(d),Y.origin3DPos=oe.origin3D,K=oe.value,Y.initOrigin=oe.initOrigin,Y.setValue(oe.value),Y.direction=oe.direction,Y.initValue=oe.initValue,Y.displayOrigin=Boolean(oe.origin3D),Y.unit=s.getCurrentUnit("length").unit,Y.display(),Y.beginManipulation()}this.updateRobotPos(),A&&!ie&&A.setVisibility(!0)},this.snapTranslationCallback=function(e){var t=e.translationVector;if(Y){var i=Y.getSnappedTranslationVector(e);0===i.returnCode&&(t=i.snappedTranslationVector)}return t},this.snapRotationCallback=function(e){var t={value:180*e.angle/Math.PI,axis:e.axis};if(re&&re.direction&&re.direction.dot(e.axis)<0&&(t.value=360-t.value),H){var i=H.getSnappedRotationValue(e);0===i.returnCode&&(t={value:i.snappedRotationAngle,axis:i.axis})}return t},this.updateOnTranslation=function(e){if(Y){var t=oe.value;oe.value=oe.initValue+e.translationVector.length()*(oe.direction.dot(e.translationVector)>0?1:-1),Y.setValue(oe.value);var i=le();if(t&&t>oe.value){var a=new n.Vector3,o=new n.Vector3,r=new n.Vector3;i.extractBasis(a,o,r),r.negate(),i.makeBasis(a,o,r)}var l=(new n.Vector3).copy(e.manipulator.axis).normalize().multiplyScalar(K-oe.value),s=J.clone().add(l);Q.setMatrix(i.setPosition(s.clone()))}else!Y&&e.intersection&&e.manipulator&&this.updateOnTranslationBegin({intersection:e.intersection,manipulator:e.manipulator});this.updateRobotPos()},this.updateOnTranslationEnd=function(){A&&!ie&&A.setVisibility(!0),Q&&Q.setVisibility(!I.getVisibleSpace()),Y&&(Y.endManipulation(),Y.display()),Q&&(I.removeNode(Q),Q.removeChildren(),Q.remove(),Q=void 0),J=void 0},this.updateOnRotationBegin=function(e,t){this.clearLinearRuler(),H||pe(),ue(e,t),this.updateRobotPos(),A&&!ie&&A.setVisibility(!0),H&&(H.display(),H.beginManipulation())},this.updateOnRotation=function(e,t){H||this.updateOnRotationBegin({axis:e.axis},t),function(e){if(H&&e){var t=(new n.Vector3).copy(e.axis),a=H.direction.dot(t),o=i.isLessThan(a,0)?2*Math.PI-e.angle:e.angle;H.setValue(H.initValue+180*o/Math.PI),H.refresh()}}(e),this.updateRobotPos(!1,!0)},this.updateOnRotationEnd=function(){A&&!ie&&A.setVisibility(!0),H&&(H.display(),H.endManipulation())},this.clearRulers=function(){this.clearLinearRuler(),this.clearAngularRuler()},this.clearLinearRuler=function(){Y&&Y.clear()},this.clearAngularRuler=function(){H&&H.clear()},this}})}),define("DS/DMUPlaySection/DMUSectionTranslationSliderSpinner",["UWA/Core","UWA/Class","DS/Controls/Slider","DS/Controls/SpinBox","DS/Controls/Toggle","DS/Controls/ButtonGroup","DS/Controls/LineEditor","DS/WebappsUtils/WebappsUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","i18n!DS/DMUPlaySection/assets/nls/DMUPlaySection","css!DS/DMUPlaySection/DMUPlaySection.css"],function(e,t,i,n,a,o,r,l,s,c,u){"use strict";return t.extend({init:function(t){var d=t||{};this._parent(d);var p=this,g=0;if(d.frameWindow&&!(isNaN(d.initValue)||isNaN(d.initMinValue)||isNaN(d.initMaxValue)||isNaN(d.initManipRange))){var v,f;(d.initValue<d.initMinValue||d.initValue>d.initMaxValue)&&(d.initValue=.5*(d.initMinValue+d.initMaxValue)),d.initStepValue=void 0!==d.initStepValue&&d.initStepValue>0?parseFloat(d.initStepValue):g/10;var m="length",S=s.getCurrentUnit("Length").unit;if("number"==typeof d.initManipRange){var h,M,b,y,w,P,C,_=(g=s.convert(d.initManipRange,m,"mm",S))/100,V=g/10,D={},x=void 0!==d.initViewName&&null!==d.initViewName?d.initViewName:"ExploreView",A="ExploreView"===x,N=!0;p.bPerformRefreshOrCreate=!0;var R=new e.Element("div",{class:"DMUSectionTranslationSliderSpinnerContainer",styles:{opacity:0}}).inject(d.frameWindow.getUIFrame());d.hasCompareObject&&R.setStyles({top:"70px"});var O=1;"number"==typeof d.initStepValue&&(O=G(s.convert(d.initStepValue,m,"mm",S),g));var E=l.getWebappsBaseUrl()+"DMUBaseCommands/assets/icons/32/";if(new e.createElement("img",{class:"WebSectionImg",src:E+"I_WebSection.png",styles:{left:"0px"}}).inject(R),b=e.createElement("div",{class:"TranslationSliderContainer",styles:{display:!0===A?"":"none"}}).inject(R),(h=new i({minValue:s.convert(d.initMinValue,m,"mm",S),maxValue:s.convert(d.initMaxValue,m,"mm",S),stepValue:O,value:s.convert(d.initValue,m,"mm",S)}).inject(b)).getTextFromValue=function(){return s.convertValueToString(s.convert(this.value,m,s.getCurrentUnit("Length").unit,"m"),"length")},h.addEventListener("beginEdit",function(){p.bPerformRefreshOrCreate=!1,d.iOwner&&d.iOwner.beginManipulation&&d.iOwner.beginManipulation(),p.bPerformRefreshOrCreate=!0}),h.addEventListener("change",function(){p.bPerformRefreshOrCreate=!1,d.onChangeSliderCB&&d.onChangeSliderCB(h.value),d.iOwner&&d.iOwner.doManipulation&&d.iOwner.doManipulation(),p.bPerformRefreshOrCreate=!0}),h.addEventListener("endEdit",function(){p.bPerformRefreshOrCreate=!1,d.iOwner&&d.iOwner.endManipulation&&d.iOwner.endManipulation(),p.bPerformRefreshOrCreate=!0}),"3dPlay"!==d.runningApp){(w=new e.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-menu-dot",title:u.viewMenu,value:!1}).inject(R)).addClassName("ViewMenuIcon"),w.addEventListener("click",function(){void 0!==w&&(!0===w.value?F(!1):F(!0))});var T=localStorage.getItem("CATWebUXPreferences_Units");T&&T.length&&(T=JSON.parse(T));var I=s.Types.Length;y=e.createElement("div",{class:"TranslationSpinnerContainer",styles:{display:!1===A?"":"none"}}).inject(R),(M=new n({minValue:s.convert(d.initMinValue,m,"mm",S),maxValue:s.convert(d.initMaxValue,m,"mm",S),stepValue:O,value:s.convert(d.initValue,m,"mm",S),units:s.getCurrentUnit("Length").unit,decimals:T&&T.Length?T.Length.decimalPlaceRW:I.defaultDecimalPlaceRW}).inject(y)).elements.container.addClassName("TranslationSpinner"),M.addEventListener("beginEdit",function(){p.bPerformRefreshOrCreate=!1,d.iOwner&&d.iOwner.beginManipulation&&d.iOwner.beginManipulation(),p.bPerformRefreshOrCreate=!0}),M.addEventListener("change",function(){p.bPerformRefreshOrCreate=!1,d.onChangeSpinnerCB&&d.onChangeSpinnerCB(M.value),d.iOwner&&d.iOwner.doManipulation&&d.iOwner.doManipulation(),p.bPerformRefreshOrCreate=!0}),M.addEventListener("endEdit",function(){p.bPerformRefreshOrCreate=!1,d.iOwner&&d.iOwner.endManipulation&&d.iOwner.endManipulation(),p.bPerformRefreshOrCreate=!0}),P=e.createElement("div",{class:"ViewMenuContainer",styles:{display:"none"}}).inject(R);var U=new o({type:"radio"});U.elements.container.addClassName("RadioButtonGroup");var B=new a({type:"radio",label:u.exploreView,checkFlag:A,value:0}),L=new a({type:"radio",label:u.detailedView,checkFlag:!A,value:1});B.elements.container.addClassName("ViewRadioBtn"),L.elements.container.addClassName("ViewRadioBtn"),U.addChild(B),U.addChild(L),U.inject(P),B.addEventListener("buttonclick",z),L.addEventListener("buttonclick",W);var k=e.createElement("div",{class:"ValueIncrementorContainer"}).inject(P);new e.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-arrow-combo-vertical"}).inject(k),new e.createElement("label",{class:"IncrementLabel",text:u.lblIncrement}).inject(k),(C=new r({placeholder:u.lblOnlyNum+" "+s.getCurrentUnit("Length").unit,value:s.convertValueToString(s.convert(O,m,s.getCurrentUnit("Length").unit,"m"),"length",{readWrite:!0}),sizeInCharNumber:10,selectAllOnFocus:!0}).inject(k)).elements.container.addClassName("IncrementEditor"),C.addEventListener("change",function(){!function(e){if(e=parseFloat(e),!isNaN(e)&&g>0&&e>0){var t=G(e,g);void 0!==M&&void 0!==M.stepValue&&(M.stepValue=parseFloat(t)),void 0!==h&&void 0!==h.stepValue&&(h.stepValue=parseFloat(t)),void 0!==C&&void 0!==C.value&&(C.value=s.convertValueToString(s.convert(t,m,s.getCurrentUnit("Length").unit,"m"),"length",{readWrite:!0})),localStorage.setItem("IncrementValue",s.convert(t,m,s.getCurrentUnit("Length").unit,"mm"))}}(C.value)})}D.onFreeZoneResize||(d.frameWindow.getImmersiveFrame().addEventListener("freeZoneResize",X),D.onFreeZoneResize=1),setTimeout(function(){R&&(X(),R.setStyles({opacity:1}))},50),this.setActiveView=function(e){"ExploreView"===e?z():"DetailedView"===e&&W()},this.getActiveView=function(){return x},this.setValue=function(e,t){isNaN(e)||(e=s.convert(e,m,"mm",S),"Slider"===t&&h?(h._properties&&h._properties.value&&(h._properties.value.value=e),h._updateCursor&&h._updateCursor()):"Spinner"===t&&M&&(M.value=e))},this.getValue=function(e){return"Slider"===e&&h?h.value:"Spinner"===e&&M?M.value:void 0},this.setRangeValues=function(e,t,i){isNaN(e)||isNaN(t)||(e=s.convert(e,m,"mm",S),t=s.convert(t,m,"mm",S),"Slider"===i&&h?(h.minValue=e,h.maxValue=t):"Spinner"===i&&M&&(M.minValue=e,M.maxValue=t))},this.getRangeValues=function(e){return"Slider"===e&&h?{minValue:h.minValue,maxValue:h.maxValue}:"Spinner"===e&&M?{minValue:M.minValue,maxValue:M.maxValue}:void 0},this.setStepValue=function(e){isNaN(e)||C&&(C.value=G(s.convert(e,m,"mm",S),g))},this.getStepValue=function(){if(C)return C.value},this.getSpinnerUnit=function(){if(M)return M.units},this.getSpinnerDecimalValue=function(){if(M)return M.decimals},this.getVisibleFlag=function(e){return"Slider"===e&&b?"none"!==b.getStyle("display"):"Spinner"===e&&y?"none"!==y.getStyle("display"):N},this.setVisibleFlag=function(e){N=e,R.setStyle("display",N?"":"none")},this.update=function(e){if(null!=e){var t="Slider";if("DetailedView"===x&&(t="Spinner"),void 0!==e.minValue&&void 0!==e.maxValue&&p.setRangeValues(e.minValue,e.maxValue,t),void 0!==e.stepValue&&e.stepValue>0){var i=parseFloat(e.stepValue);p.setStepValue(i)}void 0!==e.value&&p.setValue(e.value,t)}},this.subscribeToUnitChangeEvt=function(e){null!=e&&(v||(v=c.givePreferenceManager({context:d.frameWindow}))&&e.event&&e.cb&&(f=v.subscribe(e.event,e.cb)))},this.unsubscribeToUnitChangeEvt=function(){v&&(f=v.unsubscribe(f)),v=f=null},this.clean=function(){t.frameWindow&&R&&R.parentNode===t.frameWindow.getUIFrame()&&t.frameWindow.getUIFrame().removeChild(R),D.onFreeZoneResize&&d.frameWindow&&d.frameWindow.getImmersiveFrame().removeEventListener("freeZoneResize",X),R=null,D={},t.iOwner&&t.iOwner._movegauge&&(t.iOwner._movegauge=null),p.unsubscribeToUnitChangeEvt()}}}function F(e){void 0!==w&&void 0!==P&&(!0===e?(w.value=!0,w.addClassName("ViewMenuIconOnClick"),P.setStyle("display","")):(w.value=!1,w.removeClassName("ViewMenuIconOnClick"),P.setStyle("display","none")))}function z(){void 0!==b&&b.setStyle("display",""),void 0!==y&&y.setStyle("display","none"),localStorage.setItem("strActiveView","ExploreView"),x="ExploreView",t.iOwner&&t.iOwner.refreshSlider&&t.iOwner.refreshSlider()}function W(){void 0!==b&&b.setStyle("display","none"),void 0!==y&&y.setStyle("display",""),localStorage.setItem("strActiveView","DetailedView"),x="DetailedView",t.iOwner&&t.iOwner.refreshSlider&&t.iOwner.refreshSlider()}function G(e,t){var i=1;if(e=parseFloat(e),t>0&&e>0){i=e;for(var n=-2,a=!1,o=!1,r=_=t/100,l=V=t/10;!a||!o;){var s=Math.pow(10,n);s>_&&!a&&(r=Math.pow(10,n-1))<=_&&(_=r,a=!0),s>V&&!o&&(l=Math.pow(10,n-1))<=V&&(V=l,o=!0),n++}(e>V||e<_)&&(i=V)}return i}function X(){if(R){var e=d.frameWindow.getImmersiveFrame().getFreeZone().getSize();if(e.width){var t=0,i=d.frameWindow.getImmersiveFrame().getDockingElement(WUXDockAreaEnum.LeftDockArea),n=i.getContainedWindows();if(n&&(1===n.length&&n[0].isAWindowGroup()&&n[0].getEmbeddedWindows().length||1===n.length&&!n[0].isAWindowGroup())){for(var a=n[0].getEmbeddedWindows?n[0].getEmbeddedWindows():n,o=!1,r=0;r<a.length;r++)a[r].visibleFlag&&(o=!0);if(o&&!i.collapseDockingZoneFlag){var l=i._collapserSize;t=i.dockingZoneSize+l}}else i.interactiveDockAreaVisibleFlag&&(t=i.dockingZoneSize);let s=125;d.hasCompareObject&&(s=137.5),t+=e.width/2-s,R.setStyles({left:t+"px"})}}}}})}),define("DS/DMUPlaySection/DMUToolsSection",["DS/DMUMeasurable/DMUMathsVector3D","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMeasurable/DMUToolsMaths","DS/WebPolyPlanarSectionOper/WebPolyPlanarSectionOper"],function(e,t,i,n,a){"use strict";var o={computeSectionCurvesUsingPolyPlanarOperator:function(e,t,i){var n=new a(e);return n?n.Run(t,i):{}},computeSectionPlaneReferencial:function(a,o){var r=new t.Vector3((o.max.x+o.min.x)/2,(o.max.y+o.min.y)/2,(o.max.z+o.min.z)/2),l=i.getViewpointInfo(a.currentViewpoint),s=e.dot(l.sight.toArray(),[1,0,0]),c=e.dot(l.sight.toArray(),[0,1,0]),u=e.dot(l.sight.toArray(),[0,0,1]),d=Math.abs(s),p=Math.abs(c),g=Math.abs(u),v=new t.Matrix4;return n.isLessOrEqual(d,p)||n.isLessOrEqual(d,g)?n.isLessOrEqual(p,g)?n.isLessThan(u,0)&&v.rotateY(Math.PI):n.isLessThan(c,0)?v.rotateX(Math.PI/2):v.rotateX(-Math.PI/2):n.isLessOrEqual(s,0)?v.rotateY(-Math.PI/2):v.rotateY(Math.PI/2),v.setPosition(r),v},checkLineIntersection:function(e,t){var i=e[0][0],n=e[0][1],a=e[1][0],o=e[1][1],r=t[0][0],l=t[0][1],s=t[1][0],c=t[1][1],u={x:null,y:null,bIsOnLine1:!1,bIsOnLine2:!1},d=(c-l)*(a-i)-(s-r)*(o-n);if(0===d)return u;var p=n-l,g=i-r,v=(a-i)*p-(o-n)*g;return p=((s-r)*p-(c-l)*g)/d,g=v/d,u.x=i+p*(a-i),u.y=n+p*(o-n),p>0&&p<1&&(u.bIsOnLine1=!0),g>0&&g<1&&(u.bIsOnLine2=!0),u},trimPolylines:function(e,i){var n,a=[];i&&(n=[[[i.min.x,i.min.y],[i.max.x,i.min.y]],[[i.max.x,i.min.y],[i.max.x,i.max.y]],[[i.max.x,i.max.y],[i.min.x,i.max.y]],[[i.min.x,i.max.y],[i.min.x,i.min.y]]]);var r,l,s,c,u=!1,d=0,p=0,g=0;for(d=0;d<e.length;d++){l=e[d]._Vertices.length,u=!1;var v=[];for(p=0;p<l;p++)if(s=new t.Vector2(e[d]._Vertices[p][0],e[d]._Vertices[p][1]),!i||i&&i.containsPoint(s))v.push([e[d]._Vertices[p][0],e[d]._Vertices[p][1],e[d]._Vertices[p][2]]),u=!0;else{r=p,u&&(r=--p,u=!1);var f=!1;if(r<l-1)for(g=0;g<n.length;g++)(c=o.checkLineIntersection(n[g],[[e[d]._Vertices[r][0],e[d]._Vertices[r][1]],[e[d]._Vertices[r+1][0],e[d]._Vertices[r+1][1]]])).bIsOnLine1&&c.bIsOnLine2&&(v.push([c.x,c.y,e[d]._Vertices[r][2]]),f=!0);!f&&v.length>0&&(a.push(v),v=[])}v.length>0&&a.push(v)}return a}};return o}),define("DS/DMUPlaySection/DMUSectionPosPreVisuNode3D",["DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUToolsAvatars","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUToolsMaterial","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Visualization/SceneGraphFactory"],function(e,t,i,n,a,o,r,l,s){"use strict";return n.extend({init:function(c){this._parent();var u,d,p=c;function g(e,t){t.setPickParent(!0),t.setVisibilityInTree(!1),e.addChild(t)}function v(e,t,n){var a=function(e,t){var n=(new i.Projector).projectVector(t.clone(),e.viewpoints[0].getCamera()),a=Math.round((0-n.y)*(e.canvas.offsetHeight/2)+e.canvas.offsetHeight/2),o=Math.round(n.x*(e.canvas.offsetWidth/2)+e.canvas.offsetWidth/2);return{top:a,left:o,bottom:e.canvas.offsetHeight-a,right:e.canvas.offsetWidth-o,inWindow:a>0&&a<e.canvas.offsetHeight&&o>0&&o<e.canvas.offsetWidth}}(e,t),r=function(e,t,n){var a=new i.Vector3((t-window.pageXOffset)/e.canvas.offsetWidth*2-1,-(n-window.pageYOffset)/e.canvas.offsetHeight*2+1,.5),o=(new i.Projector).pickingRay(a,e.currentViewpoint.camera);return{position:o.ray.origin,direction:o.ray.direction}}(e,a.left+n,a.top);return o.computePointLineDistance(t.toArray(),r.position.toArray(),r.direction.toArray()).distance}var f={};f.preSolidLine=r.retrieveMaterialFromGAS({color:new i.Color(16753920),lineWidth:window.devicePixelRatio,pattern:a.LinePatternEnum.SOLID}),f.dotDashedLineBlack=r.retrieveMaterialFromGAS({color:new i.Color(0),lineWidth:window.devicePixelRatio+1,pattern:a.LinePatternEnum.DOTDASHED}),f.crossPointPreHighlight=r.retrieveMaterialFromGAS({symbol:1,size:10,color:new i.Color(65535)}),f.preFaceMaterial=r.retrieveMaterialFromGAS({color:new i.Color(16753920),opacity:1}),f.preFaceMaterial.force=!0,f.preSolidLine.force=!0,f.preFaceMaterial.line=f.preSolidLine,this.getAxisNode=function(i){var n,a,o,r=i.getType()===e.GeometryType.CIRCLE,l=r?{beginPoint:i.getCenter().clone(),endPoint:i.getCenter().clone()}:i.getPoints();n=i.getAxis().clone();var s=r?60:30,c=v(p,l.beginPoint,s);return n.normalize().multiplyScalar(c),a=l.beginPoint.clone().sub(n),o=l.endPoint.clone().add(n),t.createLineNode(a,o,f.dotDashedLineBlack)},this.getPointNode=function(e){if(e)return f.crossPointPreHighlight.force=!0,s.createPointsNode({positions:e.clone().toArray(),material:f.crossPointPreHighlight})};var m=new n;g(this,m),this.buildPreVisuNode=function(e){if(e&&e.data&&e.data.point&&e.data.normal){m.removeChildren();var i=e.data.point,n=e.data.normal,a=p.currentViewpoint,o=v(p,i,40);u=t.createRectangleNode(o,o,i,n,f.preFaceMaterial,!1),d||(d=t.createArrowNormalNode(a)),d&&d.setMatrix(l.getMatFromNormWithPos(n,i)),g(m,u),g(m,d),e.data.measurable&&e.data.toShowAxisVisu()&&g(m,this.getAxisNode(e.data.measurable,!0))}},this.remove=function(){m&&(m.removeChildren(),m.remove(),m=void 0),u&&(u.removeChildren(),u.remove(),u=void 0),d&&(d.removeChildren(),d.remove(),d=void 0)}}})}),define("DS/DMUPlaySection/DMUSectionNode3D",["DS/DMUBaseUI/DMUNode3D","DS/DMUBaseExperience/EXPUtils","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUMeasurable/DMUManipulablePlane","DS/DMUBaseExperience/DMUContextManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/DMUPlaySection/DMUSectionRobotWithRuler","DS/DMUBaseCommands/EXPToolsWUX","DS/Visualization/ClippingContext","DS/CATRelatedData3DGrid/CATRelatedData3DGridView","DS/PADUtils/PADSettingsMgt","i18n!DS/DMUPlaySection/assets/nls/DMUPlaySection"],function(e,t,i,n,a,o,r,l,s,c,u,d,p){"use strict";return e.extend({init:function(e){this._parent({frmWindow:e._frmWindow,getType:e.getType});var g,v,f,m,S,h,M,b,y,w,P,C,_,V,D,x,A=this,N=t.isEnvActivated("nosectionruler",!0),R=!1,O=!1,E=!1,T=new o.Plane,I=new o.Plane,U=new o.Plane,B=new o.Plane,L=new o.Plane,k=new o.Plane,F=new o.Plane,z=[],W=[],G=[],X=!1,j=t.isEnvActivated("psection",!0),Y=new o.Box3,H=1;this.typeCBDMU="Section";var J=function(e){if(e&&(e.setFrustumCulled&&e.setFrustumCulled(!1),e.children))for(var t=0;t<e.children.length;t++)J(e.children[t])},Z=function(){var e=!1;return d&&d.getSetting("enopad3dviewer_lightNodeModel")&&(e=!0),e};function q(t){var i=e.getAttribute("fXDirSize");"Right"!==t&&"Left"!==t||(i=e.getAttribute("fSliceOffset"));var n=e.getAttribute("fYDirSize");return"Top"!==t&&"Bottom"!==t||(n=e.getAttribute("fSliceOffset")),{referential:e._getPlanReferential(t),uSize:i,vSize:n,uStep:e.getAttribute("fXDirGridStep"),vStep:e.getAttribute("fYDirGridStep")}}function Q(t){t&&(t.uSize&&e.setAttribute("fXDirSize",t.uSize),t.vSize&&e.setAttribute("fYDirSize",t.vSize),t.uStep&&e.setAttribute("fXDirGridStep",t.uStep),t.vStep&&e.setAttribute("fYDirGridStep",t.vStep),t.referential&&(e.setAttribute("mPlaneReferential",t.referential),e.modifyPlaneReferential(t.referential)))}function K(){var t=n.State.STANDARD;return e.isInEdition()&&(t=n.State.INEDITION),t}function $(){return e.isSectionDisplayed()}function ee(){var t={mode:n.DisplayMode.PLANE,fillColor:e.getAttribute("cFillStyleColor"),opacity:e.getAttribute("fOpacity")};return"Grid"===e.getAttribute("sDisplayPlaneMode")&&(t.mode=n.DisplayMode.GRID),t}function te(i){var a=!0;if(!i||i.type!==n.ManipulationType.TRANSLATION&&i.type!==n.ManipulationType.ROTATION&&i.type!==n.ManipulationType.RESIZE&&i.type!==n.ManipulationType.CENTER)return a;switch(i.action){case n.ManipulationAction.ENABLE:void 0===x&&(x=e.isReadOnly()||!e.isEditable()||function(){var i=t.allowManipulation({object:"Section",viewer:e._viewer});if("boolean"==typeof i)return!i;var n=t.checkIfCommandIsRunning(e._viewer);if(n){var a=t.getCurrentCommand(e._viewer);"SelectiveSectionContextCmdHdr"===a&&(s.addInCSO(e,!1),n=!1),e&&"3dPlay"===e._typeApps&&"myDefaultCmd"===a&&(n=!1)}return n}()),a=!x;break;case n.ManipulationAction.BEGIN:x||(i.type===n.ManipulationType.CENTER&&(A.enableClipping(!1),e._viewer.setSectionCapping(!1)),e.beginManipulation());break;case n.ManipulationAction.DO:x||e.doManipulation();break;case n.ManipulationAction.END:x||(i.type===n.ManipulationType.CENTER&&(A.enableClipping(!0),e._viewer.setSectionCapping(!0)),e.endManipulation(i.evt)),x=void 0;break;case n.ManipulationAction.LONG_HOLD:x||e.onLongHold()}return a}function ie(t){var i=!e.isReadOnly()&&e.isEditable(),a=e.getAttribute("sPlaneBoxMode");return"SliceMode"!==a&&"BoxMode"!==a||(i=!1),new n({viewer:e._viewer,frameWindow:e._frmWindow,bTranslationManipulator:i,bRotationManipulator:i,bResizeManipulator:i,bCenterManipulator:i,sType:t,RulerClass:N?void 0:l,getState:K,getShowState:$,getGeometry:q,setGeometry:Q,getDisplayInformation:ee,getManipulationInformation:te,appType:e._typeApps,context:e._context})}function ne(t){var i=e.getAttribute("sPlaneBoxMode");"Grid"!==e.getAttribute("sDisplayPlaneMode")&&("Back"!==t||"SliceMode"!==i&&"BoxMode"!==i||S||((S=ie(t)).setName(p.sectionplane),(f=new r).setVisibilityInTree(!1),A.addChild(f),f.addChild(S)),"BoxMode"===i&&("Top"===t?P||((P=ie(t)).setName(p.sectionplane),(h=new r).setVisibilityInTree(!1),A.addChild(h),h.addChild(P)):"Bottom"===t?C||((C=ie(t)).setName(p.sectionplane),(M=new r).setVisibilityInTree(!1),A.addChild(M),M.addChild(C)):"Right"===t?_||((_=ie(t)).setName(p.sectionplane),(b=new r).setVisibilityInTree(!1),A.addChild(b),b.addChild(_)):"Left"===t&&(V||((V=ie(t)).setName(p.sectionplane),(y=new r).setVisibilityInTree(!1),A.addChild(y),y.addChild(V)))))}function ae(){var t=e.getAttribute("fXDirSize"),i=e.getAttribute("fYDirSize"),n=0,r=e.getAttribute("sPlaneBoxMode");"SliceMode"!==r&&"BoxMode"!==r||(n=e.getAttribute("fSliceOffset"));var l=e.getAttribute("fXDirGridStep"),s=e.getAttribute("fYDirGridStep");l||(l=t/10),s||(s=i/10);var c=e.getAttribute("iGridAbsoluteMode");w=new u({window:e._frmWindow,viewer:e._viewer,context:a.getContextViewer({viewer:e._viewer}),nbMaxLabel:300,stepRequiredX:l,stepRequiredY:s,stepRequiredZ:0===n?0:l,gridMatrix:(new o.Matrix4).copy(e._getPlanReferential()),freeZoneDim:e._viewer.canvas.getBoundingClientRect(),id:"Section",owner:v,isEditable:!1,isLabelManipulable:!1,isAbsoluteMode:1===c})}function oe(){v||((v=new r).setVisibilityInTree(!1),A.addChild(v),"Grid"!==e.getAttribute("sDisplayPlaneMode")?((m=new ie).setName(p.sectionplane),v.addChild(m),ne("Back"),ne("Top"),ne("Bottom"),ne("Right"),ne("Left")):ae(),A.addChild(e.getSectionCurveNode()))}function re(t){if(!t){var n=e._viewer.currentViewpoint.position.distanceTo(e._viewer.currentViewpoint.target);t=7*e.getAttribute("fXDirSize")/n}for(var a=i.getRootReferences(e._viewer),r=new o.HatchingMeshMaterial({stripesDirection:new o.Vector2(1,1),spaceWidth:5,stripesWidth:t,autoStripesColor:!0}),l=0;l<a.length;l++)a[l].setSectionCappingMaterial(r),X=!0;for(var s=i.getSceneRoot(e._viewer).children,c=s.length,u=0;u<c;u++)s[u].toBeSectionned&&(s[u].setSectionCappingMaterial(r),X=!0)}function le(){if(X){for(var t=i.getRootReferences(e._viewer),n=0;n<t.length;n++)t[n].removeSectionCappingMaterial(T),X=!1;for(var a=i.getSceneRoot(e._viewer).children,o=a.length,r=0;r<o;r++)a[r].toBeSectionned&&(a[r].removeSectionCappingMaterial(T),X=!1)}}function se(){var t=e.isSectionDisplayed();if(e._bIsInShowSpace||(t=!t),A.setVisibility(t),(O||"NoPlane"===e.getAttribute("sDisplayPlaneMode"))&&t&&(t=!t),m)if(m.setVisibility(t),m.setVisibilityFree(O),e.isReadOnly()&&m._robotWihtRuler)m._robotWihtRuler.update(Boolean(e._bIsInShowSpace));else if(m._robotWihtRuler){var i;!1===(e._bIsInShowSpace?t:!t)?(i=!t,m._robotWihtRuler.update(i)):(i=!e.isInEdition()&&m.getsectionEditCmdRunningStatus&&!m.getsectionEditCmdRunningStatus(),e._bIsInShowSpace||(i=!i)),m._robotWihtRuler.update(i)}S&&(S.setVisibility(t),S.setVisibilityFree(O)),P&&(P.setVisibility(t),P.setVisibilityFree(O)),C&&(C.setVisibility(t),C.setVisibilityFree(O)),_&&(_.setVisibility(t),_.setVisibilityFree(O)),V&&(V.setVisibility(t),V.setVisibilityFree(O)),function(){var t=e.getAttribute("sPlaneBoxMode"),i=(new o.Matrix4).translate(new o.Vector3(0,0,.1));m&&m.setMatrix(i),S&&S.setMatrix(i),P&&P.setMatrix(i),C&&C.setMatrix(i),_&&_.setMatrix(i),V&&V.setMatrix(i),v.setMatrix(e._getPlanReferential()),"SliceMode"!==t&&"BoxMode"!==t||!f||f.setMatrix(e._getPlanReferential("Back")),"BoxMode"===t&&(h&&h.setMatrix(e._getPlanReferential("Top")),M&&M.setMatrix(e._getPlanReferential("Bottom")),b&&b.setMatrix(e._getPlanReferential("Right")),y&&y.setMatrix(e._getPlanReferential("Left")));var n=e.getAttribute("sSectionRender"),a=e.isSectionDisplayed();if(R&&a&&g&&n!==g&&"NoCut"!==g&&(e._viewer.removeClippingPlane(T),I&&e._viewer.removeClippingPlane(I),A.enableClipping(!1),e._viewer.setSectionCapping(!1),R=!1),g=n,"CutOneSide"===n&&(!R&&a&&(R=!0,e._viewer.addClippingPlane(T),"SliceMode"===t?e._viewer.addClippingPlane(U):"BoxMode"===t&&(e._viewer.addClippingPlane(B),e._viewer.addClippingPlane(L),e._viewer.addClippingPlane(F),e._viewer.addClippingPlane(k)),A.enableClipping(!0),e._viewer.setSectionCapping(!0)),R&&!a&&(R=!1,e._viewer.removeClippingPlane(T),"SliceMode"===t?e._viewer.removeClippingPlane(U):"BoxMode"===t&&(e._viewer.removeClippingPlane(B),e._viewer.removeClippingPlane(L),e._viewer.removeClippingPlane(F),e._viewer.removeClippingPlane(k)),A.enableClipping(!1),e._viewer.setSectionCapping(!1)),R&&a&&!e._viewer.getSectionCapping()&&e._viewer.setSectionCapping(R)),"OnlyContour"===n){if(!R&&a){R=!0;var r=(new o.Matrix4).copy(e._getPlanReferential());I.setFromNormalAndCoplanarPoint(new o.Vector3(0,0,1),new o.Vector3(0,0,0)),I.applyMatrix4(r.rotateX(Math.PI)),e._viewer.addClippingPlane(T),e._viewer.addClippingPlane(I),A.enableClipping(!0),e._viewer.setSectionCapping(!1)}R&&!a&&(R=!1,e._viewer.removeClippingPlane(T),e._viewer.removeClippingPlane(I),A.enableClipping(!1),e._viewer.setSectionCapping(!1))}}(),T.setFromNormalAndCoplanarPoint(new o.Vector3(0,0,1),new o.Vector3(0,0,0)),T.applyMatrix4(e._getPlanReferential()),"SliceMode"!==e.getAttribute("sPlaneBoxMode")&&"BoxMode"!==e.getAttribute("sPlaneBoxMode")||(U.setFromNormalAndCoplanarPoint(new o.Vector3(0,0,1),new o.Vector3(0,0,0)),U.applyMatrix4(e._getPlanReferential("Back"))),"BoxMode"===e.getAttribute("sPlaneBoxMode")&&(B&&(B.setFromNormalAndCoplanarPoint(new o.Vector3(0,0,1),new o.Vector3(0,0,0)),B.applyMatrix4(e._getPlanReferential("Top"))),L&&(L.setFromNormalAndCoplanarPoint(new o.Vector3(0,0,1),new o.Vector3(0,0,0)),L.applyMatrix4(e._getPlanReferential("Bottom"))),k&&(k.setFromNormalAndCoplanarPoint(new o.Vector3(0,0,1),new o.Vector3(0,0,0)),k.applyMatrix4(e._getPlanReferential("Right"))),F&&(F.setFromNormalAndCoplanarPoint(new o.Vector3(0,0,1),new o.Vector3(0,0,0)),F.applyMatrix4(e._getPlanReferential("Left"))))}function ce(t,i){if(Array.isArray(t))for(var n=0;n<t.length;n++)ce(t[n],i);else if(t.enableClippingPlane(T,i),"OnlyContour"===e.getAttribute("sSectionRender"))t.enableClippingPlane(I,i);else{var a=e.getAttribute("sPlaneBoxMode");"SliceMode"!==a&&"BoxMode"!==a||t.enableClippingPlane(U,i),"BoxMode"===a&&(t.enableClippingPlane(B,i),t.enableClippingPlane(L,i),t.enableClippingPlane(k,i),t.enableClippingPlane(F,i))}}this.enableClipping=function(t){var n;if(A){W&&ce(W,!1),Z()&&D&&(i.removeSceneGraphOverrideSet(e._viewer,D),D=null),function(){var t,n,a,o;z=[],G=[];var r=e.collectCutObjects();t=r.CutObjects,n=r.CutObjectsOOC,E=r.bIsPartial,H=r.cutUncutMode;var l=0,s=0;if(E)if(Z())for(l=n.length,s=0;s<l;s++){var c=n[s];c&&G.push(c)}else for(l=t.length,s=0;s<l;s++)(a=t[s])&&(o=i.getLastInstance(a),z.push(o.getLastElement()));else{var u=e._viewer.getVisibleSpace();!1===e._bIsInShowSpace&&!1===u&&"Markup"!==e.getParent().getType()||(z=i.getRootReferences(e._viewer))}}(),W=z,ce(z,t),t?function(t){if(t&&t.length>0){D=i.createSceneGraphOverrideSet(e._viewer);var n=[];if(n.push(T),"OnlyContour"===e.getAttribute("sSectionRender"))n.push(I);else{var a=e.getAttribute("sPlaneBoxMode");"SliceMode"!==a&&"BoxMode"!==a||n.push(U),"BoxMode"===a&&(n.push(B),n.push(L),n.push(k),n.push(F))}if(H){var o=i.getOverrides(D,{idPaths:G});if(o&&o.length){var r=new c;r.setPlanes(n),o.forEach(function(e){e.setClippingContext(r)})}}else{var l=i.getRootReferences(e._viewer);for(let e=0;e<l.length;e++){let t=i.buildPathElement(l[e]);if(t){let e=[];e.push(t);let a=i.getOverrides(D,{pathElements:e});if(a&&a.length){let e=new c;e.setPlanes(n);for(let t=0;t<a.length;t++)a[t].setClippingContext(e)}}}var s=i.getOverrides(D,{idPaths:G});if(s&&s.length){var u=new c;u.setExcludeFromClippingPlanes(n),u.setEnableClippingProfile("off"),s.forEach(function(e){e.setClippingContext(u)})}}}}(G):Z()&&e.removeCurves();var a=i.getSceneRoot(e._viewer).children;for(n=0;n<a.length;n++)a[n].toBeSectionned&&a[n].enableClippingPlane(T,t)}},this.clean=function(){if(A){var t=i.getRootReferences(e._viewer);Z()&&e.removeCurves(),ce(t,!1),ce(W,!1),e._viewer.removeClippingPlane(T),T=new o.Plane,e._viewer.removeClippingPlane(I),I=new o.Plane,e._viewer.removeClippingPlane(U),U=new o.Plane,e._viewer.removeClippingPlane(B),B=new o.Plane,e._viewer.removeClippingPlane(L),L=new o.Plane,e._viewer.removeClippingPlane(F),F=new o.Plane,e._viewer.removeClippingPlane(k),k=new o.Plane,le(),m&&m.clean(),w&&v&&(w.deleteGrids({owner:v,fromStorage:!0}),w.setActiveState(!1)),A.removeChildren(),v=f=m=S=null,h=M=b=y=w=null,P=C=_=V=null,z.length=0,W.length=0,R=!1,O=!1,E=!1,x=!1,X=!1}},this.resetClippingFlag=function(){R=!1},this.update=function(t){if(A){if(t&&A.clean(),v||(oe(),J(A)),A.setName(e.getAttribute("sName")),m&&m.update(),w&&v&&(w.deleteGrids({owner:v,fromStorage:!0}),e.isSectionDisplayed()||w.setActiveState(!1)),"Grid"!==e.getAttribute("sDisplayPlaneMode")?("SliceMode"===e.getAttribute("sPlaneBoxMode")&&ne("Back"),"BoxMode"===e.getAttribute("sPlaneBoxMode")&&(A.clean(),oe(),J(A))):w&&v&&e.isSectionDisplayed()?function(){w.setActiveState(!0);var t=e.getAttribute("fXDirSize"),i=e.getAttribute("fYDirSize"),n=0,a=e.getAttribute("sPlaneBoxMode");"SliceMode"!==a&&"BoxMode"!==a||(n=e.getAttribute("fSliceOffset")),Y&&Y.set(new o.Vector3(-t/2,-i/2,0),new o.Vector3(t/2,i/2,n)),w.drawGrids({specifications:[{BBox:Y}]})}():e.isSectionDisplayed()&&ae(),e.getAttribute("bSectionCurvesVisible")&&e.isSectionCurveComputationNeeded()){e.computeCurves(function(){e.isSecondaryViewerShow()&&e.renderSecondaryViewer()})}se()}},this._getManpForRobot=function(){if(m)return m},this.updateRobotPos=function(e){m&&m.updateRobotPos(e)},this.manageLock=function(t){A&&t!==O&&e.isSectionDisplayed()?(O=t,A.update()):m&&m._updateManipulators()},this.isLocked=function(){return O},this.isSectionEnabled=function(){return R};var ue=!1;this.onViewerEventCB=function(t){if("true"===ue&&"@onViewpointChange"===t.eventType){var i=t.cameraEye.distanceTo(t.cameraTarget);re(7*e.getAttribute("fXDirSize")/i)}},j&&("true"===(ue=window.widget.getValue("Hatching"))?re():le()),e.isSectionDisplayed()&&this.update()}})}),define("DS/DMUPlaySection/DMUSection",["DS/DMUBaseReview/DMUOverloadableObject","DS/Visualization/Node3D","DS/DMUPlaySection/DMUToolsSection","DS/DMUPlaySection/DMUSectionTranslationSliderSpinner","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMeasurable/DMUMeshCreation","DS/DMUBaseExperience/EXPUtils","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUMeasurable/DMUToolsMaths","DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUSectionPosService","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/DMUBaseExperience/EXPControllerEvents","DS/DMUBaseUIControllers/DMUMarkupsController","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager","DS/DMUPlaySection/DMUSectionNode3D","DS/DMUPlaySection/DMUSectionImport","DS/ApplicationFrame/CommandsManager","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADAlert","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUBaseUIServices/DMUObjectsServices","i18n!DS/DMUPlaySection/assets/nls/DMUPlaySection"],function(e,t,i,n,a,o,r,l,s,c,u,d,p,g,v,f,m,S,h,M,b,y,w,P,C){"use strict";var _=[{name:"cFillStyleColor",type:"Color",JSONname:"PropertiesSection.GraphicProperties.FillStyle.color",defaultValue:new d.Color(3575492)},{name:"cLineStyleColor",type:"Color",JSONname:"PropertiesSection.GraphicProperties.LineStyle.color"},{name:"sLineStylePattern",type:"int",JSONname:"PropertiesSection.GraphicProperties.LineStyle.pattern"},{name:"fLineStyleThicknessIndex",type:"float",JSONname:"PropertiesSection.GraphicProperties.LineStyle.thicknessIndex"},{name:"bVisible",type:"bool",JSONname:"PropertiesSection.GraphicProperties.visible",defaultValue:!0},{name:"fOpacity",type:"float",JSONname:"PropertiesSection.GraphicProperties.FillStyle.opacity",defaultValue:.2},{name:"mPlaneReferential",type:"Matrix4",JSONname:"PropertiesSection.PlaneReferential",defaultValue:new d.Matrix4},{name:"fXDirSize",type:"float",JSONname:"PropertiesSection.XDirSize"},{name:"fYDirSize",type:"float",JSONname:"PropertiesSection.YDirSize"},{name:"sDisplayPlaneMode",type:"string",JSONname:"PropertiesSection.DisplayPlaneMode",defaultValue:"Plane"},{name:"sDisplayContourMode",type:"string",JSONname:"PropertiesSection.DisplayContourMode",defaultValue:"Contour"},{name:"sSectionRender",type:"string",JSONname:"PropertiesSection.SectionRender",defaultValue:"CutOneSide"},{name:"bPartialClippingMode",type:"bool",JSONname:"PropertiesSection.PartialClippingMode"},{name:"sUpdateAndFreezeMode",type:"string",JSONname:"PropertiesSection.UpdateAndFreezeMode",defaultValue:"Update"},{name:"fXDirGridStep",type:"float",JSONname:"PropertiesSection.XDirGridStep"},{name:"fYDirGridStep",type:"float",JSONname:"PropertiesSection.YDirGridStep"},{name:"sPlaneBoxMode",type:"string",JSONname:"PropertiesSection.PlaneBoxMode",defaultValue:"NormalMode"},{name:"fSliceOffset",type:"float",JSONname:"PropertiesSection.SliceOffset"},{name:"vTranslationValue",type:"float",JSONname:"PropertiesSection.TranslationValue",defaultValue:0},{name:"bSectionCurvesVisible",type:"bool",JSONname:"PropertiesSection.SectionCurvesVisible",defaultValue:!0},{name:"sTargetIds",type:"listStrings",JSONname:"targetIds",defaultValue:[]},{name:"iGridAbsoluteMode",type:"int",JSONname:"PropertiesSection.GridAbsoluteMode",defaultValue:1},{name:"sLinkedObjectId",type:"string",JSONname:"linkedObjectId"},{name:"mRelativePosition",type:"Matrix4",JSONname:"relativePosition"},{name:"iCutUncutMode",type:"int",JSONname:"PropertiesSection.CutUncutMode"},{name:"fLineStyleThickness",type:"int",JSONname:"PropertiesSection.GraphicProperties.LineStyle.thickness"}];return e.extend({init:function(e,V,D,x,A,N,R){if(this._parent(e,V),this.addParameters(_),N)this._context=N;else{var O,E=f.getContextViewer({reviewContext:f.getReviewContext({viewer:e})});E&&(O=E.getCommandContext()),this._context=O||"Default"}var T,I;this.setAttribute("sType","Section"),this._typeApps=D,R&&(T=R),this._sectionObjectMode=x,this._tokenModelEvent=[],A?I=A:(I=M.getCommand("DMUSectionInEditModeHdr",this._context))&&(I.isRunning()||I.isPaused())&&I.end();var U=this;this._nSectionCurvesNode=new t,this._nSectionCurvesNode.getDMUType=function(){return U.getType()};var B=new t,L=!0,k=(new d.Matrix4).makeScale(10,0,0),F=!0,z=[],W=[],G=[],X=[],j=[],Y=!1,H=null,J=[],Z=null,q=null,Q=!1;this._translationValue=0;var K=!1;this._vTranslationValue=50;var $="DS/DMUSection/DMUSectionContextualBar";var ee,te=f.getContextViewer({reviewContext:f.getReviewContext({viewer:e})}),ie=te.subscribe({event:"onRepresentationLoaded"},function(){if(U.getAttribute("sLinkedObjectId")){var e=U.getAttribute("sLinkedObjectId");if(null!=e)e.length>0&&(!function(){if(U.getAttribute("sLinkedObjectId")&&U.getAttribute("mRelativePosition")){var e=U.getAttribute("sLinkedObjectId");if(null!=e&&e.length>0){var t=U.getAttribute("mRelativePosition"),i=new d.Matrix4;i.getInverse(t);var n=e[0],a=P.getAbsolutePositionMatrix(U,i,n);if(null!=a){var o={attribute:"mPlaneReferential",value:a.rotateX(Math.PI)};U.set(o),U.getNode().updateRobotPos(!0),U._viewer.render()}}}}(),te.unsubscribe(ie))}}),ne=function(){var e=!1;if(b&&b.getSetting("enopad3dviewer_lightNodeModel")){for(var t=l.getRootReferences(U._viewer),i=0,n=0,a=0;a<t.length;a++)l.isPLMNode(t[a],!0)&&i++,l.isOOCTileSetNode(t[a],!0)&&n++;i+n===t.length&&(0===i&&(e=!1),e=!0)}return e};function ae(){U._bBox||(U._bBox=l.computeBoundingBox(U._viewer,G)),U._bSphere||(U._bSphere=l.computeBoundingSphere(U._viewer,G));var e=new d.Vector3((U._bBox.max.x+U._bBox.min.x)/2,(U._bBox.max.y+U._bBox.min.y)/2,(U._bBox.max.z+U._bBox.min.z)/2),t=Math.ceil(Math.max(2*U._bSphere.radius,U._bBox.max.distanceTo(U._bBox.min))),i=U.getCenter(),n=t/10,a="ExploreView";if("3dPlay"!==U._typeApps){var o=localStorage.getItem("IncrementValue");null!=o&&(n=o);var r=localStorage.getItem("strActiveView");null!=r&&(a=r)}var s=-1,c=1,u=0,p=!1,g=U.getNormal().normalize();U._dotXNormal=g.clone().dot(new d.Vector3(1,0,0)),U._dotYNormal=g.clone().dot(new d.Vector3(0,1,0)),U._dotZNormal=g.clone().dot(new d.Vector3(0,0,1));var v=e.clone().projectOnVector(g.clone()),f=i.clone().projectOnVector(g.clone());U._vProjBoxCenterOnPlaneNormal=i.clone().add(v.clone().sub(f.clone())),U._centerNearPlane=(new d.Vector3).addVectors(U._vProjBoxCenterOnPlaneNormal,g.clone().multiplyScalar(.5*t)),U._centerFarPlane=(new d.Vector3).subVectors(U._vProjBoxCenterOnPlaneNormal,g.clone().multiplyScalar(.5*t));var m,S=U.getNode()?U.getNode()._getManpForRobot():void 0;if(S&&S._robotWihtRuler&&S._robotWihtRuler._getRulerOriginPos&&(m=S._robotWihtRuler._getRulerOriginPos()),null==m&&I&&I.getRobotOrigin&&(m=I.getRobotOrigin()),null==m&&(m=i.clone()),null!=m){var h=U._centerNearPlane.clone().distanceTo(i.clone()),M=U._centerFarPlane.clone().distanceTo(i.clone()),b=g.clone().negate(),y=m.clone().projectOnVector(g.clone()),w=(y=i.clone().add(y.clone().sub(f.clone()))).clone().sub(i.clone()),P=y.clone().sub(U._centerFarPlane.clone()),C=y.clone().sub(U._centerNearPlane.clone()),_=w.clone().normalize().dot(b.clone().normalize()),V=P.clone().normalize().dot(b.clone().normalize()),D=C.clone().normalize().dot(b.clone().normalize());u=i.clone().distanceTo(y.clone()),c=U._centerFarPlane.clone().distanceTo(y.clone()),s=U._centerNearPlane.clone().distanceTo(y.clone()),_>.9995&&(u=-u),V>.9995&&(c=-c),D>.9995&&(s=-s),Math.abs(h+M-t)<=.001||(h>M?(u=c,p=!0):h<M&&(u=s,p=!0))}return{value:u,minValue:s,maxValue:c,manipRange:t,stepValue:n,viewName:a,bSectionPlaneOutOfmanipRange:p}}function oe(e){if(void 0!==r.getValue(U,"vTranslationValue")){var t=w.convert(e,"length",w.getCurrentUnit("Length").unit,"mm");r.setValue(t,U,"vTranslationValue")}}function re(){var e=ae();U.setTranslationValue(e.value,!1),U._movegauge&&(U._movegauge.unsubscribeToUnitChangeEvt(),U._movegauge.clean(),U._movegauge=null);let t=!1;if(V){let e;if("DMUTemporaryBag"===V.getType())e=V.getDMUObjects("DMUCompare3D");else{let t=f.getReviewContext({viewer:U._viewer});if(t){let i=t.getCurrentSessionMarkup();i.getCurrentSlide()&&(e=i.getCurrentSlide().getDMUObjects("DMUCompare3D"))}}e&&e.length&&(t=!0)}U._movegauge=new n({iOwner:U,frameWindow:U._frmWindow,runningApp:U._typeApps,initViewName:e.viewName,initValue:e.value,initMinValue:e.minValue,initMaxValue:e.maxValue,initStepValue:void 0!==e.stepValue&&null!==e.stepValue&&e.stepValue>0?e.stepValue:e.manipRange/10,initManipRange:e.manipRange,onChangeSliderCB:oe,onChangeSpinnerCB:oe,notifyOutOfRange:e.bSectionPlaneOutOfmanipRange,hasCompareObject:t}),U._movegauge&&(I&&I.setSlider(U._movegauge),U._movegauge.subscribeToUnitChangeEvt&&U._movegauge.subscribeToUnitChangeEvt({event:"onPreferencesChanged",cb:ee}))}function le(e){null!==U._nSectionCurvesNode&&U._nSectionCurvesNode.removeChildren(),e||(null!==B&&B.removeChildren(),Y=!0),X=[],j=[]}function se(e,t){var i;if(e.length>0&&t.length>0){var n=U.getAttribute("sLineStylePattern"),a=U.getAttribute("fLineStyleThickness"),r=o.createPolylines(e,t,a,n);(i=p.createMeshNode(r)).name=C.sectioncurves,i.measurable=!0,i.setPickParent(!0)}return i}function ce(e,t){var i=se(e,t);i&&B.add(i)}function ue(e,n,a){for(var o=[],r=[],l=e.aAllPolygons.length,s=U.getAttribute("cLineStyleColor"),c=0;c<l;c++){var u=i.trimPolylines(e.aAllPolygons[c]._Polylines,a);u.length>0&&(o.push(u),r.push(s||e.aAllColors[c]),X.push(u),j.push(s||e.aAllColors[c]))}!function(e,i,n){if(L||U.isSecondaryViewerShow()){var a=se(i,n);if(a){var o=new t;o.name=C.sectioncurves,o.measurable=!0,o.setPickParent(!0),o.getDMUType=function(){return U.getType()},o.add(a),e&&o.setMatrix(e),U._nSectionCurvesNode.add(o)}U._nSectionCurvesNode.setVisibility(U._bIsInShowSpace)}U.isSecondaryViewerShow()&&ce(i,n)}(n,o,r)}function de(e){e?U.setSectionCurveUpdateStatus(!0):U.setSectionCurveUpdateStatus(!1),U.refreshNode(),U._viewer.render()}function pe(){var e=[],t=U.getAttribute("sTargetIds"),i=t.length,n=f.getReviewContext({viewer:U._viewer});if(n){var a=n.getCurrentSessionMarkup();if(a){var o=a.getAttribute("oLinksManager");if(o&&i>0)for(var r=0;r<i;r++){var l,s=o.getChildWithID(t[r]);s&&(l=o.getOccurrenceIdPath(s.path)),l&&e.push(l)}}}return e}if(this.cleanLockedInRAMNodes=function(){if(J.length>0&&Z){for(var e=0;e<J.length;e++)Z.unlockRepresentationMeshInRAM(J[e]);J=[]}},this.unsuscribeOnRepLoading=function(){H&&(q&&q.unsubscribe(H),H=null)},this.isSectionDisplayed=function(){return U.isVisible()&&U.getActiveFlag()&&U.isDisplayed()&&U.getAttribute("bVisible")},ee=function(){U._movegauge&&U._movegauge.getVisibleFlag()&&(U._movegauge.unsubscribeToUnitChangeEvt(),U._movegauge.clean(),U._movegauge=null,re(),U._movegauge&&U._movegauge.setVisibleFlag(!0))},this.refreshSlider=function(){if(!U._movegauge||U._movegauge.bPerformRefreshOrCreate){if(K=!0,U._movegauge){var e=ae();U._movegauge.update({value:e.value,minValue:e.minValue,maxValue:e.maxValue,stepValue:e.stepValue,notifyOutOfRange:e.bSectionPlaneOutOfmanipRange}),U.setTranslationValue(e.value,!1)}K=!1}},this._viewer){var ge;this._bIsInShowSpace=0!==this._viewer.getVisibleSpace();var ve,fe,me=function(){ge&&clearTimeout(ge),ge=setTimeout(function(){ge=null,U&&U._viewer&&U.isSectionDisplayed()&&(U._bUpdateOnModelChange=!0,U.getNode()&&U.getNode().resetClippingFlag(),U.refreshNode(),U._viewer.render(),U._bUpdateOnModelChange=void 0)},100)},Se=f.giveEventsController({viewer:this._viewer});if(Se&&!this._tokenModelEvent.length)fe=Se.addEvent(g.Events.EXPRootModifiedEvent,me),this._tokenModelEvent.push(fe),fe=Se.addEvent(g.Events.EXPMoveEvent,me),this._tokenModelEvent.push(fe),fe=Se.addEvent(g.Events.EXPHideShowEvent,me),this._tokenModelEvent.push(fe),fe=Se.addEvent(g.Events.EXPModelUpdatedEvent,me),this._tokenModelEvent.push(fe),fe=Se.addEvent(g.Events.EXPLineLayoutComputationBeginEvent,function(){U.isSectionDisplayed()&&(ve=U.isVisible(),U.setVisibleFlag(!1),U.refreshNode(),U._viewer.render())}),this._tokenModelEvent.push(fe),fe=Se.addEvent(g.Events.EXPLineLayoutComputationEndEvent,function(){"boolean"==typeof ve&&(U.setVisibleFlag(ve),ve=void 0,me())}),this._tokenModelEvent.push(fe),ne()||(fe=Se.addEvent(g.Events.EXPStartProgressiveLoad,function(){le(),U._bLoadingInProgress=!0,de(!1),U._bPreviousLoadingInProgress=!0}),this._tokenModelEvent.push(fe),fe=Se.addEvent(g.Events.EXPEndProgressiveLoad,function(){U._bLoadingInProgress=!1,de(!0),U._bPreviousLoadingInProgress=!1}),this._tokenModelEvent.push(fe));var he=v.getDMUMarkupsController({context:this._viewer,frmWindow:this._frmWindow});he&&he.registerMarker(this)}this.initAuthoringData=function(){if(-1!==f.getAuthoringFeatureTypes().indexOf("Section")&&(-1===f.getAuthoringFeatureTypes().indexOf("Section")||U.getContextualCommandList||require([$],function(e){var t=new e;U.getContextualCommandList=t.getContextualCommandList,U.getSharedContextualCommandList=t.getSharedContextualCommandList,U.getSharedHeaderTypes=t.getSharedHeaderTypes,"ProgressiveVisuLoading"!==D&&(U.getSharedContextualMenuCommandList=t.getSharedContextualMenuCommandList,U.getContextualMenuCommandList=t.getContextualMenuCommandList),t.register({frmWindow:U._frmWindow});var i=1===m.get().length?m.get()[0].pathElement.clone():null;i&&i.getLastElement(!0).getDMUType&&(i.getLastElement(!0)===U.getNode()||i.getLastElement(!0)===U._nSectionCurvesNode)&&(m.empty(),m.add({pathElement:i}))}),!U.getPropertiesObject&&"ProgressiveVisuLoading"!==D)){require(["DS/DMUSection/DMUSectionProperties"],function(e){var t=new e(U);U.getPropertiesObject=function(){return t}})}},this.removeAuthoringData=function(){-1!==f.getAuthoringFeatureTypes().indexOf("Section")&&-1!==f.getAuthoringFeatureTypes().indexOf("Section")&&require([$],function(e){var t=new e;U.getContextualCommandList=null,U.getSharedContextualCommandList=null,U.getSharedHeaderTypes=null,U.getSharedContextualMenuCommandList=null,U.getContextualMenuCommandList=null,t.unregister({frmWindow:U._frmWindow})})};var Me=new h(U);this.importData=Me.importData,this.afterImport=Me.afterImport,this.initAuthoringData(),this.getDMUObjectFromPathElement=function(e){if(e)for(var t=e.clone();t;){if(t.getLastElement(!0)===U.getNode())return U;t=t.getParentPath()}};var be=!1,ye=this.setInEdition;this.setInEdition=function(e){if(ye(e),!U.isReadOnly()&&U.isEditable())if(e){var t=r.allowManipulation({object:"Section",viewer:U._viewer});r.checkIfCommandIsRunning(U._viewer)&&!t||function(){if(T)T.begin(),T=void 0;else if(I||(I=M.getCommand("DMUSectionInEditModeHdr",U._context)),I&&!I.isRunning()&&U.getNode()){var e=U.getNode()._getManpForRobot();e&&(I.makeRobot(e),I.begin(),e.setRobot(I.getRobot()))}}(),U.manageLock(!1)}else U._movegauge&&!1===be&&(U._movegauge.unsubscribeToUnitChangeEvt(),U._movegauge.clean(),U._movegauge=null),function(){if(I||(I=M.getCommand("DMUSectionInEditModeHdr",U._context)),!be&&I&&(I.isRunning()||I.isPaused())){if(I.end(),U.getNode()){var e=U.getNode()._getManpForRobot();e&&e.setRobot(null)}}else be&&(be=!1)}(),U.manageLock()};var we=this.setReadOnly;this.setReadOnly=function(e){we(e,!0),U.getNode()&&U.getNode().update(!0),U.manageLock()},this.removeCurves=function(){le(),this.cleanLockedInRAMNodes(),this.unsuscribeOnRepLoading()},this.computeCurves=function(e){if("BoxMode"!==U.getAttribute("sPlaneBoxMode")||"OnlyContour"===U.getAttribute("sSectionRender")){ne()||le();var t,n=U.getAttribute("mPlaneReferential");"BoxMode"===U.getAttribute("sPlaneBoxMode")&&(t=new d.Box2);var a=U.getAttribute("fXDirSize"),o=U.getAttribute("fYDirSize");if(t&&t.set(new d.Vector2(-a/2,-o/2),new d.Vector2(a/2,o/2)),F&&U.isSectionDisplayed()&&(L||U.isSecondaryViewerShow())){U.removeCurves(),k=n.clone(),Y=!1;var r=function(r,s){var c=[],u=[];if(U._bIsInShowSpace?r.forEach(function(e){e&&e.getLastElement&&!l.isOOCTileSetNode(e.getLastElement(!0))&&c.push(e)}):s.forEach(function(e){e&&e.getLastElement&&!l.isOOCTileSetNode(e.getLastElement(!0))&&u.push(e)}),U._bIsInShowSpace&&c.length>0||!U._bIsInShowSpace&&u.length>0){var p=n;if(ue(i.computeSectionCurvesUsingPolyPlanarOperator(U._viewer,p,U._bIsInShowSpace?c:u),p,t),"SliceMode"!==U.getAttribute("sPlaneBoxMode")&&"BoxMode"!==U.getAttribute("sPlaneBoxMode")||(p=U._getPlanReferential("Back"),ue(i.computeSectionCurvesUsingPolyPlanarOperator(U._viewer,p,U._bIsInShowSpace?c:u),p,t)),"BoxMode"===U.getAttribute("sPlaneBoxMode")){var g=U.getAttribute("fSliceOffset");t&&t.set(new d.Vector2(-a/2,-g/2),new d.Vector2(a/2,g/2)),p=U._getPlanReferential("Top"),ue(i.computeSectionCurvesUsingPolyPlanarOperator(U._viewer,p,U._bIsInShowSpace?c:u),p,t),p=U._getPlanReferential("Bottom"),ue(i.computeSectionCurvesUsingPolyPlanarOperator(U._viewer,p,U._bIsInShowSpace?c:u),p,t),t&&t.set(new d.Vector3(-g/2,-o/2,0),new d.Vector3(g/2,o/2,0)),p=U._getPlanReferential("Right"),ue(i.computeSectionCurvesUsingPolyPlanarOperator(U._viewer,p,U._bIsInShowSpace?c:u),p,t),p=U._getPlanReferential("Left"),ue(i.computeSectionCurvesUsingPolyPlanarOperator(U._viewer,p,U._bIsInShowSpace?c:u),p,t)}e&&e(),U._viewer.render()}},s=!1;if(ne()&&(s=!0),s){if(q||(q=f.getContextViewer({viewer:U._viewer})),Z||q&&(Z=q.getController()),Z&&q){var c=l.getRootReferences(U._viewer,!0),u=[],p=[];if("NormalMode"===U.getAttribute("sPlaneBoxMode")){var g=U.getCenter(),v=U.getUDirection(),m=U.getVDirection(),S={origin:[g.x.toString(),g.y.toString(),g.z.toString()],u_direction:[v.x.toString(),v.y.toString(),v.z.toString()],v_direction:[m.x.toString(),m.y.toString(),m.z.toString()]};if(c.length>0)for(var h=0;h<c.length;h++)p.push(Z.completeSessionWithClippingOperatorCandidates({path:Z.buildArrayFromPath(l.buildPathElement(c[h])),sectionPlane:S,meshInRAM:!0}))}if("SliceMode"===U.getAttribute("sPlaneBoxMode")){var M=U.getCenter(),b=U.getUDirection(),w=U.getVDirection(),P={origin:[M.x.toString(),M.y.toString(),M.z.toString()],u_direction:[b.x.toString(),b.y.toString(),b.z.toString()],v_direction:[w.x.toString(),w.y.toString(),w.z.toString()]},_=U.getCenter(U._getPlanReferential("Back")),V=U.getUDirection(U._getPlanReferential("Back")),D=U.getVDirection(U._getPlanReferential("Back")),x={origin:[_.x.toString(),_.y.toString(),_.z.toString()],u_direction:[V.x.toString(),V.y.toString(),V.z.toString()],v_direction:[D.x.toString(),D.y.toString(),D.z.toString()]};if(c.length>0)for(var A=0;A<c.length;A++)p.push(Z.completeSessionWithClippingOperatorCandidates({path:Z.buildArrayFromPath(l.buildPathElement(c[A])),sectionPlane:P,meshInRAM:!0})),p.push(Z.completeSessionWithClippingOperatorCandidates({path:Z.buildArrayFromPath(l.buildPathElement(c[A])),sectionPlane:x,meshInRAM:!0}))}else if("BoxMode"===U.getAttribute("sPlaneBoxMode")){var N=U.getAttribute("fSliceOffset"),R=new d.Vector3(o,a,N),O=(new d.Matrix4).copy(n);O.rotateZ(-Math.PI/2),O.translate(new d.Vector3(-o/2,-a/2,0));var E=[O.elements[0],O.elements[1],O.elements[2],O.elements[4],O.elements[5],O.elements[6],O.elements[8],O.elements[9],O.elements[10],O.elements[12],O.elements[13],O.elements[14]],T={corner_min:[0,0,0],corner_max:[R.x,R.y,R.z],transformation_matrix:E,intersection_mode:"across"};if(c.length>0)for(var I=0;I<c.length;I++)p.push(Z.completeSessionWithClippingOperatorCandidates({path:Z.buildArrayFromPath(l.buildPathElement(c[I])),box:T,meshInRAM:!0}))}Promise.all(p).then(function(e){if(e.length>0){e.forEach(function(e){if(e.selectedPaths.length>0){var t=pe();e.selectedPaths.forEach(function(e){var i=e.length;if(t.length>0){for(var n=!1,a=0;a<t.length;a++){var o=t[a],r=o.length;if(r<i)for(var l=0;l<r;l++){if(o[l]!==e[l]){n=!1;break}n=!0}if(n)break}n&&u.push(e)}i>0&&J.push(e[i-1])}),t.length>0?u.push.apply(u,t):u.push.apply(u,e.selectedPaths)}}),H||(H=q.subscribe({event:"onRepresentationLoaded"},function(e){if(Z.hasMeshInRAM(e)){for(var t=[],i=0;i<u.length;i++)-1!==u[i].indexOf(e)&&t.push(Z.buildPathFromArray(u[i]));if(t.length>0){for(var n=[],a=[],o=0;o<t.length;o++)l.parseForLeafNodes(t[o],U._viewer,n,a);r(n,a)}}}));for(var t=[],i=[],n=0;n<u.length;n++){var a=u[n][u[n].length-1];if(Z.isReferenceComplete(a)&&Z.hasMeshInRAM(a)){var o=Z.buildPathFromArray(u[n]);l.parseForLeafNodes(o,U._viewer,t,i)}}r(t,i)}},function(){y&&y.displayNotification({eventID:"warning",msg:C.notifyComputeContourfailure}),U.unsuscribeOnRepLoading(),le(),Y=!1})}}else U.collectCutObjects(),r(z,W)}}},this._getPlanReferential=function(e){var t=new d.Matrix4;if(U.getAttribute("mPlaneReferential")&&(t=t.copy(U.getAttribute("mPlaneReferential")),e)){var i=U.getAttribute("fSliceOffset");"Back"===e?(t.rotateX(Math.PI),t.translate(new d.Vector3(0,0,-i))):"Top"===e?(t.rotateX(-Math.PI/2),t.translate(new d.Vector3(0,-i/2,-U.getAttribute("fYDirSize")/2))):"Bottom"===e?(t.rotateX(Math.PI/2),t.translate(new d.Vector3(0,i/2,-U.getAttribute("fYDirSize")/2))):"Left"===e?(t.rotateY(Math.PI/2),t.translate(new d.Vector3(-i/2,0,-U.getAttribute("fXDirSize")/2))):"Right"===e&&(t.rotateY(-Math.PI/2),t.translate(new d.Vector3(i/2,0,-U.getAttribute("fXDirSize")/2)))}return t},this.isSectionCurveComputationNeeded=function(){var e=!1;if(!U._bLoadingInProgress)if(U._bUpdateOnModelChange)e=U._bUpdateOnModelChange;else{var t=U.getAttribute("mPlaneReferential");U.isSectionDisplayed()&&(Y||!c.areMatrixEqual(k.elements,t.elements)||U._bPreviousLoadingInProgress)&&(e=!0)}return e},this.isSecondaryViewerShow=function(){return U._iViewerSecondaryWindow&&U._iViewerSecondaryWindow.isShow()},this.beginManipulation=function(){U.isSecondaryViewerShow()||(F=!1),F||U._viewer.picking.primitive&&U.getAttribute("bSectionCurvesVisible")&&U._viewer.setRenderMode("SectionLine",!0),Q=!1,U._movegauge&&U.refreshSlider?U.refreshSlider():re()},this.doManipulation=function(e){ne()&&(F=!1,le(!0),this.cleanLockedInRAMNodes()),void 0===e&&de(!1),U._viewer.render(),U._movegauge&&U.refreshSlider?U.refreshSlider():re()},this.endManipulation=function(e){if(F=!0,!Q){var t={pathElement:l.buildPathElement(U.getNode())};e&&e.from&&(be=!0,!e||e&&!e.from[0].event.ctrlKey?(m.empty(),m.add(t)):m.isIn(t)?m.remove(t):m.add(t),be&&(be=!1))}de(!0),U._viewer.picking.primitive&&U._viewer.setRenderMode("SectionLine",!1),U._movegauge&&U.refreshSlider?U.refreshSlider():re(),U.fireEvent("onEndSectionManipulation",{dmuObject:U})},this.onLongHold=function(){Q=!0},this.setObjects=function(e,t){if(e&&e.length>0){G||(G=[]);var n=e.length,a=U.getParent();if(a&&a.getOccurence){for(var o,r,s=U.getAttribute("sTargetIds"),c=0;c<n;c++)if(o=a.getOccurence({pathElement:e[c]},!0))if((r=s.indexOf(o.id))>=0){var u=s.slice(0,r),d=s.slice(r+1);s=u.concat(d);var p=G.slice(0,r),g=G.slice(r+1);G=p.concat(g)}else s.push(o.id),G.push(e[c]);U.setAttribute("sTargetIds",s)}if(!t){var v=l.computeBoundingBox(U._viewer,G),f=Math.max(v.max.x-v.min.x,v.max.y-v.min.y,v.max.z-v.min.z),m=i.computeSectionPlaneReferencial(U._viewer,v);U.getNode()&&U.getNode().resetClippingFlag(),U.setAttribute("fXDirSize",f),U.setAttribute("fYDirSize",f),U.modifyPlaneReferential(m),U.getNode()&&U.getNode().updateRobotPos(!0)}}},this.collectCutObjects=function(){var e=[],t=!1,i=1;if(0===z.length&&0===W.length){var n=f.getContextViewer({viewer:U._viewer});if(ne())(e=pe())&&e.length>0&&(t=!0,void 0!==U.getAttribute("iCutUncutMode")&&(i=U.getAttribute("iCutUncutMode")));else{var a=function(){if(!G||0===G.length){G=[];var e=U.getAttribute("sTargetIds"),t=e.length,i=f.getReviewContext({viewer:U._viewer});if(i){var n=i.getCurrentSessionMarkup();if(n){var a=n.getAttribute("oLinksManager");if(a&&t>0)for(var o,r=0;r<t;r++)(o=a.getOccurrencePathElement(e[r]))&&G.push(o)}}}return G}();if(a&&a.length>0){t=!0;for(var o=a.length,r=0;r<o;r++)l.parseForLeafNodes(a[r],U._viewer,z,W)}else l.parseForLeafNodesOfScene(n,z,W)}}return t||(t=G&&G.length>0),{CutObjects:z,NoCutObjects:W,CutObjectsOOC:e,bIsPartial:t,cutUncutMode:i}},this.onViewerEventCB=function(e){var t=!0,i=f.getReviewContext({viewer:this._viewer});if(i&&(!i.isVisible()||i.getCurrentSessionMarkup()&&!i.getCurrentSessionMarkup().isVisible())&&(t=!1),t){U.getNode()&&U.getNode().onViewerEventCB&&U.getNode().onViewerEventCB(e);var n=0!==U._viewer.getVisibleSpace();if("beginExplodeCmd"===e.eventType){U._bIsInShowSpace===n&&U.setVisibleFlag(!1);var a={pathElement:l.buildPathElement(U.getNode())};m.isIn(a)?m.remove(a):(a={pathElement:l.buildPathElement(U._nSectionCurvesNode)},m.isIn(a)&&m.remove(a)),U.refreshNode(),U.getNode().enableClipping(!1),U._viewer.setSectionCapping(!1)}else"endExplodeCmd"===e.eventType&&(U._bIsInShowSpace===n&&U.setVisibleFlag(!0),U.refreshNode(),U.getNode().enableClipping(!0),U._viewer.setSectionCapping(!0))}},this.setSectionCurveUpdateStatus=function(e){L=e};var Pe=this.refreshNode;this.refreshNode=function(){if(U.getNode()&&(!V.isImporting||V.isImporting&&!V.isImporting())){z=[],W=[];var e=U.isSectionDisplayed();if(U.getNode().update(),T){var t=U.getNode();if(t){var i=t._getManpForRobot();t.enableClipping(!1),U._viewer.setSectionCapping(!1),U.setAttribute("bVisible",!1),i._setPlaneVisibility(!1)}}U._viewer.render(),!e&&U._iViewerSecondaryWindow&&U._iViewerSecondaryWindow.clear(),Pe()}},this.manageLock=function(e){var t,i=!1;if(V&&"DMUTemporaryBag"===V.getType()&&(i=!0),i)t="boolean"==typeof e?e:!!this._viewer._lockUnlockCmd&&this._viewer._lockUnlockCmd.getState();else{var n="boolean"==typeof e?e:!!this._viewer._lockUnlockCmd&&this._viewer._lockUnlockCmd.getState();U.getNode()&&(t=!(U.isInEdition()&&!U.isReadOnly())&&n)}U.getNode()&&U.getNode().manageLock(t)},this.sectionToXYZ=function(e){if(!r.isEnvActivated("oldSectionPlaneDim",!0)){var t=l.computeBoundingBox(U._viewer),i=u.computePlaneDim(t,e);if(i){if(i.fPlaneSizeV&&i.fPlaneSizeU){var n=i.fPlaneSizeU,a=i.fPlaneSizeV;U.setAttribute("fXDirSize",n),U.setAttribute("fYDirSize",a),U.setAttribute("fXDirGridStep",n/20),U.setAttribute("fYDirGridStep",a/20)}i.plane&&(e=i.plane)}}U.modifyPlaneReferential(e),U.getNode()&&U.getNode().updateRobotPos(!0),U._viewer.render(),U._movegauge&&U.refreshSlider?U.refreshSlider():re(),U.fireEvent("onEndSectionManipulation",{dmuObject:U})},this.sectionToX=function(){var e=U.getCenter(),t=(new d.Matrix4).rotateY(-Math.PI/2).setPosition(e);U.sectionToXYZ(t,e)},this.sectionToY=function(){var e=U.getCenter(),t=(new d.Matrix4).rotateX(Math.PI/2).setPosition(e);U.sectionToXYZ(t,e)},this.sectionToZ=function(){var e=U.getCenter(),t=(new d.Matrix4).rotateY(Math.PI).setPosition(e);U.sectionToXYZ(t,e)},this.sectionFlip=function(){var e={attribute:"mPlaneReferential",value:U.getAttribute("mPlaneReferential").rotateX(Math.PI)};U.set(e),U.getNode()&&U.getNode().updateRobotPos(!0),U.refreshNode(),U._viewer.render(),U._movegauge&&U.refreshSlider?U.refreshSlider():re(),U.fireEvent("onEndSectionManipulation",{dmuObject:U})},this.sectionViewpoint=function(){var e=U.getAttribute("mPlaneReferential"),t=1.5*U.getAttribute("fXDirSize"),i=e.decompose(),n=i[0],o=i[1],r=new d.Vector3(1,0,0).applyQuaternion(o),l=new d.Vector3(0,1,0).applyQuaternion(o),c=new d.Vector3(0,0,1).applyQuaternion(o),u=r.dot(new d.Vector3(0,0,1)),p=l.dot(new d.Vector3(0,0,1)),g=Math.abs(u),v=Math.abs(p),f=r;if(s.isZero(g)&&s.isZero(v)){var m=a.getViewpointInfo(U._viewer.currentViewpoint),S=r.dot(m.sight),h=l.dot(m.sight),M=Math.abs(S),b=Math.abs(h);s.isLessOrEqual(b,M)?s.isLessOrEqual(M,b)||(f=r.multiplyScalar(s.isLessThan(S,0)?-1:1)):f=l.multiplyScalar(s.isLessThan(h,0)?-1:1)}else s.isLessOrEqual(v,g)?s.isLessOrEqual(g,v)||(f=r.multiplyScalar(s.isLessThan(u,0)?-1:1)):f=l.multiplyScalar(s.isLessThan(p,0)?-1:1);a.moveViewpoint({freeZoneSize:U._frmWindow.getImmersiveFrame().getFreeZone().getBoundingClientRect(),viewerSize:{width:U._frmWindow.getViewer().SCREEN_WIDTH,height:U._frmWindow.getViewer().SCREEN_HEIGHT},viewpoint:U._viewer.currentViewpoint,target:n,sightDirection:c,upDirection:f,targetDistance:t,duration:400}),U.getNode()&&U.getNode().updateRobotPos(!0)},this.sectionCut=function(e){var t=e;r.setValue(t,U,"sSectionRender")},this.sectionGrid=function(){var e;e="Plane"===r.getValue(U,"sDisplayPlaneMode")?"Grid":"Plane",r.setValue(e,U,"sDisplayPlaneMode")},this.sectionSlice=function(){r.setValue("SliceMode",U,"sPlaneBoxMode"),r.setValue(20,U,"fSliceOffset")},this.getTranslationValue=function(){return U._translationValue},this.setTranslationValue=function(e,t){if(!1===t||!0===K)U._translationValue=e;else{U._bBox||(U._bBox=l.computeBoundingBox(U._viewer,G));var i=U.getCenter(),n=U.getNormal(),a=i.clone(),o=U._centerNearPlane.distanceTo(U._centerFarPlane),r=U._centerNearPlane.distanceTo(i.clone()),s=U._centerFarPlane.distanceTo(i.clone());if(Math.abs(r+s-o)<=.001){var c=U.getTranslationValue();a=i.clone().add(n.clone().normalize().multiplyScalar(c-e))}else{var u=U.getTranslationValue();r<s?a=U._centerNearPlane.clone().add(n.clone().normalize().multiplyScalar(u-e)):r>s&&(a=U._centerFarPlane.clone().add(n.clone().normalize().multiplyScalar(u-e)))}U._translationValue=e;var d=U.getAttribute("mPlaneReferential");d.setPosition(a),U.modifyPlaneReferential(d),U.getNode().updateRobotPos(!0),U._viewer.render()}},this.modifyPlaneReferential=function(e){if(e){var t={attribute:"mPlaneReferential",value:U.getAttribute("mPlaneReferential").copy(e)};U.set(t),U.getNode().update()}},this.getCenter=function(e){var t=e||U.getAttribute("mPlaneReferential");return(new d.Vector3).getPositionFromMatrix(t)},this.getNormal=function(e){var t=(e||U.getAttribute("mPlaneReferential")).decompose();return new d.Vector3(0,0,1).applyQuaternion(t[1])},this.getUDirection=function(e){var t=(e||U.getAttribute("mPlaneReferential")).decompose();return new d.Vector3(1,0,0).applyQuaternion(t[1])},this.getVDirection=function(e){var t=(e||U.getAttribute("mPlaneReferential")).decompose();return new d.Vector3(0,1,0).applyQuaternion(t[1])},this.renderSecondaryViewer=function(){U._iViewerSecondaryWindow&&U._iViewerSecondaryWindow.render()},this.getSectionCurvesFor2DViwer=function(){return X.length>0&&ce(X,j),B},this.getSectionCurveNode=function(){return U._nSectionCurvesNode},this.removeSectionCurve=function(){le()},this.setNode(new S(this))},remove:function(){this._movegauge&&(this._movegauge.unsubscribeToUnitChangeEvt(),this._movegauge.clean(),this._movegauge=null),this.unsuscribeOnRepLoading(),this.cleanLockedInRAMNodes();var e=M.getCommand("DMUSectionInEditModeHdr",this._context);if(e&&(e.isRunning()||e.isPaused())){e.end();var t=this.getNode()._getManpForRobot();t&&t.setRobot(null)}var i=v.giveDMUMarkupsController({context:this._viewer});i&&i.unregisterMarker(this),v.unreferenceDMUMarkupsController({context:this._viewer});var n=f.giveEventsController({viewer:this._viewer});if(n)for(var a=0;a<this._tokenModelEvent.length;a++)n.removeEvent(this._tokenModelEvent[a]);this._tokenModelEvent=[],this.getNode().clean(),this._viewer.setSectionCapping(!0),this._iViewerSecondaryWindow&&this._iViewerSecondaryWindow.clear(),this._parent()},setAttribute:function(e,t){"fLineStyleThicknessIndex"===e&&this._parent("fLineStyleThickness",null),this._parent(e,t)}})}),define("DS/DMUPlaySection/DMUClippingService",["UWA/Utils","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUPlaySection/DMUSection","DS/DMUPlaySection/DMUToolsSection","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUMeasurable/DMUSectionPosService","i18n!DS/DMUPlaySection/assets/nls/DMUPlaySection"],function(e,t,i,n,a,o,r,l){"use strict";return{setClippingParameters:function(s,c){var u=function(e){if(e){var n=t.getReviewContext({viewer:e});return n||(n=i.createReviewContext({context:t.getContextViewer({viewer:e})})),n}}(s);if(u){var d=c.appType||"3dReview",p=!isNaN(c.indexOfClippingObj)&&c.indexOfClippingObj>0?c.indexOfClippingObj:0,g=c.sectionCommandMode,v=[],f=function(){var i,a,o,r=u.getTransientReviewBag();if(r)return(v=r.getDMUObjects("DMUSection")).length>0?i=v[p]:((i=new n(s,r,d,g,void 0,(a=s,(o=t.getContextViewer({viewer:a}))?o.getCommandContext():"Default"),void 0)).setAttributes([{name:"sID",value:r.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:r.computeNewName({object:i,prefix:l.sectionPrefix||"Section"})}]),r.addDMUObject&&(r.addDMUObject(i),i.fireEvent("onDMUObjectInitialized",{dmuObject:i}))),i}();if(f){var m,S,h=o.computeBoundingBox(s),M=Math.max(h.max.x-h.min.x,h.max.y-h.min.y,h.max.z-h.min.z),b=c.planeReferential||a.computeSectionPlaneReferencial(s,h);if(c.planeSizeU&&c.planeSizeV)S=c.planeSizeV,m=c.planeSizeU;else{m=M,S=M;var y=r.computePlaneDim(h,b,!0);y&&(y.fPlaneSizeV&&y.fPlaneSizeU&&(c.planeSizeV||(S=y.fPlaneSizeV),c.planeSizeU||(m=y.fPlaneSizeU)),y.plane&&!c.planeReferential&&(b=y.plane))}f.setAttributes([{name:"mPlaneReferential",value:b},{name:"fXDirSize",value:m},{name:"fYDirSize",value:S},{name:"sDisplayPlaneMode",value:"Plane"},{name:"sDisplayContourMode",value:"Contour"},{name:"sSectionRender",value:c.sectionRender||"CutOneSide"},{name:"sPartialClippingMode",value:!1},{name:"sUpdateAndFreezeMode",value:"Update"},{name:"fXDirGridStep",value:m/20},{name:"fYDirGridStep",value:S/20},{name:"sPlaneBoxMode",value:c.boxMode||"NormalMode"},{name:"fSliceOffset",value:c.sliceOffset||0},{name:"fOpacity",value:.2},{name:"bSectionCurvesVisible",value:c.sectionCurvesVisible||"ProgressiveVisuLoading"!==g&&"3dPlay"!==d&&"true"===localStorage.getItem("DMUComputeSectionContour")}]),f.setInEdition(!1);var w=f.getNode();w&&w.update(!0),s._lockUnlockCmd&&s._lockUnlockCmd.getState&&f.manageLock(s._lockUnlockCmd.getState()),s.render()}}}}});