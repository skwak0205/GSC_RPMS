define("DS/DMU3DReviewController/DMU3DReviewController",["UWA/Class","DS/DMUControls/EXPNotify","DS/DMUReadPersistence/DMULoadMarkupServices","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPManagerSet","DS/ApplicationFrame/CommandsManager","DS/PADUtils/views/PADProgressBar","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/CoreEvents/ModelEvents","DS/DMUBaseUIControllers/DMU2DSheetManager","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUPlaySlide/controllers/DMUSlideShowController","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/DMUReadPersistence/DMUWebServicesUtils","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUPersistence/DMUSaveServices","DS/DMUControls/DMUInfoModalDiv","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXComponents/CATWebUXUtils","DS/DMUBaseExperience/EXPUtils","DS/DMUReadPersistence/DMULoadingContextController","DS/DMUPlayMarker/DMUMarkerFactory","DS/DMUPlayMarker/DMUMarkerServices","DS/DMUBaseExperience/EXPToolsVisualization","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/DMUBaseUIControllers/DMUSceneDisplayController","DS/PADServices/utils/GlobalModelEvents","DS/CATWebUXSlideDrop/CATWebUXSlideDropServices","i18n!DS/DMU3DReviewController/assets/nls/DMU3DReviewController"],function(e,t,n,o,i,r,a,l,s,c,d,u,g,p,m,f,D,C,v,M,S,h,U,b,P,R,x,y,I,w,A,V,E,F,T,L){"use strict";var O=e.extend({init:function(O){let _;this._parent(O);var k,W,H,B,j,N,X,q,G,z,J,Q,Y,K,Z,$,ee,te,ne,oe,ie,re,ae,le,se=!1,ce=(O||{}).ctxViewer,de=this,ue=new u,ge={},pe=null,me={},fe={},De=!1,Ce=!0,ve=!1,Me=!1;let Se=0,he=!1,Ue=!0;const be=["SIMItfSimulation","PLMPIMMetricReference","Document","DIFLayout","DIFSheet","DIFAnnotationSet","Requirement","Requirement Specification","DesignSight"];function Pe(e,n){_&&(_.destroy(),_=null),_=new t({body:ce.getFrameWindow().getUIFrame(),type:e,message:n})}function Re(){for(var e,t=[],n=s.get(),i=!1,r=null,a=!1,c=0;c<n.length;c++){for(e=n[c].pathElement.clone();e&&e.internalPath.length;)e=e.getParentPath();if(e.getLastElement(!0).getAnnotationClassType||e.getLastElement(!0).getDMUType)return{cmdList:[]};(r=l.getLastReference(e))&&l.isReference(r.getLastElement(!0))?i=!0:r=null}var d=n[n.length-1],u=function(e,t){return e.x>=t.x-3&&e.x<=t.x+3&&e.y>=t.y-3&&e.y<=t.y+3};if(Ce&&n.length&&B&&!B.isADocumentDisplayed()){d&&d.event&&d.event.lastPosition&&d.event.startPosition&&u(d.event.startPosition,d.event.lastPosition)&&d.pathElement.externalPath.length>2&&d.pathElement.externalPath[0]===ce.getRootBagPath().getLastElement(!0)&&(a=!0);var g=o.getReviewContext({context:ce}),p=g?g.getCurrentSessionMarkup():null;let e="3D"===j||"ITF"===j;if(p&&p.getActiveFlag()&&!p.isReadOnly()&&p.isVisible()&&p.getCurrentSlide()){if(i&&e&&t.push({name:"DMUHideShowOverloadStr",line:1,hdr_list:["DMUHideShowOverloadHdr"]}),r&&r.externalPath&&r.externalPath.length&&e){var m=E.getDMUSceneDisplayController({context:ce});m&&!m.getCurrentComparedObjectIDPaths()&&t.push({name:"DMUColorOpacityOverloadStr",line:1,hdr_list:["DMUColorOpacityOverloadHdr"]}),t.push({name:"DMUPositionOverloadStr",line:1,hdr_list:["DMUPositionOverloadHdr"]})}}else i&&e&&t.push({name:"HideShowStr",line:1,hdr_list:["HideShowHdr"]});a&&e?t.push({name:"DMULevelSelectorStr",line:1,hdr_list:["DMULevelSelectorHdr"]}):1===n.length&&d&&d.pathElement&&d.pathElement.getParentPath().isEqual(ce.getRootBagPath())&&e&&t.push({name:"RemoveRootStr",line:1,hdr_list:["RemoveRootHdr"]})}return"DIFLayout"!==ne&&"DIFSheet"!==ne||d&&d.event&&d.event.lastPosition&&d.event.startPosition&&u(d.event.startPosition,d.event.lastPosition)&&d.pathElement.externalPath.length>2&&d.pathElement.externalPath[0]===ce.getRootBagPath().getLastElement(!0)&&t.push({name:"DMULevelSelectorStr",line:1,hdr_list:["DMULevelSelectorHdr"]}),{cmdList:t}}function xe(e,t){var n=[];if(X&&X.getActiveState())return{cmdList:n};var r=o.getReviewContext({context:ce}),a=s.get(),c=!B||B&&!B.isADocumentDisplayed(),u=i.getManager({name:"DMUUserExperienceManager",context:ce.getFrameWindow()}),g={x:t.XmousePositionWithDevPxRatio,y:t.YmousePositionWithDevPxRatio};if(0===(u?u.pick(g,"mesh"):ce.getViewer().pick({xPix:g.x,yPix:g.y},"mesh",!0).path).length){var p=d.get(),m=p&&p[0]&&p[0].pathElement?p[0].pathElement.getLastElement(!0):null,f=m&&m.getDMUType?m.getDMUType():"";if("DMUSlide"===f||"DMUFormat"===f||"DMUComment"===f)return{cmdList:n};n=[{line:1,name:"DMU3DReviewDisplaySubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:!P.isMobile()&&c?["VisuQMCommand","PAD3DToggleStatusBarHdr"]:["PAD3DToggleStatusBarHdr"]},{line:1,name:"DMU3DReviewAmbiencesSubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]}]}else if(a.length){var D=r?r.getCurrentSessionMarkup():null,C=!1,v=!1,M=!1,S=D&&!D.isReadOnly()&&D.isVisible();for(let e=0;e<a.length;e++){if(D&&!D.isReadOnly()&&D.isVisible()){var h=D.getOrCreateOccurrenceOverloader(a[e]);if(!C)if(h&&h.isOverloadedInCurrentSlide())C=!0;else{let t=a[e].pathElement.clone();t.getParentPath()&&l.isInstance(t.getParentPath().getLastElement(!0))&&(h=D.getOrCreateOccurrenceOverloader({pathElement:t.getParentPath()}))&&h.isOverloadedInCurrentSlide()&&(C=!0)}}for(var U=!0,b=0;b<a[e].pathElement.externalPath.length;b++)a[e].pathElement.externalPath[b].getDMUType&&(v=!0,U=!1);U&&(M=!0)}var R=!1;if(u&&(R=u.areOccurenceOverloadsCopied()),C&&(n=n.concat([{line:1,name:"DMURemoveOverloadStr",hdr_list:["DMURemoveOverloadHdr"]},{line:1,name:"DMUCopyStr",hdr_list:["DMUCopyHdr"]},{line:1,name:"DMUCutStr",hdr_list:["DMUCutHdr"]}])),M&&R&&(n=n.concat([{line:1,name:"DMUPasteStr",hdr_list:["DMUPasteHdr"]},{line:1,name:"DMUPasteSpecialStr",hdr_list:["DMUPasteSpecialHdr"]}])),!v){c?n.push({line:1,name:"FocusOn",hdr_list:["FocusOnHdr"]}):-1===N.indexOf("Document")&&n.push({line:1,name:"FocusOn",hdr_list:["DMUFocusOnRepresentationHdr"]}),"Requirement"===N||"Requirement Specification"===N?n.push({line:1,name:"ReframeOn",hdr_list:["WebDocumentReframeOnHdr"]}):"Drawing"===N||"DIFLayout"===N||"DIFSheet"===N?n.push({line:1,name:"ReframeOn",hdr_list:["DMUReframeOnRepresentationHdr"]}):n.push({line:1,name:"ReframeOn",hdr_list:["ReframeOnHdr"]});let e=!ce.getController().isRootSupported||a.length>=1&&a[0].pathElement.externalPath.length>=2&&ce.getController().isRootSupported(l.getNodeID(a[0].pathElement.externalPath[1]));if(S&&c&&e){let e,t,o=!1;for(let n=0;n<a.length;n++){for(e=a[n].pathElement.clone();e&&e.internalPath.length;)e=e.getParentPath();if((t=l.getLastReference(e))&&l.isReference(t.getLastElement(!0))){o=!0;break}}t&&t.externalPath.length<=2&&(o=!1),o&&n.push({line:1,name:"DMUHideShowOverloadStr",hdr_list:["DMUHideShowOverloadHdr"]})}1===a.length&&"Drawing"!==le&&ce.getRootBagPath().isAParentOf(a[0].pathElement)&&n.push({name:"DMUNavOnImplementationLinksStr",line:1,hdr_list:["DMUNavOnImplementationLinksHdr"]}),n.push({line:1,name:"EditPropertiesCmd",hdr_list:["ActionBar_Attributes"]}),c&&e&&n.push({line:1,name:"PAD3DViewerToggleGeometrySection",resourceFile:"ENOPAD3DViewer/ENOPAD3DViewer",hdr_list:["PAD3DToggleSimplifiedHdr","PAD3DToggleAccurateHdr"]})}}return{cmdList:n}}function ye(){setTimeout(function(){if(ce){var e,t,n,a=o.getReviewContext({context:ce}),s=function(){for(var o=0;o<t.length;o++)(e=r.getCommand(t[o],ce.getCommandContext()))||(e=r.getCommandCheckHeader(t[o],ce.getCommandContext())),e&&(n?e.enable():e.disable())};t=["DMU2DCompareCmdHdr"],n=se&&0!==ce.getViewer().getVisibleSpace()&&l.getRoots(ce).length&&(!a||a&&!a.isReadOnly())&&("Drawing"===le||"DIFSheet"===le||"DIFLayout"===le),s(),t=["DMUMarkupHdr","3DcompareCmdHdr","measureCmdHdr","thicknessCmdHdr","sectionCmdHdr","LockUnlockSectionHdr"],n=se&&0!==ce.getViewer().getVisibleSpace()&&l.getRoots(ce).length&&(!a||a&&!a.isReadOnly()),s(),n=n&&a&&!a.isReadOnly()&&a.getCurrentSessionMarkup()&&!a.getCurrentSessionMarkup().isReadOnly(),t=["DMUEditFormatsHdr","slideCmdHdr","DMUExportReviewAsPdfHdr"],s(),n=n&&a&&!a.isReadOnly()&&a.getCurrentSessionMarkup()&&a.getCurrentSessionMarkup().getActiveFlag()&&a.getCurrentSessionMarkup().isVisible()&&a.getCurrentSessionMarkup().getCurrentSlide()&&!a.getCurrentSessionMarkup().isReadOnly(),t=["CATWebUXSlideShowHdr","markerTextCmdHdr","markerPictureCmdHdr","marker2DTextCmdHdr","marker2DPictureCmdHdr","markerCircleCmdHdr","DMU3DRectangleCmdHdr","DMUFreehandCmdHdr","DMUCommentCmdHdr","markerArrowCmdHdr"],s(),t=["CATWebUXGenerateIssueHdr","CATWebUXGenerateCAHdr"],n=se&&0!==ce.getViewer().getVisibleSpace()&&l.getRoots(ce).length&&a&&a.getCurrentSessionMarkup(),s(),n=se&&0!==ce.getViewer().getVisibleSpace()&&l.getRoots(ce).length&&a&&a.getCurrentSessionMarkup()&&a.getCurrentSessionMarkup().getSlides().length>0||se&&("Document"===j||"Requirement"===N||"Requirement Specification"===N),t=["CATWebUXSlideShowHdr"],s(),n=se&&(!a||!a.isReadOnly())&&("Document"===j||"Requirement"===N||"Requirement Specification"===N)&&B&&B.documentHasBookmarks(),t=["WebDocumentBookmarksPanelCmdHdr"],s(),n=se&&("Document"===j||"Requirement"===N||"Requirement Specification"===N)&&B&&B.documentHasMultipleElements(),t=["WebDocumentPreviousPageCmdHdr","WebDocumentNextPageCmdHdr"],s(),n=se&&("Document"===j||"Requirement"===N||"Requirement Specification"===N)&&B&&"Document"===B.getDocumentType(),t=["WebDocumentRotatePagesLeftCmdHdr","WebDocumentRotatePagesRightCmdHdr"],s(),n=se&&("Document"===j||"Requirement"===N||"Requirement Specification"===N)&&ee&&ee.hasComments(),t=["DMUPreviousCommentCmdHdr","DMUNextCommentCmdHdr"],s();var c=i.getManager({name:"DMUUserExperienceManager",context:ce.getFrameWindow()});c&&c.refreshCCPCommandsAvailability()}})}function Ie(e){se&&(j!==e&&(z&&j&&z.removeApplicativeContainer(j),j=e,o.setCurrentReviewContext(j),de.publish("onReviewContextModified",{type:j,onABReady:ye}),z&&z.initApplicativeContainer(j,{authoring:!0})),ye())}function we(e,t){for(var n=[],o=l.getRoots(ce),i=0;i<o.length;i++)if(!e||l.getNodeType(o[i])===e){var r=l.getNodeID(o[i]);r!==t&&n.push(r)}ce.removeRoots({pids:n})}async function Ae(e){try{let t=await v.getParentTypes(e);return[e].concat(t)}catch{return[e]}}async function Ve(e){if(!se||!e)return;var t,n;if(le=void 0,e.path?(t=l.getNodeID(e.path.getLastElement(!0)),n=ce.getController().getRootStats(t)&&"r2vsurvey"===ce.getController().getRootStats(t).serviceId?"R2V_FeatureState":l.getNodeType(e.path.getLastElement(!0))):e.docData&&(t=e.docData.objectId,n=e.docData.objectType),!t||!n)return;le=n,q&&q.getLoadedID()===t||(ve&&B&&(B.updateDocumentControllers(),B.isADocumentDisplayed()&&B.getDocumentLoadedID()===t?(q&&q.setLoadedID(t),B.initializeDMUEvents()):e.isCompareActive||B.clean2DDocument()),ee&&!ve&&ee.cleanCommentsPanel()),G=null;var i=function(){Ie("ITF")};var r=function(){if("DIFLayout"===n||"DIFSheet"===n)Ie("2DFL"),ne=n;else if("Drawing"===n){++Se>1&&Se===ce.getRootBagPath().getChildrenPathes().length&&Pe("warning",L.multidropdrawing),Ie("2D"),ne=n,Me||we(null,t);var e=setInterval(function(){var o,i,r,l;(1===ce.getRootBagPath().getChildrenPathes().length||Me&&2===ce.getRootBagPath().getChildrenPathes().length)&&(clearInterval(e),o=t,i=n,r=ce.getRootBagPath().getChildrenPathes()[ce.getRootBagPath().getChildrenPathes().length-1].getLastElement(!0),B.load2DDocument({phyID:o,dataType:i,serverUrl:D.get3DSpaceUrl(),securityContext:C.getSetting("pad_security_ctx"),parentNode:r,is2DCompareActive:Me,onLoadingStarted:function(){a.on(),l=1},onComplete:function(){l&&(a.off(),l=0)},onFailure:function(){ce.removeRoots({pids:[o]}),ce.displayNotification({msg:L.fileWithNoSVG,eventID:"error"}),l&&(a.off(),l=0)}}))},100)}},s=function(){!q||"DXF"!==q.getLoadMarkupCtxType()&&"DWG"!==q.getLoadMarkupCtxType()?(Ie(n),ne=n):(Ie("2D"),ne=n,we(null,t)),G=t};if("Drawing"===n||"DIFLayout"===n||"DIFSheet"===n&&e.path.getParentPath().isEqual(ce.getRootBagPath()))r(),N=n;else if("Document"===n||"Requirement"===n||"Requirement Specification"===n)s(),N=n;else if(ce.getApplicativeData().getLoadedItfData&&ce.getApplicativeData().getLoadedItfData().data.length>0)i(),N="SIMItfSimulation";else if("DesignSight"===n)Ie("MSR"),ne=n,N="MSR";else if("R2V_FeatureState"===n)!async function(){ne&&(we(ne,t),ne=void 0),await async function(){const e=l.getRoots(ce);let t=!1;for(let n=0;n<e.length;n++){let o=l.getNodeType(e[n]),i=0,r=await Ae(o);if(r.includes("VPMReference")||i===e.length-1)return r.includes("VPMReference")&&(t=!0),t;i++}}()||Ie("R2V"),q.load({data:{serviceId:"r2vsurvey",objectParentType:"R2V_FeatureState",objectType:"R2V_FeatureState",objectId:t}})}();else{let a=await Ae(n);a&&a.length&&-1!==a.indexOf("Drawing")&&e.path.getParentPath().isEqual(ce.getRootBagPath())?(n=N="Drawing",r()):a&&a.length&&-1!==a.indexOf("SIMItfSimulation")&&e.path.getParentPath().isEqual(ce.getRootBagPath())?(n=N="SIMItfSimulation",i()):a&&a.length&&(-1!==a.indexOf("Requirement")||-1!==a.indexOf("Requirement Specification"))?(n=-1!==a.indexOf("Requirement Specification")?"Requirement Specification":"Requirement",N="Requirement",s()):a&&a.length&&-1!==a.indexOf("Document")?(n=N="Document",s()):ae?ce.removeRoots({pids:[t]}):function(){ne&&(we(ne,t),ne=void 0);let e=!0;const n=o.getReviewContext({context:ce}),i=n?n.getCurrentSessionMarkup():null;if(i){const t=i.getApplicativeContext();t&&t.PIM&&(e=!1)}e&&Ie("3D")}()}ye()}var Ee,Fe,Te;function Le(){var e=o.getReviewContext({context:ce}),t=e?e.getCurrentSessionMarkup():null;se&&!te&&t&&e.getReviewCtxInformation()&&t&&!t.isReadOnly()&&t.isDirty()&&!t.isImporting()&&(Ee&&clearTimeout(Ee),Fe&&clearTimeout(Fe),$&&$.destroy(),Ee=setTimeout(function(){if(se&&!te&&o.getReviewContext({context:ce}))if(S.isProcessing())Fe=setTimeout(Le,1e3);else{if(ce){var e=o.giveEventsController({viewer:ce.getViewer()});$||($=new h),$.display({frmWindow:ce.getFrameWindow(),type:"save"});var t=null,n=null,i=null,r=null,a=null,l=null;q&&"Document"===N&&(a=q.getDocumentVersionInfos(),r="Document",l=q.getLoadMarkupCtxType()),ce.getApplicativeData&&(ce.getApplicativeData(),ce.getApplicativeData().getLoadedItfData&&(t=ce.getApplicativeData().getLoadedItfData()).data.length&&(t.data[0].metricID&&(n=t.data[0].metricID),void 0!==t.loadMode&&(i=t.loadMode),r="SIMItfSimulation")),S.saveCurrent3DMarkup({newFile:De,frmWindow:ce.getFrameWindow(),superType:r,documentType:l,listData:n,loadingInfos:i,documentVersionInfos:a}).then(()=>{$&&$.destroy(),e.fireEvent("on3DMarkupSaved")},t=>{$&&($.destroy(),$.display({frmWindow:ce.getFrameWindow(),type:"error"})),e.fireEvent("on3DMarkupSaveFailed"),Fe=setTimeout(Le,5e3),window.console.warn(t)}),De=!1}Ee=null}},750))}function Oe(){Le(),ye()}function _e(){const e=o.getReviewContext({context:ce});(e?e.getCurrentSessionMarkup():null)&&setTimeout(()=>{ce.toggleSOITimelinesUsability(!1)},1e3)}function ke(e){if(se){te=!1;var t=E.giveDMUSceneDisplayController({context:ce});if((!t||!t.getCurrentComparedObjectIDPaths()&&X&&X.getActiveState())&&X.setActiveState(!1),e.id===sessionStorage.getItem("DMU2DCompareTempRoot"))ce.removeRoots({pids:[sessionStorage.getItem("DMU2DCompareTempRoot")]}),sessionStorage.removeItem("DMU2DCompareTempRoot");else if(e.path)Ve({path:e.path});else{var n=ce.getRootBagPath().externalPath[0].path.getChildrenPathes().length;if(n)Ve({path:ce.getRootBagPath().externalPath[0].path.getChildrenPathes()[n-1]})}}}function We(e){if(se){if(!ce.getRootBagPath().getChildrenPathes().length&&X&&X.getActiveState()&&X.setActiveState(!1),B&&(e&&e.id?B.clean2DDocument(e):B.clean2DDocument()),ee&&ee.cleanCommentsPanel(),q&&(q.clean(),q.setLoadedR2VInformations([])),le&&"R2V_FeatureState"===le&&ce.toggleSOITimelinesUsability(!0),ce.getRootBagPath().getChildrenPathes().length){var t=ce.getRootBagPath().externalPath[0].path.getChildrenPathes().length;let e;t&&(e=ce.getRootBagPath().externalPath[0].path.getChildrenPathes()[t-1]),le=l.getNodeType(e.getLastElement(!0))}else te=!0,o.setReviewContext({context:ce});ye(),G=null,Se=0}}function He(){ce.unsubscribe(ge.onRootRemoved),ge.onRootRemoved=-1}function Be(){ge.onRootRemoved=ce.subscribe({event:"onRootRemoved"},We)}function je(e){Te=w.getNearPositionFrom2DCoordinates({x:e.clientX,y:e.clientY},ce.getViewer())}function Ne(e){se&&de&&e&&D.multiTenantMgt([e],l.getRoots(ce),function(t){if(!t.isMultiTenant){var n=o.getReviewContext({context:ce}),i=n?n.getCurrentSessionMarkup():null;if(!i||i.isReadOnly()||!i.getCurrentSlide())return;I.getDataFromRelatedId({type:"DMUMarker3DPicture",objectId:e.objectId,onComplete:function(t){var n=y.create3DMarker({viewer:ce.getViewer(),frameWindow:ce.getFrameWindow(),parent:i,date:Date.now(),objectId:e.objectId,shape:{type:"picture",pointingPoint:Te,data:t}});n&&(i.getCurrentSlide().addDMUObject(n),n.fireEvent("onDMUObjectInitialized",{dmuObject:n}))}})}})}function Xe(e){se&&de&&e&&Ue&&D.multiTenantMgt([e],l.getRoots(ce),function(t){t.isMultiTenant||de.loadMarkupContext(e)})}this.setActiveState=async function(e){const t=()=>D.get3DSpaceUrl(),r=()=>D.getPlatformId(),a=()=>C.getSetting("pad_security_ctx");let d,u,v,S;if(v={_Markup:function(e){se&&de&&e&&D.multiTenantMgt([e],l.getRoots(ce),function(t){t.isMultiTenant||de.loadReview(e)})},_DMUMarkupRepReference:function(e){se&&de&&e&&D.multiTenantMgt([e],l.getRoots(ce),function(t){t.isMultiTenant||de.loadReview(e)})},...T.getDelegation(ce,function(){k.fireEvent("onApplyingSlideView")})},e!==se){if(se=e){q||(q=x.getLoadingContextController({context:ce}));let e=function(e){return new Promise((n,o)=>{let i=t()+"/resources/dictionary/getTypeInfo?tenant="+r(),l=a();require("DS/WAFData/WAFData").authenticatedRequest(i+"&SecurityContext="+l,{method:"POST",type:"json",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:l},data:JSON.stringify(e),onComplete:function(e){n(e)},onFailure:function(e){o(e)},onTimeout:function(e){o(e)}})})};try{let t=await e(be);Object.keys(t).forEach(e=>{v["_"+e]=Xe}),ce.setLoadingDelegations(v)}catch{be.forEach(e=>{v["_"+e]=Xe}),ce.setLoadingDelegations(v)}(re=V.getSelectionManager({context:ce})).setActiveState(!0),oe={activated:ce.getViewer().picking.activated,trapSelection:ce.getViewer().picking.trapSelection,trapGPU:ce.getViewer().picking.trapGPU},ie={activated:ce.getViewer().pPicking.activated},ce.getViewer().setPicking({activated:!0,trapSelection:!0,trapGPU:!0}),ce.getViewer().setPrePicking({activated:!0}),k=o.getEventsController({viewer:ce.getViewer()}),F.subscribe({event:"ENXViews/WelcomePanel/openContent"},async e=>{let t=e.unserializedData?e.unserializedData.data.items:null;if(t&&t.length>1)for(const e of t){const t=await Ae(e.objectType);if(!t.includes("VPMReference")&&!t.includes("R2V_FeatureState")){Ue=!1,Pe("warning",L.dropMultiNoAutorized);break}}}),me.onDMUMarkupApplicativeContextLoaded=k.addEvent("onDMUMarkupApplicativeContextLoaded",function(e){e.markupHasApplicativeContext&&de.publish("onReviewContextModified",{type:"ITF",onABReady:ye})}),me.onDMUMarkupApplicativeContextCleaned=k.addEvent("onDMUMarkupApplicativeContextCleaned",function(){de.publish("onReviewContextModified",{type:"3D",onABReady:ye})}),me.onDMUMarkupApplicativeContextCleaned=k.addEvent("onDMUApplicativeContextClean",function(e){require(["DS/PIMwebViewController/PIMwebItfCtrl"],function(t){t.cleanApplicativeContext(e.applicativeContext,ce)})}),me.onDMUObjectDeleted=k.addEvent("onDMUObjectDeleted",function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&"DMUTemporaryBag"!==e.dmuObject.getParent().getType()&&Oe(),e&&e.dmuObject&&("DMUCompare3D"===e.dmuObject.getType()||"DMUCompare2D"===e.dmuObject.getType())&&ye()}),me.onReviewRemoved=k.addEvent("onReviewRemoved",function(){ce.elements.container.removeEventListener("drop",je),ce.setLoadingDelegations(v)}),me.onDMUObjectInitialized=k.addEvent("onDMUObjectInitialized",function(e){if(e&&e.dmuObject&&(e.dmuObject.getParent()&&"DMUTemporaryBag"!==e.dmuObject.getParent().getType()&&Oe(),"DMUMarkup"===e.dmuObject.getType()))if(ce.elements.container.removeEventListener("drop",je),"2DFL"===j){ce.elements.container.addEventListener("drop",je);var t={_EleLogicalRelay:Ne,_EleLogicalContact:Ne,_EleLogicalOperatingDevice:Ne,_EleLogicalSingleConnector:Ne,_EleLogicalInlineConnector:Ne,_EleLogicalShellConnector:Ne,_EleLogicalSplice:Ne,_EleLogicalTerminalBoard:Ne,_EleLogicalBusbar:Ne,_EleLogicalHarness:Ne,_EleLogicalNet:Ne,_EleLogicalNetGroup:Ne,_EleLogicalWire:Ne,_EleLogicalWireShield:Ne,_EleLogicalCable:Ne,_EleLogicalCableShielded:Ne,_EleLogicalCableTwisted:Ne,_EleLogicalCableTwistedShielded:Ne,_EleLogicalOverShield:Ne,_EleLogicalPowerCable:Ne,_EleLogicalCoaxCable:Ne,_EleLogicalCableGroup:Ne,_EnsLogicalEquipment:Ne,_EnsInCLoop:Ne,_EnsInCLogicalRoute:Ne,_EnsInCLogicalBranch:Ne,_EnsInCLogicalComponent:Ne,_Piping_Logical_Miscellaneous:Ne,_Piping_Logical_Branch:Ne,_Piping_Logical_Instrument:Ne,_Piping_Logical_Reducer:Ne,_Piping_Logical_Valve:Ne,_Piping_Logical_Pipe:Ne,_Piping_Line:Ne,_ICLoop_Line:Ne,_HVAC_Logical_Miscellaneous:Ne,_HVAC_Logical_Branch:Ne,_HVAC_Logical_Instrument:Ne,_HVAC_Logical_Reducer:Ne,_HVAC_Logical_Damper:Ne,_HVAC_Logical_Duct:Ne,_HVAC_Line:Ne};ce.setLoadingDelegations(Object.assign({},t,v))}else ce.setLoadingDelegations(v)}),me.onDMUMarkupCreationSucceeded=k.addEvent("onDMUMarkupCreationSucceeded",function(){De=!0,Oe()}),me.onSlideApplicativeContextModified=k.addEvent("onSlideApplicativeContextModified",function(e){e&&e.dmuObject&&("DMUSlide"===e.dmuObject.getType()||"DMUFormat"===e.dmuObject.getType())&&Oe()}),me.onDMUOccOverloadRemoved=k.addEvent("onDMUOccOverloadRemoved",Oe),me.onDMUSlideSessionInfoChanged=k.addEvent("onDMUSlideSessionInfoChanged",function(e){e&&e.dmuObject&&("DMUSlide"===e.dmuObject.getType()||"DMUFormat"===e.dmuObject.getType())&&Le()}),me.onDMUSlideNameChanged=k.addEvent("onDMUSlideNameChanged",Le),me.onSaveRequested=k.addEvent("onSaveRequested",Le),me.onDMUCurrentSlideChanged=k.addEvent("onDMUCurrentSlideChanged",ye),me.onComparisonStarted=k.addEvent("onComparisonStarted",function(e){e&&e.is2DCompare&&(Me=!0),ye()}),me.onComparisonEnded=k.addEvent("onComparisonEnded",function(){Me=!1,ye()}),me.onFormatsEditionModeStarted=k.addEvent("onFormatsEditionModeStarted",function(){de.publish("onReviewContextModified",{type:j+"Formats",onABReady:ye})}),me.onFormatsEditionModeEnded=k.addEvent("onFormatsEditionModeEnded",function(){de.publish("onReviewContextModified",{type:"RefreshAB",onABReady:ye})}),me.onReviewCtxInformationChanged=k.addEvent("onReviewCtxInformationChanged",function(e){e&&e.reviewId&&ce&&ce.getWidget()&&ce.getWidget().dispatchEvent("onDMUMarkupLoaded",{reviewID:e.reviewId,reviewType:e.reviewType})}),me.onDMUObjectReadOnlyFlagChanged=k.addEvent("onDMUObjectReadOnlyFlagChanged",function(e){"Markup"===e.dmuObject.getAttribute("sType")&&ye()}),me.onDMUObjectActiveFlagChanged=k.addEvent("onDMUObjectActiveFlagChanged",ye),me.onDMUObjectVisibleFlagChanged=k.addEvent("onDMUObjectVisibleFlagChanged",ye),me.onApplicativeContextCommandsRequired=k.addEvent("onApplicativeContextCommandsRequired",function(e){de.publish("onReviewContextModified",{type:"Data",data:e,onABReady:e.cb})}),me.on2DDocumentLoadSuccess=k.addEvent("on2DDocumentLoadSuccess",function(){ye(),ae=!1}),me.onDXFLoadSuccess=k.addEvent("onDXFLoadSuccess",function(){Ie("2D")});if(require(["DS/PIMwebViewController/PIMwebItfCtrl"],function(e){var t=e.getLoaderForMarkup({context:ce});t.subscribe("onDMUCtxtLoadingSuccess",function(){Ie("ITF")}),t.subscribe("onDMUCtxtRemoved",function(){o.getReviewContext({context:ce})&&o.removeReviewContext({context:ce}),Ie("3D")})}),W=n.getLoadMarkupServices({context:ce}),H=ce.getFrameWindow().getActionBar().onActionBarReady(ye),(B=i.getManager({name:"DMU2DSheetManager",context:ce.getFrameWindow()}))||(B=new g({ctxViewer:ce}),i.addManager({name:"DMU2DSheetManager",context:ce.getFrameWindow(),manager:B})),ee||(ee=p.getDMUCommentsController({context:ce.getFrameWindow(),commandContext:ce?ce.getCommandContext():null})),X||(X=new m({context:ce})),ge.onApplyFilterBegin=ce.subscribe({event:"onBeginFilterApplied"},He),ge.onFilterApplied=ce.subscribe({event:"onFilterApplied"},Be),ge.onLoadingFailure=ce.subscribe({event:"onLoadingFailure"},Be),ge.onApplyFilterBegin=ce.subscribe({event:"onBeginFilterRemoved"},He),ge.onFilterApplied=ce.subscribe({event:"onFilterRemoved"},Be),ge.onRootAdded=ce.subscribe({event:"onRootAdded"},ke),ge.onRootAdded=ce.subscribe({event:"onR2VLoaded"},_e),ge.onRootRemoved=ce.subscribe({event:"onRootRemoved"},We),ge.onRootAttached=ce.subscribe({event:"onRootAttached"},ke),ge.onRootDetached=ce.subscribe({event:"onRootDetached"},We),ge.onRefresh=ce.subscribe({event:"onRefresh"},()=>{he=!0}),ge.onRefreshBegin=ce.subscribe({event:"onRefreshBegin"},()=>{te=!0,he||(ce.unsubscribe(ge.onRootRemoved),ge.onRootRemoved=-1)}),ge.onRefreshCompleted=ce.subscribe({event:"onRefreshCompleted"},function(){te=!1,he?he=!1:ge.onRootRemoved=ce.subscribe({event:"onRootRemoved"},We)}),pe=ce.getViewer().onSwapVisibleSpace(ye),z=f.getDMUApplicativeContextManager({context:ce}),(u=o.getReviewContext({context:ce}))&&u.getCurrentSessionMarkup()){var h=!1,P=u.getReviewCtxInformation();if(P&&P.contextId){var R=ce.getRootBagPath().getChildrenPathes(),y=null;for(ce.getApplicativeData().getLoadedItfData&&ce.getApplicativeData().getLoadedItfData().data.length>0&&(y=ce.getApplicativeData().getLoadedItfData().data[0].isrID),d=0;d<R.length;d++){var I=l.getNodeID(R[d].getLastElement(!0));if(ce.getController().isFiltered(I).filterId&&(I=ce.getController().isFiltered(I).filterId),I===P.contextId||y===P.contextId){u.getCurrentSessionMarkup().setActiveFlag(!0),!1!==P.modifiable&&u.setReadOnly(!1),h=!0;break}}h||u.setCurrentSessionMarkup(null)}}Z=ce.getViewer().sectionCappingEnabled,ce.getViewer().setSectionCapping(!0),(K=ce.isRobotVisible())&&ce.setRobotVisibility(!1),ce.getFrameWindow().getContextualUIManager().registerUnshift({subscriberId:"3DReviewWebAppCtxElements",workbenchName:"DMU3DReviewController",context:ce.getCommandContext(),module:"DMU3DReviewController",cmdPrefix:"",directory:"assets/afr/",merge:!0,onContextualBarReady:Re,onContextualMenuReady:xe}),(J=ce.isDefaultContextualBarVisible())&&ce.setDefaultContextualBarVisibility(!1),(Q=ce.isDefaultContextualMenuVisible())&&ce.setDefaultContextualMenuVisibility(!1),(Y=ce.isOpenWithMenuAvailable())||ce.setOpenWithMenuAvailability(!0),M.setSlidePreferences({context:ce.getFrameWindow(),preferences:{displayNominal:!0}}),ce.getRootBagPath()&&ce.getRootBagPath().getChildrenPathes().length&&Ve({path:ce.getRootBagPath().getChildrenPathes()[0]}),function(){var e=U.getPreferenceManager({context:ce.getFrameWindow()});if(e){if(e.setUnitsPreferencesDisplayFlag(!0),e.setDisplayPreferencesDisplayFlag(!0),e.set3DSelectionPreferencesDisplayFlag(!0),e.set2DSelectionPreferencesDisplayFlag(!0),e.setExportPreferencesDisplayFlag(!0),e.addPreferences([{nls:L.preferences.markupSectionTitle,id:"MarkupPreferences",type:"section",preferences:[{nls:L.preferences.QuickCreationLbl,id:"DMUDisplayMarkupCreationDialog",type:"checkbox",getValue:function(){return"false"!==localStorage.getItem("DMUDisplayMarkupCreationDialog")},getDefaultValue:function(){return!0},setValue:function(e){e!==("false"!==localStorage.getItem("DMUDisplayMarkupCreationDialog"))&&(localStorage.setItem("DMUDisplayMarkupCreationDialog",e?"true":"false"),k&&k.fireEvent("onDMUPreferencesChanged",{DMUDisplayMarkupCreationDialog:e}))}},{nls:L.preferences.automaticallyCreateFirstSlide,id:"DMUCreateFirstSlide",type:"checkbox",getValue:function(){return"false"!==localStorage.getItem("DMUCreateFirstSlide")},getDefaultValue:function(){return!0},setValue:function(e){e!==("false"!==localStorage.getItem("DMUCreateFirstSlide"))&&(localStorage.setItem("DMUCreateFirstSlide",e?"true":"false"),k&&k.fireEvent("onDMUPreferencesChanged",{DMUCreateFirstSlide:e}))}}]},{nls:L.preferences.slideSectionTitle,id:"SlidePreferences",type:"section",preferences:[{nls:L.preferences.slideNameFromFeature,id:"DMUSlideNameFromFeature",type:"checkbox",getValue:function(){return"false"!==localStorage.getItem("DMUSlideNameFromFeature")},getDefaultValue:function(){return!0},setValue:function(e){e!==("false"!==localStorage.getItem("DMUSlideNameFromFeature"))&&(localStorage.setItem("DMUSlideNameFromFeature",e?"true":"false"),k&&k.fireEvent("onDMUPreferencesChanged",{DMUSlideNameFromFeature:e}))}},{nls:L.preferences.slideTitleDisplayLbl,id:"DMUDisplaySlideTitle",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("DMUDisplaySlideTitle")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("DMUDisplaySlideTitle"))&&(localStorage.setItem("DMUDisplaySlideTitle",e?"true":"false"),k&&k.fireEvent("onDMUPreferencesChanged",{DMUDisplaySlideTitle:e}))}},{nls:L.preferences.slideCaptureSpecLayers,id:"DMUCaptureSpecLayers",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("DMUCaptureSpecLayers")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("DMUCaptureSpecLayers"))&&(localStorage.setItem("DMUCaptureSpecLayers",e?"true":"false"),k&&k.fireEvent("onDMUPreferencesChanged",{DMUCaptureSpecLayers:e}))}},{nls:L.preferences.slideEnableDrag,id:"DMUEnableSlideDragContent",type:"radio",getValue:function(){return localStorage.getItem("DMUEnableSlideDragContent")||"0"},getDefaultValue:function(){return"0"},setValue:function(e){e!==localStorage.getItem("DMUEnableSlideDragContent")&&(localStorage.setItem("DMUEnableSlideDragContent",e),k&&k.fireEvent("onDMUPreferencesChanged",{DMUEnableSlideDragContent:e}))},options:[{id:"0",nls:L.preferences.enableReorder},{id:"1",nls:L.preferences.enableDragContent}]}]},{nls:L.preferences.handlesSectionTitle,id:"HandlesPreferences",type:"section",preferences:[{prefixnls:L.preferences.gridSpacingPrefix,suffixnls:L.preferences.gridSpacingSuffix,id:"DMUSnapHandlesToGrid",type:"checkbox+spinbox",disableSpinboxAtUncheck:!0,getValue:function(){return"false"!==localStorage.getItem("DMUSnapHandlesToGrid")},getSpinBoxValues:function(){var e=parseFloat(localStorage.getItem("DMUSnapHandlesGridValue")),t="mm",n=localStorage.getItem("CATWebUXPreferences_Units");return n&&n.length&&(t="foot"===(t=(n=JSON.parse(n)).Length.unit)?"inch":"cm"===t||"m"===t||"km"===t?"mm":t),e="inch"===t?b.convert(e,"Length","mm",t):e,{value:isNaN(e)?1:e,units:t,minValue:"mm"===t?1:.01,stepValue:"mm"===t?1:.01}},getDefaultValue:function(){return!0},getSpinBoxDefaultValues:function(){return{value:1,units:"mm",minValue:1,stepValue:1}},setValue:function(e){e!==("false"!==localStorage.getItem("DMUSnapHandlesToGrid"))&&(localStorage.setItem("DMUSnapHandlesToGrid",e?"true":"false"),k&&k.fireEvent("onDMUPreferencesChanged",{DMUSnapHandlesToGrid:e}))},setSpinBoxValue:function(e){var t=parseFloat(localStorage.getItem("DMUSnapHandlesGridValue"));e!==(t=isNaN(t)?1:t)&&(localStorage.setItem("DMUSnapHandlesGridValue",e),k&&k.fireEvent("onDMUPreferencesChanged",{DMUSnapHandlesGridValue:e}))}},{prefixnls:L.preferences.rotSnappingPrefix,suffixnls:"("+L.preferences.rotSnappingSuffix+")",id:"DMUSnapRotationToggle",type:"checkbox+spinbox",disableSpinboxAtUncheck:!1,getValue:function(){return"false"!==localStorage.getItem("DMUSnapRotationToggle")},getSpinBoxValues:function(){var e=parseFloat(localStorage.getItem("DMUSnapRotationAngle")),t="deg",n=localStorage.getItem("CATWebUXPreferences_Units");return n&&n.length&&(t=(n=JSON.parse(n)).Angle.unit),e="rad"===t?b.convert(e,"Angle","deg",t):e,{value:isNaN(e)?90:e,units:t,minValue:"deg"===t?1:.01,stepValue:"deg"===t?1:.01}},getDefaultValue:function(){return!0},getSpinBoxDefaultValues:function(){return{value:90,units:"deg",minValue:1,maxValue:360,stepValue:1}},setValue:function(e){e!==("false"!==localStorage.getItem("DMUSnapRotationToggle"))&&(localStorage.setItem("DMUSnapRotationToggle",e?"true":"false"),k&&k.fireEvent("onDMUPreferencesChanged",{DMUSnapRotationToggle:e}))},setSpinBoxValue:function(e){var t=parseFloat(localStorage.getItem("DMUSnapRotationAngle"));e!==(t=isNaN(t)?90:t)&&(localStorage.setItem("DMUSnapRotationAngle",e),k&&k.fireEvent("onDMUPreferencesChanged",{DMUSnapRotationAngle:e}))}}]},{nls:L.preferences.compareSectionTitle,id:"ComparePreferences",type:"section",preferences:[{nls:L.preferences.firstProductColor,id:"DMUCompareFirstColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompareFirstColor")?localStorage.getItem("DMUCompareFirstColor"):"#FF0000"},getDefaultValue:function(){return"#FF0000"},setValue:function(e){localStorage.setItem("DMUCompareFirstColor",e),k&&k.fireEvent("onDMUPreferencesChanged",{DMUCompareFirstColor:e})}},{nls:L.preferences.secondProductColor,id:"DMUCompareSecondColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompareSecondColor")?localStorage.getItem("DMUCompareSecondColor"):"#00FF00"},getDefaultValue:function(){return"#00FF00"},setValue:function(e){localStorage.setItem("DMUCompareSecondColor",e),k&&k.fireEvent("onDMUPreferencesChanged",{DMUCompareSecondColor:e})}},{nls:L.preferences.compare3DCommonColor,id:"DMUCompare3DCommonColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompare3DCommonColor")?localStorage.getItem("DMUCompare3DCommonColor"):"#D3D3D3"},getDefaultValue:function(){return"#D3D3D3"},setValue:function(e){localStorage.setItem("DMUCompare3DCommonColor",e),k&&k.fireEvent("onDMUPreferencesChanged",{DMUCompare3DCommonColor:e})}},{nls:L.preferences.compare2DCommonColor,id:"DMUCompare2DCommonColor",type:"color",getValue:function(){return localStorage.getItem("DMUCompare2DCommonColor")?localStorage.getItem("DMUCompare2DCommonColor"):"#000000"},getDefaultValue:function(){return"#000000"},setValue:function(e){localStorage.setItem("DMUCompare2DCommonColor",e),k&&k.fireEvent("onDMUPreferencesChanged",{DMUCompare2DCommonColor:e})}}]}]),e.addPreferences(A.getCommonPreferencesDefinition()),e.setPreferredPreferenceContainersOrder(["MarkupPreferences","SlidePreferences","HandlesPreferences","MeasurePreferences","PIMwebPrefLoad","PIMwebPrefDisplay","SectionPreferences","ComparePreferences"]),ce.getViewer().get2DMode()){var t=b.getPreference("CATWebUXPreferences_Select2DGeometry","boolean");re&&re.setPicking(t?0:1)}else{var n=b.getPreference("CATWebUXPreferences_GravitationalEffects","boolean");"boolean"==typeof n&&(ce.getViewer().currentViewpoint.getControl().setRotationRolling(!n),ce.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!n));var o=b.getPreference("CATWebUXPreferences_ProjectionType","int");0!==o&&1!==o||ce.getViewer().currentViewpoint.setProjectionType(o);var i=b.getPreference("CATWebUXPreferences_Select3DGeometry","boolean");re&&re.setPicking(i?0:1);let e=b.getPreference("CATWebUXPreferences_SelectParentReferenceOr3DShape","string");re&&re.selectParentReference("select3DShape"!==e)}fe&&!fe.CATWebUXPreferences_GravitationalEffects&&(fe.CATWebUXPreferences_GravitationalEffects=e.subscribe("CATWebUXPreferences_GravitationalEffects",function(e){ce&&ce.getViewer()&&ce.getViewer().currentViewpoint&&ce.getViewer().currentViewpoint.control&&!ce.getViewer().get2DMode()&&(ce.getViewer().currentViewpoint.getControl().setRotationRolling(!e),ce.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!e))}),fe.CATWebUXPreferences_ProjectionType=e.subscribe("CATWebUXPreferences_ProjectionType",function(e){ce&&ce.getViewer()&&ce.getViewer().currentViewpoint&&!ce.getViewer().get2DMode()&&ce.getViewer().currentViewpoint.setProjectionType(e)}),fe.CATWebUXPreferences_Select3DGeometry=e.subscribe("CATWebUXPreferences_Select3DGeometry",function(e){re&&!ce.getViewer().get2DMode()&&re.setPicking(e?0:1)}),fe.CATWebUXPreferences_Select2DGeometry=e.subscribe("CATWebUXPreferences_Select2DGeometry",function(e){re&&ce.getViewer().get2DMode()&&re.setPicking(e?0:1)}),fe.CATWebUXPreferences_SelectParentReferenceOr3DShape=e.subscribe("CATWebUXPreferences_SelectParentReferenceOr3DShape",function(e){re&&re.selectParentReference("select3DShape"!==e)}))}}()}else{var w;if(V.unreferenceSelectionManager({context:ce}),re=null,$&&$.destroy(),oe&&ce.getViewer().setPicking(oe),ie&&ce.getViewer().setPrePicking(ie),ie=null,ie=null,ce.elements.container.removeEventListener("drop",je),S=U.givePreferenceManager({context:ce.getFrameWindow()})){for(w=Object.keys(fe),d=0;d<w.length;d++)S.unsubscribe(fe[w[d]]);fe={},S.removePreferences(["MarkupPreferences","HandlesPreferences"])}if(U.unreferencePreferenceManager({context:ce.getFrameWindow()}),Ee&&(clearTimeout(Ee),Ee=null),ce.setLoadingDelegations({}),ce.getFrameWindow().getActionBar().removeCallback(H),ce.getFrameWindow().getContextualUIManager().unregister("3DReviewWebAppCtxElements"),void 0!==J&&ce.setDefaultContextualBarVisibility(J),J=void 0,void 0!==Q&&ce.setDefaultContextualMenuVisibility(Q),Q=void 0,void 0!==Y&&ce.setOpenWithMenuAvailability(Y),Y=void 0,void 0!==K&&ce.setRobotVisibility(K),K=void 0,void 0!==Z&&ce.getViewer().setSectionCapping(Z),Z=void 0,f.unreferenceDMUApplicativeContextManager({context:ce}),z=null,u=o.getReviewContext({context:ce}),B.isADocumentDisplayed())if(ve)u&&u.getCurrentSessionMarkup()?u.setReadOnly(!0):B.removeDMUEvents();else{B.clean2DDocument(),ee&&ee.cleanCommentsPanel();for(var E=[],O=l.getRoots(ce),_=0;_<O.length;_++)E.push(l.getNodeID(O[_]));ce.removeRoots({pids:E})}else u&&u.getCurrentSessionMarkup()&&(ve?u.setReadOnly(!0):u.getCurrentSessionMarkup().setActiveFlag(!1));for(s.empty(),c.empty(),w=Object.keys(ge),d=0;d<w.length;d++)ce.unsubscribe(ge[w[d]]);if(ge={},k){for(w=Object.keys(me),d=0;d<w.length;d++)k.removeEvent(me[w[d]]);o.unreferenceEventsController({viewer:ce.getViewer()}),k=null}me={},X&&(X.clean(),X=null),ve||(i.removeManager({name:"DMU2DSheetManager",context:ce.getFrameWindow()}),B=null,ee&&(ee=p.unreferenceDMUCommentsController({context:ce.getFrameWindow()}),ee=null)),q&&(x.unreferenceLoadingContextController({context:ce}),q=null),pe&&(ce.getViewer().unsubscribe(pe),pe=null),n.unreferenceLoadMarkupServices({context:ce}),W=null}ye()}},this.disableDMUContextualBar=function(){Ce=!1,ce.getFrameWindow().getContextualUIManager().getContextualBar().hide()},this.enableDMUContextualBar=function(){Ce=!0},this.subscribe=function(e,t){if(e&&t&&ue)return ue.subscribe({event:e},t)},this.unsubscribe=function(e){ue&&e&&ue.unsubscribe(e)},this.getActiveState=function(){return se},this.clearController=function(){de.setActiveState(!1),$=ce=de=ue=ge=B=ae=null},this.loadReview=function(e){var t=!1,n=o.getReviewContext({context:ce});if(n){var i=n.getReviewCtxInformation();t=i&&i.reviewId===e.objectId}e.objectId&&!1===t&&W&&W.load(e)},this.loadMarkupContext=async function(e){var t=!1,n=o.getReviewContext({context:ce});if(n){var i=n.getReviewCtxInformation();t=i&&i.contextId===e.objectId}const r=await Ae(e.objectType);if(e.objectId&&!t&&B||r&&r.length&&-1!==r.indexOf("SIMItfSimulation")){if(G===e.objectId)return void ce.displayNotification({msg:L.documentAlreadyLoaded,eventID:"info"});var a;r&&r.length&&["SIMItfSimulation","PLMPIMMetricReference","Document","DIFLayout","DIFSheet","DIFAnnotationSet","Requirement","Requirement Specification","DesignSight"].some(function(e){if(-1!==r.indexOf(e))return a=e,!0})?(e.objectParentType=a||e.objectType,q.load({data:e}),-1!==r.indexOf("Document")&&(ae=!0)):Ve({docData:e})}},this.loadValidation=function(e){var t=!1,n=o.getReviewContext({context:ce});n&&(t=n.checkCurrentReviewInSession(e)),e&&!1===t&&W&&W.loadValidation(e)};var qe,Ge,ze=(qe=["VPMReference","Drawing","ENOStrRefinementSpecification"].concat(be),Ge={},async function(e,t){if(qe.indexOf(e)>-1)return t(e);if(void 0!==Ge[e])return t(Ge[e]?Ge[e]:void 0);const n=await Ae(e);Ge[e]=null,qe.some(function(t){if((n||[]).indexOf(t)>-1)return Ge[e]=t,!0}),t(Ge[e]?Ge[e]:void 0)});function Je(e,t){return e.reduce(function(e,n){return e.then(function(e){return new Promise(function(o){ze(n.type,function(i){t.indexOf(i)>=0&&e.push(n),o(e)})})})},Promise.resolve([]))}this.appInitFromTransition=function(t){var n;return new e.Promise(function(e,i){var a,s,c,d,u,g,p=t.x3dContent,m=l.getRoots(ce);if(t.issues&&1===t.issues.length)p=null,a=t.issues[0].physicalid,c=require("DS/PADUtils/PADUtilsServices").getPlatformId(),d=t.issues[0].title,u=t.issues[0].description,g=t.issues[0].attachments;else if(p&&p.data&&p.data.items&&!m.length)for(s=0;s<p.data.items.length;++s)if("Issue"===p.data.items[s].objectType){if(a){a=null;break}a=p.data.items[s].objectId,c=p.data.items[s].envId,d=p.data.items[0].displayName}a?((n=new h).display({modal:!0,frmWindow:ce.getFrameWindow(),type:"load",message:d}),require(["DS/IssueServices/services/PlatformServices","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices"].concat([]),function(t,n,s,m){s.add("widget",window.widget),t.getSecurityContext=function(){return require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx").replace("ctx::","")},t.getTenant=function(){return c},t.initPlatformServices().then(function(){R._sendUsageProbe("loadFromIssue",p?"x3dContent":"transition"),(g?new Promise(function(e){e({attachments:g})}):n.getDocumentsFrom(a)).then(function(t){var s=0,g=0,f=0;if(t&&t.attachments&&t.attachments.length&&t.attachments.forEach(function(e){!e||"Markup"!==e.type&&"DMUMarkupRepReference"!==e.type||(g++,s=e.id,f=e.type)}),g>1)return R._sendUsageProbe("loadFromIssue",(p?"x3dContent":"transition")+"_Markup"+g),void e();if(1===g&&s){var D=o.getReviewContext({context:ce}),C=D?D.getReviewCtxInformation():{};if(C&&C.reviewId===s)C.fromIssue=a,e(!0);else if(k){var v=k.addEvent("onDMUMarkupLoaded",function(){k.removeEvent(v);var t=o.getReviewContext({context:ce}).getReviewCtxInformation();t&&(t.fromIssue=a),R._sendUsageProbe("loadFromIssue",(p?"x3dContent":"transition")+"_Markup"),e(!0)});p?(p.data.items=[{objectId:s,objectType:f,envId:c,serviceId:p.data.items[0].serviceId,contextId:p.data.items[0].contextId}],ce.addRootNodesFromContent({json3DXContent:p})):W&&W.loadIfContextLoaded({objectId:s,objectType:f}).then(function(t){t||(k.removeEvent(v),R._sendUsageProbe("loadFromIssue","transition_Markup_ContextNotLoaded"),e(!0))})}}else new Promise(function(e){p?m.issues.retrieve({data:{objects:[{physicalId:a}]}}).then(function(t){(t=t.results)&&1===t.length&&t[0]&&t[0].body&&(t[0].body.reportedAgainst.length||t[0].body.contexts.length)?(d=t[0].body.title,u=t[0].body.description,Je(t[0].body.reportedAgainst,["Drawing"].concat(be)).then(function(e){return e.length?(e.length=1,e):Je(t[0].body.contexts,["VPMReference","ENOStrRefinementSpecification"]).then(function(e){return e.length?e:Je(t[0].body.reportedAgainst,["VPMReference"])})}).then(function(t){if(0!==t.length){var n=[];"Drawing"===t[0].type?k&&(n.push(k.addEvent("on2DDocumentLoadSuccess",function(){n.forEach(k.removeEvent,k),e(!0)})),n.push(k.addEvent("on2DDocumentLoadFailure",function(){n.forEach(k.removeEvent,k),e(!1)}))):(n.push(ce.subscribe({event:"onLoadingComplete"},function(){n.forEach(ce.unsubscribe,ce),e(!0)})),n.push(ce.subscribe({event:"onLoadingFailure"},function(){n.forEach(ce.unsubscribe,ce),e(!1)})));var o=p.data.items[0];p.data.items=t.map(function(e){return{objectId:e.physicalid||e.physicalId,objectType:e.type,envId:c,serviceId:o.serviceId,contextId:o.contextId}}),ce.addRootNodesFromContent({json3DXContent:p})}else e(!1)})):e(!1)}):e(!0)}).then(function(t){if(t)if(l.getRoots(ce).length)if(k){var i=[],s=function(){i.forEach(k.removeEvent,k)};i.push(k.addEvent("onDMUMarkupCreationCancelled",function(){s(),e(!0)})),i.push(k.addEvent("onDMUMarkupCreationFailed",function(){s(),e(!0)})),i.push(k.addEvent("onDMUMarkupCreationSucceeded",function(){s(),R._sendUsageProbe("command","CreateMarkupFromIssue");var t=o.getReviewContext({context:ce}).getReviewCtxInformation();n.connectDocumentToParent(t.reviewId,a).then(function(){t.fromIssue=a,ce.displayNotification({msg:L.markupAttachedToIssue,eventID:"success"}),e(!0)}).catch(function(){ce.displayNotification({msg:L.markupNotAttachedToIssue,eventID:"warning"}),e(!0)})})),new Promise(function(e){var t=r.getCommand("DMUMarkupCreationForTransitionHdr");t?e(t):require(["DS/DMUPersistence/DMUCreateMarkupCmd"],function(t){e(new t({ID:"DMUMarkupCreationForTransitionHdr",frameWindow:ce.getFrameWindow()}))})}).then(function(e){e.setDefaultInfo({title:d,description:u}),e.begin()})}else e(!0);else e(!0);else e(!1)}).catch(i)}).catch(i)}).catch(i)},i)):e()}).then(function(e){e||t.onNoActionDone()}).catch(t.onNoActionDone).finally(function(){n&&n.destroy()})},this.refreshContext=function(){var e=o.getReviewContext({context:ce});e&&(e.refreshNode(),ce.getViewer().render())},this.publish=function(e,t){se&&setTimeout(function(){ue&&ue.publish({event:e,data:t,context:de})})},this.setappTransition=function(e){ve=e}}}),_=[];return e.singleton({init:function(){},give3DReviewController:function(e){if(e&&e.context)for(var t=0;t<_.length;t++)if(_[t].context===e.context)return _[t].controller},get3DReviewController:function(e){var t;if(e&&e.context&&!(t=this.give3DReviewController(e))){var n=new O({ctxViewer:e.context});t=Object.freeze({setActiveState:async function(e){n&&await n.setActiveState(e)},getActiveState:function(){if(n)return n.getActiveState()},subscribe:function(e,t){if(n)return n.subscribe(e,t)},unsubscribe:function(e){n&&n.unsubscribe(e)},clearController:function(){n&&(n.clearController(),n=null)},loadReview:function(e){n&&n.loadReview(e)},appInitFromTransition:function(e){return n?n.appInitFromTransition(e):Promise.resolve()},loadValidation:function(e){n&&n.loadValidation(e)},refreshContext:function(){n&&n.refreshContext()},disableDMUContextualBar:function(){n&&n.disableDMUContextualBar()},enableDMUContextualBar:function(){n&&n.enableDMUContextualBar()},publish:function(e,t){n&&n.publish(e,t)},setappTransition:function(e){n&&n.setappTransition(e)}}),_.push({context:e.context,controller:t})}return t},unreference3DReviewController:function(e){if(e&&e.context)for(var t=0;t<_.length;t++)if(_[t].context===e.context){e.options&&e.options.appInfo&&"X3DPLAW_AP"===e.options.appInfo&&_[t].controller.setappTransition(!0),_[t].controller.clearController(),_.splice(t,1);break}}})});