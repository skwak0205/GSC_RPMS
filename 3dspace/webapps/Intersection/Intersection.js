define("DS/Intersection/VolumeIntersection",["DS/Mesh/ThreeJS_Base","DS/Mesh/Mesh"],function(e,t){"use strict";var r=function(r,i,n,o,a,c,s,l,u,g,p,y){var f=new e.Vector3,d=new e.Vector3,m=new e.Vector3,h=new e.Sphere,v=i.vertexIndexArray;if(!i.vertexIndexArray)return console.log("Warning: no CPU picking in noMeshInRam"),0;!function(e,r,i,n,o,a,c){if(!a.vertexIndexArray)return console.log("Warning: no CPU picking in noMeshInRam"),0;for(var s=a.drawingGroups,l=0;l<s.length;l++){var u=s[l],g=0;switch(u.glType){case 4:case 5:if(!r)continue;g=3;break;case 1:if(!n)continue;g=2;break;case 0:if(!i)continue;g=1;break;default:continue}var p=null;o.layer&&(p=o.layer.getIntervals(geometry,u));for(var y=new t.SGPrimitiveHelper,f=0;f<u.getPrimitivesCount();f++){if(y.set(u,f),null!==p){for(var d=!1,m=p.length-1;m>=0;m--)if(p[m].start<=y.getStart()){p[m].skip(o,c)&&(d=!0);break}if(d)continue}if(e(g,y))return}}}(function(t,o){var a;switch(t){case 1:a=function(e){for(var t=!0,r=!1,o=e.getStart();o<e.getStart()+e.getCount();o++){i.getVertexPosition(v[o],f),f.applyMatrix4(g);var a=n.containsPoint(f);if(r=r||a,!(t=t&&a)&&r)break}return{insideb:t,partialb:r}}(o);break;case 2:a=function(t){for(var r=!0,o=!1,a=t.getStart();a<t.getStart()+t.getCount();a+=2){i.getVertexPosition(v[a],f),f.applyMatrix4(g),i.getVertexPosition(v[a+1],d),d.applyMatrix4(g);var c=n.containsPoint(f),s=n.containsPoint(d);if((r=r&&c&&s)?o=!0:(h.setFromCenterAndPoints(new e.Vector3((f.x+d.x)/2,(f.y+d.y)/2,(f.z+d.z)/2),[f,d]),o=o||c||s||n.intersectsSphere(h)&&n.intersectsLine([f,d])),!r&&o)break}return{insideb:r,partialb:o}}(o);break;case 3:a=function(t){for(var r=!0,o=!1,a=t.getStart();a+2<t.getStart()+t.getCount();a++){i.getVertexPosition(v[a],f),f.applyMatrix4(g),i.getVertexPosition(v[a+1],d),d.applyMatrix4(g),i.getVertexPosition(v[a+2],m),m.applyMatrix4(g);var c=n.containsPoint(f),s=n.containsPoint(d),l=n.containsPoint(m);if((r=r&&c&&s&&l)?o=!0:(h.setFromCenterAndPoints(new e.Vector3((f.x+d.x+m.x)/3,(f.y+d.y+m.y)/3,(f.z+d.z+m.z)/3),[f,d,m]),o=o||c||s||l||n.intersectsSphere(h)&&n.intersectsTriangle([f,d,m])),!r&&o)break}return{insideb:r,partialb:o}}(o);break;default:return void console.error("Error: requiredVectors can't be equal to 0")}var c={primitive:o.clone(),object:r};if(a.insideb)s.push(c);else{if(a.partialb)return u.push(c),p;l.push(c)}return!1},o,a,c,r,i,y)},i=function(e,t,i,n,o,a,c,s){if(!t.vertexIndexArray)return console.log("Warning: no CPU picking in noMeshInRam"),0;var l=[],u=[],g=[];return r(e,t,i,n,o,a,l,g,u,c,!0,s),u.length>0||g.length>0&&l.length>0?1:g.length>0?0:2};return{_meshIntersectVolume:function(t,r,n,o,a,c,s,l,u){if(!function(t,r,i,n){var o=new e.Sphere,a=t._getMMMatrix();return null!==t.boundingSphere&&o.copy(t.boundingSphere),o.applyMatrix4(a),r.containsSphere(o)?(n.push({object:t}),!0):!r.intersectsSphere(o)&&(i.push({object:t}),!0)}(t,r,s,c)){var g=t._getMMMatrix(),p=t.geometry;2===p._type&&(p=[p]);for(var y=0;y<p.length;y++){var f=p[y];switch(i(t,f,r,n,o,a,g,u)){case 0:s.push({object:t});break;case 1:l.push({object:t});break;case 2:c.push({object:t});break;default:return}}}}}}),define("DS/Intersection/IntersectionUtils",["DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh"],function(e,t){"use strict";var r,i,n,o,a,c,s,l,u,g=new e.Vector3,p=new e.Vector3,y=new e.Vector3;var f=new e.Vector3,d=new e.Sphere,m=function(e){return!!(e&&e.isGAS&&e._noPick)};return{checkWLayers:function(e,t,r,i,n){if(null!==e){for(var o=!1,a=e.length-1;a>=0;a--){var c=e[a];if(c.start<=t){let e=c.gas;e||(e=r),(c.skip(n,i)||m(e))&&(o=!0);break}}if(o)return!0}return!1},checkWLayersNoGAS:function(e,t){if(null!==e){for(var r=!1,i=e.length-1;i>=0;i--){var n=e[i];if(n.start<=t){n.skip(null,null)&&(r=!0);break}}if(r)return!0}return!1},checkGAS:m,checkRayToPrimitiveBoundingSphere:function(t,r,i,n){var o=t.getBoundingSphere();if(!o){var a=t.getRep();a&&(o=a.boundingSphere)&&(o=(new e.Sphere).setSimple(o.center[0],o.center[1],o.center[2],o.radius))}var c=o?o.radius+n:0;if(0===c)return!1;if(r._distanceFromIntersection(o.center)>c)return!0;if(i>0&&f.subVectors(o.center,r.origin).dot(r.direction)-c>i)return!0;return!1},computeUVCoords:function(t,r,i){var n=new e.Vector3;return n.x=t.x+u*(r.x-t.x)+l*(i.x-t.x),n.y=t.y+u*(r.y-t.y)+l*(i.y-t.y),n.z=t.z+u*(r.z-t.z)+l*(i.z-t.z),n},pointInFace3:function(e,t,f,d){return g.subVectors(d,t),p.subVectors(f,t),y.subVectors(e,t),r=g.dot(g),i=g.dot(p),n=g.dot(y),o=p.dot(p),a=p.dot(y),!((c=r*o-i*i)<1e-10)&&(u=(r*a-i*n)*(s=1/c),(l=(o*n-i*a)*s)>=0&&u>=0&&l+u<1)},checkFrustumToPrimitiveBoundingSphere:function(t,r,i){var n=t.getBoundingSphere();if(!n){var o=t.getRep();o&&(n=o.boundingSphere)&&(n=(new e.Sphere).setSimple(n.center[0],n.center[1],n.center[2],n.radius))}return!!n&&(d.center.set(n.center.x,n.center.y,n.center.z),d.radius=n.radius*i.getMaxScaleOnAxis(),d.center.applyMatrix4(i),!r.intersectsSphere(d))},filterDrawingGroup:function(e,t,r){if(e.isFiltered)return e.isFiltered(r,t);console.error("Unexpected class in filterDrawingGroup, expected Mesh.DrawingGroup");var i=t||e._geomType;return!((i&r)>0||0===i)},_screenWidth:0,_screenHeight:0,_projScreenMatrix:new e.Matrix4}}),define("DS/Intersection/RayFrustumUtils",["DS/Visualization/ThreeJS_R57","DS/Intersection/IntersectionUtils","DS/Mesh/Mesh"],function(e,t,r){"use strict";var i=new e.Vector3,n=new e.Vector3,o=new e.Vector3,a=new e.Vector3,c=new e.Vector3,s=new e.Vector3;return{intersectBufferGeom3DInsideFrustumMesh:function(e,n,o,c){var s=!1,l=n._getMMMatrix(),u=[],g=n.getFilterGeomType(),p=null,y=0;n.geometry.length>=0?(p=n.geometry[0],y=n.geometry.length):2===n.geometry._type&&(p=n.geometry,y=1);for(var f=new r.SGPrimitiveHelper,d=0;d<y;d++){for(var m=p.drawingGroups,h=p.vertexIndexArray,v=m.length,x=0;x<v;x++){var M=m[x];if(!t.filterDrawingGroup(M,g,o)){var S=null;if(n.layer&&(S=n.layer.getIntervals(p,M)),S||!t.checkGAS(M.gas))for(var V=M.getPrimitivesCount(),w=0;w<V;w++){f.set(M,w);var b=f.getCount(),P=f.getStart();if(!t.checkFrustumToPrimitiveBoundingSphere(f,b,e,l)&&!t.checkWLayers(S,P,M.gas,c))for(var I=P+b,_=P;_<I;_++)if(s=!0,p.getVertexPosition(h[_],i),a.copy(i),a.applyMatrix4(l),!e.containsPoint(a))return null}}}p=n.geometry[d+1]}return s?(u.push({object:n}),u):null},intersectBufferGeomZone3D:function(l,u,g,p,y,f,d){var m,h=[],v=g._getMMMatrix();g.matrixRotationWorld.extractRotation(v);var x,M=g.getFilterGeomType(),S=null,V=0;if(g.geometry.length>=0?(S=g.geometry[0],V=g.geometry.length):2===g.geometry._type&&(S=g.geometry,V=1),V&&(S.noMeshInRAM||!S.vertexIndexArray))return h;p||(x=!y);for(var w=new r.SGPrimitiveHelper,b=new e.Sphere,P=0;P<V;P++){for(var I=S.drawingGroups,_=S.vertexIndexArray,T=I.length,k=0;k<T;k++){var G=I[k];if((4==G.glType||5==G.glType)&&!t.filterDrawingGroup(G,M,f)){var R=null;if(g.layer&&(R=g.layer.getIntervals(S,G)),R||!t.checkGAS(G.gas)){for(var j=G.getPrimitivesCount(),z=0;z<j;z++){p&&!y&&(x=!0),w.set(G,z);var D=w.getCount(),A=w.getStart();if(!t.checkFrustumToPrimitiveBoundingSphere(w,D,u,v)&&!t.checkWLayers(R,A,G.gas,d)){for(var F=A+D,C=A;C<F;C++){if(S.getVertexPosition(_[C],i),S.getVertexPosition(_[C+1],n),S.getVertexPosition(_[C+2],o),a.copy(i),c.copy(n),s.copy(o),a.applyMatrix4(v),c.applyMatrix4(v),s.applyMatrix4(v),y){if(b.setFromCenterAndPoints(new e.Vector3((a.x+c.x+s.x)/3,(a.y+c.y+s.y)/3,(a.z+c.z+s.z)/3),[a,c,s]),u.intersectsSphere(b)&&u.intersectsTriangle([a,c,s])){p?(m={primitive:w.clone(),geometry:S,object:g},h.push(m)):x=!0;break}}else if(!(u.containsPoint(a)&&u.containsPoint(c)&&u.containsPoint(s))){x=!1;break}4==G.glType&&(C+=2)}if(p&&!y&&x)m={primitive:w.clone(),geometry:S,object:g},h.push(m);else if(!p&&y&&h.length)break}}if(!p&&(y&&x||!y&&!x))break}}}if(!p&&(y&&x||!y&&!x))break;S=g.geometry[P+1]}return!p&&x&&h.push({object:g}),h},intersectBufferGeomEdge3D:function(o,s,l,u,g,p){var y,f,d=[],m=s.getFilterGeomType(),h=s._getMMMatrix(),v=null,x=0;if(s.geometry.length>=0?(v=s.geometry[0],x=s.geometry.length):2===s.geometry._type&&(v=s.geometry,x=1),x&&(v.noMeshInRAM||!v.vertexIndexArray))return d;l||(f=!u);for(var M=new r.SGPrimitiveHelper,S=new e.Sphere,V=0;V<x;V++){for(var w=v.drawingGroups,b=v.vertexIndexArray,P=w.length,I=0;I<P;I++){var _=w[I];if(1===_.glType&&!t.filterDrawingGroup(_,m,g)){var T=null;if(s.layer&&(T=s.layer.getIntervals(v,_)),T||!t.checkGAS(_.gas)){for(var k=_.getPrimitivesCount(),G=0;G<k;G++){l&&(f=!0),M.set(_,G);var R=M.getCount(),j=M.getStart();if(!t.checkFrustumToPrimitiveBoundingSphere(M,R,o,h)&&!t.checkWLayers(T,j,_.gas,p)){for(var z=j+R,D=j;D<z;D+=2)if(v.getVertexPosition(b[D],i),v.getVertexPosition(b[D+1],n),a.copy(i),c.copy(n),a.applyMatrix4(h),c.applyMatrix4(h),u){if(S.setFromCenterAndPoints(new e.Vector3((a.x+c.x)/2,(a.y+c.y)/2,(a.z+c.z)/2),[a,c]),o.intersectsSphere(S)&&o.intersectsLine([a,c])){l?(y={primitive:M.clone(),geometry:v,object:s},d.push(y)):f=!0;break}}else if(!o.containsPoint(a)||!o.containsPoint(c)){f=!1;break}if(l&&!u&&f)y={primitive:M.clone(),geometry:v,object:s},d.push(y);else if(!l&&u&&d.length)break}}if(!l&&(u&&f||!u&&!f))break}}}if(!l&&(u&&f||!u&&!f))break;v=s.geometry[V+1]}return!l&&f&&d.push({object:s}),d},intersectBufferGeomPoint3D:function(e,n,o,c){var s,l=[],u=n.getFilterGeomType(),g=n._getMMMatrix(),p=null,y=0;if(n.geometry.length>=0?(p=n.geometry[0],y=n.geometry.length):2===n.geometry._type&&(p=n.geometry,y=1),y&&(p.noMeshInRAM||!p.vertexIndexArray))return l;for(var f=new r.SGPrimitiveHelper,d=0;d<y;d++){for(var m=p.drawingGroups,h=p.vertexIndexArray,v=m.length,x=0;x<v;x++){var M=m[x];if(0===M.glType&&!t.filterDrawingGroup(M,u,o)){var S=null;if(n.layer&&(S=n.layer.getIntervals(p,M)),S||!t.checkGAS(M.gas))for(var V=M.getPrimitivesCount(),w=0;w<V;w++){f.set(M,w);var b=f.getCount(),P=f.getStart();if(!t.checkFrustumToPrimitiveBoundingSphere(f,b,e,g)&&!t.checkWLayers(S,P,M.gas,c))for(var I=P+b,_=P;_<I;_++)p.getVertexPosition(h[_],i),a.copy(i),a.applyMatrix4(g),0===e.computeOutcode(a)&&(s={primitive:f.clone(),geometry:p,object:n},l.push(s))}}}p=n.geometry[d+1]}return l}}}),define("DS/Intersection/RayIntersectionUtils",["DS/Visualization/ThreeJS_R57","DS/Intersection/IntersectionUtils","DS/Mesh/Mesh"],function(e,t,r){"use strict";var i=new e.Vector3,n=new e.Vector3,o=new e.Vector3,a=new e.Vector3,c=new e.Vector3,s=new e.Vector3,l=new e.Vector3,u=new e.Vector3,g=new e.Vector3,p=new e.Vector3,y=new e.Vector3,f=new e.Vector3,d=new e.Vector3,m=new e.Vector3,h=new e.Vector3,v=new e.Vector3,x=new e.Vector3,M=new e.Vector3,S=new e.Vector3,V=new e.Vector3;return{intersectBufferGeomOptim:function(l,u,g,p,y,f){var h,w=[],b=g._getMMMatrix(),P=(new e.Matrix4).getInverse(b);g.matrixRotationWorld.extractRotation(b);var I=(new e.Ray).copy(this).applyMatrix4(P),_=g.getFilterGeomType(),T=null,k=0;if(g.geometry.length>=0?(T=g.geometry[0],k=g.geometry.length):2===g.geometry._type&&(T=g.geometry,k=1),T&&!T.vertexIndexArray&&!p)return h={distance:0,primitive:!0,object:g,point:null,normal:null},w.push(h),w;var G=new r.SGPrimitiveHelper,R=this.origin,j=new Map,z=function(e,r,l){var u,p,y;x.copy(I.origin),M.copy(I.direction);var f=e.vertexUvArray?e.vertexUvArray:null;null===r?(u=l,p=l+1,y=l+2):(u=r[l],p=r[l+1],y=r[l+2]),e.getVertexPosition(u,i),e.getVertexPosition(p,n),e.getVertexPosition(y,o),S.subVectors(n,i),d.copy(S);var P=S.dot(S);if(S.subVectors(i,o),m.copy(S),P=Math.max(P,S.dot(S)),S.subVectors(i,I.origin),S.cross(I.direction),S.dot(S)>P)return!0;v.crossVectors(m,d).normalize(),S.subVectors(i,x);var _=M.dot(v),T=v.dot(S)/_;if(T>=0){if(V.addVectors(x,M.multiplyScalar(T)),S.subVectors(i,V),S.dot(S)>P)return!0;if(t.pointInFace3(V,i,n,o)){var k=null;e.getVertexNormal(u,a),e.getVertexNormal(p,c),e.getVertexNormal(y,s);var j=V.barycentricCoordinates(i,n,o);a.multiplyScalar(j.alpha),c.multiplyScalar(j.beta),s.multiplyScalar(j.gamma),v.addVectors(a,c),v.add(s),v.multiplyScalar(j.normalisationFactor),v.normalize();var z=V.clone().applyMatrix4(b);f&&(e.getUV(u,i),e.getUV(p,n),e.getUV(y,o),k=t.computeUVCoords(i,n,o)),h={distance:R.distanceTo(z),point:z,normal:v.clone().applyMatrix4(g.matrixRotationWorld),tangent:null,uv:k,primitive:G.clone(),geometry:e,object:g},w.push(h)}}return!0};if(g.kdTree)g.kdTree.intersect(I,function(e,r,i){G.set(e.dg,e.primitive);var n=G.getGroup();if((4==n.glType||5==n.glType)&&!t.filterDrawingGroup(n,_,y)){var o=n.geometry,a=o.vertexIndexArray,c=e.offset;if(p)j.has(n)?j.get(n).push(e.primitive):j.set(n,[e.primitive]);else if(-1!==c)z(o,n.nonIndexed?null:a,c);else for(var s=G.getStart(),l=s+G.getCount(),u=s;u<l;4===n.glType?u+=3:u++)z(o,n.nonIndexed?null:a,u)}});else for(var D=0;D<k;D++){for(var A=T.drawingGroups,F=T.vertexIndexArray,C=A.length,W=0;W<C;W++){var B=A[W];if((4==B.glType||5==B.glType)&&!t.filterDrawingGroup(B,_,y)){var E=null;if(g.layer&&(E=g.layer.getIntervals(T,B)),E||!t.checkGAS(B.gas))for(var H=0;H<B.getPrimitivesCount();H++){G.set(B,H);var L=G.getCount(),U=G.getStart();if(!t.checkRayToPrimitiveBoundingSphere(G,I,0,0)&&!t.checkWLayers(E,U,B.gas,f))if(p)j.has(B)?j.get(B).push(H):j.set(B,[H]);else for(var O=U+L,q=U;q<O;4===B.glType?q+=3:q++)z(T,B.nonIndexed?null:F,q)}}}T=g.geometry[D+1]}return p&&j.forEach(function(e,t,r){e.sort(function(e,t){return e<=t}),w.push({object:g,dg:t,prims:e})}),w},intersectBufferGeomEdge:function(o,a,c,s,g,m,v,x){var M={norm:0,length:0},V=s.getWorldSizeFromPixelSize(1/g,a.worldCenter,s._viewpoint.viewer._getDivClientHeight());if(a.material&&a.material.lineWidth&&(a.material.lineWidth>1||a.material.is2DLine)){var w=a.material.lineWidth;a.material.is2DLine&&(w/=V),M.length=w<2*c?c+1:Math.ceil(w/2+2)}else M.length=c+1;M.norm=Math.sqrt(2)*M.length;var b,P=M.norm/V,I=[],_=a._getMMMatrix(),T=(new e.Matrix4).getInverse(_);a.matrixRotationWorld.extractRotation(_);var k=(new e.Ray).copy(this).applyMatrix4(T),G=a.getFilterGeomType(),R=null,j=0;if(a.geometry.length>=0?(R=a.geometry[0],j=a.geometry.length):2===a.geometry._type&&(R=a.geometry,j=1),R&&!R.vertexIndexArray&&!m)return b={distance:0,primitive:!0,object:a,point:null,normal:null},I.push(b),I;k.direction.normalize();for(var z=this,D=new Map,A=new r.SGPrimitiveHelper,F=function(r,c,g){null===c?(r.getVertexPosition(g,i),r.getVertexPosition(g+1,n)):(r.getVertexPosition(c[g],i),r.getVertexPosition(c[g+1],n)),S.subVectors(n,i);var m=S.dot(S);if(m+=2*Math.sqrt(m)*P+P*P,S.subVectors(i,k.origin),S.cross(k.direction),!(S.dot(S)>m)&&function(r,i,n,o,a,c){var s=a,g=.5*t._screenWidth,m=.5*t._screenHeight;f.copy(n),f.x=(f.x+1)*g,f.y=(f.y+1)*m,l.copy(r),u.copy(i),l.applyMatrix4(o),u.applyMatrix4(o),p.copy(l),y.copy(u),p.applyProjection(t._projScreenMatrix),y.applyProjection(t._projScreenMatrix);var v=p.z>1,x=y.z>1;if(v||x){var M=c._viewpoint._frustum,S=l.dot(M.planes[5].normal)+M.planes[5].constant<0,V=u.dot(M.planes[5].normal)+M.planes[5].constant<0;if(S&&V)return!1;if(S||V){var w=new e.Line3(l,u),b=M.planes[5].intersectLine(w);S?(p.copy(b),p.applyProjection(t._projScreenMatrix)):(y.copy(b),y.applyProjection(t._projScreenMatrix))}}p.x=(p.x+1)*g,p.y=(p.y+1)*m,y.x=(y.x+1)*g,y.y=(y.y+1)*m,d.subVectors(y,p),h.subVectors(f,p);var P=h.x*d.x+h.y*d.y;if(Math.abs(P)<1e-12)return!1;var I=d.x*d.x+d.y*d.y,_=Math.sqrt(I),T=s.length/_;if(P<-(T*=I)||P>I+T)return!1;var k=P/I,G=p.x+k*d.x,R=p.y+k*d.y,j=Math.sqrt((G-f.x)*(G-f.x)+(R-f.y)*(R-f.y));return!(j>s.norm||j<-s.norm)}(i,n,o,_,M,s)){var v=z.computeShortestPointToLine(l,u),x=z.origin.distanceTo(v);b={distance:Math.max(0,.99*x),point:v.clone(),normal:null,tangent:(new e.Vector3).subVectors(v,l).normalize(),primitive:A.clone(),geometry:r,object:a},I.push(b)}},C=0;C<j;C++){for(var W=R.drawingGroups,B=R.vertexIndexArray,E=W.length,H=0;H<E;H++){var L=W[H];if(1==L.glType&&!t.filterDrawingGroup(L,G,v)){var U=null;if(a.layer&&(U=a.layer.getIntervals(R,L)),U||!t.checkGAS(L.gas))for(var O=L.getPrimitivesCount(),q=0;q<O;q++){A.set(L,q);var N=A.getCount(),J=A.getStart();if(!t.checkRayToPrimitiveBoundingSphere(A,k,0,P)&&!t.checkWLayers(U,J,L.gas,x))if(m)D.has(L)?D.get(L).push(q):D.set(L,[q]);else for(var Z=J+N,K=J;K<Z;K+=2)F(R,L.nonIndexed?null:B,K)}}}R=a.geometry[C+1]}return m&&D.forEach(function(e,t,r){e.sort(function(e,t){return e<=t}),I.push({object:a,dg:t,prims:e})}),I},intersectBufferGeomPoint:function(n,o,a,c,s,y,f,m,h,v){var x,M,S=[],V=(s+1)*Math.sqrt(2),w=o._getMMMatrix(),b=(new e.Matrix4).multiplyMatrices(a.matrixWorldInverse,w),P=(new e.Matrix4).getInverse(w);o.matrixRotationWorld.extractRotation(w);var I=(new e.Ray).copy(this).applyMatrix4(P),_=1/a.getWorldSizeFromPixelSize(1,o.worldCenter,a._viewpoint.viewer._getDivClientHeight()),T=o.getFilterGeomType(),k=null,G=0,R=1/0,j=y,z=c;if(z||(j=!1),o.geometry.length>=0?(k=o.geometry[0],G=o.geometry.length):2===o.geometry._type&&(k=o.geometry,G=1),k&&!k.vertexIndexArray&&!m)return x={distance:0,primitive:!0,object:o,point:null,normal:null},S.push(x),S;I.direction.normalize();for(var D=new r.SGPrimitiveHelper,A=this,F=new Map,C=function(r,a,c){if(null===a?r.getVertexPosition(c,i):r.getVertexPosition(a[c],i),j){var s=function(t,r,n,o){var a=1/0;l.copy(i),u.copy(r),l.applyMatrix4(o);var c=new e.Matrix4;return c.getInverse(n),u.applyMatrix4(c),u.applyMatrix4(o),l.z>u.z-.01&&l.z<u.z+.01&&(d.subVectors(l,u),a=Math.sqrt(d.x*d.x+d.y*d.y)),a}(0,z,w,b);if(s<R){R=s;var y=A.origin.distanceTo(l);x={distance:Math.max(0,.98*y),point:l.clone(),normal:null,primitive:D.clone(),geometry:r,object:o}}}else if(function(e,r,i,n,o){var a=96,c=n/a;o&&(a*=o);var s=.5*t._screenWidth/a,u=.5*t._screenHeight/a;return g.copy(r),g.x*=s,g.y*=u,l.copy(e),l.applyMatrix4(i),p.copy(l),p.applyProjection(t._projScreenMatrix),p.x*=s,p.y*=u,d.subVectors(g,p),!(Math.sqrt(d.x*d.x+d.y*d.y)>c)}(i,n,w,M,f)){y=A.origin.distanceTo(l);x={distance:Math.max(0,.98*y),point:l.clone(),normal:null,primitive:D.clone(),geometry:r,object:o},S.push(x)}},W=0;W<G;W++){for(var B=k.drawingGroups,E=k.vertexIndexArray,H=B.length,L=0;L<H;L++){var U=B[L];if(0===U.glType&&!t.filterDrawingGroup(U,T,h)){var O;if(U.gas)U.gas.isGAS?O=U.gas.getPointSize():U.gas instanceof e.ParticleBasicMaterial&&U.gas.size&&(O=U.gas.size),M=O>2*s+1?O*Math.sqrt(2)/2:V;else M=V;var q=null;if(o.layer&&(q=o.layer.getIntervals(k,U)),q||!t.checkGAS(U.gas))for(var N=U.getPrimitivesCount(),J=0;J<N;J++){D.set(U,J);var Z=D.getCount(),K=D.getStart();if(!t.checkRayToPrimitiveBoundingSphere(D,I,0,M*_)&&!t.checkWLayers(q,K,U.gas,v))if(m)F.has(U)?F.get(U).push(J):F.set(U,[J]);else for(var Q=K+Z,X=K;X<Q;X++)C(k,U.nonIndexed?null:E,X)}}}k=o.geometry[W+1]}return j&&x&&S.push(x),m&&F.forEach(function(e,t,r){e.sort(function(e,t){return e<=t}),S.push({object:o,dg:t,prims:e})}),S}}}),define("DS/Intersection/RayCastUtils",["DS/Visualization/ThreeJS_R57","DS/Intersection/IntersectionUtils","DS/Mesh/Mesh"],function(e,t,r){"use strict";var i=new e.Vector3,n=new e.Vector3,o=new e.Vector3,a=new e.Vector3,c=new e.Vector3,s=new e.Vector3,l=new e.Vector3,u=new e.Vector3,g=new e.Vector3,p=new e.Vector3,y=new e.Vector3,f=new e.Vector3,d=new e.Vector3,m=new e.Vector3,h=new e.Vector3,v=new e.Vector3;return{_castRayIntoBufferGeom:function(l,u,v){var x,M=[],S=l._getMMMatrix(),V=(new e.Matrix4).getInverse(S),w=V.getMaxScaleOnAxis();l.matrixRotationWorld.extractRotation(S);var b=(new e.Ray).copy(this).applyMatrix4(V),P=v*w,I=v<1/0,_=null,T=0;if(l.geometry.length>=0?(_=l.geometry[0],T=l.geometry.length):2===l.geometry._type&&(_=l.geometry,T=1),_&&!_.vertexIndexArray)return x={distance:0,primitive:!0,object:l,point:null,normal:null},M.push(x),M;var k=new r.SGPrimitiveHelper,G=this;b.direction.normalize();var R=function(e,r,v){var V,w,T;f.copy(b.origin);var R=e.vertexUvArray?e.vertexUvArray:null;d.copy(b.direction),null===r?(V=v,w=v+1,T=v+2):(V=r[v],w=r[v+1],T=r[v+2]),e.getVertexPosition(V,i),e.getVertexPosition(w,n),e.getVertexPosition(T,o),m.subVectors(n,i),g.copy(m);var j=m.dot(m);if(m.subVectors(i,o),p.copy(m),j=Math.max(j,m.dot(m)),m.subVectors(i,b.origin),m.cross(b.direction),m.dot(m)>j)return!0;y.crossVectors(p,g).normalize(),m.subVectors(i,f);var z=d.dot(y),D=y.dot(m)/z;if(D>=0){if(I&&D>P)return!0;if(h.addVectors(f,d.multiplyScalar(D)),m.subVectors(i,h),m.dot(m)>j)return!0;if(t.pointInFace3(h,i,n,o)){if(u)return x={object:l,geometry:_},M.push(x),!1;var A=null;e.getVertexNormal(V,a),e.getVertexNormal(w,c),e.getVertexNormal(T,s);var F=h.barycentricCoordinates(i,n,o);a.multiplyScalar(F.alpha),c.multiplyScalar(F.beta),s.multiplyScalar(F.gamma),y.addVectors(a,c),y.add(s),y.multiplyScalar(F.normalisationFactor),y.normalize();var C=h.clone().applyMatrix4(S);R&&(e.getUV(V,i),e.getUV(w,n),e.getUV(T,o),A=t.computeUVCoords(i,n,o)),x={distance:G.origin.distanceTo(C),point:C,normal:y.clone().applyMatrix4(l.matrixRotationWorld),tangent:null,uv:A,primitive:k.clone(),geometry:e,object:l},M.push(x)}}return!0};if(l.kdTree){l.kdTree.intersect(b,function(e){f.copy(b.origin),d.copy(b.direction),k.set(e.dg,e.primitive);var t=k.getGroup();if(4==t.glType||5==t.glType){var r=t.geometry,i=r.vertexIndexArray,n=e.offset;if(-1!==n)R(r,t.nonIndexed?null:i,n);else for(var o=k.getStart(),a=o+k.getCount(),c=o;c<a&&R(r,t.nonIndexed?null:i,c);4===t.glType?c+=3:c++);}},null,I?P:null);return M}for(var j=0;j<T;j++){for(var z=_.drawingGroups,D=_.vertexIndexArray,A=z.length,F=0;F<A;F++){var C=z[F];if(4==C.glType||5==C.glType){var W=null;l.layer&&(W=l.layer.getIntervals(_,C));for(var B=C.getPrimitivesCount(),E=0;E<B;E++){k.set(C,E);var H=k.getCount(),L=k.getStart();if(!t.checkRayToPrimitiveBoundingSphere(k,H,b,I?P:0,0)&&!t.checkWLayersNoGAS(W,L))for(var U=L+H,O=L;O<U;4===C.glType?O+=3:O++)if(!R(_,C.nonIndexed?null:D,O))return M}}}_=l.geometry[j+1]}return M},_castRayIntoBufferGeomEdge:function(o,a,c,s){var g,p=[],y=o._getMMMatrix(),f=(new e.Matrix4).getInverse(y),d=f.getMaxScaleOnAxis();o.matrixRotationWorld.extractRotation(y);var h=(new e.Ray).copy(this).applyMatrix4(f),x=s*d,M=s<1/0;o.material&&o.material.lineWidth&&o.material.is2DLine&&(a+=.5*o.material.lineWidth);var S=null,V=0;if(o.geometry.length>=0?(S=o.geometry[0],V=o.geometry.length):2===o.geometry._type&&(S=o.geometry,V=1),S&&!S.vertexIndexArray)return g={distance:0,primitive:!0,object:o,point:null,normal:null},p.push(g),p;h.direction.normalize();for(var w=new r.SGPrimitiveHelper,b=this,P=function(t,r,f){null===r?(t.getVertexPosition(f,i),t.getVertexPosition(f+1,n)):(t.getVertexPosition(r[f],i),t.getVertexPosition(r[f+1],n)),m.subVectors(n,i);var d=m.dot(m);if(d+=2*Math.sqrt(d)*a+a*a,m.subVectors(i,h.origin),m.cross(h.direction),m.dot(m)>d)return!0;if(l.copy(i),u.copy(n),l.applyMatrix4(y),u.applyMatrix4(y),M){v.subVectors(l,b.origin);var x=v.dot(b.direction);if(v.subVectors(u,b.origin),(x=Math.min(x,v.dot(b.direction)))>s)return!0}var S=new e.Vector3;if(b.distanceSqToSegment(l,u,null,S)<a*a){if(c)return g={object:o,geometry:t},p.push(g),!1;var V=b.origin.distanceTo(S);g={distance:Math.max(0,.99*V),point:S.clone(),normal:null,tangent:(new e.Vector3).subVectors(S,l).normalize(),primitive:w.clone(),geometry:t,object:o},p.push(g)}return!0},I=0;I<V;I++){for(var _=S.drawingGroups,T=S.vertexIndexArray,k=_.length,G=0;G<k;G++){var R=_[G];if(1==R.glType){var j=null;o.layer&&(j=o.layer.getIntervals(S,R));for(var z=R.getPrimitivesCount(),D=0;D<z;D++){w.set(R,D);var A=w.getCount(),F=w.getStart();if(!t.checkRayToPrimitiveBoundingSphere(w,A,h,M?x:0,a)&&!t.checkWLayersNoGAS(j,F))for(var C=F+A,W=F;W<C;W+=2)if(!P(S,R.nonIndexed?null:T,W))return p}}}S=o.geometry[I+1]}return p},_castRayIntoBufferGeomPoint:function(n,o,a,c){var s,u=[],g=n._getMMMatrix(),p=(new e.Matrix4).getInverse(g),y=p.getMaxScaleOnAxis();n.matrixRotationWorld.extractRotation(g);var f=(new e.Ray).copy(this).applyMatrix4(p),d=c*y,m=c<1/0,h=null,v=0;if(n.geometry.length>=0?(h=n.geometry[0],v=n.geometry.length):2===n.geometry._type&&(h=n.geometry,v=1),h&&!h.vertexIndexArray)return s={distance:0,primitive:!0,object:n,point:null,normal:null},u.push(s),u;f.direction.normalize();for(var x=new r.SGPrimitiveHelper,M=this,S=function(e,t,r){if(null===t?e.getVertexPosition(r,i):e.getVertexPosition(t[r],i),l.copy(i),l.applyMatrix4(g),M.distanceToPoint(l)<o){if(a)return s={object:n,geometry:e},u.push(s),!1;var p=M.origin.distanceTo(l);if(m&&p>c)return!0;s={distance:Math.max(0,.98*p),point:l.clone(),normal:null,primitive:x.clone(),geometry:e,object:n},u.push(s)}return!0},V=0;V<v;V++){for(var w=h.drawingGroups,b=h.vertexIndexArray,P=w.length,I=0;I<P;I++){var _=w[I];if(0===_.glType){var T=null;n.layer&&(T=n.layer.getIntervals(h,_));for(var k=_.getPrimitivesCount(),G=0;G<k;G++){x.set(_,G);var R=x.getCount(),j=x.getStart();if(!t.checkRayToPrimitiveBoundingSphere(x,R,f,m?d:0,o)&&!t.checkWLayersNoGAS(T,j))for(var z=j+R,D=j;D<z;D++)if(!S(h,_.nonIndexed?null:b,D))return u}}}h=n.geometry[V+1]}return u}}}),define("DS/Intersection/Ray",["DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh","DS/Intersection/IntersectionUtils","DS/Intersection/RayFrustumUtils","DS/Intersection/RayIntersectionUtils","DS/Intersection/RayCastUtils"],function(e,t,r,i,n,o){"use strict";var a,c,s=new e.Vector3,l=new e.Vector3,u=new e.Vector3;function g(t,r,i){var n=t;if(r._occurrence&&(r._occurrence.renderMode&&(r._occurrence.renderMode.getMask?n=r._occurrence.renderMode.getMask():console.error("Error: expected RenderMode in OccurrenceNode.renderMode but got "+typeof r._occurrence.renderMode)),r._occurrence.pickingMode&&(i=r._occurrence.pickingMode)),i){var[o,a,c]=i._getPickingMasks(n);n=o|a|c}return n|e.RenderMode.defaultMask}function p(t,r,i){return!0===t?t=e.RenderMode.facesMask:!1===t&&(t=0),!0===r?r=e.RenderMode.linesMask:!1===r&&(r=0),!0===i?i=e.RenderMode.pointsMask:!1===i&&(i=0),t|r|i|e.RenderMode.defaultMask}var y,f,d,m=e.__visibleInCurrentSpace,h=function(t,r){this.origin=void 0!==t?t:new e.Vector3,this.direction=void 0!==r?r:new e.Vector3};return h.prototype={constructor:h,set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},_cleanIntersectionsList:function(e,t){if(t)for(var r=0;r<e.length;r++){var i=e[r];if(i.object){var n=i.object;if(void 0!==n.pickable&&!n.pickable){e[r]={};continue}}}},at:function(t,r){return(r||new e.Vector3).copy(this.direction).multiplyScalar(t).add(this.origin)},recast:function(){var t=new e.Vector3;return function(e){return this.origin.copy(this.at(e,t)),this}}(),closestPointToPoint:function(t,r){var i=r||new e.Vector3;i.subVectors(t,this.origin);var n=i.dot(this.direction);return i.copy(this.direction).multiplyScalar(n).add(this.origin)},distanceToPoint:function(){var t=new e.Vector3;return function(e){var r=t.subVectors(e,this.origin).dot(this.direction);return t.copy(this.direction).multiplyScalar(r).add(this.origin),t.distanceTo(e)}}(),distanceSqToSegment:(y=new e.Vector3,f=new e.Vector3,d=new e.Vector3,function(e,t,r,i){y.copy(e).add(t).multiplyScalar(.5),f.copy(t).sub(e).normalize(),d.copy(this.origin).sub(y);var n,o,a,c,s=.5*e.distanceTo(t),l=-this.direction.dot(f),u=d.dot(this.direction),g=-d.dot(f),p=d.lengthSq(),m=Math.abs(1-l*l);if(m>0)if(o=l*u-g,c=s*m,(n=l*g-u)>=0)if(o>=-c)if(o<=c){var h=1/m;a=(n*=h)*(n+l*(o*=h)+2*u)+o*(l*n+o+2*g)+p}else o=s,a=-(n=Math.max(0,-(l*o+u)))*n+o*(o+2*g)+p;else o=-s,a=-(n=Math.max(0,-(l*o+u)))*n+o*(o+2*g)+p;else o<=-c?a=-(n=Math.max(0,-(-l*s+u)))*n+(o=n>0?-s:Math.min(Math.max(-s,-g),s))*(o+2*g)+p:o<=c?(n=0,a=(o=Math.min(Math.max(-s,-g),s))*(o+2*g)+p):a=-(n=Math.max(0,-(l*s+u)))*n+(o=n>0?s:Math.min(Math.max(-s,-g),s))*(o+2*g)+p;else o=l>0?-s:s,a=-(n=Math.max(0,-(l*o+u)))*n+o*(o+2*g)+p;return r&&r.copy(this.direction).multiplyScalar(n).add(this.origin),i&&i.copy(f).multiplyScalar(o).add(y),a}),isIntersectionSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},isIntersectionPlane:function(e){return 0!=e.normal.dot(this.direction)||0==e.distanceToPoint(this.origin)},distanceToPlane:function(e){var t=e.normal.dot(this.direction);return 0==t?0==e.distanceToPoint(this.origin)?0:void 0:-(this.origin.dot(e.normal)+e.constant)/t},intersectPlane:function(e,t){var r=this.distanceToPlane(e);if(void 0!==r)return this.at(r,t)},intersectBox:function(e,t,r){var i,n,o,a,c,s,l=1/this.direction.x,u=1/this.direction.y,g=1/this.direction.z,p=this.origin;return l>=0?(i=(e.min.x-p.x)*l,n=(e.max.x-p.x)*l):(i=(e.max.x-p.x)*l,n=(e.min.x-p.x)*l),u>=0?(o=(e.min.y-p.y)*u,a=(e.max.y-p.y)*u):(o=(e.max.y-p.y)*u,a=(e.min.y-p.y)*u),i>a||o>n?null:((o>i||i!=i)&&(i=o),(a<n||n!=n)&&(n=a),g>=0?(c=(e.min.z-p.z)*g,s=(e.max.z-p.z)*g):(c=(e.max.z-p.z)*g,s=(e.min.z-p.z)*g),i>s||c>n?null:((c>i||i!=i)&&(i=c),(s<n||n!=n)&&(n=s),n<0?null:(r&&(r.x=i,r.y=n),this.at(i>=0?i:n,t))))},applyMatrix4:function(e){return this.direction.add(this.origin).applyMatrix4(e),this.origin.applyMatrix4(e),this.direction.sub(this.origin),this.direction.normalize(),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)},clone:function(){return(new e.Ray).copy(this)},intersectPlaneInDir:function(e,t){var r=this.distanceToPlane(e);if(!(void 0===r||r<0))return this.at(r,t)},computeShortestPointToLine:function(t,r){var i=this.direction,n=(new e.Vector3).subVectors(r,t),o=(new e.Vector3).subVectors(this.origin,t),a=i.lengthSq(),c=i.dot(n),s=n.lengthSq(),l=i.dot(o),u=n.dot(o),g=a*s-c*c,p=0;return p=g<1e-7?c>s?l/c:u/s:(a*u-c*l)/g,n.multiplyScalar(p).add(t)},_distanceFromIntersection:function(e){var t=this.origin,r=this.direction;return s.subVectors(e,t),a=s.dot(r),c=l.addVectors(t,u.copy(r).multiplyScalar(a)),e.distanceTo(c)},intersectMeshInstances:function(t,i,n,o,a,c,s,l,u,y){var f,d,h,v,x,M=(y=y||{}).devicePixelRatio?y.devicePixelRatio:e.getDevicePixelRatio(),S=!!y.candidatesOnly,V=!!y.debugPickHybrid,w=!!y.useViewerPickingRules,b=void 0===y.inVisibleSpace||y.inVisibleSpace,P=t.object,I=t.type,_=p(o,a,c);void 0!==I?(h=2===I,v=1===I,x=0===I):(h=!0,v=!0,x=!0);var T=null;if(w&&i._viewpoint&&i._viewpoint.viewer&&(T=new e.PickingMode)._fromRenderer(i._viewpoint.viewer.renderer.renderer),P instanceof e.Mesh)f=[{object:P}];else{var k=y.renderLists||["main","noz","noEffectNoZ","afterHighlightNoZ","dialog"];for(f=[],d=0;d<k.length;d++)f=f.concat(P.getWebGLObjects(k[d],0))}var G,R,j=[];r._screenWidth=s,r._screenHeight=l,i.matrixWorldInverse.getInverse(i.matrixWorld),r._projScreenMatrix.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse);var z=u*M,D=1.4142135623730951;for(d=0,G=f.length;d<G;d++){if(null!==f[d])if(!1!==(R=f[d].object).noPickThrough&&m(R.visible,R.visibilityFree,b,R.layer,R._occurrence)){var A=new e.Vector3;null!==R.geometry.boundingSphere&&A.copy(R.geometry.boundingSphere.center);var F=R._getMMMatrix();A.applyMatrix4(F);var C=this._distanceFromIntersection(A),W=F.getMaxScaleOnAxis(),B=0;if(R.frustumCulled&&void 0!==l){var E=0,H=0,L=null,U=0;R.geometry.length>=0?(L=R.geometry[0],U=R.geometry.length):2===R.geometry._type&&(L=R.geometry,U=1);for(var O=0;O<U;O++)for(var q=L.drawingGroups,N=0,J=q.length;N<J;N++){var Z,K=q[N];if(K.gas)K.gas.isGAS&&0===K.glType?Z=K.gas.getPointSize():K.gas instanceof e.ParticleBasicMaterial&&K.gas.size&&(Z=K.gas.size),Z>H&&(H=Z);else K.material&&K.material instanceof e.ParticleBasicMaterial&&K.material.size&&K.material.size>H&&(H=K.material.size)}E+=H,B=i.getWorldSizeFromPixelSize(E,A,r._screenHeight)}var Q=i.getWorldSizeFromPixelSize(z,A,r._screenHeight);if(!R.frustumCulled||C<=R.geometry.boundingSphere.radius*W+B*D/2+Q*D){var X=g(_,R,T);if(h){var Y;if(2===R.geometry._type||R.geometry.length>=0)(Y=this.intersectBufferGeomOptim(i,n,R,S,X,b)).length&&!S&&(!Y[0].point&&t.point&&(Y[0].point=t.point),!Y[0].normal&&t.normal&&(Y[0].normal=t.normal));else(Y=new e.Raycaster(this.origin,this.direction,i.near,i.far).intersectObject(R,!1)).length&&!S&&(!Y[0].point&&t.point&&(Y[0].point=t.point),!Y[0].normal&&t.normal&&(Y[0].normal=t.normal));j=j.concat(Y)}if(v){var $=this.intersectBufferGeomEdge(n,R,u,i,M,S,X,b);$.length&&!S&&(!$[0].point&&t.point&&($[0].point=t.point),!$[0].normal&&t.normal&&($[0].normal=t.normal)),j=j.concat($)}if(x){var ee=this.intersectBufferGeomPoint(n,R,i,t.point,u,V,M,S,X,b);ee.length&&!S&&(!ee[0].point&&t.point&&(ee[0].point=t.point),!ee[0].normal&&t.normal&&(ee[0].normal=t.normal)),j=j.concat(ee)}}}}return S||j.sort(function(e,t){return e.distance-t.distance}),j},_cast:function(t,r,i,n){var o,a=i||{},c="mesh"===r,s=void 0!==a.rayLength?a.rayLength:1/0,l=null===a.intersectFaces||void 0===a.intersectFaces||a.intersectFaces,u=a.intersectEdges,g=a.intersectPoints,p=a.edgeTolerance?a.edgeTolerance:.1,y=a.pointTolerance?a.pointTolerance:.1,f=t,d=0,m=0,h=null,v=[],x=new e.Vector3;for(d=0,o=f.length;d<o;d++)if(null!==f[d]){var M=(h=f[d].object?f[d].object:f[d]).worldCenter,S=h.worldRadius,V=this.distanceToPoint(M);if(x.subVectors(M,this.origin).dot(this.direction)-S<=s&&V<=S){var w,b,P;if(l){if(2===h.geometry._type||h.geometry.length>=0)w=this._castRayIntoBufferGeom(h,c,s);else w=new e.Raycaster(this.origin,this.direction,0,s).intersectObject(h,!1);for(m=0;m<w.length;m++){var I=new n;if(w[m].primitive){var _=!0===w[m].primitive?null:THREEDS.SubElement.getFromSGNode(w[m].primitive);I.setFromOccurrence(w[m].object._occurrence,_,void 0,!0)}else I.setFromOccurrence(w[m].object._occurrence),w[m].distance=this.direction.dot((new e.Vector3).subVectors(M,this.origin));w[m].pathElement=I}v=v.concat(w)}if(u&&(!c||c&&!w)){for(b=this._castRayIntoBufferGeomEdge(h,p,c,s),m=0;m<b.length;m++){I=new n;if(b[m].primitive){_=!0===b[m].primitive?null:THREEDS.SubElement.getFromSGNode(b[m].primitive);I.setFromOccurrence(b[m].object._occurrence,_,void 0,!0)}else I.setFromOccurrence(b[m].object._occurrence),b[m].distance=this.direction.dot((new e.Vector3).subVectors(M,this.origin));b[m].pathElement=I}v=v.concat(b)}if(g&&(!c||c&&!b)){for(P=this._castRayIntoBufferGeomPoint(h,y,c,s),m=0;m<P.length;m++){I=new n;if(P[m].primitive){_=!0===P[m].primitive?null:THREEDS.SubElement.getFromSGNode(P[m].primitive);I.setFromOccurrence(P[m].object._occurrence,_,void 0,!0)}else I.setFromOccurrence(P[m].object._occurrence),P[m].distance=this.direction.dot((new e.Vector3).subVectors(M,this.origin));P[m].pathElement=I}v=v.concat(P)}}}return v.sort(function(e,t){return e.distance-t.distance}),v},intersectMeshInstancesZones3D:function(t,i,n,o,a,c,s,l,u,y,f,d,h){var v,x,M=!!(h=h||{}).inVisibleSpace,S=!!h.useViewerPickingRules,V=void 0===M||M;if(t instanceof e.Mesh)v=[{object:t}];else{var w=h.renderLists||["main","noz","noEffectNoZ","afterHighlightNoZ","dialog"];for(v=[],x=0;x<w.length;x++)v=v.concat(t.getWebGLObjects(w[x],0))}var b=null;S&&i._viewpoint&&i._viewpoint.viewer&&(b=new e.PickingMode)._fromRenderer(i._viewpoint.viewer.renderer.renderer);var P,I,_=p(s,l,u),T=[];for(r._screenWidth=y,r._screenHeight=f,i.matrixWorldInverse.getInverse(i.matrixWorld),r._projScreenMatrix.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),x=0,P=v.length;x<P;x++){if(null!==v[x])if(!1!==(I=v[x].object).noPickThrough&&m(I.visible,I.visibilityFree,V,I.layer,I._occurrence)){if(void 0!==I.pickable&&!I.pickable)continue;var k=new e.Sphere;null!==I.geometry.boundingSphere&&k.copy(I.geometry.boundingSphere);var G=I._getMMMatrix();if(k.center.applyMatrix4(G),a.intersectsSphere(k)){var R=[],j=g(_,I,b);if(d||c)for(var z=2;z>=0;z--){var D=[];if(2===z)if(2===I.geometry._type||I.geometry.length>=0)D=this.intersectBufferGeomZone3D(i,a,I,c,d,j,V);else D=new e.Raycaster(this.origin,this.direction,i.near,i.far).intersectObject(I,!1);else 1===z?D=this.intersectBufferGeomEdge3D(a,I,c,d,j,V):0===z&&(D=this.intersectBufferGeomPoint3D(a,I,j,V));if(c)R=R.concat(D);else{if(!d&&!D.length)break;if(!R.length&&D.length&&(R=R.concat(D)),d&&R.length>0)break}}else R=this.intersectBufferGeom3DInsideFrustumMesh(a,I,j,V);R&&(T=T.concat(R))}}}return T}},Object.assign(h.prototype,i),Object.assign(h.prototype,n),Object.assign(h.prototype,o),h}),define("DS/Intersection/Raycaster",["DS/Visualization/ThreeJS_R57","DS/Intersection/Ray"],function(e,t){"use strict";var r=function(e,r,i,n){this.ray=new t(e,r),this.ray.direction.lengthSq()>0&&this.ray.direction.normalize(),this.near=i||0,this.far=n||1/0},i=new e.Sphere,n=new t,o=new e.Plane,a=new e.Vector3,c=new e.Vector3,s=new e.Matrix4,l=function(e,t){return e.distance-t.distance},u=function(t,r,l){if(t instanceof e.Particle){c.getPositionFromMatrix(t.matrixWorld);var u=r.ray.distanceToPoint(c);if(u>t.scale.x)return l;l.push({distance:u,point:t.position,face:null,object:t})}else if(t instanceof e.Mesh){var g=t._getMMMatrix();if(c.getPositionFromMatrix(g),i.set(c,t.geometry.boundingSphere.radius*g.getMaxScaleOnAxis()),!r.ray.isIntersectionSphere(i))return l;var p,y,f,d,m=t.geometry,h=m.vertices,v=t.material instanceof e.MeshFaceMaterial,x=!0===v?t.material.materials:null,M=t.material.side,S=r.precision;t.matrixRotationWorld.extractRotation(g),s.getInverse(g),n.copy(r.ray).applyMatrix4(s);for(var V=0,w=m.faces.length;V<w;V++){var b=m.faces[V],P=!0===v?x[b.materialIndex]:t.material;if(void 0!==P){o.setFromNormalAndCoplanarPoint(b.normal,h[b.a]);var I=n.distanceToPlane(o);if(!(Math.abs(I)<S||I<0)){if((M=P.side)!==THREEConstants.DoubleSide){var _=n.direction.dot(o.normal);if(!(M===THREEConstants.FrontSide?_<0:_>0))continue}if(!(I<r.near||I>r.far)){if(a=n.at(I,a),b instanceof e.Face3){if(p=h[b.a],y=h[b.b],f=h[b.c],!e.Triangle.containsPoint(a,p,y,f))continue}else{if(!(b instanceof e.Face4))throw Error("face type not supported");if(p=h[b.a],y=h[b.b],f=h[b.c],d=h[b.d],!e.Triangle.containsPoint(a,p,y,d)&&!e.Triangle.containsPoint(a,y,f,d))continue}l.push({distance:I,point:r.ray.at(I),face:b,faceIndex:V,object:t})}}}}}},g=function(e,t,r){for(var i=e.getDescendants(),n=0,o=i.length;n<o;n++)u(i[n],t,r)};return r.prototype.precision=1e-4,r.prototype.set=function(e,t){this.ray.set(e,t),this.ray.direction.length()>0&&this.ray.direction.normalize()},r.prototype.intersectObject=function(e,t){var r=[];return!0===t&&g(e,this,r),u(e,this,r),r.sort(l),r},r.prototype.intersectObjects=function(e,t){for(var r=[],i=0,n=e.length;i<n;i++)u(e[i],this,r),!0===t&&g(e[i],this,r);return r.sort(l),r},r});