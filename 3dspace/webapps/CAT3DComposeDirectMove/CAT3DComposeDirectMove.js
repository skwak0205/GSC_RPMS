/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove",["UWA/Core","UWA/Class","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/Manipulators/ScreenPlaneManipulator","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/SceneGraphNodes/AxisSystemNode","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DUtils/CATW3DUtils","DS/CATW3DAnims/CATW3DAnimation3D","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CAT3DComposeUI/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/Visualization/IdPath","DS/CoreEvents/ModelEvents","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/ApplicationFrame/CommandsManager","css!DS/CAT3DComposeUI/CAT3DComposeUI.css"],function(e,t,n,i,a,o,r,l,s,c,p,u,m,v,d,h,f,E,g,y,M,x,C,D){"use strict";var b,T=t.extend({init:function(){var t,b,T=!1,S=null,A=null,P=null,w=this,I={},W=[],G="",R=!0,O=null,V=null,N={},L=3394815,F=!1,k={},q=[],B=null,H=null,j=null,U=null,_=null,K=null,z=null,X=!d.getOption("animationOff"),Y=!1,J={},Q=!1,Z=null,$=!1,ee=null,te=null,ne=new y,ie=function(){var e=t.getRootBagPath();return e?e.getLastElement(!0):null},ae=function(e){return t.getRootBagPath().isAParentOf(e)},oe=new l("LocalAxisSystemNode");oe.exludeFromBounding(!0),oe.setVisibilityInTree(!1),oe.setPickable(s.PICKTHROUGH),oe.setVisibility(!1),oe.setVisibilityFree(!0),oe.updateDisplay=function(e){0===oe.parents.length&&P.addNode(oe),e.visibility&&e.pathElement&&oe.pathElement!==e.pathElement&&(oe.pathElement=e.pathElement,oe.setMatrix(e.pathElement.getWorldMatrix()),oe.setVisibility(!0)),e.visibility||(oe.pathElement=null,oe.setVisibility(!1))};var re=new l("MovePrevisuNode");re.exludeFromBounding(!0),re.setVisibilityFree(!0),re.setVisibilityInTree(!1),re.setPickable(s.PICKTHROUGH),re.setNoZ(!0),re.updateDisplay=function(e,t,n){0===re.parents.length&&P.addNode(re),re.removeChildren(),e&&e.equivalentGeometry&&e.equivalentGeometry.getPrevisuNode&&re.addChild(e.equivalentGeometry.getPrevisuNode(t,n))};var le=function(e){if(e.color){var t=new r.MeshBasicMaterial({side:2,forceSide:!0,color:e.color,transparent:!0,depthWrite:!1,depthTest:!1,opacity:.6,overridable:!1});x.applyMaterialToPath(e.path,t)}else x.applyMaterialToPath(e.path,null)},se=function(e){e.objectToMove.override.setColor("#FFFFFF",!1);var t=function(t){e.objectToMove&&z&&!Q&&t&&P.render()},n=S.isPathLocked({pathElement:e.objectToMove.path,onCompleted:function(e){J.isRunning()||t(e.isLocked)}});0===n.returnCode&&n.hasOwnProperty("isLocked")&&(t(n.isLocked),t=function(){})};function ce(){z&&P.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(z),z=null,B=null,T=!1,I={},F=!1,k={},V=null,N={},G="",q=[],W.forEach(function(e){e.lockedID&&t.getController().unlockNodes({ids:[e.lockedID]})}),W=[],Q=!1,X&&(Y=!1,$=!1)}var pe,ue=function(){if(z&&P.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(z),z=null,F)q.forEach(function(e){e.path&&n.add({pathElement:e.path})}),S.onMoveEnd({from:w,status:G}),"Moved"===G&&i.get().some(function(e){if(e.pathElement.isEqual(I.pathElement))return e.position=I.beginPosLocal.clone().applyMatrix4(I.pathElement.getWorldMatrix()),!0}),O&&(O.simulateReverseDirection(I.pathElement)||O.getAxisTypeIfCstOnProductAxis(I.pathElement))&&t.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!0});else if(I.pathElement&&!k.partIsInCSO){var e=I.pathElement;i.add({pathElement:e,event:I.beginEvent,position:I.beginPosLocal.clone().applyMatrix4(e.getWorldMatrix())}),t.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!0})}ce(),ne.publish({event:"onDirectMoveEnd"})},me={panInterval:void 0,viewpoint:void 0,panDuration:100,x:void 0,y:void 0},ve=function(){me.panInterval&&clearInterval(me.panInterval),me.panInterval=void 0,me.viewpoint=void 0,me.x=void 0,me.y=void 0,me.div=me.div?me.div.destroy():void 0,me.divL=me.divT=me.divR=me.divB=void 0},de=function(n){function i(){if(me.viewpoint||(me.viewpoint=P.currentViewpoint),me.viewpoint&&me.viewpoint.control&&void 0!==me.x&&void 0!==me.y){var n,i,a=new r.Vector3(me.x,me.y,0);if(a.applyQuaternion(me.viewpoint.control.orientation),a.setLength(.05*me.viewpoint.control.distanceToTarget),n=me.viewpoint.target.clone().add(a),i=me.viewpoint.control.distanceToTarget,me.viewpoint.moveTo({eyePosition:n.add(me.viewpoint.getCamera().getLookAt().normalize().multiplyScalar(-i)),duration:X?me.panDuration:0}),!me.div){var o=t.getFrameWindow().getUIFrame();me.div=e.createElement("div",{id:"C3D-viewpoint",styles:{top:P.SCREEN_HEIGHT/2+"px",left:P.SCREEN_WIDTH/2+"px"}}).inject(o);var l=function(t){var n=e.createElement("div",{class:t.side}).inject(me.div);n.setStyle(t.posKey,t.posValue+"px");var i=e.createElement("div",{class:"arrow"}).inject(n);return e.createElement("div",{class:"borderBottom"}).inject(i),e.createElement("div",{class:"borderRight"}).inject(i),n},s=Math.min(P.SCREEN_WIDTH/10,P.SCREEN_HEIGHT/10);me.divL=l({side:"left",posKey:"left",posValue:-s}),me.divT=l({side:"top",posKey:"top",posValue:-s}),me.divR=l({side:"right",posKey:"left",posValue:s}),me.divB=l({side:"bottom",posKey:"top",posValue:s})}me.x<0?me.divL.addClassName("active"):me.divL.removeClassName("active"),me.x>0?me.divR.addClassName("active"):me.divR.removeClassName("active"),me.y<0?me.divB.addClassName("active"):me.divB.removeClassName("active"),me.y>0?me.divT.addClassName("active"):me.divT.removeClassName("active")}}var a=(n.event.gesture?n.event.gesture.getEvents()[0]:n.event.from[0]).getCurrentPosition(t.getViewer().canvas);return me.x=a.x<=9?-1:a.x>=P.SCREEN_WIDTH-10-1?1:0,me.y=a.y<=9?1:a.y>=P.SCREEN_HEIGHT-10-1?-1:0,0===me.x&&me.y?me.x=a.x<P.SCREEN_WIDTH/3?-1:a.x>2*P.SCREEN_WIDTH/3?1:0:0===me.y&&me.x&&(me.y=a.y<P.SCREEN_HEIGHT/3?1:a.y>2*P.SCREEN_HEIGHT/3?-1:0),me.x||me.y?(clearInterval(me.panInterval),me.panInterval=setInterval(function(){i()},me.panDuration),i(),1):(ve(),0)};function he(e){if(b&&b.cancel&&b.cancel(),b=null,ve(),e&&!R?(R=!1,G="Moved"):G="Cancelled",oe&&oe.updateDisplay({visibility:!1}),F)if(X){if(Z&&(clearTimeout(Z),Z=null),J.forward(),J.addAnimation({animationType:"opacityOff",objectListToAnimate:W,callBackFct:function(){W.forEach(function(e){e.override.setColor(null,!1)}),I.equivalentGeometry&&le({path:I.pathElement})}}),"Cancelled"===G){var a=P.getSceneGraphOverrideSetManager();W.forEach(function(e){e.currentMatrix=a.computeAppliedPosition(e.path)}),J.addAnimation({animationType:"cancel",objectListToAnimate:W,callBackFct:function(){ue()}})}else Q?ue():Y?$=!0:($=!0,J.addAnimation({animationType:"snap",objectListToAnimate:W,callBackFct:function(){Q=!0,Z=!1,$&&ue()}}));J.startAnimation()}else ue();else q.forEach(function(a){if(a.path)if(a.path.isEqual(I.pathElement))if(k.partIsInCSO)if(T)i.remove({pathElement:I.pathElement,event:e.event}),n.remove({pathElement:I.pathElement});else{var o=I.pathElement;i.remove({pathElement:o}),i.add({pathElement:o,event:I.beginEvent,position:I.beginPosLocal.clone().applyMatrix4(o.getWorldMatrix())}),t.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!0})}else n.add({pathElement:I.pathElement});else a.path.isAParentOf(I.pathElement)&&T&&k.partIsInCSO&&(i.remove({pathElement:I.pathElement,event:e.event}),n.remove({pathElement:I.pathElement}))}),ue();P.render()}function fe(){ve(),ee&&(S.unsubscribe(ee),ee=null),te&&(S.unsubscribe(te),te=null),H&&(H.unsubscribe(U),H.unsubscribe(_),H.unsubscribe(K),H.unlink(j),H=U=_=K=j=null),oe&&oe.removeChildren(),re&&re.removeChildren()}this.activate=function(e){t=e.context,pe=!0,function(e,l){if(pe&&!H){var s=t.getFrameWindow();if(S=E.giveMoveManager({context:t}),A=f.getMoveReferentManager({context:t}),O||(O=p.getConstraintsController({context:t})),ee=S?S.subscribe("onValidateMove",function(){O&&O.deleteAllCst()}):null,te=S?S.subscribe("onCancelMove",function(e){O&&e.objectsCancelled.some(function(e){return O.isLevelConstrained(e.path)})&&O.deleteAllCst()}):null,s)if(S)if(A){if(P=s.getViewer(),J=m.getAnimation3DEngine({viewer:P}),(H=new o).setDynamic(!0),H.setPrePickingDuringManipulation(!0),H.setPreActivationDuringManipulation(!0),H.setPickingDuringManipulation(!0),H.setExclusive(!0),j=H.linkToNode(ie()),H.HandleLongHold=function(){return ce(),!0},U=H.subscribe("BeginManipulate",function(e){if(!J.isRunning()){var o,s=t.getController(),c=s.getRootBagId();if(z=new M(s.getRootBag(),c),P.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(z),P.setCursor("pointer"),T=e.event.gesture.events[0].event.ctrlKey,I={},l&&l.isActive())o=P.pick(P.getMousePosition(e.event.from[0].currentPosition),"primHybrid",!1),(I=l.filterPath({pathElement:o.path[0]})).pathReferent=A.getMoveReferent(o.path[0]);else{var p=v.giveSelectionManager({context:t});p&&((o=P.pick(P.getMousePosition(e.event.from[0].currentPosition),p.getPicking()?"mesh":"primHybrid",!1)).path[0]=p.getTruncatedPath(o.path[0]),I.pathElement=o.path[0],I.pathReferent=A.getMoveReferent(o.path[0]),I.equivalentGeometry=a.getEquivalentGeometry({pathElement:o.path[0],viewer:P,nonCanonicGeometry:!0}))}I.pathElement&&(I.beginEvent=e.event,I.beginPosLocal=e.position.clone().applyMatrix4((new r.Matrix4).getInverse(I.pathElement.getWorldMatrix())),q.push({path:I.pathElement}),e&&e.event&&e.event.from&&e.event.from&&e.event.from.length&&"Touch"!==e.event.from[0].type&&i.get().slice(0).forEach(function(t){t.pathElement&&(t.pathElement.isEqual(I.pathElement)?k.partIsInCSO=!0:T?(t.pathElement.isAParentOf(I.pathElement)&&(k.fatherIsInCSO=!0),q.push({path:t.pathElement})):(i.remove({pathElement:t.pathElement,event:e.event}),n.remove({pathElement:t.pathElement})))}),q.forEach(function(e){if(e.path){var n,i=W.slice(0).some(function(t){if(t.path&&(!t.path.isEqual(e.path)&&t.path.isAParentOf(e.path)||!ae(e.path)))return!0});if(!f.getPreferencesDefinition()[0].preferences[0].getValue()){var a=D.getCommand("CAT3DComposeMoveHdr",t.getCommandContext());a&&!a.isRunning()&&(i=!0)}if(i||!(n=A.getMoveReferent(e.path)))return;for(var o,r=n.externalPath.map(function(e){return h.getNodeID(e)}).filter(function(e){return e}),l=e.path.externalPath.length-1;l>0;--l)if(h.isRepReference(e.path.externalPath[l])){o=h.getNodeID(e.path.externalPath[l]);break}o&&s.lockNodes({ids:[o]}),r.unshift(c),W.push({path:n,lockedID:o,override:z.createIdPathOverride({idPathes:[new g(r)]}),initWorldMatrix:n.getWorldMatrix(),initMatrix:n.getLastElement(!0).getMatrix(),selectionWorldMatrix:I.pathElement.getWorldMatrix(),isAxisSystem:I.pathElement.externalPath.some(function(e){return"AxisSystems"===e.name})})}}))}}),_=H.subscribe("Manipulate",function o(s,c){if(b&&b.cancel&&b.cancel(),b=null,!J.isRunning()&&(P.setCursor("pointer"),!s.event.from[0].currentPosition.equals(s.event.from[0].lastPosition)&&W.length)){var p=e?s.intersection.path[0]:null;if(!F){if(s&&s.event&&s.event.from&&s.event.from&&s.event.from.length&&"Touch"===s.event.from[0].type&&i.get().slice(0).forEach(function(e){e.pathElement&&(e.pathElement.isEqual(I.pathElement)?k.partIsInCSO=!0:T?(e.pathElement.isAParentOf(I.pathElement)&&(k.fatherIsInCSO=!0),q.push({path:e.pathElement})):(i.remove({pathElement:e.pathElement,event:s.event}),n.remove({pathElement:e.pathElement})))}),ne.publish({event:"onDirectMoveBegin"}),!k.partIsInCSO){var m=I.pathElement;i.add({pathElement:m,event:I.beginEvent,position:I.beginPosLocal.clone().applyMatrix4(m.getWorldMatrix())})}q.forEach(function(e){e.path&&n.remove({pathElement:e.path})}),S.onMoveBegin({objectsMoved:W,from:w,moveMode:"Transient"}),W.forEach(function(e){e.path&&e.override.setPickability("IGNORED")}),P.render(),I.equivalentGeometry||(I.equivalentGeometry=a.getEquivalentGeometry({pathElement:I.pathReferent,axis:O.getProductAxisForConstraint(),viewer:P})),X?(J.addAnimation({animationType:"opacityOn",objectListToAnimate:W,callBackFct:function(){I.equivalentGeometry&&I.equivalentGeometry.getMode()===C.GeometryMode.REAL&&le({path:I.pathElement,color:L}),W.forEach(function(e){e.path&&se({objectToMove:e})})}}),J.startAnimation()):(I.equivalentGeometry&&I.equivalentGeometry.getMode()===C.GeometryMode.REAL&&le({path:I.pathElement,color:L}),W.forEach(function(e){e.path&&(e.override.setOpacity(.35,!1),se({objectToMove:e}))})),O&&(O.count()>0&&!I.equivalentGeometry||O.count()>0&&!O.isLevelConstrained(I.pathReferent))&&O.deleteAllCst(),F=!0}if(!de({event:s.event})){var v=e?P.pick(P.getMousePosition(s.event.from[0].currentPosition),"primHybrid",!1):{path:[]};v.path[0]&&!h.isAModelPath(v.path[0])&&(v.path[0]=null);var d={pathElement:v.path[0]};!(b=u.switchToAV1withMesh({pathElement:d.pathElement,pad3DViewer:t,selectionFilter:l?l.getFiltersState():null,onComplete:function(){o(s,!0),b=null},onFailure:function(){b=null}}))||"filtered"!==b.status&&"done"!==b.status||(b=null),l&&l.filterPath(d);var f=!1;d.pathElement&&N.pathElement&&(f=N.pathElement.isEqual(d.pathElement)),N=d,V&&!f&&(O.deleteLastCst(),V=null);var E={},g=null,y=null;if(d.pathElement&&p&&!I.pathReferent.isAParentOf(p)){var M=I.equivalentGeometry&&I.equivalentGeometry.getType(),x=d.equivalentGeometry&&d.equivalentGeometry.getType();if(g=M&&M!==C.GeometryType.AXISSYSTEM&&M!==C.GeometryType.SURFACE,y=x&&x!==C.GeometryType.AXISSYSTEM&&x!==C.GeometryType.SURFACE,d.pathElement&&!I.pathReferent.isAParentOf(d.pathElement)&&y&&g){if(!f){V=O.createCst({movable:I,fixed:d});var D=O.simulateSolveCst();if(D){var A=D.matrix;E.rc=D.rc,E.redundancy=D.redundancy,0===E.rc&&A&&!E.redundancy?E.matrix=A.multiply(I.pathReferent.getWorldMatrix()):(0!==E.rc||E.redundancy)&&(O.deleteLastCst(),V=null),N=d}else N={}}}else d&&d.pathElement&&(E.matrix=d.pathElement.getWorldMatrix(),d.pathElement.externalPath.some(function(e){return"AxisSystems"===e.name})?(E.isAxisSystem=!0,oe.updateDisplay({visibility:!1})):oe.updateDisplay({pathElement:d.pathElement,visibility:!0}))}if(E.matrix){var G;if(E.isAxisSystem&&W[0].isAxisSystem){var j=(new r.Matrix4).copy(E.matrix);j.multiply((new r.Matrix4).getInverse(W[0].selectionWorldMatrix)),j.multiply(W[0].initWorldMatrix),G=(new r.Matrix4).getInverse(W[0].initWorldMatrix).multiply(j)}else(G=(new r.Matrix4).getInverse(W[0].initWorldMatrix).multiply(E.matrix)).multiply((new r.Matrix4).getInverse(I.pathElement.getLastElement(!0).getMatrix()));W.forEach(function(e,t){var n=(new r.Matrix4).copy(e.initWorldMatrix).multiply(G);if(e.path){var i=(new r.Matrix4).getInverse(e.path.getParentPath().getWorldMatrix()),a=(new r.Matrix4).copy(i).multiply(n),o=null;e.snappedPosition&&(o=(new r.Matrix4).copy(e.snappedPosition));var l=o&&o.equals(a);if(e.snappedPosition=(new r.Matrix4).copy(a),X){var p=(new r.Matrix4).copy(e.initWorldMatrix),u=(new r.Vector3).getPositionFromMatrix(e.initWorldMatrix).add(s.translationVector);p.setPosition(u);var m=(new r.Matrix4).copy(i).multiply(p);Q?l||(e.currentPosition=a):(e.currentPosition=(new r.Matrix4).copy(m),(O&&O.count()<=1&&y&&g||!y&&!g||y&&!g)&&e.override.setPosition(m)),0===t&&(e.snappedTarget=d.pathElement,l||!d.pathElement||e.snappedTarget.isEqual(d.pathElement)||(clearTimeout(Z),Z=null),Z||l&&Q||b||(Z=setTimeout(function(){J.addAnimation({animationType:"snap",objectListToAnimate:W,callBackFct:function(){Q=!0,Z=null,$&&ue()}}),J.addAnimation({animationType:"opacityOff",offsetTime:J.getDefaultDuration("snap"),objectListToAnimate:W,callBackFct:function(){W.forEach(function(e){e.override.setColor(null,!1)}),I.equivalentGeometry&&le({path:I.pathElement})}}),J.startAnimation()},c?0:500)))}else e.override.setPosition(a),Q=!0}}),R=!1,S.onMove({objectsMoved:W,transformation:G,from:w})}else if(oe&&oe.updateDisplay({visibility:!1}),void 0===d.pathElement||null===d.pathElement||E.rc&&0!==E.rc||E.redundancy?(R=!0,S.onMove({objectsMoved:W,vector:s.translationVector,from:w})):y&&g&&0===E.rc&&(R=!1),void 0!==d.pathElement||null!==d.pathElement){var U=null;W.forEach(function(e,t){if(e.path){var n=null;if(0===O.count()||1===O.count()&&V){var i=(new r.Matrix4).copy(e.initWorldMatrix),a=(new r.Vector3).getPositionFromMatrix(e.initWorldMatrix).add(s.translationVector);i.setPosition(a);var o=e.path.getParentPath().getWorldMatrix();n=(new r.Matrix4).getInverse(o).multiply(i),Q||e.override.setPosition(n),e.currentPosition=(new r.Matrix4).copy(n)}else{if(0===t){U=null,V&&O.deleteLastCst();var l=(new r.Vector3).addVectors(s.translationVector,H.initial3dIntersectionPoint),c=null;c=B?(new r.Vector3).subVectors(s.translationVector,B):s.translationVector,B=s.translationVector;var p=O.simulateMoveWithCst({movableReference:l,translation:c});p&&0===p.rc&&p.matrix&&(U=p.matrix.multiply(I.pathReferent.getWorldMatrix())),V&&O.restoreLastDeletedCst()}if(U){var u=(new r.Matrix4).getInverse(W[0].initWorldMatrix).multiply(U),m=(new r.Matrix4).copy(e.initWorldMatrix).multiply(u),v=(new r.Matrix4).getInverse(e.path.getParentPath().getWorldMatrix());n=(new r.Matrix4).copy(v).multiply(m),Q||e.override.setPosition(n)}e.currentPosition=(new r.Matrix4).copy(e.initMatrix)}}}),X?f||(Z&&(clearTimeout(Z),Z=null),Q&&R&&(J.addAnimation({animationType:"unsnap",objectListToAnimate:W,callBackFct:function(){Q=!1,W.forEach(function(e){e.snappedPosition=null})}}),J.addAnimation({animationType:"opacityOn",objectListToAnimate:W,offsetTime:J.getDefaultDuration("unsnap"),callBackFct:function(){I.equivalentGeometry&&le({path:I.pathElement,color:L}),W.forEach(function(e){e.path&&se({objectToMove:e})})}}),J.startAnimation())):Q&&R&&(W.forEach(function(e){e.path&&e.currentPosition&&e.override.setPosition(e.currentPosition)}),Q=!1)}re.updateDisplay(d,s.intersection.position,s.intersection.normal),P.render()}}}),K=H.subscribe("EndManipulate",he),0===oe.getChildren().length){var d=new c({headLength:10,arrowLength:50,arrowWidth:2,head:c.types.ARROW});oe.addChild(d)}oe.updateDisplay({visibility:!1}),P.render({updateInfinitePlane:!0})}else window.console.log("A move referent component must be defined");else window.console.log("A move manager component must be defined");else window.console.log("A frame window must be defined")}}(e.withSnap,e.selectionFilter)},this.deactivate=function(){fe(),pe=!1},this.unreference=function(){fe(),O&&(O.deleteAllCst(),O.unreference()),oe&&P.removeNode(oe),oe=null,re&&P.removeNode(re),re=null,t=null,ne=null,pe=!1},this.subscribe=function(e,t){return"onDirectMoveBegin"===e||"onDirectMoveEnd"===e?ne.subscribe({event:e},t):void 0},this.unsubscribe=function(e){return ne.unsubscribe(e)}}});return t.singleton({init:function(){},activate:function(e){e&&e.context&&"ENOPAD3DViewer"===e.context.name&&(b||(b=new T),b.activate(e))},deactivate:function(e){e&&e.context&&"ENOPAD3DViewer"===e.context.name&&b&&b.deactivate()},unreference:function(e){e&&e.context&&"ENOPAD3DViewer"===e.context.name&&(b&&b.unreference(),b=null)},subscribe:function(e,t){return b?b.subscribe(e,t):null},unsubscribe:function(e){return b?b.unsubscribe(e):null}})});