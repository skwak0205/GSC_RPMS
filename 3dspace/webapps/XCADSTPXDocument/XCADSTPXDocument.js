define("DS/XCADSTPXDocument/STPXProductRepresentation",["DS/XCADInputDocuments/XCADProductRepresentation"],function(e){"use strict";return e.extend(function(e,t,n){this._name=n,this._associatedDocument=e,this._representationType=t,this._rootProducts=[]},{addRootProduct:function(e){this._rootProducts.push(e)}})}),define("DS/XCADSTPXDocument/STPXProductInstance",["DS/XCADInputDocuments/XCADProductInstance"],function(e){"use strict";return e.extend(function(e,t){this._document=e,this._STPXProductInstance=t},{getGeometricProperties:function(){throw"Error: not implemented method"},getInstanceAttributes:function(){var e=[];return e.push(this._STPXProductInstance.instanceName),e},getReferenceProduct:function(){return this._document.getProductReference(this._STPXProductInstance.productReferenceIdx)},getUID:function(){throw"Error: not implemented method"},getTransformation:function(){var e,t=this._STPXProductInstance.transfo;if(void 0!==t){var n=t.rotation.elements,r=t.translation;e=[[[n[0],n[1],n[2]],[n[3],n[4],n[5]],[n[6],n[7],n[8]]],[r.x,r.y,r.z]]}return e}})}),define("DS/XCADSTPXDocument/STPXProduct",["exports","DS/XCADInputDocuments/XCADProduct","DS/XCADSTPXDocument/STPXProductInstance"],function(e,t,n){"use strict";var r=t.extend(function(e,t){this._document=e,this._STPXProduct=t},{getDocument:function(){var e,t;return this._STPXProduct.geometries&&0!=this._STPXProduct.geometries.length&&(t=this._STPXProduct.geometries),null!=t&&((e=this._document)._internalRepresentationIndex=t[0].url),e},getFilePath:function(){var e;return void 0!==this._STPXProduct.geomRep&&null!==this._STPXProduct.geomRep&&"geometry"===this._STPXProduct.geomRep.type&&(e=this._STPXProduct.geomRep.folder+"/"+this._STPXProduct.geomRep.filename),e},getGeometricProperties:function(){throw"Error: not implemented method"},getInstanceList:function(){for(var e=[],t=this._STPXProduct.childrenList.length,r=0;r<t;r++){var o=new n(this._document,this._STPXProduct.childrenList[r]);null!=o&&e.push(o)}return e},getProductAttributes:function(){var e;void 0!==this._STPXProduct.geomRep&&null!==this._STPXProduct.geomRep&&"geometry"===this._STPXProduct.geomRep.type&&(e=this._STPXProduct.geomRep.fileContent);var n=[];return n.push(this._STPXProduct.referenceName),n.push(e),n.push(""),n.push(""),n.push(""),n.push(t.SourceTypes.Unknown),n},getUID:function(){throw"Error: not implemented method"}});return e.STPXProduct=r,r}),define("DS/XCADSTPXDocument/STPXInputDocument",["WebappsUtils/WebappsUtils","DS/XCADInputDocuments/XCADInputDocument","DS/XCADInputDocuments/XCADRepresentation","DS/XCADSTPXDocument/STPXProductRepresentation","DS/XCADSTPXDocument/STPXInputDocument","DS/XCADSTPXDocument/STPXProduct","DS/XCADLoader/XCADLoader","DS/VisuLoaders/CGRReader","DS/Visualization/Utils","DS/VisuDataAccess/ProxyAbstraction","DS/Mesh/ThreeJS_Base","DS/XCADLoader/XCADSingleton"],function(e,t,n,r,o,i,s,a,l,u,c,d){"use strict";return t.extend(function(){this.url=null,this.sceneGraph=null,this.spec=null,this.folder=null,this.refFiles=[],this.cgrLoader=null,this.assyProducts=[],this.rootProducts=[],this.nbInstPart=0},{zipped:!1,requestResponseType:"text",close:function(){},getGeomRep:function(e){throw"Error: not implemented method"},getInstanceList:function(e){throw"Error: not implemented method"},getReferencedFiles:function(){throw"Error: not implemented method"},getReferenceName:function(e){throw"Error: not implemented method"},getRepresentationType:function(e){throw"Error: not implemented method"},getTransformation:function(e){throw"Error: not implemented method"},getRootProducts:function(){return this.rootProducts},initialize:async function(e){let t=new DOMParser,n=t.parseFromString(e,"text/xml").documentElement.getElementsByTagName("DataContainer");var r=this,o=[];let i=[],l=[],u=[],m=[],g=[],h=[],f=[],p=0;console.log("initialize: processFile"),await async function e(n,r,o,s){let a=n[0].getElementsByTagName("File");var c="root";null!=s&&(c=s.substring(s.lastIndexOf("/")+1,s.length));let P=p;p++;if(null!=a&&a.length>0){for(var T=[],D=[],y=[],S=0;S<a.length;S++){var E=a[S].getElementsByTagName("Locations")[0].getElementsByTagName("ExternalItem")[0],N=E.getElementsByTagName("Id")[0].getAttribute("id"),X=E.getElementsByTagName("Source")[0],v=".";null!=X&&(v=X.getElementsByTagName("IdentifierString")[0].childNodes[0].data);var R=N.substring(N.lastIndexOf(".")+1,N.length),A=r.url.slice(0,r.url.lastIndexOf("/")+1)+v+"/"+N,C=N.substring(0,N.lastIndexOf(".")),I=(C=v+C).replaceAll("/","_"),B=(I=I.replaceAll("\\","_")).substring(0,I.lastIndexOf("."));if(B.length>1&&(I=B),(I=I.replaceAll(".","")).startsWith("_")&&(I=I.replace("_","")),"STPX"===R.toUpperCase()){T.push(A),D.push(I);let e=a[S].getAttribute("uid");null!=o&&(e=o+" "+e),y.push(e)}else i.push(A),m.push(a[S]),l.push(I),null!=o&&(null==u[N]&&(u[N]=[]),u[N].push(o))}const n=async()=>{try{const e=await Promise.all(T.map(e=>fetch(e).then(e=>e.text())));return e}catch(e){console.log("Error",e)}};let s=[];if(!0===r.zipped)for(var S=0;S<D.length;S++){let e=d.getDataValue(D[S]);s.push(e)}else s=await n();for(var S=0;S<s.length;S++){let n=t.parseFromString(s[S],"text/xml"),o=n.documentElement.getElementsByTagName("DataContainer");await e(o,r,y[S],T[S])}}let _=n[0].getElementsByTagName("Part");if(null!=_)for(var S=0;S<_.length;S++)null==g[c]&&(g[c]=[]),g[c].push(_[S]);let b=n[0].getElementsByTagName("ViewOccurrenceRelationship");if(null!=b){h[P]=[];for(var S=0;S<b.length;S++){var w={vor:b[S],uid:y[S],fileName:c};h[P].push(w)}}let x=n[0].getElementsByTagName("Document");if(null!=x)for(var S=0;S<x.length;S++)f.push(x[S])}(n,this),console.log("initialize: processGeometry"),await async function(e){let t=[];if(!0===e.zipped)for(var n=0;n<l.length;n++){let e=d.getDataValue(l[n]);t.push(e)}else t=await(async()=>{try{const e=await Promise.all(i.map(e=>fetch(e).then(function(t){var n=e.substring(e.lastIndexOf(".")+1,e.length);return"CGR"===n.toUpperCase()?t.arrayBuffer():(n.toUpperCase(),t.text())})));return e}catch(e){console.log("Error",e)}})();for(var r=[],n=0;n<t.length;n++){var o=i[n].substring(i[n].lastIndexOf(".")+1,i[n].length);if("STP"===o.toUpperCase()){let e=new s,o=require("DS/XCADSTPDocument/STPInputDocument"),i=new o;let a=null;await e.load(i,"",function(e){r[n]=e},null,null,null,null,!1,"text",a,t[n])}else"CGR"===o.toUpperCase()&&await D(t[n],r,e)}for(var n=0;n<m.length;n++)S(m[n],r[n])}(this),console.log("initialize: processOccurence");for(var P=0;P<h.length;P++)for(var T=0;T<h[P].length;T++)y(h[P][T]);function D(e,t,n){return new Promise((r,o)=>{null===n.cgrLoader&&(n.cgrLoader=new a);var i={readyCallback:function(e){return t.push(e.nodes[0]),r("xcadReady")},errorCallback:null,doneCallback:null};n.cgrLoader.load(e,i,{isBuffer:!0})})}function y(e){var t;let n=e.vor.getElementsByTagName("Placement")[0];if(n){let e=n.getElementsByTagName("CartesianTransformation")[0];if(e){let n=e.getElementsByTagName("RotationMatrix")[0].childNodes[0].nodeValue,r=e.getElementsByTagName("TranslationVector")[0].childNodes[0].nodeValue;t=function(e,t){var n={};return n.rotation=new c.Matrix3,n.rotation.set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]),n.translation=new c.Vector3(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2])),n}(n.trim().split(" "),r.trim().split(" "))}}let i=e.vor.getElementsByTagName("Related")[0].getAttribute("uidRef"),s=g[e.fileName],a=void 0,l=void 0,u=void 0,d=void 0,m=void 0,h=void 0,p=void 0,P=0;for(;(void 0===l||void 0===d)&&P<s.length;){let t=s[P].getElementsByTagName("Occurrence"),n=s[P].getElementsByTagName("Name")[0].getElementsByTagName("CharacterString")[0].childNodes[0].data,r=0;for(;void 0===l&&r<t.length;){if(null!=t[r]&&t[r].getAttribute("uid")===i){null===(a=t[r].getElementsByTagName("Id")[0].getAttribute("id"))&&(a=t[r].getElementsByTagName("Identifier")[0].getAttribute("id")),l=n,u=s[P].getElementsByTagName("Id")[0].getElementsByTagName("Identifier")[0].getAttribute("uid"),u=l;let o=s[P].getElementsByTagName("AssignedDocument")[0];if(o&&(h=o.getAttribute("uidRef")),null!=h&&h.startsWith("DV"))for(var T=!1,D=0;D<f.length&&!1===T;D++){f[D].getElementsByTagName("DocumentVersion")[0].getAttribute("uid")===h&&(T=!0,h=f[D].getElementsByTagName("DocumentVersion")[0].getElementsByTagName("DigitalFile")[0].getAttribute("uidRef"))}null!=h&&null!=e.uid&&(h=e.uid)}r++}let o=s[P].getElementsByTagName("Related"),c=s[P].getElementsByTagName("Name")[0].getElementsByTagName("CharacterString")[0].childNodes[0].data,g=0;for(;void 0===d&&g<o.length;){if(null!=o[g]&&o[g].getAttribute("uidRef")===i){d=c,m=s[P].getElementsByTagName("Id")[0].getElementsByTagName("Identifier")[0].getAttribute("uid"),m=d;let t=s[P].getElementsByTagName("AssignedDocument")[0];if(t&&(p=t.getAttribute("uidRef")),null!=p&&p.startsWith("DV"))for(T=!1,D=0;D<f.length&&!1===T;D++){f[D].getElementsByTagName("DocumentVersion")[0].getAttribute("uid")===p&&(T=!0,p=f[D].getElementsByTagName("DocumentVersion")[0].getElementsByTagName("DigitalFile")[0].getAttribute("uidRef"))}null!=p&&null!=e.uid&&(p=e.uid)}g++}P++}if(null!==m&&null!==u){if(m in r.assyProducts||(r.assyProducts[m]={referenceName:d,isRoot:!0,childrenList:[],geomRep:o[p]},r.rootProducts.push(m)),u in r.assyProducts){r.assyProducts[u].isRoot=!1;var y=r.rootProducts.indexOf(u);-1!=y&&r.rootProducts.splice(y,1)}else r.assyProducts[u]={referenceName:l,isRoot:!1,childrenList:[],geomRep:o[h]};r.assyProducts[m].childrenList.push({instanceName:a,productReferenceIdx:u,transfo:t}),void 0!==r.assyProducts[u].geomRep&&r.nbInstPart++}}function S(e,t){var n=e.getAttribute("uid"),r=e.getElementsByTagName("Locations")[0].getElementsByTagName("ExternalItem")[0],i=r.getElementsByTagName("Id")[0].getAttribute("id"),s=r.getElementsByTagName("Source")[0],a=".";null!=s&&(a=s.getElementsByTagName("IdentifierString")[0].childNodes[0].data);var l=e.getElementsByTagName("FileType")[0],c="geometry";if(null!=l&&(c=l.getElementsByTagName("ClassString")[0].childNodes[0].data),null!=u[i])for(var d=0;d<u[i].length;d++)n=u[i][d],o[n]={type:c,filename:i,folder:a,fileContent:t};else o[n]={type:c,filename:i,folder:a,fileContent:t}}},getProductReference:function(e){return new i(this,this.assyProducts[e])},getRepresentation:function(e){var t;if(0!==Object.keys(this.assyProducts).length&&e===n.XCAD_PRODUCT_REPRESENTATION){t=new r(this,n.XCAD_PRODUCT_REPRESENTATION,"root");var o,i=this.getRootProducts();if(i.length>0)o=i[0];else for(var s in this.assyProducts)if(this.assyProducts[s].isRoot){o=s;break}var a=this.getProductReference(o);t.addRootProduct(a)}return t},_testLoad:function(e,t,n){}})});