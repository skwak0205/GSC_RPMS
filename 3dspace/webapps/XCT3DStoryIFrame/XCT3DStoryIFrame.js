define("DS/XCT3DStoryIFrame/XCT3DStoryIFrame",["require","exports","UWA/Class","UWA/Core","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/WebappsUtils/WebappsUtils","DS/Usage/TrackerAPI"],function(e,t,s,r,i,a,o,n,l){"use strict";const c=e=>{};return class extends s{constructor(){super(...arguments),this.publishCallback=null,this.initParams=null,this.storyIframe=null,this.serviceUrls={},this.handleMessages=(e=>{var t,s;const r=e.data;switch(r.label){case"DS/3DStory/fullscreenActivated":this.initParams&&this.initParams.onActivateFullscreen&&this.initParams.onActivateFullscreen();break;case"DS/3DStory/fullscreenDeactivated":this.initParams&&this.initParams.onDeactivateFullscreen&&this.initParams.onDeactivateFullscreen();break;case"DS/3DStory/completed/storyBlob":this.publishCallback&&this.publishCallback(r.blob);break;case"DS/3DStory/completed/storyPublish":{const{mediaId:e,isDraft:i}=r;a.publish("My3DExPublishToSwym",{swymType:"media",cmdId:"PublishStoryToSwym",param:{contentId:e,isDraft:i}}),null===(s=null===(t=this.initParams)||void 0===t?void 0:t.onContentPublishedInSwym)||void 0===s||s.call(t,e,i);break}case"DS/3DStory/getServicesUrl":{let t={};const{servicesName:s}=r;s&&s.length>0?s.forEach(e=>t[e]=this.serviceUrls[e]):Object.assign(t,this.serviceUrls),e.ports[0].postMessage({label:"DS/3DStory/postServicesUrl",servicesUrl:t});break}case"DS/3DStory/completed/appExit":window.removeEventListener("message",this.handleMessages),this.storyIframe&&"function"==typeof this.storyIframe.destroy&&this.storyIframe.destroy(),this.storyIframe=null;break;case"DS/3DStory/ready":try{const e=window.top.document.createEvent("CustomEvent");e.initCustomEvent("STORYREADY",!0,!1,{helper:""}),window.top.document.dispatchEvent(e)}catch(e){console.warn("cannot notify 3DPlay",e)}break;case"DS/3DStory/trackEvent":r.trackEvents.forEach(this.trackEvent);break;default:c(r)}})}trackEvent(e){try{l.trackPageEvent(e)}catch(e){}}sendMessage(e){this.storyIframe&&this.storyIframe.contentWindow?this.storyIframe.contentWindow.postMessage(e,"*"):console.error("cannot access iframe")}init(){this._parent()}destroy(){this.sendMessage({label:"DS/3DStory/request/appExit"})}startPublish(e,t=!1){this.publishCallback=e,this.sendMessage({label:"DS/3DStory/request/storyBlob",isDraft:t})}createIframe(e,t){this.storyIframe=r.createElement("iframe",{src:e,styles:{width:"100%",height:"100%",border:"0px"},allowFullScreen:!0,mozAllowFullScreen:!0,webkitAllowFullScreen:!0,allow:"autoplay; camera; microphone; clipboard-read; clipboard-write"}),this.storyIframe.inject(t)}async create(e,t){var s,r,l,c,d,h,u,p,m,y,v;const S=t;S&&(this.initParams=S);const D=[];D.push(`cacheBuster=${Date.now()}`),window.addEventListener("message",this.handleMessages);const w=[];let b=S.fileUrl,f=S.mediaId;if(b){if(S.edit){const e=null!==(l=null===(r=null===(s=null==S?void 0:S.model)||void 0===s?void 0:s.toJSON)||void 0===r?void 0:r.call(s))&&void 0!==l?l:null,t=null===(h=null===(d=null===(c=null==e?void 0:e.play)||void 0===c?void 0:c["3d_streams"])||void 0===d?void 0:d[0])||void 0===h?void 0:h.transient_url;"string"==typeof t&&(b=t);const i=null==e?void 0:e.subject6wuri;i&&(f=i)}D.push("storyPath="+encodeURIComponent(b))}S["3dplay"]&&D.push("3dplay=true"),f&&D.push("mediaId="+encodeURIComponent(f)),"undefined"!=typeof widget&&"X3DPLAW_AP"===(null===(u=widget.data)||void 0===u?void 0:u.appId)&&D.push("3dplayDashboard=true"),S.edit&&D.push("editMode=true"),void 0!==S.threadId&&D.push("currentCommunityId="+encodeURIComponent(S.threadId)),void 0!==S.threadType&&D.push("currentCommunityType="+encodeURIComponent(S.threadType));let I=null;try{"function"==typeof a.getTenant&&(I=a.getTenant()),I&&0!==I.length||(I=null!==(m=null===(p=window.ds)||void 0===p?void 0:p.swymTenant)&&void 0!==m?m:null===(y=window.parent.ds)||void 0===y?void 0:y.swymTenant)}catch(e){}const E="MOBILE"===(null===(v=window.ds)||void 0===v?void 0:v.env);let g=null,C=null;const P=S.platformId||I;P&&(D.push("platformId="+encodeURIComponent(P)),w.push(new Promise((e,t)=>{o.getPlatformServices({public:!1,onComplete:t=>{if(Array.isArray(t)&&t.length>0){const e=t.find(e=>0===P.localeCompare(e.platformId,void 0,{sensitivity:"base"}));e&&(this.serviceUrls=e,(g=e["3DSwym"])&&D.push("swymServiceURL="+encodeURIComponent(g)),C=e.my3dexperience)}e()},onFailure:e})}))),S["3DDashboard"]&&D.push("3DDashboard=true"),S.wakeUpUrl&&w.push(new Promise(e=>{i.authenticatedRequest(t.wakeUpUrl,{method:"GET",type:"json",onComplete:e,onFailure:e})})),Promise.all(w).then(()=>{const t=(E?n.getWebappsBaseUrl():`${C}/resources/3DStory/en/webapps/`)+"XCT3DStory/index.html?"+D.join("&");this.createIframe(t,e)})}}}),define("DS/XCT3DStoryIFrame/3DStoryExperience",["require","exports","DS/WebUtils/ContextedSingleton","DS/CoreEvents/Events","UWA/Class","DS/XCT3DStoryIFrame/XCT3DStoryIFrame"],function(e,t,s,r,i,a){"use strict";return class extends i{constructor(e){super(),this.args={},this.init=(e=>{}),this.onStoryReady=(()=>{this.publish("EXPERIENCE/EXPERIENCEREADY",this)}),this.registerListener=(()=>{try{window.top.document.addEventListener("STORYREADY",this.onStoryReady,!1)}catch(e){}}),this.unregisterListener=(()=>{try{window.top.document.removeEventListener("STORYREADY",this.onStoryReady,!1)}catch(e){}}),this.publish=((e,t)=>{r.publish({event:"/"+this.ctx+"/"+e+"/",data:t})}),this._testBrowser=(()=>BrowserSupport.ok),this.testBrowser=(()=>BrowserSupport.ok),this.initExperience=(()=>{}),this.start=(()=>{}),this.dispose=(()=>{this.unregisterListener(),this.publish("EXPERIENCE/DISPOSE",void 0),this.container=null}),s.get(e.ctx,"helper").playerSplashScreen.hide(),this.registerListener();const t=new a,i=e.input.asset;let o={"3dplay":!0,fileUrl:i.filename};try{let e=window;for(;!e.mySwymCallBack&&e.parent&&e!==e.parent;)e=e.parent;if(e.mySwymCallBack){const t=e.mySwymCallBack;t.onActivate&&(o.onActivateFullscreen=t.onActivate),t.onDeactivate&&(o.onDeactivateFullscreen=t.onDeactivate)}}catch(e){}i.originalAsset&&(i.originalAsset.envId&&(o.platformId=i.originalAsset.envId),i.originalAsset.objectId&&(o.mediaId=i.originalAsset.objectId)),t.create(e.container,o),this.ctx=e.ctx,this.container=e.container}}});