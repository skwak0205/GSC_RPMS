/*!  Copyright 2022 Dassault Systemes. All rights reserved. */
define("DS/ECLoader/ECAbstractLoader",["UWA/Class","DS/CoreEvents/ModelEvents","DS/CoreEvents/Events","DS/SPYLoader/SPYLoader","DS/SPY/SimulationPlayerModel","DS/SPYUI/controllers/SimulationPlayerUI","DS/SPYUI/controllers/SPYContext","i18n!DS/SPYLoader/assets/nls/Loading"],function(e,t,s,i,n,o,r,a){"use strict";var d=function(e){e&&e.spm&&(e.spm.clean(),delete e.spm)},c=function(e){if(e&&e.spmUI){var t=e.spmUI.getSPM();t&&t.subReference(),e.spmUI.clean(),e.spmUI.destroy(),delete e.spmUI}};return e.extend({_msrECControllers:new Map,_msrECDataModels:new Map,_spyLoader:i,_cmdsWraps:{},init:function(e){if(e){if(e.commandsWrappers){var t=e.commandsWrappers;this._cmdsWraps.animateCmdHdr=t.animateCmdHdr,this._cmdsWraps.chooseContentCmdHdr=t.chooseContentCmdHdr,this._cmdsWraps.hideShowLegendCmdHdr=t.hideShowLegendCmdHdr}e.frameWindow&&(this._frmWindow=e.frameWindow),e.viewer&&(this._viewer=e.viewer)}},setFrameWindow:function(e){this._frmWindow=e},setViewer:function(e){this._viewer=e},_onDefaultDDActivation:function(){},_postCreateSequenceCallback:function(e){var t=this._latestAppController?this._latestAppController.spmui:void 0;t&&-1===t.getActiveSequence()&&(e&&e.state&&t.setStateData(e.state),t.activateDefaultContent(this._onDefaultDDActivation.bind(this))),this._spyLoader.continueLoading()},_createSequenceErrorCallback:function(){var e,t=this._spyLoader.getReport();if(t){var s=!1,i="noValidStream";isNaN(t.streamNb)||isNaN(t.invalidStreamNb)||t.streamNb!==t.invalidStreamNb?t.filteredContent&&(s=!0,i="filteredContent"):s=!0,s&&(e=a[i])}return this._spyLoader.continueLoading(),e},setOnProgressCallback:function(e){this._onProgressCallback=e},setOnLoadedCallback:function(e){this._onLoadedCallback=e},setOnErrorCallback:function(e){this._onErrorCallback=e},load:function(e){if(e&&"DesignSight"===e.dtype&&e.physicalid&&this._viewer&&this._frmWindow){this._viewer.setMaterialMode(!0);var t="EC_INTEGRATION_CONTEXT",i=this._frmWindow.getOption("context");t=i||t;var d=e.physicalid,c=!0,l={window:this._frmWindow,context:t,msrID:d},h={},p=this._msrECDataModels.get(d);p||(p={spm:new n(l),refCount:0,loaded:!1,success:!1,errors:[],warnings:[],infos:[],addReference:function(){this.refCount++},subReference:function(){this.refCount--},isReferenced:function(){return this.refCount>0}},c=!1,this._msrECDataModels.set(d,p)),p.addReference();var m={id:e.id,active:!1,spm:p.spm,window:this._frmWindow,parentNode:e.parentNode3D,context:t,disableReframe:!0,allowExtractableUI:!1,onClean:function(){},publishPCSEvent:function(){},updateStats:function(){},commandWrappers:{animate:this._cmdsWraps.animateCmdHdr,chooseContent:this._cmdsWraps.chooseContentCmdHdr,hideShowLegend:this._cmdsWraps.hideShowLegendCmdHdr}};h.spmui=new o(m);var u=function(t){if(this._onLoadedCallback){var s=Object.assign({id:e.id,success:this._lastSuccessFlag},t);this._onLoadedCallback(s)}}.bind(this),C=function(t){this._lastSuccessFlag=!1,t.id=e.id,this._onErrorCallback&&this._onErrorCallback(t)}.bind(this),f=function(e){this._onProgressCallback&&this._onProgressCallback(e)}.bind(this),_=function(e){this._postCreateSequenceCallback(e),this._spyLoader.isLoadingComplete()&&(s.publish({event:t+"/SPY/ASSET/LOADINGCOMPLETE"}),this._ddActivatedCb=s.subscribe({event:t+"/SPY/DATADISPLAY/ACTIVATED"},function(e){s.unsubscribe(this._ddActivatedCb);var t=e.content.node?e.content.node.parents[0]:void 0,i=this._msrECControllers.get(t.getModelIdentification());i&&(i.loaded=!0,i.node=t),u({node:t})}.bind(this)))}.bind(this);if(this._msrECControllers.set(e.id,h),this._latestAppController=h,this._lastSuccessFlag=!0,c)_();else{var S={dtype:"DesignSight",provider:"3DSPACE",physicalid:e.physicalid,serverurl:e.serverurl,tenant:e.tenant,requiredAuth:"passport"};this._spyLoader.onQueryStart(t,function(){}),this._spyLoader.onQueryProgress(t,function(e,t){f({loaded:t.streamsLoaded,total:t.streamsTotal})}),this._spyLoader.onQueryError(t,function(e){var t;switch(e){case"NOSTREAM":"infoTitle",t="noLightWeightStream",r.appNotificationTypes.info;break;case"NOACCESS":"warningTitle",t="noDataAccess",r.appNotificationTypes.warning;break;default:"errorTitle",t="failed",r.appNotificationTypes.error}C({msg:a[t]})}),this._spyLoader.onUnstreamStart(t,function(e){}),this._spyLoader.onFileNotSupported(t,function(){alert("File not supported"),C({msg:"File not supported"})}),this._spyLoader.onUnstreamComplete(t,_),this._spyLoader.onUnstreamError(t,function(){var e=this._createSequenceErrorCallback();e&&C({msg:e}),this._spyLoader.isLoadingComplete()&&(s.publish({event:t+"/SPY/ASSET/LOADINGCOMPLETE"}),u())}.bind(this)),this._spyLoader.onTimeOut(t,function(){C({msg:a.timeOut}),this._spyLoader.continueLoading(),this._spyLoader.isLoadingComplete()&&(s.publish({event:t+"/SPY/ASSET/LOADINGCOMPLETE"}),u())});this._spyLoader.load(S,"DS/SPY/CATSimNavDataLWBasicFactory",p.spm)}}},activate:function(e){var t;e&&e.id&&"DesignSight"===e.dtype&&(this._msrECControllers.forEach(function(s,i){s&&s.spmui&&(i===e.id?t=s.spmui:s.spmui.deactivate())}),t&&t.activate())},deactivate:function(e){if(e&&e.id&&"DesignSight"===e.dtype){var t=this._msrECControllers.get(e.id);t&&t.spmui.deactivate()}},remove:function(e){if(this._msrECControllers&&this._msrECDataModels){var t=this._msrECControllers.get(e.id),s=t.getSPM();c(t),this._msrECControllers.delete(e.id),s&&!s.isReferenced()&&(this._msrECDataModels.delete(s.getMSRID()),d(s))}},removeAll:function(){this._msrECControllers.forEach(function(e){c(e)}),this._msrECControllers.clear(),this._msrECDataModels.forEach(function(e){d(e)}),this._msrECDataModels.clear(),this._spyLoader.clean()}})}),define("DS/ECLoader/ExperienceContentLoader",["DS/ECLoader/ECAbstractLoader"],function(e){"use strict";return e.singleton({})});