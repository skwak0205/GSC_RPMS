<%--  emxComponentsDiscussionReplyDetails.jsp  --  Include Head page for discussion .

  Copyright (c) 1992-2020 Dassault Systemes.
  All Rights Reserved.
  This program contains proprietary and trade secret information of MatrixOne,Inc.
  Copyright notice is precautionary only and does not evidence any actual or intended publication of such program

  static const char RCSID[] = $Id: emxComponentsDiscussionReplyDetails.jsp.rca 1.7 Wed Oct 22 16:18:08 2008 przemek Experimental przemek $

 --%>

<%
String jsTreeID = null;
String objectId = null;
String suiteKey = null;
%>


<%@ include file = "emxComponentsDiscussionDetail.inc" %>

<html>
<head>
  <title>Untitled</title>
</head>
<body onload="loadChildren()">

</body>
<script language="javascript">
  function loadChildren() {

    //get reference to tree
    var discussion = parent.discussion;
<%
    // get the logged-in user's name
    String loggedInUser = com.matrixone.apps.common.Person.getPerson(context).getName(context);

    String timeZone =(String)session.getValue("timeZone");
    if(jsTreeID == null)
    {
      String queryString = request.getQueryString();
      int treeParamIndex = queryString.indexOf("jsTreeID=");
      if(treeParamIndex > -1){
      jsTreeID = queryString.substring(treeParamIndex + 9,queryString.length());
      }
    }
%>
    //here is where you would get the unique ID, presumably from some server-side logic
    var strID = "<%=XSSUtil.encodeForJavaScript(context, jsTreeID)%>";
<framework:mapListItr mapList="<%= messageList %>" mapName="messageMap">
    //this code would be generated by the JSP, given the unique ID above
    //discussion.nodes[strID].addChild("Great! The sooner the better", "We are getting lots of complaints, so this is a high priority.", "Mike Smith", "5/52001");
<%
    strCount = (String)messageMap.get(Message.SELECT_MESSAGE_COUNT);

    // show the delete link only if the user is the owner of the "Reply" and there are no replies to this "Reply"
    boolean showDelete = false;
    String replyId = (String)messageMap.get(Message.SELECT_ID);
    DomainObject domainObject = DomainObject.newInstance(context, replyId);
    String replyOwner = domainObject.getInfo(context, domainObject.SELECT_OWNER);
    String replyPolicy = domainObject.getInfo(context, domainObject.SELECT_POLICY);
    if(replyOwner.equals(loggedInUser) && strCount.equals("0"))
    {
      showDelete = true;
    }
    String sMessage=(String)messageMap.get(Message.SELECT_DESCRIPTION);
    String tempMessage=FrameworkUtil.findAndReplace(sMessage, "\n", "<br />");
    String sSubject               = findReplace((String)messageMap.get(Message.SELECT_MESSAGE_SUBJECT));
    String sDynamicURLEnabled = EnoviaResourceBundle.getProperty(context,"emxFramework.DynamicURLEnabled");
    String rSubject=FrameworkUtil.findAndReplace(sSubject, "\n", "<br />");
    String rMessage=FrameworkUtil.findAndReplace(sMessage, "\n", "<br />");
    sSubject = XSSUtil.encodeForJavaScript(context, sSubject);
    sMessage = XSSUtil.encodeForJavaScript(context, sMessage);
	
	com.matrixone.apps.common.Person person = (com.matrixone.apps.common.Person) DomainObject.newInstance(context, DomainConstants.TYPE_PERSON);
    String sreplyOwner= person.getDisplayName(context,replyOwner);
	
    if(!"false".equals(sDynamicURLEnabled)) {
        sSubject = UINavigatorUtil.formatEmbeddedURL(context, sSubject, "NO", "YES", request.getHeader("Accept-Language"));
        sMessage = UINavigatorUtil.formatEmbeddedURL(context, sMessage, "NO", "YES", request.getHeader("Accept-Language"));
    }
        
    if(Integer.parseInt(strCount) == 0) {
%>
        //XSSOK        
        discussion.nodes[strID].addChild("<%=XSSUtil.encodeForJavaScript(context, rSubject)%>", "<%=XSSUtil.encodeForJavaScript(context, rMessage)%>", "<%=XSSUtil.encodeForJavaScript(context,sreplyOwner)%>", "<emxUtil:lzDate displaydate='true' displaytime='true' localize='i18nId' tz='<%=timeZone%>' format='<%=XSSUtil.encodeForJavaScript(context, DateFrm) %>'><%=(String)messageMap.get(Message.SELECT_ORIGINATED)%></emxUtil:lzDate>","<%=XSSUtil.encodeForJavaScript(context, replyId)%>","<%=showDelete%>","","","<%=XSSUtil.encodeForJavaScript(context, replyPolicy)%>","<%=showSubscription%>");
<%
    }else{ 
    

%>
        //XSSOK
        discussion.nodes[strID].addChild("<%=XSSUtil.encodeForJavaScript(context, rSubject)%>", "<%=XSSUtil.encodeForJavaScript(context, rMessage)%>", "<%=XSSUtil.encodeForJavaScript(context,sreplyOwner)%>", "<emxUtil:lzDate displaydate='true' displaytime='true' localize='i18nId' tz='<%=timeZone%>' format='<%=XSSUtil.encodeForJavaScript(context, DateFrm) %>'><%=(String)messageMap.get(Message.SELECT_ORIGINATED)%></emxUtil:lzDate>","<%=XSSUtil.encodeForJavaScript(context, replyId)%>","<%=showDelete%>","emxComponentsDiscussionReplyDetails.jsp?objectId=<%=XSSUtil.encodeForJavaScript(context, replyId)%>","<%=XSSUtil.encodeForJavaScript(context, jsTreeID)%>","<%=XSSUtil.encodeForJavaScript(context, replyPolicy)%>","<%=showSubscription%>");
<%
    }
%>
</framework:mapListItr>
    //IMPORTANT!!!! Make sure to tell the tree that this node is now loaded
    //discussion.nodes[strID].loaded = true;

    //refresh the tree
    discussion.refresh();
  }
</script>
</html>
